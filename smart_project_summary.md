# ü§ñ –°–∂–∞—Ç—ã–π –∏—Å—Ö–æ–¥–Ω—ã–π –∫–æ–¥ –ø—Ä–æ–µ–∫—Ç–∞ –¥–ª—è AI-–ø–æ–º–æ—â–Ω–∏–∫–∞

## üîó –ë—ã—Å—Ç—Ä–∞—è –Ω–∞–≤–∏–≥–∞—Ü–∏—è –ø–æ —Ñ–∞–π–ª–∞–º
- [RentalApp_FASTAPI/Dockerfile.backend](#RentalAppFASTAPIDockerfilebackend)
- [RentalApp_FASTAPI/api/__init__.py](#RentalAppFASTAPIapiinitpy)
- [RentalApp_FASTAPI/api/accessory_api.py](#RentalAppFASTAPIapiaccessoryapipy)
- [RentalApp_FASTAPI/api/admin_dashboard_api.py](#RentalAppFASTAPIapiadmindashboardapipy)
- [RentalApp_FASTAPI/api/admin_rental_api.py](#RentalAppFASTAPIapiadminrentalapipy)
- [RentalApp_FASTAPI/api/admin_reservation_api.py](#RentalAppFASTAPIapiadminreservationapipy)
- [RentalApp_FASTAPI/api/association_api.py](#RentalAppFASTAPIapiassociationapipy)
- [RentalApp_FASTAPI/api/auth_api.py](#RentalAppFASTAPIapiauthapipy)
- [RentalApp_FASTAPI/api/calendar_api.py](#RentalAppFASTAPIapicalendarapipy)
- [RentalApp_FASTAPI/api/database.py](#RentalAppFASTAPIapidatabasepy)
- [RentalApp_FASTAPI/api/deps.py](#RentalAppFASTAPIapidepspy)
- [RentalApp_FASTAPI/api/discount_api.py](#RentalAppFASTAPIapidiscountapipy)
- [RentalApp_FASTAPI/api/equipment_api.py](#RentalAppFASTAPIapiequipmentapipy)
- [RentalApp_FASTAPI/api/holiday_api.py](#RentalAppFASTAPIapiholidayapipy)
- [RentalApp_FASTAPI/api/init_models.py](#RentalAppFASTAPIapiinitmodelspy)
- [RentalApp_FASTAPI/api/main_api.py](#RentalAppFASTAPIapimainapipy)
- [RentalApp_FASTAPI/api/models/__init__.py](#RentalAppFASTAPIapimodelsinitpy)
- [RentalApp_FASTAPI/api/models/accessory.py](#RentalAppFASTAPIapimodelsaccessorypy)
- [RentalApp_FASTAPI/api/models/association.py](#RentalAppFASTAPIapimodelsassociationpy)
- [RentalApp_FASTAPI/api/models/balance_history.py](#RentalAppFASTAPIapimodelsbalancehistorypy)
- [RentalApp_FASTAPI/api/models/discount.py](#RentalAppFASTAPIapimodelsdiscountpy)
- [RentalApp_FASTAPI/api/models/equipment.py](#RentalAppFASTAPIapimodelsequipmentpy)
- [RentalApp_FASTAPI/api/models/holiday.py](#RentalAppFASTAPIapimodelsholidaypy)
- [RentalApp_FASTAPI/api/models/payment.py](#RentalAppFASTAPIapimodelspaymentpy)
- [RentalApp_FASTAPI/api/models/promo_code.py](#RentalAppFASTAPIapimodelspromocodepy)
- [RentalApp_FASTAPI/api/models/rental.py](#RentalAppFASTAPIapimodelsrentalpy)
- [RentalApp_FASTAPI/api/models/reservation.py](#RentalAppFASTAPIapimodelsreservationpy)
- [RentalApp_FASTAPI/api/models/user.py](#RentalAppFASTAPIapimodelsuserpy)
- [RentalApp_FASTAPI/api/permissions.py](#RentalAppFASTAPIapipermissionspy)
- [RentalApp_FASTAPI/api/promo_code_api.py](#RentalAppFASTAPIapipromocodeapipy)
- [RentalApp_FASTAPI/api/reservation_api.py](#RentalAppFASTAPIapireservationapipy)
- [RentalApp_FASTAPI/api/router.py](#RentalAppFASTAPIapirouterpy)
- [RentalApp_FASTAPI/api/services/.pytest_cache/README.md](#RentalAppFASTAPIapiservicespytestcacheREADMEmd)
- [RentalApp_FASTAPI/api/services/auth_service.py](#RentalAppFASTAPIapiservicesauthservicepy)
- [RentalApp_FASTAPI/api/services/availability/__init__.py](#RentalAppFASTAPIapiservicesavailabilityinitpy)
- [RentalApp_FASTAPI/api/services/availability/availability_service.py](#RentalAppFASTAPIapiservicesavailabilityavailabilityservicepy)
- [RentalApp_FASTAPI/api/services/availability/base.py](#RentalAppFASTAPIapiservicesavailabilitybasepy)
- [RentalApp_FASTAPI/api/services/availability/calendar.py](#RentalAppFASTAPIapiservicesavailabilitycalendarpy)
- [RentalApp_FASTAPI/api/services/availability/conflicts.py](#RentalAppFASTAPIapiservicesavailabilityconflictspy)
- [RentalApp_FASTAPI/api/services/availability/queries.py](#RentalAppFASTAPIapiservicesavailabilityqueriespy)
- [RentalApp_FASTAPI/api/services/availability/statuses.py](#RentalAppFASTAPIapiservicesavailabilitystatusespy)
- [RentalApp_FASTAPI/api/services/balance_service.py](#RentalAppFASTAPIapiservicesbalanceservicepy)
- [RentalApp_FASTAPI/api/services/dashboard/README.md](#RentalAppFASTAPIapiservicesdashboardREADMEmd)
- [RentalApp_FASTAPI/api/services/dashboard/__init__.py](#RentalAppFASTAPIapiservicesdashboardinitpy)
- [RentalApp_FASTAPI/api/services/dashboard/activity_service.py](#RentalAppFASTAPIapiservicesdashboardactivityservicepy)
- [RentalApp_FASTAPI/api/services/dashboard/base.py](#RentalAppFASTAPIapiservicesdashboardbasepy)
- [RentalApp_FASTAPI/api/services/dashboard/dashboard_service.py](#RentalAppFASTAPIapiservicesdashboarddashboardservicepy)
- [RentalApp_FASTAPI/api/services/dashboard/equipment_service.py](#RentalAppFASTAPIapiservicesdashboardequipmentservicepy)
- [RentalApp_FASTAPI/api/services/dashboard/focus_service.py](#RentalAppFASTAPIapiservicesdashboardfocusservicepy)
- [RentalApp_FASTAPI/api/services/dashboard/kpi_service.py](#RentalAppFASTAPIapiservicesdashboardkpiservicepy)
- [RentalApp_FASTAPI/api/services/dashboard_service.py](#RentalAppFASTAPIapiservicesdashboardservicepy)
- [RentalApp_FASTAPI/api/services/discount_service.py](#RentalAppFASTAPIapiservicesdiscountservicepy)
- [RentalApp_FASTAPI/api/services/equipment_query_builder.py](#RentalAppFASTAPIapiservicesequipmentquerybuilderpy)
- [RentalApp_FASTAPI/api/services/equipment_service_api.py](#RentalAppFASTAPIapiservicesequipmentserviceapipy)
- [RentalApp_FASTAPI/api/services/financial_service.py](#RentalAppFASTAPIapiservicesfinancialservicepy)
- [RentalApp_FASTAPI/api/services/order/__init__.py](#RentalAppFASTAPIapiservicesorderinitpy)
- [RentalApp_FASTAPI/api/services/order/order_lifecycle_service.py](#RentalAppFASTAPIapiservicesorderorderlifecycleservicepy)
- [RentalApp_FASTAPI/api/services/order/order_query_base.py](#RentalAppFASTAPIapiservicesorderorderquerybasepy)
- [RentalApp_FASTAPI/api/services/order/order_repository.py](#RentalAppFASTAPIapiservicesorderorderrepositorypy)
- [RentalApp_FASTAPI/api/services/order/order_validator.py](#RentalAppFASTAPIapiservicesorderordervalidatorpy)
- [RentalApp_FASTAPI/api/services/promo_code/__init__.py](#RentalAppFASTAPIapiservicespromocodeinitpy)
- [RentalApp_FASTAPI/api/services/promo_code/constants.py](#RentalAppFASTAPIapiservicespromocodeconstantspy)
- [RentalApp_FASTAPI/api/services/promo_code/exceptions.py](#RentalAppFASTAPIapiservicespromocodeexceptionspy)
- [RentalApp_FASTAPI/api/services/promo_code/factory.py](#RentalAppFASTAPIapiservicespromocodefactorypy)
- [RentalApp_FASTAPI/api/services/promo_code/interfaces.py](#RentalAppFASTAPIapiservicespromocodeinterfacespy)
- [RentalApp_FASTAPI/api/services/promo_code/promo_code_business_logic.py](#RentalAppFASTAPIapiservicespromocodepromocodebusinesslogicpy)
- [RentalApp_FASTAPI/api/services/promo_code/promo_code_manager.py](#RentalAppFASTAPIapiservicespromocodepromocodemanagerpy)
- [RentalApp_FASTAPI/api/services/promo_code/promo_code_validator.py](#RentalAppFASTAPIapiservicespromocodepromocodevalidatorpy)
- [RentalApp_FASTAPI/api/services/promo_code_service.py](#RentalAppFASTAPIapiservicespromocodeservicepy)
- [RentalApp_FASTAPI/api/services/rental/__init__.py](#RentalAppFASTAPIapiservicesrentalinitpy)
- [RentalApp_FASTAPI/api/services/rental/rental_query_service.py](#RentalAppFASTAPIapiservicesrentalrentalqueryservicepy)
- [RentalApp_FASTAPI/api/services/reservation_query_service.py](#RentalAppFASTAPIapiservicesreservationqueryservicepy)
- [RentalApp_FASTAPI/api/services/user_service.py](#RentalAppFASTAPIapiservicesuserservicepy)
- [RentalApp_FASTAPI/api/user_api.py](#RentalAppFASTAPIapiuserapipy)
- [RentalApp_FASTAPI/config/__init__.py](#RentalAppFASTAPIconfiginitpy)
- [RentalApp_FASTAPI/config/logging_config.py](#RentalAppFASTAPIconfigloggingconfigpy)
- [RentalApp_FASTAPI/config/secrets.py](#RentalAppFASTAPIconfigsecretspy)
- [RentalApp_FASTAPI/config/settings.py](#RentalAppFASTAPIconfigsettingspy)
- [RentalApp_FASTAPI/create_admin.py](#RentalAppFASTAPIcreateadminpy)
- [RentalApp_FASTAPI/db/init_db.py](#RentalAppFASTAPIdbinitdbpy)
- [RentalApp_FASTAPI/migrations/env.py](#RentalAppFASTAPImigrationsenvpy)
- [RentalApp_FASTAPI/migrations/versions/9290ae79b0d3_create_initial_tables.py](#RentalAppFASTAPImigrationsversions9290ae79b0d3createinitialtablespy)
- [RentalApp_FASTAPI/scripts/populate_associations.py](#RentalAppFASTAPIscriptspopulateassociationspy)
- [RentalApp_FASTAPI/scripts/populate_discounts.py](#RentalAppFASTAPIscriptspopulatediscountspy)
- [RentalApp_FASTAPI/scripts/recalculate_balances.py](#RentalAppFASTAPIscriptsrecalculatebalancespy)
- [RentalApp_FASTAPI/shared/schemas/accessory_schema.py](#RentalAppFASTAPIsharedschemasaccessoryschemapy)
- [RentalApp_FASTAPI/shared/schemas/association_schema.py](#RentalAppFASTAPIsharedschemasassociationschemapy)
- [RentalApp_FASTAPI/shared/schemas/balance_history_schema.py](#RentalAppFASTAPIsharedschemasbalancehistoryschemapy)
- [RentalApp_FASTAPI/shared/schemas/calendar_schema.py](#RentalAppFASTAPIsharedschemascalendarschemapy)
- [RentalApp_FASTAPI/shared/schemas/common_financials.py](#RentalAppFASTAPIsharedschemascommonfinancialspy)
- [RentalApp_FASTAPI/shared/schemas/dashboard_schema.py](#RentalAppFASTAPIsharedschemasdashboardschemapy)
- [RentalApp_FASTAPI/shared/schemas/discount_schema.py](#RentalAppFASTAPIsharedschemasdiscountschemapy)
- [RentalApp_FASTAPI/shared/schemas/equipment_schema.py](#RentalAppFASTAPIsharedschemasequipmentschemapy)
- [RentalApp_FASTAPI/shared/schemas/holiday_schema.py](#RentalAppFASTAPIsharedschemasholidayschemapy)
- [RentalApp_FASTAPI/shared/schemas/promo_code_schema.py](#RentalAppFASTAPIsharedschemaspromocodeschemapy)
- [RentalApp_FASTAPI/shared/schemas/rental_schema.py](#RentalAppFASTAPIsharedschemasrentalschemapy)
- [RentalApp_FASTAPI/shared/schemas/reservation_schema.py](#RentalAppFASTAPIsharedschemasreservationschemapy)
- [RentalApp_FASTAPI/shared/schemas/user_schema.py](#RentalAppFASTAPIsharedschemasuserschemapy)
- [RentalApp_FASTAPI/smart_python_code_FastAPI.md](#RentalAppFASTAPIsmartpythoncodeFastAPImd)
- [RentalApp_FASTAPI/split.py](#RentalAppFASTAPIsplitpy)
- [RentalApp_FASTAPI/split_api.py](#RentalAppFASTAPIsplitapipy)
- [RentalApp_FASTAPI/split_txt.py](#RentalAppFASTAPIsplittxtpy)
- [docker-compose.yml](#dockercomposeyml)
- [rental-app-main/Dockerfile.frontend](#rentalappmainDockerfilefrontend)
- [rental-app-main/README_AI.md](#rentalappmainREADMEAImd)
- [rental-app-main/components.json](#rentalappmaincomponentsjson)
- [rental-app-main/eslint.config.js](#rentalappmaineslintconfigjs)
- [rental-app-main/nginx/nginx.conf](#rentalappmainnginxnginxconf)
- [rental-app-main/package.json](#rentalappmainpackagejson)
- [rental-app-main/postcss.config.js](#rentalappmainpostcssconfigjs)
- [rental-app-main/public/favicon.svg](#rentalappmainpublicfaviconsvg)
- [rental-app-main/public/vite.svg](#rentalappmainpublicvitesvg)
- [rental-app-main/rental_app_main/README.md](#rentalappmainrentalappmainREADMEmd)
- [rental-app-main/smart_react_code_gem_v2.md](#rentalappmainsmartreactcodegemv2md)
- [rental-app-main/split.py](#rentalappmainsplitpy)
- [rental-app-main/split_optimized.py](#rentalappmainsplitoptimizedpy)
- [rental-app-main/split_optimized_gem.py](#rentalappmainsplitoptimizedgempy)
- [rental-app-main/split_optimized_gem_NEW_1.py](#rentalappmainsplitoptimizedgemNEW1py)
- [rental-app-main/split_optimized_grok.py](#rentalappmainsplitoptimizedgrokpy)
- [rental-app-main/src/app/App.tsx](#rentalappmainsrcappApptsx)
- [rental-app-main/src/assets/react.svg](#rentalappmainsrcassetsreactsvg)
- [rental-app-main/src/components/AssociationFilter.tsx](#rentalappmainsrccomponentsAssociationFiltertsx)
- [rental-app-main/src/components/AuthForm.tsx](#rentalappmainsrccomponentsAuthFormtsx)
- [rental-app-main/src/components/AuthStatus.tsx](#rentalappmainsrccomponentsAuthStatustsx)
- [rental-app-main/src/components/AvailabilityStrip.tsx](#rentalappmainsrccomponentsAvailabilityStriptsx)
- [rental-app-main/src/components/AvailableCheckbox.tsx](#rentalappmainsrccomponentsAvailableCheckboxtsx)
- [rental-app-main/src/components/BrandFilter.tsx](#rentalappmainsrccomponentsBrandFiltertsx)
- [rental-app-main/src/components/CancelReservationDialog.tsx](#rentalappmainsrccomponentsCancelReservationDialogtsx)
- [rental-app-main/src/components/CardShell.tsx](#rentalappmainsrccomponentsCardShelltsx)
- [rental-app-main/src/components/CompactEquipmentCard.tsx](#rentalappmainsrccomponentsCompactEquipmentCardtsx)
- [rental-app-main/src/components/ConfirmItemRemovalDialog.tsx](#rentalappmainsrccomponentsConfirmItemRemovalDialogtsx)
- [rental-app-main/src/components/DateRangeSelector.tsx](#rentalappmainsrccomponentsDateRangeSelectortsx)
- [rental-app-main/src/components/DateRangeSelector/calendar.css](#rentalappmainsrccomponentsDateRangeSelectorcalendarcss)
- [rental-app-main/src/components/DiscountCalculator.tsx](#rentalappmainsrccomponentsDiscountCalculatortsx)
- [rental-app-main/src/components/EquipmentGrid.tsx](#rentalappmainsrccomponentsEquipmentGridtsx)
- [rental-app-main/src/components/ErrorBoundary.tsx](#rentalappmainsrccomponentsErrorBoundarytsx)
- [rental-app-main/src/components/ErrorMessage.tsx](#rentalappmainsrccomponentsErrorMessagetsx)
- [rental-app-main/src/components/FilterPanel.tsx](#rentalappmainsrccomponentsFilterPaneltsx)
- [rental-app-main/src/components/MyReservationList.tsx](#rentalappmainsrccomponentsMyReservationListtsx)
- [rental-app-main/src/components/NetworkStatus.tsx](#rentalappmainsrccomponentsNetworkStatustsx)
- [rental-app-main/src/components/PromoCodeInput.tsx](#rentalappmainsrccomponentsPromoCodeInputtsx)
- [rental-app-main/src/components/RequireAuth.tsx](#rentalappmainsrccomponentsRequireAuthtsx)
- [rental-app-main/src/components/ReservationCard.tsx](#rentalappmainsrccomponentsReservationCardtsx)
- [rental-app-main/src/components/ReservationFooter.tsx](#rentalappmainsrccomponentsReservationFootertsx)
- [rental-app-main/src/components/ReservationList.tsx](#rentalappmainsrccomponentsReservationListtsx)
- [rental-app-main/src/components/ReserveEquipmentCard.tsx](#rentalappmainsrccomponentsReserveEquipmentCardtsx)
- [rental-app-main/src/components/SearchInput.tsx](#rentalappmainsrccomponentsSearchInputtsx)
- [rental-app-main/src/components/StatusBadge.tsx](#rentalappmainsrccomponentsStatusBadgetsx)
- [rental-app-main/src/components/TypeFilter.tsx](#rentalappmainsrccomponentsTypeFiltertsx)
- [rental-app-main/src/components/UserInfoBlock.tsx](#rentalappmainsrccomponentsUserInfoBlocktsx)
- [rental-app-main/src/components/ViewModeToggle.tsx](#rentalappmainsrccomponentsViewModeToggletsx)
- [rental-app-main/src/components/admin/AccessoryDialogs.tsx](#rentalappmainsrccomponentsadminAccessoryDialogstsx)
- [rental-app-main/src/components/admin/AccessoryTable.tsx](#rentalappmainsrccomponentsadminAccessoryTabletsx)
- [rental-app-main/src/components/admin/AdminNavigation.tsx](#rentalappmainsrccomponentsadminAdminNavigationtsx)
- [rental-app-main/src/components/admin/AdminRentalCard.tsx](#rentalappmainsrccomponentsadminAdminRentalCardtsx)
- [rental-app-main/src/components/admin/AdminReservationCard.tsx](#rentalappmainsrccomponentsadminAdminReservationCardtsx)
- [rental-app-main/src/components/admin/AdminReservationToolbar.tsx](#rentalappmainsrccomponentsadminAdminReservationToolbartsx)
- [rental-app-main/src/components/admin/AllRentalsList.tsx](#rentalappmainsrccomponentsadminAllRentalsListtsx)
- [rental-app-main/src/components/admin/AllReservationsList.tsx](#rentalappmainsrccomponentsadminAllReservationsListtsx)
- [rental-app-main/src/components/admin/AssociationTable.tsx](#rentalappmainsrccomponentsadminAssociationTabletsx)
- [rental-app-main/src/components/admin/ConvertReservationDialog.tsx](#rentalappmainsrccomponentsadminConvertReservationDialogtsx)
- [rental-app-main/src/components/admin/CreateReservationDialog.tsx](#rentalappmainsrccomponentsadminCreateReservationDialogtsx)
- [rental-app-main/src/components/admin/CreateReservationStep1Details.tsx](#rentalappmainsrccomponentsadminCreateReservationStep1Detailstsx)
- [rental-app-main/src/components/admin/CreateReservationStep2Accessories.tsx](#rentalappmainsrccomponentsadminCreateReservationStep2Accessoriestsx)
- [rental-app-main/src/components/admin/DurationDiscountManager.tsx](#rentalappmainsrccomponentsadminDurationDiscountManagertsx)
- [rental-app-main/src/components/admin/EditableRentalCard.tsx](#rentalappmainsrccomponentsadminEditableRentalCardtsx)
- [rental-app-main/src/components/admin/EquipmentCreateDialog.tsx](#rentalappmainsrccomponentsadminEquipmentCreateDialogtsx)
- [rental-app-main/src/components/admin/EquipmentEditDialog.tsx](#rentalappmainsrccomponentsadminEquipmentEditDialogtsx)
- [rental-app-main/src/components/admin/EquipmentStats.tsx](#rentalappmainsrccomponentsadminEquipmentStatstsx)
- [rental-app-main/src/components/admin/EquipmentTable.tsx](#rentalappmainsrccomponentsadminEquipmentTabletsx)
- [rental-app-main/src/components/admin/EquipmentTableRow.tsx](#rentalappmainsrccomponentsadminEquipmentTableRowtsx)
- [rental-app-main/src/components/admin/EquipmentTableToolbar.tsx](#rentalappmainsrccomponentsadminEquipmentTableToolbartsx)
- [rental-app-main/src/components/admin/HolidayManager.tsx](#rentalappmainsrccomponentsadminHolidayManagertsx)
- [rental-app-main/src/components/admin/PromoCodeDialog.tsx](#rentalappmainsrccomponentsadminPromoCodeDialogtsx)
- [rental-app-main/src/components/admin/PromoCodeTable.tsx](#rentalappmainsrccomponentsadminPromoCodeTabletsx)
- [rental-app-main/src/components/admin/RentalStatusBadge.tsx](#rentalappmainsrccomponentsadminRentalStatusBadgetsx)
- [rental-app-main/src/components/admin/ReservationFinancialSummary.tsx](#rentalappmainsrccomponentsadminReservationFinancialSummarytsx)
- [rental-app-main/src/components/admin/ReturnAccessoriesChecklist.tsx](#rentalappmainsrccomponentsadminReturnAccessoriesChecklisttsx)
- [rental-app-main/src/components/admin/ReturnFinancials.tsx](#rentalappmainsrccomponentsadminReturnFinancialstsx)
- [rental-app-main/src/components/admin/ReturnRentalDialog.tsx](#rentalappmainsrccomponentsadminReturnRentalDialogtsx)
- [rental-app-main/src/components/admin/UserCreateDialog.tsx](#rentalappmainsrccomponentsadminUserCreateDialogtsx)
- [rental-app-main/src/components/admin/UserEditDialog.tsx](#rentalappmainsrccomponentsadminUserEditDialogtsx)
- [rental-app-main/src/components/admin/UserPaymentDialog.tsx](#rentalappmainsrccomponentsadminUserPaymentDialogtsx)
- [rental-app-main/src/components/admin/UserTable.tsx](#rentalappmainsrccomponentsadminUserTabletsx)
- [rental-app-main/src/components/admin/UserTableRow.tsx](#rentalappmainsrccomponentsadminUserTableRowtsx)
- [rental-app-main/src/components/admin/UserTableToolbar.tsx](#rentalappmainsrccomponentsadminUserTableToolbartsx)
- [rental-app-main/src/components/admin/dashboard/ActivityFeedWidget.tsx](#rentalappmainsrccomponentsadmindashboardActivityFeedWidgettsx)
- [rental-app-main/src/components/admin/dashboard/KpiCardsWidget.tsx](#rentalappmainsrccomponentsadmindashboardKpiCardsWidgettsx)
- [rental-app-main/src/components/admin/dashboard/PopularEquipmentChart.tsx](#rentalappmainsrccomponentsadmindashboardPopularEquipmentCharttsx)
- [rental-app-main/src/components/admin/dashboard/TodayFocusWidget.tsx](#rentalappmainsrccomponentsadmindashboardTodayFocusWidgettsx)
- [rental-app-main/src/components/calendar/CalendarDateInputRange.tsx](#rentalappmainsrccomponentscalendarCalendarDateInputRangetsx)
- [rental-app-main/src/components/calendar/CalendarFiltersBlock.tsx](#rentalappmainsrccomponentscalendarCalendarFiltersBlocktsx)
- [rental-app-main/src/components/calendar/CalendarTable.tsx](#rentalappmainsrccomponentscalendarCalendarTabletsx)
- [rental-app-main/src/components/catalog/EquipmentCatalog.tsx](#rentalappmainsrccomponentscatalogEquipmentCatalogtsx)
- [rental-app-main/src/components/equipment-card/AccessoriesSection.tsx](#rentalappmainsrccomponentsequipmentcardAccessoriesSectiontsx)
- [rental-app-main/src/components/equipment-card/CardFooter.tsx](#rentalappmainsrccomponentsequipmentcardCardFootertsx)
- [rental-app-main/src/components/equipment-card/CardImage.tsx](#rentalappmainsrccomponentsequipmentcardCardImagetsx)
- [rental-app-main/src/components/equipment-card/DiscountInfo.tsx](#rentalappmainsrccomponentsequipmentcardDiscountInfotsx)
- [rental-app-main/src/components/equipment-card/EquipmentCard.tsx](#rentalappmainsrccomponentsequipmentcardEquipmentCardtsx)
- [rental-app-main/src/components/equipment-card/constants.ts](#rentalappmainsrccomponentsequipmentcardconstantsts)
- [rental-app-main/src/components/equipment-card/index.ts](#rentalappmainsrccomponentsequipmentcardindexts)
- [rental-app-main/src/components/equipment/EquipmentDetailsDialog.tsx](#rentalappmainsrccomponentsequipmentEquipmentDetailsDialogtsx)
- [rental-app-main/src/components/equipment/EquipmentDetailsView.tsx](#rentalappmainsrccomponentsequipmentEquipmentDetailsViewtsx)
- [rental-app-main/src/components/equipment/EquipmentEditForm.tsx](#rentalappmainsrccomponentsequipmentEquipmentEditFormtsx)
- [rental-app-main/src/components/profile/BalanceHistoryTable.tsx](#rentalappmainsrccomponentsprofileBalanceHistoryTabletsx)
- [rental-app-main/src/components/rental/MyRentalCard.tsx](#rentalappmainsrccomponentsrentalMyRentalCardtsx)
- [rental-app-main/src/components/rental/MyRentalsList.tsx](#rentalappmainsrccomponentsrentalMyRentalsListtsx)
- [rental-app-main/src/components/rental/RentalStatusBadge.tsx](#rentalappmainsrccomponentsrentalRentalStatusBadgetsx)
- [rental-app-main/src/components/reservation/AvailableAccessoriesDropdown.tsx](#rentalappmainsrccomponentsreservationAvailableAccessoriesDropdowntsx)
- [rental-app-main/src/components/reservation/EditableDateRange.tsx](#rentalappmainsrccomponentsreservationEditableDateRangetsx)
- [rental-app-main/src/components/reservation/EditableEquipmentItem.tsx](#rentalappmainsrccomponentsreservationEditableEquipmentItemtsx)
- [rental-app-main/src/components/reservation/EditableReservationCard.tsx](#rentalappmainsrccomponentsreservationEditableReservationCardtsx)
- [rental-app-main/src/components/reservation/EquipmentItemWithConflicts.tsx](#rentalappmainsrccomponentsreservationEquipmentItemWithConflictstsx)
- [rental-app-main/src/components/reservation/HolidayConfirmationDialog.tsx](#rentalappmainsrccomponentsreservationHolidayConfirmationDialogtsx)
- [rental-app-main/src/components/reservation/ReservationItemsList.tsx](#rentalappmainsrccomponentsreservationReservationItemsListtsx)
- [rental-app-main/src/components/reservation/ReservationStatusBadge.tsx](#rentalappmainsrccomponentsreservationReservationStatusBadgetsx)
- [rental-app-main/src/components/reservation/ViewReservationCard.tsx](#rentalappmainsrccomponentsreservationViewReservationCardtsx)
- [rental-app-main/src/components/session/UserSession.tsx](#rentalappmainsrccomponentssessionUserSessiontsx)
- [rental-app-main/src/components/shared/EquipmentWithAccessoriesList.tsx](#rentalappmainsrccomponentssharedEquipmentWithAccessoriesListtsx)
- [rental-app-main/src/components/shared/FinancialInfoBlock.tsx](#rentalappmainsrccomponentssharedFinancialInfoBlocktsx)
- [rental-app-main/src/components/shared/FinancialSummaryBlock.tsx](#rentalappmainsrccomponentssharedFinancialSummaryBlocktsx)
- [rental-app-main/src/components/shared/OrderToolbar.tsx](#rentalappmainsrccomponentssharedOrderToolbartsx)
- [rental-app-main/src/components/ui/AdminButton.tsx](#rentalappmainsrccomponentsuiAdminButtontsx)
- [rental-app-main/src/components/ui/CreatableSelect.tsx](#rentalappmainsrccomponentsuiCreatableSelecttsx)
- [rental-app-main/src/components/ui/alert.tsx](#rentalappmainsrccomponentsuialerttsx)
- [rental-app-main/src/components/ui/badge.tsx](#rentalappmainsrccomponentsuibadgetsx)
- [rental-app-main/src/components/ui/button.tsx](#rentalappmainsrccomponentsuibuttontsx)
- [rental-app-main/src/components/ui/card.tsx](#rentalappmainsrccomponentsuicardtsx)
- [rental-app-main/src/components/ui/checkbox.tsx](#rentalappmainsrccomponentsuicheckboxtsx)
- [rental-app-main/src/components/ui/command.tsx](#rentalappmainsrccomponentsuicommandtsx)
- [rental-app-main/src/components/ui/confirmation-dialog.tsx](#rentalappmainsrccomponentsuiconfirmationdialogtsx)
- [rental-app-main/src/components/ui/dialog.tsx](#rentalappmainsrccomponentsuidialogtsx)
- [rental-app-main/src/components/ui/filter-toggle.tsx](#rentalappmainsrccomponentsuifiltertoggletsx)
- [rental-app-main/src/components/ui/input.tsx](#rentalappmainsrccomponentsuiinputtsx)
- [rental-app-main/src/components/ui/label.tsx](#rentalappmainsrccomponentsuilabeltsx)
- [rental-app-main/src/components/ui/multi-select.tsx](#rentalappmainsrccomponentsuimultiselecttsx)
- [rental-app-main/src/components/ui/phone-input.md](#rentalappmainsrccomponentsuiphoneinputmd)
- [rental-app-main/src/components/ui/phone-input.tsx](#rentalappmainsrccomponentsuiphoneinputtsx)
- [rental-app-main/src/components/ui/popover.tsx](#rentalappmainsrccomponentsuipopovertsx)
- [rental-app-main/src/components/ui/scroll-area.tsx](#rentalappmainsrccomponentsuiscrollareatsx)
- [rental-app-main/src/components/ui/select.tsx](#rentalappmainsrccomponentsuiselecttsx)
- [rental-app-main/src/components/ui/skeleton.tsx](#rentalappmainsrccomponentsuiskeletontsx)
- [rental-app-main/src/components/ui/switch.tsx](#rentalappmainsrccomponentsuiswitchtsx)
- [rental-app-main/src/components/ui/table.tsx](#rentalappmainsrccomponentsuitabletsx)
- [rental-app-main/src/components/ui/textarea.tsx](#rentalappmainsrccomponentsuitextareatsx)
- [rental-app-main/src/components/ui/toggle-group.tsx](#rentalappmainsrccomponentsuitogglegrouptsx)
- [rental-app-main/src/components/ui/toggle.tsx](#rentalappmainsrccomponentsuitoggletsx)
- [rental-app-main/src/constants/equipmentConstants.ts](#rentalappmainsrcconstantsequipmentConstantsts)
- [rental-app-main/src/constants/paginationConstants.ts](#rentalappmainsrcconstantspaginationConstantsts)
- [rental-app-main/src/constants/statusStyles.ts](#rentalappmainsrcconstantsstatusStylests)
- [rental-app-main/src/constants/userConstants.ts](#rentalappmainsrcconstantsuserConstantsts)
- [rental-app-main/src/contexts/ReservationEditContext.tsx](#rentalappmainsrccontextsReservationEditContexttsx)
- [rental-app-main/src/core/services/AccessoryService.ts](#rentalappmainsrccoreservicesAccessoryServicets)
- [rental-app-main/src/core/services/AvailabilityService.ts](#rentalappmainsrccoreservicesAvailabilityServicets)
- [rental-app-main/src/core/services/CalendarService.ts](#rentalappmainsrccoreservicesCalendarServicets)
- [rental-app-main/src/core/services/DateService.ts](#rentalappmainsrccoreservicesDateServicets)
- [rental-app-main/src/core/services/EquipmentService.ts](#rentalappmainsrccoreservicesEquipmentServicets)
- [rental-app-main/src/core/services/PhoneService.ts](#rentalappmainsrccoreservicesPhoneServicets)
- [rental-app-main/src/core/services/PromoCodeService.ts](#rentalappmainsrccoreservicesPromoCodeServicets)
- [rental-app-main/src/core/services/ReservationService.ts](#rentalappmainsrccoreservicesReservationServicets)
- [rental-app-main/src/core/services/UserService.ts](#rentalappmainsrccoreservicesUserServicets)
- [rental-app-main/src/core/services/index.ts](#rentalappmainsrccoreservicesindexts)
- [rental-app-main/src/hooks/admin/create-reservation/useCreateReservationData.ts](#rentalappmainsrchooksadmincreatereservationuseCreateReservationDatats)
- [rental-app-main/src/hooks/admin/create-reservation/useCreateReservationDialog.ts](#rentalappmainsrchooksadmincreatereservationuseCreateReservationDialogts)
- [rental-app-main/src/hooks/admin/create-reservation/useCreateReservationForm.ts](#rentalappmainsrchooksadmincreatereservationuseCreateReservationFormts)
- [rental-app-main/src/hooks/admin/useAdminRentalEdit.ts](#rentalappmainsrchooksadminuseAdminRentalEditts)
- [rental-app-main/src/hooks/admin/useAdminReservationCalculator.ts](#rentalappmainsrchooksadminuseAdminReservationCalculatorts)
- [rental-app-main/src/hooks/admin/useDashboardData.ts](#rentalappmainsrchooksadminuseDashboardDatats)
- [rental-app-main/src/hooks/admin/useEquipmentTableLogic.ts](#rentalappmainsrchooksadminuseEquipmentTableLogicts)
- [rental-app-main/src/hooks/admin/useRentalReturnForm.ts](#rentalappmainsrchooksadminuseRentalReturnFormts)
- [rental-app-main/src/hooks/admin/useUserTableLogic.ts](#rentalappmainsrchooksadminuseUserTableLogicts)
- [rental-app-main/src/hooks/data/useEquipmentData.ts](#rentalappmainsrchooksdatauseEquipmentDatats)
- [rental-app-main/src/hooks/features/useAppFilters.ts](#rentalappmainsrchooksfeaturesuseAppFiltersts)
- [rental-app-main/src/hooks/features/useEquipmentCardViewModel.ts](#rentalappmainsrchooksfeaturesuseEquipmentCardViewModelts)
- [rental-app-main/src/hooks/reservation/submission/useReservationFormData.ts](#rentalappmainsrchooksreservationsubmissionuseReservationFormDatats)
- [rental-app-main/src/hooks/reservation/submission/useReserveSubmission.ts](#rentalappmainsrchooksreservationsubmissionuseReserveSubmissionts)
- [rental-app-main/src/hooks/reservation/usePriceCalculator.ts](#rentalappmainsrchooksreservationusePriceCalculatorts)
- [rental-app-main/src/hooks/reservation/useReservationActions.ts](#rentalappmainsrchooksreservationuseReservationActionsts)
- [rental-app-main/src/hooks/reservation/useReservationData.ts](#rentalappmainsrchooksreservationuseReservationDatats)
- [rental-app-main/src/hooks/reservation/useReservationEditState.ts](#rentalappmainsrchooksreservationuseReservationEditStatets)
- [rental-app-main/src/hooks/reservation/useReservationState.ts](#rentalappmainsrchooksreservationuseReservationStatets)
- [rental-app-main/src/hooks/useAdminAccessories.ts](#rentalappmainsrchooksuseAdminAccessoriests)
- [rental-app-main/src/hooks/useAdminAssociations.ts](#rentalappmainsrchooksuseAdminAssociationsts)
- [rental-app-main/src/hooks/useAdminDiscounts.ts](#rentalappmainsrchooksuseAdminDiscountsts)
- [rental-app-main/src/hooks/useAdminEquipment.ts](#rentalappmainsrchooksuseAdminEquipmentts)
- [rental-app-main/src/hooks/useAdminHolidayRules.ts](#rentalappmainsrchooksuseAdminHolidayRulests)
- [rental-app-main/src/hooks/useAdminHolidays.ts](#rentalappmainsrchooksuseAdminHolidaysts)
- [rental-app-main/src/hooks/useAdminPromoCodes.ts](#rentalappmainsrchooksuseAdminPromoCodests)
- [rental-app-main/src/hooks/useAdminRentals.ts](#rentalappmainsrchooksuseAdminRentalsts)
- [rental-app-main/src/hooks/useAdminReservations.ts](#rentalappmainsrchooksuseAdminReservationsts)
- [rental-app-main/src/hooks/useAdminUsers.ts](#rentalappmainsrchooksuseAdminUsersts)
- [rental-app-main/src/hooks/useAllEquipment.ts](#rentalappmainsrchooksuseAllEquipmentts)
- [rental-app-main/src/hooks/useAssociations.ts](#rentalappmainsrchooksuseAssociationsts)
- [rental-app-main/src/hooks/useAvailabilityCheck.ts](#rentalappmainsrchooksuseAvailabilityCheckts)
- [rental-app-main/src/hooks/useBalanceHistory.ts](#rentalappmainsrchooksuseBalanceHistoryts)
- [rental-app-main/src/hooks/useCalendarGrid.ts](#rentalappmainsrchooksuseCalendarGridts)
- [rental-app-main/src/hooks/useDailyAvailability.ts](#rentalappmainsrchooksuseDailyAvailabilityts)
- [rental-app-main/src/hooks/useDateRange.ts](#rentalappmainsrchooksuseDateRangets)
- [rental-app-main/src/hooks/useEditReservation.ts](#rentalappmainsrchooksuseEditReservationts)
- [rental-app-main/src/hooks/useEquipment.ts](#rentalappmainsrchooksuseEquipmentts)
- [rental-app-main/src/hooks/useEquipmentAvailability.ts](#rentalappmainsrchooksuseEquipmentAvailabilityts)
- [rental-app-main/src/hooks/useEquipmentMap.ts](#rentalappmainsrchooksuseEquipmentMapts)
- [rental-app-main/src/hooks/useErrorHandler.ts](#rentalappmainsrchooksuseErrorHandlerts)
- [rental-app-main/src/hooks/useInlineReservationEdit.tsx](#rentalappmainsrchooksuseInlineReservationEdittsx)
- [rental-app-main/src/hooks/useMyRentals.ts](#rentalappmainsrchooksuseMyRentalsts)
- [rental-app-main/src/hooks/useNetworkStatus.ts](#rentalappmainsrchooksuseNetworkStatusts)
- [rental-app-main/src/hooks/usePhoneValidation.ts](#rentalappmainsrchooksusePhoneValidationts)
- [rental-app-main/src/hooks/useProfile.ts](#rentalappmainsrchooksuseProfilets)
- [rental-app-main/src/hooks/useReservationManagement.ts](#rentalappmainsrchooksuseReservationManagementts)
- [rental-app-main/src/hooks/useReservations.ts](#rentalappmainsrchooksuseReservationsts)
- [rental-app-main/src/hooks/useUpdateEquipmentDetails.ts](#rentalappmainsrchooksuseUpdateEquipmentDetailsts)
- [rental-app-main/src/hooks/useVisibleItems.ts](#rentalappmainsrchooksuseVisibleItemsts)
- [rental-app-main/src/index.css](#rentalappmainsrcindexcss)
- [rental-app-main/src/lib/api.ts](#rentalappmainsrclibapits)
- [rental-app-main/src/lib/queryClient.ts](#rentalappmainsrclibqueryClientts)
- [rental-app-main/src/lib/queryHelpers.ts](#rentalappmainsrclibqueryHelpersts)
- [rental-app-main/src/lib/sortingUtils.ts](#rentalappmainsrclibsortingUtilsts)
- [rental-app-main/src/lib/utils.ts](#rentalappmainsrclibutilsts)
- [rental-app-main/src/lib/validationSchemas.ts](#rentalappmainsrclibvalidationSchemasts)
- [rental-app-main/src/main.tsx](#rentalappmainsrcmaintsx)
- [rental-app-main/src/pages/AccessoryManagementPage.tsx](#rentalappmainsrcpagesAccessoryManagementPagetsx)
- [rental-app-main/src/pages/CalendarPage.tsx](#rentalappmainsrcpagesCalendarPagetsx)
- [rental-app-main/src/pages/CalendarTestPage.tsx](#rentalappmainsrcpagesCalendarTestPagetsx)
- [rental-app-main/src/pages/ContactPage.tsx](#rentalappmainsrcpagesContactPagetsx)
- [rental-app-main/src/pages/EquipmentManagementPage.tsx](#rentalappmainsrcpagesEquipmentManagementPagetsx)
- [rental-app-main/src/pages/HomePage.tsx](#rentalappmainsrcpagesHomePagetsx)
- [rental-app-main/src/pages/MyReservationsPage.tsx](#rentalappmainsrcpagesMyReservationsPagetsx)
- [rental-app-main/src/pages/ProfilePage.tsx](#rentalappmainsrcpagesProfilePagetsx)
- [rental-app-main/src/pages/ReservePage.tsx](#rentalappmainsrcpagesReservePagetsx)
- [rental-app-main/src/pages/UserManagementPage.tsx](#rentalappmainsrcpagesUserManagementPagetsx)
- [rental-app-main/src/pages/admin/AllReservationsManagementPage.tsx](#rentalappmainsrcpagesadminAllReservationsManagementPagetsx)
- [rental-app-main/src/pages/admin/AssociationManagementPage.tsx](#rentalappmainsrcpagesadminAssociationManagementPagetsx)
- [rental-app-main/src/pages/admin/DashboardPage.tsx](#rentalappmainsrcpagesadminDashboardPagetsx)
- [rental-app-main/src/pages/admin/HolidayManagementPage.tsx](#rentalappmainsrcpagesadminHolidayManagementPagetsx)
- [rental-app-main/src/pages/admin/PromoCodeManagementPage.tsx](#rentalappmainsrcpagesadminPromoCodeManagementPagetsx)
- [rental-app-main/src/pages/admin/RentalManagementPage.tsx](#rentalappmainsrcpagesadminRentalManagementPagetsx)
- [rental-app-main/src/store/adminReservationSelectionStore.ts](#rentalappmainsrcstoreadminReservationSelectionStorets)
- [rental-app-main/src/store/authStore.ts](#rentalappmainsrcstoreauthStorets)
- [rental-app-main/src/store/calendarSelectionStore.ts](#rentalappmainsrcstorecalendarSelectionStorets)
- [rental-app-main/src/store/dateStore.ts](#rentalappmainsrcstoredateStorets)
- [rental-app-main/src/store/filterStore.ts](#rentalappmainsrcstorefilterStorets)
- [rental-app-main/src/store/holidayStore.ts](#rentalappmainsrcstoreholidayStorets)
- [rental-app-main/src/store/orderFilterStore.ts](#rentalappmainsrcstoreorderFilterStorets)
- [rental-app-main/src/store/promoCodeStore.ts](#rentalappmainsrcstorepromoCodeStorets)
- [rental-app-main/src/store/reserveStore.ts](#rentalappmainsrcstorereserveStorets)
- [rental-app-main/src/store/sandboxCalculatorStore.ts](#rentalappmainsrcstoresandboxCalculatorStorets)
- [rental-app-main/src/store/searchStore.ts](#rentalappmainsrcstoresearchStorets)
- [rental-app-main/src/store/viewModeStore.ts](#rentalappmainsrcstoreviewModeStorets)
- [rental-app-main/src/types/accessory.ts](#rentalappmainsrctypesaccessoryts)
- [rental-app-main/src/types/association.ts](#rentalappmainsrctypesassociationts)
- [rental-app-main/src/types/availability.ts](#rentalappmainsrctypesavailabilityts)
- [rental-app-main/src/types/balanceHistory.ts](#rentalappmainsrctypesbalanceHistoryts)
- [rental-app-main/src/types/discount.ts](#rentalappmainsrctypesdiscountts)
- [rental-app-main/src/types/equipment.ts](#rentalappmainsrctypesequipmentts)
- [rental-app-main/src/types/holiday.ts](#rentalappmainsrctypesholidayts)
- [rental-app-main/src/types/promo_code.ts](#rentalappmainsrctypespromocodets)
- [rental-app-main/src/types/rental.ts](#rentalappmainsrctypesrentalts)
- [rental-app-main/src/types/reservation.ts](#rentalappmainsrctypesreservationts)
- [rental-app-main/src/types/user.ts](#rentalappmainsrctypesuserts)
- [rental-app-main/src/utils/phoneUtils.ts](#rentalappmainsrcutilsphoneUtilsts)
- [rental-app-main/src/vite-env.d.ts](#rentalappmainsrcviteenvdts)
- [rental-app-main/tailwind.config.js](#rentalappmaintailwindconfigjs)
- [rental-app-main/test_slider_sync.md](#rentalappmaintestslidersyncmd)
- [rental-app-main/tsconfig.app.json](#rentalappmaintsconfigappjson)
- [rental-app-main/tsconfig.json](#rentalappmaintsconfigjson)
- [rental-app-main/tsconfig.node.json](#rentalappmaintsconfignodejson)
- [rental-app-main/vite.config.ts](#rentalappmainviteconfigts)

---

# üìÅ –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –ø—Ä–æ–µ–∫—Ç–∞ (–∏–µ—Ä–∞—Ä—Ö–∏—è)
`S_Project_Docker/`
‚îú‚îÄ‚îÄ üê≥ `docker-compose.yml`
‚îú‚îÄ‚îÄ `RentalApp_FASTAPI/`
‚îÇ   ‚îú‚îÄ‚îÄ `api/`
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ üìÑ `__init__.py`
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ üìÑ `accessory_api.py`
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ üìÑ `admin_dashboard_api.py`
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ üìÑ `admin_rental_api.py`
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ üìÑ `admin_reservation_api.py`
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ üìÑ `association_api.py`
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ üìÑ `auth_api.py`
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ üìÑ `calendar_api.py`
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ üìÑ `database.py`
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ üìÑ `deps.py`
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ üìÑ `discount_api.py`
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ üìÑ `equipment_api.py`
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ üìÑ `holiday_api.py`
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ üìÑ `init_models.py`
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ üìÑ `main_api.py`
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ üìÑ `permissions.py`
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ üìÑ `promo_code_api.py`
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ üìÑ `reservation_api.py`
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ üìÑ `router.py`
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ üìÑ `user_api.py`
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ `models/`
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ üìÑ `__init__.py`
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ üìÑ `accessory.py`
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ üìÑ `association.py`
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ üìÑ `balance_history.py`
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ üìÑ `discount.py`
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ üìÑ `equipment.py`
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ üìÑ `holiday.py`
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ üìÑ `payment.py`
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ üìÑ `promo_code.py`
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ üìÑ `rental.py`
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ üìÑ `reservation.py`
‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ üìÑ `user.py`
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ `services/`
‚îÇ   ‚îÇ       ‚îú‚îÄ‚îÄ üìÑ `auth_service.py`
‚îÇ   ‚îÇ       ‚îú‚îÄ‚îÄ üìÑ `balance_service.py`
‚îÇ   ‚îÇ       ‚îú‚îÄ‚îÄ üìÑ `dashboard_service.py`
‚îÇ   ‚îÇ       ‚îú‚îÄ‚îÄ üìÑ `discount_service.py`
‚îÇ   ‚îÇ       ‚îú‚îÄ‚îÄ üìÑ `equipment_query_builder.py`
‚îÇ   ‚îÇ       ‚îú‚îÄ‚îÄ üìÑ `equipment_service_api.py`
‚îÇ   ‚îÇ       ‚îú‚îÄ‚îÄ üìÑ `financial_service.py`
‚îÇ   ‚îÇ       ‚îú‚îÄ‚îÄ üìÑ `promo_code_service.py`
‚îÇ   ‚îÇ       ‚îú‚îÄ‚îÄ üìÑ `reservation_query_service.py`
‚îÇ   ‚îÇ       ‚îî‚îÄ‚îÄ üìÑ `user_service.py`
‚îÇ   ‚îÇ       ‚îú‚îÄ‚îÄ `.pytest_cache/`
‚îÇ   ‚îÇ       ‚îÇ   ‚îî‚îÄ‚îÄ üìÑ `README.md`
‚îÇ   ‚îÇ       ‚îú‚îÄ‚îÄ `availability/`
‚îÇ   ‚îÇ       ‚îÇ   ‚îú‚îÄ‚îÄ üìÑ `__init__.py`
‚îÇ   ‚îÇ       ‚îÇ   ‚îú‚îÄ‚îÄ üìÑ `availability_service.py`
‚îÇ   ‚îÇ       ‚îÇ   ‚îú‚îÄ‚îÄ üìÑ `base.py`
‚îÇ   ‚îÇ       ‚îÇ   ‚îú‚îÄ‚îÄ üìÑ `calendar.py`
‚îÇ   ‚îÇ       ‚îÇ   ‚îú‚îÄ‚îÄ üìÑ `conflicts.py`
‚îÇ   ‚îÇ       ‚îÇ   ‚îú‚îÄ‚îÄ üìÑ `queries.py`
‚îÇ   ‚îÇ       ‚îÇ   ‚îî‚îÄ‚îÄ üìÑ `statuses.py`
‚îÇ   ‚îÇ       ‚îú‚îÄ‚îÄ `dashboard/`
‚îÇ   ‚îÇ       ‚îÇ   ‚îú‚îÄ‚îÄ üìÑ `__init__.py`
‚îÇ   ‚îÇ       ‚îÇ   ‚îú‚îÄ‚îÄ üìÑ `activity_service.py`
‚îÇ   ‚îÇ       ‚îÇ   ‚îú‚îÄ‚îÄ üìÑ `base.py`
‚îÇ   ‚îÇ       ‚îÇ   ‚îú‚îÄ‚îÄ üìÑ `dashboard_service.py`
‚îÇ   ‚îÇ       ‚îÇ   ‚îú‚îÄ‚îÄ üìÑ `equipment_service.py`
‚îÇ   ‚îÇ       ‚îÇ   ‚îú‚îÄ‚îÄ üìÑ `focus_service.py`
‚îÇ   ‚îÇ       ‚îÇ   ‚îú‚îÄ‚îÄ üìÑ `kpi_service.py`
‚îÇ   ‚îÇ       ‚îÇ   ‚îî‚îÄ‚îÄ üìÑ `README.md`
‚îÇ   ‚îÇ       ‚îú‚îÄ‚îÄ `order/`
‚îÇ   ‚îÇ       ‚îÇ   ‚îú‚îÄ‚îÄ üìÑ `__init__.py`
‚îÇ   ‚îÇ       ‚îÇ   ‚îú‚îÄ‚îÄ üìÑ `order_lifecycle_service.py`
‚îÇ   ‚îÇ       ‚îÇ   ‚îú‚îÄ‚îÄ üìÑ `order_query_base.py`
‚îÇ   ‚îÇ       ‚îÇ   ‚îú‚îÄ‚îÄ üìÑ `order_repository.py`
‚îÇ   ‚îÇ       ‚îÇ   ‚îî‚îÄ‚îÄ üìÑ `order_validator.py`
‚îÇ   ‚îÇ       ‚îú‚îÄ‚îÄ `promo_code/`
‚îÇ   ‚îÇ       ‚îÇ   ‚îú‚îÄ‚îÄ üìÑ `__init__.py`
‚îÇ   ‚îÇ       ‚îÇ   ‚îú‚îÄ‚îÄ üìÑ `constants.py`
‚îÇ   ‚îÇ       ‚îÇ   ‚îú‚îÄ‚îÄ üìÑ `exceptions.py`
‚îÇ   ‚îÇ       ‚îÇ   ‚îú‚îÄ‚îÄ üìÑ `factory.py`
‚îÇ   ‚îÇ       ‚îÇ   ‚îú‚îÄ‚îÄ üìÑ `interfaces.py`
‚îÇ   ‚îÇ       ‚îÇ   ‚îú‚îÄ‚îÄ üìÑ `promo_code_business_logic.py`
‚îÇ   ‚îÇ       ‚îÇ   ‚îú‚îÄ‚îÄ üìÑ `promo_code_manager.py`
‚îÇ   ‚îÇ       ‚îÇ   ‚îî‚îÄ‚îÄ üìÑ `promo_code_validator.py`
‚îÇ   ‚îÇ       ‚îî‚îÄ‚îÄ `rental/`
‚îÇ   ‚îÇ           ‚îú‚îÄ‚îÄ üìÑ `__init__.py`
‚îÇ   ‚îÇ           ‚îî‚îÄ‚îÄ üìÑ `rental_query_service.py`
‚îÇ   ‚îú‚îÄ‚îÄ `config/`
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ üìÑ `__init__.py`
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ üìÑ `logging_config.py`
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ üìÑ `secrets.py`
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ üìÑ `settings.py`
‚îÇ   ‚îú‚îÄ‚îÄ `db/`
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ üìÑ `init_db.py`
‚îÇ   ‚îú‚îÄ‚îÄ `migrations/`
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ üìÑ `env.py`
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ `versions/`
‚îÇ   ‚îÇ       ‚îî‚îÄ‚îÄ üìÑ `9290ae79b0d3_create_initial_tables.py`
‚îÇ   ‚îî‚îÄ‚îÄ `scripts/`
‚îÇ       ‚îú‚îÄ‚îÄ üìÑ `populate_associations.py`
‚îÇ       ‚îú‚îÄ‚îÄ üìÑ `populate_discounts.py`
‚îÇ       ‚îî‚îÄ‚îÄ üìÑ `recalculate_balances.py`
‚îú‚îÄ‚îÄ `nginx/`
‚îî‚îÄ‚îÄ `rental-app-main/`
    ‚îú‚îÄ‚îÄ `nginx/`
    ‚îÇ   ‚îî‚îÄ‚îÄ üìÑ `nginx.conf`
    ‚îú‚îÄ‚îÄ `public/`
    ‚îÇ   ‚îú‚îÄ‚îÄ üñºÔ∏è `favicon.svg`
    ‚îÇ   ‚îî‚îÄ‚îÄ üñºÔ∏è `vite.svg`
    ‚îú‚îÄ‚îÄ `rental_app_main/`
    ‚îÇ   ‚îî‚îÄ‚îÄ üìÑ `README.md`
    ‚îî‚îÄ‚îÄ `src/`
        ‚îú‚îÄ‚îÄ üìÑ `index.css`
        ‚îú‚îÄ‚îÄ üìÑ `main.tsx`
        ‚îî‚îÄ‚îÄ üìÑ `vite-env.d.ts`
        ‚îú‚îÄ‚îÄ `app/`
        ‚îÇ   ‚îî‚îÄ‚îÄ üìÑ `App.tsx`
        ‚îú‚îÄ‚îÄ `assets/`
        ‚îÇ   ‚îî‚îÄ‚îÄ üñºÔ∏è `react.svg`
        ‚îú‚îÄ‚îÄ `components/`
        ‚îÇ   ‚îú‚îÄ‚îÄ üìÑ `AssociationFilter.tsx`
        ‚îÇ   ‚îú‚îÄ‚îÄ üìÑ `AuthForm.tsx`
        ‚îÇ   ‚îú‚îÄ‚îÄ üìÑ `AuthStatus.tsx`
        ‚îÇ   ‚îú‚îÄ‚îÄ üìÑ `AvailabilityStrip.tsx`
        ‚îÇ   ‚îú‚îÄ‚îÄ üìÑ `AvailableCheckbox.tsx`
        ‚îÇ   ‚îú‚îÄ‚îÄ üìÑ `BrandFilter.tsx`
        ‚îÇ   ‚îú‚îÄ‚îÄ üìÑ `CancelReservationDialog.tsx`
        ‚îÇ   ‚îú‚îÄ‚îÄ üìÑ `CardShell.tsx`
        ‚îÇ   ‚îú‚îÄ‚îÄ üìÑ `CompactEquipmentCard.tsx`
        ‚îÇ   ‚îú‚îÄ‚îÄ üìÑ `ConfirmItemRemovalDialog.tsx`
        ‚îÇ   ‚îú‚îÄ‚îÄ üìÑ `DateRangeSelector.tsx`
        ‚îÇ   ‚îú‚îÄ‚îÄ üìÑ `DiscountCalculator.tsx`
        ‚îÇ   ‚îú‚îÄ‚îÄ üìÑ `EquipmentGrid.tsx`
        ‚îÇ   ‚îú‚îÄ‚îÄ üìÑ `ErrorBoundary.tsx`
        ‚îÇ   ‚îú‚îÄ‚îÄ üìÑ `ErrorMessage.tsx`
        ‚îÇ   ‚îú‚îÄ‚îÄ üìÑ `FilterPanel.tsx`
        ‚îÇ   ‚îú‚îÄ‚îÄ üìÑ `MyReservationList.tsx`
        ‚îÇ   ‚îú‚îÄ‚îÄ üìÑ `NetworkStatus.tsx`
        ‚îÇ   ‚îú‚îÄ‚îÄ üìÑ `PromoCodeInput.tsx`
        ‚îÇ   ‚îú‚îÄ‚îÄ üìÑ `RequireAuth.tsx`
        ‚îÇ   ‚îú‚îÄ‚îÄ üìÑ `ReservationCard.tsx`
        ‚îÇ   ‚îú‚îÄ‚îÄ üìÑ `ReservationFooter.tsx`
        ‚îÇ   ‚îú‚îÄ‚îÄ üìÑ `ReservationList.tsx`
        ‚îÇ   ‚îú‚îÄ‚îÄ üìÑ `ReserveEquipmentCard.tsx`
        ‚îÇ   ‚îú‚îÄ‚îÄ üìÑ `SearchInput.tsx`
        ‚îÇ   ‚îú‚îÄ‚îÄ üìÑ `StatusBadge.tsx`
        ‚îÇ   ‚îú‚îÄ‚îÄ üìÑ `TypeFilter.tsx`
        ‚îÇ   ‚îú‚îÄ‚îÄ üìÑ `UserInfoBlock.tsx`
        ‚îÇ   ‚îî‚îÄ‚îÄ üìÑ `ViewModeToggle.tsx`
        ‚îÇ   ‚îú‚îÄ‚îÄ `DateRangeSelector/`
        ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ üìÑ `calendar.css`
        ‚îÇ   ‚îú‚îÄ‚îÄ `admin/`
        ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ üìÑ `AccessoryDialogs.tsx`
        ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ üìÑ `AccessoryTable.tsx`
        ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ üìÑ `AdminNavigation.tsx`
        ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ üìÑ `AdminRentalCard.tsx`
        ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ üìÑ `AdminReservationCard.tsx`
        ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ üìÑ `AdminReservationToolbar.tsx`
        ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ üìÑ `AllRentalsList.tsx`
        ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ üìÑ `AllReservationsList.tsx`
        ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ üìÑ `AssociationTable.tsx`
        ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ üìÑ `ConvertReservationDialog.tsx`
        ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ üìÑ `CreateReservationDialog.tsx`
        ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ üìÑ `CreateReservationStep1Details.tsx`
        ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ üìÑ `CreateReservationStep2Accessories.tsx`
        ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ üìÑ `DurationDiscountManager.tsx`
        ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ üìÑ `EditableRentalCard.tsx`
        ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ üìÑ `EquipmentCreateDialog.tsx`
        ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ üìÑ `EquipmentEditDialog.tsx`
        ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ üìÑ `EquipmentStats.tsx`
        ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ üìÑ `EquipmentTable.tsx`
        ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ üìÑ `EquipmentTableRow.tsx`
        ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ üìÑ `EquipmentTableToolbar.tsx`
        ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ üìÑ `HolidayManager.tsx`
        ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ üìÑ `PromoCodeDialog.tsx`
        ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ üìÑ `PromoCodeTable.tsx`
        ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ üìÑ `RentalStatusBadge.tsx`
        ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ üìÑ `ReservationFinancialSummary.tsx`
        ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ üìÑ `ReturnAccessoriesChecklist.tsx`
        ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ üìÑ `ReturnFinancials.tsx`
        ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ üìÑ `ReturnRentalDialog.tsx`
        ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ üìÑ `UserCreateDialog.tsx`
        ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ üìÑ `UserEditDialog.tsx`
        ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ üìÑ `UserPaymentDialog.tsx`
        ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ üìÑ `UserTable.tsx`
        ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ üìÑ `UserTableRow.tsx`
        ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ üìÑ `UserTableToolbar.tsx`
        ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ `dashboard/`
        ‚îÇ   ‚îÇ       ‚îú‚îÄ‚îÄ üìÑ `ActivityFeedWidget.tsx`
        ‚îÇ   ‚îÇ       ‚îú‚îÄ‚îÄ üìÑ `KpiCardsWidget.tsx`
        ‚îÇ   ‚îÇ       ‚îú‚îÄ‚îÄ üìÑ `PopularEquipmentChart.tsx`
        ‚îÇ   ‚îÇ       ‚îî‚îÄ‚îÄ üìÑ `TodayFocusWidget.tsx`
        ‚îÇ   ‚îú‚îÄ‚îÄ `calendar/`
        ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ üìÑ `CalendarDateInputRange.tsx`
        ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ üìÑ `CalendarFiltersBlock.tsx`
        ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ üìÑ `CalendarTable.tsx`
        ‚îÇ   ‚îú‚îÄ‚îÄ `catalog/`
        ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ üìÑ `EquipmentCatalog.tsx`
        ‚îÇ   ‚îú‚îÄ‚îÄ `equipment/`
        ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ üìÑ `EquipmentDetailsDialog.tsx`
        ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ üìÑ `EquipmentDetailsView.tsx`
        ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ üìÑ `EquipmentEditForm.tsx`
        ‚îÇ   ‚îú‚îÄ‚îÄ `equipment-card/`
        ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ üìÑ `AccessoriesSection.tsx`
        ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ üìÑ `CardFooter.tsx`
        ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ üìÑ `CardImage.tsx`
        ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ üìÑ `constants.ts`
        ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ üìÑ `DiscountInfo.tsx`
        ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ üìÑ `EquipmentCard.tsx`
        ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ üìÑ `index.ts`
        ‚îÇ   ‚îú‚îÄ‚îÄ `profile/`
        ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ üìÑ `BalanceHistoryTable.tsx`
        ‚îÇ   ‚îú‚îÄ‚îÄ `rental/`
        ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ üìÑ `MyRentalCard.tsx`
        ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ üìÑ `MyRentalsList.tsx`
        ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ üìÑ `RentalStatusBadge.tsx`
        ‚îÇ   ‚îú‚îÄ‚îÄ `reservation/`
        ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ üìÑ `AvailableAccessoriesDropdown.tsx`
        ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ üìÑ `EditableDateRange.tsx`
        ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ üìÑ `EditableEquipmentItem.tsx`
        ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ üìÑ `EditableReservationCard.tsx`
        ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ üìÑ `EquipmentItemWithConflicts.tsx`
        ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ üìÑ `HolidayConfirmationDialog.tsx`
        ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ üìÑ `ReservationItemsList.tsx`
        ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ üìÑ `ReservationStatusBadge.tsx`
        ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ üìÑ `ViewReservationCard.tsx`
        ‚îÇ   ‚îú‚îÄ‚îÄ `session/`
        ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ üìÑ `UserSession.tsx`
        ‚îÇ   ‚îú‚îÄ‚îÄ `shared/`
        ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ üìÑ `EquipmentWithAccessoriesList.tsx`
        ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ üìÑ `FinancialInfoBlock.tsx`
        ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ üìÑ `FinancialSummaryBlock.tsx`
        ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ üìÑ `OrderToolbar.tsx`
        ‚îÇ   ‚îî‚îÄ‚îÄ `ui/`
        ‚îÇ       ‚îú‚îÄ‚îÄ üìÑ `AdminButton.tsx`
        ‚îÇ       ‚îú‚îÄ‚îÄ üìÑ `alert.tsx`
        ‚îÇ       ‚îú‚îÄ‚îÄ üìÑ `badge.tsx`
        ‚îÇ       ‚îú‚îÄ‚îÄ üìÑ `button.tsx`
        ‚îÇ       ‚îú‚îÄ‚îÄ üìÑ `card.tsx`
        ‚îÇ       ‚îú‚îÄ‚îÄ üìÑ `checkbox.tsx`
        ‚îÇ       ‚îú‚îÄ‚îÄ üìÑ `command.tsx`
        ‚îÇ       ‚îú‚îÄ‚îÄ üìÑ `confirmation-dialog.tsx`
        ‚îÇ       ‚îú‚îÄ‚îÄ üìÑ `CreatableSelect.tsx`
        ‚îÇ       ‚îú‚îÄ‚îÄ üìÑ `dialog.tsx`
        ‚îÇ       ‚îú‚îÄ‚îÄ üìÑ `filter-toggle.tsx`
        ‚îÇ       ‚îú‚îÄ‚îÄ üìÑ `input.tsx`
        ‚îÇ       ‚îú‚îÄ‚îÄ üìÑ `label.tsx`
        ‚îÇ       ‚îú‚îÄ‚îÄ üìÑ `multi-select.tsx`
        ‚îÇ       ‚îú‚îÄ‚îÄ üìÑ `phone-input.md`
        ‚îÇ       ‚îú‚îÄ‚îÄ üìÑ `phone-input.tsx`
        ‚îÇ       ‚îú‚îÄ‚îÄ üìÑ `popover.tsx`
        ‚îÇ       ‚îú‚îÄ‚îÄ üìÑ `scroll-area.tsx`
        ‚îÇ       ‚îú‚îÄ‚îÄ üìÑ `select.tsx`
        ‚îÇ       ‚îú‚îÄ‚îÄ üìÑ `skeleton.tsx`
        ‚îÇ       ‚îú‚îÄ‚îÄ üìÑ `switch.tsx`
        ‚îÇ       ‚îú‚îÄ‚îÄ üìÑ `table.tsx`
        ‚îÇ       ‚îú‚îÄ‚îÄ üìÑ `textarea.tsx`
        ‚îÇ       ‚îú‚îÄ‚îÄ üìÑ `toggle-group.tsx`
        ‚îÇ       ‚îî‚îÄ‚îÄ üìÑ `toggle.tsx`
        ‚îú‚îÄ‚îÄ `constants/`
        ‚îÇ   ‚îú‚îÄ‚îÄ üìÑ `equipmentConstants.ts`
        ‚îÇ   ‚îú‚îÄ‚îÄ üìÑ `paginationConstants.ts`
        ‚îÇ   ‚îú‚îÄ‚îÄ üìÑ `statusStyles.ts`
        ‚îÇ   ‚îî‚îÄ‚îÄ üìÑ `userConstants.ts`
        ‚îú‚îÄ‚îÄ `contexts/`
        ‚îÇ   ‚îî‚îÄ‚îÄ üìÑ `ReservationEditContext.tsx`
        ‚îú‚îÄ‚îÄ `hooks/`
        ‚îÇ   ‚îú‚îÄ‚îÄ üìÑ `useAdminAccessories.ts`
        ‚îÇ   ‚îú‚îÄ‚îÄ üìÑ `useAdminAssociations.ts`
        ‚îÇ   ‚îú‚îÄ‚îÄ üìÑ `useAdminDiscounts.ts`
        ‚îÇ   ‚îú‚îÄ‚îÄ üìÑ `useAdminEquipment.ts`
        ‚îÇ   ‚îú‚îÄ‚îÄ üìÑ `useAdminHolidayRules.ts`
        ‚îÇ   ‚îú‚îÄ‚îÄ üìÑ `useAdminHolidays.ts`
        ‚îÇ   ‚îú‚îÄ‚îÄ üìÑ `useAdminPromoCodes.ts`
        ‚îÇ   ‚îú‚îÄ‚îÄ üìÑ `useAdminRentals.ts`
        ‚îÇ   ‚îú‚îÄ‚îÄ üìÑ `useAdminReservations.ts`
        ‚îÇ   ‚îú‚îÄ‚îÄ üìÑ `useAdminUsers.ts`
        ‚îÇ   ‚îú‚îÄ‚îÄ üìÑ `useAllEquipment.ts`
        ‚îÇ   ‚îú‚îÄ‚îÄ üìÑ `useAssociations.ts`
        ‚îÇ   ‚îú‚îÄ‚îÄ üìÑ `useAvailabilityCheck.ts`
        ‚îÇ   ‚îú‚îÄ‚îÄ üìÑ `useBalanceHistory.ts`
        ‚îÇ   ‚îú‚îÄ‚îÄ üìÑ `useCalendarGrid.ts`
        ‚îÇ   ‚îú‚îÄ‚îÄ üìÑ `useDailyAvailability.ts`
        ‚îÇ   ‚îú‚îÄ‚îÄ üìÑ `useDateRange.ts`
        ‚îÇ   ‚îú‚îÄ‚îÄ üìÑ `useEditReservation.ts`
        ‚îÇ   ‚îú‚îÄ‚îÄ üìÑ `useEquipment.ts`
        ‚îÇ   ‚îú‚îÄ‚îÄ üìÑ `useEquipmentAvailability.ts`
        ‚îÇ   ‚îú‚îÄ‚îÄ üìÑ `useEquipmentMap.ts`
        ‚îÇ   ‚îú‚îÄ‚îÄ üìÑ `useErrorHandler.ts`
        ‚îÇ   ‚îú‚îÄ‚îÄ üìÑ `useInlineReservationEdit.tsx`
        ‚îÇ   ‚îú‚îÄ‚îÄ üìÑ `useMyRentals.ts`
        ‚îÇ   ‚îú‚îÄ‚îÄ üìÑ `useNetworkStatus.ts`
        ‚îÇ   ‚îú‚îÄ‚îÄ üìÑ `usePhoneValidation.ts`
        ‚îÇ   ‚îú‚îÄ‚îÄ üìÑ `useProfile.ts`
        ‚îÇ   ‚îú‚îÄ‚îÄ üìÑ `useReservationManagement.ts`
        ‚îÇ   ‚îú‚îÄ‚îÄ üìÑ `useReservations.ts`
        ‚îÇ   ‚îú‚îÄ‚îÄ üìÑ `useUpdateEquipmentDetails.ts`
        ‚îÇ   ‚îî‚îÄ‚îÄ üìÑ `useVisibleItems.ts`
        ‚îÇ   ‚îú‚îÄ‚îÄ `admin/`
        ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ üìÑ `useAdminRentalEdit.ts`
        ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ üìÑ `useAdminReservationCalculator.ts`
        ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ üìÑ `useDashboardData.ts`
        ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ üìÑ `useEquipmentTableLogic.ts`
        ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ üìÑ `useRentalReturnForm.ts`
        ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ üìÑ `useUserTableLogic.ts`
        ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ `create-reservation/`
        ‚îÇ   ‚îÇ       ‚îú‚îÄ‚îÄ üìÑ `useCreateReservationData.ts`
        ‚îÇ   ‚îÇ       ‚îú‚îÄ‚îÄ üìÑ `useCreateReservationDialog.ts`
        ‚îÇ   ‚îÇ       ‚îî‚îÄ‚îÄ üìÑ `useCreateReservationForm.ts`
        ‚îÇ   ‚îú‚îÄ‚îÄ `data/`
        ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ üìÑ `useEquipmentData.ts`
        ‚îÇ   ‚îú‚îÄ‚îÄ `features/`
        ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ üìÑ `useAppFilters.ts`
        ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ üìÑ `useEquipmentCardViewModel.ts`
        ‚îÇ   ‚îî‚îÄ‚îÄ `reservation/`
        ‚îÇ       ‚îú‚îÄ‚îÄ üìÑ `usePriceCalculator.ts`
        ‚îÇ       ‚îú‚îÄ‚îÄ üìÑ `useReservationActions.ts`
        ‚îÇ       ‚îú‚îÄ‚îÄ üìÑ `useReservationData.ts`
        ‚îÇ       ‚îú‚îÄ‚îÄ üìÑ `useReservationEditState.ts`
        ‚îÇ       ‚îî‚îÄ‚îÄ üìÑ `useReservationState.ts`
        ‚îÇ       ‚îî‚îÄ‚îÄ `submission/`
        ‚îÇ           ‚îú‚îÄ‚îÄ üìÑ `useReservationFormData.ts`
        ‚îÇ           ‚îî‚îÄ‚îÄ üìÑ `useReserveSubmission.ts`
        ‚îú‚îÄ‚îÄ `lib/`
        ‚îÇ   ‚îú‚îÄ‚îÄ üìÑ `api.ts`
        ‚îÇ   ‚îú‚îÄ‚îÄ üìÑ `queryClient.ts`
        ‚îÇ   ‚îú‚îÄ‚îÄ üìÑ `queryHelpers.ts`
        ‚îÇ   ‚îú‚îÄ‚îÄ üìÑ `sortingUtils.ts`
        ‚îÇ   ‚îú‚îÄ‚îÄ üìÑ `utils.ts`
        ‚îÇ   ‚îî‚îÄ‚îÄ üìÑ `validationSchemas.ts`
        ‚îú‚îÄ‚îÄ `pages/`
        ‚îÇ   ‚îú‚îÄ‚îÄ üìÑ `AccessoryManagementPage.tsx`
        ‚îÇ   ‚îú‚îÄ‚îÄ üìÑ `CalendarPage.tsx`
        ‚îÇ   ‚îú‚îÄ‚îÄ üìÑ `CalendarTestPage.tsx`
        ‚îÇ   ‚îú‚îÄ‚îÄ üìÑ `ContactPage.tsx`
        ‚îÇ   ‚îú‚îÄ‚îÄ üìÑ `EquipmentManagementPage.tsx`
        ‚îÇ   ‚îú‚îÄ‚îÄ üìÑ `HomePage.tsx`
        ‚îÇ   ‚îú‚îÄ‚îÄ üìÑ `MyReservationsPage.tsx`
        ‚îÇ   ‚îú‚îÄ‚îÄ üìÑ `ProfilePage.tsx`
        ‚îÇ   ‚îú‚îÄ‚îÄ üìÑ `ReservePage.tsx`
        ‚îÇ   ‚îî‚îÄ‚îÄ üìÑ `UserManagementPage.tsx`
        ‚îÇ   ‚îî‚îÄ‚îÄ `admin/`
        ‚îÇ       ‚îú‚îÄ‚îÄ üìÑ `AllReservationsManagementPage.tsx`
        ‚îÇ       ‚îú‚îÄ‚îÄ üìÑ `AssociationManagementPage.tsx`
        ‚îÇ       ‚îú‚îÄ‚îÄ üìÑ `DashboardPage.tsx`
        ‚îÇ       ‚îú‚îÄ‚îÄ üìÑ `HolidayManagementPage.tsx`
        ‚îÇ       ‚îú‚îÄ‚îÄ üìÑ `PromoCodeManagementPage.tsx`
        ‚îÇ       ‚îî‚îÄ‚îÄ üìÑ `RentalManagementPage.tsx`
        ‚îú‚îÄ‚îÄ `store/`
        ‚îÇ   ‚îú‚îÄ‚îÄ üìÑ `adminReservationSelectionStore.ts`
        ‚îÇ   ‚îú‚îÄ‚îÄ üìÑ `authStore.ts`
        ‚îÇ   ‚îú‚îÄ‚îÄ üìÑ `calendarSelectionStore.ts`
        ‚îÇ   ‚îú‚îÄ‚îÄ üìÑ `dateStore.ts`
        ‚îÇ   ‚îú‚îÄ‚îÄ üìÑ `filterStore.ts`
        ‚îÇ   ‚îú‚îÄ‚îÄ üìÑ `holidayStore.ts`
        ‚îÇ   ‚îú‚îÄ‚îÄ üìÑ `orderFilterStore.ts`
        ‚îÇ   ‚îú‚îÄ‚îÄ üìÑ `promoCodeStore.ts`
        ‚îÇ   ‚îú‚îÄ‚îÄ üìÑ `reserveStore.ts`
        ‚îÇ   ‚îú‚îÄ‚îÄ üìÑ `sandboxCalculatorStore.ts`
        ‚îÇ   ‚îú‚îÄ‚îÄ üìÑ `searchStore.ts`
        ‚îÇ   ‚îî‚îÄ‚îÄ üìÑ `viewModeStore.ts`
        ‚îú‚îÄ‚îÄ `types/`
        ‚îÇ   ‚îú‚îÄ‚îÄ üìÑ `accessory.ts`
        ‚îÇ   ‚îú‚îÄ‚îÄ üìÑ `association.ts`
        ‚îÇ   ‚îú‚îÄ‚îÄ üìÑ `availability.ts`
        ‚îÇ   ‚îú‚îÄ‚îÄ üìÑ `balanceHistory.ts`
        ‚îÇ   ‚îú‚îÄ‚îÄ üìÑ `discount.ts`
        ‚îÇ   ‚îú‚îÄ‚îÄ üìÑ `equipment.ts`
        ‚îÇ   ‚îú‚îÄ‚îÄ üìÑ `holiday.ts`
        ‚îÇ   ‚îú‚îÄ‚îÄ üìÑ `promo_code.ts`
        ‚îÇ   ‚îú‚îÄ‚îÄ üìÑ `rental.ts`
        ‚îÇ   ‚îú‚îÄ‚îÄ üìÑ `reservation.ts`
        ‚îÇ   ‚îî‚îÄ‚îÄ üìÑ `user.ts`
        ‚îî‚îÄ‚îÄ `utils/`
            ‚îî‚îÄ‚îÄ üìÑ `phoneUtils.ts`

---


## <a name="RentalAppFASTAPIDockerfilebackend"></a>`RentalApp_FASTAPI/Dockerfile.backend`

```dockerfile
// path: RentalApp_FASTAPI/Dockerfile.backend

# RentalApp_FASTAPI/Dockerfile.backend

FROM python:3.11-slim-buster
WORKDIR /app

# –ü—É—Ç–∏ —Ç–µ–ø–µ—Ä—å –æ—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω—ã –ø–∞–ø–∫–∏ RentalApp_FASTAPI
COPY requirements.txt requirements.txt
RUN pip install --no-cache-dir --upgrade pip -r requirements.txt

COPY ./api ./api
COPY ./shared ./shared
COPY ./config ./config
COPY ./migrations ./migrations
COPY alembic.ini alembic.ini
COPY create_admin.py create_admin.py

CMD ["uvicorn", "api.main_api:app", "--host", "0.0.0.0", "--port", "8000"]

```


## <a name="RentalAppFASTAPIapiinitpy"></a>`RentalApp_FASTAPI/api/__init__.py`

```python
// path: RentalApp_FASTAPI/api/__init__.py



```


## <a name="RentalAppFASTAPIapiaccessoryapipy"></a>`RentalApp_FASTAPI/api/accessory_api.py`

```python
// path: RentalApp_FASTAPI/api/accessory_api.py

# api/accessory_api.py

from fastapi import APIRouter, Depends, HTTPException, Query
from sqlalchemy.ext.asyncio import AsyncSession
from sqlalchemy import select, func, or_
from typing import List

from api.deps import get_db
from api.models.user import User
from api.models.accessory import Accessory
from api.models.reservation import ReservationAccessory, Reservation
from api.models.rental import RentalAccessory, Rental
from api.permissions import require_manager
from shared.schemas.accessory_schema import AccessoryCreate, AccessoryUpdate, AccessoryOut, AccessoryListResponse
from fastapi_csrf_protect import CsrfProtect

router = APIRouter(prefix="/accessories", tags=["–ê–∫—Å–µ—Å—Å—É–∞—Ä—ã"])

@router.post("/", response_model=AccessoryOut, status_code=201)
async def create_accessory(
        accessory_in: AccessoryCreate,
        db: AsyncSession = Depends(get_db),
        current_user: User = Depends(require_manager),
        csrf_protect: CsrfProtect = Depends()
):
    """–°–æ–∑–¥–∞—Ç—å –Ω–æ–≤—ã–π –∞–∫—Å–µ—Å—Å—É–∞—Ä (—Ç–æ–ª—å–∫–æ –¥–ª—è –º–µ–Ω–µ–¥–∂–µ—Ä–æ–≤/–∞–¥–º–∏–Ω–æ–≤)"""
    new_accessory = Accessory(**accessory_in.model_dump())
    db.add(new_accessory)
    await db.commit()
    await db.refresh(new_accessory)
    
    # –í–æ–∑–≤—Ä–∞—â–∞–µ–º —Å–æ–∑–¥–∞–Ω–Ω—ã–π –æ–±—ä–µ–∫—Ç —Å –∑–∞–≥—Ä—É–∂–µ–Ω–Ω—ã–º–∏ –¥–∞–Ω–Ω—ã–º–∏ –∏–∑ –ë–î
    return new_accessory

@router.get("/", response_model=AccessoryListResponse)
async def get_all_accessories(
        db: AsyncSession = Depends(get_db),
        skip: int = Query(0, ge=0, description="–°–∫–æ–ª—å–∫–æ –∑–∞–ø–∏—Å–µ–π –ø—Ä–æ–ø—É—Å—Ç–∏—Ç—å"),
        limit: int = Query(10, ge=1, le=500, description="–ú–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∑–∞–ø–∏—Å–µ–π –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–µ")
):
    """–ü–æ–ª—É—á–∏—Ç—å —Å–ø–∏—Å–æ–∫ –≤—Å–µ—Ö –∞–∫—Å–µ—Å—Å—É–∞—Ä–æ–≤ —Å –ø–∞–≥–∏–Ω–∞—Ü–∏–µ–π"""
    # 1. –ó–∞–ø—Ä–æ—Å –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –æ–±—â–µ–≥–æ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ –∞–∫—Å–µ—Å—Å—É–∞—Ä–æ–≤
    total_result = await db.execute(select(func.count(Accessory.id)))
    total_accessories = total_result.scalar_one()

    # 2. –ó–∞–ø—Ä–æ—Å –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è "—Å—Ç—Ä–∞–Ω–∏—Ü—ã" –∞–∫—Å–µ—Å—Å—É–∞—Ä–æ–≤
    accessories_result = await db.execute(
        select(Accessory).order_by(Accessory.name).offset(skip).limit(limit)
    )
    accessories_orm = accessories_result.scalars().all()

    # 3. –§–æ—Ä–º–∏—Ä—É–µ–º –∏ –≤–æ–∑–≤—Ä–∞—â–∞–µ–º –Ω–æ–≤—ã–π –æ–±—ä–µ–∫—Ç –æ—Ç–≤–µ—Ç–∞
    return AccessoryListResponse(
        items=accessories_orm,
        total=total_accessories
    )

@router.get("/{accessory_id}", response_model=AccessoryOut)
async def get_accessory_by_id(accessory_id: int, db: AsyncSession = Depends(get_db)):
    """–ü–æ–ª—É—á–∏—Ç—å –∞–∫—Å–µ—Å—Å—É–∞—Ä –ø–æ ID"""
    result = await db.execute(select(Accessory).filter(Accessory.id == accessory_id))
    accessory = result.scalars().first()
    if not accessory:
        raise HTTPException(status_code=404, detail="–ê–∫—Å–µ—Å—Å—É–∞—Ä –Ω–µ –Ω–∞–π–¥–µ–Ω")
    return accessory

@router.put("/{accessory_id}", response_model=AccessoryOut)
async def update_accessory(
        accessory_id: int,
        accessory_in: AccessoryUpdate,
        db: AsyncSession = Depends(get_db),
        current_user: User = Depends(require_manager),
        csrf_protect: CsrfProtect = Depends()
):
    """–û–±–Ω–æ–≤–∏—Ç—å –∞–∫—Å–µ—Å—Å—É–∞—Ä (—Ç–æ–ª—å–∫–æ –¥–ª—è –º–µ–Ω–µ–¥–∂–µ—Ä–æ–≤/–∞–¥–º–∏–Ω–æ–≤)"""
    result = await db.execute(select(Accessory).filter(Accessory.id == accessory_id))
    accessory = result.scalars().first()
    if not accessory:
        raise HTTPException(status_code=404, detail="–ê–∫—Å–µ—Å—Å—É–∞—Ä –Ω–µ –Ω–∞–π–¥–µ–Ω")

    update_data = accessory_in.model_dump(exclude_unset=True)
    for key, value in update_data.items():
        setattr(accessory, key, value)

    await db.commit()
    
    # –í–æ–∑–≤—Ä–∞—â–∞–µ–º –æ–±–Ω–æ–≤–ª–µ–Ω–Ω—ã–π –æ–±—ä–µ–∫—Ç –±–µ–∑ –ø–æ–≤—Ç–æ—Ä–Ω–æ–≥–æ –∑–∞–ø—Ä–æ—Å–∞ –∫ –ë–î
    return accessory

@router.delete("/{accessory_id}", status_code=204)
async def delete_accessory(
        accessory_id: int,
        db: AsyncSession = Depends(get_db),
        current_user: User = Depends(require_manager),
        csrf_protect: CsrfProtect = Depends()
):
    """–£–¥–∞–ª–∏—Ç—å –∞–∫—Å–µ—Å—Å—É–∞—Ä (—Ç–æ–ª—å–∫–æ –¥–ª—è –º–µ–Ω–µ–¥–∂–µ—Ä–æ–≤/–∞–¥–º–∏–Ω–æ–≤)"""
    result = await db.execute(select(Accessory).filter(Accessory.id == accessory_id))
    accessory = result.scalars().first()
    if not accessory:
        raise HTTPException(status_code=404, detail="–ê–∫—Å–µ—Å—Å—É–∞—Ä –Ω–µ –Ω–∞–π–¥–µ–Ω")

    # –ü—Ä–æ–≤–µ—Ä—è–µ–º –∞–∫—Ç–∏–≤–Ω—ã–µ —Ä–µ–∑–µ—Ä–≤—ã
    active_reservations_query = (
        select(func.count(Reservation.id))
        .join(ReservationAccessory, Reservation.id == ReservationAccessory.reservation_id)
        .where(ReservationAccessory.accessory_id == accessory_id)
        .where(Reservation.status == 'active')
    )
    active_reservations_count = (await db.execute(active_reservations_query)).scalar_one()

    # –ü—Ä–æ–≤–µ—Ä—è–µ–º –∞–∫—Ç–∏–≤–Ω—ã–µ –∞—Ä–µ–Ω–¥—ã
    active_rentals_query = (
        select(func.count(Rental.id))
        .join(RentalAccessory, Rental.id == RentalAccessory.rental_id)
        .where(RentalAccessory.accessory_id == accessory_id)
        .where(or_(Rental.status == 'active', Rental.status == 'overdue'))
    )
    active_rentals_count = (await db.execute(active_rentals_query)).scalar_one()

    if active_reservations_count > 0 or active_rentals_count > 0:
        error_detail = (
            f"–ù–µ–≤–æ–∑–º–æ–∂–Ω–æ —É–¥–∞–ª–∏—Ç—å –∞–∫—Å–µ—Å—Å—É–∞—Ä. –û–Ω –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –≤ "
            f"{active_reservations_count} –∞–∫—Ç–∏–≤–Ω—ã—Ö —Ä–µ–∑–µ—Ä–≤–∞—Ö –∏ "
            f"{active_rentals_count} –∞–∫—Ç–∏–≤–Ω—ã—Ö –∞—Ä–µ–Ω–¥–∞—Ö."
        )
        raise HTTPException(status_code=409, detail=error_detail)

    await db.delete(accessory)
    await db.commit()
    return None

```


## <a name="RentalAppFASTAPIapiadmindashboardapipy"></a>`RentalApp_FASTAPI/api/admin_dashboard_api.py`

```python
// path: RentalApp_FASTAPI/api/admin_dashboard_api.py

# api/admin_dashboard_api.py

from fastapi import APIRouter, Depends
from sqlalchemy.ext.asyncio import AsyncSession

from api.deps import get_dashboard_service
from api.permissions import require_manager
from api.models.user import User
from api.services.dashboard_service import DashboardService
from shared.schemas.dashboard_schema import DashboardSummaryResponse

router = APIRouter(prefix="/admin", tags=["admin-dashboard"])

@router.get("/dashboard-summary", response_model=DashboardSummaryResponse)
async def get_dashboard_summary(
    current_user: User = Depends(require_manager),
    dashboard_service: DashboardService = Depends(get_dashboard_service)
) -> DashboardSummaryResponse:
    """
    –ü–æ–ª—É—á–∞–µ—Ç —Å–≤–æ–¥–Ω—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –¥–ª—è –ø–∞–Ω–µ–ª–∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –∞–¥–º–∏–Ω–∫–∏.
    
    –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç –∞–≥—Ä–µ–≥–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –≤–∫–ª—é—á–∞—è:
    - –ó–∞–¥–∞—á–∏ –Ω–∞ —Å–µ–≥–æ–¥–Ω—è (–≤—ã–¥–∞—á–∏, –≤–æ–∑–≤—Ä–∞—Ç—ã, –ø—Ä–æ—Å—Ä–æ—á–∫–∏)
    - –ö–ª—é—á–µ–≤—ã–µ –ø–æ–∫–∞–∑–∞—Ç–µ–ª–∏ (–¥–æ—Ö–æ–¥, –Ω–æ–≤—ã–µ –∞—Ä–µ–Ω–¥—ã, –∫–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è, –Ω–æ–≤—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏)
    - –ü–æ—Å–ª–µ–¥–Ω–∏–µ —Å–æ–±—ã—Ç–∏—è –≤ —Å–∏—Å—Ç–µ–º–µ
    - –ü–æ–ø—É–ª—è—Ä–Ω–æ–µ –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏–µ
    """
    return await dashboard_service.get_summary()


```


## <a name="RentalAppFASTAPIapiadminrentalapipy"></a>`RentalApp_FASTAPI/api/admin_rental_api.py`

```python
// path: RentalApp_FASTAPI/api/admin_rental_api.py

# api/admin_rental_api.py

from fastapi import APIRouter, Depends, Query, Response, status

from api.deps import get_order_lifecycle_service, get_rental_query_service
from api.permissions import require_manager, require_admin
from api.models.user import User
from api.services.rental.rental_query_service import RentalQueryService
from api.services.order.order_lifecycle_service import OrderLifecycleService
from shared.schemas.rental_schema import (
    RentalOut, RentalListResponse, RentalCreateFromReservationRequest,
    RentalReturnRequest, RentalCreateFromScratchRequest,
    AdminRentalUpdate
)

router = APIRouter(prefix="/admin/rentals", tags=["–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω–∏–µ –ê—Ä–µ–Ω–¥"])


@router.get("/", response_model=RentalListResponse)
async def get_all_rentals(
        current_user: User = Depends(require_manager),
        query_service: RentalQueryService = Depends(get_rental_query_service),
        status: str = Query(None, description="–§–∏–ª—å—Ç—Ä –ø–æ —Å—Ç–∞—Ç—É—Å—É: active, overdue, completed"),
        search: str = Query(None, description="–ü–æ–∏—Å–∫ –ø–æ –∏–º–µ–Ω–∏ –∏–ª–∏ email –∫–ª–∏–µ–Ω—Ç–∞"),
        skip: int = Query(0, ge=0),
        limit: int = Query(10, ge=1, le=100)
):
    """–ü–æ–ª—É—á–∏—Ç—å —Å–ø–∏—Å–æ–∫ –≤—Å–µ—Ö –∞—Ä–µ–Ω–¥ —Å —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–µ–π –∏ –ø–∞–≥–∏–Ω–∞—Ü–∏–µ–π."""
    rentals_out, total = await query_service.get_paginated_rentals(skip, limit, status, search)
    return RentalListResponse(
        items=rentals_out,
        total=total
    )


@router.post("/", response_model=RentalOut)
async def create_rental_from_scratch(
        request: RentalCreateFromScratchRequest,
        current_user: User = Depends(require_manager),
        service: OrderLifecycleService = Depends(get_order_lifecycle_service)
):
    """–°–æ–∑–¥–∞—Ç—å –Ω–æ–≤—É—é –∞—Ä–µ–Ω–¥—É –±–µ–∑ –ø—Ä–µ–¥–≤–∞—Ä–∏—Ç–µ–ª—å–Ω–æ–≥–æ —Ä–µ–∑–µ—Ä–≤–∞."""
    new_rental_orm = await service.create_rental_from_scratch(request, current_user)
    return RentalOut.model_validate(new_rental_orm)


@router.put("/{rental_id}", response_model=RentalOut)
async def update_rental_details(
        rental_id: int,
        request: AdminRentalUpdate,
        current_user: User = Depends(require_manager),
        service: OrderLifecycleService = Depends(get_order_lifecycle_service)
):
    """–û–±–Ω–æ–≤–∏—Ç—å –¥–µ—Ç–∞–ª–∏ —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–π –∞—Ä–µ–Ω–¥—ã."""
    updated_rental_orm = await service.update_rental_details_by_admin(rental_id, request, current_user)
    return RentalOut.model_validate(updated_rental_orm)


@router.post("/from-reservation/{reservation_id}", response_model=RentalOut)
async def convert_reservation_to_rental(
        reservation_id: int,
        request: RentalCreateFromReservationRequest,
        current_user: User = Depends(require_manager),
        service: OrderLifecycleService = Depends(get_order_lifecycle_service)
):
    """–ö–æ–Ω–≤–µ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å —Ä–µ–∑–µ—Ä–≤ –≤ –∞—Ä–µ–Ω–¥—É."""
    new_rental_orm = await service.convert_reservation_to_rental(reservation_id, request, current_user)
    return RentalOut.model_validate(new_rental_orm)


@router.post("/{rental_id}/return", response_model=RentalOut)
async def return_rental(
        rental_id: int,
        request: RentalReturnRequest,
        current_user: User = Depends(require_manager),
        service: OrderLifecycleService = Depends(get_order_lifecycle_service)
):
    """–û—Ñ–æ—Ä–º–∏—Ç—å –≤–æ–∑–≤—Ä–∞—Ç –∞—Ä–µ–Ω–¥—ã."""
    returned_rental_orm = await service.return_rental(rental_id, request, current_user)
    return RentalOut.model_validate(returned_rental_orm)


@router.post("/{rental_id}/revert-to-reservation", status_code=status.HTTP_204_NO_CONTENT)
async def revert_rental_to_reservation(
        rental_id: int,
        current_user: User = Depends(require_manager),
        service: OrderLifecycleService = Depends(get_order_lifecycle_service)
):
    """
    –û—Ç–º–µ–Ω–∏—Ç—å –≤—ã–¥–∞—á—É –∞—Ä–µ–Ω–¥—ã –∏ –≤–µ—Ä–Ω—É—Ç—å –µ–µ –≤ —Å—Ç–∞—Ç—É—Å —Ä–µ–∑–µ—Ä–≤–∞.
    –î–æ—Å—Ç—É–ø–Ω–æ —Ç–æ–ª—å–∫–æ –≤ –¥–µ–Ω—å —Å–æ–∑–¥–∞–Ω–∏—è –∞—Ä–µ–Ω–¥—ã.
    """
    await service.revert_rental_to_reservation(rental_id, current_user)
    return Response(status_code=status.HTTP_204_NO_CONTENT)


@router.delete("/{rental_id}", status_code=204)
async def delete_rental_by_admin(
        rental_id: int,
        current_user: User = Depends(require_admin),
        service: OrderLifecycleService = Depends(get_order_lifecycle_service)
):
    """–£–¥–∞–ª–∏—Ç—å –∞—Ä–µ–Ω–¥—É (—Ç–æ–ª—å–∫–æ –¥–ª—è –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–≤)."""
    await service.delete_rental_by_admin(rental_id)
    return None

```


## <a name="RentalAppFASTAPIapiadminreservationapipy"></a>`RentalApp_FASTAPI/api/admin_reservation_api.py`

```python
// path: RentalApp_FASTAPI/api/admin_reservation_api.py

# api/admin_reservation_api.py

from fastapi import APIRouter, Depends, Query, HTTPException, Response, status, Body
import logging

from api.deps import get_order_lifecycle_service, get_reservation_query_service
from api.permissions import require_manager
from api.models.user import User
from api.services.order.order_lifecycle_service import OrderLifecycleService
# <-- –ò–ó–ú–ï–ù–ï–ù–ò–ï –ó–î–ï–°–¨: –ò–º–ø–æ—Ä—Ç–∏—Ä—É–µ–º –Ω–æ–≤—ã–π –µ–¥–∏–Ω—ã–π —Å–µ—Ä–≤–∏—Å –¥–ª—è —á—Ç–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö
from api.services.reservation_query_service import ReservationQueryService
# ----------------------------------------------------------------------
from shared.schemas.reservation_schema import (
    AdminReservationCreateRequest,
    ReservationResponse,
    ReservationUpdateRequest,
    AdminReservationListResponse,
    ReservationBulkDeleteRequest
)
from fastapi_csrf_protect import CsrfProtect

router = APIRouter(prefix="/admin/reservations", tags=["–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω–∏–µ –†–µ–∑–µ—Ä–≤–æ–≤"])
logger = logging.getLogger(__name__)


@router.post("/delete-many", status_code=status.HTTP_204_NO_CONTENT)
async def delete_multiple_reservations(
        request: ReservationBulkDeleteRequest = Body(...),
        _current_user: User = Depends(require_manager),
        _csrf_protect: CsrfProtect = Depends(),
        service: OrderLifecycleService = Depends(get_order_lifecycle_service)
):
    """–ú–∞—Å—Å–æ–≤–æ —É–¥–∞–ª–∏—Ç—å —Ä–µ–∑–µ—Ä–≤—ã –ø–æ –∏—Ö ID."""
    try:
        await service.bulk_cancel_admin_reservations(request.reservation_ids)
        return Response(status_code=status.HTTP_204_NO_CONTENT)
    except Exception as e:
        logger.error(f"Error during bulk deletion service call: {e}", exc_info=True)
        raise HTTPException(
            status_code=status.HTTP_500_INTERNAL_SERVER_ERROR,
            detail="–í–Ω—É—Ç—Ä–µ–Ω–Ω—è—è –æ—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ —Ä–µ–∑–µ—Ä–≤–æ–≤."
        )

@router.get("/", response_model=AdminReservationListResponse)
async def get_all_reservations(
        _current_user: User = Depends(require_manager),
        query_service: ReservationQueryService = Depends(get_reservation_query_service),
        status: str = Query(None, description="–§–∏–ª—å—Ç—Ä –ø–æ —Å—Ç–∞—Ç—É—Å—É —Ä–µ–∑–µ—Ä–≤–∞ ('active' –∏–ª–∏ 'completed')"),
        search: str = Query(None, description="–ü–æ–∏—Å–∫ –ø–æ –∏–º–µ–Ω–∏ –∏–ª–∏ email –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è"),
        skip: int = Query(0, ge=0, description="–°–∫–æ–ª—å–∫–æ –∑–∞–ø–∏—Å–µ–π –ø—Ä–æ–ø—É—Å—Ç–∏—Ç—å"),
        limit: int = Query(10, ge=1, le=100, description="–ú–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∑–∞–ø–∏—Å–µ–π –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–µ")
):
    """–ü–æ–ª—É—á–∏—Ç—å –≤—Å–µ —Ä–µ–∑–µ—Ä–≤—ã —Å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–µ–π –æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è—Ö —Å –ø–∞–≥–∏–Ω–∞—Ü–∏–µ–π."""
    total_reservations = await query_service.get_admin_reservations_count(status=status, search_query=search)
    paginated_reservations = await query_service.get_paginated_admin_reservations(
        skip=skip,
        limit=limit,
        status=status,
        search_query=search
    )
    return AdminReservationListResponse(
        items=paginated_reservations,
        total=total_reservations
    )

@router.post("/", response_model=ReservationResponse)
async def create_reservation_for_user(
        request: AdminReservationCreateRequest,
        _current_user: User = Depends(require_manager),
        _csrf_protect: CsrfProtect = Depends(),
        service: OrderLifecycleService = Depends(get_order_lifecycle_service)
):
    """–°–æ–∑–¥–∞—Ç—å —Ä–µ–∑–µ—Ä–≤ –¥–ª—è –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è."""
    new_reservation = await service.create_admin_reservation(request)
    return ReservationResponse(reservation_id=new_reservation.id, message="–†–µ–∑–µ—Ä–≤ —É—Å–ø–µ—à–Ω–æ —Å–æ–∑–¥–∞–Ω")

@router.put("/{reservation_id}", response_model=ReservationResponse)
async def update_any_reservation(
        reservation_id: int,
        data: ReservationUpdateRequest,
        _current_user: User = Depends(require_manager),
        _csrf_protect: CsrfProtect = Depends(),
        service: OrderLifecycleService = Depends(get_order_lifecycle_service)
):
    """–û–±–Ω–æ–≤–∏—Ç—å –ª—é–±–æ–π —Ä–µ–∑–µ—Ä–≤ –ø–æ –µ–≥–æ ID."""
    updated_reservation = await service.update_admin_reservation(reservation_id, data)
    return ReservationResponse(reservation_id=updated_reservation.id, message="–†–µ–∑–µ—Ä–≤ —É—Å–ø–µ—à–Ω–æ –æ–±–Ω–æ–≤–ª–µ–Ω")

@router.delete("/{reservation_id}", status_code=204)
async def delete_any_reservation(
        reservation_id: int,
        _current_user: User = Depends(require_manager),
        _csrf_protect: CsrfProtect = Depends(),
        service: OrderLifecycleService = Depends(get_order_lifecycle_service)
):
    """–£–¥–∞–ª–∏—Ç—å –ª—é–±–æ–π —Ä–µ–∑–µ—Ä–≤ –ø–æ –µ–≥–æ ID."""
    await service.cancel_admin_reservation(reservation_id)
    return None

```


## <a name="RentalAppFASTAPIapiassociationapipy"></a>`RentalApp_FASTAPI/api/association_api.py`

```python
// path: RentalApp_FASTAPI/api/association_api.py

# api/association_api.py

from fastapi import APIRouter, Depends, HTTPException, Query
from sqlalchemy.ext.asyncio import AsyncSession
from sqlalchemy import select, func
from sqlalchemy.orm import selectinload
from typing import List

from api.deps import get_db
from api.models.user import User
from api.models.association import Association
from api.models.equipment import Equipment
from api.permissions import require_manager
from shared.schemas.association_schema import AssociationCreate, AssociationUpdate, AssociationOut, AssociationListResponse
from fastapi_csrf_protect import CsrfProtect

router = APIRouter(prefix="/associations", tags=["–ê—Å—Å–æ—Ü–∏–∞—Ü–∏–∏"])

@router.get("/", response_model=AssociationListResponse)
async def get_all_associations(
        db: AsyncSession = Depends(get_db),
        skip: int = Query(0, ge=0, description="–°–∫–æ–ª—å–∫–æ –∑–∞–ø–∏—Å–µ–π –ø—Ä–æ–ø—É—Å—Ç–∏—Ç—å"),
        limit: int = Query(10, ge=1, le=100, description="–ú–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∑–∞–ø–∏—Å–µ–π –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–µ")
):
    """
    –ü–æ–ª—É—á–∏—Ç—å —Å–ø–∏—Å–æ–∫ –≤—Å–µ—Ö –∞—Å—Å–æ—Ü–∏–∞—Ü–∏–π, –æ—Ç—Å–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö –ø–æ –ø–æ—Ä—è–¥–∫—É —Å –ø–∞–≥–∏–Ω–∞—Ü–∏–µ–π.
    –≠—Ç–æ—Ç —ç–Ω–¥–ø–æ–∏–Ω—Ç –ø—É–±–ª–∏—á–Ω—ã–π –∏ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–ª—è —Ñ–∏–ª—å—Ç—Ä–æ–≤ –Ω–∞ –≥–ª–∞–≤–Ω–æ–π —Å—Ç—Ä–∞–Ω–∏—Ü–µ.
    """
    # 1. –ó–∞–ø—Ä–æ—Å –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –æ–±—â–µ–≥–æ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ –∞—Å—Å–æ—Ü–∏–∞—Ü–∏–π
    total_result = await db.execute(select(func.count(Association.id)))
    total_associations = total_result.scalar_one()

    # 2. –ó–∞–ø—Ä–æ—Å –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è "—Å—Ç—Ä–∞–Ω–∏—Ü—ã" –∞—Å—Å–æ—Ü–∏–∞—Ü–∏–π
    associations_result = await db.execute(
        select(Association)
        .options(selectinload(Association.equipment))
        .order_by(Association.sort_order, Association.name)
        .offset(skip)
        .limit(limit)
    )
    associations_orm = associations_result.unique().scalars().all()

    # 3. –§–æ—Ä–º–∏—Ä—É–µ–º –∏ –≤–æ–∑–≤—Ä–∞—â–∞–µ–º –Ω–æ–≤—ã–π –æ–±—ä–µ–∫—Ç –æ—Ç–≤–µ—Ç–∞
    return AssociationListResponse(
        items=[AssociationOut.from_orm(assoc) for assoc in associations_orm],
        total=total_associations
    )

@router.post("/", response_model=AssociationOut, status_code=201)
async def create_association(
        assoc_in: AssociationCreate,
        db: AsyncSession = Depends(get_db),
        _current_user: User = Depends(require_manager),
        _csrf_protect: CsrfProtect = Depends()
):
    """–°–æ–∑–¥–∞—Ç—å –Ω–æ–≤—É—é –∞—Å—Å–æ—Ü–∏–∞—Ü–∏—é (–ú–µ–Ω–µ–¥–∂–µ—Ä/–ê–¥–º–∏–Ω)."""
    result = await db.execute(select(Association).filter(Association.name == assoc_in.name))
    if result.scalars().first():
        raise HTTPException(status_code=409, detail="–ê—Å—Å–æ—Ü–∏–∞—Ü–∏—è —Å —Ç–∞–∫–∏–º –Ω–∞–∑–≤–∞–Ω–∏–µ–º —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç.")

    new_assoc = Association(
        name=assoc_in.name,
        description=assoc_in.description,
        sort_order=assoc_in.sort_order
    )

    if assoc_in.equipment_ids:
        equipment_result = await db.execute(
            select(Equipment)
            .filter(Equipment.id.in_(assoc_in.equipment_ids))
            .options(
                selectinload(Equipment.accessories),
                selectinload(Equipment.associations)
            )
        )
        equipment = equipment_result.unique().scalars().all()
        if len(equipment) != len(set(assoc_in.equipment_ids)):
            raise HTTPException(status_code=404, detail="–û–¥–Ω–æ –∏–ª–∏ –Ω–µ—Å–∫–æ–ª—å–∫–æ –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏–π –Ω–µ –Ω–∞–π–¥–µ–Ω–æ.")
        new_assoc.equipment = equipment

    db.add(new_assoc)
    await db.commit()
    await db.refresh(new_assoc)
    
    # –í–æ–∑–≤—Ä–∞—â–∞–µ–º —Å–æ–∑–¥–∞–Ω–Ω—ã–π –æ–±—ä–µ–∫—Ç —Å –∑–∞–≥—Ä—É–∂–µ–Ω–Ω—ã–º–∏ –¥–∞–Ω–Ω—ã–º–∏ –∏–∑ –ë–î
    result = await db.execute(
        select(Association)
        .filter(Association.id == new_assoc.id)
        .options(selectinload(Association.equipment))
    )
    return result.scalars().first()

@router.put("/{assoc_id}", response_model=AssociationOut)
async def update_association(
        assoc_id: int,
        assoc_in: AssociationUpdate,
        db: AsyncSession = Depends(get_db),
        _current_user: User = Depends(require_manager),
        _csrf_protect: CsrfProtect = Depends()
):
    """–û–±–Ω–æ–≤–∏—Ç—å –∞—Å—Å–æ—Ü–∏–∞—Ü–∏—é (–ú–µ–Ω–µ–¥–∂–µ—Ä/–ê–¥–º–∏–Ω)."""
    result = await db.execute(
        select(Association)
        .filter(Association.id == assoc_id)
        .options(selectinload(Association.equipment))
    )
    assoc = result.scalars().first()
    if not assoc:
        raise HTTPException(status_code=404, detail="–ê—Å—Å–æ—Ü–∏–∞—Ü–∏—è –Ω–µ –Ω–∞–π–¥–µ–Ω–∞.")

    update_data = assoc_in.model_dump(exclude_unset=True)

    if 'equipment_ids' in update_data:
        equipment_ids = update_data.pop('equipment_ids')
        assoc.equipment.clear()
        if equipment_ids:
            equipment_result = await db.execute(
                select(Equipment)
                .filter(Equipment.id.in_(equipment_ids))
                .options(
                    selectinload(Equipment.accessories),
                    selectinload(Equipment.associations)
                )
            )
            equipment = equipment_result.unique().scalars().all()
            if len(equipment) != len(set(equipment_ids)):
                raise HTTPException(status_code=404, detail="–û–¥–Ω–æ –∏–ª–∏ –Ω–µ—Å–∫–æ–ª—å–∫–æ –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏–π –Ω–µ –Ω–∞–π–¥–µ–Ω–æ.")
            assoc.equipment = equipment

    for key, value in update_data.items():
        setattr(assoc, key, value)

    await db.commit()
    
    # –ü–æ–≤—Ç–æ—Ä–Ω–æ –ø–æ–ª—É—á–∞–µ–º –æ–±—ä–µ–∫—Ç –∏–∑ –ë–î —Å –∑–∞–≥—Ä—É–∂–µ–Ω–Ω—ã–º–∏ —Å–≤—è–∑—è–º–∏
    result = await db.execute(
        select(Association)
        .filter(Association.id == assoc_id)
        .options(selectinload(Association.equipment))
    )
    return result.scalars().first()

@router.delete("/{assoc_id}", status_code=204)
async def delete_association(
        assoc_id: int,
        db: AsyncSession = Depends(get_db),
        _current_user: User = Depends(require_manager),
        _csrf_protect: CsrfProtect = Depends()
):
    """–£–¥–∞–ª–∏—Ç—å –∞—Å—Å–æ—Ü–∏–∞—Ü–∏—é (–ú–µ–Ω–µ–¥–∂–µ—Ä/–ê–¥–º–∏–Ω)."""
    result = await db.execute(
        select(Association)
        .filter(Association.id == assoc_id)
        .options(selectinload(Association.equipment))
    )
    assoc = result.scalars().first()
    if not assoc:
        raise HTTPException(status_code=404, detail="–ê—Å—Å–æ—Ü–∏–∞—Ü–∏—è –Ω–µ –Ω–∞–π–¥–µ–Ω–∞.")

    await db.delete(assoc)
    await db.commit()
    return None

```


## <a name="RentalAppFASTAPIapiauthapipy"></a>`RentalApp_FASTAPI/api/auth_api.py`

```python
// path: RentalApp_FASTAPI/api/auth_api.py

# api/auth_api.py

from fastapi import APIRouter, Depends, HTTPException, status, Request # Request –º–æ–∂–µ—Ç –ø–æ–Ω–∞–¥–æ–±–∏—Ç—å—Å—è –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏ CSRF
from fastapi.security import OAuth2PasswordRequestForm, OAuth2PasswordBearer
from sqlalchemy.ext.asyncio import AsyncSession
from shared.schemas.user_schema import UserCreate, Token
from api.services.auth_service import (
    create_user,
    authenticate_user,
    create_access_token,
    get_user_by_token,
)
from api.models.user import User
from api.deps import get_db
from fastapi_csrf_protect import CsrfProtect # <--- –î–æ–±–∞–≤–ª–µ–Ω –∏–º–ø–æ—Ä—Ç

router = APIRouter(prefix="/auth", tags=["–ê—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è"])

# OAuth2PasswordBearer –æ–ø—Ä–µ–¥–µ–ª—è–µ—Ç, —á—Ç–æ –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è —Ç–æ–∫–µ–Ω–∞ –Ω—É–∂–Ω–æ –æ–±—Ä–∞—Ç–∏—Ç—å—Å—è –∫ /auth/token
# –§—Ä–æ–Ω—Ç–µ–Ω–¥ –¥–æ–ª–∂–µ–Ω –±—É–¥–µ—Ç —Ç–∞–∫–∂–µ –æ—Ç–ø—Ä–∞–≤–∏—Ç—å CSRF —Ç–æ–∫–µ–Ω –Ω–∞ —ç—Ç–æ—Ç —ç–Ω–¥–ø–æ–∏–Ω—Ç.
oauth2_scheme = OAuth2PasswordBearer(tokenUrl="/auth/token")


@router.post("/register", status_code=status.HTTP_201_CREATED)
async def register_user(
        user_data: UserCreate,
        db: AsyncSession = Depends(get_db),
        csrf_protect: CsrfProtect = Depends() # <--- –î–æ–±–∞–≤–ª–µ–Ω–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç—å CSRF
):
    # –ó–∞–≤–∏—Å–∏–º–æ—Å—Ç—å Depends(CsrfProtect) –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø—Ä–æ–≤–µ—Ä–∏—Ç CSRF —Ç–æ–∫–µ–Ω –¥–ª—è POST –∑–∞–ø—Ä–æ—Å–∞.
    # –§—Ä–æ–Ω—Ç–µ–Ω–¥ –¥–æ–ª–∂–µ–Ω –æ—Ç–ø—Ä–∞–≤–∏—Ç—å CSRF —Ç–æ–∫–µ–Ω, –ø–æ–ª—É—á–µ–Ω–Ω—ã–π –∏–∑ cookie (–æ–±—ã—á–Ω–æ 'fastapi-csrf-token'),
    # –≤ –∑–∞–≥–æ–ª–æ–≤–∫–µ 'X-CSRF-Token'.
    user = await create_user(db, user_data)
    return {"message": "–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —É—Å–ø–µ—à–Ω–æ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω", "email": user.email}


@router.post("/token", response_model=Token)
async def login(
        form_data: OAuth2PasswordRequestForm = Depends(),
        db: AsyncSession = Depends(get_db),
        csrf_protect: CsrfProtect = Depends() # <--- –î–æ–±–∞–≤–ª–µ–Ω–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç—å CSRF
):
    # –ó–∞–≤–∏—Å–∏–º–æ—Å—Ç—å Depends(CsrfProtect) —Ç–∞–∫–∂–µ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø—Ä–æ–≤–µ—Ä–∏—Ç CSRF —Ç–æ–∫–µ–Ω –∑–¥–µ—Å—å.
    user = await authenticate_user(db, form_data.username, form_data.password)
    if not user:
        raise HTTPException(
            status_code=status.HTTP_401_UNAUTHORIZED, # –ò—Å–ø–æ–ª—å–∑—É–µ–º –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π —Å—Ç–∞—Ç—É—Å
            detail="–ù–µ–≤–µ—Ä–Ω—ã–µ —É—á–µ—Ç–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ",
            headers={"WWW-Authenticate": "Bearer"}, # –°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π –∑–∞–≥–æ–ª–æ–≤–æ–∫ –¥–ª—è 401
        )
    access_token = create_access_token({"sub": user.email})

    # fastapi-csrf-protect –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –¥–æ–ª–∂–µ–Ω —É—Å—Ç–∞–Ω–æ–≤–∏—Ç—å/–æ–±–Ω–æ–≤–∏—Ç—å CSRF cookie –≤ –æ—Ç–≤–µ—Ç–µ,
    # –∫–æ–≥–¥–∞ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è Depends(CsrfProtect) –∏ –º–µ—Ç–æ–¥ —è–≤–ª—è–µ—Ç—Å—è state-changing.
    # –ï—Å–ª–∏ –≤—ã —Ö–æ—Ç–∏—Ç–µ –±—ã—Ç—å —É–≤–µ—Ä–µ–Ω—ã –∏–ª–∏ —É–ø—Ä–∞–≤–ª—è—Ç—å —ç—Ç–∏–º —è–≤–Ω–æ (–Ω–∞–ø—Ä–∏–º–µ—Ä, –¥–ª—è –æ—Ç–≤–µ—Ç–∞ –Ω–µ –æ—Ç FastAPI Response):
    # from fastapi.responses import JSONResponse
    # response_content = {"access_token": access_token, "token_type": "bearer"}
    # response = JSONResponse(content=response_content)
    # csrf_protect.set_csrf_cookie(response) # –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å/–æ–±–Ω–æ–≤–∏—Ç—å CSRF cookie –≤ –æ—Ç–≤–µ—Ç–µ
    # return response
    # –ù–æ –¥–ª—è —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã—Ö FastAPI –æ—Ç–≤–µ—Ç–æ–≤ –∏ —Å Depends() —ç—Ç–æ –æ–±—ã—á–Ω–æ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏.

    return {"access_token": access_token, "token_type": "bearer"}


async def get_current_user(
        token: str = Depends(oauth2_scheme), db: AsyncSession = Depends(get_db)
) -> User:
    user = await get_user_by_token(db, token)
    if not user:
        # –ò—Å–ø—Ä–∞–≤–ª—è–µ–º –∫–æ–¥ —Å—Ç–∞—Ç—É—Å–∞ –∏ –¥–æ–±–∞–≤–ª—è–µ–º –∑–∞–≥–æ–ª–æ–≤–æ–∫ –¥–ª—è –æ—à–∏–±–æ–∫ –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏
        raise HTTPException(
            status_code=status.HTTP_401_UNAUTHORIZED,
            detail="–ù–µ–¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω—ã–π –∏–ª–∏ –ø—Ä–æ—Å—Ä–æ—á–µ–Ω–Ω—ã–π —Ç–æ–∫–µ–Ω –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏",
            headers={"WWW-Authenticate": "Bearer"},
        )
    return user

```


## <a name="RentalAppFASTAPIapicalendarapipy"></a>`RentalApp_FASTAPI/api/calendar_api.py`

```python
// path: RentalApp_FASTAPI/api/calendar_api.py

# api/calendar_api.py

from fastapi import APIRouter, Query, Depends, HTTPException
from sqlalchemy.ext.asyncio import AsyncSession
from sqlalchemy import select, func
from datetime import date, timedelta
from typing import List, Optional

from fastapi.security import OAuth2PasswordBearer

from api.deps import get_db, get_availability_service
from api.services.availability import AvailabilityService
from api.models.equipment import Equipment as ApiEquipment
from api.models.user import User as ApiUser
from api.auth_api import get_current_user

from shared.schemas.calendar_schema import (
    EquipmentStatusResponse,
    EquipmentDayStatusesResponse,
    CalendarEventResponse,
    EquipmentStatusListResponse,
    CalendarEventListResponse,
)

optional_oauth2_scheme = OAuth2PasswordBearer(tokenUrl="/auth/token", auto_error=False)

async def get_current_user_optional(token: Optional[str] = Depends(optional_oauth2_scheme), db: AsyncSession = Depends(get_db)) -> Optional[ApiUser]:
    if token is None:
        return None
    try:
        from api.services.auth_service import get_user_by_token as get_user_by_token_service
        user = await get_user_by_token_service(db, token)
        return user
    except HTTPException:
        return None

router = APIRouter(prefix="/calendar", tags=["–ö–∞–ª–µ–Ω–¥–∞—Ä—å"])

@router.get("/view", response_model=EquipmentStatusListResponse)
async def get_calendar_view(
        start_date: date = Query(..., alias="start"),
        end_date: date = Query(..., alias="end"),
        equipment_ids: List[int] = Query(None, alias="ids"),
        exclude_reservation_id: Optional[int] = Query(None, alias="exclude_reservation_id"),
        db: AsyncSession = Depends(get_db),
        availability_service: AvailabilityService = Depends(get_availability_service),
        skip: int = Query(0, ge=0, description="–°–∫–æ–ª—å–∫–æ –∑–∞–ø–∏—Å–µ–π –ø—Ä–æ–ø—É—Å—Ç–∏—Ç—å"),
        limit: int = Query(10, ge=1, le=100, description="–ú–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∑–∞–ø–∏—Å–µ–π –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–µ")
):
    if start_date == end_date:
        end_date = end_date + timedelta(days=1)

    if not equipment_ids:
        result = await db.execute(select(ApiEquipment))
        all_equipment = result.scalars().all()
        equipment_ids = [eq.id for eq in all_equipment]

    if not equipment_ids:
        return EquipmentStatusListResponse(items=[], total=0)

    # –ò—Å–ø–æ–ª—å–∑—É–µ–º –Ω–æ–≤—ã–π AvailabilityService
    statuses = await availability_service.get_availability_statuses(
        equipment_ids=equipment_ids,
        start_date=start_date,
        end_date=end_date,
        exclude_reservation_id=exclude_reservation_id,
    )

    equipment_result = await db.execute(select(ApiEquipment).filter(ApiEquipment.id.in_(equipment_ids)))
    equipment = equipment_result.scalars().all()
    equipment_map = {e.id: e for e in equipment}

    result = []
    for eq_id, status_info in statuses.items():
        eq = equipment_map.get(eq_id)
        result.append(
            EquipmentStatusResponse(
                equipment_id=eq_id,
                status=status_info["status"],
                details=status_info["details"],
                name=eq.name if eq else None,
                equipment_type=eq.equipment_type if eq else None,
                brand=eq.brand if eq else None,
                start_date=status_info.get("start_date"),
                end_date=status_info.get("end_date"),
            )
        )

    total_items = len(result)
    paginated_result = result[skip:skip + limit]

    return EquipmentStatusListResponse(
        items=paginated_result,
        total=total_items
    )


@router.get("/day-statuses", response_model=EquipmentDayStatusesResponse)
async def get_calendar_day_statuses(
        start_date: date = Query(..., alias="start"),
        end_date: date = Query(..., alias="end"),
        equipment_ids: List[int] = Query(None, alias="ids"),
        exclude_reservation_id: Optional[int] = Query(None, alias="exclude_reservation_id"),
        db: AsyncSession = Depends(get_db),
        availability_service: AvailabilityService = Depends(get_availability_service),
        current_user: Optional[ApiUser] = Depends(get_current_user_optional)
):
    if start_date == end_date:
        end_date = end_date + timedelta(days=1)

    if not equipment_ids:
        result = await db.execute(select(ApiEquipment))
        all_equipment = result.scalars().all()
        equipment_ids = [eq.id for eq in all_equipment]

    if not equipment_ids:
        return {"equipment_day_statuses": {}}

    current_user_id: Optional[int] = current_user.id if current_user else None

    # –ò—Å–ø–æ–ª—å–∑—É–µ–º –Ω–æ–≤—ã–π AvailabilityService
    statuses = await availability_service.get_daily_statuses(
        equipment_ids=equipment_ids,
        start_date=start_date,
        end_date=end_date,
        exclude_reservation_id=exclude_reservation_id,
        current_user_id=current_user_id
    )

    return {"equipment_day_statuses": statuses}


@router.get("/events", response_model=CalendarEventListResponse)
async def get_calendar_events(
        start: date = Query(..., alias="start"),
        end: date = Query(..., alias="end"),
        equipment_ids: List[int] = Query(None, alias="ids"),
        db: AsyncSession = Depends(get_db),
        availability_service: AvailabilityService = Depends(get_availability_service),
        skip: int = Query(0, ge=0, description="–°–∫–æ–ª—å–∫–æ –∑–∞–ø–∏—Å–µ–π –ø—Ä–æ–ø—É—Å—Ç–∏—Ç—å"),
        limit: int = Query(10, ge=1, le=100, description="–ú–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∑–∞–ø–∏—Å–µ–π –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–µ")
):
    if not equipment_ids:
        result = await db.execute(select(ApiEquipment))
        all_equipment = result.scalars().all()
        equipment_ids = [eq.id for eq in all_equipment]

    # –ò—Å–ø–æ–ª—å–∑—É–µ–º –Ω–æ–≤—ã–π AvailabilityService
    events = await availability_service.get_calendar_events(
        equipment_ids=equipment_ids,
        start_date=start,
        end_date=end,
    )

    total_events = len(events)
    paginated_events = events[skip:skip + limit]

    return CalendarEventListResponse(
        items=paginated_events,
        total=total_events
    )

```


## <a name="RentalAppFASTAPIapidatabasepy"></a>`RentalApp_FASTAPI/api/database.py`

```python
// path: RentalApp_FASTAPI/api/database.py

# api/database.py

from sqlalchemy.ext.asyncio import create_async_engine, async_sessionmaker, AsyncSession
from sqlalchemy.orm import declarative_base
# –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –≤–∞—à —Ñ–∞–π–ª config/secrets.py –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ –∑–∞–≥—Ä—É–∂–∞–µ—Ç DATABASE_URL –∏–∑ .env
# –ù–∞–ø—Ä–∏–º–µ—Ä, –∏—Å–ø–æ–ª—å–∑—É—è pydantic_settings –∏–ª–∏ python-dotenv
from config.secrets import DATABASE_URL

# –°–æ–∑–¥–∞–µ–º –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω—ã–π –¥–≤–∏–∂–æ–∫, –∏—Å–ø–æ–ª—å–∑—É—è URL –Ω–∞–ø—Ä—è–º—É—é –∏–∑ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏
engine = create_async_engine(DATABASE_URL, echo=False, future=True)

# –°–æ–∑–¥–∞–µ–º —Ñ–∞–±—Ä–∏–∫—É –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω—ã—Ö —Å–µ—Å—Å–∏–π
AsyncSessionLocal = async_sessionmaker(
    bind=engine,
    class_=AsyncSession,
    expire_on_commit=False,
    autocommit=False,
    autoflush=False
)

Base = declarative_base()

# –°–æ–∑–¥–∞–µ–º –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω—É—é –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç—å –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è —Å–µ—Å—Å–∏–∏
async def get_db() -> AsyncSession:
    """–ê—Å–∏–Ω—Ö—Ä–æ–Ω–Ω—ã–π –≥–µ–Ω–µ—Ä–∞—Ç–æ—Ä –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è —Å–µ—Å—Å–∏–∏ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö."""
    async with AsyncSessionLocal() as session:
        try:
            yield session
        finally:
            await session.close()

```


## <a name="RentalAppFASTAPIapidepspy"></a>`RentalApp_FASTAPI/api/deps.py`

```python
// path: RentalApp_FASTAPI/api/deps.py

# api/deps.py

from fastapi import Depends
from sqlalchemy.ext.asyncio import AsyncSession
from fastapi.security import OAuth2PasswordBearer
from fastapi import HTTPException, status

from api.database import get_db as get_database
from api.services.auth_service import get_user_by_token
from api.models.user import User

# –ò–º–ø–æ—Ä—Ç—ã —Å–µ—Ä–≤–∏—Å–æ–≤
from api.services.order.order_lifecycle_service import OrderLifecycleService
from api.services.rental.rental_query_service import RentalQueryService
from api.services.reservation_query_service import ReservationQueryService
from api.services.balance_service import BalanceService
from api.services.equipment_query_builder import EquipmentQueryBuilder
from api.services.financial_service import FinancialService
from api.services.availability import AvailabilityService
from api.services.dashboard_service import DashboardService

# OAuth2PasswordBearer –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è —Ç–æ–∫–µ–Ω–∞ –∏–∑ –∑–∞–≥–æ–ª–æ–≤–∫–∞ Authorization
oauth2_scheme = OAuth2PasswordBearer(tokenUrl="/auth/token")


async def get_db():
    """–ó–∞–≤–∏—Å–∏–º–æ—Å—Ç—å –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è —Å–µ—Å—Å–∏–∏ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö."""
    async for db in get_database():
        yield db


async def get_current_user(
    token: str = Depends(oauth2_scheme), 
    db: AsyncSession = Depends(get_db)
) -> User:
    """–ü–æ–ª—É—á–∏—Ç—å —Ç–µ–∫—É—â–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –ø–æ —Ç–æ–∫–µ–Ω—É."""
    user = await get_user_by_token(db, token)
    if not user:
        raise HTTPException(
            status_code=status.HTTP_401_UNAUTHORIZED,
            detail="–ù–µ–¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω—ã–π –∏–ª–∏ –ø—Ä–æ—Å—Ä–æ—á–µ–Ω–Ω—ã–π —Ç–æ–∫–µ–Ω –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏",
            headers={"WWW-Authenticate": "Bearer"},
        )
    return user


# === –ó–ê–í–ò–°–ò–ú–û–°–¢–ò –î–õ–Ø –°–ï–†–í–ò–°–û–í ===

def get_order_lifecycle_service(db: AsyncSession = Depends(get_db)) -> OrderLifecycleService:
    """–ó–∞–≤–∏—Å–∏–º–æ—Å—Ç—å –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è —Å–µ—Ä–≤–∏—Å–∞ –∂–∏–∑–Ω–µ–Ω–Ω–æ–≥–æ —Ü–∏–∫–ª–∞ –∑–∞–∫–∞–∑–æ–≤."""
    return OrderLifecycleService(db)


def get_rental_query_service(db: AsyncSession = Depends(get_db)) -> RentalQueryService:
    """–ó–∞–≤–∏—Å–∏–º–æ—Å—Ç—å –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è —Å–µ—Ä–≤–∏—Å–∞ –∑–∞–ø—Ä–æ—Å–æ–≤ –∞—Ä–µ–Ω–¥—ã."""
    return RentalQueryService(db)


def get_reservation_query_service(db: AsyncSession = Depends(get_db)) -> ReservationQueryService:
    """–ó–∞–≤–∏—Å–∏–º–æ—Å—Ç—å –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è —Å–µ—Ä–≤–∏—Å–∞ –∑–∞–ø—Ä–æ—Å–æ–≤ —Ä–µ–∑–µ—Ä–≤–∞—Ü–∏–π."""
    return ReservationQueryService(db)




def get_balance_service(db: AsyncSession = Depends(get_db)) -> BalanceService:
    """–ó–∞–≤–∏—Å–∏–º–æ—Å—Ç—å –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è —Å–µ—Ä–≤–∏—Å–∞ –±–∞–ª–∞–Ω—Å–∞."""
    return BalanceService(db)


def get_equipment_query_builder(db: AsyncSession = Depends(get_db)) -> EquipmentQueryBuilder:
    """–ó–∞–≤–∏—Å–∏–º–æ—Å—Ç—å –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –±–∏–ª–¥–µ—Ä–∞ –∑–∞–ø—Ä–æ—Å–æ–≤ –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—è."""
    return EquipmentQueryBuilder(db)


def get_financial_service(db: AsyncSession = Depends(get_db)) -> FinancialService:
    """–ó–∞–≤–∏—Å–∏–º–æ—Å—Ç—å –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è —Ñ–∏–Ω–∞–Ω—Å–æ–≤–æ–≥–æ —Å–µ—Ä–≤–∏—Å–∞."""
    return FinancialService(db)


def get_availability_service(db: AsyncSession = Depends(get_db)) -> AvailabilityService:
    """–ó–∞–≤–∏—Å–∏–º–æ—Å—Ç—å –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è —Å–µ—Ä–≤–∏—Å–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏ –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—è."""
    return AvailabilityService(db)


def get_dashboard_service(db: AsyncSession = Depends(get_db)) -> DashboardService:
    """–ó–∞–≤–∏—Å–∏–º–æ—Å—Ç—å –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è —Å–µ—Ä–≤–∏—Å–∞ –ø–∞–Ω–µ–ª–∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è."""
    return DashboardService(db)

```


## <a name="RentalAppFASTAPIapidiscountapipy"></a>`RentalApp_FASTAPI/api/discount_api.py`

```python
// path: RentalApp_FASTAPI/api/discount_api.py

# api/discount_api.py

from typing import List
from fastapi import APIRouter, Depends, HTTPException, Query
from sqlalchemy.ext.asyncio import AsyncSession
from sqlalchemy import select, func
from fastapi_csrf_protect import CsrfProtect

from api.deps import get_db
from api.models.user import User
from api.models.discount import DurationDiscount
from api.permissions import require_admin
from shared.schemas.discount_schema import DiscountCreate, DiscountUpdate, DiscountOut, DiscountListResponse

router = APIRouter(prefix="/discounts", tags=["–°–∫–∏–¥–∫–∏ –∑–∞ –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å"])

@router.get("/", response_model=DiscountListResponse)
async def get_all_discounts(
        db: AsyncSession = Depends(get_db),
        skip: int = Query(0, ge=0, description="–°–∫–æ–ª—å–∫–æ –∑–∞–ø–∏—Å–µ–π –ø—Ä–æ–ø—É—Å—Ç–∏—Ç—å"),
        limit: int = Query(10, ge=1, le=100, description="–ú–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∑–∞–ø–∏—Å–µ–π –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–µ")
):
    """–ü–æ–ª—É—á–∏—Ç—å –≤—Å–µ —É—Ä–æ–≤–Ω–∏ —Å–∫–∏–¥–æ–∫ –∑–∞ –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å —Å –ø–∞–≥–∏–Ω–∞—Ü–∏–µ–π."""
    # 1. –ó–∞–ø—Ä–æ—Å –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –æ–±—â–µ–≥–æ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ —Å–∫–∏–¥–æ–∫
    total_result = await db.execute(select(func.count(DurationDiscount.id)))
    total_discounts = total_result.scalar_one()

    # 2. –ó–∞–ø—Ä–æ—Å –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è "—Å—Ç—Ä–∞–Ω–∏—Ü—ã" —Å–∫–∏–¥–æ–∫
    discounts_result = await db.execute(
        select(DurationDiscount).order_by(DurationDiscount.min_days).offset(skip).limit(limit)
    )
    discounts_orm = discounts_result.scalars().all()

    # 3. –§–æ—Ä–º–∏—Ä—É–µ–º –∏ –≤–æ–∑–≤—Ä–∞—â–∞–µ–º –Ω–æ–≤—ã–π –æ–±—ä–µ–∫—Ç –æ—Ç–≤–µ—Ç–∞
    return DiscountListResponse(
        items=[DiscountOut.from_orm(discount) for discount in discounts_orm],
        total=total_discounts
    )

@router.post("/", response_model=DiscountOut, status_code=201)
async def create_discount(
        discount_in: DiscountCreate,
        db: AsyncSession = Depends(get_db),
        current_user: User = Depends(require_admin),
        csrf_protect: CsrfProtect = Depends()
):
    """–°–æ–∑–¥–∞—Ç—å –Ω–æ–≤—ã–π —É—Ä–æ–≤–µ–Ω—å —Å–∫–∏–¥–∫–∏."""
    result = await db.execute(select(DurationDiscount).filter(DurationDiscount.min_days == discount_in.min_days))
    existing = result.scalars().first()
    if existing:
        raise HTTPException(status_code=409, detail=f"–°–∫–∏–¥–∫–∞ –¥–ª—è {discount_in.min_days} –¥–Ω–µ–π —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç.")

    new_discount = DurationDiscount(**discount_in.model_dump())
    db.add(new_discount)
    await db.commit()
    await db.refresh(new_discount)
    
    # –í–æ–∑–≤—Ä–∞—â–∞–µ–º —Å–æ–∑–¥–∞–Ω–Ω—ã–π –æ–±—ä–µ–∫—Ç —Å –∑–∞–≥—Ä—É–∂–µ–Ω–Ω—ã–º–∏ –¥–∞–Ω–Ω—ã–º–∏ –∏–∑ –ë–î
    return new_discount

@router.put("/{discount_id}", response_model=DiscountOut)
async def update_discount(
        discount_id: int,
        discount_in: DiscountUpdate,
        db: AsyncSession = Depends(get_db),
        current_user: User = Depends(require_admin),
        csrf_protect: CsrfProtect = Depends()
):
    """–û–±–Ω–æ–≤–∏—Ç—å —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π —É—Ä–æ–≤–µ–Ω—å —Å–∫–∏–¥–∫–∏."""
    result = await db.execute(select(DurationDiscount).filter(DurationDiscount.id == discount_id))
    discount = result.scalars().first()
    if not discount:
        raise HTTPException(status_code=404, detail="–°–∫–∏–¥–∫–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞.")

    existing_result = await db.execute(
        select(DurationDiscount).filter(
            DurationDiscount.min_days == discount_in.min_days,
            DurationDiscount.id != discount_id
        )
    )
    existing = existing_result.scalars().first()
    if existing:
        raise HTTPException(status_code=409, detail=f"–°–∫–∏–¥–∫–∞ –¥–ª—è {discount_in.min_days} –¥–Ω–µ–π —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç.")

    update_data = discount_in.model_dump()
    for key, value in update_data.items():
        setattr(discount, key, value)

    await db.commit()
    await db.refresh(discount)
    
    # –í–æ–∑–≤—Ä–∞—â–∞–µ–º –æ–±–Ω–æ–≤–ª–µ–Ω–Ω—ã–π –æ–±—ä–µ–∫—Ç —Å –∑–∞–≥—Ä—É–∂–µ–Ω–Ω—ã–º–∏ –¥–∞–Ω–Ω—ã–º–∏ –∏–∑ –ë–î
    return discount

@router.delete("/{discount_id}", status_code=204)
async def delete_discount(
        discount_id: int,
        db: AsyncSession = Depends(get_db),
        current_user: User = Depends(require_admin),
        csrf_protect: CsrfProtect = Depends()
):
    """–£–¥–∞–ª–∏—Ç—å —É—Ä–æ–≤–µ–Ω—å —Å–∫–∏–¥–∫–∏."""
    result = await db.execute(select(DurationDiscount).filter(DurationDiscount.id == discount_id))
    discount = result.scalars().first()
    if not discount:
        raise HTTPException(status_code=404, detail="–°–∫–∏–¥–∫–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞.")

    await db.delete(discount)
    await db.commit()
    return None

```


## <a name="RentalAppFASTAPIapiequipmentapipy"></a>`RentalApp_FASTAPI/api/equipment_api.py`

```python
// path: RentalApp_FASTAPI/api/equipment_api.py

# api/equipment_api.py

from fastapi import APIRouter, Depends, HTTPException, Query
from sqlalchemy.ext.asyncio import AsyncSession
from sqlalchemy import select, func
from sqlalchemy.orm import selectinload
from typing import List, Optional
from datetime import date, datetime
from collections import defaultdict
from fastapi_csrf_protect import CsrfProtect

from api.models.equipment import Equipment
from api.models.user import User
from api.models.rental import Rental
from api.models.reservation import Reservation
from api.deps import get_db
from api.permissions import require_manager
# --- –ò–ó–ú–ï–ù–ï–ù–ò–ï: –ò–º–ø–æ—Ä—Ç–∏—Ä—É–µ–º –Ω–æ–≤—É—é —Å–µ—Ä–≤–∏—Å–Ω—É—é —Ñ—É–Ω–∫—Ü–∏—é –∏ —Å—Ö–µ–º—É –æ—Ç–≤–µ—Ç–∞ ---
from api.services.equipment_service_api import get_paginated_equipment, update_equipment_details
from shared.schemas.equipment_schema import (
    EquipmentOut,
    EquipmentTreeItem,
    EquipmentUpdateExtended,
    EquipmentCreate,
    EquipmentAvailabilityStatus,
    EquipmentListResponse,
    EquipmentTreeListResponse
)

router = APIRouter(prefix="/equipment", tags=["–û–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏–µ"])


@router.get("/", response_model=EquipmentListResponse)
async def list_equipment_paginated(
        db: AsyncSession = Depends(get_db),
        skip: int = Query(0, ge=0),
        limit: int = Query(10, ge=1, le=1000),
        query: Optional[str] = Query(None),
        type: Optional[str] = Query(None),
        brand: Optional[str] = Query(None),
        association_id: Optional[int] = Query(None, alias="associationId"),
        start_date: Optional[date] = Query(None, alias="startDate"),
        end_date: Optional[date] = Query(None, alias="endDate"),
        available_only: bool = Query(False, alias="availableOnly")
):
    """–í–æ–∑–≤—Ä–∞—â–∞–µ—Ç –æ—Ç—Ñ–∏–ª—å—Ç—Ä–æ–≤–∞–Ω–Ω—ã–π –∏ –ø–∞–≥–∏–Ω–∏—Ä–æ–≤–∞–Ω–Ω—ã–π —Å–ø–∏—Å–æ–∫ –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—è."""
    items, total = await get_paginated_equipment(
        db, skip=skip, limit=limit, query=query, type=type, brand=brand,
        association_id=association_id, start_date=start_date, end_date=end_date,
        available_only=available_only
    )
    return EquipmentListResponse(items=items, total=total)


@router.get("/tree", response_model=EquipmentTreeListResponse)
async def get_equipment_tree(
        db: AsyncSession = Depends(get_db),
        skip: int = Query(0, ge=0),
        limit: int = Query(10, ge=1, le=100)
):
    """–í–æ–∑–≤—Ä–∞—â–∞–µ—Ç –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏–µ, —Å–≥—Ä—É–ø–ø–∏—Ä–æ–≤–∞–Ω–Ω–æ–µ –≤ –≤–∏–¥–µ –¥–µ—Ä–µ–≤–∞ –ø–æ —Ç–∏–ø—É –∏ –±—Ä–µ–Ω–¥—É —Å –ø–∞–≥–∏–Ω–∞—Ü–∏–µ–π."""
    result = await db.execute(select(Equipment))
    all_equipment = result.scalars().all()
    grouped: dict[str, dict[str, list[Equipment]]] = defaultdict(lambda: defaultdict(list))
    for eq in all_equipment:
        grouped[eq.equipment_type][eq.brand].append(eq)

    result = []
    for eq_type, brands in grouped.items():
        type_node = EquipmentTreeItem(label=eq_type, children=[])
        for brand, items in brands.items():
            brand_node = EquipmentTreeItem(label=brand, children=[
                EquipmentTreeItem(label=item.name, value=item.id) for item in items
            ])
            type_node.children.append(brand_node)
        result.append(type_node)

    total_items = len(result)
    paginated_result = result[skip:skip + limit]

    return EquipmentTreeListResponse(
        items=paginated_result,
        total=total_items
    )


@router.put("/{equipment_id}", response_model=EquipmentOut)
async def update_single_equipment_details_route(
        equipment_id: int,
        equipment_data: EquipmentUpdateExtended,
        db: AsyncSession = Depends(get_db),
        _current_user: User = Depends(require_manager),
        _csrf_protect: CsrfProtect = Depends()
):
    """–û–±–Ω–æ–≤–ª—è–µ—Ç –¥–µ—Ç–∞–ª–∏ —É–∫–∞–∑–∞–Ω–Ω–æ–≥–æ –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—è."""
    updated_equipment = await update_equipment_details(db, equipment_id, equipment_data)
    return updated_equipment


@router.post("/", response_model=EquipmentOut)
async def create_equipment(
        equipment_data: EquipmentCreate,
        db: AsyncSession = Depends(get_db),
        _current_user: User = Depends(require_manager),
        _csrf_protect: CsrfProtect = Depends()
):
    """–°–æ–∑–¥–∞–µ—Ç –Ω–æ–≤–æ–µ –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏–µ."""
    equipment = Equipment(**equipment_data.model_dump())
    db.add(equipment)
    await db.commit()
    await db.refresh(equipment)
    
    # –ó–∞–≥—Ä—É–∂–∞–µ–º —Å–≤—è–∑–∞–Ω–Ω—ã–µ –æ–±—ä–µ–∫—Ç—ã –¥–ª—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–π —Å–µ—Ä–∏–∞–ª–∏–∑–∞—Ü–∏–∏
    result = await db.execute(
        select(Equipment)
        .filter(Equipment.id == equipment.id)
        .options(
            selectinload(Equipment.accessories),
            selectinload(Equipment.associations)
        )
    )
    equipment_with_relations = result.scalars().first()
    
    return equipment_with_relations


@router.delete("/{equipment_id}")
async def delete_equipment(
        equipment_id: int,
        db: AsyncSession = Depends(get_db),
        _current_user: User = Depends(require_manager),
        _csrf_protect: CsrfProtect = Depends()
):
    """–£–¥–∞–ª—è–µ—Ç –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏–µ."""
    result = await db.execute(select(Equipment).filter(Equipment.id == equipment_id))
    equipment = result.scalars().first()
    if not equipment:
        raise HTTPException(status_code=404, detail="–û–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏–µ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ")
    await db.delete(equipment)
    await db.commit()
    return {"message": "–û–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏–µ —É–¥–∞–ª–µ–Ω–æ"}


@router.get("/{equipment_id}/availability", response_model=EquipmentAvailabilityStatus)
async def get_equipment_availability_status(
        equipment_id: int,
        db: AsyncSession = Depends(get_db),
        _current_user: User = Depends(require_manager)
):
    """
    –ü—Ä–æ–≤–µ—Ä—è–µ—Ç, —É—á–∞—Å—Ç–≤—É–µ—Ç –ª–∏ –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏–µ –≤ –ù–ï–ó–ê–í–ï–†–®–ï–ù–ù–´–• —Ä–µ–∑–µ—Ä–≤–∞—Ö –∏–ª–∏ –∞—Ä–µ–Ω–¥–∞—Ö.
    """
    result = await db.execute(select(Equipment).filter(Equipment.id == equipment_id))
    equipment = result.scalars().first()
    if not equipment:
        raise HTTPException(status_code=404, detail="–û–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏–µ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ")

    today_start_of_day = datetime.combine(date.today(), datetime.min.time())

    reservations_result = await db.execute(
        select(func.count(Reservation.id)).filter(
            Reservation.equipment.any(Equipment.id == equipment_id),
            Reservation.end_date >= today_start_of_day
        )
    )
    active_reservations_count = reservations_result.scalar_one()

    rentals_result = await db.execute(
        select(func.count(Rental.id)).filter(
            Rental.equipment.any(Equipment.id == equipment_id),
            Rental.end_date >= today_start_of_day
        )
    )
    active_rentals_count = rentals_result.scalar_one()

    return EquipmentAvailabilityStatus(
        has_active_reservations=active_reservations_count > 0,
        has_active_rentals=active_rentals_count > 0,
        active_reservations_count=active_reservations_count,
        active_rentals_count=active_rentals_count,
    )

```


## <a name="RentalAppFASTAPIapiholidayapipy"></a>`RentalApp_FASTAPI/api/holiday_api.py`

```python
// path: RentalApp_FASTAPI/api/holiday_api.py

# api/holiday_api.py

from fastapi import APIRouter, Depends, HTTPException, Query
from sqlalchemy.ext.asyncio import AsyncSession
from sqlalchemy import select, func
from typing import List
from datetime import date, timedelta, datetime
import holidays

from api.deps import get_db
from api.permissions import require_admin
from api.models.user import User
from api.models.holiday import Holiday, HolidayRule
from api.models.reservation import Reservation
from shared.schemas.holiday_schema import HolidayOut, HolidayCreate, RecurringHolidayRuleCreate, HolidayRuleOut, HolidayListResponse, HolidayRuleListResponse

router = APIRouter(prefix="/holidays", tags=["–í—ã—Ö–æ–¥–Ω—ã–µ –∏ –ø—Ä–∞–∑–¥–Ω–∏–∫–∏"])

@router.get("/", response_model=HolidayListResponse)
async def get_holidays(
        start_date: date,
        end_date: date,
        db: AsyncSession = Depends(get_db),
        skip: int = Query(0, ge=0, description="–°–∫–æ–ª—å–∫–æ –∑–∞–ø–∏—Å–µ–π –ø—Ä–æ–ø—É—Å—Ç–∏—Ç—å"),
        limit: int = Query(400, ge=1, description="–ú–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∑–∞–ø–∏—Å–µ–π –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–µ")
):
    """–ü–æ–ª—É—á–∏—Ç—å —Å–ø–∏—Å–æ–∫ –≤—ã—Ö–æ–¥–Ω—ã—Ö –≤ –∑–∞–¥–∞–Ω–Ω–æ–º –¥–∏–∞–ø–∞–∑–æ–Ω–µ –¥–∞—Ç —Å –ø–∞–≥–∏–Ω–∞—Ü–∏–µ–π."""
    # 1. –ó–∞–ø—Ä–æ—Å –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –æ–±—â–µ–≥–æ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ –≤—ã—Ö–æ–¥–Ω—ã—Ö –≤ –¥–∏–∞–ø–∞–∑–æ–Ω–µ
    total_result = await db.execute(
        select(func.count(Holiday.date)).filter(Holiday.date.between(start_date, end_date))
    )
    total_holidays = total_result.scalar_one()

    # 2. –ó–∞–ø—Ä–æ—Å –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è "—Å—Ç—Ä–∞–Ω–∏—Ü—ã" –≤—ã—Ö–æ–¥–Ω—ã—Ö
    holidays_result = await db.execute(
        select(Holiday).filter(Holiday.date.between(start_date, end_date)).offset(skip).limit(limit)
    )
    holidays_orm = holidays_result.scalars().all()

    # 3. –§–æ—Ä–º–∏—Ä—É–µ–º –∏ –≤–æ–∑–≤—Ä–∞—â–∞–µ–º –Ω–æ–≤—ã–π –æ–±—ä–µ–∫—Ç –æ—Ç–≤–µ—Ç–∞
    return HolidayListResponse(
        items=[HolidayOut.from_orm(holiday) for holiday in holidays_orm],
        total=total_holidays
    )

@router.post("/", response_model=dict)
async def create_holiday(
        holiday_in: HolidayCreate,
        db: AsyncSession = Depends(get_db),
        current_user: User = Depends(require_admin)
):
    """–°–æ–∑–¥–∞—Ç—å –Ω–æ–≤—ã–π –≤—ã—Ö–æ–¥–Ω–æ–π –¥–µ–Ω—å (—Ä—É—á–Ω–æ–µ –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ)."""
    conflicting_result = await db.execute(
        select(Reservation.id).filter(
            (Reservation.start_date == holiday_in.date) | (Reservation.end_date == holiday_in.date)
        )
    )
    conflicting_ids = [r.id for r in conflicting_result.scalars().all()]
    if conflicting_ids and not holiday_in.force:
        raise HTTPException(
            status_code=409,
            detail={
                "message": "–≠—Ç–∞ –¥–∞—Ç–∞ —è–≤–ª—è–µ—Ç—Å—è –Ω–∞—á–∞–ª–æ–º –∏–ª–∏ –∫–æ–Ω—Ü–æ–º —Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö —Ä–µ–∑–µ—Ä–≤–æ–≤. –ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç–µ –¥–µ–π—Å—Ç–≤–∏–µ.",
                "conflicting_reservation_ids": conflicting_ids
            }
        )
    existing_result = await db.execute(select(Holiday).filter(Holiday.date == holiday_in.date))
    existing_holiday = existing_result.scalars().first()
    if existing_holiday:
        raise HTTPException(status_code=400, detail="–≠—Ç–æ—Ç –¥–µ–Ω—å —É–∂–µ —è–≤–ª—è–µ—Ç—Å—è –≤—ã—Ö–æ–¥–Ω—ã–º.")
    new_holiday = Holiday(
        **holiday_in.model_dump(exclude={"force"}),
        created_by_id=current_user.id
    )
    db.add(new_holiday)
    await db.commit()
    await db.refresh(new_holiday)
    return {"message": "–í—ã—Ö–æ–¥–Ω–æ–π –¥–µ–Ω—å —É—Å–ø–µ—à–Ω–æ –¥–æ–±–∞–≤–ª–µ–Ω", "date": new_holiday.date}


@router.delete("/{holiday_date}", status_code=204)
async def delete_holiday(
        holiday_date: date,
        db: AsyncSession = Depends(get_db),
        _current_user: User = Depends(require_admin)
):
    """–£–¥–∞–ª–∏—Ç—å –≤—ã—Ö–æ–¥–Ω–æ–π –¥–µ–Ω—å."""
    result = await db.execute(select(Holiday).filter(Holiday.date == holiday_date))
    holiday = result.scalars().first()
    if not holiday:
        raise HTTPException(status_code=404, detail="–í—ã—Ö–æ–¥–Ω–æ–π –¥–µ–Ω—å –Ω–µ –Ω–∞–π–¥–µ–Ω")
    await db.delete(holiday)
    await db.commit()
    return None

@router.post("/recurring/weekly", status_code=201, summary="–°–æ–∑–¥–∞—Ç—å –µ–∂–µ–Ω–µ–¥–µ–ª—å–Ω—ã–µ –≤—ã—Ö–æ–¥–Ω—ã–µ")
async def create_weekly_recurring_holidays(
        rule_in: RecurringHolidayRuleCreate,
        db: AsyncSession = Depends(get_db),
        current_user: User = Depends(require_admin)
):
    """–°–æ–∑–¥–∞–µ—Ç –ø—Ä–∞–≤–∏–ª–æ –∏ –≥–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç –≤—ã—Ö–æ–¥–Ω—ã–µ –¥–ª—è —É–∫–∞–∑–∞–Ω–Ω–æ–≥–æ –¥–Ω—è –Ω–µ–¥–µ–ª–∏ –≤ –¥–∏–∞–ø–∞–∑–æ–Ω–µ –¥–∞—Ç."""
    if rule_in.start_date >= rule_in.end_date:
        raise HTTPException(status_code=400, detail="–î–∞—Ç–∞ –Ω–∞—á–∞–ª–∞ –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å —Ä–∞–Ω—å—à–µ –¥–∞—Ç—ã –æ–∫–æ–Ω—á–∞–Ω–∏—è.")
    new_rule = HolidayRule(
        rule_type="weekly",
        parameters={"day_of_week": rule_in.day_of_week},
        description=rule_in.description,
        created_by_id=current_user.id
    )
    db.add(new_rule)
    await db.flush()
    holidays_to_create = []
    current_date = rule_in.start_date
    while current_date <= rule_in.end_date:
        if current_date.weekday() == rule_in.day_of_week:
            exists_result = await db.execute(select(Holiday).filter(Holiday.date == current_date))
            exists = exists_result.scalars().first()
            if not exists:
                holidays_to_create.append(
                    Holiday(
                        date=current_date,
                        description=f"–ê–≤—Ç–æ (–ø—Ä–∞–≤–∏–ª–æ #{new_rule.id})",
                        created_by_id=current_user.id,
                        rule_id=new_rule.id
                    )
                )
        current_date += timedelta(days=1)
    if holidays_to_create:
        db.add_all(holidays_to_create)
    await db.commit()
    return {"message": f"–ü—Ä–∞–≤–∏–ª–æ —Å–æ–∑–¥–∞–Ω–æ. –î–æ–±–∞–≤–ª–µ–Ω–æ {len(holidays_to_create)} –Ω–æ–≤—ã—Ö –≤—ã—Ö–æ–¥–Ω—ã—Ö."}


@router.post("/import/public", status_code=201, summary="–ò–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å –≥–æ—Å. –ø—Ä–∞–∑–¥–Ω–∏–∫–∏")
async def import_public_holidays(
        country_code: str = Query("RU", description="ISO 3166-1 alpha-2 –∫–æ–¥ —Å—Ç—Ä–∞–Ω—ã"),
        year: int = Query(datetime.now().year, description="–ì–æ–¥ –¥–ª—è –∏–º–ø–æ—Ä—Ç–∞"),
        db: AsyncSession = Depends(get_db),
        current_user: User = Depends(require_admin)
):
    """–ò–º–ø–æ—Ä—Ç–∏—Ä—É–µ—Ç –≥–æ—Å—É–¥–∞—Ä—Å—Ç–≤–µ–Ω–Ω—ã–µ –ø—Ä–∞–∑–¥–Ω–∏–∫–∏ –¥–ª—è —É–∫–∞–∑–∞–Ω–Ω–æ–π —Å—Ç—Ä–∞–Ω—ã –∏ –≥–æ–¥–∞."""
    try:
        public_holidays = holidays.country_holidays(country_code, years=year)
        if not public_holidays:
            raise HTTPException(status_code=404, detail=f"–ù–µ –Ω–∞–π–¥–µ–Ω—ã –ø—Ä–∞–∑–¥–Ω–∏–∫–∏ –¥–ª—è —Å—Ç—Ä–∞–Ω—ã '{country_code}' –≤ {year} –≥–æ–¥—É.")
    except KeyError:
        raise HTTPException(status_code=400, detail=f"–ù–µ–≤–µ—Ä–Ω—ã–π –∫–æ–¥ —Å—Ç—Ä–∞–Ω—ã: '{country_code}'")

    rule_description = f"–ò–º–ø–æ—Ä—Ç –≥–æ—Å. –ø—Ä–∞–∑–¥–Ω–∏–∫–æ–≤ –¥–ª—è {country_code} –Ω–∞ {year} –≥–æ–¥"
    new_rule = HolidayRule(
        rule_type="public_import",
        parameters={"country": country_code, "year": year},
        description=rule_description,
        created_by_id=current_user.id
    )
    db.add(new_rule)
    await db.flush()

    holidays_to_create = []
    for holiday_date, holiday_name in public_holidays.items():
        exists_result = await db.execute(select(Holiday).filter(Holiday.date == holiday_date))
        exists = exists_result.scalars().first()
        if not exists:
            holidays_to_create.append(
                Holiday(
                    date=holiday_date,
                    description=holiday_name,
                    created_by_id=current_user.id,
                    rule_id=new_rule.id
                )
            )

    if holidays_to_create:
        db.add_all(holidays_to_create)

    await db.commit()
    return {"message": f"–ü—Ä–∞–≤–∏–ª–æ –∏–º–ø–æ—Ä—Ç–∞ —Å–æ–∑–¥–∞–Ω–æ. –î–æ–±–∞–≤–ª–µ–Ω–æ {len(holidays_to_create)} –ø—Ä–∞–∑–¥–Ω–∏—á–Ω—ã—Ö –¥–Ω–µ–π."}

@router.get("/rules", response_model=HolidayRuleListResponse, summary="–ü–æ–ª—É—á–∏—Ç—å —Å–ø–∏—Å–æ–∫ –≤—Å–µ—Ö –ø—Ä–∞–≤–∏–ª")
async def get_all_rules(
        db: AsyncSession = Depends(get_db),
        current_user: User = Depends(require_admin),
        skip: int = Query(0, ge=0, description="–°–∫–æ–ª—å–∫–æ –∑–∞–ø–∏—Å–µ–π –ø—Ä–æ–ø—É—Å—Ç–∏—Ç—å"),
        limit: int = Query(10, ge=1, le=100, description="–ú–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∑–∞–ø–∏—Å–µ–π –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–µ")
):
    """–í–æ–∑–≤—Ä–∞—â–∞–µ—Ç –≤—Å–µ —Å–æ–∑–¥–∞–Ω–Ω—ã–µ –ø—Ä–∞–≤–∏–ª–∞ –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –≤—ã—Ö–æ–¥–Ω—ã—Ö —Å –ø–∞–≥–∏–Ω–∞—Ü–∏–µ–π."""
    # 1. –ó–∞–ø—Ä–æ—Å –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –æ–±—â–µ–≥–æ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ –ø—Ä–∞–≤–∏–ª
    total_result = await db.execute(select(func.count(HolidayRule.id)))
    total_rules = total_result.scalar_one()

    # 2. –ó–∞–ø—Ä–æ—Å –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è "—Å—Ç—Ä–∞–Ω–∏—Ü—ã" –ø—Ä–∞–≤–∏–ª
    rules_result = await db.execute(
        select(HolidayRule).order_by(HolidayRule.created_at.desc()).offset(skip).limit(limit)
    )
    rules_orm = rules_result.scalars().all()

    # 3. –§–æ—Ä–º–∏—Ä—É–µ–º –∏ –≤–æ–∑–≤—Ä–∞—â–∞–µ–º –Ω–æ–≤—ã–π –æ–±—ä–µ–∫—Ç –æ—Ç–≤–µ—Ç–∞
    return HolidayRuleListResponse(
        items=[HolidayRuleOut.from_orm(rule) for rule in rules_orm],
        total=total_rules
    )


@router.delete("/rules/{rule_id}", status_code=204, summary="–£–¥–∞–ª–∏—Ç—å –ø—Ä–∞–≤–∏–ª–æ –∏ —Å–≤—è–∑–∞–Ω–Ω—ã–µ —Å –Ω–∏–º –≤—ã—Ö–æ–¥–Ω—ã–µ")
async def delete_rule(
        rule_id: int,
        db: AsyncSession = Depends(get_db),
        current_user: User = Depends(require_admin)
):
    """–£–¥–∞–ª—è–µ—Ç –ø—Ä–∞–≤–∏–ª–æ. –ë–ª–∞–≥–æ–¥–∞—Ä—è `cascade='all, delete-orphan'`, –≤—Å–µ —Å–æ–∑–¥–∞–Ω–Ω—ã–µ –∏–º –≤—ã—Ö–æ–¥–Ω—ã–µ –±—É–¥—É—Ç —É–¥–∞–ª–µ–Ω—ã –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏."""
    result = await db.execute(select(HolidayRule).filter(HolidayRule.id == rule_id))
    rule = result.scalars().first()
    if not rule:
        raise HTTPException(status_code=404, detail="–ü—Ä–∞–≤–∏–ª–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ.")

    await db.delete(rule)
    await db.commit()
    return None

```


## <a name="RentalAppFASTAPIapiinitmodelspy"></a>`RentalApp_FASTAPI/api/init_models.py`

```python
// path: RentalApp_FASTAPI/api/init_models.py

# –ü—Ä–∏–º–µ—Ä –¥–ª—è api/init_models.py
from api.database import engine, Base
# ‚úÖ –≠—Ç–æ—Ç –∏–º–ø–æ—Ä—Ç —É–∂–µ –≤–∫–ª—é—á–∞–µ—Ç –Ω–∞—à –Ω–æ–≤—ã–π –∫–ª–∞—Å—Å PromoCodeApplicableType
from api.models import user, equipment, reservation, accessory, promo_code

if __name__ == "__main__":
    Base.metadata.create_all(bind=engine)
    print("‚úÖ FastAPI-–º–æ–¥–µ–ª–∏ —É—Å–ø–µ—à–Ω–æ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω—ã")

```


## <a name="RentalAppFASTAPIapimainapipy"></a>`RentalApp_FASTAPI/api/main_api.py`

```python
// path: RentalApp_FASTAPI/api/main_api.py

# api/main_api.py

import secrets
import logging # <--- –î–û–ë–ê–í–¨–¢–ï –≠–¢–û–¢ –ò–ú–ü–û–†–¢

from fastapi import FastAPI, Request, Response, HTTPException, status, APIRouter
from fastapi.middleware.cors import CORSMiddleware
from starlette.middleware.base import BaseHTTPMiddleware
from starlette.datastructures import State

from api.router import router as all_routes

# --- CSRF Protection Imports and Setup ---
from fastapi_csrf_protect import CsrfProtect
from fastapi_csrf_protect.exceptions import CsrfProtectError
from pydantic_settings import BaseSettings, SettingsConfigDict
from pydantic import Field
from fastapi.responses import JSONResponse

# --- Rate Limiting Imports ---
from slowapi import Limiter, _rate_limit_exceeded_handler
from slowapi.util import get_remote_address
from slowapi.errors import RateLimitExceeded

# --- –ù–ê–°–¢–†–û–ô–ö–ê –õ–û–ì–ì–ò–†–û–í–ê–ù–ò–Ø ---
logging.basicConfig(level=logging.INFO)
logger = logging.getLogger(__name__)

# --- CSRF Configuration ---
class CsrfSettings(BaseSettings):
    secret_key: str = Field(..., alias="CSRF_SECRET_KEY")
    model_config = SettingsConfigDict(
        env_file=".env",
        env_file_encoding="utf-8",
        extra="ignore"
    )


@CsrfProtect.load_config
def get_csrf_config():
    try:
        settings = CsrfSettings()
        return settings
    except Exception as e:
        logger.critical(
            "–ö–†–ò–¢–ò–ß–ï–°–ö–ê–Ø –û–®–ò–ë–ö–ê: –ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é CSRF. "
            "–£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –ø–µ—Ä–µ–º–µ–Ω–Ω–∞—è CSRF_SECRET_KEY –∑–∞–¥–∞–Ω–∞ –≤ –≤–∞—à–µ–º .env —Ñ–∞–π–ª–µ!"
        )
        raise e

# --- Rate Limiter Configuration ---
limiter = Limiter(key_func=get_remote_address, default_limits=["200/minute"])

# --- FastAPI App Initialization ---
app = FastAPI(title="Rental System API")

# --- Rate Limiter State and Exception Handler ---
app.state.limiter = limiter
app.add_exception_handler(RateLimitExceeded, _rate_limit_exceeded_handler)

# --- CSRF Exception Handler ---
@app.exception_handler(CsrfProtectError)
def csrf_protect_exception_handler(request: Request, exc: CsrfProtectError):
    return JSONResponse(
        status_code=exc.status_code,
        content={"detail": exc.message}
    )

# --- –ù–û–í–ê–Ø MIDDLEWARE –î–õ–Ø –õ–û–ì–ì–ò–†–û–í–ê–ù–ò–Ø –ó–ê–ü–†–û–°–û–í ---
class LoggingMiddleware(BaseHTTPMiddleware):
    async def dispatch(self, request: Request, call_next):
        logger.info(f"Incoming request: {request.method} {request.url.path}")
        response = await call_next(request)
        return response

# --- Secure Headers Middleware ---
class SecureHeadersMiddleware(BaseHTTPMiddleware):
    async def dispatch(self, request: Request, call_next):
        response: Response = await call_next(request)
        response.headers["X-Content-Type-Options"] = "nosniff"
        response.headers["X-Frame-Options"] = "DENY"
        response.headers["Content-Security-Policy"] = (
            "default-src 'self'; "
            "script-src 'self' 'unsafe-inline'; "
            "style-src 'self' 'unsafe-inline'; "
            "object-src 'none'; "
            "frame-ancestors 'none'; "
            "img-src 'self' data:;"
        )
        response.headers["Referrer-Policy"] = "strict-origin-when-cross-origin"
        response.headers["Permissions-Policy"] = "geolocation=(), microphone=(), camera=(), payment=()"
        return response

# --- Add Middlewares ---
app.add_middleware(LoggingMiddleware) # <--- –î–û–ë–ê–í–¨–¢–ï –≠–¢–£ –°–¢–†–û–ö–£

app.add_middleware(
    CORSMiddleware,
    allow_origins=["http://localhost:5173"],
    allow_credentials=True,
    allow_methods=["*"],
    allow_headers=["*", "X-CSRF-Token"],
)
app.add_middleware(SecureHeadersMiddleware)

app.include_router(all_routes)

```


## <a name="RentalAppFASTAPIapimodelsinitpy"></a>`RentalApp_FASTAPI/api/models/__init__.py`

```python
// path: RentalApp_FASTAPI/api/models/__init__.py

# api/models/__init__.py

# –≠—Ç–æ—Ç —Ñ–∞–π–ª –¥–µ–ª–∞–µ—Ç –≤—Å–µ –º–æ–¥–µ–ª–∏ –≤ —ç—Ç–æ–π –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏ –¥–æ—Å—Ç—É–ø–Ω—ã–º–∏ –∫–∞–∫ —á–∞—Å—Ç—å –ø–∞–∫–µ—Ç–∞ 'models'

from .user import User
from .equipment import Equipment
from .association import Association, association_equipment_association
from .accessory import Accessory, equipment_accessories_association
from .promo_code import PromoCode, PromoCodeApplicableType, promo_code_equipment_association, promo_code_usages
from .discount import DurationDiscount
from .holiday import Holiday, HolidayRule
from .reservation import Reservation, ReservationAccessory, reservation_equipment_association
from .rental import Rental, RentalAccessory, rental_equipment_association
from .payment import Payment
from .balance_history import BalanceHistory

__all__ = [
    "User",
    "Equipment",
    "Association",
    "association_equipment_association",
    "Accessory",
    "equipment_accessories_association",
    "PromoCode",
    "PromoCodeApplicableType",
    "promo_code_equipment_association",
    "promo_code_usages",
    "DurationDiscount",
    "Holiday",
    "HolidayRule",
    "Reservation",
    "ReservationAccessory",
    "reservation_equipment_association",
    "Rental",
    "RentalAccessory",
    "rental_equipment_association",
    "Payment",
    "BalanceHistory",
]

```


## <a name="RentalAppFASTAPIapimodelsaccessorypy"></a>`RentalApp_FASTAPI/api/models/accessory.py`

```python
// path: RentalApp_FASTAPI/api/models/accessory.py

# api/models/accessory.py

from sqlalchemy import Column, Integer, String, Float, Text, Table, ForeignKey
from sqlalchemy.orm import relationship
from api.database import Base

equipment_accessories_association = Table(
    'equipment_accessories', Base.metadata,
    Column('equipment_id', Integer, ForeignKey('equipment.id'), primary_key=True),
    Column('accessory_id', Integer, ForeignKey('accessories.id'), primary_key=True)
)

class Accessory(Base):
    __tablename__ = "accessories"

    id = Column(Integer, primary_key=True, index=True)
    name = Column(String, nullable=False, index=True)
    accessory_type = Column(String, default="–ü—Ä–æ—á–µ–µ", index=True)
    price = Column(Float, default=0.0)
    description = Column(Text, nullable=True)

    equipment_items = relationship(
        "Equipment",
        secondary=equipment_accessories_association,
        back_populates="accessories"
    )

    # --- –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï –ó–î–ï–°–¨ ---
    # –Ø–≤–Ω–æ —É–∫–∞–∑—ã–≤–∞–µ–º SQLAlchemy, –∫–∞–∫ —ç—Ç–∞ –º–æ–¥–µ–ª—å —Å–≤—è–∑–∞–Ω–∞ —Å —Ç–∞–±–ª–∏—Ü–∞–º–∏-–ø–æ—Å—Ä–µ–¥–Ω–∏–∫–∞–º–∏
    reservation_links = relationship("ReservationAccessory", back_populates="accessory")
    rental_links = relationship("RentalAccessory", back_populates="accessory")
    # -------------------------

    def __repr__(self):
        return f"<Accessory(id={self.id}, name='{self.name}')>"

```


## <a name="RentalAppFASTAPIapimodelsassociationpy"></a>`RentalApp_FASTAPI/api/models/association.py`

```python
// path: RentalApp_FASTAPI/api/models/association.py

# api/models/association.py

from sqlalchemy import Column, Integer, String, Text, Table, ForeignKey
from sqlalchemy.orm import relationship
from api.database import Base

association_equipment_association = Table(
    # V-- –í–ê–ñ–ù–û: –ò–º—è —Ç–∞–±–ª–∏—Ü—ã –≤ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö. –î–∞–≤–∞–π—Ç–µ —Å–¥–µ–ª–∞–µ–º –µ–≥–æ –∫–æ–Ω—Å–∏—Å—Ç–µ–Ω—Ç–Ω—ã–º.
    'association_equipment_association', Base.metadata,
    Column('association_id', Integer, ForeignKey('associations.id'), primary_key=True),
    Column('equipment_id', Integer, ForeignKey('equipment.id'), primary_key=True)
)

class Association(Base):
    __tablename__ = "associations"

    id = Column(Integer, primary_key=True, index=True)
    name = Column(String, nullable=False, unique=True, index=True)
    description = Column(Text, nullable=True)
    sort_order = Column(Integer, default=0, nullable=False)

    # –°–≤—è–∑—å "–º–Ω–æ–≥–∏–µ-–∫–æ-–º–Ω–æ–≥–∏–º" —Å –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏–µ–º
    equipment = relationship(
        "Equipment",
        secondary=association_equipment_association,
        # V-- –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï: –¥–æ–ª–∂–Ω–æ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–æ–≤–∞—Ç—å –∏–º–µ–Ω–∏ –≤ Equipment
        back_populates="associations"
    )

    @property
    def equipment_ids(self) -> list[int]:
        """–í–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Å–ø–∏—Å–æ–∫ ID —Å–≤—è–∑–∞–Ω–Ω–æ–≥–æ –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—è."""
        return [item.id for item in self.equipment] if self.equipment else []

    def __repr__(self):
        return f"<Association(id={self.id}, name='{self.name}')>"


```


## <a name="RentalAppFASTAPIapimodelsbalancehistorypy"></a>`RentalApp_FASTAPI/api/models/balance_history.py`

```python
// path: RentalApp_FASTAPI/api/models/balance_history.py

# api/models/balance_history.py

from sqlalchemy import Column, Integer, String, Float, DateTime, ForeignKey, Text
from sqlalchemy.orm import relationship
from api.database import Base
from datetime import datetime, timezone

class BalanceHistory(Base):
    __tablename__ = "balance_history"

    id = Column(Integer, primary_key=True)
    user_id = Column(Integer, ForeignKey("users.id"), nullable=False)
    # +++ –ò–ó–ú–ï–ù–ï–ù–ò–ï: –î–æ–±–∞–≤–ª—è–µ–º –∫–∞—Å–∫–∞–¥–Ω–æ–µ —É–¥–∞–ª–µ–Ω–∏–µ –Ω–∞ —É—Ä–æ–≤–Ω–µ –ë–î +++
    rental_id = Column(Integer, ForeignKey("rentals.id", ondelete="CASCADE"), nullable=True)

    amount = Column(Float, nullable=False, comment="–°—É–º–º–∞ –æ–ø–µ—Ä–∞—Ü–∏–∏. –û—Ç—Ä–∏—Ü–∞—Ç–µ–ª—å–Ω–∞—è –¥–ª—è —Å–ø–∏—Å–∞–Ω–∏—è, –ø–æ–ª–æ–∂–∏—Ç–µ–ª—å–Ω–∞—è –¥–ª—è –Ω–∞—á–∏—Å–ª–µ–Ω–∏—è.")
    operation_type = Column(String, nullable=False, comment="–¢–∏–ø –æ–ø–µ—Ä–∞—Ü–∏–∏ (e.g., rental_debit, early_return_credit)")
    description = Column(Text, nullable=True, comment="–û–ø–∏—Å–∞–Ω–∏–µ –æ–ø–µ—Ä–∞—Ü–∏–∏")

    created_at = Column(DateTime(timezone=True), default=lambda: datetime.now(timezone.utc))

    # –°–≤—è–∑–∏
    user = relationship("User", back_populates="balance_history")
    rental = relationship("Rental", back_populates="balance_history")

    def __repr__(self):
        return f"<BalanceHistory(id={self.id}, user_id={self.user_id}, amount={self.amount})>"

```


## <a name="RentalAppFASTAPIapimodelsdiscountpy"></a>`RentalApp_FASTAPI/api/models/discount.py`

```python
// path: RentalApp_FASTAPI/api/models/discount.py

# api/models/discount.py

from sqlalchemy import Column, Integer
from api.database import Base

class DurationDiscount(Base):
    """
    –ú–æ–¥–µ–ª—å –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è –ø–æ—Ä–æ–≥–æ–≤—ã—Ö –∑–Ω–∞—á–µ–Ω–∏–π —Å–∫–∏–¥–æ–∫ –∑–∞ –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å –∞—Ä–µ–Ω–¥—ã.
    –ù–∞–ø—Ä–∏–º–µ—Ä: –æ—Ç 3 –¥–æ 6 –¥–Ω–µ–π - 10% —Å–∫–∏–¥–∫–∞.
    """
    __tablename__ = "duration_discounts"

    id = Column(Integer, primary_key=True)
    min_days = Column(Integer, unique=True, nullable=False, comment="–ú–∏–Ω–∏–º–∞–ª—å–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –¥–Ω–µ–π –¥–ª—è —Å–∫–∏–¥–∫–∏ (–≤–∫–ª—é—á–∏—Ç–µ–ª—å–Ω–æ)")
    discount_percentage = Column(Integer, nullable=False, comment="–ü—Ä–æ—Ü–µ–Ω—Ç —Å–∫–∏–¥–∫–∏")

```


## <a name="RentalAppFASTAPIapimodelsequipmentpy"></a>`RentalApp_FASTAPI/api/models/equipment.py`

```python
// path: RentalApp_FASTAPI/api/models/equipment.py

# api/models/equipment.py

from sqlalchemy import Column, Integer, String, Float, Date, Text, JSON
from sqlalchemy.orm import relationship
from api.database import Base
from api.models.accessory import equipment_accessories_association
from api.models.reservation import reservation_equipment_association
from api.models.promo_code import promo_code_equipment_association
from api.models.association import association_equipment_association

class Equipment(Base):
    __tablename__ = "equipment"

    id = Column(Integer, primary_key=True)
    equipment_type = Column(String, nullable=False)
    brand = Column(String, nullable=False)
    name = Column(String, nullable=False)
    serial_number = Column(String, unique=True)
    condition = Column(String, default="–í–µ–ª–∏–∫–æ–ª–µ–ø–Ω–æ")
    daily_rate = Column(Float, default=0.0)
    notes = Column(String)

    # ‚úÖ –ò–ó–ú–ï–ù–ï–ù–ò–ï: –¢–∏–ø –ø–æ–ª—è –∏–∑–º–µ–Ω–µ–Ω —Å DateTime –Ω–∞ Date
    last_maintenance = Column(Date)

    description = Column(Text)
    image_url = Column(String, nullable=True)
    image_urls = Column(JSON, nullable=True)
    short_description = Column(String, nullable=True)

    accessories = relationship(
        "Accessory",
        secondary=equipment_accessories_association,
        back_populates="equipment_items"
    )

    reservations = relationship(
        "Reservation",
        secondary=reservation_equipment_association,
        back_populates="equipment"
    )

    applicable_promo_codes = relationship(
        "PromoCode",
        secondary=promo_code_equipment_association,
        back_populates="applicable_equipment"
    )

    # –°–≤—è–∑—å –º–Ω–æ–≥–∏–µ-–∫–æ-–º–Ω–æ–≥–∏–º —Å Association
    associations = relationship(
        "Association",
        secondary=association_equipment_association,
        back_populates="equipment"
    )

```


## <a name="RentalAppFASTAPIapimodelsholidaypy"></a>`RentalApp_FASTAPI/api/models/holiday.py`

```python
// path: RentalApp_FASTAPI/api/models/holiday.py

# api/models/holiday.py

from sqlalchemy import Column, Integer, String, DateTime, Date, ForeignKey, JSON
from sqlalchemy.orm import relationship
from api.database import Base
from datetime import datetime, timezone

# +++ –ù–ê–ß–ê–õ–û: –ù–û–í–ê–Ø –ú–û–î–ï–õ–¨ –î–õ–Ø –ü–†–ê–í–ò–õ +++
class HolidayRule(Base):
    """–ú–æ–¥–µ–ª—å –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è –ø—Ä–∞–≤–∏–ª –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ —Å–æ–∑–¥–∞–Ω–∏—è –≤—ã—Ö–æ–¥–Ω—ã—Ö."""
    __tablename__ = "holiday_rules"

    id = Column(Integer, primary_key=True)
    rule_type = Column(String, nullable=False, comment="–¢–∏–ø –ø—Ä–∞–≤–∏–ª–∞, –Ω–∞–ø—Ä–∏–º–µ—Ä 'weekly' –∏–ª–∏ 'public_import'")
    parameters = Column(JSON, nullable=False, comment="–ü–∞—Ä–∞–º–µ—Ç—Ä—ã –ø—Ä–∞–≤–∏–ª–∞, –Ω–∞–ø—Ä–∏–º–µ—Ä {'day_of_week': 6} –¥–ª—è –≤–æ—Å–∫—Ä–µ—Å–µ–Ω—å—è")
    description = Column(String, nullable=False, comment="–û–ø–∏—Å–∞–Ω–∏–µ –ø—Ä–∞–≤–∏–ª–∞ –¥–ª—è –∞–¥–º–∏–Ω–∞")
    created_at = Column(DateTime(timezone=True), default=lambda: datetime.now(timezone.utc))
    created_by_id = Column(Integer, ForeignKey("users.id"), nullable=False)

    creator = relationship("User")
    # –°–≤—è–∑—å –¥–ª—è –∫–∞—Å–∫–∞–¥–Ω–æ–≥–æ —É–¥–∞–ª–µ–Ω–∏—è –≤—Å–µ—Ö –≤—ã—Ö–æ–¥–Ω—ã—Ö, —Å–æ–∑–¥–∞–Ω–Ω—ã—Ö —ç—Ç–∏–º –ø—Ä–∞–≤–∏–ª–æ–º
    holidays = relationship("Holiday", back_populates="rule", cascade="all, delete-orphan")
# +++ –ö–û–ù–ï–¶: –ù–û–í–ê–Ø –ú–û–î–ï–õ–¨ –î–õ–Ø –ü–†–ê–í–ò–õ +++


class Holiday(Base):
    __tablename__ = "holidays"

    date = Column(Date, primary_key=True, index=True, comment="–î–∞—Ç–∞ –≤—ã—Ö–æ–¥–Ω–æ–≥–æ –¥–Ω—è")
    description = Column(String, nullable=True, comment="–ù–∞–∑–≤–∞–Ω–∏–µ (–Ω–∞–ø—Ä–∏–º–µ—Ä, –ù–æ–≤—ã–π –≥–æ–¥)")
    created_at = Column(DateTime(timezone=True), default=lambda: datetime.now(timezone.utc))
    created_by_id = Column(Integer, ForeignKey("users.id"), nullable=False)

    # +++ –ù–ê–ß–ê–õ–û: –ò–ó–ú–ï–ù–ï–ù–ò–Ø –í –ú–û–î–ï–õ–ò HOLIDAY +++
    rule_id = Column(Integer, ForeignKey("holiday_rules.id"), nullable=True, comment="ID –ø—Ä–∞–≤–∏–ª–∞, –∫–æ—Ç–æ—Ä—ã–º —Å–æ–∑–¥–∞–Ω —ç—Ç–æ—Ç –≤—ã—Ö–æ–¥–Ω–æ–π")
    rule = relationship("HolidayRule", back_populates="holidays")
    # +++ –ö–û–ù–ï–¶: –ò–ó–ú–ï–ù–ï–ù–ò–Ø –í –ú–û–î–ï–õ–ò HOLIDAY +++

    creator = relationship("User")

    def __repr__(self):
        return f"<Holiday(date='{self.date.strftime('%Y-%m-%d')}', description='{self.description}')>"

```


## <a name="RentalAppFASTAPIapimodelspaymentpy"></a>`RentalApp_FASTAPI/api/models/payment.py`

```python
// path: RentalApp_FASTAPI/api/models/payment.py

# api/models/payment.py

from sqlalchemy import (Column, Integer, String, Float, DateTime,
                        ForeignKey, Text)
from sqlalchemy.orm import relationship
from api.database import Base
from datetime import datetime, timezone

class Payment(Base):
    __tablename__ = "payments"

    id = Column(Integer, primary_key=True)
    user_id = Column(Integer, ForeignKey("users.id"), nullable=False)
    # +++ –ò–ó–ú–ï–ù–ï–ù–ò–ï: –î–æ–±–∞–≤–ª—è–µ–º –∫–∞—Å–∫–∞–¥–Ω–æ–µ —É–¥–∞–ª–µ–Ω–∏–µ –Ω–∞ —É—Ä–æ–≤–Ω–µ –ë–î +++
    rental_id = Column(Integer, ForeignKey("rentals.id", ondelete="CASCADE"), nullable=True)
    amount = Column(Float, nullable=False)

    payment_date = Column(DateTime(timezone=True), default=lambda: datetime.now(timezone.utc))

    payment_method = Column(String)
    transaction_type = Column(String, nullable=False)  # e.g., 'rental_payment', 'deposit', 'refund'
    description = Column(Text, nullable=True)

    user = relationship("User")
    rental = relationship("Rental", back_populates="payments")

```


## <a name="RentalAppFASTAPIapimodelspromocodepy"></a>`RentalApp_FASTAPI/api/models/promo_code.py`

```python
// path: RentalApp_FASTAPI/api/models/promo_code.py

# api/models/promo_code.py

from sqlalchemy import (Column, Integer, String, Float, DateTime, Boolean,
                        ForeignKey, Table, Text)
from sqlalchemy.orm import relationship
from api.database import Base
# ‚úÖ –ò–º–ø–æ—Ä—Ç–∏—Ä—É–µ–º timezone
from datetime import datetime, timezone

# –ü—Ä–æ–º–µ–∂—É—Ç–æ—á–Ω–∞—è —Ç–∞–±–ª–∏—Ü–∞ –¥–ª—è –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–π –ø—Ä–æ–º–æ–∫–æ–¥–æ–≤ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º–∏
promo_code_usages = Table(
    'promo_code_usages', Base.metadata,
    Column('user_id', Integer, ForeignKey('users.id'), primary_key=True),
    Column('promo_code_id', Integer, ForeignKey('promo_codes.id'), primary_key=True),
    # ‚úÖ –ò–ó–ú–ï–ù–ï–ù–ò–ï: –î–æ–±–∞–≤–ª—è–µ–º timezone=True
    Column('used_at', DateTime(timezone=True), default=lambda: datetime.now(timezone.utc))
)

# –ê—Å—Å–æ—Ü–∏–∞—Ç–∏–≤–Ω–∞—è —Ç–∞–±–ª–∏—Ü–∞ –¥–ª—è —Å–≤—è–∑–∏ –ø—Ä–æ–º–æ–∫–æ–¥–∞ —Å ID –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—è
promo_code_equipment_association = Table(
    'promo_code_equipment', Base.metadata,
    Column('promo_code_id', Integer, ForeignKey('promo_codes.id'), primary_key=True),
    Column('equipment_id', Integer, ForeignKey('equipment.id'), primary_key=True)
)

class PromoCode(Base):
    """
    –ú–æ–¥–µ–ª—å –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è –ø—Ä–æ–º–æ–∫–æ–¥–æ–≤ –∏ –∏—Ö —É—Å–ª–æ–≤–∏–π.
    """
    __tablename__ = "promo_codes"

    id = Column(Integer, primary_key=True, index=True)
    code = Column(String, unique=True, index=True, nullable=False)
    description = Column(Text, nullable=True, comment="–ö—Ä–∞—Ç–∫–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ –¥–ª—è –º–µ–Ω–µ–¥–∂–µ—Ä–æ–≤")
    discount_percentage = Column(Float, nullable=False)

    # --- –°—Ç–∞—Ç—É—Å—ã –∏ —Å—Ä–æ–∫–∏ ---
    is_active = Column(Boolean, default=True)
    # ‚úÖ –ò–ó–ú–ï–ù–ï–ù–ò–ï: –î–æ–±–∞–≤–ª—è–µ–º timezone=True
    valid_from = Column(DateTime(timezone=True), nullable=True, comment="–î–∞—Ç–∞ –Ω–∞—á–∞–ª–∞ –¥–µ–π—Å—Ç–≤–∏—è")
    # ‚úÖ –ò–ó–ú–ï–ù–ï–ù–ò–ï: –î–æ–±–∞–≤–ª—è–µ–º timezone=True
    expires_at = Column(DateTime(timezone=True), nullable=True, comment="–î–∞—Ç–∞ –∏—Å—Ç–µ—á–µ–Ω–∏—è —Å—Ä–æ–∫–∞")

    # --- –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è ---
    max_uses = Column(Integer, nullable=True, comment="–û–±—â–∏–π –ª–∏–º–∏—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–π")
    times_used = Column(Integer, default=0, nullable=False)
    max_uses_per_user = Column(Integer, nullable=True, comment="–õ–∏–º–∏—Ç –Ω–∞ –æ–¥–Ω–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è")

    # --- –£—Å–ª–æ–≤–∏—è –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è ---
    min_order_amount = Column(Float, nullable=True, comment="–ú–∏–Ω–∏–º–∞–ª—å–Ω–∞—è —Å—É–º–º–∞ –∑–∞–∫–∞–∑–∞ –¥–ª—è –∞–∫—Ç–∏–≤–∞—Ü–∏–∏")
    specific_to_user_id = Column(Integer, ForeignKey("users.id"), nullable=True, comment="–ï—Å–ª–∏ –∫–æ–¥ –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã–π")

    # --- –ú–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ ---
    # ‚úÖ –ò–ó–ú–ï–ù–ï–ù–ò–ï: –î–æ–±–∞–≤–ª—è–µ–º timezone=True
    created_at = Column(DateTime(timezone=True), default=lambda: datetime.now(timezone.utc))
    created_by_id = Column(Integer, ForeignKey("users.id"))

    # --- –°–≤—è–∑–∏ ---
    creator = relationship("User", foreign_keys=[created_by_id])
    specific_user = relationship("User", foreign_keys=[specific_to_user_id])

    used_by_users = relationship(
        "User",
        secondary=promo_code_usages,
        back_populates="used_promo_codes"
    )

    applicable_equipment = relationship(
        "Equipment",
        secondary=promo_code_equipment_association,
        back_populates="applicable_promo_codes",
        lazy="joined"
    )

    applicable_types = relationship(
        "PromoCodeApplicableType",
        back_populates="promo_code",
        cascade="all, delete-orphan",
        lazy="joined"
    )

    # --- –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–µ —Å–≤–æ–π—Å—Ç–≤–∞ ---
    @property
    def applicable_to_equipment_ids(self) -> list[int]:
        return [item.id for item in self.applicable_equipment] if self.applicable_equipment else []

    @property
    def applicable_to_equipment_types(self) -> list[str]:
        return [item.type_name for item in self.applicable_types] if self.applicable_types else []

    def __repr__(self):
        return f"<PromoCode(code='{self.code}', discount={self.discount_percentage}%)>"


# –ú–æ–¥–µ–ª—å-–ø–æ—Å—Ä–µ–¥–Ω–∏–∫ –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è —Ç–∏–ø–æ–≤ –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—è
class PromoCodeApplicableType(Base):
    __tablename__ = 'promo_code_applicable_types'
    promo_code_id = Column(Integer, ForeignKey('promo_codes.id'), primary_key=True)
    type_name = Column(String, primary_key=True)

    promo_code = relationship("PromoCode", back_populates="applicable_types")

```


## <a name="RentalAppFASTAPIapimodelsrentalpy"></a>`RentalApp_FASTAPI/api/models/rental.py`

```python
// path: RentalApp_FASTAPI/api/models/rental.py

# api/models/rental.py

from sqlalchemy import (Column, Integer, DateTime, ForeignKey, Float,
                        String, Text, Table, Boolean, Date)
from sqlalchemy.orm import relationship
from api.database import Base
from datetime import datetime, timezone

class RentalAccessory(Base):
    __tablename__ = 'rental_accessories'
    rental_id = Column(Integer, ForeignKey('rentals.id', ondelete="CASCADE"), primary_key=True)
    equipment_id = Column(Integer, ForeignKey('equipment.id'), primary_key=True)
    accessory_id = Column(Integer, ForeignKey('accessories.id'), primary_key=True)

    accessory = relationship("Accessory", back_populates="rental_links")
    rental = relationship("Rental", back_populates="accessory_links")

rental_equipment_association = Table('rental_equipment', Base.metadata,
                                     Column('rental_id', Integer, ForeignKey('rentals.id', ondelete="CASCADE"), primary_key=True),
                                     Column('equipment_id', Integer, ForeignKey('equipment.id'), primary_key=True)
                                     )

class Rental(Base):
    __tablename__ = "rentals"

    id = Column(Integer, primary_key=True)
    user_id = Column(Integer, ForeignKey("users.id"), nullable=False)
    created_by_id = Column(Integer, ForeignKey("users.id"), nullable=False)
    reservation_id = Column(Integer, ForeignKey("reservations.id"), nullable=True, unique=True)
    start_date = Column(Date, nullable=False)
    end_date = Column(Date, nullable=False)
    actual_return_date = Column(Date, nullable=True)
    status = Column(String, default="active", nullable=False, index=True)
    total_cost = Column(Float, nullable=False, default=0.0)
    discount_amount = Column(Float, nullable=False, default=0.0)
    promo_code = Column(String, nullable=True)
    final_cost = Column(Float, nullable=True)
    deposit_amount = Column(Float, default=0.0)
    prepayment_amount = Column(Float, nullable=False, default=0.0)  # –°—É–º–º–∞ –ø—Ä–µ–¥–æ–ø–ª–∞—Ç—ã, –≤–Ω–µ—Å–µ–Ω–Ω–∞—è –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –∞—Ä–µ–Ω–¥—ã
    notes_on_issue = Column(Text, nullable=True)
    notes_on_return = Column(Text, nullable=True)
    created_at = Column(DateTime(timezone=True), default=lambda: datetime.now(timezone.utc))
    updated_at = Column(DateTime(timezone=True), default=lambda: datetime.now(timezone.utc), onupdate=lambda: datetime.now(timezone.utc))

    def __init__(self, reservation_accessories=None, **kwargs):
        """
        –ö–æ–Ω—Å—Ç—Ä—É–∫—Ç–æ—Ä Rental —Å –ø–æ–¥–¥–µ—Ä–∂–∫–æ–π –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è –∞–∫—Å–µ—Å—Å—É–∞—Ä–æ–≤ –∏–∑ —Ä–µ–∑–µ—Ä–≤–∞.
        
        Args:
            reservation_accessories: –°–ø–∏—Å–æ–∫ ReservationAccessory –æ–±—ä–µ–∫—Ç–æ–≤ –¥–ª—è –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è
            **kwargs: –û—Å—Ç–∞–ª—å–Ω—ã–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è Rental
        """
        super().__init__(**kwargs)
        if reservation_accessories:
            self.copy_accessories_from_reservation(reservation_accessories)

    user = relationship("User", foreign_keys=[user_id], back_populates="rentals")
    created_by = relationship("User", foreign_keys=[created_by_id])

    # --- –ù–ê–ß–ê–õ–û –ò–°–ü–†–ê–í–õ–ï–ù–ò–ô ---
    # –£–±–∏—Ä–∞–µ–º —É–ø—Ä–∞–≤–ª—è—é—â–∏–µ –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏ `cascade` –∏ `single_parent` —Å–æ —Å—Ç–æ—Ä–æ–Ω—ã "–ø–æ—Ç–æ–º–∫–∞".
    # –¢–µ–ø–µ—Ä—å —ç—Ç–∞ —Å–≤—è–∑—å —è–≤–ª—è–µ—Ç—Å—è –ø—Ä–æ—Å—Ç–æ –æ–±—Ä–∞—Ç–Ω–æ–π —Å—Å—ã–ª–∫–æ–π.
    reservation = relationship("Reservation", back_populates="rental")
    # --- –ö–û–ù–ï–¶ –ò–°–ü–†–ê–í–õ–ï–ù–ò–ô ---

    equipment = relationship("Equipment", secondary=rental_equipment_association)
    balance_history = relationship("BalanceHistory", back_populates="rental", cascade="all, delete-orphan")
    payments = relationship("Payment", back_populates="rental", cascade="all, delete-orphan")
    accessory_links = relationship(
        "RentalAccessory",
        back_populates="rental",
        cascade="all, delete-orphan",
        lazy="joined"
    )

    def copy_accessories_from_reservation(self, reservation_accessories):
        """–ö–æ–ø–∏—Ä—É–µ—Ç –∞–∫—Å–µ—Å—Å—É–∞—Ä—ã –∏–∑ —Ä–µ–∑–µ—Ä–≤–∞ –≤ –∞—Ä–µ–Ω–¥—É"""
        if reservation_accessories:
            self.accessory_links = [
                RentalAccessory(
                    equipment_id=link.equipment_id,
                    accessory_id=link.accessory_id
                )
                for link in reservation_accessories
            ]

    def __repr__(self):
        return f"<Rental(id={self.id}, user_id={self.user_id}, status='{self.status}')>"

```


## <a name="RentalAppFASTAPIapimodelsreservationpy"></a>`RentalApp_FASTAPI/api/models/reservation.py`

```python
// path: RentalApp_FASTAPI/api/models/reservation.py

# api/models/reservation.py

from sqlalchemy import Column, Integer, DateTime, ForeignKey, Table, Float, String, Date
from sqlalchemy.orm import relationship
from api.database import Base
from typing import Optional, Dict, List
from datetime import datetime, timezone

reservation_equipment_association = Table('reservation_equipment', Base.metadata,
                                          Column('reservation_id', Integer, ForeignKey('reservations.id'), primary_key=True),
                                          Column('equipment_id', Integer, ForeignKey('equipment.id'), primary_key=True)
                                          )

class ReservationAccessory(Base):
    __tablename__ = 'reservation_accessories'
    reservation_id = Column(Integer, ForeignKey('reservations.id'), primary_key=True)
    equipment_id = Column(Integer, ForeignKey('equipment.id'), primary_key=True)
    accessory_id = Column(Integer, ForeignKey('accessories.id'), primary_key=True)

    # --- –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï –ó–î–ï–°–¨ ---
    accessory = relationship("Accessory", back_populates="reservation_links")
    reservation = relationship("Reservation", back_populates="accessory_links")
    # -------------------------

class Reservation(Base):
    __tablename__ = "reservations"

    id = Column(Integer, primary_key=True)
    user_id = Column(Integer, ForeignKey("users.id"), nullable=False)
    start_date = Column(Date, nullable=False)
    end_date = Column(Date, nullable=False)
    status = Column(String, default='active', nullable=False, index=True)
    promo_code_id = Column(Integer, ForeignKey("promo_codes.id"), nullable=True)
    total_cost = Column(Float, nullable=False, default=0.0)
    discount_amount = Column(Float, nullable=False, default=0.0)
    created_at = Column(DateTime(timezone=True), default=lambda: datetime.now(timezone.utc))

    user = relationship("User", back_populates="reservations")
    applied_promo_code = relationship("PromoCode")
    equipment = relationship(
        "Equipment",
        secondary=reservation_equipment_association,
        back_populates="reservations",
        lazy="joined"
    )
    # --- –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï –ó–î–ï–°–¨ ---
    accessory_links = relationship(
        "ReservationAccessory",
        back_populates="reservation",
        cascade="all, delete-orphan",
        lazy="joined"
    )
    # -------------------------
    rental = relationship("Rental", back_populates="reservation", uselist=False, cascade="all, delete-orphan", single_parent=True)

    @property
    def equipment_ids(self) -> list[int]:
        return [item.id for item in self.equipment] if self.equipment else []

    @property
    def selected_accessories(self) -> Dict[int, List[int]]:
        grouped_accessories: Dict[int, List[int]] = {}
        if not self.accessory_links:
            return {}
        for link in self.accessory_links:
            if link.equipment_id not in grouped_accessories:
                grouped_accessories[link.equipment_id] = []
            grouped_accessories[link.equipment_id].append(link.accessory_id)
        return grouped_accessories

    @property
    def promo_code(self) -> Optional[str]:
        return self.applied_promo_code.code if self.applied_promo_code else None

```


## <a name="RentalAppFASTAPIapimodelsuserpy"></a>`RentalApp_FASTAPI/api/models/user.py`

```python
// path: RentalApp_FASTAPI/api/models/user.py

# api/models/user.py

from sqlalchemy import (Column, Integer, String, Boolean, DateTime,
                        Float, Text)
from sqlalchemy.orm import relationship
from api.database import Base
from datetime import datetime, timezone

class User(Base):
    __tablename__ = "users"

    id = Column(Integer, primary_key=True)
    full_name = Column(String, nullable=False)
    email = Column(String, unique=True, index=True, nullable=False)
    hashed_password = Column(String)
    role = Column(String, default="user") # user, manager, admin

    created_at = Column(DateTime(timezone=True), default=lambda: datetime.now(timezone.utc))

    is_active = Column(Boolean, default=True)
    phone = Column(String)
    status = Column(String, default="–ê–∫—Ç–∏–≤–Ω—ã–π")
    balance = Column(Float, default=0.0)
    notes = Column(Text)

    privacy_policy_accepted = Column(Boolean, default=False)
    terms_accepted = Column(Boolean, default=False)
    email_verified = Column(Boolean, default=False)

    # –°—É—â–µ—Å—Ç–≤—É—é—â–∏–µ —Å–≤—è–∑–∏
    reservations = relationship("Reservation", back_populates="user")
    used_promo_codes = relationship(
        "PromoCode",
        secondary="promo_code_usages",
        back_populates="used_by_users"
    )

    # +++ –ù–û–í–´–ï –°–í–Ø–ó–ò +++
    rentals = relationship("Rental", foreign_keys="[Rental.user_id]", back_populates="user", cascade="all, delete-orphan")
    balance_history = relationship("BalanceHistory", back_populates="user", cascade="all, delete-orphan")

```


## <a name="RentalAppFASTAPIapipermissionspy"></a>`RentalApp_FASTAPI/api/permissions.py`

```python
// path: RentalApp_FASTAPI/api/permissions.py

# api/permissions.py
from fastapi import Depends, HTTPException
from api.deps import get_current_user
from api.models.user import User

# –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç —Ä–æ–ª–µ–π: user < manager < admin
ROLE_PRIORITY = {"user": 0, "manager": 1, "admin": 2}

def require_user(user: User = Depends(get_current_user)):
    # –õ—é–±–æ–π –∑–∞–ª–æ–≥–∏–Ω–µ–Ω–Ω—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å
    if not user.is_active:
        raise HTTPException(status_code=403, detail="–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ–∞–∫—Ç–∏–≤–µ–Ω")
    return user

def require_manager(user: User = Depends(get_current_user)):
    # –ú–µ–Ω–µ–¥–∂–µ—Ä –∏ –≤—ã—à–µ
    if ROLE_PRIORITY.get(user.role, 0) < ROLE_PRIORITY["manager"]:
        raise HTTPException(status_code=403, detail="–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –ø—Ä–∞–≤ (—Ç—Ä–µ–±—É–µ—Ç—Å—è manager –∏–ª–∏ admin)")
    return user

def require_admin(user: User = Depends(get_current_user)):
    # –¢–æ–ª—å–∫–æ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä
    if user.role != "admin":
        raise HTTPException(status_code=403, detail="–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –ø—Ä–∞–≤ (—Ç—Ä–µ–±—É–µ—Ç—Å—è admin)")
    return user


```


## <a name="RentalAppFASTAPIapipromocodeapipy"></a>`RentalApp_FASTAPI/api/promo_code_api.py`

```python
// path: RentalApp_FASTAPI/api/promo_code_api.py

# api/promo_code_api.py

from fastapi import APIRouter, Depends, HTTPException, status, Query
from sqlalchemy.ext.asyncio import AsyncSession
from sqlalchemy import select, func
from sqlalchemy.orm import selectinload
from typing import List

from api.deps import get_db
from api.permissions import require_manager
from api.services.auth_service import get_user_by_token
from api.models.user import User
from shared.schemas.promo_code_schema import (
    PromoCodeCreate, PromoCodeUpdate, PromoCodeOut,
    PromoCodeValidateRequest, PromoCodeValidateResponse,
    PromoCodeListResponse
)
from fastapi.security import OAuth2PasswordBearer
from fastapi_csrf_protect import CsrfProtect
from api.services.promo_code import PromoCodeManager, PromoCodeBusinessLogic

router = APIRouter(prefix="/promocodes", tags=["–ü—Ä–æ–º–æ–∫–æ–¥—ã"])
optional_oauth2_scheme = OAuth2PasswordBearer(tokenUrl="/auth/token", auto_error=False)


@router.post("/", response_model=PromoCodeOut, status_code=status.HTTP_201_CREATED)
async def create_promo_code(
        promo_in: PromoCodeCreate,
        db: AsyncSession = Depends(get_db),
        current_user: User = Depends(require_manager),
        _csrf_protect: CsrfProtect = Depends()
):
    """
    –°–æ–∑–¥–∞–µ—Ç –Ω–æ–≤—ã–π –ø—Ä–æ–º–æ–∫–æ–¥. (–ú–µ–Ω–µ–¥–∂–µ—Ä—ã <= 20%, –ê–¥–º–∏–Ω—ã <= 50%)
    """
    try:
        manager = PromoCodeManager(db)
        new_promo_code = await manager.create_promo_code(promo_in, current_user)
        return PromoCodeOut.from_orm(new_promo_code)
    except HTTPException:
        raise
    except Exception as e:
        raise HTTPException(status_code=status.HTTP_500_INTERNAL_SERVER_ERROR, detail=str(e))


@router.get("/", response_model=PromoCodeListResponse)
async def get_all_promo_codes(
        db: AsyncSession = Depends(get_db),
        _current_user: User = Depends(require_manager),
        skip: int = Query(0, ge=0, description="–°–∫–æ–ª—å–∫–æ –∑–∞–ø–∏—Å–µ–π –ø—Ä–æ–ø—É—Å—Ç–∏—Ç—å"),
        limit: int = Query(10, ge=1, le=100, description="–ú–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∑–∞–ø–∏—Å–µ–π –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–µ")
):
    """–ü–æ–ª—É—á–∏—Ç—å —Å–ø–∏—Å–æ–∫ –≤—Å–µ—Ö –ø—Ä–æ–º–æ–∫–æ–¥–æ–≤ —Å –ø–∞–≥–∏–Ω–∞—Ü–∏–µ–π (—Ç–æ–ª—å–∫–æ –¥–ª—è –º–µ–Ω–µ–¥–∂–µ—Ä–æ–≤/–∞–¥–º–∏–Ω–æ–≤)"""
    try:
        manager = PromoCodeManager(db)
        promo_codes = await manager.get_all_promo_codes()
        
        # –ü—Ä–∏–º–µ–Ω—è–µ–º –ø–∞–≥–∏–Ω–∞—Ü–∏—é –∫ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—É
        total_promo_codes = len(promo_codes)
        paginated_promo_codes = promo_codes[skip:skip + limit]
        
        return PromoCodeListResponse(
            items=[PromoCodeOut.from_orm(pc) for pc in paginated_promo_codes],
            total=total_promo_codes
        )
    except Exception as e:
        raise HTTPException(status_code=status.HTTP_500_INTERNAL_SERVER_ERROR, detail=str(e))


@router.get("/generate/new-code", response_model=dict)
async def generate_promo_code(
        db: AsyncSession = Depends(get_db),
        _current_user: User = Depends(require_manager)
):
    """–ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç —É–Ω–∏–∫–∞–ª—å–Ω—ã–π –∫–æ–¥ –ø—Ä–æ–º–æ–∫–æ–¥–∞"""
    try:
        manager = PromoCodeManager(db)
        generated_code = await manager.generate_unique_code()
        return {"generated_code": generated_code}
    except Exception as e:
        raise HTTPException(status_code=status.HTTP_500_INTERNAL_SERVER_ERROR, detail=str(e))


@router.put("/{promo_code_id}", response_model=PromoCodeOut)
async def update_promo_code(
        promo_code_id: int,
        promo_in: PromoCodeUpdate,
        db: AsyncSession = Depends(get_db),
        _current_user: User = Depends(require_manager),
        _csrf_protect: CsrfProtect = Depends()
):
    """–û–±–Ω–æ–≤–ª—è–µ—Ç —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π –ø—Ä–æ–º–æ–∫–æ–¥ (—Ç–æ–ª—å–∫–æ –¥–ª—è –º–µ–Ω–µ–¥–∂–µ—Ä–æ–≤/–∞–¥–º–∏–Ω–æ–≤)."""
    try:
        manager = PromoCodeManager(db)
        updated_promo_code = await manager.update_promo_code(promo_code_id, promo_in)
        return PromoCodeOut.from_orm(updated_promo_code)
    except HTTPException:
        raise
    except Exception as e:
        raise HTTPException(status_code=status.HTTP_500_INTERNAL_SERVER_ERROR, detail=str(e))


@router.delete("/{promo_code_id}", status_code=status.HTTP_204_NO_CONTENT)
async def delete_promo_code(
        promo_code_id: int,
        db: AsyncSession = Depends(get_db),
        _current_user: User = Depends(require_manager),
        _csrf_protect: CsrfProtect = Depends()
):
    """–£–¥–∞–ª—è–µ—Ç –ø—Ä–æ–º–æ–∫–æ–¥"""
    try:
        manager = PromoCodeManager(db)
        await manager.delete_promo_code(promo_code_id)
        return None
    except HTTPException:
        raise
    except Exception as e:
        raise HTTPException(status_code=status.HTTP_500_INTERNAL_SERVER_ERROR, detail=str(e))


@router.post("/validate", response_model=PromoCodeValidateResponse)
async def validate_promo_code_endpoint(
        request: PromoCodeValidateRequest,
        db: AsyncSession = Depends(get_db),
        token: str = Depends(optional_oauth2_scheme)
):
    """
    –ü—Ä–æ–≤–µ—Ä—è–µ—Ç –≤–∞–ª–∏–¥–Ω–æ—Å—Ç—å –ø—Ä–æ–º–æ–∫–æ–¥–∞ —Å —É—á–µ—Ç–æ–º –≤—Å–µ—Ö —É—Å–ª–æ–≤–∏–π.
    """
    try:
        current_user = await get_user_by_token(db, token) if token else None
        business_logic = PromoCodeBusinessLogic(db)
        
        promo_code = await business_logic.validate_and_get_promo_code(
            code=request.code,
            order_amount=request.order_amount,
            equipment_ids=request.equipment_ids,
            user=current_user
        )
        
        return await business_logic.create_validation_response(promo_code)
    except HTTPException:
        raise
    except Exception as e:
        raise HTTPException(status_code=status.HTTP_500_INTERNAL_SERVER_ERROR, detail=str(e))

```


## <a name="RentalAppFASTAPIapireservationapipy"></a>`RentalApp_FASTAPI/api/reservation_api.py`

```python
// path: RentalApp_FASTAPI/api/reservation_api.py

# api/reservation_api.py

from fastapi import APIRouter, Depends, HTTPException, Query
from sqlalchemy.ext.asyncio import AsyncSession
from typing import List, Optional

from api.services.order.order_lifecycle_service import OrderLifecycleService
from api.services.reservation_query_service import ReservationQueryService
from shared.schemas.reservation_schema import (
    ReservationCreateRequest, ReservationUpdateRequest, ReservationResponse,
    ReservationItem, ReservationListResponse, PriceCalculationRequest, PriceCalculationResponse
)
from api.permissions import require_user
from api.models.user import User
from api.models.promo_code import PromoCode
from api.deps import get_db, get_order_lifecycle_service, get_reservation_query_service
from fastapi_csrf_protect import CsrfProtect

from api.services.financial_service import FinancialService
from api.services.promo_code_service import validate_promo_code_for_use
from api.services.discount_service import get_duration_discount_percentage


router = APIRouter(prefix="/reservations", tags=["–†–µ–∑–µ—Ä–≤—ã (–¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π)"])

@router.post("/", response_model=ReservationResponse)
async def create_reservation(
        request: ReservationCreateRequest,
        current_user: User = Depends(require_user),
        csrf_protect: CsrfProtect = Depends(),
        service: OrderLifecycleService = Depends(get_order_lifecycle_service)
):
    """–°–æ–∑–¥–∞—Ç—å —Ä–µ–∑–µ—Ä–≤ –¥–ª—è —Ç–µ–∫—É—â–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è."""
    new_reservation = await service.create_user_reservation(request, current_user)
    return ReservationResponse(reservation_id=new_reservation.id, message="–†–µ–∑–µ—Ä–≤ —É—Å–ø–µ—à–Ω–æ —Å–æ–∑–¥–∞–Ω")

@router.get("/", response_model=ReservationListResponse)
async def get_user_reservations(
        current_user: User = Depends(require_user),
        query_service: ReservationQueryService = Depends(get_reservation_query_service),
        status: Optional[str] = Query(None, description="–§–∏–ª—å—Ç—Ä –ø–æ —Å—Ç–∞—Ç—É—Å—É: active, completed, overdue"),
        search: Optional[str] = Query(None, description="–ü–æ–∏—Å–∫ –ø–æ –Ω–∞–∑–≤–∞–Ω–∏—é, –±—Ä–µ–Ω–¥—É –∏–ª–∏ —Ç–∏–ø—É –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—è"),
        sort: Optional[str] = Query(None, description="–°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞: id_desc, id_asc, start_date_desc, start_date_asc, end_date_desc, end_date_asc, count_desc, count_asc"),
        skip: int = Query(0, ge=0, description="–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –∑–∞–ø–∏—Å–µ–π –¥–ª—è –ø—Ä–æ–ø—É—Å–∫–∞"),
        limit: int = Query(100, ge=1, le=100, description="–ú–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∑–∞–ø–∏—Å–µ–π –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–µ")
):
    """–ü–æ–ª—É—á–∏—Ç—å –æ—Ç—Ñ–∏–ª—å—Ç—Ä–æ–≤–∞–Ω–Ω—ã–π –∏ –ø–∞–≥–∏–Ω–∏—Ä–æ–≤–∞–Ω–Ω—ã–π —Å–ø–∏—Å–æ–∫ —Å–≤–æ–∏—Ö —Ä–µ–∑–µ—Ä–≤–æ–≤."""
    items, total = await query_service.get_my_reservations(
        current_user, status, search, sort, skip, limit
    )
    return ReservationListResponse(items=items, total=total)

@router.delete("/{reservation_id}")
async def delete_reservation(
        reservation_id: int,
        current_user: User = Depends(require_user),
        csrf_protect: CsrfProtect = Depends(),
        service: OrderLifecycleService = Depends(get_order_lifecycle_service)
):
    """–£–¥–∞–ª–∏—Ç—å —Å–≤–æ–π —Ä–µ–∑–µ—Ä–≤."""
    await service.cancel_user_reservation(reservation_id, current_user)
    return {"message": "–†–µ–∑–µ—Ä–≤ —É–¥–∞–ª—ë–Ω"}

@router.put("/{reservation_id}", response_model=ReservationResponse)
async def update_reservation(
        reservation_id: int,
        data: ReservationUpdateRequest,
        current_user: User = Depends(require_user),
        csrf_protect: CsrfProtect = Depends(),
        service: OrderLifecycleService = Depends(get_order_lifecycle_service)
):
    """–û–±–Ω–æ–≤–∏—Ç—å —Å–≤–æ–π —Ä–µ–∑–µ—Ä–≤."""
    updated_reservation = await service.update_user_reservation(reservation_id, data, current_user)
    return ReservationResponse(reservation_id=updated_reservation.id, message="–†–µ–∑–µ—Ä–≤ —É—Å–ø–µ—à–Ω–æ –æ–±–Ω–æ–≤–ª—ë–Ω")

@router.post("/calculate", response_model=PriceCalculationResponse)
async def calculate_price(
        request: PriceCalculationRequest,
        db: AsyncSession = Depends(get_db)
):
    """–†–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ—Ç —Å—Ç–æ–∏–º–æ—Å—Ç—å —Ä–µ–∑–µ—Ä–≤–∞ –±–µ–∑ –µ–≥–æ —Å–æ–∑–¥–∞–Ω–∏—è."""
    financial_service = FinancialService(db)
    financial_service.validate_date_range(request.start_date, request.end_date)
    promo_code_obj: Optional[PromoCode] = None
    promo_message: Optional[str] = None

    preliminary_price_details = await financial_service.calculate_final_price(
        request.equipment_ids, request.selected_accessories,
        request.start_date, request.end_date, None
    )

    if request.promo_code:
        try:
            promo_code_obj = await validate_promo_code_for_use(
                db, request.promo_code, preliminary_price_details.full_total,
                request.equipment_ids, None
            )
            promo_message = "–ü—Ä–æ–º–æ–∫–æ–¥ —É—Å–ø–µ—à–Ω–æ –ø—Ä–∏–º–µ–Ω–µ–Ω!"
        except HTTPException as e:
            promo_message = e.detail

    final_price_details = await financial_service.calculate_final_price(
        request.equipment_ids, request.selected_accessories,
        request.start_date, request.end_date, promo_code_obj
    )

    day_count = await financial_service.get_rental_days(request.start_date, request.end_date)
    promo_discount = promo_code_obj.discount_percentage if promo_code_obj else 0

    return PriceCalculationResponse(
        day_count=day_count,
        full_total=final_price_details.full_total,
        final_total=final_price_details.final_total,
        discount_amount=final_price_details.discount_amount,
        duration_discount_percentage=await get_duration_discount_percentage(db, day_count),
        promo_discount_percentage=promo_discount,
        promo_code_message=promo_message
    )

```


## <a name="RentalAppFASTAPIapirouterpy"></a>`RentalApp_FASTAPI/api/router.py`

```python
// path: RentalApp_FASTAPI/api/router.py

# api/router.py

from fastapi import APIRouter
from api.auth_api import router as auth_router
from api.equipment_api import router as equipment_router
from api.reservation_api import router as reservation_router
from api.user_api import router as user_router
from api.calendar_api import router as calendar_router
from api.accessory_api import router as accessory_router
from api.admin_reservation_api import router as admin_reservation_router
from api.promo_code_api import router as promo_code_router
from api.holiday_api import router as holiday_router
from api.discount_api import router as discount_router
from api.association_api import router as association_router
from api.admin_rental_api import router as admin_rental_router
from api.admin_dashboard_api import router as admin_dashboard_router

router = APIRouter()

router.include_router(auth_router)
router.include_router(equipment_router)
router.include_router(reservation_router)
router.include_router(user_router)
router.include_router(calendar_router)
router.include_router(accessory_router)
router.include_router(admin_reservation_router)
router.include_router(promo_code_router)
router.include_router(holiday_router)
router.include_router(discount_router)
router.include_router(association_router)
router.include_router(admin_rental_router)
router.include_router(admin_dashboard_router)

# –°—Ç–∞—Ä—ã–µ —Å–µ—Ä–≤–∏—Å—ã –±—ã–ª–∏ —É–¥–∞–ª–µ–Ω—ã, –ø–æ—ç—Ç–æ–º—É –Ω–∏–∫–∞–∫–∏—Ö –∏–∑–º–µ–Ω–µ–Ω–∏–π –≤ —Ä–æ—É—Ç–µ—Ä–µ –Ω–µ —Ç—Ä–µ–±—É–µ—Ç—Å—è,
# —Ç–∞–∫ –∫–∞–∫ –æ–Ω –ø–æ–¥–∫–ª—é—á–∞–µ—Ç —Ç–æ–ª—å–∫–æ API-—Å–ª–æ–π (–Ω–∞–ø—Ä–∏–º–µ—Ä, admin_rental_api),
# –∞ –≤–Ω—É—Ç—Ä–µ–Ω–Ω–∏–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ —ç—Ç–∏—Ö API —É–∂–µ –∏–∑–º–µ–Ω–µ–Ω—ã.

```


## <a name="RentalAppFASTAPIapiservicespytestcacheREADMEmd"></a>`RentalApp_FASTAPI/api/services/.pytest_cache/README.md`

```markdown
// path: RentalApp_FASTAPI/api/services/.pytest_cache/README.md

# pytest cache directory #

This directory contains data from the pytest's cache plugin,
which provides the `--lf` and `--ff` options, as well as the `cache` fixture.

**Do not** commit this to version control.

See [the docs](https://docs.pytest.org/en/stable/how-to/cache.html) for more information.


```


## <a name="RentalAppFASTAPIapiservicesauthservicepy"></a>`RentalApp_FASTAPI/api/services/auth_service.py`

```python
// path: RentalApp_FASTAPI/api/services/auth_service.py

# api/services/auth_service.py

from api.models.user import User
from passlib.context import CryptContext
from jose import JWTError, jwt
from sqlalchemy.ext.asyncio import AsyncSession
from sqlalchemy import select
from shared.schemas.user_schema import UserCreate
from datetime import datetime, timedelta
from config.secrets import SECRET_KEY
from fastapi import HTTPException
import logging

ALGORITHM = "HS256"
ACCESS_TOKEN_EXPIRE_MINUTES = 60
pwd_context = CryptContext(schemes=["bcrypt"], deprecated="auto")


def hash_password(password: str) -> str:
    return pwd_context.hash(password)


def verify_password(plain: str, hashed: str) -> bool:
    return pwd_context.verify(plain, hashed)


async def create_user(db: AsyncSession, user_data: UserCreate) -> User:
    try:
        result = await db.execute(select(User).filter(User.email == user_data.email))
        existing = result.scalars().first()
        if existing:
            raise HTTPException(status_code=409, detail="Email —É–∂–µ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω")

        # <<< –ò–ó–ú–ï–ù–ï–ù–ò–ï: –î–æ–±–∞–≤–ª—è–µ–º 'phone' –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è >>>
        user = User(
            full_name=user_data.full_name,
            email=user_data.email,
            hashed_password=hash_password(user_data.password),
            phone=user_data.phone,  # <--- –ù–æ–≤–æ–µ –ø–æ–ª–µ
            role="user",
            is_active=True,
            status="–ê–∫—Ç–∏–≤–Ω—ã–π",
            balance=0.0,
            notes="–°–æ–∑–¥–∞–Ω –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø—Ä–∏ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏",
            # +++ –ù–û–í–´–ï –ü–û–õ–Ø +++
            privacy_policy_accepted=user_data.privacy_policy_accepted,
            terms_accepted=user_data.terms_accepted,
            email_verified=True  # –ü—Ä–∏ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ email —Å—á–∏—Ç–∞–µ—Ç—Å—è –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–Ω—ã–º
        )
        db.add(user)
        await db.commit()
        await db.refresh(user)
        
        # –í–æ–∑–≤—Ä–∞—â–∞–µ–º —Å–æ–∑–¥–∞–Ω–Ω—ã–π –æ–±—ä–µ–∫—Ç —Å –∑–∞–≥—Ä—É–∂–µ–Ω–Ω—ã–º–∏ –¥–∞–Ω–Ω—ã–º–∏ –∏–∑ –ë–î
        return user
    except HTTPException as http_exc:
        db.rollback()
        raise http_exc
    except Exception as e:
        db.rollback()
        logging.exception(f"[‚ùå create_user] –û—à–∏–±–∫–∞ –ø—Ä–∏ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏: {e}")
        raise HTTPException(status_code=500, detail="–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞ –ø—Ä–∏ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏")


async def authenticate_user(db: AsyncSession, email: str, password: str) -> User | None:
    result = await db.execute(select(User).filter(User.email == email))
    user = result.scalars().first()
    if user and verify_password(password, user.hashed_password):
        return user
    return None


def create_access_token(data: dict, expires_delta: timedelta = None):
    to_encode = data.copy()
    expire = datetime.utcnow() + (expires_delta or timedelta(minutes=ACCESS_TOKEN_EXPIRE_MINUTES))
    to_encode.update({"exp": expire})
    return jwt.encode(to_encode, SECRET_KEY, algorithm=ALGORITHM)


async def get_user_by_token(db: AsyncSession, token: str) -> User | None:
    try:
        payload = jwt.decode(token, SECRET_KEY, algorithms=[ALGORITHM])
        email: str = payload.get("sub")
        if email is None:
            return None
    except JWTError:
        return None
    result = await db.execute(select(User).filter(User.email == email))
    return result.scalars().first()

```


## <a name="RentalAppFASTAPIapiservicesavailabilityinitpy"></a>`RentalApp_FASTAPI/api/services/availability/__init__.py`

```python
// path: RentalApp_FASTAPI/api/services/availability/__init__.py

# api/services/availability/__init__.py

from .availability_service import AvailabilityService
from .base import AvailabilityBaseService
from .conflicts import AvailabilityConflictsService
from .statuses import AvailabilityStatusService
from .calendar import AvailabilityCalendarService
from .queries import AvailabilityQueryService

__all__ = [
    'AvailabilityService',
    'AvailabilityBaseService',
    'AvailabilityConflictsService',
    'AvailabilityStatusService',
    'AvailabilityCalendarService',
    'AvailabilityQueryService'
]


```


## <a name="RentalAppFASTAPIapiservicesavailabilityavailabilityservicepy"></a>`RentalApp_FASTAPI/api/services/availability/availability_service.py`

```python
// path: RentalApp_FASTAPI/api/services/availability/availability_service.py

# api/services/availability/availability_service.py

from sqlalchemy.ext.asyncio import AsyncSession
from datetime import date
from typing import List, Dict, Any, Optional

from .conflicts import AvailabilityConflictsService
from .statuses import AvailabilityStatusService
from .calendar import AvailabilityCalendarService
from .queries import AvailabilityQueryService


class AvailabilityService:
    """
    –ì–ª–∞–≤–Ω—ã–π —Ñ–∞—Å–∞–¥ –¥–ª—è —Å–µ—Ä–≤–∏—Å–æ–≤ –ø—Ä–æ–≤–µ—Ä–∫–∏ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏ –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—è.
    –û–±—ä–µ–¥–∏–Ω—è–µ—Ç –≤—Å–µ —Å–ø–µ—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ —Å–µ—Ä–≤–∏—Å—ã –≤ –µ–¥–∏–Ω—ã–π –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å.
    –ï–¥–∏–Ω—Å—Ç–≤–µ–Ω–Ω—ã–π –∏—Å—Ç–æ—á–Ω–∏–∫ –ø—Ä–∞–≤–¥—ã –¥–ª—è –≤—Å–µ—Ö –ø—Ä–æ–≤–µ—Ä–æ–∫ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏ –≤ —Å–∏—Å—Ç–µ–º–µ.
    """

    def __init__(self, db: AsyncSession):
        self.db = db
        
        # –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º —Å–ø–µ—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ —Å–µ—Ä–≤–∏—Å—ã
        self._conflicts_service = AvailabilityConflictsService(db)
        self._status_service = AvailabilityStatusService(db)
        self._calendar_service = AvailabilityCalendarService(db)
        self._query_service = AvailabilityQueryService(db)

    # === –ú–ï–¢–û–î–´ –î–õ–Ø –†–ê–ë–û–¢–´ –° –ö–û–ù–§–õ–ò–ö–¢–ê–ú–ò ===
    
    async def get_conflicts(
        self,
        equipment_ids: List[int],
        start_date: date,
        end_date: date,
        exclude_reservation_id: Optional[int] = None,
        exclude_rental_id: Optional[int] = None
    ) -> Dict[int, List[Dict[str, Any]]]:
        """
        –û—Å–Ω–æ–≤–Ω–æ–π –º–µ—Ç–æ–¥ –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –≤—Å–µ—Ö –∫–æ–Ω—Ñ–ª–∏–∫—Ç–æ–≤ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏ –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—è.
        
        Args:
            equipment_ids: –°–ø–∏—Å–æ–∫ ID –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—è –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏
            start_date: –î–∞—Ç–∞ –Ω–∞—á–∞–ª–∞ –ø–µ—Ä–∏–æ–¥–∞
            end_date: –î–∞—Ç–∞ –æ–∫–æ–Ω—á–∞–Ω–∏—è –ø–µ—Ä–∏–æ–¥–∞ (–≤–∫–ª—é—á–∏—Ç–µ–ª—å–Ω–æ)
            exclude_reservation_id: ID —Ä–µ–∑–µ—Ä–≤–∏—Ä–æ–≤–∞–Ω–∏—è –¥–ª—è –∏—Å–∫–ª—é—á–µ–Ω–∏—è –∏–∑ –ø—Ä–æ–≤–µ—Ä–∫–∏
            exclude_rental_id: ID –∞—Ä–µ–Ω–¥—ã –¥–ª—è –∏—Å–∫–ª—é—á–µ–Ω–∏—è –∏–∑ –ø—Ä–æ–≤–µ—Ä–∫–∏
            
        Returns:
            –°–ª–æ–≤–∞—Ä—å, –≥–¥–µ –∫–ª—é—á - ID –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—è, –∑–Ω–∞—á–µ–Ω–∏–µ - —Å–ø–∏—Å–æ–∫ –∫–æ–Ω—Ñ–ª–∏–∫—Ç–æ–≤
        """
        return await self._conflicts_service.get_conflicts(
            equipment_ids, start_date, end_date, exclude_reservation_id, exclude_rental_id
        )

    async def get_conflicting_equipment_ids(
        self,
        equipment_ids: List[int],
        start_date: date,
        end_date: date,
        exclude_reservation_id: Optional[int] = None,
        exclude_rental_id: Optional[int] = None
    ) -> List[int]:
        """
        –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Å–ø–∏—Å–æ–∫ ID –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—è, —É –∫–æ—Ç–æ—Ä–æ–≥–æ –µ—Å—Ç—å –∫–æ–Ω—Ñ–ª–∏–∫—Ç—ã –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏.
        
        Args:
            equipment_ids: –°–ø–∏—Å–æ–∫ ID –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—è –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏
            start_date: –î–∞—Ç–∞ –Ω–∞—á–∞–ª–∞ –ø–µ—Ä–∏–æ–¥–∞
            end_date: –î–∞—Ç–∞ –æ–∫–æ–Ω—á–∞–Ω–∏—è –ø–µ—Ä–∏–æ–¥–∞
            exclude_reservation_id: ID —Ä–µ–∑–µ—Ä–≤–∏—Ä–æ–≤–∞–Ω–∏—è –¥–ª—è –∏—Å–∫–ª—é—á–µ–Ω–∏—è
            exclude_rental_id: ID –∞—Ä–µ–Ω–¥—ã –¥–ª—è –∏—Å–∫–ª—é—á–µ–Ω–∏—è
            
        Returns:
            –°–ø–∏—Å–æ–∫ ID –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—è —Å –∫–æ–Ω—Ñ–ª–∏–∫—Ç–∞–º–∏
        """
        return await self._conflicts_service.get_conflicting_equipment_ids(
            equipment_ids, start_date, end_date, exclude_reservation_id, exclude_rental_id
        )

    # === –ú–ï–¢–û–î–´ –î–õ–Ø –†–ê–ë–û–¢–´ –°–û –°–¢–ê–¢–£–°–ê–ú–ò ===
    
    async def get_availability_statuses(
        self,
        equipment_ids: List[int],
        start_date: date,
        end_date: date,
        exclude_reservation_id: Optional[int] = None,
        exclude_rental_id: Optional[int] = None
    ) -> Dict[int, Dict[str, Any]]:
        """
        –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Å—Ç–∞—Ç—É—Å—ã –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏ –¥–ª—è —Å–ø–∏—Å–∫–∞ –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—è.
        
        Args:
            equipment_ids: –°–ø–∏—Å–æ–∫ ID –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—è –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏
            start_date: –î–∞—Ç–∞ –Ω–∞—á–∞–ª–∞ –ø–µ—Ä–∏–æ–¥–∞
            end_date: –î–∞—Ç–∞ –æ–∫–æ–Ω—á–∞–Ω–∏—è –ø–µ—Ä–∏–æ–¥–∞
            exclude_reservation_id: ID —Ä–µ–∑–µ—Ä–≤–∏—Ä–æ–≤–∞–Ω–∏—è –¥–ª—è –∏—Å–∫–ª—é—á–µ–Ω–∏—è
            exclude_rental_id: ID –∞—Ä–µ–Ω–¥—ã –¥–ª—è –∏—Å–∫–ª—é—á–µ–Ω–∏—è
            
        Returns:
            –°–ª–æ–≤–∞—Ä—å —Å–æ —Å—Ç–∞—Ç—É—Å–∞–º–∏ –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—è
        """
        return await self._status_service.get_availability_statuses(
            equipment_ids, start_date, end_date, exclude_reservation_id, exclude_rental_id
        )

    async def get_daily_statuses(
        self,
        equipment_ids: List[int],
        start_date: date,
        end_date: date,
        exclude_reservation_id: Optional[int] = None,
        exclude_rental_id: Optional[int] = None,
        current_user_id: Optional[int] = None
    ) -> Dict[int, Dict[str, Any]]:
        """
        –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Å—Ç–∞—Ç—É—Å—ã –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—è –ø–æ –¥–Ω—è–º –¥–ª—è –∫–∞–ª–µ–Ω–¥–∞—Ä–Ω–æ–≥–æ –ø—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω–∏—è.
        
        Args:
            equipment_ids: –°–ø–∏—Å–æ–∫ ID –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—è –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏
            start_date: –î–∞—Ç–∞ –Ω–∞—á–∞–ª–∞ –ø–µ—Ä–∏–æ–¥–∞
            end_date: –î–∞—Ç–∞ –æ–∫–æ–Ω—á–∞–Ω–∏—è –ø–µ—Ä–∏–æ–¥–∞
            exclude_reservation_id: ID —Ä–µ–∑–µ—Ä–≤–∏—Ä–æ–≤–∞–Ω–∏—è –¥–ª—è –∏—Å–∫–ª—é—á–µ–Ω–∏—è
            exclude_rental_id: ID –∞—Ä–µ–Ω–¥—ã –¥–ª—è –∏—Å–∫–ª—é—á–µ–Ω–∏—è
            current_user_id: ID —Ç–µ–∫—É—â–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –¥–ª—è –≤—ã–¥–µ–ª–µ–Ω–∏—è –µ–≥–æ —Ä–µ–∑–µ—Ä–≤–∏—Ä–æ–≤–∞–Ω–∏–π
            
        Returns:
            –°–ª–æ–≤–∞—Ä—å —Å–æ —Å—Ç–∞—Ç—É—Å–∞–º–∏ –ø–æ –¥–Ω—è–º
        """
        return await self._status_service.get_daily_statuses(
            equipment_ids, start_date, end_date, exclude_reservation_id, exclude_rental_id, current_user_id
        )

    # === –ú–ï–¢–û–î–´ –î–õ–Ø –†–ê–ë–û–¢–´ –° –ö–ê–õ–ï–ù–î–ê–†–ï–ú ===
    
    async def get_calendar_events(
        self,
        equipment_ids: List[int],
        start_date: date,
        end_date: date
    ) -> List[Dict[str, Any]]:
        """
        –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Å–æ–±—ã—Ç–∏—è –¥–ª—è –∫–∞–ª–µ–Ω–¥–∞—Ä—è –≤ —Ñ–æ—Ä–º–∞—Ç–µ FullCalendar.
        
        Args:
            equipment_ids: –°–ø–∏—Å–æ–∫ ID –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—è
            start_date: –î–∞—Ç–∞ –Ω–∞—á–∞–ª–∞ –ø–µ—Ä–∏–æ–¥–∞
            end_date: –î–∞—Ç–∞ –æ–∫–æ–Ω—á–∞–Ω–∏—è –ø–µ—Ä–∏–æ–¥–∞
            
        Returns:
            –°–ø–∏—Å–æ–∫ —Å–æ–±—ã—Ç–∏–π –¥–ª—è –∫–∞–ª–µ–Ω–¥–∞—Ä—è
        """
        return await self._calendar_service.get_calendar_events(
            equipment_ids, start_date, end_date
        )

    # === –ú–ï–¢–û–î–´ –î–õ–Ø –†–ê–ë–û–¢–´ –° SQL-–ó–ê–ü–†–û–°–ê–ú–ò ===
    
    def get_sqlalchemy_filter_for_available_equipment(
        self,
        start_date: date,
        end_date: date,
        exclude_reservation_id: Optional[int] = None,
        exclude_rental_id: Optional[int] = None
    ):
        """
        –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç SQLAlchemy —Ñ–∏–ª—å—Ç—Ä –¥–ª—è –∏—Å–∫–ª—é—á–µ–Ω–∏—è –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–æ–≥–æ –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—è.
        –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–ª—è –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏ –∑–∞–ø—Ä–æ—Å–æ–≤ –≤ EquipmentQueryBuilder.
        
        Args:
            start_date: –î–∞—Ç–∞ –Ω–∞—á–∞–ª–∞ –ø–µ—Ä–∏–æ–¥–∞
            end_date: –î–∞—Ç–∞ –æ–∫–æ–Ω—á–∞–Ω–∏—è –ø–µ—Ä–∏–æ–¥–∞
            exclude_reservation_id: ID —Ä–µ–∑–µ—Ä–≤–∏—Ä–æ–≤–∞–Ω–∏—è –¥–ª—è –∏—Å–∫–ª—é—á–µ–Ω–∏—è
            exclude_rental_id: ID –∞—Ä–µ–Ω–¥—ã –¥–ª—è –∏—Å–∫–ª—é—á–µ–Ω–∏—è
            
        Returns:
            SQLAlchemy BinaryExpression –¥–ª—è —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏
        """
        return self._query_service.get_sqlalchemy_filter_for_available_equipment(
            start_date, end_date, exclude_reservation_id, exclude_rental_id
        )


```


## <a name="RentalAppFASTAPIapiservicesavailabilitybasepy"></a>`RentalApp_FASTAPI/api/services/availability/base.py`

```python
// path: RentalApp_FASTAPI/api/services/availability/base.py

# api/services/availability/base.py

from sqlalchemy.ext.asyncio import AsyncSession
from sqlalchemy.orm import selectinload
from sqlalchemy import select
from datetime import date
from typing import List, Dict, Any, Optional
import logging

from api.models.reservation import Reservation
from api.models.equipment import Equipment
from api.models.rental import Rental

logger = logging.getLogger(__name__)


class AvailabilityBaseService:
    """
    –ë–∞–∑–æ–≤—ã–π –∫–ª–∞—Å—Å –¥–ª—è —Å–µ—Ä–≤–∏—Å–æ–≤ –ø—Ä–æ–≤–µ—Ä–∫–∏ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏ –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—è.
    –°–æ–¥–µ—Ä–∂–∏—Ç –æ–±—â—É—é –ª–æ–≥–∏–∫—É –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å —Ä–µ–∑–µ—Ä–≤–∏—Ä–æ–≤–∞–Ω–∏—è–º–∏ –∏ –∞—Ä–µ–Ω–¥–∞–º–∏.
    """

    def __init__(self, db: AsyncSession):
        self.db = db

    async def _get_overlapping_reservations(
        self,
        equipment_ids: List[int],
        start_date: date,
        end_date: date,
        exclude_reservation_id: Optional[int] = None
    ) -> List[Reservation]:
        """
        –ü–æ–ª—É—á–∞–µ—Ç —Ä–µ–∑–µ—Ä–≤–∏—Ä–æ–≤–∞–Ω–∏—è, –ø–µ—Ä–µ—Å–µ–∫–∞—é—â–∏–µ—Å—è —Å —É–∫–∞–∑–∞–Ω–Ω—ã–º –ø–µ—Ä–∏–æ–¥–æ–º.
        
        Args:
            equipment_ids: –°–ø–∏—Å–æ–∫ ID –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—è –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏
            start_date: –î–∞—Ç–∞ –Ω–∞—á–∞–ª–∞ –ø–µ—Ä–∏–æ–¥–∞
            end_date: –î–∞—Ç–∞ –æ–∫–æ–Ω—á–∞–Ω–∏—è –ø–µ—Ä–∏–æ–¥–∞
            exclude_reservation_id: ID —Ä–µ–∑–µ—Ä–≤–∏—Ä–æ–≤–∞–Ω–∏—è –¥–ª—è –∏—Å–∫–ª—é—á–µ–Ω–∏—è
            
        Returns:
            –°–ø–∏—Å–æ–∫ —Ä–µ–∑–µ—Ä–≤–∏—Ä–æ–≤–∞–Ω–∏–π, –ø–µ—Ä–µ—Å–µ–∫–∞—é—â–∏—Ö—Å—è —Å –ø–µ—Ä–∏–æ–¥–æ–º
        """
        query = select(Reservation).options(
            selectinload(Reservation.equipment)
        ).filter(
            Reservation.end_date > start_date,
            Reservation.start_date < end_date,
            Reservation.status == 'active'
        ).where(
            Reservation.equipment.any(Equipment.id.in_(equipment_ids))
        )
        
        if exclude_reservation_id:
            query = query.filter(Reservation.id != exclude_reservation_id)
            
        result = await self.db.execute(query)
        return result.unique().scalars().all()

    async def _get_overlapping_rentals(
        self,
        equipment_ids: List[int],
        start_date: date,
        end_date: date,
        exclude_rental_id: Optional[int] = None
    ) -> List[Rental]:
        """
        –ü–æ–ª—É—á–∞–µ—Ç –∞—Ä–µ–Ω–¥—ã, –ø–µ—Ä–µ—Å–µ–∫–∞—é—â–∏–µ—Å—è —Å —É–∫–∞–∑–∞–Ω–Ω—ã–º –ø–µ—Ä–∏–æ–¥–æ–º.
        
        Args:
            equipment_ids: –°–ø–∏—Å–æ–∫ ID –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—è –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏
            start_date: –î–∞—Ç–∞ –Ω–∞—á–∞–ª–∞ –ø–µ—Ä–∏–æ–¥–∞
            end_date: –î–∞—Ç–∞ –æ–∫–æ–Ω—á–∞–Ω–∏—è –ø–µ—Ä–∏–æ–¥–∞
            exclude_rental_id: ID –∞—Ä–µ–Ω–¥—ã –¥–ª—è –∏—Å–∫–ª—é—á–µ–Ω–∏—è
            
        Returns:
            –°–ø–∏—Å–æ–∫ –∞—Ä–µ–Ω–¥, –ø–µ—Ä–µ—Å–µ–∫–∞—é—â–∏—Ö—Å—è —Å –ø–µ—Ä–∏–æ–¥–æ–º
        """
        query = select(Rental).options(
            selectinload(Rental.equipment)
        ).filter(
            Rental.end_date > start_date,
            Rental.start_date < end_date,
            Rental.status.in_(['active', 'overdue'])
        ).where(
            Rental.equipment.any(Equipment.id.in_(equipment_ids))
        )
        
        if exclude_rental_id:
            query = query.filter(Rental.id != exclude_rental_id)
            
        result = await self.db.execute(query)
        return result.unique().scalars().all()

    def _filter_equipment_in_list(
        self,
        equipment_list: List[Equipment],
        equipment_ids: List[int]
    ) -> List[Equipment]:
        """
        –§–∏–ª—å—Ç—Ä—É–µ—Ç –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏–µ –ø–æ —Å–ø–∏—Å–∫—É ID.
        
        Args:
            equipment_list: –°–ø–∏—Å–æ–∫ –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—è –¥–ª—è —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏
            equipment_ids: –°–ø–∏—Å–æ–∫ ID –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—è –¥–ª—è –≤–∫–ª—é—á–µ–Ω–∏—è
            
        Returns:
            –û—Ç—Ñ–∏–ª—å—Ç—Ä–æ–≤–∞–Ω–Ω—ã–π —Å–ø–∏—Å–æ–∫ –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—è
        """
        return [eq for eq in equipment_list if eq.id in equipment_ids]

    def _create_conflict_dict(
        self,
        conflict_type: str,
        conflict_id: int,
        start_date: date,
        end_date: date,
        user_id: int
    ) -> Dict[str, Any]:
        """
        –°–æ–∑–¥–∞–µ—Ç —Å–ª–æ–≤–∞—Ä—å —Å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–µ–π –æ –∫–æ–Ω—Ñ–ª–∏–∫—Ç–µ.
        
        Args:
            conflict_type: –¢–∏–ø –∫–æ–Ω—Ñ–ª–∏–∫—Ç–∞ ('reservation' –∏–ª–∏ 'rental')
            conflict_id: ID –∫–æ–Ω—Ñ–ª–∏–∫—Ç–∞
            start_date: –î–∞—Ç–∞ –Ω–∞—á–∞–ª–∞
            end_date: –î–∞—Ç–∞ –æ–∫–æ–Ω—á–∞–Ω–∏—è
            user_id: ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
            
        Returns:
            –°–ª–æ–≤–∞—Ä—å —Å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–µ–π –æ –∫–æ–Ω—Ñ–ª–∏–∫—Ç–µ
        """
        return {
            'type': conflict_type,
            'id': conflict_id,
            'start_date': start_date,
            'end_date': end_date,
            'user_id': user_id
        }


```


## <a name="RentalAppFASTAPIapiservicesavailabilitycalendarpy"></a>`RentalApp_FASTAPI/api/services/availability/calendar.py`

```python
// path: RentalApp_FASTAPI/api/services/availability/calendar.py

# api/services/availability/calendar.py

from sqlalchemy.orm import selectinload, joinedload
from sqlalchemy import select
from datetime import date
from typing import List, Dict, Any

from .base import AvailabilityBaseService
from api.models.rental import Rental 
from api.models.reservation import Reservation


class AvailabilityCalendarService(AvailabilityBaseService):
    """
    –°–µ—Ä–≤–∏—Å –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –∫–∞–ª–µ–Ω–¥–∞—Ä–Ω—ã–º–∏ —Å–æ–±—ã—Ç–∏—è–º–∏.
    –û—Ç–≤–µ—á–∞–µ—Ç –∑–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏—é —Å–æ–±—ã—Ç–∏–π –¥–ª—è FullCalendar –∏ –¥—Ä—É–≥–∏—Ö –∫–∞–ª–µ–Ω–¥–∞—Ä–Ω—ã—Ö –ø—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω–∏–π.
    """

    async def get_calendar_events(
        self,
        equipment_ids: List[int],
        start_date: date,
        end_date: date
    ) -> List[Dict[str, Any]]:
        """
        –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Å–æ–±—ã—Ç–∏—è –¥–ª—è –∫–∞–ª–µ–Ω–¥–∞—Ä—è –≤ —Ñ–æ—Ä–º–∞—Ç–µ FullCalendar.
        
        Args:
            equipment_ids: –°–ø–∏—Å–æ–∫ ID –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—è
            start_date: –î–∞—Ç–∞ –Ω–∞—á–∞–ª–∞ –ø–µ—Ä–∏–æ–¥–∞
            end_date: –î–∞—Ç–∞ –æ–∫–æ–Ω—á–∞–Ω–∏—è –ø–µ—Ä–∏–æ–¥–∞
            
        Returns:
            –°–ø–∏—Å–æ–∫ —Å–æ–±—ã—Ç–∏–π –¥–ª—è –∫–∞–ª–µ–Ω–¥–∞—Ä—è
        """
        events = []

        # 1. –ò—Å–ø–æ–ª—å–∑—É–µ–º –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–Ω—ã–π –º–µ—Ç–æ–¥ –∏–∑ –±–∞–∑–æ–≤–æ–≥–æ –∫–ª–∞—Å—Å–∞ –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –∞—Ä–µ–Ω–¥
        rentals = await self._get_overlapping_rentals(equipment_ids, start_date, end_date)
        for rental in rentals:
            for equipment in rental.equipment:
                # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏–µ –∏–∑ –∞—Ä–µ–Ω–¥—ã –µ—Å—Ç—å –≤ –Ω–∞—à–µ–º –∑–∞–ø—Ä–æ—Å–µ
                if equipment.id in equipment_ids:
                    events.append({
                        "id": f"rental-{rental.id}-{equipment.id}",
                        "title": f"–ê—Ä–µ–Ω–¥–∞: {equipment.name}",
                        "start": rental.start_date.strftime("%Y-%m-%d"),
                        "end": rental.end_date.strftime("%Y-%m-%d"),
                        "resourceId": equipment.id,
                        "status": "rented"
                    })
        
        # 2. –ò—Å–ø–æ–ª—å–∑—É–µ–º –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–Ω—ã–π –º–µ—Ç–æ–¥ –∏–∑ –±–∞–∑–æ–≤–æ–≥–æ –∫–ª–∞—Å—Å–∞ –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è —Ä–µ–∑–µ—Ä–≤–æ–≤
        reservations = await self._get_overlapping_reservations(equipment_ids, start_date, end_date)
        for reservation in reservations:
            # –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ –∑–∞–≥—Ä—É–∂–∞–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è, –µ—Å–ª–∏ —ç—Ç–æ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ
            await self.db.refresh(reservation, attribute_names=['user'])
            for equipment in reservation.equipment:
                # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏–µ –∏–∑ —Ä–µ–∑–µ—Ä–≤–∞ –µ—Å—Ç—å –≤ –Ω–∞—à–µ–º –∑–∞–ø—Ä–æ—Å–µ
                if equipment.id in equipment_ids:
                    events.append({
                        "id": f"reservation-{reservation.id}-{equipment.id}",
                        "title": f"–†–µ–∑–µ—Ä–≤: {reservation.user.full_name}",
                        "start": reservation.start_date.strftime("%Y-%m-%d"),
                        "end": reservation.end_date.strftime("%Y-%m-%d"),
                        "resourceId": equipment.id,
                        "status": "reserved"
                    })
        
        return events



```


## <a name="RentalAppFASTAPIapiservicesavailabilityconflictspy"></a>`RentalApp_FASTAPI/api/services/availability/conflicts.py`

```python
// path: RentalApp_FASTAPI/api/services/availability/conflicts.py

# api/services/availability/conflicts.py

from datetime import date
from typing import List, Dict, Any, Optional

from .base import AvailabilityBaseService


class AvailabilityConflictsService(AvailabilityBaseService):
    """
    –°–µ—Ä–≤–∏—Å –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –∫–æ–Ω—Ñ–ª–∏–∫—Ç–∞–º–∏ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏ –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—è.
    –û—Ç–≤–µ—á–∞–µ—Ç –∑–∞ –ø–æ–∏—Å–∫ –∏ –∞–Ω–∞–ª–∏–∑ –∫–æ–Ω—Ñ–ª–∏–∫—Ç–æ–≤ –º–µ–∂–¥—É —Ä–µ–∑–µ—Ä–≤–∏—Ä–æ–≤–∞–Ω–∏—è–º–∏ –∏ –∞—Ä–µ–Ω–¥–∞–º–∏.
    """

    async def get_conflicts(
        self,
        equipment_ids: List[int],
        start_date: date,
        end_date: date,
        exclude_reservation_id: Optional[int] = None,
        exclude_rental_id: Optional[int] = None
    ) -> Dict[int, List[Dict[str, Any]]]:
        """
        –û—Å–Ω–æ–≤–Ω–æ–π –º–µ—Ç–æ–¥ –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –≤—Å–µ—Ö –∫–æ–Ω—Ñ–ª–∏–∫—Ç–æ–≤ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏ –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—è.
        
        Args:
            equipment_ids: –°–ø–∏—Å–æ–∫ ID –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—è –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏
            start_date: –î–∞—Ç–∞ –Ω–∞—á–∞–ª–∞ –ø–µ—Ä–∏–æ–¥–∞
            end_date: –î–∞—Ç–∞ –æ–∫–æ–Ω—á–∞–Ω–∏—è –ø–µ—Ä–∏–æ–¥–∞ (–≤–∫–ª—é—á–∏—Ç–µ–ª—å–Ω–æ)
            exclude_reservation_id: ID —Ä–µ–∑–µ—Ä–≤–∏—Ä–æ–≤–∞–Ω–∏—è –¥–ª—è –∏—Å–∫–ª—é—á–µ–Ω–∏—è –∏–∑ –ø—Ä–æ–≤–µ—Ä–∫–∏
            exclude_rental_id: ID –∞—Ä–µ–Ω–¥—ã –¥–ª—è –∏—Å–∫–ª—é—á–µ–Ω–∏—è –∏–∑ –ø—Ä–æ–≤–µ—Ä–∫–∏
            
        Returns:
            –°–ª–æ–≤–∞—Ä—å, –≥–¥–µ –∫–ª—é—á - ID –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—è, –∑–Ω–∞—á–µ–Ω–∏–µ - —Å–ø–∏—Å–æ–∫ –∫–æ–Ω—Ñ–ª–∏–∫—Ç–æ–≤
        """
        conflicts: Dict[int, List[Dict[str, Any]]] = {}
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ —Å–ø–∏—Å–æ–∫ –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—è –Ω–µ –ø—É—Å—Ç–æ–π
        if not equipment_ids:
            return conflicts
        
        # –ü–æ–ª—É—á–∞–µ–º –ø–µ—Ä–µ—Å–µ–∫–∞—é—â–∏–µ—Å—è —Ä–µ–∑–µ—Ä–≤–∏—Ä–æ–≤–∞–Ω–∏—è
        overlapping_reservations = await self._get_overlapping_reservations(
            equipment_ids, start_date, end_date, exclude_reservation_id
        )
        
        # –ü–æ–ª—É—á–∞–µ–º –ø–µ—Ä–µ—Å–µ–∫–∞—é—â–∏–µ—Å—è –∞—Ä–µ–Ω–¥—ã
        overlapping_rentals = await self._get_overlapping_rentals(
            equipment_ids, start_date, end_date, exclude_rental_id
        )
        
        # –û–±—Ä–∞–±–æ—Ç–∫–∞ —Ä–µ–∑–µ—Ä–≤–∏—Ä–æ–≤–∞–Ω–∏–π
        for reservation in overlapping_reservations:
            for equipment in reservation.equipment:
                if equipment.id in equipment_ids:
                    if equipment.id not in conflicts:
                        conflicts[equipment.id] = []
                    
                    conflict_dict = self._create_conflict_dict(
                        'reservation',
                        reservation.id,
                        reservation.start_date,
                        reservation.end_date,
                        reservation.user_id
                    )
                    conflicts[equipment.id].append(conflict_dict)
        
        # –û–±—Ä–∞–±–æ—Ç–∫–∞ –∞—Ä–µ–Ω–¥
        for rental in overlapping_rentals:
            for equipment in rental.equipment:
                if equipment.id in equipment_ids:
                    if equipment.id not in conflicts:
                        conflicts[equipment.id] = []
                    
                    conflict_dict = self._create_conflict_dict(
                        'rental',
                        rental.id,
                        rental.start_date,
                        rental.end_date,
                        rental.user_id
                    )
                    conflicts[equipment.id].append(conflict_dict)
        
        return conflicts

    async def get_conflicting_equipment_ids(
        self,
        equipment_ids: List[int],
        start_date: date,
        end_date: date,
        exclude_reservation_id: Optional[int] = None,
        exclude_rental_id: Optional[int] = None
    ) -> List[int]:
        """
        –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Å–ø–∏—Å–æ–∫ ID –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—è, —É –∫–æ—Ç–æ—Ä–æ–≥–æ –µ—Å—Ç—å –∫–æ–Ω—Ñ–ª–∏–∫—Ç—ã –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏.
        
        Args:
            equipment_ids: –°–ø–∏—Å–æ–∫ ID –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—è –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏
            start_date: –î–∞—Ç–∞ –Ω–∞—á–∞–ª–∞ –ø–µ—Ä–∏–æ–¥–∞
            end_date: –î–∞—Ç–∞ –æ–∫–æ–Ω—á–∞–Ω–∏—è –ø–µ—Ä–∏–æ–¥–∞
            exclude_reservation_id: ID —Ä–µ–∑–µ—Ä–≤–∏—Ä–æ–≤–∞–Ω–∏—è –¥–ª—è –∏—Å–∫–ª—é—á–µ–Ω–∏—è
            exclude_rental_id: ID –∞—Ä–µ–Ω–¥—ã –¥–ª—è –∏—Å–∫–ª—é—á–µ–Ω–∏—è
            
        Returns:
            –°–ø–∏—Å–æ–∫ ID –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—è —Å –∫–æ–Ω—Ñ–ª–∏–∫—Ç–∞–º–∏
        """
        conflicts = await self.get_conflicts(
            equipment_ids, start_date, end_date, exclude_reservation_id, exclude_rental_id
        )
        return list(conflicts.keys())

    def _get_most_critical_conflict(
        self,
        conflict_list: List[Dict[str, Any]]
    ) -> Optional[Dict[str, Any]]:
        """
        –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç –Ω–∞–∏–±–æ–ª–µ–µ –∫—Ä–∏—Ç–∏—á–Ω—ã–π –∫–æ–Ω—Ñ–ª–∏–∫—Ç –∏–∑ —Å–ø–∏—Å–∫–∞.
        –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç: rental > reservation.
        
        Args:
            conflict_list: –°–ø–∏—Å–æ–∫ –∫–æ–Ω—Ñ–ª–∏–∫—Ç–æ–≤
            
        Returns:
            –ù–∞–∏–±–æ–ª–µ–µ –∫—Ä–∏—Ç–∏—á–Ω—ã–π –∫–æ–Ω—Ñ–ª–∏–∫—Ç –∏–ª–∏ None
        """
        if not conflict_list:
            return None
        
        # –°–æ—Ä—Ç–∏—Ä—É–µ–º –∫–æ–Ω—Ñ–ª–∏–∫—Ç—ã –ø–æ –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç—É: rental > reservation
        sorted_conflicts = sorted(
            conflict_list, 
            key=lambda c: (c['type'] != 'rental', c['type'] != 'reservation')
        )
        return sorted_conflicts[0]


```


## <a name="RentalAppFASTAPIapiservicesavailabilityqueriespy"></a>`RentalApp_FASTAPI/api/services/availability/queries.py`

```python
// path: RentalApp_FASTAPI/api/services/availability/queries.py

# api/services/availability/queries.py

from sqlalchemy import select, and_
from datetime import date
from typing import Optional

from .base import AvailabilityBaseService
from api.models.equipment import Equipment
from api.models.reservation import Reservation
from api.models.rental import Rental


class AvailabilityQueryService(AvailabilityBaseService):
    """
    –°–µ—Ä–≤–∏—Å –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å SQL-–∑–∞–ø—Ä–æ—Å–∞–º–∏ –∏ —Ñ–∏–ª—å—Ç—Ä–∞–º–∏.
    –û—Ç–≤–µ—á–∞–µ—Ç –∑–∞ —Å–æ–∑–¥–∞–Ω–∏–µ –æ–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö SQL-–∑–∞–ø—Ä–æ—Å–æ–≤ –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏.
    """

    def get_sqlalchemy_filter_for_available_equipment(
        self,
        start_date: date,
        end_date: date,
        exclude_reservation_id: Optional[int] = None,
        exclude_rental_id: Optional[int] = None
    ):
        """
        –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç SQLAlchemy —Ñ–∏–ª—å—Ç—Ä –¥–ª—è –∏—Å–∫–ª—é—á–µ–Ω–∏—è –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–æ–≥–æ –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—è.
        –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–ª—è –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏ –∑–∞–ø—Ä–æ—Å–æ–≤ –≤ EquipmentQueryBuilder.
        
        Args:
            start_date: –î–∞—Ç–∞ –Ω–∞—á–∞–ª–∞ –ø–µ—Ä–∏–æ–¥–∞
            end_date: –î–∞—Ç–∞ –æ–∫–æ–Ω—á–∞–Ω–∏—è –ø–µ—Ä–∏–æ–¥–∞
            exclude_reservation_id: ID —Ä–µ–∑–µ—Ä–≤–∏—Ä–æ–≤–∞–Ω–∏—è –¥–ª—è –∏—Å–∫–ª—é—á–µ–Ω–∏—è
            exclude_rental_id: ID –∞—Ä–µ–Ω–¥—ã –¥–ª—è –∏—Å–∫–ª—é—á–µ–Ω–∏—è
            
        Returns:
            SQLAlchemy BinaryExpression –¥–ª—è —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏
        """
        from api.models.reservation import reservation_equipment_association
        from api.models.rental import rental_equipment_association
        
        # –ü–æ–¥–∑–∞–ø—Ä–æ—Å –¥–ª—è ID –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—è, –∑–∞–Ω—è—Ç–æ–≥–æ –≤ –∞–∫—Ç–∏–≤–Ω—ã—Ö —Ä–µ–∑–µ—Ä–≤–∞—Ö
        booked_in_reservations_subquery = self._create_reservations_subquery(
            start_date, end_date, exclude_reservation_id
        )
        
        # –ü–æ–¥–∑–∞–ø—Ä–æ—Å –¥–ª—è ID –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—è, –∑–∞–Ω—è—Ç–æ–≥–æ –≤ –∞–∫—Ç–∏–≤–Ω—ã—Ö/–ø—Ä–æ—Å—Ä–æ—á–µ–Ω–Ω—ã—Ö –∞—Ä–µ–Ω–¥–∞—Ö
        booked_in_rentals_subquery = self._create_rentals_subquery(
            start_date, end_date, exclude_rental_id
        )
        
        # –í–æ–∑–≤—Ä–∞—â–∞–µ–º —É—Å–ª–æ–≤–∏–µ –¥–ª—è –∏—Å–∫–ª—é—á–µ–Ω–∏—è –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–æ–≥–æ –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—è
        return and_(
            Equipment.id.notin_(booked_in_reservations_subquery),
            Equipment.id.notin_(booked_in_rentals_subquery)
        )

    def _create_reservations_subquery(
        self,
        start_date: date,
        end_date: date,
        exclude_reservation_id: Optional[int] = None
    ):
        """
        –°–æ–∑–¥–∞–µ—Ç –ø–æ–¥–∑–∞–ø—Ä–æ—Å –¥–ª—è —Ä–µ–∑–µ—Ä–≤–∏—Ä–æ–≤–∞–Ω–∏–π.
        
        Args:
            start_date: –î–∞—Ç–∞ –Ω–∞—á–∞–ª–∞ –ø–µ—Ä–∏–æ–¥–∞
            end_date: –î–∞—Ç–∞ –æ–∫–æ–Ω—á–∞–Ω–∏—è –ø–µ—Ä–∏–æ–¥–∞
            exclude_reservation_id: ID —Ä–µ–∑–µ—Ä–≤–∏—Ä–æ–≤–∞–Ω–∏—è –¥–ª—è –∏—Å–∫–ª—é—á–µ–Ω–∏—è
            
        Returns:
            –ü–æ–¥–∑–∞–ø—Ä–æ—Å –¥–ª—è —Ä–µ–∑–µ—Ä–≤–∏—Ä–æ–≤–∞–Ω–∏–π
        """
        from api.models.reservation import reservation_equipment_association
        
        subquery = (
            select(reservation_equipment_association.c.equipment_id)
            .join(Reservation, reservation_equipment_association.c.reservation_id == Reservation.id)
            .filter(
                Reservation.end_date > start_date,
                Reservation.start_date < end_date,
                Reservation.status == 'active'
            )
        )
        
        if exclude_reservation_id:
            subquery = subquery.filter(Reservation.id != exclude_reservation_id)
        
        return subquery.distinct()

    def _create_rentals_subquery(
        self,
        start_date: date,
        end_date: date,
        exclude_rental_id: Optional[int] = None
    ):
        """
        –°–æ–∑–¥–∞–µ—Ç –ø–æ–¥–∑–∞–ø—Ä–æ—Å –¥–ª—è –∞—Ä–µ–Ω–¥.
        
        Args:
            start_date: –î–∞—Ç–∞ –Ω–∞—á–∞–ª–∞ –ø–µ—Ä–∏–æ–¥–∞
            end_date: –î–∞—Ç–∞ –æ–∫–æ–Ω—á–∞–Ω–∏—è –ø–µ—Ä–∏–æ–¥–∞
            exclude_rental_id: ID –∞—Ä–µ–Ω–¥—ã –¥–ª—è –∏—Å–∫–ª—é—á–µ–Ω–∏—è
            
        Returns:
            –ü–æ–¥–∑–∞–ø—Ä–æ—Å –¥–ª—è –∞—Ä–µ–Ω–¥
        """
        from api.models.rental import rental_equipment_association
        
        subquery = (
            select(rental_equipment_association.c.equipment_id)
            .join(Rental, rental_equipment_association.c.rental_id == Rental.id)
            .filter(
                Rental.end_date > start_date,
                Rental.start_date < end_date,
                Rental.status.in_(['active', 'overdue'])
            )
        )
        
        if exclude_rental_id:
            subquery = subquery.filter(Rental.id != exclude_rental_id)
        
        return subquery.distinct()


```


## <a name="RentalAppFASTAPIapiservicesavailabilitystatusespy"></a>`RentalApp_FASTAPI/api/services/availability/statuses.py`

```python
// path: RentalApp_FASTAPI/api/services/availability/statuses.py

# api/services/availability/statuses.py

from datetime import date, timedelta
from typing import List, Dict, Any, Optional

from .conflicts import AvailabilityConflictsService
from shared.schemas.calendar_schema import DayStatusItem


class AvailabilityStatusService(AvailabilityConflictsService):
    """
    –°–µ—Ä–≤–∏—Å –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å–æ —Å—Ç–∞—Ç—É—Å–∞–º–∏ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏ –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—è.
    –û—Ç–≤–µ—á–∞–µ—Ç –∑–∞ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –∏ —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–æ–≤ –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—è.
    """

    async def get_availability_statuses(
        self,
        equipment_ids: List[int],
        start_date: date,
        end_date: date,
        exclude_reservation_id: Optional[int] = None,
        exclude_rental_id: Optional[int] = None
    ) -> Dict[int, Dict[str, Any]]:
        """
        –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Å—Ç–∞—Ç—É—Å—ã –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏ –¥–ª—è —Å–ø–∏—Å–∫–∞ –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—è.
        
        Args:
            equipment_ids: –°–ø–∏—Å–æ–∫ ID –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—è –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏
            start_date: –î–∞—Ç–∞ –Ω–∞—á–∞–ª–∞ –ø–µ—Ä–∏–æ–¥–∞
            end_date: –î–∞—Ç–∞ –æ–∫–æ–Ω—á–∞–Ω–∏—è –ø–µ—Ä–∏–æ–¥–∞
            exclude_reservation_id: ID —Ä–µ–∑–µ—Ä–≤–∏—Ä–æ–≤–∞–Ω–∏—è –¥–ª—è –∏—Å–∫–ª—é—á–µ–Ω–∏—è
            exclude_rental_id: ID –∞—Ä–µ–Ω–¥—ã –¥–ª—è –∏—Å–∫–ª—é—á–µ–Ω–∏—è
            
        Returns:
            –°–ª–æ–≤–∞—Ä—å —Å–æ —Å—Ç–∞—Ç—É—Å–∞–º–∏ –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—è
        """
        statuses: Dict[int, Dict[str, Any]] = {
            eq_id: {"status": "available", "details": "–î–æ—Å—Ç—É–ø–Ω–æ"}
            for eq_id in equipment_ids
        }
        
        conflicts = await self.get_conflicts(
            equipment_ids, start_date, end_date, exclude_reservation_id, exclude_rental_id
        )
        
        for eq_id, conflict_list in conflicts.items():
            if not conflict_list:
                continue
            
            most_critical = self._get_most_critical_conflict(conflict_list)
            if most_critical:
                statuses[eq_id] = self._format_status_from_conflict(most_critical)
        
        return statuses

    async def get_daily_statuses(
        self,
        equipment_ids: List[int],
        start_date: date,
        end_date: date,
        exclude_reservation_id: Optional[int] = None,
        exclude_rental_id: Optional[int] = None,
        current_user_id: Optional[int] = None
    ) -> Dict[int, Dict[str, DayStatusItem]]:
        """
        –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Å—Ç–∞—Ç—É—Å—ã –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—è –ø–æ –¥–Ω—è–º –¥–ª—è –∫–∞–ª–µ–Ω–¥–∞—Ä–Ω–æ–≥–æ –ø—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω–∏—è.
        
        Args:
            equipment_ids: –°–ø–∏—Å–æ–∫ ID –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—è –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏
            start_date: –î–∞—Ç–∞ –Ω–∞—á–∞–ª–∞ –ø–µ—Ä–∏–æ–¥–∞
            end_date: –î–∞—Ç–∞ –æ–∫–æ–Ω—á–∞–Ω–∏—è –ø–µ—Ä–∏–æ–¥–∞
            exclude_reservation_id: ID —Ä–µ–∑–µ—Ä–≤–∏—Ä–æ–≤–∞–Ω–∏—è –¥–ª—è –∏—Å–∫–ª—é—á–µ–Ω–∏—è
            exclude_rental_id: ID –∞—Ä–µ–Ω–¥—ã –¥–ª—è –∏—Å–∫–ª—é—á–µ–Ω–∏—è
            current_user_id: ID —Ç–µ–∫—É—â–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –¥–ª—è –≤—ã–¥–µ–ª–µ–Ω–∏—è –µ–≥–æ —Ä–µ–∑–µ—Ä–≤–∏—Ä–æ–≤–∞–Ω–∏–π
            
        Returns:
            –°–ª–æ–≤–∞—Ä—å —Å–æ —Å—Ç–∞—Ç—É—Å–∞–º–∏ –ø–æ –¥–Ω—è–º
        """
        num_days = (end_date - start_date).days + 1
        all_dates = [start_date + timedelta(days=i) for i in range(num_days)]
        
        result: Dict[int, Dict[str, DayStatusItem]] = {
            eq_id: {
                day.strftime('%d.%m.%Y'): DayStatusItem(status="available")
                for day in all_dates
            }
            for eq_id in equipment_ids
        }
        
        conflicts = await self.get_conflicts(
            equipment_ids, start_date, end_date, exclude_reservation_id, exclude_rental_id
        )
        
        for eq_id, conflict_list in conflicts.items():
            if eq_id not in result:
                continue
                
            for conflict in conflict_list:
                self._apply_conflict_to_daily_statuses(
                    result[eq_id], conflict, start_date, end_date, current_user_id
                )
        
        return result

    def _format_status_from_conflict(self, conflict: Dict[str, Any]) -> Dict[str, Any]:
        """
        –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ—Ç —Å—Ç–∞—Ç—É—Å –Ω–∞ –æ—Å–Ω–æ–≤–µ –∫–æ–Ω—Ñ–ª–∏–∫—Ç–∞.
        
        Args:
            conflict: –°–ª–æ–≤–∞—Ä—å —Å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–µ–π –æ –∫–æ–Ω—Ñ–ª–∏–∫—Ç–µ
            
        Returns:
            –û—Ç—Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã–π —Å—Ç–∞—Ç—É—Å
        """
        if conflict['type'] == 'rental':
            return {
                "status": "rented",
                "details": f"–í –∞—Ä–µ–Ω–¥–µ –¥–æ {conflict['end_date'].strftime('%d.%m.%Y')}",
                "start_date": conflict['start_date'],
                "end_date": conflict['end_date']
            }
        elif conflict['type'] == 'reservation':
            return {
                "status": "reserved",
                "details": f"–ó–∞—Ä–µ–∑–µ—Ä–≤–∏—Ä–æ–≤–∞–Ω–æ –¥–æ {conflict['end_date'].strftime('%d.%m.%Y')}",
                "start_date": conflict['start_date'],
                "end_date": conflict['end_date']
            }
        
        return {"status": "available", "details": "–î–æ—Å—Ç—É–ø–Ω–æ"}

    def _apply_conflict_to_daily_statuses(
        self,
        daily_statuses: Dict[str, DayStatusItem],
        conflict: Dict[str, Any],
        start_date: date,
        end_date: date,
        current_user_id: Optional[int]
    ) -> None:
        """
        –ü—Ä–∏–º–µ–Ω—è–µ—Ç –∫–æ–Ω—Ñ–ª–∏–∫—Ç –∫ —Å—Ç–∞—Ç—É—Å–∞–º –ø–æ –¥–Ω—è–º.
        
        Args:
            daily_statuses: –°–ª–æ–≤–∞—Ä—å —Å–æ —Å—Ç–∞—Ç—É—Å–∞–º–∏ –ø–æ –¥–Ω—è–º
            conflict: –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –∫–æ–Ω—Ñ–ª–∏–∫—Ç–µ
            start_date: –ù–∞—á–∞–ª—å–Ω–∞—è –¥–∞—Ç–∞ –ø–µ—Ä–∏–æ–¥–∞
            end_date: –ö–æ–Ω–µ—á–Ω–∞—è –¥–∞—Ç–∞ –ø–µ—Ä–∏–æ–¥–∞
            current_user_id: ID —Ç–µ–∫—É—â–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        """
        current_day = conflict['start_date']
        while current_day < conflict['end_date']:
            if start_date <= current_day <= end_date:
                day_str = current_day.strftime('%d.%m.%Y')
                if daily_statuses[day_str].status != 'rented':
                    is_user_event = (
                        current_user_id is not None and 
                        conflict.get('user_id') == current_user_id and
                        conflict['type'] == 'reservation'
                    )
                    
                    # –°–æ–∑–¥–∞–µ–º –º–∞–ø–ø–∏–Ω–≥ –¥–ª—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–≥–æ –ø—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏—è —Å—Ç–∞—Ç—É—Å–æ–≤
                    status_map = {
                        "reservation": "reserved",
                        "rental": "rented"
                    }
                    correct_status = status_map.get(conflict['type'], "available")
                    
                    daily_statuses[day_str] = DayStatusItem(
                        status=correct_status,
                        group_id=f"{conflict['type']}-{conflict['id']}",
                        is_user_reservation=is_user_event
                    )
            current_day += timedelta(days=1)


```


## <a name="RentalAppFASTAPIapiservicesbalanceservicepy"></a>`RentalApp_FASTAPI/api/services/balance_service.py`

```python
// path: RentalApp_FASTAPI/api/services/balance_service.py

# api/services/balance_service.py

from sqlalchemy.ext.asyncio import AsyncSession
from sqlalchemy import select
from fastapi import HTTPException, status
import logging

from api.models.user import User
from api.models.balance_history import BalanceHistory
from api.models.rental import Rental

logger = logging.getLogger(__name__)

class BalanceService:
    def __init__(self, db: AsyncSession):
        self.db = db

    async def add_transaction(
            self,
            user_id: int,
            amount: float,
            operation_type: str,
            description: str,
            rental_id: int | None = None
    ) -> BalanceHistory:
        """
        –î–æ–±–∞–≤–ª—è–µ—Ç —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—é –≤ —Å–µ—Å—Å–∏—é, —Å–æ–∑–¥–∞–≤–∞—è –∑–∞–ø–∏—Å—å –≤ –∏—Å—Ç–æ—Ä–∏–∏ –∏ –æ–±–Ω–æ–≤–ª—è—è –±–∞–ª–∞–Ω—Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è.
        Amount: –ø–æ–ª–æ–∂–∏—Ç–µ–ª—å–Ω–æ–µ —á–∏—Å–ª–æ –¥–ª—è –Ω–∞—á–∏—Å–ª–µ–Ω–∏—è, –æ—Ç—Ä–∏—Ü–∞—Ç–µ–ª—å–Ω–æ–µ –¥–ª—è —Å–ø–∏—Å–∞–Ω–∏—è.
        –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–µ–π (commit/rollback) –æ—Å—Ç–∞–µ—Ç—Å—è –∑–∞ –≤—ã–∑—ã–≤–∞—é—â–∏–º —Å–µ—Ä–≤–∏—Å–æ–º.
        """
        # –ò—Å–ø–æ–ª—å–∑—É–µ–º with_for_update() –¥–ª—è –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏ —Å—Ç—Ä–æ–∫–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –Ω–∞ –≤—Ä–µ–º—è —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏,
        # —á—Ç–æ–±—ã –∏–∑–±–µ–∂–∞—Ç—å race conditions –ø—Ä–∏ –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–ø–µ—Ä–∞—Ü–∏—è—Ö.
        result = await self.db.execute(select(User).filter(User.id == user_id).with_for_update())
        user = result.scalars().first()
        if not user:
            logger.error(f"–ü–æ–ø—ã—Ç–∫–∞ –ø—Ä–æ–≤–µ—Å—Ç–∏ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—é –¥–ª—è –Ω–µ—Å—É—â–µ—Å—Ç–≤—É—é—â–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è ID={user_id}")
            raise HTTPException(status_code=status.HTTP_404_NOT_FOUND, detail="–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω.")

        # 1. –°–æ–∑–¥–∞–µ–º –∑–∞–ø–∏—Å—å –≤ –∏—Å—Ç–æ—Ä–∏–∏
        new_history_entry = BalanceHistory(
            user_id=user_id,
            amount=amount,
            operation_type=operation_type,
            description=description,
            rental_id=rental_id
        )
        self.db.add(new_history_entry)

        # 2. –ê—Ç–æ–º–∞—Ä–Ω–æ –æ–±–Ω–æ–≤–ª—è–µ–º –∫—ç—à–∏—Ä–æ–≤–∞–Ω–Ω–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ –±–∞–ª–∞–Ω—Å–∞
        user.balance += amount

        logger.info(f"–¢—Ä–∞–Ω–∑–∞–∫—Ü–∏—è –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è ID={user_id} –Ω–∞ —Å—É–º–º—É {amount} ({operation_type}) –¥–æ–±–∞–≤–ª–µ–Ω–∞ –≤ —Å–µ—Å—Å–∏—é. –ù–æ–≤—ã–π –±–∞–ª–∞–Ω—Å: {user.balance}")
        return new_history_entry

    async def get_balance_for_user(self, user_id: int) -> float:
        """–í–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Ç–µ–∫—É—â–∏–π –±–∞–ª–∞–Ω—Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è."""
        result = await self.db.execute(select(User).filter(User.id == user_id))
        user = result.scalars().first()
        if not user:
            raise HTTPException(status_code=status.HTTP_404_NOT_FOUND, detail="–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω.")
        return user.balance

```


## <a name="RentalAppFASTAPIapiservicesdashboardREADMEmd"></a>`RentalApp_FASTAPI/api/services/dashboard/README.md`

```markdown
// path: RentalApp_FASTAPI/api/services/dashboard/README.md

# Dashboard Services - –†–µ—Ñ–∞–∫—Ç–æ—Ä–∏–Ω–≥

## –û–±–∑–æ—Ä

–§–∞–π–ª `dashboard_service.py` –±—ã–ª —Ä–∞–∑–¥–µ–ª–µ–Ω –Ω–∞ –ª–æ–≥–∏—á–µ—Å–∫–∏ —Å–≤—è–∑–∞–Ω–Ω—ã–µ –º–æ–¥—É–ª–∏ —Å–æ–≥–ª–∞—Å–Ω–æ –ø—Ä–∏–Ω—Ü–∏–ø–∞–º SOLID –∏ DRY.

## –°—Ç—Ä—É–∫—Ç—É—Ä–∞

```
api/services/dashboard/
‚îú‚îÄ‚îÄ __init__.py              # –≠–∫—Å–ø–æ—Ä—Ç –≤—Å–µ—Ö —Å–µ—Ä–≤–∏—Å–æ–≤
‚îú‚îÄ‚îÄ base.py                  # –ë–∞–∑–æ–≤—ã–π –∫–ª–∞—Å—Å —Å –æ–±—â–∏–º–∏ –º–µ—Ç–æ–¥–∞–º–∏
‚îú‚îÄ‚îÄ dashboard_service.py     # –û—Å–Ω–æ–≤–Ω–æ–π —Å–µ—Ä–≤–∏—Å-–∫–æ–æ—Ä–¥–∏–Ω–∞—Ç–æ—Ä
‚îú‚îÄ‚îÄ focus_service.py         # –í–∏–¥–∂–µ—Ç "–°–µ–≥–æ–¥–Ω—è –≤ —Ñ–æ–∫—É—Å–µ"
‚îú‚îÄ‚îÄ kpi_service.py          # KPI –º–µ—Ç—Ä–∏–∫–∏
‚îú‚îÄ‚îÄ activity_service.py     # –õ–µ–Ω—Ç–∞ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏
‚îú‚îÄ‚îÄ equipment_service.py    # –ü–æ–ø—É–ª—è—Ä–Ω–æ–µ –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏–µ
‚îî‚îÄ‚îÄ README.md              # –≠—Ç–∞ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è
```

## –ü—Ä–∏–Ω—Ü–∏–ø—ã SOLID

### Single Responsibility Principle (SRP)
- **FocusService**: –û—Ç–≤–µ—á–∞–µ—Ç —Ç–æ–ª—å–∫–æ –∑–∞ –≤–∏–¥–∂–µ—Ç "–°–µ–≥–æ–¥–Ω—è –≤ —Ñ–æ–∫—É—Å–µ"
- **KpiService**: –û—Ç–≤–µ—á–∞–µ—Ç —Ç–æ–ª—å–∫–æ –∑–∞ —Ä–∞—Å—á–µ—Ç KPI –º–µ—Ç—Ä–∏–∫
- **ActivityService**: –û—Ç–≤–µ—á–∞–µ—Ç —Ç–æ–ª—å–∫–æ –∑–∞ –ª–µ–Ω—Ç—É –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏
- **EquipmentService**: –û—Ç–≤–µ—á–∞–µ—Ç —Ç–æ–ª—å–∫–æ –∑–∞ –ø–æ–ø—É–ª—è—Ä–Ω–æ–µ –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏–µ
- **DashboardService**: –ö–æ–æ—Ä–¥–∏–Ω–∏—Ä—É–µ—Ç —Ä–∞–±–æ—Ç—É –≤—Å–µ—Ö —Å–µ—Ä–≤–∏—Å–æ–≤

### Open/Closed Principle (OCP)
- –ö–∞–∂–¥—ã–π —Å–µ—Ä–≤–∏—Å –ª–µ–≥–∫–æ —Ä–∞—Å—à–∏—Ä—è–µ—Ç—Å—è –Ω–æ–≤—ã–º–∏ –º–µ—Ç–æ–¥–∞–º–∏
- –ë–∞–∑–æ–≤—ã–π –∫–ª–∞—Å—Å –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª—è–µ—Ç –æ–±—â–∏–µ –º–µ—Ç–æ–¥—ã –¥–ª—è –ø–µ—Ä–µ–∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è

### Dependency Inversion Principle (DIP)
- –í—Å–µ —Å–µ—Ä–≤–∏—Å—ã –∑–∞–≤–∏—Å—è—Ç –æ—Ç –∞–±—Å—Ç—Ä–∞–∫—Ü–∏–∏ (AsyncSession)
- –û—Å–Ω–æ–≤–Ω–æ–π —Å–µ—Ä–≤–∏—Å –∏—Å–ø–æ–ª—å–∑—É–µ—Ç –∫–æ–º–ø–æ–∑–∏—Ü–∏—é –≤–º–µ—Å—Ç–æ –Ω–∞—Å–ª–µ–¥–æ–≤–∞–Ω–∏—è

## –ü—Ä–∏–Ω—Ü–∏–ø DRY

### –ü–µ—Ä–µ–∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –∫–æ–¥–∞
- **BaseDashboardService**: –°–æ–¥–µ—Ä–∂–∏—Ç –æ–±—â–∏–µ –º–µ—Ç–æ–¥—ã —Å–æ–∑–¥–∞–Ω–∏—è `TodayFocusItem`
- **–û–±—â–∏–µ –∏–º–ø–æ—Ä—Ç—ã**: –í—ã–Ω–µ—Å–µ–Ω—ã –≤ –±–∞–∑–æ–≤—ã–π –∫–ª–∞—Å—Å
- **–û–±—â–∞—è –ª–æ–≥–∏–∫–∞**: –ü–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ –∑–∞–¥–∞—á –≤ –æ—Å–Ω–æ–≤–Ω–æ–º —Å–µ—Ä–≤–∏—Å–µ

## –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ

### –ò–º–ø–æ—Ä—Ç
```python
from api.services.dashboard import DashboardService
```

### API –æ—Å—Ç–∞–µ—Ç—Å—è –Ω–µ–∏–∑–º–µ–Ω–Ω—ã–º
```python
dashboard_service = DashboardService(db)
summary = await dashboard_service.get_summary()
```

## –ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞ —Ä–µ—Ñ–∞–∫—Ç–æ—Ä–∏–Ω–≥–∞

1. **–ß–∏—Ç–∞–µ–º–æ—Å—Ç—å**: –ö–∞–∂–¥—ã–π —Ñ–∞–π–ª –æ—Ç–≤–µ—á–∞–µ—Ç –∑–∞ –∫–æ–Ω–∫—Ä–µ—Ç–Ω—É—é –æ–±–ª–∞—Å—Ç—å
2. **–¢–µ—Å—Ç–∏—Ä—É–µ–º–æ—Å—Ç—å**: –õ–µ–≥–∫–æ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å –æ—Ç–¥–µ–ª—å–Ω—ã–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã
3. **–†–∞—Å—à–∏—Ä—è–µ–º–æ—Å—Ç—å**: –ü—Ä–æ—Å—Ç–æ–µ –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ –Ω–æ–≤—ã—Ö –º–µ—Ç—Ä–∏–∫ –∏–ª–∏ –≤–∏–¥–∂–µ—Ç–æ–≤
4. **–ü–æ–¥–¥–µ—Ä–∂–∫–∞**: –õ–µ–≥—á–µ –Ω–∞—Ö–æ–¥–∏—Ç—å –∏ –∏—Å–ø—Ä–∞–≤–ª—è—Ç—å –æ—à–∏–±–∫–∏
5. **–ü–µ—Ä–µ–∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ**: –ë–∞–∑–æ–≤—ã–π –∫–ª–∞—Å—Å –º–æ–∂–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –≤ –¥—Ä—É–≥–∏—Ö —Å–µ—Ä–≤–∏—Å–∞—Ö

## –û–±—Ä–∞—Ç–Ω–∞—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å

- API —ç–Ω–¥–ø–æ–∏–Ω—Ç `/admin/dashboard-summary` —Ä–∞–±–æ—Ç–∞–µ—Ç –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π
- –í—Å–µ –∏–º–ø–æ—Ä—Ç—ã –≤ —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–º –∫–æ–¥–µ –æ—Å—Ç–∞—é—Ç—Å—è —Ä–∞–±–æ—á–∏–º–∏
- –§—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç—å –ø–æ–ª–Ω–æ—Å—Ç—å—é —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞


```


## <a name="RentalAppFASTAPIapiservicesdashboardinitpy"></a>`RentalApp_FASTAPI/api/services/dashboard/__init__.py`

```python
// path: RentalApp_FASTAPI/api/services/dashboard/__init__.py

# api/services/dashboard/__init__.py

from .base import BaseDashboardService
from .focus_service import FocusService
from .kpi_service import KpiService
from .activity_service import ActivityService
from .equipment_service import EquipmentService
from .dashboard_service import DashboardService

__all__ = [
    'BaseDashboardService',
    'FocusService', 
    'KpiService',
    'ActivityService',
    'EquipmentService',
    'DashboardService'
]


```


## <a name="RentalAppFASTAPIapiservicesdashboardactivityservicepy"></a>`RentalApp_FASTAPI/api/services/dashboard/activity_service.py`

```python
// path: RentalApp_FASTAPI/api/services/dashboard/activity_service.py

# api/services/dashboard/activity_service.py

from sqlalchemy.ext.asyncio import AsyncSession
from sqlalchemy import select, func, desc, literal_column, union_all
from datetime import datetime, timedelta
from typing import List

from api.models.rental import Rental
from api.models.user import User
from api.models.equipment import Equipment
from shared.schemas.dashboard_schema import ActivityFeedItem
from .base import BaseDashboardService


class ActivityService(BaseDashboardService):
    """–°–µ—Ä–≤–∏—Å –¥–ª—è –ª–µ–Ω—Ç—ã –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ –ø–∞–Ω–µ–ª–∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è."""
    
    async def get_recent_activity(self) -> List[ActivityFeedItem]:
        """–ü–æ–ª—É—á–∞–µ—Ç –ø–æ—Å–ª–µ–¥–Ω–∏–µ —Å–æ–±—ã—Ç–∏—è –≤ —Å–∏—Å—Ç–µ–º–µ."""
        seven_days_ago = datetime.now() - timedelta(days=7)

        # –ó–∞–ø—Ä–æ—Å 1: –ù–æ–≤—ã–µ –∞—Ä–µ–Ω–¥—ã
        new_rentals_q = (
            select(
                Rental.id,
                Rental.created_at.label("timestamp"),
                literal_column("'rental_started'").label("activity_type"),
                User.full_name.label("user_name"),
                func.string_agg(Equipment.name, ', ').label("equipment_name")
            )
            .join(User, Rental.user_id == User.id)
            .join(Rental.equipment)
            .where(Rental.created_at >= seven_days_ago)
            .group_by(Rental.id, User.full_name, Rental.created_at)
        )
        
        # –ó–∞–ø—Ä–æ—Å 2: –ù–æ–≤—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏
        new_users_q = (
            select(
                User.id,
                User.created_at.label("timestamp"),
                literal_column("'user_registered'").label("activity_type"),
                User.full_name.label("user_name"),
                literal_column("NULL").label("equipment_name")
            )
            .where(User.created_at >= seven_days_ago)
        )

        # –û–±—ä–µ–¥–∏–Ω—è–µ–º –∑–∞–ø—Ä–æ—Å—ã
        combined_query = union_all(new_rentals_q, new_users_q).order_by(desc("timestamp")).limit(10)
        
        result = await self.db.execute(combined_query)
        
        activities = []
        for row in result.mappings().all():
            description = ""
            if row.activity_type == 'rental_started':
                description = f"–ù–æ–≤–∞—è –∞—Ä–µ–Ω–¥–∞ –¥–ª—è {row.user_name}"
            elif row.activity_type == 'user_registered':
                description = f"–ù–æ–≤—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: {row.user_name}"
            
            activities.append(ActivityFeedItem(
                id=row.id, 
                timestamp=row.timestamp, 
                activity_type=row.activity_type,
                description=description, 
                user_name=row.user_name, 
                equipment_name=row.equipment_name
            ))
        return activities


```


## <a name="RentalAppFASTAPIapiservicesdashboardbasepy"></a>`RentalApp_FASTAPI/api/services/dashboard/base.py`

```python
// path: RentalApp_FASTAPI/api/services/dashboard/base.py

# api/services/dashboard/base.py

from sqlalchemy.ext.asyncio import AsyncSession
from datetime import datetime, date
from typing import List

from api.models.rental import Rental
from api.models.reservation import Reservation
from shared.schemas.dashboard_schema import TodayFocusItem


class BaseDashboardService:
    """–ë–∞–∑–æ–≤—ã–π –∫–ª–∞—Å—Å –¥–ª—è —Å–µ—Ä–≤–∏—Å–æ–≤ –ø–∞–Ω–µ–ª–∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è —Å –æ–±—â–∏–º–∏ –º–µ—Ç–æ–¥–∞–º–∏."""
    
    def __init__(self, db: AsyncSession):
        self.db = db

    def _create_today_focus_item_from_reservation(self, reservation: Reservation, start_date: date = None) -> TodayFocusItem:
        """–°–æ–∑–¥–∞–µ—Ç TodayFocusItem –∏–∑ —Ä–µ–∑–µ—Ä–≤–∞—Ü–∏–∏."""
        return TodayFocusItem(
            id=reservation.id,
            user_name=reservation.user.full_name,
            details=f"{len(reservation.equipment)} –ø–æ–∑–∏—Ü–∏–π",
            user_id=reservation.user_id,
            order_type='reservation',
            scheduled_time=datetime.combine(reservation.start_date, datetime.min.time()),
            start_date=start_date or reservation.start_date
        )

    def _create_today_focus_item_from_rental(
        self, 
        rental: Rental, 
        details: str, 
        due_date: date = None, 
        days_overdue: int = None
    ) -> TodayFocusItem:
        """–°–æ–∑–¥–∞–µ—Ç TodayFocusItem –∏–∑ –∞—Ä–µ–Ω–¥—ã."""
        return TodayFocusItem(
            id=rental.id,
            user_name=rental.user.full_name,
            details=details,
            user_id=rental.user_id,
            order_type='rental',
            scheduled_time=datetime.combine(rental.end_date, datetime.min.time()),
            due_date=due_date,
            days_overdue=days_overdue
        )


```


## <a name="RentalAppFASTAPIapiservicesdashboarddashboardservicepy"></a>`RentalApp_FASTAPI/api/services/dashboard/dashboard_service.py`

```python
// path: RentalApp_FASTAPI/api/services/dashboard/dashboard_service.py

# api/services/dashboard/dashboard_service.py

from sqlalchemy.ext.asyncio import AsyncSession
import asyncio
import logging

from shared.schemas.dashboard_schema import DashboardSummaryResponse
from .focus_service import FocusService
from .kpi_service import KpiService
from .activity_service import ActivityService
from .equipment_service import EquipmentService

logger = logging.getLogger(__name__)


class DashboardService:
    """–û—Å–Ω–æ–≤–Ω–æ–π —Å–µ—Ä–≤–∏—Å –¥–ª—è —Å–±–æ—Ä–∞ –∞–≥—Ä–µ–≥–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –ø–∞–Ω–µ–ª–∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –∞–¥–º–∏–Ω–∫–∏."""

    def __init__(self, db: AsyncSession):
        self.db = db
        # –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º —Å–ø–µ—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ —Å–µ—Ä–≤–∏—Å—ã
        self.focus_service = FocusService(db)
        self.kpi_service = KpiService(db)
        self.activity_service = ActivityService(db)
        self.equipment_service = EquipmentService(db)

    async def get_summary(self) -> DashboardSummaryResponse:
        """–ü–æ–ª—É—á–∞–µ—Ç —Å–≤–æ–¥–Ω—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –¥–ª—è –ø–∞–Ω–µ–ª–∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è."""
        try:
            # –°–æ–±–∏—Ä–∞–µ–º –≤—Å–µ –¥–∞–Ω–Ω—ã–µ –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ –¥–ª—è –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏
            # –ì—Ä—É–ø–ø–∏—Ä—É–µ–º –∑–∞–¥–∞—á–∏ –ø–æ —Ç–∏–ø–∞–º –¥–ª—è –ª—É—á—à–µ–π –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏–∏
            focus_tasks = [
                self.focus_service.get_pickups_today(),
                self.focus_service.get_returns_today(),
                self.focus_service.get_overdue_rentals()
            ]
            
            other_tasks = [
                self.activity_service.get_recent_activity(),
                self.equipment_service.get_popular_equipment()
            ]
            
            # –í—ã–ø–æ–ª–Ω—è–µ–º –∑–∞–¥–∞—á–∏ –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ
            focus_results = await asyncio.gather(*focus_tasks)
            kpi_data = await self.kpi_service.get_kpi_data()
            other_results = await asyncio.gather(*other_tasks)

            return DashboardSummaryResponse(
                pickups_today=focus_results[0],
                returns_today=focus_results[1],
                overdue_rentals=focus_results[2],
                kpi=kpi_data,
                recent_activity=other_results[0],
                popular_equipment=other_results[1]
            )
        except Exception as e:
            logger.error(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ —Å–≤–æ–¥–Ω–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏: {e}", exc_info=True)
            raise


```


## <a name="RentalAppFASTAPIapiservicesdashboardequipmentservicepy"></a>`RentalApp_FASTAPI/api/services/dashboard/equipment_service.py`

```python
// path: RentalApp_FASTAPI/api/services/dashboard/equipment_service.py

# api/services/dashboard/equipment_service.py

from sqlalchemy.ext.asyncio import AsyncSession
from sqlalchemy import select, func, desc
from datetime import date, timedelta
from typing import List
import logging

from api.models.rental import Rental
from api.models.equipment import Equipment
from shared.schemas.dashboard_schema import PopularEquipmentItem
from .base import BaseDashboardService

logger = logging.getLogger(__name__)


class EquipmentService(BaseDashboardService):
    """–°–µ—Ä–≤–∏—Å –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –ø–æ–ø—É–ª—è—Ä–Ω—ã–º –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏–µ–º –ø–∞–Ω–µ–ª–∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è."""
    
    async def get_popular_equipment(self) -> List[PopularEquipmentItem]:
        """–ü–æ–ª—É—á–∞–µ—Ç —Ç–æ–ø-10 —Å–∞–º–æ–≥–æ –ø–æ–ø—É–ª—è—Ä–Ω–æ–≥–æ –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—è —Å –≤—ã—Ä—É—á–∫–æ–π."""
        try:
            thirty_days_ago = date.today() - timedelta(days=30)
            query = (
                select(
                    Equipment.id.label("equipment_id"),
                    Equipment.name.label("equipment_name"),
                    func.count(Rental.id).label("rental_count"),
                    func.sum(Rental.total_cost).label("revenue")
                )
                .join(Rental.equipment)
                .where(Rental.created_at >= thirty_days_ago)
                .group_by(Equipment.id, Equipment.name)
                .order_by(desc("rental_count"))
                .limit(10)
            )
            result = await self.db.execute(query)
            return [PopularEquipmentItem.model_validate(row) for row in result.mappings().all()]
            
        except Exception as e:
            logger.error(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ –ø–æ–ø—É–ª—è—Ä–Ω–æ–≥–æ –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—è: {e}", exc_info=True)
            # –í–æ–∑–≤—Ä–∞—â–∞–µ–º –ø—É—Å—Ç–æ–π —Å–ø–∏—Å–æ–∫ –≤ —Å–ª—É—á–∞–µ –æ—à–∏–±–∫–∏
            return []


```


## <a name="RentalAppFASTAPIapiservicesdashboardfocusservicepy"></a>`RentalApp_FASTAPI/api/services/dashboard/focus_service.py`

```python
// path: RentalApp_FASTAPI/api/services/dashboard/focus_service.py


# api/services/dashboard/focus_service.py

from sqlalchemy.ext.asyncio import AsyncSession
from sqlalchemy.orm import joinedload, selectinload
from sqlalchemy import select, and_
from datetime import date
from typing import List

from api.models.rental import Rental
from api.models.reservation import Reservation
from shared.schemas.dashboard_schema import TodayFocusItem
from .base import BaseDashboardService


class FocusService(BaseDashboardService):
    """–°–µ—Ä–≤–∏—Å –¥–ª—è –≤–∏–¥–∂–µ—Ç–∞ '–°–µ–≥–æ–¥–Ω—è –≤ —Ñ–æ–∫—É—Å–µ' - –≤—ã–¥–∞—á–∏, –≤–æ–∑–≤—Ä–∞—Ç—ã, –ø—Ä–æ—Å—Ä–æ—á–∫–∏."""
    
    async def get_pickups_today(self) -> List[TodayFocusItem]:
        """–ü–æ–ª—É—á–∞–µ—Ç –∞–∫—Ç–∏–≤–Ω—ã–µ —Ä–µ–∑–µ—Ä–≤–∞—Ü–∏–∏ –¥–ª—è –≤—ã–¥–∞—á–∏ (–Ω–µ –ø—Ä–æ—Å—Ä–æ—á–µ–Ω–Ω—ã–µ –∏ –Ω–µ –≤—ã–¥–∞–Ω–Ω—ã–µ)."""
        today = date.today()
        
        query = select(Reservation).options(
            joinedload(Reservation.user),
            selectinload(Reservation.equipment)
        ).filter(
            and_(
                Reservation.start_date <= today,
                Reservation.end_date >= today,
                Reservation.status == 'active'
            )
        )

        result = await self.db.execute(query)
        reservations = result.unique().scalars().all()

        return [self._create_today_focus_item_from_reservation(reservation, reservation.start_date) for reservation in reservations]

    async def get_returns_today(self) -> List[TodayFocusItem]:
        """–ü–æ–ª—É—á–∞–µ—Ç –∞—Ä–µ–Ω–¥—ã –Ω–∞ —Å–µ–≥–æ–¥–Ω—è –¥–ª—è –≤–æ–∑–≤—Ä–∞—Ç–∞."""
        today = date.today()
        
        query = select(Rental).options(
            joinedload(Rental.user),
            selectinload(Rental.equipment)
        ).filter(
            and_(
                Rental.end_date == today,
                Rental.status == 'active'
            )
        )

        result = await self.db.execute(query)
        rentals = result.unique().scalars().all()

        return [
            self._create_today_focus_item_from_rental(
                rental, 
                f"–û—Å—Ç–∞—Ç–æ–∫: {rental.total_cost - rental.prepayment_amount:.0f} ‚ÇΩ"
            ) 
            for rental in rentals
        ]

    async def get_overdue_rentals(self) -> List[TodayFocusItem]:
        """–ü–æ–ª—É—á–∞–µ—Ç –ø—Ä–æ—Å—Ä–æ—á–µ–Ω–Ω—ã–µ –∞—Ä–µ–Ω–¥—ã."""
        today = date.today()
        
        query = select(Rental).options(
            joinedload(Rental.user),
            selectinload(Rental.equipment)
        ).filter(
            and_(
                Rental.end_date < today,
                Rental.status == 'active'
            )
        )

        result = await self.db.execute(query)
        rentals = result.unique().scalars().all()

        result_items = []
        for rental in rentals:
            days_overdue = (today - rental.end_date).days
            remaining_amount = rental.total_cost - rental.prepayment_amount
            
            item = self._create_today_focus_item_from_rental(
                rental,
                f"{len(rental.equipment)} –ø–æ–∑., –æ—Å—Ç–∞—Ç–æ–∫: {remaining_amount:.0f} ‚ÇΩ",
                due_date=rental.end_date,
                days_overdue=days_overdue
            )
            result_items.append(item)
        
        return result_items


```


## <a name="RentalAppFASTAPIapiservicesdashboardkpiservicepy"></a>`RentalApp_FASTAPI/api/services/dashboard/kpi_service.py`

```python
// path: RentalApp_FASTAPI/api/services/dashboard/kpi_service.py

# api/services/dashboard/kpi_service.py

from sqlalchemy.ext.asyncio import AsyncSession
from sqlalchemy.orm import joinedload, selectinload
from sqlalchemy import select, func, and_
from datetime import date, timedelta
import asyncio

from api.models.rental import Rental, rental_equipment_association
from api.models.reservation import Reservation, reservation_equipment_association
from api.models.user import User
from api.models.equipment import Equipment
from shared.schemas.dashboard_schema import KpiData
from .base import BaseDashboardService


class KpiService(BaseDashboardService):
    """–°–µ—Ä–≤–∏—Å –¥–ª—è —Ä–∞—Å—á–µ—Ç–∞ KPI –º–µ—Ç—Ä–∏–∫ –ø–∞–Ω–µ–ª–∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è."""
    
    async def get_total_users(self) -> int:
        """–ü–æ–ª—É—á–∞–µ—Ç –æ–±—â–µ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π."""
        query = select(func.count(User.id))
        result = await self.db.execute(query)
        return int(result.scalar_one())

    async def get_active_users(self) -> int:
        """–ü–æ–ª—É—á–∞–µ—Ç –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∞–∫—Ç–∏–≤–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π (—Å —Ä–µ–∑–µ—Ä–≤–∞—Ü–∏—è–º–∏ –∏–ª–∏ –∞—Ä–µ–Ω–¥–∞–º–∏ –∑–∞ –ø–æ—Å–ª–µ–¥–Ω–∏–µ 30 –¥–Ω–µ–π)."""
        thirty_days_ago = date.today() - timedelta(days=30)
        
        # –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ —Å –∞–∫—Ç–∏–≤–Ω—ã–º–∏ —Ä–µ–∑–µ—Ä–≤–∞—Ü–∏—è–º–∏
        active_reservations_query = select(User.id).join(
            Reservation, User.id == Reservation.user_id
        ).filter(
            and_(
                Reservation.created_at >= thirty_days_ago,
                Reservation.status.in_(['active', 'completed'])
            )
        )
        
        # –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ —Å –∞–∫—Ç–∏–≤–Ω—ã–º–∏ –∞—Ä–µ–Ω–¥–∞–º–∏
        active_rentals_query = select(User.id).join(
            Rental, User.id == Rental.user_id
        ).filter(
            and_(
                Rental.created_at >= thirty_days_ago,
                Rental.status.in_(['active', 'completed'])
            )
        )
        
        # –û–±—ä–µ–¥–∏–Ω—è–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã
        reservations_result = await self.db.execute(active_reservations_query)
        rentals_result = await self.db.execute(active_rentals_query)
        
        active_user_ids = set()
        for row in reservations_result:
            active_user_ids.add(row.id)
        for row in rentals_result:
            active_user_ids.add(row.id)
            
        return len(active_user_ids)

    async def get_total_equipment(self) -> int:
        """–ü–æ–ª—É—á–∞–µ—Ç –æ–±—â–µ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—è."""
        query = select(func.count(Equipment.id))
        result = await self.db.execute(query)
        return int(result.scalar_one())

    async def get_total_reservations(self) -> int:
        """–ü–æ–ª—É—á–∞–µ—Ç –æ–±—â–µ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ä–µ–∑–µ—Ä–≤–∞—Ü–∏–π."""
        query = select(func.count(Reservation.id))
        result = await self.db.execute(query)
        return int(result.scalar_one())

    async def get_revenue_today(self) -> float:
        """–ü–æ–ª—É—á–∞–µ—Ç –¥–æ—Ö–æ–¥ –∑–∞ —Å–µ–≥–æ–¥–Ω—è."""
        today = date.today()
        
        query = select(func.coalesce(func.sum(Rental.final_cost), 0)).filter(
            and_(
                Rental.status == 'completed',
                func.date(Rental.actual_return_date) == today
            )
        )

        result = await self.db.execute(query)
        return float(result.scalar_one())

    async def get_revenue_this_month(self) -> float:
        """–ü–æ–ª—É—á–∞–µ—Ç –¥–æ—Ö–æ–¥ –∑–∞ —Ç–µ–∫—É—â–∏–π –º–µ—Å—è—Ü."""
        today = date.today()
        first_day_of_month = today.replace(day=1)
        
        query = select(func.coalesce(func.sum(Rental.final_cost), 0)).filter(
            and_(
                Rental.status == 'completed',
                Rental.actual_return_date >= first_day_of_month,
                Rental.actual_return_date <= today
            )
        )

        result = await self.db.execute(query)
        return float(result.scalar_one())

    async def get_occupancy_rate(self) -> float:
        """–†–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ—Ç –∫–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç –∑–∞–≥—Ä—É–∂–µ–Ω–Ω–æ—Å—Ç–∏ –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—è."""
        today = date.today()
        
        # –ü–æ–ª—É—á–∞–µ–º –æ–±—â–µ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—è
        total_equipment_query = select(func.count(Equipment.id))
        total_result = await self.db.execute(total_equipment_query)
        total_equipment = total_result.scalar_one()

        if total_equipment == 0:
            return 0.0

        # –ü–æ–ª—É—á–∞–µ–º —É–Ω–∏–∫–∞–ª—å–Ω–æ–µ –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏–µ –∏–∑ –∞–∫—Ç–∏–≤–Ω—ã—Ö —Ä–µ–∑–µ—Ä–≤–∞—Ü–∏–π
        active_reservations_query = select(reservation_equipment_association.c.equipment_id).join(
            Reservation, 
            reservation_equipment_association.c.reservation_id == Reservation.id
        ).filter(
            and_(
                Reservation.start_date <= today,
                Reservation.end_date >= today,
                Reservation.status == 'active'
            )
        )
        
        reservations_result = await self.db.execute(active_reservations_query)
        reservation_equipment_ids = set(row.equipment_id for row in reservations_result)
        
        # –ü–æ–ª—É—á–∞–µ–º —É–Ω–∏–∫–∞–ª—å–Ω–æ–µ –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏–µ –∏–∑ –∞–∫—Ç–∏–≤–Ω—ã—Ö –∞—Ä–µ–Ω–¥
        active_rentals_query = select(rental_equipment_association.c.equipment_id).join(
            Rental,
            rental_equipment_association.c.rental_id == Rental.id
        ).filter(
            and_(
                Rental.start_date <= today,
                Rental.end_date >= today,
                Rental.status == 'active'
            )
        )
        
        rentals_result = await self.db.execute(active_rentals_query)
        rental_equipment_ids = set(row.equipment_id for row in rentals_result)
        
        # –û–±—ä–µ–¥–∏–Ω—è–µ–º –∏ —Å—á–∏—Ç–∞–µ–º —É–Ω–∏–∫–∞–ª—å–Ω–æ–µ –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏–µ
        unique_equipment_ids = reservation_equipment_ids.union(rental_equipment_ids)
        unique_equipment = len(unique_equipment_ids)

        return (unique_equipment / total_equipment) * 100

    async def get_avg_rental_duration(self) -> float:
        """–†–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ—Ç —Å—Ä–µ–¥–Ω—é—é –ø—Ä–æ–¥–æ–ª–∂–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å –∞—Ä–µ–Ω–¥—ã –≤ –¥–Ω—è—Ö."""
        # –î–ª—è PostgreSQL –∏—Å–ø–æ–ª—å–∑—É–µ–º –ø—Ä–æ—Å—Ç–æ–µ –≤—ã—á–∏—Ç–∞–Ω–∏–µ –¥–∞—Ç —Ç–∏–ø–∞ DATE
        # –≠—Ç–æ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –¥–Ω–µ–π –∫–∞–∫ integer
        query = select(func.avg(
            Rental.actual_return_date - Rental.start_date
        )).filter(
            and_(
                Rental.status == 'completed',
                Rental.actual_return_date.isnot(None)
            )
        )

        result = await self.db.execute(query)
        avg_duration = result.scalar_one()
        return float(avg_duration) if avg_duration is not None else 0.0

    async def get_kpi_data(self) -> KpiData:
        """–ü–æ–ª—É—á–∞–µ—Ç –≤—Å–µ KPI –¥–∞–Ω–Ω—ã–µ –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ."""
        # –í—ã–ø–æ–ª–Ω—è–µ–º –≤—Å–µ KPI –∑–∞–ø—Ä–æ—Å—ã –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ
        results = await asyncio.gather(
            self.get_total_users(),
            self.get_active_users(),
            self.get_total_equipment(),
            self.get_total_reservations(),
            self.get_revenue_today(),
            self.get_revenue_this_month(),
            self.get_occupancy_rate(),
            self.get_avg_rental_duration()
        )
        
        return KpiData(
            total_users=results[0],
            active_users=results[1],
            total_equipment=results[2],
            total_reservations=results[3],
            revenue_today=results[4],
            revenue_this_month=results[5],
            occupancy_rate=results[6],
            avg_rental_duration=results[7]
        )


```


## <a name="RentalAppFASTAPIapiservicesdashboardservicepy"></a>`RentalApp_FASTAPI/api/services/dashboard_service.py`

```python
// path: RentalApp_FASTAPI/api/services/dashboard_service.py

# api/services/dashboard_service.py

# –ò–º–ø–æ—Ä—Ç–∏—Ä—É–µ–º –Ω–æ–≤—ã–π —Ä–µ—Ñ–∞–∫—Ç–æ—Ä–µ–Ω–Ω—ã–π —Å–µ—Ä–≤–∏—Å
from .dashboard.dashboard_service import DashboardService


```


## <a name="RentalAppFASTAPIapiservicesdiscountservicepy"></a>`RentalApp_FASTAPI/api/services/discount_service.py`

```python
// path: RentalApp_FASTAPI/api/services/discount_service.py

# api/services/discount_service.py

from sqlalchemy.ext.asyncio import AsyncSession
from sqlalchemy import desc, select
from api.models.discount import DurationDiscount

async def get_duration_discount_percentage(db: AsyncSession, days: int) -> int:
    """
    –ü–æ–ª—É—á–∞–µ—Ç –ø—Ä–æ—Ü–µ–Ω—Ç —Å–∫–∏–¥–∫–∏ –∑–∞ –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å –∞—Ä–µ–Ω–¥—ã –∏–∑ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö.
    –ù–∞—Ö–æ–¥–∏—Ç –Ω–∞–∏–±–æ–ª–µ–µ –ø–æ–¥—Ö–æ–¥—è—â—É—é —Å–∫–∏–¥–∫—É –¥–ª—è –∑–∞–¥–∞–Ω–Ω–æ–≥–æ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ –¥–Ω–µ–π.
    """
    if days <= 0:
        return 0

    # –ò—â–µ–º –Ω–∞–∏–±–æ–ª–µ–µ –ø–æ–¥—Ö–æ–¥—è—â—É—é –∑–∞–ø–∏—Å—å –æ —Å–∫–∏–¥–∫–µ,
    # –≥–¥–µ min_days –Ω–µ –ø—Ä–µ–≤—ã—à–∞–µ—Ç –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –¥–Ω–µ–π –∞—Ä–µ–Ω–¥—ã.
    # –°–æ—Ä—Ç–∏—Ä—É–µ–º –ø–æ —É–±—ã–≤–∞–Ω–∏—é, —á—Ç–æ–±—ã –ø–µ—Ä–≤–æ–π –Ω–∞–π—Ç–∏ —Å–∞–º—É—é –±–æ–ª—å—à—É—é –ø–æ–¥—Ö–æ–¥—è—â—É—é —Å–∫–∏–¥–∫—É.
    result = await db.execute(
        select(DurationDiscount)
        .filter(DurationDiscount.min_days <= days)
        .order_by(desc(DurationDiscount.min_days))
    )
    discount = result.scalars().first()

    if discount:
        return discount.discount_percentage

    return 0

```


## <a name="RentalAppFASTAPIapiservicesequipmentquerybuilderpy"></a>`RentalApp_FASTAPI/api/services/equipment_query_builder.py`

```python
// path: RentalApp_FASTAPI/api/services/equipment_query_builder.py

# api/services/equipment_query_builder.py

from typing import Optional, List
from sqlalchemy.ext.asyncio import AsyncSession
from sqlalchemy.orm import selectinload
from sqlalchemy import or_, and_, select, func
from datetime import date

from api.models.equipment import Equipment
from api.models.association import Association


class EquipmentQueryBuilder:
    """
    –ö–ª–∞—Å—Å –¥–ª—è –ø–æ—Å—Ç—Ä–æ–µ–Ω–∏—è –∑–∞–ø—Ä–æ—Å–æ–≤ –∫ –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—é —Å –ø–æ–¥–¥–µ—Ä–∂–∫–æ–π —Ä–∞–∑–ª–∏—á–Ω—ã—Ö —Ñ–∏–ª—å—Ç—Ä–æ–≤.
    –†–µ–∞–ª–∏–∑—É–µ—Ç –ø–∞—Ç—Ç–µ—Ä–Ω Builder –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è —Å–ª–æ–∂–Ω—ã—Ö SQL-–∑–∞–ø—Ä–æ—Å–æ–≤.
    """

    def __init__(self, db_session: AsyncSession):
        """
        –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –±–∏–ª–¥–µ—Ä–∞ –∑–∞–ø—Ä–æ—Å–æ–≤.

        Args:
            db_session: –°–µ—Å—Å–∏—è SQLAlchemy –¥–ª—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –∑–∞–ø—Ä–æ—Å–æ–≤
        """
        self.db_session = db_session
        # –°–æ–∑–¥–∞–µ–º –±–∞–∑–æ–≤—ã–π –∑–∞–ø—Ä–æ—Å –æ–¥–∏–Ω —Ä–∞–∑ –ø—Ä–∏ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏
        self.query = self._get_base_query()

    def _get_base_query(self):
        """
        –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç –±–∞–∑–æ–≤—ã–π –∑–∞–ø—Ä–æ—Å —Å –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã–º–∏ options –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏ —Å–≤—è–∑–∞–Ω–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö.

        Returns:
            –ë–∞–∑–æ–≤—ã–π select –∑–∞–ø—Ä–æ—Å –¥–ª—è Equipment
        """
        return select(Equipment).options(
            selectinload(Equipment.accessories),
            selectinload(Equipment.associations)
        )

    def apply_search(self, query_str: str):
        """
        –ü—Ä–∏–º–µ–Ω—è–µ—Ç —Ç–µ–∫—Å—Ç–æ–≤—ã–π –ø–æ–∏—Å–∫ –ø–æ –Ω–∞–∑–≤–∞–Ω–∏—é, –±—Ä–µ–Ω–¥—É –∏ —Ç–∏–ø—É –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—è.

        Args:
            query_str: –°—Ç—Ä–æ–∫–∞ –ø–æ–∏—Å–∫–∞

        Returns:
            self –¥–ª—è –ø–æ–¥–¥–µ—Ä–∂–∫–∏ —Ü–µ–ø–æ—á–∫–∏ –≤—ã–∑–æ–≤–æ–≤
        """
        if query_str:
            search_term = f"%{query_str.lower()}%"
            self.query = self.query.filter(
                or_(
                    Equipment.name.ilike(search_term),
                    Equipment.brand.ilike(search_term),
                    Equipment.equipment_type.ilike(search_term)
                )
            )
        return self

    def apply_type(self, equipment_type: str):
        """
        –ü—Ä–∏–º–µ–Ω—è–µ—Ç —Ñ–∏–ª—å—Ç—Ä –ø–æ —Ç–∏–ø—É –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—è.

        Args:
            equipment_type: –¢–∏–ø –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—è –¥–ª—è —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏

        Returns:
            self –¥–ª—è –ø–æ–¥–¥–µ—Ä–∂–∫–∏ —Ü–µ–ø–æ—á–∫–∏ –≤—ã–∑–æ–≤–æ–≤
        """
        if equipment_type:
            self.query = self.query.filter(Equipment.equipment_type == equipment_type)
        return self

    def apply_brand(self, brand: str):
        """
        –ü—Ä–∏–º–µ–Ω—è–µ—Ç —Ñ–∏–ª—å—Ç—Ä –ø–æ –±—Ä–µ–Ω–¥—É –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—è.

        Args:
            brand: –ë—Ä–µ–Ω–¥ –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—è –¥–ª—è —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏

        Returns:
            self –¥–ª—è –ø–æ–¥–¥–µ—Ä–∂–∫–∏ —Ü–µ–ø–æ—á–∫–∏ –≤—ã–∑–æ–≤–æ–≤
        """
        if brand and brand != "__all__":
            self.query = self.query.filter(Equipment.brand == brand)
        return self

    def apply_association(self, association_id: int):
        """
        –ü—Ä–∏–º–µ–Ω—è–µ—Ç —Ñ–∏–ª—å—Ç—Ä –ø–æ –∞—Å—Å–æ—Ü–∏–∞—Ü–∏–∏.

        Args:
            association_id: ID –∞—Å—Å–æ—Ü–∏–∞—Ü–∏–∏ –¥–ª—è —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏

        Returns:
            self –¥–ª—è –ø–æ–¥–¥–µ—Ä–∂–∫–∏ —Ü–µ–ø–æ—á–∫–∏ –≤—ã–∑–æ–≤–æ–≤
        """
        if association_id:
            self.query = self.query.join(Equipment.associations).filter(Association.id == association_id)
        return self

    def apply_availability(self, start_date: date, end_date: date, exclude_reservation_id: int | None = None, exclude_rental_id: int | None = None):
        """
        –ü—Ä–∏–º–µ–Ω—è–µ—Ç —Ñ–∏–ª—å—Ç—Ä –ø–æ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏ –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—è –≤ —É–∫–∞–∑–∞–Ω–Ω—ã–π –ø–µ—Ä–∏–æ–¥.
        –ò—Å–ø–æ–ª—å–∑—É–µ—Ç AvailabilityService –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è SQLAlchemy —Ñ–∏–ª—å—Ç—Ä–∞.

        Args:
            start_date: –î–∞—Ç–∞ –Ω–∞—á–∞–ª–∞ –ø–µ—Ä–∏–æ–¥–∞
            end_date: –î–∞—Ç–∞ –æ–∫–æ–Ω—á–∞–Ω–∏—è –ø–µ—Ä–∏–æ–¥–∞
            exclude_reservation_id: ID —Ä–µ–∑–µ—Ä–≤–∏—Ä–æ–≤–∞–Ω–∏—è –¥–ª—è –∏—Å–∫–ª—é—á–µ–Ω–∏—è
            exclude_rental_id: ID –∞—Ä–µ–Ω–¥—ã –¥–ª—è –∏—Å–∫–ª—é—á–µ–Ω–∏—è

        Returns:
            self –¥–ª—è –ø–æ–¥–¥–µ—Ä–∂–∫–∏ —Ü–µ–ø–æ—á–∫–∏ –≤—ã–∑–æ–≤–æ–≤
        """
        if not start_date or not end_date:
            return self

        # –ò—Å–ø–æ–ª—å–∑—É–µ–º AvailabilityService –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è —Ñ–∏–ª—å—Ç—Ä–∞
        from api.services.availability import AvailabilityService
        availability_service = AvailabilityService(self.db_session)
        
        availability_filter = availability_service.get_sqlalchemy_filter_for_available_equipment(
            start_date, end_date, exclude_reservation_id, exclude_rental_id
        )
        
        self.query = self.query.filter(availability_filter)
        return self

    async def count(self) -> int:
        """
        –í—ã–ø–æ–ª–Ω—è–µ—Ç –ø–æ–¥—Å—á–µ—Ç –æ–±—â–µ–≥–æ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ –∑–∞–ø–∏—Å–µ–π –ø–æ –ø–æ—Å—Ç—Ä–æ–µ–Ω–Ω–æ–º—É –∑–∞–ø—Ä–æ—Å—É.

        Returns:
            –û–±—â–µ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∑–∞–ø–∏—Å–µ–π
        """
        count_query = select(func.count()).select_from(self.query.subquery())
        result = await self.db_session.execute(count_query)
        return result.scalar_one()

    async def paginate(self, skip: int, limit: int) -> List[Equipment]:
        """
        –í—ã–ø–æ–ª–Ω—è–µ—Ç –ø–∞–≥–∏–Ω–∞—Ü–∏—é –∑–∞–ø—Ä–æ—Å–∞ –∏ –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Å–ø–∏—Å–æ–∫ –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—è.

        Args:
            skip: –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –∑–∞–ø–∏—Å–µ–π –¥–ª—è –ø—Ä–æ–ø—É—Å–∫–∞
            limit: –ú–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∑–∞–ø–∏—Å–µ–π –¥–ª—è –≤–æ–∑–≤—Ä–∞—Ç–∞

        Returns:
            –°–ø–∏—Å–æ–∫ –æ–±—ä–µ–∫—Ç–æ–≤ Equipment
        """
        paginated_query = self.query.order_by(Equipment.name).offset(skip).limit(limit)
        result = await self.db_session.execute(paginated_query)
        return result.unique().scalars().all()

```


## <a name="RentalAppFASTAPIapiservicesequipmentserviceapipy"></a>`RentalApp_FASTAPI/api/services/equipment_service_api.py`

```python
// path: RentalApp_FASTAPI/api/services/equipment_service_api.py

# api/services/equipment_service_api.py

from typing import List, Type, Optional
from sqlalchemy.ext.asyncio import AsyncSession
from sqlalchemy.orm import joinedload, selectinload
from sqlalchemy import or_, and_, select, func
from fastapi import HTTPException
from datetime import date

from api.models.equipment import Equipment
from api.models.accessory import Accessory
from api.models.association import Association
from api.models.reservation import Reservation
from api.models.rental import Rental
from shared.schemas.equipment_schema import EquipmentUpdateExtended
from api.services.equipment_query_builder import EquipmentQueryBuilder

async def get_all_equipment(db: AsyncSession) -> list[Type[Equipment]]:
    """–í–æ–∑–≤—Ä–∞—â–∞–µ—Ç QuerySet –≤—Å–µ–≥–æ –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—è —Å –ø–æ–¥–≥—Ä—É–∑–∫–æ–π —Å–≤—è–∑–µ–π."""
    result = await db.execute(
        select(Equipment).options(
            joinedload(Equipment.accessories),
            joinedload(Equipment.associations)
        )
    )
    equipment_list = result.unique().scalars().all()
    
    # –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –∑–∞—â–∏—Ç–∞: —É–±–µ–∂–¥–∞–µ–º—Å—è, —á—Ç–æ –≤—Å–µ –ø–æ–ª—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã
    for equipment in equipment_list:
        if equipment.name is None:
            equipment.name = "–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ–µ –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏–µ"
        if equipment.daily_rate is None:
            equipment.daily_rate = 0.0
        if equipment.condition is None:
            equipment.condition = "–í–µ–ª–∏–∫–æ–ª–µ–ø–Ω–æ"
    
    return equipment_list


async def get_paginated_equipment(
        db: AsyncSession,
        skip: int,
        limit: int,
        query: Optional[str] = None,
        type: Optional[str] = None,
        brand: Optional[str] = None,
        association_id: Optional[int] = None,
        start_date: Optional[date] = None,
        end_date: Optional[date] = None,
        available_only: bool = False
) -> (List[Equipment], int):
    """
    –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç –æ—Ç—Ñ–∏–ª—å—Ç—Ä–æ–≤–∞–Ω–Ω—ã–π –∏ –ø–∞–≥–∏–Ω–∏—Ä–æ–≤–∞–Ω–Ω—ã–π —Å–ø–∏—Å–æ–∫ –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—è –∏ –∏—Ö –æ–±—â–µ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ.
    –ò—Å–ø–æ–ª—å–∑—É–µ—Ç EquipmentQueryBuilder –¥–ª—è –ø–æ—Å—Ç—Ä–æ–µ–Ω–∏—è –∑–∞–ø—Ä–æ—Å–æ–≤ —Å —Ä–∞–∑–ª–∏—á–Ω—ã–º–∏ —Ñ–∏–ª—å—Ç—Ä–∞–º–∏.
    """
    # –í–∞–ª–∏–¥–∞—Ü–∏—è –¥–∞—Ç –Ω–∞ —É—Ä–æ–≤–Ω–µ —Å–µ—Ä–≤–∏—Å–∞
    if available_only and start_date and end_date:
        if start_date >= end_date:
            raise HTTPException(
                status_code=400, 
                detail="–î–∞—Ç–∞ –Ω–∞—á–∞–ª–∞ –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å —Ä–∞–Ω—å—à–µ –¥–∞—Ç—ã –æ–∫–æ–Ω—á–∞–Ω–∏—è."
            )
    
    # –°–æ–∑–¥–∞–µ–º —ç–∫–∑–µ–º–ø–ª—è—Ä –±–∏–ª–¥–µ—Ä–∞ –∑–∞–ø—Ä–æ—Å–æ–≤
    query_builder = EquipmentQueryBuilder(db)
    
    # –ü—Ä–∏–º–µ–Ω—è–µ–º —Ñ–∏–ª—å—Ç—Ä—ã —Å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º —Ü–µ–ø–æ—á–∫–∏ –≤—ã–∑–æ–≤–æ–≤ (Builder Pattern)
    query_builder.apply_search(query)\
                 .apply_type(type)\
                 .apply_brand(brand)\
                 .apply_association(association_id)
    
    # –ü—Ä–∏–º–µ–Ω—è–µ–º —Ñ–∏–ª—å—Ç—Ä –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏, –µ—Å–ª–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ
    if available_only and start_date and end_date:
        query_builder.apply_availability(start_date, end_date)
    
    # –ü–æ–ª—É—á–∞–µ–º –æ–±—â–µ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∏ –ø–∞–≥–∏–Ω–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã
    total = await query_builder.count()
    items = await query_builder.paginate(skip, limit)
    
    # –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –∑–∞—â–∏—Ç–∞: —É–±–µ–∂–¥–∞–µ–º—Å—è, —á—Ç–æ –≤—Å–µ –ø–æ–ª—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã
    for equipment in items:
        if equipment.name is None:
            equipment.name = "–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ–µ –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏–µ"
        if equipment.daily_rate is None:
            equipment.daily_rate = 0.0
        if equipment.condition is None:
            equipment.condition = "–í–µ–ª–∏–∫–æ–ª–µ–ø–Ω–æ"
    
    return items, total


async def update_equipment_details(db: AsyncSession, equipment_id: int, equipment_data: EquipmentUpdateExtended) -> Equipment:
    result = await db.execute(
        select(Equipment)
        .filter(Equipment.id == equipment_id)
        .options(
            selectinload(Equipment.accessories),
            selectinload(Equipment.associations)
        )
    )
    db_equipment = result.scalars().first()
    if not db_equipment:
        raise HTTPException(status_code=404, detail="–û–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏–µ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ")

    update_data = equipment_data.model_dump(exclude_unset=True)

    if "accessory_ids" in update_data:
        accessory_ids = update_data.pop("accessory_ids")
        db_equipment.accessories.clear()
        await db.flush()
        if accessory_ids:
            accessories_result = await db.execute(select(Accessory).filter(Accessory.id.in_(accessory_ids)))
            found_accessories = accessories_result.unique().scalars().all()
            if len(found_accessories) != len(accessory_ids):
                raise HTTPException(status_code=404, detail="–û–¥–∏–Ω –∏–ª–∏ –Ω–µ—Å–∫–æ–ª—å–∫–æ –∞–∫—Å–µ—Å—Å—É–∞—Ä–æ–≤ —Å —É–∫–∞–∑–∞–Ω–Ω—ã–º–∏ ID –Ω–µ –Ω–∞–π–¥–µ–Ω—ã")
            db_equipment.accessories.extend(found_accessories)

    if "association_ids" in update_data:
        association_ids = update_data.pop("association_ids")
        db_equipment.associations.clear()
        await db.flush()
        if association_ids:
            associations_result = await db.execute(select(Association).filter(Association.id.in_(association_ids)))
            found_associations = associations_result.unique().scalars().all()
            if len(found_associations) != len(association_ids):
                raise HTTPException(status_code=404, detail="–û–¥–Ω–∞ –∏–ª–∏ –Ω–µ—Å–∫–æ–ª—å–∫–æ –∞—Å—Å–æ—Ü–∏–∞—Ü–∏–π —Å —É–∫–∞–∑–∞–Ω–Ω—ã–º–∏ ID –Ω–µ –Ω–∞–π–¥–µ–Ω—ã")
            db_equipment.associations.extend(found_associations)

    for key, value in update_data.items():
        setattr(db_equipment, key, value)

    db.add(db_equipment)
    await db.commit()
    await db.refresh(db_equipment)
    
    # –í–æ–∑–≤—Ä–∞—â–∞–µ–º –æ–±–Ω–æ–≤–ª–µ–Ω–Ω—ã–π –æ–±—ä–µ–∫—Ç —Å –∑–∞–≥—Ä—É–∂–µ–Ω–Ω—ã–º–∏ –¥–∞–Ω–Ω—ã–º–∏ –∏–∑ –ë–î
    result = await db.execute(
        select(Equipment)
        .filter(Equipment.id == equipment_id)
        .options(
            selectinload(Equipment.accessories),
            selectinload(Equipment.associations)
        )
    )
    return result.scalars().first()

```


## <a name="RentalAppFASTAPIapiservicesfinancialservicepy"></a>`RentalApp_FASTAPI/api/services/financial_service.py`

```python
// path: RentalApp_FASTAPI/api/services/financial_service.py

# api/services/financial_service.py

from sqlalchemy.ext.asyncio import AsyncSession
from sqlalchemy import select, func
from sqlalchemy.orm import selectinload
from datetime import date, timedelta
from typing import List, Dict, Optional, NamedTuple, Union
from fastapi import HTTPException
import logging

from api.models.equipment import Equipment
from api.models.promo_code import PromoCode
from api.models.accessory import Accessory
from api.models.holiday import Holiday
from api.models.rental import Rental
from api.models.reservation import Reservation
from .discount_service import get_duration_discount_percentage
from .promo_code import PromoCodeBusinessLogic
from shared.schemas.rental_schema import RentalOut
from shared.schemas.reservation_schema import AdminReservationOut, ReservationItem

logger = logging.getLogger(__name__)


class PriceDetails(NamedTuple):
    """–°—Ç—Ä—É–∫—Ç—É—Ä–∞ –¥–ª—è –≤–æ–∑–≤—Ä–∞—Ç–∞ –¥–µ—Ç–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ —Ü–µ–Ω–µ."""
    full_total: float
    discount_amount: float
    final_total: float


class FinancialService:
    """
    –ï–¥–∏–Ω—ã–π —Å–µ—Ä–≤–∏—Å –¥–ª—è –≤—Å–µ—Ö —Ñ–∏–Ω–∞–Ω—Å–æ–≤—ã—Ö —Ä–∞—Å—á–µ—Ç–æ–≤ –∏ –æ–±–æ–≥–∞—â–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö.
    –û–±—ä–µ–¥–∏–Ω—è–µ—Ç –ª–æ–≥–∏–∫—É –∏–∑ price_calculation_service –∏ rental_calculation_service.
    """

    def __init__(self, db: AsyncSession):
        self.db = db

    # --- –ú–µ—Ç–æ–¥—ã —Ä–∞—Å—á–µ—Ç–∞ —Å—Ç–æ–∏–º–æ—Å—Ç–∏ (–∏–∑ price_calculation_service) ---

    async def find_next_working_day(self, start_date: date) -> date:
        """–ù–∞—Ö–æ–¥–∏—Ç –±–ª–∏–∂–∞–π—à—É—é —Å–ª–µ–¥—É—é—â—É—é –¥–∞—Ç—É, –∫–æ—Ç–æ—Ä–∞—è –Ω–µ —è–≤–ª—è–µ—Ç—Å—è –≤—ã—Ö–æ–¥–Ω—ã–º."""
        next_day = start_date
        while True:
            result = await self.db.execute(select(Holiday).filter(Holiday.date == next_day))
            if not result.scalars().first():
                break
            next_day += timedelta(days=1)
        return next_day

    def validate_date_range(self, start_date: date, end_date: date):
        """–ü—Ä–æ–≤–µ—Ä—è–µ—Ç, —á—Ç–æ –∫–æ–Ω–µ—á–Ω–∞—è –¥–∞—Ç–∞ —Å—Ç—Ä–æ–≥–æ –±–æ–ª—å—à–µ –Ω–∞—á–∞–ª—å–Ω–æ–π."""
        if start_date >= end_date:
            raise HTTPException(
                status_code=400,
                detail="–î–∞—Ç–∞ –æ–∫–æ–Ω—á–∞–Ω–∏—è –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å –ø–æ–∑–∂–µ –¥–∞—Ç—ã –Ω–∞—á–∞–ª–∞."
            )

    async def validate_holidays(self, start_date: date, end_date: date):
        """–ü—Ä–æ–≤–µ—Ä—è–µ—Ç, —á—Ç–æ –¥–∞—Ç–∞ –Ω–∞—á–∞–ª–∞ –∏–ª–∏ –æ–∫–æ–Ω—á–∞–Ω–∏—è —Ä–µ–∑–µ—Ä–≤–∞ –Ω–µ –≤—ã–ø–∞–¥–∞–µ—Ç –Ω–∞ –≤—ã—Ö–æ–¥–Ω–æ–π."""
        start_result = await self.db.execute(select(Holiday).filter(Holiday.date == start_date))
        is_start_holiday = start_result.scalars().first()
        
        end_result = await self.db.execute(select(Holiday).filter(Holiday.date == end_date))
        is_end_holiday = end_result.scalars().first()
        
        if is_start_holiday or is_end_holiday:
            raise HTTPException(
                status_code=400,
                detail="–ù–µ–ª—å–∑—è –Ω–∞—á–∞—Ç—å –∏–ª–∏ –∑–∞–∫–æ–Ω—á–∏—Ç—å —Ä–µ–∑–µ—Ä–≤ –≤ –≤—ã—Ö–æ–¥–Ω–æ–π –¥–µ–Ω—å."
            )

    async def get_rental_days(self, start_date: date, end_date: date) -> int:
        """–†–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ—Ç –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ç–∞—Ä–∏—Ñ–∏—Ü–∏—Ä—É–µ–º—ã—Ö —Å—É—Ç–æ–∫, –∏—Å–∫–ª—é—á–∞—è –≤—ã—Ö–æ–¥–Ω—ã–µ –¥–Ω–∏."""
        if start_date >= end_date:
            return 0
        total_days = (end_date - start_date).days
        holidays_result = await self.db.execute(
            select(func.count(Holiday.date)).filter(
                Holiday.date > start_date,
                Holiday.date < end_date
            )
        )
        holidays_count = holidays_result.scalar_one()
        return total_days - holidays_count

    async def calculate_final_price(
            self,
            equipment_ids: List[int],
            selected_accessories: Optional[Dict[int, List[int]]],
            start_date: date,
            end_date: date,
            promo_code: Optional[PromoCode]
    ) -> PriceDetails:
        """–†–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ—Ç –ø–æ–ª–Ω—É—é, —Ñ–∏–Ω–∞–ª—å–Ω—É—é —Å—Ç–æ–∏–º–æ—Å—Ç—å –∑–∞–∫–∞–∑–∞, –≤–∫–ª—é—á–∞—è –≤—Å–µ —Å–∫–∏–¥–∫–∏."""
        if not equipment_ids:
            return PriceDetails(full_total=0.0, discount_amount=0.0, final_total=0.0)

        rental_days = await self.get_rental_days(start_date, end_date)
        if rental_days <= 0:
            return PriceDetails(full_total=0.0, discount_amount=0.0, final_total=0.0)

        equipment_result = await self.db.execute(
            select(Equipment)
            .filter(Equipment.id.in_(equipment_ids))
            .options(
                selectinload(Equipment.accessories),
                selectinload(Equipment.associations)
            )
        )
        selected_equipment = equipment_result.unique().scalars().all()
        base_equipment_cost = sum(item.daily_rate for item in selected_equipment)

        accessories_cost = 0.0
        if selected_accessories:
            all_accessory_ids = [acc_id for equip_accs in selected_accessories.values() for acc_id in equip_accs]
            if all_accessory_ids:
                accessories_result = await self.db.execute(select(Accessory).filter(Accessory.id.in_(all_accessory_ids)))
                found_accessories = accessories_result.unique().scalars().all()
                accessories_cost = sum(acc.price for acc in found_accessories)

        full_total = (base_equipment_cost + accessories_cost) * rental_days
        duration_discount = await get_duration_discount_percentage(self.db, rental_days)
        
        # –ò—Å–ø–æ–ª—å–∑—É–µ–º –Ω–æ–≤—É—é –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—É –ø—Ä–æ–º–æ–∫–æ–¥–æ–≤ –¥–ª—è —Ä–∞—Å—á–µ—Ç–∞ —Å–∫–∏–¥–∫–∏
        promo_discount = 0
        if promo_code:
            business_logic = PromoCodeBusinessLogic(self.db)
            promo_discount = promo_code.discount_percentage
            # –ò—Å–ø–æ–ª—å–∑—É–µ–º –º–µ—Ç–æ–¥ –≤–∞–ª–∏–¥–∞—Ü–∏–∏ –∫–æ–º–±–∏–Ω–∏—Ä–æ–≤–∞–Ω–Ω–æ–π —Å–∫–∏–¥–∫–∏
            total_discount_percentage = business_logic.validate_combined_discount(
                duration_discount, promo_discount
            )
        else:
            total_discount_percentage = duration_discount

        discount_amount = full_total * (total_discount_percentage / 100)
        final_total = full_total - discount_amount

        return PriceDetails(
            full_total=round(full_total, 2),
            discount_amount=round(discount_amount, 2),
            final_total=round(final_total, 2)
        )

    # --- –ú–µ—Ç–æ–¥—ã —Ä–∞—Å—á–µ—Ç–∞ –∞—Ä–µ–Ω–¥—ã (–∏–∑ rental_calculation_service) ---

    async def calculate_daily_rate(self, rental: Rental) -> float:
        """
        –†–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ—Ç –¥–Ω–µ–≤–Ω—É—é —Å—Ç–∞–≤–∫—É –∞—Ä–µ–Ω–¥—ã –Ω–∞ –æ—Å–Ω–æ–≤–µ –æ–±—â–µ–π —Å—Ç–æ–∏–º–æ—Å—Ç–∏ –∏ –ø–ª–∞–Ω–æ–≤–æ–≥–æ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ –¥–Ω–µ–π.
        """
        if rental.total_cost <= 0:
            return 0.0
            
        planned_days = await self.get_rental_days(rental.start_date, rental.end_date)
        if planned_days <= 0:
            return 0.0
            
        return rental.total_cost / planned_days
    
    def calculate_overdue_days(self, rental: Rental, actual_return_date: date) -> int:
        """
        –†–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ—Ç –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø—Ä–æ—Å—Ä–æ—á–µ–Ω–Ω—ã—Ö –¥–Ω–µ–π.
        """
        if actual_return_date <= rental.end_date:
            return 0
            
        return (actual_return_date - rental.end_date).days
    
    async def calculate_overdue_surcharge(self, rental: Rental, actual_return_date: date) -> float:
        """
        –†–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ—Ç —à—Ç—Ä–∞—Ñ –∑–∞ –ø—Ä–æ—Å—Ä–æ—á–µ–Ω–Ω—ã–µ –¥–Ω–∏ –∞—Ä–µ–Ω–¥—ã.
        """
        overdue_days = self.calculate_overdue_days(rental, actual_return_date)
        if overdue_days <= 0:
            return 0.0
            
        daily_rate = await self.calculate_daily_rate(rental)
        if daily_rate <= 0:
            return 0.0
            
        surcharge_amount = daily_rate * overdue_days
        return round(surcharge_amount, 2)
    
    async def calculate_early_return_credit(self, rental: Rental, actual_return_date: date, planned_days: int) -> float:
        """
        –†–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ—Ç –∫—Ä–µ–¥–∏—Ç –∑–∞ –¥–æ—Å—Ä–æ—á–Ω—ã–π –≤–æ–∑–≤—Ä–∞—Ç –∞—Ä–µ–Ω–¥—ã.
        """
        if actual_return_date >= rental.end_date or planned_days <= 0:
            return 0.0

        daily_rate = await self.calculate_daily_rate(rental)
        if daily_rate <= 0:
            return 0.0
            
        # –†–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ–º –∏–º–µ–Ω–Ω–æ —Ç–∞—Ä–∏—Ñ–∏—Ü–∏—Ä—É–µ–º—ã–µ –¥–Ω–∏ –≤ –æ—Å—Ç–∞–≤—à–µ–º—Å—è –ø–µ—Ä–∏–æ–¥–µ
        unused_billable_days = await self.get_rental_days(actual_return_date, rental.end_date)
        if unused_billable_days <= 0:
            return 0.0
            
        credit_amount = unused_billable_days * daily_rate
        return round(credit_amount, 2)
    
    async def get_rental_calculation_summary(self, rental: Rental, actual_return_date: date, planned_days: int) -> dict:
        """
        –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç –ø–æ–ª–Ω—É—é —Å–≤–æ–¥–∫—É —Ä–∞—Å—á–µ—Ç–æ–≤ –¥–ª—è –∞—Ä–µ–Ω–¥—ã.
        """
        daily_rate = await self.calculate_daily_rate(rental)
        overdue_days = self.calculate_overdue_days(rental, actual_return_date)
        surcharge_amount = await self.calculate_overdue_surcharge(rental, actual_return_date)
        credit_amount = await self.calculate_early_return_credit(rental, actual_return_date, planned_days)
        
        return {
            'daily_rate': daily_rate,
            'overdue_days': overdue_days,
            'surcharge_amount': surcharge_amount,
            'credit_amount': credit_amount,
            'is_overdue': overdue_days > 0,
            'is_early_return': actual_return_date < rental.end_date and credit_amount > 0
        }

    # --- –£–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω—ã–π –º–µ—Ç–æ–¥ –æ–±–æ–≥–∞—â–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö ---

    async def enrich_order_with_financials(self, order: Union[Rental, Reservation]) -> Union[RentalOut, AdminReservationOut, ReservationItem]:
        """
        –£–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω—ã–π –º–µ—Ç–æ–¥ –¥–ª—è –æ–±–æ–≥–∞—â–µ–Ω–∏—è –∑–∞–∫–∞–∑–∞ (–∞—Ä–µ–Ω–¥—ã –∏–ª–∏ —Ä–µ–∑–µ—Ä–≤–∞) —Ñ–∏–Ω–∞–Ω—Å–æ–≤—ã–º–∏ –¥–∞–Ω–Ω—ã–º–∏.
        
        Args:
            order: ORM-–æ–±—ä–µ–∫—Ç –∞—Ä–µ–Ω–¥—ã –∏–ª–∏ —Ä–µ–∑–µ—Ä–≤–∞
            
        Returns:
            Pydantic-—Å—Ö–µ–º–∞ —Å –ø–æ–ª–Ω–æ—Å—Ç—å—é –∑–∞–ø–æ–ª–Ω–µ–Ω–Ω—ã–º–∏ —Ñ–∏–Ω–∞–Ω—Å–æ–≤—ã–º–∏ –¥–∞–Ω–Ω—ã–º–∏
        """
        if isinstance(order, Rental):
            return await self._enrich_rental_with_financials(order)
        elif isinstance(order, Reservation):
            return await self._enrich_reservation_with_financials(order)
        else:
            raise ValueError(f"Unsupported order type: {type(order)}")

    async def _enrich_rental_with_financials(self, rental: Rental) -> RentalOut:
        """–û–±–æ–≥–∞—â–∞–µ—Ç –æ–±—ä–µ–∫—Ç –∞—Ä–µ–Ω–¥—ã —Ñ–∏–Ω–∞–Ω—Å–æ–≤—ã–º–∏ –¥–∞–Ω–Ω—ã–º–∏."""
        rental_out = RentalOut.model_validate(rental)
        today = date.today()

        # –î–∏–Ω–∞–º–∏—á–µ—Å–∫–∏–π —Å—Ç–∞—Ç—É—Å overdue
        if rental.status == 'active' and rental.end_date < today:
            rental_out.status = 'overdue'

        # –†–∞—Å—á–µ—Ç –ø—Ä–æ—Å—Ä–æ—á–∫–∏ –∏–ª–∏ –æ—Å—Ç–∞–≤—à–∏—Ö—Å—è –¥–Ω–µ–π
        if rental_out.status == 'overdue':
            rental_out.overdue_days = self.calculate_overdue_days(rental, today)
            rental_out.overdue_surcharge = await self.calculate_overdue_surcharge(rental, today)
        elif rental.status == 'active':
            rental_out.days_remaining = (rental.end_date - today).days

        # –†–∞—Å—á–µ—Ç —Å—Ç–æ–∏–º–æ—Å—Ç–∏ –∞–∫—Å–µ—Å—Å—É–∞—Ä–æ–≤
        accessories_cost = 0.0
        for accessory_link in rental.accessory_links:
            if accessory_link.accessory and accessory_link.accessory.price:
                accessories_cost += accessory_link.accessory.price
        rental_out.accessories_cost = accessories_cost

        # –†–∞—Å—á–µ—Ç –æ—Å—Ç–∞—Ç–∫–∞ –∫ –æ–ø–ª–∞—Ç–µ
        rental_out.remaining_amount = rental.total_cost - rental.prepayment_amount

        return rental_out

    async def _enrich_reservation_with_financials(self, reservation: Reservation) -> ReservationItem:
        """–û–±–æ–≥–∞—â–∞–µ—Ç –æ–±—ä–µ–∫—Ç —Ä–µ–∑–µ—Ä–≤–∞ —Ñ–∏–Ω–∞–Ω—Å–æ–≤—ã–º–∏ –¥–∞–Ω–Ω—ã–º–∏."""
        reservation_out = ReservationItem.model_validate(reservation)
        today = date.today()

        # –î–∏–Ω–∞–º–∏—á–µ—Å–∫–∏–π —Å—Ç–∞—Ç—É—Å overdue
        if reservation.status == 'active' and reservation.end_date < today:
            reservation_out.status = 'overdue'

        # –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º rental_id –µ—Å–ª–∏ –µ—Å—Ç—å —Å–≤—è–∑–∞–Ω–Ω–∞—è –∞—Ä–µ–Ω–¥–∞
        if reservation.rental:
            reservation_out.rental_id = reservation.rental.id

        return reservation_out

    async def _enrich_admin_reservation_with_financials(self, reservation: Reservation) -> AdminReservationOut:
        """–û–±–æ–≥–∞—â–∞–µ—Ç –æ–±—ä–µ–∫—Ç —Ä–µ–∑–µ—Ä–≤–∞ –¥–ª—è –∞–¥–º–∏–Ω-–ø–∞–Ω–µ–ª–∏ —Ñ–∏–Ω–∞–Ω—Å–æ–≤—ã–º–∏ –¥–∞–Ω–Ω—ã–º–∏."""
        if not reservation.user:
            raise ValueError("Reservation must have user for admin view")

        reservation_base = await self._enrich_reservation_with_financials(reservation)
        user_info = reservation.user

        return AdminReservationOut(
            **reservation_base.model_dump(),
            user_info=user_info
        )


```


## <a name="RentalAppFASTAPIapiservicesorderinitpy"></a>`RentalApp_FASTAPI/api/services/order/__init__.py`

```python
// path: RentalApp_FASTAPI/api/services/order/__init__.py



```


## <a name="RentalAppFASTAPIapiservicesorderorderlifecycleservicepy"></a>`RentalApp_FASTAPI/api/services/order/order_lifecycle_service.py`

```python
// path: RentalApp_FASTAPI/api/services/order/order_lifecycle_service.py

# api/services/order/order_lifecycle_service.py

from sqlalchemy.ext.asyncio import AsyncSession
from sqlalchemy import select
from datetime import date
import logging

from api.models.user import User
from api.models.rental import Rental, RentalAccessory
from api.models.reservation import Reservation
from api.services.order.order_repository import OrderRepository
from api.services.order.order_validator import OrderValidator
from api.services.balance_service import BalanceService
from api.services.financial_service import FinancialService
from api.services.promo_code_service import validate_promo_code_for_use

from shared.schemas.reservation_schema import ReservationCreateRequest, ReservationUpdateRequest, AdminReservationCreateRequest
from shared.schemas.rental_schema import RentalCreateFromReservationRequest, RentalReturnRequest, RentalCreateFromScratchRequest, AdminRentalUpdate

logger = logging.getLogger(__name__)

class OrderLifecycleService:
    """
    –ï–¥–∏–Ω—ã–π —Å–µ—Ä–≤–∏—Å –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –ø–æ–ª–Ω—ã–º –∂–∏–∑–Ω–µ–Ω–Ω—ã–º —Ü–∏–∫–ª–æ–º –∑–∞–∫–∞–∑–∞:
    –æ—Ç —Å–æ–∑–¥–∞–Ω–∏—è —Ä–µ–∑–µ—Ä–≤–∞ –¥–æ –≤–æ–∑–≤—Ä–∞—Ç–∞ –∞—Ä–µ–Ω–¥—ã.
    """
    def __init__(self, db: AsyncSession):
        self.db = db
        self.repo = OrderRepository(db)
        self.validator = OrderValidator(db)
        self.balance_service = BalanceService(db)
        self.financial_service = FinancialService(db)

    # --- –ú–µ—Ç–æ–¥—ã –¥–ª—è –†–µ–∑–µ—Ä–≤–æ–≤ (–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å) ---

    async def create_user_reservation(self, request: ReservationCreateRequest, user: User) -> Reservation:
        try:
            await self.validator.validate_dates_and_holidays(request.start_date, request.end_date)
            equipment = await self.repo.get_equipment_by_ids_or_fail(request.equipment_ids)
            self.validator.validate_accessories_for_equipment(request.selected_accessories, request.equipment_ids)
            await self.validator.validate_equipment_availability(request.equipment_ids, request.start_date, request.end_date)

            promo_code_obj = await self.repo.get_promo_code_by_name(request.promo_code) if request.promo_code else None
            price_details = await self.financial_service.calculate_final_price(request.equipment_ids, request.selected_accessories, request.start_date, request.end_date, promo_code_obj)

            reservation = self.repo.create_reservation_instance(
                user_id=user.id,
                start_date=request.start_date,
                end_date=request.end_date,
                equipment=equipment,
                price_details=price_details,
                promo_code_id=promo_code_obj.id if promo_code_obj else None
            )
            self.repo.add_accessories_to_reservation(reservation, request.selected_accessories)
            await self.repo.save(reservation)
            
            await self.db.commit()
            logger.info(f"User {user.id} created reservation #{reservation.id}")
            return await self.repo.get_reservation_by_id_or_fail(reservation.id)
            
        except Exception as e:
            await self.db.rollback()
            logger.error(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ —Ä–µ–∑–µ—Ä–≤–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º {user.id}: {e}", exc_info=True)
            raise

    async def update_user_reservation(self, reservation_id: int, request: ReservationUpdateRequest, user: User) -> Reservation:
        try:
            reservation = await self.repo.get_reservation_by_id_or_fail(reservation_id, user_id=user.id)
            await self.validator.validate_dates_and_holidays(request.start_date, request.end_date)
            equipment = await self.repo.get_equipment_by_ids_or_fail(request.equipment_ids)
            self.validator.validate_accessories_for_equipment(request.selected_accessories, request.equipment_ids)
            await self.validator.validate_equipment_availability(request.equipment_ids, request.start_date, request.end_date, exclude_reservation_id=reservation_id)

            promo_code_obj = await self.repo.get_promo_code_by_name(request.promo_code) if request.promo_code else None
            price_details = await self.financial_service.calculate_final_price(request.equipment_ids, request.selected_accessories, request.start_date, request.end_date, promo_code_obj)

            self.repo.update_reservation_instance(
                reservation=reservation,
                start_date=request.start_date,
                end_date=request.end_date,
                equipment=equipment,
                price_details=price_details,
                promo_code_id=promo_code_obj.id if promo_code_obj else None
            )
            await self.repo.update_accessories_for_reservation(reservation, request.selected_accessories)
            await self.repo.save(reservation)
            
            await self.db.commit()
            logger.info(f"User {user.id} updated reservation #{reservation.id}")
            return await self.repo.get_reservation_by_id_or_fail(reservation.id)
            
        except Exception as e:
            await self.db.rollback()
            logger.error(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ —Ä–µ–∑–µ—Ä–≤–∞ #{reservation_id} –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º {user.id}: {e}", exc_info=True)
            raise

    async def cancel_user_reservation(self, reservation_id: int, user: User):
        try:
            reservation = await self.repo.get_reservation_by_id_or_fail(reservation_id, user_id=user.id)
            self.validator.validate_reservation_is_cancellable(reservation)
            await self.repo.delete(reservation)
            
            await self.db.commit()
            logger.info(f"User {user.id} cancelled reservation #{reservation_id}")
            
        except Exception as e:
            await self.db.rollback()
            logger.error(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–º–µ–Ω–µ —Ä–µ–∑–µ—Ä–≤–∞ #{reservation_id} –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º {user.id}: {e}", exc_info=True)
            raise

    # --- –ú–µ—Ç–æ–¥—ã –¥–ª—è –†–µ–∑–µ—Ä–≤–æ–≤ (–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä) ---

    async def create_admin_reservation(self, request: AdminReservationCreateRequest) -> Reservation:
        user = await self.repo.get_user_by_id_or_fail(request.user_id)
        # –î–ª—è –∞–¥–º–∏–Ω–∞ –º—ã –º–æ–∂–µ–º –ø–æ–≤—Ç–æ—Ä–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –ª–æ–≥–∏–∫—É —Å–æ–∑–¥–∞–Ω–∏—è –æ–±—ã—á–Ω–æ–≥–æ —Ä–µ–∑–µ—Ä–≤–∞
        return await self.create_user_reservation(request, user)

    async def update_admin_reservation(self, reservation_id: int, request: ReservationUpdateRequest) -> Reservation:
        reservation = await self.repo.get_reservation_by_id_or_fail(reservation_id)
        user = await self.repo.get_user_by_id_or_fail(reservation.user_id)
        # –ê–Ω–∞–ª–æ–≥–∏—á–Ω–æ, –∏—Å–ø–æ–ª—å–∑—É–µ–º –æ–±—â—É—é –ª–æ–≥–∏–∫—É –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è
        return await self.update_user_reservation(reservation_id, request, user)

    async def cancel_admin_reservation(self, reservation_id: int):
        reservation = await self.repo.get_reservation_by_id_or_fail(reservation_id)
        self.validator.validate_reservation_is_cancellable(reservation)
        await self.repo.delete(reservation)
        logger.warning(f"Admin cancelled reservation #{reservation_id}")

    async def bulk_cancel_admin_reservations(self, reservation_ids: list[int]):
        reservations = await self.repo.get_reservations_by_ids(reservation_ids)
        cancellable, not_cancellable = self.validator.filter_cancellable_reservations(reservations)

        if not_cancellable:
            logger.warning(f"Cannot bulk delete reservations already converted to rental: {[r.id for r in not_cancellable]}")

        for reservation in cancellable:
            await self.repo.delete(reservation)

        logger.warning(f"Admin bulk cancelled reservations: {[r.id for r in cancellable]}")

    # --- –ú–µ—Ç–æ–¥—ã –¥–ª—è –ê—Ä–µ–Ω–¥ (–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä) ---

    async def convert_reservation_to_rental(self, reservation_id: int, request: RentalCreateFromReservationRequest, manager: User) -> Rental:
        try:
            reservation = await self.repo.get_reservation_by_id_or_fail(reservation_id)
            self.validator.validate_reservation_for_conversion(reservation)
            
            # –°–æ–∑–¥–∞–µ–º –ø–µ—Ä–µ–º–µ–Ω–Ω—É—é new_start_date
            new_start_date = date.today()
            
            # –ó–∞–º–µ–Ω—è–µ–º –ø—Ä–æ–≤–µ—Ä–∫—É –Ω–∞ –≤—ã—Ö–æ–¥–Ω–æ–π –¥–µ–Ω—å –Ω–∞ –≤–∞–ª–∏–¥–∞—Ü–∏—é –≤—Å–µ–≥–æ –ø–µ—Ä–∏–æ–¥–∞
            await self.validator.validate_dates_and_holidays(new_start_date, reservation.end_date, request.force_issue_on_holiday)

            # --- –ù–ê–ß–ê–õ–û –ò–ó–ú–ï–ù–ï–ù–ò–ô ---
            # 1. –ü–ï–†–ï–°–ß–ò–¢–´–í–ê–ï–ú –°–¢–û–ò–ú–û–°–¢–¨ –ü–ï–†–ï–î –ö–û–ù–í–ï–†–¢–ê–¶–ò–ï–ô
            # –ü–æ–ª—É—á–∞–µ–º –ø—Ä–æ–º–æ-–∫–æ–¥ –Ω–∞–ø—Ä—è–º—É—é –∏–∑ –ë–î, –µ—Å–ª–∏ –µ—Å—Ç—å promo_code_id
            promo_code_obj = None
            if reservation.promo_code_id:
                # –ü–æ–ª—É—á–∞–µ–º –ø—Ä–æ–º–æ-–∫–æ–¥ –ø–æ ID, –∞ –Ω–µ –ø–æ –∏–º–µ–Ω–∏, —á—Ç–æ–±—ã –∏–∑–±–µ–∂–∞—Ç—å lazy loading
                from api.models.promo_code import PromoCode
                promo_code_result = await self.db.execute(
                    select(PromoCode).filter(PromoCode.id == reservation.promo_code_id)
                )
                promo_code_obj = promo_code_result.unique().scalar_one_or_none()
            
            # –ë–µ–∑–æ–ø–∞—Å–Ω–æ –ø–æ–ª—É—á–∞–µ–º –¥–∞–Ω–Ω—ã–µ —Ä–µ–∑–µ—Ä–≤–∞
            equipment_ids = []
            selected_accessories = {}
            
            # –ü–æ–ª—É—á–∞–µ–º ID –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—è
            for eq in reservation.equipment:
                equipment_ids.append(eq.id)
            
            # –ü—Ä–µ–æ–±—Ä–∞–∑—É–µ–º –∞–∫—Å–µ—Å—Å—É–∞—Ä—ã –≤ –Ω—É–∂–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç
            for link in reservation.accessory_links:
                if link.equipment_id not in selected_accessories:
                    selected_accessories[link.equipment_id] = []
                selected_accessories[link.equipment_id].append(link.accessory_id)
            
            price_details = await self.financial_service.calculate_final_price(
                equipment_ids,
                selected_accessories,
                new_start_date, # –ò—Å–ø–æ–ª—å–∑—É–µ–º new_start_date –¥–ª—è –ø–µ—Ä–µ—Å—á–µ—Ç–∞ —Å—Ç–æ–∏–º–æ—Å—Ç–∏
                reservation.end_date,
                promo_code_obj
            )

            # 2. –ü–µ—Ä–µ–¥–∞–µ–º –ø–µ—Ä–µ—Å—á–∏—Ç–∞–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –≤ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π
            rental = self.repo.create_rental_from_reservation(
                reservation, 
                manager, 
                request.deposit_amount, 
                request.notes_on_issue,
                # –ü–µ—Ä–µ–¥–∞–µ–º –Ω–æ–≤—ã–µ –¥–∞–Ω–Ω—ã–µ –æ —Ü–µ–Ω–µ
                recalculated_cost=price_details.final_total,
                recalculated_discount=price_details.discount_amount,
                new_start_date=new_start_date, # –ü–µ—Ä–µ–¥–∞–µ–º –¥–∞—Ç—É –Ω–∞—á–∞–ª–∞ –∞—Ä–µ–Ω–¥—ã
                prepayment_amount=request.prepayment_amount
            )
            # --- –ö–û–ù–ï–¶ –ò–ó–ú–ï–ù–ï–ù–ò–ô ---

            # –ù–∞—á–∏—Å–ª—è–µ–º –ø—Ä–µ–¥–æ–ø–ª–∞—Ç—É –Ω–∞ –±–∞–ª–∞–Ω—Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (–µ—Å–ª–∏ –µ—Å—Ç—å)
            if request.prepayment_amount > 0:
                await self.balance_service.add_transaction(
                    user_id=rental.user_id,
                    amount=request.prepayment_amount,
                    operation_type="prepayment",
                    description=f"–ü—Ä–µ–¥–æ–ø–ª–∞—Ç–∞ –∑–∞ –∞—Ä–µ–Ω–¥—É #{rental.id} (–∏–∑ —Ä–µ–∑–µ—Ä–≤–∞ #{reservation.id})",
                    rental_id=rental.id
                )

            await self.balance_service.add_transaction(
                user_id=rental.user_id,
                amount=-rental.total_cost,
                operation_type="rental_debit",
                description=f"–°–ø–∏—Å–∞–Ω–∏–µ –∑–∞ –∞—Ä–µ–Ω–¥—É (–∏–∑ —Ä–µ–∑–µ—Ä–≤–∞ #{reservation.id}) –Ω–∞ —Å—É–º–º—É {rental.total_cost} —Ä—É–±.",
                rental_id=rental.id
            )
            await self.repo.save(rental)
            
            # –ï–¥–∏–Ω—ã–π –∫–æ–º–º–∏—Ç –¥–ª—è –≤—Å–µ–π –æ–ø–µ—Ä–∞—Ü–∏–∏
            await self.db.commit()
            logger.info(f"Manager {manager.id} converted reservation #{reservation_id} to rental #{rental.id}")
            return await self.repo.get_rental_by_id_or_fail(rental.id) # –í–æ–∑–≤—Ä–∞—â–∞–µ–º —Å –ø–æ–¥–≥—Ä—É–∂–µ–Ω–Ω—ã–º–∏ —Å–≤—è–∑—è–º–∏
            
        except Exception as e:
            await self.db.rollback()
            logger.error(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ –∫–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏–∏ —Ä–µ–∑–µ—Ä–≤–∞ #{reservation_id} –≤ –∞—Ä–µ–Ω–¥—É: {e}", exc_info=True)
            raise

    async def create_rental_from_scratch(self, request: RentalCreateFromScratchRequest, manager: User) -> Rental:
        # –°–æ—Ö—Ä–∞–Ω—è–µ–º ID –º–µ–Ω–µ–¥–∂–µ—Ä–∞ –¥–æ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –æ–ø–µ—Ä–∞—Ü–∏–π —Å –ë–î
        manager_id = manager.id
        try:
            user = await self.repo.get_user_by_id_or_fail(request.user_id)
            await self.validator.validate_equipment_availability(request.equipment_ids, request.start_date, request.end_date)
            equipment = await self.repo.get_equipment_by_ids_or_fail(request.equipment_ids)
            price_details = await self.financial_service.calculate_final_price(request.equipment_ids, None, request.start_date, request.end_date, None)

            rental = self.repo.create_rental_instance(
                user=user,
                manager=manager,
                start_date=request.start_date,
                end_date=request.end_date,
                equipment=equipment,
                total_cost=price_details.final_total,
                deposit_amount=request.deposit_amount,
                notes_on_issue=request.notes_on_issue
            )

            await self.balance_service.add_transaction(
                user_id=user.id,
                amount=-rental.total_cost,
                operation_type="rental_debit",
                description=f"–°–ø–∏—Å–∞–Ω–∏–µ –∑–∞ –Ω–æ–≤—É—é –∞—Ä–µ–Ω–¥—É #{rental.id} –Ω–∞ —Å—É–º–º—É {rental.total_cost} —Ä—É–±.",
                rental_id=rental.id
            )
            await self.repo.save(rental)
            
            await self.db.commit()
            logger.info(f"Manager {manager.id} created rental from scratch #{rental.id} for user {user.id}")
            return await self.repo.get_rental_by_id_or_fail(rental.id)
            
        except Exception as e:
            await self.db.rollback()
            logger.error(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –∞—Ä–µ–Ω–¥—ã —Å –Ω—É–ª—è –º–µ–Ω–µ–¥–∂–µ—Ä–æ–º {manager_id}: {e}", exc_info=True)
            raise

    async def return_rental(self, rental_id: int, request: RentalReturnRequest, manager: User) -> Rental:
        # –°–æ—Ö—Ä–∞–Ω—è–µ–º ID –º–µ–Ω–µ–¥–∂–µ—Ä–∞ –¥–æ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –æ–ø–µ—Ä–∞—Ü–∏–π —Å –ë–î
        manager_id = manager.id
        try:
            rental = await self.repo.get_rental_by_id_or_fail(rental_id)
            self.validator.validate_accessories_returned(rental, request.accessories_returned_confirmation)

            # –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –¥–ª—è —Ä–∞—Å—á–µ—Ç–∞ –∫—Ä–µ–¥–∏—Ç–∞ –∏ —à—Ç—Ä–∞—Ñ–∞
            credit_amount = 0.0
            surcharge_amount = 0.0

            # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —è–≤–ª—è–µ—Ç—Å—è –ª–∏ –≤–æ–∑–≤—Ä–∞—Ç –ø—Ä–æ—Å—Ä–æ—á–µ–Ω–Ω—ã–º
            if request.actual_return_date > rental.end_date:
                # –ü—Ä–æ—Å—Ä–æ—á–µ–Ω–Ω—ã–π –≤–æ–∑–≤—Ä–∞—Ç - —Ä–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ–º —à—Ç—Ä–∞—Ñ
                surcharge_amount = await self.financial_service.calculate_overdue_surcharge(rental, request.actual_return_date)
                
                if surcharge_amount > 0:
                    # –°–æ–∑–¥–∞–µ–º –¥–µ–±–µ—Ç–æ–≤—É—é —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—é –¥–ª—è —Å–ø–∏—Å–∞–Ω–∏—è —à—Ç—Ä–∞—Ñ–∞
                    await self.balance_service.add_transaction(
                        user_id=rental.user_id,
                        amount=-surcharge_amount,  # –û—Ç—Ä–∏—Ü–∞—Ç–µ–ª—å–Ω–∞—è —Å—É–º–º–∞ –¥–ª—è —Å–ø–∏—Å–∞–Ω–∏—è
                        operation_type="overdue_surcharge_debit",
                        description=f"–°–ø–∏—Å–∞–Ω–∏–µ –∑–∞ –ø—Ä–æ—Å—Ä–æ—á–∫—É –∞—Ä–µ–Ω–¥—ã #{rental.id} –Ω–∞ {surcharge_amount} —Ä—É–±.",
                        rental_id=rental.id
                    )
                    logger.info(f"Applied overdue surcharge of {surcharge_amount} rub. for rental #{rental.id}")
            else:
                # –í–æ–∑–≤—Ä–∞—Ç –≤–æ–≤—Ä–µ–º—è –∏–ª–∏ –¥–æ—Å—Ä–æ—á–Ω–æ - —Ä–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ–º –∫—Ä–µ–¥–∏—Ç –∑–∞ –¥–æ—Å—Ä–æ—á–Ω—ã–π –≤–æ–∑–≤—Ä–∞—Ç
                planned_days = await self.repo.get_rental_days_count(rental.start_date, rental.end_date)
                credit_amount = await self.financial_service.calculate_early_return_credit(rental, request.actual_return_date, planned_days)
                
                if credit_amount > 0:
                    # –°–æ–∑–¥–∞–µ–º –∫—Ä–µ–¥–∏—Ç–æ–≤—É—é —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—é –¥–ª—è –≤–æ–∑–≤—Ä–∞—Ç–∞ —Å—Ä–µ–¥—Å—Ç–≤
                    await self.balance_service.add_transaction(
                        user_id=rental.user_id,
                        amount=credit_amount,
                        operation_type="early_return_credit",
                        description=f"–í–æ–∑–≤—Ä–∞—Ç –∑–∞ –¥–æ—Å—Ä–æ—á–Ω–æ–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∏–µ –∞—Ä–µ–Ω–¥—ã #{rental.id} –Ω–∞ —Å—É–º–º—É {credit_amount} —Ä—É–±.",
                        rental_id=rental.id
                    )
                    logger.info(f"Applied early return credit of {credit_amount} rub. for rental #{rental.id}")

            # –ü–ª–∞—Ç–µ–∂ —Ç–µ–ø–µ—Ä—å –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç—Å—è –æ—Ç–¥–µ–ª—å–Ω—ã–º —ç–Ω–¥–ø–æ–∏–Ω—Ç–æ–º –∏ –Ω–µ —è–≤–ª—è–µ—Ç—Å—è —á–∞—Å—Ç—å—é –ø—Ä–æ—Ü–µ—Å—Å–∞ –≤–æ–∑–≤—Ä–∞—Ç–∞.

            # –§–∏–Ω–∞–ª–∏–∑–∏—Ä—É–µ–º –≤–æ–∑–≤—Ä–∞—Ç —Å —É—á–µ—Ç–æ–º –∏ –∫—Ä–µ–¥–∏—Ç–∞, –∏ —à—Ç—Ä–∞—Ñ–∞
            self.repo.finalize_rental_return(rental, request.actual_return_date, request.notes_on_return, credit_amount, surcharge_amount)
            await self.repo.save(rental)
            
            await self.db.commit()
            logger.info(f"Manager {manager.id} processed return for rental #{rental_id} - credit: {credit_amount}, surcharge: {surcharge_amount}")
            return await self.repo.get_rental_by_id_or_fail(rental.id)
            
        except Exception as e:
            await self.db.rollback()
            logger.error(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ –≤–æ–∑–≤—Ä–∞—Ç–µ –∞—Ä–µ–Ω–¥—ã #{rental_id} –º–µ–Ω–µ–¥–∂–µ—Ä–æ–º {manager_id}: {e}", exc_info=True)
            raise

    async def update_rental_details_by_admin(self, rental_id: int, request: AdminRentalUpdate, manager: User) -> Rental:
        # –°–æ—Ö—Ä–∞–Ω—è–µ–º ID –º–µ–Ω–µ–¥–∂–µ—Ä–∞ –¥–æ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –æ–ø–µ—Ä–∞—Ü–∏–π —Å –ë–î
        manager_id = manager.id
        try:
            rental = await self.repo.get_rental_by_id_or_fail(rental_id)
            update_data = request.model_dump(exclude_unset=True)
            self.repo.update_rental_instance(rental, update_data)
            await self.repo.save(rental)
            
            await self.db.commit()
            logger.info(f"Manager {manager.id} updated details for rental #{rental_id}")
            return await self.repo.get_rental_by_id_or_fail(rental.id)
            
        except Exception as e:
            await self.db.rollback()
            logger.error(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ –¥–µ—Ç–∞–ª–µ–π –∞—Ä–µ–Ω–¥—ã #{rental_id} –º–µ–Ω–µ–¥–∂–µ—Ä–æ–º {manager_id}: {e}", exc_info=True)
            raise

    async def revert_rental_to_reservation(self, rental_id: int, manager: User):
        # –°–æ—Ö—Ä–∞–Ω—è–µ–º ID –º–µ–Ω–µ–¥–∂–µ—Ä–∞ –¥–æ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –æ–ø–µ—Ä–∞—Ü–∏–π —Å –ë–î
        manager_id = manager.id
        try:
            rental = await self.repo.get_rental_by_id_or_fail(rental_id)
            self.validator.validate_rental_for_revert(rental)

            reservation = self.repo.revert_rental_status_to_active(rental)

            await self.balance_service.add_transaction(
                user_id=rental.user_id,
                amount=rental.total_cost, # –í–æ–∑–≤—Ä–∞—â–∞–µ–º –ø–æ–ª–Ω—É—é —Å—Ç–æ–∏–º–æ—Å—Ç—å
                operation_type="rental_revert_credit",
                description=f"–í–æ–∑–≤—Ä–∞—Ç —Å—Ä–µ–¥—Å—Ç–≤ –∑–∞ –æ—Ç–º–µ–Ω—É –≤—ã–¥–∞—á–∏ –∞—Ä–µ–Ω–¥—ã #{rental.id}",
                rental_id=rental.id
            )

            await self.repo.delete(rental)
            
            await self.db.commit()
            logger.info(f"Manager {manager_id} reverted rental #{rental_id} to reservation #{reservation.id}")
            
        except Exception as e:
            await self.db.rollback()
            logger.error(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–º–µ–Ω–µ –∞—Ä–µ–Ω–¥—ã #{rental_id} –º–µ–Ω–µ–¥–∂–µ—Ä–æ–º {manager_id}: {e}", exc_info=True)
            raise

    async def delete_rental_by_admin(self, rental_id: int):
        try:
            rental = await self.repo.get_rental_by_id_or_fail(rental_id)
            await self.repo.delete(rental)
            
            await self.db.commit()
            logger.warning(f"Admin deleted rental #{rental_id}")
            
        except Exception as e:
            await self.db.rollback()
            logger.error(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ –∞—Ä–µ–Ω–¥—ã #{rental_id}: {e}", exc_info=True)
            raise

```


## <a name="RentalAppFASTAPIapiservicesorderorderquerybasepy"></a>`RentalApp_FASTAPI/api/services/order/order_query_base.py`

```python
// path: RentalApp_FASTAPI/api/services/order/order_query_base.py

# api/services/order/order_query_base.py

from sqlalchemy.ext.asyncio import AsyncSession
from sqlalchemy.orm import joinedload, selectinload
from sqlalchemy import or_, select, func, desc, asc
from typing import Optional, List, Tuple, TypeVar, Generic
from datetime import date
import logging

from api.models.user import User
from api.models.equipment import Equipment

logger = logging.getLogger(__name__)

T = TypeVar('T')  # –¢–∏–ø –º–æ–¥–µ–ª–∏ (Reservation –∏–ª–∏ Rental)

class OrderQueryBase(Generic[T]):
    """
    –ë–∞–∑–æ–≤—ã–π –∫–ª–∞—Å—Å –¥–ª—è –æ–±—â–∏—Ö –æ–ø–µ—Ä–∞—Ü–∏–π —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏, –ø–æ–∏—Å–∫–∞ –∏ —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∏ –∑–∞–∫–∞–∑–æ–≤.
    –°–æ–¥–µ—Ä–∂–∏—Ç –æ–±—â—É—é –ª–æ–≥–∏–∫—É –¥–ª—è —Ä–µ–∑–µ—Ä–≤–æ–≤ –∏ –∞—Ä–µ–Ω–¥.
    """

    def __init__(self, db: AsyncSession):
        self.db = db

    def _apply_user_search(self, query, search_term: str, model_class):
        """
        –ü—Ä–∏–º–µ–Ω—è–µ—Ç –ø–æ–∏—Å–∫ –ø–æ –∏–º–µ–Ω–∏ –∏–ª–∏ email –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è.
        """
        search_pattern = f"%{search_term.lower()}%"
        # –£–±–µ–∂–¥–∞–µ–º—Å—è, —á—Ç–æ JOIN –∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é —É–∂–µ –µ—Å—Ç—å –∏–ª–∏ –¥–æ–±–∞–≤–ª—è–µ–º –µ–≥–æ
        # –í –Ω–∞—à–∏—Ö —Å–ª—É—á–∞—è—Ö –æ–Ω –≤—Å–µ–≥–¥–∞ –±—É–¥–µ—Ç, —Ç–∞–∫ –∫–∞–∫ –º—ã –µ–≥–æ –¥–æ–±–∞–≤–ª—è–µ–º –≤ –±–∞–∑–æ–≤—ã—Ö –∑–∞–ø—Ä–æ—Å–∞—Ö
        query = query.join(model_class.user).filter(
            or_(
                User.full_name.ilike(search_pattern),
                User.email.ilike(search_pattern)
            )
        )
        return query

    def _apply_equipment_search(self, query, search_term: str, model_class):
        """
        –ü—Ä–∏–º–µ–Ω—è–µ—Ç –ø–æ–ª–Ω–æ—Ç–µ–∫—Å—Ç–æ–≤—ã–π –ø–æ–∏—Å–∫ –ø–æ —Å–≤—è–∑–∞–Ω–Ω–æ–º—É –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—é.
        –ò—â–µ—Ç –ø–æ –ø–æ–ª—è–º name, brand, equipment_type.
        """
        search_pattern = f"%{search_term.lower()}%"
        
        # –ü—Ä–∏–º–µ–Ω—è–µ–º —Ñ–∏–ª—å—Ç—Ä –ø–æ–∏—Å–∫–∞ —á–µ—Ä–µ–∑ EXISTS –ø–æ–¥–∑–∞–ø—Ä–æ—Å
        # –≠—Ç–æ –±–æ–ª–µ–µ –±–µ–∑–æ–ø–∞—Å–Ω—ã–π —Å–ø–æ—Å–æ–± –¥–ª—è —Å–≤—è–∑–∞–Ω–Ω—ã—Ö —Ç–∞–±–ª–∏—Ü
        equipment_subquery = select(Equipment.id).where(
            or_(
                Equipment.name.ilike(search_pattern),
                Equipment.brand.ilike(search_pattern),
                Equipment.equipment_type.ilike(search_pattern)
            )
        )
        
        # –î–æ–±–∞–≤–ª—è–µ–º —Ñ–∏–ª—å—Ç—Ä —á–µ—Ä–µ–∑ EXISTS –¥–ª—è —Å–≤—è–∑–∞–Ω–Ω–æ–≥–æ –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—è
        query = query.filter(
            model_class.equipment.any(
                Equipment.id.in_(equipment_subquery)
            )
        )
        
        return query

    def _apply_status_filter(self, query, status_filter: Optional[str], model_class):
        """
        –ü—Ä–∏–º–µ–Ω—è–µ—Ç —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏—é –ø–æ —Å—Ç–∞—Ç—É—Å—É.
        """
        if not status_filter:
            return query
            
        today = date.today()
        
        if status_filter == "active":
            query = query.filter(model_class.status == 'active')
        elif status_filter == "completed":
            # –î–ª—è —Ä–µ–∑–µ—Ä–≤–æ–≤: fulfilled, cancelled, overdue
            # –î–ª—è –∞—Ä–µ–Ω–¥: completed
            if hasattr(model_class, 'status') and 'fulfilled' in str(model_class.status):
                # –≠—Ç–æ —Ä–µ–∑–µ—Ä–≤
                query = query.filter(model_class.status.in_(['fulfilled', 'cancelled', 'overdue']))
            else:
                # –≠—Ç–æ –∞—Ä–µ–Ω–¥–∞
                query = query.filter(model_class.status == 'completed')
        elif status_filter == "overdue":
            query = query.filter(
                model_class.status == 'active',
                model_class.end_date < today
            )
            
        return query

    def _apply_sorting(self, query, sort_option: Optional[str], model_class):
        """
        –ü—Ä–∏–º–µ–Ω—è–µ—Ç —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫—É –ø–æ —Ä–∞–∑–ª–∏—á–Ω—ã–º –ø–æ–ª—è–º.
        –ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º—ã–µ –æ–ø—Ü–∏–∏: id, start_date, end_date, count
        """
        if not sort_option:
            # –°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
            return query.order_by(model_class.id.desc())
        
        sort_parts = sort_option.split('_')
        field = sort_parts[0]
        direction = sort_parts[1] if len(sort_parts) > 1 else 'desc'
        
        # –û–ø—Ä–µ–¥–µ–ª—è–µ–º –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∏
        sort_func = desc if direction == 'desc' else asc
        
        if field == "id":
            query = query.order_by(sort_func(model_class.id))
        elif field == "start_date":
            query = query.order_by(sort_func(model_class.start_date))
        elif field == "end_date":
            query = query.order_by(sort_func(model_class.end_date))
        elif field == "count":
            # –°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞ –ø–æ –∫–æ–ª–∏—á–µ—Å—Ç–≤—É –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—è
            # –î–ª—è —ç—Ç–æ–≥–æ –Ω—É–∂–Ω–æ –ø–æ–¥—Å—á–∏—Ç–∞—Ç—å –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Å–≤—è–∑–∞–Ω–Ω–æ–≥–æ –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—è
            equipment_count = select(func.count()).select_from(
                model_class.equipment.property.mapper.class_.__table__
            ).where(
                model_class.equipment.property.mapper.class_.id.in_(
                    select(model_class.equipment.property.mapper.class_.id)
                    .where(model_class.id == model_class.id)
                )
            ).scalar_subquery()
            
            query = query.order_by(sort_func(equipment_count))
        else:
            # –ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ–µ –ø–æ–ª–µ - –∏—Å–ø–æ–ª—å–∑—É–µ–º —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫—É –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
            query = query.order_by(model_class.id.desc())
            
        return query

    def _apply_pagination(self, query, skip: int, limit: int):
        """
        –ü—Ä–∏–º–µ–Ω—è–µ—Ç –ø–∞–≥–∏–Ω–∞—Ü–∏—é –∫ –∑–∞–ø—Ä–æ—Å—É.
        """
        return query.offset(skip).limit(limit)

    async def _get_total_count(self, base_query) -> int:
        """
        –ü–æ–ª—É—á–∞–µ—Ç –æ–±—â–µ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∑–∞–ø–∏—Å–µ–π –¥–ª—è –±–∞–∑–æ–≤–æ–≥–æ –∑–∞–ø—Ä–æ—Å–∞.
        """
        count_query = select(func.count()).select_from(base_query.subquery())
        result = await self.db.execute(count_query)
        return result.scalar_one()

    def _get_equipment_joins(self):
        """
        –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–µ JOIN'—ã –¥–ª—è –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—è.
        –ü–µ—Ä–µ–æ–ø—Ä–µ–¥–µ–ª—è–µ—Ç—Å—è –≤ –Ω–∞—Å–ª–µ–¥–Ω–∏–∫–∞—Ö –¥–ª—è —Å–ø–µ—Ü–∏—Ñ–∏—á–Ω—ã—Ö –º–æ–¥–µ–ª–µ–π.
        """
        return [
            selectinload(Equipment.accessories),
            selectinload(Equipment.associations)
        ]


```


## <a name="RentalAppFASTAPIapiservicesorderorderrepositorypy"></a>`RentalApp_FASTAPI/api/services/order/order_repository.py`

```python
// path: RentalApp_FASTAPI/api/services/order/order_repository.py

# api/services/order/order_repository.py

from sqlalchemy.ext.asyncio import AsyncSession
from sqlalchemy.orm import joinedload, selectinload
from sqlalchemy import select
from datetime import date
from typing import Optional, List, Dict
import logging

from fastapi import HTTPException, status
from api.models.user import User
from api.models.equipment import Equipment
from api.models.promo_code import PromoCode
from api.models.holiday import Holiday
from api.models.reservation import Reservation, ReservationAccessory
from api.models.rental import Rental, RentalAccessory
from api.services.financial_service import FinancialService, PriceDetails

logger = logging.getLogger(__name__)

class OrderRepository:
    """
    –°–ª–æ–π –¥–æ—Å—Ç—É–ø–∞ –∫ –¥–∞–Ω–Ω—ã–º –¥–ª—è —Å—É—â–Ω–æ—Å—Ç–µ–π, —Å–≤—è–∑–∞–Ω–Ω—ã—Ö —Å –∑–∞–∫–∞–∑–∞–º–∏ (–†–µ–∑–µ—Ä–≤—ã –∏ –ê—Ä–µ–Ω–¥—ã).
    –ò–Ω–∫–∞–ø—Å—É–ª–∏—Ä—É–µ—Ç –≤—Å–µ –ø—Ä—è–º—ã–µ –∑–∞–ø—Ä–æ—Å—ã –∫ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö.
    """
    def __init__(self, db: AsyncSession):
        self.db = db
        self.financial_service = FinancialService(db)

    async def get_user_by_id_or_fail(self, user_id: int) -> User:
        user = await self.db.get(User, user_id)
        if not user:
            raise HTTPException(status_code=status.HTTP_404_NOT_FOUND, detail=f"User with ID {user_id} not found.")
        return user

    async def get_equipment_by_ids_or_fail(self, equipment_ids: List[int]) -> List[Equipment]:
        result = await self.db.execute(
            select(Equipment)
            .filter(Equipment.id.in_(equipment_ids))
            .options(
                selectinload(Equipment.accessories),
                selectinload(Equipment.associations)
            )
        )
        equipment = result.unique().scalars().all()
        if len(equipment) != len(set(equipment_ids)):
            found_ids = {eq.id for eq in equipment}
            missing_ids = set(equipment_ids) - found_ids
            raise HTTPException(status_code=status.HTTP_404_NOT_FOUND, detail=f"Equipment with IDs {list(missing_ids)} not found.")
        return equipment

    async def get_promo_code_by_name(self, code: str) -> Optional[PromoCode]:
        result = await self.db.execute(select(PromoCode).filter(PromoCode.code == code))
        return result.unique().scalar_one_or_none()

    async def get_reservation_by_id_or_fail(self, reservation_id: int, user_id: Optional[int] = None) -> Reservation:
        # –ò—Å–ø–æ–ª—å–∑—É–µ–º –æ–±—ã—á–Ω—ã–π –∑–∞–ø—Ä–æ—Å –¥–ª—è –∏–∑–±–µ–∂–∞–Ω–∏—è –ø—Ä–æ–±–ª–µ–º —Å greenlet
        query = select(Reservation).options(
            joinedload(Reservation.user),
            selectinload(Reservation.equipment).options(
                selectinload(Equipment.accessories),
                selectinload(Equipment.associations)
            ),
            joinedload(Reservation.accessory_links).joinedload(ReservationAccessory.accessory),
            joinedload(Reservation.rental)
        ).filter(Reservation.id == reservation_id)
        
        result = await self.db.execute(query)
        reservation = result.unique().scalar_one_or_none()

        if not reservation:
            raise HTTPException(status_code=status.HTTP_404_NOT_FOUND, detail=f"Reservation with ID {reservation_id} not found")

        if user_id and reservation.user_id != user_id:
            raise HTTPException(status_code=status.HTTP_404_NOT_FOUND, detail="Reservation not found or you do not have permission to access it.")

        return reservation

    async def get_reservations_by_ids(self, ids: List[int]) -> List[Reservation]:
        result = await self.db.execute(select(Reservation).filter(Reservation.id.in_(ids)).options(joinedload(Reservation.rental)))
        return result.unique().scalars().all()

    async def get_rental_by_id_or_fail(self, rental_id: int) -> Rental:
        query = select(Rental).options(
            joinedload(Rental.user),
            selectinload(Rental.equipment).options(
                selectinload(Equipment.accessories),
                selectinload(Equipment.associations)
            ),
            joinedload(Rental.reservation),
            joinedload(Rental.accessory_links).joinedload(RentalAccessory.accessory)
        ).filter(Rental.id == rental_id)

        result = await self.db.execute(query)
        rental = result.unique().scalar_one_or_none()

        if not rental:
            raise HTTPException(status_code=status.HTTP_404_NOT_FOUND, detail=f"Rental with ID {rental_id} not found.")
        return rental

    async def is_holiday(self, check_date: date) -> bool:
        result = await self.db.execute(select(Holiday).filter(Holiday.date == check_date))
        return result.scalar_one_or_none() is not None

    async def get_rental_days_count(self, start_date: date, end_date: date) -> int:
        return await self.financial_service.get_rental_days(start_date, end_date)

    def create_reservation_instance(self, user_id: int, start_date: date, end_date: date, equipment: List[Equipment], price_details: PriceDetails, promo_code_id: Optional[int]) -> Reservation:
        return Reservation(
            user_id=user_id,
            start_date=start_date,
            end_date=end_date,
            equipment=equipment,
            total_cost=price_details.final_total,
            discount_amount=price_details.discount_amount,
            promo_code_id=promo_code_id
        )

    def update_reservation_instance(self, reservation: Reservation, start_date: date, end_date: date, equipment: List[Equipment], price_details: PriceDetails, promo_code_id: Optional[int]):
        reservation.start_date = start_date
        reservation.end_date = end_date
        reservation.equipment = equipment
        reservation.total_cost = price_details.final_total
        reservation.discount_amount = price_details.discount_amount
        reservation.promo_code_id = promo_code_id

    def add_accessories_to_reservation(self, reservation: Reservation, selected_accessories: Optional[Dict[int, List[int]]]):
        if not selected_accessories:
            return
        links = []
        for eq_id, acc_ids in selected_accessories.items():
            for acc_id in acc_ids:
                links.append(ReservationAccessory(equipment_id=eq_id, accessory_id=acc_id))
        reservation.accessory_links = links

    async def update_accessories_for_reservation(self, reservation: Reservation, selected_accessories: Optional[Dict[int, List[int]]]):
        reservation.accessory_links.clear()
        await self.db.flush()
        self.add_accessories_to_reservation(reservation, selected_accessories)

    def create_rental_from_reservation(self, reservation: Reservation, manager: User, deposit: float, notes: Optional[str], recalculated_cost: float, recalculated_discount: float, new_start_date: date, prepayment_amount: float = 0.0) -> Rental:
        reservation.status = 'fulfilled'
        
        # –õ–æ–≥–∏—Ä—É–µ–º –∞–∫—Å–µ—Å—Å—É–∞—Ä—ã —Ä–µ–∑–µ—Ä–≤–∞ –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏
        if reservation.accessory_links:
            accessory_ids = [link.accessory_id for link in reservation.accessory_links]
            logger.info(f"–¢–û–ß–ö–ê 1 (–ö–û–ü–ò–†–û–í–ê–ù–ò–ï): –†–µ–∑–µ—Ä–≤ #{reservation.id} –∏–º–µ–µ—Ç –∞–∫—Å–µ—Å—Å—É–∞—Ä—ã —Å ID: {accessory_ids}")
        else:
            logger.warning(f"–¢–û–ß–ö–ê 1 (–ö–û–ü–ò–†–û–í–ê–ù–ò–ï): –í –∏—Å—Ö–æ–¥–Ω–æ–º —Ä–µ–∑–µ—Ä–≤–µ #{reservation.id} –∞–∫—Å–µ—Å—Å—É–∞—Ä—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã.")
        
        # –°–æ–∑–¥–∞–µ–º –∞—Ä–µ–Ω–¥—É —Å –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ–º –∞–∫—Å–µ—Å—Å—É–∞—Ä–æ–≤ –≤ –∫–æ–Ω—Å—Ç—Ä—É–∫—Ç–æ—Ä–µ
        rental = Rental(
            user_id=reservation.user_id,
            created_by_id=manager.id,
            reservation_id=reservation.id,
            equipment=reservation.equipment,
            start_date=new_start_date,
            end_date=reservation.end_date,
            # –ò—Å–ø–æ–ª—å–∑—É–µ–º –Ω–æ–≤—ã–µ, –ø–µ—Ä–µ—Å—á–∏—Ç–∞–Ω–Ω—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è
            total_cost=recalculated_cost,
            discount_amount=recalculated_discount,
            promo_code=reservation.promo_code,
            deposit_amount=deposit,
            prepayment_amount=prepayment_amount,
            notes_on_issue=notes,
            # –ü–µ—Ä–µ–¥–∞–µ–º –∞–∫—Å–µ—Å—Å—É–∞—Ä—ã –¥–ª—è –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è –≤ –∫–æ–Ω—Å—Ç—Ä—É–∫—Ç–æ—Ä
            reservation_accessories=reservation.accessory_links
        )

        # –õ–æ–≥–∏—Ä—É–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è
        if rental.accessory_links:
            copied_ids = [link.accessory_id for link in rental.accessory_links]
            logger.info(f"–¢–û–ß–ö–ê 1 (–ö–û–ü–ò–†–û–í–ê–ù–ò–ï): –í –æ–±—ä–µ–∫—Ç –∞—Ä–µ–Ω–¥—ã (–≤ –ø–∞–º—è—Ç–∏) —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω—ã –∞–∫—Å–µ—Å—Å—É–∞—Ä—ã —Å ID: {copied_ids}")

        return rental

    def create_rental_instance(self, user: User, manager: User, start_date: date, end_date: date, equipment: List[Equipment], total_cost: float, deposit_amount: float, notes_on_issue: Optional[str]) -> Rental:
        return Rental(
            user_id=user.id,
            created_by_id=manager.id,
            equipment=equipment,
            start_date=start_date,
            end_date=end_date,
            total_cost=total_cost,
            deposit_amount=deposit_amount,
            notes_on_issue=notes_on_issue
        )

    async def calculate_early_return_credit(self, rental: Rental, actual_return_date: date, planned_days: int) -> float:
        """
        –†–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ—Ç –∫—Ä–µ–¥–∏—Ç –∑–∞ –¥–æ—Å—Ä–æ—á–Ω—ã–π –≤–æ–∑–≤—Ä–∞—Ç –∞—Ä–µ–Ω–¥—ã.
        –î–µ–ª–µ–≥–∏—Ä—É–µ—Ç —Ä–∞—Å—á–µ—Ç –≤ FinancialService –¥–ª—è —Å–æ–±–ª—é–¥–µ–Ω–∏—è –ø—Ä–∏–Ω—Ü–∏–ø–∞ DRY.
        """
        return await self.financial_service.calculate_early_return_credit(rental, actual_return_date, planned_days)

    async def calculate_overdue_surcharge(self, rental: Rental, actual_return_date: date) -> float:
        """
        –†–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ—Ç —à—Ç—Ä–∞—Ñ –∑–∞ –ø—Ä–æ—Å—Ä–æ—á–µ–Ω–Ω—ã–µ –¥–Ω–∏ –∞—Ä–µ–Ω–¥—ã.
        –î–µ–ª–µ–≥–∏—Ä—É–µ—Ç —Ä–∞—Å—á–µ—Ç –≤ FinancialService –¥–ª—è —Å–æ–±–ª—é–¥–µ–Ω–∏—è –ø—Ä–∏–Ω—Ü–∏–ø–∞ DRY.
        """
        return await self.financial_service.calculate_overdue_surcharge(rental, actual_return_date)

    def finalize_rental_return(self, rental: Rental, return_date: date, notes: Optional[str], credit: float, surcharge: float = 0.0):
        rental.status = 'completed'
        rental.actual_return_date = return_date
        rental.notes_on_return = notes
        rental.final_cost = rental.total_cost - credit + surcharge

    def update_rental_instance(self, rental: Rental, update_data: dict):
        for key, value in update_data.items():
            setattr(rental, key, value)

    def revert_rental_status_to_active(self, rental: Rental) -> Reservation:
        reservation = rental.reservation
        reservation.status = 'active'
        return reservation

    async def save(self, instance: object):
        if isinstance(instance, Rental) and instance.accessory_links:
            accessory_ids = [link.accessory_id for link in instance.accessory_links]
            logger.info(f"–¢–û–ß–ö–ê 2 (–°–û–•–†–ê–ù–ï–ù–ò–ï): –ü–µ—Ä–µ–¥ –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ–º –≤ —Å–µ—Å—Å–∏—é –∞—Ä–µ–Ω–¥–∞ #{instance.id} –∏–º–µ–µ—Ç –∞–∫—Å–µ—Å—Å—É–∞—Ä—ã —Å ID: {accessory_ids}")
        self.db.add(instance)
        await self.db.flush()  # –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ –≤—ã–ø–æ–ª–Ω—è–µ–º SQL –±–µ–∑ –∫–æ–º–º–∏—Ç–∞

    async def delete(self, instance: object):
        await self.db.delete(instance)
        await self.db.flush()  # –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ –≤—ã–ø–æ–ª–Ω—è–µ–º SQL –±–µ–∑ –∫–æ–º–º–∏—Ç–∞

```


## <a name="RentalAppFASTAPIapiservicesorderordervalidatorpy"></a>`RentalApp_FASTAPI/api/services/order/order_validator.py`

```python
// path: RentalApp_FASTAPI/api/services/order/order_validator.py

#RentalApp_FASTAPI/api/services/order/order_validator.py

from sqlalchemy.ext.asyncio import AsyncSession
from sqlalchemy import select
from datetime import date, datetime, timezone
from typing import List, Optional, Dict, Tuple

from fastapi import HTTPException, status
from api.models.reservation import Reservation
from api.models.rental import Rental
from api.models.holiday import Holiday
from api.services.availability import AvailabilityService
from api.services.financial_service import FinancialService

class OrderValidator:
    """
    –°–ª–æ–π –¥–ª—è –≤–∞–ª–∏–¥–∞—Ü–∏–∏ –±–∏–∑–Ω–µ—Å-–ø—Ä–∞–≤–∏–ª, —Å–≤—è–∑–∞–Ω–Ω—ã—Ö —Å –†–µ–∑–µ—Ä–≤–∞–º–∏ –∏ –ê—Ä–µ–Ω–¥–∞–º–∏.
    """
    def __init__(self, db: AsyncSession):
        self.db = db
        self.financial_service = FinancialService(db)
        self.availability_service = AvailabilityService(db)

    async def validate_dates_and_holidays(self, start_date: date, end_date: date, force_issue_on_holiday: bool = False):
        """
        –ü—Ä–æ–≤–µ—Ä—è–µ—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ—Å—Ç—å –¥–∏–∞–ø–∞–∑–æ–Ω–∞ –¥–∞—Ç –∏ —Ç–æ, —á—Ç–æ –æ–Ω –Ω–µ –ø–æ–ø–∞–¥–∞–µ—Ç –Ω–∞ –≤—ã—Ö–æ–¥–Ω—ã–µ.
        –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏/—Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–∏ —Ä–µ–∑–µ—Ä–≤–æ–≤ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º–∏.
        """
        self.financial_service.validate_date_range(start_date, end_date)
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º –≤—ã—Ö–æ–¥–Ω—ã–µ –¥–Ω–∏ –¥–ª—è –∞—Ä–µ–Ω–¥ (–≤–æ–∑–≤—Ä–∞—â–∞–µ–º 409 —Å —Ç–∏–ø–æ–º ISSUE_ON_HOLIDAY)
        start_result = await self.db.execute(select(Holiday).filter(Holiday.date == start_date))
        is_start_holiday = start_result.scalar_one_or_none()

        end_result = await self.db.execute(select(Holiday).filter(Holiday.date == end_date))
        is_end_holiday = end_result.scalar_one_or_none()

        if is_start_holiday and not force_issue_on_holiday:
            raise HTTPException(
                status_code=status.HTTP_409_CONFLICT,
                detail={
                    "error_type": "ISSUE_ON_HOLIDAY",
                    "message": f"–î–∞—Ç–∞ –≤—ã–¥–∞—á–∏ ({start_date.strftime('%d.%m.%Y')}) —è–≤–ª—è–µ—Ç—Å—è –≤—ã—Ö–æ–¥–Ω—ã–º –¥–Ω–µ–º."
                }
            )
        
        if is_end_holiday and not force_issue_on_holiday:
            raise HTTPException(
                status_code=status.HTTP_409_CONFLICT,
                detail={
                    "error_type": "ISSUE_ON_HOLIDAY",
                    "message": f"–î–∞—Ç–∞ –æ–∫–æ–Ω—á–∞–Ω–∏—è ({end_date.strftime('%d.%m.%Y')}) —è–≤–ª—è–µ—Ç—Å—è –≤—ã—Ö–æ–¥–Ω—ã–º –¥–Ω–µ–º."
                }
            )

    async def validate_issue_on_holiday(self, issue_date: date, force: bool):
        """
        –ü—Ä–æ–≤–µ—Ä—è–µ—Ç, —è–≤–ª—è–µ—Ç—Å—è –ª–∏ –¥–∞—Ç–∞ –≤—ã–¥–∞—á–∏ –≤—ã—Ö–æ–¥–Ω—ã–º –¥–Ω–µ–º.
        –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç –æ—à–∏–±–∫—É 409 Conflict, –µ—Å–ª–∏ —ç—Ç–æ —Ç–∞–∫ –∏ –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω —Ñ–ª–∞–≥ force.
        –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –≤ –∞–¥–º–∏–Ω-–ø–∞–Ω–µ–ª–∏ –ø—Ä–∏ –∫–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏–∏ —Ä–µ–∑–µ—Ä–≤–∞ –≤ –∞—Ä–µ–Ω–¥—É.
        """
        is_holiday_result = await self.db.execute(select(Holiday).filter(Holiday.date == issue_date))
        is_holiday = is_holiday_result.scalar_one_or_none()
        
        if is_holiday and not force:
            raise HTTPException(
                status_code=status.HTTP_409_CONFLICT,
                detail={
                    "error_type": "ISSUE_ON_HOLIDAY",
                    "message": f"–î–∞—Ç–∞ –≤—ã–¥–∞—á–∏ ({issue_date.strftime('%d.%m.%Y')}) —è–≤–ª—è–µ—Ç—Å—è –≤—ã—Ö–æ–¥–Ω—ã–º –¥–Ω–µ–º. –ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç–µ –¥–µ–π—Å—Ç–≤–∏–µ –¥–ª—è –ø—Ä–æ–¥–æ–ª–∂–µ–Ω–∏—è."
                }
            )

    async def validate_equipment_availability(self, equipment_ids: list[int], start_date: date, end_date: date, exclude_reservation_id: Optional[int] = None):
        conflicting_ids = await self.availability_service.get_conflicting_equipment_ids(
            equipment_ids, start_date, end_date, exclude_reservation_id
        )
        if conflicting_ids:
            raise HTTPException(
                status_code=status.HTTP_409_CONFLICT,
                detail=f"–û–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏–µ —Å ID {conflicting_ids} –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–æ –≤ –≤—ã–±—Ä–∞–Ω–Ω—ã–π –ø–µ—Ä–∏–æ–¥."
            )

    def validate_accessories_for_equipment(self, selected_accessories: Optional[Dict[int, List[int]]], equipment_ids: List[int]):
        if not selected_accessories:
            return

        accessory_eq_ids = set(selected_accessories.keys())
        if not accessory_eq_ids.issubset(set(equipment_ids)):
            missing_eq_ids = accessory_eq_ids - set(equipment_ids)
            raise HTTPException(status_code=status.HTTP_400_BAD_REQUEST, detail=f"–ê–∫—Å–µ—Å—Å—É–∞—Ä—ã –Ω–µ –º–æ–≥—É—Ç –±—ã—Ç—å –≤—ã–±—Ä–∞–Ω—ã –¥–ª—è –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—è, –æ—Ç—Å—É—Ç—Å—Ç–≤—É—é—â–µ–≥–æ –≤ —Ä–µ–∑–µ—Ä–≤–µ. –ù–µ–≤–µ—Ä–Ω—ã–µ ID –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—è: {list(missing_eq_ids)}")

    def validate_reservation_is_cancellable(self, reservation: Reservation):
        if reservation.rental:
            raise HTTPException(status_code=status.HTTP_409_CONFLICT, detail=f"–ù–µ–ª—å–∑—è –æ—Ç–º–µ–Ω–∏—Ç—å —Ä–µ–∑–µ—Ä–≤, —Ç–∞–∫ –∫–∞–∫ –æ–Ω –±—ã–ª –ø—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞–Ω –≤ –∞—Ä–µ–Ω–¥—É #{reservation.rental.id}.")

    def filter_cancellable_reservations(self, reservations: List[Reservation]) -> Tuple[List[Reservation], List[Reservation]]:
        cancellable = [r for r in reservations if not r.rental]
        not_cancellable = [r for r in reservations if r.rental]
        return cancellable, not_cancellable

    def validate_reservation_for_conversion(self, reservation: Reservation):
        if reservation.status != 'active':
            raise HTTPException(status_code=status.HTTP_409_CONFLICT, detail="–†–µ–∑–µ—Ä–≤ —É–∂–µ –≤—ã–ø–æ–ª–Ω–µ–Ω –∏–ª–∏ –æ—Ç–º–µ–Ω–µ–Ω.")
        if reservation.rental:
            raise HTTPException(status_code=status.HTTP_409_CONFLICT, detail=f"–†–µ–∑–µ—Ä–≤ —É–∂–µ –±—ã–ª –ø—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞–Ω –≤ –∞—Ä–µ–Ω–¥—É #{reservation.rental.id}.")

    def validate_accessories_returned(self, rental: Rental, confirmation: bool):
        if rental.accessory_links and not confirmation:
            raise HTTPException(status_code=status.HTTP_400_BAD_REQUEST, detail="–¢—Ä–µ–±—É–µ—Ç—Å—è –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –≤–æ–∑–≤—Ä–∞—Ç–∞ –≤—Å–µ—Ö –∞–∫—Å–µ—Å—Å—É–∞—Ä–æ–≤.")

    def validate_rental_for_revert(self, rental: Rental):
        if not rental.reservation_id:
            raise HTTPException(status_code=status.HTTP_400_BAD_REQUEST, detail="–ù–µ–ª—å–∑—è –æ—Ç–º–µ–Ω–∏—Ç—å –∞—Ä–µ–Ω–¥—É, —Å–æ–∑–¥–∞–Ω–Ω—É—é –±–µ–∑ —Ä–µ–∑–µ—Ä–≤–∞.")
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –∞—Ä–µ–Ω–¥–∞ –Ω–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∞
        if rental.status == 'completed':
            raise HTTPException(status_code=status.HTTP_409_CONFLICT, detail="–ù–µ–ª—å–∑—è –æ—Ç–º–µ–Ω–∏—Ç—å –≤—ã–¥–∞—á—É –¥–ª—è —É–∂–µ –∑–∞–≤–µ—Ä—à–µ–Ω–Ω–æ–π –∞—Ä–µ–Ω–¥—ã.")
        
        # –°—Ä–∞–≤–Ω–∏–≤–∞–µ–º –¥–∞—Ç—É —Å–æ–∑–¥–∞–Ω–∏—è –∞—Ä–µ–Ω–¥—ã (–≤ UTC) —Å —Ç–µ–∫—É—â–µ–π –¥–∞—Ç–æ–π (–≤ UTC),
        # —á—Ç–æ–±—ã –∏–∑–±–µ–∂–∞—Ç—å –ø—Ä–æ–±–ª–µ–º —Å —á–∞—Å–æ–≤—ã–º–∏ –ø–æ—è—Å–∞–º–∏ –Ω–∞ –≥—Ä–∞–Ω–∏—Ü–µ —Å—É—Ç–æ–∫.
        if rental.created_at.date() != datetime.now(timezone.utc).date():
            raise HTTPException(status_code=status.HTTP_403_FORBIDDEN, detail="–û—Ç–º–µ–Ω–∞ –≤—ã–¥–∞—á–∏ –≤–æ–∑–º–æ–∂–Ω–∞ —Ç–æ–ª—å–∫–æ –≤ –¥–µ–Ω—å —Å–æ–∑–¥–∞–Ω–∏—è –∞—Ä–µ–Ω–¥—ã.")

```


## <a name="RentalAppFASTAPIapiservicespromocodeinitpy"></a>`RentalApp_FASTAPI/api/services/promo_code/__init__.py`

```python
// path: RentalApp_FASTAPI/api/services/promo_code/__init__.py

# api/services/promo_code/__init__.py

from .promo_code_validator import PromoCodeValidator
from .promo_code_manager import PromoCodeManager
from .promo_code_business_logic import PromoCodeBusinessLogic
from .factory import PromoCodeServiceFactory
from .interfaces import IPromoCodeValidator, IPromoCodeManager, IPromoCodeBusinessLogic

__all__ = [
    'PromoCodeValidator',
    'PromoCodeManager', 
    'PromoCodeBusinessLogic',
    'PromoCodeServiceFactory',
    'IPromoCodeValidator',
    'IPromoCodeManager',
    'IPromoCodeBusinessLogic'
] 

```


## <a name="RentalAppFASTAPIapiservicespromocodeconstantspy"></a>`RentalApp_FASTAPI/api/services/promo_code/constants.py`

```python
// path: RentalApp_FASTAPI/api/services/promo_code/constants.py

# api/services/promo_code/constants.py

from fastapi import status

# –°–æ–æ–±—â–µ–Ω–∏—è –æ–± –æ—à–∏–±–∫–∞—Ö
ERROR_MESSAGES = {
    'NOT_FOUND': '–ü—Ä–æ–º–æ–∫–æ–¥ –Ω–µ –Ω–∞–π–¥–µ–Ω',
    'INACTIVE': '–ü—Ä–æ–º–æ–∫–æ–¥ –Ω–µ–∞–∫—Ç–∏–≤–µ–Ω',
    'NOT_STARTED': '–ü—Ä–æ–º–æ–∫–æ–¥ –µ—â–µ –Ω–µ –Ω–∞—á–∞–ª –¥–µ–π—Å—Ç–≤–æ–≤–∞—Ç—å',
    'EXPIRED': '–°—Ä–æ–∫ –¥–µ–π—Å—Ç–≤–∏—è –ø—Ä–æ–º–æ–∫–æ–¥–∞ –∏—Å—Ç–µ–∫',
    'USAGE_LIMIT_EXCEEDED': '–õ–∏–º–∏—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–π —ç—Ç–æ–≥–æ –ø—Ä–æ–º–æ–∫–æ–¥–∞ –∏—Å—á–µ—Ä–ø–∞–Ω',
    'MIN_ORDER_AMOUNT': '–ú–∏–Ω–∏–º–∞–ª—å–Ω–∞—è —Å—É–º–º–∞ –∑–∞–∫–∞–∑–∞ –¥–ª—è —ç—Ç–æ–≥–æ –∫–æ–¥–∞: {amount} ‚ÇΩ',
    'INVALID_EQUIPMENT': '–ü—Ä–æ–º–æ–∫–æ–¥ –Ω–µ –¥–µ–π—Å—Ç–≤—É–µ—Ç –Ω–∞ –≤—ã–±—Ä–∞–Ω–Ω—ã–µ —Ç–æ–≤–∞—Ä—ã',
    'INVALID_EQUIPMENT_TYPE': '–ü—Ä–æ–º–æ–∫–æ–¥ –Ω–µ –¥–µ–π—Å—Ç–≤—É–µ—Ç –Ω–∞ –≤—ã–±—Ä–∞–Ω–Ω—ã–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ —Ç–æ–≤–∞—Ä–æ–≤',
    'PERSONAL_CODE_FORBIDDEN': '–≠—Ç–æ –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã–π –ø—Ä–æ–º–æ–∫–æ–¥ –¥–ª—è –¥—Ä—É–≥–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è',
    'USER_USAGE_LIMIT': '–í—ã —É–∂–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–ª–∏ —ç—Ç–æ—Ç –ø—Ä–æ–º–æ–∫–æ–¥ –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ä–∞–∑',
    'CODE_EXISTS': '–ü—Ä–æ–º–æ–∫–æ–¥ —Å —Ç–∞–∫–∏–º –∫–æ–¥–æ–º —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç',
    'EQUIPMENT_NOT_FOUND': '–û–¥–Ω–æ –∏–ª–∏ –Ω–µ—Å–∫–æ–ª—å–∫–æ –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏–π –¥–ª—è –ø—Ä–æ–º–æ–∫–æ–¥–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã.',
    'MANAGER_DISCOUNT_LIMIT': '–ú–µ–Ω–µ–¥–∂–µ—Ä—ã –Ω–µ –º–æ–≥—É—Ç —Å–æ–∑–¥–∞–≤–∞—Ç—å —Å–∫–∏–¥–∫—É –±–æ–ª–µ–µ 20%',
    'ADMIN_DISCOUNT_LIMIT': '–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—ã –Ω–µ –º–æ–≥—É—Ç —Å–æ–∑–¥–∞–≤–∞—Ç—å —Å–∫–∏–¥–∫—É –±–æ–ª–µ–µ 50%'
}

# –ö–æ–¥—ã —Å—Ç–∞—Ç—É—Å–æ–≤ HTTP
HTTP_STATUS_CODES = {
    'NOT_FOUND': status.HTTP_404_NOT_FOUND,
    'BAD_REQUEST': status.HTTP_400_BAD_REQUEST,
    'FORBIDDEN': status.HTTP_403_FORBIDDEN,
    'CONFLICT': status.HTTP_409_CONFLICT
}

# –õ–∏–º–∏—Ç—ã —Å–∫–∏–¥–æ–∫ –ø–æ —Ä–æ–ª—è–º
DISCOUNT_LIMITS = {
    'manager': 20,
    'admin': 50
}

# –ú–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–π –∫–æ–º–±–∏–Ω–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –ø—Ä–æ—Ü–µ–Ω—Ç —Å–∫–∏–¥–∫–∏
MAX_COMBINED_DISCOUNT = 75 

```


## <a name="RentalAppFASTAPIapiservicespromocodeexceptionspy"></a>`RentalApp_FASTAPI/api/services/promo_code/exceptions.py`

```python
// path: RentalApp_FASTAPI/api/services/promo_code/exceptions.py

# api/services/promo_code/exceptions.py

from fastapi import HTTPException
from .constants import ERROR_MESSAGES, HTTP_STATUS_CODES


class PromoCodeException(HTTPException):
    """–ë–∞–∑–æ–≤–æ–µ –∏—Å–∫–ª—é—á–µ–Ω–∏–µ –¥–ª—è –ø—Ä–æ–º–æ–∫–æ–¥–æ–≤"""
    pass


class PromoCodeNotFoundError(PromoCodeException):
    def __init__(self):
        super().__init__(
            status_code=HTTP_STATUS_CODES['NOT_FOUND'],
            detail=ERROR_MESSAGES['NOT_FOUND']
        )


class PromoCodeInactiveError(PromoCodeException):
    def __init__(self):
        super().__init__(
            status_code=HTTP_STATUS_CODES['BAD_REQUEST'],
            detail=ERROR_MESSAGES['INACTIVE']
        )


class PromoCodeNotStartedError(PromoCodeException):
    def __init__(self):
        super().__init__(
            status_code=HTTP_STATUS_CODES['BAD_REQUEST'],
            detail=ERROR_MESSAGES['NOT_STARTED']
        )


class PromoCodeExpiredError(PromoCodeException):
    def __init__(self):
        super().__init__(
            status_code=HTTP_STATUS_CODES['BAD_REQUEST'],
            detail=ERROR_MESSAGES['EXPIRED']
        )


class PromoCodeUsageLimitExceededError(PromoCodeException):
    def __init__(self):
        super().__init__(
            status_code=HTTP_STATUS_CODES['BAD_REQUEST'],
            detail=ERROR_MESSAGES['USAGE_LIMIT_EXCEEDED']
        )


class PromoCodeMinOrderAmountError(PromoCodeException):
    def __init__(self, min_amount: float):
        super().__init__(
            status_code=HTTP_STATUS_CODES['BAD_REQUEST'],
            detail=ERROR_MESSAGES['MIN_ORDER_AMOUNT'].format(amount=min_amount)
        )


class PromoCodeInvalidEquipmentError(PromoCodeException):
    def __init__(self):
        super().__init__(
            status_code=HTTP_STATUS_CODES['BAD_REQUEST'],
            detail=ERROR_MESSAGES['INVALID_EQUIPMENT']
        )


class PromoCodeInvalidEquipmentTypeError(PromoCodeException):
    def __init__(self):
        super().__init__(
            status_code=HTTP_STATUS_CODES['BAD_REQUEST'],
            detail=ERROR_MESSAGES['INVALID_EQUIPMENT_TYPE']
        )


class PromoCodePersonalCodeForbiddenError(PromoCodeException):
    def __init__(self):
        super().__init__(
            status_code=HTTP_STATUS_CODES['FORBIDDEN'],
            detail=ERROR_MESSAGES['PERSONAL_CODE_FORBIDDEN']
        )


class PromoCodeUserUsageLimitError(PromoCodeException):
    def __init__(self):
        super().__init__(
            status_code=HTTP_STATUS_CODES['BAD_REQUEST'],
            detail=ERROR_MESSAGES['USER_USAGE_LIMIT']
        )


class PromoCodeExistsError(PromoCodeException):
    def __init__(self):
        super().__init__(
            status_code=HTTP_STATUS_CODES['CONFLICT'],
            detail=ERROR_MESSAGES['CODE_EXISTS']
        )


class PromoCodeEquipmentNotFoundError(PromoCodeException):
    def __init__(self):
        super().__init__(
            status_code=HTTP_STATUS_CODES['NOT_FOUND'],
            detail=ERROR_MESSAGES['EQUIPMENT_NOT_FOUND']
        )


class PromoCodeDiscountLimitError(PromoCodeException):
    def __init__(self, role: str):
        message_key = f'{role.upper()}_DISCOUNT_LIMIT'
        super().__init__(
            status_code=HTTP_STATUS_CODES['FORBIDDEN'],
            detail=ERROR_MESSAGES[message_key]
        ) 

```


## <a name="RentalAppFASTAPIapiservicespromocodefactorypy"></a>`RentalApp_FASTAPI/api/services/promo_code/factory.py`

```python
// path: RentalApp_FASTAPI/api/services/promo_code/factory.py

# api/services/promo_code/factory.py

from sqlalchemy.ext.asyncio import AsyncSession
from .promo_code_validator import PromoCodeValidator
from .promo_code_manager import PromoCodeManager
from .promo_code_business_logic import PromoCodeBusinessLogic


class PromoCodeServiceFactory:
    """–§–∞–±—Ä–∏–∫–∞ –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è —Å–µ—Ä–≤–∏—Å–æ–≤ –ø—Ä–æ–º–æ–∫–æ–¥–æ–≤"""
    
    @staticmethod
    def create_validator(db: AsyncSession) -> PromoCodeValidator:
        """–°–æ–∑–¥–∞–µ—Ç –≤–∞–ª–∏–¥–∞—Ç–æ—Ä –ø—Ä–æ–º–æ–∫–æ–¥–æ–≤"""
        return PromoCodeValidator(db)
    
    @staticmethod
    def create_manager(db: AsyncSession) -> PromoCodeManager:
        """–°–æ–∑–¥–∞–µ—Ç –º–µ–Ω–µ–¥–∂–µ—Ä –ø—Ä–æ–º–æ–∫–æ–¥–æ–≤"""
        return PromoCodeManager(db)
    
    @staticmethod
    def create_business_logic(db: AsyncSession) -> PromoCodeBusinessLogic:
        """–°–æ–∑–¥–∞–µ—Ç –±–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫—É –ø—Ä–æ–º–æ–∫–æ–¥–æ–≤"""
        return PromoCodeBusinessLogic(db)
    
    @staticmethod
    def create_all_services(db: AsyncSession) -> tuple[PromoCodeValidator, PromoCodeManager, PromoCodeBusinessLogic]:
        """–°–æ–∑–¥–∞–µ—Ç –≤—Å–µ —Å–µ—Ä–≤–∏—Å—ã –ø—Ä–æ–º–æ–∫–æ–¥–æ–≤"""
        validator = PromoCodeValidator(db)
        manager = PromoCodeManager(db)
        business_logic = PromoCodeBusinessLogic(db)
        
        return validator, manager, business_logic 

```


## <a name="RentalAppFASTAPIapiservicespromocodeinterfacespy"></a>`RentalApp_FASTAPI/api/services/promo_code/interfaces.py`

```python
// path: RentalApp_FASTAPI/api/services/promo_code/interfaces.py

# api/services/promo_code/interfaces.py

from abc import ABC, abstractmethod
from typing import Optional, List
from sqlalchemy.orm import Session

from api.models.promo_code import PromoCode
from api.models.user import User
from shared.schemas.promo_code_schema import PromoCodeCreate, PromoCodeUpdate, PromoCodeValidateResponse


class IPromoCodeValidator(ABC):
    """–ò–Ω—Ç–µ—Ä—Ñ–µ–π—Å –¥–ª—è –≤–∞–ª–∏–¥–∞—Ç–æ—Ä–∞ –ø—Ä–æ–º–æ–∫–æ–¥–æ–≤"""
    
    @abstractmethod
    def validate_complete(self, code: str, order_amount: float, equipment_ids: List[int], user: Optional[User]) -> PromoCode:
        """–í—ã–ø–æ–ª–Ω—è–µ—Ç –ø–æ–ª–Ω—É—é –≤–∞–ª–∏–¥–∞—Ü–∏—é –ø—Ä–æ–º–æ–∫–æ–¥–∞"""
        pass


class IPromoCodeManager(ABC):
    """–ò–Ω—Ç–µ—Ä—Ñ–µ–π—Å –¥–ª—è –º–µ–Ω–µ–¥–∂–µ—Ä–∞ –ø—Ä–æ–º–æ–∫–æ–¥–æ–≤"""
    
    @abstractmethod
    def create_promo_code(self, promo_data: PromoCodeCreate, creator: User) -> PromoCode:
        """–°–æ–∑–¥–∞–µ—Ç –Ω–æ–≤—ã–π –ø—Ä–æ–º–æ–∫–æ–¥"""
        pass
    
    @abstractmethod
    def get_all_promo_codes(self) -> List[PromoCode]:
        """–ü–æ–ª—É—á–∞–µ—Ç –≤—Å–µ –ø—Ä–æ–º–æ–∫–æ–¥—ã"""
        pass
    
    @abstractmethod
    def get_promo_code_by_id(self, promo_code_id: int) -> Optional[PromoCode]:
        """–ü–æ–ª—É—á–∞–µ—Ç –ø—Ä–æ–º–æ–∫–æ–¥ –ø–æ ID"""
        pass
    
    @abstractmethod
    def update_promo_code(self, promo_code_id: int, update_data: PromoCodeUpdate) -> PromoCode:
        """–û–±–Ω–æ–≤–ª—è–µ—Ç –ø—Ä–æ–º–æ–∫–æ–¥"""
        pass
    
    @abstractmethod
    def delete_promo_code(self, promo_code_id: int) -> None:
        """–£–¥–∞–ª—è–µ—Ç –ø—Ä–æ–º–æ–∫–æ–¥"""
        pass
    
    @abstractmethod
    def generate_unique_code(self) -> str:
        """–ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç —É–Ω–∏–∫–∞–ª—å–Ω—ã–π –∫–æ–¥"""
        pass


class IPromoCodeBusinessLogic(ABC):
    """–ò–Ω—Ç–µ—Ä—Ñ–µ–π—Å –¥–ª—è –±–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫–∏ –ø—Ä–æ–º–æ–∫–æ–¥–æ–≤"""
    
    @abstractmethod
    def validate_and_get_promo_code(self, code: str, order_amount: float, equipment_ids: List[int], user: Optional[User]) -> PromoCode:
        """–í–∞–ª–∏–¥–∏—Ä—É–µ—Ç –ø—Ä–æ–º–æ–∫–æ–¥ –∏ –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –µ–≥–æ"""
        pass
    
    @abstractmethod
    def create_validation_response(self, promo_code: PromoCode) -> PromoCodeValidateResponse:
        """–°–æ–∑–¥–∞–µ—Ç –æ—Ç–≤–µ—Ç –¥–ª—è –≤–∞–ª–∏–¥–∞—Ü–∏–∏"""
        pass
    
    @abstractmethod
    def record_promo_code_usage(self, promo_code: PromoCode, user: Optional[User]) -> None:
        """–ó–∞–ø–∏—Å—ã–≤–∞–µ—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –ø—Ä–æ–º–æ–∫–æ–¥–∞"""
        pass
    
    @abstractmethod
    def calculate_discount_amount(self, base_amount: float, promo_code: PromoCode) -> float:
        """–†–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ—Ç —Å—É–º–º—É —Å–∫–∏–¥–∫–∏"""
        pass
    
    @abstractmethod
    def validate_combined_discount(self, duration_discount: float, promo_discount: float) -> float:
        """–í–∞–ª–∏–¥–∏—Ä—É–µ—Ç –∫–æ–º–±–∏–Ω–∏—Ä–æ–≤–∞–Ω–Ω—É—é —Å–∫–∏–¥–∫—É"""
        pass 

```


## <a name="RentalAppFASTAPIapiservicespromocodepromocodebusinesslogicpy"></a>`RentalApp_FASTAPI/api/services/promo_code/promo_code_business_logic.py`

```python
// path: RentalApp_FASTAPI/api/services/promo_code/promo_code_business_logic.py

# api/services/promo_code/promo_code_business_logic.py

from sqlalchemy.ext.asyncio import AsyncSession
from sqlalchemy import select
from typing import Optional, List
from datetime import datetime, timezone

from api.models.promo_code import PromoCode, promo_code_usages
from api.models.user import User
from shared.schemas.promo_code_schema import PromoCodeValidateResponse
from .promo_code_validator import PromoCodeValidator
from .constants import MAX_COMBINED_DISCOUNT
from .interfaces import IPromoCodeBusinessLogic


class PromoCodeBusinessLogic(IPromoCodeBusinessLogic):
    """–ë–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫–∞ –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –ø—Ä–æ–º–æ–∫–æ–¥–∞–º–∏"""
    
    def __init__(self, db: AsyncSession):
        self.db = db
        self.validator = PromoCodeValidator(db)
    
    async def validate_and_get_promo_code(
        self, 
        code: str, 
        order_amount: float, 
        equipment_ids: List[int], 
        user: Optional[User]
    ) -> PromoCode:
        """
        –í–∞–ª–∏–¥–∏—Ä—É–µ—Ç –ø—Ä–æ–º–æ–∫–æ–¥ –∏ –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –µ–≥–æ –æ–±—ä–µ–∫—Ç.
        –û—Å–Ω–æ–≤–Ω–æ–π –º–µ—Ç–æ–¥ –¥–ª—è –≤–∞–ª–∏–¥–∞—Ü–∏–∏ –ø—Ä–æ–º–æ–∫–æ–¥–æ–≤.
        """
        return await self.validator.validate_complete(code, order_amount, equipment_ids, user)
    
    def create_validation_response(self, promo_code: PromoCode) -> PromoCodeValidateResponse:
        """–°–æ–∑–¥–∞–µ—Ç –æ—Ç–≤–µ—Ç –¥–ª—è –≤–∞–ª–∏–¥–∞—Ü–∏–∏ –ø—Ä–æ–º–æ–∫–æ–¥–∞"""
        return PromoCodeValidateResponse(
            code=promo_code.code,
            discount_percentage=promo_code.discount_percentage,
            message="–ü—Ä–æ–º–æ–∫–æ–¥ —É—Å–ø–µ—à–Ω–æ –ø—Ä–∏–º–µ–Ω–µ–Ω!"
        )
    
    async def record_promo_code_usage(self, promo_code: PromoCode, user: Optional[User]) -> None:
        """
        –ó–∞–ø–∏—Å—ã–≤–∞–µ—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –ø—Ä–æ–º–æ–∫–æ–¥–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º.
        –£–≤–µ–ª–∏—á–∏–≤–∞–µ—Ç —Å—á–µ—Ç—á–∏–∫ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–π.
        """
        # –£–≤–µ–ª–∏—á–∏–≤–∞–µ–º –æ–±—â–∏–π —Å—á–µ—Ç—á–∏–∫ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–π
        promo_code.times_used += 1
        
        # –ó–∞–ø–∏—Å—ã–≤–∞–µ–º –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º, –µ—Å–ª–∏ –æ–Ω –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω
        if user:
            # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–µ –∑–∞–ø–∏—Å–∞–Ω–æ –ª–∏ —É–∂–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ
            result = await self.db.execute(select(promo_code_usages).filter_by(
                user_id=user.id,
                promo_code_id=promo_code.id
            ))
            existing_usage = result.first()
            
            if not existing_usage:
                # –î–æ–±–∞–≤–ª—è–µ–º –∑–∞–ø–∏—Å—å –æ–± –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–∏
                await self.db.execute(
                    promo_code_usages.insert().values(
                        user_id=user.id,
                        promo_code_id=promo_code.id,
                        used_at=datetime.now(timezone.utc)
                    )
                )
        
        await self.db.commit()
    
    def calculate_discount_amount(self, base_amount: float, promo_code: PromoCode) -> float:
        """–†–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ—Ç —Å—É–º–º—É —Å–∫–∏–¥–∫–∏ –ø–æ –ø—Ä–æ–º–æ–∫–æ–¥—É"""
        return base_amount * (promo_code.discount_percentage / 100)
    
    def calculate_final_amount_with_promo(self, base_amount: float, promo_code: PromoCode) -> float:
        """–†–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ—Ç —Ñ–∏–Ω–∞–ª—å–Ω—É—é —Å—É–º–º—É —Å —É—á–µ—Ç–æ–º —Å–∫–∏–¥–∫–∏ –ø–æ –ø—Ä–æ–º–æ–∫–æ–¥—É"""
        discount_amount = self.calculate_discount_amount(base_amount, promo_code)
        return base_amount - discount_amount
    
    def validate_combined_discount(self, duration_discount: float, promo_discount: float) -> float:
        """
        –ü—Ä–æ–≤–µ—Ä—è–µ—Ç –∏ –∫–æ—Ä—Ä–µ–∫—Ç–∏—Ä—É–µ—Ç –∫–æ–º–±–∏–Ω–∏—Ä–æ–≤–∞–Ω–Ω—É—é —Å–∫–∏–¥–∫—É.
        –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç –∏—Ç–æ–≥–æ–≤—ã–π –ø—Ä–æ—Ü–µ–Ω—Ç —Å–∫–∏–¥–∫–∏.
        """
        total_discount = duration_discount + promo_discount
        if total_discount > MAX_COMBINED_DISCOUNT:
            return MAX_COMBINED_DISCOUNT
        return total_discount
    
    def get_promo_code_statistics(self, promo_code: PromoCode) -> dict:
        """–ü–æ–ª—É—á–∞–µ—Ç —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –ø—Ä–æ–º–æ–∫–æ–¥–∞"""
        total_uses = promo_code.times_used
        max_uses = promo_code.max_uses
        usage_percentage = (total_uses / max_uses * 100) if max_uses else None
        
        return {
            'total_uses': total_uses,
            'max_uses': max_uses,
            'usage_percentage': usage_percentage,
            'is_fully_used': max_uses and total_uses >= max_uses,
            'remaining_uses': max_uses - total_uses if max_uses else None
        }
    
    def is_promo_code_expired(self, promo_code: PromoCode) -> bool:
        """–ü—Ä–æ–≤–µ—Ä—è–µ—Ç, –∏—Å—Ç–µ–∫ –ª–∏ —Å—Ä–æ–∫ –¥–µ–π—Å—Ç–≤–∏—è –ø—Ä–æ–º–æ–∫–æ–¥–∞"""
        if not promo_code.expires_at:
            return False
        
        now_utc = datetime.now(timezone.utc)
        return promo_code.expires_at < now_utc
    
    def is_promo_code_active(self, promo_code: PromoCode) -> bool:
        """–ü—Ä–æ–≤–µ—Ä—è–µ—Ç, –∞–∫—Ç–∏–≤–µ–Ω –ª–∏ –ø—Ä–æ–º–æ–∫–æ–¥ (–≤–∫–ª—é—á–∞—è —Å—Ä–æ–∫–∏ –¥–µ–π—Å—Ç–≤–∏—è)"""
        if not promo_code.is_active:
            return False
        
        now_utc = datetime.now(timezone.utc)
        
        # –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–∞—Ç—ã –Ω–∞—á–∞–ª–∞ –¥–µ–π—Å—Ç–≤–∏—è
        if promo_code.valid_from and promo_code.valid_from > now_utc:
            return False
        
        # –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–∞—Ç—ã –æ–∫–æ–Ω—á–∞–Ω–∏—è –¥–µ–π—Å—Ç–≤–∏—è
        if promo_code.expires_at and promo_code.expires_at < now_utc:
            return False
        
        return True 

```


## <a name="RentalAppFASTAPIapiservicespromocodepromocodemanagerpy"></a>`RentalApp_FASTAPI/api/services/promo_code/promo_code_manager.py`

```python
// path: RentalApp_FASTAPI/api/services/promo_code/promo_code_manager.py

# api/services/promo_code/promo_code_manager.py

from sqlalchemy.ext.asyncio import AsyncSession
from sqlalchemy.orm import joinedload
from sqlalchemy import select
from typing import List, Optional
import secrets

from api.models.promo_code import PromoCode, PromoCodeApplicableType
from api.models.equipment import Equipment
from api.models.user import User
from shared.schemas.promo_code_schema import PromoCodeCreate, PromoCodeUpdate
from .exceptions import (
    PromoCodeExistsError, PromoCodeEquipmentNotFoundError, 
    PromoCodeNotFoundError, PromoCodeDiscountLimitError
)
from .constants import DISCOUNT_LIMITS
from .interfaces import IPromoCodeManager


class PromoCodeManager(IPromoCodeManager):
    """–ú–µ–Ω–µ–¥–∂–µ—Ä –¥–ª—è CRUD –æ–ø–µ—Ä–∞—Ü–∏–π —Å –ø—Ä–æ–º–æ–∫–æ–¥–∞–º–∏"""
    
    def __init__(self, db: AsyncSession):
        self.db = db
    
    async def create_promo_code(self, promo_data: PromoCodeCreate, creator: User) -> PromoCode:
        """–°–æ–∑–¥–∞–µ—Ç –Ω–æ–≤—ã–π –ø—Ä–æ–º–æ–∫–æ–¥"""
        # –ü—Ä–æ–≤–µ—Ä–∫–∞ –ª–∏–º–∏—Ç–æ–≤ —Å–∫–∏–¥–∫–∏ –ø–æ —Ä–æ–ª–∏
        self._validate_discount_limit(creator.role, promo_data.discount_percentage)
        
        # –ü—Ä–æ–≤–µ—Ä–∫–∞ —É–Ω–∏–∫–∞–ª—å–Ω–æ—Å—Ç–∏ –∫–æ–¥–∞
        result = await self.db.execute(select(PromoCode).filter(PromoCode.code == promo_data.code))
        if result.scalar_one_or_none():
            raise PromoCodeExistsError()
        
        # –°–æ–∑–¥–∞–Ω–∏–µ –æ—Å–Ω–æ–≤–Ω–æ–≥–æ –æ–±—ä–µ–∫—Ç–∞
        promo_dict = promo_data.model_dump(exclude={'applicable_to_equipment_ids', 'applicable_to_equipment_types'})
        new_promo_code = PromoCode(**promo_dict, created_by_id=creator.id)
        
        # –û–±—Ä–∞–±–æ—Ç–∫–∞ —Å–≤—è–∑–µ–π —Å –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏–µ–º
        await self._set_equipment_relations(new_promo_code, promo_data.applicable_to_equipment_ids)
        
        # –û–±—Ä–∞–±–æ—Ç–∫–∞ —Å–≤—è–∑–µ–π —Å —Ç–∏–ø–∞–º–∏ –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—è
        self._set_equipment_type_relations(new_promo_code, promo_data.applicable_to_equipment_types)
        
        self.db.add(new_promo_code)
        await self.db.commit()
        await self.db.refresh(new_promo_code)
        
        # –í–æ–∑–≤—Ä–∞—â–∞–µ–º —Å–æ–∑–¥–∞–Ω–Ω—ã–π –æ–±—ä–µ–∫—Ç —Å –∑–∞–≥—Ä—É–∂–µ–Ω–Ω—ã–º–∏ –¥–∞–Ω–Ω—ã–º–∏ –∏–∑ –ë–î
        result = await self.db.execute(
            select(PromoCode)
            .filter(PromoCode.id == new_promo_code.id)
            .options(joinedload(PromoCode.creator))
        )
        return result.unique().scalars().first()
    
    async def get_all_promo_codes(self) -> List[PromoCode]:
        """–ü–æ–ª—É—á–∞–µ—Ç –≤—Å–µ –ø—Ä–æ–º–æ–∫–æ–¥—ã —Å –∑–∞–≥—Ä—É–∑–∫–æ–π —Å–≤—è–∑–∞–Ω–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö"""
        result = await self.db.execute(select(PromoCode).options(
            joinedload(PromoCode.creator)
        ).order_by(PromoCode.created_at.desc()))
        return result.unique().scalars().all()
    
    async def get_promo_code_by_id(self, promo_code_id: int) -> Optional[PromoCode]:
        """–ü–æ–ª—É—á–∞–µ—Ç –ø—Ä–æ–º–æ–∫–æ–¥ –ø–æ ID"""
        result = await self.db.execute(select(PromoCode).filter(PromoCode.id == promo_code_id))
        return result.scalar_one_or_none()
    
    async def update_promo_code(self, promo_code_id: int, update_data: PromoCodeUpdate) -> PromoCode:
        """–û–±–Ω–æ–≤–ª—è–µ—Ç —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π –ø—Ä–æ–º–æ–∫–æ–¥"""
        promo_code = await self.get_promo_code_by_id(promo_code_id)
        if not promo_code:
            raise PromoCodeNotFoundError()
        
        update_dict = update_data.model_dump(exclude_unset=True)
        
        # –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å–≤—è–∑–µ–π —Å –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏–µ–º
        if 'applicable_to_equipment_ids' in update_dict:
            equipment_ids = update_dict.pop('applicable_to_equipment_ids')
            await self._set_equipment_relations(promo_code, equipment_ids)
        
        # –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å–≤—è–∑–µ–π —Å —Ç–∏–ø–∞–º–∏ –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—è
        if 'applicable_to_equipment_types' in update_dict:
            equipment_types = update_dict.pop('applicable_to_equipment_types')
            self._set_equipment_type_relations(promo_code, equipment_types)
        
        # –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –æ—Å—Ç–∞–ª—å–Ω—ã—Ö –ø–æ–ª–µ–π
        for key, value in update_dict.items():
            setattr(promo_code, key, value)
        
        self.db.add(promo_code)
        await self.db.commit()
        
        # –ü–æ–≤—Ç–æ—Ä–Ω–æ –ø–æ–ª—É—á–∞–µ–º –æ–±—ä–µ–∫—Ç –∏–∑ –ë–î —Å –∑–∞–≥—Ä—É–∂–µ–Ω–Ω—ã–º–∏ —Å–≤—è–∑—è–º–∏
        result = await self.db.execute(
            select(PromoCode)
            .filter(PromoCode.id == promo_code_id)
            .options(joinedload(PromoCode.creator))
        )
        return result.unique().scalars().first()
    
    async def delete_promo_code(self, promo_code_id: int) -> None:
        """–£–¥–∞–ª—è–µ—Ç –ø—Ä–æ–º–æ–∫–æ–¥"""
        promo_code = await self.get_promo_code_by_id(promo_code_id)
        if not promo_code:
            raise PromoCodeNotFoundError()
        
        await self.db.delete(promo_code)
        await self.db.commit()
    
    async def generate_unique_code(self) -> str:
        """–ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç —É–Ω–∏–∫–∞–ª—å–Ω—ã–π –∫–æ–¥ –ø—Ä–æ–º–æ–∫–æ–¥–∞"""
        while True:
            code = f"SALE-{secrets.token_hex(3).upper()}"
            result = await self.db.execute(select(PromoCode).filter(PromoCode.code == code))
            existing_code = result.scalar_one_or_none()
            if not existing_code:
                return code
    
    def _validate_discount_limit(self, role: str, discount_percentage: float) -> None:
        """–ü—Ä–æ–≤–µ—Ä—è–µ—Ç –ª–∏–º–∏—Ç —Å–∫–∏–¥–∫–∏ –¥–ª—è —Ä–æ–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è"""
        if role in DISCOUNT_LIMITS and discount_percentage > DISCOUNT_LIMITS[role]:
            raise PromoCodeDiscountLimitError(role)
    
    async def _set_equipment_relations(self, promo_code: PromoCode, equipment_ids: Optional[List[int]]) -> None:
        """–£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç —Å–≤—è–∑–∏ —Å –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏–µ–º"""
        promo_code.applicable_equipment.clear()
        if equipment_ids:
            result = await self.db.execute(select(Equipment).filter(Equipment.id.in_(equipment_ids)))
            equipment = result.unique().scalars().all()
            if len(equipment) != len(equipment_ids):
                raise PromoCodeEquipmentNotFoundError()
            promo_code.applicable_equipment = equipment
    
    def _set_equipment_type_relations(self, promo_code: PromoCode, equipment_types: Optional[List[str]]) -> None:
        """–£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç —Å–≤—è–∑–∏ —Å —Ç–∏–ø–∞–º–∏ –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—è"""
        promo_code.applicable_types.clear()
        if equipment_types:
            promo_code.applicable_types = [
                PromoCodeApplicableType(type_name=t) for t in equipment_types
            ] 

```


## <a name="RentalAppFASTAPIapiservicespromocodepromocodevalidatorpy"></a>`RentalApp_FASTAPI/api/services/promo_code/promo_code_validator.py`

```python
// path: RentalApp_FASTAPI/api/services/promo_code/promo_code_validator.py

# api/services/promo_code/promo_code_validator.py

from sqlalchemy.ext.asyncio import AsyncSession
from sqlalchemy import select
from typing import Optional, List
from datetime import datetime, timezone

from api.models.promo_code import PromoCode, promo_code_usages
from api.models.user import User
from api.models.equipment import Equipment
from .exceptions import (
    PromoCodeNotFoundError, PromoCodeInactiveError, PromoCodeNotStartedError,
    PromoCodeExpiredError, PromoCodeUsageLimitExceededError, PromoCodeMinOrderAmountError,
    PromoCodeInvalidEquipmentError, PromoCodeInvalidEquipmentTypeError,
    PromoCodePersonalCodeForbiddenError, PromoCodeUserUsageLimitError
)
from .interfaces import IPromoCodeValidator


class PromoCodeValidator(IPromoCodeValidator):
    """–í–∞–ª–∏–¥–∞—Ç–æ—Ä –ø—Ä–æ–º–æ–∫–æ–¥–æ–≤ —Å —Ä–∞–∑–¥–µ–ª–µ–Ω–∏–µ–º –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç–∏ –ø–æ —Ç–∏–ø–∞–º –ø—Ä–æ–≤–µ—Ä–æ–∫"""
    
    def __init__(self, db: AsyncSession):
        self.db = db
    
    async def validate_basic_existence(self, code: str) -> PromoCode:
        """–ü—Ä–æ–≤–µ—Ä—è–µ—Ç —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–Ω–∏–µ –ø—Ä–æ–º–æ–∫–æ–¥–∞"""
        result = await self.db.execute(select(PromoCode).filter(PromoCode.code == code))
        promo_code = result.unique().scalar_one_or_none()
        if not promo_code:
            raise PromoCodeNotFoundError()
        return promo_code
    
    def validate_status_and_dates(self, promo_code: PromoCode) -> None:
        """–ü—Ä–æ–≤–µ—Ä—è–µ—Ç –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å –∏ —Å—Ä–æ–∫–∏ –¥–µ–π—Å—Ç–≤–∏—è –ø—Ä–æ–º–æ–∫–æ–¥–∞"""
        if not promo_code.is_active:
            raise PromoCodeInactiveError()
        
        now_utc = datetime.now(timezone.utc)
        
        if promo_code.valid_from and promo_code.valid_from > now_utc:
            raise PromoCodeNotStartedError()
        
        if promo_code.expires_at and promo_code.expires_at < now_utc:
            raise PromoCodeExpiredError()
    
    def validate_usage_limits(self, promo_code: PromoCode) -> None:
        """–ü—Ä–æ–≤–µ—Ä—è–µ—Ç –ª–∏–º–∏—Ç—ã –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –ø—Ä–æ–º–æ–∫–æ–¥–∞"""
        if promo_code.max_uses is not None and promo_code.times_used >= promo_code.max_uses:
            raise PromoCodeUsageLimitExceededError()
    
    def validate_order_amount(self, promo_code: PromoCode, order_amount: float) -> None:
        """–ü—Ä–æ–≤–µ—Ä—è–µ—Ç –º–∏–Ω–∏–º–∞–ª—å–Ω—É—é —Å—É–º–º—É –∑–∞–∫–∞–∑–∞"""
        if promo_code.min_order_amount is not None and order_amount < promo_code.min_order_amount:
            raise PromoCodeMinOrderAmountError(promo_code.min_order_amount)
    
    async def validate_equipment_applicability(self, promo_code: PromoCode, equipment_ids: List[int]) -> None:
        """–ü—Ä–æ–≤–µ—Ä—è–µ—Ç –ø—Ä–∏–º–µ–Ω–∏–º–æ—Å—Ç—å –∫ –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—é"""
        # –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ ID –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—è
        if promo_code.applicable_to_equipment_ids and not any(eid in equipment_ids for eid in promo_code.applicable_to_equipment_ids):
            raise PromoCodeInvalidEquipmentError()
        
        # –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ —Ç–∏–ø–∞–º –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—è
        if promo_code.applicable_to_equipment_types:
            result = await self.db.execute(select(Equipment).filter(Equipment.id.in_(equipment_ids)))
            equipment_in_cart = result.unique().scalars().all()
            equipment_types_in_cart = {eq.equipment_type for eq in equipment_in_cart}
            if not any(eq_type in equipment_types_in_cart for eq_type in promo_code.applicable_to_equipment_types):
                raise PromoCodeInvalidEquipmentTypeError()
    
    async def validate_user_permissions(self, promo_code: PromoCode, user: Optional[User]) -> None:
        """–ü—Ä–æ–≤–µ—Ä—è–µ—Ç –ø—Ä–∞–≤–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –Ω–∞ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –ø—Ä–æ–º–æ–∫–æ–¥–∞"""
        # –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω–æ–≥–æ –ø—Ä–æ–º–æ–∫–æ–¥–∞
        if promo_code.specific_to_user_id:
            if not user or user.id != promo_code.specific_to_user_id:
                raise PromoCodePersonalCodeForbiddenError()
        
        # –ü—Ä–æ–≤–µ—Ä–∫–∞ –ª–∏–º–∏—Ç–∞ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–π –Ω–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        if promo_code.max_uses_per_user and user:
            result = await self.db.execute(select(promo_code_usages).filter_by(
                user_id=user.id, 
                promo_code_id=promo_code.id
            ))
            user_uses_count = len(result.all())
            if user_uses_count >= promo_code.max_uses_per_user:
                raise PromoCodeUserUsageLimitError()
    
    async def validate_complete(self, code: str, order_amount: float, equipment_ids: List[int], user: Optional[User]) -> PromoCode:
        """–í—ã–ø–æ–ª–Ω—è–µ—Ç –ø–æ–ª–Ω—É—é –≤–∞–ª–∏–¥–∞—Ü–∏—é –ø—Ä–æ–º–æ–∫–æ–¥–∞"""
        promo_code = await self.validate_basic_existence(code)
        self.validate_status_and_dates(promo_code)
        self.validate_usage_limits(promo_code)
        self.validate_order_amount(promo_code, order_amount)
        await self.validate_equipment_applicability(promo_code, equipment_ids)
        await self.validate_user_permissions(promo_code, user)
        
        return promo_code 

```


## <a name="RentalAppFASTAPIapiservicespromocodeservicepy"></a>`RentalApp_FASTAPI/api/services/promo_code_service.py`

```python
// path: RentalApp_FASTAPI/api/services/promo_code_service.py

# api/services/promo_code_service.py

from sqlalchemy.ext.asyncio import AsyncSession
from typing import Optional, List

from api.models.promo_code import PromoCode
from api.models.user import User
from .promo_code import PromoCodeBusinessLogic


async def validate_promo_code_for_use(
        db: AsyncSession,
        code: str,
        order_amount: float,
        equipment_ids: List[int],
        user: Optional[User]
) -> PromoCode:
    """
    –¶–µ–Ω—Ç—Ä–∞–ª–∏–∑–æ–≤–∞–Ω–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–æ–ª–Ω–æ–π —Å–µ—Ä–≤–µ—Ä–Ω–æ–π –≤–∞–ª–∏–¥–∞—Ü–∏–∏ –ø—Ä–æ–º–æ–∫–æ–¥–∞.
    –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç –æ–±—ä–µ–∫—Ç PromoCode –≤ —Å–ª—É—á–∞–µ —É—Å–ø–µ—Ö–∞ –∏–ª–∏ –≤—ã–±—Ä–∞—Å—ã–≤–∞–µ—Ç HTTPException.
    
    –≠—Ç–∞ —Ñ—É–Ω–∫—Ü–∏—è —è–≤–ª—è–µ—Ç—Å—è —Ñ–∞—Å–∞–¥–æ–º –¥–ª—è –Ω–æ–≤–æ–π –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—ã –ø—Ä–æ–º–æ–∫–æ–¥–æ–≤.
    """
    business_logic = PromoCodeBusinessLogic(db)
    return await business_logic.validate_and_get_promo_code(code, order_amount, equipment_ids, user)

```


## <a name="RentalAppFASTAPIapiservicesrentalinitpy"></a>`RentalApp_FASTAPI/api/services/rental/__init__.py`

```python
// path: RentalApp_FASTAPI/api/services/rental/__init__.py

# –≠—Ç–æ—Ç —Ñ–∞–π–ª –º–æ–∂–µ—Ç –±—ã—Ç—å –ø—É—Å—Ç—ã–º.
# –ï–≥–æ –Ω–∞–ª–∏—á–∏–µ –ø—Ä–µ–≤—Ä–∞—â–∞–µ—Ç –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é 'rental' –≤ –ø–∞–∫–µ—Ç Python.

```


## <a name="RentalAppFASTAPIapiservicesrentalrentalqueryservicepy"></a>`RentalApp_FASTAPI/api/services/rental/rental_query_service.py`

```python
// path: RentalApp_FASTAPI/api/services/rental/rental_query_service.py

# api/services/rental/rental_query_service.py

from sqlalchemy.ext.asyncio import AsyncSession
from sqlalchemy.orm import joinedload, selectinload
from sqlalchemy import or_, select, func, case, and_
from datetime import date
from typing import Optional, List, Tuple
import logging

from api.models.rental import Rental, RentalAccessory
from api.models.user import User
from api.models.equipment import Equipment
from shared.schemas.rental_schema import RentalOut
from api.services.financial_service import FinancialService
from api.services.order.order_query_base import OrderQueryBase

logger = logging.getLogger(__name__)

class RentalQueryService(OrderQueryBase[Rental]):
    """–°–µ—Ä–≤–∏—Å –¥–ª—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –æ–ø–µ—Ä–∞—Ü–∏–π —á—Ç–µ–Ω–∏—è (Query) –¥–∞–Ω–Ω—ã—Ö –æ–± –∞—Ä–µ–Ω–¥–∞—Ö."""

    def __init__(self, db: AsyncSession):
        super().__init__(db)
        self.financial_service = FinancialService(db)

    def _get_base_query(self):
        """–°–æ–∑–¥–∞–µ—Ç –±–∞–∑–æ–≤—ã–π –∑–∞–ø—Ä–æ—Å —Å –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã–º–∏ join'–∞–º–∏ –∏ –∫–∞—Å—Ç–æ–º–Ω–æ–π —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–æ–π."""
        overdue_case = case(
            (and_(Rental.status == 'active', Rental.end_date < date.today()), 0),
            else_=1
        ).asc()

        return select(Rental).options(
            joinedload(Rental.user),
            joinedload(Rental.created_by),
            selectinload(Rental.equipment).options(
                selectinload(Equipment.accessories),
                selectinload(Equipment.associations)
            ),
            joinedload(Rental.accessory_links).joinedload(RentalAccessory.accessory)
        ).order_by(overdue_case, Rental.id.desc())

    # --- –ò–ó–ú–ï–ù–ï–ù–ò–ï 1: –°–æ–∑–¥–∞–µ–º –µ–¥–∏–Ω—ã–π –º–µ—Ç–æ–¥ –¥–ª—è –ø–æ—Å—Ç—Ä–æ–µ–Ω–∏—è –∑–∞–ø—Ä–æ—Å–∞ —Å —Ñ–∏–ª—å—Ç—Ä–∞–º–∏ ---
    def _get_filtered_query(self, status_filter: Optional[str], search: Optional[str]):
        """
        –°–æ–∑–¥–∞–µ—Ç –∏ –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –æ—Ç—Ñ–∏–ª—å—Ç—Ä–æ–≤–∞–Ω–Ω—ã–π –∑–∞–ø—Ä–æ—Å –Ω–∞ –æ—Å–Ω–æ–≤–µ —Å—Ç–∞—Ç—É—Å–∞ –∏ –ø–æ–∏—Å–∫–∞.
        –≠—Ç–æ —Ü–µ–Ω—Ç—Ä–∞–ª–∏–∑—É–µ—Ç –ª–æ–≥–∏–∫—É —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏.
        """
        query = self._get_base_query()

        # –ü—Ä–∏–º–µ–Ω—è–µ–º —Ñ–∏–ª—å—Ç—Ä –ø–æ —Å—Ç–∞—Ç—É—Å—É, –µ—Å–ª–∏ –æ–Ω –µ—Å—Ç—å
        if status_filter:
            today = date.today()
            if status_filter == 'active':
                # –ê–∫—Ç–∏–≤–Ω—ã–µ –∞—Ä–µ–Ω–¥—ã - –≤—Å–µ –∞—Ä–µ–Ω–¥—ã —Å–æ —Å—Ç–∞—Ç—É—Å–æ–º 'active' (–≤–∫–ª—é—á–∞—è –ø—Ä–æ—Å—Ä–æ—á–µ–Ω–Ω—ã–µ)
                query = query.filter(Rental.status == 'active')
            elif status_filter == 'overdue':
                # –ü—Ä–æ—Å—Ä–æ—á–µ–Ω–Ω—ã–µ –∞—Ä–µ–Ω–¥—ã - –∞–∫—Ç–∏–≤–Ω—ã–µ –∞—Ä–µ–Ω–¥—ã —Å –∏—Å—Ç–µ–∫—à–∏–º —Å—Ä–æ–∫–æ–º
                query = query.filter(Rental.status == 'active', Rental.end_date < today)
            elif status_filter == 'completed':
                query = query.filter(Rental.status == 'completed')

        # –ü—Ä–∏–º–µ–Ω—è–µ–º –ø–æ–∏—Å–∫ –ø–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é, –µ—Å–ª–∏ –æ–Ω –µ—Å—Ç—å
        if search:
            query = self._apply_user_search(query, search, Rental)

        return query

    async def _enrich_rental_with_dynamic_fields(self, rental: Rental) -> RentalOut:
        """–û–±–æ–≥–∞—â–∞–µ—Ç –æ–±—ä–µ–∫—Ç –∞—Ä–µ–Ω–¥—ã –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏–º–∏ –ø–æ–ª—è–º–∏ —á–µ—Ä–µ–∑ FinancialService."""
        rental_out = RentalOut.model_validate(rental)
        today = date.today()

        if rental.status == 'active' and rental.end_date < today:
            rental_out.status = 'overdue'

        if rental_out.status == 'overdue':
            rental_out.overdue_days = self.financial_service.calculate_overdue_days(rental, today)
            rental_out.overdue_surcharge = await self.financial_service.calculate_overdue_surcharge(rental, today)
        elif rental.status == 'active':
            rental_out.days_remaining = (rental.end_date - today).days

        accessories_cost = sum(
            link.accessory.price for link in rental.accessory_links if link.accessory and link.accessory.price
        )
        rental_out.accessories_cost = accessories_cost
        rental_out.remaining_amount = rental.total_cost - rental.prepayment_amount

        return rental_out

    async def get_rentals_for_user(
        self, 
        user: User, 
        skip: int, 
        limit: int,
        status: Optional[str] = None,
        search: Optional[str] = None,
        sort: Optional[str] = None
    ) -> Tuple[List[RentalOut], int]:
        """–ü–æ–ª—É—á–∞–µ—Ç –æ—Ç—Ñ–∏–ª—å—Ç—Ä–æ–≤–∞–Ω–Ω—ã–π –∏ –ø–∞–≥–∏–Ω–∏—Ä–æ–≤–∞–Ω–Ω—ã–π —Å–ø–∏—Å–æ–∫ –∞—Ä–µ–Ω–¥ –¥–ª—è –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è."""
        
        # –°–æ–∑–¥–∞–µ–º –±–∞–∑–æ–≤—ã–π –∑–∞–ø—Ä–æ—Å
        base_query = self._get_base_query().filter(Rental.user_id == user.id)
        
        # –ü—Ä–∏–º–µ–Ω—è–µ–º —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏—é –ø–æ —Å—Ç–∞—Ç—É—Å—É
        base_query = self._apply_status_filter(base_query, status, Rental)
        
        # –ü—Ä–∏–º–µ–Ω—è–µ–º –ø–æ–∏—Å–∫ –ø–æ –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—é
        if search:
            base_query = self._apply_equipment_search(base_query, search, Rental)
        
        # –ü—Ä–∏–º–µ–Ω—è–µ–º —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫—É (–µ—Å–ª–∏ –Ω–µ —É–∫–∞–∑–∞–Ω–∞, –∏—Å–ø–æ–ª—å–∑—É–µ–º –∫–∞—Å—Ç–æ–º–Ω—É—é —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫—É –∏–∑ _get_base_query)
        if sort:
            # –£–±–∏—Ä–∞–µ–º –∫–∞—Å—Ç–æ–º–Ω—É—é —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫—É –∏–∑ –±–∞–∑–æ–≤–æ–≥–æ –∑–∞–ø—Ä–æ—Å–∞ –∏ –ø—Ä–∏–º–µ–Ω—è–µ–º –Ω–æ–≤—É—é
            base_query = base_query.order_by(None)  # –£–±–∏—Ä–∞–µ–º —Å—É—â–µ—Å—Ç–≤—É—é—â—É—é —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫—É
            base_query = self._apply_sorting(base_query, sort, Rental)
        
        # –ü–æ–ª—É—á–∞–µ–º –æ–±—â–µ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ
        total = await self._get_total_count(base_query)
        
        # –ü—Ä–∏–º–µ–Ω—è–µ–º –ø–∞–≥–∏–Ω–∞—Ü–∏—é
        base_query = self._apply_pagination(base_query, skip, limit)
        
        # –ü–æ–ª—É—á–∞–µ–º –¥–∞–Ω–Ω—ã–µ
        rentals_result = await self.db.execute(base_query)
        rentals_orm = rentals_result.unique().scalars().all()
        
        # –û–±–æ–≥–∞—â–∞–µ–º –¥–∞–Ω–Ω—ã–µ —á–µ—Ä–µ–∑ FinancialService
        try:
            enriched_rentals = [await self._enrich_rental_with_dynamic_fields(r) for r in rentals_orm]
            return enriched_rentals, total
        except Exception as e:
            logger.error(f"–û—à–∏–±–∫–∞ –≤ _enrich_rental_with_dynamic_fields: {e}", exc_info=True)
            # Fallback: –≤–æ–∑–≤—Ä–∞—â–∞–µ–º –ø—Ä–æ—Å—Ç—ã–µ –æ–±—ä–µ–∫—Ç—ã
            simple_rentals = [RentalOut.model_validate(r) for r in rentals_orm]
            return simple_rentals, total

    async def get_paginated_rentals(self, skip: int, limit: int, status_filter: Optional[str], search: Optional[str]) -> Tuple[List[RentalOut], int]:
        """–ü–æ–ª—É—á–∞–µ—Ç –æ—Ç—Ñ–∏–ª—å—Ç—Ä–æ–≤–∞–Ω–Ω—ã–π –∏ –ø–∞–≥–∏–Ω–∏—Ä–æ–≤–∞–Ω–Ω—ã–π —Å–ø–∏—Å–æ–∫ –≤—Å–µ—Ö –∞—Ä–µ–Ω–¥."""
        # --- –ò–ó–ú–ï–ù–ï–ù–ò–ï 2: –ò—Å–ø–æ–ª—å–∑—É–µ–º –Ω–æ–≤—ã–π –º–µ—Ç–æ–¥ –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –∑–∞–ø—Ä–æ—Å–∞ ---
        # –¢–µ–ø–µ—Ä—å –∏ –ø–æ–¥—Å—á–µ—Ç, –∏ –≤—ã–±–æ—Ä–∫–∞ –¥–µ–ª–∞—é—Ç—Å—è –Ω–∞ –æ—Å–Ω–æ–≤–µ –æ–¥–Ω–æ–≥–æ –∏ —Ç–æ–≥–æ –∂–µ –æ—Ç—Ñ–∏–ª—å—Ç—Ä–æ–≤–∞–Ω–Ω–æ–≥–æ –∑–∞–ø—Ä–æ—Å–∞.
        filtered_query = self._get_filtered_query(status_filter, search)

        # –ü–æ–ª—É—á–∞–µ–º –æ–±—â–µ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –Ω–∞ –æ—Å–Ω–æ–≤–µ –æ—Ç—Ñ–∏–ª—å—Ç—Ä–æ–≤–∞–Ω–Ω–æ–≥–æ –∑–∞–ø—Ä–æ—Å–∞
        count_query = select(func.count()).select_from(filtered_query.subquery())
        count_result = await self.db.execute(count_query)
        total = count_result.scalar_one()

        # –ü–æ–ª—É—á–∞–µ–º –¥–∞–Ω–Ω—ã–µ —Å –ø–∞–≥–∏–Ω–∞—Ü–∏–µ–π –∏–∑ —Ç–æ–≥–æ –∂–µ –æ—Ç—Ñ–∏–ª—å—Ç—Ä–æ–≤–∞–Ω–Ω–æ–≥–æ –∑–∞–ø—Ä–æ—Å–∞
        paginated_query = filtered_query.offset(skip).limit(limit)
        rentals_result = await self.db.execute(paginated_query)
        rentals_orm = rentals_result.unique().scalars().all()

        try:
            enriched_rentals = [await self._enrich_rental_with_dynamic_fields(r) for r in rentals_orm]
            return enriched_rentals, total
        except Exception as e:
            logger.error(f"–û—à–∏–±–∫–∞ –≤ _enrich_rental_with_dynamic_fields: {e}", exc_info=True)
            simple_rentals = [RentalOut.model_validate(r) for r in rentals_orm]
            return simple_rentals, total

```


## <a name="RentalAppFASTAPIapiservicesreservationqueryservicepy"></a>`RentalApp_FASTAPI/api/services/reservation_query_service.py`

```python
// path: RentalApp_FASTAPI/api/services/reservation_query_service.py

# api/services/reservation_query_service.py

from sqlalchemy.ext.asyncio import AsyncSession
from sqlalchemy.orm import joinedload, selectinload
from sqlalchemy import or_, select, func
from typing import List, Optional, Tuple
from datetime import date
import logging

from api.models.user import User
from api.models.reservation import Reservation, ReservationAccessory
from api.models.equipment import Equipment
from shared.schemas.reservation_schema import AdminReservationOut, ReservationItem
from shared.schemas.user_schema import UserOut
from api.services.financial_service import FinancialService
from api.services.order.order_query_base import OrderQueryBase

logger = logging.getLogger(__name__)

class ReservationQueryService(OrderQueryBase[Reservation]):
    """
    –ï–¥–∏–Ω—ã–π —Å–µ—Ä–≤–∏—Å –¥–ª—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –æ–ø–µ—Ä–∞—Ü–∏–π —á—Ç–µ–Ω–∏—è (Query) –¥–∞–Ω–Ω—ã—Ö –æ —Ä–µ–∑–µ—Ä–≤–∞—Ö.
    """

    def __init__(self, db: AsyncSession):
        super().__init__(db)
        self.financial_service = FinancialService(db)

    async def get_my_reservations(
        self, 
        user: User, 
        status: Optional[str] = None,
        search: Optional[str] = None,
        sort: Optional[str] = None,
        skip: int = 0,
        limit: int = 100
    ) -> Tuple[List[ReservationItem], int]:
        """–ü–æ–ª—É—á–∞–µ—Ç –æ—Ç—Ñ–∏–ª—å—Ç—Ä–æ–≤–∞–Ω–Ω—ã–π –∏ –ø–∞–≥–∏–Ω–∏—Ä–æ–≤–∞–Ω–Ω—ã–π —Å–ø–∏—Å–æ–∫ —Ä–µ–∑–µ—Ä–≤–æ–≤ –¥–ª—è —Ç–µ–∫—É—â–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è."""
        
        # –°–æ–∑–¥–∞–µ–º –±–∞–∑–æ–≤—ã–π –∑–∞–ø—Ä–æ—Å
        query = select(Reservation).filter(Reservation.user_id == user.id)
        
        # –ü—Ä–∏–º–µ–Ω—è–µ–º —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏—é –ø–æ —Å—Ç–∞—Ç—É—Å—É
        query = self._apply_status_filter(query, status, Reservation)
        
        # –ü—Ä–∏–º–µ–Ω—è–µ–º –ø–æ–∏—Å–∫ –ø–æ –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—é
        if search:
            query = self._apply_equipment_search(query, search, Reservation)
        
        # –î–æ–±–∞–≤–ª—è–µ–º –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã–µ JOIN'—ã
        query = query.options(
            joinedload(Reservation.applied_promo_code),
            joinedload(Reservation.accessory_links).joinedload(ReservationAccessory.accessory),
            selectinload(Reservation.equipment).options(
                selectinload(Equipment.accessories),
                selectinload(Equipment.associations)
            ),
            joinedload(Reservation.rental)
        )
        
        # –ü—Ä–∏–º–µ–Ω—è–µ–º —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫—É
        query = self._apply_sorting(query, sort, Reservation)
        
        # –ü–æ–ª—É—á–∞–µ–º –æ–±—â–µ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ
        total = await self._get_total_count(query)
        
        # –ü—Ä–∏–º–µ–Ω—è–µ–º –ø–∞–≥–∏–Ω–∞—Ü–∏—é
        query = self._apply_pagination(query, skip, limit)
        
        # –í—ã–ø–æ–ª–Ω—è–µ–º –∑–∞–ø—Ä–æ—Å
        result = await self.db.execute(query)
        reservations_orm = result.unique().scalars().all()
        
        # –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º —Å—Ç–∞—Ç—É—Å—ã –∏ –ø—Ä–µ–æ–±—Ä–∞–∑—É–µ–º –≤ DTO —á–µ—Ä–µ–∑ FinancialService
        items_dto = []
        for r_orm in reservations_orm:
            try:
                item_dto = await self.financial_service.enrich_order_with_financials(r_orm)
                items_dto.append(item_dto)
            except Exception as e:
                logger.error(f"–û—à–∏–±–∫–∞ –æ–±–æ–≥–∞—â–µ–Ω–∏—è —Ä–µ–∑–µ—Ä–≤–∞ ID {r_orm.id}: {e}")
                # Fallback: –ø—Ä–æ—Å—Ç–∞—è –≤–∞–ª–∏–¥–∞—Ü–∏—è
                item_dto = ReservationItem.model_validate(r_orm)
                items_dto.append(item_dto)
        
        return items_dto, total

    def _get_admin_base_query(self, status_filter: Optional[str] = None, search_query: Optional[str] = None):
        """–í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–π –º–µ—Ç–æ–¥ –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –±–∞–∑–æ–≤–æ–≥–æ –∑–∞–ø—Ä–æ—Å–∞ —Å —Ñ–∏–ª—å—Ç—Ä–∞–º–∏ –¥–ª—è –∞–¥–º–∏–Ω-–ø–∞–Ω–µ–ª–∏."""
        query = select(Reservation).options(
            joinedload(Reservation.user),
            joinedload(Reservation.applied_promo_code),
            joinedload(Reservation.accessory_links).joinedload(ReservationAccessory.accessory),
            selectinload(Reservation.equipment).options(
                selectinload(Equipment.accessories),
                selectinload(Equipment.associations)
            ),
            joinedload(Reservation.rental)
        )
        if search_query:
            query = self._apply_user_search(query, search_query, Reservation)

        if status_filter == "active":
            query = query.filter(Reservation.status == 'active')
        elif status_filter == "completed":
            query = query.filter(Reservation.status.in_(['fulfilled', 'cancelled', 'overdue']))

        return query

    async def get_admin_reservations_count(self, status: Optional[str] = None, search_query: Optional[str] = None) -> int:
        """–ü–æ–ª—É—á–∞–µ—Ç –æ–±—â–µ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ä–µ–∑–µ—Ä–≤–æ–≤ —Å —É—á–µ—Ç–æ–º —Ñ–∏–ª—å—Ç—Ä–æ–≤ –¥–ª—è –∞–¥–º–∏–Ω-–ø–∞–Ω–µ–ª–∏."""
        query = self._get_admin_base_query(status, search_query)
        result = await self.db.execute(select(func.count()).select_from(query.subquery()))
        return result.scalar_one()

    async def get_paginated_admin_reservations(self, skip: int, limit: int, status: Optional[str] = None, search_query: Optional[str] = None) -> List[AdminReservationOut]:
        """–ü–æ–ª—É—á–∞–µ—Ç —Å—Ç—Ä–∞–Ω–∏—Ü—É —Ä–µ–∑–µ—Ä–≤–æ–≤ —Å –ø–∞–≥–∏–Ω–∞—Ü–∏–µ–π –¥–ª—è –∞–¥–º–∏–Ω-–ø–∞–Ω–µ–ª–∏."""
        query = self._get_admin_base_query(status, search_query)
        result = await self.db.execute(query.order_by(Reservation.id.desc()).offset(skip).limit(limit))
        reservations_orm = result.unique().scalars().all()

        result = []
        for r_orm in reservations_orm:
            if not r_orm.user:
                continue
            try:
                # –ò—Å–ø–æ–ª—å–∑—É–µ–º FinancialService –¥–ª—è –æ–±–æ–≥–∞—â–µ–Ω–∏—è –∞–¥–º–∏–Ω-—Ä–µ–∑–µ—Ä–≤–∞
                final_output = await self.financial_service._enrich_admin_reservation_with_financials(r_orm)
                result.append(final_output)
            except Exception as e:
                logger.error(f"–û—à–∏–±–∫–∞ –≤–∞–ª–∏–¥–∞—Ü–∏–∏ –∞–¥–º–∏–Ω-—Ä–µ–∑–µ—Ä–≤–∞ ID {r_orm.id}: {e}", exc_info=True)
                continue
        return result

```


## <a name="RentalAppFASTAPIapiservicesuserservicepy"></a>`RentalApp_FASTAPI/api/services/user_service.py`

```python
// path: RentalApp_FASTAPI/api/services/user_service.py

# src/api/services/user_service.py

from sqlalchemy.ext.asyncio import AsyncSession
from sqlalchemy.orm import joinedload
from sqlalchemy import select, func
from api.models.user import User
from api.models.payment import Payment
# +++ –î–û–ë–ê–í–¨–¢–ï –≠–¢–û–¢ –ò–ú–ü–û–†–¢ +++
from api.models.balance_history import BalanceHistory
from api.services.balance_service import BalanceService
from shared.schemas.user_schema import UserUpdate, UserOut, AdminUserCreate, AdminUserUpdate, UserPaymentRequest
from api.services import auth_service
from fastapi import HTTPException
import logging
from datetime import datetime
from typing import List, Tuple


async def create_admin_user(db: AsyncSession, user_data: AdminUserCreate) -> User:
    """–°–æ–∑–¥–∞–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (–¥–ª—è –∞–¥–º–∏–Ω–æ–≤)."""
    result = await db.execute(select(User).filter(User.email == user_data.email))
    existing_user = result.scalars().first()
    if existing_user:
        raise HTTPException(status_code=409, detail="–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å —Ç–∞–∫–∏–º email —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç.")

    try:
        new_user = User(
            full_name=user_data.full_name,
            email=user_data.email,
            hashed_password=auth_service.hash_password(user_data.password),
            phone=user_data.phone,
            role=user_data.role,
            is_active=True,
            status="–ê–∫—Ç–∏–≤–Ω—ã–π",
            balance=0.0,
            notes=f"–°–æ–∑–¥–∞–Ω –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–º {datetime.now().strftime('%d-%m-%Y')}",
            privacy_policy_accepted=user_data.privacy_policy_accepted,
            terms_accepted=user_data.terms_accepted,
            email_verified=True
        )
        db.add(new_user)
        await db.commit()
        await db.refresh(new_user)
        
        # –í–æ–∑–≤—Ä–∞—â–∞–µ–º —Å–æ–∑–¥–∞–Ω–Ω—ã–π –æ–±—ä–µ–∫—Ç —Å –∑–∞–≥—Ä—É–∂–µ–Ω–Ω—ã–º–∏ –¥–∞–Ω–Ω—ã–º–∏ –∏–∑ –ë–î
        return new_user
    except Exception as e:
        await db.rollback()
        logging.error(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–º: {e}")
        raise HTTPException(status_code=500, detail="–í–Ω—É—Ç—Ä–µ–Ω–Ω—è—è –æ—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞.")

def get_current_user_info(user: User) -> UserOut:
    return UserOut.from_orm(user)

async def update_user(db: AsyncSession, user: User, data: UserUpdate) -> UserOut:
    """–û–±–Ω–æ–≤–ª—è–µ—Ç –ø—Ä–æ—Ñ–∏–ª—å —Ç–µ–∫—É—â–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è."""
    update_data = data.model_dump(exclude_unset=True)

    if 'email' in update_data and update_data['email'] != user.email:
        logging.info(f"–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å {user.id} –∑–∞–ø—Ä–æ—Å–∏–ª —Å–º–µ–Ω—É email –Ω–∞ {update_data['email']}. –¢—Ä–µ–±—É–µ—Ç—Å—è –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ.")
        del update_data['email']

    for key, value in update_data.items():
        setattr(user, key, value)

    db.add(user)
    await db.commit()
    
    # –í–æ–∑–≤—Ä–∞—â–∞–µ–º –æ–±–Ω–æ–≤–ª–µ–Ω–Ω—ã–π –æ–±—ä–µ–∫—Ç –±–µ–∑ –ø–æ–≤—Ç–æ—Ä–Ω–æ–≥–æ –∑–∞–ø—Ä–æ—Å–∞ –∫ –ë–î
    return UserOut.from_orm(user)

async def update_user_by_admin(db: AsyncSession, user_id: int, data: AdminUserUpdate, current_user: User) -> UserOut:
    """–û–±–Ω–æ–≤–ª—è–µ—Ç –¥–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è. –¢–æ–ª—å–∫–æ –∞–¥–º–∏–Ω –º–æ–∂–µ—Ç –º–µ–Ω—è—Ç—å —Ä–æ–ª—å."""
    result = await db.execute(select(User).filter(User.id == user_id))
    user_to_update = result.scalars().first()
    if not user_to_update:
        raise HTTPException(status_code=404, detail="–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω")

    update_data = data.model_dump(exclude_unset=True)

    if 'role' in update_data and current_user.role != 'admin':
        raise HTTPException(status_code=403, detail="–¢–æ–ª—å–∫–æ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä –º–æ–∂–µ—Ç –∏–∑–º–µ–Ω—è—Ç—å —Ä–æ–ª—å.")

    for key, value in update_data.items():
        setattr(user_to_update, key, value)

    db.add(user_to_update)
    await db.commit()
    
    # –í–æ–∑–≤—Ä–∞—â–∞–µ–º –æ–±–Ω–æ–≤–ª–µ–Ω–Ω—ã–π –æ–±—ä–µ–∫—Ç –±–µ–∑ –ø–æ–≤—Ç–æ—Ä–Ω–æ–≥–æ –∑–∞–ø—Ä–æ—Å–∞ –∫ –ë–î
    return UserOut.from_orm(user_to_update)

async def process_user_payment(db: AsyncSession, user_id: int, payment_data: UserPaymentRequest, manager: User) -> UserOut:
    """–û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç —Ä–µ–∞–ª—å–Ω—ã–π –ø–ª–∞—Ç–µ–∂ –∏ –ø–æ–ø–æ–ª–Ω—è–µ—Ç –≤–Ω—É—Ç—Ä–µ–Ω–Ω–∏–π –±–∞–ª–∞–Ω—Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è."""
    result = await db.execute(select(User).filter(User.id == user_id))
    user_to_update = result.scalars().first()
    if not user_to_update:
        raise HTTPException(status_code=404, detail="–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω")

    try:
        new_payment = Payment(
            user_id=user_id,
            amount=payment_data.amount,
            payment_method=payment_data.payment_method,
            description=payment_data.description or f"–ü–ª–∞—Ç–µ–∂ –ø—Ä–∏–Ω—è—Ç {manager.full_name}",
            transaction_type="balance_top_up"
        )
        db.add(new_payment)

        balance_service = BalanceService(db)
        await balance_service.add_transaction(
            user_id=user_id,
            amount=payment_data.amount,
            operation_type="balance_top_up",
            description=f"–ü–æ–ø–æ–ª–Ω–µ–Ω–∏–µ –±–∞–ª–∞–Ω—Å–∞. –ú–µ—Ç–æ–¥: {payment_data.payment_method}."
        )

        await db.commit()
        
        # –í–æ–∑–≤—Ä–∞—â–∞–µ–º –æ–±–Ω–æ–≤–ª–µ–Ω–Ω—ã–π –æ–±—ä–µ–∫—Ç –±–µ–∑ –ø–æ–≤—Ç–æ—Ä–Ω–æ–≥–æ –∑–∞–ø—Ä–æ—Å–∞ –∫ –ë–î
        return UserOut.from_orm(user_to_update)

    except HTTPException:
        await db.rollback()
        raise
    except Exception as e:
        await db.rollback()
        logging.error(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±—Ä–∞–±–æ—Ç–∫–µ –ø–ª–∞—Ç–µ–∂–∞ –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è ID={user_id}: {e}", exc_info=True)
        raise HTTPException(status_code=500, detail="–í–Ω—É—Ç—Ä–µ–Ω–Ω—è—è –æ—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±—Ä–∞–±–æ—Ç–∫–µ –ø–ª–∞—Ç–µ–∂–∞.")

# +++ –ù–ê–ß–ê–õ–û: –ù–æ–≤–∞—è —Ñ—É–Ω–∫—Ü–∏—è +++
async def get_balance_history_for_user(db: AsyncSession, user_id: int, skip: int, limit: int) -> Tuple[List[BalanceHistory], int]:
    """–ü–æ–ª—É—á–∞–µ—Ç –ø–∞–≥–∏–Ω–∏—Ä–æ–≤–∞–Ω–Ω—É—é –∏—Å—Ç–æ—Ä–∏—é –±–∞–ª–∞–Ω—Å–∞ –¥–ª—è —É–∫–∞–∑–∞–Ω–Ω–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è."""

    total_result = await db.execute(
        select(func.count(BalanceHistory.id)).filter(BalanceHistory.user_id == user_id)
    )
    total = total_result.scalar_one()

    history_result = await db.execute(
        select(BalanceHistory)
        .filter(BalanceHistory.user_id == user_id)
        .order_by(BalanceHistory.created_at.desc())
        .offset(skip)
        .limit(limit)
    )
    history_items = history_result.scalars().all()

    return history_items, total
# +++ –ö–û–ù–ï–¶: –ù–æ–≤–∞—è —Ñ—É–Ω–∫—Ü–∏—è +++

```


## <a name="RentalAppFASTAPIapiuserapipy"></a>`RentalApp_FASTAPI/api/user_api.py`

```python
// path: RentalApp_FASTAPI/api/user_api.py

# api/user_api.py

from fastapi import APIRouter, Depends, HTTPException, Query
from sqlalchemy.ext.asyncio import AsyncSession
from sqlalchemy import select, func
from typing import List, Optional

from api.models.user import User as OrmUser
from api.deps import get_db, get_rental_query_service
from api.permissions import require_user, require_manager, require_admin
from api.models.user import User as PermissionUser
from api.services import user_service
# <-- –ò–ó–ú–ï–ù–ï–ù–ò–ï –ó–î–ï–°–¨: –û–±–Ω–æ–≤–ª—è–µ–º –ø—É—Ç—å –∏–º–ø–æ—Ä—Ç–∞
from api.services.rental.rental_query_service import RentalQueryService
# ---------------------------------------------------
from shared.schemas.rental_schema import RentalListResponse, RentalOut
from shared.schemas.user_schema import UserUpdate, UserOut, AdminUserCreate, AdminUserUpdate, UserListResponse, UserPaymentRequest
from shared.schemas.balance_history_schema import BalanceHistoryOut, BalanceHistoryListResponse
from fastapi_csrf_protect import CsrfProtect

router = APIRouter(prefix="/user", tags=["–ü—Ä–æ—Ñ–∏–ª—å –∏ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏"])


@router.get("/", response_model=UserOut)
def get_my_profile(current_user: PermissionUser = Depends(require_user)):
    """
    –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç –ø—Ä–æ—Ñ–∏–ª—å —Ç–µ–∫—É—â–µ–≥–æ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω–Ω–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è.
    """
    return user_service.get_current_user_info(current_user)


@router.get("/rentals", response_model=RentalListResponse)
async def get_my_rentals(
        current_user: PermissionUser = Depends(require_user),
        service: RentalQueryService = Depends(get_rental_query_service),
        status: Optional[str] = Query(None, description="–§–∏–ª—å—Ç—Ä –ø–æ —Å—Ç–∞—Ç—É—Å—É: active, completed, overdue"),
        search: Optional[str] = Query(None, description="–ü–æ–∏—Å–∫ –ø–æ –Ω–∞–∑–≤–∞–Ω–∏—é, –±—Ä–µ–Ω–¥—É –∏–ª–∏ —Ç–∏–ø—É –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—è"),
        sort: Optional[str] = Query(None, description="–°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞: id_desc, id_asc, start_date_desc, start_date_asc, end_date_desc, end_date_asc, count_desc, count_asc"),
        skip: int = Query(0, ge=0, description="–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –∑–∞–ø–∏—Å–µ–π –¥–ª—è –ø—Ä–æ–ø—É—Å–∫–∞"),
        limit: int = Query(10, ge=1, le=100, description="–ú–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∑–∞–ø–∏—Å–µ–π –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–µ")
):
    """
    –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç –æ—Ç—Ñ–∏–ª—å—Ç—Ä–æ–≤–∞–Ω–Ω—ã–π –∏ –ø–∞–≥–∏–Ω–∏—Ä–æ–≤–∞–Ω–Ω—ã–π —Å–ø–∏—Å–æ–∫ –∞—Ä–µ–Ω–¥ –¥–ª—è —Ç–µ–∫—É—â–µ–≥–æ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω–Ω–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è.
    """
    rentals_out, total = await service.get_rentals_for_user(
        current_user, skip, limit, status, search, sort
    )
    return RentalListResponse(
        items=rentals_out,
        total=total
    )


@router.get("/balance-history", response_model=BalanceHistoryListResponse)
async def get_my_balance_history(
        db: AsyncSession = Depends(get_db),
        current_user: PermissionUser = Depends(require_user),
        skip: int = Query(0, ge=0),
        limit: int = Query(15, ge=1, le=100)
):
    """
    –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç –∏—Å—Ç–æ—Ä–∏—é —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π –ø–æ –±–∞–ª–∞–Ω—Å—É –¥–ª—è —Ç–µ–∫—É—â–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è.
    """
    history_orm, total = await user_service.get_balance_history_for_user(db, current_user.id, skip, limit)
    return BalanceHistoryListResponse(
        items=[BalanceHistoryOut.from_orm(h) for h in history_orm],
        total=total
    )


@router.put("/", response_model=UserOut)
async def update_my_profile(
        data: UserUpdate,
        db: AsyncSession = Depends(get_db),
        current_user: PermissionUser = Depends(require_user),
        csrf_protect: CsrfProtect = Depends()
):
    """
    –û–±–Ω–æ–≤–ª—è–µ—Ç –ø—Ä–æ—Ñ–∏–ª—å (–§–ò–û, email, —Ç–µ–ª–µ—Ñ–æ–Ω) —Ç–µ–∫—É—â–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è.
    –ó–ê–ì–õ–£–®–ö–ê: –°–º–µ–Ω–∞ email –≤ –±—É–¥—É—â–µ–º –ø–æ—Ç—Ä–µ–±—É–µ—Ç –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è –ø–æ –ø–æ—á—Ç–µ.
    """
    return await user_service.update_user(db, current_user, data)


@router.post("/confirm-email-change", summary="–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å —Å–º–µ–Ω—É email (–∑–∞–≥–ª—É—à–∫–∞)")
async def confirm_email_change(
        token: str,
        db: AsyncSession = Depends(get_db),
        current_user: PermissionUser = Depends(require_user),
        csrf_protect: CsrfProtect = Depends()
):
    """
    –ó–ê–ì–õ–£–®–ö–ê: –í –±—É–¥—É—â–µ–º –∑–¥–µ—Å—å –±—É–¥–µ—Ç –ª–æ–≥–∏–∫–∞ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è —Å–º–µ–Ω—ã email –ø–æ —Ç–æ–∫–µ–Ω—É.
    –°–µ–π—á–∞—Å –ø—Ä–æ—Å—Ç–æ –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–µ –æ —Ç–æ–º, —á—Ç–æ —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª –≤ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ.
    """
    return {
        "message": "–§—É–Ω–∫—Ü–∏–æ–Ω–∞–ª –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è —Å–º–µ–Ω—ã email –Ω–∞—Ö–æ–¥–∏—Ç—Å—è –≤ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ",
        "status": "not_implemented"
    }


# --- –≠–Ω–¥–ø–æ–∏–Ω—Ç—ã –¥–ª—è –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω–∏—è ---

@router.post("/admin/users", response_model=UserOut, status_code=201, summary="–°–æ–∑–¥–∞—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (–ê–¥–º–∏–Ω)")
async def create_user_by_admin(
        user_data: AdminUserCreate,
        db: AsyncSession = Depends(get_db),
        current_user: PermissionUser = Depends(require_admin),
        csrf_protect: CsrfProtect = Depends()
):
    """
    –°–æ–∑–¥–∞–µ—Ç –Ω–æ–≤–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è —Å —É–∫–∞–∑–∞–Ω–Ω–æ–π —Ä–æ–ª—å—é.
    –î–æ—Å—Ç—É–ø–Ω–æ —Ç–æ–ª—å–∫–æ –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π —Å —Ä–æ–ª—å—é 'admin'.
    """
    new_user = await user_service.create_admin_user(db, user_data)
    return new_user


@router.get("/admin/users", response_model=UserListResponse, summary="–ü–æ–ª—É—á–∏—Ç—å –≤—Å–µ—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π (–ú–µ–Ω–µ–¥–∂–µ—Ä)")
async def get_all_users(
        db: AsyncSession = Depends(get_db),
        current_user: PermissionUser = Depends(require_manager),
        skip: int = Query(0, ge=0, description="–°–∫–æ–ª—å–∫–æ –∑–∞–ø–∏—Å–µ–π –ø—Ä–æ–ø—É—Å—Ç–∏—Ç—å"),
        limit: int = Query(10, ge=1, le=100, description="–ú–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∑–∞–ø–∏—Å–µ–π –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–µ")
):
    """
    –ü–æ–ª—É—á–∞–µ—Ç —Å–ø–∏—Å–æ–∫ –≤—Å–µ—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –≤ —Å–∏—Å—Ç–µ–º–µ —Å –ø–∞–≥–∏–Ω–∞—Ü–∏–µ–π.
    –î–æ—Å—Ç—É–ø–Ω–æ –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π —Å —Ä–æ–ª—å—é 'manager' –∏ 'admin'.
    """
    total_result = await db.execute(select(func.count(OrmUser.id)))
    total_users = total_result.scalar_one()
    users_result = await db.execute(select(OrmUser).offset(skip).limit(limit))
    users_orm = users_result.scalars().all()

    return UserListResponse(
        items=[UserOut.from_orm(user) for user in users_orm],
        total=total_users
    )


@router.get("/admin/users/{user_id}/balance-history", response_model=BalanceHistoryListResponse, summary="–ü–æ–ª—É—á–∏—Ç—å –∏—Å—Ç–æ—Ä–∏—é –±–∞–ª–∞–Ω—Å–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (–ú–µ–Ω–µ–¥–∂–µ—Ä)")
async def get_user_balance_history_by_admin(
        user_id: int,
        db: AsyncSession = Depends(get_db),
        current_user: PermissionUser = Depends(require_manager),
        skip: int = Query(0, ge=0),
        limit: int = Query(15, ge=1, le=100)
):
    """
    –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç –∏—Å—Ç–æ—Ä–∏—é —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π –ø–æ –±–∞–ª–∞–Ω—Å—É –¥–ª—è —É–∫–∞–∑–∞–Ω–Ω–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è.
    """
    history_orm, total = await user_service.get_balance_history_for_user(db, user_id, skip, limit)
    return BalanceHistoryListResponse(
        items=[BalanceHistoryOut.from_orm(h) for h in history_orm],
        total=total
    )


@router.post("/admin/users/{user_id}/add-payment", response_model=UserOut, summary="–î–æ–±–∞–≤–∏—Ç—å –ø–ª–∞—Ç–µ–∂ –∏ –ø–æ–ø–æ–ª–Ω–∏—Ç—å –±–∞–ª–∞–Ω—Å (–ú–µ–Ω–µ–¥–∂–µ—Ä)")
async def add_payment_to_user(
        user_id: int,
        payment_data: UserPaymentRequest,
        db: AsyncSession = Depends(get_db),
        current_user: PermissionUser = Depends(require_manager),
        csrf_protect: CsrfProtect = Depends()
):
    """
    –†–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–µ—Ç —Ä–µ–∞–ª—å–Ω—ã–π –ø–ª–∞—Ç–µ–∂ –æ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏ –ø–æ–ø–æ–ª–Ω—è–µ—Ç –µ–≥–æ –≤–Ω—É—Ç—Ä–µ–Ω–Ω–∏–π –±–∞–ª–∞–Ω—Å.
    """
    return await user_service.process_user_payment(db, user_id, payment_data, current_user)


@router.put("/admin/users/{user_id}", response_model=UserOut, summary="–û–±–Ω–æ–≤–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (–ú–µ–Ω–µ–¥–∂–µ—Ä/–ê–¥–º–∏–Ω)")
async def update_user_by_admin_or_manager(
        user_id: int,
        data: AdminUserUpdate,
        db: AsyncSession = Depends(get_db),
        current_user: PermissionUser = Depends(require_manager),
        csrf_protect: CsrfProtect = Depends()
):
    """
    –û–±–Ω–æ–≤–ª—è–µ—Ç –¥–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è. –ú–µ–Ω–µ–¥–∂–µ—Ä—ã –º–æ–≥—É—Ç –æ–±–Ω–æ–≤–ª—è—Ç—å –≤—Å–µ, –∫—Ä–æ–º–µ —Ä–æ–ª–∏.
    –ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—ã –º–æ–≥—É—Ç –æ–±–Ω–æ–≤–ª—è—Ç—å –≤—Å–µ, –≤–∫–ª—é—á–∞—è —Ä–æ–ª—å. Email –Ω–µ –º–µ–Ω—è–µ—Ç—Å—è.
    """
    return await user_service.update_user_by_admin(db, user_id, data, current_user)


@router.put("/admin/users/{user_id}/role", summary="–ò–∑–º–µ–Ω–∏—Ç—å —Ä–æ–ª—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (–ê–¥–º–∏–Ω)")
async def update_user_role(
        user_id: int,
        new_role: str,
        db: AsyncSession = Depends(get_db),
        current_user: PermissionUser = Depends(require_admin),
        csrf_protect: CsrfProtect = Depends()
):
    """
    –û–±–Ω–æ–≤–ª—è–µ—Ç —Ä–æ–ª—å —É–∫–∞–∑–∞–Ω–Ω–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è.
    –î–æ—Å—Ç—É–ø–Ω–æ —Ç–æ–ª—å–∫–æ –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π —Å —Ä–æ–ª—å—é 'admin'.
    """
    if user_id == current_user.id:
        raise HTTPException(status_code=400, detail="–ù–µ–ª—å–∑—è –∏–∑–º–µ–Ω–∏—Ç—å —Å–æ–±—Å—Ç–≤–µ–Ω–Ω—É—é —Ä–æ–ª—å.")

    result = await db.execute(select(OrmUser).filter(OrmUser.id == user_id))
    user_orm = result.scalars().first()
    if not user_orm:
        raise HTTPException(status_code=404, detail="–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω")

    if new_role not in ["user", "manager", "admin"]:
        raise HTTPException(status_code=400, detail="–ù–µ–¥–æ–ø—É—Å—Ç–∏–º–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ —Ä–æ–ª–∏.")

    user_orm.role = new_role
    await db.commit()
    return {"message": f"–†–æ–ª—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è {user_orm.email} –æ–±–Ω–æ–≤–ª–µ–Ω–∞ –Ω–∞ '{new_role}'"}


@router.put("/admin/users/{user_id}/block", summary="–ó–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (–ê–¥–º–∏–Ω)")
async def block_user(
        user_id: int,
        db: AsyncSession = Depends(get_db),
        current_user: PermissionUser = Depends(require_admin),
        csrf_protect: CsrfProtect = Depends()
):
    """
    –î–µ–∞–∫—Ç–∏–≤–∏—Ä—É–µ—Ç (–±–ª–æ–∫–∏—Ä—É–µ—Ç) –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è.
    –î–æ—Å—Ç—É–ø–Ω–æ —Ç–æ–ª—å–∫–æ –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π —Å —Ä–æ–ª—å—é 'admin'.
    """
    if user_id == current_user.id:
        raise HTTPException(status_code=400, detail="–ù–µ–ª—å–∑—è –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å —Å–∞–º–æ–≥–æ —Å–µ–±—è.")

    result = await db.execute(select(OrmUser).filter(OrmUser.id == user_id))
    user_orm = result.scalars().first()
    if not user_orm:
        raise HTTPException(status_code=404, detail="–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω")

    user_orm.is_active = False
    await db.commit()
    return {"message": f"–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å {user_orm.email} –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω"}


@router.put("/admin/users/{user_id}/unblock", summary="–†–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (–ê–¥–º–∏–Ω)")
async def unblock_user(
        user_id: int,
        db: AsyncSession = Depends(get_db),
        current_user: PermissionUser = Depends(require_admin),
        csrf_protect: CsrfProtect = Depends()
):
    """
    –ê–∫—Ç–∏–≤–∏—Ä—É–µ—Ç (—Ä–∞–∑–±–ª–æ–∫–∏—Ä—É–µ—Ç) –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è.
    –î–æ—Å—Ç—É–ø–Ω–æ —Ç–æ–ª—å–∫–æ –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π —Å —Ä–æ–ª—å—é 'admin'.
    """
    result = await db.execute(select(OrmUser).filter(OrmUser.id == user_id))
    user_orm = result.scalars().first()
    if not user_orm:
        raise HTTPException(status_code=404, detail="–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω")

    user_orm.is_active = True
    await db.commit()
    return {"message": f"–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å {user_orm.email} —Ä–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω"}


@router.delete("/admin/users/{user_id}", summary="–£–¥–∞–ª–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (–ê–¥–º–∏–Ω)")
async def delete_user(
        user_id: int,
        db: AsyncSession = Depends(get_db),
        current_user: PermissionUser = Depends(require_admin),
        csrf_protect: CsrfProtect = Depends()
):
    """
    –ü–æ–ª–Ω–æ—Å—Ç—å—é —É–¥–∞–ª—è–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏–∑ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö.
    –≠—Ç–æ –Ω–µ–æ–±—Ä–∞—Ç–∏–º–æ–µ –¥–µ–π—Å—Ç–≤–∏–µ!
    –î–æ—Å—Ç—É–ø–Ω–æ —Ç–æ–ª—å–∫–æ –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π —Å —Ä–æ–ª—å—é 'admin'.
    """
    if user_id == current_user.id:
        raise HTTPException(status_code=400, detail="–ù–µ–ª—å–∑—è —É–¥–∞–ª–∏—Ç—å —Å–∞–º–æ–≥–æ —Å–µ–±—è.")

    result = await db.execute(select(OrmUser).filter(OrmUser.id == user_id))
    user_orm = result.scalars().first()
    if not user_orm:
        raise HTTPException(status_code=404, detail="–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω")

    await db.delete(user_orm)
    await db.commit()
    return {"message": f"–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å {user_orm.email} –ø–æ–ª–Ω–æ—Å—Ç—å—é —É–¥–∞–ª–µ–Ω –∏–∑ —Å–∏—Å—Ç–µ–º—ã"}

```


## <a name="RentalAppFASTAPIconfiginitpy"></a>`RentalApp_FASTAPI/config/__init__.py`

```python
// path: RentalApp_FASTAPI/config/__init__.py

# config/__init__.py

"""
–ü–∞–∫–µ—Ç –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ –ø—Ä–æ–µ–∫—Ç–∞ –∞—Ä–µ–Ω–¥—ã —Ñ–æ—Ç–æ—Ç–µ—Ö–Ω–∏–∫–∏.
–ò–º–ø–æ—Ä—Ç–∏—Ä—É–µ—Ç –±–∞–∑–æ–≤—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –∏ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è.
"""

# –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è —Å—Ä–∞–∑—É –ø—Ä–∏ –∏–º–ø–æ—Ä—Ç–µ config
from config import logging_config

```


## <a name="RentalAppFASTAPIconfigloggingconfigpy"></a>`RentalApp_FASTAPI/config/logging_config.py`

```python
// path: RentalApp_FASTAPI/config/logging_config.py

# config/logging_config.py

"""
–ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è –¥–ª—è –ø—Ä–æ–µ–∫—Ç–∞ –∞—Ä–µ–Ω–¥—ã —Ñ–æ—Ç–æ—Ç–µ—Ö–Ω–∏–∫–∏.
"""

import logging
from config.settings import LOG_FILE, DEBUG

# –ë–∞–∑–æ–≤–∞—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∞ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è
logging.basicConfig(
    level=logging.DEBUG if DEBUG else logging.WARNING,
    format="%(asctime)s [%(levelname)s] [%(name)s] %(message)s",
    handlers=[
        logging.FileHandler(LOG_FILE, encoding="utf-8"),
        logging.StreamHandler()
    ]
)

# –û—Ç–∫–ª—é—á–µ–Ω–∏–µ –Ω–µ–Ω—É–∂–Ω—ã—Ö –ª–æ–≥–æ–≤
logging.getLogger("httpcore").setLevel(logging.WARNING)
logging.getLogger("httpx").setLevel(logging.WARNING)
logging.getLogger("TelegramService").setLevel(logging.DEBUG)

# –í–∫–ª—é—á–µ–Ω–∏–µ –ª–æ–≥–æ–≤ –¥–ª—è SQLAlchemy (SQL-–∑–∞–ø—Ä–æ—Å—ã) –∏ EquipmentService
logging.getLogger("sqlalchemy.engine").setLevel(logging.WARNING)
logging.getLogger("EquipmentService").setLevel(logging.WARNING)
logging.getLogger("BaseManager").setLevel(logging.WARNING)
logging.getLogger("EquipmentManager").setLevel(logging.WARNING)
logging.getLogger("AvailabilityChecker").setLevel(logging.DEBUG)
logging.getLogger("matplotlib").setLevel(logging.WARNING)
# –£—Ä–æ–≤–µ–Ω—å –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è –¥–ª—è –æ—Ç–¥–µ–ª—å–Ω—ã—Ö –º–æ–¥—É–ª–µ–π –º–æ–∂–Ω–æ –Ω–∞—Å—Ç—Ä–æ–∏—Ç—å —Ç–∞–∫:
# logging.getLogger('sqlalchemy.engine').setLevel(logging.WARNING)




```


## <a name="RentalAppFASTAPIconfigsecretspy"></a>`RentalApp_FASTAPI/config/secrets.py`

```python
// path: RentalApp_FASTAPI/config/secrets.py

"""
–ó–∞–≥—Ä—É–∑–∫–∞ –∫–æ–Ω—Ñ–∏–¥–µ–Ω—Ü–∏–∞–ª—å–Ω—ã—Ö –Ω–∞—Å—Ç—Ä–æ–µ–∫ –∏–∑ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏—è.
"""

import os
from pathlib import Path
from dotenv import load_dotenv

# ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ –ó–∞–≥—Ä—É–∑–∫–∞ .env ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
load_dotenv()

# ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ –ö–æ—Ä–µ–Ω—å –ø—Ä–æ–µ–∫—Ç–∞ ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
BASE_DIR = Path(__file__).resolve().parent.parent

# ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ –°–µ–∫—Ä–µ—Ç—ã –∏ —Ç–æ–∫–µ–Ω—ã ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
TELEGRAM_TOKEN = os.getenv("TELEGRAM_TOKEN", "default_token_for_dev")
DEFAULT_TELEGRAM_CHAT_ID = os.getenv("DEFAULT_TELEGRAM_CHAT_ID", "")
YANDEX_EMAIL_SENDER = os.getenv("YANDEX_EMAIL_SENDER")
YANDEX_SMTP_PASSWORD = os.getenv("YANDEX_SMTP_PASSWORD")

# ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ URL –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
# –ò—Å–ø–æ–ª—å–∑—É–µ–º —Ç–æ–ª—å–∫–æ PostgreSQL
DATABASE_URL = os.getenv("DATABASE_URL", "postgresql+asyncpg://myuser:supersecretpassword@db:5432/rental_db")
print("üß© –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è PostgreSQL")

# DEBUG –º–æ–∂–µ—Ç –æ—Å—Ç–∞—Ç—å—Å—è –∑–¥–µ—Å—å (–µ—Å–ª–∏ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è)
DEBUG = os.getenv("DEBUG", "True").lower() == "true"

SECRET_KEY = os.getenv("SECRET_KEY", "super-secret-key-dev")


```


## <a name="RentalAppFASTAPIconfigsettingspy"></a>`RentalApp_FASTAPI/config/settings.py`

```python
// path: RentalApp_FASTAPI/config/settings.py

"""
–ù–∞—Å—Ç—Ä–æ–π–∫–∏ –ø—Ä–æ–µ–∫—Ç–∞ –ê—Ä–µ–Ω–¥—ã —Ñ–æ—Ç–æ—Ç–µ—Ö–Ω–∏–∫–∏ (–Ω–µ –≤–∫–ª—é—á–∞—è —Å–µ–∫—Ä–µ—Ç—ã –∏ –ë–î).
"""

import os
from pathlib import Path
from dotenv import load_dotenv

# –ó–∞–≥—Ä—É–∑–∫–∞ .env
load_dotenv()

# ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ –û–±—â–∏–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
BASE_DIR = Path(__file__).resolve().parent.parent
APP_NAME = "–ê—Ä–µ–Ω–¥–∞ —Ñ–æ—Ç–æ—Ç–µ—Ö–Ω–∏–∫–∏"

# ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ –ü—É—Ç–∏ ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
LOG_FILE = BASE_DIR / "app.log"
EXPORT_FOLDER = BASE_DIR / "exports"
EXPORT_FOLDER.mkdir(exist_ok=True)
CONTRACT_TEMPLATE = BASE_DIR / "ui" / "pdf" / "contract_template.html"

# ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ –ò–Ω—Ç–µ—Ä—Ñ–µ–π—Å ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
DEFAULT_WINDOW_WIDTH = 1400
DEFAULT_WINDOW_HEIGHT = 900

# ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ –û—Ç–ª–∞–¥–∫–∞ ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
DEBUG = os.getenv("DEBUG", "True").lower() == "true"


PASSWORD_MIN_LENGTH = 8
PASSWORD_REQUIRE_UPPERCASE = True
PASSWORD_REQUIRE_LOWERCASE = True
PASSWORD_REQUIRE_DIGITS = True


```


## <a name="RentalAppFASTAPIcreateadminpy"></a>`RentalApp_FASTAPI/create_admin.py`

```python
// path: RentalApp_FASTAPI/create_admin.py

# RentalApp_FASTAPI/scripts/create_admin.py

import asyncio
import sys
import os
from sqlalchemy import select

# –î–æ–±–∞–≤–ª—è–µ–º –∫–æ—Ä–Ω–µ–≤—É—é –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é –ø—Ä–æ–µ–∫—Ç–∞ –≤ –ø—É—Ç—å, —á—Ç–æ–±—ã —Ä–∞–±–æ—Ç–∞–ª–∏ –∏–º–ø–æ—Ä—Ç—ã
sys.path.append(os.path.dirname(os.path.dirname(os.path.abspath(__file__))))

from api.database import AsyncSessionLocal
from api.models.user import User
from api.services.auth_service import hash_password

# --- –î–∞–Ω–Ω—ã–µ –¥–ª—è –≤—Ö–æ–¥–∞ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞ ---
ADMIN_EMAIL = "admin@rentalapp.com"
ADMIN_PASSWORD = "AdminRental2024!" # –ë–µ–∑–æ–ø–∞—Å–Ω—ã–π –ø–∞—Ä–æ–ª—å
ADMIN_FULL_NAME = "–ì–ª–∞–≤–Ω—ã–π –ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä"
ADMIN_PHONE = "+7 (999) 000-00-00"
# ------------------------------------

async def create_admin_user():
    """
    –°–æ–∑–¥–∞–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è —Å –ø—Ä–∞–≤–∞–º–∏ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞ –≤ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö.
    """
    print("üöÄ –ó–∞–ø—É—Å–∫ —Å–∫—Ä–∏–ø—Ç–∞ —Å–æ–∑–¥–∞–Ω–∏—è –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞...")
    db_session = AsyncSessionLocal()
    try:
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –ª–∏ —É–∂–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å —Ç–∞–∫–∏–º email
        result = await db_session.execute(select(User).filter(User.email == ADMIN_EMAIL))
        existing_user = result.scalars().first()

        if existing_user:
            print(f"‚úÖ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å email '{ADMIN_EMAIL}' —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç. –ü—Ä–æ–ø—É—Å–∫–∞–µ–º —Å–æ–∑–¥–∞–Ω–∏–µ.")
            return

        # –°–æ–∑–¥–∞–µ–º –Ω–æ–≤–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        new_admin = User(
            full_name=ADMIN_FULL_NAME,
            email=ADMIN_EMAIL,
            hashed_password=hash_password(ADMIN_PASSWORD),
            phone=ADMIN_PHONE,
            role="admin",
            is_active=True,
            status="–ê–∫—Ç–∏–≤–Ω—ã–π",
            balance=0.0,
            notes="–°–æ–∑–¥–∞–Ω –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø—Ä–∏ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏",
            privacy_policy_accepted=True,
            terms_accepted=True,
            email_verified=True
        )
        db_session.add(new_admin)
        await db_session.commit()
        print("‚úÖ –£—á–µ—Ç–Ω–∞—è –∑–∞–ø–∏—Å—å –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞ —É—Å–ø–µ—à–Ω–æ —Å–æ–∑–¥–∞–Ω–∞!")
        print("---")
        print(f"  üìß Email: {ADMIN_EMAIL}")
        print(f"  üîë –ü–∞—Ä–æ–ª—å: {ADMIN_PASSWORD}")
        print("---")

    except Exception as e:
        await db_session.rollback()
        print(f"‚ùå –ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞: {e}")
    finally:
        await db_session.close()
        print("üèÅ –°–∫—Ä–∏–ø—Ç –∑–∞–≤–µ—Ä—à–∏–ª —Ä–∞–±–æ—Ç—É.")

if __name__ == "__main__":
    asyncio.run(create_admin_user())

```


## <a name="RentalAppFASTAPIdbinitdbpy"></a>`RentalApp_FASTAPI/db/init_db.py`

```python
// path: RentalApp_FASTAPI/db/init_db.py

# db/init_db.py
from db.orm import init_db

if __name__ == "__main__":
    init_db()
    print("–ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö —É—Å–ø–µ—à–Ω–æ —Å–æ–∑–¥–∞–Ω–∞!")

```


## <a name="RentalAppFASTAPImigrationsenvpy"></a>`RentalApp_FASTAPI/migrations/env.py`

```python
// path: RentalApp_FASTAPI/migrations/env.py

# migrations/env.py

import sys
import os
from logging.config import fileConfig
import asyncio

from sqlalchemy import engine_from_config, pool
from sqlalchemy.ext.asyncio import create_async_engine

from alembic import context

# 1. –î–æ–±–∞–≤–ª—è–µ–º –ø—É—Ç—å –∫ –∫–æ—Ä–Ω–µ–≤–æ–π –ø–∞–ø–∫–µ –ø—Ä–æ–µ–∫—Ç–∞
sys.path.insert(0, os.path.abspath(os.path.join(os.path.dirname(__file__), '..')))

# 2. –£–∫–∞–∑—ã–≤–∞–µ–º Alembic –Ω–∞ –±–∞–∑–æ–≤—ã–π –∫–ª–∞—Å—Å –º–æ–¥–µ–ª–µ–π
from api.database import Base

# 3. –ò–º–ø–æ—Ä—Ç–∏—Ä—É–µ–º –í–°–ï –ê–ö–¢–£–ê–õ–¨–ù–´–ï –º–æ–¥–µ–ª–∏
# +++ –î–û–ë–ê–í–¨–¢–ï balance_history –í –≠–¢–û–¢ –°–ü–ò–°–û–ö +++
from api.models import user, equipment, reservation, rental, accessory, payment, promo_code, holiday, discount, association, balance_history

# 4. –ü–µ—Ä–µ–¥–∞–µ–º –º–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ –≤–∞—à–∏—Ö –º–æ–¥–µ–ª–µ–π –≤ Alembic
target_metadata = Base.metadata

# This is the Alembic Config object...
config = context.config

# Interpret the config file for Python logging.
if config.config_file_name is not None:
    fileConfig(config.config_file_name)


def run_migrations_offline() -> None:
    """Run migrations in 'offline' mode."""
    url = config.get_main_option("sqlalchemy.url")
    # –ö–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ–º –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω—ã–π URL –≤ —Å–∏–Ω—Ö—Ä–æ–Ω–Ω—ã–π –¥–ª—è offline —Ä–µ–∂–∏–º–∞
    if url and "postgresql+asyncpg://" in url:
        url = url.replace("postgresql+asyncpg://", "postgresql://")
    
    context.configure(
        url=url,
        target_metadata=target_metadata,
        literal_binds=True,
        dialect_opts={"paramstyle": "named"},
    )
    with context.begin_transaction():
        context.run_migrations()


def do_run_migrations(connection):
    """–í—ã–ø–æ–ª–Ω—è–µ—Ç –º–∏–≥—Ä–∞—Ü–∏–∏ —Å –ø–µ—Ä–µ–¥–∞–Ω–Ω—ã–º —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ–º."""
    context.configure(connection=connection, target_metadata=target_metadata)
    with context.begin_transaction():
        context.run_migrations()


async def run_async_migrations():
    """–í—ã–ø–æ–ª–Ω—è–µ—Ç –º–∏–≥—Ä–∞—Ü–∏–∏ –≤ –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ–º —Ä–µ–∂–∏–º–µ."""
    url = config.get_main_option("sqlalchemy.url")
    if url and "postgresql+asyncpg://" in url:
        # –ò—Å–ø–æ–ª—å–∑—É–µ–º –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω—ã–π –¥–≤–∏–∂–æ–∫
        connectable = create_async_engine(url)
        async with connectable.connect() as connection:
            await connection.run_sync(do_run_migrations)
    else:
        # Fallback –∫ —Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ–º—É —Ä–µ–∂–∏–º—É
        connectable = engine_from_config(
            config.get_section(config.config_ini_section, {}),
            prefix="sqlalchemy.",
            poolclass=pool.NullPool,
        )
        with connectable.connect() as connection:
            do_run_migrations(connection)


def run_migrations_online() -> None:
    """Run migrations in 'online' mode."""
    url = config.get_main_option("sqlalchemy.url")
    if url and "postgresql+asyncpg://" in url:
        # –ó–∞–ø—É—Å–∫–∞–µ–º –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω—ã–µ –º–∏–≥—Ä–∞—Ü–∏–∏
        asyncio.run(run_async_migrations())
    else:
        # Fallback –∫ —Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ–º—É —Ä–µ–∂–∏–º—É
        connectable = engine_from_config(
            config.get_section(config.config_ini_section, {}),
            prefix="sqlalchemy.",
            poolclass=pool.NullPool,
        )
        with connectable.connect() as connection:
            do_run_migrations(connection)


if context.is_offline_mode():
    run_migrations_offline()
else:
    run_migrations_online()

```


## <a name="RentalAppFASTAPImigrationsversions9290ae79b0d3createinitialtablespy"></a>`RentalApp_FASTAPI/migrations/versions/9290ae79b0d3_create_initial_tables.py`

```python
// path: RentalApp_FASTAPI/migrations/versions/9290ae79b0d3_create_initial_tables.py

"""Create initial tables

Revision ID: 9290ae79b0d3
Revises: 
Create Date: 2025-09-13 15:05:27.964374

"""
from typing import Sequence, Union

from alembic import op
import sqlalchemy as sa


# revision identifiers, used by Alembic.
revision: str = '9290ae79b0d3'
down_revision: Union[str, None] = None
branch_labels: Union[str, Sequence[str], None] = None
depends_on: Union[str, Sequence[str], None] = None


def upgrade() -> None:
    """Upgrade schema."""
    # ### commands auto generated by Alembic - please adjust! ###
    op.create_table('accessories',
    sa.Column('id', sa.Integer(), nullable=False),
    sa.Column('name', sa.String(), nullable=False),
    sa.Column('accessory_type', sa.String(), nullable=True),
    sa.Column('price', sa.Float(), nullable=True),
    sa.Column('description', sa.Text(), nullable=True),
    sa.PrimaryKeyConstraint('id')
    )
    op.create_index(op.f('ix_accessories_accessory_type'), 'accessories', ['accessory_type'], unique=False)
    op.create_index(op.f('ix_accessories_id'), 'accessories', ['id'], unique=False)
    op.create_index(op.f('ix_accessories_name'), 'accessories', ['name'], unique=False)
    op.create_table('associations',
    sa.Column('id', sa.Integer(), nullable=False),
    sa.Column('name', sa.String(), nullable=False),
    sa.Column('description', sa.Text(), nullable=True),
    sa.Column('sort_order', sa.Integer(), nullable=False),
    sa.PrimaryKeyConstraint('id')
    )
    op.create_index(op.f('ix_associations_id'), 'associations', ['id'], unique=False)
    op.create_index(op.f('ix_associations_name'), 'associations', ['name'], unique=True)
    op.create_table('duration_discounts',
    sa.Column('id', sa.Integer(), nullable=False),
    sa.Column('min_days', sa.Integer(), nullable=False, comment='–ú–∏–Ω–∏–º–∞–ª—å–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –¥–Ω–µ–π –¥–ª—è —Å–∫–∏–¥–∫–∏ (–≤–∫–ª—é—á–∏—Ç–µ–ª—å–Ω–æ)'),
    sa.Column('discount_percentage', sa.Integer(), nullable=False, comment='–ü—Ä–æ—Ü–µ–Ω—Ç —Å–∫–∏–¥–∫–∏'),
    sa.PrimaryKeyConstraint('id'),
    sa.UniqueConstraint('min_days')
    )
    op.create_table('equipment',
    sa.Column('id', sa.Integer(), nullable=False),
    sa.Column('equipment_type', sa.String(), nullable=False),
    sa.Column('brand', sa.String(), nullable=False),
    sa.Column('name', sa.String(), nullable=False),
    sa.Column('serial_number', sa.String(), nullable=True),
    sa.Column('condition', sa.String(), nullable=True),
    sa.Column('daily_rate', sa.Float(), nullable=True),
    sa.Column('notes', sa.String(), nullable=True),
    sa.Column('last_maintenance', sa.Date(), nullable=True),
    sa.Column('description', sa.Text(), nullable=True),
    sa.Column('image_url', sa.String(), nullable=True),
    sa.Column('image_urls', sa.JSON(), nullable=True),
    sa.Column('short_description', sa.String(), nullable=True),
    sa.PrimaryKeyConstraint('id'),
    sa.UniqueConstraint('serial_number')
    )
    op.create_table('users',
    sa.Column('id', sa.Integer(), nullable=False),
    sa.Column('full_name', sa.String(), nullable=False),
    sa.Column('email', sa.String(), nullable=False),
    sa.Column('hashed_password', sa.String(), nullable=True),
    sa.Column('role', sa.String(), nullable=True),
    sa.Column('created_at', sa.DateTime(timezone=True), nullable=True),
    sa.Column('is_active', sa.Boolean(), nullable=True),
    sa.Column('phone', sa.String(), nullable=True),
    sa.Column('status', sa.String(), nullable=True),
    sa.Column('balance', sa.Float(), nullable=True),
    sa.Column('notes', sa.Text(), nullable=True),
    sa.Column('privacy_policy_accepted', sa.Boolean(), nullable=True),
    sa.Column('terms_accepted', sa.Boolean(), nullable=True),
    sa.Column('email_verified', sa.Boolean(), nullable=True),
    sa.PrimaryKeyConstraint('id')
    )
    op.create_index(op.f('ix_users_email'), 'users', ['email'], unique=True)
    op.create_table('association_equipment_association',
    sa.Column('association_id', sa.Integer(), nullable=False),
    sa.Column('equipment_id', sa.Integer(), nullable=False),
    sa.ForeignKeyConstraint(['association_id'], ['associations.id'], ),
    sa.ForeignKeyConstraint(['equipment_id'], ['equipment.id'], ),
    sa.PrimaryKeyConstraint('association_id', 'equipment_id')
    )
    op.create_table('equipment_accessories',
    sa.Column('equipment_id', sa.Integer(), nullable=False),
    sa.Column('accessory_id', sa.Integer(), nullable=False),
    sa.ForeignKeyConstraint(['accessory_id'], ['accessories.id'], ),
    sa.ForeignKeyConstraint(['equipment_id'], ['equipment.id'], ),
    sa.PrimaryKeyConstraint('equipment_id', 'accessory_id')
    )
    op.create_table('holiday_rules',
    sa.Column('id', sa.Integer(), nullable=False),
    sa.Column('rule_type', sa.String(), nullable=False, comment="–¢–∏–ø –ø—Ä–∞–≤–∏–ª–∞, –Ω–∞–ø—Ä–∏–º–µ—Ä 'weekly' –∏–ª–∏ 'public_import'"),
    sa.Column('parameters', sa.JSON(), nullable=False, comment="–ü–∞—Ä–∞–º–µ—Ç—Ä—ã –ø—Ä–∞–≤–∏–ª–∞, –Ω–∞–ø—Ä–∏–º–µ—Ä {'day_of_week': 6} –¥–ª—è –≤–æ—Å–∫—Ä–µ—Å–µ–Ω—å—è"),
    sa.Column('description', sa.String(), nullable=False, comment='–û–ø–∏—Å–∞–Ω–∏–µ –ø—Ä–∞–≤–∏–ª–∞ –¥–ª—è –∞–¥–º–∏–Ω–∞'),
    sa.Column('created_at', sa.DateTime(timezone=True), nullable=True),
    sa.Column('created_by_id', sa.Integer(), nullable=False),
    sa.ForeignKeyConstraint(['created_by_id'], ['users.id'], ),
    sa.PrimaryKeyConstraint('id')
    )
    op.create_table('promo_codes',
    sa.Column('id', sa.Integer(), nullable=False),
    sa.Column('code', sa.String(), nullable=False),
    sa.Column('description', sa.Text(), nullable=True, comment='–ö—Ä–∞—Ç–∫–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ –¥–ª—è –º–µ–Ω–µ–¥–∂–µ—Ä–æ–≤'),
    sa.Column('discount_percentage', sa.Float(), nullable=False),
    sa.Column('is_active', sa.Boolean(), nullable=True),
    sa.Column('valid_from', sa.DateTime(timezone=True), nullable=True, comment='–î–∞—Ç–∞ –Ω–∞—á–∞–ª–∞ –¥–µ–π—Å—Ç–≤–∏—è'),
    sa.Column('expires_at', sa.DateTime(timezone=True), nullable=True, comment='–î–∞—Ç–∞ –∏—Å—Ç–µ—á–µ–Ω–∏—è —Å—Ä–æ–∫–∞'),
    sa.Column('max_uses', sa.Integer(), nullable=True, comment='–û–±—â–∏–π –ª–∏–º–∏—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–π'),
    sa.Column('times_used', sa.Integer(), nullable=False),
    sa.Column('max_uses_per_user', sa.Integer(), nullable=True, comment='–õ–∏–º–∏—Ç –Ω–∞ –æ–¥–Ω–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è'),
    sa.Column('min_order_amount', sa.Float(), nullable=True, comment='–ú–∏–Ω–∏–º–∞–ª—å–Ω–∞—è —Å—É–º–º–∞ –∑–∞–∫–∞–∑–∞ –¥–ª—è –∞–∫—Ç–∏–≤–∞—Ü–∏–∏'),
    sa.Column('specific_to_user_id', sa.Integer(), nullable=True, comment='–ï—Å–ª–∏ –∫–æ–¥ –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã–π'),
    sa.Column('created_at', sa.DateTime(timezone=True), nullable=True),
    sa.Column('created_by_id', sa.Integer(), nullable=True),
    sa.ForeignKeyConstraint(['created_by_id'], ['users.id'], ),
    sa.ForeignKeyConstraint(['specific_to_user_id'], ['users.id'], ),
    sa.PrimaryKeyConstraint('id')
    )
    op.create_index(op.f('ix_promo_codes_code'), 'promo_codes', ['code'], unique=True)
    op.create_index(op.f('ix_promo_codes_id'), 'promo_codes', ['id'], unique=False)
    op.create_table('holidays',
    sa.Column('date', sa.Date(), nullable=False, comment='–î–∞—Ç–∞ –≤—ã—Ö–æ–¥–Ω–æ–≥–æ –¥–Ω—è'),
    sa.Column('description', sa.String(), nullable=True, comment='–ù–∞–∑–≤–∞–Ω–∏–µ (–Ω–∞–ø—Ä–∏–º–µ—Ä, –ù–æ–≤—ã–π –≥–æ–¥)'),
    sa.Column('created_at', sa.DateTime(timezone=True), nullable=True),
    sa.Column('created_by_id', sa.Integer(), nullable=False),
    sa.Column('rule_id', sa.Integer(), nullable=True, comment='ID –ø—Ä–∞–≤–∏–ª–∞, –∫–æ—Ç–æ—Ä—ã–º —Å–æ–∑–¥–∞–Ω —ç—Ç–æ—Ç –≤—ã—Ö–æ–¥–Ω–æ–π'),
    sa.ForeignKeyConstraint(['created_by_id'], ['users.id'], ),
    sa.ForeignKeyConstraint(['rule_id'], ['holiday_rules.id'], ),
    sa.PrimaryKeyConstraint('date')
    )
    op.create_index(op.f('ix_holidays_date'), 'holidays', ['date'], unique=False)
    op.create_table('promo_code_applicable_types',
    sa.Column('promo_code_id', sa.Integer(), nullable=False),
    sa.Column('type_name', sa.String(), nullable=False),
    sa.ForeignKeyConstraint(['promo_code_id'], ['promo_codes.id'], ),
    sa.PrimaryKeyConstraint('promo_code_id', 'type_name')
    )
    op.create_table('promo_code_equipment',
    sa.Column('promo_code_id', sa.Integer(), nullable=False),
    sa.Column('equipment_id', sa.Integer(), nullable=False),
    sa.ForeignKeyConstraint(['equipment_id'], ['equipment.id'], ),
    sa.ForeignKeyConstraint(['promo_code_id'], ['promo_codes.id'], ),
    sa.PrimaryKeyConstraint('promo_code_id', 'equipment_id')
    )
    op.create_table('promo_code_usages',
    sa.Column('user_id', sa.Integer(), nullable=False),
    sa.Column('promo_code_id', sa.Integer(), nullable=False),
    sa.Column('used_at', sa.DateTime(timezone=True), nullable=True),
    sa.ForeignKeyConstraint(['promo_code_id'], ['promo_codes.id'], ),
    sa.ForeignKeyConstraint(['user_id'], ['users.id'], ),
    sa.PrimaryKeyConstraint('user_id', 'promo_code_id')
    )
    op.create_table('reservations',
    sa.Column('id', sa.Integer(), nullable=False),
    sa.Column('user_id', sa.Integer(), nullable=False),
    sa.Column('start_date', sa.Date(), nullable=False),
    sa.Column('end_date', sa.Date(), nullable=False),
    sa.Column('status', sa.String(), nullable=False),
    sa.Column('promo_code_id', sa.Integer(), nullable=True),
    sa.Column('total_cost', sa.Float(), nullable=False),
    sa.Column('discount_amount', sa.Float(), nullable=False),
    sa.Column('created_at', sa.DateTime(timezone=True), nullable=True),
    sa.ForeignKeyConstraint(['promo_code_id'], ['promo_codes.id'], ),
    sa.ForeignKeyConstraint(['user_id'], ['users.id'], ),
    sa.PrimaryKeyConstraint('id')
    )
    op.create_index(op.f('ix_reservations_status'), 'reservations', ['status'], unique=False)
    op.create_table('rentals',
    sa.Column('id', sa.Integer(), nullable=False),
    sa.Column('user_id', sa.Integer(), nullable=False),
    sa.Column('created_by_id', sa.Integer(), nullable=False),
    sa.Column('reservation_id', sa.Integer(), nullable=True),
    sa.Column('start_date', sa.Date(), nullable=False),
    sa.Column('end_date', sa.Date(), nullable=False),
    sa.Column('actual_return_date', sa.Date(), nullable=True),
    sa.Column('status', sa.String(), nullable=False),
    sa.Column('total_cost', sa.Float(), nullable=False),
    sa.Column('discount_amount', sa.Float(), nullable=False),
    sa.Column('promo_code', sa.String(), nullable=True),
    sa.Column('final_cost', sa.Float(), nullable=True),
    sa.Column('deposit_amount', sa.Float(), nullable=True),
    sa.Column('prepayment_amount', sa.Float(), nullable=False),
    sa.Column('notes_on_issue', sa.Text(), nullable=True),
    sa.Column('notes_on_return', sa.Text(), nullable=True),
    sa.Column('created_at', sa.DateTime(timezone=True), nullable=True),
    sa.Column('updated_at', sa.DateTime(timezone=True), nullable=True),
    sa.ForeignKeyConstraint(['created_by_id'], ['users.id'], ),
    sa.ForeignKeyConstraint(['reservation_id'], ['reservations.id'], ),
    sa.ForeignKeyConstraint(['user_id'], ['users.id'], ),
    sa.PrimaryKeyConstraint('id'),
    sa.UniqueConstraint('reservation_id')
    )
    op.create_index(op.f('ix_rentals_status'), 'rentals', ['status'], unique=False)
    op.create_table('reservation_accessories',
    sa.Column('reservation_id', sa.Integer(), nullable=False),
    sa.Column('equipment_id', sa.Integer(), nullable=False),
    sa.Column('accessory_id', sa.Integer(), nullable=False),
    sa.ForeignKeyConstraint(['accessory_id'], ['accessories.id'], ),
    sa.ForeignKeyConstraint(['equipment_id'], ['equipment.id'], ),
    sa.ForeignKeyConstraint(['reservation_id'], ['reservations.id'], ),
    sa.PrimaryKeyConstraint('reservation_id', 'equipment_id', 'accessory_id')
    )
    op.create_table('reservation_equipment',
    sa.Column('reservation_id', sa.Integer(), nullable=False),
    sa.Column('equipment_id', sa.Integer(), nullable=False),
    sa.ForeignKeyConstraint(['equipment_id'], ['equipment.id'], ),
    sa.ForeignKeyConstraint(['reservation_id'], ['reservations.id'], ),
    sa.PrimaryKeyConstraint('reservation_id', 'equipment_id')
    )
    op.create_table('balance_history',
    sa.Column('id', sa.Integer(), nullable=False),
    sa.Column('user_id', sa.Integer(), nullable=False),
    sa.Column('rental_id', sa.Integer(), nullable=True),
    sa.Column('amount', sa.Float(), nullable=False, comment='–°—É–º–º–∞ –æ–ø–µ—Ä–∞—Ü–∏–∏. –û—Ç—Ä–∏—Ü–∞—Ç–µ–ª—å–Ω–∞—è –¥–ª—è —Å–ø–∏—Å–∞–Ω–∏—è, –ø–æ–ª–æ–∂–∏—Ç–µ–ª—å–Ω–∞—è –¥–ª—è –Ω–∞—á–∏—Å–ª–µ–Ω–∏—è.'),
    sa.Column('operation_type', sa.String(), nullable=False, comment='–¢–∏–ø –æ–ø–µ—Ä–∞—Ü–∏–∏ (e.g., rental_debit, early_return_credit)'),
    sa.Column('description', sa.Text(), nullable=True, comment='–û–ø–∏—Å–∞–Ω–∏–µ –æ–ø–µ—Ä–∞—Ü–∏–∏'),
    sa.Column('created_at', sa.DateTime(timezone=True), nullable=True),
    sa.ForeignKeyConstraint(['rental_id'], ['rentals.id'], ondelete='CASCADE'),
    sa.ForeignKeyConstraint(['user_id'], ['users.id'], ),
    sa.PrimaryKeyConstraint('id')
    )
    op.create_table('payments',
    sa.Column('id', sa.Integer(), nullable=False),
    sa.Column('user_id', sa.Integer(), nullable=False),
    sa.Column('rental_id', sa.Integer(), nullable=True),
    sa.Column('amount', sa.Float(), nullable=False),
    sa.Column('payment_date', sa.DateTime(timezone=True), nullable=True),
    sa.Column('payment_method', sa.String(), nullable=True),
    sa.Column('transaction_type', sa.String(), nullable=False),
    sa.Column('description', sa.Text(), nullable=True),
    sa.ForeignKeyConstraint(['rental_id'], ['rentals.id'], ondelete='CASCADE'),
    sa.ForeignKeyConstraint(['user_id'], ['users.id'], ),
    sa.PrimaryKeyConstraint('id')
    )
    op.create_table('rental_accessories',
    sa.Column('rental_id', sa.Integer(), nullable=False),
    sa.Column('equipment_id', sa.Integer(), nullable=False),
    sa.Column('accessory_id', sa.Integer(), nullable=False),
    sa.ForeignKeyConstraint(['accessory_id'], ['accessories.id'], ),
    sa.ForeignKeyConstraint(['equipment_id'], ['equipment.id'], ),
    sa.ForeignKeyConstraint(['rental_id'], ['rentals.id'], ondelete='CASCADE'),
    sa.PrimaryKeyConstraint('rental_id', 'equipment_id', 'accessory_id')
    )
    op.create_table('rental_equipment',
    sa.Column('rental_id', sa.Integer(), nullable=False),
    sa.Column('equipment_id', sa.Integer(), nullable=False),
    sa.ForeignKeyConstraint(['equipment_id'], ['equipment.id'], ),
    sa.ForeignKeyConstraint(['rental_id'], ['rentals.id'], ondelete='CASCADE'),
    sa.PrimaryKeyConstraint('rental_id', 'equipment_id')
    )
    # ### end Alembic commands ###


def downgrade() -> None:
    """Downgrade schema."""
    # ### commands auto generated by Alembic - please adjust! ###
    op.drop_table('rental_equipment')
    op.drop_table('rental_accessories')
    op.drop_table('payments')
    op.drop_table('balance_history')
    op.drop_table('reservation_equipment')
    op.drop_table('reservation_accessories')
    op.drop_index(op.f('ix_rentals_status'), table_name='rentals')
    op.drop_table('rentals')
    op.drop_index(op.f('ix_reservations_status'), table_name='reservations')
    op.drop_table('reservations')
    op.drop_table('promo_code_usages')
    op.drop_table('promo_code_equipment')
    op.drop_table('promo_code_applicable_types')
    op.drop_index(op.f('ix_holidays_date'), table_name='holidays')
    op.drop_table('holidays')
    op.drop_index(op.f('ix_promo_codes_id'), table_name='promo_codes')
    op.drop_index(op.f('ix_promo_codes_code'), table_name='promo_codes')
    op.drop_table('promo_codes')
    op.drop_table('holiday_rules')
    op.drop_table('equipment_accessories')
    op.drop_table('association_equipment_association')
    op.drop_index(op.f('ix_users_email'), table_name='users')
    op.drop_table('users')
    op.drop_table('equipment')
    op.drop_table('duration_discounts')
    op.drop_index(op.f('ix_associations_name'), table_name='associations')
    op.drop_index(op.f('ix_associations_id'), table_name='associations')
    op.drop_table('associations')
    op.drop_index(op.f('ix_accessories_name'), table_name='accessories')
    op.drop_index(op.f('ix_accessories_id'), table_name='accessories')
    op.drop_index(op.f('ix_accessories_accessory_type'), table_name='accessories')
    op.drop_table('accessories')
    # ### end Alembic commands ###


```


## <a name="RentalAppFASTAPIscriptspopulateassociationspy"></a>`RentalApp_FASTAPI/scripts/populate_associations.py`

```python
// path: RentalApp_FASTAPI/scripts/populate_associations.py

#!/usr/bin/env python3
# -*- coding: utf-8 -*-
"""
–°–∫—Ä–∏–ø—Ç –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –Ω–∞—á–∞–ª—å–Ω—ã—Ö –∞—Å—Å–æ—Ü–∏–∞—Ü–∏–π –≤ –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö.
–ó–∞–ø—É—Å–∫–∞—Ç—å –ø–æ—Å–ª–µ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è –º–∏–≥—Ä–∞—Ü–∏–π.
"""

import sys
import os

# –î–æ–±–∞–≤–ª—è–µ–º –∫–æ—Ä–Ω–µ–≤—É—é –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é –ø—Ä–æ–µ–∫—Ç–∞ –≤ –ø—É—Ç—å
sys.path.append(os.path.dirname(os.path.dirname(os.path.abspath(__file__))))

from sqlalchemy.orm import Session
from api.deps import get_db
from api.models.association import Association
from api.models.equipment import Equipment

def populate_associations():
    """–î–æ–±–∞–≤–ª—è–µ—Ç –Ω–∞—á–∞–ª—å–Ω—ã–µ –∞—Å—Å–æ—Ü–∏–∞—Ü–∏–∏ –≤ –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö."""
    
    # –ü–æ–ª—É—á–∞–µ–º —Å–µ—Å—Å–∏—é –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö
    db: Session = next(get_db())
    
    try:
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ —É–∂–µ –∞—Å—Å–æ—Ü–∏–∞—Ü–∏–∏
        existing_associations = db.query(Association).count()
        if existing_associations > 0:
            print("–ê—Å—Å–æ—Ü–∏–∞—Ü–∏–∏ —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É—é—Ç –≤ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö. –ü—Ä–æ–ø—É—Å–∫–∞–µ–º —Å–æ–∑–¥–∞–Ω–∏–µ.")
            return
        
        # –°–æ–∑–¥–∞–µ–º –Ω–∞—á–∞–ª—å–Ω—ã–µ –∞—Å—Å–æ—Ü–∏–∞—Ü–∏–∏
        associations_data = [
            {
                "name": "–í—Å–µ –¥–ª—è Sony",
                "description": "–û–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏–µ –∏ –∞–∫—Å–µ—Å—Å—É–∞—Ä—ã –¥–ª—è –∫–∞–º–µ—Ä Sony",
                "order_index": 1
            },
            {
                "name": "–í—Å–µ –¥–ª—è Fujifilm", 
                "description": "–û–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏–µ –∏ –∞–∫—Å–µ—Å—Å—É–∞—Ä—ã –¥–ª—è –∫–∞–º–µ—Ä Fujifilm",
                "order_index": 2
            },
            {
                "name": "–î–ª—è —Å—ä–µ–º–∫–∏ –≤–∏–¥–µ–æ",
                "description": "–û–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏–µ –¥–ª—è –≤–∏–¥–µ–æ—Å—ä–µ–º–∫–∏",
                "order_index": 3
            },
            {
                "name": "–î–ª—è —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏–∏",
                "description": "–û–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏–µ –¥–ª—è —Ñ–æ—Ç–æ—Å—ä–µ–º–∫–∏",
                "order_index": 4
            },
            {
                "name": "–°—Ç—É–¥–∏–π–Ω–æ–µ –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏–µ",
                "description": "–û–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏–µ –¥–ª—è —Å—Ç—É–¥–∏–π–Ω–æ–π —Å—ä–µ–º–∫–∏",
                "order_index": 5
            },
            {
                "name": "–ü–æ—Ä—Ç–∞—Ç–∏–≤–Ω–æ–µ –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏–µ",
                "description": "–õ–µ–≥–∫–æ–µ –∏ –ø–æ—Ä—Ç–∞—Ç–∏–≤–Ω–æ–µ –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏–µ",
                "order_index": 6
            }
        ]
        
        # –°–æ–∑–¥–∞–µ–º –∞—Å—Å–æ—Ü–∏–∞—Ü–∏–∏
        for assoc_data in associations_data:
            association = Association(**assoc_data)
            db.add(association)
        
        # –°–æ—Ö—Ä–∞–Ω—è–µ–º –∏–∑–º–µ–Ω–µ–Ω–∏—è
        db.commit()
        
        print(f"–£—Å–ø–µ—à–Ω–æ —Å–æ–∑–¥–∞–Ω–æ {len(associations_data)} –∞—Å—Å–æ—Ü–∏–∞—Ü–∏–π:")
        for assoc_data in associations_data:
            print(f"  - {assoc_data['name']}")
        
        # –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–æ–∑–¥–∞–Ω–Ω—ã–µ –∞—Å—Å–æ—Ü–∏–∞—Ü–∏–∏
        print("\n–°–æ–∑–¥–∞–Ω–Ω—ã–µ –∞—Å—Å–æ—Ü–∏–∞—Ü–∏–∏:")
        associations = db.query(Association).order_by(Association.order_index).all()
        for assoc in associations:
            print(f"  ID: {assoc.id}, –ù–∞–∑–≤–∞–Ω–∏–µ: {assoc.name}, –ü–æ—Ä—è–¥–æ–∫: {assoc.order_index}")
            
    except Exception as e:
        print(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –∞—Å—Å–æ—Ü–∏–∞—Ü–∏–π: {e}")
        db.rollback()
        raise
    finally:
        db.close()

def link_equipment_to_associations():
    """–°–≤—è–∑—ã–≤–∞–µ—Ç —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–µ –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏–µ —Å –∞—Å—Å–æ—Ü–∏–∞—Ü–∏—è–º–∏ –ø–æ –±—Ä–µ–Ω–¥—É."""
    
    db: Session = next(get_db())
    
    try:
        # –ü–æ–ª—É—á–∞–µ–º –≤—Å–µ –∞—Å—Å–æ—Ü–∏–∞—Ü–∏–∏
        associations = db.query(Association).all()
        associations_dict = {assoc.name: assoc for assoc in associations}
        
        # –ü–æ–ª—É—á–∞–µ–º –≤—Å–µ –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏–µ
        equipment = db.query(Equipment).all()
        
        linked_count = 0
        
        for eq in equipment:
            # –°–≤—è–∑—ã–≤–∞–µ–º –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏–µ —Å –∞—Å—Å–æ—Ü–∏–∞—Ü–∏—è–º–∏ –ø–æ –±—Ä–µ–Ω–¥—É
            if eq.brand.lower() == "sony" and "–í—Å–µ –¥–ª—è Sony" in associations_dict:
                associations_dict["–í—Å–µ –¥–ª—è Sony"].equipment_items.append(eq)
                linked_count += 1
            elif eq.brand.lower() == "fujifilm" and "–í—Å–µ –¥–ª—è Fujifilm" in associations_dict:
                associations_dict["–í—Å–µ –¥–ª—è Fujifilm"].equipment_items.append(eq)
                linked_count += 1
            
            # –°–≤—è–∑—ã–≤–∞–µ–º –ø–æ —Ç–∏–ø—É –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—è
            if "–≤–∏–¥–µ–æ" in eq.equipment_type.lower() or "–≤–∏–¥–µ–æ" in eq.name.lower():
                if "–î–ª—è —Å—ä–µ–º–∫–∏ –≤–∏–¥–µ–æ" in associations_dict:
                    associations_dict["–î–ª—è —Å—ä–µ–º–∫–∏ –≤–∏–¥–µ–æ"].equipment_items.append(eq)
                    linked_count += 1
            
            if "—Ñ–æ—Ç–æ" in eq.equipment_type.lower() or "—Ñ–æ—Ç–æ" in eq.name.lower():
                if "–î–ª—è —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏–∏" in associations_dict:
                    associations_dict["–î–ª—è —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏–∏"].equipment_items.append(eq)
                    linked_count += 1
        
        db.commit()
        print(f"–°–≤—è–∑–∞–Ω–æ {linked_count} –µ–¥–∏–Ω–∏—Ü –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—è —Å –∞—Å—Å–æ—Ü–∏–∞—Ü–∏—è–º–∏")
        
    except Exception as e:
        print(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–≤—è–∑—ã–≤–∞–Ω–∏–∏ –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—è: {e}")
        db.rollback()
        raise
    finally:
        db.close()

if __name__ == "__main__":
    print("–°–æ–∑–¥–∞–Ω–∏–µ –Ω–∞—á–∞–ª—å–Ω—ã—Ö –∞—Å—Å–æ—Ü–∏–∞—Ü–∏–π...")
    populate_associations()
    
    print("\n–°–≤—è–∑—ã–≤–∞–Ω–∏–µ –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—è —Å –∞—Å—Å–æ—Ü–∏–∞—Ü–∏—è–º–∏...")
    link_equipment_to_associations()
    
    print("\n–ì–æ—Ç–æ–≤–æ!")


```


## <a name="RentalAppFASTAPIscriptspopulatediscountspy"></a>`RentalApp_FASTAPI/scripts/populate_discounts.py`

```python
// path: RentalApp_FASTAPI/scripts/populate_discounts.py

# scripts/populate_discounts.py

import sys
import os
from sqlalchemy import create_engine
from sqlalchemy.orm import sessionmaker

# –î–æ–±–∞–≤–ª—è–µ–º –∫–æ—Ä–Ω–µ–≤—É—é –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é –ø—Ä–æ–µ–∫—Ç–∞ –≤ sys.path, —á—Ç–æ–±—ã –Ω–∞–π—Ç–∏ –¥—Ä—É–≥–∏–µ –º–æ–¥—É–ª–∏
sys.path.append(os.path.abspath(os.path.join(os.path.dirname(__file__), '..')))

# ‚ú® –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï: –ò–º–ø–æ—Ä—Ç–∏—Ä—É–µ–º DATABASE_URL –∏–∑ –ø—Ä–∞–≤–∏–ª—å–Ω–æ–≥–æ –º–µ—Å—Ç–∞
from config.secrets import DATABASE_URL
from api.models.discount import DurationDiscount

# –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ –ë–î, –∏—Å–ø–æ–ª—å–∑—É—è –∏–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω–Ω—É—é —Å—Ç—Ä–æ–∫—É
engine = create_engine(DATABASE_URL)
SessionLocal = sessionmaker(autocommit=False, autoflush=False, bind=engine)

def populate_duration_discounts():
    db = SessionLocal()
    try:
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ —É–∂–µ –∑–∞–ø–∏—Å–∏
        if db.query(DurationDiscount).count() > 0:
            print("–¢–∞–±–ª–∏—Ü–∞ 'duration_discounts' —É–∂–µ –∑–∞–ø–æ–ª–Ω–µ–Ω–∞. –ü—Ä–æ–ø—É—Å–∫–∞–µ–º.")
            return

        discounts = [
            {'min_days': 4, 'discount_percentage': 10},  # –û—Ç 4 –¥–æ 6 –¥–Ω–µ–π
            {'min_days': 7, 'discount_percentage': 15},  # –û—Ç 7 –¥–æ 9 –¥–Ω–µ–π
            {'min_days': 10, 'discount_percentage': 20}, # –û—Ç 10 –¥–æ 13 –¥–Ω–µ–π
            {'min_days': 14, 'discount_percentage': 25}  # –û—Ç 14 –¥–Ω–µ–π –∏ –±–æ–ª–µ–µ
        ]

        for discount_data in discounts:
            db_discount = DurationDiscount(**discount_data)
            db.add(db_discount)

        db.commit()
        print("‚úÖ –¢–∞–±–ª–∏—Ü–∞ 'duration_discounts' —É—Å–ø–µ—à–Ω–æ –∑–∞–ø–æ–ª–Ω–µ–Ω–∞.")

    except Exception as e:
        print(f"‚ùå –ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞: {e}")
        db.rollback()
    finally:
        db.close()

if __name__ == "__main__":
    populate_duration_discounts()

```


## <a name="RentalAppFASTAPIscriptsrecalculatebalancespy"></a>`RentalApp_FASTAPI/scripts/recalculate_balances.py`

```python
// path: RentalApp_FASTAPI/scripts/recalculate_balances.py

# scripts/recalculate_balances.py

import sys
import os
from sqlalchemy import func
from sqlalchemy.orm import Session

# –î–æ–±–∞–≤–ª—è–µ–º –∫–æ—Ä–Ω–µ–≤—É—é –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é –ø—Ä–æ–µ–∫—Ç–∞ –≤ sys.path,
# —á—Ç–æ–±—ã –º–æ–∂–Ω–æ –±—ã–ª–æ –∏–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å –º–æ–¥—É–ª–∏ –∏–∑ `api`
sys.path.insert(0, os.path.abspath(os.path.join(os.path.dirname(__file__), '..')))

from api.database import SessionLocal
from api.models.user import User
from api.models.balance_history import BalanceHistory

def recalculate_all_balances():
    """
    –ü–µ—Ä–µ—Å—á–∏—Ç—ã–≤–∞–µ—Ç –∏ –æ–±–Ω–æ–≤–ª—è–µ—Ç –±–∞–ª–∞–Ω—Å –¥–ª—è –≤—Å–µ—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –Ω–∞ –æ—Å–Ω–æ–≤–µ –∏—Ö –∏—Å—Ç–æ—Ä–∏–∏ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π.
    """
    print("üöÄ –ó–∞–ø—É—Å–∫ —Å–∫—Ä–∏–ø—Ç–∞ –¥–ª—è –ø–µ—Ä–µ—Å—á–µ—Ç–∞ –±–∞–ª–∞–Ω—Å–æ–≤...")
    db: Session = SessionLocal()
    try:
        users = db.query(User).all()
        if not users:
            print("–í –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö –Ω–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π. –ó–∞–≤–µ—Ä—à–µ–Ω–∏–µ.")
            return

        updated_count = 0
        print(f"–ù–∞–π–¥–µ–Ω–æ {len(users)} –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏.")

        for user in users:
            # –°—É–º–º–∏—Ä—É–µ–º –≤—Å–µ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏–∑ —Ç–∞–±–ª–∏—Ü—ã balance_history
            correct_balance_query = db.query(func.sum(BalanceHistory.amount)).filter(BalanceHistory.user_id == user.id)
            correct_balance = correct_balance_query.scalar() or 0.0
            correct_balance = round(correct_balance, 2)

            # –°—Ä–∞–≤–Ω–∏–≤–∞–µ–º —Ç–µ–∫—É—â–∏–π (–≤–æ–∑–º–æ–∂–Ω–æ, –Ω–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π) –±–∞–ª–∞–Ω—Å —Å –ø—Ä–∞–≤–∏–ª—å–Ω—ã–º
            if user.balance != correct_balance:
                print(f"  - –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å ID {user.id} ({user.email}):")
                print(f"    –ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π –±–∞–ª–∞–Ω—Å: {user.balance:.2f} ‚ÇΩ")
                print(f"    –ü—Ä–∞–≤–∏–ª—å–Ω—ã–π –±–∞–ª–∞–Ω—Å:   {correct_balance:.2f} ‚ÇΩ. –û–±–Ω–æ–≤–ª—è–µ–º...")
                user.balance = correct_balance
                updated_count += 1

        if updated_count > 0:
            print(f"\n–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –∏–∑–º–µ–Ω–µ–Ω–∏–π –¥–ª—è {updated_count} –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π...")
            db.commit()
            print("‚úÖ –ò–∑–º–µ–Ω–µ–Ω–∏—è —É—Å–ø–µ—à–Ω–æ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã.")
        else:
            print("\n–í—Å–µ –±–∞–ª–∞–Ω—Å—ã –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π —É–∂–µ –±—ã–ª–∏ –≤ –∞–∫—Ç—É–∞–ª—å–Ω–æ–º —Å–æ—Å—Ç–æ—è–Ω–∏–∏. –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –Ω–µ —Ç—Ä–µ–±—É–µ—Ç—Å—è.")

    except Exception as e:
        db.rollback()
        print(f"\n‚ùå –ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞: {e}")
        print("–í—Å–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è –±—ã–ª–∏ –æ—Ç–º–µ–Ω–µ–Ω—ã.")
    finally:
        db.close()
        print("\nüèÅ –°–∫—Ä–∏–ø—Ç –∑–∞–≤–µ—Ä—à–∏–ª —Ä–∞–±–æ—Ç—É.")

if __name__ == "__main__":
    # –≠—Ç–æ—Ç –±–ª–æ–∫ –ø–æ–∑–≤–æ–ª—è–µ—Ç –∑–∞–ø—É—Å–∫–∞—Ç—å —Å–∫—Ä–∏–ø—Ç –Ω–∞–ø—Ä—è–º—É—é –∏–∑ –∫–æ–º–∞–Ω–¥–Ω–æ–π —Å—Ç—Ä–æ–∫–∏
    recalculate_all_balances()

```


## <a name="RentalAppFASTAPIsharedschemasaccessoryschemapy"></a>`RentalApp_FASTAPI/shared/schemas/accessory_schema.py`

```python
// path: RentalApp_FASTAPI/shared/schemas/accessory_schema.py

# shared/schemas/accessory_schema.py

from pydantic import BaseModel, ConfigDict
from typing import Optional, List

class AccessoryBase(BaseModel):
    name: str
    accessory_type: Optional[str] = "–ü—Ä–æ—á–µ–µ"
    price: Optional[float] = 0.0
    description: Optional[str] = None

class AccessoryCreate(AccessoryBase):
    pass

class AccessoryUpdate(AccessoryBase):
    pass

class AccessoryOut(AccessoryBase):
    id: int
    model_config = ConfigDict(from_attributes=True)


class AccessoryListResponse(BaseModel):
    items: List[AccessoryOut]
    total: int

```


## <a name="RentalAppFASTAPIsharedschemasassociationschemapy"></a>`RentalApp_FASTAPI/shared/schemas/association_schema.py`

```python
// path: RentalApp_FASTAPI/shared/schemas/association_schema.py

# shared/schemas/association_schema.py

from pydantic import BaseModel, ConfigDict, Field
from typing import Optional, List

# –ë–∞–∑–æ–≤–∞—è —Å—Ö–µ–º–∞ —Å –æ–±—â–∏–º–∏ –ø–æ–ª—è–º–∏
class AssociationBase(BaseModel):
    name: str = Field(..., min_length=3, max_length=100, description="–ù–∞–∑–≤–∞–Ω–∏–µ –∞—Å—Å–æ—Ü–∏–∞—Ü–∏–∏")
    description: Optional[str] = Field(None, description="–í–Ω—É—Ç—Ä–µ–Ω–Ω–µ–µ –æ–ø–∏—Å–∞–Ω–∏–µ")
    sort_order: int = Field(0, description="–ò–Ω–¥–µ–∫—Å –¥–ª—è —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∏")

# –°—Ö–µ–º–∞ –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –Ω–æ–≤–æ–π –∞—Å—Å–æ—Ü–∏–∞—Ü–∏–∏
class AssociationCreate(AssociationBase):
    equipment_ids: List[int] = Field([], description="–°–ø–∏—Å–æ–∫ ID —Å–≤—è–∑–∞–Ω–Ω–æ–≥–æ –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—è")

# –°—Ö–µ–º–∞ –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–π –∞—Å—Å–æ—Ü–∏–∞—Ü–∏–∏
class AssociationUpdate(BaseModel):
    name: Optional[str] = Field(None, min_length=3, max_length=100)
    description: Optional[str] = None
    sort_order: Optional[int] = None
    equipment_ids: Optional[List[int]] = None

# –°—Ö–µ–º–∞ –¥–ª—è –≤—ã–≤–æ–¥–∞ –¥–∞–Ω–Ω—ã—Ö –∏–∑ API.
# –°–∞–º–æ–µ –≤–∞–∂–Ω–æ–µ: –æ–Ω–∞ –≤–∫–ª—é—á–∞–µ—Ç `equipment_ids` –¥–ª—è —Ä–∞–±–æ—Ç—ã —Ñ–∏–ª—å—Ç—Ä–∞ –Ω–∞ —Ñ—Ä–æ–Ω—Ç–µ–Ω–¥–µ.
class AssociationOut(AssociationBase):
    id: int
    equipment_ids: List[int]

    model_config = ConfigDict(from_attributes=True)

# +++ –í–û–°–°–¢–ê–ù–û–í–ò–¢–¨ –≠–¢–û–¢ –ö–õ–ê–°–° +++
# –≠—Ç–∞ —Å—Ö–µ–º–∞ –Ω—É–∂–Ω–∞ –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ–± –∞—Å—Å–æ—Ü–∏–∞—Ü–∏–∏ –≤–Ω—É—Ç—Ä–∏ —Å—Ö–µ–º—ã –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—è.
class AssociationSimple(BaseModel):
    id: int
    name: str

    model_config = ConfigDict(from_attributes=True)


class AssociationListResponse(BaseModel):
    items: List[AssociationOut]
    total: int


```


## <a name="RentalAppFASTAPIsharedschemasbalancehistoryschemapy"></a>`RentalApp_FASTAPI/shared/schemas/balance_history_schema.py`

```python
// path: RentalApp_FASTAPI/shared/schemas/balance_history_schema.py

# src/shared/schemas/balance_history_schema.py (–ù–û–í–´–ô –§–ê–ô–õ)

from pydantic import BaseModel, ConfigDict
from datetime import datetime
from typing import List, Optional

class BalanceHistoryBase(BaseModel):
    amount: float
    operation_type: str
    description: Optional[str] = None
    created_at: datetime
    rental_id: Optional[int] = None

class BalanceHistoryOut(BalanceHistoryBase):
    id: int
    user_id: int

    model_config = ConfigDict(from_attributes=True)

class BalanceHistoryListResponse(BaseModel):
    items: List[BalanceHistoryOut]
    total: int

```


## <a name="RentalAppFASTAPIsharedschemascalendarschemapy"></a>`RentalApp_FASTAPI/shared/schemas/calendar_schema.py`

```python
// path: RentalApp_FASTAPI/shared/schemas/calendar_schema.py

# shared/schemas/calendar_schema.py

from datetime import date
from typing import Optional, Dict, Union, List
from pydantic import BaseModel, ConfigDict # ‚ùóÔ∏è –ò–º–ø–æ—Ä—Ç–∏—Ä—É–µ–º ConfigDict


class EquipmentStatusResponse(BaseModel):
    equipment_id: int
    status: str
    details: str
    name: str | None = None
    equipment_type: str | None = None
    brand: str | None = None
    start_date: Optional[date] = None
    end_date: Optional[date] = None

    # ‚ùóÔ∏è –ò–ó–ú–ï–ù–ï–ù–ò–ï: Config –∑–∞–º–µ–Ω–µ–Ω –Ω–∞ model_config, orm_mode –Ω–∞ from_attributes
    model_config = ConfigDict(from_attributes=True)


class DayStatusItem(BaseModel):
    status: str
    group_id: Optional[str] = None
    is_user_reservation: bool = False


class EquipmentDayStatusesResponse(BaseModel):
    equipment_day_statuses: Dict[int, Dict[str, Union[str, DayStatusItem]]]


class CalendarEventResponse(BaseModel):
    id: str
    title: str
    start: str
    end: str
    resourceId: int
    status: str


class EquipmentStatusListResponse(BaseModel):
    items: List[EquipmentStatusResponse]
    total: int


class CalendarEventListResponse(BaseModel):
    items: List[CalendarEventResponse]
    total: int

```


## <a name="RentalAppFASTAPIsharedschemascommonfinancialspy"></a>`RentalApp_FASTAPI/shared/schemas/common_financials.py`

```python
// path: RentalApp_FASTAPI/shared/schemas/common_financials.py

# shared/schemas/common_financials.py

from pydantic import BaseModel
from typing import Optional


class FinancialsBase(BaseModel):
    """
    –ë–∞–∑–æ–≤–∞—è —Å—Ö–µ–º–∞ –¥–ª—è —Ñ–∏–Ω–∞–Ω—Å–æ–≤—ã—Ö –¥–∞–Ω–Ω—ã—Ö, –æ–±—â–∏—Ö –¥–ª—è –∞—Ä–µ–Ω–¥ –∏ —Ä–µ–∑–µ—Ä–≤–æ–≤.
    –°–æ–¥–µ—Ä–∂–∏—Ç —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–µ –ø–æ–ª—è –¥–ª—è —Å—Ç–æ–∏–º–æ—Å—Ç–∏, —Å–∫–∏–¥–æ–∫ –∏ –ø—Ä–æ–º–æ–∫–æ–¥–æ–≤.
    """
    total_cost: float
    discount_amount: float = 0.0
    promo_code: Optional[str] = None
    final_cost: Optional[float] = None
    accessories_cost: float = 0.0
    remaining_amount: float = 0.0


```


## <a name="RentalAppFASTAPIsharedschemasdashboardschemapy"></a>`RentalApp_FASTAPI/shared/schemas/dashboard_schema.py`

```python
// path: RentalApp_FASTAPI/shared/schemas/dashboard_schema.py

# shared/schemas/dashboard_schema.py
from pydantic import BaseModel, ConfigDict, field_validator
from datetime import datetime, date
from typing import List, Optional

# –≠–ª–µ–º–µ–Ω—Ç –¥–ª—è –≤–∏–¥–∂–µ—Ç–∞ "–°–µ–≥–æ–¥–Ω—è –≤ —Ñ–æ–∫—É—Å–µ"
class TodayFocusItem(BaseModel):
    id: int  # –ò–∑–º–µ–Ω–µ–Ω–æ —Å order_id –¥–ª—è –∫–æ–Ω—Å–∏—Å—Ç–µ–Ω—Ç–Ω–æ—Å—Ç–∏ —Å —Ñ—Ä–æ–Ω—Ç–µ–Ω–¥–æ–º
    user_name: str
    details: str  # –ù–∞–ø—Ä–∏–º–µ—Ä, "3 –ø–æ–∑–∏—Ü–∏–∏" –∏–ª–∏ "–û—Å—Ç–∞—Ç–æ–∫: 1500 ‚ÇΩ"
    user_id: int
    order_type: str # 'reservation' –∏–ª–∏ 'rental'
    scheduled_time: datetime  # –í—Ä–µ–º—è –≤—ã–¥–∞—á–∏ –∏–ª–∏ –≤–æ–∑–≤—Ä–∞—Ç–∞
    start_date: Optional[date] = None  # –î–∞—Ç–∞ –Ω–∞—á–∞–ª–∞ —Ä–µ–∑–µ—Ä–≤–∞
    # –ü–æ–ª—è –¥–ª—è –ø—Ä–æ—Å—Ä–æ—á–µ–Ω–Ω—ã—Ö –∞—Ä–µ–Ω–¥
    due_date: Optional[date] = None  # –î–∞—Ç–∞ –æ–∫–æ–Ω—á–∞–Ω–∏—è –∞—Ä–µ–Ω–¥—ã
    days_overdue: Optional[int] = None  # –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –¥–Ω–µ–π –ø—Ä–æ—Å—Ä–æ—á–∫–∏

# –≠–ª–µ–º–µ–Ω—Ç –¥–ª—è –≤–∏–¥–∂–µ—Ç–∞ "–ü–æ—Å–ª–µ–¥–Ω–∏–µ —Å–æ–±—ã—Ç–∏—è"
class ActivityFeedItem(BaseModel):
    id: int  # –î–æ–±–∞–≤–ª–µ–Ω–æ –¥–ª—è –∫–æ–Ω—Å–∏—Å—Ç–µ–Ω—Ç–Ω–æ—Å—Ç–∏ —Å —Ñ—Ä–æ–Ω—Ç–µ–Ω–¥–æ–º
    timestamp: datetime
    activity_type: str  # "new_reservation", "new_user", "rental_return"
    description: str
    user_name: Optional[str] = None  # –ò–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –¥–ª—è –æ–±–æ–≥–∞—â–µ–Ω–∏—è –ª–µ–Ω—Ç—ã —Å–æ–±—ã—Ç–∏–π
    equipment_name: Optional[str] = None  # –ù–∞–∑–≤–∞–Ω–∏–µ –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—è –¥–ª—è –æ–±–æ–≥–∞—â–µ–Ω–∏—è –ª–µ–Ω—Ç—ã —Å–æ–±—ã—Ç–∏–π

# –≠–ª–µ–º–µ–Ω—Ç –¥–ª—è –≥—Ä–∞—Ñ–∏–∫–∞ "–ü–æ–ø—É–ª—è—Ä–Ω–æ–µ –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏–µ"
class PopularEquipmentItem(BaseModel):
    equipment_id: int  # ID –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—è –¥–ª—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –≤ –∫–∞—á–µ—Å—Ç–≤–µ key –Ω–∞ —Ñ—Ä–æ–Ω—Ç–µ–Ω–¥–µ
    equipment_name: str
    rental_count: int  # –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –∞—Ä–µ–Ω–¥
    revenue: float  # –í—ã—Ä—É—á–∫–∞ –æ—Ç –∞—Ä–µ–Ω–¥—ã –¥–∞–Ω–Ω–æ–≥–æ –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—è

# –í–ª–æ–∂–µ–Ω–Ω–∞—è –º–æ–¥–µ–ª—å –¥–ª—è –≤—Å–µ—Ö KPI –ø–æ–∫–∞–∑–∞—Ç–µ–ª–µ–π
class KpiData(BaseModel):
    total_users: int  # –û–±—â–µ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
    active_users: int  # –ê–∫—Ç–∏–≤–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏
    total_equipment: int  # –û–±—â–µ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—è
    total_reservations: int  # –û–±—â–µ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ä–µ–∑–µ—Ä–≤–∞—Ü–∏–π
    revenue_today: float  # –î–æ—Ö–æ–¥ –∑–∞ —Å–µ–≥–æ–¥–Ω—è
    revenue_this_month: float  # –î–æ—Ö–æ–¥ –∑–∞ —Ç–µ–∫—É—â–∏–π –º–µ—Å—è—Ü
    occupancy_rate: float  # –ö–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç –∑–∞–≥—Ä—É–∂–µ–Ω–Ω–æ—Å—Ç–∏
    avg_rental_duration: float  # –°—Ä–µ–¥–Ω—è—è –ø—Ä–æ–¥–æ–ª–∂–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å –∞—Ä–µ–Ω–¥—ã

# –û—Å–Ω–æ–≤–Ω–∞—è —Å—Ö–µ–º–∞ –æ—Ç–≤–µ—Ç–∞
class DashboardSummaryResponse(BaseModel):
    # –í–∏–¥–∂–µ—Ç "–°–µ–≥–æ–¥–Ω—è –≤ —Ñ–æ–∫—É—Å–µ"
    pickups_today: List[TodayFocusItem]
    returns_today: List[TodayFocusItem]
    overdue_rentals: List[TodayFocusItem]

    # –í–∏–¥–∂–µ—Ç "–ö–ª—é—á–µ–≤—ã–µ –ø–æ–∫–∞–∑–∞—Ç–µ–ª–∏" - —Ç–µ–ø–µ—Ä—å –≤–ª–æ–∂–µ–Ω–Ω–∞—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∞
    kpi: KpiData

    # –í–∏–¥–∂–µ—Ç "–ü–æ—Å–ª–µ–¥–Ω–∏–µ —Å–æ–±—ã—Ç–∏—è"
    recent_activity: List[ActivityFeedItem]

    # –í–∏–¥–∂–µ—Ç "–ü–æ–ø—É–ª—è—Ä–Ω–æ–µ –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏–µ"
    popular_equipment: List[PopularEquipmentItem]

    model_config = ConfigDict(from_attributes=True)


```


## <a name="RentalAppFASTAPIsharedschemasdiscountschemapy"></a>`RentalApp_FASTAPI/shared/schemas/discount_schema.py`

```python
// path: RentalApp_FASTAPI/shared/schemas/discount_schema.py

# shared/schemas/discount_schema.py

from pydantic import BaseModel, ConfigDict, Field
from typing import List

class DiscountBase(BaseModel):
    min_days: int = Field(..., gt=0, description="–ú–∏–Ω–∏–º–∞–ª—å–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –¥–Ω–µ–π –¥–ª—è –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è —Å–∫–∏–¥–∫–∏")
    discount_percentage: int = Field(..., gt=0, le=100, description="–ü—Ä–æ—Ü–µ–Ω—Ç —Å–∫–∏–¥–∫–∏")

class DiscountCreate(DiscountBase):
    pass

class DiscountUpdate(DiscountBase):
    pass

class DiscountOut(DiscountBase):
    id: int

    model_config = ConfigDict(from_attributes=True)


class DiscountListResponse(BaseModel):
    items: List[DiscountOut]
    total: int

```


## <a name="RentalAppFASTAPIsharedschemasequipmentschemapy"></a>`RentalApp_FASTAPI/shared/schemas/equipment_schema.py`

```python
// path: RentalApp_FASTAPI/shared/schemas/equipment_schema.py

# shared/schemas/equipment_schema.py

from __future__ import annotations
from pydantic import BaseModel, ConfigDict, field_validator
from typing import Optional, List
from datetime import date, datetime # ‚úÖ –ò–ó–ú–ï–ù–ï–ù–ò–ï: –∏–º–ø–æ—Ä—Ç–∏—Ä—É–µ–º date –≤–º–µ—Å—Ç–æ datetime
# ‚úÖ –î–û–ë–ê–í–õ–ï–ù –ò–ú–ü–û–†–¢
from .accessory_schema import AccessoryOut
from .association_schema import AssociationSimple


class EquipmentCreate(BaseModel):
    equipment_type: str
    brand: str
    name: str
    serial_number: Optional[str] = None
    condition: Optional[str] = "–í–µ–ª–∏–∫–æ–ª–µ–ø–Ω–æ"
    daily_rate: Optional[float] = 0.0
    notes: Optional[str] = None
    description: Optional[str] = None
    # ‚úÖ –ò–ó–ú–ï–ù–ï–ù–ò–ï: –¢–∏–ø –ø–æ–ª—è –∏–∑–º–µ–Ω–µ–Ω —Å datetime –Ω–∞ date
    last_maintenance: Optional[date] = None
    image_url: Optional[str] = None
    image_urls: Optional[List[str]] = None
    short_description: Optional[str] = None


class EquipmentOut(BaseModel):
    id: int
    equipment_type: str
    brand: str
    name: str
    serial_number: Optional[str] = None
    condition: str
    daily_rate: float
    notes: Optional[str] = None
    description: Optional[str] = None
    # ‚úÖ –ò–ó–ú–ï–ù–ï–ù–ò–ï: –¢–∏–ø –ø–æ–ª—è –∏–∑–º–µ–Ω–µ–Ω —Å datetime –Ω–∞ date
    last_maintenance: Optional[date] = None
    image_url: Optional[str] = None
    image_urls: Optional[List[str]] = None
    short_description: Optional[str] = None
    # ‚úÖ –î–û–ë–ê–í–õ–ï–ù–û –ü–û–õ–ï –î–õ–Ø –û–¢–û–ë–†–ê–ñ–ï–ù–ò–Ø –ü–†–ò–í–Ø–ó–ê–ù–ù–´–• –ê–ö–°–ï–°–°–£–ê–†–û–í
    accessories: List[AccessoryOut] = []
    # ‚úÖ –î–û–ë–ê–í–õ–ï–ù–û –ü–û–õ–ï –î–õ–Ø –û–¢–û–ë–†–ê–ñ–ï–ù–ò–Ø –ü–†–ò–í–Ø–ó–ê–ù–ù–´–• –ê–°–°–û–¶–ò–ê–¶–ò–ô
    associations: List[AssociationSimple] = []

    @field_validator('last_maintenance', mode='before')
    @classmethod
    def validate_last_maintenance(cls, v):
        """–í–∞–ª–∏–¥–∞—Ç–æ—Ä –¥–ª—è –ø–æ–ª—è last_maintenance - –æ–±–µ—Å–ø–µ—á–∏–≤–∞–µ—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç –¥–∞—Ç—ã."""
        if v is None:
            return None
        if isinstance(v, str):
            try:
                # –ü—ã—Ç–∞–µ–º—Å—è –ø—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞—Ç—å —Å—Ç—Ä–æ–∫—É –≤ –¥–∞—Ç—É
                return datetime.fromisoformat(v.replace('Z', '+00:00')).date()
            except (ValueError, AttributeError):
                # –ï—Å–ª–∏ –Ω–µ —É–¥–∞–µ—Ç—Å—è –ø—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞—Ç—å, –≤–æ–∑–≤—Ä–∞—â–∞–µ–º None
                return None
        if isinstance(v, datetime):
            return v.date()
        return v

    model_config = ConfigDict(from_attributes=True)


class EquipmentUpdateExtended(BaseModel):
    equipment_type: Optional[str] = None
    brand: Optional[str] = None
    name: Optional[str] = None
    serial_number: Optional[str] = None
    condition: Optional[str] = None
    daily_rate: Optional[float] = None
    notes: Optional[str] = None
    description: Optional[str] = None
    # ‚úÖ –≠—Ç–æ –ø–æ–ª–µ —É–∂–µ –±—ã–ª–æ –ø—Ä–∞–≤–∏–ª—å–Ω—ã–º (date), –æ—Å—Ç–∞–≤–ª—è–µ–º –∫–∞–∫ –µ—Å—Ç—å
    last_maintenance: Optional[date] = None
    image_url: Optional[str] = None
    image_urls: Optional[List[str]] = None
    short_description: Optional[str] = None
    # ‚úÖ –î–û–ë–ê–í–õ–ï–ù–û –ü–û–õ–ï –î–õ–Ø –ü–ï–†–ï–î–ê–ß–ò ID –ê–ö–°–ï–°–°–£–ê–†–û–í –ü–†–ò –û–ë–ù–û–í–õ–ï–ù–ò–ò
    accessory_ids: Optional[List[int]] = None
    # ‚úÖ –î–û–ë–ê–í–õ–ï–ù–û –ü–û–õ–ï –î–õ–Ø –ü–ï–†–ï–î–ê–ß–ò ID –ê–°–°–û–¶–ò–ê–¶–ò–ô –ü–†–ò –û–ë–ù–û–í–õ–ï–ù–ò–ò
    association_ids: Optional[List[int]] = None

    model_config = ConfigDict(from_attributes=True)


class EquipmentTreeItem(BaseModel):
    label: str
    value: Optional[int] = None
    children: List[EquipmentTreeItem] = []
    model_config = ConfigDict(from_attributes=True)


class EquipmentAvailabilityStatus(BaseModel):
    has_active_reservations: bool
    has_active_rentals: bool
    active_reservations_count: int
    active_rentals_count: int
    model_config = ConfigDict(from_attributes=True)


class EquipmentListResponse(BaseModel):
    items: List[EquipmentOut]
    total: int


class EquipmentTreeListResponse(BaseModel):
    items: List[EquipmentTreeItem]
    total: int

```


## <a name="RentalAppFASTAPIsharedschemasholidayschemapy"></a>`RentalApp_FASTAPI/shared/schemas/holiday_schema.py`

```python
// path: RentalApp_FASTAPI/shared/schemas/holiday_schema.py

# shared/schemas/holiday_schema.py

from pydantic import BaseModel, ConfigDict, Field
from datetime import date, datetime
from typing import Literal, List

class HolidayBase(BaseModel):
    """–ë–∞–∑–æ–≤–∞—è —Å—Ö–µ–º–∞ –¥–ª—è –≤—ã—Ö–æ–¥–Ω–æ–≥–æ –¥–Ω—è."""
    date: date
    description: str | None = None

class HolidayCreate(HolidayBase):
    """–°—Ö–µ–º–∞ –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –Ω–æ–≤–æ–≥–æ –≤—ã—Ö–æ–¥–Ω–æ–≥–æ –¥–Ω—è."""
    force: bool = False

class HolidayOut(HolidayBase):
    """–°—Ö–µ–º–∞ –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö –æ –≤—ã—Ö–æ–¥–Ω–æ–º –¥–Ω–µ –∏–∑ –ë–î."""
    created_at: datetime
    created_by_id: int

    model_config = ConfigDict(from_attributes=True)

# +++ –ù–ê–ß–ê–õ–û: –ù–û–í–´–ï –°–•–ï–ú–´ +++
class RecurringHolidayRuleCreate(BaseModel):
    """–°—Ö–µ–º–∞ –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –ø—Ä–∞–≤–∏–ª–∞ –µ–∂–µ–Ω–µ–¥–µ–ª—å–Ω—ã—Ö –≤—ã—Ö–æ–¥–Ω—ã—Ö."""
    day_of_week: int = Field(..., ge=0, le=6, description="–î–µ–Ω—å –Ω–µ–¥–µ–ª–∏ (0=–ü–æ–Ω–µ–¥–µ–ª—å–Ω–∏–∫, 6=–í–æ—Å–∫—Ä–µ—Å–µ–Ω—å–µ)")
    start_date: date
    end_date: date
    description: str

class HolidayRuleOut(BaseModel):
    """–°—Ö–µ–º–∞ –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –ø—Ä–∞–≤–∏–ª –≤ –∞–¥–º–∏–Ω–∫–µ."""
    id: int
    rule_type: str
    description: str
    created_at: datetime

    model_config = ConfigDict(from_attributes=True)


class HolidayListResponse(BaseModel):
    items: List[HolidayOut]
    total: int


class HolidayRuleListResponse(BaseModel):
    items: List[HolidayRuleOut]
    total: int
# +++ –ö–û–ù–ï–¶: –ù–û–í–´–ï –°–•–ï–ú–´ +++

```


## <a name="RentalAppFASTAPIsharedschemaspromocodeschemapy"></a>`RentalApp_FASTAPI/shared/schemas/promo_code_schema.py`

```python
// path: RentalApp_FASTAPI/shared/schemas/promo_code_schema.py

# shared/schemas/promo_code_schema.py
from pydantic import BaseModel, ConfigDict, Field, EmailStr
from typing import Optional, List
from datetime import datetime

# --- –°—Ö–µ–º—ã –¥–ª—è –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω–∏—è ---

class PromoCodeBase(BaseModel):
    code: str = Field(..., description="–£–Ω–∏–∫–∞–ª—å–Ω—ã–π –∫–æ–¥, –Ω–∞–ø—Ä–∏–º–µ—Ä, 'SUMMER20'", max_length=50)
    description: Optional[str] = Field(None, description="–û–ø–∏—Å–∞–Ω–∏–µ –¥–ª—è –≤–Ω—É—Ç—Ä–µ–Ω–Ω–µ–≥–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è")
    discount_percentage: float = Field(..., gt=0, le=50, description="–ü—Ä–æ—Ü–µ–Ω—Ç —Å–∫–∏–¥–∫–∏ (1-50)")
    is_active: bool = True
    valid_from: Optional[datetime] = None
    expires_at: Optional[datetime] = None
    max_uses: Optional[int] = Field(None, gt=0, description="–û–±—â–∏–π –ª–∏–º–∏—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–π")
    max_uses_per_user: Optional[int] = Field(None, gt=0, description="–õ–∏–º–∏—Ç –Ω–∞ –æ–¥–Ω–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è")
    min_order_amount: Optional[float] = Field(None, gt=0, description="–ú–∏–Ω–∏–º–∞–ª—å–Ω–∞—è —Å—É–º–º–∞ –∑–∞–∫–∞–∑–∞")
    specific_to_user_id: Optional[int] = None
    applicable_to_equipment_ids: Optional[List[int]] = None
    applicable_to_equipment_types: Optional[List[str]] = None

class PromoCodeCreate(PromoCodeBase):
    pass

class PromoCodeUpdate(BaseModel):
    code: Optional[str] = Field(None, max_length=50)
    description: Optional[str] = None
    discount_percentage: Optional[float] = Field(None, gt=0, le=50)
    is_active: Optional[bool] = None
    valid_from: Optional[datetime] = None
    expires_at: Optional[datetime] = None
    max_uses: Optional[int] = Field(None, gt=0)
    max_uses_per_user: Optional[int] = Field(None, gt=0)
    min_order_amount: Optional[float] = Field(None, gt=0)
    specific_to_user_id: Optional[int] = None
    applicable_to_equipment_ids: Optional[List[int]] = None
    applicable_to_equipment_types: Optional[List[str]] = None

class PromoCodeOut(PromoCodeBase):
    id: int
    times_used: int
    created_at: datetime
    created_by_id: int
    creator_email: Optional[EmailStr] = None # –î–ª—è —É–¥–æ–±—Å—Ç–≤–∞ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –≤ –∞–¥–º–∏–Ω–∫–µ

    model_config = ConfigDict(from_attributes=True)

    @classmethod
    def from_orm(cls, obj):
        # –î–æ–±–∞–≤–ª—è–µ–º email —Å–æ–∑–¥–∞—Ç–µ–ª—è –¥–ª—è –≤—ã–≤–æ–¥–∞
        instance = super().from_orm(obj)
        if obj.creator:
            instance.creator_email = obj.creator.email
        return instance

# --- –°—Ö–µ–º—ã –¥–ª—è –ø—É–±–ª–∏—á–Ω–æ–π –≤–∞–ª–∏–¥–∞—Ü–∏–∏ ---

class PromoCodeValidateRequest(BaseModel):
    code: str
    # –≠—Ç–∏ –ø–æ–ª—è –Ω—É–∂–Ω—ã –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ —É—Å–ª–æ–≤–∏–π –ø—Ä–æ–º–æ–∫–æ–¥–∞
    order_amount: float
    equipment_ids: List[int]

class PromoCodeValidateResponse(BaseModel):
    code: str
    discount_percentage: float
    message: str


class PromoCodeListResponse(BaseModel):
    items: List[PromoCodeOut]
    total: int

```


## <a name="RentalAppFASTAPIsharedschemasrentalschemapy"></a>`RentalApp_FASTAPI/shared/schemas/rental_schema.py`

```python
// path: RentalApp_FASTAPI/shared/schemas/rental_schema.py

# shared/schemas/rental_schema.py

from pydantic import BaseModel, ConfigDict, Field, field_validator
from datetime import date, datetime
from typing import List, Optional

from .user_schema import UserOut
from .equipment_schema import EquipmentOut
from .accessory_schema import AccessoryOut
from .common_financials import FinancialsBase

class RentalBase(BaseModel):
    start_date: date
    end_date: date
    deposit_amount: float = 0.0
    notes_on_issue: Optional[str] = None
    status: str

class RentalAccessoryDetail(BaseModel):
    equipment_id: int
    accessory: AccessoryOut
    model_config = ConfigDict(from_attributes=True)

class RentalOut(RentalBase, FinancialsBase):
    id: int
    user_id: int
    created_by_id: int
    reservation_id: Optional[int] = None
    actual_return_date: Optional[date] = None
    prepayment_amount: float = 0.0
    notes_on_return: Optional[str] = None
    created_at: datetime
    updated_at: datetime
    user: UserOut
    created_by: UserOut
    equipment: List[EquipmentOut]

    # –ò—Å–ø–æ–ª—å–∑—É–µ–º –∏–º—è –ø–æ–ª—è 'accessory_links' –∫–∞–∫ –≤ –º–æ–¥–µ–ª–∏ SQLAlchemy
    # —á—Ç–æ–±—ã –∏–∑–±–µ–∂–∞—Ç—å –Ω–µ—Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–π –ø—Ä–∏ –ø–µ—Ä–µ–¥–∞—á–µ –¥–∞–Ω–Ω—ã—Ö.
    accessory_links: List[RentalAccessoryDetail] = []

    # –î–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ –≤—ã—á–∏—Å–ª—è–µ–º—ã–µ –ø–æ–ª—è
    days_remaining: Optional[int] = None
    overdue_days: Optional[int] = None
    overdue_surcharge: Optional[float] = None

    # –£–±–∏—Ä–∞–µ–º populate_by_name, —Ç–∞–∫ –∫–∞–∫ alias –±–æ–ª—å—à–µ –Ω–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è
    model_config = ConfigDict(from_attributes=True)

    @field_validator('start_date', 'end_date', 'actual_return_date', mode='before')
    @classmethod
    def convert_datetime_to_date(cls, v):
        if isinstance(v, datetime):
            return v.date()
        return v

class RentalListResponse(BaseModel):
    items: List[RentalOut]
    total: int

# --- –°—Ö–µ–º—ã –¥–ª—è –∑–∞–ø—Ä–æ—Å–æ–≤ ---

class RentalCreateFromReservationRequest(BaseModel):
    """–°—Ö–µ–º–∞ –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –∞—Ä–µ–Ω–¥—ã –∏–∑ —Ä–µ–∑–µ—Ä–≤–∞."""
    notes_on_issue: Optional[str] = None
    deposit_amount: float = Field(0.0, ge=0)
    prepayment_amount: float = Field(0.0, ge=0)
    force_issue_on_holiday: bool = Field(False, description="–ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –≤—ã–¥–∞—á–∏ –≤ –≤—ã—Ö–æ–¥–Ω–æ–π –¥–µ–Ω—å")

class RentalCreateFromScratchRequest(BaseModel):
    """–°—Ö–µ–º–∞ –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –∞—Ä–µ–Ω–¥—ã "—Å –Ω—É–ª—è"."""
    user_id: int
    equipment_ids: List[int] = Field(..., min_length=1)
    start_date: date
    end_date: date
    notes_on_issue: Optional[str] = None
    deposit_amount: float = Field(0.0, ge=0)

class AdminRentalUpdate(BaseModel):
    """–°—Ö–µ–º–∞ –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –∞—Ä–µ–Ω–¥—ã –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–º."""
    end_date: Optional[date] = None
    actual_return_date: Optional[date] = None
    status: Optional[str] = None
    final_cost: Optional[float] = Field(None, ge=0)
    deposit_amount: Optional[float] = Field(None, ge=0)
    notes_on_issue: Optional[str] = None
    notes_on_return: Optional[str] = None

class RentalReturnRequest(BaseModel):
    """–°—Ö–µ–º–∞ –¥–ª—è –æ—Ñ–æ—Ä–º–ª–µ–Ω–∏—è –≤–æ–∑–≤—Ä–∞—Ç–∞."""
    actual_return_date: date
    notes_on_return: Optional[str] = None
    accessories_returned_confirmation: bool = Field(..., description="–ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ, —á—Ç–æ –≤—Å–µ –∞–∫—Å–µ—Å—Å—É–∞—Ä—ã –≤–æ–∑–≤—Ä–∞—â–µ–Ω—ã")
    # –£–¥–∞–ª—è–µ–º –ø–æ–ª—è payment_amount –∏ payment_description, —Ç–∞–∫ –∫–∞–∫ –ø–ª–∞—Ç–µ–∂ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç—Å—è –æ—Ç–¥–µ–ª—å–Ω–æ

    @classmethod
    def today(cls):
        return cls(actual_return_date=date.today())

```


## <a name="RentalAppFASTAPIsharedschemasreservationschemapy"></a>`RentalApp_FASTAPI/shared/schemas/reservation_schema.py`

```python
// path: RentalApp_FASTAPI/shared/schemas/reservation_schema.py

# shared/schemas/reservation_schema.py

from pydantic import BaseModel, ConfigDict, Field
from datetime import date
from typing import List, Optional, Dict, Literal

from .user_schema import UserOut
from .accessory_schema import AccessoryOut
from .common_financials import FinancialsBase


class ReservationAccessoryDetail(BaseModel):
    equipment_id: int
    accessory: AccessoryOut
    model_config = ConfigDict(from_attributes=True)


class ReservationCreateRequest(BaseModel):
    equipment_ids: List[int]
    start_date: date
    end_date: date
    selected_accessories: Optional[Dict[int, List[int]]] = None
    promo_code: Optional[str] = None

class ReservationUpdateRequest(BaseModel):
    equipment_ids: List[int]
    start_date: date
    end_date: date
    selected_accessories: Optional[Dict[int, List[int]]] = None
    promo_code: Optional[str] = None
    confirm_date_adjustment: bool = False

class ReservationResponse(BaseModel):
    reservation_id: int
    message: str
    model_config = ConfigDict(from_attributes=True)

class ReservationItem(FinancialsBase):
    id: int
    user_id: int
    equipment_ids: List[int]
    start_date: date
    end_date: date
    status: Literal['active', 'fulfilled', 'cancelled', 'overdue']
    accessory_links: List[ReservationAccessoryDetail] = []
    rental_id: Optional[int] = Field(None, validation_alias='rental.id')

    model_config = ConfigDict(from_attributes=True)


class AdminReservationOut(ReservationItem):
    user_info: UserOut
    model_config = ConfigDict(from_attributes=True)

class AdminReservationCreateRequest(ReservationCreateRequest):
    user_id: int

class AdminReservationListResponse(BaseModel):
    items: List[AdminReservationOut]
    total: int

class ReservationListResponse(BaseModel):
    items: List[ReservationItem]
    total: int

class PriceCalculationRequest(BaseModel):
    equipment_ids: List[int]
    start_date: date
    end_date: date
    selected_accessories: Optional[Dict[int, List[int]]] = None
    promo_code: Optional[str] = None

class PriceCalculationResponse(BaseModel):
    day_count: int
    full_total: float
    final_total: float
    discount_amount: float
    duration_discount_percentage: int
    promo_discount_percentage: float
    promo_code_message: Optional[str] = None

class ReservationBulkDeleteRequest(BaseModel):
    """–°—Ö–µ–º–∞ –¥–ª—è –∑–∞–ø—Ä–æ—Å–∞ –Ω–∞ –º–∞—Å—Å–æ–≤–æ–µ —É–¥–∞–ª–µ–Ω–∏–µ —Ä–µ–∑–µ—Ä–≤–æ–≤."""
    reservation_ids: List[int]

```


## <a name="RentalAppFASTAPIsharedschemasuserschemapy"></a>`RentalApp_FASTAPI/shared/schemas/user_schema.py`

```python
// path: RentalApp_FASTAPI/shared/schemas/user_schema.py

# shared/schemas/user_schema.py

from pydantic import BaseModel, EmailStr, ConfigDict, validator, field_validator, Field
from typing import Optional, List, Annotated
import re
from datetime import datetime

# –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –≤–∞–ª–∏–¥–∞—Ü–∏–∏, –æ—Å—Ç–∞–µ—Ç—Å—è –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π
def validate_phone_number(v: Optional[str]) -> Optional[str]:
    """–í–∞–ª–∏–¥–∞—Ü–∏—è –Ω–æ–º–µ—Ä–∞ —Ç–µ–ª–µ—Ñ–æ–Ω–∞"""
    if v is None:
        return v
    if not isinstance(v, str):
        raise ValueError('–¢–µ–ª–µ—Ñ–æ–Ω –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å —Å—Ç—Ä–æ–∫–æ–π')

    phone_clean = re.sub(r'[^\d]', '', v)
    if len(phone_clean) < 10 or len(phone_clean) > 15:
        raise ValueError('–ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç —Ç–µ–ª–µ—Ñ–æ–Ω–∞')

    return v

# --- –°—É—â–µ—Å—Ç–≤—É—é—â–∏–µ —Å—Ö–µ–º—ã ---

class UserCreate(BaseModel):
    full_name: str
    email: EmailStr
    password: str
    phone: Optional[str] = None
    privacy_policy_accepted: bool = False
    terms_accepted: bool = False

    @field_validator('phone')
    @classmethod
    def validate_phone(cls, v):
        return validate_phone_number(v)

    @validator('privacy_policy_accepted')
    def validate_privacy_policy(cls, v):
        if not v:
            raise ValueError('–ù–µ–æ–±—Ö–æ–¥–∏–º–æ —Å–æ–≥–ª–∞—Å–∏–µ —Å –ø–æ–ª–∏—Ç–∏–∫–æ–π –æ–±—Ä–∞–±–æ—Ç–∫–∏ –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö')
        return v

    @validator('terms_accepted')
    def validate_terms(cls, v):
        if not v:
            raise ValueError('–ù–µ–æ–±—Ö–æ–¥–∏–º–æ —Å–æ–≥–ª–∞—Å–∏–µ —Å —É—Å–ª–æ–≤–∏—è–º–∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è')
        return v

class AdminUserCreate(UserCreate):
    role: str = "user"

class AdminUserUpdate(BaseModel):
    full_name: Optional[str] = None
    phone: Optional[str] = None
    status: Optional[str] = None
    balance: Optional[float] = None
    notes: Optional[str] = None
    role: Optional[str] = None
    privacy_policy_accepted: Optional[bool] = None
    terms_accepted: Optional[bool] = None
    email_verified: Optional[bool] = None

    @field_validator('phone')
    @classmethod
    def validate_phone(cls, v):
        return validate_phone_number(v)

class UserUpdate(BaseModel):
    full_name: Optional[str] = None
    email: Optional[EmailStr] = None
    phone: Optional[str] = None

    @field_validator('phone')
    @classmethod
    def validate_phone(cls, v):
        return validate_phone_number(v)


class UserOut(BaseModel):
    id: int
    full_name: str
    email: EmailStr
    role: str
    is_active: bool
    phone: Optional[str] = None
    status: Optional[str] = None
    balance: float
    notes: Optional[str] = None
    privacy_policy_accepted: bool
    terms_accepted: bool
    email_verified: bool
    created_at: datetime

    model_config = ConfigDict(from_attributes=True)


class Token(BaseModel):
    access_token: str
    token_type: str


class UserListResponse(BaseModel):
    items: List[UserOut]
    total: int

# +++ –ù–ê–ß–ê–õ–û: –ù–û–í–ê–Ø –°–•–ï–ú–ê –î–õ–Ø –ü–†–ò–ï–ú–ê –ü–õ–ê–¢–ï–ñ–ê +++
class UserPaymentRequest(BaseModel):
    amount: float = Field(..., gt=0, description="–°—É–º–º–∞ –ø–ª–∞—Ç–µ–∂–∞")
    payment_method: str = Field(..., description="–ú–µ—Ç–æ–¥ –æ–ø–ª–∞—Ç—ã (–Ω–∞–ª–∏—á–Ω—ã–µ, –∫–∞—Ä—Ç–∞ –∏ —Ç.–¥.)")
    description: Optional[str] = None
# +++ –ö–û–ù–ï–¶: –ù–û–í–ê–Ø –°–•–ï–ú–ê –î–õ–Ø –ü–†–ò–ï–ú–ê –ü–õ–ê–¢–ï–ñ–ê +++

```


## <a name="RentalAppFASTAPIsmartpythoncodeFastAPImd"></a>`RentalApp_FASTAPI/smart_python_code_FastAPI.md`

```markdown
// path: RentalApp_FASTAPI/smart_python_code_FastAPI.md

# –°–∂–∞—Ç—ã–π –∏—Å—Ö–æ–¥–Ω—ã–π –∫–æ–¥ –ø—Ä–æ–µ–∫—Ç–∞ –¥–ª—è AI-–ø–æ–º–æ—â–Ω–∏–∫–∞

# –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –ø—Ä–æ–µ–∫—Ç–∞

- ‚úÖ `api\accessory_api.py`
- ‚úÖ `api\admin_dashboard_api.py`
- ‚úÖ `api\admin_rental_api.py`
- ‚úÖ `api\admin_reservation_api.py`
- ‚úÖ `api\association_api.py`
- ‚úÖ `api\auth_api.py`
- ‚úÖ `api\calendar_api.py`
- ‚úÖ `api\database.py`
- ‚úÖ `api\deps.py`
- ‚úÖ `api\discount_api.py`
- ‚úÖ `api\equipment_api.py`
- ‚úÖ `api\holiday_api.py`
- ‚úÖ `api\init_models.py`
- ‚úÖ `api\main_api.py`
- ‚úÖ `api\models\accessory.py`
- ‚úÖ `api\models\association.py`
- ‚úÖ `api\models\balance_history.py`
- ‚úÖ `api\models\discount.py`
- ‚úÖ `api\models\equipment.py`
- ‚úÖ `api\models\holiday.py`
- ‚úÖ `api\models\payment.py`
- ‚úÖ `api\models\promo_code.py`
- ‚úÖ `api\models\rental.py`
- ‚úÖ `api\models\reservation.py`
- ‚úÖ `api\models\user.py`
- ‚úÖ `api\permissions.py`
- ‚úÖ `api\promo_code_api.py`
- ‚úÖ `api\reservation_api.py`
- ‚úÖ `api\router.py`
- ‚úÖ `api\services\auth_service.py`
- ‚úÖ `api\services\availability\availability_service.py`
- ‚úÖ `api\services\availability\base.py`
- ‚úÖ `api\services\availability\calendar.py`
- ‚úÖ `api\services\availability\conflicts.py`
- ‚úÖ `api\services\availability\queries.py`
- ‚úÖ `api\services\availability\statuses.py`
- ‚úÖ `api\services\balance_service.py`
- ‚úÖ `api\services\dashboard\activity_service.py`
- ‚úÖ `api\services\dashboard\base.py`
- ‚úÖ `api\services\dashboard\dashboard_service.py`
- ‚úÖ `api\services\dashboard\equipment_service.py`
- ‚úÖ `api\services\dashboard\focus_service.py`
- ‚úÖ `api\services\dashboard\kpi_service.py`
- ‚úÖ `api\services\dashboard_service.py`
- ‚úÖ `api\services\discount_service.py`
- ‚úÖ `api\services\equipment_query_builder.py`
- ‚úÖ `api\services\equipment_service_api.py`
- ‚úÖ `api\services\financial_service.py`
- ‚úÖ `api\services\order\order_lifecycle_service.py`
- ‚úÖ `api\services\order\order_query_base.py`
- ‚úÖ `api\services\order\order_repository.py`
- ‚úÖ `api\services\order\order_validator.py`
- ‚úÖ `api\services\promo_code\constants.py`
- ‚úÖ `api\services\promo_code\exceptions.py`
- ‚úÖ `api\services\promo_code\factory.py`
- ‚úÖ `api\services\promo_code\interfaces.py`
- ‚úÖ `api\services\promo_code\promo_code_business_logic.py`
- ‚úÖ `api\services\promo_code\promo_code_manager.py`
- ‚úÖ `api\services\promo_code\promo_code_validator.py`
- ‚úÖ `api\services\promo_code_service.py`
- ‚úÖ `api\services\rental\rental_query_service.py`
- ‚úÖ `api\services\reservation_query_service.py`
- ‚úÖ `api\services\user_service.py`
- ‚úÖ `api\user_api.py`
- ‚úÖ `db\init_db.py`
- ‚úÖ `requirements.txt`
- ‚úÖ `shared\schemas\accessory_schema.py`
- ‚úÖ `shared\schemas\association_schema.py`
- ‚úÖ `shared\schemas\balance_history_schema.py`
- ‚úÖ `shared\schemas\calendar_schema.py`
- ‚úÖ `shared\schemas\common_financials.py`
- ‚úÖ `shared\schemas\dashboard_schema.py`
- ‚úÖ `shared\schemas\discount_schema.py`
- ‚úÖ `shared\schemas\equipment_schema.py`
- ‚úÖ `shared\schemas\holiday_schema.py`
- ‚úÖ `shared\schemas\promo_code_schema.py`
- ‚úÖ `shared\schemas\rental_schema.py`
- ‚úÖ `shared\schemas\reservation_schema.py`
- ‚úÖ `shared\schemas\user_schema.py`

---


## `api\accessory_api.py`


```python

# api/accessory_api.py

from fastapi import APIRouter, Depends, HTTPException, Query
from sqlalchemy.ext.asyncio import AsyncSession
from sqlalchemy import select, func, or_
from typing import List

from api.deps import get_db
from api.models.user import User
from api.models.accessory import Accessory
from api.models.reservation import ReservationAccessory, Reservation
from api.models.rental import RentalAccessory, Rental
from api.permissions import require_manager
from shared.schemas.accessory_schema import AccessoryCreate, AccessoryUpdate, AccessoryOut, AccessoryListResponse
from fastapi_csrf_protect import CsrfProtect

router = APIRouter(prefix="/accessories", tags=["–ê–∫—Å–µ—Å—Å—É–∞—Ä—ã"])

@router.post("/", response_model=AccessoryOut, status_code=201)
async def create_accessory(
        accessory_in: AccessoryCreate,
        db: AsyncSession = Depends(get_db),
        current_user: User = Depends(require_manager),
        csrf_protect: CsrfProtect = Depends()
):
    """–°–æ–∑–¥–∞—Ç—å –Ω–æ–≤—ã–π –∞–∫—Å–µ—Å—Å—É–∞—Ä (—Ç–æ–ª—å–∫–æ –¥–ª—è –º–µ–Ω–µ–¥–∂–µ—Ä–æ–≤/–∞–¥–º–∏–Ω–æ–≤)"""
    new_accessory = Accessory(**accessory_in.model_dump())
    db.add(new_accessory)
    await db.commit()
    
    # –í–æ–∑–≤—Ä–∞—â–∞–µ–º —Å–æ–∑–¥–∞–Ω–Ω—ã–π –æ–±—ä–µ–∫—Ç –±–µ–∑ –ø–æ–≤—Ç–æ—Ä–Ω–æ–≥–æ –∑–∞–ø—Ä–æ—Å–∞ –∫ –ë–î
    return new_accessory

@router.get("/", response_model=AccessoryListResponse)
async def get_all_accessories(
        db: AsyncSession = Depends(get_db),
        skip: int = Query(0, ge=0, description="–°–∫–æ–ª—å–∫–æ –∑–∞–ø–∏—Å–µ–π –ø—Ä–æ–ø—É—Å—Ç–∏—Ç—å"),
        limit: int = Query(10, ge=1, le=500, description="–ú–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∑–∞–ø–∏—Å–µ–π –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–µ")
):
    """–ü–æ–ª—É—á–∏—Ç—å —Å–ø–∏—Å–æ–∫ –≤—Å–µ—Ö –∞–∫—Å–µ—Å—Å—É–∞—Ä–æ–≤ —Å –ø–∞–≥–∏–Ω–∞—Ü–∏–µ–π"""
    # 1. –ó–∞–ø—Ä–æ—Å –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –æ–±—â–µ–≥–æ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ –∞–∫—Å–µ—Å—Å—É–∞—Ä–æ–≤
    total_result = await db.execute(select(func.count(Accessory.id)))
    total_accessories = total_result.scalar_one()

    # 2. –ó–∞–ø—Ä–æ—Å –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è "—Å—Ç—Ä–∞–Ω–∏—Ü—ã" –∞–∫—Å–µ—Å—Å—É–∞—Ä–æ–≤
    accessories_result = await db.execute(
        select(Accessory).order_by(Accessory.name).offset(skip).limit(limit)
    )
    accessories_orm = accessories_result.scalars().all()

    # 3. –§–æ—Ä–º–∏—Ä—É–µ–º –∏ –≤–æ–∑–≤—Ä–∞—â–∞–µ–º –Ω–æ–≤—ã–π –æ–±—ä–µ–∫—Ç –æ—Ç–≤–µ—Ç–∞
    return AccessoryListResponse(
        items=[AccessoryOut.from_orm(accessory) for accessory in accessories_orm],
        total=total_accessories
    )

@router.get("/{accessory_id}", response_model=AccessoryOut)
async def get_accessory_by_id(accessory_id: int, db: AsyncSession = Depends(get_db)):
    """–ü–æ–ª—É—á–∏—Ç—å –∞–∫—Å–µ—Å—Å—É–∞—Ä –ø–æ ID"""
    result = await db.execute(select(Accessory).filter(Accessory.id == accessory_id))
    accessory = result.scalars().first()
    if not accessory:
        raise HTTPException(status_code=404, detail="–ê–∫—Å–µ—Å—Å—É–∞—Ä –Ω–µ –Ω–∞–π–¥–µ–Ω")
    return accessory

@router.put("/{accessory_id}", response_model=AccessoryOut)
async def update_accessory(
        accessory_id: int,
        accessory_in: AccessoryUpdate,
        db: AsyncSession = Depends(get_db),
        current_user: User = Depends(require_manager),
        csrf_protect: CsrfProtect = Depends()
):
    """–û–±–Ω–æ–≤–∏—Ç—å –∞–∫—Å–µ—Å—Å—É–∞—Ä (—Ç–æ–ª—å–∫–æ –¥–ª—è –º–µ–Ω–µ–¥–∂–µ—Ä–æ–≤/–∞–¥–º–∏–Ω–æ–≤)"""
    result = await db.execute(select(Accessory).filter(Accessory.id == accessory_id))
    accessory = result.scalars().first()
    if not accessory:
        raise HTTPException(status_code=404, detail="–ê–∫—Å–µ—Å—Å—É–∞—Ä –Ω–µ –Ω–∞–π–¥–µ–Ω")

    update_data = accessory_in.model_dump(exclude_unset=True)
    for key, value in update_data.items():
        setattr(accessory, key, value)

    await db.commit()
    
    # –í–æ–∑–≤—Ä–∞—â–∞–µ–º –æ–±–Ω–æ–≤–ª–µ–Ω–Ω—ã–π –æ–±—ä–µ–∫—Ç –±–µ–∑ –ø–æ–≤—Ç–æ—Ä–Ω–æ–≥–æ –∑–∞–ø—Ä–æ—Å–∞ –∫ –ë–î
    return accessory

@router.delete("/{accessory_id}", status_code=204)
async def delete_accessory(
        accessory_id: int,
        db: AsyncSession = Depends(get_db),
        current_user: User = Depends(require_manager),
        csrf_protect: CsrfProtect = Depends()
):
    """–£–¥–∞–ª–∏—Ç—å –∞–∫—Å–µ—Å—Å—É–∞—Ä (—Ç–æ–ª—å–∫–æ –¥–ª—è –º–µ–Ω–µ–¥–∂–µ—Ä–æ–≤/–∞–¥–º–∏–Ω–æ–≤)"""
    result = await db.execute(select(Accessory).filter(Accessory.id == accessory_id))
    accessory = result.scalars().first()
    if not accessory:
        raise HTTPException(status_code=404, detail="–ê–∫—Å–µ—Å—Å—É–∞—Ä –Ω–µ –Ω–∞–π–¥–µ–Ω")

    # –ü—Ä–æ–≤–µ—Ä—è–µ–º –∞–∫—Ç–∏–≤–Ω—ã–µ —Ä–µ–∑–µ—Ä–≤—ã
    active_reservations_query = (
        select(func.count(Reservation.id))
        .join(ReservationAccessory, Reservation.id == ReservationAccessory.reservation_id)
        .where(ReservationAccessory.accessory_id == accessory_id)
        .where(Reservation.status == 'active')
    )
    active_reservations_count = (await db.execute(active_reservations_query)).scalar_one()

    # –ü—Ä–æ–≤–µ—Ä—è–µ–º –∞–∫—Ç–∏–≤–Ω—ã–µ –∞—Ä–µ–Ω–¥—ã
    active_rentals_query = (
        select(func.count(Rental.id))
        .join(RentalAccessory, Rental.id == RentalAccessory.rental_id)
        .where(RentalAccessory.accessory_id == accessory_id)
        .where(or_(Rental.status == 'active', Rental.status == 'overdue'))
    )
    active_rentals_count = (await db.execute(active_rentals_query)).scalar_one()

    if active_reservations_count > 0 or active_rentals_count > 0:
        error_detail = (
            f"–ù–µ–≤–æ–∑–º–æ–∂–Ω–æ —É–¥–∞–ª–∏—Ç—å –∞–∫—Å–µ—Å—Å—É–∞—Ä. –û–Ω –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –≤ "
            f"{active_reservations_count} –∞–∫—Ç–∏–≤–Ω—ã—Ö —Ä–µ–∑–µ—Ä–≤–∞—Ö –∏ "
            f"{active_rentals_count} –∞–∫—Ç–∏–≤–Ω—ã—Ö –∞—Ä–µ–Ω–¥–∞—Ö."
        )
        raise HTTPException(status_code=409, detail=error_detail)

    await db.delete(accessory)
    await db.commit()
    return None

```



## `api\admin_dashboard_api.py`


```python

# api/admin_dashboard_api.py

from fastapi import APIRouter, Depends
from sqlalchemy.ext.asyncio import AsyncSession

from api.deps import get_dashboard_service
from api.permissions import require_manager
from api.models.user import User
from api.services.dashboard_service import DashboardService
from shared.schemas.dashboard_schema import DashboardSummaryResponse

router = APIRouter(prefix="/admin", tags=["admin-dashboard"])

@router.get("/dashboard-summary", response_model=DashboardSummaryResponse)
async def get_dashboard_summary(
    current_user: User = Depends(require_manager),
    dashboard_service: DashboardService = Depends(get_dashboard_service)
) -> DashboardSummaryResponse:
    """
    –ü–æ–ª—É—á–∞–µ—Ç —Å–≤–æ–¥–Ω—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –¥–ª—è –ø–∞–Ω–µ–ª–∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –∞–¥–º–∏–Ω–∫–∏.
    
    –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç –∞–≥—Ä–µ–≥–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –≤–∫–ª—é—á–∞—è:
    - –ó–∞–¥–∞—á–∏ –Ω–∞ —Å–µ–≥–æ–¥–Ω—è (–≤—ã–¥–∞—á–∏, –≤–æ–∑–≤—Ä–∞—Ç—ã, –ø—Ä–æ—Å—Ä–æ—á–∫–∏)
    - –ö–ª—é—á–µ–≤—ã–µ –ø–æ–∫–∞–∑–∞—Ç–µ–ª–∏ (–¥–æ—Ö–æ–¥, –Ω–æ–≤—ã–µ –∞—Ä–µ–Ω–¥—ã, –∫–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è, –Ω–æ–≤—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏)
    - –ü–æ—Å–ª–µ–¥–Ω–∏–µ —Å–æ–±—ã—Ç–∏—è –≤ —Å–∏—Å—Ç–µ–º–µ
    - –ü–æ–ø—É–ª—è—Ä–Ω–æ–µ –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏–µ
    """
    return await dashboard_service.get_summary()

```



## `api\admin_rental_api.py`


```python

# api/admin_rental_api.py

from fastapi import APIRouter, Depends, Query, Response, status

from api.deps import get_order_lifecycle_service, get_rental_query_service
from api.permissions import require_manager, require_admin
from api.models.user import User
from api.services.rental.rental_query_service import RentalQueryService
from api.services.order.order_lifecycle_service import OrderLifecycleService
from shared.schemas.rental_schema import (
    RentalOut, RentalListResponse, RentalCreateFromReservationRequest,
    RentalReturnRequest, RentalCreateFromScratchRequest,
    AdminRentalUpdate
)

router = APIRouter(prefix="/admin/rentals", tags=["–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω–∏–µ –ê—Ä–µ–Ω–¥"])


@router.get("/", response_model=RentalListResponse)
async def get_all_rentals(
        current_user: User = Depends(require_manager),
        query_service: RentalQueryService = Depends(get_rental_query_service),
        status: str = Query(None, description="–§–∏–ª—å—Ç—Ä –ø–æ —Å—Ç–∞—Ç—É—Å—É: active, overdue, completed"),
        search: str = Query(None, description="–ü–æ–∏—Å–∫ –ø–æ –∏–º–µ–Ω–∏ –∏–ª–∏ email –∫–ª–∏–µ–Ω—Ç–∞"),
        skip: int = Query(0, ge=0),
        limit: int = Query(10, ge=1, le=100)
):
    """–ü–æ–ª—É—á–∏—Ç—å —Å–ø–∏—Å–æ–∫ –≤—Å–µ—Ö –∞—Ä–µ–Ω–¥ —Å —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–µ–π –∏ –ø–∞–≥–∏–Ω–∞—Ü–∏–µ–π."""
    rentals_out, total = await query_service.get_paginated_rentals(skip, limit, status, search)
    return RentalListResponse(
        items=rentals_out,
        total=total
    )


@router.post("/", response_model=RentalOut)
async def create_rental_from_scratch(
        request: RentalCreateFromScratchRequest,
        current_user: User = Depends(require_manager),
        service: OrderLifecycleService = Depends(get_order_lifecycle_service)
):
    """–°–æ–∑–¥–∞—Ç—å –Ω–æ–≤—É—é –∞—Ä–µ–Ω–¥—É –±–µ–∑ –ø—Ä–µ–¥–≤–∞—Ä–∏—Ç–µ–ª—å–Ω–æ–≥–æ —Ä–µ–∑–µ—Ä–≤–∞."""
    new_rental_orm = await service.create_rental_from_scratch(request, current_user)
    return RentalOut.model_validate(new_rental_orm)


@router.put("/{rental_id}", response_model=RentalOut)
async def update_rental_details(
        rental_id: int,
        request: AdminRentalUpdate,
        current_user: User = Depends(require_manager),
        service: OrderLifecycleService = Depends(get_order_lifecycle_service)
):
    """–û–±–Ω–æ–≤–∏—Ç—å –¥–µ—Ç–∞–ª–∏ —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–π –∞—Ä–µ–Ω–¥—ã."""
    updated_rental_orm = await service.update_rental_details_by_admin(rental_id, request, current_user)
    return RentalOut.model_validate(updated_rental_orm)


@router.post("/from-reservation/{reservation_id}", response_model=RentalOut)
async def convert_reservation_to_rental(
        reservation_id: int,
        request: RentalCreateFromReservationRequest,
        current_user: User = Depends(require_manager),
        service: OrderLifecycleService = Depends(get_order_lifecycle_service)
):
    """–ö–æ–Ω–≤–µ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å —Ä–µ–∑–µ—Ä–≤ –≤ –∞—Ä–µ–Ω–¥—É."""
    new_rental_orm = await service.convert_reservation_to_rental(reservation_id, request, current_user)
    return RentalOut.model_validate(new_rental_orm)


@router.post("/{rental_id}/return", response_model=RentalOut)
async def return_rental(
        rental_id: int,
        request: RentalReturnRequest,
        current_user: User = Depends(require_manager),
        service: OrderLifecycleService = Depends(get_order_lifecycle_service)
):
    """–û—Ñ–æ—Ä–º–∏—Ç—å –≤–æ–∑–≤—Ä–∞—Ç –∞—Ä–µ–Ω–¥—ã."""
    returned_rental_orm = await service.return_rental(rental_id, request, current_user)
    return RentalOut.model_validate(returned_rental_orm)


@router.post("/{rental_id}/revert-to-reservation", status_code=status.HTTP_204_NO_CONTENT)
async def revert_rental_to_reservation(
        rental_id: int,
        current_user: User = Depends(require_manager),
        service: OrderLifecycleService = Depends(get_order_lifecycle_service)
):
    """
    –û—Ç–º–µ–Ω–∏—Ç—å –≤—ã–¥–∞—á—É –∞—Ä–µ–Ω–¥—ã –∏ –≤–µ—Ä–Ω—É—Ç—å –µ–µ –≤ —Å—Ç–∞—Ç—É—Å —Ä–µ–∑–µ—Ä–≤–∞.
    –î–æ—Å—Ç—É–ø–Ω–æ —Ç–æ–ª—å–∫–æ –≤ –¥–µ–Ω—å —Å–æ–∑–¥–∞–Ω–∏—è –∞—Ä–µ–Ω–¥—ã.
    """
    await service.revert_rental_to_reservation(rental_id, current_user)
    return Response(status_code=status.HTTP_204_NO_CONTENT)


@router.delete("/{rental_id}", status_code=204)
async def delete_rental_by_admin(
        rental_id: int,
        current_user: User = Depends(require_admin),
        service: OrderLifecycleService = Depends(get_order_lifecycle_service)
):
    """–£–¥–∞–ª–∏—Ç—å –∞—Ä–µ–Ω–¥—É (—Ç–æ–ª—å–∫–æ –¥–ª—è –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–≤)."""
    await service.delete_rental_by_admin(rental_id)
    return None

```



## `api\admin_reservation_api.py`


```python

# api/admin_reservation_api.py

from fastapi import APIRouter, Depends, Query, HTTPException, Response, status, Body
import logging

from api.deps import get_order_lifecycle_service, get_reservation_query_service
from api.permissions import require_manager
from api.models.user import User
from api.services.order.order_lifecycle_service import OrderLifecycleService
# <-- –ò–ó–ú–ï–ù–ï–ù–ò–ï –ó–î–ï–°–¨: –ò–º–ø–æ—Ä—Ç–∏—Ä—É–µ–º –Ω–æ–≤—ã–π –µ–¥–∏–Ω—ã–π —Å–µ—Ä–≤–∏—Å –¥–ª—è —á—Ç–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö
from api.services.reservation_query_service import ReservationQueryService
# ----------------------------------------------------------------------
from shared.schemas.reservation_schema import (
    AdminReservationCreateRequest,
    ReservationResponse,
    ReservationUpdateRequest,
    AdminReservationListResponse,
    ReservationBulkDeleteRequest
)
from fastapi_csrf_protect import CsrfProtect

router = APIRouter(prefix="/admin/reservations", tags=["–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω–∏–µ –†–µ–∑–µ—Ä–≤–æ–≤"])
logger = logging.getLogger(__name__)


@router.post("/delete-many", status_code=status.HTTP_204_NO_CONTENT)
async def delete_multiple_reservations(
        request: ReservationBulkDeleteRequest = Body(...),
        _current_user: User = Depends(require_manager),
        _csrf_protect: CsrfProtect = Depends(),
        service: OrderLifecycleService = Depends(get_order_lifecycle_service)
):
    """–ú–∞—Å—Å–æ–≤–æ —É–¥–∞–ª–∏—Ç—å —Ä–µ–∑–µ—Ä–≤—ã –ø–æ –∏—Ö ID."""
    try:
        await service.bulk_cancel_admin_reservations(request.reservation_ids)
        return Response(status_code=status.HTTP_204_NO_CONTENT)
    except Exception as e:
        logger.error(f"Error during bulk deletion service call: {e}", exc_info=True)
        raise HTTPException(
            status_code=status.HTTP_500_INTERNAL_SERVER_ERROR,
            detail="–í–Ω—É—Ç—Ä–µ–Ω–Ω—è—è –æ—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ —Ä–µ–∑–µ—Ä–≤–æ–≤."
        )

@router.get("/", response_model=AdminReservationListResponse)
async def get_all_reservations(
        _current_user: User = Depends(require_manager),
        query_service: ReservationQueryService = Depends(get_reservation_query_service),
        status: str = Query(None, description="–§–∏–ª—å—Ç—Ä –ø–æ —Å—Ç–∞—Ç—É—Å—É —Ä–µ–∑–µ—Ä–≤–∞ ('active' –∏–ª–∏ 'completed')"),
        search: str = Query(None, description="–ü–æ–∏—Å–∫ –ø–æ –∏–º–µ–Ω–∏ –∏–ª–∏ email –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è"),
        skip: int = Query(0, ge=0, description="–°–∫–æ–ª—å–∫–æ –∑–∞–ø–∏—Å–µ–π –ø—Ä–æ–ø—É—Å—Ç–∏—Ç—å"),
        limit: int = Query(10, ge=1, le=100, description="–ú–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∑–∞–ø–∏—Å–µ–π –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–µ")
):
    """–ü–æ–ª—É—á–∏—Ç—å –≤—Å–µ —Ä–µ–∑–µ—Ä–≤—ã —Å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–µ–π –æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è—Ö —Å –ø–∞–≥–∏–Ω–∞—Ü–∏–µ–π."""
    total_reservations = await query_service.get_admin_reservations_count(status=status, search_query=search)
    paginated_reservations = await query_service.get_paginated_admin_reservations(
        skip=skip,
        limit=limit,
        status=status,
        search_query=search
    )
    return AdminReservationListResponse(
        items=paginated_reservations,
        total=total_reservations
    )

@router.post("/", response_model=ReservationResponse)
async def create_reservation_for_user(
        request: AdminReservationCreateRequest,
        _current_user: User = Depends(require_manager),
        _csrf_protect: CsrfProtect = Depends(),
        service: OrderLifecycleService = Depends(get_order_lifecycle_service)
):
    """–°–æ–∑–¥–∞—Ç—å —Ä–µ–∑–µ—Ä–≤ –¥–ª—è –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è."""
    new_reservation = await service.create_admin_reservation(request)
    return ReservationResponse(reservation_id=new_reservation.id, message="–†–µ–∑–µ—Ä–≤ —É—Å–ø–µ—à–Ω–æ —Å–æ–∑–¥–∞–Ω")

@router.put("/{reservation_id}", response_model=ReservationResponse)
async def update_any_reservation(
        reservation_id: int,
        data: ReservationUpdateRequest,
        _current_user: User = Depends(require_manager),
        _csrf_protect: CsrfProtect = Depends(),
        service: OrderLifecycleService = Depends(get_order_lifecycle_service)
):
    """–û–±–Ω–æ–≤–∏—Ç—å –ª—é–±–æ–π —Ä–µ–∑–µ—Ä–≤ –ø–æ –µ–≥–æ ID."""
    updated_reservation = await service.update_admin_reservation(reservation_id, data)
    return ReservationResponse(reservation_id=updated_reservation.id, message="–†–µ–∑–µ—Ä–≤ —É—Å–ø–µ—à–Ω–æ –æ–±–Ω–æ–≤–ª–µ–Ω")

@router.delete("/{reservation_id}", status_code=204)
async def delete_any_reservation(
        reservation_id: int,
        _current_user: User = Depends(require_manager),
        _csrf_protect: CsrfProtect = Depends(),
        service: OrderLifecycleService = Depends(get_order_lifecycle_service)
):
    """–£–¥–∞–ª–∏—Ç—å –ª—é–±–æ–π —Ä–µ–∑–µ—Ä–≤ –ø–æ –µ–≥–æ ID."""
    await service.cancel_admin_reservation(reservation_id)
    return None

```



## `api\association_api.py`


```python

# api/association_api.py

from fastapi import APIRouter, Depends, HTTPException, Query
from sqlalchemy.ext.asyncio import AsyncSession
from sqlalchemy import select, func
from sqlalchemy.orm import selectinload
from typing import List

from api.deps import get_db
from api.models.user import User
from api.models.association import Association
from api.models.equipment import Equipment
from api.permissions import require_manager
from shared.schemas.association_schema import AssociationCreate, AssociationUpdate, AssociationOut, AssociationListResponse
from fastapi_csrf_protect import CsrfProtect

router = APIRouter(prefix="/associations", tags=["–ê—Å—Å–æ—Ü–∏–∞—Ü–∏–∏"])

@router.get("/", response_model=AssociationListResponse)
async def get_all_associations(
        db: AsyncSession = Depends(get_db),
        skip: int = Query(0, ge=0, description="–°–∫–æ–ª—å–∫–æ –∑–∞–ø–∏—Å–µ–π –ø—Ä–æ–ø—É—Å—Ç–∏—Ç—å"),
        limit: int = Query(10, ge=1, le=100, description="–ú–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∑–∞–ø–∏—Å–µ–π –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–µ")
):
    """
    –ü–æ–ª—É—á–∏—Ç—å —Å–ø–∏—Å–æ–∫ –≤—Å–µ—Ö –∞—Å—Å–æ—Ü–∏–∞—Ü–∏–π, –æ—Ç—Å–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö –ø–æ –ø–æ—Ä—è–¥–∫—É —Å –ø–∞–≥–∏–Ω–∞—Ü–∏–µ–π.
    –≠—Ç–æ—Ç —ç–Ω–¥–ø–æ–∏–Ω—Ç –ø—É–±–ª–∏—á–Ω—ã–π –∏ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–ª—è —Ñ–∏–ª—å—Ç—Ä–æ–≤ –Ω–∞ –≥–ª–∞–≤–Ω–æ–π —Å—Ç—Ä–∞–Ω–∏—Ü–µ.
    """
    # 1. –ó–∞–ø—Ä–æ—Å –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –æ–±—â–µ–≥–æ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ –∞—Å—Å–æ—Ü–∏–∞—Ü–∏–π
    total_result = await db.execute(select(func.count(Association.id)))
    total_associations = total_result.scalar_one()

    # 2. –ó–∞–ø—Ä–æ—Å –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è "—Å—Ç—Ä–∞–Ω–∏—Ü—ã" –∞—Å—Å–æ—Ü–∏–∞—Ü–∏–π
    associations_result = await db.execute(
        select(Association)
        .options(selectinload(Association.equipment))
        .order_by(Association.sort_order, Association.name)
        .offset(skip)
        .limit(limit)
    )
    associations_orm = associations_result.unique().scalars().all()

    # 3. –§–æ—Ä–º–∏—Ä—É–µ–º –∏ –≤–æ–∑–≤—Ä–∞—â–∞–µ–º –Ω–æ–≤—ã–π –æ–±—ä–µ–∫—Ç –æ—Ç–≤–µ—Ç–∞
    return AssociationListResponse(
        items=[AssociationOut.from_orm(assoc) for assoc in associations_orm],
        total=total_associations
    )

@router.post("/", response_model=AssociationOut, status_code=201)
async def create_association(
        assoc_in: AssociationCreate,
        db: AsyncSession = Depends(get_db),
        _current_user: User = Depends(require_manager),
        _csrf_protect: CsrfProtect = Depends()
):
    """–°–æ–∑–¥–∞—Ç—å –Ω–æ–≤—É—é –∞—Å—Å–æ—Ü–∏–∞—Ü–∏—é (–ú–µ–Ω–µ–¥–∂–µ—Ä/–ê–¥–º–∏–Ω)."""
    result = await db.execute(select(Association).filter(Association.name == assoc_in.name))
    if result.scalars().first():
        raise HTTPException(status_code=409, detail="–ê—Å—Å–æ—Ü–∏–∞—Ü–∏—è —Å —Ç–∞–∫–∏–º –Ω–∞–∑–≤–∞–Ω–∏–µ–º —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç.")

    new_assoc = Association(
        name=assoc_in.name,
        description=assoc_in.description,
        sort_order=assoc_in.sort_order
    )

    if assoc_in.equipment_ids:
        equipment_result = await db.execute(
            select(Equipment)
            .filter(Equipment.id.in_(assoc_in.equipment_ids))
            .options(
                selectinload(Equipment.accessories),
                selectinload(Equipment.associations)
            )
        )
        equipment = equipment_result.unique().scalars().all()
        if len(equipment) != len(set(assoc_in.equipment_ids)):
            raise HTTPException(status_code=404, detail="–û–¥–Ω–æ –∏–ª–∏ –Ω–µ—Å–∫–æ–ª—å–∫–æ –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏–π –Ω–µ –Ω–∞–π–¥–µ–Ω–æ.")
        new_assoc.equipment = equipment

    db.add(new_assoc)
    await db.commit()
    
    # –ü–æ–≤—Ç–æ—Ä–Ω–æ –ø–æ–ª—É—á–∞–µ–º –æ–±—ä–µ–∫—Ç –∏–∑ –ë–î —Å –∑–∞–≥—Ä—É–∂–µ–Ω–Ω—ã–º–∏ —Å–≤—è–∑—è–º–∏
    result = await db.execute(
        select(Association)
        .filter(Association.id == new_assoc.id)
        .options(selectinload(Association.equipment))
    )
    return result.scalars().first()

@router.put("/{assoc_id}", response_model=AssociationOut)
async def update_association(
        assoc_id: int,
        assoc_in: AssociationUpdate,
        db: AsyncSession = Depends(get_db),
        _current_user: User = Depends(require_manager),
        _csrf_protect: CsrfProtect = Depends()
):
    """–û–±–Ω–æ–≤–∏—Ç—å –∞—Å—Å–æ—Ü–∏–∞—Ü–∏—é (–ú–µ–Ω–µ–¥–∂–µ—Ä/–ê–¥–º–∏–Ω)."""
    result = await db.execute(
        select(Association)
        .filter(Association.id == assoc_id)
        .options(selectinload(Association.equipment))
    )
    assoc = result.scalars().first()
    if not assoc:
        raise HTTPException(status_code=404, detail="–ê—Å—Å–æ—Ü–∏–∞—Ü–∏—è –Ω–µ –Ω–∞–π–¥–µ–Ω–∞.")

    update_data = assoc_in.model_dump(exclude_unset=True)

    if 'equipment_ids' in update_data:
        equipment_ids = update_data.pop('equipment_ids')
        assoc.equipment.clear()
        if equipment_ids:
            equipment_result = await db.execute(
                select(Equipment)
                .filter(Equipment.id.in_(equipment_ids))
                .options(
                    selectinload(Equipment.accessories),
                    selectinload(Equipment.associations)
                )
            )
            equipment = equipment_result.unique().scalars().all()
            if len(equipment) != len(set(equipment_ids)):
                raise HTTPException(status_code=404, detail="–û–¥–Ω–æ –∏–ª–∏ –Ω–µ—Å–∫–æ–ª—å–∫–æ –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏–π –Ω–µ –Ω–∞–π–¥–µ–Ω–æ.")
            assoc.equipment = equipment

    for key, value in update_data.items():
        setattr(assoc, key, value)

    await db.commit()
    
    # –ü–æ–≤—Ç–æ—Ä–Ω–æ –ø–æ–ª—É—á–∞–µ–º –æ–±—ä–µ–∫—Ç –∏–∑ –ë–î —Å –∑–∞–≥—Ä—É–∂–µ–Ω–Ω—ã–º–∏ —Å–≤—è–∑—è–º–∏
    result = await db.execute(
        select(Association)
        .filter(Association.id == assoc_id)
        .options(selectinload(Association.equipment))
    )
    return result.scalars().first()

@router.delete("/{assoc_id}", status_code=204)
async def delete_association(
        assoc_id: int,
        db: AsyncSession = Depends(get_db),
        _current_user: User = Depends(require_manager),
        _csrf_protect: CsrfProtect = Depends()
):
    """–£–¥–∞–ª–∏—Ç—å –∞—Å—Å–æ—Ü–∏–∞—Ü–∏—é (–ú–µ–Ω–µ–¥–∂–µ—Ä/–ê–¥–º–∏–Ω)."""
    result = await db.execute(
        select(Association)
        .filter(Association.id == assoc_id)
        .options(selectinload(Association.equipment))
    )
    assoc = result.scalars().first()
    if not assoc:
        raise HTTPException(status_code=404, detail="–ê—Å—Å–æ—Ü–∏–∞—Ü–∏—è –Ω–µ –Ω–∞–π–¥–µ–Ω–∞.")

    await db.delete(assoc)
    await db.commit()
    return None

```



## `api\auth_api.py`


```python

# api/auth_api.py

from fastapi import APIRouter, Depends, HTTPException, status, Request # Request –º–æ–∂–µ—Ç –ø–æ–Ω–∞–¥–æ–±–∏—Ç—å—Å—è –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏ CSRF
from fastapi.security import OAuth2PasswordRequestForm, OAuth2PasswordBearer
from sqlalchemy.ext.asyncio import AsyncSession
from shared.schemas.user_schema import UserCreate, Token
from api.services.auth_service import (
    create_user,
    authenticate_user,
    create_access_token,
    get_user_by_token,
)
from api.models.user import User
from api.deps import get_db
from fastapi_csrf_protect import CsrfProtect # <--- –î–æ–±–∞–≤–ª–µ–Ω –∏–º–ø–æ—Ä—Ç

router = APIRouter(prefix="/auth", tags=["–ê—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è"])

# OAuth2PasswordBearer –æ–ø—Ä–µ–¥–µ–ª—è–µ—Ç, —á—Ç–æ –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è —Ç–æ–∫–µ–Ω–∞ –Ω—É–∂–Ω–æ –æ–±—Ä–∞—Ç–∏—Ç—å—Å—è –∫ /auth/token
# –§—Ä–æ–Ω—Ç–µ–Ω–¥ –¥–æ–ª–∂–µ–Ω –±—É–¥–µ—Ç —Ç–∞–∫–∂–µ –æ—Ç–ø—Ä–∞–≤–∏—Ç—å CSRF —Ç–æ–∫–µ–Ω –Ω–∞ —ç—Ç–æ—Ç —ç–Ω–¥–ø–æ–∏–Ω—Ç.
oauth2_scheme = OAuth2PasswordBearer(tokenUrl="/auth/token")


@router.post("/register", status_code=status.HTTP_201_CREATED)
async def register_user(
        user_data: UserCreate,
        db: AsyncSession = Depends(get_db),
        csrf_protect: CsrfProtect = Depends() # <--- –î–æ–±–∞–≤–ª–µ–Ω–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç—å CSRF
):
    # –ó–∞–≤–∏—Å–∏–º–æ—Å—Ç—å Depends(CsrfProtect) –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø—Ä–æ–≤–µ—Ä–∏—Ç CSRF —Ç–æ–∫–µ–Ω –¥–ª—è POST –∑–∞–ø—Ä–æ—Å–∞.
    # –§—Ä–æ–Ω—Ç–µ–Ω–¥ –¥–æ–ª–∂–µ–Ω –æ—Ç–ø—Ä–∞–≤–∏—Ç—å CSRF —Ç–æ–∫–µ–Ω, –ø–æ–ª—É—á–µ–Ω–Ω—ã–π –∏–∑ cookie (–æ–±—ã—á–Ω–æ 'fastapi-csrf-token'),
    # –≤ –∑–∞–≥–æ–ª–æ–≤–∫–µ 'X-CSRF-Token'.
    user = await create_user(db, user_data)
    return {"message": "–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —É—Å–ø–µ—à–Ω–æ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω", "email": user.email}


@router.post("/token", response_model=Token)
async def login(
        form_data: OAuth2PasswordRequestForm = Depends(),
        db: AsyncSession = Depends(get_db),
        csrf_protect: CsrfProtect = Depends() # <--- –î–æ–±–∞–≤–ª–µ–Ω–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç—å CSRF
):
    # –ó–∞–≤–∏—Å–∏–º–æ—Å—Ç—å Depends(CsrfProtect) —Ç–∞–∫–∂–µ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø—Ä–æ–≤–µ—Ä–∏—Ç CSRF —Ç–æ–∫–µ–Ω –∑–¥–µ—Å—å.
    user = await authenticate_user(db, form_data.username, form_data.password)
    if not user:
        raise HTTPException(
            status_code=status.HTTP_401_UNAUTHORIZED, # –ò—Å–ø–æ–ª—å–∑—É–µ–º –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π —Å—Ç–∞—Ç—É—Å
            detail="–ù–µ–≤–µ—Ä–Ω—ã–µ —É—á–µ—Ç–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ",
            headers={"WWW-Authenticate": "Bearer"}, # –°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π –∑–∞–≥–æ–ª–æ–≤–æ–∫ –¥–ª—è 401
        )
    access_token = create_access_token({"sub": user.email})

    # fastapi-csrf-protect –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –¥–æ–ª–∂–µ–Ω —É—Å—Ç–∞–Ω–æ–≤–∏—Ç—å/–æ–±–Ω–æ–≤–∏—Ç—å CSRF cookie –≤ –æ—Ç–≤–µ—Ç–µ,
    # –∫–æ–≥–¥–∞ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è Depends(CsrfProtect) –∏ –º–µ—Ç–æ–¥ —è–≤–ª—è–µ—Ç—Å—è state-changing.
    # –ï—Å–ª–∏ –≤—ã —Ö–æ—Ç–∏—Ç–µ –±—ã—Ç—å —É–≤–µ—Ä–µ–Ω—ã –∏–ª–∏ —É–ø—Ä–∞–≤–ª—è—Ç—å —ç—Ç–∏–º —è–≤–Ω–æ (–Ω–∞–ø—Ä–∏–º–µ—Ä, –¥–ª—è –æ—Ç–≤–µ—Ç–∞ –Ω–µ –æ—Ç FastAPI Response):
    # from fastapi.responses import JSONResponse
    # response_content = {"access_token": access_token, "token_type": "bearer"}
    # response = JSONResponse(content=response_content)
    # csrf_protect.set_csrf_cookie(response) # –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å/–æ–±–Ω–æ–≤–∏—Ç—å CSRF cookie –≤ –æ—Ç–≤–µ—Ç–µ
    # return response
    # –ù–æ –¥–ª—è —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã—Ö FastAPI –æ—Ç–≤–µ—Ç–æ–≤ –∏ —Å Depends() —ç—Ç–æ –æ–±—ã—á–Ω–æ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏.

    return {"access_token": access_token, "token_type": "bearer"}


async def get_current_user(
        token: str = Depends(oauth2_scheme), db: AsyncSession = Depends(get_db)
) -> User:
    user = await get_user_by_token(db, token)
    if not user:
        # –ò—Å–ø—Ä–∞–≤–ª—è–µ–º –∫–æ–¥ —Å—Ç–∞—Ç—É—Å–∞ –∏ –¥–æ–±–∞–≤–ª—è–µ–º –∑–∞–≥–æ–ª–æ–≤–æ–∫ –¥–ª—è –æ—à–∏–±–æ–∫ –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏
        raise HTTPException(
            status_code=status.HTTP_401_UNAUTHORIZED,
            detail="–ù–µ–¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω—ã–π –∏–ª–∏ –ø—Ä–æ—Å—Ä–æ—á–µ–Ω–Ω—ã–π —Ç–æ–∫–µ–Ω –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏",
            headers={"WWW-Authenticate": "Bearer"},
        )
    return user

```



## `api\calendar_api.py`


```python

# api/calendar_api.py

from fastapi import APIRouter, Query, Depends, HTTPException
from sqlalchemy.ext.asyncio import AsyncSession
from sqlalchemy import select, func
from datetime import date, timedelta
from typing import List, Optional

from fastapi.security import OAuth2PasswordBearer

from api.deps import get_db, get_availability_service
from api.services.availability import AvailabilityService
from api.models.equipment import Equipment as ApiEquipment
from api.models.user import User as ApiUser
from api.auth_api import get_current_user

from shared.schemas.calendar_schema import (
    EquipmentStatusResponse,
    EquipmentDayStatusesResponse,
    CalendarEventResponse,
    EquipmentStatusListResponse,
    CalendarEventListResponse,
)

optional_oauth2_scheme = OAuth2PasswordBearer(tokenUrl="/auth/token", auto_error=False)

async def get_current_user_optional(token: Optional[str] = Depends(optional_oauth2_scheme), db: AsyncSession = Depends(get_db)) -> Optional[ApiUser]:
    if token is None:
        return None
    try:
        from api.services.auth_service import get_user_by_token as get_user_by_token_service
        user = await get_user_by_token_service(db, token)
        return user
    except HTTPException:
        return None

router = APIRouter(prefix="/calendar", tags=["–ö–∞–ª–µ–Ω–¥–∞—Ä—å"])

@router.get("/view", response_model=EquipmentStatusListResponse)
async def get_calendar_view(
        start_date: date = Query(..., alias="start"),
        end_date: date = Query(..., alias="end"),
        equipment_ids: List[int] = Query(None, alias="ids"),
        exclude_reservation_id: Optional[int] = Query(None, alias="exclude_reservation_id"),
        db: AsyncSession = Depends(get_db),
        availability_service: AvailabilityService = Depends(get_availability_service),
        skip: int = Query(0, ge=0, description="–°–∫–æ–ª—å–∫–æ –∑–∞–ø–∏—Å–µ–π –ø—Ä–æ–ø—É—Å—Ç–∏—Ç—å"),
        limit: int = Query(10, ge=1, le=100, description="–ú–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∑–∞–ø–∏—Å–µ–π –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–µ")
):
    if start_date == end_date:
        end_date = end_date + timedelta(days=1)

    if not equipment_ids:
        result = await db.execute(select(ApiEquipment))
        all_equipment = result.scalars().all()
        equipment_ids = [eq.id for eq in all_equipment]

    if not equipment_ids:
        return EquipmentStatusListResponse(items=[], total=0)

    # –ò—Å–ø–æ–ª—å–∑—É–µ–º –Ω–æ–≤—ã–π AvailabilityService
    statuses = await availability_service.get_availability_statuses(
        equipment_ids=equipment_ids,
        start_date=start_date,
        end_date=end_date,
        exclude_reservation_id=exclude_reservation_id,
    )

    equipment_result = await db.execute(select(ApiEquipment).filter(ApiEquipment.id.in_(equipment_ids)))
    equipment = equipment_result.scalars().all()
    equipment_map = {e.id: e for e in equipment}

    result = []
    for eq_id, status_info in statuses.items():
        eq = equipment_map.get(eq_id)
        result.append(
            EquipmentStatusResponse(
                equipment_id=eq_id,
                status=status_info["status"],
                details=status_info["details"],
                name=eq.name if eq else None,
                equipment_type=eq.equipment_type if eq else None,
                brand=eq.brand if eq else None,
                start_date=status_info.get("start_date"),
                end_date=status_info.get("end_date"),
            )
        )

    total_items = len(result)
    paginated_result = result[skip:skip + limit]

    return EquipmentStatusListResponse(
        items=paginated_result,
        total=total_items
    )


@router.get("/day-statuses", response_model=EquipmentDayStatusesResponse)
async def get_calendar_day_statuses(
        start_date: date = Query(..., alias="start"),
        end_date: date = Query(..., alias="end"),
        equipment_ids: List[int] = Query(None, alias="ids"),
        exclude_reservation_id: Optional[int] = Query(None, alias="exclude_reservation_id"),
        db: AsyncSession = Depends(get_db),
        availability_service: AvailabilityService = Depends(get_availability_service),
        current_user: Optional[ApiUser] = Depends(get_current_user_optional)
):
    if start_date == end_date:
        end_date = end_date + timedelta(days=1)

    if not equipment_ids:
        result = await db.execute(select(ApiEquipment))
        all_equipment = result.scalars().all()
        equipment_ids = [eq.id for eq in all_equipment]

    if not equipment_ids:
        return {"equipment_day_statuses": {}}

    current_user_id: Optional[int] = current_user.id if current_user else None

    # –ò—Å–ø–æ–ª—å–∑—É–µ–º –Ω–æ–≤—ã–π AvailabilityService
    statuses = await availability_service.get_daily_statuses(
        equipment_ids=equipment_ids,
        start_date=start_date,
        end_date=end_date,
        exclude_reservation_id=exclude_reservation_id,
        current_user_id=current_user_id
    )

    return {"equipment_day_statuses": statuses}


@router.get("/events", response_model=CalendarEventListResponse)
async def get_calendar_events(
        start: date = Query(..., alias="start"),
        end: date = Query(..., alias="end"),
        equipment_ids: List[int] = Query(None, alias="ids"),
        db: AsyncSession = Depends(get_db),
        availability_service: AvailabilityService = Depends(get_availability_service),
        skip: int = Query(0, ge=0, description="–°–∫–æ–ª—å–∫–æ –∑–∞–ø–∏—Å–µ–π –ø—Ä–æ–ø—É—Å—Ç–∏—Ç—å"),
        limit: int = Query(10, ge=1, le=100, description="–ú–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∑–∞–ø–∏—Å–µ–π –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–µ")
):
    if not equipment_ids:
        result = await db.execute(select(ApiEquipment))
        all_equipment = result.scalars().all()
        equipment_ids = [eq.id for eq in all_equipment]

    # –ò—Å–ø–æ–ª—å–∑—É–µ–º –Ω–æ–≤—ã–π AvailabilityService
    events = await availability_service.get_calendar_events(
        equipment_ids=equipment_ids,
        start_date=start,
        end_date=end,
    )

    total_events = len(events)
    paginated_events = events[skip:skip + limit]

    return CalendarEventListResponse(
        items=paginated_events,
        total=total_events
    )

```



## `api\database.py`


```python

# api/database.py

from sqlalchemy.ext.asyncio import create_async_engine, async_sessionmaker, AsyncSession
from sqlalchemy.orm import declarative_base
# –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –≤–∞—à —Ñ–∞–π–ª config/secrets.py –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ –∑–∞–≥—Ä—É–∂–∞–µ—Ç DATABASE_URL –∏–∑ .env
# –ù–∞–ø—Ä–∏–º–µ—Ä, –∏—Å–ø–æ–ª—å–∑—É—è pydantic_settings –∏–ª–∏ python-dotenv
from config.secrets import DATABASE_URL

# –°–æ–∑–¥–∞–µ–º –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω—ã–π –¥–≤–∏–∂–æ–∫, –∏—Å–ø–æ–ª—å–∑—É—è URL –Ω–∞–ø—Ä—è–º—É—é –∏–∑ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏
engine = create_async_engine(DATABASE_URL, echo=False, future=True)

# –°–æ–∑–¥–∞–µ–º —Ñ–∞–±—Ä–∏–∫—É –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω—ã—Ö —Å–µ—Å—Å–∏–π
AsyncSessionLocal = async_sessionmaker(
    bind=engine,
    class_=AsyncSession,
    expire_on_commit=False,
    autocommit=False,
    autoflush=False
)

Base = declarative_base()

# –°–æ–∑–¥–∞–µ–º –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω—É—é –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç—å –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è —Å–µ—Å—Å–∏–∏
async def get_db() -> AsyncSession:
    """–ê—Å–∏–Ω—Ö—Ä–æ–Ω–Ω—ã–π –≥–µ–Ω–µ—Ä–∞—Ç–æ—Ä –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è —Å–µ—Å—Å–∏–∏ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö."""
    async with AsyncSessionLocal() as session:
        try:
            yield session
        finally:
            await session.close()

```



## `api\deps.py`


```python

# api/deps.py

from fastapi import Depends
from sqlalchemy.ext.asyncio import AsyncSession
from fastapi.security import OAuth2PasswordBearer
from fastapi import HTTPException, status

from api.database import get_db as get_database
from api.services.auth_service import get_user_by_token
from api.models.user import User

# –ò–º–ø–æ—Ä—Ç—ã —Å–µ—Ä–≤–∏—Å–æ–≤
from api.services.order.order_lifecycle_service import OrderLifecycleService
from api.services.rental.rental_query_service import RentalQueryService
from api.services.reservation_query_service import ReservationQueryService
from api.services.balance_service import BalanceService
from api.services.equipment_query_builder import EquipmentQueryBuilder
from api.services.financial_service import FinancialService
from api.services.availability import AvailabilityService
from api.services.dashboard_service import DashboardService

# OAuth2PasswordBearer –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è —Ç–æ–∫–µ–Ω–∞ –∏–∑ –∑–∞–≥–æ–ª–æ–≤–∫–∞ Authorization
oauth2_scheme = OAuth2PasswordBearer(tokenUrl="/auth/token")


async def get_db():
    """–ó–∞–≤–∏—Å–∏–º–æ—Å—Ç—å –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è —Å–µ—Å—Å–∏–∏ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö."""
    async for db in get_database():
        yield db


async def get_current_user(
    token: str = Depends(oauth2_scheme), 
    db: AsyncSession = Depends(get_db)
) -> User:
    """–ü–æ–ª—É—á–∏—Ç—å —Ç–µ–∫—É—â–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –ø–æ —Ç–æ–∫–µ–Ω—É."""
    user = await get_user_by_token(db, token)
    if not user:
        raise HTTPException(
            status_code=status.HTTP_401_UNAUTHORIZED,
            detail="–ù–µ–¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω—ã–π –∏–ª–∏ –ø—Ä–æ—Å—Ä–æ—á–µ–Ω–Ω—ã–π —Ç–æ–∫–µ–Ω –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏",
            headers={"WWW-Authenticate": "Bearer"},
        )
    return user


# === –ó–ê–í–ò–°–ò–ú–û–°–¢–ò –î–õ–Ø –°–ï–†–í–ò–°–û–í ===

def get_order_lifecycle_service(db: AsyncSession = Depends(get_db)) -> OrderLifecycleService:
    """–ó–∞–≤–∏—Å–∏–º–æ—Å—Ç—å –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è —Å–µ—Ä–≤–∏—Å–∞ –∂–∏–∑–Ω–µ–Ω–Ω–æ–≥–æ —Ü–∏–∫–ª–∞ –∑–∞–∫–∞–∑–æ–≤."""
    return OrderLifecycleService(db)


def get_rental_query_service(db: AsyncSession = Depends(get_db)) -> RentalQueryService:
    """–ó–∞–≤–∏—Å–∏–º–æ—Å—Ç—å –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è —Å–µ—Ä–≤–∏—Å–∞ –∑–∞–ø—Ä–æ—Å–æ–≤ –∞—Ä–µ–Ω–¥—ã."""
    return RentalQueryService(db)


def get_reservation_query_service(db: AsyncSession = Depends(get_db)) -> ReservationQueryService:
    """–ó–∞–≤–∏—Å–∏–º–æ—Å—Ç—å –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è —Å–µ—Ä–≤–∏—Å–∞ –∑–∞–ø—Ä–æ—Å–æ–≤ —Ä–µ–∑–µ—Ä–≤–∞—Ü–∏–π."""
    return ReservationQueryService(db)




def get_balance_service(db: AsyncSession = Depends(get_db)) -> BalanceService:
    """–ó–∞–≤–∏—Å–∏–º–æ—Å—Ç—å –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è —Å–µ—Ä–≤–∏—Å–∞ –±–∞–ª–∞–Ω—Å–∞."""
    return BalanceService(db)


def get_equipment_query_builder(db: AsyncSession = Depends(get_db)) -> EquipmentQueryBuilder:
    """–ó–∞–≤–∏—Å–∏–º–æ—Å—Ç—å –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –±–∏–ª–¥–µ—Ä–∞ –∑–∞–ø—Ä–æ—Å–æ–≤ –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—è."""
    return EquipmentQueryBuilder(db)


def get_financial_service(db: AsyncSession = Depends(get_db)) -> FinancialService:
    """–ó–∞–≤–∏—Å–∏–º–æ—Å—Ç—å –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è —Ñ–∏–Ω–∞–Ω—Å–æ–≤–æ–≥–æ —Å–µ—Ä–≤–∏—Å–∞."""
    return FinancialService(db)


def get_availability_service(db: AsyncSession = Depends(get_db)) -> AvailabilityService:
    """–ó–∞–≤–∏—Å–∏–º–æ—Å—Ç—å –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è —Å–µ—Ä–≤–∏—Å–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏ –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—è."""
    return AvailabilityService(db)


def get_dashboard_service(db: AsyncSession = Depends(get_db)) -> DashboardService:
    """–ó–∞–≤–∏—Å–∏–º–æ—Å—Ç—å –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è —Å–µ—Ä–≤–∏—Å–∞ –ø–∞–Ω–µ–ª–∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è."""
    return DashboardService(db)

```



## `api\discount_api.py`


```python

# api/discount_api.py

from typing import List
from fastapi import APIRouter, Depends, HTTPException, Query
from sqlalchemy.ext.asyncio import AsyncSession
from sqlalchemy import select, func
from fastapi_csrf_protect import CsrfProtect

from api.deps import get_db
from api.models.user import User
from api.models.discount import DurationDiscount
from api.permissions import require_admin
from shared.schemas.discount_schema import DiscountCreate, DiscountUpdate, DiscountOut, DiscountListResponse

router = APIRouter(prefix="/discounts", tags=["–°–∫–∏–¥–∫–∏ –∑–∞ –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å"])

@router.get("/", response_model=DiscountListResponse)
async def get_all_discounts(
        db: AsyncSession = Depends(get_db),
        skip: int = Query(0, ge=0, description="–°–∫–æ–ª—å–∫–æ –∑–∞–ø–∏—Å–µ–π –ø—Ä–æ–ø—É—Å—Ç–∏—Ç—å"),
        limit: int = Query(10, ge=1, le=100, description="–ú–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∑–∞–ø–∏—Å–µ–π –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–µ")
):
    """–ü–æ–ª—É—á–∏—Ç—å –≤—Å–µ —É—Ä–æ–≤–Ω–∏ —Å–∫–∏–¥–æ–∫ –∑–∞ –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å —Å –ø–∞–≥–∏–Ω–∞—Ü–∏–µ–π."""
    # 1. –ó–∞–ø—Ä–æ—Å –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –æ–±—â–µ–≥–æ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ —Å–∫–∏–¥–æ–∫
    total_result = await db.execute(select(func.count(DurationDiscount.id)))
    total_discounts = total_result.scalar_one()

    # 2. –ó–∞–ø—Ä–æ—Å –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è "—Å—Ç—Ä–∞–Ω–∏—Ü—ã" —Å–∫–∏–¥–æ–∫
    discounts_result = await db.execute(
        select(DurationDiscount).order_by(DurationDiscount.min_days).offset(skip).limit(limit)
    )
    discounts_orm = discounts_result.scalars().all()

    # 3. –§–æ—Ä–º–∏—Ä—É–µ–º –∏ –≤–æ–∑–≤—Ä–∞—â–∞–µ–º –Ω–æ–≤—ã–π –æ–±—ä–µ–∫—Ç –æ—Ç–≤–µ—Ç–∞
    return DiscountListResponse(
        items=[DiscountOut.from_orm(discount) for discount in discounts_orm],
        total=total_discounts
    )

@router.post("/", response_model=DiscountOut, status_code=201)
async def create_discount(
        discount_in: DiscountCreate,
        db: AsyncSession = Depends(get_db),
        current_user: User = Depends(require_admin),
        csrf_protect: CsrfProtect = Depends()
):
    """–°–æ–∑–¥–∞—Ç—å –Ω–æ–≤—ã–π —É—Ä–æ–≤–µ–Ω—å —Å–∫–∏–¥–∫–∏."""
    result = await db.execute(select(DurationDiscount).filter(DurationDiscount.min_days == discount_in.min_days))
    existing = result.scalars().first()
    if existing:
        raise HTTPException(status_code=409, detail=f"–°–∫–∏–¥–∫–∞ –¥–ª—è {discount_in.min_days} –¥–Ω–µ–π —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç.")

    new_discount = DurationDiscount(**discount_in.model_dump())
    db.add(new_discount)
    await db.commit()
    
    # –ü–æ–≤—Ç–æ—Ä–Ω–æ –ø–æ–ª—É—á–∞–µ–º –æ–±—ä–µ–∫—Ç –∏–∑ –ë–î
    result = await db.execute(select(DurationDiscount).filter(DurationDiscount.id == new_discount.id))
    return result.scalars().first()

@router.put("/{discount_id}", response_model=DiscountOut)
async def update_discount(
        discount_id: int,
        discount_in: DiscountUpdate,
        db: AsyncSession = Depends(get_db),
        current_user: User = Depends(require_admin),
        csrf_protect: CsrfProtect = Depends()
):
    """–û–±–Ω–æ–≤–∏—Ç—å —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π —É—Ä–æ–≤–µ–Ω—å —Å–∫–∏–¥–∫–∏."""
    result = await db.execute(select(DurationDiscount).filter(DurationDiscount.id == discount_id))
    discount = result.scalars().first()
    if not discount:
        raise HTTPException(status_code=404, detail="–°–∫–∏–¥–∫–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞.")

    existing_result = await db.execute(
        select(DurationDiscount).filter(
            DurationDiscount.min_days == discount_in.min_days,
            DurationDiscount.id != discount_id
        )
    )
    existing = existing_result.scalars().first()
    if existing:
        raise HTTPException(status_code=409, detail=f"–°–∫–∏–¥–∫–∞ –¥–ª—è {discount_in.min_days} –¥–Ω–µ–π —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç.")

    update_data = discount_in.model_dump()
    for key, value in update_data.items():
        setattr(discount, key, value)

    await db.commit()
    
    # –ü–æ–≤—Ç–æ—Ä–Ω–æ –ø–æ–ª—É—á–∞–µ–º –æ–±—ä–µ–∫—Ç –∏–∑ –ë–î
    result = await db.execute(select(DurationDiscount).filter(DurationDiscount.id == discount_id))
    return result.scalars().first()

@router.delete("/{discount_id}", status_code=204)
async def delete_discount(
        discount_id: int,
        db: AsyncSession = Depends(get_db),
        current_user: User = Depends(require_admin),
        csrf_protect: CsrfProtect = Depends()
):
    """–£–¥–∞–ª–∏—Ç—å —É—Ä–æ–≤–µ–Ω—å —Å–∫–∏–¥–∫–∏."""
    result = await db.execute(select(DurationDiscount).filter(DurationDiscount.id == discount_id))
    discount = result.scalars().first()
    if not discount:
        raise HTTPException(status_code=404, detail="–°–∫–∏–¥–∫–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞.")

    await db.delete(discount)
    await db.commit()
    return None

```



## `api\equipment_api.py`


```python

# api/equipment_api.py

from fastapi import APIRouter, Depends, HTTPException, Query
from sqlalchemy.ext.asyncio import AsyncSession
from sqlalchemy import select, func
from sqlalchemy.orm import selectinload
from typing import List, Optional
from datetime import date, datetime
from collections import defaultdict
from fastapi_csrf_protect import CsrfProtect

from api.models.equipment import Equipment
from api.models.user import User
from api.models.rental import Rental
from api.models.reservation import Reservation
from api.deps import get_db
from api.permissions import require_manager
# --- –ò–ó–ú–ï–ù–ï–ù–ò–ï: –ò–º–ø–æ—Ä—Ç–∏—Ä—É–µ–º –Ω–æ–≤—É—é —Å–µ—Ä–≤–∏—Å–Ω—É—é —Ñ—É–Ω–∫—Ü–∏—é –∏ —Å—Ö–µ–º—É –æ—Ç–≤–µ—Ç–∞ ---
from api.services.equipment_service_api import get_paginated_equipment, update_equipment_details
from shared.schemas.equipment_schema import (
    EquipmentOut,
    EquipmentTreeItem,
    EquipmentUpdateExtended,
    EquipmentCreate,
    EquipmentAvailabilityStatus,
    EquipmentListResponse,
    EquipmentTreeListResponse
)

router = APIRouter(prefix="/equipment", tags=["–û–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏–µ"])


@router.get("/", response_model=EquipmentListResponse)
async def list_equipment_paginated(
        db: AsyncSession = Depends(get_db),
        skip: int = Query(0, ge=0),
        limit: int = Query(10, ge=1, le=1000),
        query: Optional[str] = Query(None),
        type: Optional[str] = Query(None),
        brand: Optional[str] = Query(None),
        association_id: Optional[int] = Query(None, alias="associationId"),
        start_date: Optional[date] = Query(None, alias="startDate"),
        end_date: Optional[date] = Query(None, alias="endDate"),
        available_only: bool = Query(False, alias="availableOnly")
):
    """–í–æ–∑–≤—Ä–∞—â–∞–µ—Ç –æ—Ç—Ñ–∏–ª—å—Ç—Ä–æ–≤–∞–Ω–Ω—ã–π –∏ –ø–∞–≥–∏–Ω–∏—Ä–æ–≤–∞–Ω–Ω—ã–π —Å–ø–∏—Å–æ–∫ –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—è."""
    items, total = await get_paginated_equipment(
        db, skip=skip, limit=limit, query=query, type=type, brand=brand,
        association_id=association_id, start_date=start_date, end_date=end_date,
        available_only=available_only
    )
    return EquipmentListResponse(items=items, total=total)


@router.get("/tree", response_model=EquipmentTreeListResponse)
async def get_equipment_tree(
        db: AsyncSession = Depends(get_db),
        skip: int = Query(0, ge=0),
        limit: int = Query(10, ge=1, le=100)
):
    """–í–æ–∑–≤—Ä–∞—â–∞–µ—Ç –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏–µ, —Å–≥—Ä—É–ø–ø–∏—Ä–æ–≤–∞–Ω–Ω–æ–µ –≤ –≤–∏–¥–µ –¥–µ—Ä–µ–≤–∞ –ø–æ —Ç–∏–ø—É –∏ –±—Ä–µ–Ω–¥—É —Å –ø–∞–≥–∏–Ω–∞—Ü–∏–µ–π."""
    result = await db.execute(select(Equipment))
    all_equipment = result.scalars().all()
    grouped: dict[str, dict[str, list[Equipment]]] = defaultdict(lambda: defaultdict(list))
    for eq in all_equipment:
        grouped[eq.equipment_type][eq.brand].append(eq)

    result = []
    for eq_type, brands in grouped.items():
        type_node = EquipmentTreeItem(label=eq_type, children=[])
        for brand, items in brands.items():
            brand_node = EquipmentTreeItem(label=brand, children=[
                EquipmentTreeItem(label=item.name, value=item.id) for item in items
            ])
            type_node.children.append(brand_node)
        result.append(type_node)

    total_items = len(result)
    paginated_result = result[skip:skip + limit]

    return EquipmentTreeListResponse(
        items=paginated_result,
        total=total_items
    )


@router.put("/{equipment_id}", response_model=EquipmentOut)
async def update_single_equipment_details_route(
        equipment_id: int,
        equipment_data: EquipmentUpdateExtended,
        db: AsyncSession = Depends(get_db),
        _current_user: User = Depends(require_manager),
        _csrf_protect: CsrfProtect = Depends()
):
    """–û–±–Ω–æ–≤–ª—è–µ—Ç –¥–µ—Ç–∞–ª–∏ —É–∫–∞–∑–∞–Ω–Ω–æ–≥–æ –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—è."""
    updated_equipment = await update_equipment_details(db, equipment_id, equipment_data)
    return updated_equipment


@router.post("/", response_model=EquipmentOut)
async def create_equipment(
        equipment_data: EquipmentCreate,
        db: AsyncSession = Depends(get_db),
        _current_user: User = Depends(require_manager),
        _csrf_protect: CsrfProtect = Depends()
):
    """–°–æ–∑–¥–∞–µ—Ç –Ω–æ–≤–æ–µ –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏–µ."""
    equipment = Equipment(**equipment_data.model_dump())
    db.add(equipment)
    await db.commit()
    
    # –í–æ–∑–≤—Ä–∞—â–∞–µ–º —Å–æ–∑–¥–∞–Ω–Ω—ã–π –æ–±—ä–µ–∫—Ç –±–µ–∑ –ø–æ–≤—Ç–æ—Ä–Ω–æ–≥–æ –∑–∞–ø—Ä–æ—Å–∞ –∫ –ë–î
    return equipment


@router.delete("/{equipment_id}")
async def delete_equipment(
        equipment_id: int,
        db: AsyncSession = Depends(get_db),
        _current_user: User = Depends(require_manager),
        _csrf_protect: CsrfProtect = Depends()
):
    """–£–¥–∞–ª—è–µ—Ç –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏–µ."""
    result = await db.execute(select(Equipment).filter(Equipment.id == equipment_id))
    equipment = result.scalars().first()
    if not equipment:
        raise HTTPException(status_code=404, detail="–û–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏–µ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ")
    await db.delete(equipment)
    await db.commit()
    return {"message": "–û–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏–µ —É–¥–∞–ª–µ–Ω–æ"}


@router.get("/{equipment_id}/availability", response_model=EquipmentAvailabilityStatus)
async def get_equipment_availability_status(
        equipment_id: int,
        db: AsyncSession = Depends(get_db),
        _current_user: User = Depends(require_manager)
):
    """
    –ü—Ä–æ–≤–µ—Ä—è–µ—Ç, —É—á–∞—Å—Ç–≤—É–µ—Ç –ª–∏ –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏–µ –≤ –ù–ï–ó–ê–í–ï–†–®–ï–ù–ù–´–• —Ä–µ–∑–µ—Ä–≤–∞—Ö –∏–ª–∏ –∞—Ä–µ–Ω–¥–∞—Ö.
    """
    result = await db.execute(select(Equipment).filter(Equipment.id == equipment_id))
    equipment = result.scalars().first()
    if not equipment:
        raise HTTPException(status_code=404, detail="–û–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏–µ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ")

    today_start_of_day = datetime.combine(date.today(), datetime.min.time())

    reservations_result = await db.execute(
        select(func.count(Reservation.id)).filter(
            Reservation.equipment.any(Equipment.id == equipment_id),
            Reservation.end_date >= today_start_of_day
        )
    )
    active_reservations_count = reservations_result.scalar_one()

    rentals_result = await db.execute(
        select(func.count(Rental.id)).filter(
            Rental.equipment.any(Equipment.id == equipment_id),
            Rental.end_date >= today_start_of_day
        )
    )
    active_rentals_count = rentals_result.scalar_one()

    return EquipmentAvailabilityStatus(
        has_active_reservations=active_reservations_count > 0,
        has_active_rentals=active_rentals_count > 0,
        active_reservations_count=active_reservations_count,
        active_rentals_count=active_rentals_count,
    )

```



## `api\holiday_api.py`


```python

# api/holiday_api.py

from fastapi import APIRouter, Depends, HTTPException, Query
from sqlalchemy.ext.asyncio import AsyncSession
from sqlalchemy import select, func
from typing import List
from datetime import date, timedelta, datetime
import holidays

from api.deps import get_db
from api.permissions import require_admin
from api.models.user import User
from api.models.holiday import Holiday, HolidayRule
from api.models.reservation import Reservation
from shared.schemas.holiday_schema import HolidayOut, HolidayCreate, RecurringHolidayRuleCreate, HolidayRuleOut, HolidayListResponse, HolidayRuleListResponse

router = APIRouter(prefix="/holidays", tags=["–í—ã—Ö–æ–¥–Ω—ã–µ –∏ –ø—Ä–∞–∑–¥–Ω–∏–∫–∏"])

@router.get("/", response_model=HolidayListResponse)
async def get_holidays(
        start_date: date,
        end_date: date,
        db: AsyncSession = Depends(get_db),
        skip: int = Query(0, ge=0, description="–°–∫–æ–ª—å–∫–æ –∑–∞–ø–∏—Å–µ–π –ø—Ä–æ–ø—É—Å—Ç–∏—Ç—å"),
        limit: int = Query(400, ge=1, description="–ú–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∑–∞–ø–∏—Å–µ–π –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–µ")
):
    """–ü–æ–ª—É—á–∏—Ç—å —Å–ø–∏—Å–æ–∫ –≤—ã—Ö–æ–¥–Ω—ã—Ö –≤ –∑–∞–¥–∞–Ω–Ω–æ–º –¥–∏–∞–ø–∞–∑–æ–Ω–µ –¥–∞—Ç —Å –ø–∞–≥–∏–Ω–∞—Ü–∏–µ–π."""
    # 1. –ó–∞–ø—Ä–æ—Å –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –æ–±—â–µ–≥–æ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ –≤—ã—Ö–æ–¥–Ω—ã—Ö –≤ –¥–∏–∞–ø–∞–∑–æ–Ω–µ
    total_result = await db.execute(
        select(func.count(Holiday.date)).filter(Holiday.date.between(start_date, end_date))
    )
    total_holidays = total_result.scalar_one()

    # 2. –ó–∞–ø—Ä–æ—Å –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è "—Å—Ç—Ä–∞–Ω–∏—Ü—ã" –≤—ã—Ö–æ–¥–Ω—ã—Ö
    holidays_result = await db.execute(
        select(Holiday).filter(Holiday.date.between(start_date, end_date)).offset(skip).limit(limit)
    )
    holidays_orm = holidays_result.scalars().all()

    # 3. –§–æ—Ä–º–∏—Ä—É–µ–º –∏ –≤–æ–∑–≤—Ä–∞—â–∞–µ–º –Ω–æ–≤—ã–π –æ–±—ä–µ–∫—Ç –æ—Ç–≤–µ—Ç–∞
    return HolidayListResponse(
        items=[HolidayOut.from_orm(holiday) for holiday in holidays_orm],
        total=total_holidays
    )

@router.post("/", response_model=dict)
async def create_holiday(
        holiday_in: HolidayCreate,
        db: AsyncSession = Depends(get_db),
        current_user: User = Depends(require_admin)
):
    """–°–æ–∑–¥–∞—Ç—å –Ω–æ–≤—ã–π –≤—ã—Ö–æ–¥–Ω–æ–π –¥–µ–Ω—å (—Ä—É—á–Ω–æ–µ –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ)."""
    conflicting_result = await db.execute(
        select(Reservation.id).filter(
            (Reservation.start_date == holiday_in.date) | (Reservation.end_date == holiday_in.date)
        )
    )
    conflicting_ids = [r.id for r in conflicting_result.scalars().all()]
    if conflicting_ids and not holiday_in.force:
        raise HTTPException(
            status_code=409,
            detail={
                "message": "–≠—Ç–∞ –¥–∞—Ç–∞ —è–≤–ª—è–µ—Ç—Å—è –Ω–∞—á–∞–ª–æ–º –∏–ª–∏ –∫–æ–Ω—Ü–æ–º —Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö —Ä–µ–∑–µ—Ä–≤–æ–≤. –ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç–µ –¥–µ–π—Å—Ç–≤–∏–µ.",
                "conflicting_reservation_ids": conflicting_ids
            }
        )
    existing_result = await db.execute(select(Holiday).filter(Holiday.date == holiday_in.date))
    existing_holiday = existing_result.scalars().first()
    if existing_holiday:
        raise HTTPException(status_code=400, detail="–≠—Ç–æ—Ç –¥–µ–Ω—å —É–∂–µ —è–≤–ª—è–µ—Ç—Å—è –≤—ã—Ö–æ–¥–Ω—ã–º.")
    new_holiday = Holiday(
        **holiday_in.model_dump(exclude={"force"}),
        created_by_id=current_user.id
    )
    db.add(new_holiday)
    await db.commit()
    return {"message": "–í—ã—Ö–æ–¥–Ω–æ–π –¥–µ–Ω—å —É—Å–ø–µ—à–Ω–æ –¥–æ–±–∞–≤–ª–µ–Ω", "date": new_holiday.date}


@router.delete("/{holiday_date}", status_code=204)
async def delete_holiday(
        holiday_date: date,
        db: AsyncSession = Depends(get_db),
        _current_user: User = Depends(require_admin)
):
    """–£–¥–∞–ª–∏—Ç—å –≤—ã—Ö–æ–¥–Ω–æ–π –¥–µ–Ω—å."""
    result = await db.execute(select(Holiday).filter(Holiday.date == holiday_date))
    holiday = result.scalars().first()
    if not holiday:
        raise HTTPException(status_code=404, detail="–í—ã—Ö–æ–¥–Ω–æ–π –¥–µ–Ω—å –Ω–µ –Ω–∞–π–¥–µ–Ω")
    await db.delete(holiday)
    await db.commit()
    return None

@router.post("/recurring/weekly", status_code=201, summary="–°–æ–∑–¥–∞—Ç—å –µ–∂–µ–Ω–µ–¥–µ–ª—å–Ω—ã–µ –≤—ã—Ö–æ–¥–Ω—ã–µ")
async def create_weekly_recurring_holidays(
        rule_in: RecurringHolidayRuleCreate,
        db: AsyncSession = Depends(get_db),
        current_user: User = Depends(require_admin)
):
    """–°–æ–∑–¥–∞–µ—Ç –ø—Ä–∞–≤–∏–ª–æ –∏ –≥–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç –≤—ã—Ö–æ–¥–Ω—ã–µ –¥–ª—è —É–∫–∞–∑–∞–Ω–Ω–æ–≥–æ –¥–Ω—è –Ω–µ–¥–µ–ª–∏ –≤ –¥–∏–∞–ø–∞–∑–æ–Ω–µ –¥–∞—Ç."""
    if rule_in.start_date >= rule_in.end_date:
        raise HTTPException(status_code=400, detail="–î–∞—Ç–∞ –Ω–∞—á–∞–ª–∞ –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å —Ä–∞–Ω—å—à–µ –¥–∞—Ç—ã –æ–∫–æ–Ω—á–∞–Ω–∏—è.")
    new_rule = HolidayRule(
        rule_type="weekly",
        parameters={"day_of_week": rule_in.day_of_week},
        description=rule_in.description,
        created_by_id=current_user.id
    )
    db.add(new_rule)
    await db.flush()
    holidays_to_create = []
    current_date = rule_in.start_date
    while current_date <= rule_in.end_date:
        if current_date.weekday() == rule_in.day_of_week:
            exists_result = await db.execute(select(Holiday).filter(Holiday.date == current_date))
            exists = exists_result.scalars().first()
            if not exists:
                holidays_to_create.append(
                    Holiday(
                        date=current_date,
                        description=f"–ê–≤—Ç–æ (–ø—Ä–∞–≤–∏–ª–æ #{new_rule.id})",
                        created_by_id=current_user.id,
                        rule_id=new_rule.id
                    )
                )
        current_date += timedelta(days=1)
    if holidays_to_create:
        db.add_all(holidays_to_create)
    await db.commit()
    return {"message": f"–ü—Ä–∞–≤–∏–ª–æ —Å–æ–∑–¥–∞–Ω–æ. –î–æ–±–∞–≤–ª–µ–Ω–æ {len(holidays_to_create)} –Ω–æ–≤—ã—Ö –≤—ã—Ö–æ–¥–Ω—ã—Ö."}


@router.post("/import/public", status_code=201, summary="–ò–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å –≥–æ—Å. –ø—Ä–∞–∑–¥–Ω–∏–∫–∏")
async def import_public_holidays(
        country_code: str = Query("RU", description="ISO 3166-1 alpha-2 –∫–æ–¥ —Å—Ç—Ä–∞–Ω—ã"),
        year: int = Query(datetime.now().year, description="–ì–æ–¥ –¥–ª—è –∏–º–ø–æ—Ä—Ç–∞"),
        db: AsyncSession = Depends(get_db),
        current_user: User = Depends(require_admin)
):
    """–ò–º–ø–æ—Ä—Ç–∏—Ä—É–µ—Ç –≥–æ—Å—É–¥–∞—Ä—Å—Ç–≤–µ–Ω–Ω—ã–µ –ø—Ä–∞–∑–¥–Ω–∏–∫–∏ –¥–ª—è —É–∫–∞–∑–∞–Ω–Ω–æ–π —Å—Ç—Ä–∞–Ω—ã –∏ –≥–æ–¥–∞."""
    try:
        public_holidays = holidays.country_holidays(country_code, years=year)
        if not public_holidays:
            raise HTTPException(status_code=404, detail=f"–ù–µ –Ω–∞–π–¥–µ–Ω—ã –ø—Ä–∞–∑–¥–Ω–∏–∫–∏ –¥–ª—è —Å—Ç—Ä–∞–Ω—ã '{country_code}' –≤ {year} –≥–æ–¥—É.")
    except KeyError:
        raise HTTPException(status_code=400, detail=f"–ù–µ–≤–µ—Ä–Ω—ã–π –∫–æ–¥ —Å—Ç—Ä–∞–Ω—ã: '{country_code}'")

    rule_description = f"–ò–º–ø–æ—Ä—Ç –≥–æ—Å. –ø—Ä–∞–∑–¥–Ω–∏–∫–æ–≤ –¥–ª—è {country_code} –Ω–∞ {year} –≥–æ–¥"
    new_rule = HolidayRule(
        rule_type="public_import",
        parameters={"country": country_code, "year": year},
        description=rule_description,
        created_by_id=current_user.id
    )
    db.add(new_rule)
    await db.flush()

    holidays_to_create = []
    for holiday_date, holiday_name in public_holidays.items():
        exists_result = await db.execute(select(Holiday).filter(Holiday.date == holiday_date))
        exists = exists_result.scalars().first()
        if not exists:
            holidays_to_create.append(
                Holiday(
                    date=holiday_date,
                    description=holiday_name,
                    created_by_id=current_user.id,
                    rule_id=new_rule.id
                )
            )

    if holidays_to_create:
        db.add_all(holidays_to_create)

    await db.commit()
    return {"message": f"–ü—Ä–∞–≤–∏–ª–æ –∏–º–ø–æ—Ä—Ç–∞ —Å–æ–∑–¥–∞–Ω–æ. –î–æ–±–∞–≤–ª–µ–Ω–æ {len(holidays_to_create)} –ø—Ä–∞–∑–¥–Ω–∏—á–Ω—ã—Ö –¥–Ω–µ–π."}

@router.get("/rules", response_model=HolidayRuleListResponse, summary="–ü–æ–ª—É—á–∏—Ç—å —Å–ø–∏—Å–æ–∫ –≤—Å–µ—Ö –ø—Ä–∞–≤–∏–ª")
async def get_all_rules(
        db: AsyncSession = Depends(get_db),
        current_user: User = Depends(require_admin),
        skip: int = Query(0, ge=0, description="–°–∫–æ–ª—å–∫–æ –∑–∞–ø–∏—Å–µ–π –ø—Ä–æ–ø—É—Å—Ç–∏—Ç—å"),
        limit: int = Query(10, ge=1, le=100, description="–ú–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∑–∞–ø–∏—Å–µ–π –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–µ")
):
    """–í–æ–∑–≤—Ä–∞—â–∞–µ—Ç –≤—Å–µ —Å–æ–∑–¥–∞–Ω–Ω—ã–µ –ø—Ä–∞–≤–∏–ª–∞ –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –≤—ã—Ö–æ–¥–Ω—ã—Ö —Å –ø–∞–≥–∏–Ω–∞—Ü–∏–µ–π."""
    # 1. –ó–∞–ø—Ä–æ—Å –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –æ–±—â–µ–≥–æ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ –ø—Ä–∞–≤–∏–ª
    total_result = await db.execute(select(func.count(HolidayRule.id)))
    total_rules = total_result.scalar_one()

    # 2. –ó–∞–ø—Ä–æ—Å –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è "—Å—Ç—Ä–∞–Ω–∏—Ü—ã" –ø—Ä–∞–≤–∏–ª
    rules_result = await db.execute(
        select(HolidayRule).order_by(HolidayRule.created_at.desc()).offset(skip).limit(limit)
    )
    rules_orm = rules_result.scalars().all()

    # 3. –§–æ—Ä–º–∏—Ä—É–µ–º –∏ –≤–æ–∑–≤—Ä–∞—â–∞–µ–º –Ω–æ–≤—ã–π –æ–±—ä–µ–∫—Ç –æ—Ç–≤–µ—Ç–∞
    return HolidayRuleListResponse(
        items=[HolidayRuleOut.from_orm(rule) for rule in rules_orm],
        total=total_rules
    )


@router.delete("/rules/{rule_id}", status_code=204, summary="–£–¥–∞–ª–∏—Ç—å –ø—Ä–∞–≤–∏–ª–æ –∏ —Å–≤—è–∑–∞–Ω–Ω—ã–µ —Å –Ω–∏–º –≤—ã—Ö–æ–¥–Ω—ã–µ")
async def delete_rule(
        rule_id: int,
        db: AsyncSession = Depends(get_db),
        current_user: User = Depends(require_admin)
):
    """–£–¥–∞–ª—è–µ—Ç –ø—Ä–∞–≤–∏–ª–æ. –ë–ª–∞–≥–æ–¥–∞—Ä—è `cascade='all, delete-orphan'`, –≤—Å–µ —Å–æ–∑–¥–∞–Ω–Ω—ã–µ –∏–º –≤—ã—Ö–æ–¥–Ω—ã–µ –±—É–¥—É—Ç —É–¥–∞–ª–µ–Ω—ã –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏."""
    result = await db.execute(select(HolidayRule).filter(HolidayRule.id == rule_id))
    rule = result.scalars().first()
    if not rule:
        raise HTTPException(status_code=404, detail="–ü—Ä–∞–≤–∏–ª–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ.")

    await db.delete(rule)
    await db.commit()
    return None

```



## `api\init_models.py`


```python

# –ü—Ä–∏–º–µ—Ä –¥–ª—è api/init_models.py
from api.database import engine, Base
# ‚úÖ –≠—Ç–æ—Ç –∏–º–ø–æ—Ä—Ç —É–∂–µ –≤–∫–ª—é—á–∞–µ—Ç –Ω–∞—à –Ω–æ–≤—ã–π –∫–ª–∞—Å—Å PromoCodeApplicableType
from api.models import user, equipment, reservation, accessory, promo_code

if __name__ == "__main__":
    Base.metadata.create_all(bind=engine)
    print("‚úÖ FastAPI-–º–æ–¥–µ–ª–∏ —É—Å–ø–µ—à–Ω–æ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω—ã")

```



## `api\main_api.py`


```python

# api/main_api.py

import secrets
import logging # <--- –î–û–ë–ê–í–¨–¢–ï –≠–¢–û–¢ –ò–ú–ü–û–†–¢

from fastapi import FastAPI, Request, Response, HTTPException, status
from fastapi.middleware.cors import CORSMiddleware
from starlette.middleware.base import BaseHTTPMiddleware
from starlette.datastructures import State

from api.router import router as all_routes

# --- CSRF Protection Imports and Setup ---
from fastapi_csrf_protect import CsrfProtect
from fastapi_csrf_protect.exceptions import CsrfProtectError
from pydantic_settings import BaseSettings, SettingsConfigDict
from pydantic import Field
from fastapi.responses import JSONResponse

# --- Rate Limiting Imports ---
from slowapi import Limiter, _rate_limit_exceeded_handler
from slowapi.util import get_remote_address
from slowapi.errors import RateLimitExceeded

# --- –ù–ê–°–¢–†–û–ô–ö–ê –õ–û–ì–ì–ò–†–û–í–ê–ù–ò–Ø ---
logging.basicConfig(level=logging.INFO)
logger = logging.getLogger(__name__)

# --- CSRF Configuration ---
class CsrfSettings(BaseSettings):
    secret_key: str = Field(..., alias="CSRF_SECRET_KEY")
    model_config = SettingsConfigDict(
        env_file=".env",
        env_file_encoding="utf-8",
        extra="ignore"
    )


@CsrfProtect.load_config
def get_csrf_config():
    try:
        settings = CsrfSettings()
        return settings
    except Exception as e:
        logger.critical(
            "–ö–†–ò–¢–ò–ß–ï–°–ö–ê–Ø –û–®–ò–ë–ö–ê: –ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é CSRF. "
            "–£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –ø–µ—Ä–µ–º–µ–Ω–Ω–∞—è CSRF_SECRET_KEY –∑–∞–¥–∞–Ω–∞ –≤ –≤–∞—à–µ–º .env —Ñ–∞–π–ª–µ!"
        )
        raise e

# --- Rate Limiter Configuration ---
limiter = Limiter(key_func=get_remote_address, default_limits=["200/minute"])

# --- FastAPI App Initialization ---
app = FastAPI(title="Rental System API")

# --- Rate Limiter State and Exception Handler ---
app.state.limiter = limiter
app.add_exception_handler(RateLimitExceeded, _rate_limit_exceeded_handler)

# --- CSRF Exception Handler ---
@app.exception_handler(CsrfProtectError)
def csrf_protect_exception_handler(request: Request, exc: CsrfProtectError):
    return JSONResponse(
        status_code=exc.status_code,
        content={"detail": exc.message}
    )

# --- –ù–û–í–ê–Ø MIDDLEWARE –î–õ–Ø –õ–û–ì–ì–ò–†–û–í–ê–ù–ò–Ø –ó–ê–ü–†–û–°–û–í ---
class LoggingMiddleware(BaseHTTPMiddleware):
    async def dispatch(self, request: Request, call_next):
        logger.info(f"Incoming request: {request.method} {request.url.path}")
        response = await call_next(request)
        return response

# --- Secure Headers Middleware ---
class SecureHeadersMiddleware(BaseHTTPMiddleware):
    async def dispatch(self, request: Request, call_next):
        response: Response = await call_next(request)
        response.headers["X-Content-Type-Options"] = "nosniff"
        response.headers["X-Frame-Options"] = "DENY"
        response.headers["Content-Security-Policy"] = (
            "default-src 'self'; "
            "script-src 'self' 'unsafe-inline'; "
            "style-src 'self' 'unsafe-inline'; "
            "object-src 'none'; "
            "frame-ancestors 'none'; "
            "img-src 'self' data:;"
        )
        response.headers["Referrer-Policy"] = "strict-origin-when-cross-origin"
        response.headers["Permissions-Policy"] = "geolocation=(), microphone=(), camera=(), payment=()"
        return response

# --- Add Middlewares ---
app.add_middleware(LoggingMiddleware) # <--- –î–û–ë–ê–í–¨–¢–ï –≠–¢–£ –°–¢–†–û–ö–£

app.add_middleware(
    CORSMiddleware,
    allow_origins=["http://localhost:5173"],
    allow_credentials=True,
    allow_methods=["*"],
    allow_headers=["*", "X-CSRF-Token"],
)
app.add_middleware(SecureHeadersMiddleware)

app.include_router(all_routes)

```



## `api\models\accessory.py`


```python

# api/models/accessory.py

from sqlalchemy import Column, Integer, String, Float, Text, Table, ForeignKey
from sqlalchemy.orm import relationship
from api.database import Base

equipment_accessories_association = Table(
    'equipment_accessories', Base.metadata,
    Column('equipment_id', Integer, ForeignKey('equipment.id'), primary_key=True),
    Column('accessory_id', Integer, ForeignKey('accessories.id'), primary_key=True)
)

class Accessory(Base):
    __tablename__ = "accessories"

    id = Column(Integer, primary_key=True, index=True)
    name = Column(String, nullable=False, index=True)
    accessory_type = Column(String, default="–ü—Ä–æ—á–µ–µ", index=True)
    price = Column(Float, default=0.0)
    description = Column(Text, nullable=True)

    equipment_items = relationship(
        "Equipment",
        secondary=equipment_accessories_association,
        back_populates="accessories"
    )

    # --- –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï –ó–î–ï–°–¨ ---
    # –Ø–≤–Ω–æ —É–∫–∞–∑—ã–≤–∞–µ–º SQLAlchemy, –∫–∞–∫ —ç—Ç–∞ –º–æ–¥–µ–ª—å —Å–≤—è–∑–∞–Ω–∞ —Å —Ç–∞–±–ª–∏—Ü–∞–º–∏-–ø–æ—Å—Ä–µ–¥–Ω–∏–∫–∞–º–∏
    reservation_links = relationship("ReservationAccessory", back_populates="accessory")
    rental_links = relationship("RentalAccessory", back_populates="accessory")
    # -------------------------

    def __repr__(self):
        return f"<Accessory(id={self.id}, name='{self.name}')>"

```



## `api\models\association.py`


```python

# api/models/association.py

from sqlalchemy import Column, Integer, String, Text, Table, ForeignKey
from sqlalchemy.orm import relationship
from api.database import Base

association_equipment_association = Table(
    # V-- –í–ê–ñ–ù–û: –ò–º—è —Ç–∞–±–ª–∏—Ü—ã –≤ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö. –î–∞–≤–∞–π—Ç–µ —Å–¥–µ–ª–∞–µ–º –µ–≥–æ –∫–æ–Ω—Å–∏—Å—Ç–µ–Ω—Ç–Ω—ã–º.
    'association_equipment_association', Base.metadata,
    Column('association_id', Integer, ForeignKey('associations.id'), primary_key=True),
    Column('equipment_id', Integer, ForeignKey('equipment.id'), primary_key=True)
)

class Association(Base):
    __tablename__ = "associations"

    id = Column(Integer, primary_key=True, index=True)
    name = Column(String, nullable=False, unique=True, index=True)
    description = Column(Text, nullable=True)
    sort_order = Column(Integer, default=0, nullable=False)

    # –°–≤—è–∑—å "–º–Ω–æ–≥–∏–µ-–∫–æ-–º–Ω–æ–≥–∏–º" —Å –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏–µ–º
    equipment = relationship(
        "Equipment",
        secondary=association_equipment_association,
        # V-- –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï: –¥–æ–ª–∂–Ω–æ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–æ–≤–∞—Ç—å –∏–º–µ–Ω–∏ –≤ Equipment
        back_populates="associations"
    )

    @property
    def equipment_ids(self) -> list[int]:
        """–í–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Å–ø–∏—Å–æ–∫ ID —Å–≤—è–∑–∞–Ω–Ω–æ–≥–æ –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—è."""
        return [item.id for item in self.equipment] if self.equipment else []

    def __repr__(self):
        return f"<Association(id={self.id}, name='{self.name}')>"

```



## `api\models\balance_history.py`


```python

# api/models/balance_history.py

from sqlalchemy import Column, Integer, String, Float, DateTime, ForeignKey, Text
from sqlalchemy.orm import relationship
from api.database import Base
from datetime import datetime, timezone

class BalanceHistory(Base):
    __tablename__ = "balance_history"

    id = Column(Integer, primary_key=True)
    user_id = Column(Integer, ForeignKey("users.id"), nullable=False)
    # +++ –ò–ó–ú–ï–ù–ï–ù–ò–ï: –î–æ–±–∞–≤–ª—è–µ–º –∫–∞—Å–∫–∞–¥–Ω–æ–µ —É–¥–∞–ª–µ–Ω–∏–µ –Ω–∞ —É—Ä–æ–≤–Ω–µ –ë–î +++
    rental_id = Column(Integer, ForeignKey("rentals.id", ondelete="CASCADE"), nullable=True)

    amount = Column(Float, nullable=False, comment="–°—É–º–º–∞ –æ–ø–µ—Ä–∞—Ü–∏–∏. –û—Ç—Ä–∏—Ü–∞—Ç–µ–ª—å–Ω–∞—è –¥–ª—è —Å–ø–∏—Å–∞–Ω–∏—è, –ø–æ–ª–æ–∂–∏—Ç–µ–ª—å–Ω–∞—è –¥–ª—è –Ω–∞—á–∏—Å–ª–µ–Ω–∏—è.")
    operation_type = Column(String, nullable=False, comment="–¢–∏–ø –æ–ø–µ—Ä–∞—Ü–∏–∏ (e.g., rental_debit, early_return_credit)")
    description = Column(Text, nullable=True, comment="–û–ø–∏—Å–∞–Ω–∏–µ –æ–ø–µ—Ä–∞—Ü–∏–∏")

    created_at = Column(DateTime(timezone=True), default=lambda: datetime.now(timezone.utc))

    # –°–≤—è–∑–∏
    user = relationship("User", back_populates="balance_history")
    rental = relationship("Rental", back_populates="balance_history")

    def __repr__(self):
        return f"<BalanceHistory(id={self.id}, user_id={self.user_id}, amount={self.amount})>"

```



## `api\models\discount.py`


```python

# api/models/discount.py

from sqlalchemy import Column, Integer
from api.database import Base

class DurationDiscount(Base):
    """
    –ú–æ–¥–µ–ª—å –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è –ø–æ—Ä–æ–≥–æ–≤—ã—Ö –∑–Ω–∞—á–µ–Ω–∏–π —Å–∫–∏–¥–æ–∫ –∑–∞ –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å –∞—Ä–µ–Ω–¥—ã.
    –ù–∞–ø—Ä–∏–º–µ—Ä: –æ—Ç 3 –¥–æ 6 –¥–Ω–µ–π - 10% —Å–∫–∏–¥–∫–∞.
    """
    __tablename__ = "duration_discounts"

    id = Column(Integer, primary_key=True)
    min_days = Column(Integer, unique=True, nullable=False, comment="–ú–∏–Ω–∏–º–∞–ª—å–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –¥–Ω–µ–π –¥–ª—è —Å–∫–∏–¥–∫–∏ (–≤–∫–ª—é—á–∏—Ç–µ–ª—å–Ω–æ)")
    discount_percentage = Column(Integer, nullable=False, comment="–ü—Ä–æ—Ü–µ–Ω—Ç —Å–∫–∏–¥–∫–∏")

```



## `api\models\equipment.py`


```python

# api/models/equipment.py

from sqlalchemy import Column, Integer, String, Float, Date, Text, JSON
from sqlalchemy.orm import relationship
from api.database import Base
from api.models.accessory import equipment_accessories_association
from api.models.reservation import reservation_equipment_association
from api.models.promo_code import promo_code_equipment_association
from api.models.association import association_equipment_association

class Equipment(Base):
    __tablename__ = "equipment"

    id = Column(Integer, primary_key=True)
    equipment_type = Column(String, nullable=False)
    brand = Column(String, nullable=False)
    name = Column(String, nullable=False)
    serial_number = Column(String, unique=True)
    condition = Column(String, default="–í–µ–ª–∏–∫–æ–ª–µ–ø–Ω–æ")
    daily_rate = Column(Float, default=0.0)
    notes = Column(String)

    # ‚úÖ –ò–ó–ú–ï–ù–ï–ù–ò–ï: –¢–∏–ø –ø–æ–ª—è –∏–∑–º–µ–Ω–µ–Ω —Å DateTime –Ω–∞ Date
    last_maintenance = Column(Date)

    description = Column(Text)
    image_url = Column(String, nullable=True)
    image_urls = Column(JSON, nullable=True)
    short_description = Column(String, nullable=True)

    accessories = relationship(
        "Accessory",
        secondary=equipment_accessories_association,
        back_populates="equipment_items"
    )

    reservations = relationship(
        "Reservation",
        secondary=reservation_equipment_association,
        back_populates="equipment"
    )

    applicable_promo_codes = relationship(
        "PromoCode",
        secondary=promo_code_equipment_association,
        back_populates="applicable_equipment"
    )

    # –°–≤—è–∑—å –º–Ω–æ–≥–∏–µ-–∫–æ-–º–Ω–æ–≥–∏–º —Å Association
    associations = relationship(
        "Association",
        secondary=association_equipment_association,
        back_populates="equipment"
    )

```



## `api\models\holiday.py`


```python

# api/models/holiday.py

from sqlalchemy import Column, Integer, String, DateTime, Date, ForeignKey, JSON
from sqlalchemy.orm import relationship
from api.database import Base
from datetime import datetime, timezone

# +++ –ù–ê–ß–ê–õ–û: –ù–û–í–ê–Ø –ú–û–î–ï–õ–¨ –î–õ–Ø –ü–†–ê–í–ò–õ +++
class HolidayRule(Base):
    """–ú–æ–¥–µ–ª—å –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è –ø—Ä–∞–≤–∏–ª –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ —Å–æ–∑–¥–∞–Ω–∏—è –≤—ã—Ö–æ–¥–Ω—ã—Ö."""
    __tablename__ = "holiday_rules"

    id = Column(Integer, primary_key=True)
    rule_type = Column(String, nullable=False, comment="–¢–∏–ø –ø—Ä–∞–≤–∏–ª–∞, –Ω–∞–ø—Ä–∏–º–µ—Ä 'weekly' –∏–ª–∏ 'public_import'")
    parameters = Column(JSON, nullable=False, comment="–ü–∞—Ä–∞–º–µ—Ç—Ä—ã –ø—Ä–∞–≤–∏–ª–∞, –Ω–∞–ø—Ä–∏–º–µ—Ä {'day_of_week': 6} –¥–ª—è –≤–æ—Å–∫—Ä–µ—Å–µ–Ω—å—è")
    description = Column(String, nullable=False, comment="–û–ø–∏—Å–∞–Ω–∏–µ –ø—Ä–∞–≤–∏–ª–∞ –¥–ª—è –∞–¥–º–∏–Ω–∞")
    created_at = Column(DateTime(timezone=True), default=lambda: datetime.now(timezone.utc))
    created_by_id = Column(Integer, ForeignKey("users.id"), nullable=False)

    creator = relationship("User")
    # –°–≤—è–∑—å –¥–ª—è –∫–∞—Å–∫–∞–¥–Ω–æ–≥–æ —É–¥–∞–ª–µ–Ω–∏—è –≤—Å–µ—Ö –≤—ã—Ö–æ–¥–Ω—ã—Ö, —Å–æ–∑–¥–∞–Ω–Ω—ã—Ö —ç—Ç–∏–º –ø—Ä–∞–≤–∏–ª–æ–º
    holidays = relationship("Holiday", back_populates="rule", cascade="all, delete-orphan")
# +++ –ö–û–ù–ï–¶: –ù–û–í–ê–Ø –ú–û–î–ï–õ–¨ –î–õ–Ø –ü–†–ê–í–ò–õ +++


class Holiday(Base):
    __tablename__ = "holidays"

    date = Column(Date, primary_key=True, index=True, comment="–î–∞—Ç–∞ –≤—ã—Ö–æ–¥–Ω–æ–≥–æ –¥–Ω—è")
    description = Column(String, nullable=True, comment="–ù–∞–∑–≤–∞–Ω–∏–µ (–Ω–∞–ø—Ä–∏–º–µ—Ä, –ù–æ–≤—ã–π –≥–æ–¥)")
    created_at = Column(DateTime(timezone=True), default=lambda: datetime.now(timezone.utc))
    created_by_id = Column(Integer, ForeignKey("users.id"), nullable=False)

    # +++ –ù–ê–ß–ê–õ–û: –ò–ó–ú–ï–ù–ï–ù–ò–Ø –í –ú–û–î–ï–õ–ò HOLIDAY +++
    rule_id = Column(Integer, ForeignKey("holiday_rules.id"), nullable=True, comment="ID –ø—Ä–∞–≤–∏–ª–∞, –∫–æ—Ç–æ—Ä—ã–º —Å–æ–∑–¥–∞–Ω —ç—Ç–æ—Ç –≤—ã—Ö–æ–¥–Ω–æ–π")
    rule = relationship("HolidayRule", back_populates="holidays")
    # +++ –ö–û–ù–ï–¶: –ò–ó–ú–ï–ù–ï–ù–ò–Ø –í –ú–û–î–ï–õ–ò HOLIDAY +++

    creator = relationship("User")

    def __repr__(self):
        return f"<Holiday(date='{self.date.strftime('%Y-%m-%d')}', description='{self.description}')>"

```



## `api\models\payment.py`


```python

# api/models/payment.py

from sqlalchemy import (Column, Integer, String, Float, DateTime,
                        ForeignKey, Text)
from sqlalchemy.orm import relationship
from api.database import Base
from datetime import datetime, timezone

class Payment(Base):
    __tablename__ = "payments"

    id = Column(Integer, primary_key=True)
    user_id = Column(Integer, ForeignKey("users.id"), nullable=False)
    # +++ –ò–ó–ú–ï–ù–ï–ù–ò–ï: –î–æ–±–∞–≤–ª—è–µ–º –∫–∞—Å–∫–∞–¥–Ω–æ–µ —É–¥–∞–ª–µ–Ω–∏–µ –Ω–∞ —É—Ä–æ–≤–Ω–µ –ë–î +++
    rental_id = Column(Integer, ForeignKey("rentals.id", ondelete="CASCADE"), nullable=True)
    amount = Column(Float, nullable=False)

    payment_date = Column(DateTime(timezone=True), default=lambda: datetime.now(timezone.utc))

    payment_method = Column(String)
    transaction_type = Column(String, nullable=False)  # e.g., 'rental_payment', 'deposit', 'refund'
    description = Column(Text, nullable=True)

    user = relationship("User")
    rental = relationship("Rental", back_populates="payments")

```



## `api\models\promo_code.py`


```python

# api/models/promo_code.py

from sqlalchemy import (Column, Integer, String, Float, DateTime, Boolean,
                        ForeignKey, Table, Text)
from sqlalchemy.orm import relationship
from api.database import Base
# ‚úÖ –ò–º–ø–æ—Ä—Ç–∏—Ä—É–µ–º timezone
from datetime import datetime, timezone

# –ü—Ä–æ–º–µ–∂—É—Ç–æ—á–Ω–∞—è —Ç–∞–±–ª–∏—Ü–∞ –¥–ª—è –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–π –ø—Ä–æ–º–æ–∫–æ–¥–æ–≤ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º–∏
promo_code_usages = Table(
    'promo_code_usages', Base.metadata,
    Column('user_id', Integer, ForeignKey('users.id'), primary_key=True),
    Column('promo_code_id', Integer, ForeignKey('promo_codes.id'), primary_key=True),
    # ‚úÖ –ò–ó–ú–ï–ù–ï–ù–ò–ï: –î–æ–±–∞–≤–ª—è–µ–º timezone=True
    Column('used_at', DateTime(timezone=True), default=lambda: datetime.now(timezone.utc))
)

# –ê—Å—Å–æ—Ü–∏–∞—Ç–∏–≤–Ω–∞—è —Ç–∞–±–ª–∏—Ü–∞ –¥–ª—è —Å–≤—è–∑–∏ –ø—Ä–æ–º–æ–∫–æ–¥–∞ —Å ID –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—è
promo_code_equipment_association = Table(
    'promo_code_equipment', Base.metadata,
    Column('promo_code_id', Integer, ForeignKey('promo_codes.id'), primary_key=True),
    Column('equipment_id', Integer, ForeignKey('equipment.id'), primary_key=True)
)

class PromoCode(Base):
    """
    –ú–æ–¥–µ–ª—å –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è –ø—Ä–æ–º–æ–∫–æ–¥–æ–≤ –∏ –∏—Ö —É—Å–ª–æ–≤–∏–π.
    """
    __tablename__ = "promo_codes"

    id = Column(Integer, primary_key=True, index=True)
    code = Column(String, unique=True, index=True, nullable=False)
    description = Column(Text, nullable=True, comment="–ö—Ä–∞—Ç–∫–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ –¥–ª—è –º–µ–Ω–µ–¥–∂–µ—Ä–æ–≤")
    discount_percentage = Column(Float, nullable=False)

    # --- –°—Ç–∞—Ç—É—Å—ã –∏ —Å—Ä–æ–∫–∏ ---
    is_active = Column(Boolean, default=True)
    # ‚úÖ –ò–ó–ú–ï–ù–ï–ù–ò–ï: –î–æ–±–∞–≤–ª—è–µ–º timezone=True
    valid_from = Column(DateTime(timezone=True), nullable=True, comment="–î–∞—Ç–∞ –Ω–∞—á–∞–ª–∞ –¥–µ–π—Å—Ç–≤–∏—è")
    # ‚úÖ –ò–ó–ú–ï–ù–ï–ù–ò–ï: –î–æ–±–∞–≤–ª—è–µ–º timezone=True
    expires_at = Column(DateTime(timezone=True), nullable=True, comment="–î–∞—Ç–∞ –∏—Å—Ç–µ—á–µ–Ω–∏—è —Å—Ä–æ–∫–∞")

    # --- –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è ---
    max_uses = Column(Integer, nullable=True, comment="–û–±—â–∏–π –ª–∏–º–∏—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–π")
    times_used = Column(Integer, default=0, nullable=False)
    max_uses_per_user = Column(Integer, nullable=True, comment="–õ–∏–º–∏—Ç –Ω–∞ –æ–¥–Ω–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è")

    # --- –£—Å–ª–æ–≤–∏—è –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è ---
    min_order_amount = Column(Float, nullable=True, comment="–ú–∏–Ω–∏–º–∞–ª—å–Ω–∞—è —Å—É–º–º–∞ –∑–∞–∫–∞–∑–∞ –¥–ª—è –∞–∫—Ç–∏–≤–∞—Ü–∏–∏")
    specific_to_user_id = Column(Integer, ForeignKey("users.id"), nullable=True, comment="–ï—Å–ª–∏ –∫–æ–¥ –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã–π")

    # --- –ú–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ ---
    # ‚úÖ –ò–ó–ú–ï–ù–ï–ù–ò–ï: –î–æ–±–∞–≤–ª—è–µ–º timezone=True
    created_at = Column(DateTime(timezone=True), default=lambda: datetime.now(timezone.utc))
    created_by_id = Column(Integer, ForeignKey("users.id"))

    # --- –°–≤—è–∑–∏ ---
    creator = relationship("User", foreign_keys=[created_by_id])
    specific_user = relationship("User", foreign_keys=[specific_to_user_id])

    used_by_users = relationship(
        "User",
        secondary=promo_code_usages,
        back_populates="used_promo_codes"
    )

    applicable_equipment = relationship(
        "Equipment",
        secondary=promo_code_equipment_association,
        back_populates="applicable_promo_codes",
        lazy="joined"
    )

    applicable_types = relationship(
        "PromoCodeApplicableType",
        back_populates="promo_code",
        cascade="all, delete-orphan",
        lazy="joined"
    )

    # --- –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–µ —Å–≤–æ–π—Å—Ç–≤–∞ ---
    @property
    def applicable_to_equipment_ids(self) -> list[int]:
        return [item.id for item in self.applicable_equipment] if self.applicable_equipment else []

    @property
    def applicable_to_equipment_types(self) -> list[str]:
        return [item.type_name for item in self.applicable_types] if self.applicable_types else []

    def __repr__(self):
        return f"<PromoCode(code='{self.code}', discount={self.discount_percentage}%)>"


# –ú–æ–¥–µ–ª—å-–ø–æ—Å—Ä–µ–¥–Ω–∏–∫ –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è —Ç–∏–ø–æ–≤ –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—è
class PromoCodeApplicableType(Base):
    __tablename__ = 'promo_code_applicable_types'
    promo_code_id = Column(Integer, ForeignKey('promo_codes.id'), primary_key=True)
    type_name = Column(String, primary_key=True)

    promo_code = relationship("PromoCode", back_populates="applicable_types")

```



## `api\models\rental.py`


```python

# api/models/rental.py

from sqlalchemy import (Column, Integer, DateTime, ForeignKey, Float,
                        String, Text, Table, Boolean, Date)
from sqlalchemy.orm import relationship
from api.database import Base
from datetime import datetime, timezone

class RentalAccessory(Base):
    __tablename__ = 'rental_accessories'
    rental_id = Column(Integer, ForeignKey('rentals.id', ondelete="CASCADE"), primary_key=True)
    equipment_id = Column(Integer, ForeignKey('equipment.id'), primary_key=True)
    accessory_id = Column(Integer, ForeignKey('accessories.id'), primary_key=True)

    accessory = relationship("Accessory", back_populates="rental_links")
    rental = relationship("Rental", back_populates="accessory_links")

rental_equipment_association = Table('rental_equipment', Base.metadata,
                                     Column('rental_id', Integer, ForeignKey('rentals.id', ondelete="CASCADE"), primary_key=True),
                                     Column('equipment_id', Integer, ForeignKey('equipment.id'), primary_key=True)
                                     )

class Rental(Base):
    __tablename__ = "rentals"

    id = Column(Integer, primary_key=True)
    user_id = Column(Integer, ForeignKey("users.id"), nullable=False)
    created_by_id = Column(Integer, ForeignKey("users.id"), nullable=False)
    reservation_id = Column(Integer, ForeignKey("reservations.id"), nullable=True, unique=True)
    start_date = Column(Date, nullable=False)
    end_date = Column(Date, nullable=False)
    actual_return_date = Column(Date, nullable=True)
    status = Column(String, default="active", nullable=False, index=True)
    total_cost = Column(Float, nullable=False, default=0.0)
    discount_amount = Column(Float, nullable=False, default=0.0)
    promo_code = Column(String, nullable=True)
    final_cost = Column(Float, nullable=True)
    deposit_amount = Column(Float, default=0.0)
    prepayment_amount = Column(Float, nullable=False, default=0.0)  # –°—É–º–º–∞ –ø—Ä–µ–¥–æ–ø–ª–∞—Ç—ã, –≤–Ω–µ—Å–µ–Ω–Ω–∞—è –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –∞—Ä–µ–Ω–¥—ã
    notes_on_issue = Column(Text, nullable=True)
    notes_on_return = Column(Text, nullable=True)
    created_at = Column(DateTime(timezone=True), default=lambda: datetime.now(timezone.utc))
    updated_at = Column(DateTime(timezone=True), default=lambda: datetime.now(timezone.utc), onupdate=lambda: datetime.now(timezone.utc))

    user = relationship("User", foreign_keys=[user_id], back_populates="rentals")
    created_by = relationship("User", foreign_keys=[created_by_id])

    # --- –ù–ê–ß–ê–õ–û –ò–°–ü–†–ê–í–õ–ï–ù–ò–ô ---
    # –£–±–∏—Ä–∞–µ–º —É–ø—Ä–∞–≤–ª—è—é—â–∏–µ –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏ `cascade` –∏ `single_parent` —Å–æ —Å—Ç–æ—Ä–æ–Ω—ã "–ø–æ—Ç–æ–º–∫–∞".
    # –¢–µ–ø–µ—Ä—å —ç—Ç–∞ —Å–≤—è–∑—å —è–≤–ª—è–µ—Ç—Å—è –ø—Ä–æ—Å—Ç–æ –æ–±—Ä–∞—Ç–Ω–æ–π —Å—Å—ã–ª–∫–æ–π.
    reservation = relationship("Reservation", back_populates="rental")
    # --- –ö–û–ù–ï–¶ –ò–°–ü–†–ê–í–õ–ï–ù–ò–ô ---

    equipment = relationship("Equipment", secondary=rental_equipment_association)
    balance_history = relationship("BalanceHistory", back_populates="rental", cascade="all, delete-orphan")
    payments = relationship("Payment", back_populates="rental", cascade="all, delete-orphan")
    accessory_links = relationship(
        "RentalAccessory",
        back_populates="rental",
        cascade="all, delete-orphan",
        lazy="joined"
    )

    def __repr__(self):
        return f"<Rental(id={self.id}, user_id={self.user_id}, status='{self.status}')>"

```



## `api\models\reservation.py`


```python

# api/models/reservation.py

from sqlalchemy import Column, Integer, DateTime, ForeignKey, Table, Float, String, Date
from sqlalchemy.orm import relationship
from api.database import Base
from typing import Optional, Dict, List
from datetime import datetime, timezone

reservation_equipment_association = Table('reservation_equipment', Base.metadata,
                                          Column('reservation_id', Integer, ForeignKey('reservations.id'), primary_key=True),
                                          Column('equipment_id', Integer, ForeignKey('equipment.id'), primary_key=True)
                                          )

class ReservationAccessory(Base):
    __tablename__ = 'reservation_accessories'
    reservation_id = Column(Integer, ForeignKey('reservations.id'), primary_key=True)
    equipment_id = Column(Integer, ForeignKey('equipment.id'), primary_key=True)
    accessory_id = Column(Integer, ForeignKey('accessories.id'), primary_key=True)

    # --- –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï –ó–î–ï–°–¨ ---
    accessory = relationship("Accessory", back_populates="reservation_links")
    reservation = relationship("Reservation", back_populates="accessory_links")
    # -------------------------

class Reservation(Base):
    __tablename__ = "reservations"

    id = Column(Integer, primary_key=True)
    user_id = Column(Integer, ForeignKey("users.id"), nullable=False)
    start_date = Column(Date, nullable=False)
    end_date = Column(Date, nullable=False)
    status = Column(String, default='active', nullable=False, index=True)
    promo_code_id = Column(Integer, ForeignKey("promo_codes.id"), nullable=True)
    total_cost = Column(Float, nullable=False, default=0.0)
    discount_amount = Column(Float, nullable=False, default=0.0)
    created_at = Column(DateTime(timezone=True), default=lambda: datetime.now(timezone.utc))

    user = relationship("User", back_populates="reservations")
    applied_promo_code = relationship("PromoCode")
    equipment = relationship(
        "Equipment",
        secondary=reservation_equipment_association,
        back_populates="reservations",
        lazy="joined"
    )
    # --- –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï –ó–î–ï–°–¨ ---
    accessory_links = relationship(
        "ReservationAccessory",
        back_populates="reservation",
        cascade="all, delete-orphan",
        lazy="joined"
    )
    # -------------------------
    rental = relationship("Rental", back_populates="reservation", uselist=False, cascade="all, delete-orphan", single_parent=True)

    @property
    def equipment_ids(self) -> list[int]:
        return [item.id for item in self.equipment] if self.equipment else []

    @property
    def selected_accessories(self) -> Dict[int, List[int]]:
        grouped_accessories: Dict[int, List[int]] = {}
        if not self.accessory_links:
            return {}
        for link in self.accessory_links:
            if link.equipment_id not in grouped_accessories:
                grouped_accessories[link.equipment_id] = []
            grouped_accessories[link.equipment_id].append(link.accessory_id)
        return grouped_accessories

    @property
    def promo_code(self) -> Optional[str]:
        return self.applied_promo_code.code if self.applied_promo_code else None

```



## `api\models\user.py`


```python

# api/models/user.py

from sqlalchemy import (Column, Integer, String, Boolean, DateTime,
                        Float, Text)
from sqlalchemy.orm import relationship
from api.database import Base
from datetime import datetime, timezone

class User(Base):
    __tablename__ = "users"

    id = Column(Integer, primary_key=True)
    full_name = Column(String, nullable=False)
    email = Column(String, unique=True, index=True, nullable=False)
    hashed_password = Column(String)
    role = Column(String, default="user") # user, manager, admin

    created_at = Column(DateTime(timezone=True), default=lambda: datetime.now(timezone.utc))

    is_active = Column(Boolean, default=True)
    phone = Column(String)
    status = Column(String, default="–ê–∫—Ç–∏–≤–Ω—ã–π")
    balance = Column(Float, default=0.0)
    notes = Column(Text)

    privacy_policy_accepted = Column(Boolean, default=False)
    terms_accepted = Column(Boolean, default=False)
    email_verified = Column(Boolean, default=False)

    # –°—É—â–µ—Å—Ç–≤—É—é—â–∏–µ —Å–≤—è–∑–∏
    reservations = relationship("Reservation", back_populates="user")
    used_promo_codes = relationship(
        "PromoCode",
        secondary="promo_code_usages",
        back_populates="used_by_users"
    )

    # +++ –ù–û–í–´–ï –°–í–Ø–ó–ò +++
    rentals = relationship("Rental", foreign_keys="[Rental.user_id]", back_populates="user", cascade="all, delete-orphan")
    balance_history = relationship("BalanceHistory", back_populates="user", cascade="all, delete-orphan")

```



## `api\permissions.py`


```python

# api/permissions.py
from fastapi import Depends, HTTPException
from api.deps import get_current_user
from api.models.user import User

# –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç —Ä–æ–ª–µ–π: user < manager < admin
ROLE_PRIORITY = {"user": 0, "manager": 1, "admin": 2}

def require_user(user: User = Depends(get_current_user)):
    # –õ—é–±–æ–π –∑–∞–ª–æ–≥–∏–Ω–µ–Ω–Ω—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å
    if not user.is_active:
        raise HTTPException(status_code=403, detail="–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ–∞–∫—Ç–∏–≤–µ–Ω")
    return user

def require_manager(user: User = Depends(get_current_user)):
    # –ú–µ–Ω–µ–¥–∂–µ—Ä –∏ –≤—ã—à–µ
    if ROLE_PRIORITY.get(user.role, 0) < ROLE_PRIORITY["manager"]:
        raise HTTPException(status_code=403, detail="–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –ø—Ä–∞–≤ (—Ç—Ä–µ–±—É–µ—Ç—Å—è manager –∏–ª–∏ admin)")
    return user

def require_admin(user: User = Depends(get_current_user)):
    # –¢–æ–ª—å–∫–æ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä
    if user.role != "admin":
        raise HTTPException(status_code=403, detail="–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –ø—Ä–∞–≤ (—Ç—Ä–µ–±—É–µ—Ç—Å—è admin)")
    return user

```



## `api\promo_code_api.py`


```python

# api/promo_code_api.py

from fastapi import APIRouter, Depends, HTTPException, status, Query
from sqlalchemy.ext.asyncio import AsyncSession
from sqlalchemy import select, func
from sqlalchemy.orm import selectinload
from typing import List

from api.deps import get_db
from api.permissions import require_manager
from api.services.auth_service import get_user_by_token
from api.models.user import User
from shared.schemas.promo_code_schema import (
    PromoCodeCreate, PromoCodeUpdate, PromoCodeOut,
    PromoCodeValidateRequest, PromoCodeValidateResponse,
    PromoCodeListResponse
)
from fastapi.security import OAuth2PasswordBearer
from fastapi_csrf_protect import CsrfProtect
from api.services.promo_code import PromoCodeManager, PromoCodeBusinessLogic

router = APIRouter(prefix="/promocodes", tags=["–ü—Ä–æ–º–æ–∫–æ–¥—ã"])
optional_oauth2_scheme = OAuth2PasswordBearer(tokenUrl="/auth/token", auto_error=False)


@router.post("/", response_model=PromoCodeOut, status_code=status.HTTP_201_CREATED)
async def create_promo_code(
        promo_in: PromoCodeCreate,
        db: AsyncSession = Depends(get_db),
        current_user: User = Depends(require_manager),
        _csrf_protect: CsrfProtect = Depends()
):
    """
    –°–æ–∑–¥–∞–µ—Ç –Ω–æ–≤—ã–π –ø—Ä–æ–º–æ–∫–æ–¥. (–ú–µ–Ω–µ–¥–∂–µ—Ä—ã <= 20%, –ê–¥–º–∏–Ω—ã <= 50%)
    """
    try:
        manager = PromoCodeManager(db)
        new_promo_code = await manager.create_promo_code(promo_in, current_user)
        return PromoCodeOut.from_orm(new_promo_code)
    except HTTPException:
        raise
    except Exception as e:
        raise HTTPException(status_code=status.HTTP_500_INTERNAL_SERVER_ERROR, detail=str(e))


@router.get("/", response_model=PromoCodeListResponse)
async def get_all_promo_codes(
        db: AsyncSession = Depends(get_db),
        _current_user: User = Depends(require_manager),
        skip: int = Query(0, ge=0, description="–°–∫–æ–ª—å–∫–æ –∑–∞–ø–∏—Å–µ–π –ø—Ä–æ–ø—É—Å—Ç–∏—Ç—å"),
        limit: int = Query(10, ge=1, le=100, description="–ú–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∑–∞–ø–∏—Å–µ–π –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–µ")
):
    """–ü–æ–ª—É—á–∏—Ç—å —Å–ø–∏—Å–æ–∫ –≤—Å–µ—Ö –ø—Ä–æ–º–æ–∫–æ–¥–æ–≤ —Å –ø–∞–≥–∏–Ω–∞—Ü–∏–µ–π (—Ç–æ–ª—å–∫–æ –¥–ª—è –º–µ–Ω–µ–¥–∂–µ—Ä–æ–≤/–∞–¥–º–∏–Ω–æ–≤)"""
    try:
        manager = PromoCodeManager(db)
        promo_codes = await manager.get_all_promo_codes()
        
        # –ü—Ä–∏–º–µ–Ω—è–µ–º –ø–∞–≥–∏–Ω–∞—Ü–∏—é –∫ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—É
        total_promo_codes = len(promo_codes)
        paginated_promo_codes = promo_codes[skip:skip + limit]
        
        return PromoCodeListResponse(
            items=[PromoCodeOut.from_orm(pc) for pc in paginated_promo_codes],
            total=total_promo_codes
        )
    except Exception as e:
        raise HTTPException(status_code=status.HTTP_500_INTERNAL_SERVER_ERROR, detail=str(e))


@router.get("/generate/new-code", response_model=dict)
async def generate_promo_code(
        db: AsyncSession = Depends(get_db),
        _current_user: User = Depends(require_manager)
):
    """–ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç —É–Ω–∏–∫–∞–ª—å–Ω—ã–π –∫–æ–¥ –ø—Ä–æ–º–æ–∫–æ–¥–∞"""
    try:
        manager = PromoCodeManager(db)
        generated_code = await manager.generate_unique_code()
        return {"generated_code": generated_code}
    except Exception as e:
        raise HTTPException(status_code=status.HTTP_500_INTERNAL_SERVER_ERROR, detail=str(e))


@router.put("/{promo_code_id}", response_model=PromoCodeOut)
async def update_promo_code(
        promo_code_id: int,
        promo_in: PromoCodeUpdate,
        db: AsyncSession = Depends(get_db),
        _current_user: User = Depends(require_manager),
        _csrf_protect: CsrfProtect = Depends()
):
    """–û–±–Ω–æ–≤–ª—è–µ—Ç —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π –ø—Ä–æ–º–æ–∫–æ–¥ (—Ç–æ–ª—å–∫–æ –¥–ª—è –º–µ–Ω–µ–¥–∂–µ—Ä–æ–≤/–∞–¥–º–∏–Ω–æ–≤)."""
    try:
        manager = PromoCodeManager(db)
        updated_promo_code = await manager.update_promo_code(promo_code_id, promo_in)
        return PromoCodeOut.from_orm(updated_promo_code)
    except HTTPException:
        raise
    except Exception as e:
        raise HTTPException(status_code=status.HTTP_500_INTERNAL_SERVER_ERROR, detail=str(e))


@router.delete("/{promo_code_id}", status_code=status.HTTP_204_NO_CONTENT)
async def delete_promo_code(
        promo_code_id: int,
        db: AsyncSession = Depends(get_db),
        _current_user: User = Depends(require_manager),
        _csrf_protect: CsrfProtect = Depends()
):
    """–£–¥–∞–ª—è–µ—Ç –ø—Ä–æ–º–æ–∫–æ–¥"""
    try:
        manager = PromoCodeManager(db)
        await manager.delete_promo_code(promo_code_id)
        return None
    except HTTPException:
        raise
    except Exception as e:
        raise HTTPException(status_code=status.HTTP_500_INTERNAL_SERVER_ERROR, detail=str(e))


@router.post("/validate", response_model=PromoCodeValidateResponse)
async def validate_promo_code_endpoint(
        request: PromoCodeValidateRequest,
        db: AsyncSession = Depends(get_db),
        token: str = Depends(optional_oauth2_scheme)
):
    """
    –ü—Ä–æ–≤–µ—Ä—è–µ—Ç –≤–∞–ª–∏–¥–Ω–æ—Å—Ç—å –ø—Ä–æ–º–æ–∫–æ–¥–∞ —Å —É—á–µ—Ç–æ–º –≤—Å–µ—Ö —É—Å–ª–æ–≤–∏–π.
    """
    try:
        current_user = await get_user_by_token(db, token) if token else None
        business_logic = PromoCodeBusinessLogic(db)
        
        promo_code = await business_logic.validate_and_get_promo_code(
            code=request.code,
            order_amount=request.order_amount,
            equipment_ids=request.equipment_ids,
            user=current_user
        )
        
        return await business_logic.create_validation_response(promo_code)
    except HTTPException:
        raise
    except Exception as e:
        raise HTTPException(status_code=status.HTTP_500_INTERNAL_SERVER_ERROR, detail=str(e))

```



## `api\reservation_api.py`


```python

# api/reservation_api.py

from fastapi import APIRouter, Depends, HTTPException, Query
from sqlalchemy.ext.asyncio import AsyncSession
from typing import List, Optional

from api.services.order.order_lifecycle_service import OrderLifecycleService
from api.services.reservation_query_service import ReservationQueryService
from shared.schemas.reservation_schema import (
    ReservationCreateRequest, ReservationUpdateRequest, ReservationResponse,
    ReservationItem, ReservationListResponse, PriceCalculationRequest, PriceCalculationResponse
)
from api.permissions import require_user
from api.models.user import User
from api.models.promo_code import PromoCode
from api.deps import get_db, get_order_lifecycle_service, get_reservation_query_service
from fastapi_csrf_protect import CsrfProtect

from api.services.financial_service import FinancialService
from api.services.promo_code_service import validate_promo_code_for_use
from api.services.discount_service import get_duration_discount_percentage


router = APIRouter(prefix="/reservations", tags=["–†–µ–∑–µ—Ä–≤—ã (–¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π)"])

@router.post("/", response_model=ReservationResponse)
async def create_reservation(
        request: ReservationCreateRequest,
        current_user: User = Depends(require_user),
        csrf_protect: CsrfProtect = Depends(),
        service: OrderLifecycleService = Depends(get_order_lifecycle_service)
):
    """–°–æ–∑–¥–∞—Ç—å —Ä–µ–∑–µ—Ä–≤ –¥–ª—è —Ç–µ–∫—É—â–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è."""
    new_reservation = await service.create_user_reservation(request, current_user)
    return ReservationResponse(reservation_id=new_reservation.id, message="–†–µ–∑–µ—Ä–≤ —É—Å–ø–µ—à–Ω–æ —Å–æ–∑–¥–∞–Ω")

@router.get("/", response_model=ReservationListResponse)
async def get_user_reservations(
        current_user: User = Depends(require_user),
        query_service: ReservationQueryService = Depends(get_reservation_query_service),
        status: Optional[str] = Query(None, description="–§–∏–ª—å—Ç—Ä –ø–æ —Å—Ç–∞—Ç—É—Å—É: active, completed, overdue"),
        search: Optional[str] = Query(None, description="–ü–æ–∏—Å–∫ –ø–æ –Ω–∞–∑–≤–∞–Ω–∏—é, –±—Ä–µ–Ω–¥—É –∏–ª–∏ —Ç–∏–ø—É –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—è"),
        sort: Optional[str] = Query(None, description="–°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞: id_desc, id_asc, start_date_desc, start_date_asc, end_date_desc, end_date_asc, count_desc, count_asc"),
        skip: int = Query(0, ge=0, description="–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –∑–∞–ø–∏—Å–µ–π –¥–ª—è –ø—Ä–æ–ø—É—Å–∫–∞"),
        limit: int = Query(100, ge=1, le=100, description="–ú–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∑–∞–ø–∏—Å–µ–π –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–µ")
):
    """–ü–æ–ª—É—á–∏—Ç—å –æ—Ç—Ñ–∏–ª—å—Ç—Ä–æ–≤–∞–Ω–Ω—ã–π –∏ –ø–∞–≥–∏–Ω–∏—Ä–æ–≤–∞–Ω–Ω—ã–π —Å–ø–∏—Å–æ–∫ —Å–≤–æ–∏—Ö —Ä–µ–∑–µ—Ä–≤–æ–≤."""
    items, total = await query_service.get_my_reservations(
        current_user, status, search, sort, skip, limit
    )
    return ReservationListResponse(items=items, total=total)

@router.delete("/{reservation_id}")
async def delete_reservation(
        reservation_id: int,
        current_user: User = Depends(require_user),
        csrf_protect: CsrfProtect = Depends(),
        service: OrderLifecycleService = Depends(get_order_lifecycle_service)
):
    """–£–¥–∞–ª–∏—Ç—å —Å–≤–æ–π —Ä–µ–∑–µ—Ä–≤."""
    await service.cancel_user_reservation(reservation_id, current_user)
    return {"message": "–†–µ–∑–µ—Ä–≤ —É–¥–∞–ª—ë–Ω"}

@router.put("/{reservation_id}", response_model=ReservationResponse)
async def update_reservation(
        reservation_id: int,
        data: ReservationUpdateRequest,
        current_user: User = Depends(require_user),
        csrf_protect: CsrfProtect = Depends(),
        service: OrderLifecycleService = Depends(get_order_lifecycle_service)
):
    """–û–±–Ω–æ–≤–∏—Ç—å —Å–≤–æ–π —Ä–µ–∑–µ—Ä–≤."""
    updated_reservation = await service.update_user_reservation(reservation_id, data, current_user)
    return ReservationResponse(reservation_id=updated_reservation.id, message="–†–µ–∑–µ—Ä–≤ —É—Å–ø–µ—à–Ω–æ –æ–±–Ω–æ–≤–ª—ë–Ω")

@router.post("/calculate", response_model=PriceCalculationResponse)
async def calculate_price(
        request: PriceCalculationRequest,
        db: AsyncSession = Depends(get_db)
):
    """–†–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ—Ç —Å—Ç–æ–∏–º–æ—Å—Ç—å —Ä–µ–∑–µ—Ä–≤–∞ –±–µ–∑ –µ–≥–æ —Å–æ–∑–¥–∞–Ω–∏—è."""
    financial_service = FinancialService(db)
    financial_service.validate_date_range(request.start_date, request.end_date)
    promo_code_obj: Optional[PromoCode] = None
    promo_message: Optional[str] = None

    preliminary_price_details = await financial_service.calculate_final_price(
        request.equipment_ids, request.selected_accessories,
        request.start_date, request.end_date, None
    )

    if request.promo_code:
        try:
            promo_code_obj = await validate_promo_code_for_use(
                db, request.promo_code, preliminary_price_details.full_total,
                request.equipment_ids, None
            )
            promo_message = "–ü—Ä–æ–º–æ–∫–æ–¥ —É—Å–ø–µ—à–Ω–æ –ø—Ä–∏–º–µ–Ω–µ–Ω!"
        except HTTPException as e:
            promo_message = e.detail

    final_price_details = await financial_service.calculate_final_price(
        request.equipment_ids, request.selected_accessories,
        request.start_date, request.end_date, promo_code_obj
    )

    day_count = await financial_service.get_rental_days(request.start_date, request.end_date)
    promo_discount = promo_code_obj.discount_percentage if promo_code_obj else 0

    return PriceCalculationResponse(
        day_count=day_count,
        full_total=final_price_details.full_total,
        final_total=final_price_details.final_total,
        discount_amount=final_price_details.discount_amount,
        duration_discount_percentage=await get_duration_discount_percentage(db, day_count),
        promo_discount_percentage=promo_discount,
        promo_code_message=promo_message
    )

```



## `api\router.py`


```python

# api/router.py

from fastapi import APIRouter
from api.auth_api import router as auth_router
from api.equipment_api import router as equipment_router
from api.reservation_api import router as reservation_router
from api.user_api import router as user_router
from api.calendar_api import router as calendar_router
from api.accessory_api import router as accessory_router
from api.admin_reservation_api import router as admin_reservation_router
from api.promo_code_api import router as promo_code_router
from api.holiday_api import router as holiday_router
from api.discount_api import router as discount_router
from api.association_api import router as association_router
from api.admin_rental_api import router as admin_rental_router
from api.admin_dashboard_api import router as admin_dashboard_router

router = APIRouter()

router.include_router(auth_router)
router.include_router(equipment_router)
router.include_router(reservation_router)
router.include_router(user_router)
router.include_router(calendar_router)
router.include_router(accessory_router)
router.include_router(admin_reservation_router)
router.include_router(promo_code_router)
router.include_router(holiday_router)
router.include_router(discount_router)
router.include_router(association_router)
router.include_router(admin_rental_router)
router.include_router(admin_dashboard_router)

# –°—Ç–∞—Ä—ã–µ —Å–µ—Ä–≤–∏—Å—ã –±—ã–ª–∏ —É–¥–∞–ª–µ–Ω—ã, –ø–æ—ç—Ç–æ–º—É –Ω–∏–∫–∞–∫–∏—Ö –∏–∑–º–µ–Ω–µ–Ω–∏–π –≤ —Ä–æ—É—Ç–µ—Ä–µ –Ω–µ —Ç—Ä–µ–±—É–µ—Ç—Å—è,
# —Ç–∞–∫ –∫–∞–∫ –æ–Ω –ø–æ–¥–∫–ª—é—á–∞–µ—Ç —Ç–æ–ª—å–∫–æ API-—Å–ª–æ–π (–Ω–∞–ø—Ä–∏–º–µ—Ä, admin_rental_api),
# –∞ –≤–Ω—É—Ç—Ä–µ–Ω–Ω–∏–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ —ç—Ç–∏—Ö API —É–∂–µ –∏–∑–º–µ–Ω–µ–Ω—ã.

```



## `api\services\auth_service.py`


```python

# api/services/auth_service.py

from api.models.user import User
from passlib.context import CryptContext
from jose import JWTError, jwt
from sqlalchemy.ext.asyncio import AsyncSession
from sqlalchemy import select
from shared.schemas.user_schema import UserCreate
from datetime import datetime, timedelta
from config.secrets import SECRET_KEY
from fastapi import HTTPException
import logging

ALGORITHM = "HS256"
ACCESS_TOKEN_EXPIRE_MINUTES = 60
pwd_context = CryptContext(schemes=["bcrypt"], deprecated="auto")


def hash_password(password: str) -> str:
    return pwd_context.hash(password)


def verify_password(plain: str, hashed: str) -> bool:
    return pwd_context.verify(plain, hashed)


async def create_user(db: AsyncSession, user_data: UserCreate) -> User:
    try:
        result = await db.execute(select(User).filter(User.email == user_data.email))
        existing = result.scalars().first()
        if existing:
            raise HTTPException(status_code=409, detail="Email —É–∂–µ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω")

        # <<< –ò–ó–ú–ï–ù–ï–ù–ò–ï: –î–æ–±–∞–≤–ª—è–µ–º 'phone' –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è >>>
        user = User(
            full_name=user_data.full_name,
            email=user_data.email,
            hashed_password=hash_password(user_data.password),
            phone=user_data.phone,  # <--- –ù–æ–≤–æ–µ –ø–æ–ª–µ
            role="user",
            is_active=True,
            status="–ê–∫—Ç–∏–≤–Ω—ã–π",
            balance=0.0,
            notes="–°–æ–∑–¥–∞–Ω –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø—Ä–∏ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏",
            # +++ –ù–û–í–´–ï –ü–û–õ–Ø +++
            privacy_policy_accepted=user_data.privacy_policy_accepted,
            terms_accepted=user_data.terms_accepted,
            email_verified=True  # –ü—Ä–∏ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ email —Å—á–∏—Ç–∞–µ—Ç—Å—è –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–Ω—ã–º
        )
        db.add(user)
        await db.commit()
        
        # –ü–æ–≤—Ç–æ—Ä–Ω–æ –ø–æ–ª—É—á–∞–µ–º –æ–±—ä–µ–∫—Ç –∏–∑ –ë–î
        result = await db.execute(select(User).filter(User.id == user.id))
        return result.scalars().first()
    except HTTPException as http_exc:
        db.rollback()
        raise http_exc
    except Exception as e:
        db.rollback()
        logging.exception(f"[‚ùå create_user] –û—à–∏–±–∫–∞ –ø—Ä–∏ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏: {e}")
        raise HTTPException(status_code=500, detail="–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞ –ø—Ä–∏ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏")


async def authenticate_user(db: AsyncSession, email: str, password: str) -> User | None:
    result = await db.execute(select(User).filter(User.email == email))
    user = result.scalars().first()
    if user and verify_password(password, user.hashed_password):
        return user
    return None


def create_access_token(data: dict, expires_delta: timedelta = None):
    to_encode = data.copy()
    expire = datetime.utcnow() + (expires_delta or timedelta(minutes=ACCESS_TOKEN_EXPIRE_MINUTES))
    to_encode.update({"exp": expire})
    return jwt.encode(to_encode, SECRET_KEY, algorithm=ALGORITHM)


async def get_user_by_token(db: AsyncSession, token: str) -> User | None:
    try:
        payload = jwt.decode(token, SECRET_KEY, algorithms=[ALGORITHM])
        email: str = payload.get("sub")
        if email is None:
            return None
    except JWTError:
        return None
    result = await db.execute(select(User).filter(User.email == email))
    return result.scalars().first()

```



## `api\services\availability\availability_service.py`


```python

# api/services/availability/availability_service.py

from sqlalchemy.ext.asyncio import AsyncSession
from datetime import date
from typing import List, Dict, Any, Optional

from .conflicts import AvailabilityConflictsService
from .statuses import AvailabilityStatusService
from .calendar import AvailabilityCalendarService
from .queries import AvailabilityQueryService


class AvailabilityService:
    """
    –ì–ª–∞–≤–Ω—ã–π —Ñ–∞—Å–∞–¥ –¥–ª—è —Å–µ—Ä–≤–∏—Å–æ–≤ –ø—Ä–æ–≤–µ—Ä–∫–∏ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏ –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—è.
    –û–±—ä–µ–¥–∏–Ω—è–µ—Ç –≤—Å–µ —Å–ø–µ—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ —Å–µ—Ä–≤–∏—Å—ã –≤ –µ–¥–∏–Ω—ã–π –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å.
    –ï–¥–∏–Ω—Å—Ç–≤–µ–Ω–Ω—ã–π –∏—Å—Ç–æ—á–Ω–∏–∫ –ø—Ä–∞–≤–¥—ã –¥–ª—è –≤—Å–µ—Ö –ø—Ä–æ–≤–µ—Ä–æ–∫ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏ –≤ —Å–∏—Å—Ç–µ–º–µ.
    """

    def __init__(self, db: AsyncSession):
        self.db = db
        
        # –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º —Å–ø–µ—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ —Å–µ—Ä–≤–∏—Å—ã
        self._conflicts_service = AvailabilityConflictsService(db)
        self._status_service = AvailabilityStatusService(db)
        self._calendar_service = AvailabilityCalendarService(db)
        self._query_service = AvailabilityQueryService(db)

    # === –ú–ï–¢–û–î–´ –î–õ–Ø –†–ê–ë–û–¢–´ –° –ö–û–ù–§–õ–ò–ö–¢–ê–ú–ò ===
    
    async def get_conflicts(
        self,
        equipment_ids: List[int],
        start_date: date,
        end_date: date,
        exclude_reservation_id: Optional[int] = None,
        exclude_rental_id: Optional[int] = None
    ) -> Dict[int, List[Dict[str, Any]]]:
        """
        –û—Å–Ω–æ–≤–Ω–æ–π –º–µ—Ç–æ–¥ –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –≤—Å–µ—Ö –∫–æ–Ω—Ñ–ª–∏–∫—Ç–æ–≤ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏ –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—è.
        
        Args:
            equipment_ids: –°–ø–∏—Å–æ–∫ ID –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—è –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏
            start_date: –î–∞—Ç–∞ –Ω–∞—á–∞–ª–∞ –ø–µ—Ä–∏–æ–¥–∞
            end_date: –î–∞—Ç–∞ –æ–∫–æ–Ω—á–∞–Ω–∏—è –ø–µ—Ä–∏–æ–¥–∞ (–≤–∫–ª—é—á–∏—Ç–µ–ª—å–Ω–æ)
            exclude_reservation_id: ID —Ä–µ–∑–µ—Ä–≤–∏—Ä–æ–≤–∞–Ω–∏—è –¥–ª—è –∏—Å–∫–ª—é—á–µ–Ω–∏—è –∏–∑ –ø—Ä–æ–≤–µ—Ä–∫–∏
            exclude_rental_id: ID –∞—Ä–µ–Ω–¥—ã –¥–ª—è –∏—Å–∫–ª—é—á–µ–Ω–∏—è –∏–∑ –ø—Ä–æ–≤–µ—Ä–∫–∏
            
        Returns:
            –°–ª–æ–≤–∞—Ä—å, –≥–¥–µ –∫–ª—é—á - ID –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—è, –∑–Ω–∞—á–µ–Ω–∏–µ - —Å–ø–∏—Å–æ–∫ –∫–æ–Ω—Ñ–ª–∏–∫—Ç–æ–≤
        """
        return await self._conflicts_service.get_conflicts(
            equipment_ids, start_date, end_date, exclude_reservation_id, exclude_rental_id
        )

    async def get_conflicting_equipment_ids(
        self,
        equipment_ids: List[int],
        start_date: date,
        end_date: date,
        exclude_reservation_id: Optional[int] = None,
        exclude_rental_id: Optional[int] = None
    ) -> List[int]:
        """
        –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Å–ø–∏—Å–æ–∫ ID –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—è, —É –∫–æ—Ç–æ—Ä–æ–≥–æ –µ—Å—Ç—å –∫–æ–Ω—Ñ–ª–∏–∫—Ç—ã –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏.
        
        Args:
            equipment_ids: –°–ø–∏—Å–æ–∫ ID –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—è –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏
            start_date: –î–∞—Ç–∞ –Ω–∞—á–∞–ª–∞ –ø–µ—Ä–∏–æ–¥–∞
            end_date: –î–∞—Ç–∞ –æ–∫–æ–Ω—á–∞–Ω–∏—è –ø–µ—Ä–∏–æ–¥–∞
            exclude_reservation_id: ID —Ä–µ–∑–µ—Ä–≤–∏—Ä–æ–≤–∞–Ω–∏—è –¥–ª—è –∏—Å–∫–ª—é—á–µ–Ω–∏—è
            exclude_rental_id: ID –∞—Ä–µ–Ω–¥—ã –¥–ª—è –∏—Å–∫–ª—é—á–µ–Ω–∏—è
            
        Returns:
            –°–ø–∏—Å–æ–∫ ID –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—è —Å –∫–æ–Ω—Ñ–ª–∏–∫—Ç–∞–º–∏
        """
        return await self._conflicts_service.get_conflicting_equipment_ids(
            equipment_ids, start_date, end_date, exclude_reservation_id, exclude_rental_id
        )

    # === –ú–ï–¢–û–î–´ –î–õ–Ø –†–ê–ë–û–¢–´ –°–û –°–¢–ê–¢–£–°–ê–ú–ò ===
    
    async def get_availability_statuses(
        self,
        equipment_ids: List[int],
        start_date: date,
        end_date: date,
        exclude_reservation_id: Optional[int] = None,
        exclude_rental_id: Optional[int] = None
    ) -> Dict[int, Dict[str, Any]]:
        """
        –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Å—Ç–∞—Ç—É—Å—ã –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏ –¥–ª—è —Å–ø–∏—Å–∫–∞ –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—è.
        
        Args:
            equipment_ids: –°–ø–∏—Å–æ–∫ ID –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—è –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏
            start_date: –î–∞—Ç–∞ –Ω–∞—á–∞–ª–∞ –ø–µ—Ä–∏–æ–¥–∞
            end_date: –î–∞—Ç–∞ –æ–∫–æ–Ω—á–∞–Ω–∏—è –ø–µ—Ä–∏–æ–¥–∞
            exclude_reservation_id: ID —Ä–µ–∑–µ—Ä–≤–∏—Ä–æ–≤–∞–Ω–∏—è –¥–ª—è –∏—Å–∫–ª—é—á–µ–Ω–∏—è
            exclude_rental_id: ID –∞—Ä–µ–Ω–¥—ã –¥–ª—è –∏—Å–∫–ª—é—á–µ–Ω–∏—è
            
        Returns:
            –°–ª–æ–≤–∞—Ä—å —Å–æ —Å—Ç–∞—Ç—É—Å–∞–º–∏ –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—è
        """
        return await self._status_service.get_availability_statuses(
            equipment_ids, start_date, end_date, exclude_reservation_id, exclude_rental_id
        )

    async def get_daily_statuses(
        self,
        equipment_ids: List[int],
        start_date: date,
        end_date: date,
        exclude_reservation_id: Optional[int] = None,
        exclude_rental_id: Optional[int] = None,
        current_user_id: Optional[int] = None
    ) -> Dict[int, Dict[str, Any]]:
        """
        –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Å—Ç–∞—Ç—É—Å—ã –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—è –ø–æ –¥–Ω—è–º –¥–ª—è –∫–∞–ª–µ–Ω–¥–∞—Ä–Ω–æ–≥–æ –ø—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω–∏—è.
        
        Args:
            equipment_ids: –°–ø–∏—Å–æ–∫ ID –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—è –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏
            start_date: –î–∞—Ç–∞ –Ω–∞—á–∞–ª–∞ –ø–µ—Ä–∏–æ–¥–∞
            end_date: –î–∞—Ç–∞ –æ–∫–æ–Ω—á–∞–Ω–∏—è –ø–µ—Ä–∏–æ–¥–∞
            exclude_reservation_id: ID —Ä–µ–∑–µ—Ä–≤–∏—Ä–æ–≤–∞–Ω–∏—è –¥–ª—è –∏—Å–∫–ª—é—á–µ–Ω–∏—è
            exclude_rental_id: ID –∞—Ä–µ–Ω–¥—ã –¥–ª—è –∏—Å–∫–ª—é—á–µ–Ω–∏—è
            current_user_id: ID —Ç–µ–∫—É—â–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –¥–ª—è –≤—ã–¥–µ–ª–µ–Ω–∏—è –µ–≥–æ —Ä–µ–∑–µ—Ä–≤–∏—Ä–æ–≤–∞–Ω–∏–π
            
        Returns:
            –°–ª–æ–≤–∞—Ä—å —Å–æ —Å—Ç–∞—Ç—É—Å–∞–º–∏ –ø–æ –¥–Ω—è–º
        """
        return await self._status_service.get_daily_statuses(
            equipment_ids, start_date, end_date, exclude_reservation_id, exclude_rental_id, current_user_id
        )

    # === –ú–ï–¢–û–î–´ –î–õ–Ø –†–ê–ë–û–¢–´ –° –ö–ê–õ–ï–ù–î–ê–†–ï–ú ===
    
    async def get_calendar_events(
        self,
        equipment_ids: List[int],
        start_date: date,
        end_date: date
    ) -> List[Dict[str, Any]]:
        """
        –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Å–æ–±—ã—Ç–∏—è –¥–ª—è –∫–∞–ª–µ–Ω–¥–∞—Ä—è –≤ —Ñ–æ—Ä–º–∞—Ç–µ FullCalendar.
        
        Args:
            equipment_ids: –°–ø–∏—Å–æ–∫ ID –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—è
            start_date: –î–∞—Ç–∞ –Ω–∞—á–∞–ª–∞ –ø–µ—Ä–∏–æ–¥–∞
            end_date: –î–∞—Ç–∞ –æ–∫–æ–Ω—á–∞–Ω–∏—è –ø–µ—Ä–∏–æ–¥–∞
            
        Returns:
            –°–ø–∏—Å–æ–∫ —Å–æ–±—ã—Ç–∏–π –¥–ª—è –∫–∞–ª–µ–Ω–¥–∞—Ä—è
        """
        return await self._calendar_service.get_calendar_events(
            equipment_ids, start_date, end_date
        )

    # === –ú–ï–¢–û–î–´ –î–õ–Ø –†–ê–ë–û–¢–´ –° SQL-–ó–ê–ü–†–û–°–ê–ú–ò ===
    
    def get_sqlalchemy_filter_for_available_equipment(
        self,
        start_date: date,
        end_date: date,
        exclude_reservation_id: Optional[int] = None,
        exclude_rental_id: Optional[int] = None
    ):
        """
        –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç SQLAlchemy —Ñ–∏–ª—å—Ç—Ä –¥–ª—è –∏—Å–∫–ª—é—á–µ–Ω–∏—è –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–æ–≥–æ –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—è.
        –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–ª—è –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏ –∑–∞–ø—Ä–æ—Å–æ–≤ –≤ EquipmentQueryBuilder.
        
        Args:
            start_date: –î–∞—Ç–∞ –Ω–∞—á–∞–ª–∞ –ø–µ—Ä–∏–æ–¥–∞
            end_date: –î–∞—Ç–∞ –æ–∫–æ–Ω—á–∞–Ω–∏—è –ø–µ—Ä–∏–æ–¥–∞
            exclude_reservation_id: ID —Ä–µ–∑–µ—Ä–≤–∏—Ä–æ–≤–∞–Ω–∏—è –¥–ª—è –∏—Å–∫–ª—é—á–µ–Ω–∏—è
            exclude_rental_id: ID –∞—Ä–µ–Ω–¥—ã –¥–ª—è –∏—Å–∫–ª—é—á–µ–Ω–∏—è
            
        Returns:
            SQLAlchemy BinaryExpression –¥–ª—è —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏
        """
        return self._query_service.get_sqlalchemy_filter_for_available_equipment(
            start_date, end_date, exclude_reservation_id, exclude_rental_id
        )

```



## `api\services\availability\base.py`


```python

# api/services/availability/base.py

from sqlalchemy.ext.asyncio import AsyncSession
from sqlalchemy.orm import selectinload
from sqlalchemy import select
from datetime import date
from typing import List, Dict, Any, Optional
import logging

from api.models.reservation import Reservation
from api.models.equipment import Equipment
from api.models.rental import Rental

logger = logging.getLogger(__name__)


class AvailabilityBaseService:
    """
    –ë–∞–∑–æ–≤—ã–π –∫–ª–∞—Å—Å –¥–ª—è —Å–µ—Ä–≤–∏—Å–æ–≤ –ø—Ä–æ–≤–µ—Ä–∫–∏ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏ –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—è.
    –°–æ–¥–µ—Ä–∂–∏—Ç –æ–±—â—É—é –ª–æ–≥–∏–∫—É –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å —Ä–µ–∑–µ—Ä–≤–∏—Ä–æ–≤–∞–Ω–∏—è–º–∏ –∏ –∞—Ä–µ–Ω–¥–∞–º–∏.
    """

    def __init__(self, db: AsyncSession):
        self.db = db

    async def _get_overlapping_reservations(
        self,
        equipment_ids: List[int],
        start_date: date,
        end_date: date,
        exclude_reservation_id: Optional[int] = None
    ) -> List[Reservation]:
        """
        –ü–æ–ª—É—á–∞–µ—Ç —Ä–µ–∑–µ—Ä–≤–∏—Ä–æ–≤–∞–Ω–∏—è, –ø–µ—Ä–µ—Å–µ–∫–∞—é—â–∏–µ—Å—è —Å —É–∫–∞–∑–∞–Ω–Ω—ã–º –ø–µ—Ä–∏–æ–¥–æ–º.
        
        Args:
            equipment_ids: –°–ø–∏—Å–æ–∫ ID –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—è –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏
            start_date: –î–∞—Ç–∞ –Ω–∞—á–∞–ª–∞ –ø–µ—Ä–∏–æ–¥–∞
            end_date: –î–∞—Ç–∞ –æ–∫–æ–Ω—á–∞–Ω–∏—è –ø–µ—Ä–∏–æ–¥–∞
            exclude_reservation_id: ID —Ä–µ–∑–µ—Ä–≤–∏—Ä–æ–≤–∞–Ω–∏—è –¥–ª—è –∏—Å–∫–ª—é—á–µ–Ω–∏—è
            
        Returns:
            –°–ø–∏—Å–æ–∫ —Ä–µ–∑–µ—Ä–≤–∏—Ä–æ–≤–∞–Ω–∏–π, –ø–µ—Ä–µ—Å–µ–∫–∞—é—â–∏—Ö—Å—è —Å –ø–µ—Ä–∏–æ–¥–æ–º
        """
        query = select(Reservation).options(
            selectinload(Reservation.equipment)
        ).filter(
            Reservation.end_date > start_date,
            Reservation.start_date < end_date,
            Reservation.status == 'active'
        ).where(
            Reservation.equipment.any(Equipment.id.in_(equipment_ids))
        )
        
        if exclude_reservation_id:
            query = query.filter(Reservation.id != exclude_reservation_id)
            
        result = await self.db.execute(query)
        return result.unique().scalars().all()

    async def _get_overlapping_rentals(
        self,
        equipment_ids: List[int],
        start_date: date,
        end_date: date,
        exclude_rental_id: Optional[int] = None
    ) -> List[Rental]:
        """
        –ü–æ–ª—É—á–∞–µ—Ç –∞—Ä–µ–Ω–¥—ã, –ø–µ—Ä–µ—Å–µ–∫–∞—é—â–∏–µ—Å—è —Å —É–∫–∞–∑–∞–Ω–Ω—ã–º –ø–µ—Ä–∏–æ–¥–æ–º.
        
        Args:
            equipment_ids: –°–ø–∏—Å–æ–∫ ID –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—è –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏
            start_date: –î–∞—Ç–∞ –Ω–∞—á–∞–ª–∞ –ø–µ—Ä–∏–æ–¥–∞
            end_date: –î–∞—Ç–∞ –æ–∫–æ–Ω—á–∞–Ω–∏—è –ø–µ—Ä–∏–æ–¥–∞
            exclude_rental_id: ID –∞—Ä–µ–Ω–¥—ã –¥–ª—è –∏—Å–∫–ª—é—á–µ–Ω–∏—è
            
        Returns:
            –°–ø–∏—Å–æ–∫ –∞—Ä–µ–Ω–¥, –ø–µ—Ä–µ—Å–µ–∫–∞—é—â–∏—Ö—Å—è —Å –ø–µ—Ä–∏–æ–¥–æ–º
        """
        query = select(Rental).options(
            selectinload(Rental.equipment)
        ).filter(
            Rental.end_date > start_date,
            Rental.start_date < end_date,
            Rental.status.in_(['active', 'overdue'])
        ).where(
            Rental.equipment.any(Equipment.id.in_(equipment_ids))
        )
        
        if exclude_rental_id:
            query = query.filter(Rental.id != exclude_rental_id)
            
        result = await self.db.execute(query)
        return result.unique().scalars().all()

    def _filter_equipment_in_list(
        self,
        equipment_list: List[Equipment],
        equipment_ids: List[int]
    ) -> List[Equipment]:
        """
        –§–∏–ª—å—Ç—Ä—É–µ—Ç –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏–µ –ø–æ —Å–ø–∏—Å–∫—É ID.
        
        Args:
            equipment_list: –°–ø–∏—Å–æ–∫ –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—è –¥–ª—è —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏
            equipment_ids: –°–ø–∏—Å–æ–∫ ID –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—è –¥–ª—è –≤–∫–ª—é—á–µ–Ω–∏—è
            
        Returns:
            –û—Ç—Ñ–∏–ª—å—Ç—Ä–æ–≤–∞–Ω–Ω—ã–π —Å–ø–∏—Å–æ–∫ –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—è
        """
        return [eq for eq in equipment_list if eq.id in equipment_ids]

    def _create_conflict_dict(
        self,
        conflict_type: str,
        conflict_id: int,
        start_date: date,
        end_date: date,
        user_id: int
    ) -> Dict[str, Any]:
        """
        –°–æ–∑–¥–∞–µ—Ç —Å–ª–æ–≤–∞—Ä—å —Å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–µ–π –æ –∫–æ–Ω—Ñ–ª–∏–∫—Ç–µ.
        
        Args:
            conflict_type: –¢–∏–ø –∫–æ–Ω—Ñ–ª–∏–∫—Ç–∞ ('reservation' –∏–ª–∏ 'rental')
            conflict_id: ID –∫–æ–Ω—Ñ–ª–∏–∫—Ç–∞
            start_date: –î–∞—Ç–∞ –Ω–∞—á–∞–ª–∞
            end_date: –î–∞—Ç–∞ –æ–∫–æ–Ω—á–∞–Ω–∏—è
            user_id: ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
            
        Returns:
            –°–ª–æ–≤–∞—Ä—å —Å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–µ–π –æ –∫–æ–Ω—Ñ–ª–∏–∫—Ç–µ
        """
        return {
            'type': conflict_type,
            'id': conflict_id,
            'start_date': start_date,
            'end_date': end_date,
            'user_id': user_id
        }

```



## `api\services\availability\calendar.py`


```python

# api/services/availability/calendar.py

from sqlalchemy.orm import selectinload, joinedload
from sqlalchemy import select
from datetime import date
from typing import List, Dict, Any

from .base import AvailabilityBaseService
from api.models.rental import Rental 
from api.models.reservation import Reservation


class AvailabilityCalendarService(AvailabilityBaseService):
    """
    –°–µ—Ä–≤–∏—Å –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –∫–∞–ª–µ–Ω–¥–∞—Ä–Ω—ã–º–∏ —Å–æ–±—ã—Ç–∏—è–º–∏.
    –û—Ç–≤–µ—á–∞–µ—Ç –∑–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏—é —Å–æ–±—ã—Ç–∏–π –¥–ª—è FullCalendar –∏ –¥—Ä—É–≥–∏—Ö –∫–∞–ª–µ–Ω–¥–∞—Ä–Ω—ã—Ö –ø—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω–∏–π.
    """

    async def get_calendar_events(
        self,
        equipment_ids: List[int],
        start_date: date,
        end_date: date
    ) -> List[Dict[str, Any]]:
        """
        –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Å–æ–±—ã—Ç–∏—è –¥–ª—è –∫–∞–ª–µ–Ω–¥–∞—Ä—è –≤ —Ñ–æ—Ä–º–∞—Ç–µ FullCalendar.
        
        Args:
            equipment_ids: –°–ø–∏—Å–æ–∫ ID –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—è
            start_date: –î–∞—Ç–∞ –Ω–∞—á–∞–ª–∞ –ø–µ—Ä–∏–æ–¥–∞
            end_date: –î–∞—Ç–∞ –æ–∫–æ–Ω—á–∞–Ω–∏—è –ø–µ—Ä–∏–æ–¥–∞
            
        Returns:
            –°–ø–∏—Å–æ–∫ —Å–æ–±—ã—Ç–∏–π –¥–ª—è –∫–∞–ª–µ–Ω–¥–∞—Ä—è
        """
        events = []

        # 1. –ò—Å–ø–æ–ª—å–∑—É–µ–º –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–Ω—ã–π –º–µ—Ç–æ–¥ –∏–∑ –±–∞–∑–æ–≤–æ–≥–æ –∫–ª–∞—Å—Å–∞ –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –∞—Ä–µ–Ω–¥
        rentals = await self._get_overlapping_rentals(equipment_ids, start_date, end_date)
        for rental in rentals:
            for equipment in rental.equipment:
                # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏–µ –∏–∑ –∞—Ä–µ–Ω–¥—ã –µ—Å—Ç—å –≤ –Ω–∞—à–µ–º –∑–∞–ø—Ä–æ—Å–µ
                if equipment.id in equipment_ids:
                    events.append({
                        "id": f"rental-{rental.id}-{equipment.id}",
                        "title": f"–ê—Ä–µ–Ω–¥–∞: {equipment.name}",
                        "start": rental.start_date.strftime("%Y-%m-%d"),
                        "end": rental.end_date.strftime("%Y-%m-%d"),
                        "resourceId": equipment.id,
                        "status": "rented"
                    })
        
        # 2. –ò—Å–ø–æ–ª—å–∑—É–µ–º –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–Ω—ã–π –º–µ—Ç–æ–¥ –∏–∑ –±–∞–∑–æ–≤–æ–≥–æ –∫–ª–∞—Å—Å–∞ –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è —Ä–µ–∑–µ—Ä–≤–æ–≤
        reservations = await self._get_overlapping_reservations(equipment_ids, start_date, end_date)
        for reservation in reservations:
            # –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ –∑–∞–≥—Ä—É–∂–∞–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è, –µ—Å–ª–∏ —ç—Ç–æ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ
            await self.db.refresh(reservation, attribute_names=['user'])
            for equipment in reservation.equipment:
                # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏–µ –∏–∑ —Ä–µ–∑–µ—Ä–≤–∞ –µ—Å—Ç—å –≤ –Ω–∞—à–µ–º –∑–∞–ø—Ä–æ—Å–µ
                if equipment.id in equipment_ids:
                    events.append({
                        "id": f"reservation-{reservation.id}-{equipment.id}",
                        "title": f"–†–µ–∑–µ—Ä–≤: {reservation.user.full_name}",
                        "start": reservation.start_date.strftime("%Y-%m-%d"),
                        "end": reservation.end_date.strftime("%Y-%m-%d"),
                        "resourceId": equipment.id,
                        "status": "reserved"
                    })
        
        return events


```



## `api\services\availability\conflicts.py`


```python

# api/services/availability/conflicts.py

from datetime import date
from typing import List, Dict, Any, Optional

from .base import AvailabilityBaseService


class AvailabilityConflictsService(AvailabilityBaseService):
    """
    –°–µ—Ä–≤–∏—Å –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –∫–æ–Ω—Ñ–ª–∏–∫—Ç–∞–º–∏ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏ –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—è.
    –û—Ç–≤–µ—á–∞–µ—Ç –∑–∞ –ø–æ–∏—Å–∫ –∏ –∞–Ω–∞–ª–∏–∑ –∫–æ–Ω—Ñ–ª–∏–∫—Ç–æ–≤ –º–µ–∂–¥—É —Ä–µ–∑–µ—Ä–≤–∏—Ä–æ–≤–∞–Ω–∏—è–º–∏ –∏ –∞—Ä–µ–Ω–¥–∞–º–∏.
    """

    async def get_conflicts(
        self,
        equipment_ids: List[int],
        start_date: date,
        end_date: date,
        exclude_reservation_id: Optional[int] = None,
        exclude_rental_id: Optional[int] = None
    ) -> Dict[int, List[Dict[str, Any]]]:
        """
        –û—Å–Ω–æ–≤–Ω–æ–π –º–µ—Ç–æ–¥ –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –≤—Å–µ—Ö –∫–æ–Ω—Ñ–ª–∏–∫—Ç–æ–≤ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏ –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—è.
        
        Args:
            equipment_ids: –°–ø–∏—Å–æ–∫ ID –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—è –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏
            start_date: –î–∞—Ç–∞ –Ω–∞—á–∞–ª–∞ –ø–µ—Ä–∏–æ–¥–∞
            end_date: –î–∞—Ç–∞ –æ–∫–æ–Ω—á–∞–Ω–∏—è –ø–µ—Ä–∏–æ–¥–∞ (–≤–∫–ª—é—á–∏—Ç–µ–ª—å–Ω–æ)
            exclude_reservation_id: ID —Ä–µ–∑–µ—Ä–≤–∏—Ä–æ–≤–∞–Ω–∏—è –¥–ª—è –∏—Å–∫–ª—é—á–µ–Ω–∏—è –∏–∑ –ø—Ä–æ–≤–µ—Ä–∫–∏
            exclude_rental_id: ID –∞—Ä–µ–Ω–¥—ã –¥–ª—è –∏—Å–∫–ª—é—á–µ–Ω–∏—è –∏–∑ –ø—Ä–æ–≤–µ—Ä–∫–∏
            
        Returns:
            –°–ª–æ–≤–∞—Ä—å, –≥–¥–µ –∫–ª—é—á - ID –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—è, –∑–Ω–∞—á–µ–Ω–∏–µ - —Å–ø–∏—Å–æ–∫ –∫–æ–Ω—Ñ–ª–∏–∫—Ç–æ–≤
        """
        conflicts: Dict[int, List[Dict[str, Any]]] = {}
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ —Å–ø–∏—Å–æ–∫ –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—è –Ω–µ –ø—É—Å—Ç–æ–π
        if not equipment_ids:
            return conflicts
        
        # –ü–æ–ª—É—á–∞–µ–º –ø–µ—Ä–µ—Å–µ–∫–∞—é—â–∏–µ—Å—è —Ä–µ–∑–µ—Ä–≤–∏—Ä–æ–≤–∞–Ω–∏—è
        overlapping_reservations = await self._get_overlapping_reservations(
            equipment_ids, start_date, end_date, exclude_reservation_id
        )
        
        # –ü–æ–ª—É—á–∞–µ–º –ø–µ—Ä–µ—Å–µ–∫–∞—é—â–∏–µ—Å—è –∞—Ä–µ–Ω–¥—ã
        overlapping_rentals = await self._get_overlapping_rentals(
            equipment_ids, start_date, end_date, exclude_rental_id
        )
        
        # –û–±—Ä–∞–±–æ—Ç–∫–∞ —Ä–µ–∑–µ—Ä–≤–∏—Ä–æ–≤–∞–Ω–∏–π
        for reservation in overlapping_reservations:
            for equipment in reservation.equipment:
                if equipment.id in equipment_ids:
                    if equipment.id not in conflicts:
                        conflicts[equipment.id] = []
                    
                    conflict_dict = self._create_conflict_dict(
                        'reservation',
                        reservation.id,
                        reservation.start_date,
                        reservation.end_date,
                        reservation.user_id
                    )
                    conflicts[equipment.id].append(conflict_dict)
        
        # –û–±—Ä–∞–±–æ—Ç–∫–∞ –∞—Ä–µ–Ω–¥
        for rental in overlapping_rentals:
            for equipment in rental.equipment:
                if equipment.id in equipment_ids:
                    if equipment.id not in conflicts:
                        conflicts[equipment.id] = []
                    
                    conflict_dict = self._create_conflict_dict(
                        'rental',
                        rental.id,
                        rental.start_date,
                        rental.end_date,
                        rental.user_id
                    )
                    conflicts[equipment.id].append(conflict_dict)
        
        return conflicts

    async def get_conflicting_equipment_ids(
        self,
        equipment_ids: List[int],
        start_date: date,
        end_date: date,
        exclude_reservation_id: Optional[int] = None,
        exclude_rental_id: Optional[int] = None
    ) -> List[int]:
        """
        –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Å–ø–∏—Å–æ–∫ ID –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—è, —É –∫–æ—Ç–æ—Ä–æ–≥–æ –µ—Å—Ç—å –∫–æ–Ω—Ñ–ª–∏–∫—Ç—ã –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏.
        
        Args:
            equipment_ids: –°–ø–∏—Å–æ–∫ ID –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—è –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏
            start_date: –î–∞—Ç–∞ –Ω–∞—á–∞–ª–∞ –ø–µ—Ä–∏–æ–¥–∞
            end_date: –î–∞—Ç–∞ –æ–∫–æ–Ω—á–∞–Ω–∏—è –ø–µ—Ä–∏–æ–¥–∞
            exclude_reservation_id: ID —Ä–µ–∑–µ—Ä–≤–∏—Ä–æ–≤–∞–Ω–∏—è –¥–ª—è –∏—Å–∫–ª—é—á–µ–Ω–∏—è
            exclude_rental_id: ID –∞—Ä–µ–Ω–¥—ã –¥–ª—è –∏—Å–∫–ª—é—á–µ–Ω–∏—è
            
        Returns:
            –°–ø–∏—Å–æ–∫ ID –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—è —Å –∫–æ–Ω—Ñ–ª–∏–∫—Ç–∞–º–∏
        """
        conflicts = await self.get_conflicts(
            equipment_ids, start_date, end_date, exclude_reservation_id, exclude_rental_id
        )
        return list(conflicts.keys())

    def _get_most_critical_conflict(
        self,
        conflict_list: List[Dict[str, Any]]
    ) -> Optional[Dict[str, Any]]:
        """
        –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç –Ω–∞–∏–±–æ–ª–µ–µ –∫—Ä–∏—Ç–∏—á–Ω—ã–π –∫–æ–Ω—Ñ–ª–∏–∫—Ç –∏–∑ —Å–ø–∏—Å–∫–∞.
        –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç: rental > reservation.
        
        Args:
            conflict_list: –°–ø–∏—Å–æ–∫ –∫–æ–Ω—Ñ–ª–∏–∫—Ç–æ–≤
            
        Returns:
            –ù–∞–∏–±–æ–ª–µ–µ –∫—Ä–∏—Ç–∏—á–Ω—ã–π –∫–æ–Ω—Ñ–ª–∏–∫—Ç –∏–ª–∏ None
        """
        if not conflict_list:
            return None
        
        # –°–æ—Ä—Ç–∏—Ä—É–µ–º –∫–æ–Ω—Ñ–ª–∏–∫—Ç—ã –ø–æ –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç—É: rental > reservation
        sorted_conflicts = sorted(
            conflict_list, 
            key=lambda c: (c['type'] != 'rental', c['type'] != 'reservation')
        )
        return sorted_conflicts[0]

```



## `api\services\availability\queries.py`


```python

# api/services/availability/queries.py

from sqlalchemy import select, and_
from datetime import date
from typing import Optional

from .base import AvailabilityBaseService
from api.models.equipment import Equipment
from api.models.reservation import Reservation
from api.models.rental import Rental


class AvailabilityQueryService(AvailabilityBaseService):
    """
    –°–µ—Ä–≤–∏—Å –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å SQL-–∑–∞–ø—Ä–æ—Å–∞–º–∏ –∏ —Ñ–∏–ª—å—Ç—Ä–∞–º–∏.
    –û—Ç–≤–µ—á–∞–µ—Ç –∑–∞ —Å–æ–∑–¥–∞–Ω–∏–µ –æ–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö SQL-–∑–∞–ø—Ä–æ—Å–æ–≤ –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏.
    """

    def get_sqlalchemy_filter_for_available_equipment(
        self,
        start_date: date,
        end_date: date,
        exclude_reservation_id: Optional[int] = None,
        exclude_rental_id: Optional[int] = None
    ):
        """
        –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç SQLAlchemy —Ñ–∏–ª—å—Ç—Ä –¥–ª—è –∏—Å–∫–ª—é—á–µ–Ω–∏—è –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–æ–≥–æ –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—è.
        –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–ª—è –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏ –∑–∞–ø—Ä–æ—Å–æ–≤ –≤ EquipmentQueryBuilder.
        
        Args:
            start_date: –î–∞—Ç–∞ –Ω–∞—á–∞–ª–∞ –ø–µ—Ä–∏–æ–¥–∞
            end_date: –î–∞—Ç–∞ –æ–∫–æ–Ω—á–∞–Ω–∏—è –ø–µ—Ä–∏–æ–¥–∞
            exclude_reservation_id: ID —Ä–µ–∑–µ—Ä–≤–∏—Ä–æ–≤–∞–Ω–∏—è –¥–ª—è –∏—Å–∫–ª—é—á–µ–Ω–∏—è
            exclude_rental_id: ID –∞—Ä–µ–Ω–¥—ã –¥–ª—è –∏—Å–∫–ª—é—á–µ–Ω–∏—è
            
        Returns:
            SQLAlchemy BinaryExpression –¥–ª—è —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏
        """
        from api.models.reservation import reservation_equipment_association
        from api.models.rental import rental_equipment_association
        
        # –ü–æ–¥–∑–∞–ø—Ä–æ—Å –¥–ª—è ID –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—è, –∑–∞–Ω—è—Ç–æ–≥–æ –≤ –∞–∫—Ç–∏–≤–Ω—ã—Ö —Ä–µ–∑–µ—Ä–≤–∞—Ö
        booked_in_reservations_subquery = self._create_reservations_subquery(
            start_date, end_date, exclude_reservation_id
        )
        
        # –ü–æ–¥–∑–∞–ø—Ä–æ—Å –¥–ª—è ID –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—è, –∑–∞–Ω—è—Ç–æ–≥–æ –≤ –∞–∫—Ç–∏–≤–Ω—ã—Ö/–ø—Ä–æ—Å—Ä–æ—á–µ–Ω–Ω—ã—Ö –∞—Ä–µ–Ω–¥–∞—Ö
        booked_in_rentals_subquery = self._create_rentals_subquery(
            start_date, end_date, exclude_rental_id
        )
        
        # –í–æ–∑–≤—Ä–∞—â–∞–µ–º —É—Å–ª–æ–≤–∏–µ –¥–ª—è –∏—Å–∫–ª—é—á–µ–Ω–∏—è –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–æ–≥–æ –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—è
        return and_(
            Equipment.id.notin_(booked_in_reservations_subquery),
            Equipment.id.notin_(booked_in_rentals_subquery)
        )

    def _create_reservations_subquery(
        self,
        start_date: date,
        end_date: date,
        exclude_reservation_id: Optional[int] = None
    ):
        """
        –°–æ–∑–¥–∞–µ—Ç –ø–æ–¥–∑–∞–ø—Ä–æ—Å –¥–ª—è —Ä–µ–∑–µ—Ä–≤–∏—Ä–æ–≤–∞–Ω–∏–π.
        
        Args:
            start_date: –î–∞—Ç–∞ –Ω–∞—á–∞–ª–∞ –ø–µ—Ä–∏–æ–¥–∞
            end_date: –î–∞—Ç–∞ –æ–∫–æ–Ω—á–∞–Ω–∏—è –ø–µ—Ä–∏–æ–¥–∞
            exclude_reservation_id: ID —Ä–µ–∑–µ—Ä–≤–∏—Ä–æ–≤–∞–Ω–∏—è –¥–ª—è –∏—Å–∫–ª—é—á–µ–Ω–∏—è
            
        Returns:
            –ü–æ–¥–∑–∞–ø—Ä–æ—Å –¥–ª—è —Ä–µ–∑–µ—Ä–≤–∏—Ä–æ–≤–∞–Ω–∏–π
        """
        from api.models.reservation import reservation_equipment_association
        
        subquery = (
            select(reservation_equipment_association.c.equipment_id)
            .join(Reservation, reservation_equipment_association.c.reservation_id == Reservation.id)
            .filter(
                Reservation.end_date > start_date,
                Reservation.start_date < end_date,
                Reservation.status == 'active'
            )
        )
        
        if exclude_reservation_id:
            subquery = subquery.filter(Reservation.id != exclude_reservation_id)
        
        return subquery.distinct()

    def _create_rentals_subquery(
        self,
        start_date: date,
        end_date: date,
        exclude_rental_id: Optional[int] = None
    ):
        """
        –°–æ–∑–¥–∞–µ—Ç –ø–æ–¥–∑–∞–ø—Ä–æ—Å –¥–ª—è –∞—Ä–µ–Ω–¥.
        
        Args:
            start_date: –î–∞—Ç–∞ –Ω–∞—á–∞–ª–∞ –ø–µ—Ä–∏–æ–¥–∞
            end_date: –î–∞—Ç–∞ –æ–∫–æ–Ω—á–∞–Ω–∏—è –ø–µ—Ä–∏–æ–¥–∞
            exclude_rental_id: ID –∞—Ä–µ–Ω–¥—ã –¥–ª—è –∏—Å–∫–ª—é—á–µ–Ω–∏—è
            
        Returns:
            –ü–æ–¥–∑–∞–ø—Ä–æ—Å –¥–ª—è –∞—Ä–µ–Ω–¥
        """
        from api.models.rental import rental_equipment_association
        
        subquery = (
            select(rental_equipment_association.c.equipment_id)
            .join(Rental, rental_equipment_association.c.rental_id == Rental.id)
            .filter(
                Rental.end_date > start_date,
                Rental.start_date < end_date,
                Rental.status.in_(['active', 'overdue'])
            )
        )
        
        if exclude_rental_id:
            subquery = subquery.filter(Rental.id != exclude_rental_id)
        
        return subquery.distinct()

```



## `api\services\availability\statuses.py`


```python

# api/services/availability/statuses.py

from datetime import date, timedelta
from typing import List, Dict, Any, Optional

from .conflicts import AvailabilityConflictsService
from shared.schemas.calendar_schema import DayStatusItem


class AvailabilityStatusService(AvailabilityConflictsService):
    """
    –°–µ—Ä–≤–∏—Å –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å–æ —Å—Ç–∞—Ç—É—Å–∞–º–∏ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏ –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—è.
    –û—Ç–≤–µ—á–∞–µ—Ç –∑–∞ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –∏ —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–æ–≤ –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—è.
    """

    async def get_availability_statuses(
        self,
        equipment_ids: List[int],
        start_date: date,
        end_date: date,
        exclude_reservation_id: Optional[int] = None,
        exclude_rental_id: Optional[int] = None
    ) -> Dict[int, Dict[str, Any]]:
        """
        –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Å—Ç–∞—Ç—É—Å—ã –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏ –¥–ª—è —Å–ø–∏—Å–∫–∞ –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—è.
        
        Args:
            equipment_ids: –°–ø–∏—Å–æ–∫ ID –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—è –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏
            start_date: –î–∞—Ç–∞ –Ω–∞—á–∞–ª–∞ –ø–µ—Ä–∏–æ–¥–∞
            end_date: –î–∞—Ç–∞ –æ–∫–æ–Ω—á–∞–Ω–∏—è –ø–µ—Ä–∏–æ–¥–∞
            exclude_reservation_id: ID —Ä–µ–∑–µ—Ä–≤–∏—Ä–æ–≤–∞–Ω–∏—è –¥–ª—è –∏—Å–∫–ª—é—á–µ–Ω–∏—è
            exclude_rental_id: ID –∞—Ä–µ–Ω–¥—ã –¥–ª—è –∏—Å–∫–ª—é—á–µ–Ω–∏—è
            
        Returns:
            –°–ª–æ–≤–∞—Ä—å —Å–æ —Å—Ç–∞—Ç—É—Å–∞–º–∏ –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—è
        """
        statuses: Dict[int, Dict[str, Any]] = {
            eq_id: {"status": "available", "details": "–î–æ—Å—Ç—É–ø–Ω–æ"}
            for eq_id in equipment_ids
        }
        
        conflicts = await self.get_conflicts(
            equipment_ids, start_date, end_date, exclude_reservation_id, exclude_rental_id
        )
        
        for eq_id, conflict_list in conflicts.items():
            if not conflict_list:
                continue
            
            most_critical = self._get_most_critical_conflict(conflict_list)
            if most_critical:
                statuses[eq_id] = self._format_status_from_conflict(most_critical)
        
        return statuses

    async def get_daily_statuses(
        self,
        equipment_ids: List[int],
        start_date: date,
        end_date: date,
        exclude_reservation_id: Optional[int] = None,
        exclude_rental_id: Optional[int] = None,
        current_user_id: Optional[int] = None
    ) -> Dict[int, Dict[str, DayStatusItem]]:
        """
        –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Å—Ç–∞—Ç—É—Å—ã –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—è –ø–æ –¥–Ω—è–º –¥–ª—è –∫–∞–ª–µ–Ω–¥–∞—Ä–Ω–æ–≥–æ –ø—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω–∏—è.
        
        Args:
            equipment_ids: –°–ø–∏—Å–æ–∫ ID –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—è –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏
            start_date: –î–∞—Ç–∞ –Ω–∞—á–∞–ª–∞ –ø–µ—Ä–∏–æ–¥–∞
            end_date: –î–∞—Ç–∞ –æ–∫–æ–Ω—á–∞–Ω–∏—è –ø–µ—Ä–∏–æ–¥–∞
            exclude_reservation_id: ID —Ä–µ–∑–µ—Ä–≤–∏—Ä–æ–≤–∞–Ω–∏—è –¥–ª—è –∏—Å–∫–ª—é—á–µ–Ω–∏—è
            exclude_rental_id: ID –∞—Ä–µ–Ω–¥—ã –¥–ª—è –∏—Å–∫–ª—é—á–µ–Ω–∏—è
            current_user_id: ID —Ç–µ–∫—É—â–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –¥–ª—è –≤—ã–¥–µ–ª–µ–Ω–∏—è –µ–≥–æ —Ä–µ–∑–µ—Ä–≤–∏—Ä–æ–≤–∞–Ω–∏–π
            
        Returns:
            –°–ª–æ–≤–∞—Ä—å —Å–æ —Å—Ç–∞—Ç—É—Å–∞–º–∏ –ø–æ –¥–Ω—è–º
        """
        num_days = (end_date - start_date).days + 1
        all_dates = [start_date + timedelta(days=i) for i in range(num_days)]
        
        result: Dict[int, Dict[str, DayStatusItem]] = {
            eq_id: {
                day.strftime('%d.%m.%Y'): DayStatusItem(status="available")
                for day in all_dates
            }
            for eq_id in equipment_ids
        }
        
        conflicts = await self.get_conflicts(
            equipment_ids, start_date, end_date, exclude_reservation_id, exclude_rental_id
        )
        
        for eq_id, conflict_list in conflicts.items():
            if eq_id not in result:
                continue
                
            for conflict in conflict_list:
                self._apply_conflict_to_daily_statuses(
                    result[eq_id], conflict, start_date, end_date, current_user_id
                )
        
        return result

    def _format_status_from_conflict(self, conflict: Dict[str, Any]) -> Dict[str, Any]:
        """
        –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ—Ç —Å—Ç–∞—Ç—É—Å –Ω–∞ –æ—Å–Ω–æ–≤–µ –∫–æ–Ω—Ñ–ª–∏–∫—Ç–∞.
        
        Args:
            conflict: –°–ª–æ–≤–∞—Ä—å —Å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–µ–π –æ –∫–æ–Ω—Ñ–ª–∏–∫—Ç–µ
            
        Returns:
            –û—Ç—Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã–π —Å—Ç–∞—Ç—É—Å
        """
        if conflict['type'] == 'rental':
            return {
                "status": "rented",
                "details": f"–í –∞—Ä–µ–Ω–¥–µ –¥–æ {conflict['end_date'].strftime('%d.%m.%Y')}",
                "start_date": conflict['start_date'],
                "end_date": conflict['end_date']
            }
        elif conflict['type'] == 'reservation':
            return {
                "status": "reserved",
                "details": f"–ó–∞—Ä–µ–∑–µ—Ä–≤–∏—Ä–æ–≤–∞–Ω–æ –¥–æ {conflict['end_date'].strftime('%d.%m.%Y')}",
                "start_date": conflict['start_date'],
                "end_date": conflict['end_date']
            }
        
        return {"status": "available", "details": "–î–æ—Å—Ç—É–ø–Ω–æ"}

    def _apply_conflict_to_daily_statuses(
        self,
        daily_statuses: Dict[str, DayStatusItem],
        conflict: Dict[str, Any],
        start_date: date,
        end_date: date,
        current_user_id: Optional[int]
    ) -> None:
        """
        –ü—Ä–∏–º–µ–Ω—è–µ—Ç –∫–æ–Ω—Ñ–ª–∏–∫—Ç –∫ —Å—Ç–∞—Ç—É—Å–∞–º –ø–æ –¥–Ω—è–º.
        
        Args:
            daily_statuses: –°–ª–æ–≤–∞—Ä—å —Å–æ —Å—Ç–∞—Ç—É—Å–∞–º–∏ –ø–æ –¥–Ω—è–º
            conflict: –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –∫–æ–Ω—Ñ–ª–∏–∫—Ç–µ
            start_date: –ù–∞—á–∞–ª—å–Ω–∞—è –¥–∞—Ç–∞ –ø–µ—Ä–∏–æ–¥–∞
            end_date: –ö–æ–Ω–µ—á–Ω–∞—è –¥–∞—Ç–∞ –ø–µ—Ä–∏–æ–¥–∞
            current_user_id: ID —Ç–µ–∫—É—â–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        """
        current_day = conflict['start_date']
        while current_day < conflict['end_date']:
            if start_date <= current_day <= end_date:
                day_str = current_day.strftime('%d.%m.%Y')
                if daily_statuses[day_str].status != 'rented':
                    is_user_event = (
                        current_user_id is not None and 
                        conflict.get('user_id') == current_user_id and
                        conflict['type'] == 'reservation'
                    )
                    
                    # –°–æ–∑–¥–∞–µ–º –º–∞–ø–ø–∏–Ω–≥ –¥–ª—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–≥–æ –ø—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏—è —Å—Ç–∞—Ç—É—Å–æ–≤
                    status_map = {
                        "reservation": "reserved",
                        "rental": "rented"
                    }
                    correct_status = status_map.get(conflict['type'], "available")
                    
                    daily_statuses[day_str] = DayStatusItem(
                        status=correct_status,
                        group_id=f"{conflict['type']}-{conflict['id']}",
                        is_user_reservation=is_user_event
                    )
            current_day += timedelta(days=1)

```



## `api\services\balance_service.py`


```python

# api/services/balance_service.py

from sqlalchemy.ext.asyncio import AsyncSession
from sqlalchemy import select
from fastapi import HTTPException, status
import logging

from api.models.user import User
from api.models.balance_history import BalanceHistory
from api.models.rental import Rental

logger = logging.getLogger(__name__)

class BalanceService:
    def __init__(self, db: AsyncSession):
        self.db = db

    async def add_transaction(
            self,
            user_id: int,
            amount: float,
            operation_type: str,
            description: str,
            rental_id: int | None = None
    ) -> BalanceHistory:
        """
        –ü—Ä–æ–≤–æ–¥–∏—Ç —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—é, —Å–æ–∑–¥–∞–≤–∞—è –∑–∞–ø–∏—Å—å –≤ –∏—Å—Ç–æ—Ä–∏–∏ –∏ –∞—Ç–æ–º–∞—Ä–Ω–æ –æ–±–Ω–æ–≤–ª—è—è –±–∞–ª–∞–Ω—Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è.
        Amount: –ø–æ–ª–æ–∂–∏—Ç–µ–ª—å–Ω–æ–µ —á–∏—Å–ª–æ –¥–ª—è –Ω–∞—á–∏—Å–ª–µ–Ω–∏—è, –æ—Ç—Ä–∏—Ü–∞—Ç–µ–ª—å–Ω–æ–µ –¥–ª—è —Å–ø–∏—Å–∞–Ω–∏—è.
        """
        # –ò—Å–ø–æ–ª—å–∑—É–µ–º with_for_update() –¥–ª—è –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏ —Å—Ç—Ä–æ–∫–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –Ω–∞ –≤—Ä–µ–º—è —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏,
        # —á—Ç–æ–±—ã –∏–∑–±–µ–∂–∞—Ç—å race conditions –ø—Ä–∏ –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–ø–µ—Ä–∞—Ü–∏—è—Ö.
        result = await self.db.execute(select(User).filter(User.id == user_id).with_for_update())
        user = result.scalars().first()
        if not user:
            logger.error(f"–ü–æ–ø—ã—Ç–∫–∞ –ø—Ä–æ–≤–µ—Å—Ç–∏ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—é –¥–ª—è –Ω–µ—Å—É—â–µ—Å—Ç–≤—É—é—â–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è ID={user_id}")
            # –û—Ç–∫–∞—Ç—ã–≤–∞–µ–º —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—é, –µ—Å–ª–∏ –æ–Ω–∞ –±—ã–ª–∞ –Ω–∞—á–∞—Ç–∞
            await self.db.rollback()
            raise HTTPException(status_code=status.HTTP_404_NOT_FOUND, detail="–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω.")

        try:
            # 1. –°–æ–∑–¥–∞–µ–º –∑–∞–ø–∏—Å—å –≤ –∏—Å—Ç–æ—Ä–∏–∏
            new_history_entry = BalanceHistory(
                user_id=user_id,
                amount=amount,
                operation_type=operation_type,
                description=description,
                rental_id=rental_id
            )
            self.db.add(new_history_entry)

            # 2. –ê—Ç–æ–º–∞—Ä–Ω–æ –æ–±–Ω–æ–≤–ª—è–µ–º –∫—ç—à–∏—Ä–æ–≤–∞–Ω–Ω–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ –±–∞–ª–∞–Ω—Å–∞
            user.balance += amount

            await self.db.commit()
            await self.db.refresh(new_history_entry)
            logger.info(f"–¢—Ä–∞–Ω–∑–∞–∫—Ü–∏—è –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è ID={user_id} –Ω–∞ —Å—É–º–º—É {amount} ({operation_type}) —É—Å–ø–µ—à–Ω–æ –ø—Ä–æ–≤–µ–¥–µ–Ω–∞. –ù–æ–≤—ã–π –±–∞–ª–∞–Ω—Å: {user.balance}")
            return new_history_entry

        except Exception as e:
            await self.db.rollback()
            logger.error(f"–û—à–∏–±–∫–∞ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è ID={user_id}: {e}", exc_info=True)
            raise HTTPException(
                status_code=status.HTTP_500_INTERNAL_SERVER_ERROR,
                detail="–í–Ω—É—Ç—Ä–µ–Ω–Ω—è—è –æ—à–∏–±–∫–∞ –ø—Ä–∏ –ø—Ä–æ–≤–µ–¥–µ–Ω–∏–∏ —Ñ–∏–Ω–∞–Ω—Å–æ–≤–æ–π –æ–ø–µ—Ä–∞—Ü–∏–∏."
            )

    async def get_balance_for_user(self, user_id: int) -> float:
        """–í–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Ç–µ–∫—É—â–∏–π –±–∞–ª–∞–Ω—Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è."""
        result = await self.db.execute(select(User).filter(User.id == user_id))
        user = result.scalars().first()
        if not user:
            raise HTTPException(status_code=status.HTTP_404_NOT_FOUND, detail="–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω.")
        return user.balance

```



## `api\services\dashboard\activity_service.py`


```python

# api/services/dashboard/activity_service.py

from sqlalchemy.ext.asyncio import AsyncSession
from sqlalchemy import select, func, desc, literal_column, union_all
from datetime import datetime, timedelta
from typing import List

from api.models.rental import Rental
from api.models.user import User
from api.models.equipment import Equipment
from shared.schemas.dashboard_schema import ActivityFeedItem
from .base import BaseDashboardService


class ActivityService(BaseDashboardService):
    """–°–µ—Ä–≤–∏—Å –¥–ª—è –ª–µ–Ω—Ç—ã –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ –ø–∞–Ω–µ–ª–∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è."""
    
    async def get_recent_activity(self) -> List[ActivityFeedItem]:
        """–ü–æ–ª—É—á–∞–µ—Ç –ø–æ—Å–ª–µ–¥–Ω–∏–µ —Å–æ–±—ã—Ç–∏—è –≤ —Å–∏—Å—Ç–µ–º–µ."""
        seven_days_ago = datetime.now() - timedelta(days=7)

        # –ó–∞–ø—Ä–æ—Å 1: –ù–æ–≤—ã–µ –∞—Ä–µ–Ω–¥—ã
        new_rentals_q = (
            select(
                Rental.id,
                Rental.created_at.label("timestamp"),
                literal_column("'rental_started'").label("activity_type"),
                User.full_name.label("user_name"),
                func.string_agg(Equipment.name, ', ').label("equipment_name")
            )
            .join(User, Rental.user_id == User.id)
            .join(Rental.equipment)
            .where(Rental.created_at >= seven_days_ago)
            .group_by(Rental.id, User.full_name, Rental.created_at)
        )
        
        # –ó–∞–ø—Ä–æ—Å 2: –ù–æ–≤—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏
        new_users_q = (
            select(
                User.id,
                User.created_at.label("timestamp"),
                literal_column("'user_registered'").label("activity_type"),
                User.full_name.label("user_name"),
                literal_column("NULL").label("equipment_name")
            )
            .where(User.created_at >= seven_days_ago)
        )

        # –û–±—ä–µ–¥–∏–Ω—è–µ–º –∑–∞–ø—Ä–æ—Å—ã
        combined_query = union_all(new_rentals_q, new_users_q).order_by(desc("timestamp")).limit(10)
        
        result = await self.db.execute(combined_query)
        
        activities = []
        for row in result.mappings().all():
            description = ""
            if row.activity_type == 'rental_started':
                description = f"–ù–æ–≤–∞—è –∞—Ä–µ–Ω–¥–∞ –¥–ª—è {row.user_name}"
            elif row.activity_type == 'user_registered':
                description = f"–ù–æ–≤—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: {row.user_name}"
            
            activities.append(ActivityFeedItem(
                id=row.id, 
                timestamp=row.timestamp, 
                activity_type=row.activity_type,
                description=description, 
                user_name=row.user_name, 
                equipment_name=row.equipment_name
            ))
        return activities

```



## `api\services\dashboard\base.py`


```python

# api/services/dashboard/base.py

from sqlalchemy.ext.asyncio import AsyncSession
from datetime import datetime, date
from typing import List

from api.models.rental import Rental
from api.models.reservation import Reservation
from shared.schemas.dashboard_schema import TodayFocusItem


class BaseDashboardService:
    """–ë–∞–∑–æ–≤—ã–π –∫–ª–∞—Å—Å –¥–ª—è —Å–µ—Ä–≤–∏—Å–æ–≤ –ø–∞–Ω–µ–ª–∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è —Å –æ–±—â–∏–º–∏ –º–µ—Ç–æ–¥–∞–º–∏."""
    
    def __init__(self, db: AsyncSession):
        self.db = db

    def _create_today_focus_item_from_reservation(self, reservation: Reservation, start_date: date = None) -> TodayFocusItem:
        """–°–æ–∑–¥–∞–µ—Ç TodayFocusItem –∏–∑ —Ä–µ–∑–µ—Ä–≤–∞—Ü–∏–∏."""
        return TodayFocusItem(
            id=reservation.id,
            user_name=reservation.user.full_name,
            details=f"{len(reservation.equipment)} –ø–æ–∑–∏—Ü–∏–π",
            user_id=reservation.user_id,
            order_type='reservation',
            scheduled_time=datetime.combine(reservation.start_date, datetime.min.time()),
            start_date=start_date or reservation.start_date
        )

    def _create_today_focus_item_from_rental(
        self, 
        rental: Rental, 
        details: str, 
        due_date: date = None, 
        days_overdue: int = None
    ) -> TodayFocusItem:
        """–°–æ–∑–¥–∞–µ—Ç TodayFocusItem –∏–∑ –∞—Ä–µ–Ω–¥—ã."""
        return TodayFocusItem(
            id=rental.id,
            user_name=rental.user.full_name,
            details=details,
            user_id=rental.user_id,
            order_type='rental',
            scheduled_time=datetime.combine(rental.end_date, datetime.min.time()),
            due_date=due_date,
            days_overdue=days_overdue
        )

```



## `api\services\dashboard\dashboard_service.py`


```python

# api/services/dashboard/dashboard_service.py

from sqlalchemy.ext.asyncio import AsyncSession
import asyncio
import logging

from shared.schemas.dashboard_schema import DashboardSummaryResponse
from .focus_service import FocusService
from .kpi_service import KpiService
from .activity_service import ActivityService
from .equipment_service import EquipmentService

logger = logging.getLogger(__name__)


class DashboardService:
    """–û—Å–Ω–æ–≤–Ω–æ–π —Å–µ—Ä–≤–∏—Å –¥–ª—è —Å–±–æ—Ä–∞ –∞–≥—Ä–µ–≥–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –ø–∞–Ω–µ–ª–∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –∞–¥–º–∏–Ω–∫–∏."""

    def __init__(self, db: AsyncSession):
        self.db = db
        # –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º —Å–ø–µ—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ —Å–µ—Ä–≤–∏—Å—ã
        self.focus_service = FocusService(db)
        self.kpi_service = KpiService(db)
        self.activity_service = ActivityService(db)
        self.equipment_service = EquipmentService(db)

    async def get_summary(self) -> DashboardSummaryResponse:
        """–ü–æ–ª—É—á–∞–µ—Ç —Å–≤–æ–¥–Ω—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –¥–ª—è –ø–∞–Ω–µ–ª–∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è."""
        try:
            # –°–æ–±–∏—Ä–∞–µ–º –≤—Å–µ –¥–∞–Ω–Ω—ã–µ –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ –¥–ª—è –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏
            # –ì—Ä—É–ø–ø–∏—Ä—É–µ–º –∑–∞–¥–∞—á–∏ –ø–æ —Ç–∏–ø–∞–º –¥–ª—è –ª—É—á—à–µ–π –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏–∏
            focus_tasks = [
                self.focus_service.get_pickups_today(),
                self.focus_service.get_returns_today(),
                self.focus_service.get_overdue_rentals()
            ]
            
            other_tasks = [
                self.activity_service.get_recent_activity(),
                self.equipment_service.get_popular_equipment()
            ]
            
            # –í—ã–ø–æ–ª–Ω—è–µ–º –∑–∞–¥–∞—á–∏ –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ
            focus_results = await asyncio.gather(*focus_tasks)
            kpi_data = await self.kpi_service.get_kpi_data()
            other_results = await asyncio.gather(*other_tasks)

            return DashboardSummaryResponse(
                pickups_today=focus_results[0],
                returns_today=focus_results[1],
                overdue_rentals=focus_results[2],
                kpi=kpi_data,
                recent_activity=other_results[0],
                popular_equipment=other_results[1]
            )
        except Exception as e:
            logger.error(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ —Å–≤–æ–¥–Ω–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏: {e}", exc_info=True)
            raise

```



## `api\services\dashboard\equipment_service.py`


```python

# api/services/dashboard/equipment_service.py

from sqlalchemy.ext.asyncio import AsyncSession
from sqlalchemy import select, func, desc
from datetime import date, timedelta
from typing import List
import logging

from api.models.rental import Rental
from api.models.equipment import Equipment
from shared.schemas.dashboard_schema import PopularEquipmentItem
from .base import BaseDashboardService

logger = logging.getLogger(__name__)


class EquipmentService(BaseDashboardService):
    """–°–µ—Ä–≤–∏—Å –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –ø–æ–ø—É–ª—è—Ä–Ω—ã–º –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏–µ–º –ø–∞–Ω–µ–ª–∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è."""
    
    async def get_popular_equipment(self) -> List[PopularEquipmentItem]:
        """–ü–æ–ª—É—á–∞–µ—Ç —Ç–æ–ø-10 —Å–∞–º–æ–≥–æ –ø–æ–ø—É–ª—è—Ä–Ω–æ–≥–æ –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—è —Å –≤—ã—Ä—É—á–∫–æ–π."""
        try:
            thirty_days_ago = date.today() - timedelta(days=30)
            query = (
                select(
                    Equipment.id.label("equipment_id"),
                    Equipment.name.label("equipment_name"),
                    func.count(Rental.id).label("rental_count"),
                    func.sum(Rental.total_cost).label("revenue")
                )
                .join(Rental.equipment)
                .where(Rental.created_at >= thirty_days_ago)
                .group_by(Equipment.id, Equipment.name)
                .order_by(desc("rental_count"))
                .limit(10)
            )
            result = await self.db.execute(query)
            return [PopularEquipmentItem.model_validate(row) for row in result.mappings().all()]
            
        except Exception as e:
            logger.error(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ –ø–æ–ø—É–ª—è—Ä–Ω–æ–≥–æ –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—è: {e}", exc_info=True)
            # –í–æ–∑–≤—Ä–∞—â–∞–µ–º –ø—É—Å—Ç–æ–π —Å–ø–∏—Å–æ–∫ –≤ —Å–ª—É—á–∞–µ –æ—à–∏–±–∫–∏
            return []

```



## `api\services\dashboard\focus_service.py`


```python


# api/services/dashboard/focus_service.py

from sqlalchemy.ext.asyncio import AsyncSession
from sqlalchemy.orm import joinedload, selectinload
from sqlalchemy import select, and_
from datetime import date
from typing import List

from api.models.rental import Rental
from api.models.reservation import Reservation
from shared.schemas.dashboard_schema import TodayFocusItem
from .base import BaseDashboardService


class FocusService(BaseDashboardService):
    """–°–µ—Ä–≤–∏—Å –¥–ª—è –≤–∏–¥–∂–µ—Ç–∞ '–°–µ–≥–æ–¥–Ω—è –≤ —Ñ–æ–∫—É—Å–µ' - –≤—ã–¥–∞—á–∏, –≤–æ–∑–≤—Ä–∞—Ç—ã, –ø—Ä–æ—Å—Ä–æ—á–∫–∏."""
    
    async def get_pickups_today(self) -> List[TodayFocusItem]:
        """–ü–æ–ª—É—á–∞–µ—Ç –∞–∫—Ç–∏–≤–Ω—ã–µ —Ä–µ–∑–µ—Ä–≤–∞—Ü–∏–∏ –¥–ª—è –≤—ã–¥–∞—á–∏ (–Ω–µ –ø—Ä–æ—Å—Ä–æ—á–µ–Ω–Ω—ã–µ –∏ –Ω–µ –≤—ã–¥–∞–Ω–Ω—ã–µ)."""
        today = date.today()
        
        query = select(Reservation).options(
            joinedload(Reservation.user),
            selectinload(Reservation.equipment)
        ).filter(
            and_(
                Reservation.start_date <= today,
                Reservation.end_date >= today,
                Reservation.status == 'active'
            )
        )

        result = await self.db.execute(query)
        reservations = result.unique().scalars().all()

        return [self._create_today_focus_item_from_reservation(reservation, reservation.start_date) for reservation in reservations]

    async def get_returns_today(self) -> List[TodayFocusItem]:
        """–ü–æ–ª—É—á–∞–µ—Ç –∞—Ä–µ–Ω–¥—ã –Ω–∞ —Å–µ–≥–æ–¥–Ω—è –¥–ª—è –≤–æ–∑–≤—Ä–∞—Ç–∞."""
        today = date.today()
        
        query = select(Rental).options(
            joinedload(Rental.user),
            selectinload(Rental.equipment)
        ).filter(
            and_(
                Rental.end_date == today,
                Rental.status == 'active'
            )
        )

        result = await self.db.execute(query)
        rentals = result.unique().scalars().all()

        return [
            self._create_today_focus_item_from_rental(
                rental, 
                f"–û—Å—Ç–∞—Ç–æ–∫: {rental.total_cost - rental.prepayment_amount:.0f} ‚ÇΩ"
            ) 
            for rental in rentals
        ]

    async def get_overdue_rentals(self) -> List[TodayFocusItem]:
        """–ü–æ–ª—É—á–∞–µ—Ç –ø—Ä–æ—Å—Ä–æ—á–µ–Ω–Ω—ã–µ –∞—Ä–µ–Ω–¥—ã."""
        today = date.today()
        
        query = select(Rental).options(
            joinedload(Rental.user),
            selectinload(Rental.equipment)
        ).filter(
            and_(
                Rental.end_date < today,
                Rental.status == 'active'
            )
        )

        result = await self.db.execute(query)
        rentals = result.unique().scalars().all()

        result_items = []
        for rental in rentals:
            days_overdue = (today - rental.end_date).days
            remaining_amount = rental.total_cost - rental.prepayment_amount
            
            item = self._create_today_focus_item_from_rental(
                rental,
                f"{len(rental.equipment)} –ø–æ–∑., –æ—Å—Ç–∞—Ç–æ–∫: {remaining_amount:.0f} ‚ÇΩ",
                due_date=rental.end_date,
                days_overdue=days_overdue
            )
            result_items.append(item)
        
        return result_items

```



## `api\services\dashboard\kpi_service.py`


```python

# api/services/dashboard/kpi_service.py

from sqlalchemy.ext.asyncio import AsyncSession
from sqlalchemy.orm import joinedload, selectinload
from sqlalchemy import select, func, and_
from datetime import date, timedelta
import asyncio

from api.models.rental import Rental, rental_equipment_association
from api.models.reservation import Reservation, reservation_equipment_association
from api.models.user import User
from api.models.equipment import Equipment
from shared.schemas.dashboard_schema import KpiData
from .base import BaseDashboardService


class KpiService(BaseDashboardService):
    """–°–µ—Ä–≤–∏—Å –¥–ª—è —Ä–∞—Å—á–µ—Ç–∞ KPI –º–µ—Ç—Ä–∏–∫ –ø–∞–Ω–µ–ª–∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è."""
    
    async def get_total_users(self) -> int:
        """–ü–æ–ª—É—á–∞–µ—Ç –æ–±—â–µ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π."""
        query = select(func.count(User.id))
        result = await self.db.execute(query)
        return int(result.scalar_one())

    async def get_active_users(self) -> int:
        """–ü–æ–ª—É—á–∞–µ—Ç –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∞–∫—Ç–∏–≤–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π (—Å —Ä–µ–∑–µ—Ä–≤–∞—Ü–∏—è–º–∏ –∏–ª–∏ –∞—Ä–µ–Ω–¥–∞–º–∏ –∑–∞ –ø–æ—Å–ª–µ–¥–Ω–∏–µ 30 –¥–Ω–µ–π)."""
        thirty_days_ago = date.today() - timedelta(days=30)
        
        # –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ —Å –∞–∫—Ç–∏–≤–Ω—ã–º–∏ —Ä–µ–∑–µ—Ä–≤–∞—Ü–∏—è–º–∏
        active_reservations_query = select(User.id).join(
            Reservation, User.id == Reservation.user_id
        ).filter(
            and_(
                Reservation.created_at >= thirty_days_ago,
                Reservation.status.in_(['active', 'completed'])
            )
        )
        
        # –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ —Å –∞–∫—Ç–∏–≤–Ω—ã–º–∏ –∞—Ä–µ–Ω–¥–∞–º–∏
        active_rentals_query = select(User.id).join(
            Rental, User.id == Rental.user_id
        ).filter(
            and_(
                Rental.created_at >= thirty_days_ago,
                Rental.status.in_(['active', 'completed'])
            )
        )
        
        # –û–±—ä–µ–¥–∏–Ω—è–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã
        reservations_result = await self.db.execute(active_reservations_query)
        rentals_result = await self.db.execute(active_rentals_query)
        
        active_user_ids = set()
        for row in reservations_result:
            active_user_ids.add(row.id)
        for row in rentals_result:
            active_user_ids.add(row.id)
            
        return len(active_user_ids)

    async def get_total_equipment(self) -> int:
        """–ü–æ–ª—É—á–∞–µ—Ç –æ–±—â–µ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—è."""
        query = select(func.count(Equipment.id))
        result = await self.db.execute(query)
        return int(result.scalar_one())

    async def get_total_reservations(self) -> int:
        """–ü–æ–ª—É—á–∞–µ—Ç –æ–±—â–µ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ä–µ–∑–µ—Ä–≤–∞—Ü–∏–π."""
        query = select(func.count(Reservation.id))
        result = await self.db.execute(query)
        return int(result.scalar_one())

    async def get_revenue_today(self) -> float:
        """–ü–æ–ª—É—á–∞–µ—Ç –¥–æ—Ö–æ–¥ –∑–∞ —Å–µ–≥–æ–¥–Ω—è."""
        today = date.today()
        
        query = select(func.coalesce(func.sum(Rental.final_cost), 0)).filter(
            and_(
                Rental.status == 'completed',
                func.date(Rental.actual_return_date) == today
            )
        )

        result = await self.db.execute(query)
        return float(result.scalar_one())

    async def get_revenue_this_month(self) -> float:
        """–ü–æ–ª—É—á–∞–µ—Ç –¥–æ—Ö–æ–¥ –∑–∞ —Ç–µ–∫—É—â–∏–π –º–µ—Å—è—Ü."""
        today = date.today()
        first_day_of_month = today.replace(day=1)
        
        query = select(func.coalesce(func.sum(Rental.final_cost), 0)).filter(
            and_(
                Rental.status == 'completed',
                Rental.actual_return_date >= first_day_of_month,
                Rental.actual_return_date <= today
            )
        )

        result = await self.db.execute(query)
        return float(result.scalar_one())

    async def get_occupancy_rate(self) -> float:
        """–†–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ—Ç –∫–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç –∑–∞–≥—Ä—É–∂–µ–Ω–Ω–æ—Å—Ç–∏ –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—è."""
        today = date.today()
        
        # –ü–æ–ª—É—á–∞–µ–º –æ–±—â–µ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—è
        total_equipment_query = select(func.count(Equipment.id))
        total_result = await self.db.execute(total_equipment_query)
        total_equipment = total_result.scalar_one()

        if total_equipment == 0:
            return 0.0

        # –ü–æ–ª—É—á–∞–µ–º —É–Ω–∏–∫–∞–ª—å–Ω–æ–µ –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏–µ –∏–∑ –∞–∫—Ç–∏–≤–Ω—ã—Ö —Ä–µ–∑–µ—Ä–≤–∞—Ü–∏–π
        active_reservations_query = select(reservation_equipment_association.c.equipment_id).join(
            Reservation, 
            reservation_equipment_association.c.reservation_id == Reservation.id
        ).filter(
            and_(
                Reservation.start_date <= today,
                Reservation.end_date >= today,
                Reservation.status == 'active'
            )
        )
        
        reservations_result = await self.db.execute(active_reservations_query)
        reservation_equipment_ids = set(row.equipment_id for row in reservations_result)
        
        # –ü–æ–ª—É—á–∞–µ–º —É–Ω–∏–∫–∞–ª—å–Ω–æ–µ –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏–µ –∏–∑ –∞–∫—Ç–∏–≤–Ω—ã—Ö –∞—Ä–µ–Ω–¥
        active_rentals_query = select(rental_equipment_association.c.equipment_id).join(
            Rental,
            rental_equipment_association.c.rental_id == Rental.id
        ).filter(
            and_(
                Rental.start_date <= today,
                Rental.end_date >= today,
                Rental.status == 'active'
            )
        )
        
        rentals_result = await self.db.execute(active_rentals_query)
        rental_equipment_ids = set(row.equipment_id for row in rentals_result)
        
        # –û–±—ä–µ–¥–∏–Ω—è–µ–º –∏ —Å—á–∏—Ç–∞–µ–º —É–Ω–∏–∫–∞–ª—å–Ω–æ–µ –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏–µ
        unique_equipment_ids = reservation_equipment_ids.union(rental_equipment_ids)
        unique_equipment = len(unique_equipment_ids)

        return (unique_equipment / total_equipment) * 100

    async def get_avg_rental_duration(self) -> float:
        """–†–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ—Ç —Å—Ä–µ–¥–Ω—é—é –ø—Ä–æ–¥–æ–ª–∂–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å –∞—Ä–µ–Ω–¥—ã –≤ –¥–Ω—è—Ö."""
        # –î–ª—è PostgreSQL –∏—Å–ø–æ–ª—å–∑—É–µ–º –ø—Ä–æ—Å—Ç–æ–µ –≤—ã—á–∏—Ç–∞–Ω–∏–µ –¥–∞—Ç —Ç–∏–ø–∞ DATE
        # –≠—Ç–æ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –¥–Ω–µ–π –∫–∞–∫ integer
        query = select(func.avg(
            Rental.actual_return_date - Rental.start_date
        )).filter(
            and_(
                Rental.status == 'completed',
                Rental.actual_return_date.isnot(None)
            )
        )

        result = await self.db.execute(query)
        avg_duration = result.scalar_one()
        return float(avg_duration) if avg_duration is not None else 0.0

    async def get_kpi_data(self) -> KpiData:
        """–ü–æ–ª—É—á–∞–µ—Ç –≤—Å–µ KPI –¥–∞–Ω–Ω—ã–µ –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ."""
        # –í—ã–ø–æ–ª–Ω—è–µ–º –≤—Å–µ KPI –∑–∞–ø—Ä–æ—Å—ã –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ
        results = await asyncio.gather(
            self.get_total_users(),
            self.get_active_users(),
            self.get_total_equipment(),
            self.get_total_reservations(),
            self.get_revenue_today(),
            self.get_revenue_this_month(),
            self.get_occupancy_rate(),
            self.get_avg_rental_duration()
        )
        
        return KpiData(
            total_users=results[0],
            active_users=results[1],
            total_equipment=results[2],
            total_reservations=results[3],
            revenue_today=results[4],
            revenue_this_month=results[5],
            occupancy_rate=results[6],
            avg_rental_duration=results[7]
        )

```



## `api\services\dashboard_service.py`


```python

# api/services/dashboard_service.py

# –ò–º–ø–æ—Ä—Ç–∏—Ä—É–µ–º –Ω–æ–≤—ã–π —Ä–µ—Ñ–∞–∫—Ç–æ—Ä–µ–Ω–Ω—ã–π —Å–µ—Ä–≤–∏—Å
from .dashboard.dashboard_service import DashboardService

```



## `api\services\discount_service.py`


```python

# api/services/discount_service.py

from sqlalchemy.ext.asyncio import AsyncSession
from sqlalchemy import desc, select
from api.models.discount import DurationDiscount

async def get_duration_discount_percentage(db: AsyncSession, days: int) -> int:
    """
    –ü–æ–ª—É—á–∞–µ—Ç –ø—Ä–æ—Ü–µ–Ω—Ç —Å–∫–∏–¥–∫–∏ –∑–∞ –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å –∞—Ä–µ–Ω–¥—ã –∏–∑ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö.
    –ù–∞—Ö–æ–¥–∏—Ç –Ω–∞–∏–±–æ–ª–µ–µ –ø–æ–¥—Ö–æ–¥—è—â—É—é —Å–∫–∏–¥–∫—É –¥–ª—è –∑–∞–¥–∞–Ω–Ω–æ–≥–æ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ –¥–Ω–µ–π.
    """
    if days <= 0:
        return 0

    # –ò—â–µ–º –Ω–∞–∏–±–æ–ª–µ–µ –ø–æ–¥—Ö–æ–¥—è—â—É—é –∑–∞–ø–∏—Å—å –æ —Å–∫–∏–¥–∫–µ,
    # –≥–¥–µ min_days –Ω–µ –ø—Ä–µ–≤—ã—à–∞–µ—Ç –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –¥–Ω–µ–π –∞—Ä–µ–Ω–¥—ã.
    # –°–æ—Ä—Ç–∏—Ä—É–µ–º –ø–æ —É–±—ã–≤–∞–Ω–∏—é, —á—Ç–æ–±—ã –ø–µ—Ä–≤–æ–π –Ω–∞–π—Ç–∏ —Å–∞–º—É—é –±–æ–ª—å—à—É—é –ø–æ–¥—Ö–æ–¥—è—â—É—é —Å–∫–∏–¥–∫—É.
    result = await db.execute(
        select(DurationDiscount)
        .filter(DurationDiscount.min_days <= days)
        .order_by(desc(DurationDiscount.min_days))
    )
    discount = result.scalars().first()

    if discount:
        return discount.discount_percentage

    return 0

```



## `api\services\equipment_query_builder.py`


```python

# api/services/equipment_query_builder.py

from typing import Optional, List
from sqlalchemy.ext.asyncio import AsyncSession
from sqlalchemy.orm import selectinload
from sqlalchemy import or_, and_, select, func
from datetime import date

from api.models.equipment import Equipment
from api.models.association import Association


class EquipmentQueryBuilder:
    """
    –ö–ª–∞—Å—Å –¥–ª—è –ø–æ—Å—Ç—Ä–æ–µ–Ω–∏—è –∑–∞–ø—Ä–æ—Å–æ–≤ –∫ –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—é —Å –ø–æ–¥–¥–µ—Ä–∂–∫–æ–π —Ä–∞–∑–ª–∏—á–Ω—ã—Ö —Ñ–∏–ª—å—Ç—Ä–æ–≤.
    –†–µ–∞–ª–∏–∑—É–µ—Ç –ø–∞—Ç—Ç–µ—Ä–Ω Builder –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è —Å–ª–æ–∂–Ω—ã—Ö SQL-–∑–∞–ø—Ä–æ—Å–æ–≤.
    """

    def __init__(self, db_session: AsyncSession):
        """
        –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –±–∏–ª–¥–µ—Ä–∞ –∑–∞–ø—Ä–æ—Å–æ–≤.

        Args:
            db_session: –°–µ—Å—Å–∏—è SQLAlchemy –¥–ª—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –∑–∞–ø—Ä–æ—Å–æ–≤
        """
        self.db_session = db_session
        # –°–æ–∑–¥–∞–µ–º –±–∞–∑–æ–≤—ã–π –∑–∞–ø—Ä–æ—Å –æ–¥–∏–Ω —Ä–∞–∑ –ø—Ä–∏ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏
        self.query = self._get_base_query()

    def _get_base_query(self):
        """
        –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç –±–∞–∑–æ–≤—ã–π –∑–∞–ø—Ä–æ—Å —Å –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã–º–∏ options –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏ —Å–≤—è–∑–∞–Ω–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö.

        Returns:
            –ë–∞–∑–æ–≤—ã–π select –∑–∞–ø—Ä–æ—Å –¥–ª—è Equipment
        """
        return select(Equipment).options(
            selectinload(Equipment.accessories),
            selectinload(Equipment.associations)
        )

    def apply_search(self, query_str: str):
        """
        –ü—Ä–∏–º–µ–Ω—è–µ—Ç —Ç–µ–∫—Å—Ç–æ–≤—ã–π –ø–æ–∏—Å–∫ –ø–æ –Ω–∞–∑–≤–∞–Ω–∏—é, –±—Ä–µ–Ω–¥—É –∏ —Ç–∏–ø—É –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—è.

        Args:
            query_str: –°—Ç—Ä–æ–∫–∞ –ø–æ–∏—Å–∫–∞

        Returns:
            self –¥–ª—è –ø–æ–¥–¥–µ—Ä–∂–∫–∏ —Ü–µ–ø–æ—á–∫–∏ –≤—ã–∑–æ–≤–æ–≤
        """
        if query_str:
            search_term = f"%{query_str.lower()}%"
            self.query = self.query.filter(
                or_(
                    Equipment.name.ilike(search_term),
                    Equipment.brand.ilike(search_term),
                    Equipment.equipment_type.ilike(search_term)
                )
            )
        return self

    def apply_type(self, equipment_type: str):
        """
        –ü—Ä–∏–º–µ–Ω—è–µ—Ç —Ñ–∏–ª—å—Ç—Ä –ø–æ —Ç–∏–ø—É –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—è.

        Args:
            equipment_type: –¢–∏–ø –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—è –¥–ª—è —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏

        Returns:
            self –¥–ª—è –ø–æ–¥–¥–µ—Ä–∂–∫–∏ —Ü–µ–ø–æ—á–∫–∏ –≤—ã–∑–æ–≤–æ–≤
        """
        if equipment_type:
            self.query = self.query.filter(Equipment.equipment_type == equipment_type)
        return self

    def apply_brand(self, brand: str):
        """
        –ü—Ä–∏–º–µ–Ω—è–µ—Ç —Ñ–∏–ª—å—Ç—Ä –ø–æ –±—Ä–µ–Ω–¥—É –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—è.

        Args:
            brand: –ë—Ä–µ–Ω–¥ –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—è –¥–ª—è —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏

        Returns:
            self –¥–ª—è –ø–æ–¥–¥–µ—Ä–∂–∫–∏ —Ü–µ–ø–æ—á–∫–∏ –≤—ã–∑–æ–≤–æ–≤
        """
        if brand and brand != "__all__":
            self.query = self.query.filter(Equipment.brand == brand)
        return self

    def apply_association(self, association_id: int):
        """
        –ü—Ä–∏–º–µ–Ω—è–µ—Ç —Ñ–∏–ª—å—Ç—Ä –ø–æ –∞—Å—Å–æ—Ü–∏–∞—Ü–∏–∏.

        Args:
            association_id: ID –∞—Å—Å–æ—Ü–∏–∞—Ü–∏–∏ –¥–ª—è —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏

        Returns:
            self –¥–ª—è –ø–æ–¥–¥–µ—Ä–∂–∫–∏ —Ü–µ–ø–æ—á–∫–∏ –≤—ã–∑–æ–≤–æ–≤
        """
        if association_id:
            self.query = self.query.join(Equipment.associations).filter(Association.id == association_id)
        return self

    def apply_availability(self, start_date: date, end_date: date, exclude_reservation_id: int | None = None, exclude_rental_id: int | None = None):
        """
        –ü—Ä–∏–º–µ–Ω—è–µ—Ç —Ñ–∏–ª—å—Ç—Ä –ø–æ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏ –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—è –≤ —É–∫–∞–∑–∞–Ω–Ω—ã–π –ø–µ—Ä–∏–æ–¥.
        –ò—Å–ø–æ–ª—å–∑—É–µ—Ç AvailabilityService –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è SQLAlchemy —Ñ–∏–ª—å—Ç—Ä–∞.

        Args:
            start_date: –î–∞—Ç–∞ –Ω–∞—á–∞–ª–∞ –ø–µ—Ä–∏–æ–¥–∞
            end_date: –î–∞—Ç–∞ –æ–∫–æ–Ω—á–∞–Ω–∏—è –ø–µ—Ä–∏–æ–¥–∞
            exclude_reservation_id: ID —Ä–µ–∑–µ—Ä–≤–∏—Ä–æ–≤–∞–Ω–∏—è –¥–ª—è –∏—Å–∫–ª—é—á–µ–Ω–∏—è
            exclude_rental_id: ID –∞—Ä–µ–Ω–¥—ã –¥–ª—è –∏—Å–∫–ª—é—á–µ–Ω–∏—è

        Returns:
            self –¥–ª—è –ø–æ–¥–¥–µ—Ä–∂–∫–∏ —Ü–µ–ø–æ—á–∫–∏ –≤—ã–∑–æ–≤–æ–≤
        """
        if not start_date or not end_date:
            return self

        # –ò—Å–ø–æ–ª—å–∑—É–µ–º AvailabilityService –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è —Ñ–∏–ª—å—Ç—Ä–∞
        from api.services.availability import AvailabilityService
        availability_service = AvailabilityService(self.db_session)
        
        availability_filter = availability_service.get_sqlalchemy_filter_for_available_equipment(
            start_date, end_date, exclude_reservation_id, exclude_rental_id
        )
        
        self.query = self.query.filter(availability_filter)
        return self

    async def count(self) -> int:
        """
        –í—ã–ø–æ–ª–Ω—è–µ—Ç –ø–æ–¥—Å—á–µ—Ç –æ–±—â–µ–≥–æ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ –∑–∞–ø–∏—Å–µ–π –ø–æ –ø–æ—Å—Ç—Ä–æ–µ–Ω–Ω–æ–º—É –∑–∞–ø—Ä–æ—Å—É.

        Returns:
            –û–±—â–µ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∑–∞–ø–∏—Å–µ–π
        """
        count_query = select(func.count()).select_from(self.query.subquery())
        result = await self.db_session.execute(count_query)
        return result.scalar_one()

    async def paginate(self, skip: int, limit: int) -> List[Equipment]:
        """
        –í—ã–ø–æ–ª–Ω—è–µ—Ç –ø–∞–≥–∏–Ω–∞—Ü–∏—é –∑–∞–ø—Ä–æ—Å–∞ –∏ –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Å–ø–∏—Å–æ–∫ –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—è.

        Args:
            skip: –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –∑–∞–ø–∏—Å–µ–π –¥–ª—è –ø—Ä–æ–ø—É—Å–∫–∞
            limit: –ú–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∑–∞–ø–∏—Å–µ–π –¥–ª—è –≤–æ–∑–≤—Ä–∞—Ç–∞

        Returns:
            –°–ø–∏—Å–æ–∫ –æ–±—ä–µ–∫—Ç–æ–≤ Equipment
        """
        paginated_query = self.query.order_by(Equipment.name).offset(skip).limit(limit)
        result = await self.db_session.execute(paginated_query)
        return result.unique().scalars().all()

```



## `api\services\equipment_service_api.py`


```python

# api/services/equipment_service_api.py

from typing import List, Type, Optional
from sqlalchemy.ext.asyncio import AsyncSession
from sqlalchemy.orm import joinedload, selectinload
from sqlalchemy import or_, and_, select, func
from fastapi import HTTPException
from datetime import date

from api.models.equipment import Equipment
from api.models.accessory import Accessory
from api.models.association import Association
from api.models.reservation import Reservation
from api.models.rental import Rental
from shared.schemas.equipment_schema import EquipmentUpdateExtended
from api.services.equipment_query_builder import EquipmentQueryBuilder

async def get_all_equipment(db: AsyncSession) -> list[Type[Equipment]]:
    """–í–æ–∑–≤—Ä–∞—â–∞–µ—Ç QuerySet –≤—Å–µ–≥–æ –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—è —Å –ø–æ–¥–≥—Ä—É–∑–∫–æ–π —Å–≤—è–∑–µ–π."""
    result = await db.execute(
        select(Equipment).options(
            joinedload(Equipment.accessories),
            joinedload(Equipment.associations)
        )
    )
    equipment_list = result.unique().scalars().all()
    
    # –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –∑–∞—â–∏—Ç–∞: —É–±–µ–∂–¥–∞–µ–º—Å—è, —á—Ç–æ –≤—Å–µ –ø–æ–ª—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã
    for equipment in equipment_list:
        if equipment.name is None:
            equipment.name = "–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ–µ –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏–µ"
        if equipment.daily_rate is None:
            equipment.daily_rate = 0.0
        if equipment.condition is None:
            equipment.condition = "–í–µ–ª–∏–∫–æ–ª–µ–ø–Ω–æ"
    
    return equipment_list


async def get_paginated_equipment(
        db: AsyncSession,
        skip: int,
        limit: int,
        query: Optional[str] = None,
        type: Optional[str] = None,
        brand: Optional[str] = None,
        association_id: Optional[int] = None,
        start_date: Optional[date] = None,
        end_date: Optional[date] = None,
        available_only: bool = False
) -> (List[Equipment], int):
    """
    –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç –æ—Ç—Ñ–∏–ª—å—Ç—Ä–æ–≤–∞–Ω–Ω—ã–π –∏ –ø–∞–≥–∏–Ω–∏—Ä–æ–≤–∞–Ω–Ω—ã–π —Å–ø–∏—Å–æ–∫ –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—è –∏ –∏—Ö –æ–±—â–µ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ.
    –ò—Å–ø–æ–ª—å–∑—É–µ—Ç EquipmentQueryBuilder –¥–ª—è –ø–æ—Å—Ç—Ä–æ–µ–Ω–∏—è –∑–∞–ø—Ä–æ—Å–æ–≤ —Å —Ä–∞–∑–ª–∏—á–Ω—ã–º–∏ —Ñ–∏–ª—å—Ç—Ä–∞–º–∏.
    """
    # –í–∞–ª–∏–¥–∞—Ü–∏—è –¥–∞—Ç –Ω–∞ —É—Ä–æ–≤–Ω–µ —Å–µ—Ä–≤–∏—Å–∞
    if available_only and start_date and end_date:
        if start_date >= end_date:
            raise HTTPException(
                status_code=400, 
                detail="–î–∞—Ç–∞ –Ω–∞—á–∞–ª–∞ –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å —Ä–∞–Ω—å—à–µ –¥–∞—Ç—ã –æ–∫–æ–Ω—á–∞–Ω–∏—è."
            )
    
    # –°–æ–∑–¥–∞–µ–º —ç–∫–∑–µ–º–ø–ª—è—Ä –±–∏–ª–¥–µ—Ä–∞ –∑–∞–ø—Ä–æ—Å–æ–≤
    query_builder = EquipmentQueryBuilder(db)
    
    # –ü—Ä–∏–º–µ–Ω—è–µ–º —Ñ–∏–ª—å—Ç—Ä—ã —Å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º —Ü–µ–ø–æ—á–∫–∏ –≤—ã–∑–æ–≤–æ–≤ (Builder Pattern)
    query_builder.apply_search(query)\
                 .apply_type(type)\
                 .apply_brand(brand)\
                 .apply_association(association_id)
    
    # –ü—Ä–∏–º–µ–Ω—è–µ–º —Ñ–∏–ª—å—Ç—Ä –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏, –µ—Å–ª–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ
    if available_only and start_date and end_date:
        query_builder.apply_availability(start_date, end_date)
    
    # –ü–æ–ª—É—á–∞–µ–º –æ–±—â–µ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∏ –ø–∞–≥–∏–Ω–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã
    total = await query_builder.count()
    items = await query_builder.paginate(skip, limit)
    
    # –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –∑–∞—â–∏—Ç–∞: —É–±–µ–∂–¥–∞–µ–º—Å—è, —á—Ç–æ –≤—Å–µ –ø–æ–ª—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã
    for equipment in items:
        if equipment.name is None:
            equipment.name = "–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ–µ –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏–µ"
        if equipment.daily_rate is None:
            equipment.daily_rate = 0.0
        if equipment.condition is None:
            equipment.condition = "–í–µ–ª–∏–∫–æ–ª–µ–ø–Ω–æ"
    
    return items, total


async def update_equipment_details(db: AsyncSession, equipment_id: int, equipment_data: EquipmentUpdateExtended) -> Equipment:
    result = await db.execute(
        select(Equipment)
        .filter(Equipment.id == equipment_id)
        .options(
            selectinload(Equipment.accessories),
            selectinload(Equipment.associations)
        )
    )
    db_equipment = result.scalars().first()
    if not db_equipment:
        raise HTTPException(status_code=404, detail="–û–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏–µ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ")

    update_data = equipment_data.model_dump(exclude_unset=True)

    if "accessory_ids" in update_data:
        accessory_ids = update_data.pop("accessory_ids")
        db_equipment.accessories.clear()
        await db.flush()
        if accessory_ids:
            accessories_result = await db.execute(select(Accessory).filter(Accessory.id.in_(accessory_ids)))
            found_accessories = accessories_result.unique().scalars().all()
            if len(found_accessories) != len(accessory_ids):
                raise HTTPException(status_code=404, detail="–û–¥–∏–Ω –∏–ª–∏ –Ω–µ—Å–∫–æ–ª—å–∫–æ –∞–∫—Å–µ—Å—Å—É–∞—Ä–æ–≤ —Å —É–∫–∞–∑–∞–Ω–Ω—ã–º–∏ ID –Ω–µ –Ω–∞–π–¥–µ–Ω—ã")
            db_equipment.accessories.extend(found_accessories)

    if "association_ids" in update_data:
        association_ids = update_data.pop("association_ids")
        db_equipment.associations.clear()
        await db.flush()
        if association_ids:
            associations_result = await db.execute(select(Association).filter(Association.id.in_(association_ids)))
            found_associations = associations_result.unique().scalars().all()
            if len(found_associations) != len(association_ids):
                raise HTTPException(status_code=404, detail="–û–¥–Ω–∞ –∏–ª–∏ –Ω–µ—Å–∫–æ–ª—å–∫–æ –∞—Å—Å–æ—Ü–∏–∞—Ü–∏–π —Å —É–∫–∞–∑–∞–Ω–Ω—ã–º–∏ ID –Ω–µ –Ω–∞–π–¥–µ–Ω—ã")
            db_equipment.associations.extend(found_associations)

    for key, value in update_data.items():
        setattr(db_equipment, key, value)

    db.add(db_equipment)
    await db.commit()
    
    # –ü–æ–≤—Ç–æ—Ä–Ω–æ –ø–æ–ª—É—á–∞–µ–º –æ–±—ä–µ–∫—Ç –∏–∑ –ë–î —Å –∑–∞–≥—Ä—É–∂–µ–Ω–Ω—ã–º–∏ —Å–≤—è–∑—è–º–∏
    result = await db.execute(
        select(Equipment)
        .filter(Equipment.id == equipment_id)
        .options(
            selectinload(Equipment.accessories),
            selectinload(Equipment.associations)
        )
    )
    return result.scalars().first()

```



## `api\services\financial_service.py`


```python

# api/services/financial_service.py

from sqlalchemy.ext.asyncio import AsyncSession
from sqlalchemy import select, func
from sqlalchemy.orm import selectinload
from datetime import date, timedelta
from typing import List, Dict, Optional, NamedTuple, Union
from fastapi import HTTPException
import logging

from api.models.equipment import Equipment
from api.models.promo_code import PromoCode
from api.models.accessory import Accessory
from api.models.holiday import Holiday
from api.models.rental import Rental
from api.models.reservation import Reservation
from .discount_service import get_duration_discount_percentage
from .promo_code import PromoCodeBusinessLogic
from shared.schemas.rental_schema import RentalOut
from shared.schemas.reservation_schema import AdminReservationOut, ReservationItem

logger = logging.getLogger(__name__)


class PriceDetails(NamedTuple):
    """–°—Ç—Ä—É–∫—Ç—É—Ä–∞ –¥–ª—è –≤–æ–∑–≤—Ä–∞—Ç–∞ –¥–µ—Ç–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ —Ü–µ–Ω–µ."""
    full_total: float
    discount_amount: float
    final_total: float


class FinancialService:
    """
    –ï–¥–∏–Ω—ã–π —Å–µ—Ä–≤–∏—Å –¥–ª—è –≤—Å–µ—Ö —Ñ–∏–Ω–∞–Ω—Å–æ–≤—ã—Ö —Ä–∞—Å—á–µ—Ç–æ–≤ –∏ –æ–±–æ–≥–∞—â–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö.
    –û–±—ä–µ–¥–∏–Ω—è–µ—Ç –ª–æ–≥–∏–∫—É –∏–∑ price_calculation_service –∏ rental_calculation_service.
    """

    def __init__(self, db: AsyncSession):
        self.db = db

    # --- –ú–µ—Ç–æ–¥—ã —Ä–∞—Å—á–µ—Ç–∞ —Å—Ç–æ–∏–º–æ—Å—Ç–∏ (–∏–∑ price_calculation_service) ---

    async def find_next_working_day(self, start_date: date) -> date:
        """–ù–∞—Ö–æ–¥–∏—Ç –±–ª–∏–∂–∞–π—à—É—é —Å–ª–µ–¥—É—é—â—É—é –¥–∞—Ç—É, –∫–æ—Ç–æ—Ä–∞—è –Ω–µ —è–≤–ª—è–µ—Ç—Å—è –≤—ã—Ö–æ–¥–Ω—ã–º."""
        next_day = start_date
        while True:
            result = await self.db.execute(select(Holiday).filter(Holiday.date == next_day))
            if not result.scalars().first():
                break
            next_day += timedelta(days=1)
        return next_day

    def validate_date_range(self, start_date: date, end_date: date):
        """–ü—Ä–æ–≤–µ—Ä—è–µ—Ç, —á—Ç–æ –∫–æ–Ω–µ—á–Ω–∞—è –¥–∞—Ç–∞ —Å—Ç—Ä–æ–≥–æ –±–æ–ª—å—à–µ –Ω–∞—á–∞–ª—å–Ω–æ–π."""
        if start_date >= end_date:
            raise HTTPException(
                status_code=400,
                detail="–î–∞—Ç–∞ –æ–∫–æ–Ω—á–∞–Ω–∏—è –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å –ø–æ–∑–∂–µ –¥–∞—Ç—ã –Ω–∞—á–∞–ª–∞."
            )

    async def validate_holidays(self, start_date: date, end_date: date):
        """–ü—Ä–æ–≤–µ—Ä—è–µ—Ç, —á—Ç–æ –¥–∞—Ç–∞ –Ω–∞—á–∞–ª–∞ –∏–ª–∏ –æ–∫–æ–Ω—á–∞–Ω–∏—è —Ä–µ–∑–µ—Ä–≤–∞ –Ω–µ –≤—ã–ø–∞–¥–∞–µ—Ç –Ω–∞ –≤—ã—Ö–æ–¥–Ω–æ–π."""
        start_result = await self.db.execute(select(Holiday).filter(Holiday.date == start_date))
        is_start_holiday = start_result.scalars().first()
        
        end_result = await self.db.execute(select(Holiday).filter(Holiday.date == end_date))
        is_end_holiday = end_result.scalars().first()
        
        if is_start_holiday or is_end_holiday:
            raise HTTPException(
                status_code=400,
                detail="–ù–µ–ª—å–∑—è –Ω–∞—á–∞—Ç—å –∏–ª–∏ –∑–∞–∫–æ–Ω—á–∏—Ç—å —Ä–µ–∑–µ—Ä–≤ –≤ –≤—ã—Ö–æ–¥–Ω–æ–π –¥–µ–Ω—å."
            )

    async def get_rental_days(self, start_date: date, end_date: date) -> int:
        """–†–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ—Ç –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ç–∞—Ä–∏—Ñ–∏—Ü–∏—Ä—É–µ–º—ã—Ö —Å—É—Ç–æ–∫, –∏—Å–∫–ª—é—á–∞—è –≤—ã—Ö–æ–¥–Ω—ã–µ –¥–Ω–∏."""
        if start_date >= end_date:
            return 0
        total_days = (end_date - start_date).days
        holidays_result = await self.db.execute(
            select(func.count(Holiday.date)).filter(
                Holiday.date > start_date,
                Holiday.date < end_date
            )
        )
        holidays_count = holidays_result.scalar_one()
        return total_days - holidays_count

    async def calculate_final_price(
            self,
            equipment_ids: List[int],
            selected_accessories: Optional[Dict[int, List[int]]],
            start_date: date,
            end_date: date,
            promo_code: Optional[PromoCode]
    ) -> PriceDetails:
        """–†–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ—Ç –ø–æ–ª–Ω—É—é, —Ñ–∏–Ω–∞–ª—å–Ω—É—é —Å—Ç–æ–∏–º–æ—Å—Ç—å –∑–∞–∫–∞–∑–∞, –≤–∫–ª—é—á–∞—è –≤—Å–µ —Å–∫–∏–¥–∫–∏."""
        if not equipment_ids:
            return PriceDetails(full_total=0.0, discount_amount=0.0, final_total=0.0)

        rental_days = await self.get_rental_days(start_date, end_date)
        if rental_days <= 0:
            return PriceDetails(full_total=0.0, discount_amount=0.0, final_total=0.0)

        equipment_result = await self.db.execute(
            select(Equipment)
            .filter(Equipment.id.in_(equipment_ids))
            .options(
                selectinload(Equipment.accessories),
                selectinload(Equipment.associations)
            )
        )
        selected_equipment = equipment_result.unique().scalars().all()
        base_equipment_cost = sum(item.daily_rate for item in selected_equipment)

        accessories_cost = 0.0
        if selected_accessories:
            all_accessory_ids = [acc_id for equip_accs in selected_accessories.values() for acc_id in equip_accs]
            if all_accessory_ids:
                accessories_result = await self.db.execute(select(Accessory).filter(Accessory.id.in_(all_accessory_ids)))
                found_accessories = accessories_result.unique().scalars().all()
                accessories_cost = sum(acc.price for acc in found_accessories)

        full_total = (base_equipment_cost + accessories_cost) * rental_days
        duration_discount = await get_duration_discount_percentage(self.db, rental_days)
        
        # –ò—Å–ø–æ–ª—å–∑—É–µ–º –Ω–æ–≤—É—é –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—É –ø—Ä–æ–º–æ–∫–æ–¥–æ–≤ –¥–ª—è —Ä–∞—Å—á–µ—Ç–∞ —Å–∫–∏–¥–∫–∏
        promo_discount = 0
        if promo_code:
            business_logic = PromoCodeBusinessLogic(self.db)
            promo_discount = promo_code.discount_percentage
            # –ò—Å–ø–æ–ª—å–∑—É–µ–º –º–µ—Ç–æ–¥ –≤–∞–ª–∏–¥–∞—Ü–∏–∏ –∫–æ–º–±–∏–Ω–∏—Ä–æ–≤–∞–Ω–Ω–æ–π —Å–∫–∏–¥–∫–∏
            total_discount_percentage = business_logic.validate_combined_discount(
                duration_discount, promo_discount
            )
        else:
            total_discount_percentage = duration_discount

        discount_amount = full_total * (total_discount_percentage / 100)
        final_total = full_total - discount_amount

        return PriceDetails(
            full_total=round(full_total, 2),
            discount_amount=round(discount_amount, 2),
            final_total=round(final_total, 2)
        )

    # --- –ú–µ—Ç–æ–¥—ã —Ä–∞—Å—á–µ—Ç–∞ –∞—Ä–µ–Ω–¥—ã (–∏–∑ rental_calculation_service) ---

    async def calculate_daily_rate(self, rental: Rental) -> float:
        """
        –†–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ—Ç –¥–Ω–µ–≤–Ω—É—é —Å—Ç–∞–≤–∫—É –∞—Ä–µ–Ω–¥—ã –Ω–∞ –æ—Å–Ω–æ–≤–µ –æ–±—â–µ–π —Å—Ç–æ–∏–º–æ—Å—Ç–∏ –∏ –ø–ª–∞–Ω–æ–≤–æ–≥–æ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ –¥–Ω–µ–π.
        """
        if rental.total_cost <= 0:
            return 0.0
            
        planned_days = await self.get_rental_days(rental.start_date, rental.end_date)
        if planned_days <= 0:
            return 0.0
            
        return rental.total_cost / planned_days
    
    def calculate_overdue_days(self, rental: Rental, actual_return_date: date) -> int:
        """
        –†–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ—Ç –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø—Ä–æ—Å—Ä–æ—á–µ–Ω–Ω—ã—Ö –¥–Ω–µ–π.
        """
        if actual_return_date <= rental.end_date:
            return 0
            
        return (actual_return_date - rental.end_date).days
    
    async def calculate_overdue_surcharge(self, rental: Rental, actual_return_date: date) -> float:
        """
        –†–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ—Ç —à—Ç—Ä–∞—Ñ –∑–∞ –ø—Ä–æ—Å—Ä–æ—á–µ–Ω–Ω—ã–µ –¥–Ω–∏ –∞—Ä–µ–Ω–¥—ã.
        """
        overdue_days = self.calculate_overdue_days(rental, actual_return_date)
        if overdue_days <= 0:
            return 0.0
            
        daily_rate = await self.calculate_daily_rate(rental)
        if daily_rate <= 0:
            return 0.0
            
        surcharge_amount = daily_rate * overdue_days
        return round(surcharge_amount, 2)
    
    async def calculate_early_return_credit(self, rental: Rental, actual_return_date: date, planned_days: int) -> float:
        """
        –†–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ—Ç –∫—Ä–µ–¥–∏—Ç –∑–∞ –¥–æ—Å—Ä–æ—á–Ω—ã–π –≤–æ–∑–≤—Ä–∞—Ç –∞—Ä–µ–Ω–¥—ã.
        """
        if actual_return_date >= rental.end_date or planned_days <= 0:
            return 0.0

        daily_rate = await self.calculate_daily_rate(rental)
        if daily_rate <= 0:
            return 0.0
            
        # –†–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ–º –∏–º–µ–Ω–Ω–æ —Ç–∞—Ä–∏—Ñ–∏—Ü–∏—Ä—É–µ–º—ã–µ –¥–Ω–∏ –≤ –æ—Å—Ç–∞–≤—à–µ–º—Å—è –ø–µ—Ä–∏–æ–¥–µ
        unused_billable_days = await self.get_rental_days(actual_return_date, rental.end_date)
        if unused_billable_days <= 0:
            return 0.0
            
        credit_amount = unused_billable_days * daily_rate
        return round(credit_amount, 2)
    
    async def get_rental_calculation_summary(self, rental: Rental, actual_return_date: date, planned_days: int) -> dict:
        """
        –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç –ø–æ–ª–Ω—É—é —Å–≤–æ–¥–∫—É —Ä–∞—Å—á–µ—Ç–æ–≤ –¥–ª—è –∞—Ä–µ–Ω–¥—ã.
        """
        daily_rate = await self.calculate_daily_rate(rental)
        overdue_days = self.calculate_overdue_days(rental, actual_return_date)
        surcharge_amount = await self.calculate_overdue_surcharge(rental, actual_return_date)
        credit_amount = await self.calculate_early_return_credit(rental, actual_return_date, planned_days)
        
        return {
            'daily_rate': daily_rate,
            'overdue_days': overdue_days,
            'surcharge_amount': surcharge_amount,
            'credit_amount': credit_amount,
            'is_overdue': overdue_days > 0,
            'is_early_return': actual_return_date < rental.end_date and credit_amount > 0
        }

    # --- –£–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω—ã–π –º–µ—Ç–æ–¥ –æ–±–æ–≥–∞—â–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö ---

    async def enrich_order_with_financials(self, order: Union[Rental, Reservation]) -> Union[RentalOut, AdminReservationOut, ReservationItem]:
        """
        –£–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω—ã–π –º–µ—Ç–æ–¥ –¥–ª—è –æ–±–æ–≥–∞—â–µ–Ω–∏—è –∑–∞–∫–∞–∑–∞ (–∞—Ä–µ–Ω–¥—ã –∏–ª–∏ —Ä–µ–∑–µ—Ä–≤–∞) —Ñ–∏–Ω–∞–Ω—Å–æ–≤—ã–º–∏ –¥–∞–Ω–Ω—ã–º–∏.
        
        Args:
            order: ORM-–æ–±—ä–µ–∫—Ç –∞—Ä–µ–Ω–¥—ã –∏–ª–∏ —Ä–µ–∑–µ—Ä–≤–∞
            
        Returns:
            Pydantic-—Å—Ö–µ–º–∞ —Å –ø–æ–ª–Ω–æ—Å—Ç—å—é –∑–∞–ø–æ–ª–Ω–µ–Ω–Ω—ã–º–∏ —Ñ–∏–Ω–∞–Ω—Å–æ–≤—ã–º–∏ –¥–∞–Ω–Ω—ã–º–∏
        """
        if isinstance(order, Rental):
            return await self._enrich_rental_with_financials(order)
        elif isinstance(order, Reservation):
            return await self._enrich_reservation_with_financials(order)
        else:
            raise ValueError(f"Unsupported order type: {type(order)}")

    async def _enrich_rental_with_financials(self, rental: Rental) -> RentalOut:
        """–û–±–æ–≥–∞—â–∞–µ—Ç –æ–±—ä–µ–∫—Ç –∞—Ä–µ–Ω–¥—ã —Ñ–∏–Ω–∞–Ω—Å–æ–≤—ã–º–∏ –¥–∞–Ω–Ω—ã–º–∏."""
        rental_out = RentalOut.model_validate(rental)
        today = date.today()

        # –î–∏–Ω–∞–º–∏—á–µ—Å–∫–∏–π —Å—Ç–∞—Ç—É—Å overdue
        if rental.status == 'active' and rental.end_date < today:
            rental_out.status = 'overdue'

        # –†–∞—Å—á–µ—Ç –ø—Ä–æ—Å—Ä–æ—á–∫–∏ –∏–ª–∏ –æ—Å—Ç–∞–≤—à–∏—Ö—Å—è –¥–Ω–µ–π
        if rental_out.status == 'overdue':
            rental_out.overdue_days = self.calculate_overdue_days(rental, today)
            rental_out.overdue_surcharge = await self.calculate_overdue_surcharge(rental, today)
        elif rental.status == 'active':
            rental_out.days_remaining = (rental.end_date - today).days

        # –†–∞—Å—á–µ—Ç —Å—Ç–æ–∏–º–æ—Å—Ç–∏ –∞–∫—Å–µ—Å—Å—É–∞—Ä–æ–≤
        accessories_cost = 0.0
        for accessory_link in rental.accessory_links:
            if accessory_link.accessory and accessory_link.accessory.price:
                accessories_cost += accessory_link.accessory.price
        rental_out.accessories_cost = accessories_cost

        # –†–∞—Å—á–µ—Ç –æ—Å—Ç–∞—Ç–∫–∞ –∫ –æ–ø–ª–∞—Ç–µ
        rental_out.remaining_amount = rental.total_cost - rental.prepayment_amount

        return rental_out

    async def _enrich_reservation_with_financials(self, reservation: Reservation) -> ReservationItem:
        """–û–±–æ–≥–∞—â–∞–µ—Ç –æ–±—ä–µ–∫—Ç —Ä–µ–∑–µ—Ä–≤–∞ —Ñ–∏–Ω–∞–Ω—Å–æ–≤—ã–º–∏ –¥–∞–Ω–Ω—ã–º–∏."""
        reservation_out = ReservationItem.model_validate(reservation)
        today = date.today()

        # –î–∏–Ω–∞–º–∏—á–µ—Å–∫–∏–π —Å—Ç–∞—Ç—É—Å overdue
        if reservation.status == 'active' and reservation.end_date < today:
            reservation_out.status = 'overdue'

        # –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º rental_id –µ—Å–ª–∏ –µ—Å—Ç—å —Å–≤—è–∑–∞–Ω–Ω–∞—è –∞—Ä–µ–Ω–¥–∞
        if reservation.rental:
            reservation_out.rental_id = reservation.rental.id

        return reservation_out

    async def _enrich_admin_reservation_with_financials(self, reservation: Reservation) -> AdminReservationOut:
        """–û–±–æ–≥–∞—â–∞–µ—Ç –æ–±—ä–µ–∫—Ç —Ä–µ–∑–µ—Ä–≤–∞ –¥–ª—è –∞–¥–º–∏–Ω-–ø–∞–Ω–µ–ª–∏ —Ñ–∏–Ω–∞–Ω—Å–æ–≤—ã–º–∏ –¥–∞–Ω–Ω—ã–º–∏."""
        if not reservation.user:
            raise ValueError("Reservation must have user for admin view")

        reservation_base = await self._enrich_reservation_with_financials(reservation)
        user_info = reservation.user

        return AdminReservationOut(
            **reservation_base.model_dump(),
            user_info=user_info
        )

```



## `api\services\order\order_lifecycle_service.py`


```python

# api/services/order/order_lifecycle_service.py

from sqlalchemy.ext.asyncio import AsyncSession
from datetime import date
import logging

from api.models.user import User
from api.models.rental import Rental, RentalAccessory
from api.models.reservation import Reservation
from api.services.order.order_repository import OrderRepository
from api.services.order.order_validator import OrderValidator
from api.services.balance_service import BalanceService
from api.services.financial_service import FinancialService
from api.services.promo_code_service import validate_promo_code_for_use

from shared.schemas.reservation_schema import ReservationCreateRequest, ReservationUpdateRequest, AdminReservationCreateRequest
from shared.schemas.rental_schema import RentalCreateFromReservationRequest, RentalReturnRequest, RentalCreateFromScratchRequest, AdminRentalUpdate

logger = logging.getLogger(__name__)

class OrderLifecycleService:
    """
    –ï–¥–∏–Ω—ã–π —Å–µ—Ä–≤–∏—Å –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –ø–æ–ª–Ω—ã–º –∂–∏–∑–Ω–µ–Ω–Ω—ã–º —Ü–∏–∫–ª–æ–º –∑–∞–∫–∞–∑–∞:
    –æ—Ç —Å–æ–∑–¥–∞–Ω–∏—è —Ä–µ–∑–µ—Ä–≤–∞ –¥–æ –≤–æ–∑–≤—Ä–∞—Ç–∞ –∞—Ä–µ–Ω–¥—ã.
    """
    def __init__(self, db: AsyncSession):
        self.db = db
        self.repo = OrderRepository(db)
        self.validator = OrderValidator(db)
        self.balance_service = BalanceService(db)
        self.financial_service = FinancialService(db)

    # --- –ú–µ—Ç–æ–¥—ã –¥–ª—è –†–µ–∑–µ—Ä–≤–æ–≤ (–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å) ---

    async def create_user_reservation(self, request: ReservationCreateRequest, user: User) -> Reservation:
        await self.validator.validate_dates_and_holidays(request.start_date, request.end_date)
        equipment = await self.repo.get_equipment_by_ids_or_fail(request.equipment_ids)
        self.validator.validate_accessories_for_equipment(request.selected_accessories, request.equipment_ids)
        await self.validator.validate_equipment_availability(request.equipment_ids, request.start_date, request.end_date)

        promo_code_obj = await self.repo.get_promo_code_by_name(request.promo_code) if request.promo_code else None
        price_details = await self.financial_service.calculate_final_price(request.equipment_ids, request.selected_accessories, request.start_date, request.end_date, promo_code_obj)

        reservation = self.repo.create_reservation_instance(
            user_id=user.id,
            start_date=request.start_date,
            end_date=request.end_date,
            equipment=equipment,
            price_details=price_details,
            promo_code_id=promo_code_obj.id if promo_code_obj else None
        )
        self.repo.add_accessories_to_reservation(reservation, request.selected_accessories)
        await self.repo.save(reservation)
        logger.info(f"User {user.id} created reservation #{reservation.id}")
        return await self.repo.get_reservation_by_id_or_fail(reservation.id)

    async def update_user_reservation(self, reservation_id: int, request: ReservationUpdateRequest, user: User) -> Reservation:
        reservation = await self.repo.get_reservation_by_id_or_fail(reservation_id, user_id=user.id)
        await self.validator.validate_dates_and_holidays(request.start_date, request.end_date)
        equipment = await self.repo.get_equipment_by_ids_or_fail(request.equipment_ids)
        self.validator.validate_accessories_for_equipment(request.selected_accessories, request.equipment_ids)
        await self.validator.validate_equipment_availability(request.equipment_ids, request.start_date, request.end_date, exclude_reservation_id=reservation_id)

        promo_code_obj = await self.repo.get_promo_code_by_name(request.promo_code) if request.promo_code else None
        price_details = await self.financial_service.calculate_final_price(request.equipment_ids, request.selected_accessories, request.start_date, request.end_date, promo_code_obj)

        self.repo.update_reservation_instance(
            reservation=reservation,
            start_date=request.start_date,
            end_date=request.end_date,
            equipment=equipment,
            price_details=price_details,
            promo_code_id=promo_code_obj.id if promo_code_obj else None
        )
        await self.repo.update_accessories_for_reservation(reservation, request.selected_accessories)
        await self.repo.save(reservation)
        logger.info(f"User {user.id} updated reservation #{reservation.id}")
        return await self.repo.get_reservation_by_id_or_fail(reservation.id)

    async def cancel_user_reservation(self, reservation_id: int, user: User):
        reservation = await self.repo.get_reservation_by_id_or_fail(reservation_id, user_id=user.id)
        self.validator.validate_reservation_is_cancellable(reservation)
        await self.repo.delete(reservation)
        logger.info(f"User {user.id} cancelled reservation #{reservation_id}")

    # --- –ú–µ—Ç–æ–¥—ã –¥–ª—è –†–µ–∑–µ—Ä–≤–æ–≤ (–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä) ---

    async def create_admin_reservation(self, request: AdminReservationCreateRequest) -> Reservation:
        user = await self.repo.get_user_by_id_or_fail(request.user_id)
        # –î–ª—è –∞–¥–º–∏–Ω–∞ –º—ã –º–æ–∂–µ–º –ø–æ–≤—Ç–æ—Ä–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –ª–æ–≥–∏–∫—É —Å–æ–∑–¥–∞–Ω–∏—è –æ–±—ã—á–Ω–æ–≥–æ —Ä–µ–∑–µ—Ä–≤–∞
        return await self.create_user_reservation(request, user)

    async def update_admin_reservation(self, reservation_id: int, request: ReservationUpdateRequest) -> Reservation:
        reservation = await self.repo.get_reservation_by_id_or_fail(reservation_id)
        user = await self.repo.get_user_by_id_or_fail(reservation.user_id)
        # –ê–Ω–∞–ª–æ–≥–∏—á–Ω–æ, –∏—Å–ø–æ–ª—å–∑—É–µ–º –æ–±—â—É—é –ª–æ–≥–∏–∫—É –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è
        return await self.update_user_reservation(reservation_id, request, user)

    async def cancel_admin_reservation(self, reservation_id: int):
        reservation = await self.repo.get_reservation_by_id_or_fail(reservation_id)
        self.validator.validate_reservation_is_cancellable(reservation)
        await self.repo.delete(reservation)
        logger.warning(f"Admin cancelled reservation #{reservation_id}")

    async def bulk_cancel_admin_reservations(self, reservation_ids: list[int]):
        reservations = await self.repo.get_reservations_by_ids(reservation_ids)
        cancellable, not_cancellable = self.validator.filter_cancellable_reservations(reservations)

        if not_cancellable:
            logger.warning(f"Cannot bulk delete reservations already converted to rental: {[r.id for r in not_cancellable]}")

        for reservation in cancellable:
            await self.repo.delete(reservation)

        logger.warning(f"Admin bulk cancelled reservations: {[r.id for r in cancellable]}")

    # --- –ú–µ—Ç–æ–¥—ã –¥–ª—è –ê—Ä–µ–Ω–¥ (–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä) ---

    async def convert_reservation_to_rental(self, reservation_id: int, request: RentalCreateFromReservationRequest, manager: User) -> Rental:
        reservation = await self.repo.get_reservation_by_id_or_fail(reservation_id)
        self.validator.validate_reservation_for_conversion(reservation)
        await self.validator.validate_issue_on_holiday(date.today(), request.force_issue_on_holiday)

        # --- –ù–ê–ß–ê–õ–û –ò–ó–ú–ï–ù–ï–ù–ò–ô ---
        # 1. –ü–ï–†–ï–°–ß–ò–¢–´–í–ê–ï–ú –°–¢–û–ò–ú–û–°–¢–¨ –ü–ï–†–ï–î –ö–û–ù–í–ï–†–¢–ê–¶–ò–ï–ô
        price_details = await self.financial_service.calculate_final_price(
            reservation.equipment_ids,
            reservation.selected_accessories, # –ò—Å–ø–æ–ª—å–∑—É–µ–º —Å–≤–æ–π—Å—Ç–≤–æ –º–æ–¥–µ–ª–∏ –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –∞–∫—Å–µ—Å—Å—É–∞—Ä–æ–≤
            date.today(), # –ê—Ä–µ–Ω–¥–∞ –≤—Å–µ–≥–¥–∞ –Ω–∞—á–∏–Ω–∞–µ—Ç—Å—è –≤ –¥–µ–Ω—å –≤—ã–¥–∞—á–∏
            reservation.end_date,
            reservation.applied_promo_code
        )

        # 2. –ü–µ—Ä–µ–¥–∞–µ–º –ø–µ—Ä–µ—Å—á–∏—Ç–∞–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –≤ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π
        rental = self.repo.create_rental_from_reservation(
            reservation, 
            manager, 
            request.deposit_amount, 
            request.notes_on_issue,
            # –ü–µ—Ä–µ–¥–∞–µ–º –Ω–æ–≤—ã–µ –¥–∞–Ω–Ω—ã–µ –æ —Ü–µ–Ω–µ
            recalculated_cost=price_details.final_total,
            recalculated_discount=price_details.discount_amount,
            prepayment_amount=request.prepayment_amount
        )
        # --- –ö–û–ù–ï–¶ –ò–ó–ú–ï–ù–ï–ù–ò–ô ---

        # –ù–∞—á–∏—Å–ª—è–µ–º –ø—Ä–µ–¥–æ–ø–ª–∞—Ç—É –Ω–∞ –±–∞–ª–∞–Ω—Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (–µ—Å–ª–∏ –µ—Å—Ç—å)
        if request.prepayment_amount > 0:
            await self.balance_service.add_transaction(
                user_id=rental.user_id,
                amount=request.prepayment_amount,
                operation_type="prepayment",
                description=f"–ü—Ä–µ–¥–æ–ø–ª–∞—Ç–∞ –∑–∞ –∞—Ä–µ–Ω–¥—É #{rental.id} (–∏–∑ —Ä–µ–∑–µ—Ä–≤–∞ #{reservation.id})",
                rental_id=rental.id
            )

        await self.balance_service.add_transaction(
            user_id=rental.user_id,
            amount=-rental.total_cost,
            operation_type="rental_debit",
            description=f"–°–ø–∏—Å–∞–Ω–∏–µ –∑–∞ –∞—Ä–µ–Ω–¥—É (–∏–∑ —Ä–µ–∑–µ—Ä–≤–∞ #{reservation.id}) –Ω–∞ —Å—É–º–º—É {rental.total_cost} —Ä—É–±.",
            rental_id=rental.id
        )
        await self.repo.save(rental)
        logger.info(f"Manager {manager.id} converted reservation #{reservation_id} to rental #{rental.id}")
        return await self.repo.get_rental_by_id_or_fail(rental.id) # –í–æ–∑–≤—Ä–∞—â–∞–µ–º —Å –ø–æ–¥–≥—Ä—É–∂–µ–Ω–Ω—ã–º–∏ —Å–≤—è–∑—è–º–∏

    async def create_rental_from_scratch(self, request: RentalCreateFromScratchRequest, manager: User) -> Rental:
        user = await self.repo.get_user_by_id_or_fail(request.user_id)
        await self.validator.validate_equipment_availability(request.equipment_ids, request.start_date, request.end_date)
        equipment = await self.repo.get_equipment_by_ids_or_fail(request.equipment_ids)
        price_details = await self.financial_service.calculate_final_price(request.equipment_ids, None, request.start_date, request.end_date, None)

        rental = self.repo.create_rental_instance(
            user=user,
            manager=manager,
            start_date=request.start_date,
            end_date=request.end_date,
            equipment=equipment,
            total_cost=price_details.final_total,
            deposit_amount=request.deposit_amount,
            notes_on_issue=request.notes_on_issue
        )

        await self.balance_service.add_transaction(
            user_id=user.id,
            amount=-rental.total_cost,
            operation_type="rental_debit",
            description=f"–°–ø–∏—Å–∞–Ω–∏–µ –∑–∞ –Ω–æ–≤—É—é –∞—Ä–µ–Ω–¥—É #{rental.id} –Ω–∞ —Å—É–º–º—É {rental.total_cost} —Ä—É–±.",
            rental_id=rental.id
        )
        await self.repo.save(rental)
        logger.info(f"Manager {manager.id} created rental from scratch #{rental.id} for user {user.id}")
        return await self.repo.get_rental_by_id_or_fail(rental.id)

    async def return_rental(self, rental_id: int, request: RentalReturnRequest, manager: User) -> Rental:
        rental = await self.repo.get_rental_by_id_or_fail(rental_id)
        self.validator.validate_accessories_returned(rental, request.accessories_returned_confirmation)

        # –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –¥–ª—è —Ä–∞—Å—á–µ—Ç–∞ –∫—Ä–µ–¥–∏—Ç–∞ –∏ —à—Ç—Ä–∞—Ñ–∞
        credit_amount = 0.0
        surcharge_amount = 0.0

        # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —è–≤–ª—è–µ—Ç—Å—è –ª–∏ –≤–æ–∑–≤—Ä–∞—Ç –ø—Ä–æ—Å—Ä–æ—á–µ–Ω–Ω—ã–º
        if request.actual_return_date > rental.end_date:
            # –ü—Ä–æ—Å—Ä–æ—á–µ–Ω–Ω—ã–π –≤–æ–∑–≤—Ä–∞—Ç - —Ä–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ–º —à—Ç—Ä–∞—Ñ
            surcharge_amount = await self.financial_service.calculate_overdue_surcharge(rental, request.actual_return_date)
            
            if surcharge_amount > 0:
                # –°–æ–∑–¥–∞–µ–º –¥–µ–±–µ—Ç–æ–≤—É—é —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—é –¥–ª—è —Å–ø–∏—Å–∞–Ω–∏—è —à—Ç—Ä–∞—Ñ–∞
                await self.balance_service.add_transaction(
                    user_id=rental.user_id,
                    amount=-surcharge_amount,  # –û—Ç—Ä–∏—Ü–∞—Ç–µ–ª—å–Ω–∞—è —Å—É–º–º–∞ –¥–ª—è —Å–ø–∏—Å–∞–Ω–∏—è
                    operation_type="overdue_surcharge_debit",
                    description=f"–°–ø–∏—Å–∞–Ω–∏–µ –∑–∞ –ø—Ä–æ—Å—Ä–æ—á–∫—É –∞—Ä–µ–Ω–¥—ã #{rental.id} –Ω–∞ {surcharge_amount} —Ä—É–±.",
                    rental_id=rental.id
                )
                logger.info(f"Applied overdue surcharge of {surcharge_amount} rub. for rental #{rental.id}")
        else:
            # –í–æ–∑–≤—Ä–∞—Ç –≤–æ–≤—Ä–µ–º—è –∏–ª–∏ –¥–æ—Å—Ä–æ—á–Ω–æ - —Ä–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ–º –∫—Ä–µ–¥–∏—Ç –∑–∞ –¥–æ—Å—Ä–æ—á–Ω—ã–π –≤–æ–∑–≤—Ä–∞—Ç
            planned_days = await self.repo.get_rental_days_count(rental.start_date, rental.end_date)
            credit_amount = await self.financial_service.calculate_early_return_credit(rental, request.actual_return_date, planned_days)
            
            if credit_amount > 0:
                # –°–æ–∑–¥–∞–µ–º –∫—Ä–µ–¥–∏—Ç–æ–≤—É—é —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—é –¥–ª—è –≤–æ–∑–≤—Ä–∞—Ç–∞ —Å—Ä–µ–¥—Å—Ç–≤
                await self.balance_service.add_transaction(
                    user_id=rental.user_id,
                    amount=credit_amount,
                    operation_type="early_return_credit",
                    description=f"–í–æ–∑–≤—Ä–∞—Ç –∑–∞ –¥–æ—Å—Ä–æ—á–Ω–æ–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∏–µ –∞—Ä–µ–Ω–¥—ã #{rental.id} –Ω–∞ —Å—É–º–º—É {credit_amount} —Ä—É–±.",
                    rental_id=rental.id
                )
                logger.info(f"Applied early return credit of {credit_amount} rub. for rental #{rental.id}")

        # –ü–ª–∞—Ç–µ–∂ —Ç–µ–ø–µ—Ä—å –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç—Å—è –æ—Ç–¥–µ–ª—å–Ω—ã–º —ç–Ω–¥–ø–æ–∏–Ω—Ç–æ–º –∏ –Ω–µ —è–≤–ª—è–µ—Ç—Å—è —á–∞—Å—Ç—å—é –ø—Ä–æ—Ü–µ—Å—Å–∞ –≤–æ–∑–≤—Ä–∞—Ç–∞.

        # –§–∏–Ω–∞–ª–∏–∑–∏—Ä—É–µ–º –≤–æ–∑–≤—Ä–∞—Ç —Å —É—á–µ—Ç–æ–º –∏ –∫—Ä–µ–¥–∏—Ç–∞, –∏ —à—Ç—Ä–∞—Ñ–∞
        self.repo.finalize_rental_return(rental, request.actual_return_date, request.notes_on_return, credit_amount, surcharge_amount)
        await self.repo.save(rental)
        logger.info(f"Manager {manager.id} processed return for rental #{rental_id} - credit: {credit_amount}, surcharge: {surcharge_amount}")
        return await self.repo.get_rental_by_id_or_fail(rental.id)

    async def update_rental_details_by_admin(self, rental_id: int, request: AdminRentalUpdate, manager: User) -> Rental:
        rental = await self.repo.get_rental_by_id_or_fail(rental_id)
        update_data = request.model_dump(exclude_unset=True)
        self.repo.update_rental_instance(rental, update_data)
        await self.repo.save(rental)
        logger.info(f"Manager {manager.id} updated details for rental #{rental_id}")
        return await self.repo.get_rental_by_id_or_fail(rental.id)

    async def revert_rental_to_reservation(self, rental_id: int, manager: User):
        rental = await self.repo.get_rental_by_id_or_fail(rental_id)
        self.validator.validate_rental_for_revert(rental)

        reservation = self.repo.revert_rental_status_to_active(rental)

        await self.balance_service.add_transaction(
            user_id=rental.user_id,
            amount=rental.total_cost, # –í–æ–∑–≤—Ä–∞—â–∞–µ–º –ø–æ–ª–Ω—É—é —Å—Ç–æ–∏–º–æ—Å—Ç—å
            operation_type="rental_revert_credit",
            description=f"–í–æ–∑–≤—Ä–∞—Ç —Å—Ä–µ–¥—Å—Ç–≤ –∑–∞ –æ—Ç–º–µ–Ω—É –≤—ã–¥–∞—á–∏ –∞—Ä–µ–Ω–¥—ã #{rental.id}",
            rental_id=rental.id
        )

        await self.repo.delete(rental)
        logger.info(f"Manager {manager.id} reverted rental #{rental_id} to reservation #{reservation.id}")

    async def delete_rental_by_admin(self, rental_id: int):
        rental = await self.repo.get_rental_by_id_or_fail(rental_id)
        await self.repo.delete(rental)
        logger.warning(f"Admin deleted rental #{rental_id}")

```



## `api\services\order\order_query_base.py`


```python

# api/services/order/order_query_base.py

from sqlalchemy.ext.asyncio import AsyncSession
from sqlalchemy.orm import joinedload, selectinload
from sqlalchemy import or_, select, func, desc, asc
from typing import Optional, List, Tuple, TypeVar, Generic
from datetime import date
import logging

from api.models.user import User
from api.models.equipment import Equipment

logger = logging.getLogger(__name__)

T = TypeVar('T')  # –¢–∏–ø –º–æ–¥–µ–ª–∏ (Reservation –∏–ª–∏ Rental)

class OrderQueryBase(Generic[T]):
    """
    –ë–∞–∑–æ–≤—ã–π –∫–ª–∞—Å—Å –¥–ª—è –æ–±—â–∏—Ö –æ–ø–µ—Ä–∞—Ü–∏–π —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏, –ø–æ–∏—Å–∫–∞ –∏ —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∏ –∑–∞–∫–∞–∑–æ–≤.
    –°–æ–¥–µ—Ä–∂–∏—Ç –æ–±—â—É—é –ª–æ–≥–∏–∫—É –¥–ª—è —Ä–µ–∑–µ—Ä–≤–æ–≤ –∏ –∞—Ä–µ–Ω–¥.
    """

    def __init__(self, db: AsyncSession):
        self.db = db

    def _apply_user_search(self, query, search_term: str, model_class):
        """
        –ü—Ä–∏–º–µ–Ω—è–µ—Ç –ø–æ–∏—Å–∫ –ø–æ –∏–º–µ–Ω–∏ –∏–ª–∏ email –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è.
        """
        search_pattern = f"%{search_term.lower()}%"
        # –£–±–µ–∂–¥–∞–µ–º—Å—è, —á—Ç–æ JOIN –∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é —É–∂–µ –µ—Å—Ç—å –∏–ª–∏ –¥–æ–±–∞–≤–ª—è–µ–º –µ–≥–æ
        # –í –Ω–∞—à–∏—Ö —Å–ª—É—á–∞—è—Ö –æ–Ω –≤—Å–µ–≥–¥–∞ –±—É–¥–µ—Ç, —Ç–∞–∫ –∫–∞–∫ –º—ã –µ–≥–æ –¥–æ–±–∞–≤–ª—è–µ–º –≤ –±–∞–∑–æ–≤—ã—Ö –∑–∞–ø—Ä–æ—Å–∞—Ö
        query = query.join(model_class.user).filter(
            or_(
                User.full_name.ilike(search_pattern),
                User.email.ilike(search_pattern)
            )
        )
        return query

    def _apply_equipment_search(self, query, search_term: str, model_class):
        """
        –ü—Ä–∏–º–µ–Ω—è–µ—Ç –ø–æ–ª–Ω–æ—Ç–µ–∫—Å—Ç–æ–≤—ã–π –ø–æ–∏—Å–∫ –ø–æ —Å–≤—è–∑–∞–Ω–Ω–æ–º—É –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—é.
        –ò—â–µ—Ç –ø–æ –ø–æ–ª—è–º name, brand, equipment_type.
        """
        search_pattern = f"%{search_term.lower()}%"
        
        # –ü—Ä–∏–º–µ–Ω—è–µ–º —Ñ–∏–ª—å—Ç—Ä –ø–æ–∏—Å–∫–∞ —á–µ—Ä–µ–∑ EXISTS –ø–æ–¥–∑–∞–ø—Ä–æ—Å
        # –≠—Ç–æ –±–æ–ª–µ–µ –±–µ–∑–æ–ø–∞—Å–Ω—ã–π —Å–ø–æ—Å–æ–± –¥–ª—è —Å–≤—è–∑–∞–Ω–Ω—ã—Ö —Ç–∞–±–ª–∏—Ü
        equipment_subquery = select(Equipment.id).where(
            or_(
                Equipment.name.ilike(search_pattern),
                Equipment.brand.ilike(search_pattern),
                Equipment.equipment_type.ilike(search_pattern)
            )
        )
        
        # –î–æ–±–∞–≤–ª—è–µ–º —Ñ–∏–ª—å—Ç—Ä —á–µ—Ä–µ–∑ EXISTS –¥–ª—è —Å–≤—è–∑–∞–Ω–Ω–æ–≥–æ –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—è
        query = query.filter(
            model_class.equipment.any(
                Equipment.id.in_(equipment_subquery)
            )
        )
        
        return query

    def _apply_status_filter(self, query, status_filter: Optional[str], model_class):
        """
        –ü—Ä–∏–º–µ–Ω—è–µ—Ç —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏—é –ø–æ —Å—Ç–∞—Ç—É—Å—É.
        """
        if not status_filter:
            return query
            
        today = date.today()
        
        if status_filter == "active":
            query = query.filter(model_class.status == 'active')
        elif status_filter == "completed":
            # –î–ª—è —Ä–µ–∑–µ—Ä–≤–æ–≤: fulfilled, cancelled, overdue
            # –î–ª—è –∞—Ä–µ–Ω–¥: completed
            if hasattr(model_class, 'status') and 'fulfilled' in str(model_class.status):
                # –≠—Ç–æ —Ä–µ–∑–µ—Ä–≤
                query = query.filter(model_class.status.in_(['fulfilled', 'cancelled', 'overdue']))
            else:
                # –≠—Ç–æ –∞—Ä–µ–Ω–¥–∞
                query = query.filter(model_class.status == 'completed')
        elif status_filter == "overdue":
            query = query.filter(
                model_class.status == 'active',
                model_class.end_date < today
            )
            
        return query

    def _apply_sorting(self, query, sort_option: Optional[str], model_class):
        """
        –ü—Ä–∏–º–µ–Ω—è–µ—Ç —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫—É –ø–æ —Ä–∞–∑–ª–∏—á–Ω—ã–º –ø–æ–ª—è–º.
        –ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º—ã–µ –æ–ø—Ü–∏–∏: id, start_date, end_date, count
        """
        if not sort_option:
            # –°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
            return query.order_by(model_class.id.desc())
        
        sort_parts = sort_option.split('_')
        field = sort_parts[0]
        direction = sort_parts[1] if len(sort_parts) > 1 else 'desc'
        
        # –û–ø—Ä–µ–¥–µ–ª—è–µ–º –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∏
        sort_func = desc if direction == 'desc' else asc
        
        if field == "id":
            query = query.order_by(sort_func(model_class.id))
        elif field == "start_date":
            query = query.order_by(sort_func(model_class.start_date))
        elif field == "end_date":
            query = query.order_by(sort_func(model_class.end_date))
        elif field == "count":
            # –°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞ –ø–æ –∫–æ–ª–∏—á–µ—Å—Ç–≤—É –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—è
            # –î–ª—è —ç—Ç–æ–≥–æ –Ω—É–∂–Ω–æ –ø–æ–¥—Å—á–∏—Ç–∞—Ç—å –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Å–≤—è–∑–∞–Ω–Ω–æ–≥–æ –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—è
            equipment_count = select(func.count()).select_from(
                model_class.equipment.property.mapper.class_.__table__
            ).where(
                model_class.equipment.property.mapper.class_.id.in_(
                    select(model_class.equipment.property.mapper.class_.id)
                    .where(model_class.id == model_class.id)
                )
            ).scalar_subquery()
            
            query = query.order_by(sort_func(equipment_count))
        else:
            # –ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ–µ –ø–æ–ª–µ - –∏—Å–ø–æ–ª—å–∑—É–µ–º —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫—É –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
            query = query.order_by(model_class.id.desc())
            
        return query

    def _apply_pagination(self, query, skip: int, limit: int):
        """
        –ü—Ä–∏–º–µ–Ω—è–µ—Ç –ø–∞–≥–∏–Ω–∞—Ü–∏—é –∫ –∑–∞–ø—Ä–æ—Å—É.
        """
        return query.offset(skip).limit(limit)

    async def _get_total_count(self, base_query) -> int:
        """
        –ü–æ–ª—É—á–∞–µ—Ç –æ–±—â–µ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∑–∞–ø–∏—Å–µ–π –¥–ª—è –±–∞–∑–æ–≤–æ–≥–æ –∑–∞–ø—Ä–æ—Å–∞.
        """
        count_query = select(func.count()).select_from(base_query.subquery())
        result = await self.db.execute(count_query)
        return result.scalar_one()

    def _get_equipment_joins(self):
        """
        –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–µ JOIN'—ã –¥–ª—è –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—è.
        –ü–µ—Ä–µ–æ–ø—Ä–µ–¥–µ–ª—è–µ—Ç—Å—è –≤ –Ω–∞—Å–ª–µ–¥–Ω–∏–∫–∞—Ö –¥–ª—è —Å–ø–µ—Ü–∏—Ñ–∏—á–Ω—ã—Ö –º–æ–¥–µ–ª–µ–π.
        """
        return [
            selectinload(Equipment.accessories),
            selectinload(Equipment.associations)
        ]

```



## `api\services\order\order_repository.py`


```python

# api/services/order/order_repository.py

from sqlalchemy.ext.asyncio import AsyncSession
from sqlalchemy.orm import joinedload, selectinload
from sqlalchemy import select
from datetime import date
from typing import Optional, List, Dict
import logging

from fastapi import HTTPException, status
from api.models.user import User
from api.models.equipment import Equipment
from api.models.promo_code import PromoCode
from api.models.holiday import Holiday
from api.models.reservation import Reservation, ReservationAccessory
from api.models.rental import Rental, RentalAccessory
from api.services.financial_service import FinancialService, PriceDetails

logger = logging.getLogger(__name__)

class OrderRepository:
    """
    –°–ª–æ–π –¥–æ—Å—Ç—É–ø–∞ –∫ –¥–∞–Ω–Ω—ã–º –¥–ª—è —Å—É—â–Ω–æ—Å—Ç–µ–π, —Å–≤—è–∑–∞–Ω–Ω—ã—Ö —Å –∑–∞–∫–∞–∑–∞–º–∏ (–†–µ–∑–µ—Ä–≤—ã –∏ –ê—Ä–µ–Ω–¥—ã).
    –ò–Ω–∫–∞–ø—Å—É–ª–∏—Ä—É–µ—Ç –≤—Å–µ –ø—Ä—è–º—ã–µ –∑–∞–ø—Ä–æ—Å—ã –∫ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö.
    """
    def __init__(self, db: AsyncSession):
        self.db = db
        self.financial_service = FinancialService(db)

    async def get_user_by_id_or_fail(self, user_id: int) -> User:
        user = await self.db.get(User, user_id)
        if not user:
            raise HTTPException(status_code=status.HTTP_404_NOT_FOUND, detail=f"User with ID {user_id} not found.")
        return user

    async def get_equipment_by_ids_or_fail(self, equipment_ids: List[int]) -> List[Equipment]:
        result = await self.db.execute(
            select(Equipment)
            .filter(Equipment.id.in_(equipment_ids))
            .options(
                selectinload(Equipment.accessories),
                selectinload(Equipment.associations)
            )
        )
        equipment = result.unique().scalars().all()
        if len(equipment) != len(set(equipment_ids)):
            found_ids = {eq.id for eq in equipment}
            missing_ids = set(equipment_ids) - found_ids
            raise HTTPException(status_code=status.HTTP_404_NOT_FOUND, detail=f"Equipment with IDs {list(missing_ids)} not found.")
        return equipment

    async def get_promo_code_by_name(self, code: str) -> Optional[PromoCode]:
        result = await self.db.execute(select(PromoCode).filter(PromoCode.code == code))
        return result.unique().scalar_one_or_none()

    async def get_reservation_by_id_or_fail(self, reservation_id: int, user_id: Optional[int] = None) -> Reservation:
        # –ò—Å–ø–æ–ª—å–∑—É–µ–º db.get –¥–ª—è –ø—Ä–æ—Å—Ç–æ–≥–æ –∏ —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ–≥–æ –ø–æ–ª—É—á–µ–Ω–∏—è –ø–æ PK
        reservation = await self.db.get(Reservation, reservation_id, options=[
            joinedload(Reservation.user),
            selectinload(Reservation.equipment).options(
                selectinload(Equipment.accessories),
                selectinload(Equipment.associations)
            ),
            joinedload(Reservation.accessory_links).joinedload(ReservationAccessory.accessory),
            joinedload(Reservation.rental)
        ])

        if not reservation:
            raise HTTPException(status_code=status.HTTP_404_NOT_FOUND, detail=f"Reservation with ID {reservation_id} not found")

        if user_id and reservation.user_id != user_id:
            raise HTTPException(status_code=status.HTTP_404_NOT_FOUND, detail="Reservation not found or you do not have permission to access it.")

        return reservation

    async def get_reservations_by_ids(self, ids: List[int]) -> List[Reservation]:
        result = await self.db.execute(select(Reservation).filter(Reservation.id.in_(ids)).options(joinedload(Reservation.rental)))
        return result.unique().scalars().all()

    async def get_rental_by_id_or_fail(self, rental_id: int) -> Rental:
        query = select(Rental).options(
            joinedload(Rental.user),
            selectinload(Rental.equipment).options(
                selectinload(Equipment.accessories),
                selectinload(Equipment.associations)
            ),
            joinedload(Rental.reservation),
            joinedload(Rental.accessory_links).joinedload(RentalAccessory.accessory)
        ).filter(Rental.id == rental_id)

        result = await self.db.execute(query)
        rental = result.unique().scalar_one_or_none()

        if not rental:
            raise HTTPException(status_code=status.HTTP_404_NOT_FOUND, detail=f"Rental with ID {rental_id} not found.")
        return rental

    async def is_holiday(self, check_date: date) -> bool:
        result = await self.db.execute(select(Holiday).filter(Holiday.date == check_date))
        return result.scalar_one_or_none() is not None

    async def get_rental_days_count(self, start_date: date, end_date: date) -> int:
        return await self.financial_service.get_rental_days(start_date, end_date)

    def create_reservation_instance(self, user_id: int, start_date: date, end_date: date, equipment: List[Equipment], price_details: PriceDetails, promo_code_id: Optional[int]) -> Reservation:
        return Reservation(
            user_id=user_id,
            start_date=start_date,
            end_date=end_date,
            equipment=equipment,
            total_cost=price_details.final_total,
            discount_amount=price_details.discount_amount,
            promo_code_id=promo_code_id
        )

    def update_reservation_instance(self, reservation: Reservation, start_date: date, end_date: date, equipment: List[Equipment], price_details: PriceDetails, promo_code_id: Optional[int]):
        reservation.start_date = start_date
        reservation.end_date = end_date
        reservation.equipment = equipment
        reservation.total_cost = price_details.final_total
        reservation.discount_amount = price_details.discount_amount
        reservation.promo_code_id = promo_code_id

    def add_accessories_to_reservation(self, reservation: Reservation, selected_accessories: Optional[Dict[int, List[int]]]):
        if not selected_accessories:
            return
        links = []
        for eq_id, acc_ids in selected_accessories.items():
            for acc_id in acc_ids:
                links.append(ReservationAccessory(equipment_id=eq_id, accessory_id=acc_id))
        reservation.accessory_links = links

    async def update_accessories_for_reservation(self, reservation: Reservation, selected_accessories: Optional[Dict[int, List[int]]]):
        reservation.accessory_links.clear()
        await self.db.flush()
        self.add_accessories_to_reservation(reservation, selected_accessories)

    def create_rental_from_reservation(self, reservation: Reservation, manager: User, deposit: float, notes: Optional[str], recalculated_cost: float, recalculated_discount: float, prepayment_amount: float = 0.0) -> Rental:
        reservation.status = 'fulfilled'
        rental = Rental(
            user_id=reservation.user_id,
            created_by_id=manager.id,
            reservation_id=reservation.id,
            equipment=reservation.equipment,
            start_date=date.today(),
            end_date=reservation.end_date,
            # –ò—Å–ø–æ–ª—å–∑—É–µ–º –Ω–æ–≤—ã–µ, –ø–µ—Ä–µ—Å—á–∏—Ç–∞–Ω–Ω—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è
            total_cost=recalculated_cost,
            discount_amount=recalculated_discount,
            promo_code=reservation.promo_code,
            deposit_amount=deposit,
            prepayment_amount=prepayment_amount,
            notes_on_issue=notes
        )

        if reservation.accessory_links:
            accessory_ids = [link.accessory_id for link in reservation.accessory_links]
            logger.info(f"–¢–û–ß–ö–ê 1 (–ö–û–ü–ò–†–û–í–ê–ù–ò–ï): –†–µ–∑–µ—Ä–≤ #{reservation.id} –∏–º–µ–µ—Ç –∞–∫—Å–µ—Å—Å—É–∞—Ä—ã —Å ID: {accessory_ids}")
            for link in reservation.accessory_links:
                rental.accessory_links.append(
                    RentalAccessory(equipment_id=link.equipment_id, accessory_id=link.accessory_id)
                )
            copied_ids = [link.accessory_id for link in rental.accessory_links]
            logger.info(f"–¢–û–ß–ö–ê 1 (–ö–û–ü–ò–†–û–í–ê–ù–ò–ï): –í –æ–±—ä–µ–∫—Ç –∞—Ä–µ–Ω–¥—ã (–≤ –ø–∞–º—è—Ç–∏) —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω—ã –∞–∫—Å–µ—Å—Å—É–∞—Ä—ã —Å ID: {copied_ids}")
        else:
            logger.warning(f"–¢–û–ß–ö–ê 1 (–ö–û–ü–ò–†–û–í–ê–ù–ò–ï): –í –∏—Å—Ö–æ–¥–Ω–æ–º —Ä–µ–∑–µ—Ä–≤–µ #{reservation.id} –∞–∫—Å–µ—Å—Å—É–∞—Ä—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã.")

        return rental

    def create_rental_instance(self, user: User, manager: User, start_date: date, end_date: date, equipment: List[Equipment], total_cost: float, deposit_amount: float, notes_on_issue: Optional[str]) -> Rental:
        return Rental(
            user_id=user.id,
            created_by_id=manager.id,
            equipment=equipment,
            start_date=start_date,
            end_date=end_date,
            total_cost=total_cost,
            deposit_amount=deposit_amount,
            notes_on_issue=notes_on_issue
        )

    async def calculate_early_return_credit(self, rental: Rental, actual_return_date: date, planned_days: int) -> float:
        """
        –†–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ—Ç –∫—Ä–µ–¥–∏—Ç –∑–∞ –¥–æ—Å—Ä–æ—á–Ω—ã–π –≤–æ–∑–≤—Ä–∞—Ç –∞—Ä–µ–Ω–¥—ã.
        –î–µ–ª–µ–≥–∏—Ä—É–µ—Ç —Ä–∞—Å—á–µ—Ç –≤ FinancialService –¥–ª—è —Å–æ–±–ª—é–¥–µ–Ω–∏—è –ø—Ä–∏–Ω—Ü–∏–ø–∞ DRY.
        """
        return await self.financial_service.calculate_early_return_credit(rental, actual_return_date, planned_days)

    async def calculate_overdue_surcharge(self, rental: Rental, actual_return_date: date) -> float:
        """
        –†–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ—Ç —à—Ç—Ä–∞—Ñ –∑–∞ –ø—Ä–æ—Å—Ä–æ—á–µ–Ω–Ω—ã–µ –¥–Ω–∏ –∞—Ä–µ–Ω–¥—ã.
        –î–µ–ª–µ–≥–∏—Ä—É–µ—Ç —Ä–∞—Å—á–µ—Ç –≤ FinancialService –¥–ª—è —Å–æ–±–ª—é–¥–µ–Ω–∏—è –ø—Ä–∏–Ω—Ü–∏–ø–∞ DRY.
        """
        return await self.financial_service.calculate_overdue_surcharge(rental, actual_return_date)

    def finalize_rental_return(self, rental: Rental, return_date: date, notes: Optional[str], credit: float, surcharge: float = 0.0):
        rental.status = 'completed'
        rental.actual_return_date = return_date
        rental.notes_on_return = notes
        rental.final_cost = rental.total_cost - credit + surcharge

    def update_rental_instance(self, rental: Rental, update_data: dict):
        for key, value in update_data.items():
            setattr(rental, key, value)

    def revert_rental_status_to_active(self, rental: Rental) -> Reservation:
        reservation = rental.reservation
        reservation.status = 'active'
        return reservation

    async def save(self, instance: object):
        if isinstance(instance, Rental) and instance.accessory_links:
            accessory_ids = [link.accessory_id for link in instance.accessory_links]
            logger.info(f"–¢–û–ß–ö–ê 2 (–°–û–•–†–ê–ù–ï–ù–ò–ï): –ü–µ—Ä–µ–¥ –∫–æ–º–º–∏—Ç–æ–º –∞—Ä–µ–Ω–¥–∞ #{instance.id} –∏–º–µ–µ—Ç –∞–∫—Å–µ—Å—Å—É–∞—Ä—ã —Å ID: {accessory_ids}")
        try:
            self.db.add(instance)
            await self.db.commit()
            await self.db.refresh(instance)
        except Exception as e:
            await self.db.rollback()
            raise HTTPException(status_code=status.HTTP_500_INTERNAL_SERVER_ERROR, detail=f"Database error: {e}")

    async def delete(self, instance: object):
        try:
            await self.db.delete(instance)
            await self.db.commit()
        except Exception as e:
            await self.db.rollback()
            raise HTTPException(status_code=status.HTTP_500_INTERNAL_SERVER_ERROR, detail=f"Database error on delete: {e}")

```



## `api\services\order\order_validator.py`


```python

# api/services/order/order_validator.py

from sqlalchemy.ext.asyncio import AsyncSession
from sqlalchemy import select
from datetime import date
from typing import List, Optional, Dict, Tuple

from fastapi import HTTPException, status
from api.models.reservation import Reservation
from api.models.rental import Rental
# +++ 1. –î–û–ë–ê–í–¨–¢–ï –≠–¢–û–¢ –ò–ú–ü–û–†–¢ +++
from api.models.holiday import Holiday
# ---------------------------------
from api.services.availability import AvailabilityService
from api.services.financial_service import FinancialService

class OrderValidator:
    """
    –°–ª–æ–π –¥–ª—è –≤–∞–ª–∏–¥–∞—Ü–∏–∏ –±–∏–∑–Ω–µ—Å-–ø—Ä–∞–≤–∏–ª, —Å–≤—è–∑–∞–Ω–Ω—ã—Ö —Å –†–µ–∑–µ—Ä–≤–∞–º–∏ –∏ –ê—Ä–µ–Ω–¥–∞–º–∏.
    """
    def __init__(self, db: AsyncSession):
        self.db = db
        self.financial_service = FinancialService(db)
        self.availability_service = AvailabilityService(db)

    async def validate_dates_and_holidays(self, start_date: date, end_date: date):
        self.financial_service.validate_date_range(start_date, end_date)
        await self.financial_service.validate_holidays(start_date, end_date)

    async def validate_equipment_availability(self, equipment_ids: list[int], start_date: date, end_date: date, exclude_reservation_id: Optional[int] = None):
        conflicting_ids = await self.availability_service.get_conflicting_equipment_ids(
            equipment_ids, start_date, end_date, exclude_reservation_id
        )
        if conflicting_ids:
            raise HTTPException(
                status_code=status.HTTP_409_CONFLICT,
                detail=f"Equipment with IDs {conflicting_ids} is unavailable for the selected period."
            )

    def validate_accessories_for_equipment(self, selected_accessories: Optional[Dict[int, List[int]]], equipment_ids: List[int]):
        if not selected_accessories:
            return

        accessory_eq_ids = set(selected_accessories.keys())
        if not accessory_eq_ids.issubset(set(equipment_ids)):
            missing_eq_ids = accessory_eq_ids - set(equipment_ids)
            raise HTTPException(status_code=status.HTTP_400_BAD_REQUEST, detail=f"Accessories cannot be selected for equipment not in the reservation. Invalid equipment IDs: {list(missing_eq_ids)}")

    def validate_reservation_is_cancellable(self, reservation: Reservation):
        if reservation.rental:
            raise HTTPException(status_code=status.HTTP_409_CONFLICT, detail=f"Cannot cancel reservation as it has been converted to rental #{reservation.rental.id}.")

    def filter_cancellable_reservations(self, reservations: List[Reservation]) -> Tuple[List[Reservation], List[Reservation]]:
        cancellable = [r for r in reservations if not r.rental]
        not_cancellable = [r for r in reservations if r.rental]
        return cancellable, not_cancellable

    def validate_reservation_for_conversion(self, reservation: Reservation):
        if reservation.status != 'active':
            raise HTTPException(status_code=status.HTTP_409_CONFLICT, detail="Reservation is already fulfilled or cancelled.")
        if reservation.rental:
            raise HTTPException(status_code=status.HTTP_409_CONFLICT, detail=f"Reservation has already been converted to rental #{reservation.rental.id}.")

    async def validate_issue_on_holiday(self, issue_date: date, force: bool):
        # +++ 2. –ò–°–ü–†–ê–í–¨–¢–ï –≠–¢–£ –°–¢–†–û–ö–£ +++
        result = await self.db.execute(select(Holiday).filter(Holiday.date == issue_date))
        is_holiday = result.scalar_one_or_none()
        # --------------------------------
        if is_holiday and not force:
            raise HTTPException(
                status_code=status.HTTP_409_CONFLICT,
                detail={
                    "error_type": "ISSUE_ON_HOLIDAY",
                    "message": f"Issue date ({issue_date.strftime('%d.%m.%Y')}) is a holiday. Confirm action."
                }
            )

    def validate_accessories_returned(self, rental: Rental, confirmation: bool):
        if rental.accessory_links and not confirmation:
            raise HTTPException(status_code=status.HTTP_400_BAD_REQUEST, detail="Confirmation of all accessories return is required.")

    def validate_rental_for_revert(self, rental: Rental):
        if not rental.reservation_id:
            raise HTTPException(status_code=status.HTTP_400_BAD_REQUEST, detail="Cannot revert a rental created without a reservation.")
        if rental.created_at.date() != date.today():
            raise HTTPException(status_code=status.HTTP_403_FORBIDDEN, detail="Reverting is only possible on the day of creation.")

```



## `api\services\promo_code\constants.py`


```python

# api/services/promo_code/constants.py

from fastapi import status

# –°–æ–æ–±—â–µ–Ω–∏—è –æ–± –æ—à–∏–±–∫–∞—Ö
ERROR_MESSAGES = {
    'NOT_FOUND': '–ü—Ä–æ–º–æ–∫–æ–¥ –Ω–µ –Ω–∞–π–¥–µ–Ω',
    'INACTIVE': '–ü—Ä–æ–º–æ–∫–æ–¥ –Ω–µ–∞–∫—Ç–∏–≤–µ–Ω',
    'NOT_STARTED': '–ü—Ä–æ–º–æ–∫–æ–¥ –µ—â–µ –Ω–µ –Ω–∞—á–∞–ª –¥–µ–π—Å—Ç–≤–æ–≤–∞—Ç—å',
    'EXPIRED': '–°—Ä–æ–∫ –¥–µ–π—Å—Ç–≤–∏—è –ø—Ä–æ–º–æ–∫–æ–¥–∞ –∏—Å—Ç–µ–∫',
    'USAGE_LIMIT_EXCEEDED': '–õ–∏–º–∏—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–π —ç—Ç–æ–≥–æ –ø—Ä–æ–º–æ–∫–æ–¥–∞ –∏—Å—á–µ—Ä–ø–∞–Ω',
    'MIN_ORDER_AMOUNT': '–ú–∏–Ω–∏–º–∞–ª—å–Ω–∞—è —Å—É–º–º–∞ –∑–∞–∫–∞–∑–∞ –¥–ª—è —ç—Ç–æ–≥–æ –∫–æ–¥–∞: {amount} ‚ÇΩ',
    'INVALID_EQUIPMENT': '–ü—Ä–æ–º–æ–∫–æ–¥ –Ω–µ –¥–µ–π—Å—Ç–≤—É–µ—Ç –Ω–∞ –≤—ã–±—Ä–∞–Ω–Ω—ã–µ —Ç–æ–≤–∞—Ä—ã',
    'INVALID_EQUIPMENT_TYPE': '–ü—Ä–æ–º–æ–∫–æ–¥ –Ω–µ –¥–µ–π—Å—Ç–≤—É–µ—Ç –Ω–∞ –≤—ã–±—Ä–∞–Ω–Ω—ã–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ —Ç–æ–≤–∞—Ä–æ–≤',
    'PERSONAL_CODE_FORBIDDEN': '–≠—Ç–æ –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã–π –ø—Ä–æ–º–æ–∫–æ–¥ –¥–ª—è –¥—Ä—É–≥–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è',
    'USER_USAGE_LIMIT': '–í—ã —É–∂–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–ª–∏ —ç—Ç–æ—Ç –ø—Ä–æ–º–æ–∫–æ–¥ –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ä–∞–∑',
    'CODE_EXISTS': '–ü—Ä–æ–º–æ–∫–æ–¥ —Å —Ç–∞–∫–∏–º –∫–æ–¥–æ–º —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç',
    'EQUIPMENT_NOT_FOUND': '–û–¥–Ω–æ –∏–ª–∏ –Ω–µ—Å–∫–æ–ª—å–∫–æ –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏–π –¥–ª—è –ø—Ä–æ–º–æ–∫–æ–¥–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã.',
    'MANAGER_DISCOUNT_LIMIT': '–ú–µ–Ω–µ–¥–∂–µ—Ä—ã –Ω–µ –º–æ–≥—É—Ç —Å–æ–∑–¥–∞–≤–∞—Ç—å —Å–∫–∏–¥–∫—É –±–æ–ª–µ–µ 20%',
    'ADMIN_DISCOUNT_LIMIT': '–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—ã –Ω–µ –º–æ–≥—É—Ç —Å–æ–∑–¥–∞–≤–∞—Ç—å —Å–∫–∏–¥–∫—É –±–æ–ª–µ–µ 50%'
}

# –ö–æ–¥—ã —Å—Ç–∞—Ç—É—Å–æ–≤ HTTP
HTTP_STATUS_CODES = {
    'NOT_FOUND': status.HTTP_404_NOT_FOUND,
    'BAD_REQUEST': status.HTTP_400_BAD_REQUEST,
    'FORBIDDEN': status.HTTP_403_FORBIDDEN,
    'CONFLICT': status.HTTP_409_CONFLICT
}

# –õ–∏–º–∏—Ç—ã —Å–∫–∏–¥–æ–∫ –ø–æ —Ä–æ–ª—è–º
DISCOUNT_LIMITS = {
    'manager': 20,
    'admin': 50
}

# –ú–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–π –∫–æ–º–±–∏–Ω–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –ø—Ä–æ—Ü–µ–Ω—Ç —Å–∫–∏–¥–∫–∏
MAX_COMBINED_DISCOUNT = 75 

```



## `api\services\promo_code\exceptions.py`


```python

# api/services/promo_code/exceptions.py

from fastapi import HTTPException
from .constants import ERROR_MESSAGES, HTTP_STATUS_CODES


class PromoCodeException(HTTPException):
    """–ë–∞–∑–æ–≤–æ–µ –∏—Å–∫–ª—é—á–µ–Ω–∏–µ –¥–ª—è –ø—Ä–æ–º–æ–∫–æ–¥–æ–≤"""
    pass


class PromoCodeNotFoundError(PromoCodeException):
    def __init__(self):
        super().__init__(
            status_code=HTTP_STATUS_CODES['NOT_FOUND'],
            detail=ERROR_MESSAGES['NOT_FOUND']
        )


class PromoCodeInactiveError(PromoCodeException):
    def __init__(self):
        super().__init__(
            status_code=HTTP_STATUS_CODES['BAD_REQUEST'],
            detail=ERROR_MESSAGES['INACTIVE']
        )


class PromoCodeNotStartedError(PromoCodeException):
    def __init__(self):
        super().__init__(
            status_code=HTTP_STATUS_CODES['BAD_REQUEST'],
            detail=ERROR_MESSAGES['NOT_STARTED']
        )


class PromoCodeExpiredError(PromoCodeException):
    def __init__(self):
        super().__init__(
            status_code=HTTP_STATUS_CODES['BAD_REQUEST'],
            detail=ERROR_MESSAGES['EXPIRED']
        )


class PromoCodeUsageLimitExceededError(PromoCodeException):
    def __init__(self):
        super().__init__(
            status_code=HTTP_STATUS_CODES['BAD_REQUEST'],
            detail=ERROR_MESSAGES['USAGE_LIMIT_EXCEEDED']
        )


class PromoCodeMinOrderAmountError(PromoCodeException):
    def __init__(self, min_amount: float):
        super().__init__(
            status_code=HTTP_STATUS_CODES['BAD_REQUEST'],
            detail=ERROR_MESSAGES['MIN_ORDER_AMOUNT'].format(amount=min_amount)
        )


class PromoCodeInvalidEquipmentError(PromoCodeException):
    def __init__(self):
        super().__init__(
            status_code=HTTP_STATUS_CODES['BAD_REQUEST'],
            detail=ERROR_MESSAGES['INVALID_EQUIPMENT']
        )


class PromoCodeInvalidEquipmentTypeError(PromoCodeException):
    def __init__(self):
        super().__init__(
            status_code=HTTP_STATUS_CODES['BAD_REQUEST'],
            detail=ERROR_MESSAGES['INVALID_EQUIPMENT_TYPE']
        )


class PromoCodePersonalCodeForbiddenError(PromoCodeException):
    def __init__(self):
        super().__init__(
            status_code=HTTP_STATUS_CODES['FORBIDDEN'],
            detail=ERROR_MESSAGES['PERSONAL_CODE_FORBIDDEN']
        )


class PromoCodeUserUsageLimitError(PromoCodeException):
    def __init__(self):
        super().__init__(
            status_code=HTTP_STATUS_CODES['BAD_REQUEST'],
            detail=ERROR_MESSAGES['USER_USAGE_LIMIT']
        )


class PromoCodeExistsError(PromoCodeException):
    def __init__(self):
        super().__init__(
            status_code=HTTP_STATUS_CODES['CONFLICT'],
            detail=ERROR_MESSAGES['CODE_EXISTS']
        )


class PromoCodeEquipmentNotFoundError(PromoCodeException):
    def __init__(self):
        super().__init__(
            status_code=HTTP_STATUS_CODES['NOT_FOUND'],
            detail=ERROR_MESSAGES['EQUIPMENT_NOT_FOUND']
        )


class PromoCodeDiscountLimitError(PromoCodeException):
    def __init__(self, role: str):
        message_key = f'{role.upper()}_DISCOUNT_LIMIT'
        super().__init__(
            status_code=HTTP_STATUS_CODES['FORBIDDEN'],
            detail=ERROR_MESSAGES[message_key]
        ) 

```



## `api\services\promo_code\factory.py`


```python

# api/services/promo_code/factory.py

from sqlalchemy.ext.asyncio import AsyncSession
from .promo_code_validator import PromoCodeValidator
from .promo_code_manager import PromoCodeManager
from .promo_code_business_logic import PromoCodeBusinessLogic


class PromoCodeServiceFactory:
    """–§–∞–±—Ä–∏–∫–∞ –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è —Å–µ—Ä–≤–∏—Å–æ–≤ –ø—Ä–æ–º–æ–∫–æ–¥–æ–≤"""
    
    @staticmethod
    def create_validator(db: AsyncSession) -> PromoCodeValidator:
        """–°–æ–∑–¥–∞–µ—Ç –≤–∞–ª–∏–¥–∞—Ç–æ—Ä –ø—Ä–æ–º–æ–∫–æ–¥–æ–≤"""
        return PromoCodeValidator(db)
    
    @staticmethod
    def create_manager(db: AsyncSession) -> PromoCodeManager:
        """–°–æ–∑–¥–∞–µ—Ç –º–µ–Ω–µ–¥–∂–µ—Ä –ø—Ä–æ–º–æ–∫–æ–¥–æ–≤"""
        return PromoCodeManager(db)
    
    @staticmethod
    def create_business_logic(db: AsyncSession) -> PromoCodeBusinessLogic:
        """–°–æ–∑–¥–∞–µ—Ç –±–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫—É –ø—Ä–æ–º–æ–∫–æ–¥–æ–≤"""
        return PromoCodeBusinessLogic(db)
    
    @staticmethod
    def create_all_services(db: AsyncSession) -> tuple[PromoCodeValidator, PromoCodeManager, PromoCodeBusinessLogic]:
        """–°–æ–∑–¥–∞–µ—Ç –≤—Å–µ —Å–µ—Ä–≤–∏—Å—ã –ø—Ä–æ–º–æ–∫–æ–¥–æ–≤"""
        validator = PromoCodeValidator(db)
        manager = PromoCodeManager(db)
        business_logic = PromoCodeBusinessLogic(db)
        
        return validator, manager, business_logic 

```



## `api\services\promo_code\interfaces.py`


```python

# api/services/promo_code/interfaces.py

from abc import ABC, abstractmethod
from typing import Optional, List
from sqlalchemy.orm import Session

from api.models.promo_code import PromoCode
from api.models.user import User
from shared.schemas.promo_code_schema import PromoCodeCreate, PromoCodeUpdate, PromoCodeValidateResponse


class IPromoCodeValidator(ABC):
    """–ò–Ω—Ç–µ—Ä—Ñ–µ–π—Å –¥–ª—è –≤–∞–ª–∏–¥–∞—Ç–æ—Ä–∞ –ø—Ä–æ–º–æ–∫–æ–¥–æ–≤"""
    
    @abstractmethod
    def validate_complete(self, code: str, order_amount: float, equipment_ids: List[int], user: Optional[User]) -> PromoCode:
        """–í—ã–ø–æ–ª–Ω—è–µ—Ç –ø–æ–ª–Ω—É—é –≤–∞–ª–∏–¥–∞—Ü–∏—é –ø—Ä–æ–º–æ–∫–æ–¥–∞"""
        pass


class IPromoCodeManager(ABC):
    """–ò–Ω—Ç–µ—Ä—Ñ–µ–π—Å –¥–ª—è –º–µ–Ω–µ–¥–∂–µ—Ä–∞ –ø—Ä–æ–º–æ–∫–æ–¥–æ–≤"""
    
    @abstractmethod
    def create_promo_code(self, promo_data: PromoCodeCreate, creator: User) -> PromoCode:
        """–°–æ–∑–¥–∞–µ—Ç –Ω–æ–≤—ã–π –ø—Ä–æ–º–æ–∫–æ–¥"""
        pass
    
    @abstractmethod
    def get_all_promo_codes(self) -> List[PromoCode]:
        """–ü–æ–ª—É—á–∞–µ—Ç –≤—Å–µ –ø—Ä–æ–º–æ–∫–æ–¥—ã"""
        pass
    
    @abstractmethod
    def get_promo_code_by_id(self, promo_code_id: int) -> Optional[PromoCode]:
        """–ü–æ–ª—É—á–∞–µ—Ç –ø—Ä–æ–º–æ–∫–æ–¥ –ø–æ ID"""
        pass
    
    @abstractmethod
    def update_promo_code(self, promo_code_id: int, update_data: PromoCodeUpdate) -> PromoCode:
        """–û–±–Ω–æ–≤–ª—è–µ—Ç –ø—Ä–æ–º–æ–∫–æ–¥"""
        pass
    
    @abstractmethod
    def delete_promo_code(self, promo_code_id: int) -> None:
        """–£–¥–∞–ª—è–µ—Ç –ø—Ä–æ–º–æ–∫–æ–¥"""
        pass
    
    @abstractmethod
    def generate_unique_code(self) -> str:
        """–ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç —É–Ω–∏–∫–∞–ª—å–Ω—ã–π –∫–æ–¥"""
        pass


class IPromoCodeBusinessLogic(ABC):
    """–ò–Ω—Ç–µ—Ä—Ñ–µ–π—Å –¥–ª—è –±–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫–∏ –ø—Ä–æ–º–æ–∫–æ–¥–æ–≤"""
    
    @abstractmethod
    def validate_and_get_promo_code(self, code: str, order_amount: float, equipment_ids: List[int], user: Optional[User]) -> PromoCode:
        """–í–∞–ª–∏–¥–∏—Ä—É–µ—Ç –ø—Ä–æ–º–æ–∫–æ–¥ –∏ –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –µ–≥–æ"""
        pass
    
    @abstractmethod
    def create_validation_response(self, promo_code: PromoCode) -> PromoCodeValidateResponse:
        """–°–æ–∑–¥–∞–µ—Ç –æ—Ç–≤–µ—Ç –¥–ª—è –≤–∞–ª–∏–¥–∞—Ü–∏–∏"""
        pass
    
    @abstractmethod
    def record_promo_code_usage(self, promo_code: PromoCode, user: Optional[User]) -> None:
        """–ó–∞–ø–∏—Å—ã–≤–∞–µ—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –ø—Ä–æ–º–æ–∫–æ–¥–∞"""
        pass
    
    @abstractmethod
    def calculate_discount_amount(self, base_amount: float, promo_code: PromoCode) -> float:
        """–†–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ—Ç —Å—É–º–º—É —Å–∫–∏–¥–∫–∏"""
        pass
    
    @abstractmethod
    def validate_combined_discount(self, duration_discount: float, promo_discount: float) -> float:
        """–í–∞–ª–∏–¥–∏—Ä—É–µ—Ç –∫–æ–º–±–∏–Ω–∏—Ä–æ–≤–∞–Ω–Ω—É—é —Å–∫–∏–¥–∫—É"""
        pass 

```



## `api\services\promo_code\promo_code_business_logic.py`


```python

# api/services/promo_code/promo_code_business_logic.py

from sqlalchemy.ext.asyncio import AsyncSession
from sqlalchemy import select
from typing import Optional, List
from datetime import datetime, timezone

from api.models.promo_code import PromoCode, promo_code_usages
from api.models.user import User
from shared.schemas.promo_code_schema import PromoCodeValidateResponse
from .promo_code_validator import PromoCodeValidator
from .constants import MAX_COMBINED_DISCOUNT
from .interfaces import IPromoCodeBusinessLogic


class PromoCodeBusinessLogic(IPromoCodeBusinessLogic):
    """–ë–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫–∞ –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –ø—Ä–æ–º–æ–∫–æ–¥–∞–º–∏"""
    
    def __init__(self, db: AsyncSession):
        self.db = db
        self.validator = PromoCodeValidator(db)
    
    async def validate_and_get_promo_code(
        self, 
        code: str, 
        order_amount: float, 
        equipment_ids: List[int], 
        user: Optional[User]
    ) -> PromoCode:
        """
        –í–∞–ª–∏–¥–∏—Ä—É–µ—Ç –ø—Ä–æ–º–æ–∫–æ–¥ –∏ –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –µ–≥–æ –æ–±—ä–µ–∫—Ç.
        –û—Å–Ω–æ–≤–Ω–æ–π –º–µ—Ç–æ–¥ –¥–ª—è –≤–∞–ª–∏–¥–∞—Ü–∏–∏ –ø—Ä–æ–º–æ–∫–æ–¥–æ–≤.
        """
        return await self.validator.validate_complete(code, order_amount, equipment_ids, user)
    
    def create_validation_response(self, promo_code: PromoCode) -> PromoCodeValidateResponse:
        """–°–æ–∑–¥–∞–µ—Ç –æ—Ç–≤–µ—Ç –¥–ª—è –≤–∞–ª–∏–¥–∞—Ü–∏–∏ –ø—Ä–æ–º–æ–∫–æ–¥–∞"""
        return PromoCodeValidateResponse(
            code=promo_code.code,
            discount_percentage=promo_code.discount_percentage,
            message="–ü—Ä–æ–º–æ–∫–æ–¥ —É—Å–ø–µ—à–Ω–æ –ø—Ä–∏–º–µ–Ω–µ–Ω!"
        )
    
    async def record_promo_code_usage(self, promo_code: PromoCode, user: Optional[User]) -> None:
        """
        –ó–∞–ø–∏—Å—ã–≤–∞–µ—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –ø—Ä–æ–º–æ–∫–æ–¥–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º.
        –£–≤–µ–ª–∏—á–∏–≤–∞–µ—Ç —Å—á–µ—Ç—á–∏–∫ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–π.
        """
        # –£–≤–µ–ª–∏—á–∏–≤–∞–µ–º –æ–±—â–∏–π —Å—á–µ—Ç—á–∏–∫ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–π
        promo_code.times_used += 1
        
        # –ó–∞–ø–∏—Å—ã–≤–∞–µ–º –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º, –µ—Å–ª–∏ –æ–Ω –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω
        if user:
            # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–µ –∑–∞–ø–∏—Å–∞–Ω–æ –ª–∏ —É–∂–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ
            result = await self.db.execute(select(promo_code_usages).filter_by(
                user_id=user.id,
                promo_code_id=promo_code.id
            ))
            existing_usage = result.first()
            
            if not existing_usage:
                # –î–æ–±–∞–≤–ª—è–µ–º –∑–∞–ø–∏—Å—å –æ–± –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–∏
                await self.db.execute(
                    promo_code_usages.insert().values(
                        user_id=user.id,
                        promo_code_id=promo_code.id,
                        used_at=datetime.now(timezone.utc)
                    )
                )
        
        await self.db.commit()
    
    def calculate_discount_amount(self, base_amount: float, promo_code: PromoCode) -> float:
        """–†–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ—Ç —Å—É–º–º—É —Å–∫–∏–¥–∫–∏ –ø–æ –ø—Ä–æ–º–æ–∫–æ–¥—É"""
        return base_amount * (promo_code.discount_percentage / 100)
    
    def calculate_final_amount_with_promo(self, base_amount: float, promo_code: PromoCode) -> float:
        """–†–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ—Ç —Ñ–∏–Ω–∞–ª—å–Ω—É—é —Å—É–º–º—É —Å —É—á–µ—Ç–æ–º —Å–∫–∏–¥–∫–∏ –ø–æ –ø—Ä–æ–º–æ–∫–æ–¥—É"""
        discount_amount = self.calculate_discount_amount(base_amount, promo_code)
        return base_amount - discount_amount
    
    def validate_combined_discount(self, duration_discount: float, promo_discount: float) -> float:
        """
        –ü—Ä–æ–≤–µ—Ä—è–µ—Ç –∏ –∫–æ—Ä—Ä–µ–∫—Ç–∏—Ä—É–µ—Ç –∫–æ–º–±–∏–Ω–∏—Ä–æ–≤–∞–Ω–Ω—É—é —Å–∫–∏–¥–∫—É.
        –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç –∏—Ç–æ–≥–æ–≤—ã–π –ø—Ä–æ—Ü–µ–Ω—Ç —Å–∫–∏–¥–∫–∏.
        """
        total_discount = duration_discount + promo_discount
        if total_discount > MAX_COMBINED_DISCOUNT:
            return MAX_COMBINED_DISCOUNT
        return total_discount
    
    def get_promo_code_statistics(self, promo_code: PromoCode) -> dict:
        """–ü–æ–ª—É—á–∞–µ—Ç —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –ø—Ä–æ–º–æ–∫–æ–¥–∞"""
        total_uses = promo_code.times_used
        max_uses = promo_code.max_uses
        usage_percentage = (total_uses / max_uses * 100) if max_uses else None
        
        return {
            'total_uses': total_uses,
            'max_uses': max_uses,
            'usage_percentage': usage_percentage,
            'is_fully_used': max_uses and total_uses >= max_uses,
            'remaining_uses': max_uses - total_uses if max_uses else None
        }
    
    def is_promo_code_expired(self, promo_code: PromoCode) -> bool:
        """–ü—Ä–æ–≤–µ—Ä—è–µ—Ç, –∏—Å—Ç–µ–∫ –ª–∏ —Å—Ä–æ–∫ –¥–µ–π—Å—Ç–≤–∏—è –ø—Ä–æ–º–æ–∫–æ–¥–∞"""
        if not promo_code.expires_at:
            return False
        
        now_utc = datetime.now(timezone.utc)
        return promo_code.expires_at < now_utc
    
    def is_promo_code_active(self, promo_code: PromoCode) -> bool:
        """–ü—Ä–æ–≤–µ—Ä—è–µ—Ç, –∞–∫—Ç–∏–≤–µ–Ω –ª–∏ –ø—Ä–æ–º–æ–∫–æ–¥ (–≤–∫–ª—é—á–∞—è —Å—Ä–æ–∫–∏ –¥–µ–π—Å—Ç–≤–∏—è)"""
        if not promo_code.is_active:
            return False
        
        now_utc = datetime.now(timezone.utc)
        
        # –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–∞—Ç—ã –Ω–∞—á–∞–ª–∞ –¥–µ–π—Å—Ç–≤–∏—è
        if promo_code.valid_from and promo_code.valid_from > now_utc:
            return False
        
        # –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–∞—Ç—ã –æ–∫–æ–Ω—á–∞–Ω–∏—è –¥–µ–π—Å—Ç–≤–∏—è
        if promo_code.expires_at and promo_code.expires_at < now_utc:
            return False
        
        return True 

```



## `api\services\promo_code\promo_code_manager.py`


```python

# api/services/promo_code/promo_code_manager.py

from sqlalchemy.ext.asyncio import AsyncSession
from sqlalchemy.orm import joinedload
from sqlalchemy import select
from typing import List, Optional
import secrets

from api.models.promo_code import PromoCode, PromoCodeApplicableType
from api.models.equipment import Equipment
from api.models.user import User
from shared.schemas.promo_code_schema import PromoCodeCreate, PromoCodeUpdate
from .exceptions import (
    PromoCodeExistsError, PromoCodeEquipmentNotFoundError, 
    PromoCodeNotFoundError, PromoCodeDiscountLimitError
)
from .constants import DISCOUNT_LIMITS
from .interfaces import IPromoCodeManager


class PromoCodeManager(IPromoCodeManager):
    """–ú–µ–Ω–µ–¥–∂–µ—Ä –¥–ª—è CRUD –æ–ø–µ—Ä–∞—Ü–∏–π —Å –ø—Ä–æ–º–æ–∫–æ–¥–∞–º–∏"""
    
    def __init__(self, db: AsyncSession):
        self.db = db
    
    async def create_promo_code(self, promo_data: PromoCodeCreate, creator: User) -> PromoCode:
        """–°–æ–∑–¥–∞–µ—Ç –Ω–æ–≤—ã–π –ø—Ä–æ–º–æ–∫–æ–¥"""
        # –ü—Ä–æ–≤–µ—Ä–∫–∞ –ª–∏–º–∏—Ç–æ–≤ —Å–∫–∏–¥–∫–∏ –ø–æ —Ä–æ–ª–∏
        self._validate_discount_limit(creator.role, promo_data.discount_percentage)
        
        # –ü—Ä–æ–≤–µ—Ä–∫–∞ —É–Ω–∏–∫–∞–ª—å–Ω–æ—Å—Ç–∏ –∫–æ–¥–∞
        result = await self.db.execute(select(PromoCode).filter(PromoCode.code == promo_data.code))
        if result.scalar_one_or_none():
            raise PromoCodeExistsError()
        
        # –°–æ–∑–¥–∞–Ω–∏–µ –æ—Å–Ω–æ–≤–Ω–æ–≥–æ –æ–±—ä–µ–∫—Ç–∞
        promo_dict = promo_data.model_dump(exclude={'applicable_to_equipment_ids', 'applicable_to_equipment_types'})
        new_promo_code = PromoCode(**promo_dict, created_by_id=creator.id)
        
        # –û–±—Ä–∞–±–æ—Ç–∫–∞ —Å–≤—è–∑–µ–π —Å –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏–µ–º
        await self._set_equipment_relations(new_promo_code, promo_data.applicable_to_equipment_ids)
        
        # –û–±—Ä–∞–±–æ—Ç–∫–∞ —Å–≤—è–∑–µ–π —Å —Ç–∏–ø–∞–º–∏ –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—è
        self._set_equipment_type_relations(new_promo_code, promo_data.applicable_to_equipment_types)
        
        self.db.add(new_promo_code)
        await self.db.commit()
        
        # –ü–æ–≤—Ç–æ—Ä–Ω–æ –ø–æ–ª—É—á–∞–µ–º –æ–±—ä–µ–∫—Ç –∏–∑ –ë–î —Å –∑–∞–≥—Ä—É–∂–µ–Ω–Ω—ã–º–∏ —Å–≤—è–∑—è–º–∏
        result = await self.db.execute(
            select(PromoCode)
            .filter(PromoCode.id == new_promo_code.id)
            .options(joinedload(PromoCode.creator))
        )
        return result.unique().scalars().first()
    
    async def get_all_promo_codes(self) -> List[PromoCode]:
        """–ü–æ–ª—É—á–∞–µ—Ç –≤—Å–µ –ø—Ä–æ–º–æ–∫–æ–¥—ã —Å –∑–∞–≥—Ä—É–∑–∫–æ–π —Å–≤—è–∑–∞–Ω–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö"""
        result = await self.db.execute(select(PromoCode).options(
            joinedload(PromoCode.creator)
        ).order_by(PromoCode.created_at.desc()))
        return result.unique().scalars().all()
    
    async def get_promo_code_by_id(self, promo_code_id: int) -> Optional[PromoCode]:
        """–ü–æ–ª—É—á–∞–µ—Ç –ø—Ä–æ–º–æ–∫–æ–¥ –ø–æ ID"""
        result = await self.db.execute(select(PromoCode).filter(PromoCode.id == promo_code_id))
        return result.scalar_one_or_none()
    
    async def update_promo_code(self, promo_code_id: int, update_data: PromoCodeUpdate) -> PromoCode:
        """–û–±–Ω–æ–≤–ª—è–µ—Ç —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π –ø—Ä–æ–º–æ–∫–æ–¥"""
        promo_code = await self.get_promo_code_by_id(promo_code_id)
        if not promo_code:
            raise PromoCodeNotFoundError()
        
        update_dict = update_data.model_dump(exclude_unset=True)
        
        # –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å–≤—è–∑–µ–π —Å –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏–µ–º
        if 'applicable_to_equipment_ids' in update_dict:
            equipment_ids = update_dict.pop('applicable_to_equipment_ids')
            await self._set_equipment_relations(promo_code, equipment_ids)
        
        # –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å–≤—è–∑–µ–π —Å —Ç–∏–ø–∞–º–∏ –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—è
        if 'applicable_to_equipment_types' in update_dict:
            equipment_types = update_dict.pop('applicable_to_equipment_types')
            self._set_equipment_type_relations(promo_code, equipment_types)
        
        # –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –æ—Å—Ç–∞–ª—å–Ω—ã—Ö –ø–æ–ª–µ–π
        for key, value in update_dict.items():
            setattr(promo_code, key, value)
        
        self.db.add(promo_code)
        await self.db.commit()
        
        # –ü–æ–≤—Ç–æ—Ä–Ω–æ –ø–æ–ª—É—á–∞–µ–º –æ–±—ä–µ–∫—Ç –∏–∑ –ë–î —Å –∑–∞–≥—Ä—É–∂–µ–Ω–Ω—ã–º–∏ —Å–≤—è–∑—è–º–∏
        result = await self.db.execute(
            select(PromoCode)
            .filter(PromoCode.id == promo_code_id)
            .options(joinedload(PromoCode.creator))
        )
        return result.unique().scalars().first()
    
    async def delete_promo_code(self, promo_code_id: int) -> None:
        """–£–¥–∞–ª—è–µ—Ç –ø—Ä–æ–º–æ–∫–æ–¥"""
        promo_code = await self.get_promo_code_by_id(promo_code_id)
        if not promo_code:
            raise PromoCodeNotFoundError()
        
        await self.db.delete(promo_code)
        await self.db.commit()
    
    async def generate_unique_code(self) -> str:
        """–ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç —É–Ω–∏–∫–∞–ª—å–Ω—ã–π –∫–æ–¥ –ø—Ä–æ–º–æ–∫–æ–¥–∞"""
        while True:
            code = f"SALE-{secrets.token_hex(3).upper()}"
            result = await self.db.execute(select(PromoCode).filter(PromoCode.code == code))
            existing_code = result.scalar_one_or_none()
            if not existing_code:
                return code
    
    def _validate_discount_limit(self, role: str, discount_percentage: float) -> None:
        """–ü—Ä–æ–≤–µ—Ä—è–µ—Ç –ª–∏–º–∏—Ç —Å–∫–∏–¥–∫–∏ –¥–ª—è —Ä–æ–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è"""
        if role in DISCOUNT_LIMITS and discount_percentage > DISCOUNT_LIMITS[role]:
            raise PromoCodeDiscountLimitError(role)
    
    async def _set_equipment_relations(self, promo_code: PromoCode, equipment_ids: Optional[List[int]]) -> None:
        """–£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç —Å–≤—è–∑–∏ —Å –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏–µ–º"""
        promo_code.applicable_equipment.clear()
        if equipment_ids:
            result = await self.db.execute(select(Equipment).filter(Equipment.id.in_(equipment_ids)))
            equipment = result.unique().scalars().all()
            if len(equipment) != len(equipment_ids):
                raise PromoCodeEquipmentNotFoundError()
            promo_code.applicable_equipment = equipment
    
    def _set_equipment_type_relations(self, promo_code: PromoCode, equipment_types: Optional[List[str]]) -> None:
        """–£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç —Å–≤—è–∑–∏ —Å —Ç–∏–ø–∞–º–∏ –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—è"""
        promo_code.applicable_types.clear()
        if equipment_types:
            promo_code.applicable_types = [
                PromoCodeApplicableType(type_name=t) for t in equipment_types
            ] 

```



## `api\services\promo_code\promo_code_validator.py`


```python

# api/services/promo_code/promo_code_validator.py

from sqlalchemy.ext.asyncio import AsyncSession
from sqlalchemy import select
from typing import Optional, List
from datetime import datetime, timezone

from api.models.promo_code import PromoCode, promo_code_usages
from api.models.user import User
from api.models.equipment import Equipment
from .exceptions import (
    PromoCodeNotFoundError, PromoCodeInactiveError, PromoCodeNotStartedError,
    PromoCodeExpiredError, PromoCodeUsageLimitExceededError, PromoCodeMinOrderAmountError,
    PromoCodeInvalidEquipmentError, PromoCodeInvalidEquipmentTypeError,
    PromoCodePersonalCodeForbiddenError, PromoCodeUserUsageLimitError
)
from .interfaces import IPromoCodeValidator


class PromoCodeValidator(IPromoCodeValidator):
    """–í–∞–ª–∏–¥–∞—Ç–æ—Ä –ø—Ä–æ–º–æ–∫–æ–¥–æ–≤ —Å —Ä–∞–∑–¥–µ–ª–µ–Ω–∏–µ–º –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç–∏ –ø–æ —Ç–∏–ø–∞–º –ø—Ä–æ–≤–µ—Ä–æ–∫"""
    
    def __init__(self, db: AsyncSession):
        self.db = db
    
    async def validate_basic_existence(self, code: str) -> PromoCode:
        """–ü—Ä–æ–≤–µ—Ä—è–µ—Ç —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–Ω–∏–µ –ø—Ä–æ–º–æ–∫–æ–¥–∞"""
        result = await self.db.execute(select(PromoCode).filter(PromoCode.code == code))
        promo_code = result.unique().scalar_one_or_none()
        if not promo_code:
            raise PromoCodeNotFoundError()
        return promo_code
    
    def validate_status_and_dates(self, promo_code: PromoCode) -> None:
        """–ü—Ä–æ–≤–µ—Ä—è–µ—Ç –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å –∏ —Å—Ä–æ–∫–∏ –¥–µ–π—Å—Ç–≤–∏—è –ø—Ä–æ–º–æ–∫–æ–¥–∞"""
        if not promo_code.is_active:
            raise PromoCodeInactiveError()
        
        now_utc = datetime.now(timezone.utc)
        
        if promo_code.valid_from and promo_code.valid_from > now_utc:
            raise PromoCodeNotStartedError()
        
        if promo_code.expires_at and promo_code.expires_at < now_utc:
            raise PromoCodeExpiredError()
    
    def validate_usage_limits(self, promo_code: PromoCode) -> None:
        """–ü—Ä–æ–≤–µ—Ä—è–µ—Ç –ª–∏–º–∏—Ç—ã –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –ø—Ä–æ–º–æ–∫–æ–¥–∞"""
        if promo_code.max_uses is not None and promo_code.times_used >= promo_code.max_uses:
            raise PromoCodeUsageLimitExceededError()
    
    def validate_order_amount(self, promo_code: PromoCode, order_amount: float) -> None:
        """–ü—Ä–æ–≤–µ—Ä—è–µ—Ç –º–∏–Ω–∏–º–∞–ª—å–Ω—É—é —Å—É–º–º—É –∑–∞–∫–∞–∑–∞"""
        if promo_code.min_order_amount is not None and order_amount < promo_code.min_order_amount:
            raise PromoCodeMinOrderAmountError(promo_code.min_order_amount)
    
    async def validate_equipment_applicability(self, promo_code: PromoCode, equipment_ids: List[int]) -> None:
        """–ü—Ä–æ–≤–µ—Ä—è–µ—Ç –ø—Ä–∏–º–µ–Ω–∏–º–æ—Å—Ç—å –∫ –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—é"""
        # –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ ID –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—è
        if promo_code.applicable_to_equipment_ids and not any(eid in equipment_ids for eid in promo_code.applicable_to_equipment_ids):
            raise PromoCodeInvalidEquipmentError()
        
        # –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ —Ç–∏–ø–∞–º –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—è
        if promo_code.applicable_to_equipment_types:
            result = await self.db.execute(select(Equipment).filter(Equipment.id.in_(equipment_ids)))
            equipment_in_cart = result.unique().scalars().all()
            equipment_types_in_cart = {eq.equipment_type for eq in equipment_in_cart}
            if not any(eq_type in equipment_types_in_cart for eq_type in promo_code.applicable_to_equipment_types):
                raise PromoCodeInvalidEquipmentTypeError()
    
    async def validate_user_permissions(self, promo_code: PromoCode, user: Optional[User]) -> None:
        """–ü—Ä–æ–≤–µ—Ä—è–µ—Ç –ø—Ä–∞–≤–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –Ω–∞ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –ø—Ä–æ–º–æ–∫–æ–¥–∞"""
        # –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω–æ–≥–æ –ø—Ä–æ–º–æ–∫–æ–¥–∞
        if promo_code.specific_to_user_id:
            if not user or user.id != promo_code.specific_to_user_id:
                raise PromoCodePersonalCodeForbiddenError()
        
        # –ü—Ä–æ–≤–µ—Ä–∫–∞ –ª–∏–º–∏—Ç–∞ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–π –Ω–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        if promo_code.max_uses_per_user and user:
            result = await self.db.execute(select(promo_code_usages).filter_by(
                user_id=user.id, 
                promo_code_id=promo_code.id
            ))
            user_uses_count = len(result.all())
            if user_uses_count >= promo_code.max_uses_per_user:
                raise PromoCodeUserUsageLimitError()
    
    async def validate_complete(self, code: str, order_amount: float, equipment_ids: List[int], user: Optional[User]) -> PromoCode:
        """–í—ã–ø–æ–ª–Ω—è–µ—Ç –ø–æ–ª–Ω—É—é –≤–∞–ª–∏–¥–∞—Ü–∏—é –ø—Ä–æ–º–æ–∫–æ–¥–∞"""
        promo_code = await self.validate_basic_existence(code)
        self.validate_status_and_dates(promo_code)
        self.validate_usage_limits(promo_code)
        self.validate_order_amount(promo_code, order_amount)
        await self.validate_equipment_applicability(promo_code, equipment_ids)
        await self.validate_user_permissions(promo_code, user)
        
        return promo_code 

```



## `api\services\promo_code_service.py`


```python

# api/services/promo_code_service.py

from sqlalchemy.ext.asyncio import AsyncSession
from typing import Optional, List

from api.models.promo_code import PromoCode
from api.models.user import User
from .promo_code import PromoCodeBusinessLogic


async def validate_promo_code_for_use(
        db: AsyncSession,
        code: str,
        order_amount: float,
        equipment_ids: List[int],
        user: Optional[User]
) -> PromoCode:
    """
    –¶–µ–Ω—Ç—Ä–∞–ª–∏–∑–æ–≤–∞–Ω–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–æ–ª–Ω–æ–π —Å–µ—Ä–≤–µ—Ä–Ω–æ–π –≤–∞–ª–∏–¥–∞—Ü–∏–∏ –ø—Ä–æ–º–æ–∫–æ–¥–∞.
    –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç –æ–±—ä–µ–∫—Ç PromoCode –≤ —Å–ª—É—á–∞–µ —É—Å–ø–µ—Ö–∞ –∏–ª–∏ –≤—ã–±—Ä–∞—Å—ã–≤–∞–µ—Ç HTTPException.
    
    –≠—Ç–∞ —Ñ—É–Ω–∫—Ü–∏—è —è–≤–ª—è–µ—Ç—Å—è —Ñ–∞—Å–∞–¥–æ–º –¥–ª—è –Ω–æ–≤–æ–π –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—ã –ø—Ä–æ–º–æ–∫–æ–¥–æ–≤.
    """
    business_logic = PromoCodeBusinessLogic(db)
    return await business_logic.validate_and_get_promo_code(code, order_amount, equipment_ids, user)

```



## `api\services\rental\rental_query_service.py`


```python

# api/services/rental/rental_query_service.py

from sqlalchemy.ext.asyncio import AsyncSession
from sqlalchemy.orm import joinedload, selectinload
from sqlalchemy import or_, select, func, case, and_
from datetime import date
from typing import Optional, List, Tuple
import logging

from api.models.rental import Rental, RentalAccessory
from api.models.user import User
from api.models.equipment import Equipment
from shared.schemas.rental_schema import RentalOut
from api.services.financial_service import FinancialService
from api.services.order.order_query_base import OrderQueryBase

logger = logging.getLogger(__name__)

class RentalQueryService(OrderQueryBase[Rental]):
    """–°–µ—Ä–≤–∏—Å –¥–ª—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –æ–ø–µ—Ä–∞—Ü–∏–π —á—Ç–µ–Ω–∏—è (Query) –¥–∞–Ω–Ω—ã—Ö –æ–± –∞—Ä–µ–Ω–¥–∞—Ö."""

    def __init__(self, db: AsyncSession):
        super().__init__(db)
        self.financial_service = FinancialService(db)

    def _get_base_query(self):
        """–°–æ–∑–¥–∞–µ—Ç –±–∞–∑–æ–≤—ã–π –∑–∞–ø—Ä–æ—Å —Å –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã–º–∏ join'–∞–º–∏ –∏ –∫–∞—Å—Ç–æ–º–Ω–æ–π —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–æ–π."""
        overdue_case = case(
            (and_(Rental.status == 'active', Rental.end_date < date.today()), 0),
            else_=1
        ).asc()

        return select(Rental).options(
            joinedload(Rental.user),
            joinedload(Rental.created_by),
            selectinload(Rental.equipment).options(
                selectinload(Equipment.accessories),
                selectinload(Equipment.associations)
            ),
            joinedload(Rental.accessory_links).joinedload(RentalAccessory.accessory)
        ).order_by(overdue_case, Rental.id.desc())

    # --- –ò–ó–ú–ï–ù–ï–ù–ò–ï 1: –°–æ–∑–¥–∞–µ–º –µ–¥–∏–Ω—ã–π –º–µ—Ç–æ–¥ –¥–ª—è –ø–æ—Å—Ç—Ä–æ–µ–Ω–∏—è –∑–∞–ø—Ä–æ—Å–∞ —Å —Ñ–∏–ª—å—Ç—Ä–∞–º–∏ ---
    def _get_filtered_query(self, status_filter: Optional[str], search: Optional[str]):
        """
        –°–æ–∑–¥–∞–µ—Ç –∏ –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –æ—Ç—Ñ–∏–ª—å—Ç—Ä–æ–≤–∞–Ω–Ω—ã–π –∑–∞–ø—Ä–æ—Å –Ω–∞ –æ—Å–Ω–æ–≤–µ —Å—Ç–∞—Ç—É—Å–∞ –∏ –ø–æ–∏—Å–∫–∞.
        –≠—Ç–æ —Ü–µ–Ω—Ç—Ä–∞–ª–∏–∑—É–µ—Ç –ª–æ–≥–∏–∫—É —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏.
        """
        query = self._get_base_query()

        # –ü—Ä–∏–º–µ–Ω—è–µ–º —Ñ–∏–ª—å—Ç—Ä –ø–æ —Å—Ç–∞—Ç—É—Å—É, –µ—Å–ª–∏ –æ–Ω –µ—Å—Ç—å
        if status_filter:
            today = date.today()
            if status_filter == 'active':
                # –ê–∫—Ç–∏–≤–Ω—ã–µ –∞—Ä–µ–Ω–¥—ã - –≤—Å–µ –∞—Ä–µ–Ω–¥—ã —Å–æ —Å—Ç–∞—Ç—É—Å–æ–º 'active' (–≤–∫–ª—é—á–∞—è –ø—Ä–æ—Å—Ä–æ—á–µ–Ω–Ω—ã–µ)
                query = query.filter(Rental.status == 'active')
            elif status_filter == 'overdue':
                # –ü—Ä–æ—Å—Ä–æ—á–µ–Ω–Ω—ã–µ –∞—Ä–µ–Ω–¥—ã - –∞–∫—Ç–∏–≤–Ω—ã–µ –∞—Ä–µ–Ω–¥—ã —Å –∏—Å—Ç–µ–∫—à–∏–º —Å—Ä–æ–∫–æ–º
                query = query.filter(Rental.status == 'active', Rental.end_date < today)
            elif status_filter == 'completed':
                query = query.filter(Rental.status == 'completed')

        # –ü—Ä–∏–º–µ–Ω—è–µ–º –ø–æ–∏—Å–∫ –ø–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é, –µ—Å–ª–∏ –æ–Ω –µ—Å—Ç—å
        if search:
            query = self._apply_user_search(query, search, Rental)

        return query

    async def _enrich_rental_with_dynamic_fields(self, rental: Rental) -> RentalOut:
        """–û–±–æ–≥–∞—â–∞–µ—Ç –æ–±—ä–µ–∫—Ç –∞—Ä–µ–Ω–¥—ã –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏–º–∏ –ø–æ–ª—è–º–∏ —á–µ—Ä–µ–∑ FinancialService."""
        rental_out = RentalOut.model_validate(rental)
        today = date.today()

        if rental.status == 'active' and rental.end_date < today:
            rental_out.status = 'overdue'

        if rental_out.status == 'overdue':
            rental_out.overdue_days = self.financial_service.calculate_overdue_days(rental, today)
            rental_out.overdue_surcharge = await self.financial_service.calculate_overdue_surcharge(rental, today)
        elif rental.status == 'active':
            rental_out.days_remaining = (rental.end_date - today).days

        accessories_cost = sum(
            link.accessory.price for link in rental.accessory_links if link.accessory and link.accessory.price
        )
        rental_out.accessories_cost = accessories_cost
        rental_out.remaining_amount = rental.total_cost - rental.prepayment_amount

        return rental_out

    async def get_rentals_for_user(
        self, 
        user: User, 
        skip: int, 
        limit: int,
        status: Optional[str] = None,
        search: Optional[str] = None,
        sort: Optional[str] = None
    ) -> Tuple[List[RentalOut], int]:
        """–ü–æ–ª—É—á–∞–µ—Ç –æ—Ç—Ñ–∏–ª—å—Ç—Ä–æ–≤–∞–Ω–Ω—ã–π –∏ –ø–∞–≥–∏–Ω–∏—Ä–æ–≤–∞–Ω–Ω—ã–π —Å–ø–∏—Å–æ–∫ –∞—Ä–µ–Ω–¥ –¥–ª—è –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è."""
        
        # –°–æ–∑–¥–∞–µ–º –±–∞–∑–æ–≤—ã–π –∑–∞–ø—Ä–æ—Å
        base_query = self._get_base_query().filter(Rental.user_id == user.id)
        
        # –ü—Ä–∏–º–µ–Ω—è–µ–º —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏—é –ø–æ —Å—Ç–∞—Ç—É—Å—É
        base_query = self._apply_status_filter(base_query, status, Rental)
        
        # –ü—Ä–∏–º–µ–Ω—è–µ–º –ø–æ–∏—Å–∫ –ø–æ –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—é
        if search:
            base_query = self._apply_equipment_search(base_query, search, Rental)
        
        # –ü—Ä–∏–º–µ–Ω—è–µ–º —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫—É (–µ—Å–ª–∏ –Ω–µ —É–∫–∞–∑–∞–Ω–∞, –∏—Å–ø–æ–ª—å–∑—É–µ–º –∫–∞—Å—Ç–æ–º–Ω—É—é —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫—É –∏–∑ _get_base_query)
        if sort:
            # –£–±–∏—Ä–∞–µ–º –∫–∞—Å—Ç–æ–º–Ω—É—é —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫—É –∏–∑ –±–∞–∑–æ–≤–æ–≥–æ –∑–∞–ø—Ä–æ—Å–∞ –∏ –ø—Ä–∏–º–µ–Ω—è–µ–º –Ω–æ–≤—É—é
            base_query = base_query.order_by(None)  # –£–±–∏—Ä–∞–µ–º —Å—É—â–µ—Å—Ç–≤—É—é—â—É—é —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫—É
            base_query = self._apply_sorting(base_query, sort, Rental)
        
        # –ü–æ–ª—É—á–∞–µ–º –æ–±—â–µ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ
        total = await self._get_total_count(base_query)
        
        # –ü—Ä–∏–º–µ–Ω—è–µ–º –ø–∞–≥–∏–Ω–∞—Ü–∏—é
        base_query = self._apply_pagination(base_query, skip, limit)
        
        # –ü–æ–ª—É—á–∞–µ–º –¥–∞–Ω–Ω—ã–µ
        rentals_result = await self.db.execute(base_query)
        rentals_orm = rentals_result.unique().scalars().all()
        
        # –û–±–æ–≥–∞—â–∞–µ–º –¥–∞–Ω–Ω—ã–µ —á–µ—Ä–µ–∑ FinancialService
        try:
            enriched_rentals = [await self._enrich_rental_with_dynamic_fields(r) for r in rentals_orm]
            return enriched_rentals, total
        except Exception as e:
            logger.error(f"–û—à–∏–±–∫–∞ –≤ _enrich_rental_with_dynamic_fields: {e}", exc_info=True)
            # Fallback: –≤–æ–∑–≤—Ä–∞—â–∞–µ–º –ø—Ä–æ—Å—Ç—ã–µ –æ–±—ä–µ–∫—Ç—ã
            simple_rentals = [RentalOut.model_validate(r) for r in rentals_orm]
            return simple_rentals, total

    async def get_paginated_rentals(self, skip: int, limit: int, status_filter: Optional[str], search: Optional[str]) -> Tuple[List[RentalOut], int]:
        """–ü–æ–ª—É—á–∞–µ—Ç –æ—Ç—Ñ–∏–ª—å—Ç—Ä–æ–≤–∞–Ω–Ω—ã–π –∏ –ø–∞–≥–∏–Ω–∏—Ä–æ–≤–∞–Ω–Ω—ã–π —Å–ø–∏—Å–æ–∫ –≤—Å–µ—Ö –∞—Ä–µ–Ω–¥."""
        # --- –ò–ó–ú–ï–ù–ï–ù–ò–ï 2: –ò—Å–ø–æ–ª—å–∑—É–µ–º –Ω–æ–≤—ã–π –º–µ—Ç–æ–¥ –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –∑–∞–ø—Ä–æ—Å–∞ ---
        # –¢–µ–ø–µ—Ä—å –∏ –ø–æ–¥—Å—á–µ—Ç, –∏ –≤—ã–±–æ—Ä–∫–∞ –¥–µ–ª–∞—é—Ç—Å—è –Ω–∞ –æ—Å–Ω–æ–≤–µ –æ–¥–Ω–æ–≥–æ –∏ —Ç–æ–≥–æ –∂–µ –æ—Ç—Ñ–∏–ª—å—Ç—Ä–æ–≤–∞–Ω–Ω–æ–≥–æ –∑–∞–ø—Ä–æ—Å–∞.
        filtered_query = self._get_filtered_query(status_filter, search)

        # –ü–æ–ª—É—á–∞–µ–º –æ–±—â–µ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –Ω–∞ –æ—Å–Ω–æ–≤–µ –æ—Ç—Ñ–∏–ª—å—Ç—Ä–æ–≤–∞–Ω–Ω–æ–≥–æ –∑–∞–ø—Ä–æ—Å–∞
        count_query = select(func.count()).select_from(filtered_query.subquery())
        count_result = await self.db.execute(count_query)
        total = count_result.scalar_one()

        # –ü–æ–ª—É—á–∞–µ–º –¥–∞–Ω–Ω—ã–µ —Å –ø–∞–≥–∏–Ω–∞—Ü–∏–µ–π –∏–∑ —Ç–æ–≥–æ –∂–µ –æ—Ç—Ñ–∏–ª—å—Ç—Ä–æ–≤–∞–Ω–Ω–æ–≥–æ –∑–∞–ø—Ä–æ—Å–∞
        paginated_query = filtered_query.offset(skip).limit(limit)
        rentals_result = await self.db.execute(paginated_query)
        rentals_orm = rentals_result.unique().scalars().all()

        try:
            enriched_rentals = [await self._enrich_rental_with_dynamic_fields(r) for r in rentals_orm]
            return enriched_rentals, total
        except Exception as e:
            logger.error(f"–û—à–∏–±–∫–∞ –≤ _enrich_rental_with_dynamic_fields: {e}", exc_info=True)
            simple_rentals = [RentalOut.model_validate(r) for r in rentals_orm]
            return simple_rentals, total

```



## `api\services\reservation_query_service.py`


```python

# api/services/reservation_query_service.py

from sqlalchemy.ext.asyncio import AsyncSession
from sqlalchemy.orm import joinedload, selectinload
from sqlalchemy import or_, select, func
from typing import List, Optional, Tuple
from datetime import date
import logging

from api.models.user import User
from api.models.reservation import Reservation, ReservationAccessory
from api.models.equipment import Equipment
from shared.schemas.reservation_schema import AdminReservationOut, ReservationItem
from shared.schemas.user_schema import UserOut
from api.services.financial_service import FinancialService
from api.services.order.order_query_base import OrderQueryBase

logger = logging.getLogger(__name__)

class ReservationQueryService(OrderQueryBase[Reservation]):
    """
    –ï–¥–∏–Ω—ã–π —Å–µ—Ä–≤–∏—Å –¥–ª—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –æ–ø–µ—Ä–∞—Ü–∏–π —á—Ç–µ–Ω–∏—è (Query) –¥–∞–Ω–Ω—ã—Ö –æ —Ä–µ–∑–µ—Ä–≤–∞—Ö.
    """

    def __init__(self, db: AsyncSession):
        super().__init__(db)
        self.financial_service = FinancialService(db)

    async def get_my_reservations(
        self, 
        user: User, 
        status: Optional[str] = None,
        search: Optional[str] = None,
        sort: Optional[str] = None,
        skip: int = 0,
        limit: int = 100
    ) -> Tuple[List[ReservationItem], int]:
        """–ü–æ–ª—É—á–∞–µ—Ç –æ—Ç—Ñ–∏–ª—å—Ç—Ä–æ–≤–∞–Ω–Ω—ã–π –∏ –ø–∞–≥–∏–Ω–∏—Ä–æ–≤–∞–Ω–Ω—ã–π —Å–ø–∏—Å–æ–∫ —Ä–µ–∑–µ—Ä–≤–æ–≤ –¥–ª—è —Ç–µ–∫—É—â–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è."""
        
        # –°–æ–∑–¥–∞–µ–º –±–∞–∑–æ–≤—ã–π –∑–∞–ø—Ä–æ—Å
        query = select(Reservation).filter(Reservation.user_id == user.id)
        
        # –ü—Ä–∏–º–µ–Ω—è–µ–º —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏—é –ø–æ —Å—Ç–∞—Ç—É—Å—É
        query = self._apply_status_filter(query, status, Reservation)
        
        # –ü—Ä–∏–º–µ–Ω—è–µ–º –ø–æ–∏—Å–∫ –ø–æ –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—é
        if search:
            query = self._apply_equipment_search(query, search, Reservation)
        
        # –î–æ–±–∞–≤–ª—è–µ–º –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã–µ JOIN'—ã
        query = query.options(
            joinedload(Reservation.applied_promo_code),
            joinedload(Reservation.accessory_links).joinedload(ReservationAccessory.accessory),
            selectinload(Reservation.equipment).options(
                selectinload(Equipment.accessories),
                selectinload(Equipment.associations)
            ),
            joinedload(Reservation.rental)
        )
        
        # –ü—Ä–∏–º–µ–Ω—è–µ–º —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫—É
        query = self._apply_sorting(query, sort, Reservation)
        
        # –ü–æ–ª—É—á–∞–µ–º –æ–±—â–µ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ
        total = await self._get_total_count(query)
        
        # –ü—Ä–∏–º–µ–Ω—è–µ–º –ø–∞–≥–∏–Ω–∞—Ü–∏—é
        query = self._apply_pagination(query, skip, limit)
        
        # –í—ã–ø–æ–ª–Ω—è–µ–º –∑–∞–ø—Ä–æ—Å
        result = await self.db.execute(query)
        reservations_orm = result.unique().scalars().all()
        
        # –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º —Å—Ç–∞—Ç—É—Å—ã –∏ –ø—Ä–µ–æ–±—Ä–∞–∑—É–µ–º –≤ DTO —á–µ—Ä–µ–∑ FinancialService
        items_dto = []
        for r_orm in reservations_orm:
            try:
                item_dto = await self.financial_service.enrich_order_with_financials(r_orm)
                items_dto.append(item_dto)
            except Exception as e:
                logger.error(f"–û—à–∏–±–∫–∞ –æ–±–æ–≥–∞—â–µ–Ω–∏—è —Ä–µ–∑–µ—Ä–≤–∞ ID {r_orm.id}: {e}")
                # Fallback: –ø—Ä–æ—Å—Ç–∞—è –≤–∞–ª–∏–¥–∞—Ü–∏—è
                item_dto = ReservationItem.model_validate(r_orm)
                items_dto.append(item_dto)
        
        return items_dto, total

    def _get_admin_base_query(self, status_filter: Optional[str] = None, search_query: Optional[str] = None):
        """–í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–π –º–µ—Ç–æ–¥ –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –±–∞–∑–æ–≤–æ–≥–æ –∑–∞–ø—Ä–æ—Å–∞ —Å —Ñ–∏–ª—å—Ç—Ä–∞–º–∏ –¥–ª—è –∞–¥–º–∏–Ω-–ø–∞–Ω–µ–ª–∏."""
        query = select(Reservation).options(
            joinedload(Reservation.user),
            joinedload(Reservation.applied_promo_code),
            joinedload(Reservation.accessory_links).joinedload(ReservationAccessory.accessory),
            selectinload(Reservation.equipment).options(
                selectinload(Equipment.accessories),
                selectinload(Equipment.associations)
            ),
            joinedload(Reservation.rental)
        )
        if search_query:
            query = self._apply_user_search(query, search_query, Reservation)

        if status_filter == "active":
            query = query.filter(Reservation.status == 'active')
        elif status_filter == "completed":
            query = query.filter(Reservation.status.in_(['fulfilled', 'cancelled', 'overdue']))

        return query

    async def get_admin_reservations_count(self, status: Optional[str] = None, search_query: Optional[str] = None) -> int:
        """–ü–æ–ª—É—á–∞–µ—Ç –æ–±—â–µ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ä–µ–∑–µ—Ä–≤–æ–≤ —Å —É—á–µ—Ç–æ–º —Ñ–∏–ª—å—Ç—Ä–æ–≤ –¥–ª—è –∞–¥–º–∏–Ω-–ø–∞–Ω–µ–ª–∏."""
        query = self._get_admin_base_query(status, search_query)
        result = await self.db.execute(select(func.count()).select_from(query.subquery()))
        return result.scalar_one()

    async def get_paginated_admin_reservations(self, skip: int, limit: int, status: Optional[str] = None, search_query: Optional[str] = None) -> List[AdminReservationOut]:
        """–ü–æ–ª—É—á–∞–µ—Ç —Å—Ç—Ä–∞–Ω–∏—Ü—É —Ä–µ–∑–µ—Ä–≤–æ–≤ —Å –ø–∞–≥–∏–Ω–∞—Ü–∏–µ–π –¥–ª—è –∞–¥–º–∏–Ω-–ø–∞–Ω–µ–ª–∏."""
        query = self._get_admin_base_query(status, search_query)
        result = await self.db.execute(query.order_by(Reservation.id.desc()).offset(skip).limit(limit))
        reservations_orm = result.unique().scalars().all()

        result = []
        for r_orm in reservations_orm:
            if not r_orm.user:
                continue
            try:
                # –ò—Å–ø–æ–ª—å–∑—É–µ–º FinancialService –¥–ª—è –æ–±–æ–≥–∞—â–µ–Ω–∏—è –∞–¥–º–∏–Ω-—Ä–µ–∑–µ—Ä–≤–∞
                final_output = await self.financial_service._enrich_admin_reservation_with_financials(r_orm)
                result.append(final_output)
            except Exception as e:
                logger.error(f"–û—à–∏–±–∫–∞ –≤–∞–ª–∏–¥–∞—Ü–∏–∏ –∞–¥–º–∏–Ω-—Ä–µ–∑–µ—Ä–≤–∞ ID {r_orm.id}: {e}", exc_info=True)
                continue
        return result

```



## `api\services\user_service.py`


```python

# src/api/services/user_service.py

from sqlalchemy.ext.asyncio import AsyncSession
from sqlalchemy.orm import joinedload
from sqlalchemy import select, func
from api.models.user import User
from api.models.payment import Payment
# +++ –î–û–ë–ê–í–¨–¢–ï –≠–¢–û–¢ –ò–ú–ü–û–†–¢ +++
from api.models.balance_history import BalanceHistory
from api.services.balance_service import BalanceService
from shared.schemas.user_schema import UserUpdate, UserOut, AdminUserCreate, AdminUserUpdate, UserPaymentRequest
from api.services import auth_service
from fastapi import HTTPException
import logging
from datetime import datetime
from typing import List, Tuple


async def create_admin_user(db: AsyncSession, user_data: AdminUserCreate) -> User:
    """–°–æ–∑–¥–∞–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (–¥–ª—è –∞–¥–º–∏–Ω–æ–≤)."""
    result = await db.execute(select(User).filter(User.email == user_data.email))
    existing_user = result.scalars().first()
    if existing_user:
        raise HTTPException(status_code=409, detail="–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å —Ç–∞–∫–∏–º email —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç.")

    try:
        new_user = User(
            full_name=user_data.full_name,
            email=user_data.email,
            hashed_password=auth_service.hash_password(user_data.password),
            phone=user_data.phone,
            role=user_data.role,
            is_active=True,
            status="–ê–∫—Ç–∏–≤–Ω—ã–π",
            balance=0.0,
            notes=f"–°–æ–∑–¥–∞–Ω –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–º {datetime.now().strftime('%d-%m-%Y')}",
            privacy_policy_accepted=user_data.privacy_policy_accepted,
            terms_accepted=user_data.terms_accepted,
            email_verified=True
        )
        db.add(new_user)
        await db.commit()
        
        # –í–æ–∑–≤—Ä–∞—â–∞–µ–º —Å–æ–∑–¥–∞–Ω–Ω—ã–π –æ–±—ä–µ–∫—Ç –±–µ–∑ –ø–æ–≤—Ç–æ—Ä–Ω–æ–≥–æ –∑–∞–ø—Ä–æ—Å–∞ –∫ –ë–î
        return new_user
    except Exception as e:
        await db.rollback()
        logging.error(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–º: {e}")
        raise HTTPException(status_code=500, detail="–í–Ω—É—Ç—Ä–µ–Ω–Ω—è—è –æ—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞.")

def get_current_user_info(user: User) -> UserOut:
    return UserOut.from_orm(user)

async def update_user(db: AsyncSession, user: User, data: UserUpdate) -> UserOut:
    """–û–±–Ω–æ–≤–ª—è–µ—Ç –ø—Ä–æ—Ñ–∏–ª—å —Ç–µ–∫—É—â–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è."""
    update_data = data.model_dump(exclude_unset=True)

    if 'email' in update_data and update_data['email'] != user.email:
        logging.info(f"–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å {user.id} –∑–∞–ø—Ä–æ—Å–∏–ª —Å–º–µ–Ω—É email –Ω–∞ {update_data['email']}. –¢—Ä–µ–±—É–µ—Ç—Å—è –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ.")
        del update_data['email']

    for key, value in update_data.items():
        setattr(user, key, value)

    db.add(user)
    await db.commit()
    
    # –í–æ–∑–≤—Ä–∞—â–∞–µ–º –æ–±–Ω–æ–≤–ª–µ–Ω–Ω—ã–π –æ–±—ä–µ–∫—Ç –±–µ–∑ –ø–æ–≤—Ç–æ—Ä–Ω–æ–≥–æ –∑–∞–ø—Ä–æ—Å–∞ –∫ –ë–î
    return UserOut.from_orm(user)

async def update_user_by_admin(db: AsyncSession, user_id: int, data: AdminUserUpdate, current_user: User) -> UserOut:
    """–û–±–Ω–æ–≤–ª—è–µ—Ç –¥–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è. –¢–æ–ª—å–∫–æ –∞–¥–º–∏–Ω –º–æ–∂–µ—Ç –º–µ–Ω—è—Ç—å —Ä–æ–ª—å."""
    result = await db.execute(select(User).filter(User.id == user_id))
    user_to_update = result.scalars().first()
    if not user_to_update:
        raise HTTPException(status_code=404, detail="–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω")

    update_data = data.model_dump(exclude_unset=True)

    if 'role' in update_data and current_user.role != 'admin':
        raise HTTPException(status_code=403, detail="–¢–æ–ª—å–∫–æ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä –º–æ–∂–µ—Ç –∏–∑–º–µ–Ω—è—Ç—å —Ä–æ–ª—å.")

    for key, value in update_data.items():
        setattr(user_to_update, key, value)

    db.add(user_to_update)
    await db.commit()
    
    # –í–æ–∑–≤—Ä–∞—â–∞–µ–º –æ–±–Ω–æ–≤–ª–µ–Ω–Ω—ã–π –æ–±—ä–µ–∫—Ç –±–µ–∑ –ø–æ–≤—Ç–æ—Ä–Ω–æ–≥–æ –∑–∞–ø—Ä–æ—Å–∞ –∫ –ë–î
    return UserOut.from_orm(user_to_update)

async def process_user_payment(db: AsyncSession, user_id: int, payment_data: UserPaymentRequest, manager: User) -> UserOut:
    """–û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç —Ä–µ–∞–ª—å–Ω—ã–π –ø–ª–∞—Ç–µ–∂ –∏ –ø–æ–ø–æ–ª–Ω—è–µ—Ç –≤–Ω—É—Ç—Ä–µ–Ω–Ω–∏–π –±–∞–ª–∞–Ω—Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è."""
    result = await db.execute(select(User).filter(User.id == user_id))
    user_to_update = result.scalars().first()
    if not user_to_update:
        raise HTTPException(status_code=404, detail="–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω")

    try:
        new_payment = Payment(
            user_id=user_id,
            amount=payment_data.amount,
            payment_method=payment_data.payment_method,
            description=payment_data.description or f"–ü–ª–∞—Ç–µ–∂ –ø—Ä–∏–Ω—è—Ç {manager.full_name}",
            transaction_type="balance_top_up"
        )
        db.add(new_payment)

        balance_service = BalanceService(db)
        await balance_service.add_transaction(
            user_id=user_id,
            amount=payment_data.amount,
            operation_type="balance_top_up",
            description=f"–ü–æ–ø–æ–ª–Ω–µ–Ω–∏–µ –±–∞–ª–∞–Ω—Å–∞. –ú–µ—Ç–æ–¥: {payment_data.payment_method}."
        )

        await db.commit()
        
        # –í–æ–∑–≤—Ä–∞—â–∞–µ–º –æ–±–Ω–æ–≤–ª–µ–Ω–Ω—ã–π –æ–±—ä–µ–∫—Ç –±–µ–∑ –ø–æ–≤—Ç–æ—Ä–Ω–æ–≥–æ –∑–∞–ø—Ä–æ—Å–∞ –∫ –ë–î
        return UserOut.from_orm(user_to_update)

    except HTTPException:
        await db.rollback()
        raise
    except Exception as e:
        await db.rollback()
        logging.error(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±—Ä–∞–±–æ—Ç–∫–µ –ø–ª–∞—Ç–µ–∂–∞ –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è ID={user_id}: {e}", exc_info=True)
        raise HTTPException(status_code=500, detail="–í–Ω—É—Ç—Ä–µ–Ω–Ω—è—è –æ—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±—Ä–∞–±–æ—Ç–∫–µ –ø–ª–∞—Ç–µ–∂–∞.")

# +++ –ù–ê–ß–ê–õ–û: –ù–æ–≤–∞—è —Ñ—É–Ω–∫—Ü–∏—è +++
async def get_balance_history_for_user(db: AsyncSession, user_id: int, skip: int, limit: int) -> Tuple[List[BalanceHistory], int]:
    """–ü–æ–ª—É—á–∞–µ—Ç –ø–∞–≥–∏–Ω–∏—Ä–æ–≤–∞–Ω–Ω—É—é –∏—Å—Ç–æ—Ä–∏—é –±–∞–ª–∞–Ω—Å–∞ –¥–ª—è —É–∫–∞–∑–∞–Ω–Ω–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è."""

    total_result = await db.execute(
        select(func.count(BalanceHistory.id)).filter(BalanceHistory.user_id == user_id)
    )
    total = total_result.scalar_one()

    history_result = await db.execute(
        select(BalanceHistory)
        .filter(BalanceHistory.user_id == user_id)
        .order_by(BalanceHistory.created_at.desc())
        .offset(skip)
        .limit(limit)
    )
    history_items = history_result.scalars().all()

    return history_items, total
# +++ –ö–û–ù–ï–¶: –ù–æ–≤–∞—è —Ñ—É–Ω–∫—Ü–∏—è +++

```



## `api\user_api.py`


```python

# api/user_api.py

from fastapi import APIRouter, Depends, HTTPException, Query
from sqlalchemy.ext.asyncio import AsyncSession
from sqlalchemy import select, func
from typing import List, Optional

from api.models.user import User as OrmUser
from api.deps import get_db, get_rental_query_service
from api.permissions import require_user, require_manager, require_admin
from api.models.user import User as PermissionUser
from api.services import user_service
# <-- –ò–ó–ú–ï–ù–ï–ù–ò–ï –ó–î–ï–°–¨: –û–±–Ω–æ–≤–ª—è–µ–º –ø—É—Ç—å –∏–º–ø–æ—Ä—Ç–∞
from api.services.rental.rental_query_service import RentalQueryService
# ---------------------------------------------------
from shared.schemas.rental_schema import RentalListResponse, RentalOut
from shared.schemas.user_schema import UserUpdate, UserOut, AdminUserCreate, AdminUserUpdate, UserListResponse, UserPaymentRequest
from shared.schemas.balance_history_schema import BalanceHistoryOut, BalanceHistoryListResponse
from fastapi_csrf_protect import CsrfProtect

router = APIRouter(prefix="/user", tags=["–ü—Ä–æ—Ñ–∏–ª—å –∏ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏"])


@router.get("/", response_model=UserOut)
def get_my_profile(current_user: PermissionUser = Depends(require_user)):
    """
    –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç –ø—Ä–æ—Ñ–∏–ª—å —Ç–µ–∫—É—â–µ–≥–æ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω–Ω–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è.
    """
    return user_service.get_current_user_info(current_user)


@router.get("/rentals", response_model=RentalListResponse)
async def get_my_rentals(
        current_user: PermissionUser = Depends(require_user),
        service: RentalQueryService = Depends(get_rental_query_service),
        status: Optional[str] = Query(None, description="–§–∏–ª—å—Ç—Ä –ø–æ —Å—Ç–∞—Ç—É—Å—É: active, completed, overdue"),
        search: Optional[str] = Query(None, description="–ü–æ–∏—Å–∫ –ø–æ –Ω–∞–∑–≤–∞–Ω–∏—é, –±—Ä–µ–Ω–¥—É –∏–ª–∏ —Ç–∏–ø—É –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—è"),
        sort: Optional[str] = Query(None, description="–°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞: id_desc, id_asc, start_date_desc, start_date_asc, end_date_desc, end_date_asc, count_desc, count_asc"),
        skip: int = Query(0, ge=0, description="–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –∑–∞–ø–∏—Å–µ–π –¥–ª—è –ø—Ä–æ–ø—É—Å–∫–∞"),
        limit: int = Query(10, ge=1, le=100, description="–ú–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∑–∞–ø–∏—Å–µ–π –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–µ")
):
    """
    –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç –æ—Ç—Ñ–∏–ª—å—Ç—Ä–æ–≤–∞–Ω–Ω—ã–π –∏ –ø–∞–≥–∏–Ω–∏—Ä–æ–≤–∞–Ω–Ω—ã–π —Å–ø–∏—Å–æ–∫ –∞—Ä–µ–Ω–¥ –¥–ª—è —Ç–µ–∫—É—â–µ–≥–æ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω–Ω–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è.
    """
    rentals_out, total = await service.get_rentals_for_user(
        current_user, skip, limit, status, search, sort
    )
    return RentalListResponse(
        items=rentals_out,
        total=total
    )


@router.get("/balance-history", response_model=BalanceHistoryListResponse)
async def get_my_balance_history(
        db: AsyncSession = Depends(get_db),
        current_user: PermissionUser = Depends(require_user),
        skip: int = Query(0, ge=0),
        limit: int = Query(15, ge=1, le=100)
):
    """
    –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç –∏—Å—Ç–æ—Ä–∏—é —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π –ø–æ –±–∞–ª–∞–Ω—Å—É –¥–ª—è —Ç–µ–∫—É—â–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è.
    """
    history_orm, total = await user_service.get_balance_history_for_user(db, current_user.id, skip, limit)
    return BalanceHistoryListResponse(
        items=[BalanceHistoryOut.from_orm(h) for h in history_orm],
        total=total
    )


@router.put("/", response_model=UserOut)
async def update_my_profile(
        data: UserUpdate,
        db: AsyncSession = Depends(get_db),
        current_user: PermissionUser = Depends(require_user),
        csrf_protect: CsrfProtect = Depends()
):
    """
    –û–±–Ω–æ–≤–ª—è–µ—Ç –ø—Ä–æ—Ñ–∏–ª—å (–§–ò–û, email, —Ç–µ–ª–µ—Ñ–æ–Ω) —Ç–µ–∫—É—â–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è.
    –ó–ê–ì–õ–£–®–ö–ê: –°–º–µ–Ω–∞ email –≤ –±—É–¥—É—â–µ–º –ø–æ—Ç—Ä–µ–±—É–µ—Ç –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è –ø–æ –ø–æ—á—Ç–µ.
    """
    return await user_service.update_user(db, current_user, data)


@router.post("/confirm-email-change", summary="–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å —Å–º–µ–Ω—É email (–∑–∞–≥–ª—É—à–∫–∞)")
async def confirm_email_change(
        token: str,
        db: AsyncSession = Depends(get_db),
        current_user: PermissionUser = Depends(require_user),
        csrf_protect: CsrfProtect = Depends()
):
    """
    –ó–ê–ì–õ–£–®–ö–ê: –í –±—É–¥—É—â–µ–º –∑–¥–µ—Å—å –±—É–¥–µ—Ç –ª–æ–≥–∏–∫–∞ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è —Å–º–µ–Ω—ã email –ø–æ —Ç–æ–∫–µ–Ω—É.
    –°–µ–π—á–∞—Å –ø—Ä–æ—Å—Ç–æ –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–µ –æ —Ç–æ–º, —á—Ç–æ —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª –≤ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ.
    """
    return {
        "message": "–§—É–Ω–∫—Ü–∏–æ–Ω–∞–ª –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è —Å–º–µ–Ω—ã email –Ω–∞—Ö–æ–¥–∏—Ç—Å—è –≤ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ",
        "status": "not_implemented"
    }


# --- –≠–Ω–¥–ø–æ–∏–Ω—Ç—ã –¥–ª—è –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω–∏—è ---

@router.post("/admin/users", response_model=UserOut, status_code=201, summary="–°–æ–∑–¥–∞—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (–ê–¥–º–∏–Ω)")
async def create_user_by_admin(
        user_data: AdminUserCreate,
        db: AsyncSession = Depends(get_db),
        current_user: PermissionUser = Depends(require_admin),
        csrf_protect: CsrfProtect = Depends()
):
    """
    –°–æ–∑–¥–∞–µ—Ç –Ω–æ–≤–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è —Å —É–∫–∞–∑–∞–Ω–Ω–æ–π —Ä–æ–ª—å—é.
    –î–æ—Å—Ç—É–ø–Ω–æ —Ç–æ–ª—å–∫–æ –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π —Å —Ä–æ–ª—å—é 'admin'.
    """
    new_user = await user_service.create_admin_user(db, user_data)
    return new_user


@router.get("/admin/users", response_model=UserListResponse, summary="–ü–æ–ª—É—á–∏—Ç—å –≤—Å–µ—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π (–ú–µ–Ω–µ–¥–∂–µ—Ä)")
async def get_all_users(
        db: AsyncSession = Depends(get_db),
        current_user: PermissionUser = Depends(require_manager),
        skip: int = Query(0, ge=0, description="–°–∫–æ–ª—å–∫–æ –∑–∞–ø–∏—Å–µ–π –ø—Ä–æ–ø—É—Å—Ç–∏—Ç—å"),
        limit: int = Query(10, ge=1, le=100, description="–ú–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∑–∞–ø–∏—Å–µ–π –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–µ")
):
    """
    –ü–æ–ª—É—á–∞–µ—Ç —Å–ø–∏—Å–æ–∫ –≤—Å–µ—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –≤ —Å–∏—Å—Ç–µ–º–µ —Å –ø–∞–≥–∏–Ω–∞—Ü–∏–µ–π.
    –î–æ—Å—Ç—É–ø–Ω–æ –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π —Å —Ä–æ–ª—å—é 'manager' –∏ 'admin'.
    """
    total_result = await db.execute(select(func.count(OrmUser.id)))
    total_users = total_result.scalar_one()
    users_result = await db.execute(select(OrmUser).offset(skip).limit(limit))
    users_orm = users_result.scalars().all()

    return UserListResponse(
        items=[UserOut.from_orm(user) for user in users_orm],
        total=total_users
    )


@router.get("/admin/users/{user_id}/balance-history", response_model=BalanceHistoryListResponse, summary="–ü–æ–ª—É—á–∏—Ç—å –∏—Å—Ç–æ—Ä–∏—é –±–∞–ª–∞–Ω—Å–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (–ú–µ–Ω–µ–¥–∂–µ—Ä)")
async def get_user_balance_history_by_admin(
        user_id: int,
        db: AsyncSession = Depends(get_db),
        current_user: PermissionUser = Depends(require_manager),
        skip: int = Query(0, ge=0),
        limit: int = Query(15, ge=1, le=100)
):
    """
    –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç –∏—Å—Ç–æ—Ä–∏—é —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π –ø–æ –±–∞–ª–∞–Ω—Å—É –¥–ª—è —É–∫–∞–∑–∞–Ω–Ω–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è.
    """
    history_orm, total = await user_service.get_balance_history_for_user(db, user_id, skip, limit)
    return BalanceHistoryListResponse(
        items=[BalanceHistoryOut.from_orm(h) for h in history_orm],
        total=total
    )


@router.post("/admin/users/{user_id}/add-payment", response_model=UserOut, summary="–î–æ–±–∞–≤–∏—Ç—å –ø–ª–∞—Ç–µ–∂ –∏ –ø–æ–ø–æ–ª–Ω–∏—Ç—å –±–∞–ª–∞–Ω—Å (–ú–µ–Ω–µ–¥–∂–µ—Ä)")
async def add_payment_to_user(
        user_id: int,
        payment_data: UserPaymentRequest,
        db: AsyncSession = Depends(get_db),
        current_user: PermissionUser = Depends(require_manager),
        csrf_protect: CsrfProtect = Depends()
):
    """
    –†–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–µ—Ç —Ä–µ–∞–ª—å–Ω—ã–π –ø–ª–∞—Ç–µ–∂ –æ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏ –ø–æ–ø–æ–ª–Ω—è–µ—Ç –µ–≥–æ –≤–Ω—É—Ç—Ä–µ–Ω–Ω–∏–π –±–∞–ª–∞–Ω—Å.
    """
    return await user_service.process_user_payment(db, user_id, payment_data, current_user)


@router.put("/admin/users/{user_id}", response_model=UserOut, summary="–û–±–Ω–æ–≤–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (–ú–µ–Ω–µ–¥–∂–µ—Ä/–ê–¥–º–∏–Ω)")
async def update_user_by_admin_or_manager(
        user_id: int,
        data: AdminUserUpdate,
        db: AsyncSession = Depends(get_db),
        current_user: PermissionUser = Depends(require_manager),
        csrf_protect: CsrfProtect = Depends()
):
    """
    –û–±–Ω–æ–≤–ª—è–µ—Ç –¥–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è. –ú–µ–Ω–µ–¥–∂–µ—Ä—ã –º–æ–≥—É—Ç –æ–±–Ω–æ–≤–ª—è—Ç—å –≤—Å–µ, –∫—Ä–æ–º–µ —Ä–æ–ª–∏.
    –ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—ã –º–æ–≥—É—Ç –æ–±–Ω–æ–≤–ª—è—Ç—å –≤—Å–µ, –≤–∫–ª—é—á–∞—è —Ä–æ–ª—å. Email –Ω–µ –º–µ–Ω—è–µ—Ç—Å—è.
    """
    return await user_service.update_user_by_admin(db, user_id, data, current_user)


@router.put("/admin/users/{user_id}/role", summary="–ò–∑–º–µ–Ω–∏—Ç—å —Ä–æ–ª—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (–ê–¥–º–∏–Ω)")
async def update_user_role(
        user_id: int,
        new_role: str,
        db: AsyncSession = Depends(get_db),
        current_user: PermissionUser = Depends(require_admin),
        csrf_protect: CsrfProtect = Depends()
):
    """
    –û–±–Ω–æ–≤–ª—è–µ—Ç —Ä–æ–ª—å —É–∫–∞–∑–∞–Ω–Ω–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è.
    –î–æ—Å—Ç—É–ø–Ω–æ —Ç–æ–ª—å–∫–æ –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π —Å —Ä–æ–ª—å—é 'admin'.
    """
    if user_id == current_user.id:
        raise HTTPException(status_code=400, detail="–ù–µ–ª—å–∑—è –∏–∑–º–µ–Ω–∏—Ç—å —Å–æ–±—Å—Ç–≤–µ–Ω–Ω—É—é —Ä–æ–ª—å.")

    result = await db.execute(select(OrmUser).filter(OrmUser.id == user_id))
    user_orm = result.scalars().first()
    if not user_orm:
        raise HTTPException(status_code=404, detail="–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω")

    if new_role not in ["user", "manager", "admin"]:
        raise HTTPException(status_code=400, detail="–ù–µ–¥–æ–ø—É—Å—Ç–∏–º–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ —Ä–æ–ª–∏.")

    user_orm.role = new_role
    await db.commit()
    return {"message": f"–†–æ–ª—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è {user_orm.email} –æ–±–Ω–æ–≤–ª–µ–Ω–∞ –Ω–∞ '{new_role}'"}


@router.put("/admin/users/{user_id}/block", summary="–ó–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (–ê–¥–º–∏–Ω)")
async def block_user(
        user_id: int,
        db: AsyncSession = Depends(get_db),
        current_user: PermissionUser = Depends(require_admin),
        csrf_protect: CsrfProtect = Depends()
):
    """
    –î–µ–∞–∫—Ç–∏–≤–∏—Ä—É–µ—Ç (–±–ª–æ–∫–∏—Ä—É–µ—Ç) –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è.
    –î–æ—Å—Ç—É–ø–Ω–æ —Ç–æ–ª—å–∫–æ –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π —Å —Ä–æ–ª—å—é 'admin'.
    """
    if user_id == current_user.id:
        raise HTTPException(status_code=400, detail="–ù–µ–ª—å–∑—è –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å —Å–∞–º–æ–≥–æ —Å–µ–±—è.")

    result = await db.execute(select(OrmUser).filter(OrmUser.id == user_id))
    user_orm = result.scalars().first()
    if not user_orm:
        raise HTTPException(status_code=404, detail="–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω")

    user_orm.is_active = False
    await db.commit()
    return {"message": f"–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å {user_orm.email} –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω"}


@router.put("/admin/users/{user_id}/unblock", summary="–†–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (–ê–¥–º–∏–Ω)")
async def unblock_user(
        user_id: int,
        db: AsyncSession = Depends(get_db),
        current_user: PermissionUser = Depends(require_admin),
        csrf_protect: CsrfProtect = Depends()
):
    """
    –ê–∫—Ç–∏–≤–∏—Ä—É–µ—Ç (—Ä–∞–∑–±–ª–æ–∫–∏—Ä—É–µ—Ç) –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è.
    –î–æ—Å—Ç—É–ø–Ω–æ —Ç–æ–ª—å–∫–æ –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π —Å —Ä–æ–ª—å—é 'admin'.
    """
    result = await db.execute(select(OrmUser).filter(OrmUser.id == user_id))
    user_orm = result.scalars().first()
    if not user_orm:
        raise HTTPException(status_code=404, detail="–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω")

    user_orm.is_active = True
    await db.commit()
    return {"message": f"–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å {user_orm.email} —Ä–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω"}


@router.delete("/admin/users/{user_id}", summary="–£–¥–∞–ª–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (–ê–¥–º–∏–Ω)")
async def delete_user(
        user_id: int,
        db: AsyncSession = Depends(get_db),
        current_user: PermissionUser = Depends(require_admin),
        csrf_protect: CsrfProtect = Depends()
):
    """
    –ü–æ–ª–Ω–æ—Å—Ç—å—é —É–¥–∞–ª—è–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏–∑ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö.
    –≠—Ç–æ –Ω–µ–æ–±—Ä–∞—Ç–∏–º–æ–µ –¥–µ–π—Å—Ç–≤–∏–µ!
    –î–æ—Å—Ç—É–ø–Ω–æ —Ç–æ–ª—å–∫–æ –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π —Å —Ä–æ–ª—å—é 'admin'.
    """
    if user_id == current_user.id:
        raise HTTPException(status_code=400, detail="–ù–µ–ª—å–∑—è —É–¥–∞–ª–∏—Ç—å —Å–∞–º–æ–≥–æ —Å–µ–±—è.")

    result = await db.execute(select(OrmUser).filter(OrmUser.id == user_id))
    user_orm = result.scalars().first()
    if not user_orm:
        raise HTTPException(status_code=404, detail="–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω")

    await db.delete(user_orm)
    await db.commit()
    return {"message": f"–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å {user_orm.email} –ø–æ–ª–Ω–æ—Å—Ç—å—é —É–¥–∞–ª–µ–Ω –∏–∑ —Å–∏—Å—Ç–µ–º—ã"}

```



## `db\init_db.py`


```python

# db/init_db.py
from db.orm import init_db

if __name__ == "__main__":
    init_db()
    print("–ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö —É—Å–ø–µ—à–Ω–æ —Å–æ–∑–¥–∞–Ω–∞!")

```



## `requirements.txt`


```html

# –û—à–∏–±–∫–∞ —á—Ç–µ–Ω–∏—è —Ñ–∞–π–ª–∞: 'utf-8' codec can't decode byte 0xff in position 0: invalid start byte

```



## `shared\schemas\accessory_schema.py`


```python

# shared/schemas/accessory_schema.py

from pydantic import BaseModel, ConfigDict
from typing import Optional, List

class AccessoryBase(BaseModel):
    name: str
    accessory_type: Optional[str] = "–ü—Ä–æ—á–µ–µ"
    price: Optional[float] = 0.0
    description: Optional[str] = None

class AccessoryCreate(AccessoryBase):
    pass

class AccessoryUpdate(AccessoryBase):
    pass

class AccessoryOut(AccessoryBase):
    id: int
    model_config = ConfigDict(from_attributes=True)


class AccessoryListResponse(BaseModel):
    items: List[AccessoryOut]
    total: int

```



## `shared\schemas\association_schema.py`


```python

# shared/schemas/association_schema.py

from pydantic import BaseModel, ConfigDict, Field
from typing import Optional, List

# –ë–∞–∑–æ–≤–∞—è —Å—Ö–µ–º–∞ —Å –æ–±—â–∏–º–∏ –ø–æ–ª—è–º–∏
class AssociationBase(BaseModel):
    name: str = Field(..., min_length=3, max_length=100, description="–ù–∞–∑–≤–∞–Ω–∏–µ –∞—Å—Å–æ—Ü–∏–∞—Ü–∏–∏")
    description: Optional[str] = Field(None, description="–í–Ω—É—Ç—Ä–µ–Ω–Ω–µ–µ –æ–ø–∏—Å–∞–Ω–∏–µ")
    sort_order: int = Field(0, description="–ò–Ω–¥–µ–∫—Å –¥–ª—è —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∏")

# –°—Ö–µ–º–∞ –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –Ω–æ–≤–æ–π –∞—Å—Å–æ—Ü–∏–∞—Ü–∏–∏
class AssociationCreate(AssociationBase):
    equipment_ids: List[int] = Field([], description="–°–ø–∏—Å–æ–∫ ID —Å–≤—è–∑–∞–Ω–Ω–æ–≥–æ –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—è")

# –°—Ö–µ–º–∞ –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–π –∞—Å—Å–æ—Ü–∏–∞—Ü–∏–∏
class AssociationUpdate(BaseModel):
    name: Optional[str] = Field(None, min_length=3, max_length=100)
    description: Optional[str] = None
    sort_order: Optional[int] = None
    equipment_ids: Optional[List[int]] = None

# –°—Ö–µ–º–∞ –¥–ª—è –≤—ã–≤–æ–¥–∞ –¥–∞–Ω–Ω—ã—Ö –∏–∑ API.
# –°–∞–º–æ–µ –≤–∞–∂–Ω–æ–µ: –æ–Ω–∞ –≤–∫–ª—é—á–∞–µ—Ç `equipment_ids` –¥–ª—è —Ä–∞–±–æ—Ç—ã —Ñ–∏–ª—å—Ç—Ä–∞ –Ω–∞ —Ñ—Ä–æ–Ω—Ç–µ–Ω–¥–µ.
class AssociationOut(AssociationBase):
    id: int
    equipment_ids: List[int]

    model_config = ConfigDict(from_attributes=True)

# +++ –í–û–°–°–¢–ê–ù–û–í–ò–¢–¨ –≠–¢–û–¢ –ö–õ–ê–°–° +++
# –≠—Ç–∞ —Å—Ö–µ–º–∞ –Ω—É–∂–Ω–∞ –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ–± –∞—Å—Å–æ—Ü–∏–∞—Ü–∏–∏ –≤–Ω—É—Ç—Ä–∏ —Å—Ö–µ–º—ã –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—è.
class AssociationSimple(BaseModel):
    id: int
    name: str

    model_config = ConfigDict(from_attributes=True)


class AssociationListResponse(BaseModel):
    items: List[AssociationOut]
    total: int

```



## `shared\schemas\balance_history_schema.py`


```python

# src/shared/schemas/balance_history_schema.py (–ù–û–í–´–ô –§–ê–ô–õ)

from pydantic import BaseModel, ConfigDict
from datetime import datetime
from typing import List, Optional

class BalanceHistoryBase(BaseModel):
    amount: float
    operation_type: str
    description: Optional[str] = None
    created_at: datetime
    rental_id: Optional[int] = None

class BalanceHistoryOut(BalanceHistoryBase):
    id: int
    user_id: int

    model_config = ConfigDict(from_attributes=True)

class BalanceHistoryListResponse(BaseModel):
    items: List[BalanceHistoryOut]
    total: int

```



## `shared\schemas\calendar_schema.py`


```python

# shared/schemas/calendar_schema.py

from datetime import date
from typing import Optional, Dict, Union, List
from pydantic import BaseModel, ConfigDict # ‚ùóÔ∏è –ò–º–ø–æ—Ä—Ç–∏—Ä—É–µ–º ConfigDict


class EquipmentStatusResponse(BaseModel):
    equipment_id: int
    status: str
    details: str
    name: str | None = None
    equipment_type: str | None = None
    brand: str | None = None
    start_date: Optional[date] = None
    end_date: Optional[date] = None

    # ‚ùóÔ∏è –ò–ó–ú–ï–ù–ï–ù–ò–ï: Config –∑–∞–º–µ–Ω–µ–Ω –Ω–∞ model_config, orm_mode –Ω–∞ from_attributes
    model_config = ConfigDict(from_attributes=True)


class DayStatusItem(BaseModel):
    status: str
    group_id: Optional[str] = None
    is_user_reservation: bool = False


class EquipmentDayStatusesResponse(BaseModel):
    equipment_day_statuses: Dict[int, Dict[str, Union[str, DayStatusItem]]]


class CalendarEventResponse(BaseModel):
    id: str
    title: str
    start: str
    end: str
    resourceId: int
    status: str


class EquipmentStatusListResponse(BaseModel):
    items: List[EquipmentStatusResponse]
    total: int


class CalendarEventListResponse(BaseModel):
    items: List[CalendarEventResponse]
    total: int

```



## `shared\schemas\common_financials.py`


```python

# shared/schemas/common_financials.py

from pydantic import BaseModel
from typing import Optional


class FinancialsBase(BaseModel):
    """
    –ë–∞–∑–æ–≤–∞—è —Å—Ö–µ–º–∞ –¥–ª—è —Ñ–∏–Ω–∞–Ω—Å–æ–≤—ã—Ö –¥–∞–Ω–Ω—ã—Ö, –æ–±—â–∏—Ö –¥–ª—è –∞—Ä–µ–Ω–¥ –∏ —Ä–µ–∑–µ—Ä–≤–æ–≤.
    –°–æ–¥–µ—Ä–∂–∏—Ç —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–µ –ø–æ–ª—è –¥–ª—è —Å—Ç–æ–∏–º–æ—Å—Ç–∏, —Å–∫–∏–¥–æ–∫ –∏ –ø—Ä–æ–º–æ–∫–æ–¥–æ–≤.
    """
    total_cost: float
    discount_amount: float = 0.0
    promo_code: Optional[str] = None
    final_cost: Optional[float] = None
    accessories_cost: float = 0.0
    remaining_amount: float = 0.0

```



## `shared\schemas\dashboard_schema.py`


```python

# shared/schemas/dashboard_schema.py
from pydantic import BaseModel, ConfigDict, field_validator
from datetime import datetime, date
from typing import List, Optional

# –≠–ª–µ–º–µ–Ω—Ç –¥–ª—è –≤–∏–¥–∂–µ—Ç–∞ "–°–µ–≥–æ–¥–Ω—è –≤ —Ñ–æ–∫—É—Å–µ"
class TodayFocusItem(BaseModel):
    id: int  # –ò–∑–º–µ–Ω–µ–Ω–æ —Å order_id –¥–ª—è –∫–æ–Ω—Å–∏—Å—Ç–µ–Ω—Ç–Ω–æ—Å—Ç–∏ —Å —Ñ—Ä–æ–Ω—Ç–µ–Ω–¥–æ–º
    user_name: str
    details: str  # –ù–∞–ø—Ä–∏–º–µ—Ä, "3 –ø–æ–∑–∏—Ü–∏–∏" –∏–ª–∏ "–û—Å—Ç–∞—Ç–æ–∫: 1500 ‚ÇΩ"
    user_id: int
    order_type: str # 'reservation' –∏–ª–∏ 'rental'
    scheduled_time: datetime  # –í—Ä–µ–º—è –≤—ã–¥–∞—á–∏ –∏–ª–∏ –≤–æ–∑–≤—Ä–∞—Ç–∞
    start_date: Optional[date] = None  # –î–∞—Ç–∞ –Ω–∞—á–∞–ª–∞ —Ä–µ–∑–µ—Ä–≤–∞
    # –ü–æ–ª—è –¥–ª—è –ø—Ä–æ—Å—Ä–æ—á–µ–Ω–Ω—ã—Ö –∞—Ä–µ–Ω–¥
    due_date: Optional[date] = None  # –î–∞—Ç–∞ –æ–∫–æ–Ω—á–∞–Ω–∏—è –∞—Ä–µ–Ω–¥—ã
    days_overdue: Optional[int] = None  # –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –¥–Ω–µ–π –ø—Ä–æ—Å—Ä–æ—á–∫–∏

# –≠–ª–µ–º–µ–Ω—Ç –¥–ª—è –≤–∏–¥–∂–µ—Ç–∞ "–ü–æ—Å–ª–µ–¥–Ω–∏–µ —Å–æ–±—ã—Ç–∏—è"
class ActivityFeedItem(BaseModel):
    id: int  # –î–æ–±–∞–≤–ª–µ–Ω–æ –¥–ª—è –∫–æ–Ω—Å–∏—Å—Ç–µ–Ω—Ç–Ω–æ—Å—Ç–∏ —Å —Ñ—Ä–æ–Ω—Ç–µ–Ω–¥–æ–º
    timestamp: datetime
    activity_type: str  # "new_reservation", "new_user", "rental_return"
    description: str
    user_name: Optional[str] = None  # –ò–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –¥–ª—è –æ–±–æ–≥–∞—â–µ–Ω–∏—è –ª–µ–Ω—Ç—ã —Å–æ–±—ã—Ç–∏–π
    equipment_name: Optional[str] = None  # –ù–∞–∑–≤–∞–Ω–∏–µ –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—è –¥–ª—è –æ–±–æ–≥–∞—â–µ–Ω–∏—è –ª–µ–Ω—Ç—ã —Å–æ–±—ã—Ç–∏–π

# –≠–ª–µ–º–µ–Ω—Ç –¥–ª—è –≥—Ä–∞—Ñ–∏–∫–∞ "–ü–æ–ø—É–ª—è—Ä–Ω–æ–µ –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏–µ"
class PopularEquipmentItem(BaseModel):
    equipment_id: int  # ID –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—è –¥–ª—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –≤ –∫–∞—á–µ—Å—Ç–≤–µ key –Ω–∞ —Ñ—Ä–æ–Ω—Ç–µ–Ω–¥–µ
    equipment_name: str
    rental_count: int  # –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –∞—Ä–µ–Ω–¥
    revenue: float  # –í—ã—Ä—É—á–∫–∞ –æ—Ç –∞—Ä–µ–Ω–¥—ã –¥–∞–Ω–Ω–æ–≥–æ –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—è

# –í–ª–æ–∂–µ–Ω–Ω–∞—è –º–æ–¥–µ–ª—å –¥–ª—è –≤—Å–µ—Ö KPI –ø–æ–∫–∞–∑–∞—Ç–µ–ª–µ–π
class KpiData(BaseModel):
    total_users: int  # –û–±—â–µ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
    active_users: int  # –ê–∫—Ç–∏–≤–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏
    total_equipment: int  # –û–±—â–µ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—è
    total_reservations: int  # –û–±—â–µ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ä–µ–∑–µ—Ä–≤–∞—Ü–∏–π
    revenue_today: float  # –î–æ—Ö–æ–¥ –∑–∞ —Å–µ–≥–æ–¥–Ω—è
    revenue_this_month: float  # –î–æ—Ö–æ–¥ –∑–∞ —Ç–µ–∫—É—â–∏–π –º–µ—Å—è—Ü
    occupancy_rate: float  # –ö–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç –∑–∞–≥—Ä—É–∂–µ–Ω–Ω–æ—Å—Ç–∏
    avg_rental_duration: float  # –°—Ä–µ–¥–Ω—è—è –ø—Ä–æ–¥–æ–ª–∂–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å –∞—Ä–µ–Ω–¥—ã

# –û—Å–Ω–æ–≤–Ω–∞—è —Å—Ö–µ–º–∞ –æ—Ç–≤–µ—Ç–∞
class DashboardSummaryResponse(BaseModel):
    # –í–∏–¥–∂–µ—Ç "–°–µ–≥–æ–¥–Ω—è –≤ —Ñ–æ–∫—É—Å–µ"
    pickups_today: List[TodayFocusItem]
    returns_today: List[TodayFocusItem]
    overdue_rentals: List[TodayFocusItem]

    # –í–∏–¥–∂–µ—Ç "–ö–ª—é—á–µ–≤—ã–µ –ø–æ–∫–∞–∑–∞—Ç–µ–ª–∏" - —Ç–µ–ø–µ—Ä—å –≤–ª–æ–∂–µ–Ω–Ω–∞—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∞
    kpi: KpiData

    # –í–∏–¥–∂–µ—Ç "–ü–æ—Å–ª–µ–¥–Ω–∏–µ —Å–æ–±—ã—Ç–∏—è"
    recent_activity: List[ActivityFeedItem]

    # –í–∏–¥–∂–µ—Ç "–ü–æ–ø—É–ª—è—Ä–Ω–æ–µ –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏–µ"
    popular_equipment: List[PopularEquipmentItem]

    model_config = ConfigDict(from_attributes=True)

```



## `shared\schemas\discount_schema.py`


```python

# shared/schemas/discount_schema.py

from pydantic import BaseModel, ConfigDict, Field
from typing import List

class DiscountBase(BaseModel):
    min_days: int = Field(..., gt=0, description="–ú–∏–Ω–∏–º–∞–ª—å–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –¥–Ω–µ–π –¥–ª—è –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è —Å–∫–∏–¥–∫–∏")
    discount_percentage: int = Field(..., gt=0, le=100, description="–ü—Ä–æ—Ü–µ–Ω—Ç —Å–∫–∏–¥–∫–∏")

class DiscountCreate(DiscountBase):
    pass

class DiscountUpdate(DiscountBase):
    pass

class DiscountOut(DiscountBase):
    id: int

    model_config = ConfigDict(from_attributes=True)


class DiscountListResponse(BaseModel):
    items: List[DiscountOut]
    total: int

```



## `shared\schemas\equipment_schema.py`


```python

# shared/schemas/equipment_schema.py

from __future__ import annotations
from pydantic import BaseModel, ConfigDict, field_validator
from typing import Optional, List
from datetime import date, datetime # ‚úÖ –ò–ó–ú–ï–ù–ï–ù–ò–ï: –∏–º–ø–æ—Ä—Ç–∏—Ä—É–µ–º date –≤–º–µ—Å—Ç–æ datetime
# ‚úÖ –î–û–ë–ê–í–õ–ï–ù –ò–ú–ü–û–†–¢
from .accessory_schema import AccessoryOut
from .association_schema import AssociationSimple


class EquipmentCreate(BaseModel):
    equipment_type: str
    brand: str
    name: str
    serial_number: Optional[str] = None
    condition: Optional[str] = "–í–µ–ª–∏–∫–æ–ª–µ–ø–Ω–æ"
    daily_rate: Optional[float] = 0.0
    notes: Optional[str] = None
    description: Optional[str] = None
    # ‚úÖ –ò–ó–ú–ï–ù–ï–ù–ò–ï: –¢–∏–ø –ø–æ–ª—è –∏–∑–º–µ–Ω–µ–Ω —Å datetime –Ω–∞ date
    last_maintenance: Optional[date] = None
    image_url: Optional[str] = None
    image_urls: Optional[List[str]] = None
    short_description: Optional[str] = None


class EquipmentOut(BaseModel):
    id: int
    equipment_type: str
    brand: str
    name: str
    serial_number: Optional[str] = None
    condition: str
    daily_rate: float
    notes: Optional[str] = None
    description: Optional[str] = None
    # ‚úÖ –ò–ó–ú–ï–ù–ï–ù–ò–ï: –¢–∏–ø –ø–æ–ª—è –∏–∑–º–µ–Ω–µ–Ω —Å datetime –Ω–∞ date
    last_maintenance: Optional[date] = None
    image_url: Optional[str] = None
    image_urls: Optional[List[str]] = None
    short_description: Optional[str] = None
    # ‚úÖ –î–û–ë–ê–í–õ–ï–ù–û –ü–û–õ–ï –î–õ–Ø –û–¢–û–ë–†–ê–ñ–ï–ù–ò–Ø –ü–†–ò–í–Ø–ó–ê–ù–ù–´–• –ê–ö–°–ï–°–°–£–ê–†–û–í
    accessories: List[AccessoryOut] = []
    # ‚úÖ –î–û–ë–ê–í–õ–ï–ù–û –ü–û–õ–ï –î–õ–Ø –û–¢–û–ë–†–ê–ñ–ï–ù–ò–Ø –ü–†–ò–í–Ø–ó–ê–ù–ù–´–• –ê–°–°–û–¶–ò–ê–¶–ò–ô
    associations: List[AssociationSimple] = []

    @field_validator('last_maintenance', mode='before')
    @classmethod
    def validate_last_maintenance(cls, v):
        """–í–∞–ª–∏–¥–∞—Ç–æ—Ä –¥–ª—è –ø–æ–ª—è last_maintenance - –æ–±–µ—Å–ø–µ—á–∏–≤–∞–µ—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç –¥–∞—Ç—ã."""
        if v is None:
            return None
        if isinstance(v, str):
            try:
                # –ü—ã—Ç–∞–µ–º—Å—è –ø—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞—Ç—å —Å—Ç—Ä–æ–∫—É –≤ –¥–∞—Ç—É
                return datetime.fromisoformat(v.replace('Z', '+00:00')).date()
            except (ValueError, AttributeError):
                # –ï—Å–ª–∏ –Ω–µ —É–¥–∞–µ—Ç—Å—è –ø—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞—Ç—å, –≤–æ–∑–≤—Ä–∞—â–∞–µ–º None
                return None
        if isinstance(v, datetime):
            return v.date()
        return v

    model_config = ConfigDict(from_attributes=True)


class EquipmentUpdateExtended(BaseModel):
    equipment_type: Optional[str] = None
    brand: Optional[str] = None
    name: Optional[str] = None
    serial_number: Optional[str] = None
    condition: Optional[str] = None
    daily_rate: Optional[float] = None
    notes: Optional[str] = None
    description: Optional[str] = None
    # ‚úÖ –≠—Ç–æ –ø–æ–ª–µ —É–∂–µ –±—ã–ª–æ –ø—Ä–∞–≤–∏–ª—å–Ω—ã–º (date), –æ—Å—Ç–∞–≤–ª—è–µ–º –∫–∞–∫ –µ—Å—Ç—å
    last_maintenance: Optional[date] = None
    image_url: Optional[str] = None
    image_urls: Optional[List[str]] = None
    short_description: Optional[str] = None
    # ‚úÖ –î–û–ë–ê–í–õ–ï–ù–û –ü–û–õ–ï –î–õ–Ø –ü–ï–†–ï–î–ê–ß–ò ID –ê–ö–°–ï–°–°–£–ê–†–û–í –ü–†–ò –û–ë–ù–û–í–õ–ï–ù–ò–ò
    accessory_ids: Optional[List[int]] = None
    # ‚úÖ –î–û–ë–ê–í–õ–ï–ù–û –ü–û–õ–ï –î–õ–Ø –ü–ï–†–ï–î–ê–ß–ò ID –ê–°–°–û–¶–ò–ê–¶–ò–ô –ü–†–ò –û–ë–ù–û–í–õ–ï–ù–ò–ò
    association_ids: Optional[List[int]] = None

    model_config = ConfigDict(from_attributes=True)


class EquipmentTreeItem(BaseModel):
    label: str
    value: Optional[int] = None
    children: List[EquipmentTreeItem] = []
    model_config = ConfigDict(from_attributes=True)


class EquipmentAvailabilityStatus(BaseModel):
    has_active_reservations: bool
    has_active_rentals: bool
    active_reservations_count: int
    active_rentals_count: int
    model_config = ConfigDict(from_attributes=True)


class EquipmentListResponse(BaseModel):
    items: List[EquipmentOut]
    total: int


class EquipmentTreeListResponse(BaseModel):
    items: List[EquipmentTreeItem]
    total: int

```



## `shared\schemas\holiday_schema.py`


```python

# shared/schemas/holiday_schema.py

from pydantic import BaseModel, ConfigDict, Field
from datetime import date, datetime
from typing import Literal, List

class HolidayBase(BaseModel):
    """–ë–∞–∑–æ–≤–∞—è —Å—Ö–µ–º–∞ –¥–ª—è –≤—ã—Ö–æ–¥–Ω–æ–≥–æ –¥–Ω—è."""
    date: date
    description: str | None = None

class HolidayCreate(HolidayBase):
    """–°—Ö–µ–º–∞ –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –Ω–æ–≤–æ–≥–æ –≤—ã—Ö–æ–¥–Ω–æ–≥–æ –¥–Ω—è."""
    force: bool = False

class HolidayOut(HolidayBase):
    """–°—Ö–µ–º–∞ –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö –æ –≤—ã—Ö–æ–¥–Ω–æ–º –¥–Ω–µ –∏–∑ –ë–î."""
    created_at: datetime
    created_by_id: int

    model_config = ConfigDict(from_attributes=True)

# +++ –ù–ê–ß–ê–õ–û: –ù–û–í–´–ï –°–•–ï–ú–´ +++
class RecurringHolidayRuleCreate(BaseModel):
    """–°—Ö–µ–º–∞ –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –ø—Ä–∞–≤–∏–ª–∞ –µ–∂–µ–Ω–µ–¥–µ–ª—å–Ω—ã—Ö –≤—ã—Ö–æ–¥–Ω—ã—Ö."""
    day_of_week: int = Field(..., ge=0, le=6, description="–î–µ–Ω—å –Ω–µ–¥–µ–ª–∏ (0=–ü–æ–Ω–µ–¥–µ–ª—å–Ω–∏–∫, 6=–í–æ—Å–∫—Ä–µ—Å–µ–Ω—å–µ)")
    start_date: date
    end_date: date
    description: str

class HolidayRuleOut(BaseModel):
    """–°—Ö–µ–º–∞ –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –ø—Ä–∞–≤–∏–ª –≤ –∞–¥–º–∏–Ω–∫–µ."""
    id: int
    rule_type: str
    description: str
    created_at: datetime

    model_config = ConfigDict(from_attributes=True)


class HolidayListResponse(BaseModel):
    items: List[HolidayOut]
    total: int


class HolidayRuleListResponse(BaseModel):
    items: List[HolidayRuleOut]
    total: int
# +++ –ö–û–ù–ï–¶: –ù–û–í–´–ï –°–•–ï–ú–´ +++

```



## `shared\schemas\promo_code_schema.py`


```python

# shared/schemas/promo_code_schema.py
from pydantic import BaseModel, ConfigDict, Field, EmailStr
from typing import Optional, List
from datetime import datetime

# --- –°—Ö–µ–º—ã –¥–ª—è –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω–∏—è ---

class PromoCodeBase(BaseModel):
    code: str = Field(..., description="–£–Ω–∏–∫–∞–ª—å–Ω—ã–π –∫–æ–¥, –Ω–∞–ø—Ä–∏–º–µ—Ä, 'SUMMER20'", max_length=50)
    description: Optional[str] = Field(None, description="–û–ø–∏—Å–∞–Ω–∏–µ –¥–ª—è –≤–Ω—É—Ç—Ä–µ–Ω–Ω–µ–≥–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è")
    discount_percentage: float = Field(..., gt=0, le=50, description="–ü—Ä–æ—Ü–µ–Ω—Ç —Å–∫–∏–¥–∫–∏ (1-50)")
    is_active: bool = True
    valid_from: Optional[datetime] = None
    expires_at: Optional[datetime] = None
    max_uses: Optional[int] = Field(None, gt=0, description="–û–±—â–∏–π –ª–∏–º–∏—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–π")
    max_uses_per_user: Optional[int] = Field(None, gt=0, description="–õ–∏–º–∏—Ç –Ω–∞ –æ–¥–Ω–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è")
    min_order_amount: Optional[float] = Field(None, gt=0, description="–ú–∏–Ω–∏–º–∞–ª—å–Ω–∞—è —Å—É–º–º–∞ –∑–∞–∫–∞–∑–∞")
    specific_to_user_id: Optional[int] = None
    applicable_to_equipment_ids: Optional[List[int]] = None
    applicable_to_equipment_types: Optional[List[str]] = None

class PromoCodeCreate(PromoCodeBase):
    pass

class PromoCodeUpdate(BaseModel):
    code: Optional[str] = Field(None, max_length=50)
    description: Optional[str] = None
    discount_percentage: Optional[float] = Field(None, gt=0, le=50)
    is_active: Optional[bool] = None
    valid_from: Optional[datetime] = None
    expires_at: Optional[datetime] = None
    max_uses: Optional[int] = Field(None, gt=0)
    max_uses_per_user: Optional[int] = Field(None, gt=0)
    min_order_amount: Optional[float] = Field(None, gt=0)
    specific_to_user_id: Optional[int] = None
    applicable_to_equipment_ids: Optional[List[int]] = None
    applicable_to_equipment_types: Optional[List[str]] = None

class PromoCodeOut(PromoCodeBase):
    id: int
    times_used: int
    created_at: datetime
    created_by_id: int
    creator_email: Optional[EmailStr] = None # –î–ª—è —É–¥–æ–±—Å—Ç–≤–∞ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –≤ –∞–¥–º–∏–Ω–∫–µ

    model_config = ConfigDict(from_attributes=True)

    @classmethod
    def from_orm(cls, obj):
        # –î–æ–±–∞–≤–ª—è–µ–º email —Å–æ–∑–¥–∞—Ç–µ–ª—è –¥–ª—è –≤—ã–≤–æ–¥–∞
        instance = super().from_orm(obj)
        if obj.creator:
            instance.creator_email = obj.creator.email
        return instance

# --- –°—Ö–µ–º—ã –¥–ª—è –ø—É–±–ª–∏—á–Ω–æ–π –≤–∞–ª–∏–¥–∞—Ü–∏–∏ ---

class PromoCodeValidateRequest(BaseModel):
    code: str
    # –≠—Ç–∏ –ø–æ–ª—è –Ω—É–∂–Ω—ã –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ —É—Å–ª–æ–≤–∏–π –ø—Ä–æ–º–æ–∫–æ–¥–∞
    order_amount: float
    equipment_ids: List[int]

class PromoCodeValidateResponse(BaseModel):
    code: str
    discount_percentage: float
    message: str


class PromoCodeListResponse(BaseModel):
    items: List[PromoCodeOut]
    total: int

```



## `shared\schemas\rental_schema.py`


```python

# shared/schemas/rental_schema.py

from pydantic import BaseModel, ConfigDict, Field, field_validator
from datetime import date, datetime
from typing import List, Optional

from .user_schema import UserOut
from .equipment_schema import EquipmentOut
from .accessory_schema import AccessoryOut
from .common_financials import FinancialsBase

class RentalBase(BaseModel):
    start_date: date
    end_date: date
    deposit_amount: float = 0.0
    notes_on_issue: Optional[str] = None
    status: str

class RentalAccessoryDetail(BaseModel):
    equipment_id: int
    accessory: AccessoryOut
    model_config = ConfigDict(from_attributes=True)

class RentalOut(RentalBase, FinancialsBase):
    id: int
    user_id: int
    created_by_id: int
    reservation_id: Optional[int] = None
    actual_return_date: Optional[date] = None
    prepayment_amount: float = 0.0
    notes_on_return: Optional[str] = None
    created_at: datetime
    updated_at: datetime
    user: UserOut
    created_by: UserOut
    equipment: List[EquipmentOut]

    # –ò—Å–ø–æ–ª—å–∑—É–µ–º –∏–º—è –ø–æ–ª—è 'accessory_links' –∫–∞–∫ –≤ –º–æ–¥–µ–ª–∏ SQLAlchemy
    # —á—Ç–æ–±—ã –∏–∑–±–µ–∂–∞—Ç—å –Ω–µ—Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–π –ø—Ä–∏ –ø–µ—Ä–µ–¥–∞—á–µ –¥–∞–Ω–Ω—ã—Ö.
    accessory_links: List[RentalAccessoryDetail] = []

    # –î–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ –≤—ã—á–∏—Å–ª—è–µ–º—ã–µ –ø–æ–ª—è
    days_remaining: Optional[int] = None
    overdue_days: Optional[int] = None
    overdue_surcharge: Optional[float] = None

    # –£–±–∏—Ä–∞–µ–º populate_by_name, —Ç–∞–∫ –∫–∞–∫ alias –±–æ–ª—å—à–µ –Ω–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è
    model_config = ConfigDict(from_attributes=True)

    @field_validator('start_date', 'end_date', 'actual_return_date', mode='before')
    @classmethod
    def convert_datetime_to_date(cls, v):
        if isinstance(v, datetime):
            return v.date()
        return v

class RentalListResponse(BaseModel):
    items: List[RentalOut]
    total: int

# --- –°—Ö–µ–º—ã –¥–ª—è –∑–∞–ø—Ä–æ—Å–æ–≤ ---

class RentalCreateFromReservationRequest(BaseModel):
    """–°—Ö–µ–º–∞ –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –∞—Ä–µ–Ω–¥—ã –∏–∑ —Ä–µ–∑–µ—Ä–≤–∞."""
    notes_on_issue: Optional[str] = None
    deposit_amount: float = Field(0.0, ge=0)
    prepayment_amount: float = Field(0.0, ge=0)
    force_issue_on_holiday: bool = Field(False, description="–ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –≤—ã–¥–∞—á–∏ –≤ –≤—ã—Ö–æ–¥–Ω–æ–π –¥–µ–Ω—å")

class RentalCreateFromScratchRequest(BaseModel):
    """–°—Ö–µ–º–∞ –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –∞—Ä–µ–Ω–¥—ã "—Å –Ω—É–ª—è"."""
    user_id: int
    equipment_ids: List[int] = Field(..., min_length=1)
    start_date: date
    end_date: date
    notes_on_issue: Optional[str] = None
    deposit_amount: float = Field(0.0, ge=0)

class AdminRentalUpdate(BaseModel):
    """–°—Ö–µ–º–∞ –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –∞—Ä–µ–Ω–¥—ã –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–º."""
    end_date: Optional[date] = None
    actual_return_date: Optional[date] = None
    status: Optional[str] = None
    final_cost: Optional[float] = Field(None, ge=0)
    deposit_amount: Optional[float] = Field(None, ge=0)
    notes_on_issue: Optional[str] = None
    notes_on_return: Optional[str] = None

class RentalReturnRequest(BaseModel):
    """–°—Ö–µ–º–∞ –¥–ª—è –æ—Ñ–æ—Ä–º–ª–µ–Ω–∏—è –≤–æ–∑–≤—Ä–∞—Ç–∞."""
    actual_return_date: date
    notes_on_return: Optional[str] = None
    accessories_returned_confirmation: bool = Field(..., description="–ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ, —á—Ç–æ –≤—Å–µ –∞–∫—Å–µ—Å—Å—É–∞—Ä—ã –≤–æ–∑–≤—Ä–∞—â–µ–Ω—ã")
    # –£–¥–∞–ª—è–µ–º –ø–æ–ª—è payment_amount –∏ payment_description, —Ç–∞–∫ –∫–∞–∫ –ø–ª–∞—Ç–µ–∂ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç—Å—è –æ—Ç–¥–µ–ª—å–Ω–æ

    @classmethod
    def today(cls):
        return cls(actual_return_date=date.today())

```



## `shared\schemas\reservation_schema.py`


```python

# shared/schemas/reservation_schema.py

from pydantic import BaseModel, ConfigDict, Field
from datetime import date
from typing import List, Optional, Dict, Literal

from .user_schema import UserOut
from .accessory_schema import AccessoryOut
from .common_financials import FinancialsBase


class ReservationAccessoryDetail(BaseModel):
    equipment_id: int
    accessory: AccessoryOut
    model_config = ConfigDict(from_attributes=True)


class ReservationCreateRequest(BaseModel):
    equipment_ids: List[int]
    start_date: date
    end_date: date
    selected_accessories: Optional[Dict[int, List[int]]] = None
    promo_code: Optional[str] = None

class ReservationUpdateRequest(BaseModel):
    equipment_ids: List[int]
    start_date: date
    end_date: date
    selected_accessories: Optional[Dict[int, List[int]]] = None
    promo_code: Optional[str] = None
    confirm_date_adjustment: bool = False

class ReservationResponse(BaseModel):
    reservation_id: int
    message: str
    model_config = ConfigDict(from_attributes=True)

class ReservationItem(FinancialsBase):
    id: int
    user_id: int
    equipment_ids: List[int]
    start_date: date
    end_date: date
    status: Literal['active', 'fulfilled', 'cancelled', 'overdue']
    accessory_links: List[ReservationAccessoryDetail] = []
    rental_id: Optional[int] = Field(None, validation_alias='rental.id')

    model_config = ConfigDict(from_attributes=True)


class AdminReservationOut(ReservationItem):
    user_info: UserOut
    model_config = ConfigDict(from_attributes=True)

class AdminReservationCreateRequest(ReservationCreateRequest):
    user_id: int

class AdminReservationListResponse(BaseModel):
    items: List[AdminReservationOut]
    total: int

class ReservationListResponse(BaseModel):
    items: List[ReservationItem]
    total: int

class PriceCalculationRequest(BaseModel):
    equipment_ids: List[int]
    start_date: date
    end_date: date
    selected_accessories: Optional[Dict[int, List[int]]] = None
    promo_code: Optional[str] = None

class PriceCalculationResponse(BaseModel):
    day_count: int
    full_total: float
    final_total: float
    discount_amount: float
    duration_discount_percentage: int
    promo_discount_percentage: float
    promo_code_message: Optional[str] = None

class ReservationBulkDeleteRequest(BaseModel):
    """–°—Ö–µ–º–∞ –¥–ª—è –∑–∞–ø—Ä–æ—Å–∞ –Ω–∞ –º–∞—Å—Å–æ–≤–æ–µ —É–¥–∞–ª–µ–Ω–∏–µ —Ä–µ–∑–µ—Ä–≤–æ–≤."""
    reservation_ids: List[int]

```



## `shared\schemas\user_schema.py`


```python

# shared/schemas/user_schema.py

from pydantic import BaseModel, EmailStr, ConfigDict, validator, field_validator, Field
from typing import Optional, List, Annotated
import re
from datetime import datetime

# –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –≤–∞–ª–∏–¥–∞—Ü–∏–∏, –æ—Å—Ç–∞–µ—Ç—Å—è –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π
def validate_phone_number(v: Optional[str]) -> Optional[str]:
    """–í–∞–ª–∏–¥–∞—Ü–∏—è –Ω–æ–º–µ—Ä–∞ —Ç–µ–ª–µ—Ñ–æ–Ω–∞"""
    if v is None:
        return v
    if not isinstance(v, str):
        raise ValueError('–¢–µ–ª–µ—Ñ–æ–Ω –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å —Å—Ç—Ä–æ–∫–æ–π')

    phone_clean = re.sub(r'[^\d]', '', v)
    if len(phone_clean) < 10 or len(phone_clean) > 15:
        raise ValueError('–ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç —Ç–µ–ª–µ—Ñ–æ–Ω–∞')

    return v

# --- –°—É—â–µ—Å—Ç–≤—É—é—â–∏–µ —Å—Ö–µ–º—ã ---

class UserCreate(BaseModel):
    full_name: str
    email: EmailStr
    password: str
    phone: Optional[str] = None
    privacy_policy_accepted: bool = False
    terms_accepted: bool = False

    @field_validator('phone')
    @classmethod
    def validate_phone(cls, v):
        return validate_phone_number(v)

    @validator('privacy_policy_accepted')
    def validate_privacy_policy(cls, v):
        if not v:
            raise ValueError('–ù–µ–æ–±—Ö–æ–¥–∏–º–æ —Å–æ–≥–ª–∞—Å–∏–µ —Å –ø–æ–ª–∏—Ç–∏–∫–æ–π –æ–±—Ä–∞–±–æ—Ç–∫–∏ –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö')
        return v

    @validator('terms_accepted')
    def validate_terms(cls, v):
        if not v:
            raise ValueError('–ù–µ–æ–±—Ö–æ–¥–∏–º–æ —Å–æ–≥–ª–∞—Å–∏–µ —Å —É—Å–ª–æ–≤–∏—è–º–∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è')
        return v

class AdminUserCreate(UserCreate):
    role: str = "user"

class AdminUserUpdate(BaseModel):
    full_name: Optional[str] = None
    phone: Optional[str] = None
    status: Optional[str] = None
    balance: Optional[float] = None
    notes: Optional[str] = None
    role: Optional[str] = None
    privacy_policy_accepted: Optional[bool] = None
    terms_accepted: Optional[bool] = None
    email_verified: Optional[bool] = None

    @field_validator('phone')
    @classmethod
    def validate_phone(cls, v):
        return validate_phone_number(v)

class UserUpdate(BaseModel):
    full_name: Optional[str] = None
    email: Optional[EmailStr] = None
    phone: Optional[str] = None

    @field_validator('phone')
    @classmethod
    def validate_phone(cls, v):
        return validate_phone_number(v)


class UserOut(BaseModel):
    id: int
    full_name: str
    email: EmailStr
    role: str
    is_active: bool
    phone: Optional[str] = None
    status: Optional[str] = None
    balance: float
    notes: Optional[str] = None
    privacy_policy_accepted: bool
    terms_accepted: bool
    email_verified: bool
    created_at: datetime

    model_config = ConfigDict(from_attributes=True)


class Token(BaseModel):
    access_token: str
    token_type: str


class UserListResponse(BaseModel):
    items: List[UserOut]
    total: int

# +++ –ù–ê–ß–ê–õ–û: –ù–û–í–ê–Ø –°–•–ï–ú–ê –î–õ–Ø –ü–†–ò–ï–ú–ê –ü–õ–ê–¢–ï–ñ–ê +++
class UserPaymentRequest(BaseModel):
    amount: float = Field(..., gt=0, description="–°—É–º–º–∞ –ø–ª–∞—Ç–µ–∂–∞")
    payment_method: str = Field(..., description="–ú–µ—Ç–æ–¥ –æ–ø–ª–∞—Ç—ã (–Ω–∞–ª–∏—á–Ω—ã–µ, –∫–∞—Ä—Ç–∞ –∏ —Ç.–¥.)")
    description: Optional[str] = None
# +++ –ö–û–ù–ï–¶: –ù–û–í–ê–Ø –°–•–ï–ú–ê –î–õ–Ø –ü–†–ò–ï–ú–ê –ü–õ–ê–¢–ï–ñ–ê +++

```


```


## <a name="RentalAppFASTAPIsplitpy"></a>`RentalApp_FASTAPI/split.py`

```python
// path: RentalApp_FASTAPI/split.py

import os
from pathlib import Path
import fnmatch

# –ü–∞–ø–∫–∞ –ø—Ä–æ–µ–∫—Ç–∞
project_root = Path(__file__).resolve().parent
output_filename = project_root / "smart_python_code_RentalApp.md"

# –ß—Ç–æ –≤–∫–ª—é—á–∞–µ–º
INCLUDE_DIRS = {"logic", "services", "db", "config", "ui", "config", "notifications", 'migrations', 'exports', 'api','schemas'}
INCLUDE_FILES = {"contract_template.html", 'requirements.txt'}
INCLUDE_EXTENSIONS = {".py", ".html"}

# –ß—Ç–æ –ø–æ–ª–Ω–æ—Å—Ç—å—é –∏—Å–∫–ª—é—á–∞–µ–º (–∏ –Ω–µ –æ—Ç–æ–±—Ä–∞–∂–∞–µ–º –≤ —Å—Ç—Ä—É–∫—Ç—É—Ä–µ)
EXCLUDE_DIRS = {'.git', '.venv', '__pycache__', 'tests', '.vscode', '.idea', '.gigaide', 'api'}
EXCLUDE_FILES = {'*.pyc', '*.pyo', '*.db', '__init__.py'}

# –ü–æ—Ä–æ–≥ —É—Å–µ—á–µ–Ω–∏—è
MAX_LINES = 450
TRUNCATE_LINES = 50

def is_excluded(file_path: Path) -> bool:
    return any(fnmatch.fnmatch(file_path.name, pattern) for pattern in EXCLUDE_FILES)

def is_included(file_path: Path) -> bool:
    parts = file_path.relative_to(project_root).parts
    return (
            file_path.name in INCLUDE_FILES or
            (parts and parts[0] in INCLUDE_DIRS and file_path.suffix in INCLUDE_EXTENSIONS)
    )

def collect_files():
    included = []
    for root, dirs, files in os.walk(project_root):
        # —É–¥–∞–ª—è–µ–º —Å–∏—Å—Ç–µ–º–Ω—ã–µ –ø–∞–ø–∫–∏ –Ω–∞ –º–µ—Å—Ç–µ ‚Äî –Ω–µ –ø–æ–ø–∞–¥—É—Ç –¥–∞–∂–µ –≤ –æ–±—Ö–æ–¥
        dirs[:] = [d for d in dirs if d not in EXCLUDE_DIRS]
        for file in files:
            path = Path(root) / file
            rel_path = path.relative_to(project_root)
            if any(part in EXCLUDE_DIRS for part in rel_path.parts):
                continue
            if is_excluded(path):
                continue
            if is_included(path):
                included.append(path)
    return included

def summarize_structure(included, truncation_map):
    lines = ["# –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –ø—Ä–æ–µ–∫—Ç–∞\n"]
    for file in sorted(included, key=lambda x: str(x)):
        rel = file.relative_to(project_root)
        if truncation_map.get(str(rel)):
            lines.append(f"- ‚ö†Ô∏è `{rel}` (—É—Å–µ—á—ë–Ω)")
        else:
            lines.append(f"- ‚úÖ `{rel}`")
    return "\n".join(lines)

def write_output(included):
    truncation_map = {}
    with open(output_filename, "w", encoding="utf-8") as out:
        out.write("# –°–∂–∞—Ç—ã–π –∏—Å—Ö–æ–¥–Ω—ã–π –∫–æ–¥ –ø—Ä–æ–µ–∫—Ç–∞ –¥–ª—è AI-–ø–æ–º–æ—â–Ω–∏–∫–∞\n\n")

        code_blocks = []
        for path in sorted(included, key=lambda p: str(p.relative_to(project_root))):
            rel_path = path.relative_to(project_root)
            ext = path.suffix
            block = [f"\n\n## `{rel_path}`\n\n"]
            block.append("```python\n" if ext == ".py" else "```html\n")

            try:
                lines = path.read_text(encoding="utf-8").splitlines()
                if len(lines) > MAX_LINES:
                    truncation_map[str(rel_path)] = True
                    block.extend(lines[:TRUNCATE_LINES])
                    block.append(f"# ... truncated ({len(lines)} lines total)")
                    block.append("# ‚ö†Ô∏è –ü–æ–ª–Ω—ã–π –∫–æ–¥ –¥–æ—Å—Ç—É–ø–µ–Ω –≤ –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω–æ–º —Ñ–∞–π–ª–µ")
                else:
                    block.extend(lines)
            except Exception as e:
                block.append(f"# –û—à–∏–±–∫–∞ —á—Ç–µ–Ω–∏—è —Ñ–∞–π–ª–∞: {e}")
            block.append("\n```\n")
            code_blocks.append("\n".join(block))

        structure = summarize_structure(included, truncation_map)
        out.write(structure)
        out.write("\n\n---\n")
        out.write("\n".join(code_blocks))

def main():
    included_files = collect_files()
    write_output(included_files)
    print(f"‚úÖ –§–∞–π–ª '{output_filename.name}' —É—Å–ø–µ—à–Ω–æ —Å–æ–∑–¥–∞–Ω.")

if __name__ == "__main__":
    main()


```


## <a name="RentalAppFASTAPIsplitapipy"></a>`RentalApp_FASTAPI/split_api.py`

```python
// path: RentalApp_FASTAPI/split_api.py

import os
from pathlib import Path
import fnmatch

# –ü–∞–ø–∫–∞ –ø—Ä–æ–µ–∫—Ç–∞
project_root = Path(__file__).resolve().parent
output_filename = project_root / "smart_python_code_FastAPI.md"

# –ß—Ç–æ –≤–∫–ª—é—á–∞–µ–º
INCLUDE_DIRS = {"api", "shared", "db"}
INCLUDE_FILES = {"contract_template.html", 'requirements.txt'}
INCLUDE_EXTENSIONS = {".py", ".html", ".env"}

# –ß—Ç–æ –ø–æ–ª–Ω–æ—Å—Ç—å—é –∏—Å–∫–ª—é—á–∞–µ–º (–∏ –Ω–µ –æ—Ç–æ–±—Ä–∞–∂–∞–µ–º –≤ —Å—Ç—Ä—É–∫—Ç—É—Ä–µ)
EXCLUDE_DIRS = {'.git', '.venv', '__pycache__', 'tests', '.vscode', '.idea', '.gigaide'}
EXCLUDE_FILES = {'*.pyc', '*.pyo', '*.db', '__init__.py'}

# –ü–æ—Ä–æ–≥ —É—Å–µ—á–µ–Ω–∏—è
MAX_LINES = 350
TRUNCATE_LINES = 50

def is_excluded(file_path: Path) -> bool:
    return any(fnmatch.fnmatch(file_path.name, pattern) for pattern in EXCLUDE_FILES)

def is_included(file_path: Path) -> bool:
    parts = file_path.relative_to(project_root).parts
    return (
            file_path.name in INCLUDE_FILES or
            (parts and parts[0] in INCLUDE_DIRS and file_path.suffix in INCLUDE_EXTENSIONS)
    )

def collect_files():
    included = []
    for root, dirs, files in os.walk(project_root):
        # —É–¥–∞–ª—è–µ–º —Å–∏—Å—Ç–µ–º–Ω—ã–µ –ø–∞–ø–∫–∏ –Ω–∞ –º–µ—Å—Ç–µ ‚Äî –Ω–µ –ø–æ–ø–∞–¥—É—Ç –¥–∞–∂–µ –≤ –æ–±—Ö–æ–¥
        dirs[:] = [d for d in dirs if d not in EXCLUDE_DIRS]
        for file in files:
            path = Path(root) / file
            rel_path = path.relative_to(project_root)
            if any(part in EXCLUDE_DIRS for part in rel_path.parts):
                continue
            if is_excluded(path):
                continue
            if is_included(path):
                included.append(path)
    return included

def summarize_structure(included, truncation_map):
    lines = ["# –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –ø—Ä–æ–µ–∫—Ç–∞\n"]
    for file in sorted(included, key=lambda x: str(x)):
        rel = file.relative_to(project_root)
        if truncation_map.get(str(rel)):
            lines.append(f"- ‚ö†Ô∏è `{rel}` (—É—Å–µ—á—ë–Ω)")
        else:
            lines.append(f"- ‚úÖ `{rel}`")
    return "\n".join(lines)

def write_output(included):
    truncation_map = {}
    with open(output_filename, "w", encoding="utf-8") as out:
        out.write("# –°–∂–∞—Ç—ã–π –∏—Å—Ö–æ–¥–Ω—ã–π –∫–æ–¥ –ø—Ä–æ–µ–∫—Ç–∞ –¥–ª—è AI-–ø–æ–º–æ—â–Ω–∏–∫–∞\n\n")

        code_blocks = []
        for path in sorted(included, key=lambda p: str(p.relative_to(project_root))):
            rel_path = path.relative_to(project_root)
            ext = path.suffix
            block = [f"\n\n## `{rel_path}`\n\n"]
            block.append("```python\n" if ext == ".py" else "```html\n")

            try:
                lines = path.read_text(encoding="utf-8").splitlines()
                if len(lines) > MAX_LINES:
                    truncation_map[str(rel_path)] = True
                    block.extend(lines[:TRUNCATE_LINES])
                    block.append(f"# ... truncated ({len(lines)} lines total)")
                    block.append("# ‚ö†Ô∏è –ü–æ–ª–Ω—ã–π –∫–æ–¥ –¥–æ—Å—Ç—É–ø–µ–Ω –≤ –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω–æ–º —Ñ–∞–π–ª–µ")
                else:
                    block.extend(lines)
            except Exception as e:
                block.append(f"# –û—à–∏–±–∫–∞ —á—Ç–µ–Ω–∏—è —Ñ–∞–π–ª–∞: {e}")
            block.append("\n```\n")
            code_blocks.append("\n".join(block))

        structure = summarize_structure(included, truncation_map)
        out.write(structure)
        out.write("\n\n---\n")
        out.write("\n".join(code_blocks))

def main():
    included_files = collect_files()
    write_output(included_files)
    print(f"‚úÖ –§–∞–π–ª '{output_filename.name}' —É—Å–ø–µ—à–Ω–æ —Å–æ–∑–¥–∞–Ω.")

if __name__ == "__main__":
    main()


```


## <a name="RentalAppFASTAPIsplittxtpy"></a>`RentalApp_FASTAPI/split_txt.py`

```python
// path: RentalApp_FASTAPI/split_txt.py

import os

# –ü—É—Ç—å –∫ –∫–æ—Ä–Ω—é –ø—Ä–æ–µ–∫—Ç–∞
project_root = os.path.dirname(os.path.abspath(__file__))

# –ò–º—è –∏—Ç–æ–≥–æ–≤–æ–≥–æ —Ñ–∞–π–ª–∞
output_filename = os.path.join(project_root, "all_python_code.txt")

# –ü–æ–ª—É—á–∞–µ–º –∞–±—Å–æ–ª—é—Ç–Ω—ã–π –ø—É—Ç—å –∫ —ç—Ç–æ–º—É —Ñ–∞–π–ª—É, —á—Ç–æ–±—ã –∏—Å–∫–ª—é—á–∏—Ç—å –µ–≥–æ
this_script = os.path.abspath(__file__)

with open(output_filename, "w", encoding="utf-8") as output_file:
    for root, dirs, files in os.walk(project_root):
        # –ò—Å–∫–ª—é—á–∞–µ–º venv –∏ —Å–∫—Ä—ã—Ç—ã–µ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏
        dirs[:] = [d for d in dirs if not d.startswith('.') and d != 'venv' and d != '__pycache__']

        for file in files:
            file_path = os.path.join(root, file)

            # –ü—Ä–æ–ø—É—Å–∫–∞–µ–º —Å–∞–º —Å–∫—Ä–∏–ø—Ç, –ë–î-—Ñ–∞–π–ª—ã –∏ –Ω–µ .py —Ñ–∞–π–ª—ã
            if (
                    file_path == this_script or
                    not file.endswith(".py") or
                    file.endswith(".pyc") or
                    file.endswith(".pyo") or
                    file.endswith(".db")
            ):
                continue

            output_file.write(f"\n\n# === {os.path.relpath(file_path, project_root)} ===\n\n")
            with open(file_path, "r", encoding="utf-8") as f:
                output_file.write(f.read())

```


## <a name="dockercomposeyml"></a>`docker-compose.yml`

```yaml
// path: docker-compose.yml

# S_PROJECT_DOCKER/docker-compose.yml

services:
  db:
    image: postgres:15-alpine
    volumes:
      - postgres_data:/var/lib/postgresql/data/
    environment:
      - POSTGRES_USER=${POSTGRES_USER}
      - POSTGRES_PASSWORD=${POSTGRES_PASSWORD}
      - POSTGRES_DB=${POSTGRES_DB}
    ports:
      - "5433:5432"
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${POSTGRES_USER} -d ${POSTGRES_DB}"]
      interval: 10s
      timeout: 5s
      retries: 5

# docker-compose.yml (–∑–∞–º–µ–Ω–∏—Ç–µ —Ç–æ–ª—å–∫–æ —ç—Ç–æ—Ç —Å–µ—Ä–≤–∏—Å)

  backend:
    build:
      context: ./RentalApp_FASTAPI
      dockerfile: Dockerfile.backend
    volumes:
      - ./RentalApp_FASTAPI/api:/app/api
      - ./RentalApp_FASTAPI/shared:/app/shared
      - ./RentalApp_FASTAPI/config:/app/config
      - ./RentalApp_FASTAPI/migrations:/app/migrations
      - ./RentalApp_FASTAPI/alembic.ini:/app/alembic.ini
    ports:
      - "8000:8000"
    # –ò–ó–ú–ï–ù–ï–ù–ò–ï –ó–î–ï–°–¨: –î–æ–±–∞–≤–ª—è–µ–º –≤—Å–µ –æ—Å—Ç–∞–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ
    environment:
      - DATABASE_URL=postgresql+asyncpg://${POSTGRES_USER}:${POSTGRES_PASSWORD}@db:5432/${POSTGRES_DB}
      - CSRF_SECRET_KEY=${CSRF_SECRET_KEY}
      - TELEGRAM_TOKEN=${TELEGRAM_TOKEN}
      - DEFAULT_TELEGRAM_CHAT_ID=${DEFAULT_TELEGRAM_CHAT_ID}
      - DEBUG=${DEBUG}
      - YANDEX_EMAIL_SENDER=${YANDEX_EMAIL_SENDER}
      - YANDEX_SMTP_PASSWORD=${YANDEX_SMTP_PASSWORD}
      - DB_TYPE=${DB_TYPE}
      - SECRET_KEY=${SECRET_KEY}
      - TZ=Europe/Astrakhan
    depends_on:
      db:
        condition: service_healthy
        
  frontend:
    build:
      context: ./rental-app-main
      dockerfile: Dockerfile.frontend
    ports:
      - "5173:80"
    volumes:
      - ./rental-app-main/nginx/nginx.conf:/etc/nginx/conf.d/default.conf
    depends_on:
      - backend

volumes:
  postgres_data:

```


## <a name="rentalappmainDockerfilefrontend"></a>`rental-app-main/Dockerfile.frontend`

```dockerfile
// path: rental-app-main/Dockerfile.frontend

# rental-app-main/Dockerfile.frontend

# --- –≠–¢–ê–ü 1: –°–±–æ—Ä–∫–∞ ---
FROM node:20-alpine as build
WORKDIR /app

# –ü—É—Ç–∏ —Ç–µ–ø–µ—Ä—å –æ—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω—ã –ø–∞–ø–∫–∏ rental-app-main
COPY package*.json ./
RUN npm install

COPY . .
RUN npm run build

# --- –≠–¢–ê–ü 2: –ü–æ–¥–∞—á–∞ ---
FROM nginx:stable-alpine
COPY --from=build /app/dist /usr/share/nginx/html

# –°—Ç—Ä–æ–∫–∞ `COPY nginx.conf` —É–¥–∞–ª–µ–Ω–∞, —Ç–∞–∫ –∫–∞–∫ —ç—Ç–∏–º —Ç–µ–ø–µ—Ä—å —É–ø—Ä–∞–≤–ª—è–µ—Ç docker-compose.yml
EXPOSE 80
CMD ["nginx", "-g", "daemon off;"]

```


## <a name="rentalappmainREADMEAImd"></a>`rental-app-main/README_AI.md`

```markdown
// path: rental-app-main/README_AI.md

# üìò –ò–Ω—Å—Ç—Ä—É–∫—Ü–∏—è –¥–ª—è AI-–ø–æ–º–æ—â–Ω–∏–∫–∞

–≠—Ç–æ—Ç –ø—Ä–æ–µ–∫—Ç —Å–æ–±—Ä–∞–Ω —Å–∫—Ä–∏–ø—Ç–æ–º `split_optimized.py` –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞ –ò–ò.

## üìÇ –°–æ–¥–µ—Ä–∂–∏–º–æ–µ
- `smart_react_code.md` ‚Äî –æ—Å–Ω–æ–≤–Ω–æ–π —Ñ–∞–π–ª —Å –∫–æ–¥–æ–º
- `README_AI.md` ‚Äî —ç—Ç–∞ –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—è

## üöÄ –ö–∞–∫ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å
–ü–µ—Ä–µ–¥–∞–π `smart_react_code.md` –≤ AI-–ø–æ–º–æ—â–Ω–∏–∫. –û–Ω —Å–æ–¥–µ—Ä–∂–∏—Ç —Å—Ç—Ä—É–∫—Ç—É—Ä—É, –æ–≥–ª–∞–≤–ª–µ–Ω–∏–µ, –∫–ª—é—á–µ–≤—ã–µ —É—á–∞—Å—Ç–∫–∏ –∫–æ–¥–∞.
–ü–æ —É–º–æ–ª—á–∞–Ω–∏—é UI-–∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã (`src/components/ui`) –∏—Å–∫–ª—é—á–µ–Ω—ã, –≤–∫–ª—é—á–∏ –∏—Ö —Ñ–ª–∞–≥–æ–º `--include-ui` –ø—Ä–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏.


```


## <a name="rentalappmaincomponentsjson"></a>`rental-app-main/components.json`

```json
// path: rental-app-main/components.json

{
  "$schema": "https://ui.shadcn.com/schema.json",
  "style": "new-york",
  "rsc": false,
  "tsx": true,
  "tailwind": {
    "config": "tailwind.config.js",
    "css": "src/index.css",
    "baseColor": "neutral",
    "cssVariables": true,
    "prefix": ""
  },
  "aliases": {
    "components": "@/components",
    "utils": "@/lib/utils",
    "ui": "@/components/ui",
    "lib": "@/lib",
    "hooks": "@/hooks"
  },
  "iconLibrary": "lucide"
}

```


## <a name="rentalappmaineslintconfigjs"></a>`rental-app-main/eslint.config.js`

```javascript
// path: rental-app-main/eslint.config.js

import js from '@eslint/js'
import globals from 'globals'
import reactHooks from 'eslint-plugin-react-hooks'
import reactRefresh from 'eslint-plugin-react-refresh'
import tseslint from 'typescript-eslint'

export default tseslint.config(
  { ignores: ['dist'] },
  {
    extends: [js.configs.recommended, ...tseslint.configs.recommended],
    files: ['**/*.{ts,tsx}'],
    languageOptions: {
      ecmaVersion: 2020,
      globals: globals.browser,
    },
    plugins: {
      'react-hooks': reactHooks,
      'react-refresh': reactRefresh,
    },
    rules: {
      ...reactHooks.configs.recommended.rules,
      'react-refresh/only-export-components': [
        'warn',
        { allowConstantExport: true },
      ],
    },
  },
)


```


## <a name="rentalappmainnginxnginxconf"></a>`rental-app-main/nginx/nginx.conf`

```nginx
// path: rental-app-main/nginx/nginx.conf

# nginx/nginx.conf

server {
    # Nginx –±—É–¥–µ—Ç —Å–ª—É—à–∞—Ç—å –ø–æ—Ä—Ç 80 –≤–Ω—É—Ç—Ä–∏ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞.
    listen 80;

    # –ö–æ—Ä–Ω–µ–≤–∞—è –ø–∞–ø–∫–∞, –∫—É–¥–∞ –º—ã —Å–∫–æ–ø–∏—Ä–æ–≤–∞–ª–∏ —Å–æ–±—Ä–∞–Ω–Ω—ã–π React-–ø—Ä–æ–µ–∫—Ç.
    root   /usr/share/nginx/html;
    index  index.html;

    # –ë–ª–æ–∫ –¥–ª—è –ø–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏—è API-–∑–∞–ø—Ä–æ—Å–æ–≤ —Å –ø—Ä–µ—Ñ–∏–∫—Å–æ–º /api/
    # –í—Å–µ –∑–∞–ø—Ä–æ—Å—ã, –Ω–∞—á–∏–Ω–∞—é—â–∏–µ—Å—è —Å /api/, –±—É–¥—É—Ç –ø–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª–µ–Ω—ã –Ω–∞ backend-—Å–µ—Ä–≤–∏—Å
    # —Å —É–¥–∞–ª–µ–Ω–∏–µ–º –ø—Ä–µ—Ñ–∏–∫—Å–∞ /api/ –ø–µ—Ä–µ–¥ –æ—Ç–ø—Ä–∞–≤–∫–æ–π
    location /api/ {
        rewrite /api/(.*) /$1 break;
        proxy_pass http://backend:8000;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    # –ë–ª–æ–∫ –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ –≤—Å–µ—Ö –æ—Å—Ç–∞–ª—å–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤ (SPA —Ä–æ—É—Ç–∏–Ω–≥).
    # –≠—Ç–∞ –≤–∞–∂–Ω–∞—è —Å—Ç—Ä–æ–∫–∞ –Ω—É–∂–Ω–∞ –¥–ª—è React Router. –ï—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –æ–±–Ω–æ–≤–∏—Ç —Å—Ç—Ä–∞–Ω–∏—Ü—É
    # –ø–æ –∞–¥—Ä–µ—Å—É /profile, Nginx —Å–Ω–∞—á–∞–ª–∞ –ø–æ–ø—ã—Ç–∞–µ—Ç—Å—è –Ω–∞–π—Ç–∏ —Ñ–∞–π–ª /profile.
    # –ù–µ –Ω–∞–π–¥—è –µ–≥–æ, –æ–Ω –æ—Ç–¥–∞—Å—Ç /index.html, –∞ React Router —É–∂–µ —Å–∞–º —Ä–∞–∑–±–µ—Ä–µ—Ç—Å—è —Å –º–∞—Ä—à—Ä—É—Ç–æ–º.
    location / {
        try_files $uri $uri/ /index.html;
    }
}

```


## <a name="rentalappmainpackagejson"></a>`rental-app-main/package.json`

```json
// path: rental-app-main/package.json

{
  "name": "rental-app-main",
  "private": true,
  "version": "0.0.0",
  "type": "module",
  "scripts": {
    "dev": "vite",
    "build": "vite build",
    "lint": "eslint .",
    "preview": "vite preview"
  },
  "dependencies": {
    "@fullcalendar/core": "^6.1.17",
    "@fullcalendar/daygrid": "^6.1.17",
    "@fullcalendar/interaction": "^6.1.17",
    "@fullcalendar/react": "^6.1.17",
    "@fullcalendar/resource-timeline": "^6.1.17",
    "@hookform/resolvers": "^5.0.1",
    "@radix-ui/react-checkbox": "^1.3.1",
    "@radix-ui/react-dialog": "^1.1.14",
    "@radix-ui/react-label": "^2.1.6",
    "@radix-ui/react-popover": "^1.1.14",
    "@radix-ui/react-scroll-area": "^1.2.9",
    "@radix-ui/react-select": "^2.2.4",
    "@radix-ui/react-slot": "^1.2.2",
    "@radix-ui/react-switch": "^1.2.5",
    "@radix-ui/react-toggle": "^1.1.8",
    "@radix-ui/react-toggle-group": "^1.1.9",
    "@tanstack/react-query": "^5.76.1",
    "@tanstack/react-query-devtools": "^5.76.1",
    "@types/react-input-mask": "^3.0.6",
    "@uiw/react-md-editor": "^4.0.7",
    "axios": "^1.9.0",
    "class-variance-authority": "^0.7.1",
    "clsx": "^2.1.1",
    "cmdk": "^1.1.1",
    "date-fns": "^4.1.0",
    "lucide-react": "^0.511.0",
    "react": "^19.1.0",
    "react-day-picker": "^9.7.0",
    "react-dom": "^19.1.0",
    "react-error-boundary": "^6.0.0",
    "react-hook-form": "^7.56.4",
    "react-imask": "^7.6.1",
    "react-markdown": "^10.1.0",
    "react-router-dom": "^7.6.0",
    "rehype-sanitize": "^6.0.0",
    "sonner": "^2.0.3",
    "tailwind-merge": "^3.3.0",
    "tailwindcss-animate": "^1.0.7",
    "zod": "^3.25.28",
    "zustand": "^5.0.4"
  },
  "devDependencies": {
    "@eslint/js": "^9.25.0",
    "@tailwindcss/typography": "^0.5.16",
    "@types/mocha": "^10.0.10",
    "@types/node": "^24.0.10",
    "@types/react": "^19.1.2",
    "@types/react-dom": "^19.1.2",
    "@vitejs/plugin-react": "^4.4.1",
    "autoprefixer": "^10.4.15",
    "eslint": "^9.25.0",
    "eslint-plugin-react-hooks": "^5.2.0",
    "eslint-plugin-react-refresh": "^0.4.19",
    "globals": "^16.0.0",
    "postcss": "^8.4.38",
    "tailwindcss": "^3.4.1",
    "typescript": "~5.8.3",
    "typescript-eslint": "^8.30.1",
    "vite": "^6.3.5"
  }
}


```


## <a name="rentalappmainpostcssconfigjs"></a>`rental-app-main/postcss.config.js`

```javascript
// path: rental-app-main/postcss.config.js

// postcss.config.js

export default {
    plugins: {
        tailwindcss: {},
        autoprefixer: {},
    },
}

```


## <a name="rentalappmainpublicfaviconsvg"></a>`rental-app-main/public/favicon.svg`

```
[–°–æ–¥–µ—Ä–∂–∏–º–æ–µ SVG —Ñ–∞–π–ª–∞ 'favicon.svg' –Ω–µ –≤–∫–ª—é—á–µ–Ω–æ –¥–ª—è —ç–∫–æ–Ω–æ–º–∏–∏ –º–µ—Å—Ç–∞]
```


## <a name="rentalappmainpublicvitesvg"></a>`rental-app-main/public/vite.svg`

```
[–°–æ–¥–µ—Ä–∂–∏–º–æ–µ SVG —Ñ–∞–π–ª–∞ 'vite.svg' –Ω–µ –≤–∫–ª—é—á–µ–Ω–æ –¥–ª—è —ç–∫–æ–Ω–æ–º–∏–∏ –º–µ—Å—Ç–∞]
```


## <a name="rentalappmainrentalappmainREADMEmd"></a>`rental-app-main/rental_app_main/README.md`

```markdown
// path: rental-app-main/rental_app_main/README.md

# rental_app_main



```


## <a name="rentalappmainsmartreactcodegemv2md"></a>`rental-app-main/smart_react_code_gem_v2.md`

```markdown
// path: rental-app-main/smart_react_code_gem_v2.md

# ü§ñ –°–∂–∞—Ç—ã–π –∏—Å—Ö–æ–¥–Ω—ã–π –∫–æ–¥ —Ñ—Ä–æ–Ω—Ç–µ–Ω–¥–∞ –¥–ª—è AI-–ø–æ–º–æ—â–Ω–∏–∫–∞

## üîó –ë—ã—Å—Ç—Ä–∞—è –Ω–∞–≤–∏–≥–∞—Ü–∏—è –ø–æ —Ñ–∞–π–ª–∞–º
- [package.json](#packagejson)
- [postcss.config.js](#postcssconfigjs)
- [public/favicon.svg](#publicfaviconsvg)
- [public/vite.svg](#publicvitesvg)
- [src/app/App.tsx](#srcappApptsx)
- [src/assets/react.svg](#srcassetsreactsvg)
- [src/components/AssociationFilter.tsx](#srccomponentsAssociationFiltertsx)
- [src/components/AuthForm.tsx](#srccomponentsAuthFormtsx)
- [src/components/AuthStatus.tsx](#srccomponentsAuthStatustsx)
- [src/components/AvailabilityStrip.tsx](#srccomponentsAvailabilityStriptsx)
- [src/components/AvailableCheckbox.tsx](#srccomponentsAvailableCheckboxtsx)
- [src/components/BrandFilter.tsx](#srccomponentsBrandFiltertsx)
- [src/components/CancelReservationDialog.tsx](#srccomponentsCancelReservationDialogtsx)
- [src/components/CardShell.tsx](#srccomponentsCardShelltsx)
- [src/components/CompactEquipmentCard.tsx](#srccomponentsCompactEquipmentCardtsx)
- [src/components/ConfirmItemRemovalDialog.tsx](#srccomponentsConfirmItemRemovalDialogtsx)
- [src/components/DateRangeSelector.tsx](#srccomponentsDateRangeSelectortsx)
- [src/components/DateRangeSelector/calendar.css](#srccomponentsDateRangeSelectorcalendarcss)
- [src/components/DiscountCalculator.tsx](#srccomponentsDiscountCalculatortsx)
- [src/components/EquipmentGrid.tsx](#srccomponentsEquipmentGridtsx)
- [src/components/ErrorBoundary.tsx](#srccomponentsErrorBoundarytsx)
- [src/components/ErrorMessage.tsx](#srccomponentsErrorMessagetsx)
- [src/components/FilterPanel.tsx](#srccomponentsFilterPaneltsx)
- [src/components/MyReservationList.tsx](#srccomponentsMyReservationListtsx)
- [src/components/NetworkStatus.tsx](#srccomponentsNetworkStatustsx)
- [src/components/PromoCodeInput.tsx](#srccomponentsPromoCodeInputtsx)
- [src/components/RequireAuth.tsx](#srccomponentsRequireAuthtsx)
- [src/components/ReservationCard.tsx](#srccomponentsReservationCardtsx)
- [src/components/ReservationFooter.tsx](#srccomponentsReservationFootertsx)
- [src/components/ReservationList.tsx](#srccomponentsReservationListtsx)
- [src/components/ReserveEquipmentCard.tsx](#srccomponentsReserveEquipmentCardtsx)
- [src/components/SearchInput.tsx](#srccomponentsSearchInputtsx)
- [src/components/StatusBadge.tsx](#srccomponentsStatusBadgetsx)
- [src/components/TypeFilter.tsx](#srccomponentsTypeFiltertsx)
- [src/components/UserInfoBlock.tsx](#srccomponentsUserInfoBlocktsx)
- [src/components/ViewModeToggle.tsx](#srccomponentsViewModeToggletsx)
- [src/components/admin/AccessoryDialogs.tsx](#srccomponentsadminAccessoryDialogstsx)
- [src/components/admin/AccessoryTable.tsx](#srccomponentsadminAccessoryTabletsx)
- [src/components/admin/AdminNavigation.tsx](#srccomponentsadminAdminNavigationtsx)
- [src/components/admin/AdminRentalCard.tsx](#srccomponentsadminAdminRentalCardtsx)
- [src/components/admin/AdminReservationCard.tsx](#srccomponentsadminAdminReservationCardtsx)
- [src/components/admin/AdminReservationToolbar.tsx](#srccomponentsadminAdminReservationToolbartsx)
- [src/components/admin/AllRentalsList.tsx](#srccomponentsadminAllRentalsListtsx)
- [src/components/admin/AllReservationsList.tsx](#srccomponentsadminAllReservationsListtsx)
- [src/components/admin/AssociationTable.tsx](#srccomponentsadminAssociationTabletsx)
- [src/components/admin/ConvertReservationDialog.tsx](#srccomponentsadminConvertReservationDialogtsx)
- [src/components/admin/CreateReservationDialog.tsx](#srccomponentsadminCreateReservationDialogtsx)
- [src/components/admin/CreateReservationStep1Details.tsx](#srccomponentsadminCreateReservationStep1Detailstsx)
- [src/components/admin/CreateReservationStep2Accessories.tsx](#srccomponentsadminCreateReservationStep2Accessoriestsx)
- [src/components/admin/DurationDiscountManager.tsx](#srccomponentsadminDurationDiscountManagertsx)
- [src/components/admin/EditableRentalCard.tsx](#srccomponentsadminEditableRentalCardtsx)
- [src/components/admin/EquipmentCreateDialog.tsx](#srccomponentsadminEquipmentCreateDialogtsx)
- [src/components/admin/EquipmentEditDialog.tsx](#srccomponentsadminEquipmentEditDialogtsx)
- [src/components/admin/EquipmentStats.tsx](#srccomponentsadminEquipmentStatstsx)
- [src/components/admin/EquipmentTable.tsx](#srccomponentsadminEquipmentTabletsx)
- [src/components/admin/EquipmentTableRow.tsx](#srccomponentsadminEquipmentTableRowtsx)
- [src/components/admin/EquipmentTableToolbar.tsx](#srccomponentsadminEquipmentTableToolbartsx)
- [src/components/admin/HolidayManager.tsx](#srccomponentsadminHolidayManagertsx)
- [src/components/admin/PromoCodeDialog.tsx](#srccomponentsadminPromoCodeDialogtsx)
- [src/components/admin/PromoCodeTable.tsx](#srccomponentsadminPromoCodeTabletsx)
- [src/components/admin/RentalStatusBadge.tsx](#srccomponentsadminRentalStatusBadgetsx)
- [src/components/admin/ReservationFinancialSummary.tsx](#srccomponentsadminReservationFinancialSummarytsx)
- [src/components/admin/ReturnAccessoriesChecklist.tsx](#srccomponentsadminReturnAccessoriesChecklisttsx)
- [src/components/admin/ReturnFinancials.tsx](#srccomponentsadminReturnFinancialstsx)
- [src/components/admin/ReturnRentalDialog.tsx](#srccomponentsadminReturnRentalDialogtsx)
- [src/components/admin/UserCreateDialog.tsx](#srccomponentsadminUserCreateDialogtsx)
- [src/components/admin/UserEditDialog.tsx](#srccomponentsadminUserEditDialogtsx)
- [src/components/admin/UserPaymentDialog.tsx](#srccomponentsadminUserPaymentDialogtsx)
- [src/components/admin/UserTable.tsx](#srccomponentsadminUserTabletsx)
- [src/components/admin/UserTableRow.tsx](#srccomponentsadminUserTableRowtsx)
- [src/components/admin/UserTableToolbar.tsx](#srccomponentsadminUserTableToolbartsx)
- [src/components/admin/dashboard/ActivityFeedWidget.tsx](#srccomponentsadmindashboardActivityFeedWidgettsx)
- [src/components/admin/dashboard/KpiCardsWidget.tsx](#srccomponentsadmindashboardKpiCardsWidgettsx)
- [src/components/admin/dashboard/PopularEquipmentChart.tsx](#srccomponentsadmindashboardPopularEquipmentCharttsx)
- [src/components/admin/dashboard/TodayFocusWidget.tsx](#srccomponentsadmindashboardTodayFocusWidgettsx)
- [src/components/calendar/CalendarDateInputRange.tsx](#srccomponentscalendarCalendarDateInputRangetsx)
- [src/components/calendar/CalendarFiltersBlock.tsx](#srccomponentscalendarCalendarFiltersBlocktsx)
- [src/components/calendar/CalendarTable.tsx](#srccomponentscalendarCalendarTabletsx)
- [src/components/catalog/EquipmentCatalog.tsx](#srccomponentscatalogEquipmentCatalogtsx)
- [src/components/equipment-card/AccessoriesSection.tsx](#srccomponentsequipment-cardAccessoriesSectiontsx)
- [src/components/equipment-card/CardFooter.tsx](#srccomponentsequipment-cardCardFootertsx)
- [src/components/equipment-card/CardImage.tsx](#srccomponentsequipment-cardCardImagetsx)
- [src/components/equipment-card/DiscountInfo.tsx](#srccomponentsequipment-cardDiscountInfotsx)
- [src/components/equipment-card/EquipmentCard.tsx](#srccomponentsequipment-cardEquipmentCardtsx)
- [src/components/equipment-card/constants.ts](#srccomponentsequipment-cardconstantsts)
- [src/components/equipment-card/index.ts](#srccomponentsequipment-cardindexts)
- [src/components/equipment/EquipmentDetailsDialog.tsx](#srccomponentsequipmentEquipmentDetailsDialogtsx)
- [src/components/equipment/EquipmentDetailsView.tsx](#srccomponentsequipmentEquipmentDetailsViewtsx)
- [src/components/equipment/EquipmentEditForm.tsx](#srccomponentsequipmentEquipmentEditFormtsx)
- [src/components/profile/BalanceHistoryTable.tsx](#srccomponentsprofileBalanceHistoryTabletsx)
- [src/components/rental/MyRentalCard.tsx](#srccomponentsrentalMyRentalCardtsx)
- [src/components/rental/MyRentalsList.tsx](#srccomponentsrentalMyRentalsListtsx)
- [src/components/rental/RentalStatusBadge.tsx](#srccomponentsrentalRentalStatusBadgetsx)
- [src/components/reservation/AvailableAccessoriesDropdown.tsx](#srccomponentsreservationAvailableAccessoriesDropdowntsx)
- [src/components/reservation/EditableDateRange.tsx](#srccomponentsreservationEditableDateRangetsx)
- [src/components/reservation/EditableEquipmentItem.tsx](#srccomponentsreservationEditableEquipmentItemtsx)
- [src/components/reservation/EditableReservationCard.tsx](#srccomponentsreservationEditableReservationCardtsx)
- [src/components/reservation/EquipmentItemWithConflicts.tsx](#srccomponentsreservationEquipmentItemWithConflictstsx)
- [src/components/reservation/HolidayConfirmationDialog.tsx](#srccomponentsreservationHolidayConfirmationDialogtsx)
- [src/components/reservation/ReservationItemsList.tsx](#srccomponentsreservationReservationItemsListtsx)
- [src/components/reservation/ReservationStatusBadge.tsx](#srccomponentsreservationReservationStatusBadgetsx)
- [src/components/reservation/ViewReservationCard.tsx](#srccomponentsreservationViewReservationCardtsx)
- [src/components/session/UserSession.tsx](#srccomponentssessionUserSessiontsx)
- [src/components/shared/EquipmentWithAccessoriesList.tsx](#srccomponentssharedEquipmentWithAccessoriesListtsx)
- [src/components/shared/FinancialInfoBlock.tsx](#srccomponentssharedFinancialInfoBlocktsx)
- [src/components/shared/FinancialSummaryBlock.tsx](#srccomponentssharedFinancialSummaryBlocktsx)
- [src/components/shared/OrderToolbar.tsx](#srccomponentssharedOrderToolbartsx)
- [src/constants/equipmentConstants.ts](#srcconstantsequipmentConstantsts)
- [src/constants/paginationConstants.ts](#srcconstantspaginationConstantsts)
- [src/constants/statusStyles.ts](#srcconstantsstatusStylests)
- [src/constants/userConstants.ts](#srcconstantsuserConstantsts)
- [src/contexts/ReservationEditContext.tsx](#srccontextsReservationEditContexttsx)
- [src/core/services/AccessoryService.ts](#srccoreservicesAccessoryServicets)
- [src/core/services/AvailabilityService.ts](#srccoreservicesAvailabilityServicets)
- [src/core/services/CalendarService.ts](#srccoreservicesCalendarServicets)
- [src/core/services/DateService.ts](#srccoreservicesDateServicets)
- [src/core/services/EquipmentService.ts](#srccoreservicesEquipmentServicets)
- [src/core/services/PhoneService.ts](#srccoreservicesPhoneServicets)
- [src/core/services/PromoCodeService.ts](#srccoreservicesPromoCodeServicets)
- [src/core/services/ReservationService.ts](#srccoreservicesReservationServicets)
- [src/core/services/UserService.ts](#srccoreservicesUserServicets)
- [src/core/services/index.ts](#srccoreservicesindexts)
- [src/hooks/admin/create-reservation/useCreateReservationData.ts](#srchooksadmincreate-reservationuseCreateReservationDatats)
- [src/hooks/admin/create-reservation/useCreateReservationDialog.ts](#srchooksadmincreate-reservationuseCreateReservationDialogts)
- [src/hooks/admin/create-reservation/useCreateReservationForm.ts](#srchooksadmincreate-reservationuseCreateReservationFormts)
- [src/hooks/admin/useAdminRentalEdit.ts](#srchooksadminuseAdminRentalEditts)
- [src/hooks/admin/useAdminReservationCalculator.ts](#srchooksadminuseAdminReservationCalculatorts)
- [src/hooks/admin/useDashboardData.ts](#srchooksadminuseDashboardDatats)
- [src/hooks/admin/useEquipmentTableLogic.ts](#srchooksadminuseEquipmentTableLogicts)
- [src/hooks/admin/useRentalReturnForm.ts](#srchooksadminuseRentalReturnFormts)
- [src/hooks/admin/useUserTableLogic.ts](#srchooksadminuseUserTableLogicts)
- [src/hooks/data/useEquipmentData.ts](#srchooksdatauseEquipmentDatats)
- [src/hooks/features/useAppFilters.ts](#srchooksfeaturesuseAppFiltersts)
- [src/hooks/features/useEquipmentCardViewModel.ts](#srchooksfeaturesuseEquipmentCardViewModelts)
- [src/hooks/reservation/submission/useReservationFormData.ts](#srchooksreservationsubmissionuseReservationFormDatats)
- [src/hooks/reservation/submission/useReserveSubmission.ts](#srchooksreservationsubmissionuseReserveSubmissionts)
- [src/hooks/reservation/usePriceCalculator.ts](#srchooksreservationusePriceCalculatorts)
- [src/hooks/reservation/useReservationActions.ts](#srchooksreservationuseReservationActionsts)
- [src/hooks/reservation/useReservationData.ts](#srchooksreservationuseReservationDatats)
- [src/hooks/reservation/useReservationEditState.ts](#srchooksreservationuseReservationEditStatets)
- [src/hooks/reservation/useReservationState.ts](#srchooksreservationuseReservationStatets)
- [src/hooks/useAdminAccessories.ts](#srchooksuseAdminAccessoriests)
- [src/hooks/useAdminAssociations.ts](#srchooksuseAdminAssociationsts)
- [src/hooks/useAdminDiscounts.ts](#srchooksuseAdminDiscountsts)
- [src/hooks/useAdminEquipment.ts](#srchooksuseAdminEquipmentts)
- [src/hooks/useAdminHolidayRules.ts](#srchooksuseAdminHolidayRulests)
- [src/hooks/useAdminHolidays.ts](#srchooksuseAdminHolidaysts)
- [src/hooks/useAdminPromoCodes.ts](#srchooksuseAdminPromoCodests)
- [src/hooks/useAdminRentals.ts](#srchooksuseAdminRentalsts)
- [src/hooks/useAdminReservations.ts](#srchooksuseAdminReservationsts)
- [src/hooks/useAdminUsers.ts](#srchooksuseAdminUsersts)
- [src/hooks/useAllEquipment.ts](#srchooksuseAllEquipmentts)
- [src/hooks/useAssociations.ts](#srchooksuseAssociationsts)
- [src/hooks/useAvailabilityCheck.ts](#srchooksuseAvailabilityCheckts)
- [src/hooks/useBalanceHistory.ts](#srchooksuseBalanceHistoryts)
- [src/hooks/useCalendarGrid.ts](#srchooksuseCalendarGridts)
- [src/hooks/useDailyAvailability.ts](#srchooksuseDailyAvailabilityts)
- [src/hooks/useDateRange.ts](#srchooksuseDateRangets)
- [src/hooks/useEditReservation.ts](#srchooksuseEditReservationts)
- [src/hooks/useEquipment.ts](#srchooksuseEquipmentts)
- [src/hooks/useEquipmentAvailability.ts](#srchooksuseEquipmentAvailabilityts)
- [src/hooks/useEquipmentMap.ts](#srchooksuseEquipmentMapts)
- [src/hooks/useErrorHandler.ts](#srchooksuseErrorHandlerts)
- [src/hooks/useInlineReservationEdit.tsx](#srchooksuseInlineReservationEdittsx)
- [src/hooks/useMyRentals.ts](#srchooksuseMyRentalsts)
- [src/hooks/useNetworkStatus.ts](#srchooksuseNetworkStatusts)
- [src/hooks/usePhoneValidation.ts](#srchooksusePhoneValidationts)
- [src/hooks/useProfile.ts](#srchooksuseProfilets)
- [src/hooks/useReservationManagement.ts](#srchooksuseReservationManagementts)
- [src/hooks/useReservations.ts](#srchooksuseReservationsts)
- [src/hooks/useUpdateEquipmentDetails.ts](#srchooksuseUpdateEquipmentDetailsts)
- [src/hooks/useVisibleItems.ts](#srchooksuseVisibleItemsts)
- [src/index.css](#srcindexcss)
- [src/lib/api.ts](#srclibapits)
- [src/lib/queryClient.ts](#srclibqueryClientts)
- [src/lib/queryHelpers.ts](#srclibqueryHelpersts)
- [src/lib/sortingUtils.ts](#srclibsortingUtilsts)
- [src/lib/utils.ts](#srclibutilsts)
- [src/lib/validationSchemas.ts](#srclibvalidationSchemasts)
- [src/main.tsx](#srcmaintsx)
- [src/pages/AccessoryManagementPage.tsx](#srcpagesAccessoryManagementPagetsx)
- [src/pages/CalendarPage.tsx](#srcpagesCalendarPagetsx)
- [src/pages/CalendarTestPage.tsx](#srcpagesCalendarTestPagetsx)
- [src/pages/ContactPage.tsx](#srcpagesContactPagetsx)
- [src/pages/EquipmentManagementPage.tsx](#srcpagesEquipmentManagementPagetsx)
- [src/pages/HomePage.tsx](#srcpagesHomePagetsx)
- [src/pages/MyReservationsPage.tsx](#srcpagesMyReservationsPagetsx)
- [src/pages/ProfilePage.tsx](#srcpagesProfilePagetsx)
- [src/pages/ReservePage.tsx](#srcpagesReservePagetsx)
- [src/pages/UserManagementPage.tsx](#srcpagesUserManagementPagetsx)
- [src/pages/admin/AllReservationsManagementPage.tsx](#srcpagesadminAllReservationsManagementPagetsx)
- [src/pages/admin/AssociationManagementPage.tsx](#srcpagesadminAssociationManagementPagetsx)
- [src/pages/admin/DashboardPage.tsx](#srcpagesadminDashboardPagetsx)
- [src/pages/admin/HolidayManagementPage.tsx](#srcpagesadminHolidayManagementPagetsx)
- [src/pages/admin/PromoCodeManagementPage.tsx](#srcpagesadminPromoCodeManagementPagetsx)
- [src/pages/admin/RentalManagementPage.tsx](#srcpagesadminRentalManagementPagetsx)
- [src/store/adminReservationSelectionStore.ts](#srcstoreadminReservationSelectionStorets)
- [src/store/authStore.ts](#srcstoreauthStorets)
- [src/store/calendarSelectionStore.ts](#srcstorecalendarSelectionStorets)
- [src/store/dateStore.ts](#srcstoredateStorets)
- [src/store/filterStore.ts](#srcstorefilterStorets)
- [src/store/holidayStore.ts](#srcstoreholidayStorets)
- [src/store/orderFilterStore.ts](#srcstoreorderFilterStorets)
- [src/store/promoCodeStore.ts](#srcstorepromoCodeStorets)
- [src/store/reserveStore.ts](#srcstorereserveStorets)
- [src/store/sandboxCalculatorStore.ts](#srcstoresandboxCalculatorStorets)
- [src/store/searchStore.ts](#srcstoresearchStorets)
- [src/store/viewModeStore.ts](#srcstoreviewModeStorets)
- [src/types/accessory.ts](#srctypesaccessoryts)
- [src/types/association.ts](#srctypesassociationts)
- [src/types/availability.ts](#srctypesavailabilityts)
- [src/types/balanceHistory.ts](#srctypesbalanceHistoryts)
- [src/types/discount.ts](#srctypesdiscountts)
- [src/types/equipment.ts](#srctypesequipmentts)
- [src/types/holiday.ts](#srctypesholidayts)
- [src/types/promo_code.ts](#srctypespromo_codets)
- [src/types/rental.ts](#srctypesrentalts)
- [src/types/reservation.ts](#srctypesreservationts)
- [src/types/user.ts](#srctypesuserts)
- [src/utils/phoneUtils.ts](#srcutilsphoneUtilsts)
- [src/vite-env.d.ts](#srcvite-envdts)
- [tailwind.config.js](#tailwindconfigjs)
- [tsconfig.app.json](#tsconfigappjson)
- [tsconfig.json](#tsconfigjson)
- [tsconfig.node.json](#tsconfignodejson)
- [vite.config.ts](#viteconfigts)

---

# üìÅ –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –ø—Ä–æ–µ–∫—Ç–∞ (–∏–µ—Ä–∞—Ä—Ö–∏—è)
`rental-app-main/`
    ‚îú‚îÄ‚îÄ `public/`
    ‚îÇ   ‚îú‚îÄ‚îÄ üñºÔ∏è `favicon.svg`
    ‚îÇ   ‚îî‚îÄ‚îÄ üñºÔ∏è `vite.svg`
    ‚îú‚îÄ‚îÄ `src/`
    ‚îÇ   ‚îú‚îÄ‚îÄ `app/`
    ‚îÇ   ‚îú‚îÄ‚îÄ `assets/`
    ‚îÇ   ‚îú‚îÄ‚îÄ `components/`
    ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ `DateRangeSelector/`
    ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ `admin/`
    ‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ `dashboard/`
    ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ `calendar/`
    ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ `catalog/`
    ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ `equipment/`
    ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ `equipment-card/`
    ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ `profile/`
    ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ `rental/`
    ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ `reservation/`
    ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ `session/`
    ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ `shared/`
    ‚îÇ   ‚îú‚îÄ‚îÄ `constants/`
    ‚îÇ   ‚îú‚îÄ‚îÄ `contexts/`
    ‚îÇ   ‚îú‚îÄ‚îÄ `hooks/`
    ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ `admin/`
    ‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ `create-reservation/`
    ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ `data/`
    ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ `features/`
    ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ `reservation/`
    ‚îÇ   ‚îÇ       ‚îî‚îÄ‚îÄ `submission/`
    ‚îÇ   ‚îú‚îÄ‚îÄ `lib/`
    ‚îÇ   ‚îú‚îÄ‚îÄ `pages/`
    ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ `admin/`
    ‚îÇ   ‚îú‚îÄ‚îÄ `store/`
    ‚îÇ   ‚îú‚îÄ‚îÄ `types/`
    ‚îÇ   ‚îú‚îÄ‚îÄ `utils/`
    ‚îÇ   ‚îú‚îÄ‚îÄ üìÑ `index.css`
    ‚îÇ   ‚îú‚îÄ‚îÄ üìÑ `main.tsx`
    ‚îÇ   ‚îî‚îÄ‚îÄ üìÑ `vite-env.d.ts`
    ‚îú‚îÄ‚îÄ üìÑ `package.json`
    ‚îú‚îÄ‚îÄ üìÑ `postcss.config.js`
    ‚îú‚îÄ‚îÄ üìÑ `tailwind.config.js`
    ‚îú‚îÄ‚îÄ üìÑ `tsconfig.app.json`
    ‚îú‚îÄ‚îÄ üìÑ `tsconfig.json`
    ‚îú‚îÄ‚îÄ üìÑ `tsconfig.node.json`
    ‚îî‚îÄ‚îÄ üìÑ `vite.config.ts`

---


## <a name="packagejson"></a>`package.json`

```json
// path: package.json

{
  "name": "rental-app-main",
  "private": true,
  "version": "0.0.0",
  "type": "module",
  "scripts": {
    "dev": "vite",
    "build": "vite build",
    "lint": "eslint .",
    "preview": "vite preview"
  },
  "dependencies": {
    "@fullcalendar/core": "^6.1.17",
    "@fullcalendar/daygrid": "^6.1.17",
    "@fullcalendar/interaction": "^6.1.17",
    "@fullcalendar/react": "^6.1.17",
    "@fullcalendar/resource-timeline": "^6.1.17",
    "@hookform/resolvers": "^5.0.1",
    "@radix-ui/react-checkbox": "^1.3.1",
    "@radix-ui/react-dialog": "^1.1.14",
    "@radix-ui/react-label": "^2.1.6",
    "@radix-ui/react-popover": "^1.1.14",
    "@radix-ui/react-scroll-area": "^1.2.9",
    "@radix-ui/react-select": "^2.2.4",
    "@radix-ui/react-slot": "^1.2.2",
    "@radix-ui/react-switch": "^1.2.5",
    "@radix-ui/react-toggle": "^1.1.8",
    "@radix-ui/react-toggle-group": "^1.1.9",
    "@tanstack/react-query": "^5.76.1",
    "@tanstack/react-query-devtools": "^5.76.1",
    "@types/react-input-mask": "^3.0.6",
    "@uiw/react-md-editor": "^4.0.7",
    "axios": "^1.9.0",
    "class-variance-authority": "^0.7.1",
    "clsx": "^2.1.1",
    "cmdk": "^1.1.1",
    "date-fns": "^4.1.0",
    "lucide-react": "^0.511.0",
    "react": "^19.1.0",
    "react-day-picker": "^9.7.0",
    "react-dom": "^19.1.0",
    "react-error-boundary": "^6.0.0",
    "react-hook-form": "^7.56.4",
    "react-imask": "^7.6.1",
    "react-markdown": "^10.1.0",
    "react-router-dom": "^7.6.0",
    "rehype-sanitize": "^6.0.0",
    "sonner": "^2.0.3",
    "tailwind-merge": "^3.3.0",
    "tailwindcss-animate": "^1.0.7",
    "zod": "^3.25.28",
    "zustand": "^5.0.4"
  },
  "devDependencies": {
    "@eslint/js": "^9.25.0",
    "@tailwindcss/typography": "^0.5.16",
    "@types/mocha": "^10.0.10",
    "@types/node": "^24.0.10",
    "@types/react": "^19.1.2",
    "@types/react-dom": "^19.1.2",
    "@vitejs/plugin-react": "^4.4.1",
    "autoprefixer": "^10.4.15",
    "eslint": "^9.25.0",
    "eslint-plugin-react-hooks": "^5.2.0",
    "eslint-plugin-react-refresh": "^0.4.19",
    "globals": "^16.0.0",
    "postcss": "^8.4.38",
    "tailwindcss": "^3.4.1",
    "typescript": "~5.8.3",
    "typescript-eslint": "^8.30.1",
    "vite": "^6.3.5"
  }
}


```


## <a name="postcssconfigjs"></a>`postcss.config.js`

```javascript
// path: postcss.config.js

// postcss.config.js

export default {
    plugins: {
        tailwindcss: {},
        autoprefixer: {},
    },
}

```


## <a name="publicfaviconsvg"></a>`public/favicon.svg`

```
[–°–æ–¥–µ—Ä–∂–∏–º–æ–µ SVG —Ñ–∞–π–ª–∞ 'favicon.svg' –Ω–µ –≤–∫–ª—é—á–µ–Ω–æ –¥–ª—è —ç–∫–æ–Ω–æ–º–∏–∏ –º–µ—Å—Ç–∞]
```


## <a name="publicvitesvg"></a>`public/vite.svg`

```
[–°–æ–¥–µ—Ä–∂–∏–º–æ–µ SVG —Ñ–∞–π–ª–∞ 'vite.svg' –Ω–µ –≤–∫–ª—é—á–µ–Ω–æ –¥–ª—è —ç–∫–æ–Ω–æ–º–∏–∏ –º–µ—Å—Ç–∞]
```


## <a name="srcappApptsx"></a>`src/app/App.tsx`

```tsx
// path: src/app/App.tsx

// src/app/App.tsx

import { Routes, Route } from "react-router-dom";
import HomePage from "../pages/HomePage";
import ReservePage from "../pages/ReservePage";
import ProfilePage from "../pages/ProfilePage";
import MyReservationsPage from "../pages/MyReservationsPage";
import ContactPage from "../pages/ContactPage";
import CalendarPage from "../pages/CalendarPage";
import RequireAuth from "../components/RequireAuth";
import { Toaster } from "sonner"; // <--- 1. –î–û–ë–ê–í–¨–¢–ï –≠–¢–û–¢ –ò–ú–ü–û–†–¢

// –ò–º–ø–æ—Ä—Ç—ã –¥–ª—è –∞–¥–º–∏–Ω –ø–∞–Ω–µ–ª–∏
import DashboardPage from "../pages/admin/DashboardPage";
import UserManagementPage from "../pages/UserManagementPage";
import EquipmentManagementPage from "../pages/EquipmentManagementPage";
import AccessoryManagementPage from "../pages/AccessoryManagementPage";
import AllReservationsManagementPage from "../pages/admin/AllReservationsManagementPage";
import PromoCodeManagementPage from "../pages/admin/PromoCodeManagementPage";
import CalendarTestPage from "../pages/CalendarTestPage";
import HolidayManagementPage from "../pages/admin/HolidayManagementPage";
import AssociationManagementPage from "../pages/admin/AssociationManagementPage";
import RentalManagementPage from "../pages/admin/RentalManagementPage";


function App() {
    return (
        // +++ 2. –û–ë–ï–†–ù–ò–¢–ï –í–°–ï –í –§–†–ê–ì–ú–ï–ù–¢ –ò –î–û–ë–ê–í–¨–¢–ï TOASTER +++
        <>
            <Routes>
                {/* –û—Å–Ω–æ–≤–Ω—ã–µ –º–∞—Ä—à—Ä—É—Ç—ã */}
                <Route path="/test-calendar" element={<CalendarTestPage />} />
                <Route path="/" element={<HomePage />} />
                <Route path="/reserve/create" element={<ReservePage />} />
                <Route path="/contacts" element={<ContactPage />} />
                <Route path="/calendar" element={<CalendarPage />} />

                {/* –ú–∞—Ä—à—Ä—É—Ç—ã, —Ç—Ä–µ–±—É—é—â–∏–µ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ */}
                <Route
                    path="/profile"
                    element={
                        <RequireAuth>
                            <ProfilePage />
                        </RequireAuth>
                    }
                />
                <Route
                    path="/reservations/my"
                    element={
                        <RequireAuth>
                            <MyReservationsPage />
                        </RequireAuth>
                    }
                />

                {/* –ú–∞—Ä—à—Ä—É—Ç—ã –∞–¥–º–∏–Ω-–ø–∞–Ω–µ–ª–∏ */}
                <Route
                    path="/admin"
                    element={
                        <RequireAuth role={["manager", "admin"]}>
                            <DashboardPage />
                        </RequireAuth>
                    }
                />
                <Route
                    path="/admin/rentals"
                    element={
                        <RequireAuth role={["manager", "admin"]}>
                            <RentalManagementPage />
                        </RequireAuth>
                    }
                />
                <Route
                    path="/admin/users"
                    element={
                        <RequireAuth role={["manager", "admin"]}>
                            <UserManagementPage />
                        </RequireAuth>
                    }
                />
                <Route
                    path="/admin/equipment"
                    element={
                        <RequireAuth role={["manager", "admin"]}>
                            <EquipmentManagementPage />
                        </RequireAuth>
                    }
                />
                <Route
                    path="/admin/accessories"
                    element={
                        <RequireAuth role={["manager", "admin"]}>
                            <AccessoryManagementPage />
                        </RequireAuth>
                    }
                />
                <Route
                    path="/admin/reservations"
                    element={
                        <RequireAuth role={["manager", "admin"]}>
                            <AllReservationsManagementPage />
                        </RequireAuth>
                    }
                />
                <Route
                    path="/admin/promocodes"
                    element={
                        <RequireAuth role={["manager", "admin"]}>
                            <PromoCodeManagementPage />
                        </RequireAuth>
                    }
                />
                <Route
                    path="/admin/holidays"
                    element={
                        <RequireAuth role={["admin"]}>
                            <HolidayManagementPage />
                        </RequireAuth>
                    }
                />
                <Route
                    path="/admin/associations"
                    element={
                        <RequireAuth role={["manager", "admin"]}>
                            <AssociationManagementPage />
                        </RequireAuth>
                    }
                />

            </Routes>
            <Toaster richColors position="top-right" />
        </>
    );
}

export default App;

```


## <a name="srcassetsreactsvg"></a>`src/assets/react.svg`

```
[–°–æ–¥–µ—Ä–∂–∏–º–æ–µ SVG —Ñ–∞–π–ª–∞ 'react.svg' –Ω–µ –≤–∫–ª—é—á–µ–Ω–æ –¥–ª—è —ç–∫–æ–Ω–æ–º–∏–∏ –º–µ—Å—Ç–∞]
```


## <a name="srccomponentsAssociationFiltertsx"></a>`src/components/AssociationFilter.tsx`

```tsx
// path: src/components/AssociationFilter.tsx

// src/components/AssociationFilter.tsx

import { useMemo } from "react"; // <--- –î–û–ë–ê–í–ò–¢–¨ –ò–ú–ü–û–†–¢
import { ToggleGroup, ToggleGroupItem } from "@/components/ui/toggle-group";
import { useFilterStore } from "@/store/filterStore";
import { useAssociations } from "@/hooks/useAssociations";
import { getFilterToggleClass } from "@/components/ui/filter-toggle";
import { Tags, List } from "lucide-react";

export default function AssociationFilter() {
    const { associationId, setAssociationId } = useFilterStore();
    const { data: allAssociations = [], isLoading } = useAssociations();

    // +++ –ù–ê–ß–ê–õ–û –ò–ó–ú–ï–ù–ï–ù–ò–ô +++
    // –§–∏–ª—å—Ç—Ä—É–µ–º –∞—Å—Å–æ—Ü–∏–∞—Ü–∏–∏, –æ—Å—Ç–∞–≤–ª—è—è —Ç–æ–ª—å–∫–æ —Ç–µ, –∫ –∫–æ—Ç–æ—Ä—ã–º –ø—Ä–∏–≤—è–∑–∞–Ω–æ –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏–µ
    const associationsWithEquipment = useMemo(() => {
        return allAssociations.filter(assoc => assoc.equipment_ids && assoc.equipment_ids.length > 0);
    }, [allAssociations]);

    // –¢–µ–ø–µ—Ä—å –ø—Ä–æ–≤–µ—Ä—è–µ–º –æ—Ç—Ñ–∏–ª—å—Ç—Ä–æ–≤–∞–Ω–Ω—ã–π —Å–ø–∏—Å–æ–∫
    if (isLoading || associationsWithEquipment.length === 0) {
        return null; // –ù–µ —Ä–µ–Ω–¥–µ—Ä–∏–º –Ω–∏—á–µ–≥–æ, –µ—Å–ª–∏ –¥–∞–Ω–Ω—ã—Ö –Ω–µ—Ç –∏–ª–∏ –≤—Å–µ –∞—Å—Å–æ—Ü–∏–∞—Ü–∏–∏ "–ø—É—Å—Ç—ã–µ"
    }
    // +++ –ö–û–ù–ï–¶ –ò–ó–ú–ï–ù–ï–ù–ò–ô +++

    return (
        <ToggleGroup
            type="single"
            value={associationId?.toString() ?? "__all__"}
            onValueChange={(val: string) => setAssociationId(val === "__all__" ? null : Number(val))}
            className="flex flex-wrap gap-2"
        >
            <ToggleGroupItem value="__all__" className={getFilterToggleClass("green")}>
                <List />
                –í—Å–µ –ø–æ–¥–±–æ—Ä–∫–∏
            </ToggleGroupItem>

            {/* –ò—Å–ø–æ–ª—å–∑—É–µ–º –æ—Ç—Ñ–∏–ª—å—Ç—Ä–æ–≤–∞–Ω–Ω—ã–π —Å–ø–∏—Å–æ–∫ –¥–ª—è —Ä–µ–Ω–¥–µ—Ä–∏–Ω–≥–∞ */}
            {associationsWithEquipment.map((assoc) => (
                <ToggleGroupItem
                    key={assoc.id}
                    value={assoc.id.toString()}
                    className={getFilterToggleClass("green")}
                >
                    <Tags className="h-4 w-4" />
                    {assoc.name}
                </ToggleGroupItem>
            ))}
        </ToggleGroup>
    );
}


```


## <a name="srccomponentsAuthFormtsx"></a>`src/components/AuthForm.tsx`

```tsx
// path: src/components/AuthForm.tsx

// src/components/AuthForm.tsx

import { useState } from "react";
import { useForm, Controller } from "react-hook-form";
import { zodResolver } from "@hookform/resolvers/zod";
import { authSchema, AuthSchema } from "@/lib/validationSchemas";
import { useAuthStore } from "@/store/authStore";
import { Input } from "@/components/ui/input";
import { Button } from "@/components/ui/button";
import { Checkbox } from "@/components/ui/checkbox";
import { Label } from "@/components/ui/label";
import { PhoneInput } from "@/components/ui/phone-input";
import { Eye, EyeOff, Mail, Lock, User, LogIn, UserPlus, Phone, Calendar } from "lucide-react"; // <<< –ò–ó–ú–ï–ù–ï–ù–ò–ï: –î–æ–±–∞–≤–ª–µ–Ω–∞ –∏–∫–æ–Ω–∫–∞ Calendar
import { useNavigate } from "react-router-dom"; // <<< –ò–ó–ú–ï–ù–ï–ù–ò–ï: –î–æ–±–∞–≤–ª–µ–Ω useNavigate

export default function AuthForm() {
    const { login, register: registerUser, error, loading } = useAuthStore();
    const [isRegister, setIsRegister] = useState(false);
    const [showPassword, setShowPassword] = useState(false);
    const [phoneError, setPhoneError] = useState("");
    const [emailError, setEmailError] = useState("");
    const navigate = useNavigate(); // <<< –ò–ó–ú–ï–ù–ï–ù–ò–ï: –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º —Ö—É–∫

    const {
        register: formRegister,
        handleSubmit,
        control,
        formState: { errors, isValid },
        reset
    } = useForm<AuthSchema>({
        resolver: zodResolver(authSchema),
        mode: "onChange",
        defaultValues: {
            privacyPolicyAccepted: false,
            termsAccepted: false,
        }
    });

    const onSubmit = async (data: AuthSchema) => {
        try {
            if (isRegister) {
                if (!data.privacyPolicyAccepted || !data.termsAccepted) {
                    // –≠—Ç–∞ –ø—Ä–æ–≤–µ—Ä–∫–∞ –æ—Å—Ç–∞–µ—Ç—Å—è –Ω–∞ —Å–ª—É—á–∞–π, –µ—Å–ª–∏ Zod –ø–æ –∫–∞–∫–æ–π-—Ç–æ –ø—Ä–∏—á–∏–Ω–µ –±—É–¥–µ—Ç –æ–±–æ–π–¥–µ–Ω
                    throw new Error("–ù–µ–æ–±—Ö–æ–¥–∏–º–æ –ø—Ä–∏–Ω—è—Ç—å —É—Å–ª–æ–≤–∏—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –∏ –ø–æ–ª–∏—Ç–∏–∫—É –∫–æ–Ω—Ñ–∏–¥–µ–Ω—Ü–∏–∞–ª—å–Ω–æ—Å—Ç–∏.");
                }
                await registerUser({
                    email: data.email,
                    password: data.password,
                    full_name: data.fullName ?? "",
                    phone: data.phone,
                    privacy_policy_accepted: data.privacyPolicyAccepted,
                    terms_accepted: data.termsAccepted,
                });
            } else {
                await login(data.email, data.password);
            }
            reset();
        } catch (err) {
            // –û—à–∏–±–∫–∏ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—é—Ç—Å—è –≤ zustand
            console.error("Auth error:", err);
        }
    };

    const validatePhoneRealTime = (value: string) => {
        if (!value) { setPhoneError(""); return; }
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –Ω–æ–º–µ—Ä —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç –º–∞—Å–∫–µ +7 (XXX) XXX-XX-XX
        const phoneRegex = /^\+7 \(\d{3}\) \d{3}-\d{2}-\d{2}$/;
        setPhoneError(phoneRegex.test(value) ? "" : "–í–≤–µ–¥–∏—Ç–µ –ø–æ–ª–Ω—ã–π –Ω–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞");
    };

    const validateEmailRealTime = (value: string) => {
        if (!value) { setEmailError(""); return; }
        const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
        setEmailError(emailRegex.test(value) ? "" : "–í–≤–µ–¥–∏—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π email");
    };

    const toggleMode = () => {
        setIsRegister(!isRegister);
        reset({
            email: '', password: '', fullName: '', phone: '',
            privacyPolicyAccepted: false, termsAccepted: false,
        });
        setPhoneError("");
        setEmailError("");
    };

    const registrationFields = (
        <>
            <div className="grid grid-cols-1 sm:grid-cols-2 gap-4">
                <div>
                    <Label htmlFor="fullName">–§–ò–û *</Label>
                    <div className="relative">
                        <User className="absolute left-3 top-1/2 -translate-y-1/2 h-4 w-4 text-gray-400" />
                        <Input id="fullName" {...formRegister("fullName")} placeholder="–ò–≤–∞–Ω –ò–≤–∞–Ω–æ–≤" className="pl-9" />
                    </div>
                    {errors.fullName && <p className="text-xs text-red-600 mt-1">{errors.fullName.message}</p>}
                </div>
                <div>
                    <Label htmlFor="phone">–¢–µ–ª–µ—Ñ–æ–Ω</Label>
                    <div className="relative">
                        <Phone className="absolute left-3 top-1/2 -translate-y-1/2 h-4 w-4 text-gray-400" />
                        <Controller
                            control={control}
                            name="phone"
                            render={({ field }) => (
                                <PhoneInput
                                    id="phone"
                                    {...field}
                                    placeholder="+7 (___) ___-__-__"
                                    className="pl-9"
                                    error={!!phoneError}
                                    onChange={(e) => {
                                        field.onChange(e);
                                        validatePhoneRealTime(e.target.value);
                                    }}
                                />
                            )}
                        />
                    </div>
                    {(errors.phone || phoneError) && <p className="text-xs text-red-600 mt-1">{phoneError || errors.phone?.message}</p>}
                </div>
            </div>

            <div className="grid grid-cols-1 sm:grid-cols-2 gap-4">
                <div>
                    <Label htmlFor="emailReg">Email *</Label>
                    <div className="relative">
                        <Mail className="absolute left-3 top-1/2 -translate-y-1/2 h-4 w-4 text-gray-400" />
                        <Input
                            id="emailReg" type="email" {...formRegister("email")}
                            placeholder="your@email.com" className="pl-9"
                            onChange={(e) => {
                                formRegister("email").onChange(e);
                                validateEmailRealTime(e.target.value);
                            }}
                        />
                    </div>
                    {(errors.email || emailError) && <p className="text-xs text-red-600 mt-1">{emailError || errors.email?.message}</p>}
                </div>
                <div>
                    <Label htmlFor="passwordReg">–ü–∞—Ä–æ–ª—å *</Label>
                    <div className="relative">
                        <Lock className="absolute left-3 top-1/2 -translate-y-1/2 h-4 w-4 text-gray-400" />
                        <Input id="passwordReg" type={showPassword ? "text" : "password"} {...formRegister("password")} placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" className="pl-9 pr-10" />
                        <Button type="button" variant="ghost" size="icon" className="absolute right-1 top-1/2 -translate-y-1/2 h-8 w-8" onClick={() => setShowPassword(p => !p)}>
                            {showPassword ? <EyeOff className="h-4 w-4" /> : <Eye className="h-4 w-4" />}
                        </Button>
                    </div>
                    {errors.password && <p className="text-xs text-red-600 mt-1">{errors.password.message}</p>}
                </div>
            </div>

            <div className="space-y-3 pt-2">
                <Controller
                    control={control}
                    name="privacyPolicyAccepted"
                    render={({ field }) => (
                        <div className="flex items-start space-x-2">
                            <Checkbox id="privacy" checked={field.value} onCheckedChange={field.onChange} />
                            <div className="grid gap-1.5 leading-none">
                                <Label htmlFor="privacy" className="text-sm font-normal cursor-pointer">
                                    –Ø —Å–æ–≥–ª–∞—Å–µ–Ω —Å <a href="#" onClick={(e) => e.preventDefault()} className="text-sky-600 hover:underline">–ø–æ–ª–∏—Ç–∏–∫–æ–π –æ–±—Ä–∞–±–æ—Ç–∫–∏ –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö</a> *
                                </Label>
                                {errors.privacyPolicyAccepted && <p className="text-xs text-red-600">{errors.privacyPolicyAccepted.message}</p>}
                            </div>
                        </div>
                    )}
                />
                <Controller
                    control={control}
                    name="termsAccepted"
                    render={({ field }) => (
                        <div className="flex items-start space-x-2">
                            <Checkbox id="terms" checked={field.value} onCheckedChange={field.onChange} />
                            <div className="grid gap-1.5 leading-none">
                                <Label htmlFor="terms" className="text-sm font-normal cursor-pointer">
                                    –Ø –ø—Ä–∏–Ω–∏–º–∞—é <a href="#" onClick={(e) => e.preventDefault()} className="text-sky-600 hover:underline">—É—Å–ª–æ–≤–∏—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è —Å–µ—Ä–≤–∏—Å–∞</a> *
                                </Label>
                                {errors.termsAccepted && <p className="text-xs text-red-600">{errors.termsAccepted.message}</p>}
                            </div>
                        </div>
                    )}
                />
            </div>
        </>
    );

    const loginFields = (
        <div className="grid grid-cols-1 sm:grid-cols-2 gap-4">
            <div>
                <Label htmlFor="emailLogin">Email</Label>
                <div className="relative">
                    <Mail className="absolute left-3 top-1/2 -translate-y-1/2 h-4 w-4 text-gray-400" />
                    <Input
                        id="emailLogin" type="email" {...formRegister("email")}
                        placeholder="your@email.com" className="pl-9"
                        onChange={(e) => {
                            formRegister("email").onChange(e);
                            validateEmailRealTime(e.target.value);
                        }}
                    />
                </div>
                {(errors.email || emailError) && <p className="text-xs text-red-600 mt-1">{emailError || errors.email?.message}</p>}
            </div>
            <div>
                <Label htmlFor="passwordLogin">–ü–∞—Ä–æ–ª—å</Label>
                <div className="relative">
                    <Lock className="absolute left-3 top-1/2 -translate-y-1/2 h-4 w-4 text-gray-400" />
                    <Input id="passwordLogin" type={showPassword ? "text" : "password"} {...formRegister("password")} placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" className="pl-9 pr-10" />
                    <Button type="button" variant="ghost" size="icon" className="absolute right-1 top-1/2 -translate-y-1/2 h-8 w-8" onClick={() => setShowPassword(p => !p)}>
                        {showPassword ? <EyeOff className="h-4 w-4" /> : <Eye className="h-4 w-4" />}
                    </Button>
                </div>
                {errors.password && <p className="text-xs text-red-600 mt-1">{errors.password.message}</p>}
            </div>
        </div>
    );

    return (
        <div className="w-full">
            <form onSubmit={handleSubmit(onSubmit)} className="bg-white border border-gray-200 rounded-lg shadow-sm p-6 space-y-6">
                <h2 className="text-xl font-semibold text-center">{isRegister ? "–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è" : "–í—Ö–æ–¥ –≤ –∞–∫–∫–∞—É–Ω—Ç"}</h2>

                {isRegister ? registrationFields : loginFields}

                {error && (
                    <div className="p-3 bg-red-50 border border-red-200 rounded text-sm text-red-600">
                        {error}
                    </div>
                )}

                {/* +++ –ù–ê–ß–ê–õ–û: –ò–∑–º–µ–Ω–µ–Ω–Ω—ã–π –±–ª–æ–∫ –∫–Ω–æ–ø–æ–∫ +++ */}
                <div className="pt-4 border-t space-y-4">
                    <Button type="submit" disabled={!isValid || loading} className="w-full">
                        {loading ? "–ó–∞–≥—Ä—É–∑–∫–∞..." : (isRegister ? <><UserPlus className="mr-2 h-4 w-4" />–ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è</> : <><LogIn className="mr-2 h-4 w-4" />–í–æ–π—Ç–∏</>)}
                    </Button>
                    <div className="flex justify-center items-center gap-4 text-sm">
                        <Button
                            type="button"
                            variant="outline"
                            size="sm"
                            onClick={() => navigate("/calendar")}
                        >
                            <Calendar className="mr-2 h-4 w-4" />
                            –ö–∞–ª–µ–Ω–¥–∞—Ä—å
                        </Button>
                        <Button type="button" variant="link" onClick={toggleMode} className="text-gray-600">
                            {isRegister ? "–£–∂–µ –µ—Å—Ç—å –∞–∫–∫–∞—É–Ω—Ç? –í–æ–π—Ç–∏" : "–ù–µ—Ç –∞–∫–∫–∞—É–Ω—Ç–∞?"}
                        </Button>
                    </div>
                </div>
                {/* +++ –ö–û–ù–ï–¶: –ò–∑–º–µ–Ω–µ–Ω–Ω—ã–π –±–ª–æ–∫ –∫–Ω–æ–ø–æ–∫ +++ */}
            </form>
        </div>
    );
}

```


## <a name="srccomponentsAuthStatustsx"></a>`src/components/AuthStatus.tsx`

```tsx
// path: src/components/AuthStatus.tsx

import { useCurrentUser } from "@/hooks/useProfile";
import { useAuthStore } from "@/store/authStore";

export default function AuthStatus() {
    const { data: user, isLoading, isError } = useCurrentUser();
    const { logout } = useAuthStore();

    if (isLoading) {
        return (
            <div className="bg-gray-50 border border-gray-200 rounded-md p-2 mb-2">
                <div className="flex items-center justify-center">
                    <div className="animate-spin rounded-full h-3 w-3 border-b-2 border-gray-400 mr-2"></div>
                    <span className="text-xs text-gray-500">–ü—Ä–æ–≤–µ—Ä–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏...</span>
                </div>
            </div>
        );
    }

    if (isError) {
        return (
            <div className="bg-gray-50 border border-gray-200 rounded-md p-2 mb-2">
                <div className="flex items-center justify-between">
                    <span className="text-xs text-gray-500">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ø—Ä–æ—Ñ–∏–ª—è</span>
                    <button
                        onClick={logout}
                        className="text-xs text-gray-400 hover:text-gray-600 underline"
                    >
                        –í—ã–π—Ç–∏
                    </button>
                </div>
            </div>
        );
    }

    if (!user) {
        return (
            <div className="bg-gray-50 border border-gray-200 rounded-md p-2 mb-2">
                <div className="flex items-center justify-center">
                    <span className="text-xs text-gray-500">–í–æ–π–¥–∏—Ç–µ –≤ —Å–∏—Å—Ç–µ–º—É –¥–ª—è –¥–æ—Å—Ç—É–ø–∞ –∫ –ø–æ–ª–Ω–æ–º—É —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—É</span>
                </div>
            </div>
        );
    }

    return null; // –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω, –Ω–∏—á–µ–≥–æ –Ω–µ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º
} 

```


## <a name="srccomponentsAvailabilityStriptsx"></a>`src/components/AvailabilityStrip.tsx`

```tsx
// path: src/components/AvailabilityStrip.tsx

// src/components/AvailabilityStrip.tsx

import { useState } from 'react';
import { Popover, PopoverContent, PopoverAnchor } from '@/components/ui/popover';
import { useDateStore } from '@/store/dateStore';
import type { DayStatus } from '@/types/availability';
import { format } from 'date-fns';
import { ru } from 'date-fns/locale';
import { Button } from './ui/button';
import { useHolidayStore } from '@/store/holidayStore';
import { DateService } from '@/core/services/DateService';
import { toast } from 'sonner';

interface AvailabilityStripProps {
    dailyStatus?: Record<string, DayStatus>;
}

const cellColorMap: Record<string, string> = {
    available: 'bg-green-500 hover:bg-green-600',
    reserved: 'bg-yellow-500 hover:bg-yellow-600',
    rented: 'bg-red-500 hover:bg-red-600',
    default: 'bg-gray-400 hover:bg-gray-500'
};

type PopoverData = {
    date: Date;
    status: string;
};

export default function AvailabilityStrip({ dailyStatus = {} }: AvailabilityStripProps) {
    const { setRange } = useDateStore();
    const holidays = useHolidayStore((state) => state.holidays);

    const [isPopoverOpen, setPopoverOpen] = useState(false);
    const [popoverData, setPopoverData] = useState<PopoverData | null>(null);

    const today = new Date();
    today.setHours(0, 0, 0, 0);

    const dates = Array.from({ length: 30 }, (_, i) => {
        const date = new Date();
        date.setDate(today.getDate() + i);
        return date;
    });

    const handleCellClick = (date: Date, status: string) => {
        setPopoverData({ date, status });
        setPopoverOpen(true);
    };

    // +++ –ù–ê–ß–ê–õ–û: –û–ë–ù–û–í–õ–ï–ù–ù–ê–Ø –õ–û–ì–ò–ö–ê –û–ë–†–ê–ë–û–¢–ß–ò–ö–ê +++
    const handleSetAsStartDate = () => {
        if (!popoverData) return;

        const originalStartDate = popoverData.date;

        // 1. –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å–¥–≤–∏–≥–∞–µ–º –¥–∞—Ç—É, –µ—Å–ª–∏ –æ–Ω–∞ –ø–æ–ø–∞–ª–∞ –Ω–∞ –≤—ã—Ö–æ–¥–Ω–æ–π
        const adjustedStartDate = DateService.adjustDateIfHoliday(originalStartDate, holidays);

        // 2. –†–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ–º –¥–∞—Ç—É –æ–∫–æ–Ω—á–∞–Ω–∏—è –æ—Ç *—Å–∫–æ—Ä—Ä–µ–∫—Ç–∏—Ä–æ–≤–∞–Ω–Ω–æ–π* –¥–∞—Ç—ã –Ω–∞—á–∞–ª–∞
        const finalEndDate = DateService.findNextWorkingDay(adjustedStartDate, holidays, 1);

        // 3. –ü—Ä–æ–≤–µ—Ä—è–µ–º, –±—ã–ª–∞ –ª–∏ –¥–∞—Ç–∞ –Ω–∞—á–∞–ª–∞ –∏–∑–º–µ–Ω–µ–Ω–∞
        if (adjustedStartDate.getTime() !== originalStartDate.getTime()) {
            // 4. –ï—Å–ª–∏ –¥–∞ - –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ
            toast.info(`–î–∞—Ç–∞ –Ω–∞—á–∞–ª–∞ —Å–¥–≤–∏–Ω—É—Ç–∞ —Å ${format(originalStartDate, 'dd.MM.yyyy')} –Ω–∞ ${format(adjustedStartDate, 'dd.MM.yyyy')}, —Ç–∞–∫ –∫–∞–∫ –≤—ã–±—Ä–∞–Ω–Ω—ã–π –¥–µ–Ω—å —è–≤–ª—è–µ—Ç—Å—è –≤—ã—Ö–æ–¥–Ω—ã–º.`);
        }

        // 5. –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –Ω–æ–≤—ã–π, –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π –¥–∏–∞–ø–∞–∑–æ–Ω –¥–∞—Ç
        setRange(adjustedStartDate, finalEndDate);
        setPopoverOpen(false);
    };
    // +++ –ö–û–ù–ï–¶: –û–ë–ù–û–í–õ–ï–ù–ù–ê–Ø –õ–û–ì–ò–ö–ê –û–ë–†–ê–ë–û–¢–ß–ò–ö–ê +++

    const statusTextMap: Record<string, string> = {
        available: '–°–≤–æ–±–æ–¥–Ω–æ',
        reserved: '–í —Ä–µ–∑–µ—Ä–≤–µ',
        rented: '–í –∞—Ä–µ–Ω–¥–µ',
        default: '–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö'
    };

    return (
        <Popover open={isPopoverOpen} onOpenChange={setPopoverOpen}>
            <PopoverAnchor asChild>
                <div
                    className="w-full h-3 mt-auto flex rounded-sm overflow-hidden border border-gray-400 cursor-pointer"
                    title="–ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å –∏ –≤—ã–±—Ä–∞—Ç—å –¥–∞—Ç—ã"
                >
                    {dates.map(date => {
                        const dateStr = format(date, 'dd.MM.yyyy');
                        const status = dailyStatus[dateStr]?.status ?? 'available';
                        const color = cellColorMap[status] ?? cellColorMap.default;

                        return (
                            <button
                                key={dateStr}
                                className={`flex-1 h-full transition-colors focus:outline-none focus:ring-2 focus:ring-sky-500 z-10 ${color}`}
                                onClick={() => handleCellClick(date, status)}
                                aria-label={`–°—Ç–∞—Ç—É—Å –Ω–∞ ${dateStr}: ${statusTextMap[status]}`}
                            />
                        );
                    })}
                </div>
            </PopoverAnchor>

            <PopoverContent
                className="w-auto p-3 bg-white border rounded-md shadow-lg text-sm"
                side="bottom"
                align="center"
                onCloseAutoFocus={(e) => e.preventDefault()}
                sideOffset={5}
            >
                {popoverData && (
                    <div className="space-y-2">
                        <p>
                            <strong>–î–∞—Ç–∞:</strong> {format(popoverData.date, "PPP", { locale: ru })}
                        </p>
                        <p>
                            <strong>–°—Ç–∞—Ç—É—Å:</strong> {statusTextMap[popoverData.status] ?? '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ'}
                        </p>
                        {popoverData.status === 'available' && (
                            <Button
                                size="sm"
                                className="mt-2 w-full"
                                onClick={handleSetAsStartDate}
                            >
                                –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –¥–∞—Ç–æ–π –Ω–∞—á–∞–ª–∞ —Ä–µ–∑–µ—Ä–≤–∞
                            </Button>
                        )}
                    </div>
                )}
            </PopoverContent>
        </Popover>
    );
}

```


## <a name="srccomponentsAvailableCheckboxtsx"></a>`src/components/AvailableCheckbox.tsx`

```tsx
// path: src/components/AvailableCheckbox.tsx

import { Checkbox } from "@/components/ui/checkbox"
import { useFilterStore } from "@/store/filterStore"
import { Label } from "@/components/ui/label"

export default function AvailableCheckbox() {
  const { availableOnly, setAvailableOnly } = useFilterStore()

  return (
    <div className="flex items-center space-x-2">
      <Checkbox
        id="available-only"
        checked={availableOnly}
        onCheckedChange={(checked) => setAvailableOnly(Boolean(checked))}
      />
      <Label htmlFor="available-only">–¢–æ–ª—å–∫–æ –¥–æ—Å—Ç—É–ø–Ω–æ–µ</Label>
    </div>
  )
}


```


## <a name="srccomponentsBrandFiltertsx"></a>`src/components/BrandFilter.tsx`

```tsx
// path: src/components/BrandFilter.tsx

// src/components/BrandFilter.tsx
import { useMemo } from "react"
import { useFilterStore } from "@/store/filterStore"
import type { Equipment } from "@/types/equipment"
import {
    Select,
    SelectContent,
    SelectItem,
    SelectTrigger,
    SelectValue,
} from "@/components/ui/select"

interface BrandFilterProps {
    items: Equipment[]
}

export default function BrandFilter({ items }: BrandFilterProps) {
    const { brand, setBrand } = useFilterStore()

    const brands = useMemo(() => {
        const set = new Set(items.map((i) => i.brand))
        return Array.from(set)
    }, [items])

    return (
        <Select value={brand} onValueChange={setBrand}>
            <SelectTrigger className="w-[200px] border border-sky-300 shadow-sm hover:shadow-md">
                <SelectValue placeholder="–í—Å–µ –±—Ä–µ–Ω–¥—ã" />
            </SelectTrigger>
            <SelectContent>
                <SelectItem value="__all__">–í—Å–µ –±—Ä–µ–Ω–¥—ã</SelectItem>
                {brands.map((b) => (
                    <SelectItem key={b} value={b}>
                        {b}
                    </SelectItem>
                ))}
            </SelectContent>
        </Select>
    )
}


```


## <a name="srccomponentsCancelReservationDialogtsx"></a>`src/components/CancelReservationDialog.tsx`

```tsx
// path: src/components/CancelReservationDialog.tsx

// src/components/CancelReservationDialog.tsx
import {
    Dialog,
    DialogContent,
    DialogHeader,
    DialogTitle, // –ò–º–ø–æ—Ä—Ç–∏—Ä—É–µ–º DialogTitle
    DialogDescription, // –ò–º–ø–æ—Ä—Ç–∏—Ä—É–µ–º DialogDescription
    DialogFooter,
} from "@/components/ui/dialog";
import { Button } from "@/components/ui/button";

type Props = {
    open: boolean;
    onClose: () => void;
    onConfirm: () => void;
};

export default function CancelReservationDialog({ open, onClose, onConfirm }: Props) {
    return (
        <Dialog open={open} onOpenChange={onClose}>
            <DialogContent>
                <DialogHeader>
                    {/* üëá –ò–°–ü–û–õ–¨–ó–£–ï–ú DialogTitle –≤–º–µ—Å—Ç–æ h2 */}
                    <DialogTitle className="text-lg font-semibold">–û—Ç–º–µ–Ω–∏—Ç—å –æ—Ñ–æ—Ä–º–ª–µ–Ω–∏–µ?</DialogTitle>
                </DialogHeader>
                {/* üëá –ò–°–ü–û–õ–¨–ó–£–ï–ú DialogDescription –≤–º–µ—Å—Ç–æ p */}
                <DialogDescription className="text-sm text-gray-600">
                    –í—Å–µ –≤—ã–±—Ä–∞–Ω–Ω—ã–µ –ø–æ–∑–∏—Ü–∏–∏ –±—É–¥—É—Ç —É–¥–∞–ª–µ–Ω—ã, –∞ –≤—ã –≤–µ—Ä–Ω—ë—Ç–µ—Å—å –Ω–∞ –≥–ª–∞–≤–Ω—É—é —Å—Ç—Ä–∞–Ω–∏—Ü—É.
                </DialogDescription>
                <DialogFooter className="pt-4">
                    <Button variant="ghost" onClick={onClose}>
                        –û—Ç–º–µ–Ω–∞
                    </Button>
                    <Button
                        className="bg-red-700 hover:bg-red-800 text-white"
                        onClick={onConfirm}
                    >
                        –ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å –æ—Ç–º–µ–Ω—É
                    </Button>
                </DialogFooter>
            </DialogContent>
        </Dialog>
    );
}

```


## <a name="srccomponentsCardShelltsx"></a>`src/components/CardShell.tsx`

```tsx
// path: src/components/CardShell.tsx

import { Card, CardContent, CardFooter, CardHeader } from "@/components/ui/card"
import { ReactNode } from "react"

type Props = {
    title: string
    status?: ReactNode
    children: ReactNode
    footer?: ReactNode
    className?: string
}

export default function CardShell({ title, status, children, footer, className = "" }: Props) {
    return (
        <Card className={`w-full rounded-xl border shadow-sm hover:shadow-md transition ${className}`}>
            <CardHeader className="flex justify-between items-start">
                <h3 className="text-lg font-semibold">{title}</h3>
                {status && <div>{status}</div>}
            </CardHeader>
            <CardContent className="space-y-2 text-sm text-gray-700">
                {children}
            </CardContent>
            {footer && <CardFooter className="pt-2">{footer}</CardFooter>}
        </Card>
    )
}


```


## <a name="srccomponentsCompactEquipmentCardtsx"></a>`src/components/CompactEquipmentCard.tsx`

```tsx
// path: src/components/CompactEquipmentCard.tsx

// src/components/CompactEquipmentCard.tsx

import React, { useMemo, useCallback } from "react";
import { CheckCircle } from "lucide-react";
import { useReserveStore } from "@/store/reserveStore";
import { useDateStore } from "@/store/dateStore";
import { useSandboxCalculatorStore } from "@/store/sandboxCalculatorStore";
import { usePromoCodeStore } from "@/store/promoCodeStore";
import { formatDateRangeEuropean } from "@/lib/utils";

// –¢–∏–ø—ã
import type { Equipment } from "@/types/equipment";
import type { DayStatus, EquipmentStatus } from "@/types/availability";

interface CompactEquipmentCardProps {
    equipment: Equipment;
    status?: EquipmentStatus | "my_reservation" | "added";
    startDate?: string;
    endDate?: string;
    dailyStatus?: Record<string, DayStatus>;
}

// --- –ù–ê–ß–ê–õ–û –ò–ó–ú–ï–ù–ï–ù–ò–ô ---

// 1. –£–ø—Ä–æ—â–∞–µ–º —Å—Ç–∏–ª–∏, —É–¥–∞–ª—è—è `ending_today`
const COMPACT_STATUS_STYLES: Record<EquipmentStatus | "my_reservation" | "added", string> = {
    available: "bg-white border-gray-200 hover:bg-gray-50",
    reserved: "bg-rose-100 border-rose-300",
    rented: "bg-red-200 border-red-400",
    my_reservation: "bg-sky-50 border-sky-200 hover:bg-sky-100",
    added: "bg-green-100 border-green-300",
};
// --- –ö–û–ù–ï–¶ –ò–ó–ú–ï–ù–ï–ù–ò–ô ---

const COMPACT_SELECTED_STYLES = "ring-2 ring-offset-1 ring-green-500 border-green-500 bg-green-100";

const CompactEquipmentCardComponent: React.FC<CompactEquipmentCardProps> = ({
                                                                       equipment,
                                                                       status = "available",
                                                                       startDate,
                                                                       endDate,
                                                                   }) => {
    const { toggle, isSelected, selectedAccessories } = useReserveStore();
    const { dayCount } = useDateStore();
    const { durationDiscountPercentage } = useSandboxCalculatorStore();
    const { promoCodePercentage } = usePromoCodeStore();
    const isSelectedByUser = isSelected(equipment.id);

    const accessoriesDailyRate = useMemo(() => {
        const selectedForThisCard = selectedAccessories[equipment.id] || [];
        return equipment.accessories?.reduce((total, acc) =>
            selectedForThisCard.includes(acc.id) ? total + acc.price : total, 0) ?? 0;
    }, [equipment.accessories, equipment.id, selectedAccessories]);

    const totalDiscountPercentage = useMemo(() =>
            durationDiscountPercentage + promoCodePercentage,
        [durationDiscountPercentage, promoCodePercentage]
    );

    const priceData = useMemo(() => {
        const totalDailyRate = equipment.daily_rate + accessoriesDailyRate;
        const priceBefore = totalDailyRate * dayCount;
        const priceAfter = priceBefore * (1 - totalDiscountPercentage / 100);

        return {
            dailyRate: totalDailyRate,
            totalPrice: priceAfter,
            discountPercentage: totalDiscountPercentage,
            days: dayCount,
        };
    }, [equipment.daily_rate, accessoriesDailyRate, dayCount, totalDiscountPercentage]);

    // --- –ù–ê–ß–ê–õ–û –ò–ó–ú–ï–ù–ï–ù–ò–ô: –£–¥–∞–ª—è–µ–º useMemo –¥–ª—è finalStatus ---
    // const finalStatus: DisplayStatus = useMemo(() => { ... }); // –≠–¢–û–¢ –ë–õ–û–ö –ü–û–õ–ù–û–°–¢–¨–Æ –£–î–ê–õ–ï–ù
    // --- –ö–û–ù–ï–¶ –ò–ó–ú–ï–ù–ï–ù–ò–ô ---

    const handleCardClick = useCallback((e: React.MouseEvent<HTMLDivElement>) => {
        if ((e.target as HTMLElement).closest("button, a, label, input[type='checkbox']")) return;
        // --- –ò–ó–ú–ï–ù–ï–ù–ò–ï: –ò—Å–ø–æ–ª—å–∑—É–µ–º `status` –Ω–∞–ø—Ä—è–º—É—é ---
        if (status === 'available' || status === 'added') {
            toggle(equipment);
        }
    }, [status, toggle, equipment]);

    const handleDoubleClick = useCallback((e: React.MouseEvent<HTMLDivElement>) => {
        if ((e.target as HTMLElement).closest("button, a, label, input[type='checkbox']")) return;
        // --- –ò–ó–ú–ï–ù–ï–ù–ò–ï: –ò—Å–ø–æ–ª—å–∑—É–µ–º `status` –Ω–∞–ø—Ä—è–º—É—é ---
        if (status === 'available' || status === 'added') {
            toggle(equipment);
        }
    }, [status, toggle, equipment]);

    // --- –ò–ó–ú–ï–ù–ï–ù–ò–ï: –ò—Å–ø–æ–ª—å–∑—É–µ–º `status` –¥–ª—è –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è —Å—Ç–∏–ª—è ---
    const backgroundClass = isSelectedByUser
        ? COMPACT_SELECTED_STYLES
        : COMPACT_STATUS_STYLES[status];

    const dateRangeDisplay = (startDate && endDate)
        ? `(${formatDateRangeEuropean(startDate, endDate)})`
        : "";

    return (
        <div
            className={`relative p-3 rounded-lg border transition-all duration-200 cursor-pointer ${backgroundClass}`}
            onClick={handleCardClick}
            onDoubleClick={handleDoubleClick}
            tabIndex={0}
        >
            {isSelectedByUser && (
                <div className="absolute top-1 right-1 z-10 bg-green-600 text-white rounded-full p-0.5 shadow">
                    <CheckCircle className="w-3 h-3" />
                </div>
            )}

            <div className="space-y-2">
                <div className="space-y-1">
                    <h3 className="text-sm font-semibold text-gray-900 truncate" title={equipment.name}>
                        {equipment.name}
                    </h3>
                    <p className="text-xs text-gray-500">
                        {equipment.brand} ‚Ä¢ {equipment.equipment_type}
                    </p>
                    {dateRangeDisplay && (
                        <p className="text-xs text-gray-400">{dateRangeDisplay}</p>
                    )}
                </div>

                <div className="space-y-1">
                    <div className="flex justify-between items-center">
                        <span className="text-xs text-gray-600">
                            {priceData.days} {priceData.days === 1 ? '–¥–µ–Ω—å' : priceData.days < 5 ? '–¥–Ω—è' : '–¥–Ω–µ–π'}
                        </span>
                        <span className="text-sm font-semibold text-gray-900">
                            {priceData.totalPrice.toLocaleString('ru-RU')} ‚ÇΩ
                        </span>
                    </div>

                    {priceData.discountPercentage > 0 && (
                        <div className="text-xs text-green-600">
                            –°–∫–∏–¥–∫–∞: {priceData.discountPercentage.toFixed(0)}%
                        </div>
                    )}
                </div>

                {/* --- –ù–ê–ß–ê–õ–û –ò–ó–ú–ï–ù–ï–ù–ò–ô: –£–ø—Ä–æ—â–µ–Ω–Ω—ã–π –±–ª–æ–∫ —Å—Ç–∞—Ç—É—Å–∞ --- */}
                <div className="text-xs">
                    {status === 'available' && (
                        <span className="text-green-600 font-medium">–°–≤–æ–±–æ–¥–Ω–æ</span>
                    )}
                    {status === 'reserved' && (
                        <span className="text-red-600 font-medium">–í —Ä–µ–∑–µ—Ä–≤–µ</span>
                    )}
                    {status === 'rented' && (
                        <span className="text-red-700 font-medium">–í –∞—Ä–µ–Ω–¥–µ</span>
                    )}
                    {status === 'my_reservation' && (
                        <span className="text-sky-600 font-medium">–í —ç—Ç–æ–º —Ä–µ–∑–µ—Ä–≤–µ</span>
                    )}
                    {status === 'added' && (
                        <span className="text-emerald-600 font-medium">–î–æ–±–∞–≤–ª–µ–Ω–æ</span>
                    )}
                </div>
                {/* --- –ö–û–ù–ï–¶ –ò–ó–ú–ï–ù–ï–ù–ò–ô --- */}
            </div>
        </div>
    );
};

// –ú–µ–º–æ–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω–∞—è –≤–µ—Ä—Å–∏—è –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–∞ –¥–ª—è –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏
const CompactEquipmentCard = React.memo(CompactEquipmentCardComponent);

export default CompactEquipmentCard;

```


## <a name="srccomponentsConfirmItemRemovalDialogtsx"></a>`src/components/ConfirmItemRemovalDialog.tsx`

```tsx
// path: src/components/ConfirmItemRemovalDialog.tsx

// src/components/ConfirmItemRemovalDialog.tsx
import {
    Dialog,
    DialogContent,
    DialogHeader,
    DialogTitle,
    DialogDescription,
    DialogFooter,
} from "@/components/ui/dialog";
import { Button } from "@/components/ui/button";

type Props = {
    open: boolean;
    onClose: () => void;
    onConfirm: () => void;
    isConfirming: boolean;
    variant?: 'removeItem' | 'cancelReservation'; // ‚ú® –ù–û–í–´–ô –ü–†–û–ü–°
};

export default function ConfirmItemRemovalDialog({
                                                     open,
                                                     onClose,
                                                     onConfirm,
                                                     isConfirming,
                                                     variant = 'removeItem' // ‚ú® –ó–ù–ê–ß–ï–ù–ò–ï –ü–û –£–ú–û–õ–ß–ê–ù–ò–Æ
                                                 }: Props) {

    // ‚ú® –ö–û–ù–¢–ï–ù–¢ –î–õ–Ø –†–ê–ó–ù–´–• –í–ê–†–ò–ê–ù–¢–û–í –î–ò–ê–õ–û–ì–ê
    const content = {
        removeItem: {
            title: "–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç–µ –¥–µ–π—Å—Ç–≤–∏–µ",
            description: "–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å —ç—Ç—É –ø–æ–∑–∏—Ü–∏—é –∏–∑ —Ä–µ–∑–µ—Ä–≤–∞?",
            cancelText: "–û—Ç–º–µ–Ω–∞",
            confirmText: "–£–¥–∞–ª–∏—Ç—å",
            confirmLoadingText: "–£–¥–∞–ª–µ–Ω–∏–µ..."
        },
        cancelReservation: {
            title: "–£–¥–∞–ª–µ–Ω–∏–µ –ø–æ—Å–ª–µ–¥–Ω–µ–π –ø–æ–∑–∏—Ü–∏–∏",
            description: "–í—ã —É–¥–∞–ª–∏–ª–∏ –ø–æ—Å–ª–µ–¥–Ω—é—é –ø–æ–∑–∏—Ü–∏—é. –•–æ—Ç–∏—Ç–µ –æ—Ç–º–µ–Ω–∏—Ç—å —Ä–µ–∑–µ—Ä–≤ –ø–æ–ª–Ω–æ—Å—Ç—å—é?",
            cancelText: "–í–µ—Ä–Ω—É—Ç—å—Å—è –∫ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—é",
            confirmText: "–û—Ç–º–µ–Ω–∏—Ç—å —Ä–µ–∑–µ—Ä–≤",
            confirmLoadingText: "–û—Ç–º–µ–Ω–∞..."
        }
    }[variant];

    return (
        <Dialog open={open} onOpenChange={onClose}>
            <DialogContent>
                <DialogHeader>
                    <DialogTitle>{content.title}</DialogTitle>
                </DialogHeader>
                <DialogDescription>{content.description}</DialogDescription>
                <DialogFooter className="pt-4">
                    <Button variant="ghost" onClick={onClose} disabled={isConfirming}>
                        {content.cancelText}
                    </Button>
                    <Button
                        variant="destructive"
                        onClick={onConfirm}
                        disabled={isConfirming}
                    >
                        {isConfirming ? content.confirmLoadingText : content.confirmText}
                    </Button>
                </DialogFooter>
            </DialogContent>
        </Dialog>
    );
}

```


## <a name="srccomponentsDateRangeSelectortsx"></a>`src/components/DateRangeSelector.tsx`

```tsx
// path: src/components/DateRangeSelector.tsx

// src/components/DateRangeSelector.tsx

import { useState, type RefObject, useCallback, useEffect, useRef } from 'react';
import { DayPicker, type DateRange } from 'react-day-picker';
import { ru } from 'date-fns/locale';
import { format, addMonths, startOfMonth, endOfMonth } from 'date-fns';
import { ChevronsDown, ChevronsUp } from "lucide-react";
import { useDateStore } from "@/store/dateStore";
import { useSandboxCalculatorStore } from "@/store/sandboxCalculatorStore";
import { useDateRange } from "@/hooks/useDateRange";
import { useHolidayStore } from "@/store/holidayStore";
import { DateService } from '@/core/services/DateService';

interface DateRangeSelectorProps {
    containerRef: RefObject<HTMLDivElement | null>;
}

export default function DateRangeSelector({ containerRef }: DateRangeSelectorProps) {
    const { startDate, endDate, setRange } = useDateStore();
    const { isCalculatorVisible, syncWithDateStore, refreshCalculator } = useSandboxCalculatorStore();

    const [collapsed, setCollapsed] = useState(true);
    const [month, setMonth] = useState(startDate);

    const lastChangeSource = useRef<'calendar' | 'slider' | 'manual' | null>(null);
    const [isAutoUpdating, setIsAutoUpdating] = useState(false);

    const { holidays, fetchHolidays } = useHolidayStore();

    useEffect(() => {
        const firstDayToFetch = startOfMonth(addMonths(month, -1));
        const lastDayToFetch = endOfMonth(addMonths(month, 2));
        void fetchHolidays(firstDayToFetch, lastDayToFetch);
    }, [month, fetchHolidays]);

    // ‚úÖ –ù–û–í–û–ï: –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä—É–µ–º –∫–∞–ª—å–∫—É–ª—è—Ç–æ—Ä –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ –≤—ã—Ö–æ–¥–Ω—ã—Ö –¥–Ω–µ–π
    useEffect(() => {
        if (holidays.length > 0) {
            refreshCalculator();
        }
    }, [holidays, refreshCalculator]);

    // ‚úÖ –ù–û–í–û–ï: –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä—É–µ–º –∫–∞–ª—å–∫—É–ª—è—Ç–æ—Ä –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ –¥–Ω–µ–π
    useEffect(() => {
        const { dayCount } = useDateStore.getState();
        if (dayCount > 0) {
            syncWithDateStore();
        }
    }, [startDate, endDate, syncWithDateStore]);

    const handleRangeChange = useCallback((newStart: Date, newEnd: Date, source?: 'calendar' | 'slider' | 'manual') => {
        lastChangeSource.current = source || 'manual';

        if (source === 'slider') {
            setIsAutoUpdating(true);
            setTimeout(() => setIsAutoUpdating(false), 1000);
        }

        setRange(newStart, newEnd, source, holidays);

        if (source !== 'slider') {
            syncWithDateStore();
        }
    }, [holidays, setRange, syncWithDateStore]);

    useEffect(() => {
        if (lastChangeSource.current === 'slider') {
            lastChangeSource.current = null;
            return;
        }

        lastChangeSource.current = null;
    }, [startDate, endDate]);

    const {
        localStartDate,
        localEndDate,
        handleStartDateChange,
        handleEndDateChange,
    } = useDateRange({
        startDate,
        endDate,
        onRangeChange: handleRangeChange,
        holidays
    });

    const handleSelect = (selectedRange: DateRange | undefined) => {
        if (!selectedRange?.from) return;

        const selectionStartDate = selectedRange.from;
        const finalEndDate = selectedRange.to ?? DateService.findNextWorkingDay(selectionStartDate, holidays, 1);

        const finalRange = { from: selectionStartDate, to: finalEndDate };

        if (finalRange.from && finalRange.to) {
            const { dayCount } = useDateStore.getState();
            const willCalculatorAppear = !isCalculatorVisible && dayCount >= 4;

            if (willCalculatorAppear && containerRef.current) {
                containerRef.current.style.overflowAnchor = 'none';
            }

            handleRangeChange(finalRange.from, finalRange.to, 'calendar');

            if (willCalculatorAppear && containerRef.current) {
                setTimeout(() => {
                    if (containerRef.current) containerRef.current.style.overflowAnchor = 'auto';
                }, 0);
            }
        }
    };

    const today = new Date();
    today.setHours(0, 0, 0, 0);

    const disabledDays = [
        ...holidays,
        { before: today }
    ];

    function formatDateForInput(date: Date): string {
        const year = date.getFullYear();
        const month = String(date.getMonth() + 1).padStart(2, "0");
        const day = String(date.getDate()).padStart(2, "0");
        return `${year}-${month}-${day}`;
    }

    const minEndDate = (() => {
        const start = new Date(localStartDate);
        const timezoneOffset = start.getTimezoneOffset() * 60000;
        const startUTC = new Date(start.getTime() + timezoneOffset);
        startUTC.setDate(startUTC.getDate() + 1);
        return formatDateForInput(startUTC);
    })();

    return (
        <div className="mb-4 border rounded-md p-4 bg-white shadow-sm">
            <div className="flex justify-between items-center mb-2">
                <h2 className="text-base font-semibold text-gray-700">–í—ã–±–∏—Ä–∞–π—Ç–µ –¥–∞—Ç—ã –Ω–∞—á–∞–ª–∞ –∏ –æ–∫–æ–Ω—á–∞–Ω–∏—è –∞—Ä–µ–Ω–¥—ã:</h2>
                <button
                    onClick={() => setCollapsed(!collapsed)}
                    className="text-gray-600 hover:text-gray-800 transition p-1"
                    title={collapsed ? "–†–∞–∑–≤–µ—Ä–Ω—É—Ç—å –∫–∞–ª–µ–Ω–¥–∞—Ä—å" : "–°–≤–µ—Ä–Ω—É—Ç—å –∫–∞–ª–µ–Ω–¥–∞—Ä—å"}
                >
                    {collapsed ? <ChevronsDown className="w-5 h-5" /> : <ChevronsUp className="w-5 h-5" />}
                </button>
            </div>

            {collapsed ? (
                    <div
                        className="flex justify-center items-center gap-4 mt-4 cursor-pointer group"
                        onClick={() => setCollapsed(false)}
                        title="–ù–∞–∂–º–∏—Ç–µ, —á—Ç–æ–±—ã –∏–∑–º–µ–Ω–∏—Ç—å –¥–∞—Ç—ã"
                    >
                        <div className="text-center p-3 rounded-lg bg-sky-50 border-2 border-sky-200 w-40 transition-all group-hover:border-sky-400 group-hover:shadow-lg">
                            <div className="text-sm font-medium text-sky-700">–ù–∞—á–∞–ª–æ</div>
                            <div className="text-4xl font-bold text-sky-900 leading-tight">{format(startDate, "dd")}</div>
                            <div className="text-lg font-semibold text-sky-800 capitalize">{format(startDate, "LLLL", { locale: ru })}</div>
                            <div className="text-sm text-sky-600">{format(startDate, "yyyy")}</div>
                        </div>
                        <div className="text-3xl font-light text-gray-300 pb-8">-</div>
                        <div className={`text-center p-3 rounded-lg w-40 transition-all group-hover:shadow-lg ${
                            isAutoUpdating
                                ? 'bg-green-50 border-2 border-green-300 animate-pulse'
                                : 'bg-sky-50 border-2 border-sky-200 group-hover:border-sky-400'
                        }`}>
                            <div className="text-sm font-medium text-sky-700">
                                {isAutoUpdating ? '–û–±–Ω–æ–≤–ª—è–µ—Ç—Å—è...' : '–û–∫–æ–Ω—á–∞–Ω–∏–µ'}
                            </div>
                            <div className="text-4xl font-bold text-sky-900 leading-tight">{format(endDate, "dd")}</div>
                            <div className="text-lg font-semibold text-sky-800 capitalize">{format(endDate, "LLLL", { locale: ru })}</div>
                            <div className="text-sm text-sky-600">{format(endDate, "yyyy")}</div>
                        </div>
                    </div>
                ) :
                <>
                    <div className="flex justify-center mb-4">
                        <DayPicker
                            mode="range"
                            locale={ru}
                            selected={{ from: startDate, to: endDate }}
                            onSelect={handleSelect}
                            month={month}
                            onMonthChange={setMonth}
                            showOutsideDays
                            numberOfMonths={2}
                            disabled={disabledDays}
                            min={2}
                            modifiers={{ holiday: holidays }}
                            classNames={{
                                months: 'flex flex-col sm:flex-row space-y-4 sm:space-x-4 sm:space-y-0',
                                month: 'space-y-4',
                                table: 'w-full border-collapse space-y-1',
                                head_row: 'flex',
                                head_cell: 'text-muted-foreground rounded-md w-9 font-normal text-[0.8rem]',
                                row: 'flex w-full mt-2',
                                cell: 'h-9 w-9 text-center text-sm p-0 relative [&:has([aria-selected])]:bg-accent first:[&:has([aria-selected])]:rounded-l-md last:[&:has([aria-selected])]:rounded-r-md focus-within:relative focus-within:z-20',
                                day: 'h-9 w-9 p-0 font-normal aria-selected:opacity-100',
                                nav: 'space-x-1 flex items-center',
                                caption: 'flex justify-center pt-1 relative items-center',
                                caption_label: 'text-sm font-medium',
                                nav_button: 'h-7 w-7 bg-transparent p-0 opacity-50 hover:opacity-100'
                            }}
                            modifiersClassNames={{
                                today: 'bg-accent text-accent-foreground',
                                selected: 'bg-sky-600 text-white hover:bg-sky-600 hover:text-white focus:bg-sky-600 focus:text-white',
                                range_start: 'rounded-l-full',
                                range_end: 'rounded-r-full',
                                range_middle: 'aria-selected:bg-sky-100 aria-selected:text-sky-900',
                                outside: 'day-outside text-muted-foreground opacity-50',
                                disabled: 'text-muted-foreground opacity-50 cursor-not-allowed',
                                holiday: 'text-red-600 bg-red-50 border-red-200 font-bold',
                            }}
                        />
                    </div>
                    <div className="flex flex-col sm:flex-row gap-4 justify-center">
                        <label className="text-sm text-gray-700">
                            –°:
                            <input
                                type="date"
                                value={localStartDate}
                                onChange={handleStartDateChange}
                                className="ml-2 border border-gray-300 rounded px-2 py-1 text-sm"
                                min={formatDateForInput(new Date())}
                            />
                        </label>
                        <label className="text-sm text-gray-700">
                            –ü–æ:
                            <input
                                type="date"
                                value={localEndDate}
                                onChange={handleEndDateChange}
                                className="ml-2 border border-gray-300 rounded px-2 py-1 text-sm"
                                min={minEndDate}
                            />
                        </label>
                    </div>
                </>
            }
        </div>
    );
}

```


## <a name="srccomponentsDateRangeSelectorcalendarcss"></a>`src/components/DateRangeSelector/calendar.css`

```css
// path: src/components/DateRangeSelector/calendar.css

/* src/components/DateRangeSelector/calendar.css */

/* –û–±—â–∏–µ —Å—Ç–∏–ª–∏ –¥–ª—è –¥–Ω—è, –∫–æ—Ç–æ—Ä—ã–µ —É–∂–µ –µ—Å—Ç—å –≤ index.css, –Ω–æ –º—ã –º–æ–∂–µ–º –∏—Ö –¥–æ–ø–æ–ª–Ω–∏—Ç—å */
.calendar-day {
    padding: 0.5rem;
    border-radius: 0; /* –£–±–∏—Ä–∞–µ–º —Å–∫—Ä—É–≥–ª–µ–Ω–∏–µ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é –¥–ª—è —Å—Ä–µ–¥–Ω–∏—Ö –¥–Ω–µ–π */
    color: #1f2937; /* –¶–≤–µ—Ç —Ç–µ–∫—Å—Ç–∞ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é */
    transition: background-color 0.2s, color 0.2s;
}

/* –°—Ç–∏–ª–∏ –¥–ª—è –¥–Ω–µ–π –≤–Ω—É—Ç—Ä–∏ –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ –¥–∏–∞–ø–∞–∑–æ–Ω–∞ (–¥—É–±–ª–∏—Ä—É—é—Ç index.css –¥–ª—è –Ω–∞–¥–µ–∂–Ω–æ—Å—Ç–∏) */
.range-middle {
    background-color: #e0f2fe; /* Tailwind sky-100 */
}

/* –°—Ç–∏–ª–∏ –¥–ª—è –Ω–∞—á–∞–ª—å–Ω–æ–π –∏ –∫–æ–Ω–µ—á–Ω–æ–π –¥–∞—Ç –¥–∏–∞–ø–∞–∑–æ–Ω–∞ (–¥—É–±–ª–∏—Ä—É—é—Ç index.css –¥–ª—è –Ω–∞–¥–µ–∂–Ω–æ—Å—Ç–∏) */
.range-start,
.range-end {
    background-color: #0284c7; /* Tailwind sky-600 */
    color: white;
    border-radius: 50%; /* –î–µ–ª–∞–µ–º –∏—Ö –∫—Ä—É–≥–ª—ã–º–∏ */
}

/* –£–±–∏—Ä–∞–µ–º —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–æ–µ –≤—ã–¥–µ–ª–µ–Ω–∏–µ –¥–ª—è –æ–¥–∏–Ω–æ—á–Ω—ã—Ö –∫–ª–∏–∫–æ–≤ –≤ —Ä–µ–∂–∏–º–µ –¥–∏–∞–ø–∞–∑–æ–Ω–∞ */
.day-selected:not([class*="range-"]) {
    background-color: transparent;
    color: inherit;
}

/* –°—Ç–∏–ª–∏ –¥–ª—è –Ω–∞–≤–∏–≥–∞—Ü–∏–∏ –∏ –∑–∞–≥–æ–ª–æ–≤–∫–æ–≤ (–¥—É–±–ª–∏—Ä—É—é—Ç index.css –¥–ª—è –Ω–∞–¥–µ–∂–Ω–æ—Å—Ç–∏) */
.calendar-caption {
    font-weight: bold;
    font-size: 1.1rem;
    text-transform: capitalize;
    padding-bottom: 0.5rem;
}

.calendar-nav {
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.calendar-head-cell {
    font-weight: 500;
    color: #4b5563; /* gray-600 */
    font-size: 0.8rem;
}

.calendar-cell {
    padding: 1px; /* –ù–µ–±–æ–ª—å—à–æ–π –æ—Ç—Å—Ç—É–ø –º–µ–∂–¥—É —è—á–µ–π–∫–∞–º–∏ –¥–ª—è –≤–∏–∑—É–∞–ª—å–Ω–æ–≥–æ —Ä–∞–∑–¥–µ–ª–µ–Ω–∏—è */
}

```


## <a name="srccomponentsDiscountCalculatortsx"></a>`src/components/DiscountCalculator.tsx`

```tsx
// path: src/components/DiscountCalculator.tsx

// src/components/DiscountCalculator.tsx

import { useState, useMemo, useRef, useCallback, useEffect } from 'react'; // 1. –î–æ–±–∞–≤–ª–µ–Ω –∏–º–ø–æ—Ä—Ç useEffect
import { useSandboxCalculatorStore } from '@/store/sandboxCalculatorStore';
import { useDateStore } from '@/store/dateStore';
import { usePromoCodeStore } from '@/store/promoCodeStore';
import { useReserveStore } from '@/store/reserveStore';
import { Card, CardContent } from '@/components/ui/card';
import { Label } from "@/components/ui/label";
import { ChevronRight, Percent, Loader2 } from "lucide-react";
import PromoCodeInput from './PromoCodeInput';
import type { ChangeEvent } from 'react';
import { toast } from 'sonner';
import { api } from '@/lib/api';

export default function DiscountCalculator() {
    const { dayCount } = useDateStore();
    const {
        setDaysFromSlider, isCalculatorVisible, toggleCalculator,
        isLoadingTiers, durationDiscountPercentage,
        syncWithDateStore // 2. –ü–æ–ª—É—á–∞–µ–º —Ñ—É–Ω–∫—Ü–∏—é —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏
    } = useSandboxCalculatorStore();

    const {
        promoCode, setPromoCode, promoCodePercentage,
        promoCodeMessage, setPromoCodeResult, removePromoCode
    } = usePromoCodeStore();

    const { items } = useReserveStore();

    const [isApplyingPromoCode, setIsApplyingPromoCode] = useState(false);

    const debounceTimeoutRef = useRef<NodeJS.Timeout | null>(null);

    // 3. --- –î–û–ë–ê–í–õ–ï–ù –≠–¢–û–¢ –ë–õ–û–ö ---
    // –≠—Ç–æ—Ç —ç—Ñ—Ñ–µ–∫—Ç —Å–ª–µ–¥–∏—Ç –∑–∞ –∏–∑–º–µ–Ω–µ–Ω–∏–µ–º `dayCount` –≤ —Ö—Ä–∞–Ω–∏–ª–∏—â–µ –¥–∞—Ç.
    // –ö–∞–∫ —Ç–æ–ª—å–∫–æ `dayCount` –æ–±–Ω–æ–≤–∏–ª—Å—è (–ø–æ—Å–ª–µ —É—á–µ—Ç–∞ –≤—ã—Ö–æ–¥–Ω—ã—Ö),
    // –º—ã –∑–∞–ø—É—Å–∫–∞–µ–º `syncWithDateStore`, –∫–æ—Ç–æ—Ä—ã–π –ø–µ—Ä–µ—Å—á–∏—Ç—ã–≤–∞–µ—Ç —Å–∫–∏–¥–∫—É,
    // –∏—Å–ø–æ–ª—å–∑—É—è —É–∂–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –¥–Ω–µ–π.
    useEffect(() => {
        syncWithDateStore();
    }, [dayCount, syncWithDateStore]);
    // ----------------------------

    const handleApplyPromoCode = async () => {
        const currentItems = useReserveStore.getState().items;
        const currentDays = useDateStore.getState().dayCount;

        if (currentItems.length === 0) {
            toast.info("–í—ã–±–µ—Ä–∏—Ç–µ –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏–µ, —á—Ç–æ–±—ã –ø—Ä–∏–º–µ–Ω–∏—Ç—å –ø—Ä–æ–º–æ–∫–æ–¥.");
            return;
        }
        if (!promoCode) {
            toast.info("–í–≤–µ–¥–∏—Ç–µ –ø—Ä–æ–º–æ–∫–æ–¥");
            return;
        }

        const totalDailyRate = currentItems.reduce((sum, item) => sum + item.daily_rate, 0);
        const orderAmount = totalDailyRate * currentDays;

        setIsApplyingPromoCode(true);
        try {
            const response = await api.post("/promocodes/validate", {
                code: promoCode,
                order_amount: orderAmount,
                equipment_ids: currentItems.map(item => item.id)
            });
            setPromoCodeResult(response.data.discount_percentage, response.data.message);
            toast.success(response.data.message);
        } catch (error: unknown) {
            const apiError = error as { response?: { data?: { detail?: string } } }
            const errorMessage = apiError.response?.data?.detail || "–ù–µ —É–¥–∞–ª–æ—Å—å –ø—Ä–∏–º–µ–Ω–∏—Ç—å –ø—Ä–æ–º–æ–∫–æ–¥";
            setPromoCodeResult(0, errorMessage);
            toast.error(errorMessage);
        } finally {
            setIsApplyingPromoCode(false);
        }
    };

    const handleSliderChange = useCallback((event: ChangeEvent<HTMLInputElement>) => {
        const newDays = Number(event.target.value);

        if (debounceTimeoutRef.current) {
            clearTimeout(debounceTimeoutRef.current);
        }

        debounceTimeoutRef.current = setTimeout(() => {
            setDaysFromSlider(newDays);
        }, 10);
    }, [setDaysFromSlider]);

    const totalDiscountPercentage = useMemo(() => durationDiscountPercentage + promoCodePercentage, [durationDiscountPercentage, promoCodePercentage]);

    const getDiscountInfo = (percent: number) => {
        if (percent >= 25) return {label: "–ú–∞–∫—Å–∏–º—É–º –≤—ã–≥–æ–¥—ã!", className: "text-amber-600 font-bold"};
        if (percent >= 20) return {label: "–û—Ç–ª–∏—á–Ω–∞—è —Å–∫–∏–¥–∫–∞!", className: "text-purple-600 font-bold"};
        if (percent >= 15) return {label: "–•–æ—Ä–æ—à–∞—è —Å–∫–∏–¥–∫–∞", className: "text-green-600 font-bold"};
        if (percent > 0) return {label: "–ù–µ–±–æ–ª—å—à–∞—è —Å–∫–∏–¥–∫–∞", className: "text-sky-600"};
        return {label: "–°–∫–∏–¥–∫–∞ –∑–∞–≤–∏—Å–∏—Ç –æ—Ç –¥–Ω–µ–π", className: "text-gray-500"};
    };

    const discountInfo = getDiscountInfo(totalDiscountPercentage);
    const requirementMessage = items.length === 0 ? "–í—ã–±–µ—Ä–∏—Ç–µ –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏–µ –¥–ª—è –ø—Ä–æ–º–æ–∫–æ–¥–∞." : "";

    if (!isCalculatorVisible) {
        return (
            <Card
                className="my-4 bg-gray-50/50 hover:bg-gray-100 cursor-pointer transition"
                onClick={toggleCalculator}
            >
                <CardContent className="p-3">
                    <div className="flex items-center justify-between">
                        <div className="flex items-center gap-3">
                            <Percent className="w-5 h-5 text-purple-500"/>
                            <div className="text-sm">
                                <p className="text-gray-800">
                                    <span className="text-base font-bold text-purple-600">–ï—Å—Ç—å –ø—Ä–æ–º–æ–∫–æ–¥?</span>
                                    <span className="font-medium"> –∏–ª–∏ —Ö–æ—Ç–∏—Ç–µ —Ä–∞—Å—Å—á–∏—Ç–∞—Ç—å —Å–∫–∏–¥–∫—É?</span>
                                </p>
                            </div>
                        </div>
                        <ChevronRight className="w-5 h-5 text-gray-400"/>
                    </div>
                </CardContent>
            </Card>
        );
    }

    return (
        <Card className="my-4 bg-white border-sky-200 shadow-md">
            <CardContent className="p-4">
                <div className="flex flex-col md:flex-row items-center justify-between gap-6 w-full">
                    <div className="w-full md:flex-1">
                        <Label htmlFor="days-slider" className="mb-2 block text-sm text-gray-700">
                            –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –¥–Ω–µ–π: <span className="font-bold">{dayCount}</span>
                            <span className="ml-2 text-xs text-gray-500">(–¥–≤–∏–≥–∞–π—Ç–µ –ø–æ–ª–∑—É–Ω–æ–∫ –¥–ª—è –∏–∑–º–µ–Ω–µ–Ω–∏—è –¥–∞—Ç)</span>
                        </Label>
                        <input id="days-slider" type="range" min="1" max="30" value={dayCount} onChange={handleSliderChange}
                               className="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer accent-sky-600"/>
                    </div>
                    <div className="flex-shrink-0 text-center bg-sky-50 py-2 px-4 rounded-lg border w-full md:w-auto min-w-[160px]">
                        {isLoadingTiers ? (
                            <div className="flex items-center justify-center text-gray-500"><Loader2 className="h-4 w-4 animate-spin mr-2" /> –ó–∞–≥—Ä—É–∑–∫–∞...</div>
                        ) : (
                            <>
                                <div className={`text-2xl font-bold transition-colors duration-300 ${discountInfo.className}`}>–°–∫–∏–¥–∫–∞: {totalDiscountPercentage}%</div>
                                <p className={`text-xs mt-1 transition-colors duration-300 ${discountInfo.className}`}>{discountInfo.label}</p>
                            </>
                        )}
                    </div>
                    <div className="w-full md:flex-1">
                        <PromoCodeInput
                            promoCode={promoCode}
                            setPromoCode={setPromoCode}
                            applyPromoCode={handleApplyPromoCode}
                            removePromoCode={removePromoCode}
                            promoCodeMessage={promoCodeMessage}
                            isLoading={isApplyingPromoCode}
                            requirementMessage={requirementMessage}
                        />
                    </div>
                </div>
            </CardContent>
        </Card>
    );
}

```


## <a name="srccomponentsEquipmentGridtsx"></a>`src/components/EquipmentGrid.tsx`

```tsx
// path: src/components/EquipmentGrid.tsx

// src/components/EquipmentGrid.tsx

import EquipmentCard from '@/components/equipment-card';
import CompactEquipmentCard from '@/components/CompactEquipmentCard';
import { Button } from "@/components/ui/button";
import { PackageSearch, FilterX, Loader2 } from "lucide-react";
import type { Equipment } from "@/types/equipment";
// ‚úÖ –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï: –î–æ–±–∞–≤–ª—è–µ–º –∏–º–ø–æ—Ä—Ç –Ω–µ–¥–æ—Å—Ç–∞—é—â–∏—Ö —Ç–∏–ø–æ–≤
import type { AvailabilityInfo, DayStatus, EquipmentStatus } from "@/types/availability";
import type { ViewMode } from '@/store/viewModeStore';

interface EquipmentGridProps {
    isLoading: boolean;
    items: Equipment[];
    // ‚úÖ –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï: –£–±–∏—Ä–∞–µ–º –Ω–µ–∏—Å–ø–æ–ª—å–∑—É–µ–º—ã–π –ø–∞—Ä–∞–º–µ—Ç—Ä
    // totalItemCount: number;
    hasActiveFilters: boolean;
    getEquipmentStatus: (eq: Equipment) => EquipmentStatus | "my_reservation" | "added";
    dailyAvailabilityData?: Record<number, Record<string, DayStatus>>;
    availabilityData?: AvailabilityInfo[];
    onShowMore: () => void;
    onResetFilters: () => void;
    viewMode: ViewMode;
    isFetchingNextPage: boolean;
    hasNextPage: boolean | undefined;
}

export default function EquipmentGrid({
                                          isLoading,
                                          items,
                                          // ‚úÖ –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï: –£–±–∏—Ä–∞–µ–º –Ω–µ–∏—Å–ø–æ–ª—å–∑—É–µ–º—ã–π –ø–∞—Ä–∞–º–µ—Ç—Ä
                                          // totalItemCount,
                                          hasActiveFilters,
                                          getEquipmentStatus,
                                          dailyAvailabilityData,
                                          availabilityData,
                                          onShowMore,
                                          onResetFilters,
                                          viewMode,
                                          isFetchingNextPage,
                                          hasNextPage,
                                      }: EquipmentGridProps) {

    if (isLoading && items.length === 0) {
        return <p className="text-gray-500 text-sm col-span-full text-center py-5">–ó–∞–≥—Ä—É–∑–∫–∞ –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—è...</p>;
    }

    if (items.length === 0) {
        return (
            <div className="col-span-full my-8">
                <div className="flex flex-col items-center justify-center text-center p-8 space-y-4 bg-gray-50/50 rounded-lg border-2 border-dashed">
                    {hasActiveFilters ? <FilterX className="w-16 h-16 text-gray-400" /> : <PackageSearch className="w-16 h-16 text-gray-400" />}
                    <div className="space-y-1">
                        <h3 className="text-lg font-semibold text-gray-800">{hasActiveFilters ? "–ù–∏—á–µ–≥–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ" : "–ö–∞—Ç–∞–ª–æ–≥ –ø–æ–∫–∞ –ø—É—Å—Ç"}</h3>
                        <p className="text-sm text-gray-500">{hasActiveFilters ? "–ü–æ–ø—Ä–æ–±—É–π—Ç–µ –∏–∑–º–µ–Ω–∏—Ç—å –∏–ª–∏ —Å–±—Ä–æ—Å–∏—Ç—å —Ñ–∏–ª—å—Ç—Ä—ã." : "–ó–¥–µ—Å—å –ø–æ—è–≤–∏—Ç—Å—è –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏–µ –¥–ª—è –∞—Ä–µ–Ω–¥—ã."}</p>
                    </div>
                    {hasActiveFilters && (
                        <div className="mt-4">
                            <Button variant="outline" onClick={onResetFilters}>
                                –°–±—Ä–æ—Å–∏—Ç—å —Ñ–∏–ª—å—Ç—Ä—ã
                            </Button>
                        </div>
                    )}
                </div>
            </div>
        );
    }

    const gridClasses = viewMode === "compact"
        ? "grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 2xl:grid-cols-5 gap-3 mt-4"
        : "grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-4 sm:gap-6 mt-4";

    return (
        <>
            <div className={gridClasses}>
                {items.map((eq) => {
                    const availability = availabilityData?.find(a => a.equipment_id === eq.id);
                    const equipmentDailyStatus = dailyAvailabilityData?.[eq.id];
                    const status = getEquipmentStatus(eq);

                    const equipmentProps = {
                        equipment: eq,
                        status,
                        startDate: availability?.start_date ?? undefined,
                        endDate: availability?.end_date ?? undefined,
                        dailyStatus: equipmentDailyStatus,
                    };

                    return viewMode === "compact" ? (
                        <CompactEquipmentCard key={eq.id} {...equipmentProps} />
                    ) : (
                        <EquipmentCard key={eq.id} {...equipmentProps} />
                    );
                })}
            </div>
            {hasNextPage && (
                <div className="flex justify-center mt-8">
                    <Button
                        variant="outline"
                        onClick={onShowMore}
                        disabled={isFetchingNextPage}
                    >
                        {isFetchingNextPage ? (
                            <>
                                <Loader2 className="mr-2 h-4 w-4 animate-spin" />
                                –ó–∞–≥—Ä—É–∑–∫–∞...
                            </>
                        ) : (
                            "–ü–æ–∫–∞–∑–∞—Ç—å –µ—â—ë"
                        )}
                    </Button>
                </div>
            )}
        </>
    );
}

```


## <a name="srccomponentsErrorBoundarytsx"></a>`src/components/ErrorBoundary.tsx`

```tsx
// path: src/components/ErrorBoundary.tsx

// src/components/ErrorBoundary.tsx

import { ErrorBoundary as ReactErrorBoundary } from "react-error-boundary"
import ErrorMessage from "./ErrorMessage"

type Props = {
    children: React.ReactNode
}

/**
 * –ì–ª–æ–±–∞–ª—å–Ω—ã–π –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –æ—à–∏–±–æ–∫ –¥–ª—è –≤—Å–µ–≥–æ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è.
 * –ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç –∫–æ–º–ø–æ–Ω–µ–Ω—Ç `ErrorMessage` –ø—Ä–∏ —Å–±–æ–µ –¥–µ—Ä–µ–≤–∞ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤.
 */
export default function ErrorBoundary({ children }: Props) {
    return (
        <ReactErrorBoundary
            fallbackRender={({ error, resetErrorBoundary }) => (
                <ErrorMessage error={error} onRetry={resetErrorBoundary} />
            )}
        >
            {children}
        </ReactErrorBoundary>
    )
}


```


## <a name="srccomponentsErrorMessagetsx"></a>`src/components/ErrorMessage.tsx`

```tsx
// path: src/components/ErrorMessage.tsx

import { AlertCircle, RotateCcw } from "lucide-react"

type Props = {
    error: Error
    onRetry?: () => void
}

export default function ErrorMessage({ error, onRetry }: Props) {
    return (
        <div className="bg-red-50 border border-red-300 text-red-700 p-4 rounded-md shadow-sm text-sm">
            <div className="flex items-start gap-2">
                <AlertCircle className="w-4 h-4 mt-0.5" />
                <div>
                    <p className="font-semibold mb-1">–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞:</p>
                    <pre className="whitespace-pre-wrap break-words">{error.message}</pre>
                </div>
            </div>
            {onRetry && (
                <button
                    onClick={onRetry}
                    className="mt-3 inline-flex items-center text-sm text-sky-700 hover:underline"
                >
                    <RotateCcw className="w-4 h-4 mr-1" />
                    –ü–æ–≤—Ç–æ—Ä–∏—Ç—å
                </button>
            )}
        </div>
    )
}


```


## <a name="srccomponentsFilterPaneltsx"></a>`src/components/FilterPanel.tsx`

```tsx
// path: src/components/FilterPanel.tsx

// src/components/FilterPanel.tsx

import SearchInput from "@/components/SearchInput";
import AvailableCheckbox from "@/components/AvailableCheckbox";
import TypeFilter from "@/components/TypeFilter";
import BrandFilter from "@/components/BrandFilter";
import AssociationFilter from "@/components/AssociationFilter";
import ViewModeToggle from "@/components/ViewModeToggle";
import type { Equipment } from "@/types/equipment";

interface FilterPanelProps {
    // ‚úÖ –¢–∏–ø–∏–∑–∞—Ü–∏—è –Ω–µ –º–µ–Ω—è–µ—Ç—Å—è, –Ω–æ —Ç–µ–ø–µ—Ä—å —Å—é–¥–∞ –±—É–¥–µ—Ç –ø—Ä–∏—Ö–æ–¥–∏—Ç—å –ø–æ–ª–Ω—ã–π —Å–ø–∏—Å–æ–∫
    equipmentData: Equipment[];
}

export default function FilterPanel({ equipmentData }: FilterPanelProps) {
    return (
        <div className="bg-white border border-gray-200 shadow-sm rounded-lg p-4 space-y-4">
            <div className="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4">
                <SearchInput />
                <div className="flex items-center gap-2">
                    <AvailableCheckbox />
                    <ViewModeToggle />
                </div>
            </div>
            <div className="flex flex-wrap gap-2 sm:gap-3">
                {/* ‚úÖ –ü–µ—Ä–µ–¥–∞–µ–º –ø–æ–ª–Ω—ã–π —Å–ø–∏—Å–æ–∫ –¥–∞–ª—å—à–µ */}
                <TypeFilter items={equipmentData} />
            </div>
            <div className="flex flex-wrap gap-2 sm:gap-3">
                {/* ‚úÖ AssociationFilter —É–∂–µ –ø–æ–ª—É—á–∞–µ—Ç –ø–æ–ª–Ω—ã–π —Å–ø–∏—Å–æ–∫ –∞—Å—Å–æ—Ü–∏–∞—Ü–∏–π –∏–∑ —Å–≤–æ–µ–≥–æ —Ö—É–∫–∞, –µ–≥–æ —Ç—Ä–æ–≥–∞—Ç—å –Ω–µ –Ω–∞–¥–æ */}
                <AssociationFilter />
            </div>
            <div className="flex flex-wrap gap-2 sm:gap-3">
                {/* ‚úÖ –ü–µ—Ä–µ–¥–∞–µ–º –ø–æ–ª–Ω—ã–π —Å–ø–∏—Å–æ–∫ –¥–∞–ª—å—à–µ */}
                <BrandFilter items={equipmentData} />
            </div>
        </div>
    );
}

```


## <a name="srccomponentsMyReservationListtsx"></a>`src/components/MyReservationList.tsx`

```tsx
// path: src/components/MyReservationList.tsx

// src/components/MyReservationList.tsx

import { useMemo, useState } from "react";
import { useReservations } from "@/hooks/useReservations";
import { useAllEquipment } from "@/hooks/useAllEquipment";
import { ReservationService } from "@/core/services";
import ReservationCard from "./ReservationCard";
import { Checkbox } from "@/components/ui/checkbox";
import { useNavigate } from "react-router-dom";
import { useReserveStore } from "@/store/reserveStore";
import { useDateStore } from "@/store/dateStore";
import { Button } from "@/components/ui/button";
import { FileText, FilterX } from "lucide-react";
import ConfirmItemRemovalDialog from "./ConfirmItemRemovalDialog";

import type { Equipment } from "@/types/equipment";
import type { Reservation, ReservationWithNames } from "@/types/reservation";

interface MyReservationListProps {
    continueEditingReservationId?: number;
    highlightId?: number | null;
    reservationsData?: Reservation[];
    isLoading?: boolean;
    isError?: boolean;
}

const LoadingState = () => (
    <p className="text-center py-4">–ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö...</p>
);

const ErrorState = ({ message }: { message: string }) => (
    <p className="text-red-600 text-center py-4">{message}</p>
);

export default function MyReservationList({
                                              continueEditingReservationId,
                                              highlightId,
                                              reservationsData: propReservationsData,
                                              isLoading: propIsLoading,
                                              isError: propIsError,
                                          }: MyReservationListProps) {
    const { data: allEquipment = [], isLoading: isLoadingEquipment, isError: isEquipmentError } = useAllEquipment();

    const equipmentMap = useMemo(() => {
        const map: Record<number, Equipment> = {};
        allEquipment.forEach(e => { map[e.id] = e; });
        return map;
    }, [allEquipment]);

    const { deleteReservation, updateReservation } = useReservations();

    // –ò—Å–ø–æ–ª—å–∑—É–µ–º –¥–∞–Ω–Ω—ã–µ –∏–∑ –ø—Ä–æ–ø—Å–æ–≤ –∏–ª–∏ –∑–∞–≥—Ä—É–∂–∞–µ–º –∏—Ö —Å–∞–º–æ—Å—Ç–æ—è—Ç–µ–ª—å–Ω–æ
    const reservationsData: Reservation[] = useMemo(() => propReservationsData ?? [], [propReservationsData]);
    const isLoadingReservations = propIsLoading ?? false;
    const isReservationsError = propIsError ?? false;

    const navigate = useNavigate();
    const reserveStore = useReserveStore();
    const dateStore = useDateStore();

    const [deletingId, setDeletingId] = useState<number | null>(null);
    const [hideCompleted, setHideCompleted] = useState<boolean>(false);
    const [itemToRemove, setItemToRemove] = useState<{ reservationId: number; equipmentId: number } | null>(null);

    const reservationsWithNames: ReservationWithNames[] = useMemo(() =>
            ReservationService.createReservationsWithNames(reservationsData, equipmentMap),
        [reservationsData, equipmentMap]
    );

    const filteredByStatus = useMemo(() =>
            hideCompleted
                ? reservationsWithNames.filter((r: ReservationWithNames) => 
                    // –°–∫—Ä—ã–≤–∞–µ–º —Ä–µ–∑–µ—Ä–≤—ã —Å–æ —Å—Ç–∞—Ç—É—Å–∞–º–∏ 'fulfilled' (–≤—ã–¥–∞–Ω –≤ –∞—Ä–µ–Ω–¥—É) –∏ 'cancelled' (–æ—Ç–º–µ–Ω–µ–Ω)
                    r.status !== 'fulfilled' && r.status !== 'cancelled'
                )
                : reservationsWithNames,
        [hideCompleted, reservationsWithNames]
    );

    // –¢–µ–ø–µ—Ä—å –¥–∞–Ω–Ω—ã–µ —É–∂–µ –æ—Ç—Ñ–∏–ª—å—Ç—Ä–æ–≤–∞–Ω—ã –∏ –æ—Ç—Å–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω—ã –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ
    const finalReservations = filteredByStatus;

    if (isLoadingReservations || isLoadingEquipment) {
        return <LoadingState />;
    }

    if (isReservationsError) {
        return <ErrorState message="–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ä–µ–∑–µ—Ä–≤–æ–≤" />;
    }

    if (isEquipmentError) {
        return <ErrorState message="–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—è" />;
    }

    const cancelReservation = async (id: number) => {
        setDeletingId(id);
        try {
            await deleteReservation.mutateAsync(id);
        } catch (error) {
            console.error(`[MyReservationList] Error cancelling reservation ${id}:`, error);
            alert("–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–º–µ–Ω–µ —Ä–µ–∑–µ—Ä–≤–∞.");
        } finally {
            setDeletingId(null);
        }
    };

    const removeItemFromReservation = async (
        reservationId: number,
        equipmentIdToRemove: number
    ) => {
        const reservation = reservationsData.find((r: Reservation) => r.id === reservationId);
        if (!reservation) return;

        const newEquipmentIdsList = reservation.equipment_ids.filter((id: number) => id !== equipmentIdToRemove);
        try {
            if (newEquipmentIdsList.length === 0) {
                await deleteReservation.mutateAsync(reservationId);
            } else {
                await updateReservation.mutateAsync({
                    id: reservationId,
                    equipment_ids: newEquipmentIdsList,
                    start_date: reservation.start_date,
                    end_date: reservation.end_date,
                });
            }
        } catch (error) {
            console.error(`[MyReservationList] Error removing equipment from reservation:`, error);
            alert("–û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ –ø–æ–∑–∏—Ü–∏–∏ –∏–∑ —Ä–µ–∑–µ—Ä–≤–∞.");
        }
    };

    const requestItemRemoval = (reservationId: number, equipmentId: number) => {
        setItemToRemove({ reservationId, equipmentId });
    };

    const confirmItemRemoval = () => {
        if (itemToRemove) {
            void removeItemFromReservation(itemToRemove.reservationId, itemToRemove.equipmentId)
                .finally(() => {
                    setItemToRemove(null);
                });
        }
    };

    const cancelItemRemoval = () => {
        setItemToRemove(null);
    };


    const repeatReservation = (r: ReservationWithNames) => {
        reserveStore.clear();
        const validEquipment = r.equipment_ids
            .map((id: number) => equipmentMap[id])
            .filter((eq): eq is Equipment => Boolean(eq));
        reserveStore.bulkAdd(validEquipment);
        dateStore.setRange(new Date(r.start_date), new Date(r.end_date));
        navigate("/", {
            state: {
                intent: "add_to_existing_reservation",
                reservationId: r.id,
                startDate: r.start_date,
                endDate: r.end_date,
                equipmentIds: r.equipment_ids
            }
        });
    };

    const renderedCards = finalReservations
        .map((r: ReservationWithNames) => {
            const equipmentListForCard = r.equipment_ids
                .map((id: number) => {
                    const eq = equipmentMap[id];
                    return eq ? { id, label: `${eq.equipment_type} ${eq.brand} ${eq.name}` } : null;
                })
                .filter((item): item is { id: number; label: string } => Boolean(item));

            if (r.equipment_ids.length === 0) {
                return null;
            }

            const autoStartEditForThisCard = r.id === continueEditingReservationId;

            return (
                <ReservationCard
                    key={`${r.id}-${r.equipment_ids.join('-')}-${r.start_date}-${r.end_date}`}
                    id={r.id}
                    start_date={r.start_date}
                    end_date={r.end_date}
                    status={r.status}
                    equipment={equipmentListForCard}
                    onCancel={() => cancelReservation(r.id)}
                    cancelDisabled={deletingId === r.id}
                    onRemoveItem={(equipmentId) => requestItemRemoval(r.id, equipmentId)}
                    onRepeat={() => repeatReservation(r)}
                    autoStartEdit={autoStartEditForThisCard}
                    total_cost={r.total_cost}
                    discount_amount={r.discount_amount}
                    promo_code={r.promo_code}
                    selected_accessories={r.selected_accessories}
                    accessory_links={r.accessory_links}
                    highlightId={highlightId}
                    rental_id={r.rental_id}
                />
            );
        })
        .filter(Boolean);

    const hasFilters = (filteredByStatus.length > 0) &&
        finalReservations.length === 0 &&
        reservationsData.length > 0;

    return (
        <div>
            <div className="mb-4 flex items-center gap-2">
                <Checkbox
                    id="hideCompleted"
                    checked={hideCompleted}
                    onCheckedChange={(checked) => setHideCompleted(Boolean(checked))}
                />
                <label htmlFor="hideCompleted" className="text-sm text-gray-700">
                    –°–∫—Ä—ã—Ç—å –∑–∞–≤–µ—Ä—à—ë–Ω–Ω—ã–µ —Ä–µ–∑–µ—Ä–≤—ã
                </label>
            </div>
            {renderedCards.length === 0 ? (
                <div className="my-8">
                    <div className="flex flex-col items-center justify-center text-center p-8 space-y-4 bg-gray-50/50 rounded-lg border-2 border-dashed">
                        {hasFilters ? <FilterX className="w-16 h-16 text-gray-400" /> : <FileText className="w-16 h-16 text-gray-400" />}
                        <div className="space-y-1">
                            <h3 className="text-lg font-semibold text-gray-800">
                                {hasFilters ? "–†–µ–∑–µ—Ä–≤—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã" : "–£ –≤–∞—Å –ø–æ–∫–∞ –Ω–µ—Ç —Ä–µ–∑–µ—Ä–≤–æ–≤"}
                            </h3>
                            <p className="text-sm text-gray-500">
                                {hasFilters
                                    ? "–ù–∏ –æ–¥–∏–Ω –∏–∑ –≤–∞—à–∏—Ö —Ä–µ–∑–µ—Ä–≤–æ–≤ –Ω–µ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç –∑–∞–¥–∞–Ω–Ω—ã–º —Ñ–∏–ª—å—Ç—Ä–∞–º."
                                    : "–ó–¥–µ—Å—å –±—É–¥—É—Ç –æ—Ç–æ–±—Ä–∞–∂–∞—Ç—å—Å—è –≤–∞—à–∏ –±—É–¥—É—â–∏–µ –∏ –ø—Ä–æ—à–ª—ã–µ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è."}
                            </p>
                        </div>
                        {!hasFilters && (
                            <div className="mt-4">
                                <Button onClick={() => navigate("/")}>–°–æ–∑–¥–∞—Ç—å –ø–µ—Ä–≤—ã–π —Ä–µ–∑–µ—Ä–≤</Button>
                            </div>
                        )}
                    </div>
                </div>
            ) : (
                <ul className="space-y-4">{renderedCards}</ul>
            )}

            <ConfirmItemRemovalDialog
                open={!!itemToRemove}
                onClose={cancelItemRemoval}
                onConfirm={confirmItemRemoval}
                isConfirming={updateReservation.isPending || deleteReservation.isPending}
            />
        </div>
    );
}

```


## <a name="srccomponentsNetworkStatustsx"></a>`src/components/NetworkStatus.tsx`

```tsx
// path: src/components/NetworkStatus.tsx

// src/components/NetworkStatus.tsx
import { useNetworkStatus } from "@/hooks/useNetworkStatus"
import { WifiOff, Wifi } from "lucide-react"

export default function NetworkStatus() {
    const isOnline = useNetworkStatus()

    return (
        <div
            className={`fixed bottom-4 left-4 z-50 text-xs font-medium px-3 py-1.5 rounded-md shadow-lg transition
      ${isOnline ? "bg-green-100 text-green-700 border border-green-300" : "bg-red-100 text-red-700 border border-red-300"}
      `}
        >
            <div className="flex items-center gap-2">
                {isOnline ? <Wifi className="w-4 h-4" /> : <WifiOff className="w-4 h-4" />}
                {isOnline ? "–í —Å–µ—Ç–∏" : "–ù–µ—Ç –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è"}
            </div>
        </div>
    )
}


```


## <a name="srccomponentsPromoCodeInputtsx"></a>`src/components/PromoCodeInput.tsx`

```tsx
// path: src/components/PromoCodeInput.tsx

// src/components/PromoCodeInput.tsx
import { Input } from "@/components/ui/input";
import { Button } from "@/components/ui/button";
import { Label } from "@/components/ui/label";
import { TicketPercent, CheckCircle, XCircle, Loader2, AlertTriangle } from "lucide-react";
import { toast } from "sonner";

interface PromoCodeInputProps {
    promoCode: string;
    setPromoCode: (code: string) => void;
    applyPromoCode: () => void;
    removePromoCode?: () => void;
    promoCodeMessage: string;
    disabled?: boolean;
    isLoading?: boolean;
    requirementMessage?: string;
}

export default function PromoCodeInput({
                                           promoCode,
                                           setPromoCode,
                                           applyPromoCode,
                                           removePromoCode,
                                           promoCodeMessage,
                                           disabled = false,
                                           isLoading = false,
                                           requirementMessage,
                                       }: PromoCodeInputProps) {

    const handleApply = () => {
        if (!promoCode.trim()) {
            toast.info("–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–≤–µ–¥–∏—Ç–µ –ø—Ä–æ–º–æ–∫–æ–¥.");
            return;
        }
        applyPromoCode();
    };

    const isApplied = promoCodeMessage && promoCodeMessage.length > 0;
    const isSuccess = isApplied && promoCodeMessage.includes("—É—Å–ø–µ—à–Ω–æ");
    const isDisabledByRequirement = !!requirementMessage;

    return (
        <div className="space-y-2">
            <div className="flex justify-between items-center">
                <Label htmlFor="promo-code" className="text-sm font-medium">–ï—Å—Ç—å –ø—Ä–æ–º–æ–∫–æ–¥?</Label>
                {/* –ë—ã–ª–æ: {isSuccess && removePromoCode && ( */}
                {/* –°—Ç–∞–ª–æ: –£—Å–ª–æ–≤–∏–µ —Ç–µ–ø–µ—Ä—å –∑–∞–≤–∏—Å–∏—Ç –æ—Ç –Ω–∞–ª–∏—á–∏—è —Ç–µ–∫—Å—Ç–∞ –≤ –ø–æ–ª–µ –ø—Ä–æ–º–æ–∫–æ–¥–∞ */}
                {promoCode && removePromoCode && (
                    <button onClick={removePromoCode} className="text-xs text-gray-500 hover:text-red-600 hover:underline">–°–±—Ä–æ—Å–∏—Ç—å</button>
                )}
            </div>
            <div className="flex items-center gap-2">
                <div className="relative flex-grow">
                    <TicketPercent className="absolute left-2.5 top-2.5 h-4 w-4 text-gray-400" />
                    <Input
                        id="promo-code"
                        type="text"
                        placeholder="SALE15"
                        value={promoCode}
                        onChange={(e) => setPromoCode(e.target.value)}
                        disabled={disabled || isLoading || isSuccess || isDisabledByRequirement}
                        className="pl-8"
                    />
                    {isSuccess && promoCode && (
                        <CheckCircle className="absolute right-2.5 top-2.5 h-4 w-4 text-green-500" />
                    )}
                </div>
                <Button
                    type="button"
                    variant="outline"
                    onClick={handleApply}
                    disabled={disabled || isLoading || isSuccess || isDisabledByRequirement}
                >
                    {isLoading ? <Loader2 className="h-4 w-4 animate-spin" /> : "–ü—Ä–∏–º–µ–Ω–∏—Ç—å"}
                </Button>
            </div>

            {isDisabledByRequirement && (
                <div className="flex items-center gap-1.5 text-xs mt-1.5 text-orange-600">
                    <AlertTriangle className="h-4 w-4" />
                    <span>{requirementMessage}</span>
                </div>
            )}

            {!isDisabledByRequirement && isApplied && (
                <div className={`flex items-center gap-1.5 text-xs mt-1.5 ${isSuccess ? "text-green-600" : "text-red-600"}`}>
                    {!isSuccess && <XCircle className="h-3.5 w-3.5" />}
                    <span>{promoCodeMessage}</span>
                </div>
            )}
        </div>
    );
}

```


## <a name="srccomponentsRequireAuthtsx"></a>`src/components/RequireAuth.tsx`

```tsx
// path: src/components/RequireAuth.tsx

import { ReactNode } from "react"
import { Navigate, useLocation } from "react-router-dom"
import { useCurrentUser } from "@/hooks/useProfile"

type Props = {
    children: ReactNode
    role?: string | string[] // –î–æ–±–∞–≤–ª–µ–Ω –ø—Ä–æ–ø—Å role
}

export default function RequireAuth({ children, role }: Props) {
    const { data: user, isLoading } = useCurrentUser()
    const location = useLocation()

    if (isLoading) {
        return <p>–ó–∞–≥—Ä—É–∑–∫–∞ –ø—Ä–æ—Ñ–∏–ª—è...</p>
    }
    if (!user) {
        return <Navigate to="/" replace state={{ from: location.pathname }} />
    }
    // –î–æ–±–∞–≤–ª–µ–Ω–∞ –ø—Ä–æ–≤–µ—Ä–∫–∞ —Ä–æ–ª–∏
    if (role && !(Array.isArray(role) ? role.includes(user.role) : user.role === role)) {
        return <Navigate to="/" replace state={{ from: location.pathname }} />
    }

    return <>{children}</>
}


```


## <a name="srccomponentsReservationCardtsx"></a>`src/components/ReservationCard.tsx`

```tsx
// path: src/components/ReservationCard.tsx

// src/components/ReservationCard.tsx
import { useEffect, useMemo, useState } from "react";
import { useNavigate, useLocation } from "react-router-dom";
import { ReservationEditProvider } from "@/hooks/useInlineReservationEdit"; // ‚ú® –ò–º–ø–æ—Ä—Ç–∏—Ä—É–µ–º –ø—Ä–æ–≤–∞–π–¥–µ—Ä
import EditableReservationCard from "./reservation/EditableReservationCard";
import ViewReservationCard from "./reservation/ViewReservationCard";
import type { Reservation, AccessoryLink } from "@/types/reservation";
import type { EquipmentDisplayDetail } from "@/hooks/reservation/useReservationState";

type Props = {
    id: number;
    equipment: EquipmentDisplayDetail[];
    start_date: string;
    end_date: string;
    status: Reservation['status'];
    onRemoveItem?: (equipmentId: number) => void;
    onCancel?: () => void;
    cancelDisabled?: boolean;
    onRepeat?: () => void;
    autoStartEdit?: boolean;
    total_cost?: number;
    discount_amount?: number;
    promo_code?: string | null;
    selected_accessories?: Record<number, number[]>;
    accessory_links?: AccessoryLink[];
    highlightId?: number | null;
    rental_id?: number | null;
};

export default function ReservationCard({
                                            id, equipment, start_date, end_date, status, onRemoveItem, onCancel,
                                            cancelDisabled, onRepeat, autoStartEdit = false,
                                            total_cost, discount_amount, promo_code, selected_accessories,
                                            accessory_links, highlightId, rental_id
                                        }: Props) {
    const navigate = useNavigate();
    const location = useLocation();

    // ‚ú® 1. –£–ø—Ä–∞–≤–ª—è–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ–º —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –ø—Ä—è–º–æ –∑–¥–µ—Å—å.
    const [isEditing, setIsEditing] = useState(autoStartEdit);
    const [hasAutoStarted, setHasAutoStarted] = useState(false);

    // –≠—Ç–æ—Ç –æ–±—ä–µ–∫—Ç –≤—Å–µ –µ—â–µ –Ω—É–∂–µ–Ω –¥–ª—è –ø–µ—Ä–µ–¥–∞—á–∏ –≤ –ø—Ä–æ–≤–∞–π–¥–µ—Ä.
    const reservationForProvider: Reservation = useMemo(() => ({
        id, equipment_ids: equipment.map(e => e.id), start_date, end_date, status,
        total_cost, discount_amount, promo_code,
        selected_accessories: selected_accessories || {},
    }), [id, equipment, start_date, end_date, status, total_cost, discount_amount, promo_code, selected_accessories]);

    useEffect(() => {
        if (autoStartEdit && !isEditing && !hasAutoStarted) {
            setIsEditing(true);
            setHasAutoStarted(true);
        }
    }, [autoStartEdit, isEditing, hasAutoStarted]);


    // ‚ú® 2. –ú—ã –±–æ–ª—å—à–µ –Ω–µ –∏—Å–ø–æ–ª—å–∑—É–µ–º —Ö—É–∫ useInlineReservationEdit –Ω–∞–ø—Ä—è–º—É—é –∑–¥–µ—Å—å.
    // –í–º–µ—Å—Ç–æ —ç—Ç–æ–≥–æ –º—ã —É–ø—Ä–∞–≤–ª—è–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ–º isEditing –∏ —Ä–µ–Ω–¥–µ—Ä–∏–º –ª–∏–±–æ View, –ª–∏–±–æ Provider+Edit.

    const isHighlighted = highlightId === id;

    return (
        <div className={`transition-all duration-300 ${
            isHighlighted 
                ? "ring-2 ring-sky-500 bg-sky-50 shadow-lg rounded-2xl" 
                : ""
        }`}>
            {isEditing ? (
                // ‚ú® 3. –û–±–æ—Ä–∞—á–∏–≤–∞–µ–º –∫–æ–º–ø–æ–Ω–µ–Ω—Ç —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –≤ –Ω–∞—à –Ω–æ–≤—ã–π –ø—Ä–æ–≤–∞–π–¥–µ—Ä.
                <ReservationEditProvider
                    reservation={reservationForProvider}
                    initialEquipmentForDisplay={equipment}
                    onFullCancellation={onCancel}
                    isAdminContext={false}
                    // ‚ú® 4. –ü–µ—Ä–µ–¥–∞–µ–º –∫–æ–ª–±—ç–∫ –¥–ª—è –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è.
                    onFinishEditing={() => {
                        setIsEditing(false);
                        // –ï—Å–ª–∏ —ç—Ç–æ –±—ã–ª–æ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ, —á–∏—Å—Ç–∏–º —Å—Ç–µ–π—Ç –≤ location
                        if (autoStartEdit) {
                            navigate(location.pathname, { replace: true, state: {} });
                        }
                    }}
                >
                    {/* EditableReservationCard —Ç–µ–ø–µ—Ä—å –Ω–µ –ø—Ä–∏–Ω–∏–º–∞–µ—Ç –ø—Ä–æ–ø—Å–æ–≤! */}
                    <EditableReservationCard />
                </ReservationEditProvider>
            ) : (
                <ViewReservationCard
                    id={id}
                    equipment={equipment}
                    start_date={start_date}
                    end_date={end_date}
                    status={status}
                    // ‚ú® 5. –ö–Ω–æ–ø–∫–∞ "–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å" —Ç–µ–ø–µ—Ä—å –ø—Ä–æ—Å—Ç–æ –ø–µ—Ä–µ–∫–ª—é—á–∞–µ—Ç –ª–æ–∫–∞–ª—å–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ.
                    onEdit={status === 'active' ? () => setIsEditing(true) : undefined}
                    onCancel={onCancel}
                    onRemoveItem={onRemoveItem}
                    onRepeat={onRepeat}
                    cancelDisabled={cancelDisabled}
                    total_cost={total_cost}
                    discount_amount={discount_amount}
                    promo_code={promo_code}
                    accessory_links={accessory_links}
                    rental_id={rental_id}
                />
            )}

            {/* –î–∏–∞–ª–æ–≥ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è —É–¥–∞–ª–µ–Ω–∏—è –æ—Å—Ç–∞–µ—Ç—Å—è –∑–¥–µ—Å—å, —Ç.–∫. –æ–Ω —Å–≤—è–∑–∞–Ω —Å ViewReservationCard */}
            {/* –ï–≥–æ –ª–æ–≥–∏–∫–∞ –±—É–¥–µ—Ç –ø–µ—Ä–µ—Å–º–æ—Ç—Ä–µ–Ω–∞, –µ—Å–ª–∏ –ø–æ—Ç—Ä–µ–±—É–µ—Ç—Å—è –≤ —Ä–µ–∂–∏–º–µ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è */}
            {/* <ConfirmItemRemovalDialog ... />  <- –º–æ–∂–Ω–æ –ø–æ–∫–∞ –æ—Å—Ç–∞–≤–∏—Ç—å –∏–ª–∏ –∑–∞–∫–æ–º–º–µ–Ω—Ç–∏—Ä–æ–≤–∞—Ç—å */}
        </div>
    );
}

```


## <a name="srccomponentsReservationFootertsx"></a>`src/components/ReservationFooter.tsx`

```tsx
// path: src/components/ReservationFooter.tsx

// src/components/ReservationFooter.tsx

import { Button } from "@/components/ui/button";
import { ArrowRight, X } from "lucide-react";

interface ReservationFooterProps {
    selectedCount: number;
    onClick: () => void;
    // ‚úÖ –î–æ–±–∞–≤–ª—è–µ–º –Ω–æ–≤–æ–µ —Å–≤–æ–π—Å—Ç–≤–æ –¥–ª—è —Å–±—Ä–æ—Å–∞
    onReset: () => void;
    isEditingMode: boolean;
    intent?: string;
}

export default function ReservationFooter({ selectedCount, onClick, onReset, isEditingMode, intent }: ReservationFooterProps) {
    if (selectedCount === 0) {
        return null;
    }

    const buttonText = isEditingMode && intent !== "add_to_new_reservation"
        ? `‚úîÔ∏è –î–æ–±–∞–≤–∏—Ç—å –∫ —Ä–µ–∑–µ—Ä–≤—É (${selectedCount})`
        : `üì• –û—Ñ–æ—Ä–º–∏—Ç—å (${selectedCount})`;

    return (
        <div className="fixed bottom-0 left-0 right-0 z-50 p-4 bg-background/90 backdrop-blur-sm border-t border-border shadow-[0_-4px_15px_rgba(0,0,0,0.08)]">
            <div className="max-w-7xl mx-auto flex justify-between items-center">
                {/* ‚úÖ –ù–æ–≤–∞—è –∫–Ω–æ–ø–∫–∞ "–°–±—Ä–æ—Å–∏—Ç—å –≤—ã–±–æ—Ä" —Å–ª–µ–≤–∞ */}
                <Button
                    onClick={onReset}
                    variant="destructive"
                    size="lg"
                    className="flex items-center gap-2"
                >
                    <X className="h-5 w-5" />
                    –°–±—Ä–æ—Å–∏—Ç—å –≤—ã–±–æ—Ä
                </Button>

                {/* –ë–ª–æ–∫ —Å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–µ–π –∏ –æ—Å–Ω–æ–≤–Ω–æ–π –∫–Ω–æ–ø–∫–æ–π —Å–ø—Ä–∞–≤–∞ */}
                <div className="flex items-center gap-4">
                    <div className="text-sm text-foreground">
                        <span className="font-semibold">–í—ã–±—Ä–∞–Ω–æ –¥–ª—è —Ä–µ–∑–µ—Ä–≤–∞:</span>
                        <span className="ml-2 font-bold text-lg">{selectedCount} –ø–æ–∑.</span>
                    </div>
                    <Button
                        onClick={onClick}
                        size="lg"
                        className="bg-green-600 hover:bg-green-700 text-white shadow-lg flex items-center gap-2"
                    >
                        {buttonText}
                        <ArrowRight className="h-5 w-5" />
                    </Button>
                </div>
            </div>
        </div>
    );
}

```


## <a name="srccomponentsReservationListtsx"></a>`src/components/ReservationList.tsx`

```tsx
// path: src/components/ReservationList.tsx

import { useReserveSubmission } from "@/hooks/reservation/submission/useReserveSubmission"
import type { Equipment } from "@/types/equipment"

export default function ReservationList() {
    const {
        items,
        unavailableIdsFromAPI,
        submitMessage,
        reservationSuccess,
        removeItemFromStore,
        clearReserveStore,
        handleSubmit,
    } = useReserveSubmission()

    if (items.length === 0) return null

    return (
        <div className="mt-6 p-4 border rounded bg-white shadow-sm max-w-2xl mx-auto">
            <h2 className="text-lg font-bold mb-4">–í—ã–±—Ä–∞–Ω–Ω–æ–µ –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏–µ:</h2>

            <ul className="space-y-2 mb-4">
                {items.map((item: Equipment) => (
                    <li
                        key={item.id}
                        className={`flex justify-between items-center border-b pb-1 ${
                            unavailableIdsFromAPI.includes(item.id) ? "bg-red-50 border-red-600" : ""
                        }`}
                    >
                        <div>
                            <p className="font-medium">{item.name}</p>
                            <p className="text-sm text-gray-500">
                                {item.brand} ‚Ä¢ {item.equipment_type}
                            </p>
                            {unavailableIdsFromAPI.includes(item.id) && (
                                <p className="text-xs text-red-600 pt-1">
                                    –≠—Ç–æ –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏–µ —Å—Ç–∞–ª–æ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω—ã–º
                                </p>
                            )}
                        </div>
                        <button
                            onClick={() => removeItemFromStore(item.id)}
                            className="text-red-600 hover:underline text-sm"
                        >
                            –£–¥–∞–ª–∏—Ç—å
                        </button>
                    </li>
                ))}
            </ul>

            <div className="flex justify-between items-center">
                <button
                    onClick={clearReserveStore}
                    className="text-gray-600 hover:underline text-sm"
                >
                    –û—á–∏—Å—Ç–∏—Ç—å –≤—Å—ë
                </button>
                <button
                    onClick={handleSubmit}
                    className="bg-sky-700 text-white px-4 py-2 rounded hover:bg-sky-800 text-sm font-medium"
                    disabled={unavailableIdsFromAPI.length > 0}
                >
                    üì§ –û—Ç–ø—Ä–∞–≤–∏—Ç—å —Ä–µ–∑–µ—Ä–≤
                </button>
            </div>

            {submitMessage && (
                <p
                    className={`text-sm mt-3 text-center ${
                        reservationSuccess ? "text-green-700" : "text-red-600"
                    }`}
                >
                    {submitMessage}
                </p>
            )}
        </div>
    )
}


```


## <a name="srccomponentsReserveEquipmentCardtsx"></a>`src/components/ReserveEquipmentCard.tsx`

```tsx
// path: src/components/ReserveEquipmentCard.tsx

// src/components/ReserveEquipmentCard.tsx
import { useState } from "react";
import { Trash2, Paperclip, ChevronDown } from "lucide-react";
import { Checkbox } from "@/components/ui/checkbox";
import { Label } from "@/components/ui/label";
import type { Equipment } from "@/types/equipment";
import type { AvailabilityInfo, EquipmentStatus } from "@/types/availability";
import { Card, CardContent } from "@/components/ui/card";
import { formatDateRangeEuropean } from "@/lib/utils";

type Props = {
    equipment: Equipment;
    availability?: AvailabilityInfo;
    onRemove: (id: number) => void;
    // ‚úÖ –î–û–ë–ê–í–õ–ï–ù–´ –ù–û–í–´–ï –°–í–û–ô–°–¢–í–ê
    isAccessorySelected: (equipmentId: number, accessoryId: number) => boolean;
    onToggleAccessory: (equipmentId: number, accessoryId: number) => void;
};

const statusTextMap: Record<EquipmentStatus | string, string> = {
    available: "–°–≤–æ–±–æ–¥–Ω–æ",
    reserved: "–í —Ä–µ–∑–µ—Ä–≤–µ (–¥—Ä—É–≥–∏–º)",
    rented: "–í –∞—Ä–µ–Ω–¥–µ (–¥—Ä—É–≥–∏–º)",
    my_reservation: "–í —ç—Ç–æ–º —Ä–µ–∑–µ—Ä–≤–µ",
};

const statusColorMap: Record<EquipmentStatus | string, string> = {
    available: "text-green-600",
    reserved: "text-rose-500",
    rented: "text-red-600",
    my_reservation: "text-sky-700",
};

const bgColorMap: Record<EquipmentStatus | string, string> = {
    available: "bg-white",
    reserved: "bg-rose-50 border-rose-200",
    rented: "bg-rose-100 border-rose-300",
    my_reservation: "bg-sky-50 border-sky-200",
};

function formatDateRange(start?: string, end?: string) {
    if (!start || !end) return "";
    return `(${formatDateRangeEuropean(start, end)})`;
}

export default function ReserveEquipmentCard({
                                                 equipment,
                                                 availability,
                                                 onRemove,
                                                 // ‚úÖ –ü–û–õ–£–ß–ê–ï–ú –ù–û–í–´–ï –°–í–û–ô–°–¢–í–ê
                                                 isAccessorySelected,
                                                 onToggleAccessory
                                             }: Props) {
    const status = availability?.status ?? "available";
    const statusText = statusTextMap[status] || "–ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π —Å—Ç–∞—Ç—É—Å";
    const colorClass = statusColorMap[status] || "text-gray-500";
    const bgClass = bgColorMap[status] || "bg-gray-50";
    const dateRange = (status === "reserved" || status === "rented")
        ? formatDateRange(availability?.start_date, availability?.end_date)
        : "";
    const isExternalConflict = status === "reserved" || status === "rented";

    // ‚úÖ –°–û–°–¢–û–Ø–ù–ò–ï –î–õ–Ø –û–¢–û–ë–†–ê–ñ–ï–ù–ò–Ø –°–ü–ò–°–ö–ê –ê–ö–°–ï–°–°–£–ê–†–û–í
    const [showAccessories, setShowAccessories] = useState(false);

    return (
        <Card
            className={`rounded-xl px-4 py-4 sm:px-6 shadow-sm transition border w-full flex flex-col ${bgClass}`}
        >
            <CardContent className="p-0 flex-1 flex flex-col sm:flex-row justify-between items-start gap-4">
                <div className="flex-1">
                    <h3 className="text-base sm:text-lg font-semibold mb-1">{equipment.name}</h3>
                    <p className="text-xs sm:text-sm text-gray-500 mb-1">
                        {equipment.brand} ‚Ä¢ {equipment.equipment_type}
                    </p>
                    <p className="text-xs sm:text-sm mb-1">
                        –°–æ—Å—Ç–æ—è–Ω–∏–µ: <strong>{equipment.condition}</strong>
                    </p>
                    <p className="text-sm sm:text-base font-bold mb-1">{equipment.daily_rate} ‚ÇΩ / –¥–µ–Ω—å</p>

                    <p className={`text-sm font-semibold mt-2 ${colorClass}`}>
                        {statusText}
                        {dateRange && <span className="ml-1 text-xs font-normal">{dateRange}</span>}
                    </p>

                    {/* ‚úÖ –ù–ê–ß–ê–õ–û –ë–õ–û–ö–ê –í–´–ë–û–†–ê –ê–ö–°–ï–°–°–£–ê–†–û–í */}
                    {equipment.accessories && equipment.accessories.length > 0 && (
                        <div className="mt-3 border-t pt-3">
                            <button
                                className="w-full flex justify-between items-center text-sm font-medium text-gray-600 hover:text-sky-700 p-1 -m-1 rounded"
                                onClick={() => setShowAccessories(prev => !prev)}
                            >
                                <span className="flex items-center gap-2">
                                    <Paperclip className="w-4 h-4" />
                                    –î–æ–±–∞–≤–∏—Ç—å –∞–∫—Å–µ—Å—Å—É–∞—Ä—ã ({equipment.accessories.length})
                                </span>
                                <ChevronDown className={`w-5 h-5 transition-transform ${showAccessories ? 'rotate-180' : ''}`} />
                            </button>
                            {showAccessories && (
                                <div className="mt-2 space-y-2 pl-1 animate-in fade-in-0 slide-in-from-top-2 duration-300">
                                    {equipment.accessories.map(acc => (
                                        <div key={acc.id} className="flex items-center justify-between p-1 rounded hover:bg-gray-50">
                                            <Label htmlFor={`reserve-acc-${equipment.id}-${acc.id}`} className="flex items-center gap-2 text-xs font-normal cursor-pointer">
                                                <Checkbox
                                                    id={`reserve-acc-${equipment.id}-${acc.id}`}
                                                    checked={isAccessorySelected(equipment.id, acc.id)}
                                                    onCheckedChange={() => onToggleAccessory(equipment.id, acc.id)}
                                                />
                                                {acc.name}
                                            </Label>
                                            <span className="text-xs text-gray-500">{acc.price} ‚ÇΩ</span>
                                        </div>
                                    ))}
                                </div>
                            )}
                        </div>
                    )}
                    {/* ‚úÖ –ö–û–ù–ï–¶ –ë–õ–û–ö–ê –í–´–ë–û–†–ê –ê–ö–°–ï–°–°–£–ê–†–û–í */}
                </div>

                <button
                    onClick={() => onRemove(equipment.id)}
                    className={`rounded px-2 py-1 sm:px-3 text-xs sm:text-sm font-medium flex items-center gap-1 mt-1 self-start sm:self-center 
                        ${isExternalConflict
                        ? "bg-red-500 text-white hover:bg-red-600"
                        : "bg-slate-500 text-white hover:bg-slate-600"
                    }`}
                    title="–£–¥–∞–ª–∏—Ç—å –∏–∑ —Ä–µ–∑–µ—Ä–≤–∞"
                >
                    <Trash2 size={14} className="sm:size-4" />
                    –£–¥–∞–ª–∏—Ç—å
                </button>
            </CardContent>
        </Card>
    );
}

```


## <a name="srccomponentsSearchInputtsx"></a>`src/components/SearchInput.tsx`

```tsx
// path: src/components/SearchInput.tsx

import { useSearchStore } from "../store/searchStore"
import { Input } from "@/components/ui/input"

export default function SearchInput() {
  const { query, setQuery } = useSearchStore()

  return (
    <Input
      type="text"
      placeholder="–ü–æ–∏—Å–∫ –ø–æ –Ω–∞–∑–≤–∞–Ω–∏—é..."
      value={query}
      onChange={(e) => setQuery(e.target.value)}
      className="w-full max-w-sm"
    />
  )
}


```


## <a name="srccomponentsStatusBadgetsx"></a>`src/components/StatusBadge.tsx`

```tsx
// path: src/components/StatusBadge.tsx

export default function StatusBadge({ status }: { status: "active" | "past" }) {
    const isActive = status === "active"
    return (
        <span
            className={`text-xs font-medium px-2 py-1 rounded-full inline-block
        ${isActive
                ? "bg-green-100 text-green-700 border border-green-300"
                : "bg-gray-100 text-gray-500 border border-gray-300"
            }`}
        >
      {isActive ? "–ê–∫—Ç–∏–≤–µ–Ω" : "–ó–∞–≤–µ—Ä—à—ë–Ω"}
    </span>
    )
}


```


## <a name="srccomponentsTypeFiltertsx"></a>`src/components/TypeFilter.tsx`

```tsx
// path: src/components/TypeFilter.tsx

// src/components/TypeFilter.tsx
import { ToggleGroup, ToggleGroupItem } from "@/components/ui/toggle-group"
import { useFilterStore } from "@/store/filterStore"
import { useMemo, type ReactNode } from "react"
import type { Equipment } from "@/types/equipment"
import { getFilterToggleClass } from "@/components/ui/filter-toggle"
import {
    Camera,
    Aperture,
    Lightbulb,
    Mic,
    Video,
    Grip,
    Headphones,
    Laptop,
    Package,
    List,
} from "lucide-react"

// –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è —Å–æ–ø–æ—Å—Ç–∞–≤–ª–µ–Ω–∏—è —Ç–∏–ø–∞ –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—è —Å –∏–∫–æ–Ω–∫–æ–π
const getIconForType = (type: string): ReactNode => {
    const iconMap: Record<string, ReactNode> = {
        "–§–æ—Ç–æ–∫–∞–º–µ—Ä–∞": <Camera />,
        "–û–±—ä–µ–∫—Ç–∏–≤": <Aperture />,
        "–°–≤–µ—Ç": <Lightbulb />,
        "–ú–∏–∫—Ä–æ—Ñ–æ–Ω": <Mic />,
        "–≠–∫—à–Ω –∫–∞–º–µ—Ä–∞": <Video />,
        "–®—Ç–∞—Ç–∏–≤—ã": <Grip />,
        "–ê—É–¥–∏–æ–æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏–µ": <Headphones />,
        "–ö–æ–º–ø—å—é—Ç–µ—Ä–Ω–∞—è —Ç–µ—Ö–Ω–∏–∫–∞": <Laptop />,
        "–ü—Ä–æ—á–µ–µ": <Package />,
    }
    // –í–æ–∑–≤—Ä–∞—â–∞–µ–º —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â—É—é –∏–∫–æ–Ω–∫—É –∏–ª–∏ null, –µ—Å–ª–∏ —Å–æ–≤–ø–∞–¥–µ–Ω–∏—è –Ω–µ –Ω–∞–π–¥–µ–Ω—ã
    return iconMap[type] || null
}

interface TypeFilterProps {
    items: Equipment[]
}

export default function TypeFilter({ items }: TypeFilterProps) {
    const { type, setType } = useFilterStore()

    const types = useMemo(() => {
        const uniqueTypes = new Set(items.map((eq) => eq.equipment_type))
        return Array.from(uniqueTypes)
    }, [items])

    return (
        <ToggleGroup
            type="single"
            value={type ?? "__all__"}
            onValueChange={(val: string) => setType(val === "__all__" ? null : val)}
            className="flex flex-wrap gap-2"
        >
            <ToggleGroupItem
                value="__all__"
                className={getFilterToggleClass()}
            >
                <List />
                –í—Å–µ
            </ToggleGroupItem>

            {types.map((t) => (
                <ToggleGroupItem
                    key={t}
                    value={t}
                    className={getFilterToggleClass()}
                >
                    {getIconForType(t)}
                    {t}
                </ToggleGroupItem>
            ))}
        </ToggleGroup>
    )
}

```


## <a name="srccomponentsUserInfoBlocktsx"></a>`src/components/UserInfoBlock.tsx`

```tsx
// path: src/components/UserInfoBlock.tsx

// src/components/UserInfoBlock.tsx
import { Button } from "@/components/ui/button";
import { useNavigate, useLocation } from "react-router-dom";
import { useCurrentUser } from "@/hooks/useProfile";
import { useAuthStore } from "@/store/authStore";
import {
    Shield,
    Calendar,
    Edit,
    FileText,
    LogOut,
    Settings,
    HelpCircle,
    AlertTriangle,
    Send
} from "lucide-react";

type Props = {
    onEditProfile?: () => void;
    showExtraLinks?: boolean;
};

export default function UserInfoBlock({ onEditProfile, showExtraLinks = false }: Props) {
    const { data: user, isLoading, isError } = useCurrentUser();
    const { logout } = useAuthStore();
    const navigate = useNavigate();
    const location = useLocation();

    if (isLoading) {
        return (
            <div className="w-full">
                <div className="bg-gradient-to-r from-white to-gray-50 border border-gray-200 rounded-lg shadow-sm p-4">
                    <p className="text-center text-sm text-gray-500">–ó–∞–≥—Ä—É–∑–∫–∞...</p>
                </div>
            </div>
        );
    }

    if (isError || !user) {
        return (
            <div className="w-full">
                <div className="bg-gradient-to-r from-white to-gray-50 border border-gray-200 rounded-lg shadow-sm p-4">
                    <p className="text-center text-sm text-red-600">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ø—Ä–æ—Ñ–∏–ª—è</p>
                </div>
            </div>
        );
    }

    const isAdmin = user.role === "admin";
    const isManager = user.role === "manager" || isAdmin;

    const getRoleInfo = () => {
        if (isAdmin) return { label: "–ê–¥–º–∏–Ω", color: "text-red-600", icon: "üëë", bg: "bg-red-50" };
        if (isManager) return { label: "–ú–µ–Ω–µ–¥–∂–µ—Ä", color: "text-blue-600", icon: "üõ°Ô∏è", bg: "bg-blue-50" };
        return { label: "–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å", color: "text-gray-600", icon: "üë§", bg: "bg-gray-50" };
    };

    const roleInfo = getRoleInfo();

    // ‚úÖ –ò–ó–ú–ï–ù–ï–ù–ò–ï: –î–æ–±–∞–≤–ª—è–µ–º —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∏ –ø—Ä–æ–≤–µ—Ä–∫—É –±–∞–ª–∞–Ω—Å–∞
    const balance = user.balance ?? 0;
    const balanceColor = balance < 0 ? 'text-red-600' : 'text-green-700';

    return (
        <div className="w-full">
            <div className="bg-gradient-to-r from-white to-gray-50 border border-gray-200 rounded-lg shadow-sm">
                <div className="flex flex-col lg:flex-row items-stretch">
                    <div className="flex-1 p-3 lg:p-4">
                        <div className="flex items-center gap-3">
                            <div className={`w-12 h-12 ${roleInfo.bg} rounded-full flex items-center justify-center text-lg flex-shrink-0`}>
                                {roleInfo.icon}
                            </div>
                            <div className="flex-1 min-w-0">
                                <div className="flex flex-col lg:flex-row lg:items-start lg:gap-6">
                                    <div className="min-w-0">
                                        <div>
                                            <h3 className="font-semibold text-gray-900 text-sm truncate">
                                                {user.full_name}
                                            </h3>
                                            <p className="text-xs text-gray-600 truncate">{user.email}</p>
                                        </div>
                                    </div>
                                    <div className="flex items-center gap-4 mt-2 lg:mt-0">
                                        <div className="flex items-center gap-1">
                                            <Shield className="w-3 h-3 text-gray-400" />
                                            <span className={`text-xs font-medium ${roleInfo.color}`}>
                                                {roleInfo.label}
                                            </span>
                                        </div>
                                        <div className="flex items-center gap-1 text-xs text-gray-500">
                                            <span>–ë–∞–ª–∞–Ω—Å:</span>
                                            {/* ‚úÖ –ò–ó–ú–ï–ù–ï–ù–ò–ï: –ü—Ä–∏–º–µ–Ω—è–µ–º —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∏ —Ü–≤–µ—Ç */}
                                            <span className={`font-semibold ${balanceColor}`}>
                                                {balance.toLocaleString('ru-RU', { style: 'currency', currency: 'RUB' })}
                                            </span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    {showExtraLinks && (
                        <div className="p-3 lg:p-4 lg:border-l lg:border-r border-gray-200 lg:w-[260px] lg:flex-shrink-0">
                            <h4 className="text-xs text-gray-500 mb-2 font-semibold">–ü–æ–ª–µ–∑–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è:</h4>
                            <div className="space-y-1.5">
                                <a
                                    href="/how-it-works"
                                    onClick={(e) => {
                                        e.preventDefault();
                                        alert("–°—Ç—Ä–∞–Ω–∏—Ü–∞ '–ö–∞–∫ —Ä–∞–±–æ—Ç–∞–µ—Ç –ø—Ä–æ–∫–∞—Ç?' –µ—â–µ –Ω–µ —Å–æ–∑–¥–∞–Ω–∞.");
                                    }}
                                    className="flex items-center text-sm text-gray-700 hover:text-sky-600 hover:underline transition-colors duration-150"
                                >
                                    <HelpCircle className="w-4 h-4 mr-2 text-gray-400 flex-shrink-0" />
                                    –ö–∞–∫ —Ä–∞–±–æ—Ç–∞–µ—Ç –ø—Ä–æ–∫–∞—Ç?
                                </a>
                                <a
                                    href="/rules"
                                    onClick={(e) => {
                                        e.preventDefault();
                                        alert("–°—Ç—Ä–∞–Ω–∏—Ü–∞ '–ù–∞—à–∏ –ø—Ä–∞–≤–∏–ª–∞' –µ—â–µ –Ω–µ —Å–æ–∑–¥–∞–Ω–∞.");
                                    }}
                                    className="flex items-center text-sm text-gray-700 hover:text-sky-600 hover:underline transition-colors duration-150"
                                >
                                    <AlertTriangle className="w-4 h-4 mr-2 text-orange-400 flex-shrink-0" />
                                    –ù–∞—à–∏ –ø—Ä–∞–≤–∏–ª–∞
                                </a>
                                <button
                                    onClick={() => navigate("/contacts", { state: { from: location.pathname } })}
                                    className="flex items-center text-sm text-gray-700 hover:text-sky-600 hover:underline w-full text-left transition-colors duration-150"
                                >
                                    <Send className="w-4 h-4 mr-2 text-blue-400 flex-shrink-0" />
                                    –°–≤—è–∑–∞—Ç—å—Å—è —Å –Ω–∞–º–∏
                                </button>
                            </div>
                        </div>
                    )}

                    <div className="border-t lg:border-t-0 lg:border-l bg-gray-50 lg:bg-transparent p-3 lg:p-4 lg:w-[300px] lg:ml-auto lg:flex-shrink-0">
                        <div className="flex gap-2 w-full">
                            <div className="flex flex-col gap-2 flex-1">
                                <Button
                                    variant="default"
                                    onClick={() =>
                                        navigate("/reservations/my", { state: { from: location.pathname } })
                                    }
                                    className="h-8 px-3 text-xs flex items-center justify-center gap-1.5 w-full"
                                    size="sm"
                                >
                                    <FileText className="w-3 h-3" />
                                    –ú–æ–∏ –∑–∞–∫–∞–∑—ã
                                </Button>
                                <Button
                                    onClick={() => navigate("/calendar", { state: { from: location.pathname } })}
                                    className="h-8 px-3 text-xs flex items-center justify-center gap-1.5 bg-amber-500 hover:bg-amber-600 text-white w-full"
                                    size="sm"
                                >
                                    <Calendar className="w-3 h-3" />
                                    –ö–∞–ª–µ–Ω–¥–∞—Ä—å
                                </Button>
                                {isManager && (
                                    <Button
                                        variant="secondary"
                                        onClick={() => navigate("/admin")}
                                        className="h-8 px-3 text-xs flex items-center justify-center gap-1.5 bg-gray-800 hover:bg-gray-700 text-white w-full"
                                        size="sm"
                                    >
                                        <Settings className="w-3 h-3" />
                                        {isAdmin ? "–ê–¥–º–∏–Ω –ø–∞–Ω–µ–ª—å" : "–ü–∞–Ω–µ–ª—å –º–µ–Ω–µ–¥–∂–µ—Ä–∞"}
                                    </Button>
                                )}
                            </div>
                            <div className="flex flex-col gap-2">
                                <Button
                                    variant="outline"
                                    onClick={
                                        onEditProfile
                                            ? onEditProfile
                                            : () => navigate("/profile", { state: { from: location.pathname } })
                                    }
                                    className="h-8 px-3 text-xs flex items-center justify-center gap-1.5"
                                    size="sm"
                                >
                                    <Edit className="w-3 h-3" />
                                    –ü—Ä–æ—Ñ–∏–ª—å
                                </Button>
                                <Button
                                    variant="destructive"
                                    onClick={logout}
                                    className="h-8 px-3 text-xs flex items-center justify-center gap-1.5"
                                    size="sm"
                                >
                                    <LogOut className="w-3 h-3" />
                                    –í—ã–π—Ç–∏
                                </Button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    );
}

```


## <a name="srccomponentsViewModeToggletsx"></a>`src/components/ViewModeToggle.tsx`

```tsx
// path: src/components/ViewModeToggle.tsx

// src/components/ViewModeToggle.tsx

import { ToggleGroup, ToggleGroupItem } from "@/components/ui/toggle-group";
import { LayoutGrid, List } from "lucide-react";
// –ò–º–ø–æ—Ä—Ç–∏—Ä—É–µ–º –æ–±–Ω–æ–≤–ª–µ–Ω–Ω—ã–π —Å—Ç–æ—Ä
import { useViewModeStore, type ViewMode } from "@/store/viewModeStore";

export default function ViewModeToggle() {
  // –ò—Å–ø–æ–ª—å–∑—É–µ–º –Ω–æ–≤—ã–µ –º–µ—Ç–æ–¥—ã –∏–∑ —Å—Ç–æ—Ä–∞
  const { viewMode, setViewMode } = useViewModeStore();

  return (
      <ToggleGroup
          type="single"
          value={viewMode}
          onValueChange={(value: ViewMode) => {
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –∑–Ω–∞—á–µ–Ω–∏–µ –Ω–µ –ø—É—Å—Ç–æ–µ, –ø—Ä–µ–∂–¥–µ —á–µ–º –æ–±–Ω–æ–≤–ª—è—Ç—å —Å—Ç–æ—Ä
            if (value) setViewMode(value);
          }}
          className="flex items-center"
          aria-label="–ü–µ—Ä–µ–∫–ª—é—á–∞—Ç–µ–ª—å –≤–∏–¥–∞ –∫–∞—Ä—Ç–æ—á–µ–∫"
      >
        <ToggleGroupItem value="default" aria-label="–°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π –≤–∏–¥" className="p-2 h-9 w-9">
          <LayoutGrid className="h-4 w-4" />
        </ToggleGroupItem>
        <ToggleGroupItem value="compact" aria-label="–ö–æ–º–ø–∞–∫—Ç–Ω—ã–π –≤–∏–¥" className="p-2 h-9 w-9">
          <List className="h-4 w-4" />
        </ToggleGroupItem>
      </ToggleGroup>
  );
}

```


## <a name="srccomponentsadminAccessoryDialogstsx"></a>`src/components/admin/AccessoryDialogs.tsx`

```tsx
// path: src/components/admin/AccessoryDialogs.tsx

// src/components/admin/AccessoryDialogs.tsx
import { useForm } from "react-hook-form";
import { zodResolver } from "@hookform/resolvers/zod";
import { accessorySchema, AccessorySchema } from "@/lib/validationSchemas";
import { useCreateAccessory, useUpdateAccessory } from "@/hooks/useAdminAccessories";
import type { Accessory } from "@/types/accessory";

import { Button } from "@/components/ui/button";
import { Input } from "@/components/ui/input";
import { Label } from "@/components/ui/label";
import { Textarea } from "@/components/ui/textarea";
import {
    Dialog,
    DialogContent,
    DialogHeader,
    DialogTitle,
    DialogFooter,
    DialogDescription,
} from "@/components/ui/dialog";

// --- –î–∏–∞–ª–æ–≥ —Å–æ–∑–¥–∞–Ω–∏—è ---
interface CreateProps {
    open: boolean;
    onClose: () => void;
}
export function AccessoryCreateDialog({ open, onClose }: CreateProps) {
    const createMutation = useCreateAccessory();
    const { register, handleSubmit, formState: { errors, isValid }, reset } = useForm<AccessorySchema>({
        resolver: zodResolver(accessorySchema) as any,
        mode: "onChange",
    });

    const onSubmit = (data: AccessorySchema) => {
        createMutation.mutate(data, {
            onSuccess: () => {
                reset();
                onClose();
            },
        });
    };

    return (
        <Dialog open={open} onOpenChange={onClose}>
            <DialogContent>
                <DialogHeader>
                    <DialogTitle>–ù–æ–≤—ã–π –∞–∫—Å–µ—Å—Å—É–∞—Ä</DialogTitle>
                    <DialogDescription>–°–æ–∑–¥–∞–π—Ç–µ –Ω–æ–≤—É—é –∑–∞–ø–∏—Å—å –≤ –∫–∞—Ç–∞–ª–æ–≥–µ –∞–∫—Å–µ—Å—Å—É–∞—Ä–æ–≤.</DialogDescription>
                </DialogHeader>
                <form onSubmit={handleSubmit(onSubmit)} className="space-y-4 py-2">
                    {/* ... –ø–æ–ª—è —Ñ–æ—Ä–º—ã ... */}
                    <div>
                        <Label htmlFor="name">–ù–∞–∑–≤–∞–Ω–∏–µ *</Label>
                        <Input id="name" {...register("name")} placeholder="–ê–∫–∫—É–º—É–ª—è—Ç–æ—Ä LP-E6" />
                        {errors.name && <p className="text-xs text-red-600 mt-1">{errors.name.message}</p>}
                    </div>
                    <div className="grid grid-cols-2 gap-4">
                        <div>
                            <Label htmlFor="accessory_type">–¢–∏–ø</Label>
                            <Input id="accessory_type" {...register("accessory_type")} placeholder="–ü–∏—Ç–∞–Ω–∏–µ"/>
                        </div>
                        <div>
                            <Label htmlFor="price">–¶–µ–Ω–∞ (‚ÇΩ/–¥–µ–Ω—å)</Label>
                            <Input id="price" type="number" step="0.01" {...register("price")} placeholder="100"/>
                            {errors.price && <p className="text-xs text-red-600 mt-1">{errors.price.message}</p>}
                        </div>
                    </div>
                    <div>
                        <Label htmlFor="description">–û–ø–∏—Å–∞–Ω–∏–µ</Label>
                        <Textarea id="description" {...register("description")} placeholder="–î–ª—è –∫–∞–º–µ—Ä Canon R, R5, R6..." />
                    </div>
                    <DialogFooter>
                        <Button type="button" variant="ghost" onClick={onClose}>–û—Ç–º–µ–Ω–∞</Button>
                        <Button type="submit" disabled={!isValid || createMutation.isPending}>
                            {createMutation.isPending ? "–°–æ–∑–¥–∞–Ω–∏–µ..." : "–°–æ–∑–¥–∞—Ç—å"}
                        </Button>
                    </DialogFooter>
                </form>
            </DialogContent>
        </Dialog>
    );
}

// --- –î–∏–∞–ª–æ–≥ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è ---
interface EditProps {
    accessory: Accessory | null;
    open: boolean;
    onClose: () => void;
}
export function AccessoryEditDialog({ accessory, open, onClose }: EditProps) {
    const updateMutation = useUpdateAccessory();
    const { register, handleSubmit, formState: { errors, isValid }, reset } = useForm<AccessorySchema>({
        resolver: zodResolver(accessorySchema) as any,
        mode: "onChange",
        // 'key' –≤ defaultValues –Ω–µ—è–≤–Ω–æ —Å–±—Ä–∞—Å—ã–≤–∞–µ—Ç —Å–æ—Å—Ç–æ—è–Ω–∏–µ —Ñ–æ—Ä–º—ã –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ accessory
        defaultValues: {
            name: accessory?.name || "",
            accessory_type: accessory?.accessory_type || "",
            price: accessory?.price || 0,
            description: accessory?.description || "",
        },
    });

    const onSubmit = (data: AccessorySchema) => {
        if (!accessory) return;
        updateMutation.mutate({ id: accessory.id, data }, {
            onSuccess: () => {
                reset(data);
                onClose();
            },
        });
    };

    if (!accessory) return null;

    return (
        <Dialog open={open} onOpenChange={onClose}>
            <DialogContent>
                <DialogHeader>
                    <DialogTitle>–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –∞–∫—Å–µ—Å—Å—É–∞—Ä</DialogTitle>
                    <DialogDescription>"{accessory.name}"</DialogDescription>
                </DialogHeader>
                <form onSubmit={handleSubmit(onSubmit)} className="space-y-4 py-2">
                    {/* ... –ø–æ–ª—è —Ñ–æ—Ä–º—ã ... */}
                    <div>
                        <Label htmlFor="edit-name">–ù–∞–∑–≤–∞–Ω–∏–µ *</Label>
                        <Input id="edit-name" {...register("name")} />
                        {errors.name && <p className="text-xs text-red-600 mt-1">{errors.name.message}</p>}
                    </div>
                    <div className="grid grid-cols-2 gap-4">
                        <div>
                            <Label htmlFor="edit-accessory_type">–¢–∏–ø</Label>
                            <Input id="edit-accessory_type" {...register("accessory_type")} />
                        </div>
                        <div>
                            <Label htmlFor="edit-price">–¶–µ–Ω–∞ (‚ÇΩ/–¥–µ–Ω—å)</Label>
                            <Input id="edit-price" type="number" step="0.01" {...register("price")} />
                            {errors.price && <p className="text-xs text-red-600 mt-1">{errors.price.message}</p>}
                        </div>
                    </div>
                    <div>
                        <Label htmlFor="edit-description">–û–ø–∏—Å–∞–Ω–∏–µ</Label>
                        <Textarea id="edit-description" {...register("description")} />
                    </div>
                    <DialogFooter>
                        <Button type="button" variant="ghost" onClick={onClose}>–û—Ç–º–µ–Ω–∞</Button>
                        <Button type="submit" disabled={!isValid || updateMutation.isPending}>
                            {updateMutation.isPending ? "–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ..." : "–°–æ—Ö—Ä–∞–Ω–∏—Ç—å"}
                        </Button>
                    </DialogFooter>
                </form>
            </DialogContent>
        </Dialog>
    );
}

```


## <a name="srccomponentsadminAccessoryTabletsx"></a>`src/components/admin/AccessoryTable.tsx`

```tsx
// path: src/components/admin/AccessoryTable.tsx

// src/components/admin/AccessoryTable.tsx

import { useState } from "react";
import { useAccessories, useDeleteAccessory } from "@/hooks/useAdminAccessories";
import type { Accessory } from "@/types/accessory";
import { AccessoryCreateDialog, AccessoryEditDialog } from "./AccessoryDialogs";

import { Button } from "@/components/ui/button";
import { Input } from "@/components/ui/input";
import {
    Table,
    TableBody,
    TableCell,
    TableHead,
    TableHeader,
    TableRow,
} from "@/components/ui/table";
import { Plus, Edit, Trash2, Search, Wrench, ChevronLeft, ChevronRight } from "lucide-react";

const PAGE_SIZE = 15;

export default function AccessoryTable() {
    // +++ –ù–ê–ß–ê–õ–û –ò–ó–ú–ï–ù–ï–ù–ò–ô +++
    const [currentPage, setCurrentPage] = useState(1);
    const { data: accessoriesResponse, isLoading, error } = useAccessories(currentPage, PAGE_SIZE);
    const deleteMutation = useDeleteAccessory();

    const accessories = accessoriesResponse?.items ?? [];
    const totalAccessories = accessoriesResponse?.total ?? 0;
    const totalPages = Math.ceil(totalAccessories / PAGE_SIZE);
    // +++ –ö–û–ù–ï–¶ –ò–ó–ú–ï–ù–ï–ù–ò–ô +++

    const [search, setSearch] = useState("");
    const [isCreateOpen, setCreateOpen] = useState(false);
    const [editingAccessory, setEditingAccessory] = useState<Accessory | null>(null);

    const filteredAccessories = accessories.filter(acc =>
        acc.name.toLowerCase().includes(search.toLowerCase()) ||
        (acc.accessory_type && acc.accessory_type.toLowerCase().includes(search.toLowerCase()))
    );

    const handleDelete = (id: number) => {
        if (window.confirm("–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å —ç—Ç–æ—Ç –∞–∫—Å–µ—Å—Å—É–∞—Ä?")) {
            deleteMutation.mutate(id);
        }
    };

    if (isLoading) return <p>–ó–∞–≥—Ä—É–∑–∫–∞ –∞–∫—Å–µ—Å—Å—É–∞—Ä–æ–≤...</p>;
    if (error) return <p className="text-red-600">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö.</p>;

    return (
        <>
            <div className="flex items-center justify-between gap-4 mb-4">
                <div className="relative w-full max-w-sm">
                    <Search className="absolute left-3 top-2.5 h-4 w-4 text-muted-foreground" />
                    <Input
                        placeholder="–ü–æ–∏—Å–∫ –ø–æ –Ω–∞–∑–≤–∞–Ω–∏—é –∏–ª–∏ —Ç–∏–ø—É..."
                        value={search}
                        onChange={(e) => setSearch(e.target.value)}
                        className="pl-10"
                    />
                </div>
                <Button onClick={() => setCreateOpen(true)}>
                    <Plus className="mr-2 h-4 w-4" /> –î–æ–±–∞–≤–∏—Ç—å –∞–∫—Å–µ—Å—Å—É–∞—Ä
                </Button>
            </div>
            {filteredAccessories.length > 0 ? (
                <>
                    <div className="border rounded-md">
                        <Table>
                            <TableHeader>
                                <TableRow>
                                    <TableHead className="w-[100px]">ID</TableHead>
                                    <TableHead>–ù–∞–∑–≤–∞–Ω–∏–µ</TableHead>
                                    <TableHead>–¢–∏–ø</TableHead>
                                    <TableHead>–¶–µ–Ω–∞</TableHead>
                                    <TableHead className="text-right">–î–µ–π—Å—Ç–≤–∏—è</TableHead>
                                </TableRow>
                            </TableHeader>
                            <TableBody>
                                {filteredAccessories.map((acc) => (
                                    <TableRow key={acc.id}>
                                        <TableCell>{acc.id}</TableCell>
                                        <TableCell className="font-medium">{acc.name}</TableCell>
                                        <TableCell>{acc.accessory_type}</TableCell>
                                        <TableCell>{acc.price} ‚ÇΩ</TableCell>
                                        <TableCell className="text-right">
                                            <Button variant="ghost" size="icon" onClick={() => setEditingAccessory(acc)}>
                                                <Edit className="h-4 w-4" />
                                            </Button>
                                            <Button variant="ghost" size="icon" onClick={() => handleDelete(acc.id)} disabled={deleteMutation.isPending}>
                                                <Trash2 className="h-4 w-4 text-red-500" />
                                            </Button>
                                        </TableCell>
                                    </TableRow>
                                ))}
                            </TableBody>
                        </Table>
                    </div>
                    {/* +++ –ù–ê–ß–ê–õ–û: –ö–Ω–æ–ø–∫–∏ –ø–∞–≥–∏–Ω–∞—Ü–∏–∏ +++ */}
                    <div className="flex items-center justify-end space-x-2 py-4">
                        <span className="text-sm text-muted-foreground">
                            –°—Ç—Ä–∞–Ω–∏—Ü–∞ {currentPage} –∏–∑ {totalPages}
                        </span>
                        <Button
                            variant="outline"
                            size="sm"
                            onClick={() => setCurrentPage(prev => Math.max(prev - 1, 1))}
                            disabled={currentPage === 1}
                        >
                            <ChevronLeft className="h-4 w-4" />
                            –ù–∞–∑–∞–¥
                        </Button>
                        <Button
                            variant="outline"
                            size="sm"
                            onClick={() => setCurrentPage(prev => Math.min(prev + 1, totalPages))}
                            disabled={currentPage === totalPages}
                        >
                            –í–ø–µ—Ä–µ–¥
                            <ChevronRight className="h-4 w-4" />
                        </Button>
                    </div>
                    {/* +++ –ö–û–ù–ï–¶: –ö–Ω–æ–ø–∫–∏ –ø–∞–≥–∏–Ω–∞—Ü–∏–∏ +++ */}
                </>
            ) : (
                <div className="text-center py-12 px-4 border rounded-md">
                    <Wrench className="w-16 h-16 text-gray-300 mx-auto mb-3" />
                    <h3 className="text-lg font-semibold text-gray-700">–ê–∫—Å–µ—Å—Å—É–∞—Ä—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã</h3>
                    <p className="text-sm text-gray-500 mt-1">{search ? "–ü–æ–ø—Ä–æ–±—É–π—Ç–µ –∏–∑–º–µ–Ω–∏—Ç—å –ø–æ–∏—Å–∫–æ–≤—ã–π –∑–∞–ø—Ä–æ—Å." : "–î–æ–±–∞–≤—å—Ç–µ –ø–µ—Ä–≤—ã–π –∞–∫—Å–µ—Å—Å—É–∞—Ä, —á—Ç–æ–±—ã –æ–Ω –ø–æ—è–≤–∏–ª—Å—è –≤ —Å–ø–∏—Å–∫–µ."}</p>
                </div>
            )}

            <AccessoryCreateDialog open={isCreateOpen} onClose={() => setCreateOpen(false)} />
            <AccessoryEditDialog accessory={editingAccessory} open={!!editingAccessory} onClose={() => setEditingAccessory(null)} />
        </>
    );
}

```


## <a name="srccomponentsadminAdminNavigationtsx"></a>`src/components/admin/AdminNavigation.tsx`

```tsx
// path: src/components/admin/AdminNavigation.tsx

// src/components/admin/AdminNavigation.tsx

import { useCurrentUser } from "@/hooks/useProfile";
import { Button } from "@/components/ui/button";
import { useNavigate, useLocation } from "react-router-dom";
import { Users, Package, Shield, Home, Paperclip, ClipboardList, TicketPercent, CalendarDays, Tags, Truck } from "lucide-react"; // <-- –î–æ–±–∞–≤–ª–µ–Ω–∞ –∏–∫–æ–Ω–∫–∞ Truck

export default function AdminNavigation() {
    const { data: user } = useCurrentUser();
    const navigate = useNavigate();
    const location = useLocation();

    const isAdmin = user?.role === "admin";
    const isManager = user?.role === "manager" || isAdmin;

    if (!isManager) return null;

    const navigationItems = [
        {
            path: "/admin",
            label: "–û–±–∑–æ—Ä",
            icon: <Shield className="w-4 h-4" />,
            accessible: isManager
        },
        {
            path: "/admin/reservations",
            label: "–í—Å–µ —Ä–µ–∑–µ—Ä–≤—ã",
            icon: <ClipboardList className="w-4 h-4" />,
            accessible: isManager
        },
        // +++ –ù–û–í–´–ô –ü–£–ù–ö–¢ –ú–ï–ù–Æ +++
        {
            path: "/admin/rentals",
            label: "–ê—Ä–µ–Ω–¥—ã",
            icon: <Truck className="w-4 h-4" />,
            accessible: isManager
        },
        // ++++++++++++++++++++++++
        {
            path: "/admin/users",
            label: "–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏",
            icon: <Users className="w-4 h-4" />,
            accessible: isManager,
        },
        {
            path: "/admin/equipment",
            label: "–û–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏–µ",
            icon: <Package className="w-4 h-4" />,
            accessible: isManager
        },
        {
            path: "/admin/accessories",
            label: "–ê–∫—Å–µ—Å—Å—É–∞—Ä—ã",
            icon: <Paperclip className="w-4 h-4" />,
            accessible: isManager
        },
        {
            path: "/admin/associations",
            label: "–ê—Å—Å–æ—Ü–∏–∞—Ü–∏–∏",
            icon: <Tags className="w-4 h-4" />,
            accessible: isManager
        },
        {
            path: "/admin/promocodes",
            label: "–ü—Ä–æ–º–æ–∫–æ–¥—ã –∏ –°–∫–∏–¥–∫–∏",
            icon: <TicketPercent className="w-4 h-4" />,
            accessible: isManager
        },
        {
            path: "/admin/holidays",
            label: "–í—ã—Ö–æ–¥–Ω—ã–µ –¥–Ω–∏",
            icon: <CalendarDays className="w-4 h-4" />,
            accessible: isAdmin
        }
    ];

    const isActive = (path: string) => {
        if (path === "/admin") {
            return location.pathname === "/admin";
        }
        return location.pathname.startsWith(path);
    };

    return (
        <div className="bg-white border rounded-lg shadow-sm p-4 mb-6">
            <div className="flex items-center justify-between mb-4">
                <h2 className="text-lg font-semibold text-gray-900">
                    –ü–∞–Ω–µ–ª—å —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è
                </h2>
                <Button
                    variant="outline"
                    size="sm"
                    onClick={() => navigate("/")}
                >
                    <Home className="w-4 h-4 mr-2" />
                    –ù–∞ –≥–ª–∞–≤–Ω—É—é
                </Button>
            </div>

            <div className="flex items-center text-sm text-gray-600 mb-4">
                <span>–†–æ–ª—å: </span>
                <span className={`ml-1 font-medium ${
                    isAdmin ? "text-red-600" : "text-blue-600"
                }`}>
                    {user?.role === "admin" ? "–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä" : "–ú–µ–Ω–µ–¥–∂–µ—Ä"}
                </span>
            </div>

            <div className="flex flex-wrap gap-2">
                {navigationItems
                    .filter(item => item.accessible)
                    .map((item) => (
                        <Button
                            key={item.path}
                            variant={isActive(item.path) ? "default" : "outline"}
                            size="sm"
                            onClick={() => navigate(item.path)}
                            className="flex items-center gap-2"
                        >
                            {item.icon}
                            <span>{item.label}</span>
                        </Button>
                    ))
                }
            </div>
        </div>
    );
}

```


## <a name="srccomponentsadminAdminRentalCardtsx"></a>`src/components/admin/AdminRentalCard.tsx`

```tsx
// path: src/components/admin/AdminRentalCard.tsx

// src/components/admin/AdminRentalCard.tsx

import { useState, useMemo, useRef, useEffect } from "react";
import { useNavigate, useLocation } from "react-router-dom";
import { Card, CardContent } from "@/components/ui/card";
import { Button } from "@/components/ui/button";
// ‚úÖ –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï 1: –£–±–∏—Ä–∞–µ–º –Ω–µ–∏—Å–ø–æ–ª—å–∑—É–µ–º—ã–µ –∏–∫–æ–Ω–∫–∏ Wallet, Landmark, Paperclip
import { Calendar, Edit, Package, Trash2, User, Truck, RotateCcw, List, ChevronDown, Link as LinkIcon, ReceiptText } from "lucide-react";
import { formatDateEuropean, cn } from "@/lib/utils";
import RentalStatusBadge from "./RentalStatusBadge";
import type { AdminRentalOut } from "@/types/rental";
import { useCurrentUser } from "@/hooks/useProfile";
import { useDeleteAdminRental, useRevertRentalToReservation } from "@/hooks/useAdminRentals";
import { ConfirmationDialog } from "@/components/ui/confirmation-dialog";
import type { Equipment } from "@/types/equipment";
import EditableRentalCard from "./EditableRentalCard";
import EquipmentWithAccessoriesList from "@/components/shared/EquipmentWithAccessoriesList";
import { RENTAL_CARD_STYLES } from "@/constants/statusStyles";

interface Props {
    rental: AdminRentalOut;
    onReturn: (rental: AdminRentalOut) => void;
    highlightId?: number;
}

const isToday = (dateString: string): boolean => {
    const date = new Date(dateString);
    const today = new Date();
    return date.getFullYear() === today.getFullYear() &&
        date.getMonth() === today.getMonth() &&
        date.getDate() === today.getDate();
};

export default function AdminRentalCard({ rental, onReturn, highlightId }: Props) {
    const { data: currentUser } = useCurrentUser();
    const deleteMutation = useDeleteAdminRental();
    const revertMutation = useRevertRentalToReservation();
    const [isConfirmingRevert, setConfirmingRevert] = useState(false);
    const [isExpanded, setIsExpanded] = useState(true);
    const [isEditing, setIsEditing] = useState(false);
    const navigate = useNavigate();
    const location = useLocation();
    const cardRef = useRef<HTMLDivElement>(null);

    const isHighlighted = highlightId === rental.id;

    const isAdmin = currentUser?.role === 'admin';
    const canRevert = rental.reservation_id && rental.status !== 'completed' && isToday(rental.created_at);

    const handleDelete = () => {
        if (window.confirm(`–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ –±–µ–∑–≤–æ–∑–≤—Ä–∞—Ç–Ω–æ —É–¥–∞–ª–∏—Ç—å –∞—Ä–µ–Ω–¥—É #${rental.id}? –≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ –Ω–µ–ª—å–∑—è –æ—Ç–º–µ–Ω–∏—Ç—å.`)) {
            deleteMutation.mutate(rental.id);
        }
    };

    const handleRevert = () => {
        revertMutation.mutate(rental.id, {
            onSuccess: () => setConfirmingRevert(false),
            onError: () => setConfirmingRevert(false),
        });
    };


    const handleNavigateToReservation = (reservationId: number) => {
        navigate('/admin/reservations', {
            state: {
                highlightId: reservationId,
                statusFilterOverride: 'all'
            }
        });
    };

    useEffect(() => {
        if (isHighlighted && cardRef.current) {
            cardRef.current.scrollIntoView({
                behavior: "smooth",
                block: "center",
            });
        }
    }, [isHighlighted]);

    if (isEditing) {
        return <EditableRentalCard rental={rental} onCancel={() => setIsEditing(false)} />;
    }

    const statusClass = RENTAL_CARD_STYLES[rental.status] || RENTAL_CARD_STYLES.default;
    
    const highlightClass = isHighlighted
        ? "ring-2 ring-offset-2 ring-amber-500 border-amber-400 bg-amber-50"
        : "";

    return (
        <>
            <div ref={cardRef} className={`relative w-full rounded-lg border transition-all hover:shadow-md ${highlightClass}`}>
                <Card className={cn("w-full", statusClass)}>
                    <CardContent className="p-4">
                        <div className="flex flex-col md:flex-row gap-4 justify-between">
                            {/* –ë–ª–æ–∫ —Å –æ—Å–Ω–æ–≤–Ω–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–µ–π */}
                            <div className="flex-1 space-y-2.5">
                                <div className="flex items-center gap-4">
                                    <h3 className="font-bold text-lg text-orange-700 flex items-center gap-2">
                                        <Truck className="w-5 h-5"/> –ê—Ä–µ–Ω–¥–∞ #{rental.id}
                                    </h3>
                                    <RentalStatusBadge status={rental.status} />
                                </div>
                                <div className="text-sm text-gray-700 space-y-1.5 pl-1">
                                    <div className="flex items-center gap-2">
                                        <User className="w-4 h-4 text-gray-500" />
                                        <span>{rental.user.full_name} ({rental.user.email})</span>
                                    </div>
                                    <div className="flex items-center gap-2">
                                        <span className="text-gray-600">–ë–∞–ª–∞–Ω—Å:</span>
                                        <span className={`font-medium ${(rental.user.balance ?? 0) < 0 ? 'text-red-600' : 'text-green-700'}`}>
                                            {(rental.user.balance ?? 0).toLocaleString('ru-RU')} ‚ÇΩ
                                        </span>
                                    </div>
                                    {rental.reservation_id && (
                                        <div className="flex items-center gap-2">
                                            <LinkIcon className="w-4 h-4 text-gray-500" />
                                            <button
                                                onClick={() => handleNavigateToReservation(rental.reservation_id!)}
                                                className="text-sky-600 hover:underline hover:text-sky-700 transition-colors"
                                            >
                                                –ò–∑ —Ä–µ–∑–µ—Ä–≤–∞ #{rental.reservation_id}
                                            </button>
                                        </div>
                                    )}
                                    <div className="flex items-center gap-2">
                                        <Calendar className="w-4 h-4 text-gray-500" />
                                        <span>{formatDateEuropean(rental.start_date)} ‚Äî {formatDateEuropean(rental.end_date)}</span>
                                    </div>
                                    <div className="flex items-start gap-2">
                                        <Package className="w-4 h-4 text-gray-500 mt-0.5 flex-shrink-0" />
                                        <div className="flex-1">
                                            <button
                                                onClick={() => setIsExpanded(!isExpanded)}
                                                className="flex items-center text-left w-full hover:text-sky-700 transition-colors disabled:hover:text-current disabled:cursor-not-allowed"
                                            >
                                                <span>–ü–æ–∑–∏—Ü–∏–π –≤ –∞—Ä–µ–Ω–¥–µ: {rental.equipment.length + (rental.accessory_links?.length ?? 0)}</span>
                                                <ChevronDown className={`w-4 h-4 ml-1 transition-transform ${isExpanded ? 'rotate-180' : ''}`} />
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            {/* –§–∏–Ω–∞–Ω—Å–æ–≤—ã–π –±–ª–æ–∫ */}
                            <div className="flex-shrink-0 md:w-64 bg-slate-50 p-3 rounded-lg border space-y-2">
                                <h4 className="font-semibold text-sm text-slate-800 flex items-center gap-2"><ReceiptText className="w-4 h-4"/>–§–∏–Ω–∞–Ω—Å—ã</h4>
                                <div className="text-xs space-y-1.5 text-slate-700">
                                    <div className="flex justify-between"><span>–û–±—â–∞—è —Å—Ç–æ–∏–º–æ—Å—Ç—å:</span> <span className="font-medium">{rental.total_cost.toLocaleString('ru-RU')} ‚ÇΩ</span></div>
                                    {rental.accessories_cost > 0 && (
                                        <div className="flex justify-between"><span>–í —Ç.—á. –∞–∫—Å–µ—Å—Å—É–∞—Ä—ã:</span> <span className="font-medium">{rental.accessories_cost.toLocaleString('ru-RU')} ‚ÇΩ</span></div>
                                    )}
                                    {rental.discount_amount > 0 && (
                                        <div className="flex justify-between"><span>–°–∫–∏–¥–∫–∞:</span> <span className="font-medium text-green-600">-{rental.discount_amount.toLocaleString('ru-RU')} ‚ÇΩ</span></div>
                                    )}
                                    {rental.prepayment_amount > 0 && (
                                        <div className="flex justify-between"><span>–ü—Ä–µ–¥–æ–ø–ª–∞—Ç–∞:</span> <span className="font-medium text-blue-600">{rental.prepayment_amount.toLocaleString('ru-RU')} ‚ÇΩ</span></div>
                                    )}
                                    <div className="flex justify-between pt-1 border-t">
                                        <span className="font-semibold text-base">–û—Å—Ç–∞—Ç–æ–∫ –∫ –æ–ø–ª–∞—Ç–µ:</span>
                                        <span className="font-bold text-base">{rental.remaining_amount.toLocaleString('ru-RU')} ‚ÇΩ</span>
                                    </div>
                                    {rental.status === 'completed' && rental.final_cost !== null && (
                                        <div className="flex justify-between pt-1 border-t border-dashed">
                                            <span className="font-semibold">–ò—Ç–æ–≥–æ–≤–∞—è —Å—Ç–æ–∏–º–æ—Å—Ç—å:</span>
                                            <span className="font-bold">{rental.final_cost.toLocaleString('ru-RU')} ‚ÇΩ</span>
                                        </div>
                                    )}
                                    <div className="flex justify-between pt-2 border-t text-slate-500">
                                        <span>–í–Ω–µ—Å–µ–Ω–Ω—ã–π –∑–∞–ª–æ–≥:</span>
                                        <span className="font-medium">{rental.deposit_amount.toLocaleString('ru-RU')} ‚ÇΩ</span>
                                    </div>
                                </div>
                            </div>

                            {/* –ë–ª–æ–∫ —Å –∫–Ω–æ–ø–∫–∞–º–∏ –¥–µ–π—Å—Ç–≤–∏–π */}
                            <div className="flex md:flex-col items-center md:items-end justify-between md:justify-start gap-2 border-t md:border-t-0 md:border-l pt-3 md:pt-0 md:pl-4">
                                <div className="flex flex-col gap-2">
                                    {canRevert && (
                                        <Button size="sm" variant="outline" onClick={() => setConfirmingRevert(true)} className="text-amber-700 border-amber-300 hover:bg-amber-50 hover:text-amber-800">
                                            <RotateCcw className="mr-2 h-4 w-4" />
                                            –û—Ç–º–µ–Ω–∏—Ç—å –≤—ã–¥–∞—á—É
                                        </Button>
                                    )}
                                    <Button size="sm" variant="outline" onClick={() => setIsEditing(true)}>
                                        <Edit className="mr-2 h-4 w-4" />
                                        –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å
                                    </Button>
                                    {rental.status !== 'completed' && (
                                        <Button size="sm" variant="default" onClick={() => onReturn(rental)}>
                                            <RotateCcw className="mr-2 h-4 w-4" />
                                            –û—Ñ–æ—Ä–º–∏—Ç—å –≤–æ–∑–≤—Ä–∞—Ç
                                        </Button>
                                    )}
                                </div>
                                {isAdmin && (
                                    <Button onClick={handleDelete} size="sm" variant="destructive" disabled={deleteMutation.isPending}>
                                        <Trash2 className="mr-2 h-4 w-4" />
                                        {deleteMutation.isPending ? "–£–¥–∞–ª–µ–Ω–∏–µ..." : "–£–¥–∞–ª–∏—Ç—å"}
                                    </Button>
                                )}
                            </div>
                        </div>

                        {/* –†–∞–∑–≤–æ—Ä–∞—á–∏–≤–∞–µ–º—ã–π –±–ª–æ–∫ —Å —Å–æ—Å—Ç–∞–≤–æ–º –∞—Ä–µ–Ω–¥—ã */}
                        {isExpanded && (
                            <div className="mt-3 pt-3 border-t border-dashed animate-in fade-in-0 slide-in-from-top-2 duration-300">
                                <div className="flex items-center gap-2 text-sm font-semibold text-gray-600 mb-2">
                                    <List className="w-4 h-4" />
                                    <span>–°–æ—Å—Ç–∞–≤ –∞—Ä–µ–Ω–¥—ã:</span>
                                </div>
                                <EquipmentWithAccessoriesList
                                    equipment={rental.equipment.map(equipmentItem => ({
                                        id: equipmentItem.id,
                                        name: `${equipmentItem.equipment_type} ${equipmentItem.brand} ${equipmentItem.name}`
                                    }))}
                                    accessoryLinks={rental.accessory_links || []}
                                    title=""
                                    showTitle={false}
                                    className="border-t-0 pt-0"
                                />
                            </div>
                        )}
                    </CardContent>
                </Card>
            </div>

            <ConfirmationDialog
                open={isConfirmingRevert}
                onOpenChange={setConfirmingRevert}
                title="–û—Ç–º–µ–Ω–∏—Ç—å –≤—ã–¥–∞—á—É –∞—Ä–µ–Ω–¥—ã?"
                description={`–ê—Ä–µ–Ω–¥–∞ #${rental.id} –±—É–¥–µ—Ç —É–¥–∞–ª–µ–Ω–∞, –∞ –∏—Å—Ö–æ–¥–Ω—ã–π —Ä–µ–∑–µ—Ä–≤ #${rental.reservation_id} —Å–Ω–æ–≤–∞ —Å—Ç–∞–Ω–µ—Ç –∞–∫—Ç–∏–≤–Ω—ã–º. –≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ –Ω–µ–ª—å–∑—è –±—É–¥–µ—Ç –æ—Ç–º–µ–Ω–∏—Ç—å.`}
                confirmText="–î–∞, –æ—Ç–º–µ–Ω–∏—Ç—å –≤—ã–¥–∞—á—É"
                cancelText="–ù–∞–∑–∞–¥"
                onConfirm={handleRevert}
                variant="destructive"
            />
        </>
    );
}

```


## <a name="srccomponentsadminAdminReservationCardtsx"></a>`src/components/admin/AdminReservationCard.tsx`

```tsx
// path: src/components/admin/AdminReservationCard.tsx

// src/components/admin/AdminReservationCard.tsx

import { useState, useMemo, useRef, useEffect } from "react";
import { useLocation, useNavigate } from "react-router-dom";
import { Card, CardContent } from "@/components/ui/card";
import { Button } from "@/components/ui/button";
import { Calendar, Edit, Package, Trash2, User, Truck, CheckCircle, AlertTriangle, XCircle, List } from "lucide-react";
import { formatDateEuropean, cn } from "@/lib/utils";
import type { AdminReservationOut } from "@/types/reservation";
import { useDeleteAdminReservation } from "@/hooks/useAdminReservations";
import { ReservationEditProvider } from "@/hooks/useInlineReservationEdit";
import EditableReservationCard from "@/components/reservation/EditableReservationCard";
import type { Equipment } from "@/types/equipment";
import { Checkbox } from "@/components/ui/checkbox";
import { useAdminReservationSelectionStore } from "@/store/adminReservationSelectionStore";
import EquipmentWithAccessoriesList from "@/components/shared/EquipmentWithAccessoriesList";
import FinancialInfoBlock from "@/components/shared/FinancialInfoBlock";
import { RESERVATION_CARD_STYLES } from "@/constants/statusStyles";

interface Props {
    reservation: AdminReservationOut;
    onConvertToRental: (reservation: AdminReservationOut) => void;
    equipmentMap: Map<number, Equipment>;
    highlightId?: number;
}

const getStatusInfo = (reservation: AdminReservationOut) => {
    const now = new Date();
    now.setHours(0, 0, 0, 0);
    const endDate = new Date(reservation.end_date);

    if (reservation.status === 'fulfilled') {
        return { text: "–í—ã–ø–æ–ª–Ω–µ–Ω", Icon: CheckCircle, className: "text-green-600 bg-green-50 border-green-200", isActionable: false };
    }
    if (reservation.status === 'cancelled') {
        return { text: "–û—Ç–º–µ–Ω–µ–Ω", Icon: XCircle, className: "text-gray-600 bg-gray-100 border-gray-200", isActionable: false };
    }
    if (endDate < now || reservation.status === 'overdue') {
        return { text: "–ü—Ä–æ—Å—Ä–æ—á–µ–Ω", Icon: AlertTriangle, className: "text-orange-600 bg-orange-50 border-orange-200", isActionable: true };
    }
    return { text: "–ê–∫—Ç–∏–≤–µ–Ω", Icon: Calendar, className: "text-blue-600 bg-blue-50 border-blue-200", isActionable: true };
};

export default function AdminReservationCard({ reservation, onConvertToRental, equipmentMap, highlightId }: Props) {
    const [isEditing, setIsEditing] = useState(false);
    const [isExpanded, setIsExpanded] = useState(false);
    const deleteReservationMutation = useDeleteAdminReservation();
    const cardRef = useRef<HTMLDivElement>(null);
    const navigate = useNavigate();
    const location = useLocation();

    const { selectedIds, toggleId } = useAdminReservationSelectionStore();
    const isSelected = selectedIds.includes(reservation.id);
    const isHighlighted = highlightId === reservation.id;

    const statusInfo = useMemo(() => getStatusInfo(reservation), [reservation]);

    useEffect(() => {
        if (isHighlighted && cardRef.current) {
            cardRef.current.scrollIntoView({
                behavior: "smooth",
                block: "center",
            });
        }
    }, [isHighlighted]);


    const handleDelete = () => {
        if (window.confirm(`–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å —Ä–µ–∑–µ—Ä–≤ #${reservation.id} –¥–ª—è –∫–ª–∏–µ–Ω—Ç–∞ "${reservation.user_info.full_name}"?`)) {
            deleteReservationMutation.mutate(reservation.id);
        }
    };

    const handleNavigateToRental = () => {
        if (reservation.rental_id) {
            navigate('/admin/rentals', {
                state: {
                    highlightId: reservation.rental_id,
                    statusFilterOverride: 'all'
                }
            });
        }
    };

    const initialEquipmentForDisplay = useMemo(() =>
            reservation.equipment_ids
                .map(id => {
                    const equipment = equipmentMap.get(id);
                    if (!equipment) {
                        return { id, label: `–û–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏–µ #${id} (–Ω–µ –Ω–∞–π–¥–µ–Ω–æ)` };
                    }
                    return { id, label: `${equipment.equipment_type} ${equipment.brand} ${equipment.name}` };
                }),
        [reservation.equipment_ids, equipmentMap]
    );

    const equipmentListForDisplay = useMemo(() =>
        reservation.equipment_ids.map(id => {
            const equipment = equipmentMap.get(id);
            return equipment
                ? `${equipment.equipment_type} ${equipment.brand} ${equipment.name}`
                : `–û–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏–µ #${id} (–Ω–µ –Ω–∞–π–¥–µ–Ω–æ)`;
        }), [reservation.equipment_ids, equipmentMap]);

    if (isEditing) {
        return (
            <ReservationEditProvider
                reservation={reservation}
                initialEquipmentForDisplay={initialEquipmentForDisplay}
                onFullCancellation={handleDelete}
                isAdminContext={true}
                onFinishEditing={() => setIsEditing(false)}
            >
                <EditableReservationCard />
            </ReservationEditProvider>
        );
    }

    const statusClass = RESERVATION_CARD_STYLES[reservation.status] || RESERVATION_CARD_STYLES.default;
    
    const highlightClass = isHighlighted
        ? "ring-2 ring-offset-2 ring-amber-500 border-amber-400 bg-amber-50"
        : isSelected
            ? 'ring-2 ring-sky-500 border-sky-400'
            : 'border-gray-200';

    return (
        <div ref={cardRef} className={`relative w-full rounded-lg border transition-all hover:shadow-md ${highlightClass}`}>
            <div className="absolute top-4 left-4 z-10">
                <Checkbox
                    checked={isSelected}
                    onCheckedChange={() => toggleId(reservation.id)}
                    aria-label={`–í—ã–±—Ä–∞—Ç—å —Ä–µ–∑–µ—Ä–≤ #${reservation.id}`}
                    className="bg-white h-5 w-5"
                />
            </div>
            <Card className={cn("w-full", statusClass)}>
                <CardContent className="p-4 pl-12">
                    <div className="flex flex-col md:flex-row gap-4 justify-between">
                        <div className="flex-1 space-y-2.5">
                            <div className="flex items-center gap-4">
                                <h3 className="font-bold text-lg text-indigo-700">–†–µ–∑–µ—Ä–≤ #{reservation.id}</h3>
                                <span className={`flex items-center gap-1.5 text-xs font-medium px-2 py-1 rounded-md border ${statusInfo.className}`}>
                                    <statusInfo.Icon className="w-3.5 h-3.5" />
                                    {statusInfo.text}
                                </span>
                            </div>
                            <div className="text-sm text-gray-700 space-y-1.5 pl-1">
                                <div className="flex items-center gap-2">
                                    <User className="w-4 h-4 text-gray-500" />
                                    <span>{reservation.user_info.full_name} ({reservation.user_info.email})</span>
                                </div>
                                <div className="flex items-center gap-2">
                                    <Calendar className="w-4 h-4 text-gray-500" />
                                    <span>{formatDateEuropean(reservation.start_date)} ‚Äî {formatDateEuropean(reservation.end_date)}</span>
                                </div>
                                <div className="flex items-start gap-2">
                                    <Package className="w-4 h-4 text-gray-500 mt-1 flex-shrink-0" />
                                    <div className="flex-1">
                                        <div className="flex items-center text-left w-full">
                                            <span>–ü–æ–∑–∏—Ü–∏–π –≤ —Ä–µ–∑–µ—Ä–≤–µ: {equipmentListForDisplay.length}</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        {/* –§–∏–Ω–∞–Ω—Å–æ–≤—ã–π –±–ª–æ–∫ */}
                        <FinancialInfoBlock
                            totalCost={reservation.total_cost}
                            discountAmount={reservation.discount_amount}
                            promoCode={reservation.promo_code}
                            variant="admin"
                        />

                        <div className="flex md:flex-col items-center md:items-end justify-between md:justify-start gap-2 border-t md:border-t-0 md:border-l pt-3 md:pt-0 md:pl-4">
                            {statusInfo.isActionable ? (
                                <>
                                    <Button onClick={() => onConvertToRental(reservation)} size="sm" className="bg-green-600 hover:bg-green-700 w-full md:w-auto">
                                        <Truck className="mr-2 h-4 w-4" />
                                        –í—ã–¥–∞—Ç—å –≤ –∞—Ä–µ–Ω–¥—É
                                    </Button>
                                    <Button onClick={() => setIsEditing(true)} size="sm" variant="outline" className="w-full md:w-auto">
                                        <Edit className="mr-2 h-4 w-4" />
                                        –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å
                                    </Button>
                                </>
                            ) : (
                                <div className="text-sm text-gray-500 flex items-center gap-2 pr-2">
                                    <span>–î–µ–π—Å—Ç–≤–∏–π –Ω–µ—Ç</span>
                                </div>
                            )}

                            {/* –ö–Ω–æ–ø–∫–∞ –ø–µ—Ä–µ—Ö–æ–¥–∞ –∫ –∞—Ä–µ–Ω–¥–µ –¥–ª—è –≤—ã–ø–æ–ª–Ω–µ–Ω–Ω—ã—Ö —Ä–µ–∑–µ—Ä–≤–æ–≤ */}
                            {reservation.status === 'fulfilled' && reservation.rental_id && (
                                <Button onClick={handleNavigateToRental} size="sm" variant="outline" className="w-full md:w-auto text-orange-600 hover:text-orange-700 hover:bg-orange-50 border-orange-200">
                                    <Truck className="mr-2 h-4 w-4" />
                                    –ü–µ—Ä–µ–π—Ç–∏ –∫ –∞—Ä–µ–Ω–¥–µ
                                </Button>
                            )}

                            <Button onClick={handleDelete} size="sm" variant="destructive" disabled={deleteReservationMutation.isPending} className="w-full md:w-auto">
                                <Trash2 className="mr-2 h-4 w-4" />
                                {deleteReservationMutation.isPending ? "–£–¥–∞–ª–µ–Ω–∏–µ..." : "–£–¥–∞–ª–∏—Ç—å"}
                            </Button>
                        </div>
                    </div>

                    {equipmentListForDisplay.length > 0 && (
                        <div className="mt-3 pt-3 border-t border-dashed animate-in fade-in-0 slide-in-from-top-2 duration-300">
                            <div className="flex items-center gap-2 text-sm font-semibold text-gray-600 mb-2">
                                <List className="w-4 h-4" />
                                <span>–°–æ—Å—Ç–∞–≤ —Ä–µ–∑–µ—Ä–≤–∞:</span>
                            </div>
                            <EquipmentWithAccessoriesList
                                equipment={reservation.equipment_ids.map(equipmentId => {
                                    const equipment = equipmentMap.get(equipmentId);
                                    return {
                                        id: equipmentId,
                                        name: equipment
                                            ? `${equipment.equipment_type} ${equipment.brand} ${equipment.name}`
                                            : `–û–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏–µ #${equipmentId} (–Ω–µ –Ω–∞–π–¥–µ–Ω–æ)`
                                    };
                                })}
                                accessoryLinks={reservation.accessory_links || []}
                                title=""
                                showTitle={false}
                                className="border-t-0 pt-0"
                            />
                        </div>
                    )}
                </CardContent>
            </Card>
        </div>
    );
}

```


## <a name="srccomponentsadminAdminReservationToolbartsx"></a>`src/components/admin/AdminReservationToolbar.tsx`

```tsx
// path: src/components/admin/AdminReservationToolbar.tsx

// src/components/admin/AdminReservationToolbar.tsx

import { Button } from '@/components/ui/button';
import { Checkbox } from '@/components/ui/checkbox';
import { Trash2 } from 'lucide-react';
import { useAdminReservationSelectionStore } from '@/store/adminReservationSelectionStore';

interface Props {
    visibleReservationIds: number[];
    onBulkDelete: () => void;
    isDeleting: boolean;
}

export function AdminReservationToolbar({ visibleReservationIds, onBulkDelete, isDeleting }: Props) {
    const { selectedIds, setSelectedIds, clearSelection } = useAdminReservationSelectionStore();

    const isAllSelected = visibleReservationIds.length > 0 && selectedIds.length === visibleReservationIds.length;
    const isSomeSelected = selectedIds.length > 0 && selectedIds.length < visibleReservationIds.length;

    const handleSelectAll = (checked: boolean | 'indeterminate') => {
        if (checked === true) {
            setSelectedIds(visibleReservationIds);
        } else {
            clearSelection();
        }
    };

    return (
        <div className="flex items-center gap-4 p-3 bg-slate-50 border rounded-md mb-4 h-14">
            <div className="flex items-center gap-2">
                <Checkbox
                    id="select-all"
                    checked={isAllSelected ? true : (isSomeSelected ? 'indeterminate' : false)}
                    onCheckedChange={handleSelectAll}
                    aria-label="–í—ã–±—Ä–∞—Ç—å –≤—Å–µ –≤–∏–¥–∏–º—ã–µ —Ä–µ–∑–µ—Ä–≤—ã"
                />
                <label htmlFor="select-all" className="text-sm font-medium text-slate-700 cursor-pointer">
                    –í—ã–±—Ä–∞—Ç—å –≤—Å–µ
                </label>
            </div>

            {selectedIds.length > 0 && (
                <div className="flex items-center gap-4 animate-in fade-in-0 duration-300">
          <span className="text-sm text-slate-500">
            –í—ã–±—Ä–∞–Ω–æ: {selectedIds.length}
          </span>
                    <Button
                        size="sm"
                        variant="destructive"
                        onClick={onBulkDelete}
                        disabled={isDeleting}
                    >
                        <Trash2 className="w-4 h-4 mr-2" />
                        {isDeleting ? '–£–¥–∞–ª–µ–Ω–∏–µ...' : '–£–¥–∞–ª–∏—Ç—å –≤—ã–±—Ä–∞–Ω–Ω–æ–µ'}
                    </Button>
                </div>
            )}
        </div>
    );
}

```


## <a name="srccomponentsadminAllRentalsListtsx"></a>`src/components/admin/AllRentalsList.tsx`

```tsx
// path: src/components/admin/AllRentalsList.tsx

// src/components/admin/AllRentalsList.tsx

// +++ –î–û–ë–ê–í–¨–¢–ï –ò–ú–ü–û–†–¢ AdminRentalOut +++
import type { AdminRentalOut } from "@/types/rental";
import { ClipboardX } from "lucide-react";
import AdminRentalCard from "./AdminRentalCard";

// +++ –ò–ó–ú–ï–ù–ò–¢–ï –ò–ù–¢–ï–†–§–ï–ô–° Props +++
interface Props {
    rentals: AdminRentalOut[];
    onReturn: (rental: AdminRentalOut) => void;
    highlightId?: number | null;
}

export default function AllRentalsList({ rentals, onReturn, highlightId }: Props) {
    if (!rentals || rentals.length === 0) {
        return (
            <div className="flex flex-col items-center justify-center text-center p-12 space-y-4 bg-gray-50/50 rounded-lg border-2 border-dashed">
                <ClipboardX className="w-16 h-16 text-gray-400" />
                <h3 className="text-lg font-semibold text-gray-800">–ê—Ä–µ–Ω–¥—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã</h3>
                <p className="text-sm text-gray-500">–ü–æ–ø—Ä–æ–±—É–π—Ç–µ –∏–∑–º–µ–Ω–∏—Ç—å —Ñ–∏–ª—å—Ç—Ä—ã –∏–ª–∏ –ø–æ–∏—Å–∫–æ–≤—ã–π –∑–∞–ø—Ä–æ—Å.</p>
            </div>
        );
    }

    return (
        <div className="space-y-4">
            {/* +++ –ü–ï–†–ï–î–ê–ô–¢–ï –ü–†–û–ü–° onReturn –í –ö–ê–†–¢–û–ß–ö–£ +++ */}
            {rentals.map((rental) => (
                <AdminRentalCard key={rental.id} rental={rental} onReturn={onReturn} highlightId={highlightId} />
            ))}
        </div>
    );
}

```


## <a name="srccomponentsadminAllReservationsListtsx"></a>`src/components/admin/AllReservationsList.tsx`

```tsx
// path: src/components/admin/AllReservationsList.tsx

// src/components/admin/AllReservationsList.tsx

import type { AdminReservationOut } from "@/types/reservation";
import AdminReservationCard from "./AdminReservationCard";
import type { Equipment } from "@/types/equipment";

interface Props {
    reservations: AdminReservationOut[];
    onConvertToRental: (reservation: AdminReservationOut) => void;
    equipmentMap: Map<number, Equipment>;
    highlightId?: number;
}

export default function AllReservationsList({ reservations, onConvertToRental, equipmentMap, highlightId }: Props) {
    return (
        <div className="space-y-4">
            {reservations.map((reservation) => (
                <AdminReservationCard
                    key={reservation.id}
                    reservation={reservation}
                    onConvertToRental={onConvertToRental}
                    equipmentMap={equipmentMap}
                    highlightId={highlightId}
                />
            ))}
        </div>
    );
}

```


## <a name="srccomponentsadminAssociationTabletsx"></a>`src/components/admin/AssociationTable.tsx`

```tsx
// path: src/components/admin/AssociationTable.tsx

// src/components/admin/AssociationTable.tsx

import { useState, useMemo, useEffect } from "react";
import { useAdminAssociations, useCreateAssociation, useUpdateAssociation, useDeleteAssociation } from "@/hooks/useAdminAssociations";
// ‚ùå –£–î–ê–õ–ï–ù–û: –ë–æ–ª—å—à–µ –Ω–µ –∏—Å–ø–æ–ª—å–∑—É–µ–º –ø–∞–≥–∏–Ω–∏—Ä–æ–≤–∞–Ω–Ω—ã–π —Ö—É–∫ –¥–ª—è –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—è
// import { useEquipment } from "@/hooks/useEquipment";
// ‚úÖ –î–û–ë–ê–í–õ–ï–ù–û: –ò—Å–ø–æ–ª—å–∑—É–µ–º —Ö—É–∫, –∫–æ—Ç–æ—Ä—ã–π –∑–∞–≥—Ä—É–∂–∞–µ—Ç –ü–û–õ–ù–´–ô —Å–ø–∏—Å–æ–∫ –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—è –¥–ª—è –Ω–∞—à–µ–≥–æ "—Å–ø—Ä–∞–≤–æ—á–Ω–∏–∫–∞"
import { useAllEquipment } from "@/hooks/useAllEquipment";
import { useForm, Controller } from "react-hook-form";
import { zodResolver } from "@hookform/resolvers/zod";
import { z } from "zod";
import type { Association } from "@/types/association";
// ‚ùå –£–î–ê–õ–ï–ù–û: –≠—Ç–æ—Ç —Ç–∏–ø –±–æ–ª—å—à–µ –Ω–µ –Ω—É–∂–µ–Ω, —Ç–∞–∫ –∫–∞–∫ –º—ã –Ω–µ —Ä–∞–±–æ—Ç–∞–µ–º —Å –ø–∞–≥–∏–Ω–∞—Ü–∏–µ–π –∑–¥–µ—Å—å
// import type { EquipmentListResponse } from "@/core/services/EquipmentService";

// UI Components
import { Button } from "@/components/ui/button";
import { Dialog, DialogContent, DialogHeader, DialogTitle, DialogFooter, DialogDescription } from "@/components/ui/dialog";
import { Input } from "@/components/ui/input";
import { Label } from "@/components/ui/label";
import { MultiSelect } from "@/components/ui/multi-select";
import { Table, TableBody, TableCell, TableHead, TableHeader, TableRow } from "@/components/ui/table";
import { Plus, Edit, Trash2, Tags, Loader2 } from "lucide-react";

const associationSchema = z.object({
    name: z.string().min(3, "–ù–∞–∑–≤–∞–Ω–∏–µ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ"),
    description: z.string().optional(),
    sort_order: z.coerce.number(),
    equipment_ids: z.array(z.number()),
});
type AssociationFormData = z.infer<typeof associationSchema>;

// --- –ö–æ–º–ø–æ–Ω–µ–Ω—Ç –¥–∏–∞–ª–æ–≥–æ–≤–æ–≥–æ –æ–∫–Ω–∞ (–±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π –≤ –ª–æ–≥–∏–∫–µ) ---
function AssociationDialog({ open, onClose, association, allEquipment }: {
    open: boolean;
    onClose: () => void;
    association: Association | null;
    allEquipment: { value: string, label: string }[];
}) {
    const createMutation = useCreateAssociation();
    const updateMutation = useUpdateAssociation();

    const {
        register,
        handleSubmit,
        control,
        reset,
        formState: { errors, isValid },
    } = useForm<AssociationFormData>({
        resolver: zodResolver(associationSchema),
        mode: "onChange",
    });

    useEffect(() => {
        if (open) {
            reset({
                name: association?.name ?? "",
                description: association?.description ?? "",
                sort_order: association?.sort_order ?? 0,
                equipment_ids: association?.equipment_ids ?? [],
            });
        }
    }, [association, open, reset]);

    const onSubmit = (data: AssociationFormData) => {
        const handleSuccess = () => {
            reset();
            onClose();
        };

        if (association) {
            updateMutation.mutate({ id: association.id, data }, { onSuccess: handleSuccess });
        } else {
            createMutation.mutate(data, { onSuccess: handleSuccess });
        }
    };

    return (
        <Dialog open={open} onOpenChange={onClose}>
            <DialogContent>
                <DialogHeader>
                    <DialogTitle>{association ? "–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –∞—Å—Å–æ—Ü–∏–∞—Ü–∏—é" : "–ù–æ–≤–∞—è –∞—Å—Å–æ—Ü–∏–∞—Ü–∏—è"}</DialogTitle>
                    <DialogDescription>
                        {association ? `–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ "${association.name}"` : "–°–æ–∑–¥–∞–π—Ç–µ –Ω–æ–≤—É—é –ø–æ–¥–±–æ—Ä–∫—É –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—è."}
                    </DialogDescription>
                </DialogHeader>
                <form onSubmit={handleSubmit(onSubmit)} className="space-y-4 py-2">
                    <div>
                        <Label htmlFor="assoc-name">–ù–∞–∑–≤–∞–Ω–∏–µ *</Label>
                        <Input id="assoc-name" {...register("name")} placeholder="–ù–∞–±–æ—Ä –¥–ª—è —Å—Ç—Ä–∏–º–∏–Ω–≥–∞" />
                        {errors.name && <p className="text-xs text-red-600 mt-1">{errors.name.message}</p>}
                    </div>
                    <div>
                        <Label htmlFor="assoc-sort">–ü–æ—Ä—è–¥–æ–∫ —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∏</Label>
                        <Input id="assoc-sort" type="number" {...register("sort_order")} />
                    </div>
                    <div>
                        <Label>–û–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏–µ –≤ –ø–æ–¥–±–æ—Ä–∫–µ</Label>
                        <Controller
                            name="equipment_ids"
                            control={control}
                            render={({ field }) => (
                                <MultiSelect
                                    placeholder="–í—ã–±–µ—Ä–∏—Ç–µ –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏–µ..."
                                    options={allEquipment}
                                    value={field.value.map(String)}
                                    onValueChange={(selected) => field.onChange(selected.map(Number))}
                                />
                            )}
                        />
                    </div>
                    <DialogFooter>
                        <Button type="button" variant="ghost" onClick={onClose}>–û—Ç–º–µ–Ω–∞</Button>
                        <Button type="submit" disabled={!isValid || createMutation.isPending || updateMutation.isPending}>
                            {createMutation.isPending || updateMutation.isPending ? "–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ..." : "–°–æ—Ö—Ä–∞–Ω–∏—Ç—å"}
                        </Button>
                    </DialogFooter>
                </form>
            </DialogContent>
        </Dialog>
    );
}

// --- –û—Å–Ω–æ–≤–Ω–æ–π –∫–æ–º–ø–æ–Ω–µ–Ω—Ç —Ç–∞–±–ª–∏—Ü—ã ---
export default function AssociationTable() {
    const { data: associations = [], isLoading } = useAdminAssociations();
    // ‚úÖ –ò–ó–ú–ï–ù–ï–ù–û: –ó–∞–≥—Ä—É–∂–∞–µ–º –≤–µ—Å—å —Å–ø–∏—Å–æ–∫ –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—è –æ–¥–∏–Ω —Ä–∞–∑.
    const { data: allEquipment = [] } = useAllEquipment();
    const deleteMutation = useDeleteAssociation();

    // ‚úÖ –ò–ó–ú–ï–ù–ï–ù–û: –ü—Ä–µ–æ–±—Ä–∞–∑—É–µ–º –ø–æ–ª–Ω—ã–π —Å–ø–∏—Å–æ–∫ –≤ —Ñ–æ—Ä–º–∞—Ç –¥–ª—è –≤—ã–ø–∞–¥–∞—é—â–µ–≥–æ –º–µ–Ω—é.
    const equipmentOptions = useMemo(() =>
            allEquipment.map(e => ({ value: e.id.toString(), label: e.name })),
        [allEquipment]
    );

    const [isDialogOpen, setDialogOpen] = useState(false);
    const [editingAssoc, setEditingAssoc] = useState<Association | null>(null);

    const handleEdit = (assoc: Association) => { setEditingAssoc(assoc); setDialogOpen(true); };
    const handleCreate = () => { setEditingAssoc(null); setDialogOpen(true); };
    const handleDelete = (id: number) => { if (window.confirm("–£–¥–∞–ª–∏—Ç—å –∞—Å—Å–æ—Ü–∏–∞—Ü–∏—é?")) deleteMutation.mutate(id); };

    if (isLoading) return <div className="flex items-center gap-2"><Loader2 className="animate-spin" /> –ó–∞–≥—Ä—É–∑–∫–∞...</div>;

    return (
        <>
            <div className="flex justify-end mb-4">
                <Button onClick={handleCreate}><Plus className="mr-2 h-4 w-4" /> –°–æ–∑–¥–∞—Ç—å</Button>
            </div>
            {associations.length > 0 ? (
                <Table>
                    <TableHeader>
                        <TableRow>
                            <TableHead>–ü–æ—Ä—è–¥–æ–∫</TableHead>
                            <TableHead>–ù–∞–∑–≤–∞–Ω–∏–µ</TableHead>
                            <TableHead>–ö–æ–ª-–≤–æ –µ–¥.</TableHead>
                            <TableHead className="text-right">–î–µ–π—Å—Ç–≤–∏—è</TableHead>
                        </TableRow>
                    </TableHeader>
                    <TableBody>
                        {associations.map((assoc) => (
                            <TableRow key={assoc.id}>
                                <TableCell>{assoc.sort_order}</TableCell>
                                <TableCell className="font-medium">{assoc.name}</TableCell>
                                <TableCell>{assoc.equipment_ids.length}</TableCell>
                                <TableCell className="text-right">
                                    <Button variant="ghost" size="icon" onClick={() => handleEdit(assoc)}><Edit className="h-4 w-4" /></Button>
                                    <Button variant="ghost" size="icon" onClick={() => handleDelete(assoc.id)}><Trash2 className="h-4 w-4 text-red-500" /></Button>
                                </TableCell>
                            </TableRow>
                        ))}
                    </TableBody>
                </Table>
            ) : (
                <div className="text-center py-10 border-dashed border-2 rounded-lg">
                    <Tags className="mx-auto h-12 w-12 text-gray-300" />
                    <h3 className="mt-2 text-sm font-semibold text-gray-800">–ê—Å—Å–æ—Ü–∏–∞—Ü–∏–∏ –Ω–µ —Å–æ–∑–¥–∞–Ω—ã</h3>
                    <p className="mt-1 text-sm text-gray-500">–ù–∞–∂–º–∏—Ç–µ "–°–æ–∑–¥–∞—Ç—å", —á—Ç–æ–±—ã –¥–æ–±–∞–≤–∏—Ç—å –ø–µ—Ä–≤—É—é.</p>
                </div>
            )}
            {/* ‚úÖ –¢–µ–ø–µ—Ä—å –≤ –¥–∏–∞–ª–æ–≥ –≥–∞—Ä–∞–Ω—Ç–∏—Ä–æ–≤–∞–Ω–Ω–æ –ø–µ—Ä–µ–¥–∞–µ—Ç—Å—è –ü–û–õ–ù–´–ô —Å–ø–∏—Å–æ–∫ –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—è */}
            {isDialogOpen && <AssociationDialog open={isDialogOpen} onClose={() => setDialogOpen(false)} association={editingAssoc} allEquipment={equipmentOptions} />}
        </>
    );
}

```


## <a name="srccomponentsadminConvertReservationDialogtsx"></a>`src/components/admin/ConvertReservationDialog.tsx`

```tsx
// path: src/components/admin/ConvertReservationDialog.tsx

// src/components/admin/ConvertReservationDialog.tsx

import { useState, useEffect, useMemo } from "react";
import { Dialog, DialogContent, DialogHeader, DialogTitle, DialogFooter, DialogDescription } from "@/components/ui/dialog";
import { Button } from "@/components/ui/button";
import { Label } from "@/components/ui/label";
import { Input } from "@/components/ui/input";
import { Textarea } from "@/components/ui/textarea";
import { useConvertReservationToRental } from "@/hooks/useAdminRentals";
import type { AdminReservationOut } from "@/types/reservation";
import type { Equipment } from "@/types/equipment";
import ReservationFinancialSummary from "./ReservationFinancialSummary";
import { useAvailabilityCheck } from "@/hooks/useAvailabilityCheck";
import { ConfirmationDialog } from "@/components/ui/confirmation-dialog";
import type { AxiosError } from "axios";
import { addDays } from "date-fns"; // +++ 1. –î–û–ë–ê–í–¨–¢–ï –≠–¢–û–¢ –ò–ú–ü–û–†–¢

interface Props {
    reservation: AdminReservationOut | null;
    open: boolean;
    onClose: () => void;
    equipmentMap: Map<number, Equipment>;
}

export default function ConvertReservationDialog({ reservation, open, onClose, equipmentMap }: Props) {
    const [notes, setNotes] = useState("");
    const [deposit, setDeposit] = useState("0");
    const [prepayment, setPrepayment] = useState("0");
    const convertMutation = useConvertReservationToRental();
    const [holidayConflict, setHolidayConflict] = useState<string | null>(null);

    // +++ –ù–ê–ß–ê–õ–û: –ò–ó–ú–ï–ù–ï–ù–ù–ê–Ø –õ–û–ì–ò–ö–ê –†–ê–°–ß–ï–¢–ê –î–ê–¢ +++
    const { newStartDate, newEndDate } = useMemo(() => {
        const today = new Date();
        today.setHours(0, 0, 0, 0);

        if (!reservation) {
            return { newStartDate: today, newEndDate: addDays(today, 1) };
        }

        const originalEndDate = new Date(reservation.end_date);

        // 2. –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å–ª–∏ –¥–∞—Ç–∞ –æ–∫–æ–Ω—á–∞–Ω–∏—è —Ä–µ–∑–µ—Ä–≤–∞ —Å–µ–≥–æ–¥–Ω—è –∏–ª–∏ —É–∂–µ –ø—Ä–æ—à–ª–∞.
        // –ï—Å–ª–∏ —ç—Ç–æ —Ç–∞–∫, —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –Ω–æ–≤—É—é –¥–∞—Ç—É –æ–∫–æ–Ω—á–∞–Ω–∏—è –Ω–∞ –∑–∞–≤—Ç—Ä–∞.
        const finalEndDate = originalEndDate <= today
            ? addDays(today, 1)
            : originalEndDate;

        return { newStartDate: today, newEndDate: finalEndDate };
    }, [reservation]);
    // +++ –ö–û–ù–ï–¶: –ò–ó–ú–ï–ù–ï–ù–ù–ê–Ø –õ–û–ì–ò–ö–ê +++

    const { hasConflicts, conflictingItemIds, isLoading: isCheckingAvailability } = useAvailabilityCheck({
        equipmentIds: reservation?.equipment_ids || [],
        startDate: newStartDate,
        endDate: newEndDate,
        excludeReservationId: reservation?.id,
    });

    useEffect(() => {
        if (!open) {
            setNotes("");
            setDeposit("0");
            setPrepayment("0");
            setHolidayConflict(null);
        }
    }, [open]);

    const handleSubmit = async (force: boolean = false) => {
        if (!reservation) return;

        try {
            await convertMutation.mutateAsync({
                reservationId: reservation.id,
                data: {
                    notes_on_issue: notes,
                    deposit_amount: parseFloat(deposit) || 0,
                    prepayment_amount: parseFloat(prepayment) || 0,
                    force_issue_on_holiday: force,
                },
            });
            onClose();
        } catch (error) {
            const axiosError = error as AxiosError<{ detail?: { error_type?: string; message?: string } }>;
            const detail = axiosError.response?.data?.detail;

            if (axiosError.response?.status === 409 && detail?.error_type === "ISSUE_ON_HOLIDAY") {
                setHolidayConflict(detail.message || "–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç–µ –¥–µ–π—Å—Ç–≤–∏–µ.");
            }
        }
    };

    const handleForceSubmit = () => {
        setHolidayConflict(null);
        void handleSubmit(true);
    };

    if (!reservation) return null;

    return (
        <>
            <Dialog open={open} onOpenChange={onClose}>
                <DialogContent className="sm:max-w-lg">
                    <DialogHeader>
                        <DialogTitle>–í—ã–¥–∞—á–∞ –∞—Ä–µ–Ω–¥—ã –∏–∑ —Ä–µ–∑–µ—Ä–≤–∞ #{reservation.id}</DialogTitle>
                        <DialogDescription>
                            –î–ª—è –∫–ª–∏–µ–Ω—Ç–∞: <strong>{reservation.user_info.full_name}</strong>
                        </DialogDescription>
                    </DialogHeader>

                    <div className="space-y-4 py-2">
                        <ReservationFinancialSummary
                            reservation={reservation}
                            open={open}
                            hasConflicts={hasConflicts}
                            conflictingItemIds={conflictingItemIds}
                            isCheckingAvailability={isCheckingAvailability}
                            equipmentMap={equipmentMap}
                        />

                        <div>
                            <Label htmlFor="deposit_amount">–°—É–º–º–∞ –∑–∞–ª–æ–≥–∞ (‚ÇΩ)</Label>
                            <Input id="deposit_amount" type="number" value={deposit} onChange={(e) => setDeposit(e.target.value)} placeholder="0" />
                        </div>
                        <div>
                            <Label htmlFor="prepayment_amount">–ü—Ä–µ–¥–æ–ø–ª–∞—Ç–∞ (‚ÇΩ)</Label>
                            <Input id="prepayment_amount" type="number" value={prepayment} onChange={(e) => setPrepayment(e.target.value)} placeholder="0" />
                        </div>
                        <div>
                            <Label htmlFor="notes_on_issue">–ó–∞–º–µ—Ç–∫–∏ –ø—Ä–∏ –≤—ã–¥–∞—á–µ</Label>
                            <Textarea id="notes_on_issue" value={notes} onChange={(e) => setNotes(e.target.value)} placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: –º–µ–ª–∫–∞—è —Ü–∞—Ä–∞–ø–∏–Ω–∞ –Ω–∞ –∫–æ—Ä–ø—É—Å–µ..." />
                        </div>
                    </div>

                    <DialogFooter>
                        <Button variant="ghost" onClick={onClose}>–û—Ç–º–µ–Ω–∞</Button>
                        <Button onClick={() => handleSubmit(false)} disabled={convertMutation.isPending || isCheckingAvailability || hasConflicts}>
                            {convertMutation.isPending ? "–û–±—Ä–∞–±–æ—Ç–∫–∞..." : "–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å –∏ –≤—ã–¥–∞—Ç—å"}
                        </Button>
                    </DialogFooter>
                </DialogContent>
            </Dialog>

            <ConfirmationDialog
                open={!!holidayConflict}
                onOpenChange={() => setHolidayConflict(null)}
                title="–ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –≤—ã–¥–∞—á–∏"
                description={holidayConflict || ""}
                confirmText="–î–∞, –≤—ã–¥–∞—Ç—å"
                cancelText="–û—Ç–º–µ–Ω–∞"
                onConfirm={handleForceSubmit}
                variant="destructive"
            />
        </>
    );
}

```


## <a name="srccomponentsadminCreateReservationDialogtsx"></a>`src/components/admin/CreateReservationDialog.tsx`

```tsx
// path: src/components/admin/CreateReservationDialog.tsx

// src/components/admin/CreateReservationDialog.tsx
import { Dialog, DialogContent, DialogHeader, DialogTitle, DialogFooter, DialogDescription } from "@/components/ui/dialog";
import { Button } from "@/components/ui/button";
import { ArrowRight, ArrowLeft } from "lucide-react";
import { useCreateReservationDialog } from "@/hooks/admin/create-reservation/useCreateReservationDialog";
import { CreateReservationStep1Details } from "./CreateReservationStep1Details";
import { CreateReservationStep2Accessories } from "./CreateReservationStep2Accessories";
import FinancialSummaryBlock from "@/components/shared/FinancialSummaryBlock";

interface Props {
    isOpen: boolean;
    onClose: () => void;
}

export default function CreateReservationDialog({ isOpen, onClose }: Props) {
    const {
        step, setStep, form, users, isLoadingUsers, clientPopoverOpen,
        setClientPopoverOpen, equipmentSearch, setEquipmentSearch,
        isLoadingEquipment, filteredAndGroupedEquipment, availabilityMap,
        equipmentWithAccessories, isLoadingAvailability, hasConflictsInSelection,
        isSubmitting, handleNextStep, onSubmit, handleCloseDialog,
        financialData // ‚úÖ 2. –ü–æ–ª—É—á–∞–µ–º –µ–¥–∏–Ω—ã–π –æ–±—ä–µ–∫—Ç —Å —Ñ–∏–Ω–∞–Ω—Å–æ–≤—ã–º–∏ –¥–∞–Ω–Ω—ã–º–∏
    } = useCreateReservationDialog({ isOpen, onClose });

    const { formState: { isValid } } = form;

    const formId = "create-reservation-admin-form";

    return (
        <Dialog open={isOpen} onOpenChange={onClose}>
            <DialogContent className="sm:max-w-[700px] h-[90vh] flex flex-col p-0">
                <DialogHeader className="p-6 pb-4">
                    <DialogTitle>–°–æ–∑–¥–∞—Ç—å –Ω–æ–≤—ã–π —Ä–µ–∑–µ—Ä–≤ (–®–∞–≥ {step === 'details' ? 1 : 2} –∏–∑ 2)</DialogTitle>
                    <DialogDescription>
                        {step === 'details'
                            ? "–í—ã–±–µ—Ä–∏—Ç–µ –∫–ª–∏–µ–Ω—Ç–∞, –¥–∞—Ç—ã –∏ –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏–µ –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è."
                            : "–í—ã–±–µ—Ä–∏—Ç–µ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –∞–∫—Å–µ—Å—Å—É–∞—Ä—ã –¥–ª—è –ø–æ–∑–∏—Ü–∏–π –≤ —Ä–µ–∑–µ—Ä–≤–µ."
                        }
                    </DialogDescription>
                </DialogHeader>

                <div className="flex-1 overflow-y-auto px-6">
                    <form id={formId} onSubmit={onSubmit} className="contents">
                        {step === 'details' ? (
                            <CreateReservationStep1Details
                                form={form}
                                users={users}
                                isLoadingUsers={isLoadingUsers}
                                clientPopoverOpen={clientPopoverOpen}
                                setClientPopoverOpen={setClientPopoverOpen}
                                equipmentSearch={equipmentSearch}
                                setEquipmentSearch={setEquipmentSearch}
                                isLoadingEquipment={isLoadingEquipment}
                                filteredAndGroupedEquipment={filteredAndGroupedEquipment}
                                availabilityMap={availabilityMap}
                            />
                        ) : (
                            <CreateReservationStep2Accessories
                                form={form}
                                equipmentWithAccessories={equipmentWithAccessories}
                            />
                        )}
                    </form>
                </div>

                <DialogFooter className="p-6 pt-4 border-t items-center">
                    {step === 'details' ? (
                        <>
                            {/* –ò—Å–ø–æ–ª—å–∑—É–µ–º —É–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω—ã–π –∫–æ–º–ø–æ–Ω–µ–Ω—Ç –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è —Å–≤–æ–¥–∫–∏ */}
                            <FinancialSummaryBlock
                                priceDetails={financialData.priceDetails}
                                promoCode={financialData.promoCode}
                                setPromoCode={financialData.setPromoCode}
                                applyPromoCode={financialData.applyPromoCode}
                                promoCodeMessage={financialData.promoCodeMessage}
                                isLoading={isLoadingAvailability}
                                isApplyingPromoCode={financialData.isApplyingPromoCode}
                                isSubmitting={isSubmitting}
                                hasConflicts={hasConflictsInSelection}
                                variant="admin"
                                showActions={false}
                            />
                            <Button type="button" variant="ghost" onClick={handleCloseDialog}>–û—Ç–º–µ–Ω–∞</Button>
                            <Button type="button" onClick={handleNextStep} disabled={!isValid || isSubmitting || hasConflictsInSelection || isLoadingAvailability}>
                                {equipmentWithAccessories.length > 0 ? "–î–∞–ª–µ–µ" : "–°–æ–∑–¥–∞—Ç—å —Ä–µ–∑–µ—Ä–≤"}
                                {equipmentWithAccessories.length > 0 && <ArrowRight className="ml-2 h-4 w-4" />}
                            </Button>
                        </>
                    ) : (
                        <>
                            <Button type="button" variant="ghost" onClick={() => setStep('details')} className="mr-auto">
                                <ArrowLeft className="mr-2 h-4 w-4" /> –ù–∞–∑–∞–¥
                            </Button>
                            <Button type="button" variant="ghost" onClick={handleCloseDialog}>–û—Ç–º–µ–Ω–∞</Button>
                            <Button type="submit" form={formId} disabled={isSubmitting}>
                                {isSubmitting ? "–°–æ–∑–¥–∞–Ω–∏–µ..." : "–°–æ–∑–¥–∞—Ç—å —Ä–µ–∑–µ—Ä–≤"}
                            </Button>
                        </>
                    )}
                </DialogFooter>
            </DialogContent>
        </Dialog>
    );
}

```


## <a name="srccomponentsadminCreateReservationStep1Detailstsx"></a>`src/components/admin/CreateReservationStep1Details.tsx`

```tsx
// path: src/components/admin/CreateReservationStep1Details.tsx

// src/components/admin/CreateReservationStep1Details.tsx
import { useState } from "react";
import { Controller, UseFormReturn } from "react-hook-form";
import { Input } from "@/components/ui/input";
import { Label } from "@/components/ui/label";
import { Popover, PopoverContent, PopoverTrigger } from "@/components/ui/popover";
// ‚úÖ –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï: –î–æ–±–∞–≤–ª—è–µ–º CommandInput –≤ –∏–º–ø–æ—Ä—Ç
import { Command, CommandEmpty, CommandGroup, CommandInput, CommandItem, CommandList } from "@/components/ui/command";
import { Button } from "@/components/ui/button";
import { Checkbox } from "@/components/ui/checkbox";
import { Check, ChevronsUpDown, Search, ChevronRight } from "lucide-react";
import type { CreateReservationFormData } from "@/hooks/admin/create-reservation/useCreateReservationForm";
import type { UserOut } from "@/types/user";
import type { Equipment } from "@/types/equipment";
import type { AvailabilityInfo } from "@/types/availability";

const EquipmentNode = ({ item, isChecked, onCheckedChange, availability }: {
    item: Equipment;
    isChecked: boolean;
    onCheckedChange: (checked: boolean) => void;
    availability?: AvailabilityInfo;
}) => {
    const hasConflict = !!availability && availability.status !== 'available';
    const conflictColorClass = availability?.status === 'rented' ? 'bg-red-100' : 'bg-amber-100';
    const hoverClass = hasConflict ? '' : 'hover:bg-gray-50';

    return (
        <div className={`p-2 rounded-md transition-colors ${hasConflict ? conflictColorClass : ''} ${hoverClass}`}>
            <div className="flex items-center justify-between">
                <div className="flex items-center gap-3 flex-1">
                    <Checkbox id={`eq-${item.id}`} checked={isChecked} onCheckedChange={onCheckedChange} />
                    <Label htmlFor={`eq-${item.id}`} className="font-normal w-full cursor-pointer text-sm">{item.brand} {item.name}</Label>
                </div>
                {hasConflict && <span className="text-xs font-medium">{availability?.status === 'rented' ? '–ê—Ä–µ–Ω–¥–∞' : '–†–µ–∑–µ—Ä–≤'}</span>}
            </div>
            {hasConflict && availability?.details && <div className="text-xs text-gray-600 mt-1 pl-8">- {availability.details}</div>}
        </div>
    );
};

interface Props {
    form: UseFormReturn<CreateReservationFormData>;
    users?: UserOut[];
    isLoadingUsers: boolean;
    clientPopoverOpen: boolean;
    setClientPopoverOpen: (isOpen: boolean) => void;
    equipmentSearch: string;
    setEquipmentSearch: (query: string) => void;
    isLoadingEquipment: boolean;
    filteredAndGroupedEquipment: { tree: Record<string, Record<string, Equipment[]>>, visibleIds: number[] };
    availabilityMap: Record<number, AvailabilityInfo>;
}

export const CreateReservationStep1Details = ({
                                                  form, users, isLoadingUsers, clientPopoverOpen, setClientPopoverOpen,
                                                  equipmentSearch, setEquipmentSearch, isLoadingEquipment,
                                                  filteredAndGroupedEquipment, availabilityMap
                                              }: Props) => {
    const { register, control, formState: { errors } } = form;
    const [collapsedSections, setCollapsedSections] = useState<Record<string, boolean>>({});

    const toggleSection = (key: string) => {
        setCollapsedSections(prev => ({ ...prev, [key]: !prev[key] }));
    };

    return (
        <div className="space-y-4">
            <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                    <Label>–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å *</Label>
                    <Controller
                        control={control}
                        name="user_id"
                        render={({ field }) => (
                            <Popover open={clientPopoverOpen} onOpenChange={setClientPopoverOpen}>
                                <PopoverTrigger asChild>
                                    <Button variant="outline" role="combobox" className="w-full justify-between" disabled={isLoadingUsers}>
                                        {field.value ? users?.find(u => u.id === field.value)?.full_name : "–í—ã–±–µ—Ä–∏—Ç–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è..."}
                                        <ChevronsUpDown className="ml-2 h-4 w-4 shrink-0 opacity-50" />
                                    </Button>
                                </PopoverTrigger>
                                <PopoverContent className="w-[--radix-popover-trigger-width] p-0">
                                    <Command>
                                        <CommandInput placeholder="–ü–æ–∏—Å–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è..." />
                                        <CommandList><CommandEmpty>–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã.</CommandEmpty>
                                            <CommandGroup>
                                                {users?.map((user) => (
                                                    <CommandItem key={user.id} value={`${user.full_name} ${user.email}`} onSelect={() => { form.setValue("user_id", user.id, { shouldValidate: true }); setClientPopoverOpen(false); }}>
                                                        <Check className={`mr-2 h-4 w-4 ${field.value === user.id ? "opacity-100" : "opacity-0"}`} />
                                                        {user.full_name}
                                                    </CommandItem>
                                                ))}
                                            </CommandGroup>
                                        </CommandList>
                                    </Command>
                                </PopoverContent>
                            </Popover>
                        )}
                    />
                    {errors.user_id && <p className="text-xs text-red-600 mt-1">{errors.user_id.message}</p>}
                </div>
                <div className="grid grid-cols-2 gap-2">
                    <div><Label htmlFor="start_date">–ù–∞—á–∞–ª–æ *</Label><Input id="start_date" type="date" {...register("start_date")} />{errors.start_date && <p className="text-xs text-red-600 mt-1">{errors.start_date.message}</p>}</div>
                    <div><Label htmlFor="end_date">–û–∫–æ–Ω—á–∞–Ω–∏–µ *</Label><Input id="end_date" type="date" {...register("end_date")} />{errors.end_date && <p className="text-xs text-red-600 mt-1">{errors.end_date.message}</p>}</div>
                </div>
            </div>

            <div className="space-y-2">
                <Label>–û–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏–µ *</Label>
                <div className="relative"><Search className="absolute left-3 top-2.5 h-4 w-4 text-muted-foreground" /><Input placeholder="–ü–æ–∏—Å–∫..." value={equipmentSearch} onChange={(e) => setEquipmentSearch(e.target.value)} className="pl-10" /></div>
                <div className="rounded-md border p-2">
                    {isLoadingEquipment ? <p className="text-center py-4">–ó–∞–≥—Ä—É–∑–∫–∞...</p> : (
                        <Controller name="equipment_ids" control={control}
                                    render={({ field }) => (
                                        <div className="space-y-3">
                                            {Object.keys(filteredAndGroupedEquipment.tree).map(type => {
                                                const isTypeCollapsed = collapsedSections[type];
                                                return (
                                                    <div key={type}>
                                                        <button type="button" onClick={() => toggleSection(type)} className="w-full flex items-center gap-1 font-semibold text-md sticky top-0 bg-white/80 backdrop-blur-sm py-1 cursor-pointer z-10">
                                                            <ChevronRight className={`w-4 h-4 transition-transform ${!isTypeCollapsed ? 'rotate-90' : ''}`} />
                                                            {type}
                                                        </button>
                                                        {!isTypeCollapsed && Object.keys(filteredAndGroupedEquipment.tree[type]).map(brand => {
                                                            const brandKey = `${type}-${brand}`;
                                                            const isBrandCollapsed = collapsedSections[brandKey];
                                                            return (
                                                                <div key={brandKey} className="pl-4">
                                                                    <button type="button" onClick={() => toggleSection(brandKey)} className="w-full flex items-center gap-1 font-medium text-sm text-gray-600 hover:text-black">
                                                                        <ChevronRight className={`w-4 h-4 transition-transform ${!isBrandCollapsed ? 'rotate-90' : ''}`} />
                                                                        {brand}
                                                                    </button>
                                                                    {!isBrandCollapsed && (
                                                                        <div className="space-y-1 pl-4 border-l ml-2 py-1">
                                                                            {filteredAndGroupedEquipment.tree[type][brand].map(item => (
                                                                                <EquipmentNode key={item.id} item={item} availability={availabilityMap[item.id]}
                                                                                               isChecked={field.value?.includes(item.id)}
                                                                                               onCheckedChange={(checked) => field.onChange(checked ? [...field.value, item.id] : field.value.filter(id => id !== item.id))} />
                                                                            ))}
                                                                        </div>
                                                                    )}
                                                                </div>
                                                            )})}
                                                    </div>
                                                )})}
                                        </div>
                                    )}
                        />
                    )}
                </div>
                {errors.equipment_ids && <p className="text-xs text-red-600 mt-1">{errors.equipment_ids.message}</p>}
            </div>
        </div>
    );
};

```


## <a name="srccomponentsadminCreateReservationStep2Accessoriestsx"></a>`src/components/admin/CreateReservationStep2Accessories.tsx`

```tsx
// path: src/components/admin/CreateReservationStep2Accessories.tsx

// src/components/admin/CreateReservationStep2Accessories.tsx
import { Controller, UseFormReturn } from "react-hook-form";
import { Card, CardContent, CardHeader, CardTitle } from "@/components/ui/card";
import { Checkbox } from "@/components/ui/checkbox";
import { Label } from "@/components/ui/label";
import { ScrollArea } from "@/components/ui/scroll-area";
import { Paperclip } from "lucide-react";
import type { CreateReservationFormData } from "@/hooks/admin/create-reservation/useCreateReservationForm";
import type { Equipment } from "@/types/equipment";

interface Props {
    form: UseFormReturn<CreateReservationFormData>;
    equipmentWithAccessories: Equipment[];
}

export const CreateReservationStep2Accessories = ({ form, equipmentWithAccessories }: Props) => {
    const { control } = form;

    return (
        <div className="space-y-4 overflow-hidden flex flex-col flex-1">
            <ScrollArea className="flex-1 -mx-6 px-6">
                <div className="space-y-4 pb-4">
                    {equipmentWithAccessories.map(equipmentItem => (
                        <Card key={equipmentItem.id}>
                            <CardHeader className="pb-2">
                                <CardTitle className="text-base flex items-center gap-2">
                                    <Paperclip className="h-4 w-4" />
                                    {equipmentItem.name}
                                </CardTitle>
                            </CardHeader>
                            <CardContent>
                                <Controller
                                    name={`selected_accessories.${equipmentItem.id}`}
                                    control={control}
                                    render={({ field }) => (
                                        <div className="space-y-2">
                                            {equipmentItem.accessories.map(acc => (
                                                <div key={acc.id} className="flex items-center justify-between hover:bg-slate-50 p-2 rounded">
                                                    <Label htmlFor={`acc-${equipmentItem.id}-${acc.id}`} className="flex items-center gap-2 font-normal cursor-pointer">
                                                        <Checkbox id={`acc-${equipmentItem.id}-${acc.id}`}
                                                                  checked={field.value?.includes(acc.id)}
                                                                  onCheckedChange={(checked) => {
                                                                      const currentIds = field.value || [];
                                                                      const newIds = checked ? [...currentIds, acc.id] : currentIds.filter(id => id !== acc.id);
                                                                      field.onChange(newIds);
                                                                  }}
                                                        />
                                                        {acc.name}
                                                    </Label>
                                                    <span className="text-xs text-muted-foreground">{acc.price} ‚ÇΩ</span>
                                                </div>
                                            ))}
                                        </div>
                                    )}
                                />
                            </CardContent>
                        </Card>
                    ))}
                </div>
            </ScrollArea>
        </div>
    );
};

```


## <a name="srccomponentsadminDurationDiscountManagertsx"></a>`src/components/admin/DurationDiscountManager.tsx`

```tsx
// path: src/components/admin/DurationDiscountManager.tsx

// src/components/admin/DurationDiscountManager.tsx

import { useState, useMemo } from 'react';
import { useDurationDiscounts, useCreateDurationDiscount, useDeleteDurationDiscount } from '@/hooks/useAdminDiscounts';
// +++ –ù–ê–ß–ê–õ–û –ò–ó–ú–ï–ù–ï–ù–ò–ô: –ò—Å–ø—Ä–∞–≤–ª—è–µ–º –∏–º–ø–æ—Ä—Ç —Ç–∏–ø–æ–≤ +++
import type { DiscountPayload, DurationDiscount } from '@/types/discount';
// +++ –ö–û–ù–ï–¶ –ò–ó–ú–ï–ù–ï–ù–ò–ô +++
import { Button } from '@/components/ui/button';
import { Input } from '@/components/ui/input';
import { Table, TableBody, TableCell, TableHead, TableHeader, TableRow } from '@/components/ui/table';
import { PlusCircle, Trash2, Loader2, ChevronLeft, ChevronRight } from 'lucide-react';
import { Alert, AlertDescription, AlertTitle } from "@/components/ui/alert";

const PAGE_SIZE = 10;

export default function DurationDiscountManager() {
    const [currentPage, setCurrentPage] = useState(1);
    const { data: discountResponse, isLoading, isError } = useDurationDiscounts(currentPage, PAGE_SIZE);

    const discounts = useMemo(() => discountResponse?.items ?? [], [discountResponse]);
    const totalDiscounts = useMemo(() => discountResponse?.total ?? 0, [discountResponse]);
    const totalPages = Math.ceil(totalDiscounts / PAGE_SIZE);

    const createMutation = useCreateDurationDiscount();
    const deleteMutation = useDeleteDurationDiscount();

    const [newItem, setNewItem] = useState<DiscountPayload>({ min_days: 0, discount_percentage: 0 });

    const handleCreate = () => {
        if (!newItem.min_days || newItem.min_days <= 0) {
            alert("–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –¥–Ω–µ–π –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å –±–æ–ª—å—à–µ 0.");
            return;
        }
        if (!newItem.discount_percentage || newItem.discount_percentage <= 0) {
            alert("–ü—Ä–æ—Ü–µ–Ω—Ç —Å–∫–∏–¥–∫–∏ –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –±–æ–ª—å—à–µ 0.");
            return;
        }
        createMutation.mutate(newItem, {
            onSuccess: () => setNewItem({ min_days: 0, discount_percentage: 0 })
        });
    };

    if (isLoading) {
        return <div className="flex items-center gap-2 text-gray-500"><Loader2 className="h-4 w-4 animate-spin"/>–ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö –æ —Å–∫–∏–¥–∫–∞—Ö...</div>;
    }

    if (isError) {
        return <Alert variant="destructive"><AlertTitle>–û—à–∏–±–∫–∞!</AlertTitle><AlertDescription>–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –¥–∞–Ω–Ω—ã–µ –æ —Å–∫–∏–¥–∫–∞—Ö.</AlertDescription></Alert>;
    }

    return (
        <div className="space-y-4">
            <div className="border rounded-md">
                <Table>
                    <TableHeader>
                        <TableRow>
                            <TableHead className="w-[40%]">–ú–∏–Ω–∏–º–∞–ª—å–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –¥–Ω–µ–π</TableHead>
                            <TableHead className="w-[40%]">–ü—Ä–æ—Ü–µ–Ω—Ç —Å–∫–∏–¥–∫–∏ (%)</TableHead>
                            <TableHead className="text-right">–î–µ–π—Å—Ç–≤–∏—è</TableHead>
                        </TableRow>
                    </TableHeader>
                    <TableBody>
                        {discounts.map((d: DurationDiscount) => (
                            <TableRow key={d.id}>
                                <TableCell>{d.min_days}</TableCell>
                                <TableCell>{d.discount_percentage}%</TableCell>
                                <TableCell className="text-right">
                                    <Button variant="ghost" size="icon" onClick={() => deleteMutation.mutate(d.id)} disabled={deleteMutation.isPending}>
                                        <Trash2 className="h-4 w-4 text-red-500" />
                                    </Button>
                                </TableCell>
                            </TableRow>
                        ))}
                        <TableRow>
                            <TableCell>
                                <Input type="number" placeholder="–ù–∞–ø—Ä. 7" value={newItem.min_days || ''} onChange={e => setNewItem((p: DiscountPayload) => ({...p, min_days: parseInt(e.target.value, 10) || 0}))} />
                            </TableCell>
                            <TableCell>
                                <Input type="number" placeholder="–ù–∞–ø—Ä. 15" value={newItem.discount_percentage || ''} onChange={e => setNewItem((p: DiscountPayload) => ({...p, discount_percentage: parseInt(e.target.value, 10) || 0}))} />
                            </TableCell>
                            <TableCell className="text-right">
                                <Button size="sm" onClick={handleCreate} disabled={createMutation.isPending}>
                                    {createMutation.isPending ? <Loader2 className="mr-2 h-4 w-4 animate-spin"/> : <PlusCircle className="mr-2 h-4 w-4" />}
                                    –î–æ–±–∞–≤–∏—Ç—å
                                </Button>
                            </TableCell>
                        </TableRow>
                    </TableBody>
                </Table>
            </div>

            <div className="flex items-center justify-end space-x-2 pt-2">
                <span className="text-sm text-muted-foreground">
                    –°—Ç—Ä–∞–Ω–∏—Ü–∞ {currentPage} –∏–∑ {totalPages > 0 ? totalPages : 1}
                </span>
                <Button
                    variant="outline"
                    size="sm"
                    onClick={() => setCurrentPage(prev => Math.max(prev - 1, 1))}
                    disabled={currentPage === 1}
                >
                    <ChevronLeft className="h-4 w-4 mr-1" />
                    –ù–∞–∑–∞–¥
                </Button>
                <Button
                    variant="outline"
                    size="sm"
                    onClick={() => setCurrentPage(prev => Math.min(prev + 1, totalPages))}
                    disabled={currentPage >= totalPages}
                >
                    –í–ø–µ—Ä–µ–¥
                    <ChevronRight className="h-4 w-4 ml-1" />
                </Button>
            </div>

            <p className="text-sm text-gray-600 pt-2">
                <strong>–ö–∞–∫ —ç—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç:</strong> –°–∏—Å—Ç–µ–º–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø—Ä–∏–º–µ–Ω–∏—Ç —Å–∫–∏–¥–∫—É —Å –Ω–∞–∏–±–æ–ª—å—à–∏–º –ø–æ—Ä–æ–≥–æ–º –¥–Ω–µ–π, –∫–æ—Ç–æ—Ä—ã–π –Ω–µ –ø—Ä–µ–≤—ã—à–∞–µ—Ç –æ–±—â–µ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –¥–Ω–µ–π –∞—Ä–µ–Ω–¥—ã.
                <br />
                <em>–ù–∞–ø—Ä–∏–º–µ—Ä, –µ—Å–ª–∏ –µ—Å—Ç—å —Å–∫–∏–¥–∫–∏ –¥–ª—è 3 –∏ 7 –¥–Ω–µ–π, –∞ –∞—Ä–µ–Ω–¥–∞ –Ω–∞ 8 –¥–Ω–µ–π, –±—É–¥–µ—Ç –ø—Ä–∏–º–µ–Ω–µ–Ω–∞ —Å–∫–∏–¥–∫–∞ –¥–ª—è 7 –¥–Ω–µ–π.</em>
            </p>
        </div>
    );
}

```


## <a name="srccomponentsadminEditableRentalCardtsx"></a>`src/components/admin/EditableRentalCard.tsx`

```tsx
// path: src/components/admin/EditableRentalCard.tsx

// components/admin/EditableRentalCard.tsx (–ù–û–í–´–ô –§–ê–ô–õ)

import { Card, CardContent } from "@/components/ui/card";
import { Button } from "@/components/ui/button";
import { Input } from "@/components/ui/input";
import { Label } from "@/components/ui/label";
import { Textarea } from "@/components/ui/textarea";
import { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from "@/components/ui/select";
import { Save, X, Loader2 } from "lucide-react";
import { useAdminRentalEdit } from "@/hooks/admin/useAdminRentalEdit";
import type { AdminRentalOut } from "@/types/reservation";

interface Props {
    rental: AdminRentalOut;
    onCancel: () => void;
}

export default function EditableRentalCard({ rental, onCancel }: Props) {
    const { register, handleSubmit, errors, isValid, isDirty, isSaving } = useAdminRentalEdit({
        rental,
        onSuccess: onCancel, // –ó–∞–∫—Ä—ã–≤–∞–µ–º —Ñ–æ—Ä–º—É –ø—Ä–∏ —É—Å–ø–µ—Ö–µ
    });

    const statusOptions = [
        { value: "active", label: "–ê–∫—Ç–∏–≤–Ω–∞" },
        { value: "overdue", label: "–ü—Ä–æ—Å—Ä–æ—á–µ–Ω–∞" },
        { value: "completed", label: "–ó–∞–≤–µ—Ä—à–µ–Ω–∞" },
    ];

    return (
        <Card className="w-full transition-shadow border-2 border-dashed border-sky-400 bg-sky-50/50">
            <form onSubmit={handleSubmit}>
                <CardContent className="p-4 space-y-4">
                    <h3 className="font-semibold text-lg text-sky-800">–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∞—Ä–µ–Ω–¥—ã #{rental.id}</h3>
                    <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                        {/* –î–∞—Ç—ã */}
                        <div className="space-y-2">
                            <Label htmlFor="end_date">–î–∞—Ç–∞ –≤–æ–∑–≤—Ä–∞—Ç–∞ (–ø–ª–∞–Ω)</Label>
                            <Input id="end_date" type="date" {...register("end_date")} />
                            {errors.end_date && <p className="text-xs text-red-600 mt-1">{errors.end_date.message}</p>}
                        </div>
                        <div className="space-y-2">
                            <Label htmlFor="actual_return_date">–î–∞—Ç–∞ –≤–æ–∑–≤—Ä–∞—Ç–∞ (—Ñ–∞–∫—Ç)</Label>
                            <Input id="actual_return_date" type="date" {...register("actual_return_date")} />
                            {errors.actual_return_date && <p className="text-xs text-red-600 mt-1">{errors.actual_return_date.message}</p>}
                        </div>

                        {/* –°—Ç–∞—Ç—É—Å –∏ –§–∏–Ω–∞–Ω—Å—ã */}
                        <div className="space-y-2">
                            <Label htmlFor="status">–°—Ç–∞—Ç—É—Å</Label>
                            <select id="status" {...register("status")} className="w-full p-2 border rounded-md">
                                {statusOptions.map(opt => <option key={opt.value} value={opt.value}>{opt.label}</option>)}
                            </select>
                        </div>
                        <div className="space-y-2">
                            <Label htmlFor="deposit_amount">–ó–∞–ª–æ–≥ (‚ÇΩ)</Label>
                            <Input id="deposit_amount" type="number" {...register("deposit_amount")} />
                        </div>
                        <div className="space-y-2">
                            <Label htmlFor="final_cost">–ò—Ç–æ–≥–æ–≤–∞—è —Å—Ç–æ–∏–º–æ—Å—Ç—å (‚ÇΩ)</Label>
                            <Input id="final_cost" type="number" {...register("final_cost")} placeholder="–û—Å—Ç–∞–≤—å—Ç–µ –ø—É—Å—Ç—ã–º –¥–ª—è –∞–≤—Ç–æ—Ä–∞—Å—á–µ—Ç–∞" />
                        </div>
                    </div>

                    {/* –ó–∞–º–µ—Ç–∫–∏ */}
                    <div className="space-y-2">
                        <Label htmlFor="notes_on_issue">–ó–∞–º–µ—Ç–∫–∏ –ø—Ä–∏ –≤—ã–¥–∞—á–µ</Label>
                        <Textarea id="notes_on_issue" {...register("notes_on_issue")} rows={2} />
                    </div>
                    <div className="space-y-2">
                        <Label htmlFor="notes_on_return">–ó–∞–º–µ—Ç–∫–∏ –ø—Ä–∏ –≤–æ–∑–≤—Ä–∞—Ç–µ</Label>
                        <Textarea id="notes_on_return" {...register("notes_on_return")} rows={2} />
                    </div>

                    {/* –ö–Ω–æ–ø–∫–∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è */}
                    <div className="flex justify-end gap-2 pt-2 border-t">
                        <Button type="button" variant="ghost" onClick={onCancel} disabled={isSaving}>
                            <X className="mr-2 h-4 w-4" /> –û—Ç–º–µ–Ω–∞
                        </Button>
                        <Button type="submit" disabled={!isValid || !isDirty || isSaving}>
                            {isSaving ? <Loader2 className="mr-2 h-4 w-4 animate-spin" /> : <Save className="mr-2 h-4 w-4" />}
                            –°–æ—Ö—Ä–∞–Ω–∏—Ç—å
                        </Button>
                    </div>
                </CardContent>
            </form>
        </Card>
    );
}

```


## <a name="srccomponentsadminEquipmentCreateDialogtsx"></a>`src/components/admin/EquipmentCreateDialog.tsx`

```tsx
// path: src/components/admin/EquipmentCreateDialog.tsx

// src/components/admin/EquipmentCreateDialog.tsx

import { useMemo } from "react";
import { useForm, Controller } from "react-hook-form";
import { zodResolver } from "@hookform/resolvers/zod";
import { z } from "zod";
import { useCreateEquipment } from "@/hooks/useAdminEquipment";
import { EQUIPMENT_CONDITIONS } from "@/constants/equipmentConstants";

import {
    Dialog,
    DialogContent,
    DialogHeader,
    DialogTitle,
    DialogFooter,
} from "@/components/ui/dialog";
import { Button } from "@/components/ui/button";
import { Input } from "@/components/ui/input";
import { Label } from "@/components/ui/label";
import { Textarea } from "@/components/ui/textarea";
import {
    Select,
    SelectContent,
    SelectItem,
    SelectTrigger,
    SelectValue,
} from "@/components/ui/select";
import type { Equipment } from "@/types/equipment";
import { CreatableSelect } from "@/components/ui/CreatableSelect";

const equipmentCreateSchema = z.object({
    equipment_type: z.string().min(1, "–¢–∏–ø –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—è –æ–±—è–∑–∞—Ç–µ–ª–µ–Ω"),
    brand: z.string().min(1, "–ë—Ä–µ–Ω–¥ –æ–±—è–∑–∞—Ç–µ–ª–µ–Ω"),
    name: z.string().min(1, "–ù–∞–∑–≤–∞–Ω–∏–µ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ"),
    serial_number: z.string().optional(),
    condition: z.string().min(1, "–°–æ—Å—Ç–æ—è–Ω–∏–µ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ"),
    daily_rate: z.number().min(0, "–¢–∞—Ä–∏—Ñ –Ω–µ –º–æ–∂–µ—Ç –±—ã—Ç—å –æ—Ç—Ä–∏—Ü–∞—Ç–µ–ª—å–Ω—ã–º"),
    notes: z.string().optional(),
    description: z.string().optional(),
    last_maintenance: z.string().optional(),
});

type EquipmentCreateFormData = z.infer<typeof equipmentCreateSchema>;

interface EquipmentCreateDialogProps {
    open: boolean;
    onClose: () => void;
    equipment: Equipment[];
}

export default function EquipmentCreateDialog({
                                                  open,
                                                  onClose,
                                                  equipment
                                              }: EquipmentCreateDialogProps) {
    const createEquipmentMutation = useCreateEquipment();

    const {
        register,
        handleSubmit,
        formState: { errors, isValid },
        reset,
        setValue,
        control,
    } = useForm<EquipmentCreateFormData>({
        resolver: zodResolver(equipmentCreateSchema),
        defaultValues: {
            condition: "–í–µ–ª–∏–∫–æ–ª–µ–ø–Ω–æ",
            daily_rate: 0,
        },
        mode: "onChange",
    });

    const equipmentTypes = useMemo(() => {
        const types = new Set(equipment.map(e => e.equipment_type));
        return Array.from(types).sort((a,b) => a.localeCompare(b));
    }, [equipment]);

    const equipmentBrands = useMemo(() => {
        const brands = new Set(equipment.map(e => e.brand));
        return Array.from(brands).sort((a,b) => a.localeCompare(b));
    }, [equipment]);

    const onSubmit = async (data: EquipmentCreateFormData) => {
        try {
            await createEquipmentMutation.mutateAsync(data);
            reset();
            onClose();
        } catch (error) {
            // –û—à–∏–±–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∞–µ—Ç—Å—è –≤ —Ö—É–∫–µ
        }
    };

    const handleClose = () => {
        reset();
        onClose();
    };

    return (
        <Dialog open={open} onOpenChange={handleClose}>
            <DialogContent className="max-w-2xl max-h-[90vh] overflow-y-auto">
                <DialogHeader>
                    <DialogTitle>–î–æ–±–∞–≤–∏—Ç—å –Ω–æ–≤–æ–µ –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏–µ</DialogTitle>
                </DialogHeader>

                <form onSubmit={handleSubmit(onSubmit)} className="space-y-4">
                    <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                        {/* –¢–∏–ø –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—è */}
                        <div>
                            <Label htmlFor="equipment_type">–¢–∏–ø –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—è *</Label>
                            <Controller
                                name="equipment_type"
                                control={control}
                                render={({ field }) => (
                                    <CreatableSelect
                                        value={field.value}
                                        onChange={field.onChange}
                                        options={equipmentTypes}
                                        placeholder="–í—ã–±–µ—Ä–∏—Ç–µ –∏–ª–∏ —Å–æ–∑–¥–∞–π—Ç–µ —Ç–∏–ø"
                                        dialogTitle="–ù–æ–≤—ã–π —Ç–∏–ø –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—è"
                                        dialogDescription="–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –¥–ª—è –Ω–æ–≤–æ–≥–æ —Ç–∏–ø–∞."
                                        dialogLabel="–ù–∞–∑–≤–∞–Ω–∏–µ"
                                    />
                                )}
                            />
                            {errors.equipment_type && (
                                <p className="text-xs text-red-600 mt-1">
                                    {errors.equipment_type.message}
                                </p>
                            )}
                        </div>

                        {/* –ë—Ä–µ–Ω–¥ */}
                        <div>
                            <Label htmlFor="brand">–ë—Ä–µ–Ω–¥ *</Label>
                            <Controller
                                name="brand"
                                control={control}
                                render={({ field }) => (
                                    <CreatableSelect
                                        value={field.value}
                                        onChange={field.onChange}
                                        options={equipmentBrands}
                                        placeholder="–í—ã–±–µ—Ä–∏—Ç–µ –∏–ª–∏ —Å–æ–∑–¥–∞–π—Ç–µ –±—Ä–µ–Ω–¥"
                                        dialogTitle="–ù–æ–≤—ã–π –±—Ä–µ–Ω–¥"
                                        dialogDescription="–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –¥–ª—è –Ω–æ–≤–æ–≥–æ –±—Ä–µ–Ω–¥–∞."
                                        dialogLabel="–ù–∞–∑–≤–∞–Ω–∏–µ"
                                    />
                                )}
                            />
                            {errors.brand && (
                                <p className="text-xs text-red-600 mt-1">
                                    {errors.brand.message}
                                </p>
                            )}
                        </div>
                    </div>

                    <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                        {/* –ù–∞–∑–≤–∞–Ω–∏–µ */}
                        <div>
                            <Label htmlFor="name">–ù–∞–∑–≤–∞–Ω–∏–µ *</Label>
                            <Input
                                id="name"
                                {...register("name")}
                                placeholder="EOS R5, MacBook Pro 14..."
                            />
                            {errors.name && (
                                <p className="text-xs text-red-600 mt-1">
                                    {errors.name.message}
                                </p>
                            )}
                        </div>

                        {/* –°–µ—Ä–∏–π–Ω—ã–π –Ω–æ–º–µ—Ä */}
                        <div>
                            <Label htmlFor="serial_number">–°–µ—Ä–∏–π–Ω—ã–π –Ω–æ–º–µ—Ä</Label>
                            <Input
                                id="serial_number"
                                {...register("serial_number")}
                                placeholder="–ù–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ"
                            />
                        </div>
                    </div>

                    <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                        {/* –°–æ—Å—Ç–æ—è–Ω–∏–µ */}
                        <div>
                            <Label htmlFor="condition">–°–æ—Å—Ç–æ—è–Ω–∏–µ *</Label>
                            <Select
                                onValueChange={(value) => setValue("condition", value, { shouldValidate: true })}
                                defaultValue="–í–µ–ª–∏–∫–æ–ª–µ–ø–Ω–æ"
                            >
                                <SelectTrigger>
                                    <SelectValue placeholder="–í—ã–±–µ—Ä–∏—Ç–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ" />
                                </SelectTrigger>
                                <SelectContent>
                                    {EQUIPMENT_CONDITIONS.map((condition) => (
                                        <SelectItem key={condition} value={condition}>
                                            {condition}
                                        </SelectItem>
                                    ))}
                                </SelectContent>
                            </Select>
                            {errors.condition && (
                                <p className="text-xs text-red-600 mt-1">
                                    {errors.condition.message}
                                </p>
                            )}
                        </div>

                        {/* –¢–∞—Ä–∏—Ñ –∑–∞ –¥–µ–Ω—å */}
                        <div>
                            <Label htmlFor="daily_rate">–¢–∞—Ä–∏—Ñ –∑–∞ –¥–µ–Ω—å (‚ÇΩ) *</Label>
                            <Input
                                id="daily_rate"
                                type="number"
                                step="0.01"
                                min="0"
                                {...register("daily_rate", { valueAsNumber: true })}
                                placeholder="0"
                            />
                            {errors.daily_rate && (
                                <p className="text-xs text-red-600 mt-1">
                                    {errors.daily_rate.message}
                                </p>
                            )}
                        </div>
                    </div>

                    {/* –î–∞—Ç–∞ –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ –¢–û */}
                    <div>
                        <Label htmlFor="last_maintenance">–î–∞—Ç–∞ –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ –¢–û</Label>
                        <Input
                            id="last_maintenance"
                            type="date"
                            {...register("last_maintenance")}
                        />
                    </div>

                    {/* –û–ø–∏—Å–∞–Ω–∏–µ */}
                    <div>
                        <Label htmlFor="description">–û–ø–∏—Å–∞–Ω–∏–µ</Label>
                        <Textarea
                            id="description"
                            {...register("description")}
                            placeholder="–ü–æ–¥—Ä–æ–±–Ω–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—è, –µ–≥–æ –æ—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏..."
                            rows={3}
                        />
                    </div>

                    {/* –ó–∞–º–µ—Ç–∫–∏ */}
                    <div>
                        <Label htmlFor="notes">–ó–∞–º–µ—Ç–∫–∏ (–≤–∏–¥–Ω—ã —Ç–æ–ª—å–∫–æ –ø–µ—Ä—Å–æ–Ω–∞–ª—É)</Label>
                        <Textarea
                            id="notes"
                            {...register("notes")}
                            placeholder="–í–Ω—É—Ç—Ä–µ–Ω–Ω–∏–µ –∑–∞–º–µ—Ç–∫–∏ –æ —Å–æ—Å—Ç–æ—è–Ω–∏–∏, –æ—Å–æ–±–µ–Ω–Ω–æ—Å—Ç—è—Ö..."
                            rows={2}
                        />
                    </div>

                    <DialogFooter className="pt-4">
                        <Button type="button" variant="outline" onClick={handleClose}>
                            –û—Ç–º–µ–Ω–∞
                        </Button>
                        <Button
                            type="submit"
                            disabled={!isValid || createEquipmentMutation.isPending}
                        >
                            {createEquipmentMutation.isPending ? "–°–æ–∑–¥–∞–Ω–∏–µ..." : "–°–æ–∑–¥–∞—Ç—å –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏–µ"}
                        </Button>
                    </DialogFooter>
                </form>
            </DialogContent>
        </Dialog>
    );
}

```


## <a name="srccomponentsadminEquipmentEditDialogtsx"></a>`src/components/admin/EquipmentEditDialog.tsx`

```tsx
// path: src/components/admin/EquipmentEditDialog.tsx

// src/components/admin/EquipmentEditDialog.tsx

import { Dialog, DialogContent, DialogHeader, DialogTitle } from "@/components/ui/dialog";
import EquipmentEditForm from "@/components/equipment/EquipmentEditForm";
import type { Equipment } from "@/types/equipment";

interface Props {
    open: boolean;
    onClose: () => void;
    equipment: Equipment;
}

export default function EquipmentEditDialog({ open, onClose, equipment }: Props) {
    const handleSuccess = () => {
        onClose();
    };

    return (
        <Dialog open={open} onOpenChange={onClose} modal={false}>
            <DialogContent className="max-w-2xl">
                <DialogHeader>
                    <DialogTitle>–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—è</DialogTitle>
                </DialogHeader>
                <EquipmentEditForm
                    equipment={equipment}
                    onSuccess={handleSuccess}
                    onCancel={onClose}
                />
            </DialogContent>
        </Dialog>
    );
}

```


## <a name="srccomponentsadminEquipmentStatstsx"></a>`src/components/admin/EquipmentStats.tsx`

```tsx
// path: src/components/admin/EquipmentStats.tsx

// src/components/admin/EquipmentStats.tsx
import { useMemo } from 'react';
import type { Equipment } from "@/types/equipment";

interface Props {
    equipment: Equipment[];
}

export const EquipmentStats = ({ equipment }: Props) => {
    const stats = useMemo(() => {
        const totalCount = equipment.length;
        if (totalCount === 0) {
            return { totalCount: 0, typesCount: 0, brandsCount: 0, avgRate: 0 };
        }
        return {
            totalCount,
            typesCount: new Set(equipment.map(item => item.equipment_type)).size,
            brandsCount: new Set(equipment.map(item => item.brand)).size,
            avgRate: Math.round(equipment.reduce((sum, item) => sum + item.daily_rate, 0) / totalCount),
        };
    }, [equipment]);

    return (
        <div className="grid grid-cols-2 sm:grid-cols-4 gap-4 pt-4 border-t">
            <div className="text-center">
                <div className="text-2xl font-bold">{stats.totalCount}</div>
                <div className="text-sm text-muted-foreground">–í—Å–µ–≥–æ –µ–¥–∏–Ω–∏—Ü</div>
            </div>
            <div className="text-center">
                <div className="text-2xl font-bold">{stats.typesCount}</div>
                <div className="text-sm text-muted-foreground">–¢–∏–ø–æ–≤</div>
            </div>
            <div className="text-center">
                <div className="text-2xl font-bold">{stats.brandsCount}</div>
                <div className="text-sm text-muted-foreground">–ë—Ä–µ–Ω–¥–æ–≤</div>
            </div>
            <div className="text-center">
                <div className="text-2xl font-bold">{stats.avgRate.toLocaleString()} ‚ÇΩ</div>
                <div className="text-sm text-muted-foreground">–°—Ä–µ–¥–Ω–∏–π —Ç–∞—Ä–∏—Ñ</div>
            </div>
        </div>
    );
};

```


## <a name="srccomponentsadminEquipmentTabletsx"></a>`src/components/admin/EquipmentTable.tsx`

```tsx
// path: src/components/admin/EquipmentTable.tsx

// src/components/admin/EquipmentTable.tsx

import { useState } from "react";
import { Table, TableBody, TableHead, TableHeader, TableRow } from "@/components/ui/table";
import { Package, PackageSearch, Loader2 } from "lucide-react"; // ‚úÖ –î–æ–±–∞–≤–ª–µ–Ω –∏–º–ø–æ—Ä—Ç Loader2
import { Button } from "@/components/ui/button"; // ‚úÖ –î–æ–±–∞–≤–ª–µ–Ω –∏–º–ø–æ—Ä—Ç Button
import EquipmentCreateDialog from "./EquipmentCreateDialog";
import { useEquipmentTableLogic } from "@/hooks/admin/useEquipmentTableLogic";
import { EquipmentTableToolbar } from "./EquipmentTableToolbar";
import { EquipmentTableRow } from "./EquipmentTableRow";
import { EquipmentStats } from "./EquipmentStats";
import type { Equipment } from "@/types/equipment";

interface EquipmentTableProps {
    onEditEquipment?: (equipment: Equipment) => void;
    equipment: Equipment[];
    // ‚úÖ –ù–ê–ß–ê–õ–û: –î–æ–±–∞–≤–ª—è–µ–º –Ω–æ–≤—ã–µ —Å–≤–æ–π—Å—Ç–≤–∞ –¥–ª—è –ø–∞–≥–∏–Ω–∞—Ü–∏–∏
    hasNextPage?: boolean;
    isFetchingNextPage?: boolean;
    onLoadMore: () => void;
    // ‚úÖ –ö–û–ù–ï–¶: –ù–æ–≤—ã–µ —Å–≤–æ–π—Å—Ç–≤–∞ –¥–ª—è –ø–∞–≥–∏–Ω–∞—Ü–∏–∏
}

export default function EquipmentTable({
                                           onEditEquipment,
                                           equipment,
                                           hasNextPage,
                                           isFetchingNextPage,
                                           onLoadMore
                                       }: EquipmentTableProps) {
    const [showCreateDialog, setShowCreateDialog] = useState(false);

    const {
        isManager,
        isLoading,
        error,
        filteredEquipment,
        searchQuery,
        selectedIds,
        deleteEquipmentMutation,
        bulkDeleteMutation,
        handlers,
    } = useEquipmentTableLogic(equipment);

    if (isLoading) return <div className="flex justify-center p-4">–ó–∞–≥—Ä—É–∑–∫–∞ –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—è...</div>;
    if (error) return <div className="flex justify-center p-4 text-red-500">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—è</div>;

    return (
        <div className="space-y-4">
            <EquipmentTableToolbar
                searchQuery={searchQuery}
                onSearchChange={handlers.setSearchQuery}
                onAdd={() => setShowCreateDialog(true)}
                onBulkDelete={handlers.handleBulkDelete}
                selectedCount={selectedIds.length}
                totalCount={equipment.length}
                filteredCount={filteredEquipment.length}
                isManager={isManager}
                isDeleting={bulkDeleteMutation.isPending}
            />

            {filteredEquipment.length > 0 ? (
                <div className="border rounded-md">
                    <Table>
                        <TableHeader>
                            <TableRow>
                                {isManager && <TableHead className="w-12"></TableHead>}
                                <TableHead><Package className="inline mr-2 h-4 w-4" />–¢–∏–ø</TableHead>
                                <TableHead>–ë—Ä–µ–Ω–¥</TableHead>
                                <TableHead>–ù–∞–∑–≤–∞–Ω–∏–µ</TableHead>
                                <TableHead>–°–µ—Ä–∏–π–Ω—ã–π –Ω–æ–º–µ—Ä</TableHead>
                                <TableHead>–°–æ—Å—Ç–æ—è–Ω–∏–µ</TableHead>
                                <TableHead>–¢–∞—Ä–∏—Ñ/–¥–µ–Ω—å</TableHead>
                                {isManager && <TableHead>–î–µ–π—Å—Ç–≤–∏—è</TableHead>}
                            </TableRow>
                        </TableHeader>
                        <TableBody>
                            {filteredEquipment.map((item) => (
                                <EquipmentTableRow
                                    key={item.id}
                                    item={item}
                                    isSelected={selectedIds.includes(item.id)}
                                    isManager={isManager}
                                    isDeleting={deleteEquipmentMutation.isPending}
                                    onSelectItem={handlers.handleSelectItem}
                                    onEdit={onEditEquipment!}
                                    onDelete={handlers.handleDelete}
                                />
                            ))}
                        </TableBody>
                    </Table>
                </div>
            ) : (
                <div className="text-center py-12 px-4 border rounded-md">
                    <PackageSearch className="w-16 h-16 text-gray-300 mx-auto mb-3" />
                    <h3 className="text-lg font-semibold text-gray-700">–û–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏–µ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ</h3>
                    <p className="text-sm text-gray-500 max-w-sm">
                        {searchQuery ? "–ü–æ–ø—Ä–æ–±—É–π—Ç–µ –∏–∑–º–µ–Ω–∏—Ç—å –ø–æ–∏—Å–∫–æ–≤—ã–π –∑–∞–ø—Ä–æ—Å." : "–î–æ–±–∞–≤—å—Ç–µ –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏–µ, —á—Ç–æ–±—ã –æ–Ω–æ –ø–æ—è–≤–∏–ª–æ—Å—å –≤ —Å–ø–∏—Å–∫–µ."}
                    </p>
                </div>
            )}

            {/* ‚úÖ –ù–ê–ß–ê–õ–û: –ë–ª–æ–∫ —Å –∫–Ω–æ–ø–∫–æ–π –ø–∞–≥–∏–Ω–∞—Ü–∏–∏ */}
            {hasNextPage && (
                <div className="flex justify-center pt-2">
                    <Button
                        variant="outline"
                        onClick={onLoadMore}
                        disabled={isFetchingNextPage}
                    >
                        {isFetchingNextPage ? (
                            <>
                                <Loader2 className="mr-2 h-4 w-4 animate-spin" />
                                –ó–∞–≥—Ä—É–∑–∫–∞...
                            </>
                        ) : (
                            "–ó–∞–≥—Ä—É–∑–∏—Ç—å –µ—â—ë"
                        )}
                    </Button>
                </div>
            )}
            {/* ‚úÖ –ö–û–ù–ï–¶: –ë–ª–æ–∫ —Å –∫–Ω–æ–ø–∫–æ–π –ø–∞–≥–∏–Ω–∞—Ü–∏–∏ */}

            <EquipmentStats equipment={equipment} />

            <EquipmentCreateDialog
                open={showCreateDialog}
                onClose={() => setShowCreateDialog(false)}
                equipment={equipment}
            />
        </div>
    );
}

```


## <a name="srccomponentsadminEquipmentTableRowtsx"></a>`src/components/admin/EquipmentTableRow.tsx`

```tsx
// path: src/components/admin/EquipmentTableRow.tsx

// src/components/admin/EquipmentTableRow.tsx

import { TableCell, TableRow } from "@/components/ui/table";
import { Checkbox } from "@/components/ui/checkbox";
import { Button } from "@/components/ui/button";
import { Edit, Trash2 } from "lucide-react";
import type { Equipment } from "@/types/equipment";
import { getConditionVariantClass } from "@/constants/equipmentConstants";

interface Props {
    item: Equipment;
    isSelected: boolean;
    isManager: boolean;
    isDeleting: boolean;
    onSelectItem: (id: number, checked: boolean) => void;
    onEdit: (item: Equipment) => void;
    onDelete: (id: number) => void;
}

export const EquipmentTableRow = ({ item, isSelected, isManager, isDeleting, onSelectItem, onEdit, onDelete }: Props) => (
    <TableRow>
        {isManager && (
            <TableCell>
                <Checkbox
                    checked={isSelected}
                    onCheckedChange={(checked) => onSelectItem(item.id, Boolean(checked))}
                />
            </TableCell>
        )}
        <TableCell className="font-medium">{item.equipment_type}</TableCell>
        <TableCell>{item.brand}</TableCell>
        <TableCell>{item.name}</TableCell>
        <TableCell>{item.serial_number || "‚Äî"}</TableCell>
        <TableCell>
            {/* ‚úÖ –ò–ó–ú–ï–ù–ï–ù–ò–ï: –ò—Å–ø–æ–ª—å–∑—É–µ–º –∏–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω–Ω—É—é —Ñ—É–Ω–∫—Ü–∏—é */}
            <span className={`text-xs px-2 py-1 rounded-full font-medium ${getConditionVariantClass(item.condition)}`}>
                {item.condition}
            </span>
        </TableCell>
        <TableCell className="font-medium">{item.daily_rate.toLocaleString()} ‚ÇΩ</TableCell>
        {isManager && (
            <TableCell>
                <div className="flex gap-2">
                    <Button variant="outline" size="icon" onClick={() => onEdit(item)}>
                        <Edit className="h-4 w-4" />
                    </Button>
                    <Button variant="destructive" size="icon" onClick={() => onDelete(item.id)} disabled={isDeleting}>
                        <Trash2 className="h-4 w-4" />
                    </Button>
                </div>
            </TableCell>
        )}
    </TableRow>
);

```


## <a name="srccomponentsadminEquipmentTableToolbartsx"></a>`src/components/admin/EquipmentTableToolbar.tsx`

```tsx
// path: src/components/admin/EquipmentTableToolbar.tsx

// src/components/admin/EquipmentTableToolbar.tsx
import { Button } from "@/components/ui/button";
import { Input } from "@/components/ui/input";
import { Plus, Search, Trash2 } from "lucide-react";

interface Props {
    searchQuery: string;
    onSearchChange: (value: string) => void;
    onAdd: () => void;
    onBulkDelete: () => void;
    selectedCount: number;
    totalCount: number;
    filteredCount: number;
    isManager: boolean;
    isDeleting: boolean;
}

export const EquipmentTableToolbar = ({
                                          searchQuery,
                                          onSearchChange,
                                          onAdd,
                                          onBulkDelete,
                                          selectedCount,
                                          totalCount,
                                          filteredCount,
                                          isManager,
                                          isDeleting
                                      }: Props) => (
    <div className="flex flex-col sm:flex-row gap-4 items-start sm:items-center justify-between">
        <div className="relative flex-1 w-full sm:w-auto sm:max-w-sm">
            <Search className="absolute left-3 top-2.5 h-4 w-4 text-muted-foreground" />
            <Input
                placeholder="–ü–æ–∏—Å–∫ –ø–æ –Ω–∞–∑–≤–∞–Ω–∏—é, –±—Ä–µ–Ω–¥—É, —Ç–∏–ø—É..."
                value={searchQuery}
                onChange={(e) => onSearchChange(e.target.value)}
                className="pl-10"
            />
        </div>
        <div className="flex flex-col sm:flex-row gap-2 items-stretch sm:items-center w-full sm:w-auto">
            <span className="text-sm text-muted-foreground text-center sm:text-left">
                –ù–∞–π–¥–µ–Ω–æ: {filteredCount} –∏–∑ {totalCount}
            </span>
            {selectedCount > 0 && isManager && (
                <Button variant="destructive" size="sm" onClick={onBulkDelete} disabled={isDeleting}>
                    <Trash2 className="h-4 w-4 mr-2" />
                    –£–¥–∞–ª–∏—Ç—å ({selectedCount})
                </Button>
            )}
            {isManager && (
                <Button onClick={onAdd} size="sm" className="flex items-center gap-2">
                    <Plus className="h-4 w-4" />
                    –î–æ–±–∞–≤–∏—Ç—å –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏–µ
                </Button>
            )}
        </div>
    </div>
);

```


## <a name="srccomponentsadminHolidayManagertsx"></a>`src/components/admin/HolidayManager.tsx`

```tsx
// path: src/components/admin/HolidayManager.tsx

// src/components/admin/HolidayManager.tsx

import { useState, useMemo } from 'react';
import { DayPicker } from 'react-day-picker';
import { ru } from 'date-fns/locale';
import { format, startOfMonth, endOfMonth } from 'date-fns';
import { useHolidays, useCreateHoliday, useDeleteHoliday, type HolidayWithDate } from '@/hooks/useAdminHolidays';
import { useGetHolidayRules, useCreateWeeklyRule, useImportPublicHolidays, useDeleteHolidayRule } from '@/hooks/useAdminHolidayRules';

import { Button } from '@/components/ui/button';
import { Input } from '@/components/ui/input';
import { Trash2, CalendarPlus, Globe, Repeat } from 'lucide-react';
import { Dialog, DialogContent, DialogHeader, DialogTitle, DialogFooter, DialogDescription } from "@/components/ui/dialog";
import { toast } from 'sonner';
import { Card, CardContent, CardHeader, CardTitle, CardDescription } from "@/components/ui/card";
import { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from "@/components/ui/select";
import { Label } from "@/components/ui/label";
import { Table, TableBody, TableCell, TableHead, TableHeader, TableRow } from "@/components/ui/table";

type ConflictInfo = {
    date: Date;
    description: string;
    conflicting_reservation_ids: number[];
};

// --- –ù–æ–≤—ã–π –∫–æ–º–ø–æ–Ω–µ–Ω—Ç –¥–ª—è —Ñ–æ—Ä–º—ã –µ–∂–µ–Ω–µ–¥–µ–ª—å–Ω—ã—Ö –ø—Ä–∞–≤–∏–ª ---
function WeeklyRuleForm({ isLoading }: { isLoading: boolean }) {
    const [dayOfWeek, setDayOfWeek] = useState<string>("6"); // 6 = –í–æ—Å–∫—Ä–µ—Å–µ–Ω—å–µ
    const [startDate, setStartDate] = useState<string>(format(new Date(), 'yyyy-MM-dd'));
    const [endDate, setEndDate] = useState<string>(`${new Date().getFullYear()}-12-31`);
    const createRuleMutation = useCreateWeeklyRule();

    const daysOfWeek = [
        { label: "–ü–æ–Ω–µ–¥–µ–ª—å–Ω–∏–∫", value: "0" },
        { label: "–í—Ç–æ—Ä–Ω–∏–∫", value: "1" },
        { label: "–°—Ä–µ–¥–∞", value: "2" },
        { label: "–ß–µ—Ç–≤–µ—Ä–≥", value: "3" },
        { label: "–ü—è—Ç–Ω–∏—Ü–∞", value: "4" },
        { label: "–°—É–±–±–æ—Ç–∞", value: "5" },
        { label: "–í–æ—Å–∫—Ä–µ—Å–µ–Ω—å–µ", value: "6" },
    ];

    const handleSubmit = (e: React.FormEvent) => {
        e.preventDefault();
        const selectedDay = daysOfWeek.find(d => d.value === dayOfWeek);
        createRuleMutation.mutate({
            day_of_week: parseInt(dayOfWeek, 10),
            start_date: new Date(startDate),
            end_date: new Date(endDate),
            description: `–ï–∂–µ–Ω–µ–¥–µ–ª—å–Ω—ã–π –≤—ã—Ö–æ–¥–Ω–æ–π: ${selectedDay?.label}`
        });
    };

    return (
        <Card>
            <CardHeader>
                <CardTitle className="flex items-center gap-2"><Repeat className="w-5 h-5" /> –ï–∂–µ–Ω–µ–¥–µ–ª—å–Ω—ã–µ –≤—ã—Ö–æ–¥–Ω—ã–µ</CardTitle>
                <CardDescription>–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å–¥–µ–ª–∞—Ç—å –≤—ã—Ö–æ–¥–Ω—ã–º–∏ –≤—Å–µ –≤—ã–±—Ä–∞–Ω–Ω—ã–µ –¥–Ω–∏ –Ω–µ–¥–µ–ª–∏ –≤ –ø–µ—Ä–∏–æ–¥–µ.</CardDescription>
            </CardHeader>
            <CardContent>
                <form onSubmit={handleSubmit} className="space-y-4">
                    <div className="grid grid-cols-1 sm:grid-cols-3 gap-4">
                        <div>
                            <Label>–î–µ–Ω—å –Ω–µ–¥–µ–ª–∏</Label>
                            <Select value={dayOfWeek} onValueChange={setDayOfWeek}>
                                <SelectTrigger><SelectValue /></SelectTrigger>
                                <SelectContent>
                                    {daysOfWeek.map(day => (
                                        <SelectItem key={day.value} value={day.value}>{day.label}</SelectItem>
                                    ))}
                                </SelectContent>
                            </Select>
                        </div>
                        <div>
                            <Label>–ù–∞—á–∏–Ω–∞—è —Å</Label>
                            <Input type="date" value={startDate} onChange={e => setStartDate(e.target.value)} />
                        </div>
                        <div>
                            <Label>–ó–∞–∫–∞–Ω—á–∏–≤–∞—è</Label>
                            <Input type="date" value={endDate} onChange={e => setEndDate(e.target.value)} />
                        </div>
                    </div>
                    <Button type="submit" disabled={isLoading || createRuleMutation.isPending} className="w-full sm:w-auto">
                        {createRuleMutation.isPending ? "–°–æ–∑–¥–∞–Ω–∏–µ..." : "–°–æ–∑–¥–∞—Ç—å –ø—Ä–∞–≤–∏–ª–æ"}
                    </Button>
                </form>
            </CardContent>
        </Card>
    );
}

// --- –ù–æ–≤—ã–π –∫–æ–º–ø–æ–Ω–µ–Ω—Ç –¥–ª—è —Ñ–æ—Ä–º—ã –∏–º–ø–æ—Ä—Ç–∞ ---
function PublicHolidayImportForm({ isLoading }: { isLoading: boolean }) {
    const [year, setYear] = useState<number>(new Date().getFullYear());
    const [countryCode, setCountryCode] = useState<string>("RU");
    const importMutation = useImportPublicHolidays();

    const handleSubmit = (e: React.FormEvent) => {
        e.preventDefault();
        importMutation.mutate({ year, country_code: countryCode });
    };

    return (
        <Card>
            <CardHeader>
                <CardTitle className="flex items-center gap-2"><Globe className="w-5 h-5" /> –ò–º–ø–æ—Ä—Ç –≥–æ—Å. –ø—Ä–∞–∑–¥–Ω–∏–∫–æ–≤</CardTitle>
                <CardDescription>–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –¥–æ–±–∞–≤–∏—Ç—å –æ—Ñ–∏—Ü–∏–∞–ª—å–Ω—ã–µ –ø—Ä–∞–∑–¥–Ω–∏–∫–∏ –¥–ª—è —Å—Ç—Ä–∞–Ω—ã.</CardDescription>
            </CardHeader>
            <CardContent>
                <form onSubmit={handleSubmit} className="flex flex-col sm:flex-row items-end gap-4">
                    <div className="flex-grow">
                        <Label>–ì–æ–¥</Label>
                        <Input type="number" value={year} onChange={e => setYear(parseInt(e.target.value, 10))} />
                    </div>
                    <div className="flex-grow">
                        <Label>–ö–æ–¥ —Å—Ç—Ä–∞–Ω—ã (ISO 3166-1)</Label>
                        <Input value={countryCode} onChange={e => setCountryCode(e.target.value.toUpperCase())} placeholder="RU" />
                    </div>
                    <Button type="submit" disabled={isLoading || importMutation.isPending}>
                        {importMutation.isPending ? "–ò–º–ø–æ—Ä—Ç..." : "–ò–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å"}
                    </Button>
                </form>
            </CardContent>
        </Card>
    );
}


// --- –û—Å–Ω–æ–≤–Ω–æ–π –∫–æ–º–ø–æ–Ω–µ–Ω—Ç HolidayManager ---
export default function HolidayManager() {
    const [month, setMonth] = useState(new Date());
    const [description, setDescription] = useState("");
    const [conflict, setConflict] = useState<ConflictInfo | null>(null);

    const startDate = startOfMonth(month);
    const endDate = endOfMonth(month);

    const { data: holidays = [], isLoading: isLoadingHolidays } = useHolidays(startDate, endDate);
    const createMutation = useCreateHoliday();
    const deleteMutation = useDeleteHoliday();

    const { data: rules = [], isLoading: isLoadingRules } = useGetHolidayRules();
    const deleteRuleMutation = useDeleteHolidayRule();

    const holidayDates = useMemo(() => holidays.map((h: HolidayWithDate) => h.date), [holidays]);
    const holidaySet = useMemo(() => new Set(holidays.map((h: HolidayWithDate) => format(h.date, "yyyy-MM-dd"))), [holidays]);

    const handleDaySelect = (day: Date | undefined) => {
        if (!day) return;

        if (holidaySet.has(format(day, "yyyy-MM-dd"))) {
            toast.info("–≠—Ç–æ—Ç –¥–µ–Ω—å —É–∂–µ —è–≤–ª—è–µ—Ç—Å—è –≤—ã—Ö–æ–¥–Ω—ã–º.");
            return;
        }

        createMutation.mutate({
            date: format(day, "yyyy-MM-dd"),
            description: description || undefined,
        }, {
            onError: (error: any) => {
                if (error.response?.status === 409) {
                    setConflict({
                        date: day,
                        description: description,
                        conflicting_reservation_ids: error.response.data.detail.conflicting_reservation_ids,
                    });
                }
            },
            onSuccess: () => setDescription("")
        });
    };

    const handleForceCreate = () => {
        if (!conflict) return;
        createMutation.mutate(
            { date: format(conflict.date, "yyyy-MM-dd"), description: conflict.description, force: true },
            { onSuccess: () => setConflict(null) }
        );
    };

    const handleDeleteHoliday = (date: Date) => {
        if (window.confirm(`–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å –≤—ã—Ö–æ–¥–Ω–æ–π ${format(date, 'dd.MM.yyyy')}?`)) {
            deleteMutation.mutate(date);
        }
    };

    const handleDeleteRule = (ruleId: number) => {
        if (window.confirm(`–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å —ç—Ç–æ –ø—Ä–∞–≤–∏–ª–æ –∏ –≤—Å–µ —Å–æ–∑–¥–∞–Ω–Ω—ã–µ –∏–º –±—É–¥—É—â–∏–µ –≤—ã—Ö–æ–¥–Ω—ã–µ?`)) {
            deleteRuleMutation.mutate(ruleId);
        }
    };

    const isLoading = isLoadingHolidays || isLoadingRules;

    return (
        <div className="space-y-6">

            <div className="space-y-4">
                <WeeklyRuleForm isLoading={isLoading} />
                <PublicHolidayImportForm isLoading={isLoading} />
            </div>

            <Card>
                <CardHeader>
                    <CardTitle className="flex items-center gap-2"><CalendarPlus className="w-5 h-5" /> –†—É—á–Ω–æ–µ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ</CardTitle>
                    <CardDescription>–í—ã–±–µ—Ä–∏—Ç–µ –¥–∞—Ç—É –≤ –∫–∞–ª–µ–Ω–¥–∞—Ä–µ, —á—Ç–æ–±—ã —Å–¥–µ–ª–∞—Ç—å –µ–µ –≤—ã—Ö–æ–¥–Ω—ã–º, –∏–ª–∏ —É–¥–∞–ª–∏—Ç–µ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π.</CardDescription>
                </CardHeader>
                <CardContent className="grid grid-cols-1 md:grid-cols-2 gap-8">
                    <div>
                        <div className="space-y-2 mb-4">
                            <Label htmlFor="holiday-desc">–ù–∞–∑–≤–∞–Ω–∏–µ (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)</Label>
                            <Input id="holiday-desc" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä, –ö–æ—Ä–ø–æ—Ä–∞—Ç–∏–≤" value={description} onChange={(e) => setDescription(e.target.value)} />
                        </div>
                        <div className="flex justify-center border rounded-md p-2">
                            <DayPicker
                                mode="single" locale={ru} month={month} onMonthChange={setMonth}
                                onSelect={handleDaySelect} modifiers={{ holidays: holidayDates }}
                                modifiersClassNames={{ holidays: 'bg-red-100 text-red-800 rounded-md' }}
                                footer={isLoadingHolidays ? <p className="text-center text-sm p-2">–ó–∞–≥—Ä—É–∑–∫–∞...</p> : <p className="text-center text-sm p-2">–í—ã–±—Ä–∞–Ω –º–µ—Å—è—Ü: {format(month, "LLLL yyyy", { locale: ru })}</p>}
                            />
                        </div>
                    </div>
                    <div>
                        <h3 className="text-md font-semibold mb-4">–í—ã—Ö–æ–¥–Ω—ã–µ –≤ —ç—Ç–æ–º –º–µ—Å—è—Ü–µ:</h3>
                        {holidays.length > 0 ? (
                            <div className="space-y-2 max-h-96 overflow-y-auto pr-2">
                                {holidays.map((holiday: HolidayWithDate) => (
                                    <div key={holiday.date.toString()} className="flex items-center justify-between p-2 bg-gray-50 rounded-md">
                                        <div>
                                            <span className="font-medium">{format(holiday.date, 'PPP', { locale: ru })}</span>
                                            {holiday.description && <span className="text-gray-600 text-sm ml-2">- {holiday.description}</span>}
                                        </div>
                                        <Button variant="ghost" size="icon" onClick={() => handleDeleteHoliday(holiday.date)} disabled={deleteMutation.isPending}><Trash2 className="h-4 w-4 text-red-500" /></Button>
                                    </div>
                                ))}
                            </div>
                        ) : (<p className="text-sm text-gray-500">–í —ç—Ç–æ–º –º–µ—Å—è—Ü–µ –≤—ã—Ö–æ–¥–Ω—ã–µ –Ω–µ –Ω–∞–∑–Ω–∞—á–µ–Ω—ã.</p>)}
                    </div>
                </CardContent>
            </Card>

            <Card>
                <CardHeader>
                    <CardTitle>–ê–∫—Ç–∏–≤–Ω—ã–µ –ø—Ä–∞–≤–∏–ª–∞ –∞–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü–∏–∏</CardTitle>
                </CardHeader>
                <CardContent>
                    <Table>
                        <TableHeader>
                            <TableRow>
                                <TableHead>–û–ø–∏—Å–∞–Ω–∏–µ</TableHead>
                                <TableHead>–¢–∏–ø</TableHead>
                                <TableHead>–î–∞—Ç–∞ —Å–æ–∑–¥–∞–Ω–∏—è</TableHead>
                                <TableHead className="text-right">–î–µ–π—Å—Ç–≤–∏—è</TableHead>
                            </TableRow>
                        </TableHeader>
                        <TableBody>
                            {isLoadingRules ? <TableRow><TableCell colSpan={4} className="text-center">–ó–∞–≥—Ä—É–∑–∫–∞ –ø—Ä–∞–≤–∏–ª...</TableCell></TableRow> :
                                rules.length === 0 ? <TableRow><TableCell colSpan={4} className="text-center">–ù–µ—Ç –∞–∫—Ç–∏–≤–Ω—ã—Ö –ø—Ä–∞–≤–∏–ª.</TableCell></TableRow> :
                                    rules.map(rule => (
                                        <TableRow key={rule.id}>
                                            <TableCell>{rule.description}</TableCell>
                                            <TableCell><span className="text-xs font-mono bg-slate-100 px-2 py-1 rounded">{rule.rule_type}</span></TableCell>
                                            <TableCell>{format(new Date(rule.created_at), 'dd.MM.yyyy HH:mm')}</TableCell>
                                            <TableCell className="text-right">
                                                <Button variant="ghost" size="icon" onClick={() => handleDeleteRule(rule.id)} disabled={deleteRuleMutation.isPending}><Trash2 className="h-4 w-4 text-red-500" /></Button>
                                            </TableCell>
                                        </TableRow>
                                    ))}
                        </TableBody>
                    </Table>
                </CardContent>
            </Card>

            <Dialog open={!!conflict} onOpenChange={() => setConflict(null)}>
                <DialogContent>
                    <DialogHeader>
                        <DialogTitle>–û–±–Ω–∞—Ä—É–∂–µ–Ω –∫–æ–Ω—Ñ–ª–∏–∫—Ç</DialogTitle>
                        <DialogDescription>
                            –í—ã–±—Ä–∞–Ω–Ω–∞—è –¥–∞—Ç–∞ —è–≤–ª—è–µ—Ç—Å—è –¥–∞—Ç–æ–π –Ω–∞—á–∞–ª–∞ –∏–ª–∏ –æ–∫–æ–Ω—á–∞–Ω–∏—è –¥–ª—è —Å–ª–µ–¥—É—é—â–∏—Ö —Ä–µ–∑–µ—Ä–≤–æ–≤:
                            <strong className="block my-2">ID: {conflict?.conflicting_reservation_ids.join(', ')}</strong>
                            –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ —ç—Ç–æ–≥–æ –¥–Ω—è –≤—ã—Ö–æ–¥–Ω—ã–º —Å–¥–µ–ª–∞–µ—Ç —ç—Ç–∏ —Ä–µ–∑–µ—Ä–≤—ã –Ω–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–º–∏. –í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ –ø—Ä–æ–¥–æ–ª–∂–∏—Ç—å?
                        </DialogDescription>
                    </DialogHeader>
                    <DialogFooter>
                        <Button variant="ghost" onClick={() => setConflict(null)}>–û—Ç–º–µ–Ω–∞</Button>
                        <Button variant="destructive" onClick={handleForceCreate} disabled={createMutation.isPending}>
                            {createMutation.isPending ? "–û–±—Ä–∞–±–æ—Ç–∫–∞..." : "–î–∞, –≤—Å–µ —Ä–∞–≤–Ω–æ –Ω–∞–∑–Ω–∞—á–∏—Ç—å"}
                        </Button>
                    </DialogFooter>
                </DialogContent>
            </Dialog>
        </div>
    );
}

```


## <a name="srccomponentsadminPromoCodeDialogtsx"></a>`src/components/admin/PromoCodeDialog.tsx`

```tsx
// path: src/components/admin/PromoCodeDialog.tsx

// src/components/admin/PromoCodeDialog.tsx

import { useEffect, useMemo } from "react";
import { useForm, Controller } from "react-hook-form";
import { zodResolver } from "@hookform/resolvers/zod";
import { Button } from "@/components/ui/button";
import { Dialog, DialogContent, DialogHeader, DialogTitle, DialogFooter, DialogDescription } from "@/components/ui/dialog";
import { Input } from "@/components/ui/input";
import { Label } from "@/components/ui/label";
import { Switch } from "@/components/ui/switch";
import { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from "@/components/ui/select";
import { toast } from "sonner";
import { RefreshCw } from "lucide-react";

import { useCreatePromoCode, useUpdatePromoCode, fetchGeneratedPromoCode } from "@/hooks/useAdminPromoCodes";
import { useEquipment } from "@/hooks/useEquipment";
import { useAdminUsers } from "@/hooks/useAdminUsers";
import { useCurrentUser } from "@/hooks/useProfile";
import type { PromoCodeOut, PromoCodeCreate } from "@/types/promo_code";
import { promoCodeFormSchema, PromoCodeFormData } from "@/lib/validationSchemas";
import { MultiSelect } from "@/components/ui/multi-select";

interface Props {
    promoCode?: PromoCodeOut | null;
    open: boolean;
    onClose: () => void;
}

export function PromoCodeDialog({ promoCode, open, onClose }: Props) {
    const { data: user } = useCurrentUser();
    const createMutation = useCreatePromoCode();
    const updateMutation = useUpdatePromoCode();

    // +++ –ù–ê–ß–ê–õ–û –ò–ó–ú–ï–ù–ï–ù–ò–ô +++
    // 1. –ü–æ–ª—É—á–∞–µ–º –æ–±—ä–µ–∫—Ç —Å –ø–∞–≥–∏–Ω–∞—Ü–∏–µ–π –æ—Ç useInfiniteQuery
    const { data: equipmentPages } = useEquipment();
    const { data: usersResponse, isLoading: isLoadingUsers } = useAdminUsers();

    // 2. "–†–∞–∑–≤–æ—Ä–∞—á–∏–≤–∞–µ–º" —Å—Ç—Ä–∞–Ω–∏—Ü—ã –≤ –æ–¥–∏–Ω –ø–ª–æ—Å–∫–∏–π –º–∞—Å—Å–∏–≤ allEquipment
    const allEquipment = useMemo(() =>
            equipmentPages?.pages.flatMap(page => page.items) ?? [],
        [equipmentPages]);

    // 3. –ê–Ω–∞–ª–æ–≥–∏—á–Ω–æ –ø–æ—Å—Ç—É–ø–∞–µ–º —Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º–∏
    const users = useMemo(() => 
        usersResponse?.pages?.flatMap(page => page.items) ?? [], 
        [usersResponse]
    );
    // +++ –ö–û–ù–ï–¶ –ò–ó–ú–ï–ù–ï–ù–ò–ô +++


    const {
        register,
        handleSubmit,
        control,
        reset,
        setValue,
        formState: { errors, isValid },
    } = useForm<PromoCodeFormData>({
        resolver: zodResolver(promoCodeFormSchema) as any,
        mode: "onChange",
    });

    useEffect(() => {
        if (open) {
            if (promoCode) {
                reset({
                    code: promoCode.code,
                    description: promoCode.description ?? undefined,
                    discount_percentage: promoCode.discount_percentage,
                    is_active: promoCode.is_active,
                    valid_from: promoCode.valid_from ? new Date(promoCode.valid_from) : undefined,
                    expires_at: promoCode.expires_at ? new Date(promoCode.expires_at) : undefined,
                    max_uses: promoCode.max_uses ?? undefined,
                    max_uses_per_user: promoCode.max_uses_per_user ?? undefined,
                    min_order_amount: promoCode.min_order_amount ?? undefined,
                    specific_to_user_id: promoCode.specific_to_user_id ?? undefined,
                    applicable_to_equipment_ids: promoCode.applicable_to_equipment_ids ?? [],
                    applicable_to_equipment_types: promoCode.applicable_to_equipment_types ?? [],
                });
            } else {
                reset({
                    code: "",
                    description: "",
                    discount_percentage: 10,
                    is_active: true,
                    max_uses_per_user: 1,
                    applicable_to_equipment_ids: [],
                    applicable_to_equipment_types: [],
                });
            }
        }
    }, [promoCode, open, reset]);

    const onSubmit = (data: PromoCodeFormData) => {
        const maxDiscount = user?.role === 'admin' ? 50 : 20;
        if (data.discount_percentage > maxDiscount) {
            toast.error(`–ú–∞–∫—Å–∏–º–∞–ª—å–Ω–∞—è —Å–∫–∏–¥–∫–∞ –¥–ª—è –≤–∞—à–µ–π —Ä–æ–ª–∏: ${maxDiscount}%`);
            return;
        }

        const payload = {
            ...data,
            valid_from: data.valid_from ? data.valid_from.toISOString() : null,
            expires_at: data.expires_at ? data.expires_at.toISOString() : null,
        };

        if (promoCode) {
            updateMutation.mutate({ id: promoCode.id, data: payload }, { onSuccess: onClose });
        } else {
            createMutation.mutate(payload as PromoCodeCreate, { onSuccess: onClose });
        }
    };

    const handleGenerateCode = async () => {
        const newCode = await fetchGeneratedPromoCode();
        if (newCode) {
            setValue("code", newCode, { shouldValidate: true, shouldDirty: true });
        }
    };

    const isLoading = createMutation.isPending || updateMutation.isPending;

    // +++ –ù–ê–ß–ê–õ–û –ò–ó–ú–ï–ù–ï–ù–ò–ô: –ò—Å–ø–æ–ª—å–∑—É–µ–º `allEquipment` –≤–º–µ—Å—Ç–æ `equipments` +++
    const equipmentOptions = useMemo(() => allEquipment.map(e => ({ value: e.id.toString(), label: e.name })), [allEquipment]);
    const equipmentTypeOptions = useMemo(() => [...new Set(allEquipment.map(e => e.equipment_type))].map(type => ({ value: type, label: type })), [allEquipment]);
    // +++ –ö–û–ù–ï–¶ –ò–ó–ú–ï–ù–ï–ù–ò–ô +++
    const userOptions = useMemo(() => users.map((u: any) => ({ value: u.id.toString(), label: `${u.full_name} (${u.email})` })), [users]);

    return (
        <Dialog open={open} onOpenChange={onClose}>
            <DialogContent className="sm:max-w-[700px] max-h-[90vh] overflow-y-auto">
                <DialogHeader>
                    <DialogTitle>{promoCode ? "–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –ø—Ä–æ–º–æ–∫–æ–¥" : "–°–æ–∑–¥–∞—Ç—å –Ω–æ–≤—ã–π –ø—Ä–æ–º–æ–∫–æ–¥"}</DialogTitle>
                    <DialogDescription>{promoCode ? `–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ "${promoCode.code}"` : "–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –¥–µ—Ç–∞–ª–∏ –¥–ª—è –Ω–æ–≤–æ–≥–æ –ø—Ä–æ–º–æ–∫–æ–¥–∞."}</DialogDescription>
                </DialogHeader>
                <form onSubmit={handleSubmit(onSubmit)} className="space-y-4 py-4 pr-2">
                    <div className="grid grid-cols-4 items-center gap-4">
                        <Label htmlFor="code" className="text-right">–ö–æ–¥ *</Label>
                        <div className="col-span-3 flex items-center gap-2">
                            <Input id="code" {...register("code")} className="flex-grow" placeholder="SUMMER25"/>
                            <Button type="button" variant="outline" size="icon" onClick={handleGenerateCode} title="–°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –∫–æ–¥"><RefreshCw className="h-4 w-4" /></Button>
                        </div>
                        {errors.code && <p className="col-start-2 col-span-3 text-xs text-red-500 mt-1">{errors.code.message}</p>}
                    </div>

                    <div className="grid grid-cols-4 items-center gap-4">
                        <Label htmlFor="discount_percentage" className="text-right">–°–∫–∏–¥–∫–∞, % *</Label>
                        <div className="col-span-3"><Input id="discount_percentage" type="number" {...register("discount_percentage")} /></div>
                        {errors.discount_percentage && <p className="col-start-2 col-span-3 text-xs text-red-500 mt-1">{errors.discount_percentage.message}</p>}
                    </div>

                    <div className="grid grid-cols-4 items-center gap-4">
                        <Label htmlFor="description" className="text-right">–û–ø–∏—Å–∞–Ω–∏–µ</Label>
                        <div className="col-span-3"><Input id="description" {...register("description")} placeholder="–î–ª—è –≤–Ω—É—Ç—Ä–µ–Ω–Ω–µ–≥–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è"/></div>
                    </div>

                    <div className="grid grid-cols-4 items-center gap-4">
                        <Label className="text-right">–õ–∏–º–∏—Ç—ã</Label>
                        <div className="col-span-3 grid grid-cols-3 gap-2">
                            <Input type="number" {...register("max_uses")} placeholder="–í—Å–µ–≥–æ"/>
                            <Input type="number" {...register("max_uses_per_user")} placeholder="–ù–∞ —é–∑–µ—Ä–∞"/>
                            <Input type="number" {...register("min_order_amount")} placeholder="–ú–∏–Ω. —Å—É–º–º–∞ ‚ÇΩ"/>
                        </div>
                    </div>

                    <div className="grid grid-cols-4 items-center gap-4">
                        <Label className="text-right">–°—Ä–æ–∫ –¥–µ–π—Å—Ç–≤–∏—è</Label>
                        <div className="col-span-3 grid grid-cols-2 gap-2">
                            <Controller control={control} name="valid_from" render={({ field }) => (<Input type="date" onChange={(e) => field.onChange(e.target.valueAsDate)} value={field.value ? field.value.toISOString().split('T')[0] : ''}/>)} />
                            <Controller control={control} name="expires_at" render={({ field }) => (<Input type="date" onChange={(e) => field.onChange(e.target.valueAsDate)} value={field.value ? field.value.toISOString().split('T')[0] : ''}/>)} />
                        </div>
                        {errors.expires_at && <p className="col-start-2 col-span-3 text-xs text-red-500 mt-1">{errors.expires_at.message}</p>}
                    </div>

                    <div className="grid grid-cols-4 items-center gap-4">
                        <Label className="text-right">–î–ª—è —Ç–æ–≤–∞—Ä–æ–≤</Label>
                        <div className="col-span-3">
                            <Controller control={control} name="applicable_to_equipment_ids" render={({ field }) => (<MultiSelect placeholder="–î–ª—è –≤—Å–µ–≥–æ –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—è" options={equipmentOptions} value={field.value?.map(String) || []} onValueChange={(selected) => field.onChange(selected.map(Number))} />)} />
                        </div>
                    </div>

                    <div className="grid grid-cols-4 items-center gap-4">
                        <Label className="text-right">–î–ª—è —Ç–∏–ø–æ–≤</Label>
                        <div className="col-span-3">
                            <Controller control={control} name="applicable_to_equipment_types" render={({ field }) => (<MultiSelect placeholder="–î–ª—è –≤—Å–µ—Ö —Ç–∏–ø–æ–≤" options={equipmentTypeOptions} value={field.value || []} onValueChange={field.onChange}/>)} />
                        </div>
                    </div>

                    <div className="grid grid-cols-4 items-center gap-4">
                        <Label className="text-right">–î–ª—è —é–∑–µ—Ä–∞</Label>
                        <div className="col-span-3">
                            <Controller control={control} name="specific_to_user_id"
                                        render={({ field }) => (
                                            <Select
                                                onValueChange={(value) => field.onChange(value === 'all' ? undefined : Number(value))}
                                                value={field.value?.toString()}
                                                disabled={isLoadingUsers}
                                            >
                                                <SelectTrigger><SelectValue placeholder="–î–ª—è –≤—Å–µ—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π" /></SelectTrigger>
                                                <SelectContent>
                                                    <SelectItem value="all">–î–ª—è –≤—Å–µ—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π</SelectItem>
                                                    {userOptions.map((opt: any) => <SelectItem key={opt.value} value={opt.value}>{opt.label}</SelectItem>)}
                                                </SelectContent>
                                            </Select>
                                        )}
                            />
                        </div>
                    </div>

                    <div className="grid grid-cols-4 items-center gap-4">
                        <Label className="text-right">–°—Ç–∞—Ç—É—Å</Label>
                        <div className="col-span-3 flex items-center space-x-2">
                            <Controller control={control} name="is_active" render={({ field }) => (
                                <Switch id="is_active" checked={field.value} onCheckedChange={field.onChange} />
                            )} />
                            <Label htmlFor="is_active" className="font-normal cursor-pointer">–ê–∫—Ç–∏–≤–µ–Ω</Label>
                        </div>
                    </div>

                    <DialogFooter>
                        <Button type="button" variant="ghost" onClick={onClose}>–û—Ç–º–µ–Ω–∞</Button>
                        <Button type="submit" disabled={!isValid || isLoading}>
                            {isLoading ? "–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ..." : "–°–æ—Ö—Ä–∞–Ω–∏—Ç—å"}
                        </Button>
                    </DialogFooter>
                </form>
            </DialogContent>
        </Dialog>
    );
}

```


## <a name="srccomponentsadminPromoCodeTabletsx"></a>`src/components/admin/PromoCodeTable.tsx`

```tsx
// path: src/components/admin/PromoCodeTable.tsx

// src/components/admin/PromoCodeTable.tsx

import { useState } from "react";
import { useAdminPromoCodes, useDeletePromoCode } from "@/hooks/useAdminPromoCodes";
import { PromoCodeDialog } from "./PromoCodeDialog";
import type { PromoCodeOut } from "@/types/promo_code";
import { formatDateEuropean } from "@/lib/utils";

import { Button } from "@/components/ui/button";
import { Input } from "@/components/ui/input";
import { Badge } from "@/components/ui/badge";
import { Table, TableBody, TableCell, TableHead, TableHeader, TableRow } from "@/components/ui/table";
// ‚úÖ –£–±—Ä–∞–Ω–∞ –∏–∫–æ–Ω–∫–∞ AlertCircle
import { Plus, Edit, Trash2, Search, Ticket } from "lucide-react";

export default function PromoCodeTable() {
    const { data: promoCodes = [], isLoading, error } = useAdminPromoCodes();
    const deleteMutation = useDeletePromoCode();

    const [search, setSearch] = useState("");
    const [isDialogOpen, setDialogOpen] = useState(false);
    const [editingPromoCode, setEditingPromoCode] = useState<PromoCodeOut | null>(null);

    const filteredPromoCodes = promoCodes.filter(pc =>
        pc.code.toLowerCase().includes(search.toLowerCase()) ||
        pc.description?.toLowerCase().includes(search.toLowerCase())
    );

    const handleCreate = () => {
        setEditingPromoCode(null);
        setDialogOpen(true);
    };

    const handleEdit = (promoCode: PromoCodeOut) => {
        setEditingPromoCode(promoCode);
        setDialogOpen(true);
    };

    const handleDelete = (id: number) => {
        if (window.confirm("–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å —ç—Ç–æ—Ç –ø—Ä–æ–º–æ–∫–æ–¥? –î–µ–π—Å—Ç–≤–∏–µ –Ω–µ–æ–±—Ä–∞—Ç–∏–º–æ.")) {
            deleteMutation.mutate(id);
        }
    };

    if (isLoading) return <p className="text-center py-4">–ó–∞–≥—Ä—É–∑–∫–∞ –ø—Ä–æ–º–æ–∫–æ–¥–æ–≤...</p>;
    if (error) return <p className="text-center text-red-600 py-4">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö.</p>;

    return (
        <>
            <div className="flex flex-col sm:flex-row items-center justify-between gap-4 mb-4">
                <div className="relative w-full sm:max-w-xs">
                    <Search className="absolute left-3 top-2.5 h-4 w-4 text-muted-foreground" />
                    <Input
                        placeholder="–ü–æ–∏—Å–∫ –ø–æ –∫–æ–¥—É –∏–ª–∏ –æ–ø–∏—Å–∞–Ω–∏—é..."
                        value={search}
                        onChange={(e) => setSearch(e.target.value)}
                        className="pl-10"
                    />
                </div>
                <Button onClick={handleCreate} className="w-full sm:w-auto">
                    <Plus className="mr-2 h-4 w-4" /> –î–æ–±–∞–≤–∏—Ç—å –ø—Ä–æ–º–æ–∫–æ–¥
                </Button>
            </div>

            {filteredPromoCodes.length > 0 ? (
                <div className="border rounded-md overflow-x-auto">
                    <Table>
                        <TableHeader>
                            <TableRow>
                                <TableHead>–ö–æ–¥</TableHead>
                                <TableHead>–°–∫–∏–¥–∫–∞</TableHead>
                                <TableHead>–°—Ç–∞—Ç—É—Å</TableHead>
                                <TableHead>–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è</TableHead>
                                <TableHead>–°—Ä–æ–∫ –¥–µ–π—Å—Ç–≤–∏—è</TableHead>
                                <TableHead className="text-right">–î–µ–π—Å—Ç–≤–∏—è</TableHead>
                            </TableRow>
                        </TableHeader>
                        <TableBody>
                            {filteredPromoCodes.map((pc) => (
                                <TableRow key={pc.id}>
                                    <TableCell className="font-medium">{pc.code}</TableCell>
                                    <TableCell>{pc.discount_percentage}%</TableCell>
                                    <TableCell>
                                        <Badge variant={pc.is_active ? "default" : "secondary"}>
                                            {pc.is_active ? "–ê–∫—Ç–∏–≤–µ–Ω" : "–ù–µ–∞–∫—Ç–∏–≤–µ–Ω"}
                                        </Badge>
                                    </TableCell>
                                    <TableCell>
                                        {pc.times_used} / {pc.max_uses ?? '‚àû'}
                                    </TableCell>
                                    <TableCell>
                                        {pc.expires_at ? formatDateEuropean(pc.expires_at) : '–ë–µ—Å—Å—Ä–æ—á–Ω–æ'}
                                    </TableCell>
                                    <TableCell className="text-right">
                                        <Button variant="ghost" size="icon" onClick={() => handleEdit(pc)}>
                                            <Edit className="h-4 w-4" />
                                        </Button>
                                        <Button variant="ghost" size="icon" onClick={() => handleDelete(pc.id)} disabled={deleteMutation.isPending}>
                                            <Trash2 className="h-4 w-4 text-red-500" />
                                        </Button>
                                    </TableCell>
                                </TableRow>
                            ))}
                        </TableBody>
                    </Table>
                </div>
            ) : (
                <div className="text-center py-12 px-4 border-2 border-dashed rounded-lg">
                    <Ticket className="w-16 h-16 text-gray-300 mx-auto mb-3" />
                    <h3 className="text-lg font-semibold text-gray-700">–ü—Ä–æ–º–æ–∫–æ–¥—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã</h3>
                    <p className="text-sm text-gray-500 mt-1">
                        {search ? "–ü–æ–ø—Ä–æ–±—É–π—Ç–µ –∏–∑–º–µ–Ω–∏—Ç—å –ø–æ–∏—Å–∫–æ–≤—ã–π –∑–∞–ø—Ä–æ—Å." : "–î–æ–±–∞–≤—å—Ç–µ –ø–µ—Ä–≤—ã–π –ø—Ä–æ–º–æ–∫–æ–¥, —á—Ç–æ–±—ã –æ–Ω –ø–æ—è–≤–∏–ª—Å—è –≤ —Å–ø–∏—Å–∫–µ."}
                    </p>
                </div>
            )}

            <PromoCodeDialog
                open={isDialogOpen}
                onClose={() => setDialogOpen(false)}
                promoCode={editingPromoCode}
            />
        </>
    );
}

```


## <a name="srccomponentsadminRentalStatusBadgetsx"></a>`src/components/admin/RentalStatusBadge.tsx`

```tsx
// path: src/components/admin/RentalStatusBadge.tsx

// src/components/admin/RentalStatusBadge.tsx

import { Badge } from "@/components/ui/badge";

type RentalStatus = 'active' | 'overdue' | 'completed';

interface Props {
    status: RentalStatus;
}

export default function RentalStatusBadge({ status }: Props) {
    const statusConfig = {
        active: { text: "–ê–∫—Ç–∏–≤–Ω–∞", className: "bg-green-100 text-green-800 border-green-200" },
        overdue: { text: "–ü—Ä–æ—Å—Ä–æ—á–µ–Ω–∞", className: "bg-red-100 text-red-800 border-red-200" },
        completed: { text: "–ó–∞–≤–µ—Ä—à–µ–Ω–∞", className: "bg-gray-100 text-gray-800 border-gray-200" },
    };

    const config = statusConfig[status] || statusConfig.completed;

    return (
        <Badge variant="outline" className={`font-medium ${config.className}`}>
            {config.text}
        </Badge>
    );
}

```


## <a name="srccomponentsadminReservationFinancialSummarytsx"></a>`src/components/admin/ReservationFinancialSummary.tsx`

```tsx
// path: src/components/admin/ReservationFinancialSummary.tsx

// src/components/admin/ReservationFinancialSummary.tsx

import { useMemo } from "react";
import { usePriceCalculator } from "@/hooks/reservation/usePriceCalculator";
import { AlertCircle, Loader2, ReceiptText } from "lucide-react";
import type { AdminReservationOut } from "@/types/reservation";
import type { Equipment } from "@/types/equipment"; // –ò–º–ø–æ—Ä—Ç–∏—Ä—É–µ–º —Ç–∏–ø Equipment

interface ReservationFinancialSummaryProps {
    reservation: AdminReservationOut;
    open: boolean;
    // +++ –ù–ê–ß–ê–õ–û: –ù–æ–≤—ã–µ –ø—Ä–æ–ø—Å—ã –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –∫–æ–Ω—Ñ–ª–∏–∫—Ç–æ–≤ +++
    hasConflicts: boolean;
    conflictingItemIds: number[];
    isCheckingAvailability: boolean;
    equipmentMap: Map<number, Equipment>;
    // +++ –ö–û–ù–ï–¶: –ù–æ–≤—ã–µ –ø—Ä–æ–ø—Å—ã +++
}

export default function ReservationFinancialSummary({
                                                        reservation,
                                                        open,
                                                        hasConflicts,
                                                        conflictingItemIds,
                                                        isCheckingAvailability,
                                                        equipmentMap
                                                    }: ReservationFinancialSummaryProps) {

    const { newStartDate, newEndDate, newDateRangeIsValid } = useMemo(() => {
        const today = new Date();
        today.setHours(0, 0, 0, 0);

        const originalEndDate = new Date(reservation.end_date);

        return {
            newStartDate: today,
            newEndDate: originalEndDate,
            newDateRangeIsValid: originalEndDate > today,
        };
    }, [reservation]);

    const { data: priceDetails, isFetching: isCalculatingPrice, error: priceError } = usePriceCalculator({
        equipmentIds: reservation.equipment_ids || [],
        startDate: newStartDate!,
        endDate: newEndDate!,
        selectedAccessories: reservation.selected_accessories || {},
        promoCode: reservation.promo_code || undefined,
        enabled: open && newDateRangeIsValid,
    });

    const finalCost = priceDetails?.final_total ?? reservation.total_cost ?? 0;

    // +++ –ü–æ–ª—É—á–∞–µ–º –∏–º–µ–Ω–∞ –∫–æ–Ω—Ñ–ª–∏–∫—Ç–Ω–æ–≥–æ –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—è +++
    const conflictingEquipmentNames = useMemo(() =>
            conflictingItemIds.map(id => equipmentMap.get(id)?.name).filter(Boolean).join(', '),
        [conflictingItemIds, equipmentMap]);

    return (
        <div className="p-3 bg-slate-50 border rounded-lg space-y-2">
            <h4 className="flex items-center gap-2 text-sm font-semibold text-gray-800">
                <ReceiptText className="w-5 h-5 text-sky-600" />
                –§–∏–Ω–∞–Ω—Å–æ–≤–∞—è —Å–≤–æ–¥–∫–∞
            </h4>

            {(isCalculatingPrice || isCheckingAvailability) ? (
                <div className="flex items-center justify-center gap-2 text-sm text-gray-500 py-4">
                    <Loader2 className="h-4 w-4 animate-spin" />
                    {isCheckingAvailability ? "–ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏..." : "–ü–µ—Ä–µ—Å—á–µ—Ç —Å—Ç–æ–∏–º–æ—Å—Ç–∏..."}
                </div>
            ) : hasConflicts ? (
                // +++ –ù–ê–ß–ê–õ–û: –ù–æ–≤—ã–π –±–ª–æ–∫ –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –æ—à–∏–±–∫–∏ –∫–æ–Ω—Ñ–ª–∏–∫—Ç–∞ +++
                <div className="text-sm text-red-700 font-medium p-2 bg-red-100 border border-red-200 rounded-md space-y-1">
                    <div className="flex items-center gap-2">
                        <AlertCircle className="h-4 w-4" />
                        <span>–ö–æ–Ω—Ñ–ª–∏–∫—Ç –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è!</span>
                    </div>
                    <p className="text-xs font-normal pl-6">
                        –û–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏–µ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–æ –≤ –Ω–æ–≤–æ–º –ø–µ—Ä–∏–æ–¥–µ: <strong>{conflictingEquipmentNames}</strong>.
                    </p>
                </div>
                // +++ –ö–û–ù–ï–¶: –ù–æ–≤—ã–π –±–ª–æ–∫ +++
            ) : priceError || !newDateRangeIsValid ? (
                <div className="flex items-center gap-2 text-sm text-red-600 font-medium p-2 bg-red-50 rounded-md">
                    <AlertCircle className="h-4 w-4" />
                    <span>{priceError ? "–ù–µ —É–¥–∞–ª–æ—Å—å —Ä–∞—Å—Å—á–∏—Ç–∞—Ç—å —Ü–µ–Ω—É." : "–ù–µ–≤–æ–∑–º–æ–∂–Ω–æ –≤—ã–¥–∞—Ç—å: —Ä–µ–∑–µ—Ä–≤ —É–∂–µ –∑–∞–∫–æ–Ω—á–∏–ª—Å—è."}</span>
                </div>
            ) : (
                <div className="text-xs text-gray-700 space-y-1.5 border-t pt-2">
                    <div className="flex justify-between">
                        <span>–ü–µ—Ä–∏–æ–¥ —Ä–µ–∑–µ—Ä–≤–∞:</span>
                        <span className="font-medium">{new Date(reservation.start_date).toLocaleDateString()} - {new Date(reservation.end_date).toLocaleDateString()}</span>
                    </div>
                    <div className="flex justify-between">
                        <span>–°—Ç–æ–∏–º–æ—Å—Ç—å —Ä–µ–∑–µ—Ä–≤–∞:</span>
                        <span className="font-medium">{reservation.total_cost?.toLocaleString('ru-RU')} ‚ÇΩ</span>
                    </div>
                    <hr className="border-dashed my-1"/>
                    <div className="flex justify-between">
                        <span>–ù–æ–≤—ã–π –ø–µ—Ä–∏–æ–¥ –∞—Ä–µ–Ω–¥—ã:</span>
                        <span className="font-medium">{newStartDate?.toLocaleDateString()} - {newEndDate?.toLocaleDateString()}</span>
                    </div>
                    {priceDetails && (priceDetails.discount_amount > 0) && (
                        <div className="flex justify-between text-green-600">
                            <span>–°–∫–∏–¥–∫–∞ ({priceDetails.duration_discount_percentage}%):</span>
                            <span className="font-medium">- {priceDetails.discount_amount.toLocaleString('ru-RU')} ‚ÇΩ</span>
                        </div>
                    )}
                    <div className="flex justify-between text-base font-bold pt-1 border-t mt-1">
                        <span>–ò—Ç–æ–≥–æ –∫ —Å–ø–∏—Å–∞–Ω–∏—é —Å –±–∞–ª–∞–Ω—Å–∞:</span>
                        <span className="text-sky-700">{finalCost.toLocaleString('ru-RU')} ‚ÇΩ</span>
                    </div>
                </div>
            )}
        </div>
    );
}

```


## <a name="srccomponentsadminReturnAccessoriesChecklisttsx"></a>`src/components/admin/ReturnAccessoriesChecklist.tsx`

```tsx
// path: src/components/admin/ReturnAccessoriesChecklist.tsx

// src/components/admin/ReturnAccessoriesChecklist.tsx

import { Label } from "@/components/ui/label";
import { Checkbox } from "@/components/ui/checkbox";
import type { AdminRentalOut } from "@/types/rental";
import type { Accessory } from "@/types/accessory";
import type { Equipment } from "@/types/equipment";

interface Props {
    rental: AdminRentalOut;
    accessoriesByEquipment: Record<number, Accessory[]>;
    checkedAccessories: Set<string>;
    handleToggleAccessory: (equipmentId: number, accessoryId: number) => void;
    totalAccessoriesCount: number;
}

export default function ReturnAccessoriesChecklist({
    rental,
    accessoriesByEquipment,
    checkedAccessories,
    handleToggleAccessory,
    totalAccessoriesCount,
}: Props) {
    if (totalAccessoriesCount === 0) {
        return null;
    }

    return (
        <div className="space-y-3 pt-3 border-t">
            <Label className="font-semibold">–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç–µ –≤–æ–∑–≤—Ä–∞—Ç –∞–∫—Å–µ—Å—Å—É–∞—Ä–æ–≤:</Label>
            <div className="space-y-2 max-h-48 overflow-y-auto rounded-md border p-3 bg-slate-50">
                {rental.equipment.map((eq: Equipment) => (
                    accessoriesByEquipment[eq.id] && (
                        <div key={eq.id}>
                            <p className="text-sm font-medium text-gray-700">{eq.name}</p>
                            <ul className="pl-4 mt-1 space-y-1">
                                {accessoriesByEquipment[eq.id].map((acc: Accessory) => {
                                    const key = `${eq.id}-${acc.id}`;
                                    return (
                                        <li key={key} className="flex items-center">
                                            <Checkbox
                                                id={key}
                                                checked={checkedAccessories.has(key)}
                                                onCheckedChange={() => handleToggleAccessory(eq.id, acc.id)}
                                            />
                                            <Label htmlFor={key} className="ml-2 text-sm font-normal cursor-pointer">
                                                {acc.name}
                                            </Label>
                                        </li>
                                    );
                                })}
                            </ul>
                        </div>
                    )
                ))}
            </div>
        </div>
    );
}


```


## <a name="srccomponentsadminReturnFinancialstsx"></a>`src/components/admin/ReturnFinancials.tsx`

```tsx
// path: src/components/admin/ReturnFinancials.tsx

// src/components/admin/ReturnFinancials.tsx

import { Button } from "@/components/ui/button";
import { Label } from "@/components/ui/label";
import { Input } from "@/components/ui/input";
import { Textarea } from "@/components/ui/textarea";
import type { AdminRentalOut } from "@/types/rental";

interface Props {
    rental: AdminRentalOut;
    dynamicRemainingAmount: number;
    paymentAmount: string;
    setPaymentAmount: (value: string) => void;
    paymentDescription: string;
    setPaymentDescription: (value: string) => void;
    paymentApplied: boolean;
    handleApplyPayment: () => void;
    handleCancelPayment: () => void;
    isApplyingPayment: boolean;
    handleAutoFillPayment: () => void;
    overdueSurcharge?: number;
}

export default function ReturnFinancials({
    rental,
    dynamicRemainingAmount,
    paymentAmount,
    setPaymentAmount,
    paymentDescription,
    setPaymentDescription,
    paymentApplied,
    handleApplyPayment,
    handleCancelPayment,
    isApplyingPayment,
    handleAutoFillPayment,
    overdueSurcharge,
}: Props) {
    return (
        <div className="space-y-4 pt-3 border-t">
            <Label className="font-semibold text-base">–§–∏–Ω–∞–Ω—Å–æ–≤–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è</Label>
            
            {/* –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏–æ–Ω–Ω—ã–µ –ø–æ–ª—è */}
            <div className="space-y-2 bg-slate-50 p-3 rounded-md">
                <div className="flex justify-between">
                    <span className="text-sm text-gray-600">–¢–µ–∫—É—â–∏–π –±–∞–ª–∞–Ω—Å –∫–ª–∏–µ–Ω—Ç–∞:</span>
                    <span className="font-medium">{(rental.user.balance || 0).toLocaleString()} ‚ÇΩ</span>
                </div>
                <div className="flex justify-between">
                    <span className="text-sm text-gray-600">–°—Ç–æ–∏–º–æ—Å—Ç—å –∞—Ä–µ–Ω–¥—ã:</span>
                    <span className="font-medium">{rental.total_cost.toLocaleString()} ‚ÇΩ</span>
                </div>
                <div className="flex justify-between">
                    <span className="text-sm text-gray-600">–í–Ω–µ—Å–µ–Ω–Ω–∞—è –ø—Ä–µ–¥–æ–ø–ª–∞—Ç–∞:</span>
                    <span className="font-medium">{rental.prepayment_amount.toLocaleString()} ‚ÇΩ</span>
                </div>
                <div className="flex justify-between">
                    <span className="text-sm text-gray-600">–û—Å—Ç–∞—Ç–æ–∫ –∫ –æ–ø–ª–∞—Ç–µ:</span>
                    <span className={`font-medium ${dynamicRemainingAmount > 0 ? 'text-red-600' : 'text-green-600'}`}>
                        {dynamicRemainingAmount.toLocaleString()} ‚ÇΩ
                    </span>
                </div>
                <div className="flex justify-between">
                    <span className="text-sm text-gray-600">–í–Ω–µ—Å–µ–Ω–Ω—ã–π –∑–∞–ª–æ–≥:</span>
                    <span className="font-medium">{rental.deposit_amount.toLocaleString()} ‚ÇΩ</span>
                </div>
                {overdueSurcharge && overdueSurcharge > 0 && (
                    <div className="flex justify-between text-red-600 font-semibold pt-2 border-t border-dashed">
                        <span>–®—Ç—Ä–∞—Ñ –∑–∞ –ø—Ä–æ—Å—Ä–æ—á–∫—É:</span>
                        <span>+ {overdueSurcharge.toLocaleString()} ‚ÇΩ</span>
                    </div>
                )}
            </div>

            {/* –ü–æ–ª—è –¥–ª—è –ø–ª–∞—Ç–µ–∂–∞ */}
            <div className="space-y-3">
                <div>
                    <div className="flex items-center justify-between mb-1">
                        <Label htmlFor="payment_amount">–°—É–º–º–∞ –ø–ª–∞—Ç–µ–∂–∞</Label>
                        {!paymentApplied && dynamicRemainingAmount > 0 && (
                            <Button
                                type="button"
                                variant="ghost"
                                size="sm"
                                onClick={handleAutoFillPayment}
                                className="text-xs h-6 px-2"
                            >
                                –ó–∞–ø–æ–ª–Ω–∏—Ç—å –æ—Å—Ç–∞—Ç–æ–∫
                            </Button>
                        )}
                    </div>
                    <Input
                        id="payment_amount"
                        type="number"
                        value={paymentAmount}
                        onChange={(e) => setPaymentAmount(e.target.value)}
                        placeholder="–í–≤–µ–¥–∏—Ç–µ —Å—É–º–º—É"
                        disabled={paymentApplied}
                        className={paymentApplied ? "bg-green-50 border-green-200" : ""}
                    />
                    {paymentApplied && (
                        <p className="text-xs text-green-600 mt-1 flex items-center">
                            <span className="mr-1">‚úì</span>
                            –ü–ª–∞—Ç–µ–∂ —É—á—Ç–µ–Ω
                        </p>
                    )}
                </div>
                
                <div>
                    <Label htmlFor="payment_description">–û–ø–∏—Å–∞–Ω–∏–µ –ø–ª–∞—Ç–µ–∂–∞</Label>
                    <Textarea
                        id="payment_description"
                        value={paymentDescription}
                        onChange={(e) => setPaymentDescription(e.target.value)}
                        placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: –ß–∞—Å—Ç–∏—á–Ω–∞—è –æ–ø–ª–∞—Ç–∞ –ø—Ä–∏ –≤–æ–∑–≤—Ä–∞—Ç–µ"
                        disabled={paymentApplied}
                        className={paymentApplied ? "bg-green-50 border-green-200" : ""}
                    />
                </div>

                {/* –ö–Ω–æ–ø–∫–∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –ø–ª–∞—Ç–µ–∂–æ–º */}
                <div className="flex gap-2">
                    <Button
                        type="button"
                        variant="outline"
                        onClick={handleApplyPayment}
                        disabled={!paymentAmount || paymentApplied || isApplyingPayment}
                        className="flex-1"
                    >
                        {isApplyingPayment ? "–û–±—Ä–∞–±–æ—Ç–∫–∞..." : "–í–Ω–µ—Å—Ç–∏ –ø–ª–∞—Ç–µ–∂"}
                    </Button>
                    
                    {paymentApplied && (
                        <Button
                            type="button"
                            variant="destructive"
                            onClick={handleCancelPayment}
                            className="flex-1"
                        >
                            –û—Ç–º–µ–Ω–∏—Ç—å –ø–ª–∞—Ç–µ–∂
                        </Button>
                    )}
                </div>
            </div>
        </div>
    );
}


```


## <a name="srccomponentsadminReturnRentalDialogtsx"></a>`src/components/admin/ReturnRentalDialog.tsx`

```tsx
// path: src/components/admin/ReturnRentalDialog.tsx

// src/components/admin/ReturnRentalDialog.tsx

import { Dialog, DialogContent, DialogHeader, DialogTitle, DialogFooter, DialogDescription } from "@/components/ui/dialog";
import { Button } from "@/components/ui/button";
import { Label } from "@/components/ui/label";
import { Input } from "@/components/ui/input";
import { Textarea } from "@/components/ui/textarea";
import type { AdminRentalOut } from "@/types/rental";
import { useRentalReturnForm } from "@/hooks/admin/useRentalReturnForm";
import ReturnFinancials from "./ReturnFinancials";
import ReturnAccessoriesChecklist from "./ReturnAccessoriesChecklist";

interface Props {
    rental: AdminRentalOut | null;
    open: boolean;
    onClose: () => void;
}

export default function ReturnRentalDialog({ rental, open, onClose }: Props) {
    const {
        // –°–æ—Å—Ç–æ—è–Ω–∏—è
        paymentAmount,
        setPaymentAmount,
        paymentDescription,
        setPaymentDescription,
        paymentApplied,
        checkedAccessories,
        dynamicRemainingAmount,
        
        // –§—É–Ω–∫—Ü–∏–∏-–æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏
        handleApplyPayment,
        handleCancelPayment,
        handleToggleAccessory,
        handleAutoFillPayment,
        onSubmit,
        
        // –°–æ—Å—Ç–æ—è–Ω–∏—è –º—É—Ç–∞—Ü–∏–π
        isSubmittingReturn,
        isApplyingPayment,
        
        // –î–∞–Ω–Ω—ã–µ —Ñ–æ—Ä–º—ã –æ—Ç react-hook-form
        register,
        handleSubmit,
        formState: { errors, isValid },
        
        // –î—Ä—É–≥–∏–µ –≤—ã—á–∏—Å–ª—è–µ–º—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è
        accessoriesByEquipment,
        allAccessoriesChecked,
        totalAccessoriesCount,
    } = useRentalReturnForm({ rental, onClose });

    if (!rental) return null;

    return (
        <Dialog open={open} onOpenChange={onClose}>
            <DialogContent>
                <DialogHeader>
                    <DialogTitle>–û—Ñ–æ—Ä–º–ª–µ–Ω–∏–µ –≤–æ–∑–≤—Ä–∞—Ç–∞ –∞—Ä–µ–Ω–¥—ã #{rental.id}</DialogTitle>
                    <DialogDescription>
                        –ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç–µ –≤–æ–∑–≤—Ä–∞—Ç –æ—Ç –∫–ª–∏–µ–Ω—Ç–∞: <strong>{rental.user.full_name}</strong>.
                    </DialogDescription>
                </DialogHeader>
                <form onSubmit={handleSubmit(onSubmit)} className="space-y-4 py-2">
                    <div>
                        <Label htmlFor="actual_return_date">–§–∞–∫—Ç–∏—á–µ—Å–∫–∞—è –¥–∞—Ç–∞ –≤–æ–∑–≤—Ä–∞—Ç–∞ *</Label>
                        <Input
                            id="actual_return_date"
                            type="date"
                            {...register("actual_return_date")}
                        />
                        {errors.actual_return_date && <p className="text-xs text-red-600 mt-1">{errors.actual_return_date.message}</p>}
                    </div>
                    <div>
                        <Label htmlFor="notes_on_return">–ó–∞–º–µ—Ç–∫–∏ –ø—Ä–∏ –≤–æ–∑–≤—Ä–∞—Ç–µ</Label>
                        <Textarea
                            id="notes_on_return"
                            {...register("notes_on_return")}
                            placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏–µ —á–∏—Å—Ç–æ–µ, –∫–æ–º–ø–ª–µ–∫—Ç–∞—Ü–∏—è –ø–æ–ª–Ω–∞—è..."
                        />
                    </div>

                    {/* –§–∏–Ω–∞–Ω—Å–æ–≤—ã–π –±–ª–æ–∫ */}
                    <ReturnFinancials
                        rental={rental}
                        dynamicRemainingAmount={dynamicRemainingAmount}
                        paymentAmount={paymentAmount}
                        setPaymentAmount={setPaymentAmount}
                        paymentDescription={paymentDescription}
                        setPaymentDescription={setPaymentDescription}
                        paymentApplied={paymentApplied}
                        handleApplyPayment={handleApplyPayment}
                        handleCancelPayment={handleCancelPayment}
                        isApplyingPayment={isApplyingPayment}
                        handleAutoFillPayment={handleAutoFillPayment}
                        overdueSurcharge={rental.overdue_surcharge || undefined}
                    />

                    {/* –°–ø–∏—Å–æ–∫ –∞–∫—Å–µ—Å—Å—É–∞—Ä–æ–≤ */}
                    <ReturnAccessoriesChecklist
                        rental={rental}
                        accessoriesByEquipment={accessoriesByEquipment}
                        checkedAccessories={checkedAccessories}
                        handleToggleAccessory={handleToggleAccessory}
                        totalAccessoriesCount={totalAccessoriesCount}
                    />

                    <DialogFooter>
                        <Button type="button" variant="ghost" onClick={onClose}>–û—Ç–º–µ–Ω–∞</Button>
                        <Button
                            type="submit"
                            disabled={!isValid || isSubmittingReturn || (totalAccessoriesCount > 0 && !allAccessoriesChecked)}
                        >
                            {isSubmittingReturn ? "–û–±—Ä–∞–±–æ—Ç–∫–∞..." : "–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å –≤–æ–∑–≤—Ä–∞—Ç"}
                        </Button>
                    </DialogFooter>
                </form>
            </DialogContent>
        </Dialog>
    );
}

```


## <a name="srccomponentsadminUserCreateDialogtsx"></a>`src/components/admin/UserCreateDialog.tsx`

```tsx
// path: src/components/admin/UserCreateDialog.tsx

// src/components/admin/UserCreateDialog.tsx

import { useForm, Controller } from "react-hook-form";
import { zodResolver } from "@hookform/resolvers/zod";
import { adminUserCreateFormSchema, type AdminUserCreateFormSchema } from "@/lib/validationSchemas";
import { useAdminCreateUser } from "@/hooks/useAdminUsers";
import { USER_ROLE_OPTIONS, USER_ROLES } from "@/constants/userConstants";

import { Button } from "@/components/ui/button";
import { Input } from "@/components/ui/input";
import { Label } from "@/components/ui/label";
import { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from "@/components/ui/select";
import { Dialog, DialogContent, DialogHeader, DialogTitle, DialogFooter, DialogDescription } from "@/components/ui/dialog";
import { PhoneInput } from "@/components/ui/phone-input";

interface Props {
    open: boolean;
    onClose: () => void;
}

export function UserCreateDialog({ open, onClose }: Props) {
    const createMutation = useAdminCreateUser();
    const { register, handleSubmit, formState: { errors, isValid }, reset, control } = useForm<AdminUserCreateFormSchema>({
        resolver: zodResolver(adminUserCreateFormSchema),
        mode: "onChange",
        defaultValues: {
            role: USER_ROLES.USER,
            privacyPolicyAccepted: true,
            termsAccepted: true,
            emailVerified: true,
        }
    });

    const onSubmit = (data: AdminUserCreateFormSchema) => {
        createMutation.mutate(data, {
            onSuccess: () => {
                reset();
                onClose();
            },
        });
    };

    const handleDialogClose = () => {
        reset();
        onClose();
    }

    return (
        <Dialog open={open} onOpenChange={handleDialogClose}>
            <DialogContent>
                <DialogHeader>
                    <DialogTitle>–ù–æ–≤—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å</DialogTitle>
                    <DialogDescription>
                        –°–æ–∑–¥–∞–Ω–∏–µ –Ω–æ–≤–æ–π —É—á–µ—Ç–Ω–æ–π –∑–∞–ø–∏—Å–∏ –∏ —Å–≤—è–∑–∞–Ω–Ω–æ–≥–æ –ø—Ä–æ—Ñ–∏–ª—è –∫–ª–∏–µ–Ω—Ç–∞.
                    </DialogDescription>
                </DialogHeader>
                <form onSubmit={handleSubmit(onSubmit)} className="space-y-4 py-2">
                    <div>
                        <Label htmlFor="create-full_name">–§–ò–û *</Label>
                        <Input id="create-full_name" {...register("full_name")} placeholder="–ò–≤–∞–Ω –ü–µ—Ç—Ä–æ–≤" />
                        {errors.full_name && <p className="text-xs text-red-600 mt-1">{errors.full_name.message}</p>}
                    </div>

                    <div>
                        <Label htmlFor="create-email">Email *</Label>
                        <Input id="create-email" type="email" {...register("email")} placeholder="user@example.com" />
                        {errors.email && <p className="text-xs text-red-600 mt-1">{errors.email.message}</p>}
                    </div>

                    {/* +++ –ù–ê–ß–ê–õ–û: –ù–æ–≤–æ–µ –ø–æ–ª–µ –¥–ª—è —Ç–µ–ª–µ—Ñ–æ–Ω–∞ +++ */}
                    <div>
                        <Label htmlFor="create-phone">–¢–µ–ª–µ—Ñ–æ–Ω</Label>
                        <Controller
                            name="phone"
                            control={control}
                            render={({ field }) => (
                                <PhoneInput
                                    id="create-phone"
                                    placeholder="+7 (___) ___-__-__"
                                    {...field} // –ü–µ—Ä–µ–¥–∞–µ–º –≤—Å–µ —Å–≤–æ–π—Å—Ç–≤–∞ –ø–æ–ª—è (value, onChange, onBlur, ref)
                                />
                            )}
                        />
                        {errors.phone && <p className="text-xs text-red-600 mt-1">{errors.phone.message}</p>}
                    </div>
                    {/* +++ –ö–û–ù–ï–¶: –ù–æ–≤–æ–µ –ø–æ–ª–µ –¥–ª—è —Ç–µ–ª–µ—Ñ–æ–Ω–∞ +++ */}

                    <div>
                        <Label htmlFor="create-password">–ü–∞—Ä–æ–ª—å *</Label>
                        <Input id="create-password" type="password" {...register("password")} placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" />
                        {errors.password && <p className="text-xs text-red-600 mt-1">{errors.password.message}</p>}
                    </div>

                    <div>
                        <Label htmlFor="create-role">–†–æ–ª—å *</Label>
                        <Controller
                            name="role"
                            control={control}
                            render={({ field }) => (
                                <Select onValueChange={field.onChange} defaultValue={field.value}>
                                    <SelectTrigger id="create-role">
                                        <SelectValue placeholder="–í—ã–±–µ—Ä–∏—Ç–µ —Ä–æ–ª—å" />
                                    </SelectTrigger>
                                    <SelectContent>
                                        {USER_ROLE_OPTIONS.map(option => (
                                            <SelectItem key={option.value} value={option.value}>
                                                {option.label}
                                            </SelectItem>
                                        ))}
                                    </SelectContent>
                                </Select>
                            )}
                        />
                        {errors.role && <p className="text-xs text-red-600 mt-1">{errors.role.message}</p>}
                    </div>

                    <DialogFooter className="pt-4">
                        <Button type="button" variant="ghost" onClick={handleDialogClose}>–û—Ç–º–µ–Ω–∞</Button>
                        <Button type="submit" disabled={!isValid || createMutation.isPending}>
                            {createMutation.isPending ? "–°–æ–∑–¥–∞–Ω–∏–µ..." : "–°–æ–∑–¥–∞—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è"}
                        </Button>
                    </DialogFooter>
                </form>
            </DialogContent>
        </Dialog>
    );
}

```


## <a name="srccomponentsadminUserEditDialogtsx"></a>`src/components/admin/UserEditDialog.tsx`

```tsx
// path: src/components/admin/UserEditDialog.tsx

// src/components/admin/UserEditDialog.tsx

import { useEffect, useState } from "react";
import { useForm, Controller } from "react-hook-form";
import { zodResolver } from "@hookform/resolvers/zod";
import { adminUserUpdateSchema, type AdminUserUpdateSchema } from "@/lib/validationSchemas";
import { useAdminUpdateUser, useUpdateUserRole } from "@/hooks/useAdminUsers";
import { useCurrentUser } from "@/hooks/useProfile";
import { USER_ROLE_OPTIONS, USER_ROLE_LABELS } from "@/constants/userConstants";
import type { UserOut, UserRole } from "@/types/user"; // ‚úÖ –ò–ó–ú–ï–ù–ï–ù–ò–ï: –î–æ–±–∞–≤–ª–µ–Ω –∏–º–ø–æ—Ä—Ç UserRole

import { Button } from "@/components/ui/button";
import { Input } from "@/components/ui/input";
import { Label } from "@/components/ui/label";
import { Textarea } from "@/components/ui/textarea";
import { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from "@/components/ui/select";
import { Dialog, DialogContent, DialogHeader, DialogTitle, DialogFooter, DialogDescription } from "@/components/ui/dialog";
import { ConfirmationDialog } from "@/components/ui/confirmation-dialog";
import { PhoneInput } from "@/components/ui/phone-input";

interface Props {
    user: UserOut | null;
    open: boolean;
    onClose: () => void;
}

const statusOptions = [
    { value: "–ê–∫—Ç–∏–≤–Ω—ã–π", label: "–ê–∫—Ç–∏–≤–Ω—ã–π" },
    { value: "–¢—Ä–µ–±—É–µ—Ç –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è", label: "–¢—Ä–µ–±—É–µ—Ç –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è" },
    { value: "–ó–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω", label: "–ó–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω" },
];

export function UserEditDialog({ user, open, onClose }: Props) {
    const { data: currentUser } = useCurrentUser();
    const isAdmin = currentUser?.role === 'admin';
    const updateMutation = useAdminUpdateUser();
    const updateRoleMutation = useUpdateUserRole();
    const [showRoleConfirmation, setShowRoleConfirmation] = useState(false);
    const [pendingRoleChange, setPendingRoleChange] = useState<string | null>(null);

    const { register, handleSubmit, formState: { errors, isValid, isDirty }, reset, control } = useForm<AdminUserUpdateSchema>({
        resolver: zodResolver(adminUserUpdateSchema),
        mode: "onChange",
    });

    useEffect(() => {
        if (user && open) {
            const formData = {
                full_name: user.full_name,
                phone: user.phone || "",
                status: user.status || "",
                notes: user.notes || "",
                balance: user.balance,
            };
            reset(formData);
        }
    }, [user, open, reset]); // ‚úÖ –ò–ó–ú–ï–ù–ï–ù–ò–ï: `reset` –∑–¥–µ—Å—å –±–µ–∑–æ–ø–∞—Å–µ–Ω, –æ—Å—Ç–∞–≤–ª—è–µ–º –µ–≥–æ –¥–ª—è —Å–±—Ä–æ—Å–∞ —Ñ–æ—Ä–º—ã –ø—Ä–∏ —Å–º–µ–Ω–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è

    const handleRoleChange = (newRole: string) => {
        if (!user || !isAdmin || currentUser?.role !== 'admin') return;
        if (newRole !== user.role) {
            setPendingRoleChange(newRole);
            setShowRoleConfirmation(true);
        }
    };

    const confirmRoleChange = () => {
        if (!user || !pendingRoleChange || !isAdmin) return;

        // ‚úÖ –ò–ó–ú–ï–ù–ï–ù–ò–ï: –ü—Ä–∏–≤–æ–¥–∏–º —Å—Ç—Ä–æ–∫—É –∫ —Ç–∏–ø—É UserRole, —á—Ç–æ–±—ã –∏—Å–ø—Ä–∞–≤–∏—Ç—å –æ—à–∏–±–∫—É TS2322
        updateRoleMutation.mutate({ userId: user.id, newRole: pendingRoleChange as UserRole }, {
            onSuccess: () => {
                setPendingRoleChange(null);
                setShowRoleConfirmation(false);
            },
        });
    };

    const onSubmit = (data: AdminUserUpdateSchema) => {
        if (!user) return;
        updateMutation.mutate({ userId: user.id, data }, {
            onSuccess: () => {
                onClose();
            },
        });
    };

    if (!user) return null;

    return (
        <>
            <Dialog open={open} onOpenChange={onClose}>
                <DialogContent className="sm:max-w-[600px]">
                    <DialogHeader>
                        <DialogTitle>–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –ø—Ä–æ—Ñ–∏–ª—è</DialogTitle>
                        <DialogDescription>
                            –í—ã –∏–∑–º–µ–Ω—è–µ—Ç–µ –¥–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è: <strong>{user.full_name}</strong>
                        </DialogDescription>
                    </DialogHeader>
                    <form onSubmit={handleSubmit(onSubmit)} className="space-y-4 py-2">
                        <div>
                            <Label htmlFor="edit-email">Email (–Ω–µ–ª—å–∑—è –∏–∑–º–µ–Ω–∏—Ç—å)</Label>
                            <Input id="edit-email" value={user.email} disabled />
                        </div>

                        <div className="grid grid-cols-1 sm:grid-cols-2 gap-4">
                            <div>
                                <Label htmlFor="edit-full_name">–§–ò–û *</Label>
                                <Input id="edit-full_name" {...register("full_name")} />
                                {errors.full_name && <p className="text-xs text-red-600 mt-1">{errors.full_name.message}</p>}
                            </div>
                            <div>
                                <Label htmlFor="edit-phone">–¢–µ–ª–µ—Ñ–æ–Ω</Label>
                                {/* ‚úÖ –ò–ó–ú–ï–ù–ï–ù–ò–ï: –û–±–æ—Ä–∞—á–∏–≤–∞–µ–º PhoneInput –≤ Controller –¥–ª—è —Å—Ç–∞–±–∏–ª—å–Ω–æ–π —Ä–∞–±–æ—Ç—ã */}
                                <Controller
                                    name="phone"
                                    control={control}
                                    render={({ field }) => (
                                        <PhoneInput id="edit-phone" {...field} />
                                    )}
                                />
                                {errors.phone && <p className="text-xs text-red-600 mt-1">{errors.phone.message}</p>}
                            </div>
                        </div>

                        <div className="grid grid-cols-1 sm:grid-cols-2 gap-4">
                            <div>
                                <Label htmlFor="edit-role">–†–æ–ª—å</Label>
                                <Select
                                    onValueChange={handleRoleChange}
                                    value={user.role}
                                    disabled={!isAdmin}
                                >
                                    <SelectTrigger id="edit-role">
                                        <SelectValue />
                                    </SelectTrigger>
                                    <SelectContent>
                                        {USER_ROLE_OPTIONS.map(option => (
                                            <SelectItem key={option.value} value={option.value}>
                                                {option.label}
                                            </SelectItem>
                                        ))}
                                    </SelectContent>
                                </Select>
                                {!isAdmin && <p className="text-xs text-gray-500 mt-1">–¢–æ–ª—å–∫–æ –∞–¥–º–∏–Ω –º–æ–∂–µ—Ç –º–µ–Ω—è—Ç—å —Ä–æ–ª—å.</p>}
                            </div>
                            <div>
                                <Label htmlFor="edit-status">–°—Ç–∞—Ç—É—Å</Label>
                                <Controller
                                    name="status"
                                    control={control}
                                    render={({ field }) => (
                                        <Select onValueChange={field.onChange} value={field.value}>
                                            <SelectTrigger id="edit-status">
                                                <SelectValue />
                                            </SelectTrigger>
                                            <SelectContent>
                                                {statusOptions.map(option => (
                                                    <SelectItem key={option.value} value={option.value}>
                                                        {option.label}
                                                    </SelectItem>
                                                ))}
                                            </SelectContent>
                                        </Select>
                                    )}
                                />
                            </div>
                        </div>

                        <div>
                            <Label htmlFor="edit-balance">–ë–∞–ª–∞–Ω—Å</Label>
                            <Input id="edit-balance" type="number" step="0.01" {...register("balance")} placeholder="0.00" />
                            {errors.balance && <p className="text-xs text-red-600 mt-1">{errors.balance.message}</p>}
                        </div>

                        <div>
                            <Label htmlFor="edit-notes">–ó–∞–º–µ—Ç–∫–∏ (–≤–∏–¥–Ω—ã —Ç–æ–ª—å–∫–æ –ø–µ—Ä—Å–æ–Ω–∞–ª—É)</Label>
                            <Textarea id="edit-notes" {...register("notes")} placeholder="–í–Ω—É—Ç—Ä–µ–Ω–Ω—è—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –∫–ª–∏–µ–Ω—Ç–µ..." />
                        </div>

                        <DialogFooter className="pt-4">
                            <Button type="button" variant="ghost" onClick={onClose}>–û—Ç–º–µ–Ω–∞</Button>
                            <Button type="submit" disabled={!isDirty || !isValid || updateMutation.isPending}>
                                {updateMutation.isPending ? "–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ..." : "–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è"}
                            </Button>
                        </DialogFooter>
                    </form>
                </DialogContent>
            </Dialog>

            <ConfirmationDialog
                open={showRoleConfirmation}
                onOpenChange={setShowRoleConfirmation}
                title="–ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è —Ä–æ–ª–∏"
                description={`–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ –∏–∑–º–µ–Ω–∏—Ç—å —Ä–æ–ª—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è "${user?.full_name}" —Å "${USER_ROLE_LABELS[user?.role as keyof typeof USER_ROLE_LABELS] || user?.role}" –Ω–∞ "${pendingRoleChange ? USER_ROLE_LABELS[pendingRoleChange as keyof typeof USER_ROLE_LABELS] || pendingRoleChange : ''}"?`}
                confirmText="–ò–∑–º–µ–Ω–∏—Ç—å —Ä–æ–ª—å"
                cancelText="–û—Ç–º–µ–Ω–∞"
                onConfirm={confirmRoleChange}
                variant="destructive"
            />
        </>
    );
}

```


## <a name="srccomponentsadminUserPaymentDialogtsx"></a>`src/components/admin/UserPaymentDialog.tsx`

```tsx
// path: src/components/admin/UserPaymentDialog.tsx

// src/components/admin/UserPaymentDialog.tsx

import { useForm, Controller } from "react-hook-form";
import { zodResolver } from "@hookform/resolvers/zod";
import { userPaymentSchema, type UserPaymentSchema } from "@/lib/validationSchemas";
import { useAddUserPayment } from "@/hooks/useAdminUsers";
import type { UserOut } from "@/types/user";

import { Button } from "@/components/ui/button";
import { Input } from "@/components/ui/input";
import { Label } from "@/components/ui/label";
import { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from "@/components/ui/select";
import { Textarea } from "@/components/ui/textarea";
import {
    Dialog,
    DialogContent,
    DialogHeader,
    DialogTitle,
    DialogFooter,
    DialogDescription,
} from "@/components/ui/dialog";

const PAYMENT_METHODS = ["–ù–∞–ª–∏—á–Ω—ã–µ", "–ö–∞—Ä—Ç–∞", "–ü–µ—Ä–µ–≤–æ–¥"];

interface Props {
    user: UserOut | null;
    open: boolean;
    onClose: () => void;
}

export function UserPaymentDialog({ user, open, onClose }: Props) {
    const paymentMutation = useAddUserPayment();
    const { register, handleSubmit, formState: { errors, isValid }, reset, control } = useForm<UserPaymentSchema>({
        resolver: zodResolver(userPaymentSchema),
        mode: "onChange",
    });

    const onSubmit = (data: UserPaymentSchema) => {
        if (!user) return;

        paymentMutation.mutate({ userId: user.id, data }, {
            onSuccess: () => {
                reset();
                onClose();
            },
        });
    };

    const handleDialogClose = () => {
        if (paymentMutation.isPending) return;
        reset();
        onClose();
    };

    if (!user) return null;

    // –ò–ó–ú–ï–ù–ï–ù–ò–ï: –î–æ–±–∞–≤–ª—è–µ–º ?? 0 –¥–ª—è –±–µ–∑–æ–ø–∞—Å–Ω–æ–≥–æ –¥–æ—Å—Ç—É–ø–∞ –∫ –±–∞–ª–∞–Ω—Å—É
    const currentBalance = user.balance ?? 0;

    return (
        <Dialog open={open} onOpenChange={handleDialogClose}>
            <DialogContent>
                <DialogHeader>
                    <DialogTitle>–ü–æ–ø–æ–ª–Ω–µ–Ω–∏–µ –±–∞–ª–∞–Ω—Å–∞</DialogTitle>
                    <DialogDescription>
                        –í—ã –ø–æ–ø–æ–ª–Ω—è–µ—Ç–µ –±–∞–ª–∞–Ω—Å –¥–ª—è <strong>{user.full_name}</strong>.
                        –¢–µ–∫—É—â–∏–π –±–∞–ª–∞–Ω—Å:
                        <span className={`font-bold ${currentBalance < 0 ? 'text-red-600' : 'text-green-700'}`}>
                            {' '}{currentBalance.toLocaleString('ru-RU')} ‚ÇΩ
                        </span>
                    </DialogDescription>
                </DialogHeader>
                <form onSubmit={handleSubmit(onSubmit)} className="space-y-4 py-2">
                    <div className="grid grid-cols-2 gap-4">
                        <div>
                            <Label htmlFor="payment-amount">–°—É–º–º–∞ (‚ÇΩ) *</Label>
                            <Input id="payment-amount" type="number" step="0.01" {...register("amount")} placeholder="1000" />
                            {errors.amount && <p className="text-xs text-red-600 mt-1">{errors.amount.message}</p>}
                        </div>
                        <div>
                            <Label htmlFor="payment-method">–ú–µ—Ç–æ–¥ –æ–ø–ª–∞—Ç—ã *</Label>
                            <Controller
                                name="payment_method"
                                control={control}
                                render={({ field }) => (
                                    <Select onValueChange={field.onChange} defaultValue={field.value}>
                                        <SelectTrigger id="payment-method">
                                            <SelectValue placeholder="–í—ã–±–µ—Ä–∏—Ç–µ –º–µ—Ç–æ–¥" />
                                        </SelectTrigger>
                                        <SelectContent>
                                            {PAYMENT_METHODS.map(method => (
                                                <SelectItem key={method} value={method}>{method}</SelectItem>
                                            ))}
                                        </SelectContent>
                                    </Select>
                                )}
                            />
                            {errors.payment_method && <p className="text-xs text-red-600 mt-1">{errors.payment_method.message}</p>}
                        </div>
                    </div>
                    <div>
                        <Label htmlFor="payment-description">–û–ø–∏—Å–∞–Ω–∏–µ (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)</Label>
                        <Textarea id="payment-description" {...register("description")} placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä, –æ–ø–ª–∞—Ç–∞ –∑–∞–ª–æ–≥–∞ –∑–∞ –∞—Ä–µ–Ω–¥—É #123" />
                    </div>
                    <DialogFooter className="pt-4">
                        <Button type="button" variant="ghost" onClick={handleDialogClose} disabled={paymentMutation.isPending}>
                            –û—Ç–º–µ–Ω–∞
                        </Button>
                        <Button type="submit" disabled={!isValid || paymentMutation.isPending}>
                            {paymentMutation.isPending ? "–ü–æ–ø–æ–ª–Ω–µ–Ω–∏–µ..." : "–ü–æ–ø–æ–ª–Ω–∏—Ç—å –±–∞–ª–∞–Ω—Å"}
                        </Button>
                    </DialogFooter>
                </form>
            </DialogContent>
        </Dialog>
    );
}

```


## <a name="srccomponentsadminUserTabletsx"></a>`src/components/admin/UserTable.tsx`

```tsx
// path: src/components/admin/UserTable.tsx

// src/components/admin/UserTable.tsx

import { useState } from "react";
import { Table, TableBody, TableCell, TableHead, TableHeader, TableRow } from "@/components/ui/table";
import { Button } from "@/components/ui/button";
import { UserSearch, Loader2 } from "lucide-react";
import { UserCreateDialog } from "./UserCreateDialog";
import { useUserTableLogic } from "@/hooks/admin/useUserTableLogic";
import { UserTableToolbar } from "./UserTableToolbar";
import { UserTableRow } from "./UserTableRow";
import { UserEditDialog } from "./UserEditDialog";
import { UserPaymentDialog } from "./UserPaymentDialog";
import type { UserOut } from "@/types/user";

interface UserTableProps {
    users: UserOut[];
    isLoading: boolean;
    error: unknown;
    onLoadMore: () => void;
    hasNextPage: boolean;
    isFetchingNextPage: boolean;
}

export default function UserTable({
    users,
    isLoading,
    error,
    onLoadMore,
    hasNextPage,
    isFetchingNextPage,
}: UserTableProps) {
    const [isCreateDialogOpen, setCreateDialogOpen] = useState(false);
    const [isEditDialogOpen, setEditDialogOpen] = useState(false);
    const [selectedUser, setSelectedUser] = useState<UserOut | null>(null);
    const [paymentUser, setPaymentUser] = useState<UserOut | null>(null);

    const {
        currentUser,
        filteredUsers,
        isAdmin,
        searchQuery,
        setSearchQuery,
        confirmDelete,
        mutations,
        handlers,
    } = useUserTableLogic(users);

    const handleEdit = (user: UserOut) => {
        setSelectedUser(user);
        setEditDialogOpen(true);
    };

    const handleAddPayment = (user: UserOut) => {
        setPaymentUser(user);
    };

    if (isLoading) {
        return <div className="text-center py-8">–ó–∞–≥—Ä—É–∑–∫–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π...</div>;
    }

    if (error) {
        return <div className="text-center py-8 text-red-600">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π</div>;
    }

    return (
        <>
            <div className="space-y-4">
                <UserTableToolbar
                    searchQuery={searchQuery}
                    onSearchChange={setSearchQuery}
                    onAddUser={() => setCreateDialogOpen(true)}
                    filteredUserCount={filteredUsers.length}
                    isAdmin={isAdmin}
                />

                <div className="rounded-md border">
                    <Table>
                        <TableHeader>
                            <TableRow>
                                <TableHead>–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å</TableHead>
                                <TableHead>Email</TableHead>
                                <TableHead>–†–æ–ª—å</TableHead>
                                <TableHead>–°—Ç–∞—Ç—É—Å</TableHead>
                                <TableHead>–î–∞—Ç–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏</TableHead>
                                {isAdmin && <TableHead className="text-right">–î–µ–π—Å—Ç–≤–∏—è</TableHead>}
                            </TableRow>
                        </TableHeader>
                        <TableBody>
                            {filteredUsers.length > 0 ? (
                                filteredUsers.map((user) => (
                                    <UserTableRow
                                        key={user.id}
                                        user={user}
                                        currentUser={currentUser}
                                        isAdmin={isAdmin}
                                        confirmDeleteId={confirmDelete}
                                        handlers={handlers}
                                        mutations={mutations}
                                        onEdit={handleEdit}
                                        onAddPayment={handleAddPayment}
                                    />
                                ))
                            ) : (
                                <TableRow>
                                    <TableCell colSpan={isAdmin ? 6 : 5} className="h-24 text-center">
                                        <div className="flex flex-col items-center justify-center text-center p-4">
                                            <UserSearch className="w-16 h-16 text-gray-300 mb-3" />
                                            <h3 className="text-lg font-semibold text-gray-700">–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã</h3>
                                            <p className="text-sm text-gray-500 max-w-sm">
                                                {searchQuery
                                                    ? "–ü–æ–ø—Ä–æ–±—É–π—Ç–µ –∏–∑–º–µ–Ω–∏—Ç—å –ø–æ–∏—Å–∫–æ–≤—ã–π –∑–∞–ø—Ä–æ—Å."
                                                    : "–í —Å–∏—Å—Ç–µ–º–µ –ø–æ–∫–∞ –Ω–µ—Ç –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π."}
                                            </p>
                                        </div>
                                    </TableCell>
                                </TableRow>
                            )}
                        </TableBody>
                    </Table>
                </div>

                {/* –ö–Ω–æ–ø–∫–∞ Load More */}
                {hasNextPage && (
                    <div className="flex justify-center mt-6">
                        <Button
                            onClick={onLoadMore}
                            disabled={isFetchingNextPage}
                            variant="outline"
                            className="min-w-[120px]"
                        >
                            {isFetchingNextPage ? (
                                <>
                                    <Loader2 className="w-4 h-4 mr-2 animate-spin" />
                                    –ó–∞–≥—Ä—É–∑–∫–∞...
                                </>
                            ) : (
                                "–ó–∞–≥—Ä—É–∑–∏—Ç—å –µ—â–µ"
                            )}
                        </Button>
                    </div>
                )}

                {!isAdmin && (
                    <div className="bg-blue-50 border border-blue-200 rounded-lg p-4 text-sm text-blue-800">
                        <strong>–†–µ–∂–∏–º –º–µ–Ω–µ–¥–∂–µ—Ä–∞:</strong> –í—ã –º–æ–∂–µ—Ç–µ –ø—Ä–æ—Å–º–∞—Ç—Ä–∏–≤–∞—Ç—å —Å–ø–∏—Å–æ–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π, –Ω–æ –Ω–µ –º–æ–∂–µ—Ç–µ –∏—Ö –∏–∑–º–µ–Ω—è—Ç—å, –±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å –∏–ª–∏ —É–¥–∞–ª—è—Ç—å.
                    </div>
                )}
            </div>

            <UserCreateDialog open={isCreateDialogOpen} onClose={() => setCreateDialogOpen(false)} />

            <UserEditDialog
                user={selectedUser}
                open={isEditDialogOpen}
                onClose={() => {
                    setEditDialogOpen(false);
                    setSelectedUser(null);
                }}
            />

            <UserPaymentDialog
                user={paymentUser}
                open={!!paymentUser}
                onClose={() => setPaymentUser(null)}
            />
        </>
    );
}

```


## <a name="srccomponentsadminUserTableRowtsx"></a>`src/components/admin/UserTableRow.tsx`

```tsx
// path: src/components/admin/UserTableRow.tsx

// src/components/admin/UserTableRow.tsx

import type { UserOut } from "@/types/user";
import { TableCell, TableRow } from "@/components/ui/table";
import { Badge } from "@/components/ui/badge";
import { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from "@/components/ui/select";
import { Button } from "@/components/ui/button";
import { Shield, ShieldCheck, UserCheck, UserX, Trash2, Pencil, DollarSign } from "lucide-react";
import type { useUserTableLogic } from "@/hooks/admin/useUserTableLogic";
import { USER_ROLE_LABELS, USER_ROLE_BADGE_VARIANTS, USER_ROLE_OPTIONS } from "@/constants/userConstants";
import { formatDateEuropean } from "@/lib/utils";

type Handlers = ReturnType<typeof useUserTableLogic>['handlers'];
type Mutations = ReturnType<typeof useUserTableLogic>['mutations'];

interface Props {
    user: UserOut;
    currentUser: UserOut | null | undefined;
    isAdmin: boolean;
    confirmDeleteId: number | null;
    handlers: Handlers;
    mutations: Mutations;
    onEdit: (user: UserOut) => void;
    onAddPayment: (user: UserOut) => void;
}

export function UserTableRow({ user, currentUser, isAdmin, confirmDeleteId, handlers, mutations, onEdit, onAddPayment }: Props) {
    return (
        <TableRow key={user.id}>
            <TableCell className="font-medium">
                <div className="flex items-center gap-2">
                    {user.role === "admin" && <ShieldCheck className="w-4 h-4 text-red-500" />}
                    {user.role === "manager" && <Shield className="w-4 h-4 text-blue-500" />}
                    {user.full_name}
                    {user.id === currentUser?.id && <Badge variant="outline" className="text-xs">–≠—Ç–æ –≤—ã</Badge>}
                </div>
            </TableCell>
            <TableCell>{user.email}</TableCell>
            <TableCell>
                {isAdmin && user.id !== currentUser?.id ? (
                    <Select value={user.role} onValueChange={(value) => handlers.handleRoleChange(user.id, value)}>
                        <SelectTrigger className="w-32"><SelectValue /></SelectTrigger>
                        <SelectContent>
                            {USER_ROLE_OPTIONS.map(option => (
                                <SelectItem key={option.value} value={option.value}>
                                    {option.label}
                                </SelectItem>
                            ))}
                        </SelectContent>
                    </Select>
                ) : (
                    <Badge variant={USER_ROLE_BADGE_VARIANTS[user.role]}>
                        {USER_ROLE_LABELS[user.role]}
                    </Badge>
                )}
            </TableCell>
            <TableCell>
                <Badge variant={user.is_active ? "default" : "secondary"}>{user.is_active ? "–ê–∫—Ç–∏–≤–µ–Ω" : "–ó–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω"}</Badge>
            </TableCell>
            <TableCell className="text-sm text-gray-600">
                {formatDateEuropean(user.created_at)}
            </TableCell>
            {isAdmin && (
                <TableCell className="text-right">
                    <div className="flex items-center justify-end gap-2">
                        {user.id !== currentUser?.id ? (
                            <>
                                <Button variant="outline" size="icon" onClick={() => onAddPayment(user)} className="h-8 w-8 text-green-600 border-green-300 hover:bg-green-50 hover:text-green-700">
                                    <DollarSign className="w-4 h-4" />
                                </Button>
                                <Button variant="outline" size="icon" onClick={() => onEdit(user)} className="h-8 w-8">
                                    <Pencil className="w-4 h-4" />
                                </Button>
                                <Button variant="outline" size="sm" onClick={() => handlers.handleToggleBlock(user)} disabled={mutations.blockUser.isPending || mutations.unblockUser.isPending}>
                                    {user.is_active ? <UserX className="w-4 h-4" /> : <UserCheck className="w-4 h-4" />}
                                </Button>
                                <Button variant={confirmDeleteId === user.id ? "destructive" : "outline"} size="sm" onClick={() => handlers.handleDelete(user.id)} disabled={mutations.deleteUser.isPending}>
                                    <Trash2 className="w-4 h-4" />
                                    {confirmDeleteId === user.id && <span className="ml-1 text-xs">–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å</span>}
                                </Button>
                            </>
                        ) : (
                            <Button variant="outline" size="icon" onClick={() => onAddPayment(user)} className="h-8 w-8 text-green-600 border-green-300 hover:bg-green-50 hover:text-green-700">
                                <DollarSign className="w-4 h-4" />
                            </Button>
                        )}
                    </div>
                </TableCell>
            )}
        </TableRow>
    );
}

```


## <a name="srccomponentsadminUserTableToolbartsx"></a>`src/components/admin/UserTableToolbar.tsx`

```tsx
// path: src/components/admin/UserTableToolbar.tsx

// src/components/admin/UserTableToolbar.tsx
import { Input } from "@/components/ui/input";
import { Button } from "@/components/ui/button";
import { Search, Plus } from "lucide-react";

interface Props {
    searchQuery: string;
    onSearchChange: (query: string) => void;
    onAddUser: () => void;
    filteredUserCount: number;
    isAdmin: boolean;
}

export function UserTableToolbar({
                                     searchQuery,
                                     onSearchChange,
                                     onAddUser,
                                     filteredUserCount,
                                     isAdmin
                                 }: Props) {
    return (
        <div className="flex flex-col sm:flex-row gap-4 items-center justify-between">
            <div className="relative flex-grow max-w-sm w-full">
                <Search className="absolute left-3 top-1/2 -translate-y-1/2 text-gray-400 w-4 h-4" />
                <Input
                    placeholder="–ü–æ–∏—Å–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π..."
                    value={searchQuery}
                    onChange={(e) => onSearchChange(e.target.value)}
                    className="pl-10"
                />
            </div>
            <div className="flex items-center gap-4">
                <p className="text-sm text-gray-600">
                    –ù–∞–π–¥–µ–Ω–æ: {filteredUserCount}
                </p>
                {isAdmin && (
                    <Button size="sm" onClick={onAddUser}>
                        <Plus className="w-4 h-4 mr-2" />
                        –î–æ–±–∞–≤–∏—Ç—å
                    </Button>
                )}
            </div>
        </div>
    );
}

```


## <a name="srccomponentsadmindashboardActivityFeedWidgettsx"></a>`src/components/admin/dashboard/ActivityFeedWidget.tsx`

```tsx
// path: src/components/admin/dashboard/ActivityFeedWidget.tsx

// src/components/admin/dashboard/ActivityFeedWidget.tsx

import { Card, CardContent, CardHeader, CardTitle } from "@/components/ui/card";
import { Skeleton } from "@/components/ui/skeleton";
import { Badge } from "@/components/ui/badge";
import { 
    Activity,
    Plus,
    X,
    Play,
    CheckCircle,
    UserPlus,
    Package,
    Calendar
} from "lucide-react";
import { formatDistanceToNow } from "date-fns";
import { ru } from "date-fns/locale";
import type { ActivityFeedItem } from "@/hooks/admin/useDashboardData";

interface ActivityFeedWidgetProps {
    data: ActivityFeedItem[];
    isLoading: boolean;
}

export default function ActivityFeedWidget({ data, isLoading }: ActivityFeedWidgetProps) {
    const getActivityIcon = (type: ActivityFeedItem['type']) => {
        switch (type) {
            case 'reservation_created':
                return <Calendar className="w-4 h-4 text-blue-600" />;
            case 'reservation_cancelled':
                return <X className="w-4 h-4 text-red-600" />;
            case 'rental_started':
                return <Play className="w-4 h-4 text-green-600" />;
            case 'rental_completed':
                return <CheckCircle className="w-4 h-4 text-green-600" />;
            case 'user_registered':
                return <UserPlus className="w-4 h-4 text-purple-600" />;
            case 'equipment_added':
                return <Package className="w-4 h-4 text-orange-600" />;
            default:
                return <Activity className="w-4 h-4 text-gray-600" />;
        }
    };

    const getActivityColor = (type: ActivityFeedItem['type']) => {
        switch (type) {
            case 'reservation_created':
                return 'bg-blue-50 border-blue-200';
            case 'reservation_cancelled':
                return 'bg-red-50 border-red-200';
            case 'rental_started':
                return 'bg-green-50 border-green-200';
            case 'rental_completed':
                return 'bg-green-50 border-green-200';
            case 'user_registered':
                return 'bg-purple-50 border-purple-200';
            case 'equipment_added':
                return 'bg-orange-50 border-orange-200';
            default:
                return 'bg-gray-50 border-gray-200';
        }
    };

    const getActivityBadgeVariant = (type: ActivityFeedItem['type']) => {
        switch (type) {
            case 'reservation_created':
                return 'default' as const;
            case 'reservation_cancelled':
                return 'destructive' as const;
            case 'rental_started':
                return 'secondary' as const;
            case 'rental_completed':
                return 'secondary' as const;
            case 'user_registered':
                return 'outline' as const;
            case 'equipment_added':
                return 'outline' as const;
            default:
                return 'outline' as const;
        }
    };

    const getActivityTypeLabel = (type: ActivityFeedItem['type']) => {
        switch (type) {
            case 'reservation_created':
                return '–†–µ–∑–µ—Ä–≤ —Å–æ–∑–¥–∞–Ω';
            case 'reservation_cancelled':
                return '–†–µ–∑–µ—Ä–≤ –æ—Ç–º–µ–Ω–µ–Ω';
            case 'rental_started':
                return '–ê—Ä–µ–Ω–¥–∞ –Ω–∞—á–∞—Ç–∞';
            case 'rental_completed':
                return '–ê—Ä–µ–Ω–¥–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞';
            case 'user_registered':
                return '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω';
            case 'equipment_added':
                return '–û–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏–µ –¥–æ–±–∞–≤–ª–µ–Ω–æ';
            default:
                return '–°–æ–±—ã—Ç–∏–µ';
        }
    };

    if (isLoading) {
        return (
            <Card>
                <CardHeader>
                    <CardTitle className="flex items-center gap-2">
                        <Activity className="w-5 h-5" />
                        –õ–µ–Ω—Ç–∞ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏
                    </CardTitle>
                </CardHeader>
                <CardContent className="space-y-4">
                    {Array.from({ length: 5 }).map((_, index) => (
                        <div key={index} className="flex items-start gap-3 p-3 border rounded-lg">
                            <Skeleton className="w-8 h-8 rounded-full" />
                            <div className="flex-1 space-y-2">
                                <Skeleton className="h-4 w-3/4" />
                                <Skeleton className="h-3 w-1/2" />
                            </div>
                            <Skeleton className="h-6 w-16" />
                        </div>
                    ))}
                </CardContent>
            </Card>
        );
    }

    return (
        <Card>
            <CardHeader>
                <CardTitle className="flex items-center gap-2">
                    <Activity className="w-5 h-5" />
                    –õ–µ–Ω—Ç–∞ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏
                </CardTitle>
            </CardHeader>
            <CardContent>
                <div className="space-y-3">
                    {data.length > 0 ? (
                        data.map((activity) => (
                            <div 
                                key={activity.id}
                                className={`flex items-start gap-3 p-3 border rounded-lg ${getActivityColor(activity.type)}`}
                            >
                                <div className="flex-shrink-0 mt-0.5">
                                    {getActivityIcon(activity.type)}
                                </div>
                                <div className="flex-1 min-w-0">
                                    <p className="text-sm font-medium text-gray-900 mb-1">
                                        {activity.description}
                                    </p>
                                    <div className="flex items-center gap-2 text-xs text-gray-500">
                                        <span>
                                            {formatDistanceToNow(new Date(activity.timestamp), { 
                                                addSuffix: true, 
                                                locale: ru 
                                            })}
                                        </span>
                                        {activity.user_name && (
                                            <>
                                                <span>‚Ä¢</span>
                                                <span>{activity.user_name}</span>
                                            </>
                                        )}
                                        {activity.equipment_name && (
                                            <>
                                                <span>‚Ä¢</span>
                                                <span>{activity.equipment_name}</span>
                                            </>
                                        )}
                                    </div>
                                </div>
                                <div className="flex-shrink-0">
                                    <Badge 
                                        variant={getActivityBadgeVariant(activity.type)}
                                        className="text-xs"
                                    >
                                        {getActivityTypeLabel(activity.type)}
                                    </Badge>
                                </div>
                            </div>
                        ))
                    ) : (
                        <div className="text-center py-8 text-sm text-gray-500">
                            <Activity className="w-8 h-8 mx-auto mb-2 text-gray-400" />
                            <p>–ù–µ—Ç –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏</p>
                            <p className="text-xs">–°–æ–±—ã—Ç–∏—è –ø–æ—è–≤—è—Ç—Å—è –∑–¥–µ—Å—å –ø–æ –º–µ—Ä–µ –∏—Ö –≤–æ–∑–Ω–∏–∫–Ω–æ–≤–µ–Ω–∏—è</p>
                        </div>
                    )}
                </div>
            </CardContent>
        </Card>
    );
}


```


## <a name="srccomponentsadmindashboardKpiCardsWidgettsx"></a>`src/components/admin/dashboard/KpiCardsWidget.tsx`

```tsx
// path: src/components/admin/dashboard/KpiCardsWidget.tsx

// src/components/admin/dashboard/KpiCardsWidget.tsx

import { Card, CardContent, CardHeader, CardTitle } from "@/components/ui/card";
import { Skeleton } from "@/components/ui/skeleton";
import { 
    Users, 
    UserCheck, 
    Package, 
    Calendar,
    DollarSign,
    TrendingUp,
    BarChart3,
    Clock
} from "lucide-react";
import type { DashboardSummary } from "@/hooks/admin/useDashboardData";

interface KpiCardsWidgetProps {
    data: DashboardSummary['kpi'];
    isLoading: boolean;
}

export default function KpiCardsWidget({ data, isLoading }: KpiCardsWidgetProps) {
    if (isLoading) {
        return (
            <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                {Array.from({ length: 8 }).map((_, index) => (
                    <Card key={index}>
                        <CardHeader className="flex flex-row items-center justify-between space-y-0 pb-2">
                            <Skeleton className="h-4 w-20" />
                            <Skeleton className="h-4 w-4" />
                        </CardHeader>
                        <CardContent>
                            <Skeleton className="h-8 w-16 mb-1" />
                            <Skeleton className="h-3 w-24" />
                        </CardContent>
                    </Card>
                ))}
            </div>
        );
    }

    const kpiCards = [
        {
            title: "–í—Å–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π",
            value: data.total_users.toLocaleString(),
            description: `${data.active_users} –∞–∫—Ç–∏–≤–Ω—ã—Ö`,
            icon: <Users className="h-4 w-4 text-muted-foreground" />,
            trend: data.active_users > 0 ? "positive" : "neutral"
        },
        {
            title: "–ê–∫—Ç–∏–≤–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏",
            value: data.active_users.toLocaleString(),
            description: `${Math.round((data.active_users / data.total_users) * 100)}% –æ—Ç –æ–±—â–µ–≥–æ —á–∏—Å–ª–∞`,
            icon: <UserCheck className="h-4 w-4 text-muted-foreground" />,
            trend: "positive"
        },
        {
            title: "–í—Å–µ–≥–æ –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—è",
            value: data.total_equipment.toLocaleString(),
            description: "–ï–¥–∏–Ω–∏—Ü –≤ –∫–∞—Ç–∞–ª–æ–≥–µ",
            icon: <Package className="h-4 w-4 text-muted-foreground" />,
            trend: "neutral"
        },
        {
            title: "–í—Å–µ–≥–æ —Ä–µ–∑–µ—Ä–≤–æ–≤",
            value: data.total_reservations.toLocaleString(),
            description: "–ó–∞ –≤—Å–µ –≤—Ä–µ–º—è",
            icon: <Calendar className="h-4 w-4 text-muted-foreground" />,
            trend: "positive"
        },
        {
            title: "–í—ã—Ä—É—á–∫–∞ —Å–µ–≥–æ–¥–Ω—è",
            value: `${data.revenue_today.toLocaleString()} ‚ÇΩ`,
            description: "–ó–∞ —Ç–µ–∫—É—â–∏–π –¥–µ–Ω—å",
            icon: <DollarSign className="h-4 w-4 text-muted-foreground" />,
            trend: data.revenue_today > 0 ? "positive" : "neutral"
        },
        {
            title: "–í—ã—Ä—É—á–∫–∞ –∑–∞ –º–µ—Å—è—Ü",
            value: `${data.revenue_this_month.toLocaleString()} ‚ÇΩ`,
            description: "–ó–∞ —Ç–µ–∫—É—â–∏–π –º–µ—Å—è—Ü",
            icon: <TrendingUp className="h-4 w-4 text-muted-foreground" />,
            trend: "positive"
        },
        {
            title: "–ó–∞–≥—Ä—É–∂–µ–Ω–Ω–æ—Å—Ç—å",
            value: `${data.occupancy_rate.toFixed(1)}%`,
            description: "–°—Ä–µ–¥–Ω—è—è –∑–∞–≥—Ä—É–∂–µ–Ω–Ω–æ—Å—Ç—å",
            icon: <BarChart3 className="h-4 w-4 text-muted-foreground" />,
            trend: data.occupancy_rate > 70 ? "positive" : data.occupancy_rate > 40 ? "neutral" : "negative"
        },
        {
            title: "–°—Ä–µ–¥–Ω—è—è –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å",
            value: `${data.avg_rental_duration.toFixed(1)} –¥–Ω.`,
            description: "–ê—Ä–µ–Ω–¥—ã",
            icon: <Clock className="h-4 w-4 text-muted-foreground" />,
            trend: "neutral"
        }
    ];

    const getTrendColor = (trend: string) => {
        switch (trend) {
            case "positive":
                return "text-green-600";
            case "negative":
                return "text-red-600";
            default:
                return "text-gray-600";
        }
    };

    return (
        <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
            {kpiCards.map((card, index) => (
                <Card key={index} className="hover:shadow-md transition-shadow">
                    <CardHeader className="flex flex-row items-center justify-between space-y-0 pb-2">
                        <CardTitle className="text-sm font-medium">{card.title}</CardTitle>
                        {card.icon}
                    </CardHeader>
                    <CardContent>
                        <div className={`text-2xl font-bold ${getTrendColor(card.trend)}`}>
                            {card.value}
                        </div>
                        <p className="text-xs text-muted-foreground">
                            {card.description}
                        </p>
                    </CardContent>
                </Card>
            ))}
        </div>
    );
}


```


## <a name="srccomponentsadmindashboardPopularEquipmentCharttsx"></a>`src/components/admin/dashboard/PopularEquipmentChart.tsx`

```tsx
// path: src/components/admin/dashboard/PopularEquipmentChart.tsx

// src/components/admin/dashboard/PopularEquipmentChart.tsx

import { Card, CardContent, CardHeader, CardTitle } from "@/components/ui/card";
import { Skeleton } from "@/components/ui/skeleton";
import { Badge } from "@/components/ui/badge";
import { BarChart3, TrendingUp, Package } from "lucide-react";
import type { PopularEquipmentItem } from "@/hooks/admin/useDashboardData";
import { formatNumber } from "@/lib/utils";

interface PopularEquipmentChartProps {
    data: PopularEquipmentItem[];
    isLoading: boolean;
}

export default function PopularEquipmentChart({ data, isLoading }: PopularEquipmentChartProps) {
    if (isLoading) {
        return (
            <Card>
                <CardHeader>
                    <CardTitle className="flex items-center gap-2">
                        <BarChart3 className="w-5 h-5" />
                        –ü–æ–ø—É–ª—è—Ä–Ω–æ–µ –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏–µ
                    </CardTitle>
                </CardHeader>
                <CardContent className="space-y-4">
                    {Array.from({ length: 5 }).map((_, index) => (
                        <div key={index} className="space-y-2">
                            <div className="flex justify-between items-center">
                                <Skeleton className="h-4 w-32" />
                                <Skeleton className="h-4 w-16" />
                            </div>
                            <Skeleton className="h-6 w-full" />
                        </div>
                    ))}
                </CardContent>
            </Card>
        );
    }

    if (data.length === 0) {
        return (
            <Card>
                <CardHeader>
                    <CardTitle className="flex items-center gap-2">
                        <BarChart3 className="w-5 h-5" />
                        –ü–æ–ø—É–ª—è—Ä–Ω–æ–µ –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏–µ
                    </CardTitle>
                </CardHeader>
                <CardContent>
                    <div className="text-center py-8 text-sm text-gray-500">
                        <BarChart3 className="w-8 h-8 mx-auto mb-2 text-gray-400" />
                        <p>–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –ø–æ—Å—Ç—Ä–æ–µ–Ω–∏—è –≥—Ä–∞—Ñ–∏–∫–∞</p>
                        <p className="text-xs">–î–∞–Ω–Ω—ã–µ –ø–æ—è–≤—è—Ç—Å—è –ø–æ—Å–ª–µ –ø–µ—Ä–≤—ã—Ö –∞—Ä–µ–Ω–¥</p>
                    </div>
                </CardContent>
            </Card>
        );
    }

    // –°–æ—Ä—Ç–∏—Ä—É–µ–º –¥–∞–Ω–Ω—ã–µ –ø–æ –∫–æ–ª–∏—á–µ—Å—Ç–≤—É –∞—Ä–µ–Ω–¥ (–ø–æ —É–±—ã–≤–∞–Ω–∏—é)
    const sortedData = [...data].sort((a, b) => (b.rental_count || 0) - (a.rental_count || 0));
    
    // –ë–µ—Ä–µ–º —Ç–æ–ø-10 –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è
    const topData = sortedData.slice(0, 10);
    
    // –î–æ–±–∞–≤–ª—è–µ–º fallback ID –¥–ª—è —ç–ª–µ–º–µ–Ω—Ç–æ–≤ –±–µ–∑ equipment_id
    const dataWithIds = topData.map((item, index) => ({
        ...item,
        equipment_id: item.equipment_id || `fallback-${index}`
    }));
    
    
    // –ù–∞—Ö–æ–¥–∏–º –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ –¥–ª—è –Ω–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏–∏
    const maxRentals = topData.length > 0 ? Math.max(...topData.map(item => item.rental_count || 0)) : 0;


    const totalRentals = data.reduce((sum, item) => sum + (item.rental_count || 0), 0);
    const totalRevenue = data.reduce((sum, item) => sum + (item.revenue || 0), 0);

    return (
        <Card>
            <CardHeader>
                <CardTitle className="flex items-center gap-2">
                    <BarChart3 className="w-5 h-5" />
                    –ü–æ–ø—É–ª—è—Ä–Ω–æ–µ –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏–µ
                </CardTitle>
            </CardHeader>
            <CardContent className="space-y-6">
                {/* –°–≤–æ–¥–Ω–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ */}
                <div className="grid grid-cols-2 gap-4 p-4 bg-gray-50 rounded-lg">
                    <div className="text-center">
                        <div className="flex items-center justify-center gap-1 mb-1">
                            <Package className="w-4 h-4 text-blue-600" />
                            <span className="text-sm font-medium text-gray-600">–í—Å–µ–≥–æ –∞—Ä–µ–Ω–¥</span>
                        </div>
                        <div className="text-2xl font-bold text-gray-900">
                            {formatNumber(totalRentals, "0")}
                        </div>
                    </div>
                    <div className="text-center">
                        <div className="flex items-center justify-center gap-1 mb-1">
                            <TrendingUp className="w-4 h-4 text-green-600" />
                            <span className="text-sm font-medium text-gray-600">–í—ã—Ä—É—á–∫–∞</span>
                        </div>
                        <div className="text-2xl font-bold text-gray-900">
                            {formatNumber(totalRevenue, "0")} ‚ÇΩ
                        </div>
                    </div>
                </div>

                {/* –ì—Ä–∞—Ñ–∏–∫ */}
                <div className="space-y-4">
                    {dataWithIds.map((item, index) => (
                        <div key={item.equipment_id} className="space-y-2">
                            <div className="flex justify-between items-center">
                                <div className="flex items-center gap-2">
                                    <span className="text-sm font-medium text-gray-900 truncate max-w-[200px]">
                                        {item.equipment_name}
                                    </span>
                                    {index < 3 && (
                                        <Badge 
                                            variant={index === 0 ? "default" : "secondary"}
                                            className="text-xs"
                                        >
                                            #{index + 1}
                                        </Badge>
                                    )}
                                </div>
                                <div className="text-right">
                                    <div className="text-sm font-semibold text-gray-900">
                                        {formatNumber(item.rental_count, "0")}
                                    </div>
                                    <div className="text-xs text-gray-500">
                                        {formatNumber(item.revenue, "0")} ‚ÇΩ
                                    </div>
                                </div>
                            </div>
                            <div className="relative">
                                <div className="w-full bg-gray-200 rounded-full h-6 overflow-hidden">
                                    <div 
                                        className={`h-full transition-all duration-500 ease-out ${
                                            index === 0 
                                                ? 'bg-gradient-to-r from-blue-500 to-blue-600' 
                                                : index === 1 
                                                ? 'bg-gradient-to-r from-green-500 to-green-600'
                                                : index === 2
                                                ? 'bg-gradient-to-r from-yellow-500 to-yellow-600'
                                                : 'bg-gradient-to-r from-gray-400 to-gray-500'
                                        }`}
                                        style={{ width: `${maxRentals > 0 ? ((item.rental_count || 0) / maxRentals) * 100 : 0}%` }}
                                    />
                                </div>
                                <div className="absolute inset-0 flex items-center justify-center">
                                    <span className="text-xs font-medium text-white mix-blend-difference">
                                        {maxRentals > 0 ? (((item.rental_count || 0) / maxRentals) * 100).toFixed(1) : 0}%
                                    </span>
                                </div>
                            </div>
                        </div>
                    ))}
                </div>

                {/* –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è */}
                {data.length > 10 && (
                    <div className="text-center text-sm text-gray-500 pt-2 border-t">
                        –ü–æ–∫–∞–∑–∞–Ω—ã —Ç–æ–ø-10 –∏–∑ {data.length} –ø–æ–∑–∏—Ü–∏–π
                    </div>
                )}
            </CardContent>
        </Card>
    );
}


```


## <a name="srccomponentsadmindashboardTodayFocusWidgettsx"></a>`src/components/admin/dashboard/TodayFocusWidget.tsx`

```tsx
// path: src/components/admin/dashboard/TodayFocusWidget.tsx

// src/components/admin/dashboard/TodayFocusWidget.tsx

import { useNavigate } from "react-router-dom";
import { Card, CardContent, CardHeader, CardTitle } from "@/components/ui/card";
import { Badge } from "@/components/ui/badge";
import { Skeleton } from "@/components/ui/skeleton";
import { 
    Package, 
    ArrowUpCircle, 
    ArrowDownCircle, 
    AlertTriangle,
    Clock,
    User
} from "lucide-react";
import { differenceInDays } from "date-fns";
import { calculateDaysOverdue } from "@/lib/utils";
import { sortPickupsByPriority, sortOverdueRentalsByDays, getTodayDate } from "@/lib/sortingUtils";
import type { PickupReturnItem, OverdueRentalItem } from "@/hooks/admin/useDashboardData";

interface TodayFocusWidgetProps {
    data: {
        pickups_today: PickupReturnItem[];
        returns_today: PickupReturnItem[];
        overdue_rentals: OverdueRentalItem[];
    };
    isLoading: boolean;
}

export default function TodayFocusWidget({ data, isLoading }: TodayFocusWidgetProps) {
    const navigate = useNavigate();
    
    // –ü–æ–ª—É—á–∞–µ–º —Å–µ–≥–æ–¥–Ω—è—à–Ω—é—é –¥–∞—Ç—É —Å –æ–±–Ω—É–ª–µ–Ω–Ω—ã–º –≤—Ä–µ–º–µ–Ω–µ–º –¥–ª—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–≥–æ —Å—Ä–∞–≤–Ω–µ–Ω–∏—è
    const today = getTodayDate();

    const handlePickupClick = (item: PickupReturnItem) => {
        navigate('/admin/reservations', {
            state: {
                highlightId: item.id,
                statusFilterOverride: 'active' // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∞–∫—Ç–∏–≤–Ω—ã–µ, —á—Ç–æ–±—ã –Ω–∞–π—Ç–∏ –Ω—É–∂–Ω—ã–π
            }
        });
    };

    const handleReturnClick = (item: PickupReturnItem) => {
        navigate('/admin/rentals', {
            state: {
                highlightId: item.id,
                statusFilterOverride: 'active'
            }
        });
    };

    const handleOverdueClick = (item: OverdueRentalItem) => {
        navigate('/admin/rentals', {
            state: {
                highlightId: item.id,
                statusFilterOverride: 'overdue'
            }
        });
    };

    if (isLoading) {
        return (
            <Card>
                <CardHeader>
                    <CardTitle className="flex items-center gap-2">
                        <Package className="w-5 h-5" />
                        –§–æ–∫—É—Å –Ω–∞ —Å–µ–≥–æ–¥–Ω—è
                    </CardTitle>
                </CardHeader>
                <CardContent className="space-y-4">
                    <div className="space-y-2">
                        <Skeleton className="h-4 w-24" />
                        <Skeleton className="h-16 w-full" />
                    </div>
                    <div className="space-y-2">
                        <Skeleton className="h-4 w-24" />
                        <Skeleton className="h-16 w-full" />
                    </div>
                    <div className="space-y-2">
                        <Skeleton className="h-4 w-24" />
                        <Skeleton className="h-16 w-full" />
                    </div>
                </CardContent>
            </Card>
        );
    }

    const renderPickupItem = (item: PickupReturnItem) => {
        // –û–ø—Ä–µ–¥–µ–ª—è–µ–º, —è–≤–ª—è–µ—Ç—Å—è –ª–∏ –≤—ã–¥–∞—á–∞ "–æ–∂–∏–¥–∞—é—â–µ–π"
        const itemStartDate = item.start_date ? new Date(item.start_date) : null;
        const isPendingPickup = itemStartDate && itemStartDate < today;
        const daysPassed = itemStartDate ? differenceInDays(today, itemStartDate) : 0;

        // –û–ø—Ä–µ–¥–µ–ª—è–µ–º –∫–ª–∞—Å—Å—ã –∏ —Ç–µ–∫—Å—Ç –Ω–∞ –æ—Å–Ω–æ–≤–µ —Å—Ç–∞—Ç—É—Å–∞
        const bgColor = isPendingPickup ? "bg-cyan-50 hover:bg-cyan-100" : "bg-blue-50 hover:bg-blue-100";
        const iconColor = isPendingPickup ? "text-cyan-600" : "text-blue-600";
        const badgeText = isPendingPickup ? `–ö –≤—ã–¥–∞—á–µ (-${daysPassed} –¥–Ω.)` : "–í—ã–¥–∞—á–∞ —Å–µ–≥–æ–¥–Ω—è";
        const badgeVariant = isPendingPickup ? "outline" : "secondary";

        return (
            <div 
                key={item.id}
                className={`flex items-center justify-between p-3 rounded-lg cursor-pointer ${bgColor} transition-colors`}
                onClick={() => handlePickupClick(item)}
            >
                <div className="flex-1 min-w-0">
                    <div className="flex items-center gap-2 mb-1">
                        <User className={`w-4 h-4 ${iconColor} flex-shrink-0`} />
                        <span className="font-medium text-sm truncate">{item.user_name}</span>
                    </div>
                    <div className="flex items-center gap-2 text-xs text-gray-600">
                        <Package className="w-3 h-3 flex-shrink-0" />
                        <span className="truncate">{item.equipment_name}</span>
                    </div>
                </div>
                <div className="text-right ml-2">
                    <div className="flex items-center justify-end gap-1 text-xs text-gray-500 mb-1">
                        <Clock className="w-3 h-3" />
                        <span>{item.scheduled_time ? new Date(item.scheduled_time).toLocaleDateString('ru-RU') : '–ù–µ —É–∫–∞–∑–∞–Ω–æ'}</span>
                    </div>
                    <Badge variant={badgeVariant} className="text-xs">
                        {badgeText}
                    </Badge>
                </div>
            </div>
        );
    };

    const renderReturnItem = (item: PickupReturnItem) => (
        <div 
            key={item.id}
            className="flex items-center justify-between p-3 bg-green-50 rounded-lg cursor-pointer hover:bg-green-100 transition-colors"
            onClick={() => handleReturnClick(item)}
        >
            <div className="flex-1 min-w-0">
                <div className="flex items-center gap-2 mb-1">
                    <User className="w-4 h-4 text-green-600 flex-shrink-0" />
                    <span className="font-medium text-sm truncate">{item.user_name}</span>
                </div>
                <div className="flex items-center gap-2 text-xs text-gray-600">
                    <Package className="w-3 h-3 flex-shrink-0" />
                    <span className="truncate">{item.equipment_name}</span>
                </div>
            </div>
            <div className="text-right ml-2">
                <div className="flex items-center justify-end gap-1 text-xs text-gray-500 mb-1">
                    <Clock className="w-3 h-3" />
                    <span>{item.scheduled_time ? new Date(item.scheduled_time).toLocaleDateString('ru-RU') : '–ù–µ —É–∫–∞–∑–∞–Ω–æ'}</span>
                </div>
                <Badge variant="secondary" className="text-xs">
                    {item.status}
                </Badge>
            </div>
        </div>
    );

    const renderOverdueItem = (item: OverdueRentalItem) => {
        // –ò—Å–ø–æ–ª—å–∑—É–µ–º —É—Ç–∏–ª–∏—Ç–∞—Ä–Ω—É—é —Ñ—É–Ω–∫—Ü–∏—é –¥–ª—è –≤—ã—á–∏—Å–ª–µ–Ω–∏—è –¥–Ω–µ–π –ø—Ä–æ—Å—Ä–æ—á–∫–∏
        const daysOverdue = calculateDaysOverdue(item.due_date, item.days_overdue);

        return (
            <div 
                key={item.id}
                className="flex items-center justify-between p-3 bg-red-50 rounded-lg cursor-pointer hover:bg-red-100 transition-colors"
                onClick={() => handleOverdueClick(item)}
            >
                <div className="flex-1 min-w-0">
                    <div className="flex items-center gap-2 mb-1">
                        <User className="w-4 h-4 text-red-600 flex-shrink-0" />
                        <span className="font-medium text-sm truncate">{item.user_name}</span>
                    </div>
                    <div className="flex items-center gap-2 text-xs text-gray-600">
                        <Package className="w-3 h-3 flex-shrink-0" />
                        <span className="truncate">{item.equipment_name}</span>
                    </div>
                </div>
                <div className="text-right ml-2">
                    <div className="flex items-center justify-end gap-1 text-xs text-red-600 mb-1">
                        <AlertTriangle className="w-3 h-3" />
                        <span>
                            {daysOverdue > 0 ? `${daysOverdue} –¥–Ω.` : '–ü—Ä–æ—Å—Ä–æ—á–µ–Ω–æ'}
                        </span>
                    </div>
                    <Badge variant="destructive" className="text-xs">
                        –ü—Ä–æ—Å—Ä–æ—á–µ–Ω–æ
                    </Badge>
                </div>
            </div>
        );
    };

    return (
        <Card>
            <CardHeader>
                <CardTitle className="flex items-center gap-2">
                    <Package className="w-5 h-5" />
                    –§–æ–∫—É—Å –Ω–∞ —Å–µ–≥–æ–¥–Ω—è
                </CardTitle>
            </CardHeader>
            <CardContent className="space-y-6">
                {/* –í—ã–¥–∞—á–∏ —Å–µ–≥–æ–¥–Ω—è */}
                <div>
                    <div className="flex items-center gap-2 mb-3">
                        <ArrowUpCircle className="w-4 h-4 text-blue-600" />
                        <h3 className="font-medium text-sm">–í—ã–¥–∞—á–∏ —Å–µ–≥–æ–¥–Ω—è</h3>
                        <Badge variant="outline" className="text-xs">
                            {data.pickups_today.length}
                        </Badge>
                    </div>
                    <div className="space-y-2">
                        {data.pickups_today.length > 0 ? (
                            sortPickupsByPriority(data.pickups_today, today).map(renderPickupItem)
                        ) : (
                            <div className="text-center py-4 text-sm text-gray-500">
                                –°–µ–≥–æ–¥–Ω—è –Ω–µ—Ç –≤—ã–¥–∞—á
                            </div>
                        )}
                    </div>
                </div>

                {/* –í–æ–∑–≤—Ä–∞—Ç—ã —Å–µ–≥–æ–¥–Ω—è */}
                <div>
                    <div className="flex items-center gap-2 mb-3">
                        <ArrowDownCircle className="w-4 h-4 text-green-600" />
                        <h3 className="font-medium text-sm">–í–æ–∑–≤—Ä–∞—Ç—ã —Å–µ–≥–æ–¥–Ω—è</h3>
                        <Badge variant="outline" className="text-xs">
                            {data.returns_today.length}
                        </Badge>
                    </div>
                    <div className="space-y-2">
                        {data.returns_today.length > 0 ? (
                            data.returns_today.map(renderReturnItem)
                        ) : (
                            <div className="text-center py-4 text-sm text-gray-500">
                                –°–µ–≥–æ–¥–Ω—è –Ω–µ—Ç –≤–æ–∑–≤—Ä–∞—Ç–æ–≤
                            </div>
                        )}
                    </div>
                </div>

                {/* –ü—Ä–æ—Å—Ä–æ—á–µ–Ω–Ω—ã–µ –∞—Ä–µ–Ω–¥—ã */}
                <div>
                    <div className="flex items-center gap-2 mb-3">
                        <AlertTriangle className="w-4 h-4 text-red-600" />
                        <h3 className="font-medium text-sm">–ü—Ä–æ—Å—Ä–æ—á–µ–Ω–Ω—ã–µ –∞—Ä–µ–Ω–¥—ã</h3>
                        <Badge variant="outline" className="text-xs">
                            {data.overdue_rentals.length}
                        </Badge>
                    </div>
                    <div className="space-y-2">
                        {data.overdue_rentals.length > 0 ? (
                            sortOverdueRentalsByDays(data.overdue_rentals).map(renderOverdueItem)
                        ) : (
                            <div className="text-center py-4 text-sm text-gray-500">
                                –ù–µ—Ç –ø—Ä–æ—Å—Ä–æ—á–µ–Ω–Ω—ã—Ö –∞—Ä–µ–Ω–¥
                            </div>
                        )}
                    </div>
                </div>
            </CardContent>
        </Card>
    );
}


```


## <a name="srccomponentscalendarCalendarDateInputRangetsx"></a>`src/components/calendar/CalendarDateInputRange.tsx`

```tsx
// path: src/components/calendar/CalendarDateInputRange.tsx

// src/components/calendar/CalendarDateInputRange.tsx

import { useDateStore } from "@/store/dateStore";
import { useDateRange } from "@/hooks/useDateRange";

export default function CalendarDateInputRange() {
    // ‚úÖ –ò–°–ü–†–ê–í–õ–ï–ù–û: –ü–æ–ª—É—á–∞–µ–º –∞–∫—Ç—É–∞–ª—å–Ω—ã–µ startDate, endDate –∏ setRange –∏–∑ —Ö—Ä–∞–Ω–∏–ª–∏—â–∞
    const { startDate, endDate, setRange } = useDateStore();

    const {
        localStartDate,
        localEndDate,
        handleStartDateChange,
        handleEndDateChange
    } = useDateRange({
        // ‚úÖ –ò–°–ü–†–ê–í–õ–ï–ù–û: –ü–µ—Ä–µ–¥–∞—ë–º –∞–∫—Ç—É–∞–ª—å–Ω—ã–µ –¥–∞—Ç—ã –≤ —Ö—É–∫
        startDate,
        endDate,
        onRangeChange: (start, end, source) => setRange(start, end, source)
    });

    return (
        <div className="flex items-center gap-2" role="group" aria-labelledby="date-range-label">
            <span id="date-range-label" className="sr-only">–í—ã–±–æ—Ä –¥–∏–∞–ø–∞–∑–æ–Ω–∞ –¥–∞—Ç –∫–∞–ª–µ–Ω–¥–∞—Ä—è</span>
            <label htmlFor="calendar-start-date" className="text-sm text-gray-700 shrink-0">
                –°:
            </label>
            <input
                id="calendar-start-date"
                type="date"
                value={localStartDate}
                onChange={handleStartDateChange}
                className="border border-gray-300 rounded px-2 py-1.5 text-sm focus:ring-2 focus:ring-sky-500 focus:border-sky-500"
                aria-label="–î–∞—Ç–∞ –Ω–∞—á–∞–ª–∞ –¥–ª—è –∫–∞–ª–µ–Ω–¥–∞—Ä—è"
            />

            <label htmlFor="calendar-end-date" className="text-sm text-gray-700 shrink-0">
                –ü–æ:
            </label>
            <input
                id="calendar-end-date"
                type="date"
                value={localEndDate}
                onChange={handleEndDateChange}
                className="border border-gray-300 rounded px-2 py-1.5 text-sm focus:ring-2 focus:ring-sky-500 focus:border-sky-500"
                aria-label="–î–∞—Ç–∞ –æ–∫–æ–Ω—á–∞–Ω–∏—è –¥–ª—è –∫–∞–ª–µ–Ω–¥–∞—Ä—è"
                min={localStartDate}
            />
        </div>
    );
}

```


## <a name="srccomponentscalendarCalendarFiltersBlocktsx"></a>`src/components/calendar/CalendarFiltersBlock.tsx`

```tsx
// path: src/components/calendar/CalendarFiltersBlock.tsx

// src/components/calendar/CalendarFiltersBlock.tsx
import CalendarDateInputRange from "@/components/calendar/CalendarDateInputRange";
import { Button } from "@/components/ui/button";
import { FilterX } from "lucide-react";
import type { Equipment } from "@/types/equipment";

type Props = {
    equipment: Equipment[];
    typeFilter: string | null;
    setTypeFilter: (v: string | null) => void;
    brandFilter: string | null;
    setBrandFilter: (v: string | null) => void;
    searchText: string;
    setSearchText: (v: string) => void;
    onReset: () => void;
};

export default function CalendarFiltersBlock({
                                                 equipment,
                                                 typeFilter,
                                                 setTypeFilter,
                                                 brandFilter,
                                                 setBrandFilter,
                                                 searchText,
                                                 setSearchText,
                                                 onReset,
                                             }: Props) {
    const types = Array.from(new Set(equipment.map((e) => e.equipment_type)));
    const brands = Array.from(new Set(equipment.map((e) => e.brand)));

    return (
        <div className="flex flex-col gap-4 mb-5 p-4 bg-gray-50 border border-gray-200 rounded-lg shadow-sm print:hidden">
            <div className="flex flex-col md:flex-row md:items-end md:justify-between gap-2">
                <div className="flex flex-col gap-2">
                    <input
                        type="text"
                        placeholder="–ü–æ–∏—Å–∫ –ø–æ –Ω–∞–∑–≤–∞–Ω–∏—é..."
                        value={searchText}
                        onChange={(e) => setSearchText(e.target.value)}
                        className="border px-3 py-1 rounded-md text-sm w-[250px]"
                    />
                    <CalendarDateInputRange />
                </div>
                <Button
                    variant="ghost"
                    onClick={onReset}
                    className="text-gray-600 hover:text-sky-700"
                >
                    <FilterX className="w-4 h-4 mr-1" />
                    –°–±—Ä–æ—Å–∏—Ç—å
                </Button>
            </div>

            <div className="flex flex-wrap items-center gap-2">
                <span className="text-sm text-gray-600 mr-2">–¢–∏–ø:</span>
                <Button
                    variant="filter"
                    data-state={typeFilter === null ? "on" : "off"}
                    onClick={() => setTypeFilter(null)}
                >
                    –í—Å–µ
                </Button>
                {types.map((type) => (
                    <Button
                        key={type}
                        variant="filter"
                        data-state={typeFilter === type ? "on" : "off"}
                        onClick={() => setTypeFilter(type)}
                    >
                        {type}
                    </Button>
                ))}
            </div>

            <div className="flex flex-wrap items-center gap-2">
                <span className="text-sm text-gray-600 mr-2">–ë—Ä–µ–Ω–¥:</span>
                <Button
                    variant="filter"
                    data-state={brandFilter === null ? "on" : "off"}
                    onClick={() => setBrandFilter(null)}
                >
                    –í—Å–µ
                </Button>
                {brands.map((brand) => (
                    <Button
                        key={brand}
                        variant="filter"
                        data-state={brandFilter === brand ? "on" : "off"}
                        onClick={() => setBrandFilter(brand)}
                    >
                        {brand}
                    </Button>
                ))}
            </div>
        </div>
    );
}


```


## <a name="srccomponentscalendarCalendarTabletsx"></a>`src/components/calendar/CalendarTable.tsx`

```tsx
// path: src/components/calendar/CalendarTable.tsx

// src/components/calendar/CalendarTable.tsx
import { useCalendarGrid } from "@/hooks/useCalendarGrid";
import { format } from "date-fns";
import { useDateStore } from "@/store/dateStore";
import { useCalendarSelectionStore } from "@/store/calendarSelectionStore";
// import { useCurrentUser } from "@/hooks/useProfile"; // –ù–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –Ω–∞–ø—Ä—è–º—É—é –¥–ª—è —Å—Ç–∏–ª–∏–∑–∞—Ü–∏–∏
import type { DayStatus, EquipmentStatus } from "@/types/availability";

type Equipment = {
    id: number;
    name: string;
    brand: string;
    equipment_type: string;
};

function getDateRange(start: Date, end: Date): Date[] {
    const days = [];
    let d = new Date(start);
    while (d <= end) {
        days.push(new Date(d));
        d.setDate(d.getDate() + 1);
    }
    return days;
}

function formatDateToDayMonthYear(date: Date): string {
    return format(date, "dd.MM.yyyy");
}

const cellBgMap: Record<string, string> = {
    available: "bg-emerald-50",
    reserved: "bg-amber-300",  // –ß—É–∂–∏–µ —Ä–µ–∑–µ—Ä–≤—ã
    rented: "bg-rose-400",     // –ß—É–∂–∏–µ –∞—Ä–µ–Ω–¥—ã
};

const userCellBgMap: Record<string, string> = {
    available: "bg-emerald-50", // –°–≤–æ–±–æ–¥–Ω—ã–µ —è—á–µ–π–∫–∏ –æ–¥–∏–Ω–∞–∫–æ–≤—ã –¥–ª—è –≤—Å–µ—Ö
    reserved: "bg-amber-500",  // –°–í–û–ô —Ä–µ–∑–µ—Ä–≤ - —Ç–µ–º–Ω–µ–µ
    rented: "bg-rose-600",     // –°–í–û–Ø –∞—Ä–µ–Ω–¥–∞ (–µ—Å–ª–∏ –ø—Ä–∏–º–µ–Ω–∏–º–æ –∏ –Ω—É–∂–Ω–æ –æ—Ç–ª–∏—á–∞—Ç—å) - —Ç–µ–º–Ω–µ–µ
};

export default function CalendarTable({ equipment }: { equipment: Equipment[] }) {
    const { startDate, endDate } = useDateStore();
    const { data: calendarDataFromHook, isLoading, isError, refetch } = useCalendarGrid();
    const { selectedGroupId, setSelectedGroupId } = useCalendarSelectionStore();

    if (!startDate || !endDate) return null;
    if (isLoading) return <div className="p-6 text-center">–ó–∞–≥—Ä—É–∑–∫–∞...</div>;
    if (isError)
        return (
            <div className="p-6 text-center text-red-700">
                –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ <button onClick={() => refetch()} className="underline hover:text-red-800">–ü–æ–≤—Ç–æ—Ä–∏—Ç—å</button>
            </div>
        );
    if (!equipment.length || !calendarDataFromHook || Object.keys(calendarDataFromHook).length === 0)
        return <div className="p-6 text-center text-gray-500">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –≤—ã–±—Ä–∞–Ω–Ω—ã—Ö —Ñ–∏–ª—å—Ç—Ä–æ–≤</div>;

    const dateRange = getDateRange(startDate, endDate);
    const todayStr = formatDateToDayMonthYear(new Date());

    return (
        <div
            className="overflow-x-auto rounded-xl border bg-white shadow"
            onClick={() => setSelectedGroupId(null)} // —Å–±—Ä–æ—Å –≤—ã–¥–µ–ª–µ–Ω–∏—è –ø—Ä–∏ –∫–ª–∏–∫–µ –≤–Ω–µ —è—á–µ–µ–∫
        >
            <table className="min-w-max table-auto border-collapse">
                <thead>
                <tr>
                    <th
                        className="sticky left-0 z-20 bg-white border-b px-4 py-2 text-sm font-semibold min-w-[220px]"
                        style={{ boxShadow: "2px 0 6px -2px #e0e7ef" }}
                    >
                        –û–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏–µ
                    </th>
                    {dateRange.map((date) => {
                        const dateStr = formatDateToDayMonthYear(date);
                        const isToday = dateStr === todayStr;

                        return (
                            <th
                                key={dateStr}
                                className={`sticky top-0 z-10 border-b px-2 py-1 text-xs font-medium min-w-[90px] truncate ${
                                    isToday
                                        ? "bg-sky-100 text-sky-800 border-sky-400 border-b-2 today-column"
                                        : "bg-white"
                                }`}
                            >
                                {dateStr}
                            </th>
                        );
                    })}
                </tr>
                </thead>
                <tbody>
                {equipment.map((item) => (
                    <tr key={item.id}>
                        <td className="sticky left-0 bg-white border-r px-3 py-1 z-10 min-w-[220px] text-xs text-gray-800 truncate">
                            {item.equipment_type} {item.brand} {item.name}
                        </td>
                        {dateRange.map((date) => {
                            const dateStr = formatDateToDayMonthYear(date);

                            const cellItemData = calendarDataFromHook[item.id]?.[dateStr];

                            let cell: DayStatus | undefined;

                            // –ë—ç–∫–µ–Ω–¥ —Ç–µ–ø–µ—Ä—å –≤—Å–µ–≥–¥–∞ –¥–æ–ª–∂–µ–Ω –≤–æ–∑–≤—Ä–∞—â–∞—Ç—å –æ–±—ä–µ–∫—Ç DayStatusItem (–∫–æ—Ç–æ—Ä—ã–π —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç DayStatus –Ω–∞ —Ñ—Ä–æ–Ω—Ç–µ)
                            if (typeof cellItemData === 'object' && cellItemData !== null && 'status' in cellItemData) {
                                cell = cellItemData as DayStatus;
                            } else if (typeof cellItemData === 'string') {
                                // –≠—Ç–æ—Ç –±–ª–æ–∫ –¥–ª—è –æ–±—Ä–∞—Ç–Ω–æ–π —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏, –µ—Å–ª–∏ –±—ç–∫–µ–Ω–¥ –í–î–†–£–ì –≤–µ—Ä–Ω–µ—Ç —Å—Ç—Ä–æ–∫—É
                                console.warn(`[CalendarTable] Received string status for ${item.name} on ${dateStr}. Expected DayStatus object.`);
                                cell = { status: cellItemData as EquipmentStatus, group_id: null, is_user_reservation: false };
                            }

                            const status: EquipmentStatus = cell?.status || "available";
                            const groupId: string | null = cell?.group_id || null;
                            const isUserReservation: boolean = cell?.is_user_reservation || false;
                            const isToday = dateStr === todayStr;

                            const isHighlighted: boolean = !!(groupId && groupId === selectedGroupId);

                            const handleClick = (e: React.MouseEvent) => {
                                e.stopPropagation();
                                setSelectedGroupId(groupId === selectedGroupId ? null : groupId);
                            };

                            const currentBgMap = isUserReservation ? userCellBgMap : cellBgMap;
                            const bgColor = currentBgMap[status] || currentBgMap['available']; // –§–æ–ª–±—ç–∫ –Ω–∞ 'available'

                            return (
                                <td
                                    key={dateStr}
                                    className={`p-[2px] border border-white ${isToday ? "today-column" : ""}`}
                                    onClick={handleClick}
                                    style={{ cursor: groupId ? 'pointer' : 'default' }} // –î–æ–±–∞–≤–ª—è–µ–º –∫—É—Ä—Å–æ—Ä, –µ—Å–ª–∏ –µ—Å—Ç—å groupId
                                >
                                    <div
                                        className={`w-full h-6 rounded-md transition-colors ${bgColor} ${
                                            isHighlighted ? "ring-2 ring-black/40 ring-inset opacity-90" : ""
                                        }`}
                                        title={status + (isUserReservation ? " (–º–æ–π)" : "") + (groupId ? ` (–≥—Ä—É–ø–ø–∞: ${groupId})` : "")}
                                    >
                                        <span className="sr-only">{status}{isUserReservation ? " (–º–æ–π)" : ""}{groupId ? ` (–≥—Ä—É–ø–ø–∞: ${groupId})` : ""}</span>
                                    </div>
                                </td>
                            );
                        })}
                    </tr>
                ))}
                </tbody>
            </table>
        </div>
    );
}

```


## <a name="srccomponentscatalogEquipmentCatalogtsx"></a>`src/components/catalog/EquipmentCatalog.tsx`

```tsx
// path: src/components/catalog/EquipmentCatalog.tsx

// src/components/catalog/EquipmentCatalog.tsx

import { useMemo } from "react";
import FilterPanel from "@/components/FilterPanel";
import EquipmentGrid from "@/components/EquipmentGrid";
import { useAppFilters } from "@/hooks/features/useAppFilters";
import { useAssociations } from "@/hooks/useAssociations";
import { useAllEquipment } from "@/hooks/useAllEquipment";
import { useEquipmentData } from "@/hooks/data/useEquipmentData";
import { useReservationManagement } from "@/hooks/useReservationManagement";
import { useViewModeStore } from "@/store/viewModeStore";

interface EquipmentCatalogProps {
    editingReservationId?: number;
    intent?: string;
}

/**
 * –ö–æ–º–ø–æ–Ω–µ–Ω—Ç –∫–∞—Ç–∞–ª–æ–≥–∞ –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—è.
 * –ò–Ω–∫–∞–ø—Å—É–ª–∏—Ä—É–µ—Ç –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –∏ —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏—é –∫–∞—Ç–∞–ª–æ–≥–∞ –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—è.
 */
export default function EquipmentCatalog({ editingReservationId: _editingReservationId, intent: _intent }: EquipmentCatalogProps) {
    const { viewMode } = useViewModeStore();

    // 1. –ü–æ–ª—É—á–∞–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ —Ñ–∏–ª—å—Ç—Ä–æ–≤
    const { query, type, brand, availableOnly, associationId, reset: resetFilters, startDate, endDate } = useAppFilters();

    // 2. –ü–æ–ª—É—á–∞–µ–º –¥–∞–Ω–Ω—ã–µ –¥–ª—è —Ñ–∏–ª—å—Ç—Ä–æ–≤
    const { data: _associations = [] } = useAssociations();
    const { data: allEquipmentForFilters = [] } = useAllEquipment();

    // 3. –í—ã–∑—ã–≤–∞–µ–º —Ö—É–∫ –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö —Å —É—á–µ—Ç–æ–º —Ñ–∏–ª—å—Ç—Ä–æ–≤
    const {
        equipment,
        totalEquipmentCount: _totalEquipmentCount,
        availabilityData,
        dailyAvailabilityData,
        isLoading,
        isFetchingNextPage,
        hasNextPage,
        fetchNextPage
    } = useEquipmentData({ 
        query, 
        type: type || undefined, 
        brand, 
        associationId: associationId || undefined, 
        availableOnly, 
        startDate: startDate as Date | undefined, 
        endDate: endDate as Date | undefined 
    });

    // –°–æ–∑–¥–∞–µ–º availabilityMap –∏–∑ availabilityData –¥–ª—è useReservationManagement
    const availabilityMap = useMemo(() => {
        const map: Record<number, any> = {};
        availabilityData?.forEach((info) => {
            map[info.equipment_id] = info;
        });
        return map;
    }, [availabilityData]);

    // 4. –í—ã–∑—ã–≤–∞–µ–º —Ö—É–∫ –¥–ª—è –ª–æ–≥–∏–∫–∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è —Ä–µ–∑–µ—Ä–≤–∞–º–∏
    const {
        getEquipmentStatus
    } = useReservationManagement(equipment, availabilityMap, availableOnly);

    // –í—ã—á–∏—Å–ª—è–µ–º –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è
    const hasActiveFilters = !!(type || (brand && brand !== "__all__") || query || associationId);

    return (
        <>
            <FilterPanel equipmentData={allEquipmentForFilters} />

            <EquipmentGrid
                isLoading={isLoading}
                items={equipment}
                hasActiveFilters={hasActiveFilters}
                getEquipmentStatus={getEquipmentStatus}
                dailyAvailabilityData={dailyAvailabilityData}
                availabilityData={availabilityData}
                onShowMore={fetchNextPage}
                onResetFilters={resetFilters}
                viewMode={viewMode}
                isFetchingNextPage={isFetchingNextPage}
                hasNextPage={hasNextPage}
            />
        </>
    );
}


```


## <a name="srccomponentsequipment-cardAccessoriesSectiontsx"></a>`src/components/equipment-card/AccessoriesSection.tsx`

```tsx
// path: src/components/equipment-card/AccessoriesSection.tsx

// src/components/equipment-card/AccessoriesSection.tsx
import React from 'react';
import { Paperclip, ChevronDown } from "lucide-react";
import { Label } from "@/components/ui/label";
import { Checkbox } from "@/components/ui/checkbox";
import type { Equipment } from "@/types/equipment";

interface AccessoriesSectionProps {
    equipment: Equipment;
    isExpanded: boolean;
    isDisabled: boolean;
    onToggleExpand: (e: React.MouseEvent) => void;
    onToggleAccessory: (accId: number) => void;
    isAccessorySelected: (eqId: number, accId: number) => boolean;
}

export const AccessoriesSection: React.FC<AccessoriesSectionProps> = ({
                                                                          equipment, isExpanded, isDisabled, onToggleExpand, onToggleAccessory, isAccessorySelected
                                                                      }) => {
    if (!equipment.accessories?.length) return null;

    return (
        <div className="mt-3 border-t pt-3">
            <button
                className="w-full flex justify-between items-center text-sm font-medium text-gray-600 hover:text-sky-700 p-1 -m-1 rounded"
                onClick={onToggleExpand}
                aria-expanded={isExpanded}
            >
                <span className="flex items-center gap-2">
                    <Paperclip className="w-4 h-4" />
                    –ê–∫—Å–µ—Å—Å—É–∞—Ä—ã ({equipment.accessories.length})
                </span>
                <ChevronDown className={`w-5 h-5 transition-transform ${isExpanded ? 'rotate-180' : ''}`} />
            </button>
            {isExpanded && (
                <div className="mt-2 space-y-2 pl-1 animate-in fade-in-0 slide-in-from-top-2 duration-300">
                    {equipment.accessories.map(acc => (
                        <div key={acc.id} className="flex items-center justify-between p-1 rounded hover:bg-gray-50">
                            <Label htmlFor={`acc-${equipment.id}-${acc.id}`} className="flex items-center gap-2 text-xs font-normal cursor-pointer">
                                <Checkbox
                                    id={`acc-${equipment.id}-${acc.id}`}
                                    checked={isAccessorySelected(equipment.id, acc.id)}
                                    onCheckedChange={() => onToggleAccessory(acc.id)}
                                    disabled={isDisabled}
                                />
                                {acc.name}
                            </Label>
                            <span className="text-xs text-gray-500">{acc.price} ‚ÇΩ</span>
                        </div>
                    ))}
                </div>
            )}
        </div>
    );
};

```


## <a name="srccomponentsequipment-cardCardFootertsx"></a>`src/components/equipment-card/CardFooter.tsx`

```tsx
// path: src/components/equipment-card/CardFooter.tsx

// src/components/equipment-card/CardFooter.tsx
import React from 'react';
import AvailabilityStrip from "@/components/AvailabilityStrip";
import { STATUS_TEXT_STYLES, STATUS_TEXTS } from './constants';
import type { DayStatus, EquipmentStatus } from "@/types/availability";

interface CardFooterProps {
    status: EquipmentStatus | "my_reservation" | "added";
    dateRange: string;
    selected: boolean;
    onToggleSelection: (e: React.MouseEvent) => void;
    dailyStatus?: Record<string, DayStatus>;
}

export const CardFooter: React.FC<CardFooterProps> = ({
                                                          status, dateRange, selected, onToggleSelection, dailyStatus
                                                      }) => (
    <div className="mt-auto pt-4 space-y-2">
        <div className="flex justify-between items-center">
            <p className={`text-sm font-semibold ${STATUS_TEXT_STYLES[status]}`}>
                {STATUS_TEXTS[status]}
                {dateRange && <span className="ml-1 text-xs font-normal">{dateRange}</span>}
            </p>
            {(status === 'available' || status === 'added') && (
                <button
                    onClick={onToggleSelection}
                    className={`px-3 py-1 rounded text-sm font-medium transition ${
                        status === 'added'
                            ? "bg-rose-100 text-rose-700 hover:bg-rose-200"
                            : selected
                                ? "bg-sky-700 text-white hover:bg-sky-800"
                                : "bg-sky-100 text-sky-700 hover:bg-sky-200"
                    }`}
                >
                    {status === 'added' ? "–û—Ç–º–µ–Ω–∏—Ç—å" : (selected ? "‚úî –í —Ä–µ–∑–µ—Ä–≤–µ" : "‚ûï –í —Ä–µ–∑–µ—Ä–≤")}
                </button>
            )}
        </div>
        <AvailabilityStrip dailyStatus={dailyStatus} />
    </div>
);

```


## <a name="srccomponentsequipment-cardCardImagetsx"></a>`src/components/equipment-card/CardImage.tsx`

```tsx
// path: src/components/equipment-card/CardImage.tsx

// src/components/equipment-card/CardImage.tsx
import React from 'react';
import { Image as ImageIcon } from "lucide-react";

interface CardImageProps {
    imageUrl?: string;
    name: string;
}

export const CardImage: React.FC<CardImageProps> = ({ imageUrl, name }) => (
    <div className="relative w-full h-40 bg-gray-100 flex items-center justify-center overflow-hidden">
        {imageUrl ? (
            <img
                src={imageUrl}
                alt={name}
                className="w-full h-full object-cover transition-transform duration-300 group-hover:scale-105"
                loading="lazy"
            />
        ) : (
            <ImageIcon className="w-12 h-12 text-gray-300" />
        )}
        <div className="absolute inset-0 bg-black/40 transition-opacity duration-300 group-hover:opacity-0 group-focus-within:opacity-0" />
    </div>
);

```


## <a name="srccomponentsequipment-cardDiscountInfotsx"></a>`src/components/equipment-card/DiscountInfo.tsx`

```tsx
// path: src/components/equipment-card/DiscountInfo.tsx

// src/components/equipment-card/DiscountInfo.tsx
import React from 'react';
import { getDayEnding } from './constants';

interface DiscountInfoProps {
    days: number;
    percentage: number;
    priceBefore: number;
    priceAfter: number;
}

export const DiscountInfo: React.FC<DiscountInfoProps> = ({ days, percentage, priceBefore, priceAfter }) => (
    <div className="mt-2 p-2 bg-gray-50 rounded-md border border-dashed">
        <div className="flex justify-between items-center text-sm">
            <span>{days} {getDayEnding(days)}:</span>
            {percentage > 0 ? (
                <div className="flex items-baseline gap-2">
                    <span className="text-gray-500 line-through">{Math.round(priceBefore).toLocaleString('ru-RU')} ‚ÇΩ</span>
                    <span className="font-bold text-base text-green-600">{Math.round(priceAfter).toLocaleString('ru-RU')} ‚ÇΩ</span>
                </div>
            ) : (
                <span className="font-bold text-base text-gray-800">{Math.round(priceBefore).toLocaleString('ru-RU')} ‚ÇΩ</span>
            )}
        </div>
        {percentage > 0 && <div className="text-xs text-right text-gray-500">–°–∫–∏–¥–∫–∞ {percentage}%</div>}
    </div>
);

```


## <a name="srccomponentsequipment-cardEquipmentCardtsx"></a>`src/components/equipment-card/EquipmentCard.tsx`

```tsx
// path: src/components/equipment-card/EquipmentCard.tsx

// src/components/equipment-card/EquipmentCard.tsx
import React, { useState } from "react";
import { CheckCircle } from "lucide-react";
import { formatDateRangeEuropean } from "@/lib/utils";
import { useEquipmentCardViewModel } from "@/hooks/features/useEquipmentCardViewModel";

// –ü–æ–¥–∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã
import { CardImage } from "./CardImage";
import { DiscountInfo } from "./DiscountInfo";
import { AccessoriesSection } from "./AccessoriesSection";
import { CardFooter } from "./CardFooter";
import { STATUS_BACKGROUND_STYLES } from './constants';
import EquipmentDetailsDialog from "@/components/equipment/EquipmentDetailsDialog";

// –¢–∏–ø—ã
import type { Equipment } from "@/types/equipment";
import type { DayStatus, EquipmentStatus } from "@/types/availability";

interface EquipmentCardProps {
    equipment: Equipment;
    status?: EquipmentStatus | "my_reservation" | "added";
    startDate?: string;
    endDate?: string;
    dailyStatus?: Record<string, DayStatus>;
}

const EquipmentCardComponent: React.FC<EquipmentCardProps> = ({ equipment, status = "available", startDate, endDate, dailyStatus }) => {
    const [showDetails, setShowDetails] = useState(false);
    const [showAccessories, setShowAccessories] = useState(false);

    // –ü–æ–ª—É—á–∞–µ–º –≤—Å–µ –¥–∞–Ω–Ω—ã–µ –∏ —Ñ—É–Ω–∫—Ü–∏–∏ –∏–∑ —Ö—É–∫–∞-ViewModel
    const {
        isSelectedByUser,
        isCalculatorVisible,
        discountData,
        handleToggleAccessory,
        handleToggleSelection,
        isAccessorySelected,
    } = useEquipmentCardViewModel({ equipment, status });

    const handleCardClick = (e: React.MouseEvent<HTMLDivElement>) => {
        if ((e.target as HTMLElement).closest("button, a, label, input[type='checkbox']")) return;
        setShowDetails(true);
    };

    const handleDoubleClick = (e: React.MouseEvent<HTMLDivElement>) => {
        if ((e.target as HTMLElement).closest("button, a, label, input[type='checkbox']")) return;
        if (status === 'available' || status === 'added') handleToggleSelection();
    };

    const stopPropagationAndToggle = (e: React.MouseEvent, action: () => void) => {
        e.stopPropagation();
        action();
    };

    const backgroundClass = STATUS_BACKGROUND_STYLES[status] || 'bg-white';
    const selectionClass = isSelectedByUser ? "ring-2 ring-offset-1 ring-sky-500 border-sky-400" : "border-gray-200 hover:shadow-lg";
    const dateRangeDisplay = (startDate && endDate) ? `(${formatDateRangeEuropean(startDate, endDate)})` : "";

    return (
        <>
            <div
                className={`relative group rounded-xl shadow transition w-full max-w-sm flex flex-col justify-between cursor-pointer overflow-hidden ${backgroundClass} ${selectionClass}`}
                onClick={handleCardClick}
                onDoubleClick={handleDoubleClick}
                tabIndex={0}
            >
                {isSelectedByUser && <div className="absolute top-2.5 right-2.5 z-10 bg-sky-600 text-white rounded-full p-1 shadow"><CheckCircle className="w-5 h-5" /></div>}

                <CardImage imageUrl={equipment.image_url} name={equipment.name} />

                <div className="p-4 flex-1 flex flex-col">
                    <div className="flex-grow">
                        <h3 className="text-lg font-semibold mb-1">{equipment.name}</h3>
                        <p className="text-sm text-gray-500 mb-2">{equipment.brand} ‚Ä¢ {equipment.equipment_type}</p>
                        {equipment.short_description && <p className="text-sm italic text-gray-600 mb-2">"{equipment.short_description}"</p>}
                        <p className="text-sm mb-1">–°–æ—Å—Ç–æ—è–Ω–∏–µ: <strong>{equipment.condition}</strong></p>
                        <p className="text-base font-bold mb-1">{equipment.daily_rate} ‚ÇΩ / –¥–µ–Ω—å</p>
                        {isCalculatorVisible && <DiscountInfo {...discountData} />}
                    </div>

                    <AccessoriesSection
                        equipment={equipment}
                        isExpanded={showAccessories}
                        isDisabled={status !== 'available' && status !== 'added'}
                        onToggleExpand={(e) => stopPropagationAndToggle(e, () => setShowAccessories(p => !p))}
                        onToggleAccessory={handleToggleAccessory}
                        isAccessorySelected={isAccessorySelected}
                    />

                    <CardFooter
                        status={status}
                        dateRange={dateRangeDisplay}
                        selected={isSelectedByUser}
                        onToggleSelection={(e) => stopPropagationAndToggle(e, handleToggleSelection)}
                        dailyStatus={dailyStatus}
                    />
                </div>
            </div>

            <EquipmentDetailsDialog
                open={showDetails}
                onClose={() => setShowDetails(false)}
                equipment={equipment}
                availability={{ equipment_id: equipment.id, status: status as EquipmentStatus, details: "" }}
            />
        </>
    );
};

// –ú–µ–º–æ–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω–∞—è –≤–µ—Ä—Å–∏—è –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–∞ –¥–ª—è –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏
export const EquipmentCard = React.memo(EquipmentCardComponent);

```


## <a name="srccomponentsequipment-cardconstantsts"></a>`src/components/equipment-card/constants.ts`

```typescript
// path: src/components/equipment-card/constants.ts

// src/components/equipment-card/constants.ts

import type { EquipmentStatus } from "@/types/availability";

type StatusKey = EquipmentStatus | "my_reservation" | "added";

// –°—Ç–∏–ª–∏ –¢–û–õ–¨–ö–û –¥–ª—è —Ü–≤–µ—Ç–∞ —Ç–µ–∫—Å—Ç–∞
export const STATUS_TEXT_STYLES: Record<StatusKey, string> = {
    available: "text-green-600",
    reserved: "text-yellow-500",
    rented: "text-red-600",
    my_reservation: "text-sky-700",
    added: "text-emerald-600",
};

// –°—Ç–∏–ª–∏ –¢–û–õ–¨–ö–û –¥–ª—è —Ü–≤–µ—Ç–∞ —Ñ–æ–Ω–∞
export const STATUS_BACKGROUND_STYLES: Record<StatusKey, string> = {
    available: "bg-white",
    reserved: "bg-white",
    rented: "bg-white",
    my_reservation: "bg-sky-50",
    added: "bg-emerald-50",
};

// –¢–µ–∫—Å—Ç–æ–≤—ã–µ –æ–ø–∏—Å–∞–Ω–∏—è –¥–ª—è —Å—Ç–∞—Ç—É—Å–æ–≤
export const STATUS_TEXTS: Record<StatusKey, string> = {
    available: "–°–≤–æ–±–æ–¥–Ω–æ",
    reserved: "–í —Ä–µ–∑–µ—Ä–≤–µ",
    rented: "–í –∞—Ä–µ–Ω–¥–µ",
    my_reservation: "–í —ç—Ç–æ–º —Ä–µ–∑–µ—Ä–≤–µ",
    added: "–î–æ–±–∞–≤–ª–µ–Ω–æ",
};

// –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –ø—Ä–∞–≤–∏–ª—å–Ω–æ–≥–æ –æ–∫–æ–Ω—á–∞–Ω–∏—è —Å–ª–æ–≤–∞ "–¥–µ–Ω—å"
export const getDayEnding = (num: number): string => {
    if (num > 10 && num < 20) return '–¥–Ω–µ–π';
    const lastDigit = num % 10;
    if (lastDigit === 1) return '–¥–µ–Ω—å';
    if (lastDigit > 1 && lastDigit < 5) return '–¥–Ω—è';
    return '–¥–Ω–µ–π';
};

```


## <a name="srccomponentsequipment-cardindexts"></a>`src/components/equipment-card/index.ts`

```typescript
// path: src/components/equipment-card/index.ts

// src/components/equipment-card/index.ts

export { EquipmentCard as default } from './EquipmentCard';

```


## <a name="srccomponentsequipmentEquipmentDetailsDialogtsx"></a>`src/components/equipment/EquipmentDetailsDialog.tsx`

```tsx
// path: src/components/equipment/EquipmentDetailsDialog.tsx

// src/components/equipment/EquipmentDetailsDialog.tsx
import { useState, useEffect } from "react"; // 1. –ò–º–ø–æ—Ä—Ç–∏—Ä—É–µ–º useEffect
import { Dialog, DialogContent, DialogFooter, DialogHeader, DialogTitle } from "@/components/ui/dialog";
import EquipmentDetailsView from "@/components/equipment/EquipmentDetailsView";
import EquipmentEditForm from "./EquipmentEditForm";
import type { Equipment } from "@/types/equipment";
import type { AvailabilityInfo } from "@/types/availability";
import { Button } from "@/components/ui/button";
import { useReserveStore } from "@/store/reserveStore";
import { useCurrentUser } from "@/hooks/useProfile";
import { Pencil, Check } from "lucide-react";

type Props = {
    open: boolean;
    onClose: () => void;
    equipment: Equipment;
    availability?: AvailabilityInfo;
};

export default function EquipmentDetailsDialog({ open, onClose, equipment, availability }: Props) {
    const { addWithAccessories, isSelected } = useReserveStore();
    const { data: currentUser } = useCurrentUser();

    const [isEditing, setIsEditing] = useState(false);
    const [stagedAccessoryIds, setStagedAccessoryIds] = useState<Set<number>>(new Set());

    // 2. –î–æ–±–∞–≤–ª—è–µ–º —ç—Ç–æ—Ç –±–ª–æ–∫ useEffect
    useEffect(() => {
        if (!open) {
            document.body.style.overflow = '';
        }
    }, [open]);

    const selected = isSelected(equipment.id);
    const isAvailableForReservation = availability?.status === "available";
    const userRole = currentUser?.role;
    const canEdit = userRole === "admin" || userRole === "manager";
    const canViewAdminInfo = canEdit;

    const handleMainActionClick = () => {
        if (!selected) {
            addWithAccessories(equipment, Array.from(stagedAccessoryIds));
        }
        onClose();
    };

    const handleEditClick = () => {
        setIsEditing(true);
    };

    const handleDialogCloseTrigger = () => {
        setIsEditing(false);
        setStagedAccessoryIds(new Set());
        onClose();
    };

    const handleToggleStagedAccessory = (accessoryId: number) => {
        setStagedAccessoryIds(prev => {
            const newSet = new Set(prev);
            if (newSet.has(accessoryId)) {
                newSet.delete(accessoryId);
            } else {
                newSet.add(accessoryId);
            }
            return newSet;
        });
    };

    return (
        <Dialog open={open} onOpenChange={(isOpen) => !isOpen && handleDialogCloseTrigger()}>
            <DialogContent className="max-w-xl p-6">
                <DialogHeader className="pb-4">
                    <DialogTitle className="text-lg sm:text-xl">
                        {isEditing ? `–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ: ${equipment.name}` : "–î–µ—Ç–∞–ª–∏ –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—è"}
                    </DialogTitle>
                </DialogHeader>

                {isEditing ? (
                    <EquipmentEditForm
                        equipment={equipment}
                        onSuccess={() => { setIsEditing(false); onClose(); }}
                        onCancel={() => setIsEditing(false) }
                    />
                ) : (
                    <EquipmentDetailsView
                        equipment={equipment}
                        canViewAdminInfo={canViewAdminInfo}
                        canToggleAccessories={isAvailableForReservation}
                        isMainSelected={selected}
                        stagedAccessoryIds={stagedAccessoryIds}
                        onToggleStagedAccessory={handleToggleStagedAccessory}
                    />
                )}

                {!isEditing && (
                    <DialogFooter className="pt-4 mt-4 border-t border-gray-200 flex flex-col sm:flex-row sm:justify-end sm:items-center gap-2">
                        {canEdit && (
                            <Button
                                variant="secondary"
                                onClick={handleEditClick}
                                className="w-full sm:w-auto order-last sm:order-none"
                            >
                                <Pencil size={15} className="mr-1.5" />
                                –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å
                            </Button>
                        )}
                        {isAvailableForReservation && (
                            <Button
                                onClick={handleMainActionClick}
                                variant="default"
                                className="w-full sm:w-auto"
                            >
                                {selected
                                    ? <><Check size={16} className="mr-1.5" />–ì–æ—Ç–æ–≤–æ</>
                                    : "‚ûï –î–æ–±–∞–≤–∏—Ç—å –≤ —Ä–µ–∑–µ—Ä–≤"
                                }
                            </Button>
                        )}
                    </DialogFooter>
                )}
            </DialogContent>
        </Dialog>
    );
}

```


## <a name="srccomponentsequipmentEquipmentDetailsViewtsx"></a>`src/components/equipment/EquipmentDetailsView.tsx`

```tsx
// path: src/components/equipment/EquipmentDetailsView.tsx

// src/components/equipment/EquipmentDetailsView.tsx
import type { Equipment } from "@/types/equipment";
import { formatDateEuropean } from "@/lib/utils";
import ReactMarkdown from 'react-markdown';
import { Image as ImageIcon, Paperclip, Plus, Check } from "lucide-react";
import { Button } from "@/components/ui/button";
import { useReserveStore } from "@/store/reserveStore";

type Props = {
    equipment: Equipment;
    canViewAdminInfo: boolean;
    canToggleAccessories: boolean;
    // üëá –ò–ó–ú–ï–ù–ï–ù–ò–ï: –ù–æ–≤—ã–µ –ø—Ä–æ–ø—Å—ã –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è —Å–æ—Å—Ç–æ—è–Ω–∏–µ–º
    isMainSelected: boolean;
    stagedAccessoryIds: Set<number>;
    onToggleStagedAccessory: (accessoryId: number) => void;
};

export default function EquipmentDetailsView({
                                                 equipment,
                                                 canViewAdminInfo,
                                                 canToggleAccessories,
                                                 isMainSelected,
                                                 stagedAccessoryIds,
                                                 onToggleStagedAccessory
                                             }: Props) {
    const { toggleAccessory, isAccessorySelected } = useReserveStore();

    // üëá –ò–ó–ú–ï–ù–ï–ù–ò–ï: –û–±—Ä–∞–±–æ—Ç—á–∏–∫ —Ç–µ–ø–µ—Ä—å —Ä–∞–∑–¥–µ–ª—è–µ—Ç –ª–æ–≥–∏–∫—É
    const handleToggleAccessory = (accessoryId: number) => {
        // –ï—Å–ª–∏ –æ—Å–Ω–æ–≤–Ω–æ–π —Ç–æ–≤–∞—Ä —É–∂–µ –≤ —Ä–µ–∑–µ—Ä–≤–µ, —Ä–∞–±–æ—Ç–∞–µ–º —Å –≥–ª–æ–±–∞–ª—å–Ω—ã–º —Å—Ç–æ—Ä–æ–º
        if (isMainSelected) {
            toggleAccessory(equipment.id, accessoryId);
        } else {
            // –ò–Ω–∞—á–µ - —Ä–∞–±–æ—Ç–∞–µ–º —Å –ª–æ–∫–∞–ª—å–Ω—ã–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ–º "–æ—Ç–º–µ—á–µ–Ω–Ω—ã—Ö"
            onToggleStagedAccessory(accessoryId);
        }
    };

    const allImages = [equipment.image_url, ...(equipment.image_urls || [])].filter(Boolean) as string[];

    return (
        <div className="space-y-3 text-sm">
            {/* ... –±–ª–æ–∫ —Å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è–º–∏ –∏ –æ–ø–∏—Å–∞–Ω–∏–µ–º –æ—Å—Ç–∞–µ—Ç—Å—è –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π ... */}
            {allImages.length > 0 ? (
                <div className="flex overflow-x-auto space-x-2 pb-2 -mx-1 px-1">
                    {allImages.map((url, index) => (
                        <div key={index} className="flex-shrink-0 w-48 h-32 rounded-lg overflow-hidden bg-gray-100 border">
                            <img src={url} alt={`${equipment.name} image ${index + 1}`} className="w-full h-full object-cover" />
                        </div>
                    ))}
                </div>
            ) : (
                <div className="w-full h-32 bg-gray-100 flex items-center justify-center rounded-lg border">
                    <ImageIcon className="w-12 h-12 text-gray-300" />
                </div>
            )}

            <h3 className="text-base sm:text-lg font-bold text-gray-900 leading-tight pt-2">
                {equipment.equipment_type} {equipment.brand} {equipment.name}
            </h3>

            <div className="mt-2 space-y-1">
                <p><span className="font-medium text-gray-700">–¶–µ–Ω–∞:</span> {equipment.daily_rate} ‚ÇΩ / –¥–µ–Ω—å</p>
                <p><span className="font-medium text-gray-700">–°–æ—Å—Ç–æ—è–Ω–∏–µ:</span> {equipment.condition}</p>
            </div>

            {equipment.accessories && equipment.accessories.length > 0 && (
                <div className="pt-3 mt-3 border-t">
                    <p className="font-semibold text-gray-800 mb-2 flex items-center gap-2">
                        <Paperclip className="w-4 h-4 text-gray-500"/>
                        –î–æ—Å—Ç—É–ø–Ω—ã–µ –∞–∫—Å–µ—Å—Å—É–∞—Ä—ã:
                    </p>
                    <ul className="space-y-1.5">
                        {equipment.accessories.map(acc => {
                            // üëá –ò–ó–ú–ï–ù–ï–ù–ò–ï: –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—Ç–∞—Ç—É—Å –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Ç–æ–≥–æ, –¥–æ–±–∞–≤–ª–µ–Ω –ª–∏ —Ç–æ–≤–∞—Ä –≤ —Ä–µ–∑–µ—Ä–≤
                            const isAdded = isMainSelected
                                ? isAccessorySelected(equipment.id, acc.id)
                                : stagedAccessoryIds.has(acc.id);

                            return (
                                <li key={acc.id} className="flex justify-between items-center bg-gray-50/70 p-2 rounded-md hover:bg-gray-100 transition-colors">
                                    <div>
                                        <span className="font-medium">{acc.name}</span>
                                        <span className="text-xs text-gray-600 ml-2">{acc.price} ‚ÇΩ</span>
                                    </div>
                                    <Button
                                        size="icon"
                                        variant={isAdded ? "default" : "outline"}
                                        className={`h-7 w-7 shrink-0 ${isAdded ? 'bg-green-600 hover:bg-green-700' : ''}`}
                                        onClick={() => handleToggleAccessory(acc.id)}
                                        aria-label={isAdded ? "–£–±—Ä–∞—Ç—å –∞–∫—Å–µ—Å—Å—É–∞—Ä" : "–î–æ–±–∞–≤–∏—Ç—å –∞–∫—Å–µ—Å—Å—É–∞—Ä"}
                                        disabled={!canToggleAccessories}
                                    >
                                        {isAdded ? <Check className="h-4 w-4" /> : <Plus className="h-4 w-4" />}
                                    </Button>
                                </li>
                            );
                        })}
                    </ul>
                </div>
            )}

            {/* ... –æ—Å—Ç–∞–ª—å–Ω—ã–µ –±–ª–æ–∫–∏ (–æ–ø–∏—Å–∞–Ω–∏–µ, —Å–ª—É–∂–µ–±–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è) –æ—Å—Ç–∞—é—Ç—Å—è –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π ... */}
            {equipment.description && (
                <div className="pt-3 mt-3 border-t">
                    <p className="font-semibold text-gray-800 mb-1">–û–ø–∏—Å–∞–Ω–∏–µ:</p>
                    <div className="prose prose-sm max-w-none text-gray-700 bg-gray-50 p-3 rounded-md border border-gray-200">
                        <ReactMarkdown>{equipment.description}</ReactMarkdown>
                    </div>
                </div>
            )}

            {canViewAdminInfo && (equipment.notes || equipment.last_maintenance) && (
                <div className="pt-3 mt-3 border-t space-y-2">
                    <h4 className="text-sm font-semibold text-sky-700">–°–ª—É–∂–µ–±–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è:</h4>
                    {equipment.last_maintenance && (
                        <p className="text-xs text-gray-600"><strong>–ü–æ—Å–ª–µ–¥–Ω–µ–µ –¢–û:</strong> {formatDateEuropean(equipment.last_maintenance)}</p>
                    )}
                    {equipment.notes && (
                        <div>
                            <p className="text-xs font-semibold text-gray-600 mb-0.5">–ó–∞–º–µ—Ç–∫–∏:</p>
                            <p className="text-xs text-gray-500 whitespace-pre-wrap bg-gray-50 p-2 rounded-md border border-gray-200">{equipment.notes}</p>
                        </div>
                    )}
                </div>
            )}
        </div>
    );
}

```


## <a name="srccomponentsequipmentEquipmentEditFormtsx"></a>`src/components/equipment/EquipmentEditForm.tsx`

```tsx
// path: src/components/equipment/EquipmentEditForm.tsx

// src/components/equipment/EquipmentEditForm.tsx

import { useForm, Controller } from "react-hook-form";
import { zodResolver } from "@hookform/resolvers/zod";
import {
    equipmentUpdateExtendedSchema,
    type EquipmentUpdateExtendedSchema as EquipmentUpdateFormData
} from "@/lib/validationSchemas";
import { useUpdateEquipmentDetails } from "@/hooks/useUpdateEquipmentDetails";
import { useAccessories } from "@/hooks/useAdminAccessories";
import type { Equipment } from "@/types/equipment";
import type { Accessory } from "@/types/accessory"; // –î–æ–±–∞–≤–ª—è–µ–º –∏–º–ø–æ—Ä—Ç —Ç–∏–ø–∞ Accessory
import { Input } from "@/components/ui/input";
import { Button } from "@/components/ui/button";
import { Label } from "@/components/ui/label";
import { Textarea } from "@/components/ui/textarea";
import { formatDate } from "@/lib/utils";
import MDEditor from '@uiw/react-md-editor';
import rehypeSanitize from 'rehype-sanitize';
import { Checkbox } from "@/components/ui/checkbox";
import { useAllEquipment } from "@/hooks/useAllEquipment";
import { CreatableSelect } from "@/components/ui/CreatableSelect";
import { useMemo } from "react";

type Props = {
    equipment: Equipment;
    onSuccess: (updatedData: Equipment) => void;
    onCancel: () => void;
};

export default function EquipmentEditForm({ equipment, onSuccess, onCancel }: Props) {
    const { data: allEquipmentData = [] } = useAllEquipment();
    // –ó–∞–ø—Ä–∞—à–∏–≤–∞–µ–º –∞–∫—Å–µ—Å—Å—É–∞—Ä—ã —Å –ø–∞–≥–∏–Ω–∞—Ü–∏–µ–π (–±–µ—Ä–µ–º –æ–¥–Ω—É –±–æ–ª—å—à—É—é "—Å—Ç—Ä–∞–Ω–∏—Ü—É")
    const { data: accessoriesResponse, isLoading: isLoadingAccessories } = useAccessories(1, 500);
    // –ò–∑–≤–ª–µ–∫–∞–µ–º –º–∞—Å—Å–∏–≤ .items –∏–∑ –æ—Ç–≤–µ—Ç–∞
    const allAccessories = accessoriesResponse?.items || [];

    const equipmentTypes = useMemo(() => {
        const types = new Set(allEquipmentData.map(e => e.equipment_type));
        return Array.from(types).sort((a, b) => a.localeCompare(b));
    }, [allEquipmentData]);

    const equipmentBrands = useMemo(() => {
        const brands = new Set(allEquipmentData.map(e => e.brand));
        return Array.from(brands).sort((a, b) => a.localeCompare(b));
    }, [allEquipmentData]);

    const {
        register,
        handleSubmit,
        control,
        formState: { errors, isDirty, isValid },
    } = useForm<EquipmentUpdateFormData>({
        resolver: zodResolver(equipmentUpdateExtendedSchema) as any,
        defaultValues: {
            equipment_type: equipment.equipment_type ?? undefined,
            brand: equipment.brand ?? undefined,
            name: equipment.name ?? undefined,
            serial_number: equipment.serial_number ?? undefined,
            condition: equipment.condition ?? undefined,
            daily_rate: equipment.daily_rate ?? undefined,
            notes: equipment.notes ?? undefined,
            description: equipment.description ?? undefined,
            last_maintenance: equipment.last_maintenance ? formatDate(equipment.last_maintenance) : undefined,
            short_description: equipment.short_description ?? undefined,
            image_url: equipment.image_url ?? undefined,
            image_urls: equipment.image_urls ?? [],
            accessory_ids: equipment.accessories?.map(acc => acc.id) ?? [],
        },
        mode: "onChange",
    });

    const updateEquipmentMutation = useUpdateEquipmentDetails();

    const onSubmitHandler = async (data: EquipmentUpdateFormData) => {
        await updateEquipmentMutation.mutateAsync(
            { id: equipment.id, data },
            {
                onSuccess: (updatedEquipmentDataFromApi) => {
                    onSuccess(updatedEquipmentDataFromApi);
                },
            }
        );
    };

    return (
        <form onSubmit={handleSubmit(onSubmitHandler)} className="space-y-4 py-4 max-h-[75vh] overflow-y-auto pr-4">
            {/* ... –æ—Å—Ç–∞–ª—å–Ω–∞—è —á–∞—Å—Ç—å —Ñ–æ—Ä–º—ã –æ—Å—Ç–∞–µ—Ç—Å—è –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π ... */}
            <div>
                <Label htmlFor="name">–ù–∞–∑–≤–∞–Ω–∏–µ</Label>
                <Input id="name" {...register("name")} />
                {errors.name && <p className="text-xs text-red-600 mt-1">{errors.name.message}</p>}
            </div>

            <div className="grid grid-cols-1 sm:grid-cols-2 gap-4">
                <div>
                    <Label htmlFor="equipment_type">–¢–∏–ø –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—è</Label>
                    <Controller
                        name="equipment_type"
                        control={control}
                        render={({ field }) => (
                            <CreatableSelect
                                value={field.value}
                                onChange={field.onChange}
                                options={equipmentTypes}
                                placeholder="–í—ã–±–µ—Ä–∏—Ç–µ –∏–ª–∏ —Å–æ–∑–¥–∞–π—Ç–µ —Ç–∏–ø"
                                dialogTitle="–ù–æ–≤—ã–π —Ç–∏–ø –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—è"
                                dialogDescription="–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –¥–ª—è –Ω–æ–≤–æ–≥–æ —Ç–∏–ø–∞."
                                dialogLabel="–ù–∞–∑–≤–∞–Ω–∏–µ"
                            />
                        )}
                    />
                    {errors.equipment_type && <p className="text-xs text-red-600 mt-1">{errors.equipment_type.message}</p>}
                </div>
                <div>
                    <Label htmlFor="brand">–ë—Ä–µ–Ω–¥</Label>
                    <Controller
                        name="brand"
                        control={control}
                        render={({ field }) => (
                            <CreatableSelect
                                value={field.value}
                                onChange={field.onChange}
                                options={equipmentBrands}
                                placeholder="–í—ã–±–µ—Ä–∏—Ç–µ –∏–ª–∏ —Å–æ–∑–¥–∞–π—Ç–µ –±—Ä–µ–Ω–¥"
                                dialogTitle="–ù–æ–≤—ã–π –±—Ä–µ–Ω–¥"
                                dialogDescription="–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –¥–ª—è –Ω–æ–≤–æ–≥–æ –±—Ä–µ–Ω–¥–∞."
                                dialogLabel="–ù–∞–∑–≤–∞–Ω–∏–µ"
                            />
                        )}
                    />
                    {errors.brand && <p className="text-xs text-red-600 mt-1">{errors.brand.message}</p>}
                </div>
            </div>

            <div>
                <Label htmlFor="short_description">–ö—Ä–∞—Ç–∫–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ (–¥–ª—è –∫–∞—Ä—Ç–æ—á–∫–∏)</Label>
                <Input id="short_description" {...register("short_description")} placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: –ü—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω–∞—è –±–µ–∑–∑–µ—Ä–∫–∞–ª—å–Ω–∞—è –∫–∞–º–µ—Ä–∞..." />
                {errors.short_description && <p className="text-xs text-red-600 mt-1">{errors.short_description.message}</p>}
            </div>

            <div>
                <Label htmlFor="image_url">URL –æ—Å–Ω–æ–≤–Ω–æ–≥–æ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è</Label>
                <Input id="image_url" {...register("image_url")} placeholder="https://example.com/main_image.jpg" />
                {errors.image_url && <p className="text-xs text-red-600 mt-1">{errors.image_url.message}</p>}
            </div>

            <div>
                <Label htmlFor="image_urls">URL –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã—Ö –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π (–∫–∞–∂–¥—ã–π —Å –Ω–æ–≤–æ–π —Å—Ç—Ä–æ–∫–∏)</Label>
                <Controller
                    name="image_urls"
                    control={control}
                    render={({ field }) => (
                        <Textarea
                            id="image_urls"
                            placeholder={"https://example.com/image1.jpg\nhttps://example.com/image2.jpg"}
                            value={Array.isArray(field.value) ? field.value.join('\n') : ''}
                            onChange={(e) => {
                                const urls = e.target.value ? e.target.value.split('\n') : [];
                                field.onChange(urls);
                            }}
                            rows={4}
                        />
                    )}
                />
                {errors.image_urls && <p className="text-xs text-red-600 mt-1">{errors.image_urls.message as string}</p>}
            </div>

            <div>
                <Label htmlFor="serial_number">–°–µ—Ä–∏–π–Ω—ã–π –Ω–æ–º–µ—Ä</Label>
                <Input id="serial_number" {...register("serial_number")} />
                {errors.serial_number && <p className="text-xs text-red-600 mt-1">{errors.serial_number.message}</p>}
            </div>

            <div className="grid grid-cols-1 sm:grid-cols-2 gap-4">
                <div>
                    <Label htmlFor="condition">–°–æ—Å—Ç–æ—è–Ω–∏–µ</Label>
                    <Input id="condition" {...register("condition")} />
                    {errors.condition && <p className="text-xs text-red-600 mt-1">{errors.condition.message}</p>}
                </div>
                <div>
                    <Label htmlFor="daily_rate">–¶–µ–Ω–∞ –∑–∞ –¥–µ–Ω—å (‚ÇΩ)</Label>
                    <Controller
                        name="daily_rate"
                        control={control}
                        render={({ field }) => (
                            <Input
                                {...field}
                                id="daily_rate"
                                type="number"
                                value={field.value ?? ""}
                                onChange={(e) => {
                                    const val = e.target.value;
                                    field.onChange(val === '' ? undefined : parseFloat(val));
                                }}
                                step="0.01"
                                placeholder="0.00"
                            />
                        )}
                    />
                    {errors.daily_rate && <p className="text-xs text-red-600 mt-1">{errors.daily_rate.message}</p>}
                </div>
            </div>

            <div>
                <Label htmlFor="description">–û–ø–∏—Å–∞–Ω–∏–µ (Markdown)</Label>
                <Controller
                    name="description"
                    control={control}
                    render={({ field }) => (
                        <div data-color-mode="light">
                            <MDEditor
                                value={field.value ?? ""}
                                onChange={(val) => field.onChange(val ?? "")}
                                previewOptions={{ rehypePlugins: [[rehypeSanitize]] }}
                                height={250}
                            />
                        </div>
                    )}
                />
                {errors.description && <p className="text-xs text-red-600 mt-1">{errors.description.message}</p>}
            </div>

            <div className="space-y-2 pt-4 border-t">
                <Label>–ü—Ä–∏–≤—è–∑–∞–Ω–Ω—ã–µ –∞–∫—Å–µ—Å—Å—É–∞—Ä—ã</Label>
                <p className="text-sm text-muted-foreground">
                    –í—ã–±–µ—Ä–∏—Ç–µ –∞–∫—Å–µ—Å—Å—É–∞—Ä—ã, –∫–æ—Ç–æ—Ä—ã–µ –±—É–¥—É—Ç –ø—Ä–µ–¥–ª–∞–≥–∞—Ç—å—Å—è –≤–º–µ—Å—Ç–µ —Å —ç—Ç–∏–º –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏–µ–º.
                </p>
                {isLoadingAccessories ? (
                    <p className="text-sm text-muted-foreground">–ó–∞–≥—Ä—É–∑–∫–∞ —Å–ø–∏—Å–∫–∞ –∞–∫—Å–µ—Å—Å—É–∞—Ä–æ–≤...</p>
                ) : (
                    <Controller
                        control={control}
                        name="accessory_ids"
                        render={({ field }) => (
                            <div className="space-y-2 max-h-48 overflow-y-auto rounded-md border p-4 bg-slate-50">
                                {allAccessories.map((accessory: Accessory) => ( // –î–æ–±–∞–≤–ª—è–µ–º —Ç–∏–ø –¥–ª—è accessory
                                    <div key={accessory.id} className="flex items-center justify-between hover:bg-slate-100 p-2 rounded">
                                        <div className="flex items-center gap-2">
                                            <Checkbox
                                                id={`accessory-${accessory.id}`}
                                                checked={field.value?.includes(accessory.id)}
                                                onCheckedChange={(checked) => {
                                                    const currentIds = field.value ?? [];
                                                    const newIds = checked
                                                        ? [...currentIds, accessory.id]
                                                        : currentIds.filter(id => id !== accessory.id);
                                                    field.onChange(newIds);
                                                }}
                                            />
                                            <Label htmlFor={`accessory-${accessory.id}`} className="font-normal cursor-pointer">
                                                {accessory.name}
                                            </Label>
                                        </div>
                                        <span className="text-xs text-muted-foreground">{accessory.price} ‚ÇΩ</span>
                                    </div>
                                ))}
                            </div>
                        )}
                    />
                )}
            </div>

            <div>
                <Label htmlFor="notes">–ó–∞–º–µ—Ç–∫–∏ (–≤–∏–¥–Ω–æ —Ç–æ–ª—å–∫–æ –º–µ–Ω–µ–¥–∂–µ—Ä–∞–º/–∞–¥–º–∏–Ω–∞–º)</Label>
                <Textarea id="notes" {...register("notes")} rows={3} />
                {errors.notes && <p className="text-xs text-red-600 mt-1">{errors.notes.message}</p>}
            </div>

            <div>
                <Label htmlFor="last_maintenance">–î–∞—Ç–∞ –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ –¢–û (–≤–∏–¥–Ω–æ —Ç–æ–ª—å–∫–æ –º–µ–Ω–µ–¥–∂–µ—Ä–∞–º/–∞–¥–º–∏–Ω–∞–º)</Label>
                <Input
                    id="last_maintenance"
                    type="date"
                    {...register("last_maintenance")}
                />
                {errors.last_maintenance && <p className="text-xs text-red-600 mt-1">{errors.last_maintenance.message}</p>}
            </div>

            <div className="flex justify-end gap-3 pt-4 border-t mt-6">
                <Button type="button" variant="ghost" onClick={onCancel}>
                    –û—Ç–º–µ–Ω–∞
                </Button>
                <Button type="submit" disabled={!isDirty || !isValid || updateEquipmentMutation.isPending}>
                    {updateEquipmentMutation.isPending ? "–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ..." : "–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è"}
                </Button>
            </div>
        </form>
    );
}

```


## <a name="srccomponentsprofileBalanceHistoryTabletsx"></a>`src/components/profile/BalanceHistoryTable.tsx`

```tsx
// path: src/components/profile/BalanceHistoryTable.tsx

// src/components/profile/BalanceHistoryTable.tsx

import { useState } from "react";
import { useBalanceHistory, useAdminBalanceHistory } from "@/hooks/useBalanceHistory";
import {
    Table,
    TableBody,
    TableCell,
    TableHead,
    TableHeader,
    TableRow,
    TableCaption,
} from "@/components/ui/table";
import { Button } from "@/components/ui/button";
import { formatDateEuropean } from "@/lib/utils";
import { Loader2, AlertTriangle, ChevronLeft, ChevronRight, Inbox } from "lucide-react";

interface Props {
    userId: number;
    // –§–ª–∞–≥, –æ–ø—Ä–µ–¥–µ–ª—è—é—â–∏–π, –∏—Å–ø–æ–ª—å–∑—É–µ–º –ª–∏ –º—ã –∞–¥–º–∏–Ω—Å–∫–∏–π —Ö—É–∫ –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö
    isAdminView?: boolean;
}

export default function BalanceHistoryTable({ userId, isAdminView = false }: Props) {
    const [currentPage, setCurrentPage] = useState(1);

    // –í –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Ñ–ª–∞–≥–∞ isAdminView, –∏—Å–ø–æ–ª—å–∑—É–µ–º —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–∏–π —Ö—É–∫
    const queryResult = isAdminView
        ? useAdminBalanceHistory(userId, currentPage)
        : useBalanceHistory(currentPage);

    const { data: historyResponse, isLoading, isError, error } = queryResult;

    const history = historyResponse?.items ?? [];
    const totalEntries = historyResponse?.total ?? 0;
    const totalPages = Math.ceil(totalEntries / 15); // 15 - PAGE_SIZE –∏–∑ —Ö—É–∫–∞

    if (isLoading) {
        return (
            <div className="flex items-center justify-center gap-2 text-gray-500 py-8">
                <Loader2 className="h-5 w-5 animate-spin" />
                <span>–ó–∞–≥—Ä—É–∑–∫–∞ –∏—Å—Ç–æ—Ä–∏–∏ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π...</span>
            </div>
        );
    }

    if (isError) {
        return (
            <div className="flex items-center justify-center gap-2 text-red-600 bg-red-50 p-4 rounded-md">
                <AlertTriangle className="h-5 w-5" />
                <span>–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏: {error?.message || "–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –¥–∞–Ω–Ω—ã–µ"}</span>
            </div>
        );
    }

    if (history.length === 0) {
        return (
            <div className="text-center py-10 text-gray-500 border-2 border-dashed rounded-lg">
                <Inbox className="mx-auto h-12 w-12 text-gray-300" />
                <p className="mt-2 font-medium">–ò—Å—Ç–æ—Ä–∏—è —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π –ø—É—Å—Ç–∞</p>
                <p className="text-sm">–ó–¥–µ—Å—å –±—É–¥—É—Ç –æ—Ç–æ–±—Ä–∞–∂–∞—Ç—å—Å—è –≤—Å–µ –¥–≤–∏–∂–µ–Ω–∏—è –ø–æ –≤–∞—à–µ–º—É —Å—á–µ—Ç—É.</p>
            </div>
        );
    }

    return (
        <div className="space-y-4">
            <div className="border rounded-lg">
                <Table>
                    <TableCaption>
                        {totalEntries > 0 ? `–ü–æ–∫–∞–∑–∞–Ω–æ ${history.length} –∏–∑ ${totalEntries} –∑–∞–ø–∏—Å–µ–π.` : '–ó–∞–ø–∏—Å–µ–π –Ω–µ –Ω–∞–π–¥–µ–Ω–æ.'}
                    </TableCaption>
                    <TableHeader>
                        <TableRow>
                            <TableHead className="w-[120px]">–î–∞—Ç–∞</TableHead>
                            <TableHead>–¢–∏–ø –æ–ø–µ—Ä–∞—Ü–∏–∏</TableHead>
                            <TableHead>–û–ø–∏—Å–∞–Ω–∏–µ</TableHead>
                            <TableHead className="text-right w-[150px]">–°—É–º–º–∞</TableHead>
                        </TableRow>
                    </TableHeader>
                    <TableBody>
                        {history.map((entry) => {
                            const amountColor = entry.amount < 0 ? 'text-red-600' : 'text-green-600';
                            const amountSign = entry.amount > 0 ? '+' : '';

                            return (
                                <TableRow key={entry.id}>
                                    <TableCell className="font-medium text-xs">
                                        {formatDateEuropean(entry.created_at)}
                                    </TableCell>
                                    <TableCell className="text-xs">{entry.operation_type}</TableCell>
                                    <TableCell className="text-xs">{entry.description}</TableCell>
                                    <TableCell className={`text-right font-semibold ${amountColor}`}>
                                        {amountSign} {entry.amount.toLocaleString('ru-RU', { style: 'currency', currency: 'RUB' })}
                                    </TableCell>
                                </TableRow>
                            );
                        })}
                    </TableBody>
                </Table>
            </div>

            {totalPages > 1 && (
                <div className="flex items-center justify-end space-x-2">
                    <span className="text-sm text-muted-foreground">
                        –°—Ç—Ä–∞–Ω–∏—Ü–∞ {currentPage} –∏–∑ {totalPages}
                    </span>
                    <Button
                        variant="outline"
                        size="sm"
                        onClick={() => setCurrentPage(prev => Math.max(prev - 1, 1))}
                        disabled={currentPage === 1}
                    >
                        <ChevronLeft className="h-4 w-4 mr-1" />
                        –ù–∞–∑–∞–¥
                    </Button>
                    <Button
                        variant="outline"
                        size="sm"
                        onClick={() => setCurrentPage(prev => Math.min(prev + 1, totalPages))}
                        disabled={currentPage === totalPages}
                    >
                        –í–ø–µ—Ä–µ–¥
                        <ChevronRight className="h-4 w-4 ml-1" />
                    </Button>
                </div>
            )}
        </div>
    );
}

```


## <a name="srccomponentsrentalMyRentalCardtsx"></a>`src/components/rental/MyRentalCard.tsx`

```tsx
// path: src/components/rental/MyRentalCard.tsx

// src/components/rental/MyRentalCard.tsx

import { useState } from "react";
import { Card } from "@/components/ui/card";
import { Button } from "@/components/ui/button";
import RentalStatusBadge from "./RentalStatusBadge";
import { CalendarRange, Truck, ExternalLink, ChevronDown, Paperclip, Tag, ReceiptText, Clock, AlertTriangle } from "lucide-react";
import { useNavigate } from "react-router-dom";
import { formatDateEuropean, calculateDaysOverdue } from "@/lib/utils";
import type { AdminRentalOut } from "@/types/rental";
import { RENTAL_CARD_STYLES } from "@/constants/statusStyles";

interface MyRentalCardProps {
    rental: AdminRentalOut;
    highlightId?: number | null;
}

export default function MyRentalCard({ rental, highlightId }: MyRentalCardProps) {
    const navigate = useNavigate();
    const [expandedAccessories, setExpandedAccessories] = useState<Record<number, boolean>>({});
    
    const isHighlighted = highlightId === rental.id;
    
    const toggleAccessories = (equipmentId: number) => {
        setExpandedAccessories(prev => ({
            ...prev,
            [equipmentId]: !prev[equipmentId]
        }));
    };
    
    
    const start = rental.start_date ? new Date(rental.start_date) : null;
    const end = rental.end_date ? new Date(rental.end_date) : null;
    const actualReturn = rental.actual_return_date ? new Date(rental.actual_return_date) : null;

    const handleReservationClick = () => {
        if (rental.reservation_id) {
            navigate("/reservations/my", { 
                state: { 
                    highlightReservationId: rental.reservation_id,
                    from: "rental"
                } 
            });
        }
    };

    // –õ–æ–≥–∏–∫–∞ –¥–ª—è —Å—Ç–∏–ª–∏–∑–∞—Ü–∏–∏ –∫–∞—Ä—Ç–æ—á–∫–∏ –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Å—Ç–∞—Ç—É—Å–∞
    const statusClass = RENTAL_CARD_STYLES[rental.status] || RENTAL_CARD_STYLES.default;

    return (
        <Card 
            className={`p-4 space-y-4 transition-all duration-300 ${statusClass} ${isHighlighted ? "ring-2 ring-orange-500 shadow-lg" : ""}`}
        >
            {/* –ó–∞–≥–æ–ª–æ–≤–æ–∫ —Å ID –∏ —Å—Ç–∞—Ç—É—Å–æ–º */}
            <div className="flex items-center justify-between">
                <div className="flex items-center gap-3">
                    <Truck className="w-5 h-5 text-orange-600" />
                    <h3 className="text-lg font-semibold text-gray-900">
                        –ê—Ä–µ–Ω–¥–∞ #{rental.id}
                    </h3>
                </div>
                <div className="flex items-center gap-2">
                    <RentalStatusBadge status={rental.status} />
                    {/* –°—Å—ã–ª–∫–∞ –Ω–∞ —Ä–µ–∑–µ—Ä–≤ */}
                    {rental.reservation_id && (
                        <Button
                            variant="outline"
                            size="sm"
                            onClick={handleReservationClick}
                            className="text-sky-600 hover:text-sky-700 hover:bg-sky-50 border-sky-200"
                        >
                            <ExternalLink className="w-3 h-3 mr-1" />
                            –†–µ–∑–µ—Ä–≤ #{rental.reservation_id}
                        </Button>
                    )}
                </div>
            </div>

            {/* –î–∞—Ç—ã */}
            <div className="flex items-center gap-2 text-sm text-gray-600">
                <CalendarRange className="w-4 h-4" />
                <span>
                    {start && end && (
                        <>
                            {formatDateEuropean(start)} - {formatDateEuropean(end)}
                        </>
                    )}
                </span>
            </div>

            {/* –§–∞–∫—Ç–∏—á–µ—Å–∫–∞—è –¥–∞—Ç–∞ –≤–æ–∑–≤—Ä–∞—Ç–∞ */}
            {actualReturn && (
                <div className="text-sm text-gray-600">
                    <span className="font-medium">–í–æ–∑–≤—Ä–∞—Ç:</span> {formatDateEuropean(actualReturn)}
                </div>
            )}

            {/* –°–æ—Å—Ç–∞–≤ –∞—Ä–µ–Ω–¥—ã */}
            <div className="space-y-2 pt-3 border-t">
                <h4 className="font-medium text-sm text-gray-800">–°–æ—Å—Ç–∞–≤ –∞—Ä–µ–Ω–¥—ã:</h4>
                <div className="space-y-2">
                    {rental.equipment.map((item) => {
                        const accessoriesForItem = rental.accessory_links?.filter(link => link.equipment_id === item.id);
                        return (
                            <div key={item.id} className="text-sm text-gray-700 bg-gray-50/70 p-2 rounded-md border">
                                <p>‚Ä¢ {item.name}</p>
                                {accessoriesForItem && accessoriesForItem.length > 0 && (
                                    <div className="mt-2 pl-4">
                                        <button onClick={() => toggleAccessories(item.id)} className="flex items-center text-xs text-sky-700 hover:underline font-medium">
                                            <Paperclip className="w-3 h-3 mr-1" />
                                            –ê–∫—Å–µ—Å—Å—É–∞—Ä—ã ({accessoriesForItem.length})
                                            <ChevronDown className={`w-4 h-4 ml-1 transition-transform ${expandedAccessories[item.id] ? 'rotate-180' : ''}`} />
                                        </button>
                                        {expandedAccessories[item.id] && (
                                            <ul className="list-disc list-inside text-xs text-gray-600 mt-1 pl-2 animate-in fade-in duration-200">
                                                {accessoriesForItem.map(link => (
                                                    <li key={link.accessory.id}>{link.accessory.name}</li>
                                                ))}
                                            </ul>
                                        )}
                                    </div>
                                )}
                            </div>
                        );
                    })}
                </div>
            </div>

            {/* –§–∏–Ω–∞–Ω—Å–æ–≤—ã–π –±–ª–æ–∫ —Å —Ç–∞–π–º–µ—Ä–æ–º */}
            <div className="flex items-start justify-between pt-3 border-t flex-wrap-reverse gap-4">
                {/* –§–∏–Ω–∞–Ω—Å–æ–≤—ã–π –±–ª–æ–∫ */}
                <div className="text-xs space-y-1.5 text-slate-700 flex-grow">
                    <h4 className="font-semibold text-sm text-slate-800 flex items-center gap-2 mb-2"><ReceiptText className="w-4 h-4"/>–§–∏–Ω–∞–Ω—Å—ã</h4>
                    <div className="flex justify-between gap-4"><span>–°—Ç–æ–∏–º–æ—Å—Ç—å –∞—Ä–µ–Ω–¥—ã:</span> <span className="font-medium">{rental.total_cost.toLocaleString('ru-RU')} ‚ÇΩ</span></div>
                    {rental.discount_amount > 0 && (
                        <div className="flex justify-between gap-4 text-green-600"><span>–°–∫–∏–¥–∫–∞:</span> <span className="font-medium">- {rental.discount_amount.toLocaleString('ru-RU')} ‚ÇΩ</span></div>
                    )}
                    {rental.promo_code && (
                        <div className="flex justify-between items-center gap-4 text-purple-600"><span>–ü—Ä–æ–º–æ–∫–æ–¥:</span> <span className="font-medium flex items-center gap-1"><Tag className="w-3 h-3"/>{rental.promo_code}</span></div>
                    )}
                    {rental.overdue_surcharge && rental.overdue_surcharge > 0 && (
                        <div className="flex justify-between gap-4 text-red-600 font-bold pt-1 border-t border-dashed mt-1"><span>–î–æ–ø–ª–∞—Ç–∞ –∑–∞ –ø—Ä–æ—Å—Ä–æ—á–∫—É:</span> <span>{rental.overdue_surcharge.toLocaleString('ru-RU')} ‚ÇΩ</span></div>
                    )}
                </div>
                
                {/* –¢–∞–π–º–µ—Ä —Å—Ç–∞—Ç—É—Å–∞ */}
                {(() => {
                    if (rental.status === 'overdue') {
                        const daysOverdue = calculateDaysOverdue(rental.end_date, rental.overdue_days);
                        return (
                            <div className="flex items-center gap-2 px-2 py-1 rounded-md border text-xs font-medium text-red-600 bg-red-100/60 border-red-200">
                                <AlertTriangle className="w-4 h-4"/>
                                {`–ü—Ä–æ—Å—Ä–æ—á–µ–Ω–∞ –Ω–∞ ${daysOverdue} –¥–Ω.`}
                            </div>
                        );
                    }
                    if (rental.status === 'active' && rental.days_remaining !== null) {
                        const daysLeft = rental.days_remaining;
                        if (daysLeft <= 1) {
                            return (
                                <div className="flex items-center gap-2 px-2 py-1 rounded-md border text-xs font-medium text-orange-600 bg-orange-100/60 border-orange-200">
                                    <Clock className="w-4 h-4"/>
                                    {`–û—Å—Ç–∞–ª—Å—è ${daysLeft} –¥–µ–Ω—å`}
                                </div>
                            );
                        }
                        return (
                            <div className="flex items-center gap-2 px-2 py-1 rounded-md border text-xs font-medium text-green-700 bg-green-100/60 border-green-200">
                                <Clock className="w-4 h-4"/>
                                {`–û—Å—Ç–∞–ª–æ—Å—å ${daysLeft} –¥–Ω.`}
                            </div>
                        );
                    }
                    return null;
                })()}
            </div>


            {/* –ó–∞–º–µ—Ç–∫–∏ */}
            {rental.notes_on_issue && (
                <div className="pt-2 border-t">
                    <div className="text-sm">
                        <span className="font-medium text-gray-700">–ó–∞–º–µ—Ç–∫–∏ –ø—Ä–∏ –≤—ã–¥–∞—á–µ:</span>
                        <p className="text-gray-600 mt-1">{rental.notes_on_issue}</p>
                    </div>
                </div>
            )}

            {rental.notes_on_return && (
                <div className="pt-2 border-t">
                    <div className="text-sm">
                        <span className="font-medium text-gray-700">–ó–∞–º–µ—Ç–∫–∏ –ø—Ä–∏ –≤–æ–∑–≤—Ä–∞—Ç–µ:</span>
                        <p className="text-gray-600 mt-1">{rental.notes_on_return}</p>
                    </div>
                </div>
            )}
        </Card>
    );
}


```


## <a name="srccomponentsrentalMyRentalsListtsx"></a>`src/components/rental/MyRentalsList.tsx`

```tsx
// path: src/components/rental/MyRentalsList.tsx

// src/components/rental/MyRentalsList.tsx

import { useMemo } from "react";
import { useMyRentals } from "@/hooks/useMyRentals";
import MyRentalCard from "./MyRentalCard";
import { Button } from "@/components/ui/button";
import { RefreshCw, Truck } from "lucide-react";

interface MyRentalsListProps {
    highlightId?: number | null;
    rentalsData?: any;
}

const LoadingState = () => (
    <div className="text-center py-8">
        <div className="flex items-center justify-center mb-4">
            <RefreshCw className="w-8 h-8 animate-spin text-orange-600" />
        </div>
        <p className="text-gray-600">–ó–∞–≥—Ä—É–∑–∫–∞ –∞—Ä–µ–Ω–¥...</p>
    </div>
);

const ErrorState = ({ message, onRetry }: { message: string; onRetry: () => void }) => (
    <div className="text-center py-8">
        <div className="flex items-center justify-center mb-4">
            <Truck className="w-8 h-8 text-gray-400" />
        </div>
        <p className="text-red-600 mb-4">{message}</p>
        <Button onClick={onRetry} variant="outline" size="sm">
            <RefreshCw className="w-4 h-4 mr-2" />
            –ü–æ–ø—Ä–æ–±–æ–≤–∞—Ç—å —Å–Ω–æ–≤–∞
        </Button>
    </div>
);

const EmptyState = () => (
    <div className="text-center py-12">
        <div className="flex items-center justify-center mb-4">
            <Truck className="w-12 h-12 text-gray-400" />
        </div>
        <h3 className="text-lg font-medium text-gray-900 mb-2">–ù–µ—Ç –∞—Ä–µ–Ω–¥</h3>
        <p className="text-gray-600">
            –£ –≤–∞—Å –ø–æ–∫–∞ –Ω–µ—Ç –∞–∫—Ç–∏–≤–Ω—ã—Ö –∏–ª–∏ –∑–∞–≤–µ—Ä—à–µ–Ω–Ω—ã—Ö –∞—Ä–µ–Ω–¥.
        </p>
    </div>
);

export default function MyRentalsList({ highlightId, rentalsData: propRentalsData }: MyRentalsListProps) {
    const { data, isLoading, isError, error, fetchNextPage, hasNextPage, isFetchingNextPage, refetch } = useMyRentals();

    // –ò—Å–ø–æ–ª—å–∑—É–µ–º –¥–∞–Ω–Ω—ã–µ –∏–∑ –ø—Ä–æ–ø—Å–æ–≤ –∏–ª–∏ –∑–∞–≥—Ä—É–∂–∞–µ–º –∏—Ö —Å–∞–º–æ—Å—Ç–æ—è—Ç–µ–ª—å–Ω–æ
    const allRentals = useMemo(() => {
        if (propRentalsData?.pages) {
            return propRentalsData.pages.flatMap(page => page.items);
        }
        if (data?.pages) {
            return data.pages.flatMap(page => page.items);
        }
        return [];
    }, [propRentalsData, data]);

    if (isLoading) {
        return <LoadingState />;
    }

    if (isError) {
        return (
            <ErrorState 
                message={error?.message || "–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –∞—Ä–µ–Ω–¥"} 
                onRetry={() => refetch()} 
            />
        );
    }

    if (allRentals.length === 0) {
        return <EmptyState />;
    }

    return (
        <div className="space-y-4">
            {/* –°–ø–∏—Å–æ–∫ –∞—Ä–µ–Ω–¥ */}
            <div className="space-y-4">
                {allRentals.map((rental) => (
                    <MyRentalCard 
                        key={rental.id} 
                        rental={rental} 
                        highlightId={highlightId}
                    />
                ))}
            </div>

            {/* –ö–Ω–æ–ø–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã—Ö –∞—Ä–µ–Ω–¥ */}
            {hasNextPage && (
                <div className="text-center pt-4">
                    <Button
                        onClick={() => fetchNextPage()}
                        disabled={isFetchingNextPage}
                        variant="outline"
                        size="sm"
                    >
                        {isFetchingNextPage ? (
                            <>
                                <RefreshCw className="w-4 h-4 mr-2 animate-spin" />
                                –ó–∞–≥—Ä—É–∑–∫–∞...
                            </>
                        ) : (
                            "–ó–∞–≥—Ä—É–∑–∏—Ç—å –µ—â–µ"
                        )}
                    </Button>
                </div>
            )}
        </div>
    );
}


```


## <a name="srccomponentsrentalRentalStatusBadgetsx"></a>`src/components/rental/RentalStatusBadge.tsx`

```tsx
// path: src/components/rental/RentalStatusBadge.tsx

// src/components/rental/RentalStatusBadge.tsx

import { Badge } from "@/components/ui/badge";

type Status = 'active' | 'overdue' | 'completed';

interface Props {
    status: Status;
}

const statusConfig: Record<Status, { text: string; className: string }> = {
    active: {
        text: "–ê–∫—Ç–∏–≤–Ω–∞",
        className: "bg-green-100 text-green-800 border-green-200",
    },
    overdue: {
        text: "–ü—Ä–æ—Å—Ä–æ—á–µ–Ω–∞",
        className: "bg-orange-100 text-orange-800 border-orange-200",
    },
    completed: {
        text: "–ó–∞–≤–µ—Ä—à–µ–Ω–∞",
        className: "bg-gray-100 text-gray-800 border-gray-200",
    },
};

export default function RentalStatusBadge({ status }: Props) {
    const config = statusConfig[status] || statusConfig.completed;

    return (
        <Badge variant="outline" className={`font-medium ${config.className}`}>
            {config.text}
        </Badge>
    );
}


```


## <a name="srccomponentsreservationAvailableAccessoriesDropdowntsx"></a>`src/components/reservation/AvailableAccessoriesDropdown.tsx`

```tsx
// path: src/components/reservation/AvailableAccessoriesDropdown.tsx

// src/components/reservation/AvailableAccessoriesDropdown.tsx

import { useState } from 'react';
import { Paperclip, ChevronDown, PlusCircle } from 'lucide-react';
import { Button } from '@/components/ui/button';
import { Accessory } from '@/types/accessory';

interface Props {
    accessories: Accessory[];
    equipmentId: number;
    onToggleAccessory: (equipmentId: number, accessoryId: number) => void;
    disabled?: boolean;
    hasTopBorder: boolean;
}

export const AvailableAccessoriesDropdown = ({ accessories, equipmentId, onToggleAccessory, disabled, hasTopBorder }: Props) => {
    const [isExpanded, setExpanded] = useState(false);

    if (accessories.length === 0) {
        return null;
    }

    return (
        <div className={`pt-2 mt-2 ${hasTopBorder ? 'border-t border-dashed' : ''}`}>
            <button
                className="w-full flex justify-between items-center text-sm font-medium text-gray-600 hover:text-sky-700 p-1 -m-1 rounded"
                onClick={(e) => { e.stopPropagation(); setExpanded(p => !p); }}
                aria-expanded={isExpanded}
                disabled={disabled}
            >
                <span className="flex items-center gap-2">
                    <Paperclip className="w-4 h-4" />
                    –î–æ–±–∞–≤–∏—Ç—å –∞–∫—Å–µ—Å—Å—É–∞—Ä—ã ({accessories.length})
                </span>
                <ChevronDown className={`w-5 h-5 transition-transform ${isExpanded ? 'rotate-180' : ''}`} />
            </button>
            {isExpanded && (
                <div className="mt-2 space-y-1 pl-1 animate-in fade-in-0 slide-in-from-top-2 duration-300">
                    {accessories.map(acc => (
                        <div key={acc.id} className="flex items-center justify-between p-1 rounded hover:bg-gray-50">
                            <span className="text-xs font-normal">
                                {acc.name} ({acc.price} ‚ÇΩ)
                            </span>
                            <Button
                                size="sm"
                                variant="ghost"
                                className="h-6 px-2 text-xs"
                                onClick={() => onToggleAccessory(equipmentId, acc.id)}
                                disabled={disabled}
                            >
                                <PlusCircle className="w-3.5 h-3.5 mr-1" />
                                –î–æ–±–∞–≤–∏—Ç—å
                            </Button>
                        </div>
                    ))}
                </div>
            )}
        </div>
    );
}

```


## <a name="srccomponentsreservationEditableDateRangetsx"></a>`src/components/reservation/EditableDateRange.tsx`

```tsx
// path: src/components/reservation/EditableDateRange.tsx

// src/components/reservation/EditableDateRange.tsx

import { CalendarRange } from "lucide-react";
import { useDateRange } from "@/hooks/useDateRange";
import { formatDate, formatDateEuropean } from "@/lib/utils";

interface EditableDateRangeProps {
    startDate: Date;
    endDate: Date;
    onChange: (startDate: Date, endDate: Date, source?: 'calendar' | 'slider' | 'manual') => void;
    disabled?: boolean;
}

export default function EditableDateRange({
                                              startDate,
                                              endDate,
                                              onChange,
                                              disabled = false
                                          }: EditableDateRangeProps) {
    const {
        localStartDate,
        localEndDate,
        handleStartDateChange,
        handleEndDateChange
    } = useDateRange({
        // ‚úÖ –ò–°–ü–†–ê–í–õ–ï–ù–û: –ú–µ–Ω—è–µ–º initialStartDate/initialEndDate –Ω–∞ startDate/endDate
        startDate: startDate,
        endDate: endDate,
        onRangeChange: onChange
    });

    const today = formatDate(new Date());

    return (
        <div className="space-y-3">
            <div className="flex items-center gap-2 text-sm font-medium text-gray-700">
                <CalendarRange className="w-4 h-4" />
                –î–∞—Ç—ã —Ä–µ–∑–µ—Ä–≤–∞:
            </div>

            <div className="grid grid-cols-1 sm:grid-cols-2 gap-3">
                <div className="space-y-1">
                    <label htmlFor="edit-start-date" className="block text-xs text-gray-600">
                        –ù–∞—á–∞–ª–æ:
                    </label>
                    <input
                        id="edit-start-date"
                        type="date"
                        value={localStartDate}
                        onChange={handleStartDateChange}
                        disabled={disabled}
                        min={today}
                        className={`w-full px-3 py-2 text-sm border rounded-md focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-colors ${
                            disabled
                                ? 'bg-gray-100 cursor-not-allowed'
                                : 'bg-white hover:border-blue-300'
                        }`}
                    />
                    <div className="text-xs text-gray-500">
                        {formatDateEuropean(new Date(localStartDate))}
                    </div>
                </div>

                <div className="space-y-1">
                    <label htmlFor="edit-end-date" className="block text-xs text-gray-600">
                        –û–∫–æ–Ω—á–∞–Ω–∏–µ:
                    </label>
                    <input
                        id="edit-end-date"
                        type="date"
                        value={localEndDate}
                        onChange={handleEndDateChange}
                        disabled={disabled}
                        min={localStartDate}
                        className={`w-full px-3 py-2 text-sm border rounded-md focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-colors ${
                            disabled
                                ? 'bg-gray-100 cursor-not-allowed'
                                : 'bg-white hover:border-blue-300'
                        }`}
                    />
                    <div className="text-xs text-gray-500">
                        {formatDateEuropean(new Date(localEndDate))}
                    </div>
                </div>
            </div>
        </div>
    );
}

```


## <a name="srccomponentsreservationEditableEquipmentItemtsx"></a>`src/components/reservation/EditableEquipmentItem.tsx`

```tsx
// path: src/components/reservation/EditableEquipmentItem.tsx

// src/components/reservation/EditableEquipmentItem.tsx
import { X } from "lucide-react";
import EquipmentItemWithConflicts from "./EquipmentItemWithConflicts";
import { AvailableAccessoriesDropdown } from "./AvailableAccessoriesDropdown"; // <-- –ù–æ–≤—ã–π –∏–º–ø–æ—Ä—Ç
import type { Equipment } from "@/types/equipment";
import type { AvailabilityInfo } from "@/types/availability";
import { Button } from "@/components/ui/button";

interface Props {
    itemDetail: { id: number; label: string };
    fullEquipmentItem: Equipment | undefined;
    isNew: boolean;
    hasConflict: boolean;
    availability?: AvailabilityInfo;
    selectedAccessoryIds: number[];
    onRemove: (id: number) => void;
    onToggleAccessory: (equipmentId: number, accessoryId: number) => void;
    disabled?: boolean;
}

export default function EditableEquipmentItem({
                                                  itemDetail,
                                                  fullEquipmentItem,
                                                  isNew,
                                                  hasConflict,
                                                  availability,
                                                  selectedAccessoryIds,
                                                  onRemove,
                                                  onToggleAccessory,
                                                  disabled
                                              }: Props) {

    if (!fullEquipmentItem) {
        return <div className="p-3 bg-gray-100 rounded-md text-sm text-red-600">–û—à–∏–±–∫–∞: –¥–∞–Ω–Ω—ã–µ –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—è –Ω–µ –Ω–∞–π–¥–µ–Ω—ã.</div>;
    }

    // –†–∞–∑–¥–µ–ª—è–µ–º –∞–∫—Å–µ—Å—Å—É–∞—Ä—ã –Ω–∞ —É–∂–µ –≤—ã–±—Ä–∞–Ω–Ω—ã–µ –∏ –¥–æ—Å—Ç—É–ø–Ω—ã–µ –¥–ª—è –≤—ã–±–æ—Ä–∞
    const selectedAccessoryDetails = fullEquipmentItem.accessories?.filter(
        acc => selectedAccessoryIds.includes(acc.id)
    ) || [];

    const availableAccessoriesDetails = fullEquipmentItem.accessories?.filter(
        acc => !selectedAccessoryIds.includes(acc.id)
    ) || [];


    return (
        <div className="bg-white p-3 rounded-md border">
            {/* –ë–ª–æ–∫ —Å –æ—Å–Ω–æ–≤–Ω–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–µ–π –æ–± –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏–∏ (–±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π) */}
            <EquipmentItemWithConflicts
                item={itemDetail}
                isNew={isNew}
                hasConflict={hasConflict}
                availability={availability}
                onRemove={onRemove}
                disabled={disabled}
            />

            {/* –ë–ª–æ–∫ –¥–ª—è —É–∂–µ –¥–æ–±–∞–≤–ª–µ–Ω–Ω—ã—Ö –∞–∫—Å–µ—Å—Å—É–∞—Ä–æ–≤ */}
            {selectedAccessoryDetails.length > 0 && (
                <div className="pl-8 pr-2 pt-2 border-t mt-2">
                    <p className="text-xs font-medium text-gray-500 mb-1">–î–æ–±–∞–≤–ª–µ–Ω–Ω—ã–µ –∞–∫—Å–µ—Å—Å—É–∞—Ä—ã:</p>
                    <ul className="space-y-1">
                        {selectedAccessoryDetails.map(acc => (
                            <li key={acc.id} className="flex justify-between items-center text-xs text-gray-800 hover:bg-slate-50 p-1 rounded">
                                <span>- {acc.name} <strong>({acc.price} ‚ÇΩ)</strong></span>
                                <Button
                                    variant="ghost"
                                    size="icon"
                                    className="h-5 w-5 text-gray-400 hover:bg-red-50 hover:text-red-600"
                                    onClick={() => onToggleAccessory(fullEquipmentItem.id, acc.id)}
                                    disabled={disabled}
                                    title="–£–±—Ä–∞—Ç—å –∞–∫—Å–µ—Å—Å—É–∞—Ä"
                                >
                                    <X className="w-3 h-3" />
                                </Button>
                            </li>
                        ))}
                    </ul>
                </div>
            )}

            {/* –í—ã–ø–∞–¥–∞—é—â–∏–π —Å–ø–∏—Å–æ–∫ –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –Ω–æ–≤—ã—Ö –∞–∫—Å–µ—Å—Å—É–∞—Ä–æ–≤ */}
            <AvailableAccessoriesDropdown
                accessories={availableAccessoriesDetails}
                equipmentId={fullEquipmentItem.id}
                onToggleAccessory={onToggleAccessory}
                disabled={disabled}
                hasTopBorder={selectedAccessoryDetails.length > 0}
            />
        </div>
    );
}

```


## <a name="srccomponentsreservationEditableReservationCardtsx"></a>`src/components/reservation/EditableReservationCard.tsx`

```tsx
// path: src/components/reservation/EditableReservationCard.tsx

// src/components/reservation/EditableReservationCard.tsx

import React from "react"; // ‚úÖ –£–±—Ä–∞–ª–∏ –Ω–µ–∏—Å–ø–æ–ª—å–∑—É–µ–º—ã–π useMemo
import { Card } from "@/components/ui/card";
import { Button } from "@/components/ui/button";
import { Badge } from "@/components/ui/badge";
import { Loader2, Plus, Save, X, AlertTriangle, Sparkles } from "lucide-react";
import EditableDateRange from "./EditableDateRange";
import FinancialSummaryBlock from "@/components/shared/FinancialSummaryBlock";
import EditableEquipmentItem from "./EditableEquipmentItem";
import { useReservationEditContext } from "@/contexts/ReservationEditContext";
import { useNavigate } from "react-router-dom";
import HolidayConfirmationDialog from "./HolidayConfirmationDialog";
import { formatDateEuropean } from "@/lib/utils"; // ‚úÖ –î–æ–±–∞–≤–∏–ª–∏ –Ω–µ–¥–æ—Å—Ç–∞—é—â–∏–π –∏–º–ø–æ—Ä—Ç

export default function EditableReservationCard() {
    const {
        reservationId,
        editState,
        availabilityMap,
        equipmentMap,
        hasConflicts,
        saveChanges,
        cancelEdit,
        updateDates,
        removeEquipmentItem,
        isLoading,
        isCheckingAvailability,
        isSaving,
        localSelectedAccessories,
        toggleAccessory,
        holidayConflict,
        confirmHolidayAdjustment,
        cancelHolidayAdjustment,
        priceDetails,
        financials,
        setPromoCode,
        applyPromoCode,
        removePromoCode,
    } = useReservationEditContext();

    const navigate = useNavigate();

    const displayNewItemsCount = editState.newlyAddedEquipmentIdsAsArray.length;
    const equipmentToDisplay = editState.currentEquipmentDetails;
    const totalItemsInEdit = equipmentToDisplay.length;

    const onAddEquipment = () => {
        navigate("/", {
            state: {
                intent: "add_to_reservation",
                reservationId: reservationId,
                equipmentIds: editState.currentEquipmentDetails.map(eq => eq.id),
                startDate: editState.startDate.toISOString(),
                endDate: editState.endDate.toISOString(),
            }
        });
    };

    return (
        <>
            <Card className="w-full px-5 py-4 rounded-2xl border shadow-md bg-blue-50 border-blue-300 transition-all">
                <div className="space-y-4">
                    <div className="flex justify-between items-center">
                        <div className="flex items-center gap-2">
                            <div className="text-base font-semibold text-blue-700">
                                ‚úèÔ∏è –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Ä–µ–∑–µ—Ä–≤–∞ #{reservationId}
                            </div>
                            {isCheckingAvailability && (
                                <div className="flex items-center gap-1 text-xs text-blue-600">
                                    <Loader2 className="w-3 h-3 animate-spin" />
                                    –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏...
                                </div>
                            )}
                        </div>
                        <div className="flex items-center gap-2">
                            <Badge variant="outline" className="bg-blue-100 text-blue-700 border-blue-300">
                                –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ
                            </Badge>
                            {displayNewItemsCount > 0 && (
                                <Badge variant="outline" className="bg-green-100 text-green-700 border-green-300">
                                    <Sparkles className="w-3 h-3 mr-1" />
                                    +{displayNewItemsCount} –Ω–æ–≤—ã—Ö
                                </Badge>
                            )}
                        </div>
                    </div>

                    <div className="grid grid-cols-1 md:grid-cols-3 gap-6">
                        <div className="md:col-span-2 space-y-4">
                            {hasConflicts && (
                                <div className="flex items-start gap-2 p-3 bg-red-50 border border-red-200 rounded-md">
                                    <AlertTriangle className="w-4 h-4 text-red-600 mt-0.5 flex-shrink-0" />
                                    <div className="text-sm text-red-700">
                                        <div className="font-medium">–û–±–Ω–∞—Ä—É–∂–µ–Ω—ã –∫–æ–Ω—Ñ–ª–∏–∫—Ç—ã!</div>
                                        <div className="text-xs mt-1">
                                            –ù–µ–∫–æ—Ç–æ—Ä–æ–µ –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏–µ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–æ –Ω–∞ –≤—ã–±—Ä–∞–Ω–Ω—ã–µ –¥–∞—Ç—ã.
                                            –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –∏—Å–ø—Ä–∞–≤—å—Ç–µ –∫–æ–Ω—Ñ–ª–∏–∫—Ç—ã –ø–µ—Ä–µ–¥ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ–º.
                                        </div>
                                    </div>
                                </div>
                            )}

                            <EditableDateRange
                                startDate={editState.startDate}
                                endDate={editState.endDate}
                                onChange={updateDates}
                                disabled={isLoading}
                            />

                            <div className="space-y-3">
                                <div className="flex justify-between items-center">
                                    <div className="text-sm font-medium text-gray-700">
                                        –û–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏–µ ({totalItemsInEdit} –ø–æ–∑.
                                        {displayNewItemsCount > 0 && (
                                            <span className="text-green-600">
                                                , –∏–∑ –Ω–∏—Ö {displayNewItemsCount} –Ω–æ–≤—ã—Ö
                                            </span>
                                        )}
                                        ):
                                    </div>
                                    <Button
                                        variant="outline"
                                        size="sm"
                                        onClick={onAddEquipment}
                                        disabled={isLoading}
                                        className="text-xs px-3 py-1 h-7"
                                    >
                                        <Plus className="w-3 h-3 mr-1" />
                                        –î–æ–±–∞–≤–∏—Ç—å
                                    </Button>
                                </div>
                                {totalItemsInEdit === 0 ? (
                                    <div className="text-sm text-gray-500 text-center py-6 border border-dashed border-gray-300 rounded-md">
                                        –ù–µ—Ç –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—è –≤ —Ä–µ–∑–µ—Ä–≤–µ.{" "}
                                        <button
                                            onClick={onAddEquipment}
                                            disabled={isLoading}
                                            className="text-blue-600 hover:underline"
                                        >
                                            –î–æ–±–∞–≤–∏—Ç—å –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏–µ
                                        </button>
                                    </div>
                                ) : (
                                    <div className="space-y-2">
                                        {equipmentToDisplay.map((itemDetail) => {
                                            const availability = availabilityMap[itemDetail.id];
                                            const itemHasConflict = !!availability && (
                                                availability.status === "reserved" || availability.status === "rented"
                                            );
                                            const isNew = editState.newlyAddedEquipmentIdsAsArray.includes(itemDetail.id);

                                            return (
                                                <EditableEquipmentItem
                                                    key={itemDetail.id}
                                                    itemDetail={itemDetail}
                                                    fullEquipmentItem={equipmentMap.get(itemDetail.id)}
                                                    isNew={isNew}
                                                    hasConflict={itemHasConflict}
                                                    availability={availability}
                                                    selectedAccessoryIds={localSelectedAccessories[itemDetail.id] || []}
                                                    onRemove={() => removeEquipmentItem(itemDetail.id)}
                                                    onToggleAccessory={toggleAccessory}
                                                    disabled={isLoading}
                                                />
                                            );
                                        })}
                                    </div>
                                )}
                            </div>
                        </div>

                        <div className="md:col-span-1">
                            <FinancialSummaryBlock
                                priceDetails={priceDetails}
                                promoCode={financials.promoCode}
                                setPromoCode={setPromoCode}
                                applyPromoCode={applyPromoCode}
                                removePromoCode={removePromoCode}
                                promoCodeMessage={financials.promoCodeMessage}
                                isLoading={isCheckingAvailability}
                                hasConflicts={hasConflicts}
                                variant="inline"
                                showActions={false}
                            />
                        </div>
                    </div>

                    <div className="flex flex-col sm:flex-row justify-end items-center gap-3 pt-4 border-t border-blue-200 mt-4">
                        <Button
                            variant="ghost"
                            onClick={cancelEdit}
                            disabled={isLoading}
                            className="text-sm mr-auto"
                        >
                            <X className="w-4 h-4 mr-1" />
                            –û—Ç–º–µ–Ω–∞
                        </Button>
                        <Button
                            onClick={() => saveChanges()}
                            disabled={!editState.hasChanges || hasConflicts || isLoading || totalItemsInEdit === 0}
                            className="text-sm min-w-[120px]"
                        >
                            {isSaving ? (
                                <>
                                    <Loader2 className="w-4 h-4 mr-1 animate-spin" />
                                    –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ...
                                </>
                            ) : (
                                <>
                                    <Save className="w-4 h-4 mr-1" />
                                    –°–æ—Ö—Ä–∞–Ω–∏—Ç—å
                                </>
                            )}
                        </Button>
                    </div>

                    <div className="text-xs text-gray-500 bg-gray-50 border border-gray-200 rounded p-2 space-y-1 mt-4">
                        <div>üí° –ü–æ–¥—Å–∫–∞–∑–∫–∏:</div>
                        <ul className="space-y-0.5 ml-3">
                            <li>‚Ä¢ –ó–µ–ª–µ–Ω—ã–º –æ—Ç–º–µ—á–µ–Ω—ã –Ω–æ–≤—ã–µ –ø–æ–∑–∏—Ü–∏–∏, –¥–æ–±–∞–≤–ª–µ–Ω–Ω—ã–µ –ø—Ä–∏ —Ç–µ–∫—É—â–µ–º —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–∏.</li>
                            <li>‚Ä¢ –ñ–µ–ª—Ç—ã–º/–∫—Ä–∞—Å–Ω—ã–º –æ—Ç–º–µ—á–µ–Ω—ã –∫–æ–Ω—Ñ–ª–∏–∫—Ç—ã —Å –¥—Ä—É–≥–∏–º–∏ —Ä–µ–∑–µ—Ä–≤–∞–º–∏.</li>
                            <li>‚Ä¢ –ù–∞–∂–º–∏—Ç–µ "–î–æ–±–∞–≤–∏—Ç—å –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏–µ" –¥–ª—è –≤—ã–±–æ—Ä–∞ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã—Ö –ø–æ–∑–∏—Ü–∏–π.</li>
                            <li>‚Ä¢ –ö–Ω–æ–ø–∫–∞ "–°–æ—Ö—Ä–∞–Ω–∏—Ç—å" –∞–∫—Ç–∏–≤–Ω–∞ —Ç–æ–ª—å–∫–æ –ø—Ä–∏ –Ω–∞–ª–∏—á–∏–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–π –∏ –æ—Ç—Å—É—Ç—Å—Ç–≤–∏–∏ –∫–æ–Ω—Ñ–ª–∏–∫—Ç–æ–≤.</li>
                            <li>‚Ä¢ –ü–æ—Å–ª–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –Ω–æ–≤—ã–µ –ø–æ–∑–∏—Ü–∏–∏ —Å—Ç–∞–Ω—É—Ç –æ–±—ã—á–Ω—ã–º–∏ —á–∞—Å—Ç—è–º–∏ —Ä–µ–∑–µ—Ä–≤–∞.</li>
                        </ul>
                    </div>
                </div>
            </Card>

            <HolidayConfirmationDialog
                open={!!holidayConflict}
                message={holidayConflict?.message || ""}
                suggestedDate={holidayConflict ? formatDateEuropean(new Date(holidayConflict.suggested_end_date)) : ""}
                onConfirm={confirmHolidayAdjustment}
                onCancel={cancelHolidayAdjustment}
                isConfirming={isSaving}
            />
        </>
    );
}

```


## <a name="srccomponentsreservationEquipmentItemWithConflictstsx"></a>`src/components/reservation/EquipmentItemWithConflicts.tsx`

```tsx
// path: src/components/reservation/EquipmentItemWithConflicts.tsx

// src/components/reservation/EquipmentItemWithConflicts.tsx
import { Button } from "@/components/ui/button";
import { MinusCircle, AlertTriangle, CheckCircle, Sparkles } from "lucide-react";
import { formatDateRangeEuropean } from "@/lib/utils";
import type { AvailabilityInfo } from "@/types/availability";

interface EquipmentItemWithConflictsProps {
    item: { id: number; label: string };
    isNew: boolean;
    hasConflict: boolean;
    availability?: AvailabilityInfo;
    onRemove?: (id: number) => void;
    disabled?: boolean;
}

export default function EquipmentItemWithConflicts({
                                                       item,
                                                       isNew,
                                                       hasConflict,
                                                       availability,
                                                       onRemove,
                                                       disabled = false
                                                   }: EquipmentItemWithConflictsProps) {

    const getStatusInfo = () => {
        if (hasConflict && availability) {
            const dateRange = availability.start_date && availability.end_date
                ? formatDateRangeEuropean(availability.start_date, availability.end_date)
                : "";

            if (availability.status === "reserved") {
                return {
                    icon: <AlertTriangle className="w-4 h-4" />,
                    color: "text-yellow-600",
                    bgColor: "bg-yellow-50 border-yellow-200",
                    status: "–ó–∞—Ä–µ–∑–µ—Ä–≤–∏—Ä–æ–≤–∞–Ω–æ",
                    dateText: dateRange
                };
            } else if (availability.status === "rented") {
                return {
                    icon: <AlertTriangle className="w-4 h-4" />,
                    color: "text-red-600",
                    bgColor: "bg-red-50 border-red-200",
                    status: "–í –∞—Ä–µ–Ω–¥–µ",
                    dateText: dateRange
                };
            }
        }

        if (isNew) {
            return {
                icon: <Sparkles className="w-4 h-4" />,
                color: "text-green-600",
                bgColor: "bg-green-50 border-green-200",
                status: "–ù–æ–≤–∞—è –ø–æ–∑–∏—Ü–∏—è",
                dateText: ""
            };
        }

        return {
            icon: <CheckCircle className="w-4 h-4" />,
            color: "text-gray-600",
            bgColor: "bg-gray-50 border-gray-200",
            status: "–î–æ—Å—Ç—É–ø–Ω–æ",
            dateText: ""
        };
    };

    const statusInfo = getStatusInfo();

    return (
        <div className={`flex justify-between items-start p-3 rounded-md border transition-colors ${statusInfo.bgColor}`}>
            <div className="flex-1 min-w-0">
                <div className="flex items-start gap-2">
                    <div className={`flex-shrink-0 mt-0.5 ${statusInfo.color}`}>
                        {statusInfo.icon}
                    </div>

                    <div className="flex-1 min-w-0">
                        <div className="text-sm font-medium text-gray-900 truncate">
                            {item.label}
                        </div>

                        <div className={`text-xs ${statusInfo.color} mt-1`}>
                            {statusInfo.status}
                            {statusInfo.dateText && (
                                <span className="ml-1 font-normal">
                  ({statusInfo.dateText})
                </span>
                            )}
                        </div>

                        {hasConflict && (
                            <div className="text-xs text-red-600 mt-1 font-medium">
                                ‚ö†Ô∏è –ö–æ–Ω—Ñ–ª–∏–∫—Ç: –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏–µ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–æ –Ω–∞ –≤—ã–±—Ä–∞–Ω–Ω—ã–µ –¥–∞—Ç—ã
                            </div>
                        )}
                    </div>
                </div>
            </div>

            {onRemove && (
                <Button
                    variant="ghost"
                    size="icon"
                    onClick={() => onRemove(item.id)}
                    disabled={disabled}
                    className={`ml-2 h-8 w-8 flex-shrink-0 hover:text-red-700 ${
                        disabled
                            ? "text-gray-400 cursor-not-allowed"
                            : hasConflict
                                ? "text-red-500 hover:bg-red-100"
                                : "text-gray-500 hover:bg-gray-100"
                    }`}
                    title="–£–¥–∞–ª–∏—Ç—å –∏–∑ —Ä–µ–∑–µ—Ä–≤–∞"
                >
                    <MinusCircle className="w-4 h-4" />
                </Button>
            )}
        </div>
    );
}

```


## <a name="srccomponentsreservationHolidayConfirmationDialogtsx"></a>`src/components/reservation/HolidayConfirmationDialog.tsx`

```tsx
// path: src/components/reservation/HolidayConfirmationDialog.tsx

// src/components/reservation/HolidayConfirmationDialog.tsx
import {
    Dialog,
    DialogContent,
    DialogHeader,
    DialogTitle,
    DialogDescription,
    DialogFooter,
} from "@/components/ui/dialog";
import { Button } from "@/components/ui/button";
import { AlertTriangle } from "lucide-react";

type Props = {
    open: boolean;
    message: string;
    suggestedDate: string;
    onConfirm: () => void;
    onCancel: () => void;
    isConfirming: boolean;
};

export default function HolidayConfirmationDialog({
                                                      open,
                                                      message,
                                                      suggestedDate,
                                                      onConfirm,
                                                      onCancel,
                                                      isConfirming,
                                                  }: Props) {
    return (
        <Dialog open={open} onOpenChange={onCancel}>
            <DialogContent>
                <DialogHeader>
                    <DialogTitle className="flex items-center gap-2">
                        <AlertTriangle className="text-amber-500" />
                        –î–∞—Ç–∞ –æ–∫–æ–Ω—á–∞–Ω–∏—è - –≤—ã—Ö–æ–¥–Ω–æ–π
                    </DialogTitle>
                </DialogHeader>
                <DialogDescription>
                    <p>{message}</p>
                    <p className="mt-2">
                        –í—ã —Ö–æ—Ç–∏—Ç–µ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∏–∑–º–µ–Ω–∏—Ç—å –¥–∞—Ç—É –æ–∫–æ–Ω—á–∞–Ω–∏—è –Ω–∞ –±–ª–∏–∂–∞–π—à–∏–π —Ä–∞–±–æ—á–∏–π –¥–µ–Ω—å:
                        <strong className="text-gray-800"> {suggestedDate}</strong>?
                    </p>
                </DialogDescription>
                <DialogFooter className="pt-4">
                    <Button variant="ghost" onClick={onCancel} disabled={isConfirming}>
                        –ù–µ—Ç, —è –≤—ã–±–µ—Ä—É –¥—Ä—É–≥—É—é –¥–∞—Ç—É
                    </Button>
                    <Button
                        onClick={onConfirm}
                        disabled={isConfirming}
                    >
                        {isConfirming ? "–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ..." : "–î–∞, –∏–∑–º–µ–Ω–∏—Ç—å"}
                    </Button>
                </DialogFooter>
            </DialogContent>
        </Dialog>
    );
}

```


## <a name="srccomponentsreservationReservationItemsListtsx"></a>`src/components/reservation/ReservationItemsList.tsx`

```tsx
// path: src/components/reservation/ReservationItemsList.tsx

// src/components/reservation/ReservationItemsList.tsx
import ReserveEquipmentCard from "@/components/ReserveEquipmentCard";
import { Button } from "@/components/ui/button";
import { Paperclip, X } from "lucide-react";
import type { Equipment } from "@/types/equipment";
import type { AvailabilityInfo } from "@/types/availability";

interface Props {
    items: Equipment[];
    selectedAccessories: Record<number, number[]>;
    availabilityMap: Record<number, AvailabilityInfo>;
    unavailableIdsFromAPI: number[];
    invalidItems: number[];
    onRemoveItem: (id: number) => void;
    onRemoveAccessory: (equipmentId: number, accessoryId: number) => void;
    // ‚úÖ –î–û–ë–ê–í–õ–ï–ù–´ –ù–û–í–´–ï –°–í–û–ô–°–¢–í–ê
    isAccessorySelected: (equipmentId: number, accessoryId: number) => boolean;
    onToggleAccessory: (equipmentId: number, accessoryId: number) => void;
}

export default function ReservationItemsList({
                                                 items,
                                                 selectedAccessories,
                                                 availabilityMap,
                                                 unavailableIdsFromAPI,
                                                 invalidItems,
                                                 onRemoveItem,
                                                 onRemoveAccessory,
                                                 // ‚úÖ –ü–û–õ–£–ß–ê–ï–ú –ù–û–í–´–ï –°–í–û–ô–°–¢–í–ê
                                                 isAccessorySelected,
                                                 onToggleAccessory,
                                             }: Props) {
    return (
        <div className="space-y-4 pt-4">
            {items.map((item) => {
                const selectedAccessoryIds = selectedAccessories[item.id] || [];
                const selectedAccessoryDetails = item.accessories?.filter(acc =>
                    selectedAccessoryIds.includes(acc.id)
                ) || [];

                return (
                    <div
                        key={item.id}
                        className={`border rounded-lg overflow-hidden shadow-sm transition-all ${
                            unavailableIdsFromAPI.includes(item.id) || invalidItems.includes(item.id)
                                ? "border-red-400 bg-red-50"
                                : "border-gray-200 bg-white"
                        }`}
                    >
                        <ReserveEquipmentCard
                            equipment={item}
                            availability={availabilityMap[item.id]}
                            onRemove={() => onRemoveItem(item.id)}
                            // ‚úÖ –ü–ï–†–ï–î–ê–ï–ú –§–£–ù–ö–¶–ò–ò –í –ö–ê–†–¢–û–ß–ö–£
                            isAccessorySelected={isAccessorySelected}
                            onToggleAccessory={onToggleAccessory}
                        />

                        {selectedAccessoryDetails.length > 0 && (
                            <div className="px-4 pb-3 pt-2 bg-slate-50 border-t border-dashed">
                                <h4 className="flex items-center gap-1.5 text-xs font-semibold text-gray-600 mb-2">
                                    <Paperclip className="h-3.5 w-3.5" />
                                    –î–æ–ø. –∞–∫—Å–µ—Å—Å—É–∞—Ä—ã:
                                </h4>
                                <ul className="space-y-1.5">
                                    {selectedAccessoryDetails.map(acc => (
                                        <li key={acc.id} className="flex items-center justify-between text-xs hover:bg-slate-100 p-1 rounded-md">
                                            <span className="text-gray-800">{acc.name}</span>
                                            <div className="flex items-center gap-2">
                                                <span className="text-gray-500 font-medium">{acc.price} ‚ÇΩ</span>
                                                <Button
                                                    variant="ghost"
                                                    size="icon"
                                                    className="h-5 w-5 text-gray-400 hover:text-red-500 hover:bg-red-50"
                                                    onClick={() => onRemoveAccessory(item.id, acc.id)}
                                                    title="–£–¥–∞–ª–∏—Ç—å –∞–∫—Å–µ—Å—Å—É–∞—Ä"
                                                >
                                                    <X className="h-3 w-3" />
                                                </Button>
                                            </div>
                                        </li>
                                    ))}
                                </ul>
                            </div>
                        )}

                        {(unavailableIdsFromAPI.includes(item.id) || invalidItems.includes(item.id)) && (
                            <p className="text-sm text-red-600 px-4 pb-2 pt-0">
                                –≠—Ç–æ –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏–µ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–æ –Ω–∞ –≤—ã–±—Ä–∞–Ω–Ω—ã–µ –¥–∞—Ç—ã.
                            </p>
                        )}
                    </div>
                )
            })}
        </div>
    );
}

```


## <a name="srccomponentsreservationReservationStatusBadgetsx"></a>`src/components/reservation/ReservationStatusBadge.tsx`

```tsx
// path: src/components/reservation/ReservationStatusBadge.tsx

// src/components/reservation/ReservationStatusBadge.tsx

import { Badge } from "@/components/ui/badge";
import type { Reservation } from "@/types/reservation";

type Status = Reservation['status'];

interface Props {
    status: Status;
}

const statusConfig: Record<Status, { text: string; className: string }> = {
    active: {
        text: "–ê–∫—Ç–∏–≤–µ–Ω",
        className: "bg-green-100 text-green-800 border-green-200",
    },
    fulfilled: {
        text: "–í—ã–¥–∞–Ω –≤ –∞—Ä–µ–Ω–¥—É",
        className: "bg-blue-100 text-blue-800 border-blue-200",
    },
    cancelled: {
        text: "–û—Ç–º–µ–Ω–µ–Ω",
        className: "bg-gray-100 text-gray-800 border-gray-200",
    },
    overdue: {
        text: "–ü—Ä–æ—Å—Ä–æ—á–µ–Ω",
        className: "bg-orange-100 text-orange-800 border-orange-200",
    },
};

export default function ReservationStatusBadge({ status }: Props) {
    const config = statusConfig[status] || statusConfig.cancelled;

    return (
        <Badge variant="outline" className={`font-medium ${config.className}`}>
            {config.text}
        </Badge>
    );
}


```


## <a name="srccomponentsreservationViewReservationCardtsx"></a>`src/components/reservation/ViewReservationCard.tsx`

```tsx
// path: src/components/reservation/ViewReservationCard.tsx

// src/components/reservation/ViewReservationCard.tsx

import { Button } from "@/components/ui/button";
import { Card } from "@/components/ui/card";
import ReservationStatusBadge from "./ReservationStatusBadge";
import { MinusCircle, CalendarRange, Edit2, RotateCcw, Trash2, ExternalLink } from "lucide-react";
import { useNavigate, useLocation } from "react-router-dom";
import { formatDateEuropean } from "@/lib/utils";
import type { Reservation, AccessoryLink } from "@/types/reservation";
import { useState } from "react";
import EquipmentWithAccessoriesList from "@/components/shared/EquipmentWithAccessoriesList";
import FinancialInfoBlock from "@/components/shared/FinancialInfoBlock";
import { RESERVATION_CARD_STYLES } from "@/constants/statusStyles";

interface ViewReservationCardProps {
    id: number;
    equipment: { id: number; label: string }[];
    start_date: string;
    end_date: string;
    status: Reservation['status'];
    onEdit?: () => void;
    onCancel?: () => void;
    onRemoveItem?: (equipmentId: number) => void;
    onRepeat?: () => void;
    cancelDisabled?: boolean;
    total_cost?: number;
    discount_amount?: number;
    promo_code?: string | null;
    rental_id?: number | null;
    accessory_links?: AccessoryLink[];
}

export default function ViewReservationCard(props: ViewReservationCardProps) {
    const {
        id,
        equipment,
        start_date,
        end_date,
        status,
        onEdit,
        onCancel,
        onRemoveItem,
        onRepeat,
        cancelDisabled,
        total_cost,
        discount_amount,
        promo_code,
        rental_id,
        accessory_links,
    } = props;

    const navigate = useNavigate();
    const location = useLocation();

    const start = start_date ? new Date(start_date) : null;
    const end = end_date ? new Date(end_date) : null;

    const now = new Date();
    const isPast = !!end && end < now;

    const msPerDay = 1000 * 60 * 60 * 24;
    const daysUntilStart = start ? Math.ceil((start.getTime() - now.getTime()) / msPerDay) : null;
    const daysUntilEnd = end ? Math.floor((end.getTime() - now.getTime()) / msPerDay) : null;

    const isProtected = !isPast && daysUntilEnd !== null && daysUntilEnd < 2;
    const isActionable = status === 'active';
    const canBeRepeated = status === 'fulfilled' || status === 'cancelled';
    const cardColor = RESERVATION_CARD_STYLES[status] || RESERVATION_CARD_STYLES.default;

    const getStatusInfo = () => {
        if (isPast) {
            return {
                showMessage: false,
                message: "",
                className: ""
            };
        }

        if (daysUntilStart !== null) {
            if (daysUntilStart <= 0) {
                return {
                    showMessage: true,
                    message: "–†–µ–∑–µ—Ä–≤ —É–∂–µ –Ω–∞—á–∞–ª—Å—è",
                    className: "text-green-600"
                };
            } else if (daysUntilStart <= 3) {
                return {
                    showMessage: true,
                    message: `–î–æ –Ω–∞—á–∞–ª–∞ —Ä–µ–∑–µ—Ä–≤–∞: ${daysUntilStart} –¥–Ω.`,
                    className: "text-orange-600 font-medium"
                };
            } else {
                return {
                    showMessage: true,
                    message: `–î–æ –Ω–∞—á–∞–ª–∞ —Ä–µ–∑–µ—Ä–≤–∞: ${daysUntilStart} –¥–Ω.`,
                    className: "text-gray-600"
                };
            }
        }

        return {
            showMessage: false,
            message: "",
            className: ""
        };
    };

    const statusInfo = getStatusInfo();

    const handleRentalClick = () => {
        if (rental_id) {
            navigate("/reservations/my", {
                state: {
                    highlightRentalId: rental_id,
                    from: "reservation"
                }
            });
        }
    };

    return (
        <Card className={`w-full px-5 py-4 rounded-2xl border shadow-sm hover:shadow-md transition-all ${cardColor}`}>
            <div className="space-y-3">
                <div className="flex justify-between items-center">
                    <div className="text-base font-semibold text-sky-700">–†–µ–∑–µ—Ä–≤ #{id}</div>
                    <div className="flex items-center gap-2">
                        <ReservationStatusBadge status={status} />
                        {rental_id && status === 'fulfilled' && (
                            <Button
                                variant="outline"
                                size="sm"
                                onClick={handleRentalClick}
                                className="text-orange-600 hover:text-orange-700 hover:bg-orange-50 border-orange-200"
                            >
                                <ExternalLink className="w-3 h-3 mr-1" />
                                –ê—Ä–µ–Ω–¥–∞ #{rental_id}
                            </Button>
                        )}
                    </div>
                </div>

                <div className="flex flex-col sm:flex-row sm:justify-between sm:items-center gap-2 pt-2 border-t border-dashed">
                    {start && end ? (
                        <div className="flex items-center gap-2 text-sm">
                            <CalendarRange className="w-4 h-4 text-gray-500 flex-shrink-0" />
                            <span>{formatDateEuropean(start)} ‚Äî {formatDateEuropean(end)}</span>
                        </div>
                    ) : (
                        <p className="text-red-600 text-sm">–û—à–∏–±–∫–∞ –≤ –¥–∞—Ç–µ —Ä–µ–∑–µ—Ä–≤–∞</p>
                    )}

                    <FinancialInfoBlock
                        totalCost={total_cost}
                        discountAmount={discount_amount}
                        promoCode={promo_code}
                        variant="default"
                        className="justify-start sm:justify-end"
                    />
                </div>

                {statusInfo.showMessage && status === 'active' && (
                    <div className="flex items-center gap-2 text-sm">
                        <div className={`px-2 py-1 rounded-md text-xs ${statusInfo.className} bg-opacity-10`}>
                            {statusInfo.message}
                        </div>
                    </div>
                )}

                {/* –°–æ—Å—Ç–∞–≤ —Ä–µ–∑–µ—Ä–≤–∞ */}
                <EquipmentWithAccessoriesList
                    equipment={equipment.map(item => ({ id: item.id, name: item.label }))}
                    accessoryLinks={accessory_links || []}
                    title="–°–æ—Å—Ç–∞–≤ —Ä–µ–∑–µ—Ä–≤–∞:"
                    showTitle={true}
                    className="pt-2 border-t"
                    showRemoveButton={isActionable && !!onRemoveItem}
                    onRemoveItem={onRemoveItem}
                    isRemoveDisabled={isProtected}
                    removeButtonTitle={isProtected ? "–£–¥–∞–ª–µ–Ω–∏–µ —á–µ—Ä–µ–∑ –º–µ–Ω–µ–¥–∂–µ—Ä–∞" : "–£–¥–∞–ª–∏—Ç—å –∏–∑ —Ä–µ–∑–µ—Ä–≤–∞"}
                />

                {canBeRepeated && onRepeat ? (
                    <div className="flex justify-end pt-2 border-t border-gray-200">
                        <Button variant="outline" size="sm" onClick={onRepeat}>
                            <RotateCcw className="w-4 h-4 mr-1" />
                            –ü–æ–≤—Ç–æ—Ä–∏—Ç—å —Ä–µ–∑–µ—Ä–≤
                        </Button>
                    </div>
                ) : (
                    <div className="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-2 pt-2 border-t border-gray-200">
                        {isProtected ? (
                            <div className="flex flex-col gap-2">
                                <p className="text-sm font-medium text-rose-700">
                                    –û—Ç–º–µ–Ω–∞ –∏ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Ç–æ–ª—å–∫–æ —á–µ—Ä–µ–∑ –º–µ–Ω–µ–¥–∂–µ—Ä–∞
                                </p>
                                <Button
                                    variant="outline"
                                    size="sm"
                                    onClick={() => navigate("/contacts", { state: { from: location.pathname } })}
                                >
                                    –ù–∞–ø–∏—Å–∞—Ç—å –º–µ–Ω–µ–¥–∂–µ—Ä—É
                                </Button>
                            </div>
                        ) : (
                            <div className="text-sm text-gray-600">
                                {daysUntilEnd !== null && daysUntilEnd >= 0 && (
                                    <span>–î–æ –æ–∫–æ–Ω—á–∞–Ω–∏—è: {daysUntilEnd} –¥–Ω.</span>
                                )}
                            </div>
                        )}

                        <div className="flex gap-2 justify-end w-full sm:w-auto">
                            {isActionable && onEdit && !isProtected && (
                                <Button variant="secondary" size="sm" onClick={onEdit}>
                                    <Edit2 className="w-4 h-4 mr-1" />
                                    –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å
                                </Button>
                            )}
                            {isActionable && onCancel && !isProtected && (
                                <Button
                                    variant="destructive"
                                    size="sm"
                                    disabled={cancelDisabled}
                                    onClick={onCancel}
                                >
                                    <Trash2 className="w-4 h-4 mr-1" />
                                    {cancelDisabled ? "–û—Ç–º–µ–Ω–∞..." : "–û—Ç–º–µ–Ω–∏—Ç—å"}
                                </Button>
                            )}
                        </div>
                    </div>
                )}
            </div>
        </Card>
    );
}

```


## <a name="srccomponentssessionUserSessiontsx"></a>`src/components/session/UserSession.tsx`

```tsx
// path: src/components/session/UserSession.tsx

// src/components/session/UserSession.tsx

import AuthForm from "@/components/AuthForm";
import UserInfoBlock from "@/components/UserInfoBlock";
import { useCurrentUser } from "@/hooks/useProfile";

/**
 * –ö–æ–º–ø–æ–Ω–µ–Ω—Ç –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–æ–π —Å–µ—Å—Å–∏–µ–π.
 * –û—Ç–æ–±—Ä–∞–∂–∞–µ—Ç —Ñ–æ—Ä–º—É –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ –¥–ª—è –≥–æ—Å—Ç–µ–π –∏–ª–∏ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ –¥–ª—è –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω–Ω—ã—Ö.
 */
export default function UserSession() {
    const { data: user } = useCurrentUser();

    return user ? <UserInfoBlock showExtraLinks={true} /> : <AuthForm />;
}


```


## <a name="srccomponentssharedEquipmentWithAccessoriesListtsx"></a>`src/components/shared/EquipmentWithAccessoriesList.tsx`

```tsx
// path: src/components/shared/EquipmentWithAccessoriesList.tsx

// src/components/shared/EquipmentWithAccessoriesList.tsx

import { useState } from "react";
import { Paperclip, ChevronDown, MinusCircle } from "lucide-react";
import { Button } from "@/components/ui/button";
import type { AccessoryLink } from "@/types/reservation";

interface EquipmentItem {
    id: number;
    name: string;
}

interface EquipmentWithAccessoriesListProps {
    equipment: EquipmentItem[];
    accessoryLinks?: AccessoryLink[];
    title?: string;
    showTitle?: boolean;
    className?: string;
    showRemoveButton?: boolean;
    onRemoveItem?: (equipmentId: number) => void;
    isRemoveDisabled?: boolean;
    removeButtonTitle?: string;
}

export default function EquipmentWithAccessoriesList({
    equipment,
    accessoryLinks = [],
    title = "–°–æ—Å—Ç–∞–≤ —Ä–µ–∑–µ—Ä–≤–∞:",
    showTitle = true,
    className = "",
    showRemoveButton = false,
    onRemoveItem,
    isRemoveDisabled = false,
    removeButtonTitle = "–£–¥–∞–ª–∏—Ç—å –∏–∑ —Ä–µ–∑–µ—Ä–≤–∞"
}: EquipmentWithAccessoriesListProps) {
    const [expandedAccessories, setExpandedAccessories] = useState<Record<number, boolean>>({});

    // –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏ –æ—Ç—Å—É—Ç—Å—Ç–≤—É—é—â–∏—Ö –∞–∫—Å–µ—Å—Å—É–∞—Ä–æ–≤
    const missingAccessories = accessoryLinks.filter(link => !link.accessory);
    if (missingAccessories.length > 0) {
        console.warn('–û–±–Ω–∞—Ä—É–∂–µ–Ω—ã AccessoryLink —Å –æ—Ç—Å—É—Ç—Å—Ç–≤—É—é—â–∏–º–∏ accessory:', missingAccessories);
    }

    const toggleAccessories = (equipmentId: number) => {
        setExpandedAccessories(prev => ({
            ...prev,
            [equipmentId]: !prev[equipmentId]
        }));
    };

    if (equipment.length === 0) {
        return (
            <div className={`space-y-2 pt-2 border-t ${className}`}>
                {showTitle && (
                    <h4 className="font-medium text-sm text-gray-800">{title}</h4>
                )}
                <div className="text-sm text-gray-500 italic">–ù–µ—Ç –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—è –≤ —Ä–µ–∑–µ—Ä–≤–µ</div>
            </div>
        );
    }

    return (
        <div className={`space-y-2 pt-2 border-t ${className}`}>
            {showTitle && (
                <h4 className="font-medium text-sm text-gray-800">{title}</h4>
            )}
            <div className="space-y-2">
                {equipment.map((item) => {
                    // –§–∏–ª—å—Ç—Ä—É–µ–º –∞–∫—Å–µ—Å—Å—É–∞—Ä—ã, —á—Ç–æ–±—ã —É–±–µ–¥–∏—Ç—å—Å—è, —á—Ç–æ –¥–∞–Ω–Ω—ã–µ –æ –Ω–∏—Ö —Å—É—â–µ—Å—Ç–≤—É—é—Ç
                    const accessoriesForItem = accessoryLinks.filter(link => 
                        link.equipment_id === item.id && link.accessory
                    );
                    
                    return (
                        <div key={item.id} className="text-sm text-gray-700 bg-gray-50/70 p-2 rounded-md border">
                            <div className="flex justify-between items-center">
                                <p>‚Ä¢ {item.name}</p>
                                {showRemoveButton && onRemoveItem && (
                                    <Button
                                        variant="ghost"
                                        size="icon"
                                        onClick={() => onRemoveItem(item.id)}
                                        className={`hover:text-rose-700 ${
                                            isRemoveDisabled ? "text-gray-400 cursor-not-allowed" : "text-rose-500"
                                        }`}
                                        title={removeButtonTitle}
                                        aria-label="–£–¥–∞–ª–∏—Ç—å –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏–µ"
                                        disabled={isRemoveDisabled}
                                    >
                                        <MinusCircle className="w-4 h-4" />
                                    </Button>
                                )}
                            </div>
                            {accessoriesForItem.length > 0 && (
                                <div className="mt-2 pl-4">
                                    <button 
                                        onClick={() => toggleAccessories(item.id)} 
                                        className="flex items-center text-xs text-sky-700 hover:underline font-medium"
                                    >
                                        <Paperclip className="w-3 h-3 mr-1" />
                                        –ê–∫—Å–µ—Å—Å—É–∞—Ä—ã ({accessoriesForItem.length})
                                        <ChevronDown className={`w-4 h-4 ml-1 transition-transform ${expandedAccessories[item.id] ? 'rotate-180' : ''}`} />
                                    </button>
                                    {expandedAccessories[item.id] && (
                                        <ul className="list-disc list-inside text-xs text-gray-600 mt-1 pl-2 animate-in fade-in duration-200">
                                            {accessoriesForItem.map(link => {
                                                // –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –∑–∞—â–∏—Ç–∞ –Ω–∞ —Å–ª—É—á–∞–π, –µ—Å–ª–∏ accessory —Å—Ç–∞–ª null –ø–æ—Å–ª–µ —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏
                                                if (!link.accessory) {
                                                    console.warn('–û–±–Ω–∞—Ä—É–∂–µ–Ω AccessoryLink —Å –æ—Ç—Å—É—Ç—Å—Ç–≤—É—é—â–∏–º accessory:', link);
                                                    return null;
                                                }
                                                return (
                                                    <li key={link.accessory.id}>{link.accessory.name}</li>
                                                );
                                            })}
                                        </ul>
                                    )}
                                </div>
                            )}
                        </div>
                    );
                })}
            </div>
        </div>
    );
}


```


## <a name="srccomponentssharedFinancialInfoBlocktsx"></a>`src/components/shared/FinancialInfoBlock.tsx`

```tsx
// path: src/components/shared/FinancialInfoBlock.tsx

// src/components/shared/FinancialInfoBlock.tsx

import { Tag, Receipt, ReceiptText } from "lucide-react";
import { cn } from "@/lib/utils";

interface FinancialInfoBlockProps {
    totalCost?: number | null;
    discountAmount?: number | null;
    promoCode?: string | null;
    variant?: 'default' | 'compact' | 'admin';
    className?: string;
}

export default function FinancialInfoBlock({
    totalCost,
    discountAmount,
    promoCode,
    variant = 'default',
    className
}: FinancialInfoBlockProps) {
    // –ê–¥–º–∏–Ω—Å–∫–∏–π —Å—Ç–∏–ª—å - –∫–∞–∫ –≤ AdminRentalCard
    if (variant === 'admin') {
        return (
            <div className={cn("flex-shrink-0 md:w-64 bg-slate-50 p-3 rounded-lg border space-y-2", className)}>
                <h4 className="font-semibold text-sm text-slate-800 flex items-center gap-2">
                    <ReceiptText className="w-4 h-4"/>–§–∏–Ω–∞–Ω—Å—ã
                </h4>
                <div className="text-xs space-y-1.5 text-slate-700">
                    <div className="flex justify-between">
                        <span>–û–±—â–∞—è —Å—Ç–æ–∏–º–æ—Å—Ç—å:</span> 
                        <span className="font-medium">{totalCost?.toLocaleString('ru-RU') ?? '–ù/–î'} ‚ÇΩ</span>
                    </div>
                    {promoCode && (
                        <div className="flex justify-between">
                            <span>–ü—Ä–æ–º–æ–∫–æ–¥:</span> 
                            <span className="font-medium text-purple-600">{promoCode}</span>
                        </div>
                    )}
                    {(discountAmount ?? 0) > 0 && (
                        <div className="flex justify-between">
                            <span>–°–∫–∏–¥–∫–∞:</span> 
                            <span className="font-medium text-green-600">-{discountAmount?.toLocaleString('ru-RU')} ‚ÇΩ</span>
                        </div>
                    )}
                </div>
            </div>
        );
    }

    // –ö–æ–º–ø–∞–∫—Ç–Ω—ã–π –∏ —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π —Å—Ç–∏–ª–∏ (–æ–±—ä–µ–¥–∏–Ω–µ–Ω—ã –¥–ª—è —É—Å—Ç—Ä–∞–Ω–µ–Ω–∏—è –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏—è)
    const isCompact = variant === 'compact';
    const containerClasses = isCompact 
        ? "flex flex-wrap items-center justify-start gap-x-4 gap-y-1 text-sm pt-2 border-t border-dashed"
        : "flex flex-wrap items-center justify-start gap-x-4 gap-y-1 text-sm";
    
    return (
        <div className={cn(containerClasses, className)}>
            {promoCode && (
                <div className="flex items-center gap-1.5 text-xs text-purple-600 self-end">
                    <Tag className="w-3 h-3" />
                    <span>{promoCode}</span>
                </div>
            )}
            <div className="text-right">
                <div className="flex items-center gap-1.5 font-semibold">
                    <Receipt className="w-4 h-4 text-gray-500" />
                    –ò—Ç–æ–≥:
                    <span className="text-gray-800">
                        {totalCost?.toLocaleString('ru-RU') ?? '–ù/–î'} ‚ÇΩ
                    </span>
                </div>
                {(discountAmount ?? 0) > 0 && (
                    <div className="text-xs text-green-600 mt-0.5">
                        —Å–æ —Å–∫–∏–¥–∫–æ–π –≤ {discountAmount?.toLocaleString('ru-RU')} ‚ÇΩ
                    </div>
                )}
            </div>
        </div>
    );
}


```


## <a name="srccomponentssharedFinancialSummaryBlocktsx"></a>`src/components/shared/FinancialSummaryBlock.tsx`

```tsx
// path: src/components/shared/FinancialSummaryBlock.tsx

// src/components/shared/FinancialSummaryBlock.tsx

import { Button } from "@/components/ui/button";
import PromoCodeInput from "@/components/PromoCodeInput";
import { ReceiptText, Loader2, AlertTriangle } from "lucide-react";
import { cn } from "@/lib/utils";
import type { PriceDetails } from "@/hooks/reservation/usePriceCalculator";

interface FinancialSummaryBlockProps {
    // –î–∞–Ω–Ω—ã–µ –æ —Å—Ç–æ–∏–º–æ—Å—Ç–∏
    priceDetails?: PriceDetails | null;
    
    // –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —Ñ–∏–Ω–∞–Ω—Å–æ–≤—ã–µ –¥–∞–Ω–Ω—ã–µ
    accessoriesDailyTotal?: number;
    
    // –ü—Ä–æ–º–æ–∫–æ–¥
    promoCode: string;
    setPromoCode: (code: string) => void;
    applyPromoCode: () => void;
    removePromoCode?: () => void;
    promoCodeMessage?: string;
    
    // –°–æ—Å—Ç–æ—è–Ω–∏—è –∑–∞–≥—Ä—É–∑–∫–∏
    isLoading?: boolean;
    isApplyingPromoCode?: boolean;
    isSubmitting?: boolean;
    
    // –í–∞–ª–∏–¥–∞—Ü–∏—è
    isFormValid?: boolean;
    hasConflicts?: boolean;
    
    // –î–µ–π—Å—Ç–≤–∏—è
    onCancel?: () => void;
    onAddMore?: () => void;
    onSubmit?: () => void;
    
    // –°—Ç–∏–ª–∏–∑–∞—Ü–∏—è
    variant?: 'default' | 'compact' | 'admin' | 'inline';
    className?: string;
    showActions?: boolean;
}

/**
 * –£–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω—ã–π –∫–æ–º–ø–æ–Ω–µ–Ω—Ç –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è —Ñ–∏–Ω–∞–Ω—Å–æ–≤–æ–π —Å–≤–æ–¥–∫–∏ —Ä–µ–∑–µ—Ä–≤–∞.
 * –ó–∞–º–µ–Ω—è–µ—Ç ReservationSummary, AdminReservationSummary –∏ ReservationFinancialSummary.
 */
export default function FinancialSummaryBlock({
    priceDetails,
    accessoriesDailyTotal = 0,
    promoCode,
    setPromoCode,
    applyPromoCode,
    removePromoCode,
    promoCodeMessage = "",
    isLoading = false,
    isApplyingPromoCode = false,
    isSubmitting = false,
    isFormValid = true,
    hasConflicts = false,
    onCancel,
    onAddMore,
    onSubmit,
    variant = 'default',
    className,
    showActions = true
}: FinancialSummaryBlockProps) {
    
    // –ò–∑–≤–ª–µ–∫–∞–µ–º –¥–∞–Ω–Ω—ã–µ –∏–∑ priceDetails
    const dayCount = priceDetails?.day_count ?? 0;
    const fullTotal = priceDetails?.full_total ?? 0;
    const finalTotal = priceDetails?.final_total ?? 0;
    const discountAmount = priceDetails?.discount_amount ?? 0;
    const durationDiscountPercentage = priceDetails?.duration_discount_percentage ?? 0;
    const promoDiscountPercentage = priceDetails?.promo_discount_percentage ?? 0;
    const totalDiscountPercentage = durationDiscountPercentage + promoDiscountPercentage;
    const apiPromoCodeMessage = priceDetails?.promo_code_message ?? "";
    
    // –ò—Å–ø–æ–ª—å–∑—É–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –∏–∑ API –∏–ª–∏ –ø–µ—Ä–µ–¥–∞–Ω–Ω–æ–µ
    const displayPromoCodeMessage = apiPromoCodeMessage || promoCodeMessage;
    
    // –ö–æ–º–ø–∞–∫—Ç–Ω—ã–π –≤–∞—Ä–∏–∞–Ω—Ç –¥–ª—è –∫–∞—Ä—Ç–æ—á–µ–∫
    if (variant === 'compact') {
        return (
            <div className={cn("flex flex-wrap items-center justify-start gap-x-4 gap-y-1 text-sm", className)}>
                {promoCode && (
                    <div className="flex items-center gap-1.5 text-xs text-purple-600 self-end">
                        <span className="px-1.5 py-0.5 bg-purple-100 rounded text-xs">
                            {promoCode}
                        </span>
                    </div>
                )}
                <div className="text-right">
                    <div className="flex items-center gap-1.5 font-semibold">
                        <ReceiptText className="w-4 h-4 text-gray-500" />
                        –ò—Ç–æ–≥:
                        <span className="text-gray-800">
                            {finalTotal.toLocaleString('ru-RU')} ‚ÇΩ
                        </span>
                    </div>
                    {discountAmount > 0 && (
                        <div className="text-xs text-green-600 mt-0.5">
                            —Å–æ —Å–∫–∏–¥–∫–æ–π –≤ {discountAmount.toLocaleString('ru-RU')} ‚ÇΩ
                        </div>
                    )}
                </div>
            </div>
        );
    }
    
    // –ê–¥–º–∏–Ω—Å–∫–∏–π –≤–∞—Ä–∏–∞–Ω—Ç
    if (variant === 'admin') {
        return (
            <div className={cn("flex-1 space-y-2 text-sm", className)}>
                <div className="grid grid-cols-2 gap-x-4 gap-y-1">
                    <span className="text-gray-600">–î–Ω–µ–π –∞—Ä–µ–Ω–¥—ã:</span>
                    <span className="font-medium text-right">{dayCount}</span>

                    <span className="text-gray-600">–°—É–º–º–∞ –±–µ–∑ —Å–∫–∏–¥–∫–∏:</span>
                    <span className="font-medium text-right">{fullTotal.toLocaleString('ru-RU')} ‚ÇΩ</span>

                    {totalDiscountPercentage > 0 && (
                        <>
                            <span className="text-green-600">–°–∫–∏–¥–∫–∞ ({totalDiscountPercentage}%):</span>
                            <span className="font-medium text-green-600 text-right">- {discountAmount.toLocaleString('ru-RU')} ‚ÇΩ</span>
                        </>
                    )}

                    <span className="font-semibold text-base mt-1">–ò—Ç–æ–≥–æ:</span>
                    <span className="font-bold text-base text-right mt-1">{finalTotal.toLocaleString('ru-RU')} ‚ÇΩ</span>
                </div>

                <div className="pt-2">
                    <PromoCodeInput
                        promoCode={promoCode}
                        setPromoCode={setPromoCode}
                        applyPromoCode={applyPromoCode}
                        promoCodeMessage={displayPromoCodeMessage}
                        disabled={isSubmitting || isLoading}
                        isLoading={isApplyingPromoCode}
                    />
                </div>

                {isLoading && (
                    <div className="flex items-center gap-2 text-xs text-gray-500 pt-1">
                        <Loader2 className="h-3 w-3 animate-spin" />
                        <span>–ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏...</span>
                    </div>
                )}
                {hasConflicts && (
                    <div className="flex items-center gap-2 text-xs text-red-600 font-medium pt-1">
                        <AlertTriangle className="h-4 w-4" />
                        <span>–û–±–Ω–∞—Ä—É–∂–µ–Ω—ã –∫–æ–Ω—Ñ–ª–∏–∫—Ç—ã –≤ –≤—ã–±–æ—Ä–µ!</span>
                    </div>
                )}
            </div>
        );
    }
    
    // Inline –≤–∞—Ä–∏–∞–Ω—Ç –¥–ª—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
    if (variant === 'inline') {
        return (
            <div className={cn("space-y-3", className)}>
                <div className="flex items-center gap-2 text-sm font-medium text-gray-700">
                    <ReceiptText className="w-4 h-4" />
                    –§–∏–Ω–∞–Ω—Å–æ–≤–∞—è —Å–≤–æ–¥–∫–∞
                </div>
                
                {isLoading ? (
                    <div className="text-center py-4 text-gray-500 flex items-center justify-center gap-2">
                        <Loader2 className="h-4 w-4 animate-spin" />
                        –†–∞—Å—á–µ—Ç —Å—Ç–æ–∏–º–æ—Å—Ç–∏...
                    </div>
                ) : (
                    <div className="text-sm text-gray-700 space-y-2">
                        <div className="flex justify-between">
                            <span>–ê—Ä–µ–Ω–¥–∞ –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—è ({dayCount} –¥–Ω.):</span>
                            <span>{fullTotal.toLocaleString('ru-RU')} ‚ÇΩ</span>
                        </div>
                        
                        {accessoriesDailyTotal > 0 && (
                            <div className="flex justify-between text-gray-600 pl-4">
                                <span>- –≤ —Ç.—á. –∞–∫—Å–µ—Å—Å—É–∞—Ä—ã ({accessoriesDailyTotal.toLocaleString('ru-RU')} ‚ÇΩ/–¥–µ–Ω—å):</span>
                                <span>{(accessoriesDailyTotal * dayCount).toLocaleString('ru-RU')} ‚ÇΩ</span>
                            </div>
                        )}
                        
                        <div className="flex justify-between pt-2 border-t border-dashed">
                            <span>–°—É–º–º–∞ –±–µ–∑ —Å–∫–∏–¥–∫–∏:</span>
                            <strong>{fullTotal.toLocaleString('ru-RU')} ‚ÇΩ</strong>
                        </div>
                        
                        {totalDiscountPercentage > 0 && (
                            <div className="flex justify-between text-green-600">
                                <span>–°–∫–∏–¥–∫–∞ ({totalDiscountPercentage}%):</span>
                                <strong>- {discountAmount.toLocaleString('ru-RU', { minimumFractionDigits: 2, maximumFractionDigits: 2 })} ‚ÇΩ</strong>
                            </div>
                        )}
                        
                        <div className="flex justify-between text-base font-bold pt-2 border-t mt-2">
                            <span>–ö –æ–ø–ª–∞—Ç–µ:</span>
                            <span className="text-sky-700 ml-2">{finalTotal.toLocaleString('ru-RU', { minimumFractionDigits: 2, maximumFractionDigits: 2 })} ‚ÇΩ</span>
                        </div>
                    </div>
                )}
                
                <div className="pt-2">
                    <PromoCodeInput
                        promoCode={promoCode}
                        setPromoCode={setPromoCode}
                        applyPromoCode={applyPromoCode}
                        removePromoCode={removePromoCode}
                        promoCodeMessage={displayPromoCodeMessage}
                        disabled={isSubmitting || isLoading}
                        isLoading={isApplyingPromoCode}
                    />
                </div>
            </div>
        );
    }
    
    // –°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π –≤–∞—Ä–∏–∞–Ω—Ç (–∫–∞–∫ ReservationSummary)
    return (
        <div className={cn("mt-6 p-4 border rounded-lg bg-white shadow-sm space-y-4", className)}>
            <div className="flex items-center gap-2 text-lg font-semibold text-gray-800">
                <ReceiptText className="w-6 h-6 text-sky-600" />
                –ò—Ç–æ–≥–æ–≤—ã–π —Ä–∞—Å—á–µ—Ç
            </div>

            <div className="border-t pt-4">
                <PromoCodeInput
                    promoCode={promoCode}
                    setPromoCode={setPromoCode}
                    applyPromoCode={applyPromoCode}
                    removePromoCode={removePromoCode}
                    promoCodeMessage={displayPromoCodeMessage}
                    disabled={isSubmitting || isLoading}
                    isLoading={isApplyingPromoCode}
                />
            </div>

            {isLoading ? (
                <div className="text-center py-4 text-gray-500 flex items-center justify-center gap-2">
                    <Loader2 className="h-4 w-4 animate-spin" />
                    –†–∞—Å—á–µ—Ç —Å—Ç–æ–∏–º–æ—Å—Ç–∏...
                </div>
            ) : (
                <div className="text-sm text-gray-700 space-y-2 border-t pt-4">
                    <div className="flex justify-between">
                        <span>–ê—Ä–µ–Ω–¥–∞ –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—è ({dayCount} –¥–Ω.):</span>
                    </div>
                    {accessoriesDailyTotal > 0 && (
                        <div className="flex justify-between text-gray-600 pl-4">
                            <span>- –≤ —Ç.—á. –∞–∫—Å–µ—Å—Å—É–∞—Ä—ã ({accessoriesDailyTotal.toLocaleString('ru-RU')} ‚ÇΩ/–¥–µ–Ω—å):</span>
                            <span>{(accessoriesDailyTotal * dayCount).toLocaleString('ru-RU')} ‚ÇΩ</span>
                        </div>
                    )}
                    <div className="flex justify-between pt-2 border-t border-dashed">
                        <span>–°—É–º–º–∞ –±–µ–∑ —Å–∫–∏–¥–∫–∏:</span>
                        <strong>{fullTotal.toLocaleString('ru-RU')} ‚ÇΩ</strong>
                    </div>
                    {totalDiscountPercentage > 0 && (
                        <div className="flex justify-between text-green-600">
                            <span>–°–∫–∏–¥–∫–∞ ({totalDiscountPercentage}%):</span>
                            <strong>- {discountAmount.toLocaleString('ru-RU', { minimumFractionDigits: 2, maximumFractionDigits: 2 })} ‚ÇΩ</strong>
                        </div>
                    )}
                    <div className="flex justify-between text-base font-bold pt-2 border-t mt-2">
                        <span>–ö –æ–ø–ª–∞—Ç–µ:</span>
                        <span className="text-sky-700 ml-2">{finalTotal.toLocaleString('ru-RU', { minimumFractionDigits: 2, maximumFractionDigits: 2 })} ‚ÇΩ</span>
                    </div>
                </div>
            )}

            {showActions && (onCancel || onAddMore || onSubmit) && (
                <div className="flex flex-col sm:flex-row justify-end items-center pt-3 gap-3">
                    {onCancel && (
                        <Button variant="ghost" className="text-red-600 hover:bg-red-50 w-full sm:w-auto" onClick={onCancel}>
                            –û—Ç–º–µ–Ω–∏—Ç—å –æ—Ñ–æ—Ä–º–ª–µ–Ω–∏–µ
                        </Button>
                    )}
                    {onAddMore && (
                        <Button variant="outline" className="w-full sm:w-auto" onClick={onAddMore}>
                            –î–æ–±–∞–≤–∏—Ç—å –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏–µ
                        </Button>
                    )}
                    {onSubmit && (
                        <Button
                            disabled={!isFormValid || isSubmitting || isLoading || isApplyingPromoCode}
                            className="px-6 py-2 w-full sm:w-auto"
                            onClick={onSubmit}
                        >
                            {isSubmitting ? "–û–±—Ä–∞–±–æ—Ç–∫–∞..." : "–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å —Ä–µ–∑–µ—Ä–≤"}
                        </Button>
                    )}
                </div>
            )}
        </div>
    );
}


```


## <a name="srccomponentssharedOrderToolbartsx"></a>`src/components/shared/OrderToolbar.tsx`

```tsx
// path: src/components/shared/OrderToolbar.tsx

import { Input } from "@/components/ui/input"
import { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from "@/components/ui/select"
import { Checkbox } from "@/components/ui/checkbox"
import { Label } from "@/components/ui/label"
import { useOrderFilterStore, type SortOption, type OrderContext } from "@/store/orderFilterStore"

interface OrderToolbarProps {
    context: OrderContext
    showHideCompletedCheckbox?: boolean
}

export default function OrderToolbar({ context, showHideCompletedCheckbox }: OrderToolbarProps) {
    const { searchQuery, statusFilter, sortOption, setSearchQuery, setStatusFilter, setSortOption } = useOrderFilterStore()

    // –û–ø—Ä–µ–¥–µ–ª—è–µ–º placeholder –¥–ª—è –ø–æ–∏—Å–∫–∞ –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞
    const getSearchPlaceholder = () => {
        switch (context) {
            case "user-reservations":
            case "user-rentals":
                return "–ü–æ–∏—Å–∫ –ø–æ –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—é..."
            case "admin-reservations":
            case "admin-rentals":
                return "–ü–æ–∏—Å–∫ –ø–æ –∫–ª–∏–µ–Ω—Ç—É..."
            default:
                return "–ü–æ–∏—Å–∫..."
        }
    }

    // –û–ø—Ä–µ–¥–µ–ª—è–µ–º –æ–ø—Ü–∏–∏ —Å—Ç–∞—Ç—É—Å–∞ –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞
    const getStatusOptions = () => {
        switch (context) {
            case "user-reservations":
                return [
                    { value: "active", label: "–ê–∫—Ç–∏–≤–Ω—ã–µ" },
                    { value: "completed", label: "–ó–∞–≤–µ—Ä—à–µ–Ω–Ω—ã–µ" },
                    { value: "all", label: "–í—Å–µ" }
                ]
            case "user-rentals":
                return [
                    { value: "active", label: "–ê–∫—Ç–∏–≤–Ω—ã–µ" },
                    { value: "overdue", label: "–ü—Ä–æ—Å—Ä–æ—á–µ–Ω–Ω—ã–µ" },
                    { value: "completed", label: "–ó–∞–≤–µ—Ä—à–µ–Ω–Ω—ã–µ" },
                    { value: "all", label: "–í—Å–µ" }
                ]
            case "admin-reservations":
                return [
                    { value: "active", label: "–ê–∫—Ç–∏–≤–Ω—ã–µ" },
                    { value: "completed", label: "–ó–∞–≤–µ—Ä—à–µ–Ω–Ω—ã–µ" },
                    { value: "all", label: "–í—Å–µ" }
                ]
            case "admin-rentals":
                return [
                    { value: "active", label: "–ê–∫—Ç–∏–≤–Ω—ã–µ" },
                    { value: "overdue", label: "–ü—Ä–æ—Å—Ä–æ—á–µ–Ω–Ω—ã–µ" },
                    { value: "completed", label: "–ó–∞–≤–µ—Ä—à–µ–Ω–Ω—ã–µ" },
                    { value: "all", label: "–í—Å–µ" }
                ]
            default:
                return []
        }
    }

    const statusOptions = getStatusOptions()

    // –õ–æ–≥–∏–∫–∞ –¥–ª—è —á–µ–∫–±–æ–∫—Å–∞ "–°–∫—Ä—ã—Ç—å –∑–∞–≤–µ—Ä—à–µ–Ω–Ω—ã–µ"
    const isHideCompletedChecked = statusFilter !== 'all'
    const handleHideCompletedChange = (checked: boolean | 'indeterminate') => {
        // –ï—Å–ª–∏ indeterminate, —Å—á–∏—Ç–∞–µ–º –∫–∞–∫ false
        setStatusFilter(checked === true ? 'active' : 'all')
    }

    return (
        <div className="mb-4 flex flex-wrap items-center gap-4">
            <Input
                type="text"
                placeholder={getSearchPlaceholder()}
                value={searchQuery}
                onChange={(e) => setSearchQuery(e.target.value)}
                className="max-w-xs"
            />
            
            {showHideCompletedCheckbox ? (
                <div className="flex items-center space-x-2">
                    <Checkbox
                        id="hide-completed-orders"
                        checked={isHideCompletedChecked}
                        onCheckedChange={handleHideCompletedChange}
                    />
                    <Label htmlFor="hide-completed-orders">–°–∫—Ä—ã—Ç—å –∑–∞–≤–µ—Ä—à–µ–Ω–Ω—ã–µ</Label>
                </div>
            ) : (
                <Select value={statusFilter || "active"} onValueChange={setStatusFilter}>
                    <SelectTrigger className="w-52">
                        <SelectValue placeholder="–§–∏–ª—å—Ç—Ä –ø–æ —Å—Ç–∞—Ç—É—Å—É" />
                    </SelectTrigger>
                    <SelectContent>
                        {statusOptions.map((option) => (
                            <SelectItem key={option.value} value={option.value}>
                                {option.label}
                            </SelectItem>
                        ))}
                    </SelectContent>
                </Select>
            )}

            <Select value={sortOption} onValueChange={(val) => setSortOption(val as SortOption)}>
                <SelectTrigger className="w-52">
                    <SelectValue placeholder="–°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞" />
                </SelectTrigger>
                <SelectContent>
                    <SelectItem value="id_desc">–ù–æ–º–µ—Ä ‚Üì</SelectItem>
                    <SelectItem value="id_asc">–ù–æ–º–µ—Ä ‚Üë</SelectItem>
                    <SelectItem value="start_desc">–ù–∞—á–∞–ª–æ ‚Üì</SelectItem>
                    <SelectItem value="start_asc">–ù–∞—á–∞–ª–æ ‚Üë</SelectItem>
                    <SelectItem value="end_desc">–û–∫–æ–Ω—á–∞–Ω–∏–µ ‚Üì</SelectItem>
                    <SelectItem value="end_asc">–û–∫–æ–Ω—á–∞–Ω–∏–µ ‚Üë</SelectItem>
                    <SelectItem value="count_desc">–ü–æ–∑–∏—Ü–∏–π ‚Üì</SelectItem>
                    <SelectItem value="count_asc">–ü–æ–∑–∏—Ü–∏–π ‚Üë</SelectItem>
                </SelectContent>
            </Select>
        </div>
    )
}


```


## <a name="srcconstantsequipmentConstantsts"></a>`src/constants/equipmentConstants.ts`

```typescript
// path: src/constants/equipmentConstants.ts

// src/constants/equipmentConstants.ts

/**
 * –°–ø–∏—Å–æ–∫ –≤–æ–∑–º–æ–∂–Ω—ã—Ö —Å–æ—Å—Ç–æ—è–Ω–∏–π –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—è.
 * –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–ª—è –≤—ã–ø–∞–¥–∞—é—â–∏—Ö —Å–ø–∏—Å–∫–æ–≤ –≤ —Ñ–æ—Ä–º–∞—Ö –∏ –¥–ª—è –≤–∞–ª–∏–¥–∞—Ü–∏–∏.
 */
export const EQUIPMENT_CONDITIONS: readonly string[] = [
    "–í–µ–ª–∏–∫–æ–ª–µ–ø–Ω–æ",
    "–û—Ç–ª–∏—á–Ω–æ",
    "–•–æ—Ä–æ—à–æ",
    "–£–¥–æ–≤–ª–µ—Ç–≤–æ—Ä–∏—Ç–µ–ª—å–Ω–æ",
    "–¢—Ä–µ–±—É–µ—Ç —Ä–µ–º–æ–Ω—Ç–∞",
];

/**
 * –£—Ç–∏–ª–∏—Ç–∞ –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è Tailwind CSS –∫–ª–∞—Å—Å–æ–≤ –¥–ª—è —Å—Ç–∏–ª–∏–∑–∞—Ü–∏–∏ —Å–æ—Å—Ç–æ—è–Ω–∏—è –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—è.
 * @param condition –°—Ç—Ä–æ–∫–∞ —Å –Ω–∞–∑–≤–∞–Ω–∏–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏—è.
 * @returns –°—Ç—Ä–æ–∫–∞ —Å CSS –∫–ª–∞—Å—Å–∞–º–∏ –¥–ª—è —Ñ–æ–Ω–∞ –∏ —Ç–µ–∫—Å—Ç–∞.
 */
export function getConditionVariantClass(condition: string): string {
    switch (condition) {
        case "–í–µ–ª–∏–∫–æ–ª–µ–ø–Ω–æ":
            return "bg-green-100 text-green-800";
        case "–û—Ç–ª–∏—á–Ω–æ":
            return "bg-sky-100 text-sky-800";
        case "–•–æ—Ä–æ—à–æ":
            return "bg-yellow-100 text-yellow-800";
        case "–£–¥–æ–≤–ª–µ—Ç–≤–æ—Ä–∏—Ç–µ–ª—å–Ω–æ":
            return "bg-orange-100 text-orange-800";
        case "–¢—Ä–µ–±—É–µ—Ç —Ä–µ–º–æ–Ω—Ç–∞":
            return "bg-red-100 text-red-800";
        default:
            return "bg-gray-100 text-gray-800";
    }
};

```


## <a name="srcconstantspaginationConstantsts"></a>`src/constants/paginationConstants.ts`

```typescript
// path: src/constants/paginationConstants.ts

// src/constants/paginationConstants.ts

export const PAGINATION_CONSTANTS = {
    HOME_PAGE_SIZE: 12,
    ADMIN_PAGE_SIZE: 10,
};

```


## <a name="srcconstantsstatusStylests"></a>`src/constants/statusStyles.ts`

```typescript
// path: src/constants/statusStyles.ts

// src/constants/statusStyles.ts

// –°—Ç–∏–ª–∏ –¥–ª—è –∫–∞—Ä—Ç–æ—á–µ–∫ –†–ï–ó–ï–†–í–û–í
export const RESERVATION_CARD_STYLES: Record<string, string> = {
    active: "bg-white hover:shadow-md",
    fulfilled: "bg-blue-50 border-blue-200 text-gray-800",
    cancelled: "bg-gray-100 border-gray-300 text-gray-600 hover:shadow-sm",
    overdue: "bg-orange-50 border-orange-200 text-gray-800",
    default: "bg-white hover:shadow-md"
};

// –°—Ç–∏–ª–∏ –¥–ª—è –∫–∞—Ä—Ç–æ—á–µ–∫ –ê–†–ï–ù–î–´
export const RENTAL_CARD_STYLES: Record<string, string> = {
    active: "bg-white hover:shadow-md",
    completed: "bg-gray-100 border-gray-200 text-gray-600 hover:shadow-sm",
    overdue: "bg-red-50/70 border-red-300",
    default: "bg-white hover:shadow-md"
};


```


## <a name="srcconstantsuserConstantsts"></a>`src/constants/userConstants.ts`

```typescript
// path: src/constants/userConstants.ts

// src/constants/userConstants.ts

/**
 * –°–∏—Å—Ç–µ–º–Ω—ã–µ –∏–º–µ–Ω–∞ —Ä–æ–ª–µ–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π.
 * –ò—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è –¥–ª—è –æ–±—â–µ–Ω–∏—è —Å API –∏ –≤ –ª–æ–≥–∏–∫–µ.
 */
export const USER_ROLES = {
    USER: "user",
    MANAGER: "manager",
    ADMIN: "admin",
} as const;

// –°–æ–∑–¥–∞–µ–º —Ç–∏–ø –Ω–∞ –æ—Å–Ω–æ–≤–µ –∫–ª—é—á–µ–π –æ–±—ä–µ–∫—Ç–∞ USER_ROLES –¥–ª—è —É–¥–æ–±—Å—Ç–≤–∞
type UserRoleKey = keyof typeof USER_ROLES;

/**
 * –¢–∏–ø –¥–ª—è —Å–∏—Å—Ç–µ–º–Ω—ã—Ö –∏–º–µ–Ω —Ä–æ–ª–µ–π.
 * –ü—Ä–∏–º–µ—Ä: 'user' | 'manager' | 'admin'
 */
export type UserRole = (typeof USER_ROLES)[UserRoleKey];

// ‚úÖ –ò–ó–ú–ï–ù–ï–ù–ò–ï: –°–æ–∑–¥–∞–µ–º –º–∞—Å—Å–∏–≤ —Ä–æ–ª–µ–π –∏ —è–≤–Ω–æ —É–∫–∞–∑—ã–≤–∞–µ–º TypeScript,
// —á—Ç–æ —ç—Ç–æ –Ω–µ–ø—É—Å—Ç–æ–π –∫–æ—Ä—Ç–µ–∂ –∏–∑ –Ω–∞—à–∏—Ö –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã—Ö —Ä–æ–ª–µ–π.
// –≠—Ç–æ –∏ –µ—Å—Ç—å –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –æ—à–∏–±–∫–∏.
export const USER_ROLE_VALUES = Object.values(USER_ROLES) as [UserRole, ...UserRole[]];

/**
 * –ú–µ—Ç–∫–∏ —Ä–æ–ª–µ–π –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –≤ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–µ.
 */
export const USER_ROLE_LABELS: Record<UserRole, string> = {
    [USER_ROLES.USER]: "–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å",
    [USER_ROLES.MANAGER]: "–ú–µ–Ω–µ–¥–∂–µ—Ä",
    [USER_ROLES.ADMIN]: "–ê–¥–º–∏–Ω",
};

/**
 * –í–∞—Ä–∏–∞–Ω—Ç—ã (—Ü–≤–µ—Ç–∞) –¥–ª—è –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–∞ Badge –∏–∑ UI-–±–∏–±–ª–∏–æ—Ç–µ–∫–∏.
 */
export const USER_ROLE_BADGE_VARIANTS: Record<UserRole, "secondary" | "default" | "destructive"> = {
    [USER_ROLES.USER]: "secondary",
    [USER_ROLES.MANAGER]: "default",
    [USER_ROLES.ADMIN]: "destructive",
};

/**
 * –ü–æ–ª–Ω—ã–π –Ω–∞–±–æ—Ä –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –∫–∞–∂–¥–æ–π —Ä–æ–ª–∏, —É–¥–æ–±–Ω—ã–π –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ UI-—ç–ª–µ–º–µ–Ω—Ç–æ–≤.
 */
export const USER_ROLE_OPTIONS = (Object.keys(USER_ROLES) as UserRoleKey[]).map(key => ({
    value: USER_ROLES[key],
    label: USER_ROLE_LABELS[USER_ROLES[key]],
}));

```


## <a name="srccontextsReservationEditContexttsx"></a>`src/contexts/ReservationEditContext.tsx`

```tsx
// path: src/contexts/ReservationEditContext.tsx

// src/contexts/ReservationEditContext.tsx

import { createContext, useContext } from 'react';
import type { AvailabilityInfo } from '@/types/availability';
import type { EditState } from '@/hooks/reservation/useReservationState';
import type { Equipment } from '@/types/equipment'; // ‚úÖ –î–æ–±–∞–≤–ª–µ–Ω –∏–º–ø–æ—Ä—Ç
import type { PriceDetails } from '@/hooks/reservation/usePriceCalculator';

export type ReservationEditContextValue = {
    reservationId: number;
    editState: EditState & { hasChanges: boolean; newlyAddedEquipmentIdsAsArray: number[] };
    availabilityMap: Record<number, AvailabilityInfo>;
    hasConflicts: boolean;
    isLoading: boolean;
    isCheckingAvailability: boolean;
    isSaving: boolean;
    isCalculatingPrice: boolean;
    isCancelling: boolean;
    isCancelConfirmationVisible: boolean;
    startEdit: () => void;
    cancelEdit: () => void;
    saveChanges: () => Promise<boolean | void>;
    // ‚úÖ –î–û–ë–ê–í–õ–ï–ù–´ –≠–¢–ò –î–í–ê –°–í–û–ô–°–¢–í–ê
    equipmentMap: Map<number, Equipment>;
    allEquipment: Equipment[];
    updateDates: (newStartDate: Date, newEndDate: Date) => void;
    addEquipmentItems: (itemsToAdd: any[]) => void;
    removeEquipmentItem: (idToRemove: number) => void;
    handleConfirmFullCancellation: () => Promise<void>;
    handleCloseCancellationDialog: () => void;
    financials: {
        dayCount: number;
        fullTotal: number;
        finalTotal: number;
        discountAmount: number;
        durationDiscountAmount: number;
        durationDiscountPercentage: number;
        promoDiscountAmount: number;
        promoCodePercentage: number;
        promoCodeMessage: string;
        promoCode: string;
    };
    priceDetails?: PriceDetails | null; // –î–æ–±–∞–≤–ª—è–µ–º priceDetails –∏–∑ usePriceCalculator
    setPromoCode: (code: string) => void;
    applyPromoCode: () => void;
    removePromoCode: () => void;
    localSelectedAccessories: Record<number, number[]>;
    toggleAccessory: (equipmentId: number, accessoryId: number) => void;
    holidayConflict: { message: string, suggested_end_date: string } | null;
    confirmHolidayAdjustment: () => void;
    cancelHolidayAdjustment: () => void;
};

export const ReservationEditContext = createContext<ReservationEditContextValue | null>(null);

export const useReservationEditContext = () => {
    const context = useContext(ReservationEditContext);
    if (!context) {
        throw new Error('useReservationEditContext must be used within a ReservationEditProvider');
    }
    return context;
};

```


## <a name="srccoreservicesAccessoryServicets"></a>`src/core/services/AccessoryService.ts`

```typescript
// path: src/core/services/AccessoryService.ts

// src/core/services/AccessoryService.ts

import { api } from "@/lib/api";
import type { Accessory, AccessoryListResponse } from "@/types/accessory"; // –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ AccessoryListResponse –∏–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω

export interface AccessoryCreateInput {
    name: string;
    accessory_type: string;
    price: number;
    description?: string;
}

export interface AccessoryUpdateInput extends AccessoryCreateInput {
    id: number;
}

export interface AccessoryFilterOptions {
    search?: string;
    accessoryType?: string;
    minPrice?: number;
    maxPrice?: number;
}

export interface AccessoryValidationResult {
    isValid: boolean;
    errors: string[];
}

export class AccessoryService {
    /**
     * –ü–æ–ª—É—á–∞–µ—Ç –≤—Å–µ –∞–∫—Å–µ—Å—Å—É–∞—Ä—ã —Å –ø–∞–≥–∏–Ω–∞—Ü–∏–µ–π
     */
    static async getAllAccessories(skip: number, limit: number): Promise<AccessoryListResponse> {
        const response = await api.get("/accessories/", {
            params: { skip, limit }
        });
        // –í–ê–ñ–ù–û: API –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –æ–±—ä–µ–∫—Ç { items: [], total: 0 },
        // –∏ —Ç–µ–ø–µ—Ä—å –Ω–∞—à —Å–µ—Ä–≤–∏—Å –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ –µ–≥–æ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç.
        return response.data;
    }

    /**
     * –ü–æ–ª—É—á–∞–µ—Ç –∞–∫—Å–µ—Å—Å—É–∞—Ä –ø–æ ID
     */
    static async getAccessoryById(id: number): Promise<Accessory> {
        const response = await api.get(`/accessories/${id}`);
        return response.data;
    }

    /**
     * –°–æ–∑–¥–∞–µ—Ç –Ω–æ–≤—ã–π –∞–∫—Å–µ—Å—Å—É–∞—Ä
     */
    static async createAccessory(input: AccessoryCreateInput): Promise<Accessory> {
        const response = await api.post("/accessories/", input);
        return response.data;
    }

    /**
     * –û–±–Ω–æ–≤–ª—è–µ—Ç –∞–∫—Å–µ—Å—Å—É–∞—Ä
     */
    static async updateAccessory(input: AccessoryUpdateInput): Promise<Accessory> {
        const response = await api.put(`/accessories/${input.id}`, input);
        return response.data;
    }

    /**
     * –£–¥–∞–ª—è–µ—Ç –∞–∫—Å–µ—Å—Å—É–∞—Ä
     */
    static async deleteAccessory(id: number): Promise<void> {
        await api.delete(`/accessories/${id}`);
    }

    /**
     * –ü–æ–ª—É—á–∞–µ—Ç –∞–∫—Å–µ—Å—Å—É–∞—Ä—ã –¥–ª—è –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—è
     */
    static async getAccessoriesForEquipment(equipmentId: number): Promise<Accessory[]> {
        const response = await api.get(`/equipment/${equipmentId}/accessories`);
        return response.data;
    }

    /**
     * –§–∏–ª—å—Ç—Ä—É–µ—Ç –∞–∫—Å–µ—Å—Å—É–∞—Ä—ã –ø–æ –∑–∞–¥–∞–Ω–Ω—ã–º –∫—Ä–∏—Ç–µ—Ä–∏—è–º
     */
    static filterAccessories(
        accessories: Accessory[],
        filters: AccessoryFilterOptions
    ): Accessory[] {
        return accessories.filter(accessory => {
            // –§–∏–ª—å—Ç—Ä –ø–æ –ø–æ–∏—Å–∫—É
            if (filters.search) {
                const searchLower = filters.search.toLowerCase();
                const matchesSearch =
                    accessory.name.toLowerCase().includes(searchLower) ||
                    accessory.accessory_type.toLowerCase().includes(searchLower) ||
                    (accessory.description && accessory.description.toLowerCase().includes(searchLower));

                if (!matchesSearch) {
                    return false;
                }
            }

            // –§–∏–ª—å—Ç—Ä –ø–æ —Ç–∏–ø—É –∞–∫—Å–µ—Å—Å—É–∞—Ä–∞
            if (filters.accessoryType && accessory.accessory_type !== filters.accessoryType) {
                return false;
            }

            // –§–∏–ª—å—Ç—Ä –ø–æ –º–∏–Ω–∏–º–∞–ª—å–Ω–æ–π —Ü–µ–Ω–µ
            if (filters.minPrice !== undefined && accessory.price < filters.minPrice) {
                return false;
            }

            // –§–∏–ª—å—Ç—Ä –ø–æ –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–π —Ü–µ–Ω–µ
            if (filters.maxPrice !== undefined && accessory.price > filters.maxPrice) {
                return false;
            }

            return true;
        });
    }

    /**
     * –ì—Ä—É–ø–ø–∏—Ä—É–µ—Ç –∞–∫—Å–µ—Å—Å—É–∞—Ä—ã –ø–æ —Ç–∏–ø—É
     */
    static groupAccessoriesByType(accessories: Accessory[]): Record<string, Accessory[]> {
        return accessories.reduce((acc, accessory) => {
            const type = accessory.accessory_type;
            if (!acc[type]) {
                acc[type] = [];
            }
            acc[type].push(accessory);
            return acc;
        }, {} as Record<string, Accessory[]>);
    }

    /**
     * –°–æ—Ä—Ç–∏—Ä—É–µ—Ç –∞–∫—Å–µ—Å—Å—É–∞—Ä—ã –ø–æ –∑–∞–¥–∞–Ω–Ω–æ–º—É –∫—Ä–∏—Ç–µ—Ä–∏—é
     */
    static sortAccessories(
        accessories: Accessory[],
        sortBy: 'name' | 'accessory_type' | 'price',
        sortOrder: 'asc' | 'desc' = 'asc'
    ): Accessory[] {
        return [...accessories].sort((a, b) => {
            let aValue: any = a[sortBy];
            let bValue: any = b[sortBy];

            // –î–ª—è —á–∏—Å–µ–ª (price)
            if (sortBy === 'price') {
                aValue = Number(aValue) || 0;
                bValue = Number(bValue) || 0;
            }

            // –°—Ç—Ä–æ–∫–æ–≤–æ–µ —Å—Ä–∞–≤–Ω–µ–Ω–∏–µ
            if (typeof aValue === 'string' && typeof bValue === 'string') {
                aValue = aValue.toLowerCase();
                bValue = bValue.toLowerCase();
            }

            if (aValue < bValue) {
                return sortOrder === 'asc' ? -1 : 1;
            }
            if (aValue > bValue) {
                return sortOrder === 'asc' ? 1 : -1;
            }
            return 0;
        });
    }

    /**
     * –í–∞–ª–∏–¥–∏—Ä—É–µ—Ç –¥–∞–Ω–Ω—ã–µ –∞–∫—Å–µ—Å—Å—É–∞—Ä–∞
     */
    static validateAccessoryData(input: AccessoryCreateInput): AccessoryValidationResult {
        const errors: string[] = [];

        if (!input.name?.trim()) {
            errors.push("–ù–∞–∑–≤–∞–Ω–∏–µ –∞–∫—Å–µ—Å—Å—É–∞—Ä–∞ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ");
        }

        if (!input.accessory_type?.trim()) {
            errors.push("–¢–∏–ø –∞–∫—Å–µ—Å—Å—É–∞—Ä–∞ –æ–±—è–∑–∞—Ç–µ–ª–µ–Ω");
        }

        if (input.price <= 0) {
            errors.push("–¶–µ–Ω–∞ –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å –±–æ–ª—å—à–µ –Ω—É–ª—è");
        }

        return {
            isValid: errors.length === 0,
            errors
        };
    }

    /**
     * –†–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ—Ç –æ–±—â—É—é —Å—Ç–æ–∏–º–æ—Å—Ç—å –≤—ã–±—Ä–∞–Ω–Ω—ã—Ö –∞–∫—Å–µ—Å—Å—É–∞—Ä–æ–≤
     */
    static calculateAccessoriesTotal(
        selectedAccessories: Record<number, number[]>,
        allAccessories: Accessory[]
    ): number {
        let total = 0;

        Object.entries(selectedAccessories).forEach(([equipmentId, accessoryIds]) => {
            accessoryIds.forEach(accessoryId => {
                const accessory = allAccessories.find(acc => acc.id === accessoryId);
                if (accessory) {
                    total += accessory.price;
                }
            });
        });

        return total;
    }

    /**
     * –ü–æ–ª—É—á–∞–µ—Ç –∞–∫—Å–µ—Å—Å—É–∞—Ä—ã –ø–æ –∏—Ö ID
     */
    static getAccessoriesByIds(
        accessoryIds: number[],
        allAccessories: Accessory[]
    ): Accessory[] {
        return allAccessories.filter(accessory => accessoryIds.includes(accessory.id));
    }

    /**
     * –ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç –∫–ª—é—á –¥–ª—è –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏—è –∞–∫—Å–µ—Å—Å—É–∞—Ä–æ–≤
     */
    static generateAccessoriesCacheKey(filters?: AccessoryFilterOptions): string {
        return JSON.stringify(["accessories", filters]);
    }

    /**
     * –ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç –∫–ª—é—á –¥–ª—è –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏—è –∞–∫—Å–µ—Å—Å—É–∞—Ä–æ–≤ –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—è
     */
    static generateEquipmentAccessoriesCacheKey(equipmentId: number): string {
        return JSON.stringify(["equipment-accessories", equipmentId]);
    }
}

```


## <a name="srccoreservicesAvailabilityServicets"></a>`src/core/services/AvailabilityService.ts`

```typescript
// path: src/core/services/AvailabilityService.ts

// src/core/services/AvailabilityService.ts

import { api } from "@/lib/api";
import { formatDate } from "@/lib/utils";
import type { AvailabilityInfo, AvailabilityListResponse, DayStatus } from "@/types/availability";

export interface AvailabilityStatusParams {
    equipmentIds: number[];
    startDate: Date;
    endDate: Date;
    excludeReservationId?: number;
}

export interface DailyStatusParams {
    equipmentIds: number[];
    startDate: Date;
    endDate: Date;
    excludeReservationId?: number;
}

export interface ConflictCheckParams {
    equipmentIds: number[];
    startDate: Date;
    endDate: Date;
    excludeReservationId?: number;
}

/**
 * –°–µ—Ä–≤–∏—Å –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å—é –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—è.
 * –¶–µ–Ω—Ç—Ä–∞–ª–∏–∑—É–µ—Ç –≤—Å–µ API-–∑–∞–ø—Ä–æ—Å—ã, —Å–≤—è–∑–∞–Ω–Ω—ã–µ —Å –ø—Ä–æ–≤–µ—Ä–∫–æ–π –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏.
 */
export class AvailabilityService {
    /**
     * –ü–æ–ª—É—á–∞–µ—Ç –æ–±—â–∏–π —Å—Ç–∞—Ç—É—Å (available, rented, reserved) –¥–ª—è —Å–ø–∏—Å–∫–∞ –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—è.
     * –í—ã–∑—ã–≤–∞–µ—Ç —ç–Ω–¥–ø–æ–∏–Ω—Ç /calendar/view.
     */
    static async getStatuses(params: AvailabilityStatusParams): Promise<AvailabilityInfo[]> {
        if (!params.startDate || !params.endDate || params.equipmentIds.length === 0) {
            return [];
        }

        const searchParams = new URLSearchParams();
        
        searchParams.append("start", formatDate(params.startDate));
        searchParams.append("end", formatDate(params.endDate));
        
        params.equipmentIds.forEach(id => {
            searchParams.append("ids", id.toString());
        });

        if (params.excludeReservationId !== undefined) {
            searchParams.append("exclude_reservation_id", params.excludeReservationId.toString());
        }

        const response = await api.get<AvailabilityListResponse>(`/calendar/view?${searchParams.toString()}`);
        return response.data.items;
    }

    /**
     * –ü–æ–ª—É—á–∞–µ—Ç —Å—Ç–∞—Ç—É—Å—ã –ø–æ –¥–Ω—è–º –¥–ª—è –∫–∞–ª–µ–Ω–¥–∞—Ä—è-–ø–æ–ª–æ—Å–∫–∏.
     * –í—ã–∑—ã–≤–∞–µ—Ç —ç–Ω–¥–ø–æ–∏–Ω—Ç /calendar/day-statuses.
     */
    static async getDailyStatuses(params: DailyStatusParams): Promise<Record<number, DayStatus[]>> {
        if (!params.startDate || !params.endDate || params.equipmentIds.length === 0) {
            return {};
        }

        const searchParams = new URLSearchParams();
        
        searchParams.append("start", formatDate(params.startDate));
        searchParams.append("end", formatDate(params.endDate));
        
        params.equipmentIds.forEach(id => {
            searchParams.append("ids", id.toString());
        });

        if (params.excludeReservationId !== undefined) {
            searchParams.append("exclude_reservation_id", params.excludeReservationId.toString());
        }

        const response = await api.get<Record<number, DayStatus[]>>(`/calendar/day-statuses?${searchParams.toString()}`);
        return response.data;
    }

    /**
     * –ü—Ä–æ–≤–µ—Ä—è–µ—Ç –∫–æ–Ω—Ñ–ª–∏–∫—Ç—ã –¥–ª—è —É–∫–∞–∑–∞–Ω–Ω–æ–≥–æ –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—è.
     * –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Å–ø–∏—Å–æ–∫ ID –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—è —Å –∫–æ–Ω—Ñ–ª–∏–∫—Ç–∞–º–∏.
     * –≠—Ç–æ—Ç –º–µ—Ç–æ–¥ –º–æ–∂–µ—Ç –±—ã—Ç—å –æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω—ã–º, –µ—Å–ª–∏ getStatuses –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏.
     */
    static async checkConflicts(params: ConflictCheckParams): Promise<number[]> {
        const statuses = await this.getStatuses(params);
        
        return statuses
            .filter(info => info.status === "reserved" || info.status === "rented")
            .map(info => info.equipment_id);
    }
}


```


## <a name="srccoreservicesCalendarServicets"></a>`src/core/services/CalendarService.ts`

```typescript
// path: src/core/services/CalendarService.ts

// src/core/services/CalendarService.ts
import { api } from "@/lib/api";
import type { DayStatus } from "@/types/availability";
import type { Equipment } from "@/types/equipment";

export interface CalendarGridData {
  [equipmentId: number]: {
    [date: string]: DayStatus;
  };
}

export interface CalendarFilterOptions {
  type?: string;
  brand?: string;
  query?: string;
}

export class CalendarService {
  /**
   * –ü–æ–ª—É—á–∞–µ—Ç —Å—Ç–∞—Ç—É—Å—ã –¥–Ω–µ–π –¥–ª—è –∫–∞–ª–µ–Ω–¥–∞—Ä—è
   */
  static async getDayStatuses(
    startDate: string,
    endDate: string,
    equipmentIds: number[]
  ): Promise<CalendarGridData> {
    if (!startDate || !endDate) {
      console.warn(
        "[CalendarService] getDayStatuses –≤—ã–∑–≤–∞–Ω —Å –Ω–µ–≤–∞–ª–∏–¥–Ω—ã–º–∏ –¥–∞—Ç–∞–º–∏"
      );
      return {};
    }

    if (equipmentIds.length === 0) {
      console.warn(
        "[CalendarService] getDayStatuses –≤—ã–∑–≤–∞–Ω —Å –ø—É—Å—Ç—ã–º —Å–ø–∏—Å–∫–æ–º ID –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—è"
      );
      return {};
    }

    try {
      const response = await api.get("/calendar/day-statuses", {
        params: {
          start: startDate,
          end: endDate,
          ids: equipmentIds,
        },
      });

      console.log(
        "[CalendarService] API response for /calendar/day-statuses:",
        response
      );

      if (
        response?.data?.equipment_day_statuses !== undefined
      ) {
        return response.data.equipment_day_statuses;
      } else {
        console.error(
          "[CalendarService] API response did not contain 'equipment_day_statuses'",
          response?.data
        );
        return {};
      }
    } catch (error) {
      console.error(
        "[CalendarService] Error fetching /calendar/day-statuses:",
        error
      );
      throw error;
    }
  }

  /**
   * –§–∏–ª—å—Ç—Ä—É–µ—Ç –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏–µ –¥–ª—è –∫–∞–ª–µ–Ω–¥–∞—Ä—è –ø–æ –∑–∞–¥–∞–Ω–Ω—ã–º –∫—Ä–∏—Ç–µ—Ä–∏—è–º
   */
  static filterEquipmentForCalendar(
    equipment: Equipment[],
    options: CalendarFilterOptions
  ): number[] {
    return equipment
      .filter((item) => {
        // –§–∏–ª—å—Ç—Ä –ø–æ —Ç–∏–ø—É
        if (options.type && options.type !== item.equipment_type) {
          return false;
        }

        // –§–∏–ª—å—Ç—Ä –ø–æ –±—Ä–µ–Ω–¥—É
        if (options.brand && options.brand !== "__all__" && options.brand !== item.brand) {
          return false;
        }

        // –§–∏–ª—å—Ç—Ä –ø–æ –ø–æ–∏—Å–∫–æ–≤–æ–º—É –∑–∞–ø—Ä–æ—Å—É
        if (options.query) {
          const query = options.query.toLowerCase();
          const matchesQuery =
            item.name?.toLowerCase().includes(query) ||
            item.brand?.toLowerCase().includes(query) ||
            item.equipment_type?.toLowerCase().includes(query);
          
          if (!matchesQuery) {
            return false;
          }
        }

        return true;
      })
      .map((item) => item.id);
  }

  /**
   * –°–æ–∑–¥–∞–µ—Ç –∫–ª—é—á –∑–∞–ø—Ä–æ—Å–∞ –¥–ª—è –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏—è
   */
  static createQueryKey(
    startDate: string,
    endDate: string,
    equipmentIds: number[]
  ): string[] {
    return [
      "calendar-grid",
      startDate,
      endDate,
      JSON.stringify(equipmentIds.sort((a, b) => a - b)),
    ];
  }
} 

```


## <a name="srccoreservicesDateServicets"></a>`src/core/services/DateService.ts`

```typescript
// path: src/core/services/DateService.ts

// src/core/services/DateService.ts

import { addDays, format } from 'date-fns';

export interface DateRange {
  startDate: Date;
  endDate: Date;
}

export interface DateRangeValidationResult {
  isValid: boolean;
  error?: string;
  adjustedRange?: DateRange;
}

export class DateService {
  /**
   * –ö–æ—Ä—Ä–µ–∫—Ç–∏—Ä—É–µ—Ç –¥–∞—Ç—É, –µ—Å–ª–∏ –æ–Ω–∞ –≤—ã–ø–∞–¥–∞–µ—Ç –Ω–∞ –≤—ã—Ö–æ–¥–Ω–æ–π, —Å–¥–≤–∏–≥–∞—è –µ—ë –Ω–∞ –±–ª–∏–∂–∞–π—à–∏–π —Ä–∞–±–æ—á–∏–π –¥–µ–Ω—å.
   * @param date - –ü—Ä–æ–≤–µ—Ä—è–µ–º–∞—è –¥–∞—Ç–∞
   * @param holidays - –ú–∞—Å—Å–∏–≤ –¥–∞—Ç-–≤—ã—Ö–æ–¥–Ω—ã—Ö
   * @returns –°–∫–æ—Ä—Ä–µ–∫—Ç–∏—Ä–æ–≤–∞–Ω–Ω–∞—è –¥–∞—Ç–∞
   */
  static adjustDateIfHoliday(date: Date, holidays: Date[]): Date {
    let adjustedDate = new Date(date);
    const holidaySet = new Set(holidays.map(h => format(h, 'yyyy-MM-dd')));

    // –ü–æ–∫–∞ –∏—Ç–æ–≥–æ–≤–∞—è –¥–∞—Ç–∞ —è–≤–ª—è–µ—Ç—Å—è –≤—ã—Ö–æ–¥–Ω—ã–º, –¥–æ–±–∞–≤–ª—è–µ–º –æ–¥–∏–Ω –¥–µ–Ω—å
    while (holidaySet.has(format(adjustedDate, 'yyyy-MM-dd'))) {
      adjustedDate = addDays(adjustedDate, 1);
    }
    return adjustedDate;
  }

  /**
   * –í–∞–ª–∏–¥–∏—Ä—É–µ—Ç –¥–∏–∞–ø–∞–∑–æ–Ω –¥–∞—Ç
   */
  static validateDateRange(startDate: Date, endDate: Date): DateRangeValidationResult {
    if (!startDate || !endDate) {
      return {
        isValid: false,
        error: '–î–∞—Ç—ã –Ω–∞—á–∞–ª–∞ –∏ –æ–∫–æ–Ω—á–∞–Ω–∏—è –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã'
      };
    }

    if (isNaN(startDate.getTime()) || isNaN(endDate.getTime())) {
      return {
        isValid: false,
        error: '–ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç –¥–∞—Ç—ã'
      };
    }

    if (startDate >= endDate) {
      return {
        isValid: false,
        error: '–î–∞—Ç–∞ –æ–∫–æ–Ω—á–∞–Ω–∏—è –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å –ø–æ–∑–∂–µ –¥–∞—Ç—ã –Ω–∞—á–∞–ª–∞'
      };
    }

    return {
      isValid: true
    };
  }

  /**
   * –ö–æ—Ä—Ä–µ–∫—Ç–∏—Ä—É–µ—Ç –¥–∏–∞–ø–∞–∑–æ–Ω –¥–∞—Ç, –µ—Å–ª–∏ endDate —Ä–∞–Ω—å—à–µ startDate
   */
  static adjustDateRange(startDate: Date, endDate: Date): DateRange {
    if (startDate >= endDate) {
      const adjustedEndDate = new Date(startDate);
      adjustedEndDate.setDate(adjustedEndDate.getDate() + 1);
      return {
        startDate,
        endDate: adjustedEndDate
      };
    }

    return { startDate, endDate };
  }

  /**
   * –ü—Ä–æ–≤–µ—Ä—è–µ—Ç, —è–≤–ª—è–µ—Ç—Å—è –ª–∏ –¥–∞—Ç–∞ –≤–∞–ª–∏–¥–Ω–æ–π
   */
  static isValidDate(date: Date): boolean {
    return date instanceof Date && !isNaN(date.getTime());
  }

  /**
   * –°–æ–∑–¥–∞–µ—Ç —Å–ª–µ–¥—É—é—â—É—é –¥–∞—Ç—É –ø–æ—Å–ª–µ —É–∫–∞–∑–∞–Ω–Ω–æ–π
   */
  static getNextDay(date: Date): Date {
    const nextDay = new Date(date);
    nextDay.setDate(nextDay.getDate() + 1);
    return nextDay;
  }

  /**
   * –°–æ–∑–¥–∞–µ—Ç –ø—Ä–µ–¥—ã–¥—É—â—É—é –¥–∞—Ç—É –ø–µ—Ä–µ–¥ —É–∫–∞–∑–∞–Ω–Ω–æ–π
   */
  static getPreviousDay(date: Date): Date {
    const previousDay = new Date(date);
    previousDay.setDate(previousDay.getDate() - 1);
    return previousDay;
  }

  /**
   * –í—ã—á–∏—Å–ª—è–µ—Ç –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –¥–Ω–µ–π –º–µ–∂–¥—É –¥–≤—É–º—è –¥–∞—Ç–∞–º–∏
   */
  static getDaysDifference(startDate: Date, endDate: Date): number {
    const timeDiff = endDate.getTime() - startDate.getTime();
    return Math.ceil(timeDiff / (1000 * 3600 * 24));
  }

  /**
   * –ü—Ä–æ–≤–µ—Ä—è–µ—Ç, –Ω–∞—Ö–æ–¥–∏—Ç—Å—è –ª–∏ –¥–∞—Ç–∞ –≤ –∑–∞–¥–∞–Ω–Ω–æ–º –¥–∏–∞–ø–∞–∑–æ–Ω–µ
   */
  static isDateInRange(date: Date, startDate: Date, endDate: Date): boolean {
    return date >= startDate && date <= endDate;
  }

  /**
   * –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ—Ç –¥–∞—Ç—É –≤ —Å—Ç—Ä–æ–∫—É –¥–ª—è API (YYYY-MM-DD)
   */
  static formatDateForAPI(date: Date): string {
    return date.toISOString().split('T')[0];
  }

  /**
   * –ü–∞—Ä—Å–∏—Ç —Å—Ç—Ä–æ–∫—É –¥–∞—Ç—ã –≤ –æ–±—ä–µ–∫—Ç Date
   */
  static parseDate(dateString: string): Date | null {
    const date = new Date(dateString);
    return this.isValidDate(date) ? date : null;
  }

  /**
   * –ù–∞—Ö–æ–¥–∏—Ç —Å–ª–µ–¥—É—é—â–∏–π —Ä–∞–±–æ—á–∏–π –¥–µ–Ω—å, –∏—Å–∫–ª—é—á–∞—è –ø—Ä–∞–∑–¥–Ω–∏–∫–∏
   * @param startDate - –Ω–∞—á–∞–ª—å–Ω–∞—è –¥–∞—Ç–∞
   * @param holidays - –º–∞—Å—Å–∏–≤ –¥–∞—Ç –ø—Ä–∞–∑–¥–Ω–∏–∫–æ–≤
   * @param daysToAdd - –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –¥–Ω–µ–π –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é 1)
   * @returns –î–∞—Ç–∞ —Å–ª–µ–¥—É—é—â–µ–≥–æ —Ä–∞–±–æ—á–µ–≥–æ –¥–Ω—è
   */
  static findNextWorkingDay(startDate: Date, holidays: Date[], daysToAdd: number = 1): Date {
    let finalDate = addDays(startDate, daysToAdd);

    // –°–æ–∑–¥–∞–µ–º Set –∏–∑ –¥–∞—Ç –ø—Ä–∞–∑–¥–Ω–∏–∫–æ–≤ –¥–ª—è –±—ã—Å—Ç—Ä–æ–π –ø—Ä–æ–≤–µ—Ä–∫–∏
    const holidaySet = new Set(holidays.map(h => format(h, 'yyyy-MM-dd')));

    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–µ —è–≤–ª—è–µ—Ç—Å—è –ª–∏ –∫–æ–Ω–µ—á–Ω–∞—è –¥–∞—Ç–∞ –≤—ã—Ö–æ–¥–Ω—ã–º.
    // –ï—Å–ª–∏ –¥–∞, —Å–¥–≤–∏–≥–∞–µ–º –µ–µ –≤–ø–µ—Ä–µ–¥ –¥–æ —Ç–µ—Ö –ø–æ—Ä, –ø–æ–∫–∞ –Ω–µ –Ω–∞–π–¥–µ–º —Ä–∞–±–æ—á–∏–π –¥–µ–Ω—å.
    while (holidaySet.has(format(finalDate, 'yyyy-MM-dd'))) {
      finalDate = addDays(finalDate, 1);
    }

    return finalDate;
  }

  /**
   * –°–æ–∑–¥–∞–µ—Ç –¥–∏–∞–ø–∞–∑–æ–Ω –¥–∞—Ç —Å –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–º –ø–æ–∏—Å–∫–æ–º —Ä–∞–±–æ—á–µ–≥–æ –¥–Ω—è –æ–∫–æ–Ω—á–∞–Ω–∏—è
   * @param startDate - –¥–∞—Ç–∞ –Ω–∞—á–∞–ª–∞
   * @param holidays - –º–∞—Å—Å–∏–≤ –¥–∞—Ç –ø—Ä–∞–∑–¥–Ω–∏–∫–æ–≤
   * @param daysToAdd - –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –¥–Ω–µ–π –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é 1)
   * @returns –û–±—ä–µ–∫—Ç —Å –¥–∞—Ç–∞–º–∏ –Ω–∞—á–∞–ª–∞ –∏ –æ–∫–æ–Ω—á–∞–Ω–∏—è
   */
  static createWorkingDayRange(startDate: Date, holidays: Date[], daysToAdd: number = 1): DateRange {
    const endDate = this.findNextWorkingDay(startDate, holidays, daysToAdd);
    return {
      startDate,
      endDate
    };
  }
}

```


## <a name="srccoreservicesEquipmentServicets"></a>`src/core/services/EquipmentService.ts`

```typescript
// path: src/core/services/EquipmentService.ts

// src/core/services/EquipmentService.ts

import { api } from "@/lib/api";
import type { Equipment } from "@/types/equipment";
import type { AvailabilityInfo, AvailabilityListResponse } from "@/types/availability";
import { formatDate } from "@/lib/utils"; // 1. –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ —ç—Ç–æ—Ç –∏–º–ø–æ—Ä—Ç –ø—Ä–∏—Å—É—Ç—Å—Ç–≤—É–µ—Ç

export interface EquipmentListResponse {
    items: Equipment[];
    total: number;
}

export interface EquipmentFilterParams {
    query?: string;
    type?: string | null;
    brand?: string | null;
    associationId?: number | null;
    startDate?: Date | null;
    endDate?: Date | null;
    availableOnly?: boolean;
}

export class EquipmentService {
    static async getAllEquipment(
        skip: number,
        limit: number,
        filters: EquipmentFilterParams = {}
    ): Promise<EquipmentListResponse> {
        const params: Record<string, any> = { skip, limit };

        if (filters.query) {
            params.query = filters.query;
        }
        if (filters.type) {
            params.type = filters.type;
        }
        if (filters.brand) {
            params.brand = filters.brand;
        }
        if (filters.associationId) {
            params.associationId = filters.associationId;
        }

        if (filters.availableOnly && filters.startDate && filters.endDate) {
            params.availableOnly = true;
            params.startDate = formatDate(filters.startDate);
            params.endDate = formatDate(filters.endDate);
        }

        const response = await api.get<EquipmentListResponse>("/equipment/", { params });
        return response.data;
    }

    static async checkAvailability(input: { ids: number[]; start: Date | null; end: Date | null; excludeReservationId?: number; }): Promise<AvailabilityInfo[]> {
        if (!input.start || !input.end || input.ids.length === 0) {
            return [];
        }

        const searchParams = new URLSearchParams();

        // V-- 2. –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï –ó–î–ï–°–¨ --V
        searchParams.append("start", formatDate(input.start));
        searchParams.append("end", formatDate(input.end));
        // ^-- –ö–û–ù–ï–¶ –ò–°–ü–†–ê–í–õ–ï–ù–ò–Ø --^

        input.ids.forEach(id => {
            searchParams.append("ids", id.toString());
        });

        if (input.excludeReservationId !== undefined) {
            searchParams.append("exclude_reservation_id", input.excludeReservationId.toString());
        }

        const response = await api.get<AvailabilityListResponse>(`/calendar/view?${searchParams.toString()}`);
        return response.data.items;
    }

    static filterAndGroupEquipment(
        allEquipment: Equipment[],
        searchQuery: string
    ): { tree: Record<string, Record<string, Equipment[]>>; visibleIds: number[] } {
        const lowerCaseQuery = searchQuery.toLowerCase();
        const filtered = searchQuery
            ? allEquipment.filter(item =>
                item.name.toLowerCase().includes(lowerCaseQuery) ||
                item.brand.toLowerCase().includes(lowerCaseQuery) ||
                item.equipment_type.toLowerCase().includes(lowerCaseQuery)
            )
            : allEquipment;

        const visibleIds = filtered.map(item => item.id);

        const tree: Record<string, Record<string, Equipment[]>> = {};
        for (const eq of filtered) {
            if (!tree[eq.equipment_type]) {
                tree[eq.equipment_type] = {};
            }
            if (!tree[eq.equipment_type][eq.brand]) {
                tree[eq.equipment_type][eq.brand] = [];
            }
            tree[eq.equipment_type][eq.brand].push(eq);
        }

        return { tree, visibleIds };
    }

    static filterEquipment(
        equipmentData: Equipment[],
        params: EquipmentFilterParams
    ): Equipment[] {
        let result = equipmentData;
        if (params.query) {
            const lowerCaseQuery = params.query.toLowerCase();
            result = result.filter((item) =>
                item.name.toLowerCase().includes(lowerCaseQuery) ||
                item.brand.toLowerCase().includes(lowerCaseQuery) ||
                item.equipment_type.toLowerCase().includes(lowerCaseQuery)
            );
        }
        if (params.type) {
            result = result.filter((item) => item.equipment_type === params.type);
        }
        if (params.brand && params.brand !== "__all__") {
            result = result.filter((item) => item.brand === params.brand);
        }
        return result;
    }

    static async getEquipmentById(id: number): Promise<Equipment> {
        const response = await api.get(`/equipment/${id}`);
        return response.data;
    }

    static async createEquipment(input: Omit<Equipment, 'id' | 'accessories' | 'associations'>): Promise<Equipment> {
        const response = await api.post("/equipment/", input);
        return response.data;
    }

    static async updateEquipment(id: number, input: Partial<Omit<Equipment, 'id'>>): Promise<Equipment> {
        const response = await api.put(`/equipment/${id}`, input);
        return response.data;
    }

    static async deleteEquipment(id: number): Promise<void> {
        await api.delete(`/equipment/${id}`);
    }
}

```


## <a name="srccoreservicesPhoneServicets"></a>`src/core/services/PhoneService.ts`

```typescript
// path: src/core/services/PhoneService.ts

// src/core/services/PhoneService.ts

export interface PhoneValidationResult {
  isValid: boolean;
  error?: string;
  normalizedPhone?: string;
}

export class PhoneService {
  /**
   * –í–∞–ª–∏–¥–∏—Ä—É–µ—Ç —Ä–æ—Å—Å–∏–π—Å–∫–∏–π —Ç–µ–ª–µ—Ñ–æ–Ω–Ω—ã–π –Ω–æ–º–µ—Ä
   */
  static validate(phone: string): PhoneValidationResult {
    if (!phone) {
      return {
        isValid: false,
        error: '–ù–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞ –æ–±—è–∑–∞—Ç–µ–ª–µ–Ω'
      };
    }

    const normalized = this.normalize(phone);
    
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –Ω–æ–º–µ—Ä —Å–æ–¥–µ—Ä–∂–∏—Ç —Ç–æ–ª—å–∫–æ —Ü–∏—Ñ—Ä—ã
    if (!/^\d+$/.test(normalized)) {
      return {
        isValid: false,
        error: '–ù–æ–º–µ—Ä –¥–æ–ª–∂–µ–Ω —Å–æ–¥–µ—Ä–∂–∞—Ç—å —Ç–æ–ª—å–∫–æ —Ü–∏—Ñ—Ä—ã'
      };
    }

    // –ü—Ä–æ–≤–µ—Ä—è–µ–º –¥–ª–∏–Ω—É (10 –∏–ª–∏ 11 —Ü–∏—Ñ—Ä –¥–ª—è —Ä–æ—Å—Å–∏–π—Å–∫–∏—Ö –Ω–æ–º–µ—Ä–æ–≤)
    if (normalized.length < 10 || normalized.length > 11) {
      return {
        isValid: false,
        error: '–ù–æ–º–µ—Ä –¥–æ–ª–∂–µ–Ω —Å–æ–¥–µ—Ä–∂–∞—Ç—å 10 –∏–ª–∏ 11 —Ü–∏—Ñ—Ä'
      };
    }

    // –ï—Å–ª–∏ 11 —Ü–∏—Ñ—Ä, –ø–µ—Ä–≤–∞—è –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å 7 –∏–ª–∏ 8
    if (normalized.length === 11 && !['7', '8'].includes(normalized[0])) {
      return {
        isValid: false,
        error: '–ù–æ–º–µ—Ä –¥–æ–ª–∂–µ–Ω –Ω–∞—á–∏–Ω–∞—Ç—å—Å—è —Å 7 –∏–ª–∏ 8'
      };
    }

    return {
      isValid: true,
      normalizedPhone: normalized
    };
  }

  /**
   * –ù–æ—Ä–º–∞–ª–∏–∑—É–µ—Ç —Ç–µ–ª–µ—Ñ–æ–Ω–Ω—ã–π –Ω–æ–º–µ—Ä (—É–±–∏—Ä–∞–µ—Ç –≤—Å–µ —Å–∏–º–≤–æ–ª—ã –∫—Ä–æ–º–µ —Ü–∏—Ñ—Ä)
   */
  static normalize(phone: string): string {
    return phone.replace(/\D/g, '');
  }

  /**
   * –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ—Ç —Ç–µ–ª–µ—Ñ–æ–Ω–Ω—ã–π –Ω–æ–º–µ—Ä –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è
   */
  static format(phone: string): string {
    const normalized = this.normalize(phone);
    
    if (normalized.length === 11) {
      // +7 (XXX) XXX-XX-XX
      return `+7 (${normalized.slice(1, 4)}) ${normalized.slice(4, 7)}-${normalized.slice(7, 9)}-${normalized.slice(9)}`;
    } else if (normalized.length === 10) {
      // +7 (XXX) XXX-XX-XX (–¥–æ–±–∞–≤–ª—è–µ–º 7 –≤ –Ω–∞—á–∞–ª–æ)
      return `+7 (${normalized.slice(0, 3)}) ${normalized.slice(3, 6)}-${normalized.slice(6, 8)}-${normalized.slice(8)}`;
    }
    
    return phone; // –í–æ–∑–≤—Ä–∞—â–∞–µ–º –∫–∞–∫ –µ—Å—Ç—å, –µ—Å–ª–∏ –Ω–µ —É–¥–∞–µ—Ç—Å—è –æ—Ç—Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞—Ç—å
  }

  /**
   * –ü–æ–ª—É—á–∞–µ—Ç –ø–æ–ª–Ω—ã–π –Ω–æ–º–µ—Ä –¥–ª—è API (–≤—Å–µ–≥–¥–∞ 11 —Ü–∏—Ñ—Ä —Å 7 –≤ –Ω–∞—á–∞–ª–µ)
   */
  static getFullNumber(phone: string): string {
    const normalized = this.normalize(phone);
    
    if (normalized.length === 11) {
      return normalized;
    } else if (normalized.length === 10) {
      return `7${normalized}`;
    }
    
    return normalized; // –í–æ–∑–≤—Ä–∞—â–∞–µ–º –∫–∞–∫ –µ—Å—Ç—å, –µ—Å–ª–∏ –Ω–µ —É–¥–∞–µ—Ç—Å—è –æ–±—Ä–∞–±–æ—Ç–∞—Ç—å
  }
} 

```


## <a name="srccoreservicesPromoCodeServicets"></a>`src/core/services/PromoCodeService.ts`

```typescript
// path: src/core/services/PromoCodeService.ts

// src/core/services/PromoCodeService.ts

import { api } from "@/lib/api";
import type { PromoCodeOut, PromoCodeCreate, PromoCodeUpdate } from "@/types/promo_code";

export interface PromoCodeValidationResult {
    isValid: boolean;
    message: string | null;
    discountPercentage: number;
}

export interface PromoCodeFilterOptions {
    isActive?: boolean;
    search?: string;
}

export class PromoCodeService {
    /**
     * –ü–æ–ª—É—á–∞–µ—Ç –≤—Å–µ –ø—Ä–æ–º–æ–∫–æ–¥—ã
     */
    static async getAllPromoCodes(): Promise<PromoCodeOut[]> {
        const response = await api.get("/promocodes/");
        return response.data;
    }

    /**
     * –ü–æ–ª—É—á–∞–µ—Ç –ø—Ä–æ–º–æ–∫–æ–¥ –ø–æ ID
     */
    static async getPromoCodeById(id: number): Promise<PromoCodeOut> {
        const response = await api.get(`/promocodes/${id}`);
        return response.data;
    }

    /**
     * –°–æ–∑–¥–∞–µ—Ç –Ω–æ–≤—ã–π –ø—Ä–æ–º–æ–∫–æ–¥
     */
    static async createPromoCode(input: PromoCodeCreate): Promise<PromoCodeOut> {
        const response = await api.post("/promocodes/", input);
        return response.data;
    }

    /**
     * –û–±–Ω–æ–≤–ª—è–µ—Ç –ø—Ä–æ–º–æ–∫–æ–¥
     */
    static async updatePromoCode(id: number, input: PromoCodeUpdate): Promise<PromoCodeOut> {
        const response = await api.put(`/promocodes/${id}`, input);
        return response.data;
    }

    /**
     * –£–¥–∞–ª—è–µ—Ç –ø—Ä–æ–º–æ–∫–æ–¥
     */
    static async deletePromoCode(id: number): Promise<void> {
        await api.delete(`/promocodes/${id}`);
    }

    /**
     * –ê–∫—Ç–∏–≤–∏—Ä—É–µ—Ç/–¥–µ–∞–∫—Ç–∏–≤–∏—Ä—É–µ—Ç –ø—Ä–æ–º–æ–∫–æ–¥
     */
    static async togglePromoCodeStatus(id: number, isActive: boolean): Promise<PromoCodeOut> {
        const response = await api.patch(`/promocodes/${id}/toggle-status`, { is_active: isActive });
        return response.data;
    }

    /**
     * –í–∞–ª–∏–¥–∏—Ä—É–µ—Ç –ø—Ä–æ–º–æ–∫–æ–¥ –¥–ª—è –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ –∑–∞–∫–∞–∑–∞
     */
    static async validatePromoCode(
        code: string,
        equipmentIds: number[],
        totalAmount: number,
        userId?: number
    ): Promise<PromoCodeValidationResult> {
        try {
            const response = await api.post("/promocodes/validate", {
                code,
                equipment_ids: equipmentIds,
                total_amount: totalAmount,
                user_id: userId
            });
            return response.data;
        } catch (error: any) {
            return {
                isValid: false,
                message: error.response?.data?.detail || "–ü—Ä–æ–º–æ–∫–æ–¥ –Ω–µ–¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª–µ–Ω",
                discountPercentage: 0
            };
        }
    }

    /**
     * –§–∏–ª—å—Ç—Ä—É–µ—Ç –ø—Ä–æ–º–æ–∫–æ–¥—ã –ø–æ –∑–∞–¥–∞–Ω–Ω—ã–º –∫—Ä–∏—Ç–µ—Ä–∏—è–º
     */
    static filterPromoCodes(
        promoCodes: PromoCodeOut[],
        filters: PromoCodeFilterOptions
    ): PromoCodeOut[] {
        return promoCodes.filter(promo => {
            // –§–∏–ª—å—Ç—Ä –ø–æ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏
            if (filters.isActive !== undefined && promo.is_active !== filters.isActive) {
                return false;
            }

            // –§–∏–ª—å—Ç—Ä –ø–æ –ø–æ–∏—Å–∫—É
            if (filters.search) {
                const searchLower = filters.search.toLowerCase();
                const matchesSearch = 
                    promo.code.toLowerCase().includes(searchLower) ||
                    (promo.description && promo.description.toLowerCase().includes(searchLower));
                
                if (!matchesSearch) {
                    return false;
                }
            }

            return true;
        });
    }

    /**
     * –í–∞–ª–∏–¥–∏—Ä—É–µ—Ç –¥–∞–Ω–Ω—ã–µ –ø—Ä–æ–º–æ–∫–æ–¥–∞ –ø–µ—Ä–µ–¥ —Å–æ–∑–¥–∞–Ω–∏–µ–º/–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ–º
     */
    static validatePromoCodeData(input: PromoCodeCreate): { isValid: boolean; errors: string[] } {
        const errors: string[] = [];

        if (!input.code?.trim()) {
            errors.push("–ö–æ–¥ –ø—Ä–æ–º–æ–∫–æ–¥–∞ –æ–±—è–∑–∞—Ç–µ–ª–µ–Ω");
        }

        if (input.discount_percentage <= 0 || input.discount_percentage > 100) {
            errors.push("–ü—Ä–æ—Ü–µ–Ω—Ç —Å–∫–∏–¥–∫–∏ –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –æ—Ç 1 –¥–æ 100");
        }

        if (input.valid_from && input.expires_at) {
            const validFrom = new Date(input.valid_from);
            const expiresAt = new Date(input.expires_at);
            
            if (validFrom >= expiresAt) {
                errors.push("–î–∞—Ç–∞ –æ–∫–æ–Ω—á–∞–Ω–∏—è –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å –ø–æ–∑–∂–µ –¥–∞—Ç—ã –Ω–∞—á–∞–ª–∞");
            }
        }

        if (input.max_uses !== null && input.max_uses <= 0) {
            errors.push("–ú–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–π –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å –±–æ–ª—å—à–µ –Ω—É–ª—è");
        }

        if (input.max_uses_per_user !== null && input.max_uses_per_user <= 0) {
            errors.push("–ú–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–π –Ω–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å –±–æ–ª—å—à–µ –Ω—É–ª—è");
        }

        if (input.min_order_amount !== null && input.min_order_amount <= 0) {
            errors.push("–ú–∏–Ω–∏–º–∞–ª—å–Ω–∞—è —Å—É–º–º–∞ –∑–∞–∫–∞–∑–∞ –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å –±–æ–ª—å—à–µ –Ω—É–ª—è");
        }

        return {
            isValid: errors.length === 0,
            errors
        };
    }

    /**
     * –ü—Ä–æ–≤–µ—Ä—è–µ—Ç, –∞–∫—Ç–∏–≤–µ–Ω –ª–∏ –ø—Ä–æ–º–æ–∫–æ–¥ –≤ –¥–∞–Ω–Ω—ã–π –º–æ–º–µ–Ω—Ç
     */
    static isPromoCodeActive(promoCode: PromoCodeOut): boolean {
        if (!promoCode.is_active) {
            return false;
        }

        const now = new Date();

        // –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–∞—Ç—ã –Ω–∞—á–∞–ª–∞
        if (promoCode.valid_from) {
            const validFrom = new Date(promoCode.valid_from);
            if (now < validFrom) {
                return false;
            }
        }

        // –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–∞—Ç—ã –æ–∫–æ–Ω—á–∞–Ω–∏—è
        if (promoCode.expires_at) {
            const expiresAt = new Date(promoCode.expires_at);
            if (now > expiresAt) {
                return false;
            }
        }

        // –ü—Ä–æ–≤–µ—Ä–∫–∞ –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–≥–æ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–π
        if (promoCode.max_uses !== null && promoCode.times_used >= promoCode.max_uses) {
            return false;
        }

        return true;
    }

    /**
     * –ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç –∫–ª—é—á –¥–ª—è –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏—è –ø—Ä–æ–º–æ–∫–æ–¥–æ–≤
     */
    static generatePromoCodesCacheKey(filters?: PromoCodeFilterOptions): string {
        return JSON.stringify(["promo-codes", filters]);
    }

    /**
     * –ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç –∫–ª—é—á –¥–ª—è –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏—è –≤–∞–ª–∏–¥–∞—Ü–∏–∏ –ø—Ä–æ–º–æ–∫–æ–¥–∞
     */
    static generateValidationCacheKey(
        code: string,
        equipmentIds: number[],
        totalAmount: number,
        userId?: number
    ): string {
        return JSON.stringify([
            "promo-code-validation",
            code,
            equipmentIds.sort(),
            totalAmount,
            userId
        ]);
    }
} 

```


## <a name="srccoreservicesReservationServicets"></a>`src/core/services/ReservationService.ts`

```typescript
// path: src/core/services/ReservationService.ts

// src/core/services/ReservationService.ts

import { api } from "@/lib/api";
import type { Equipment } from "@/types/equipment";
import type { Reservation, ReservationWithNames, ReservationListResponse } from "@/types/reservation";

// –ï–¥–∏–Ω—ã–π —Ç–∏–ø –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è —Ä–µ–∑–µ—Ä–≤–∞, –∫–æ—Ç–æ—Ä—ã–π –±—É–¥–µ—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å—Å—è –≤–µ–∑–¥–µ
export interface ReservationCreateInput {
    user_id?: number;
    start_date: string;
    end_date: string;
    equipment_ids: number[];
    selected_accessories: Record<number, number[]>;
    promo_code?: string;
}

export interface ReservationUpdateInput {
    id: number;
    start_date: string;
    end_date: string;
    equipment_ids: number[];
    selected_accessories: Record<number, number[]>;
    promo_code?: string;
    isAdminContext?: boolean;
}

export class ReservationService {
    /**
     * –†–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ—Ç —Å—Ç–æ–∏–º–æ—Å—Ç—å —Ä–µ–∑–µ—Ä–≤–∞
     */
    static async calculatePrice(input: Omit<ReservationCreateInput, 'user_id'>): Promise<any> {
        const payload = {
            ...input,
            selected_accessories: input.selected_accessories || {},
            promo_code: input.promo_code || null,
        };

        const response = await api.post("/reservations/calculate", payload);
        return response.data;
    }

    /**
     * –°–æ–∑–¥–∞–µ—Ç –Ω–æ–≤—ã–π —Ä–µ–∑–µ—Ä–≤
     */
    static async createReservation(input: ReservationCreateInput) {
        const { user_id, ...payload } = input;
        const finalPayload = user_id !== undefined ? { user_id, ...payload } : payload;

        const response = await api.post("/reservations/", finalPayload);
        return response.data;
    }

    /**
     * –û–±–Ω–æ–≤–ª—è–µ—Ç —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π —Ä–µ–∑–µ—Ä–≤
     */
    static async updateReservation(input: ReservationUpdateInput) {
        const { isAdminContext, id, ...payload } = input;
        const url = isAdminContext
            ? `/admin/reservations/${id}`
            : `/reservations/${id}`;

        const response = await api.put(url, payload);
        return response.data;
    }

    /**
     * –û—Ç–º–µ–Ω—è–µ—Ç —Ä–µ–∑–µ—Ä–≤
     */
    static async cancelReservation(id: number) {
        const response = await api.delete(`/reservations/${id}`);
        return response.data;
    }

    /**
     * –ü–æ–ª—É—á–∞–µ—Ç —Å–ø–∏—Å–æ–∫ —Ä–µ–∑–µ—Ä–≤–æ–≤ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
     */
    static async getUserReservations(params?: { search?: string; status?: string; sort?: string }): Promise<Reservation[]> {
        // –£–∫–∞–∑—ã–≤–∞–µ–º, —á—Ç–æ –æ–∂–∏–¥–∞–µ–º –æ–±—ä–µ–∫—Ç —Å –ø–∞–≥–∏–Ω–∞—Ü–∏–µ–π
        const response = await api.get<ReservationListResponse>("/reservations/", {
            params: params ? {
                search: params.search,
                status: params.status,
                sort: params.sort
            } : undefined
        });
        // –í–æ–∑–≤—Ä–∞—â–∞–µ–º —Ç–æ–ª—å–∫–æ –º–∞—Å—Å–∏–≤ items
        return response.data.items;
    }

    /**
     * –ü–æ–ª—É—á–∞–µ—Ç –≤—Å–µ —Ä–µ–∑–µ—Ä–≤—ã (–¥–ª—è –∞–¥–º–∏–Ω–∞)
     */
    static async getAllReservations() {
        // –ü—Ä–∏–º–µ—á–∞–Ω–∏–µ: —ç—Ç–æ—Ç –º–µ—Ç–æ–¥ –Ω–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–ª—è –ø–∞–≥–∏–Ω–∞—Ü–∏–∏, –Ω–æ –æ—Å—Ç–∞–≤–ª–µ–Ω –¥–ª—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏.
        // –î–ª—è –ø–∞–≥–∏–Ω–∏—Ä–æ–≤–∞–Ω–Ω–æ–≥–æ —Å–ø–∏—Å–∫–∞ –∞–¥–º–∏–Ω–∞ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è /admin/reservations
        const response = await api.get("/reservations/");
        return response.data;
    }

    /**
     * –ü–æ–ª—É—á–∞–µ—Ç –¥–µ—Ç–∞–ª–∏ —Ä–µ–∑–µ—Ä–≤–∞ –ø–æ ID
     */
    static async getReservationById(id: number) {
        const response = await api.get(`/reservations/${id}`);
        return response.data;
    }

    /**
     * –ü—Ä–µ–æ–±—Ä–∞–∑—É–µ—Ç —Ä–µ–∑–µ—Ä–≤—ã, –¥–æ–±–∞–≤–ª—è—è –∏–º–µ–Ω–∞ –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—è
     */
    static createReservationsWithNames(
        reservationsData: Reservation[],
        equipmentMap: Record<number, Equipment>
    ): ReservationWithNames[] {
        if (!reservationsData || reservationsData.length === 0) {
            return [];
        }

        return reservationsData.map((r: Reservation) => ({
            ...r,
            equipment_names: r.equipment_ids
                .map((id: number) => equipmentMap[id])
                .filter((eq): eq is Equipment => Boolean(eq))
                .map((eq: Equipment) => `${eq.equipment_type} ${eq.brand} ${eq.name}`),
        }));
    }
}

```


## <a name="srccoreservicesUserServicets"></a>`src/core/services/UserService.ts`

```typescript
// path: src/core/services/UserService.ts

// src/core/services/UserService.ts

import { api } from "@/lib/api";
import type { UserOut, UserRole, UserListResponse, UserPaymentRequest } from "@/types/user";
import type { BalanceHistoryListResponse } from "@/types/balanceHistory";

export interface UserCreateInput {
    full_name: string;
    email: string;
    password: string;
    role: UserRole;
    phone?: string;
    privacyPolicyAccepted: boolean;
    termsAccepted: boolean;
    emailVerified: boolean;
}

export interface UserUpdateInput extends Partial<UserCreateInput> {
    id: number;
}

export interface UserFilterOptions {
    search?: string;
    role?: UserRole;
    isActive?: boolean;
    status?: string;
}

export interface UserValidationResult {
    isValid: boolean;
    errors: string[];
}

export class UserService {
    /**
     * –ü—Ä–µ–æ–±—Ä–∞–∑—É–µ—Ç camelCase –ø–æ–ª—è –≤ snake_case –¥–ª—è API
     */
    private static toApiFormat(input: Partial<UserCreateInput>): Record<string, any> {
        const apiPayload: Record<string, any> = {};

        if (input.full_name !== undefined) apiPayload.full_name = input.full_name;
        if (input.email !== undefined) apiPayload.email = input.email;
        if (input.password !== undefined) apiPayload.password = input.password;
        if (input.role !== undefined) apiPayload.role = input.role;
        if (input.phone !== undefined) apiPayload.phone = input.phone;
        if (input.privacyPolicyAccepted !== undefined) apiPayload.privacy_policy_accepted = input.privacyPolicyAccepted;
        if (input.termsAccepted !== undefined) apiPayload.terms_accepted = input.termsAccepted;
        if (input.emailVerified !== undefined) apiPayload.email_verified = input.emailVerified;

        return apiPayload;
    }

    /**
     * –ü–æ–ª—É—á–∞–µ—Ç –≤—Å–µ—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π —Å –ø–∞–≥–∏–Ω–∞—Ü–∏–µ–π
     */
    static async getAllUsers(skip: number = 0, limit: number = 15): Promise<UserListResponse> {
        try {
            const response = await api.get<UserListResponse>("/user/admin/users", {
                params: { skip, limit }
            });
            return response.data;
        } catch (error) {
            console.error("–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π:", error);
            throw error;
        }
    }

    /**
     * –ü–æ–ª—É—á–∞–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –ø–æ ID
     */
    static async getUserById(id: number): Promise<UserOut> {
        try {
            const response = await api.get(`/user/admin/users/${id}`);
            return response.data;
        } catch (error) {
            console.error(`–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è —Å ID ${id}:`, error);
            throw error;
        }
    }

    /**
     * –°–æ–∑–¥–∞–µ—Ç –Ω–æ–≤–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
     */
    static async createUser(input: UserCreateInput): Promise<UserOut> {
        try {
            const apiPayload = this.toApiFormat(input);
            const response = await api.post("/user/admin/users", apiPayload);
            return response.data;
        } catch (error) {
            console.error("–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:", error);
            throw error;
        }
    }

    /**
     * –û–±–Ω–æ–≤–ª—è–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
     */
    static async updateUser(input: UserUpdateInput): Promise<UserOut> {
        try {
            const { id, ...updateData } = input;
            const apiPayload = this.toApiFormat(updateData);
            const response = await api.put(`/user/admin/users/${id}`, apiPayload);
            return response.data;
        } catch (error) {
            console.error(`–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è —Å ID ${input.id}:`, error);
            throw error;
        }
    }

    /**
     * –û–±–Ω–æ–≤–ª—è–µ—Ç —Ä–æ–ª—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (—Ç–æ–ª—å–∫–æ –∞–¥–º–∏–Ω)
     */
    static async updateUserRole(userId: number, newRole: UserRole): Promise<any> {
        try {
            // –ò–ó–ú–ï–ù–ï–ù–ò–ï: –û—Ç–ø—Ä–∞–≤–ª—è–µ–º `new_role` –∫–∞–∫ –ø–∞—Ä–∞–º–µ—Ç—Ä –∑–∞–ø—Ä–æ—Å–∞, –∞ –Ω–µ –≤ —Ç–µ–ª–µ.
            // –¢–∞–∫–∂–µ –º–µ–Ω—è–µ–º –æ–∂–∏–¥–∞–µ–º—ã–π —Ç–∏–ø –æ—Ç–≤–µ—Ç–∞ –Ω–∞ `any`, —Ç–∞–∫ –∫–∞–∫ API –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç { message: "..." }
            const response = await api.put(`/user/admin/users/${userId}/role?new_role=${newRole}`);
            return response.data;
        } catch (error) {
            console.error(`–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ —Ä–æ–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è ${userId}:`, error);
            throw error;
        }
    }

    /**
     * –£–¥–∞–ª—è–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
     */
    static async deleteUser(id: number): Promise<void> {
        try {
            await api.delete(`/user/admin/users/${id}`);
        } catch (error) {
            console.error(`–û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è —Å ID ${id}:`, error);
            throw error;
        }
    }

    /**
     * –ê–∫—Ç–∏–≤–∏—Ä—É–µ—Ç/–¥–µ–∞–∫—Ç–∏–≤–∏—Ä—É–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
     */
    static async toggleUserStatus(id: number, isActive: boolean): Promise<UserOut> {
        try {
            const endpoint = isActive ? `/user/admin/users/${id}/unblock` : `/user/admin/users/${id}/block`;
            const response = await api.put(endpoint);
            return response.data;
        } catch (error) {
            console.error(`–û—à–∏–±–∫–∞ –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ —Å—Ç–∞—Ç—É—Å–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è ${id}:`, error);
            throw error;
        }
    }

    /**
     * –ü–æ–ª—É—á–∞–µ—Ç –ø—Ä–æ—Ñ–∏–ª—å —Ç–µ–∫—É—â–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
     */
    static async getCurrentUserProfile(): Promise<UserOut> {
        try {
            const response = await api.get("/user/");
            return response.data;
        } catch (error) {
            console.error("–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ –ø—Ä–æ—Ñ–∏–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:", error);
            throw error;
        }
    }

    /**
     * –û–±–Ω–æ–≤–ª—è–µ—Ç –ø—Ä–æ—Ñ–∏–ª—å —Ç–µ–∫—É—â–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
     */
    static async updateCurrentUserProfile(input: Partial<UserCreateInput>): Promise<UserOut> {
        try {
            const apiPayload = this.toApiFormat(input);
            const response = await api.put("/user/", apiPayload);
            return response.data;
        } catch (error) {
            console.error("–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ –ø—Ä–æ—Ñ–∏–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:", error);
            throw error;
        }
    }

    /**
     * –ü–æ–ª—É—á–∞–µ—Ç –∏—Å—Ç–æ—Ä–∏—é –±–∞–ª–∞–Ω—Å–∞ –¥–ª—è —Ç–µ–∫—É—â–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è —Å –ø–∞–≥–∏–Ω–∞—Ü–∏–µ–π.
     */
    static async getMyBalanceHistory(skip: number, limit: number): Promise<BalanceHistoryListResponse> {
        try {
            const response = await api.get<BalanceHistoryListResponse>("/user/balance-history", {
                params: { skip, limit }
            });
            return response.data;
        } catch (error) {
            console.error("–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ –∏—Å—Ç–æ—Ä–∏–∏ –±–∞–ª–∞–Ω—Å–∞:", error);
            throw error;
        }
    }

    /**
     * –ü–æ–ª—É—á–∞–µ—Ç –∏—Å—Ç–æ—Ä–∏—é –±–∞–ª–∞–Ω—Å–∞ –¥–ª—è –ª—é–±–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –ø–æ ID (–¥–ª—è –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–≤).
     */
    static async getUserBalanceHistory(userId: number, skip: number, limit: number): Promise<BalanceHistoryListResponse> {
        try {
            const response = await api.get<BalanceHistoryListResponse>(`/user/admin/users/${userId}/balance-history`, {
                params: { skip, limit }
            });
            return response.data;
        } catch (error) {
            console.error(`–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ –∏—Å—Ç–æ—Ä–∏–∏ –±–∞–ª–∞–Ω—Å–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è ${userId}:`, error);
            throw error;
        }
    }

    /**
     * –†–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–µ—Ç –ø–ª–∞—Ç–µ–∂ –∏ –ø–æ–ø–æ–ª–Ω—è–µ—Ç –±–∞–ª–∞–Ω—Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (–¥–ª—è –º–µ–Ω–µ–¥–∂–µ—Ä–æ–≤/–∞–¥–º–∏–Ω–æ–≤).
     */
    static async addUserPayment(userId: number, data: UserPaymentRequest): Promise<UserOut> {
        try {
            const response = await api.post<UserOut>(`/user/admin/users/${userId}/add-payment`, data);
            return response.data;
        } catch (error) {
            console.error(`–û—à–∏–±–∫–∞ –ø—Ä–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–∏ –ø–ª–∞—Ç–µ–∂–∞ –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è ${userId}:`, error);
            throw error;
        }
    }

    /**
     * –§–∏–ª—å—Ç—Ä—É–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –ø–æ –∑–∞–¥–∞–Ω–Ω—ã–º –∫—Ä–∏—Ç–µ—Ä–∏—è–º
     */
    static filterUsers(
        users: UserOut[],
        filters: UserFilterOptions
    ): UserOut[] {
        return users.filter(user => {
            if (filters.search) {
                const searchLower = filters.search.toLowerCase();
                const matchesSearch =
                    user.full_name.toLowerCase().includes(searchLower) ||
                    user.email.toLowerCase().includes(searchLower) ||
                    (user.phone && user.phone.toLowerCase().includes(searchLower));
                if (!matchesSearch) return false;
            }
            if (filters.role && user.role !== filters.role) return false;
            if (filters.isActive !== undefined && user.is_active !== filters.isActive) return false;
            if (filters.status && user.status !== filters.status) return false;
            return true;
        });
    }

    /**
     * –í–∞–ª–∏–¥–∏—Ä—É–µ—Ç –¥–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
     */
    static validateUserData(input: UserCreateInput): UserValidationResult {
        const errors: string[] = [];
        if (!input.full_name?.trim()) errors.push("–ü–æ–ª–Ω–æ–µ –∏–º—è –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ");
        if (!input.email?.trim()) {
            errors.push("Email –æ–±—è–∑–∞—Ç–µ–ª–µ–Ω");
        } else if (!this.isValidEmail(input.email)) {
            errors.push("–ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç email");
        }
        if (!input.role) errors.push("–†–æ–ª—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–∞");
        if (input.phone && !this.isValidPhone(input.phone)) errors.push("–ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç —Ç–µ–ª–µ—Ñ–æ–Ω–∞");
        if (!input.privacyPolicyAccepted) errors.push("–ù–µ–æ–±—Ö–æ–¥–∏–º–æ –ø—Ä–∏–Ω—è—Ç—å –ø–æ–ª–∏—Ç–∏–∫—É –∫–æ–Ω—Ñ–∏–¥–µ–Ω—Ü–∏–∞–ª—å–Ω–æ—Å—Ç–∏");
        if (!input.termsAccepted) errors.push("–ù–µ–æ–±—Ö–æ–¥–∏–º–æ –ø—Ä–∏–Ω—è—Ç—å —É—Å–ª–æ–≤–∏—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è");
        return { isValid: errors.length === 0, errors };
    }

    /**
     * –ü—Ä–æ–≤–µ—Ä—è–µ—Ç –≤–∞–ª–∏–¥–Ω–æ—Å—Ç—å email
     */
    private static isValidEmail(email: string): boolean {
        const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
        return emailRegex.test(email);
    }

    /**
     * –ü—Ä–æ–≤–µ—Ä—è–µ—Ç –≤–∞–ª–∏–¥–Ω–æ—Å—Ç—å —Ç–µ–ª–µ—Ñ–æ–Ω–∞
     */
    private static isValidPhone(phone: string): boolean {
        const phoneRegex = /^[+]?[0-9\s-()]+$/;
        return phoneRegex.test(phone) && phone.replace(/\D/g, '').length >= 10;
    }

    /**
     * –°–æ—Ä—Ç–∏—Ä—É–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –ø–æ –∑–∞–¥–∞–Ω–Ω–æ–º—É –∫—Ä–∏—Ç–µ—Ä–∏—é
     */
    static sortUsers(
        users: UserOut[],
        sortBy: 'full_name' | 'email' | 'role' | 'created_at' | 'balance',
        sortOrder: 'asc' | 'desc' = 'asc'
    ): UserOut[] {
        return [...users].sort((a, b) => {
            let aValue: string | number | Date = a[sortBy] as string | number | Date;
            let bValue: string | number | Date = b[sortBy] as string | number | Date;

            if (aValue === null || aValue === undefined) aValue = '';
            if (bValue === null || bValue === undefined) bValue = '';

            if (sortBy === 'created_at') {
                aValue = new Date(aValue as string).getTime();
                bValue = new Date(bValue as string).getTime();
            }

            if (sortBy === 'balance') {
                aValue = Number(aValue) || 0;
                bValue = Number(bValue) || 0;
            }

            if (typeof aValue === 'string' && typeof bValue === 'string') {
                aValue = aValue.toLowerCase();
                bValue = bValue.toLowerCase();
            }

            if (aValue < bValue) return sortOrder === 'asc' ? -1 : 1;
            if (aValue > bValue) return sortOrder === 'asc' ? 1 : -1;
            return 0;
        });
    }

    /**
     * –ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç –∫–ª—é—á –¥–ª—è –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
     */
    static generateUsersCacheKey(filters?: UserFilterOptions): string {
        return JSON.stringify(["users", filters]);
    }

    /**
     * –ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç –∫–ª—é—á –¥–ª—è –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏—è –ø—Ä–æ—Ñ–∏–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
     */
    static generateUserProfileCacheKey(): string {
        return JSON.stringify(["user-profile"]);
    }
}

```


## <a name="srccoreservicesindexts"></a>`src/core/services/index.ts`

```typescript
// path: src/core/services/index.ts

// src/core/services/index.ts

// –≠–∫—Å–ø–æ—Ä—Ç –≤—Å–µ—Ö —Å–µ—Ä–≤–∏—Å–æ–≤
export { ReservationService } from './ReservationService';
export { EquipmentService } from './EquipmentService';
export { AvailabilityService } from './AvailabilityService';
export { PromoCodeService } from './PromoCodeService';
export { UserService } from './UserService';
export { AccessoryService } from './AccessoryService';
export { PhoneService } from './PhoneService';
export { CalendarService } from './CalendarService';
export { DateService } from './DateService';

// –≠–∫—Å–ø–æ—Ä—Ç —Ç–∏–ø–æ–≤
export type {
    ReservationCreateInput,
    ReservationUpdateInput
} from './ReservationService';

export type {
    EquipmentListResponse,
    EquipmentFilterParams
} from './EquipmentService';

export type {
    PromoCodeValidationResult,
    PromoCodeFilterOptions
} from './PromoCodeService';

export type {
    UserCreateInput,
    UserUpdateInput,
    UserFilterOptions,
    UserValidationResult
} from './UserService';

export type {
    AccessoryCreateInput,
    AccessoryUpdateInput,
    AccessoryFilterOptions,
    AccessoryValidationResult
} from './AccessoryService';

export type {
    PhoneValidationResult
} from './PhoneService';

export type {
    CalendarGridData,
    CalendarFilterOptions
} from './CalendarService';

export type {
    DateRange,
    DateRangeValidationResult
} from './DateService';

export type {
    AvailabilityStatusParams,
    DailyStatusParams,
    ConflictCheckParams
} from './AvailabilityService';

```


## <a name="srchooksadmincreate-reservationuseCreateReservationDatats"></a>`src/hooks/admin/create-reservation/useCreateReservationData.ts`

```typescript
// path: src/hooks/admin/create-reservation/useCreateReservationData.ts

// src/hooks/admin/create-reservation/useCreateReservationData.ts

import { useMemo } from "react";
import { useAdminUsers } from "@/hooks/useAdminUsers";
import { useEquipment } from "@/hooks/useEquipment";
import { useAvailabilityCheck } from "@/hooks/useAvailabilityCheck";
import { EquipmentService } from "@/core/services";
import type { Equipment } from "@/types/equipment";

interface UseCreateReservationDataInputs {
    equipmentSearch: string;
    watchedStartDate: string;
    watchedEndDate: string;
    watchedEquipmentIds: number[];
}

/**
 * –•—É–∫ –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –∏ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –¥–∞–Ω–Ω—ã—Ö –¥–ª—è —Ñ–æ—Ä–º—ã —Å–æ–∑–¥–∞–Ω–∏—è —Ä–µ–∑–µ—Ä–≤–∞.
 * –°–æ–¥–µ—Ä–∂–∏—Ç –≤—Å—é –ª–æ–≥–∏–∫—É –ø–æ–ª—É—á–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö: –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏, –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏–µ, –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å.
 */
export const useCreateReservationData = ({
    equipmentSearch,
    watchedStartDate,
    watchedEndDate,
    watchedEquipmentIds
}: UseCreateReservationDataInputs) => {

    // 1. –ó–∞–≥—Ä—É–∑–∫–∞ –∏—Å—Ö–æ–¥–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö
    const { data: usersResponse, isLoading: isLoadingUsers } = useAdminUsers();
    const { data: equipmentPages, isLoading: isLoadingEquipment } = useEquipment({}); // –í—ã–∑—ã–≤–∞–µ–º —Å –ø—É—Å—Ç—ã–º –æ–±—ä–µ–∫—Ç–æ–º —Ñ–∏–ª—å—Ç—Ä–æ–≤

    // 2. "–†–∞–∑–≤–æ—Ä–∞—á–∏–≤–∞–µ–º" —Å—Ç—Ä–∞–Ω–∏—Ü—ã –≤ –æ–¥–∏–Ω –ø–ª–æ—Å–∫–∏–π –º–∞—Å—Å–∏–≤ `allEquipment`
    const allEquipment = useMemo(() =>
        equipmentPages?.pages.flatMap((page) => page.items) ?? [],
        [equipmentPages]);

    const users = useMemo(() => 
        usersResponse?.pages?.flatMap(page => page.items) ?? [], 
        [usersResponse]
    );

    // 3. –§–∏–ª—å—Ç—Ä–∞—Ü–∏—è –∏ –≥—Ä—É–ø–ø–∏—Ä–æ–≤–∫–∞ –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—è
    const filteredAndGroupedEquipment = useMemo(() => {
        return EquipmentService.filterAndGroupEquipment(allEquipment, equipmentSearch);
    }, [allEquipment, equipmentSearch]);

    // 4. –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏ –æ—Ç—Ñ–∏–ª—å—Ç—Ä–æ–≤–∞–Ω–Ω–æ–≥–æ –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—è
    const { validStartDate, validEndDate } = useMemo(() => {
        const start = watchedStartDate ? new Date(watchedStartDate) : null;
        const end = watchedEndDate ? new Date(watchedEndDate) : null;
        return {
            validStartDate: start && !isNaN(start.getTime()) ? start : null,
            validEndDate: end && !isNaN(end.getTime()) ? end : null,
        }
    }, [watchedStartDate, watchedEndDate]);

    const { 
        availabilityMap, 
        hasConflicts: hasConflictsInSelection, 
        isLoading: isLoadingAvailability 
    } = useAvailabilityCheck({
        equipmentIds: filteredAndGroupedEquipment.visibleIds,
        startDate: validStartDate || new Date(),
        endDate: validEndDate || new Date(),
        enabled: !!(validStartDate && validEndDate && filteredAndGroupedEquipment.visibleIds.length > 0)
    });

    // –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—è —Å –∞–∫—Å–µ—Å—Å—É–∞—Ä–∞–º–∏
    const getEquipmentWithAccessories = (allEq: Equipment[], ids: number[]): Equipment[] => {
        const selectedIds = new Set(ids);
        return allEq.filter(eq => selectedIds.has(eq.id) && eq.accessories && eq.accessories.length > 0);
    };

    const equipmentWithAccessories = useMemo(() => getEquipmentWithAccessories(allEquipment, watchedEquipmentIds), [watchedEquipmentIds, allEquipment]);

    return {
        users,
        isLoadingUsers,
        allEquipment,
        isLoadingEquipment,
        filteredAndGroupedEquipment,
        availabilityMap,
        isLoadingAvailability,
        hasConflictsInSelection,
        equipmentWithAccessories
    };
};


```


## <a name="srchooksadmincreate-reservationuseCreateReservationDialogts"></a>`src/hooks/admin/create-reservation/useCreateReservationDialog.ts`

```typescript
// path: src/hooks/admin/create-reservation/useCreateReservationDialog.ts

// src/hooks/admin/create-reservation/useCreateReservationDialog.ts

import { useState, useEffect, useCallback } from "react";
import { useCreateAdminReservation } from "@/hooks/useAdminReservations";
import { useAdminReservationCalculator } from "../useAdminReservationCalculator";
import { formatDate } from "@/lib/utils";
import { useCreateReservationData } from "./useCreateReservationData";
import { useCreateReservationForm, type CreateReservationFormData } from "./useCreateReservationForm";

const todayDate = new Date();
const tomorrowDate = new Date();
tomorrowDate.setDate(todayDate.getDate() + 1);

/**
 * –£–ü–†–û–©–ï–ù–ù–´–ô –•–£–ö-–û–†–ö–ï–°–¢–†–ê–¢–û–†
 * –£–ø—Ä–∞–≤–ª—è–µ—Ç —Å–æ—Å—Ç–æ—è–Ω–∏–µ–º –¥–∏–∞–ª–æ–≥–∞ —Å–æ–∑–¥–∞–Ω–∏—è —Ä–µ–∑–µ—Ä–≤–∞, –∏—Å–ø–æ–ª—å–∑—É—è –¥–æ—á–µ—Ä–Ω–∏–µ —Ö—É–∫–∏ –¥–ª—è –¥–∞–Ω–Ω—ã—Ö –∏ —Ä–∞—Å—á–µ—Ç–æ–≤.
 */
export const useCreateReservationDialog = ({ isOpen, onClose }: { isOpen: boolean; onClose: () => void }) => {
    // 1. –°–æ—Å—Ç–æ—è–Ω–∏–µ UI –¥–∏–∞–ª–æ–≥–∞
    const [step, setStep] = useState<'details' | 'accessories'>('details');
    const [equipmentSearch, setEquipmentSearch] = useState("");
    const [clientPopoverOpen, setClientPopoverOpen] = useState(false);

    // 2. –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Ñ–æ—Ä–º–æ–π —á–µ—Ä–µ–∑ —Å–ø–µ—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–π —Ö—É–∫
    const { form, watch, trigger, handleSubmit, reset } = useCreateReservationForm();

    const watchedStartDate = watch("start_date");
    const watchedEndDate = watch("end_date");
    const watchedEquipmentIds = watch("equipment_ids");

    // 3. –ü–æ–ª—É—á–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö —á–µ—Ä–µ–∑ —Å–ø–µ—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–π —Ö—É–∫
    const {
        users,
        isLoadingUsers,
        allEquipment,
        isLoadingEquipment,
        filteredAndGroupedEquipment,
        availabilityMap,
        isLoadingAvailability,
        hasConflictsInSelection,
        equipmentWithAccessories,
    } = useCreateReservationData({
        equipmentSearch,
        watchedStartDate,
        watchedEndDate,
        watchedEquipmentIds,
    });

    // 4. –†–∞—Å—á–µ—Ç —Ñ–∏–Ω–∞–Ω—Å–æ–≤
    const financialData = useAdminReservationCalculator(watch, allEquipment);

    // 5. –õ–æ–≥–∏–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ —Ñ–æ—Ä–º—ã
    const createReservationMutation = useCreateAdminReservation();

    const handleCloseDialog = useCallback(() => onClose(), [onClose]);

    const processSubmit = useCallback((data: CreateReservationFormData) => {
        if (hasConflictsInSelection) {
            alert("–ù–µ–ª—å–∑—è —Å–æ–∑–¥–∞—Ç—å —Ä–µ–∑–µ—Ä–≤, —Ç–∞–∫ –∫–∞–∫ –≤ –≤–∞—à–µ–º –≤—ã–±–æ—Ä–µ –µ—Å—Ç—å –∫–æ–Ω—Ñ–ª–∏–∫—Ç–Ω—ã–µ –ø–æ–∑–∏—Ü–∏–∏.");
            return;
        }
        createReservationMutation.mutate(data, { onSuccess: handleCloseDialog });
    }, [hasConflictsInSelection, createReservationMutation, handleCloseDialog]);

    const handleNextStep = useCallback(async () => {
        const isValid = await trigger(["user_id", "start_date", "end_date", "equipment_ids"]);
        if (!isValid) return;

        if (equipmentWithAccessories.length > 0) {
            setStep('accessories');
        } else {
            // ‚úÖ –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï: –î–æ–±–∞–≤–ª–µ–Ω–æ –∫–ª—é—á–µ–≤–æ–µ —Å–ª–æ–≤–æ `await` –¥–ª—è –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ–≥–æ –≤—ã–∑–æ–≤–∞.
            await handleSubmit(processSubmit)();
        }
    }, [trigger, equipmentWithAccessories, handleSubmit, processSubmit]);

    // 6. –°–±—Ä–æ—Å —Å–æ—Å—Ç–æ—è–Ω–∏—è –ø—Ä–∏ –∑–∞–∫—Ä—ã—Ç–∏–∏ –¥–∏–∞–ª–æ–≥–∞
    useEffect(() => {
        if (!isOpen) {
            reset({
                equipment_ids: [], 
                selected_accessories: {},
                start_date: formatDate(todayDate), 
                end_date: formatDate(tomorrowDate),
            });
            setEquipmentSearch("");
            setStep('details');
        }
    }, [isOpen, reset]);

    // 7. –í–æ–∑–≤—Ä–∞—â–∞–µ–º –µ–¥–∏–Ω—ã–π –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å –¥–ª—è –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–∞
    return {
        step,
        form,
        isSubmitting: createReservationMutation.isPending,
        users,
        isLoadingUsers,
        clientPopoverOpen,
        setClientPopoverOpen,
        equipmentSearch,
        setEquipmentSearch,
        isLoadingEquipment,
        filteredAndGroupedEquipment,
        equipmentWithAccessories,
        availabilityMap,
        isLoadingAvailability,
        hasConflictsInSelection,
        setStep,
        handleNextStep,
        onSubmit: handleSubmit(processSubmit),
        handleCloseDialog,
        financialData,
    };
};


```


## <a name="srchooksadmincreate-reservationuseCreateReservationFormts"></a>`src/hooks/admin/create-reservation/useCreateReservationForm.ts`

```typescript
// path: src/hooks/admin/create-reservation/useCreateReservationForm.ts

// src/hooks/admin/create-reservation/useCreateReservationForm.ts

import { useForm } from "react-hook-form";
import { zodResolver } from "@hookform/resolvers/zod";
import { z } from "zod";
import { formatDate } from "@/lib/utils";

const createSchema = z.object({
    user_id: z.coerce.number().min(1, "–ù–µ–æ–±—Ö–æ–¥–∏–º–æ –≤—ã–±—Ä–∞—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è"),
    start_date: z.string().min(1, "–ù–µ–æ–±—Ö–æ–¥–∏–º–æ —É–∫–∞–∑–∞—Ç—å –¥–∞—Ç—É –Ω–∞—á–∞–ª–∞"),
    end_date: z.string().min(1, "–ù–µ–æ–±—Ö–æ–¥–∏–º–æ —É–∫–∞–∑–∞—Ç—å –¥–∞—Ç—É –æ–∫–æ–Ω—á–∞–Ω–∏—è"),
    equipment_ids: z.array(z.number()).min(1, "–í—ã–±–µ—Ä–∏—Ç–µ —Ö–æ—Ç—è –±—ã –æ–¥–Ω—É –ø–æ–∑–∏—Ü–∏—é –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—è"),
    selected_accessories: z.record(z.array(z.number())).optional(),
}).refine(data => new Date(data.end_date) >= new Date(data.start_date), {
    message: "–î–∞—Ç–∞ –æ–∫–æ–Ω—á–∞–Ω–∏—è –Ω–µ –º–æ–∂–µ—Ç –±—ã—Ç—å —Ä–∞–Ω—å—à–µ –¥–∞—Ç—ã –Ω–∞—á–∞–ª–∞",
    path: ["end_date"],
});

export type CreateReservationFormData = z.infer<typeof createSchema>;

const todayDate = new Date();
const tomorrowDate = new Date();
tomorrowDate.setDate(todayDate.getDate() + 1);

/**
 * –•—É–∫ –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è —Ñ–æ—Ä–º–æ–π —Å–æ–∑–¥–∞–Ω–∏—è —Ä–µ–∑–µ—Ä–≤–∞.
 * –°–æ–¥–µ—Ä–∂–∏—Ç –≤—Å—é –ª–æ–≥–∏–∫—É, —Å–≤—è–∑–∞–Ω–Ω—É—é —Å react-hook-form.
 */
export const useCreateReservationForm = () => {
    const form = useForm<CreateReservationFormData>({
        resolver: zodResolver(createSchema), 
        mode: "onChange",
        defaultValues: {
            equipment_ids: [], 
            selected_accessories: {},
            start_date: formatDate(todayDate), 
            end_date: formatDate(tomorrowDate),
        },
    });

    const { watch, trigger, handleSubmit, reset } = form;

    return {
        form,
        watch,
        trigger,
        handleSubmit,
        reset,
    };
};


```


## <a name="srchooksadminuseAdminRentalEditts"></a>`src/hooks/admin/useAdminRentalEdit.ts`

```typescript
// path: src/hooks/admin/useAdminRentalEdit.ts

// hooks/admin/useAdminRentalEdit.ts (–ù–û–í–´–ô –§–ê–ô–õ)

import { useForm } from "react-hook-form";
import { zodResolver } from "@hookform/resolvers/zod";
import { z } from "zod";
import { useMutation, useQueryClient } from "@tanstack/react-query";
import { toast } from "sonner";
import { api } from "@/lib/api";
import { formatDate } from "@/lib/utils";
import type { AdminRentalOut } from "@/types/reservation";

// –°—Ö–µ–º–∞ –≤–∞–ª–∏–¥–∞—Ü–∏–∏ –¥–ª—è —Ñ–æ—Ä–º—ã —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
const rentalEditSchema = z.object({
    end_date: z.string().optional(),
    actual_return_date: z.string().nullable().optional(),
    status: z.string().optional(),
    final_cost: z.coerce.number().optional(),
    deposit_amount: z.coerce.number().optional(),
    notes_on_issue: z.string().optional(),
    notes_on_return: z.string().optional(),
});

type RentalEditFormData = z.infer<typeof rentalEditSchema>;

interface UseAdminRentalEditProps {
    rental: AdminRentalOut;
    onSuccess: () => void;
}

export function useAdminRentalEdit({ rental, onSuccess }: UseAdminRentalEditProps) {
    const queryClient = useQueryClient();

    const { register, handleSubmit, formState: { errors, isValid, isDirty } } = useForm<RentalEditFormData>({
        resolver: zodResolver(rentalEditSchema),
        defaultValues: {
            end_date: formatDate(rental.end_date),
            actual_return_date: rental.actual_return_date ? formatDate(rental.actual_return_date) : null,
            status: rental.status,
            final_cost: rental.final_cost ?? undefined,
            deposit_amount: rental.deposit_amount,
            notes_on_issue: rental.notes_on_issue ?? "",
            notes_on_return: rental.notes_on_return ?? "",
        },
        mode: "onChange",
    });

    const updateMutation = useMutation({
        mutationFn: (data: RentalEditFormData) => api.put(`/admin/rentals/${rental.id}`, data),
        onSuccess: () => {
            toast.success("–ê—Ä–µ–Ω–¥–∞ —É—Å–ø–µ—à–Ω–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∞");
            void queryClient.invalidateQueries({ queryKey: ["adminRentals"] });
            onSuccess(); // –ó–∞–∫—Ä—ã–≤–∞–µ–º —Ñ–æ—Ä–º—É —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
        },
        onError: (error: any) => {
            toast.error(error?.response?.data?.detail || "–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ –∞—Ä–µ–Ω–¥—ã");
        },
    });

    const onSubmit = (data: RentalEditFormData) => {
        updateMutation.mutate(data);
    };

    return {
        register,
        handleSubmit: handleSubmit(onSubmit),
        errors,
        isValid,
        isDirty,
        isSaving: updateMutation.isPending,
    };
}

```


## <a name="srchooksadminuseAdminReservationCalculatorts"></a>`src/hooks/admin/useAdminReservationCalculator.ts`

```typescript
// path: src/hooks/admin/useAdminReservationCalculator.ts

// src/hooks/admin/useAdminReservationCalculator.ts

import { useMemo } from "react";
import { UseFormWatch } from "react-hook-form";
import { usePromoCodeStore } from "@/store/promoCodeStore";
import { usePriceCalculator } from "../reservation/usePriceCalculator";
import type { CreateReservationFormData } from "./create-reservation/useCreateReservationForm";
import type { Equipment } from "@/types/equipment";

/**
 * –•—É–∫ –¥–ª—è —Ä–∞—Å—á–µ—Ç–∞ —Å—Ç–æ–∏–º–æ—Å—Ç–∏ —Ä–µ–∑–µ—Ä–≤–∞ –≤ –∞–¥–º–∏–Ω-–ø–∞–Ω–µ–ª–∏.
 * –ò—Å–ø–æ–ª—å–∑—É–µ—Ç —Ü–µ–Ω—Ç—Ä–∞–ª–∏–∑–æ–≤–∞–Ω–Ω—ã–π usePriceCalculator –∫–∞–∫ –µ–¥–∏–Ω—ã–π –∏—Å—Ç–æ—á–Ω–∏–∫ –ø—Ä–∞–≤–¥—ã.
 */
export function useAdminReservationCalculator(
    watch: UseFormWatch<CreateReservationFormData>,
    allEquipment: Equipment[] = []
) {
    const watchedStartDateStr = watch("start_date");
    const watchedEndDateStr = watch("end_date");
    const watchedEquipmentIds = watch("equipment_ids");
    const watchedSelectedAccessories = watch("selected_accessories") || {};

    const { promoCode, setPromoCode, promoCodeMessage } = usePromoCodeStore();

    const startDate = useMemo(() => watchedStartDateStr ? new Date(watchedStartDateStr) : new Date(), [watchedStartDateStr]);
    const endDate = useMemo(() => watchedEndDateStr ? new Date(watchedEndDateStr) : new Date(), [watchedEndDateStr]);

    const equipmentForCalc = useMemo(() =>
            allEquipment.filter(e => watchedEquipmentIds.includes(e.id)),
        [allEquipment, watchedEquipmentIds]
    );

    // –ò—Å–ø–æ–ª—å–∑—É–µ–º —Ä–∞—Å—à–∏—Ä–µ–Ω–Ω—ã–π usePriceCalculator
    const priceCalculator = usePriceCalculator({
        equipmentIds: equipmentForCalc.map(i => i.id),
        startDate,
        endDate,
        selectedAccessories: watchedSelectedAccessories,
        promoCode: promoCode,
        enabled: watchedEquipmentIds.length > 0 && !!watchedStartDateStr && !!watchedEndDateStr
    });

    const applyPromoCode = () => {
        console.log("Applying promo code from admin calculator context:", promoCode);
    };

    // –í–æ–∑–≤—Ä–∞—â–∞–µ–º –¥–∞–Ω–Ω—ã–µ –∏–∑ —Ü–µ–Ω—Ç—Ä–∞–ª–∏–∑–æ–≤–∞–Ω–Ω–æ–≥–æ —Ö—É–∫–∞
    return {
        // –û—Å–Ω–æ–≤–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –∏–∑ usePriceCalculator
        priceDetails: priceCalculator.priceDetails,
        
        // –§–∏–Ω–∞–Ω—Å–æ–≤—ã–µ –¥–∞–Ω–Ω—ã–µ –∏–∑ usePriceCalculator
        dayCount: priceCalculator.dayCount,
        fullTotal: priceCalculator.fullTotal,
        finalTotal: priceCalculator.finalTotal,
        discountAmount: priceCalculator.discountAmount,
        totalDiscountPercentage: priceCalculator.totalDiscountPercentage,
        durationDiscountPercentage: priceCalculator.durationDiscountPercentage,
        promoDiscountPercentage: priceCalculator.promoDiscountPercentage,
        
        // –ü—Ä–æ–º–æ–∫–æ–¥
        promoCode,
        setPromoCode,
        applyPromoCode,
        promoCodeMessage: priceCalculator.promoCodeMessage || promoCodeMessage,
        
        // –°–æ—Å—Ç–æ—è–Ω–∏—è –∑–∞–≥—Ä—É–∑–∫–∏
        isApplyingPromoCode: priceCalculator.isApplyingPromoCode,
        isCalculatingPrice: priceCalculator.isCalculatingPrice,
        isFetchingPrice: priceCalculator.isFetchingPrice,
    };
}

```


## <a name="srchooksadminuseDashboardDatats"></a>`src/hooks/admin/useDashboardData.ts`

```typescript
// path: src/hooks/admin/useDashboardData.ts

// src/hooks/admin/useDashboardData.ts

import { useQuery } from "@tanstack/react-query";
import { api } from "@/lib/api";

// –¢–∏–ø—ã –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –¥–∞—à–±–æ—Ä–¥–∞
export interface DashboardSummary {
    pickups_today: PickupReturnItem[];
    returns_today: PickupReturnItem[];
    overdue_rentals: OverdueRentalItem[];
    kpi: {
        total_users: number;
        active_users: number;
        total_equipment: number;
        total_reservations: number;
        revenue_today: number;
        revenue_this_month: number;
        occupancy_rate: number;
        avg_rental_duration: number;
    };
    recent_activity: ActivityFeedItem[];
    popular_equipment: PopularEquipmentItem[];
}

export interface PickupReturnItem {
    id: number;
    user_name: string;
    equipment_name: string;
    scheduled_time: string | null;
    status: string;
    start_date?: string;
}

export interface OverdueRentalItem {
    id: number;
    user_name: string;
    equipment_name: string;
    due_date: string | null;
    days_overdue: number | null;
}

export interface ActivityFeedItem {
    id: number;
    type: 'reservation_created' | 'reservation_cancelled' | 'rental_started' | 'rental_completed' | 'user_registered' | 'equipment_added';
    description: string;
    timestamp: string;
    user_name?: string;
    equipment_name?: string;
}

export interface PopularEquipmentItem {
    equipment_id: number;
    equipment_name: string;
    rental_count: number;
    revenue: number;
}

export const useDashboardData = () => {
    return useQuery({
        queryKey: ['admin', 'dashboardSummary'],
        queryFn: async (): Promise<DashboardSummary> => {
            const response = await api.get('/admin/dashboard-summary');
            return response.data;
        },
        staleTime: 5 * 60 * 1000, // 5 –º–∏–Ω—É—Ç
        refetchInterval: 2 * 60 * 1000, // 2 –º–∏–Ω—É—Ç—ã
        retry: 3,
        retryDelay: (attemptIndex) => Math.min(1000 * 2 ** attemptIndex, 30000),
    });
};


```


## <a name="srchooksadminuseEquipmentTableLogicts"></a>`src/hooks/admin/useEquipmentTableLogic.ts`

```typescript
// path: src/hooks/admin/useEquipmentTableLogic.ts

// src/hooks/admin/useEquipmentTableLogic.ts
import { useState, useMemo } from "react";
import { useQueryClient } from "@tanstack/react-query";
import { useCurrentUser } from "@/hooks/useProfile";
// ‚õîÔ∏è –£–¥–∞–ª—è–µ–º useEquipment, —Ç–∞–∫ –∫–∞–∫ —Ö—É–∫ –±–æ–ª—å—à–µ –Ω–µ –±—É–¥–µ—Ç –∑–∞–≥—Ä—É–∂–∞—Ç—å –¥–∞–Ω–Ω—ã–µ —Å–∞–º
// import { useEquipment } from "@/hooks/useEquipment";
import { useDeleteEquipment, useBulkDeleteEquipment } from "@/hooks/useAdminEquipment";
import { api } from "@/lib/api";
import { toast } from "sonner";
import type { Equipment } from "@/types/equipment"; // ‚úÖ –î–æ–±–∞–≤–ª—è–µ–º –∏–º–ø–æ—Ä—Ç —Ç–∏–ø–∞

interface EquipmentAvailability {
    hasActiveReservations: boolean;
    hasActiveRentals: boolean;
    activeReservationsCount: number;
    activeRentalsCount: number;
}

// ‚úÖ –•—É–∫ —Ç–µ–ø–µ—Ä—å –ø—Ä–∏–Ω–∏–º–∞–µ—Ç –º–∞—Å—Å–∏–≤ –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—è –∫–∞–∫ –∞—Ä–≥—É–º–µ–Ω—Ç
export const useEquipmentTableLogic = (equipment: Equipment[] = []) => {
    const queryClient = useQueryClient();
    const { data: currentUser } = useCurrentUser();
    // ‚õîÔ∏è –£–¥–∞–ª—è–µ–º –≤–Ω—É—Ç—Ä–µ–Ω–Ω–∏–π –≤—ã–∑–æ–≤ useEquipment()
    // const { data: equipment = [], isLoading, error } = useEquipment();

    const [searchQuery, setSearchQuery] = useState("");
    const [selectedIds, setSelectedIds] = useState<number[]>([]);

    const deleteEquipmentMutation = useDeleteEquipment();
    const bulkDeleteMutation = useBulkDeleteEquipment();

    const isManager = currentUser?.role === "manager" || currentUser?.role === "admin";

    const filteredEquipment = useMemo(() => {
        const lowerCaseQuery = searchQuery.toLowerCase();
        return equipment.filter(item =>
            item.name.toLowerCase().includes(lowerCaseQuery) ||
            item.brand.toLowerCase().includes(lowerCaseQuery) ||
            item.equipment_type.toLowerCase().includes(lowerCaseQuery) ||
            (item.serial_number && item.serial_number.toLowerCase().includes(lowerCaseQuery))
        );
    }, [equipment, searchQuery]);

    const handleSelectAll = (checked: boolean) => {
        setSelectedIds(checked ? filteredEquipment.map(item => item.id) : []);
    };

    const handleSelectItem = (itemId: number, checked: boolean) => {
        setSelectedIds(prev =>
            checked ? [...prev, itemId] : prev.filter(id => id !== itemId)
        );
    };

    const handleDelete = async (itemId: number) => {
        if (!isManager) return;

        try {
            const availability = await queryClient.fetchQuery<EquipmentAvailability>({
                queryKey: ["equipment-availability", itemId],
                queryFn: async () => (await api.get<EquipmentAvailability>(`/equipment/${itemId}/availability`)).data,
            });

            if (availability.hasActiveReservations || availability.hasActiveRentals) {
                const messages = [];
                if (availability.hasActiveReservations) messages.push(`${availability.activeReservationsCount} –∞–∫—Ç–∏–≤–Ω—ã—Ö —Ä–µ–∑–µ—Ä–≤–æ–≤`);
                if (availability.hasActiveRentals) messages.push(`${availability.activeRentalsCount} –∞–∫—Ç–∏–≤–Ω—ã—Ö –∞—Ä–µ–Ω–¥`);
                toast.error(`–ù–µ–≤–æ–∑–º–æ–∂–Ω–æ —É–¥–∞–ª–∏—Ç—å: —É –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—è –µ—Å—Ç—å ${messages.join(" –∏ ")}.`);
                return;
            }

            const equipmentToDelete = filteredEquipment.find(item => item.id === itemId);
            if (window.confirm(`–£–¥–∞–ª–∏—Ç—å "${equipmentToDelete?.name}"? –î–µ–π—Å—Ç–≤–∏–µ –Ω–µ–ª—å–∑—è –æ—Ç–º–µ–Ω–∏—Ç—å.`)) {
                deleteEquipmentMutation.mutate(itemId);
            }
        } catch (err) {
            toast.error("–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø—Ä–æ–≤–µ—Ä–∫–µ —Å—Ç–∞—Ç—É—Å–∞ –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—è.");
            console.error("Availability check failed:", err);
        }
    };

    const handleBulkDelete = () => {
        if (!isManager || selectedIds.length === 0) return;
        if (window.confirm(`–£–¥–∞–ª–∏—Ç—å ${selectedIds.length} –µ–¥. –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—è?`)) {
            bulkDeleteMutation.mutate(selectedIds, {
                onSuccess: () => setSelectedIds([]),
            });
        }
    };

    const handlers = {
        setSearchQuery,
        handleSelectAll,
        handleSelectItem,
        handleDelete,
        handleBulkDelete
    };

    return {
        isManager,
        // ‚úÖ –¢–∞–∫ –∫–∞–∫ –∑–∞–≥—Ä—É–∑–∫–∞ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç –≤—ã—à–µ, –∑–¥–µ—Å—å –º—ã —Å—á–∏—Ç–∞–µ–º, —á—Ç–æ –µ—ë –Ω–µ—Ç
        isLoading: false,
        error: null,
        equipment,
        filteredEquipment,
        searchQuery,
        selectedIds,
        deleteEquipmentMutation,
        bulkDeleteMutation,
        handlers,
    };
};

```


## <a name="srchooksadminuseRentalReturnFormts"></a>`src/hooks/admin/useRentalReturnForm.ts`

```typescript
// path: src/hooks/admin/useRentalReturnForm.ts

// src/hooks/admin/useRentalReturnForm.ts

import { useForm } from "react-hook-form";
import { zodResolver } from "@hookform/resolvers/zod";
import { z } from "zod";
import { useReturnRental } from "@/hooks/useAdminRentals";
import { useAddUserPayment } from "@/hooks/useAdminUsers";
import { useQueryClient } from "@tanstack/react-query";
import { toast } from "sonner";
import type { AdminRentalOut, RentalAccessoryDetail } from "@/types/rental";
import { formatDate } from "@/lib/utils";
import { useState, useMemo, useEffect } from "react";
import type { Accessory } from "@/types/accessory";
import type { Equipment } from "@/types/equipment";

interface Props {
    rental: AdminRentalOut | null;
    onClose: () => void;
}

const returnSchema = z.object({
    actual_return_date: z.string().min(1, "–î–∞—Ç–∞ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–∞"),
    notes_on_return: z.string().optional(),
});

type ReturnFormData = z.infer<typeof returnSchema>;

export function useRentalReturnForm({ rental, onClose }: Props) {
    const returnMutation = useReturnRental();
    const queryClient = useQueryClient();
    const paymentMutation = useAddUserPayment();
    
    const { register, handleSubmit, formState: { errors, isValid }, reset } = useForm<ReturnFormData>({
        resolver: zodResolver(returnSchema),
        mode: "onChange",
        defaultValues: {
            actual_return_date: formatDate(new Date()),
            notes_on_return: "",
        },
    });

    const [checkedAccessories, setCheckedAccessories] = useState<Set<string>>(new Set());
    
    // –°–æ—Å—Ç–æ—è–Ω–∏–µ –¥–ª—è –ø–ª–∞—Ç–µ–∂–∞
    const [paymentAmount, setPaymentAmount] = useState("");
    const [paymentDescription, setPaymentDescription] = useState("");
    const [paymentApplied, setPaymentApplied] = useState(false);

    // –î–∏–Ω–∞–º–∏—á–µ—Å–∫–∏–π –ø–µ—Ä–µ—Å—á–µ—Ç –æ—Å—Ç–∞—Ç–∫–∞ —Å —É—á–µ—Ç–æ–º —à—Ç—Ä–∞—Ñ–∞ –∑–∞ –ø—Ä–æ—Å—Ä–æ—á–∫—É
    const dynamicRemainingAmount = useMemo(() => {
        if (!rental) return 0;
        
        const remaining = rental.remaining_amount || 0;
        const surcharge = rental.overdue_surcharge || 0;
        const payment = parseFloat(paymentAmount) || 0;

        // –ò—Ç–æ–≥–æ–≤—ã–π –æ—Å—Ç–∞—Ç–æ–∫ = (–û—Å—Ç–∞—Ç–æ–∫ –ø–æ –∞—Ä–µ–Ω–¥–µ) + (–®—Ç—Ä–∞—Ñ) - (–í–Ω–µ—Å–µ–Ω–Ω—ã–π –ø–ª–∞—Ç–µ–∂)
        return Math.max(0, remaining + surcharge - payment);
    }, [rental, paymentAmount]);

    // –ì—Ä—É–ø–ø–∏—Ä–æ–≤–∫–∞ –∞–∫—Å–µ—Å—Å—É–∞—Ä–æ–≤ –ø–æ –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—é
    const accessoriesByEquipment = useMemo(() => {
        if (!rental?.accessory_links) return {};
        return rental.accessory_links.reduce((acc: Record<number, Accessory[]>, current: RentalAccessoryDetail) => {
            const equipmentId = current.equipment_id;
            (acc[equipmentId] = acc[equipmentId] || []).push(current.accessory);
            return acc;
        }, {} as Record<number, Accessory[]>);
    }, [rental]);

    const totalAccessoriesCount = rental?.accessory_links?.length ?? 0;
    const allAccessoriesChecked = checkedAccessories.size === totalAccessoriesCount;

    const handleToggleAccessory = (equipmentId: number, accessoryId: number) => {
        const key = `${equipmentId}-${accessoryId}`;
        setCheckedAccessories(prev => {
            const newSet = new Set(prev);
            if (newSet.has(key)) {
                newSet.delete(key);
            } else {
                newSet.add(key);
            }
            return newSet;
        });
    };

    // –õ–æ–≥–∏–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –ø–ª–∞—Ç–µ–∂–∞
    const handleApplyPayment = async () => {
        if (!rental || !paymentAmount) return;
        
        try {
            await paymentMutation.mutateAsync({
                userId: rental.user.id,
                data: {
                    amount: parseFloat(paymentAmount),
                    payment_method: "cash",
                    description: paymentDescription || `–ü–ª–∞—Ç–µ–∂ –ø—Ä–∏ –≤–æ–∑–≤—Ä–∞—Ç–µ –∞—Ä–µ–Ω–¥—ã #${rental.id}`
                }
            });
            
            setPaymentApplied(true);
            toast.success("–ü–ª–∞—Ç–µ–∂ —É—Å–ø–µ—à–Ω–æ –∑–∞–Ω–µ—Å–µ–Ω.");
            
            // –ò–Ω–≤–∞–ª–∏–¥–∏—Ä—É–µ–º –∑–∞–ø—Ä–æ—Å—ã –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö
            await queryClient.invalidateQueries({ queryKey: ["adminUsers"] });
            await queryClient.invalidateQueries({ queryKey: ["adminRentals"] });
        } catch (error) {
            console.error("–û—à–∏–±–∫–∞ –ø—Ä–∏ –≤–Ω–µ—Å–µ–Ω–∏–∏ –ø–ª–∞—Ç–µ–∂–∞:", error);
        }
    };

    // –õ–æ–≥–∏–∫–∞ –æ—Ç–º–µ–Ω—ã –ø–ª–∞—Ç–µ–∂–∞
    const handleCancelPayment = () => {
        setPaymentAmount("");
        setPaymentDescription("");
        setPaymentApplied(false);
        toast.info("–í–≤–æ–¥ –ø–ª–∞—Ç–µ–∂–∞ –æ—Ç–º–µ–Ω–µ–Ω.");
    };

    // –ê–≤—Ç–æ–∑–∞–ø–æ–ª–Ω–µ–Ω–∏–µ —Å—É–º–º—ã –ø–ª–∞—Ç–µ–∂–∞ —Å —É—á–µ—Ç–æ–º —à—Ç—Ä–∞—Ñ–∞ –∑–∞ –ø—Ä–æ—Å—Ä–æ—á–∫—É
    const handleAutoFillPayment = () => {
        if (rental) {
            const remaining = rental.remaining_amount || 0;
            const surcharge = rental.overdue_surcharge || 0;
            const totalAmount = remaining + surcharge;
            setPaymentAmount(totalAmount.toString());
        }
    };

    useEffect(() => {
        if (rental) {
            setCheckedAccessories(new Set());
            setPaymentAmount("");
            setPaymentDescription("");
            setPaymentApplied(false);
            reset({
                actual_return_date: formatDate(new Date()),
                notes_on_return: "",
            });
        }
    }, [rental, reset]);

    const onSubmit = (data: ReturnFormData) => {
        if (!rental) return;
        returnMutation.mutate(
            {
                rentalId: rental.id,
                data: {
                    ...data,
                    accessories_returned_confirmation: allAccessoriesChecked,
                }
            },
            {
                onSuccess: () => {
                    reset();
                    onClose();
                },
            }
        );
    };

    return {
        // –°–æ—Å—Ç–æ—è–Ω–∏—è
        paymentAmount,
        setPaymentAmount,
        paymentDescription,
        setPaymentDescription,
        paymentApplied,
        checkedAccessories,
        dynamicRemainingAmount,
        
        // –§—É–Ω–∫—Ü–∏–∏-–æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏
        handleApplyPayment,
        handleCancelPayment,
        handleToggleAccessory,
        handleAutoFillPayment,
        onSubmit,
        
        // –°–æ—Å—Ç–æ—è–Ω–∏—è –º—É—Ç–∞—Ü–∏–π
        isSubmittingReturn: returnMutation.isPending,
        isApplyingPayment: paymentMutation.isPending,
        
        // –î–∞–Ω–Ω—ã–µ —Ñ–æ—Ä–º—ã –æ—Ç react-hook-form
        register,
        handleSubmit,
        formState: { errors, isValid },
        
        // –î—Ä—É–≥–∏–µ –≤—ã—á–∏—Å–ª—è–µ–º—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è
        accessoriesByEquipment,
        allAccessoriesChecked,
        totalAccessoriesCount,
    };
}


```


## <a name="srchooksadminuseUserTableLogicts"></a>`src/hooks/admin/useUserTableLogic.ts`

```typescript
// path: src/hooks/admin/useUserTableLogic.ts

// src/hooks/admin/useUserTableLogic.ts

import { useState, useMemo } from "react";
import { useCurrentUser } from "@/hooks/useProfile";
import {
    useUpdateUserRole,
    useBlockUser,
    useUnblockUser,
    useDeleteUser
} from "@/hooks/useAdminUsers";
import type { UserOut, UserRole } from "@/types/user";

export function useUserTableLogic(users: UserOut[]) {
    const { data: currentUser } = useCurrentUser();

    const [searchQuery, setSearchQuery] = useState("");
    const [confirmDelete, setConfirmDelete] = useState<number | null>(null);

    const updateRoleMutation = useUpdateUserRole();
    const blockUserMutation = useBlockUser();
    const unblockUserMutation = useUnblockUser();
    const deleteUserMutation = useDeleteUser();

    const isAdmin = currentUser?.role === "admin";

    const filteredUsers = useMemo(() => {
        return users.filter(user =>
            user.full_name.toLowerCase().includes(searchQuery.toLowerCase()) ||
            user.email.toLowerCase().includes(searchQuery.toLowerCase()) ||
            user.role.toLowerCase().includes(searchQuery.toLowerCase())
        );
    }, [users, searchQuery]);

    const handleRoleChange = (userId: number, newRole: string) => {
        if (!isAdmin) return;
        // –ò–ó–ú–ï–ù–ï–ù–ò–ï: –ü—Ä–∏–≤–æ–¥–∏–º string –∫ —Ç–∏–ø—É UserRole –ø–µ—Ä–µ–¥ –≤—ã–∑–æ–≤–æ–º –º—É—Ç–∞—Ü–∏–∏
        updateRoleMutation.mutate({ userId, newRole: newRole as UserRole });
    };

    const handleToggleBlock = (user: UserOut) => {
        if (!isAdmin) return;
        if (user.is_active) {
            blockUserMutation.mutate(user.id);
        } else {
            unblockUserMutation.mutate(user.id);
        }
    };

    const handleDelete = (userId: number) => {
        if (!isAdmin) return;
        if (confirmDelete === userId) {
            deleteUserMutation.mutate(userId);
            setConfirmDelete(null);
        } else {
            setConfirmDelete(userId);
            setTimeout(() => setConfirmDelete(null), 5000);
        }
    };

    return {
        currentUser,
        filteredUsers,
        isAdmin,
        searchQuery,
        setSearchQuery,
        confirmDelete,
        mutations: {
            updateRole: updateRoleMutation,
            blockUser: blockUserMutation,
            unblockUser: unblockUserMutation,
            deleteUser: deleteUserMutation,
        },
        handlers: {
            handleRoleChange,
            handleToggleBlock,
            handleDelete,
        },
    };
}

```


## <a name="srchooksdatauseEquipmentDatats"></a>`src/hooks/data/useEquipmentData.ts`

```typescript
// path: src/hooks/data/useEquipmentData.ts

// src/hooks/data/useEquipmentData.ts

import { useMemo } from "react";
import { useEquipment } from "@/hooks/useEquipment";
import { useAvailabilityCheck } from "@/hooks/useAvailabilityCheck";
import { useDailyAvailability } from "@/hooks/useDailyAvailability";
import { useReserveStore } from "@/store/reserveStore";
import type { Equipment } from "@/types/equipment";
import type { AvailabilityInfo, DailyAvailabilityData } from "@/types/availability";

export interface EquipmentFilters {
    query?: string;
    type?: string;
    brand?: string;
    associationId?: number;
    availableOnly?: boolean;
    startDate?: Date;
    endDate?: Date;
}

export interface UseEquipmentDataReturn {
    equipment: Equipment[];
    totalEquipmentCount: number;
    availabilityData: AvailabilityInfo[];
    dailyAvailabilityData: DailyAvailabilityData | undefined;
    isLoading: boolean;
    isFetchingNextPage: boolean;
    hasNextPage: boolean;
    fetchNextPage: () => void;
}

export const useEquipmentData = (filters: EquipmentFilters): UseEquipmentDataReturn => {
    const { addToReservationMode } = useReserveStore();

    // –ó–∞–≥—Ä—É–∂–∞–µ–º –ø–∞–≥–∏–Ω–∏—Ä–æ–≤–∞–Ω–Ω—ã–π —Å–ø–∏—Å–æ–∫ –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—è
    const {
        data: equipmentPages,
        fetchNextPage,
        hasNextPage,
        isLoading,
        isFetchingNextPage
    } = useEquipment(filters);

    // –ò–∑–≤–ª–µ–∫–∞–µ–º –ø–ª–æ—Å–∫–∏–π –º–∞—Å—Å–∏–≤ –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—è
    const equipment = useMemo(() =>
        equipmentPages?.pages.flatMap(page => page.items) ?? [],
        [equipmentPages]
    );

    const totalEquipmentCount = equipmentPages?.pages[0]?.total ?? 0;

    // –ó–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ –æ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏ –¥–ª—è –≤—Å–µ–≥–æ –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—è
    const { availabilityMap } = useAvailabilityCheck({
        equipmentIds: equipment.map(e => e.id),
        startDate: filters.startDate || new Date(),
        endDate: filters.endDate || new Date(),
        excludeReservationId: addToReservationMode || undefined,
        enabled: !!(filters.startDate && filters.endDate && equipment.length > 0)
    });

    // –ü—Ä–µ–æ–±—Ä–∞–∑—É–µ–º availabilityMap –æ–±—Ä–∞—Ç–Ω–æ –≤ –º–∞—Å—Å–∏–≤ –¥–ª—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏
    const availabilityData = useMemo(() => 
        Object.values(availabilityMap), 
        [availabilityMap]
    );

    // –ó–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ –æ –µ–∂–µ–¥–Ω–µ–≤–Ω–æ–π –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏ –¥–ª—è –≤–∏–¥–∏–º—ã—Ö —ç–ª–µ–º–µ–Ω—Ç–æ–≤
    const thirtyDaysFromNow = useMemo(() => new Date(Date.now() + 30 * 24 * 60 * 60 * 1000), []);
    const { data: dailyAvailabilityData } = useDailyAvailability({
        ids: equipment.map(item => item.id),
        start: new Date(),
        end: thirtyDaysFromNow,
    });

    return {
        equipment,
        totalEquipmentCount,
        availabilityData,
        dailyAvailabilityData,
        isLoading,
        isFetchingNextPage,
        hasNextPage,
        fetchNextPage
    };
};



```


## <a name="srchooksfeaturesuseAppFiltersts"></a>`src/hooks/features/useAppFilters.ts`

```typescript
// path: src/hooks/features/useAppFilters.ts

// src/hooks/features/useAppFilters.ts

import { useSearchStore } from "@/store/searchStore";
import { useFilterStore } from "@/store/filterStore";
import { useDateStore } from "@/store/dateStore";

/**
 * –•—É–∫ –¥–ª—è –∏–Ω–∫–∞–ø—Å—É–ª—è—Ü–∏–∏ –ª–æ–≥–∏–∫–∏ –ø–æ–ª—É—á–µ–Ω–∏—è –≤—Å–µ—Ö —Ñ–∏–ª—å—Ç—Ä–æ–≤ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
 * –û–±—ä–µ–¥–∏–Ω—è–µ—Ç —Å–æ—Å—Ç–æ—è–Ω–∏–µ –∏–∑ —Ç—Ä–µ—Ö —Å—Ç–æ—Ä–æ–≤: –ø–æ–∏—Å–∫–∞, —Ñ–∏–ª—å—Ç—Ä–æ–≤ –∏ –¥–∞—Ç
 */
export const useAppFilters = () => {
    const search = useSearchStore();
    const filters = useFilterStore();
    const dates = useDateStore();

    return {
        // –ü–æ–∏—Å–∫
        query: search.query,
        
        // –§–∏–ª—å—Ç—Ä—ã
        type: filters.type,
        brand: filters.brand,
        availableOnly: filters.availableOnly,
        associationId: filters.associationId,
        reset: filters.reset,
        
        // –î–∞—Ç—ã
        startDate: dates.startDate,
        endDate: dates.endDate,
    };
};



```


## <a name="srchooksfeaturesuseEquipmentCardViewModelts"></a>`src/hooks/features/useEquipmentCardViewModel.ts`

```typescript
// path: src/hooks/features/useEquipmentCardViewModel.ts

// src/hooks/features/useEquipmentCardViewModel.ts

import { useMemo, useCallback } from "react";
import { useReserveStore } from "@/store/reserveStore";
import { useDateStore } from "@/store/dateStore";
import { useSandboxCalculatorStore } from "@/store/sandboxCalculatorStore";
import { usePromoCodeStore } from "@/store/promoCodeStore";
import type { Equipment } from "@/types/equipment";
import type { EquipmentStatus } from "@/types/availability";

interface UseEquipmentCardViewModelProps {
    equipment: Equipment;
    status?: EquipmentStatus | "my_reservation" | "added";
}

/**
 * –•—É–∫ –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –ª–æ–≥–∏–∫–æ–π –∫–∞—Ä—Ç–æ—á–∫–∏ –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—è.
 * –°–æ–¥–µ—Ä–∂–∏—Ç –≤—Å–µ —Ö—É–∫–∏, —Ä–∞—Å—á–µ—Ç—ã –∏ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Å–æ–±—ã—Ç–∏–π –¥–ª—è EquipmentCard.
 */
export const useEquipmentCardViewModel = ({ equipment, status: _status = "available" }: UseEquipmentCardViewModelProps) => {
    // –ü–æ–ª—É—á–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö –∏–∑ –≤—Å–µ—Ö —Å—Ç–æ—Ä–æ–≤
    const { toggle, isSelected, toggleAccessory, isAccessorySelected, selectedAccessories } = useReserveStore();
    const { dayCount } = useDateStore();
    const { isCalculatorVisible, durationDiscountPercentage } = useSandboxCalculatorStore();
    const { promoCodePercentage } = usePromoCodeStore();

    // –ü—Ä–æ–≤–µ—Ä–∫–∞ –≤—ã–±—Ä–∞–Ω–Ω–æ—Å—Ç–∏ –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—è
    const isSelectedByUser = isSelected(equipment.id);

    // –†–∞—Å—á–µ—Ç —Å—É—Ç–æ—á–Ω–æ–π —Å—Ç–æ–∏–º–æ—Å—Ç–∏ –∞–∫—Å–µ—Å—Å—É–∞—Ä–æ–≤
    const accessoriesDailyRate = useMemo(() => {
        const selectedForThisCard = selectedAccessories[equipment.id] || [];
        return equipment.accessories?.reduce((total, acc) => 
            selectedForThisCard.includes(acc.id) ? total + acc.price : total, 0) ?? 0;
    }, [equipment.accessories, equipment.id, selectedAccessories]);

    // –†–∞—Å—á–µ—Ç –æ–±—â–µ–π —Å–∫–∏–¥–∫–∏
    const totalDiscountPercentage = useMemo(() => 
        durationDiscountPercentage + promoCodePercentage, 
        [durationDiscountPercentage, promoCodePercentage]
    );

    // –î–∞–Ω–Ω—ã–µ –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è —Å–∫–∏–¥–∫–∏
    const discountData = useMemo(() => {
        const totalDailyRate = equipment.daily_rate + accessoriesDailyRate;
        const priceBefore = totalDailyRate * dayCount;
        return {
            days: dayCount,
            percentage: totalDiscountPercentage,
            priceBefore,
            priceAfter: priceBefore * (1 - totalDiscountPercentage / 100),
        };
    }, [equipment.daily_rate, accessoriesDailyRate, dayCount, totalDiscountPercentage]);

    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è –∞–∫—Å–µ—Å—Å—É–∞—Ä–∞
    const handleToggleAccessory = useCallback((accessoryId: number) => {
        if (!isSelectedByUser) toggle(equipment);
        toggleAccessory(equipment.id, accessoryId);
    }, [isSelectedByUser, toggle, equipment, toggleAccessory]);

    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è –≤—ã–±–æ—Ä–∞ –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—è
    const handleToggleSelection = useCallback(() => {
        toggle(equipment);
    }, [toggle, equipment]);

    return {
        // –°–æ—Å—Ç–æ—è–Ω–∏–µ
        isSelectedByUser,
        isCalculatorVisible,
        
        // –†–∞—Å—á–µ—Ç—ã
        accessoriesDailyRate,
        totalDiscountPercentage,
        discountData,
        
        // –§—É–Ω–∫—Ü–∏–∏
        handleToggleAccessory,
        handleToggleSelection,
        isAccessorySelected,
    };
};


```


## <a name="srchooksreservationsubmissionuseReservationFormDatats"></a>`src/hooks/reservation/submission/useReservationFormData.ts`

```typescript
// path: src/hooks/reservation/submission/useReservationFormData.ts

// src/hooks/reservation/submission/useReservationFormData.ts

import { useReserveStore } from "@/store/reserveStore";
import { useDateStore } from "@/store/dateStore";
import { usePromoCodeStore } from "@/store/promoCodeStore";
import { useCurrentUser } from "@/hooks/useProfile";

/**
 * –•—É–∫-–∞–≥—Ä–µ–≥–∞—Ç–æ—Ä –¥–ª—è —Å–±–æ—Ä–∞ –¥–∞–Ω–Ω—ã—Ö –∏–∑ —Ä–∞–∑–ª–∏—á–Ω—ã—Ö —Ö—Ä–∞–Ω–∏–ª–∏—â (Zustand).
 * –°–æ–±–∏—Ä–∞–µ—Ç –∏ –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –µ–¥–∏–Ω—ã–π –æ–±—ä–µ–∫—Ç —Å–æ –≤—Å–µ–º–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã–º–∏ –¥–∞–Ω–Ω—ã–º–∏ –¥–ª—è —Å—Ç—Ä–∞–Ω–∏—Ü—ã –æ—Ñ–æ—Ä–º–ª–µ–Ω–∏—è.
 */
export const useReservationFormData = () => {
    // –ü–æ–ª—É—á–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö –∏–∑ –≤—Å–µ—Ö —Å—Ç–æ—Ä–æ–≤
    const { data: user } = useCurrentUser();
    const { startDate, endDate, setStartDate, setEndDate, dayCount } = useDateStore();
    const { 
        items, 
        selectedAccessories, 
        remove: removeItemFromStore, 
        clear: clearReserveStore, 
        isAccessorySelected, 
        toggleAccessory 
    } = useReserveStore();
    const { 
        promoCode: promoCodeInput, 
        setPromoCode: setPromoCodeInput, 
        removePromoCode 
    } = usePromoCodeStore();

    return {
        // –î–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        user,
        
        // –î–∞–Ω–Ω—ã–µ –¥–∞—Ç
        startDate,
        endDate,
        dayCount,
        
        // –î–∞–Ω–Ω—ã–µ —Ä–µ–∑–µ—Ä–≤–∞
        items,
        selectedAccessories,
        
        // –ü—Ä–æ–º–æ–∫–æ–¥
        promoCodeInput,
        
        // –§—É–Ω–∫—Ü–∏–∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –¥–∞—Ç–∞–º–∏
        setStartDate,
        setEndDate,
        
        // –§—É–Ω–∫—Ü–∏–∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è —Ä–µ–∑–µ—Ä–≤–æ–º
        removeItemFromStore,
        clearReserveStore,
        isAccessorySelected,
        toggleAccessory,
        
        // –§—É–Ω–∫—Ü–∏–∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –ø—Ä–æ–º–æ–∫–æ–¥–æ–º
        setPromoCodeInput,
        removePromoCode,
    };
};


```


## <a name="srchooksreservationsubmissionuseReserveSubmissionts"></a>`src/hooks/reservation/submission/useReserveSubmission.ts`

```typescript
// path: src/hooks/reservation/submission/useReserveSubmission.ts

// src/hooks/reservation/submission/useReserveSubmission.ts

import { useMemo, useState } from "react";
import { toast } from "sonner";
import { useReservations } from "@/hooks/useReservations";
import { useAvailabilityCheck } from "@/hooks/useAvailabilityCheck";
import { reservationCreateSchema, type ReservationCreateInput } from "@/lib/validationSchemas";
import { usePriceCalculator } from "../usePriceCalculator";
import { formatDate } from "@/lib/utils";
import { useReservationFormData } from "./useReservationFormData";

/**
 * –•—É–∫-–∫–æ–æ—Ä–¥–∏–Ω–∞—Ç–æ—Ä –¥–ª—è —Å—Ç—Ä–∞–Ω–∏—Ü—ã –æ—Ñ–æ—Ä–º–ª–µ–Ω–∏—è —Ä–µ–∑–µ—Ä–≤–∞.
 * –ò—Å–ø–æ–ª—å–∑—É–µ—Ç —Ö—É–∫-–∞–≥—Ä–µ–≥–∞—Ç–æ—Ä –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö –∏ —Å–æ–¥–µ—Ä–∂–∏—Ç –ª–æ–≥–∏–∫—É –æ–±—Ä–∞–±–æ—Ç–∫–∏ –∏ –æ—Ç–ø—Ä–∞–≤–∫–∏ —Ñ–æ—Ä–º—ã.
 */
export function useReserveSubmission() {
    // –ü–æ–ª—É—á–µ–Ω–∏–µ –≤—Å–µ—Ö –¥–∞–Ω–Ω—ã—Ö —á–µ—Ä–µ–∑ —Ö—É–∫-–∞–≥—Ä–µ–≥–∞—Ç–æ—Ä
    const {
        user,
        startDate,
        endDate,
        dayCount,
        items,
        selectedAccessories,
        promoCodeInput,
        setStartDate,
        setEndDate,
        removeItemFromStore,
        clearReserveStore,
        isAccessorySelected,
        toggleAccessory,
        setPromoCodeInput,
        removePromoCode,
    } = useReservationFormData();

    // –õ–æ–∫–∞–ª—å–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ –¥–ª—è –ø—Ä–æ–º–æ–∫–æ–¥–∞, –∫–æ—Ç–æ—Ä—ã–π –±—ã–ª –ø—Ä–∏–º–µ–Ω–µ–Ω –∫ —Ä–∞—Å—á–µ—Ç—É
    const [appliedPromoCode, setAppliedPromoCode] = useState(promoCodeInput);

    // --- –†–ê–°–ß–ï–¢–´ –ò –ü–†–û–í–ï–†–ö–ò ---
    const equipmentIds = useMemo(() => items.map(i => i.id), [items]);

    // –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏ –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—è –Ω–∞ –≤—ã–±—Ä–∞–Ω–Ω—ã–µ –¥–∞—Ç—ã
    const { availabilityMap, conflictingItemIds, isLoading: isCheckingAvailability } = useAvailabilityCheck({
        equipmentIds, startDate, endDate
    });

    // –†–∞—Å—á–µ—Ç –∏—Ç–æ–≥–æ–≤–æ–π —Å—Ç–æ–∏–º–æ—Å—Ç–∏ —Å –ø–æ–º–æ—â—å—é —Ä–∞—Å—à–∏—Ä–µ–Ω–Ω–æ–≥–æ usePriceCalculator
    const priceCalculator = usePriceCalculator({
        equipmentIds, startDate, endDate, selectedAccessories, promoCode: appliedPromoCode
    });

    // –†–∞—Å—á–µ—Ç —Å—É—Ç–æ—á–Ω–æ–π —Å—Ç–æ–∏–º–æ—Å—Ç–∏ –∞–∫—Å–µ—Å—Å—É–∞—Ä–æ–≤ (–¥–ª—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏)
    const accessoriesDailyTotal = useMemo(() => {
        return items.reduce((total, item) => {
            const selectedForThisItem = selectedAccessories[item.id] || [];
            return total + (item.accessories?.reduce((accTotal, accessory) =>
                selectedForThisItem.includes(accessory.id) ? accTotal + accessory.price : accTotal, 0) ?? 0);
        }, 0);
    }, [items, selectedAccessories]);

    // --- –õ–û–ì–ò–ö–ê –û–¢–ü–†–ê–í–ö–ò –§–û–†–ú–´ ---
    const { createReservation } = useReservations();
    const { isPending: isSubmitting, isSuccess: reservationSuccess, mutateAsync, error } = createReservation;

    // –ò–∑–≤–ª–µ–∫–∞–µ–º ID –Ω–µ–¥–æ—Å—Ç—É–ø–Ω—ã—Ö —Ç–æ–≤–∞—Ä–æ–≤ –∏–∑ –æ—à–∏–±–∫–∏, –µ—Å–ª–∏ –æ–Ω–∞ –µ—Å—Ç—å
    const unavailableIdsFromAPI = useMemo(() => (error as { unavailable_ids?: number[] })?.unavailable_ids ?? [], [error]);

    const handleSubmit = async () => {
        if (!user) {
            toast.error("–ù–µ–æ–±—Ö–æ–¥–∏–º–æ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞—Ç—å—Å—è –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è —Ä–µ–∑–µ—Ä–≤–∞.");
            return;
        }
        if (conflictingItemIds.length > 0) {
            toast.error("–ù–µ–∫–æ—Ç–æ—Ä—ã–µ –≤—ã–±—Ä–∞–Ω–Ω—ã–µ –ø–æ–∑–∏—Ü–∏–∏ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω—ã. –£–¥–∞–ª–∏—Ç–µ –∏—Ö –∏–ª–∏ –∏–∑–º–µ–Ω–∏—Ç–µ –¥–∞—Ç—ã.");
            return;
        }

        const payload: ReservationCreateInput = {
            equipment_ids: items.map(i => i.id),
            start_date: formatDate(startDate),
            end_date: formatDate(endDate),
            selected_accessories: selectedAccessories,
            promo_code: appliedPromoCode || undefined,
        };

        const validationResult = reservationCreateSchema.safeParse(payload);
        if (!validationResult.success) {
            const errorMessages = validationResult.error.errors.map(e => e.message).join("\n");
            toast.error(`–û—à–∏–±–∫–∞ –≤–∞–ª–∏–¥–∞—Ü–∏–∏ –¥–∞–Ω–Ω—ã—Ö:\n${errorMessages}`);
            return;
        }

        try {
            await mutateAsync(validationResult.data);
            toast.success("–†–µ–∑–µ—Ä–≤ —É—Å–ø–µ—à–Ω–æ —Å–æ–∑–¥–∞–Ω!");
            clearReserveStore();
            // –û—á–∏—â–∞–µ–º –ø—Ä–æ–º–æ–∫–æ–¥ –ø–æ—Å–ª–µ —É—Å–ø–µ—à–Ω–æ–≥–æ —Ä–µ–∑–µ—Ä–≤–∞
            removePromoCode();
        } catch (e: unknown) {
            // –û—à–∏–±–∫–∏ (–≤–∫–ª—é—á–∞—è 409 —Å –∫–æ–Ω—Ñ–ª–∏–∫—Ç–∞–º–∏) —Ç–µ–ø–µ—Ä—å –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—é—Ç—Å—è –∏ –æ—Ç–æ–±—Ä–∞–∂–∞—é—Ç—Å—è
            // —Ü–µ–Ω—Ç—Ä–∞–ª–∏–∑–æ–≤–∞–Ω–Ω–æ –≤ —Ö—É–∫–µ useReservations. –ó–¥–µ—Å—å –º—ã –ø—Ä–æ—Å—Ç–æ –ª–æ–≥–∏—Ä—É–µ–º –∏—Ö.
            console.error("Submission failed:", e);
        }
    };

    // –§—É–Ω–∫—Ü–∏—è, –∫–æ—Ç–æ—Ä–∞—è "—Ñ–∏–∫—Å–∏—Ä—É–µ—Ç" –≤–≤–µ–¥–µ–Ω–Ω—ã–π –ø—Ä–æ–º–æ–∫–æ–¥ –¥–ª—è —Ä–∞—Å—á–µ—Ç–∞
    const applyPromoCode = () => {
        setAppliedPromoCode(promoCodeInput);
    };

    // --- –í–û–ó–í–†–ê–¢ –î–ê–ù–ù–´–• –î–õ–Ø UI ---
    // –°–æ–±–∏—Ä–∞–µ–º –≤—Å–µ –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã–µ –¥–∞–Ω–Ω—ã–µ –∏ —Ñ—É–Ω–∫—Ü–∏–∏ –≤ –æ–¥–∏–Ω –æ–±—ä–µ–∫—Ç –¥–ª—è –ø–µ—Ä–µ–¥–∞—á–∏ –≤ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç
    return {
        // –î–∞–Ω–Ω—ã–µ –∏ —Å–æ—Å—Ç–æ—è–Ω–∏–µ
        items,
        user,
        startDate,
        endDate,
        availabilityMap,
        unavailableIdsFromAPI,
        invalidItems: conflictingItemIds,
        isLoadingAvailability: isCheckingAvailability || priceCalculator.isCalculatingPrice,
        isSubmitting,
        isApplyingPromoCode: priceCalculator.isApplyingPromoCode,
        reservationSuccess,
        submitMessage: (error as Error)?.message,
        selectedAccessories,
        // –§–∏–Ω–∞–Ω—Å–æ–≤—ã–µ —Ä–∞—Å—á–µ—Ç—ã –∏–∑ —Ü–µ–Ω—Ç—Ä–∞–ª–∏–∑–æ–≤–∞–Ω–Ω–æ–≥–æ —Ö—É–∫–∞
        priceDetails: priceCalculator.priceDetails,
        dayCount: priceCalculator.dayCount || dayCount,
        fullTotal: priceCalculator.fullTotal,
        totalDiscountPercentage: priceCalculator.totalDiscountPercentage,
        discountAmount: priceCalculator.discountAmount,
        finalTotal: priceCalculator.finalTotal,
        accessoriesDailyTotal,
        // –ü—Ä–æ–º–æ–∫–æ–¥
        promoCode: promoCodeInput,
        promoCodeMessage: priceCalculator.promoCodeMessage,
        // –§—É–Ω–∫—Ü–∏–∏ –∏ –¥–µ–π—Å—Ç–≤–∏—è
        setStartDate,
        setEndDate,
        clearReserveStore,
        removeItemFromStore,
        isAccessorySelected,
        toggleAccessory,
        setPromoCode: setPromoCodeInput,
        applyPromoCode,
        removePromoCode,
        handleSubmit,
    };
}


```


## <a name="srchooksreservationusePriceCalculatorts"></a>`src/hooks/reservation/usePriceCalculator.ts`

```typescript
// path: src/hooks/reservation/usePriceCalculator.ts

// src/hooks/reservation/usePriceCalculator.ts

import { useQuery } from "@tanstack/react-query";
import { ReservationService, type PriceDetails } from "@/core/services";
import { formatDate } from "@/lib/utils";

interface UsePriceCalculatorInput {
    equipmentIds: number[];
    startDate: Date;
    endDate: Date;
    selectedAccessories: Record<number, number[]>;
    promoCode?: string;
    enabled?: boolean;
}

export { type PriceDetails };

/**
 * –ï–¥–∏–Ω—ã–π —Ö—É–∫ –¥–ª—è —Ä–∞—Å—á–µ—Ç–∞ —Å—Ç–æ–∏–º–æ—Å—Ç–∏ —Ä–µ–∑–µ—Ä–≤–∞.
 * –Ø–≤–ª—è–µ—Ç—Å—è –µ–¥–∏–Ω—Å—Ç–≤–µ–Ω–Ω—ã–º –∏—Å—Ç–æ—á–Ω–∏–∫–æ–º –ø—Ä–∞–≤–¥—ã –¥–ª—è –≤—Å–µ—Ö —Ñ–∏–Ω–∞–Ω—Å–æ–≤—ã—Ö —Ä–∞—Å—á–µ—Ç–æ–≤ –≤ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏.
 */
export const usePriceCalculator = ({
    equipmentIds, 
    startDate, 
    endDate, 
    selectedAccessories, 
    promoCode, 
    enabled = true
}: UsePriceCalculatorInput) => {

    const queryKey = [
        "priceCalculation",
        [...equipmentIds].sort(),
        formatDate(startDate),
        formatDate(endDate),
        JSON.stringify(selectedAccessories),
        promoCode || ""
    ];

    const query = useQuery<PriceDetails>({
        queryKey: queryKey,
        queryFn: async () => {
            return ReservationService.calculatePrice({
                equipment_ids: equipmentIds,
                start_date: formatDate(startDate),
                end_date: formatDate(endDate),
                selected_accessories: selectedAccessories,
                promo_code: promoCode
            });
        },
        enabled: enabled && equipmentIds.length > 0 && !!startDate && !!endDate && startDate < endDate,
        staleTime: 5000,
    });

    // –í–æ–∑–≤—Ä–∞—â–∞–µ–º —Ä–∞—Å—à–∏—Ä–µ–Ω–Ω—ã–π –æ–±—ä–µ–∫—Ç —Å –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–º–∏ –≤—ã—á–∏—Å–ª—è–µ–º—ã–º–∏ –ø–æ–ª—è–º–∏
    return {
        ...query,
        // –û—Å–Ω–æ–≤–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –∏–∑ API
        priceDetails: query.data,
        
        // –í—ã—á–∏—Å–ª—è–µ–º—ã–µ –ø–æ–ª—è –¥–ª—è —É–¥–æ–±—Å—Ç–≤–∞ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è
        dayCount: query.data?.day_count ?? 0,
        fullTotal: query.data?.full_total ?? 0,
        finalTotal: query.data?.final_total ?? 0,
        discountAmount: query.data?.discount_amount ?? 0,
        durationDiscountPercentage: query.data?.duration_discount_percentage ?? 0,
        promoDiscountPercentage: query.data?.promo_discount_percentage ?? 0,
        totalDiscountPercentage: (query.data?.duration_discount_percentage ?? 0) + (query.data?.promo_discount_percentage ?? 0),
        promoCodeMessage: query.data?.promo_code_message ?? "",
        
        // –°–æ—Å—Ç–æ—è–Ω–∏—è –∑–∞–≥—Ä—É–∑–∫–∏
        isCalculatingPrice: query.isLoading,
        isFetchingPrice: query.isFetching,
        isApplyingPromoCode: query.isFetching && !!promoCode,
    };
};

```


## <a name="srchooksreservationuseReservationActionsts"></a>`src/hooks/reservation/useReservationActions.ts`

```typescript
// path: src/hooks/reservation/useReservationActions.ts

// src/hooks/reservation/useReservationActions.ts

import { useState, useCallback, useMemo } from "react";
import { toast } from "sonner";
import { useReserveStore } from "@/store/reserveStore";
import { useEditReservation } from "../useEditReservation";
import { ReservationService } from "@/core/services";
import type { Reservation } from "@/types/reservation";
import { type EditState } from "./useReservationState";

export function useReservationActions({
                                          reservation,
                                          state,
                                          hasConflicts,
                                          appliedPromoCode,
                                          onFullCancellation,
                                          isAdminContext,
                                          onFinishEditing, // ‚ú® 1. –ü—Ä–∏–Ω–∏–º–∞–µ–º –∫–æ–ª–±—ç–∫
                                      }: {
    reservation: Reservation,
    state: EditState,
    hasConflicts: boolean,
    appliedPromoCode: string,
    onFullCancellation?: () => Promise<void> | void,
    isAdminContext: boolean,
    onFinishEditing: () => void; // ‚ú® 2. –î–æ–±–∞–≤–ª—è–µ–º –µ–≥–æ –≤ —Ç–∏–ø
}) {
    const editApiMutation = useEditReservation();
    const { clear: clearReserveStore } = useReserveStore();

    const finalHasChanges = useMemo(() => {
        const promoCodeChanged = appliedPromoCode !== (reservation.promo_code || "");
        return state.hasChanges || promoCodeChanged;
    }, [state.hasChanges, appliedPromoCode, reservation.promo_code]);

    const saveChanges = useCallback(async (): Promise<boolean> => {
        if (!finalHasChanges) {
            toast.info("–ù–µ—Ç –∏–∑–º–µ–Ω–µ–Ω–∏–π –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è.");
            return false;
        }
        if (hasConflicts) {
            toast.error("–ù–µ–≤–æ–∑–º–æ–∂–Ω–æ —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å —Ä–µ–∑–µ—Ä–≤ —Å –∫–æ–Ω—Ñ–ª–∏–∫—Ç–∞–º–∏.");
            return false;
        }
        if (state.currentEquipmentDetails.length === 0) {
            toast.error("–†–µ–∑–µ—Ä–≤ –¥–æ–ª–∂–µ–Ω —Å–æ–¥–µ—Ä–∂–∞—Ç—å —Ö–æ—Ç—è –±—ã –æ–¥–Ω—É –ø–æ–∑–∏—Ü–∏—é.");
            return false;
        }

        try {
            await editApiMutation.mutateAsync({
                id: reservation.id,
                start_date: state.startDate.toISOString().split('T')[0],
                end_date: state.endDate.toISOString().split('T')[0],
                equipment_ids: state.currentEquipmentDetails.map(eq => eq.id),
                promo_code: appliedPromoCode || undefined,
                selected_accessories: state.localSelectedAccessories,
                isAdminContext,
            });
            toast.success("–†–µ–∑–µ—Ä–≤ —É—Å–ø–µ—à–Ω–æ –æ–±–Ω–æ–≤–ª–µ–Ω!");
            clearReserveStore();
            onFinishEditing(); // ‚ú® 3. –í—ã–∑—ã–≤–∞–µ–º –∫–æ–ª–±—ç–∫ –ø–æ—Å–ª–µ —É—Å–ø–µ—à–Ω–æ–≥–æ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è
            return true;
        } catch (error) {
            toast.error("–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–π.");
            return false;
        }
    }, [
        reservation.id, state, finalHasChanges, hasConflicts,
        appliedPromoCode, editApiMutation, clearReserveStore, isAdminContext, onFinishEditing
    ]);

    const [isCancelling, setIsCancelling] = useState(false);

    const handleConfirmFullCancellation = useCallback(async () => {
        if (!onFullCancellation) return;
        setIsCancelling(true);
        try {
            await onFullCancellation();
        } catch (error) {
            toast.error("–ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–º–µ–Ω–∏—Ç—å —Ä–µ–∑–µ—Ä–≤.");
        } finally {
            setIsCancelling(false);
        }
    }, [onFullCancellation]);

    return {
        saveChanges,
        isSaving: editApiMutation.isPending,
        handleConfirmFullCancellation,
        isCancelling,
        finalHasChanges,
    };
}

```


## <a name="srchooksreservationuseReservationDatats"></a>`src/hooks/reservation/useReservationData.ts`

```typescript
// path: src/hooks/reservation/useReservationData.ts

// src/hooks/reservation/useReservationData.ts

import { useState, useMemo, useEffect } from "react";
import { usePriceCalculator } from "./usePriceCalculator";
import { useAvailabilityCheck } from "@/hooks/useAvailabilityCheck";
import type { EditState } from "./useReservationState";
import type { Reservation } from "@/types/reservation";

const emptyFinancials = {
    dayCount: 0,
    fullTotal: 0,
    finalTotal: 0,
    discountAmount: 0,
    durationDiscountAmount: 0,
    durationDiscountPercentage: 0,
    promoDiscountAmount: 0,
    promoCodePercentage: 0,
    promoCodeMessage: "",
};

export function useReservationData(reservation: Reservation, state: EditState) {
    const [promoCode, setPromoCode] = useState(reservation.promo_code || "");
    const [appliedPromoCode, setAppliedPromoCode] = useState(reservation.promo_code || "");

    const { availabilityMap, hasConflicts, isLoading: isCheckingAvailability } = useAvailabilityCheck({
        equipmentIds: state.currentEquipmentDetails.map(eq => eq.id),
        startDate: state.startDate,
        endDate: state.endDate,
        // ‚ú® –ì–õ–ê–í–ù–û–ï –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï: –ú—ã –≤—Å–µ–≥–¥–∞ –≤ —Ä–µ–∂–∏–º–µ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è,
        // –ø–æ—ç—Ç–æ–º—É –≤—Å–µ–≥–¥–∞ –ø–µ—Ä–µ–¥–∞–µ–º ID –¥–ª—è –∏—Å–∫–ª—é—á–µ–Ω–∏—è.
        excludeReservationId: reservation.id,
    });

    const priceCalculator = usePriceCalculator({
        equipmentIds: state.currentEquipmentDetails.map(i => i.id),
        startDate: state.startDate,
        endDate: state.endDate,
        selectedAccessories: state.localSelectedAccessories,
        promoCode: appliedPromoCode,
        enabled: true // –•—É–∫ –∞–∫—Ç–∏–≤–µ–Ω –≤—Å–µ–≥–¥–∞, –∫–æ–≥–¥–∞ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è
    });

    const financials = useMemo(() => {
        if (!priceCalculator.priceDetails) {
            return { ...emptyFinancials, promoCode: promoCode };
        }
        const priceDetails = priceCalculator.priceDetails;
        const durationDiscountAmount = priceDetails.full_total * (priceDetails.duration_discount_percentage / 100);
        const promoDiscountAmount = priceDetails.full_total * (priceDetails.promo_discount_percentage / 100);
        return {
            dayCount: priceDetails.day_count,
            fullTotal: priceDetails.full_total,
            finalTotal: priceDetails.final_total,
            discountAmount: priceDetails.discount_amount,
            durationDiscountAmount,
            durationDiscountPercentage: priceDetails.duration_discount_percentage,
            promoDiscountAmount,
            promoCodePercentage: priceDetails.promo_discount_percentage,
            promoCodeMessage: priceDetails.promo_code_message ?? "",
            promoCode: promoCode,
        };
    }, [priceCalculator.priceDetails, promoCode]);

    const applyPromoCode = () => setAppliedPromoCode(promoCode);
    const removePromoCode = () => {
        setPromoCode("");
        setAppliedPromoCode("");
    };

    return {
        availabilityMap,
        hasConflicts,
        isCheckingAvailability,
        isCalculatingPrice: priceCalculator.isCalculatingPrice,
        financials,
        promoCode,
        setPromoCode,
        applyPromoCode,
        removePromoCode,
        appliedPromoCode,
        priceDetails: priceCalculator.priceDetails,
    };
}

```


## <a name="srchooksreservationuseReservationEditStatets"></a>`src/hooks/reservation/useReservationEditState.ts`

```typescript
// path: src/hooks/reservation/useReservationEditState.ts

// src/hooks/reservation/useReservationEditState.ts
import { useState, useMemo, useCallback, useEffect } from "react";
import type { Reservation } from "@/types/reservation";
// ‚ùå –£–¥–∞–ª–µ–Ω –Ω–µ–∏—Å–ø–æ–ª—å–∑—É–µ–º—ã–π –∏–º–ø–æ—Ä—Ç `Equipment`
// import type { Equipment } from "@/types/equipment";

// ‚úÖ –û–ø–µ—á–∞—Ç–∫–∞ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∞: –ø–µ—Ä–µ–∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è -> –ø–µ—Ä–µ–∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è
// –ò–Ω—Ç–µ—Ä—Ñ–µ–π—Å—ã –≤—ã–Ω–µ—Å–µ–Ω—ã –¥–ª—è –ø–µ—Ä–µ–∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è
export interface EquipmentDisplayDetail {
    id: number;
    label: string;
}

export interface EditState {
    isEditing: boolean;
    startDate: Date;
    endDate: Date;
    originalEquipmentIds: ReadonlySet<number>;
    currentEquipmentDetails: EquipmentDisplayDetail[];
    newlyAddedEquipmentIds: ReadonlySet<number>;
    hasChanges: boolean;
}

/**
 * –£–ø—Ä–∞–≤–ª—è–µ—Ç –æ—Å–Ω–æ–≤–Ω—ã–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ–º —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è —Ä–µ–∑–µ—Ä–≤–∞.
 */
export function useReservationEditState(
    reservation: Reservation,
    initialEquipmentForDisplay: ReadonlyArray<EquipmentDisplayDetail>
) {
    const initialStartDate = useMemo(() => new Date(reservation.start_date), [reservation.start_date]);
    const initialEndDate = useMemo(() => new Date(reservation.end_date), [reservation.end_date]);
    const initialOriginalIds = useMemo(() => new Set(reservation.equipment_ids), [reservation.equipment_ids]);
    const initialCurrentDetails = useMemo(() => [...initialEquipmentForDisplay], [initialEquipmentForDisplay]);

    const [editState, setEditState] = useState<EditState>({
        isEditing: false,
        startDate: initialStartDate,
        endDate: initialEndDate,
        originalEquipmentIds: initialOriginalIds,
        currentEquipmentDetails: initialCurrentDetails,
        newlyAddedEquipmentIds: new Set<number>(),
        hasChanges: false
    });

    const calculateChanges = useCallback((
        currentState: EditState
    ): boolean => {
        const datesChanged =
            currentState.startDate.getTime() !== initialStartDate.getTime() ||
            currentState.endDate.getTime() !== initialEndDate.getTime();

        const currentIdSet = new Set(currentState.currentEquipmentDetails.map(eq => eq.id));
        const equipmentChanged =
            initialOriginalIds.size !== currentIdSet.size ||
            !Array.from(initialOriginalIds).every(id => currentIdSet.has(id));

        return datesChanged || equipmentChanged;
    }, [initialStartDate, initialEndDate, initialOriginalIds]);

    // –°–±—Ä–æ—Å —Å–æ—Å—Ç–æ—è–Ω–∏—è, –µ—Å–ª–∏ –ø—Ä–æ–ø—Å—ã —Ä–µ–∑–µ—Ä–≤–∞ –∏–∑–º–µ–Ω–∏–ª–∏—Å—å –∏–∑–≤–Ω–µ
    useEffect(() => {
        if (!editState.isEditing) {
            setEditState({
                isEditing: false,
                startDate: initialStartDate,
                endDate: initialEndDate,
                originalEquipmentIds: initialOriginalIds,
                currentEquipmentDetails: initialCurrentDetails,
                newlyAddedEquipmentIds: new Set<number>(),
                hasChanges: false,
            });
        }
    }, [initialStartDate, initialEndDate, initialOriginalIds, initialCurrentDetails, editState.isEditing]);

    const resetToInitialState = useCallback(() => {
        setEditState({
            isEditing: false,
            startDate: initialStartDate,
            endDate: initialEndDate,
            originalEquipmentIds: initialOriginalIds,
            currentEquipmentDetails: initialCurrentDetails,
            newlyAddedEquipmentIds: new Set<number>(),
            hasChanges: false,
        });
    }, [initialStartDate, initialEndDate, initialOriginalIds, initialCurrentDetails]);

    return {
        editState,
        setEditState,
        calculateChanges,
        initialOriginalIds,
        initialStartDate,
        initialEndDate,
        resetToInitialState,
    };
}

```


## <a name="srchooksreservationuseReservationStatets"></a>`src/hooks/reservation/useReservationState.ts`

```typescript
// path: src/hooks/reservation/useReservationState.ts

// src/hooks/reservation/useReservationState.ts

import { useState, useMemo, useCallback, useEffect } from "react";
import type { Reservation } from "@/types/reservation";
import type { Equipment } from "@/types/equipment";

export interface EquipmentDisplayDetail {
    id: number;
    label: string;
}

export interface EditState {
    // isEditing: boolean; // ‚ú® –£–î–ê–õ–ï–ù–û
    startDate: Date;
    endDate: Date;
    originalEquipmentIds: ReadonlySet<number>;
    currentEquipmentDetails: EquipmentDisplayDetail[];
    newlyAddedEquipmentIds: ReadonlySet<number>;
    localSelectedAccessories: Record<number, number[]>;
    hasChanges: boolean;
}

function createDisplayLabel(equipmentItem: Equipment): string {
    return `${equipmentItem.equipment_type} ${equipmentItem.brand} ${equipmentItem.name}`;
}

export function useReservationState(
    reservation: Reservation,
    initialEquipmentForDisplay: ReadonlyArray<EquipmentDisplayDetail>
) {
    const initialValues = useMemo(() => ({
        startDate: new Date(reservation.start_date),
        endDate: new Date(reservation.end_date),
        equipmentIds: new Set(reservation.equipment_ids),
        equipmentDetails: [...initialEquipmentForDisplay],
        accessories: reservation.selected_accessories || {},
    }), [reservation, initialEquipmentForDisplay]);

    const [state, setState] = useState<Omit<EditState, 'hasChanges'>>({ // ‚ú® hasChanges —É–±—Ä–∞–Ω–æ –∏–∑ –Ω–∞—á–∞–ª—å–Ω–æ–≥–æ —Å–æ—Å—Ç–æ—è–Ω–∏—è
        startDate: initialValues.startDate,
        endDate: initialValues.endDate,
        originalEquipmentIds: initialValues.equipmentIds,
        currentEquipmentDetails: initialValues.equipmentDetails,
        newlyAddedEquipmentIds: new Set<number>(),
        localSelectedAccessories: initialValues.accessories,
    });

    // ‚ú® –í—ã—á–∏—Å–ª—è–µ–º hasChanges —á–µ—Ä–µ–∑ useMemo
    const hasChanges = useMemo(() => {
        const datesChanged =
            state.startDate.getTime() !== initialValues.startDate.getTime() ||
            state.endDate.getTime() !== initialValues.endDate.getTime();

        const currentIdSet = new Set(state.currentEquipmentDetails.map(eq => eq.id));
        const equipmentChanged =
            initialValues.equipmentIds.size !== currentIdSet.size ||
            !Array.from(initialValues.equipmentIds).every(id => currentIdSet.has(id));

        const accessoriesChanged =
            JSON.stringify(state.localSelectedAccessories) !== JSON.stringify(initialValues.accessories);

        return datesChanged || equipmentChanged || accessoriesChanged;
    }, [state, initialValues]);


    const [isCancelConfirmationVisible, setCancelConfirmationVisible] = useState(false);

    const updateDates = useCallback((newStartDate: Date, newEndDate: Date) => {
        setState(prev => ({ ...prev, startDate: newStartDate, endDate: newEndDate }));
    }, []);

    const addEquipmentItems = useCallback((itemsToAdd: Equipment[]) => {
        setState(prev => {
            const currentIds = new Set(prev.currentEquipmentDetails.map(d => d.id));
            const newDetails = itemsToAdd
                .filter(item => !currentIds.has(item.id))
                .map(item => ({ id: item.id, label: createDisplayLabel(item) }));

            if (newDetails.length === 0) return prev;

            const newNewlyAddedIds = new Set(prev.newlyAddedEquipmentIds);
            itemsToAdd.forEach(item => {
                if (!initialValues.equipmentIds.has(item.id)) {
                    newNewlyAddedIds.add(item.id);
                }
            });

            return {
                ...prev,
                currentEquipmentDetails: [...prev.currentEquipmentDetails, ...newDetails],
                newlyAddedEquipmentIds: newNewlyAddedIds,
            };
        });
    }, [initialValues.equipmentIds]);

    const removeEquipmentItem = useCallback((idToRemove: number) => {
        if (state.currentEquipmentDetails.length <= 1) {
            setCancelConfirmationVisible(true);
        } else {
            setState(prev => {
                const newDetails = prev.currentEquipmentDetails.filter(eq => eq.id !== idToRemove);
                const newNewlyAddedIds = new Set(prev.newlyAddedEquipmentIds);
                newNewlyAddedIds.delete(idToRemove);

                const newAccessories = { ...prev.localSelectedAccessories };
                delete newAccessories[idToRemove];

                return {
                    ...prev,
                    currentEquipmentDetails: newDetails,
                    newlyAddedEquipmentIds: newNewlyAddedIds,
                    localSelectedAccessories: newAccessories,
                };
            });
        }
    }, [state.currentEquipmentDetails.length]);

    const toggleAccessory = useCallback((equipmentId: number, accessoryId: number) => {
        setState(prev => {
            const newAccessoriesState = { ...prev.localSelectedAccessories };
            const currentSelection = newAccessoriesState[equipmentId] || [];
            const isSelected = currentSelection.includes(accessoryId);

            const newSelection = isSelected
                ? currentSelection.filter(id => id !== accessoryId)
                : [...currentSelection, accessoryId];

            if (newSelection.length > 0) {
                newAccessoriesState[equipmentId] = newSelection;
            } else {
                delete newAccessoriesState[equipmentId];
            }
            return { ...prev, localSelectedAccessories: newAccessoriesState };
        });
    }, []);

    return {
        // ‚ú® –í–æ–∑–≤—Ä–∞—â–∞–µ–º –≤—ã—á–∏—Å–ª–µ–Ω–Ω–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ hasChanges
        state: { ...state, hasChanges },
        actions: {
            updateDates,
            addEquipmentItems,
            removeEquipmentItem,
            toggleAccessory,
        },
        dialogs: {
            isCancelConfirmationVisible,
            setCancelConfirmationVisible,
        },
    };
}

```


## <a name="srchooksuseAdminAccessoriests"></a>`src/hooks/useAdminAccessories.ts`

```typescript
// path: src/hooks/useAdminAccessories.ts

// src/hooks/useAdminAccessories.ts

import { useQuery, useMutation, useQueryClient } from "@tanstack/react-query";
import { api } from "@/lib/api";
import { toast } from "sonner";
import type { Accessory, AccessoryListResponse } from "@/types/accessory";
import { AccessoryService } from "@/core/services";

// –¢–∏–ø—ã –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è
type AccessoryPayload = {
    name: string;
    accessory_type?: string;
    price?: number;
    description?: string;
};

// +++ –ù–ê–ß–ê–õ–û –ò–ó–ú–ï–ù–ï–ù–ò–ô +++
// –î–æ–±–∞–≤–ª—è–µ–º –∑–Ω–∞—á–µ–Ω–∏—è –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é –¥–ª—è —Å—Ç—Ä–∞–Ω–∏—Ü—ã –∏ —Ä–∞–∑–º–µ—Ä–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
export function useAccessories(page: number = 1, pageSize: number = 20) {
// +++ –ö–û–ù–ï–¶ –ò–ó–ú–ï–ù–ï–ù–ò–ô +++
    const skip = (page - 1) * pageSize;

    return useQuery<AccessoryListResponse>({
        queryKey: ["accessories", page, pageSize],
        queryFn: async () => {
            return await AccessoryService.getAllAccessories(skip, pageSize);
        },
        staleTime: 5 * 60 * 1000, // 5 –º–∏–Ω—É—Ç
    });
}

// –°–æ–∑–¥–∞–Ω–∏–µ –Ω–æ–≤–æ–≥–æ –∞–∫—Å–µ—Å—Å—É–∞—Ä–∞
export function useCreateAccessory() {
    const queryClient = useQueryClient();
    return useMutation({
        mutationFn: (data: AccessoryPayload) => api.post<Accessory>("/accessories/", data),
        onSuccess: () => {
            void queryClient.invalidateQueries({ queryKey: ["accessories"] });
            toast.success("–ê–∫—Å–µ—Å—Å—É–∞—Ä —É—Å–ø–µ—à–Ω–æ —Å–æ–∑–¥–∞–Ω");
        },
        onError: (error: any) => {
            toast.error(error?.response?.data?.detail || "–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –∞–∫—Å–µ—Å—Å—É–∞—Ä–∞");
        },
    });
}

// –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∞–∫—Å–µ—Å—Å—É–∞—Ä–∞
export function useUpdateAccessory() {
    const queryClient = useQueryClient();
    return useMutation({
        mutationFn: ({ id, data }: { id: number, data: AccessoryPayload }) =>
            api.put<Accessory>(`/accessories/${id}`, data),
        onSuccess: () => {
            void queryClient.invalidateQueries({ queryKey: ["accessories"] });
            toast.success("–ê–∫—Å–µ—Å—Å—É–∞—Ä —É—Å–ø–µ—à–Ω–æ –æ–±–Ω–æ–≤–ª–µ–Ω");
        },
        onError: (error: any) => {
            toast.error(error?.response?.data?.detail || "–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ –∞–∫—Å–µ—Å—Å—É–∞—Ä–∞");
        },
    });
}

// –£–¥–∞–ª–µ–Ω–∏–µ –∞–∫—Å–µ—Å—Å—É–∞—Ä–∞
export function useDeleteAccessory() {
    const queryClient = useQueryClient();
    return useMutation({
        mutationFn: (id: number) => api.delete(`/accessories/${id}`),
        onSuccess: () => {
            void queryClient.invalidateQueries({ queryKey: ["accessories"] });
            toast.success("–ê–∫—Å–µ—Å—Å—É–∞—Ä —É–¥–∞–ª–µ–Ω");
        },
        onError: (error: any) => {
            toast.error(error?.response?.data?.detail || "–û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ –∞–∫—Å–µ—Å—Å—É–∞—Ä–∞");
        },
    });
}

```


## <a name="srchooksuseAdminAssociationsts"></a>`src/hooks/useAdminAssociations.ts`

```typescript
// path: src/hooks/useAdminAssociations.ts

// src/hooks/useAdminAssociations.ts

import { useQuery, useMutation, useQueryClient } from "@tanstack/react-query";
import { api } from "@/lib/api";
import { toast } from "sonner";
// +++ –ù–ê–ß–ê–õ–û –ò–ó–ú–ï–ù–ï–ù–ò–ô: –ò–º–ø–æ—Ä—Ç–∏—Ä—É–µ–º —Ç–∏–ø –¥–ª—è –æ—Ç–≤–µ—Ç–∞ —Å –ø–∞–≥–∏–Ω–∞—Ü–∏–µ–π +++
import type { Association, AssociationCreate, AssociationUpdate, AssociationListResponse } from "@/types/association";
// +++ –ö–û–ù–ï–¶ –ò–ó–ú–ï–ù–ï–ù–ò–ô +++

const ADMIN_ASSOCIATIONS_KEY = ["admin", "associations"];

// –•—É–∫ –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö —Ç–∞–∫–æ–π –∂–µ, –∫–∞–∫ –∏ –ø—É–±–ª–∏—á–Ω—ã–π, –Ω–æ —Å –¥—Ä—É–≥–∏–º –∫–ª—é—á–æ–º
export function useAdminAssociations() {
    // +++ –ù–ê–ß–ê–õ–û –ò–ó–ú–ï–ù–ï–ù–ò–ô: –ò—Å–ø—Ä–∞–≤–ª—è–µ–º —Ö—É–∫ –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –æ–±—ä–µ–∫—Ç–æ–º –æ—Ç–≤–µ—Ç–∞ +++
    return useQuery<AssociationListResponse, Error, Association[]>({
        queryKey: ADMIN_ASSOCIATIONS_KEY,
        queryFn: async () => {
            // 1. –û–∂–∏–¥–∞–µ–º –æ—Ç API –æ–±—ä–µ–∫—Ç AssociationListResponse
            const response = await api.get<AssociationListResponse>("/associations/");
            return response.data; // –í–æ–∑–≤—Ä–∞—â–∞–µ–º –≤–µ—Å—å –æ–±—ä–µ–∫—Ç { items: [...], total: ... }
        },
        // 2. –° –ø–æ–º–æ—â—å—é `select` –∏–∑–≤–ª–µ–∫–∞–µ–º –∏ –≤–æ–∑–≤—Ä–∞—â–∞–µ–º —Ç–æ–ª—å–∫–æ –º–∞—Å—Å–∏–≤ `items`
        select: (data) => data.items,
    });
    // +++ –ö–û–ù–ï–¶ –ò–ó–ú–ï–ù–ï–ù–ò–ô +++
}

export function useCreateAssociation() {
    const queryClient = useQueryClient();
    return useMutation({
        mutationFn: (data: AssociationCreate) => api.post<Association>("/associations/", data),
        onSuccess: () => {
            void queryClient.invalidateQueries({ queryKey: ADMIN_ASSOCIATIONS_KEY });
            toast.success("–ê—Å—Å–æ—Ü–∏–∞—Ü–∏—è —É—Å–ø–µ—à–Ω–æ —Å–æ–∑–¥–∞–Ω–∞");
        },
        onError: (e: any) => toast.error(e.response?.data?.detail || "–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è"),
    });
}

export function useUpdateAssociation() {
    const queryClient = useQueryClient();
    return useMutation({
        mutationFn: ({ id, data }: { id: number, data: AssociationUpdate }) =>
            api.put<Association>(`/associations/${id}`, data),
        onSuccess: () => {
            void queryClient.invalidateQueries({ queryKey: ADMIN_ASSOCIATIONS_KEY });
            toast.success("–ê—Å—Å–æ—Ü–∏–∞—Ü–∏—è —É—Å–ø–µ—à–Ω–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∞");
        },
        onError: (e: any) => toast.error(e.response?.data?.detail || "–û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è"),
    });
}

export function useDeleteAssociation() {
    const queryClient = useQueryClient();
    return useMutation({
        mutationFn: (id: number) => api.delete(`/associations/${id}`),
        onSuccess: () => {
            void queryClient.invalidateQueries({ queryKey: ADMIN_ASSOCIATIONS_KEY });
            toast.success("–ê—Å—Å–æ—Ü–∏–∞—Ü–∏—è —É–¥–∞–ª–µ–Ω–∞");
        },
        onError: (e: any) => toast.error(e.response?.data?.detail || "–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è"),
    });
}

```


## <a name="srchooksuseAdminDiscountsts"></a>`src/hooks/useAdminDiscounts.ts`

```typescript
// path: src/hooks/useAdminDiscounts.ts

// src/hooks/useAdminDiscounts.ts

import { useQuery, useMutation, useQueryClient } from "@tanstack/react-query";
import { api } from "@/lib/api";
import { toast } from "sonner";
// +++ –ù–ê–ß–ê–õ–û –ò–ó–ú–ï–ù–ï–ù–ò–ô: –ò—Å–ø—Ä–∞–≤–ª—è–µ–º –∏–º–ø–æ—Ä—Ç +++
import type { DurationDiscount, DiscountPayload, DiscountListResponse } from "@/types/discount";
// +++ –ö–û–ù–ï–¶ –ò–ó–ú–ï–ù–ï–ù–ò–ô +++

const DURATION_DISCOUNTS_KEY = "durationDiscounts";

export const useDurationDiscounts = (page: number = 1, pageSize: number = 10) => {
    const skip = (page - 1) * pageSize;
    return useQuery<DiscountListResponse>({
        queryKey: [DURATION_DISCOUNTS_KEY, page, pageSize],
        queryFn: async () => {
            const response = await api.get<DiscountListResponse>("/discounts/", {
                params: { skip, limit: pageSize }
            });
            return response.data;
        },
    });
};

export const useCreateDurationDiscount = () => {
    const queryClient = useQueryClient();
    return useMutation({
        mutationFn: (data: DiscountPayload) => api.post("/discounts/", data),
        onSuccess: () => {
            toast.success("–ù–æ–≤—ã–π —É—Ä–æ–≤–µ–Ω—å —Å–∫–∏–¥–∫–∏ –¥–æ–±–∞–≤–ª–µ–Ω");
            void queryClient.invalidateQueries({ queryKey: [DURATION_DISCOUNTS_KEY] });
        },
        onError: (e: any) => toast.error(e.response?.data?.detail || "–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è"),
    });
};

export const useUpdateDurationDiscount = () => {
    const queryClient = useQueryClient();
    return useMutation({
        mutationFn: ({ id, ...data }: DurationDiscount) => api.put(`/discounts/${id}`, data),
        onSuccess: () => {
            toast.success("–°–∫–∏–¥–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∞");
            void queryClient.invalidateQueries({ queryKey: [DURATION_DISCOUNTS_KEY] });
        },
        onError: (e: any) => toast.error(e.response?.data?.detail || "–û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è"),
    });
};

export const useDeleteDurationDiscount = () => {
    const queryClient = useQueryClient();
    return useMutation({
        mutationFn: (id: number) => api.delete(`/discounts/${id}`),
        onSuccess: () => {
            toast.success("–°–∫–∏–¥–∫–∞ —É–¥–∞–ª–µ–Ω–∞");
            void queryClient.invalidateQueries({ queryKey: [DURATION_DISCOUNTS_KEY] });
        },
        onError: (e: any) => toast.error(e.response?.data?.detail || "–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è"),
    });
};

```


## <a name="srchooksuseAdminEquipmentts"></a>`src/hooks/useAdminEquipment.ts`

```typescript
// path: src/hooks/useAdminEquipment.ts

//src/hooks/useAdminEquipment.ts


import { useMutation, useQueryClient } from "@tanstack/react-query";
import { api } from "@/lib/api";
import { toast } from "sonner";
import type { Equipment } from "@/types/equipment";

export interface EquipmentCreateData {
    equipment_type: string;
    brand: string;
    name: string;
    serial_number?: string;
    condition?: string;
    daily_rate?: number;
    notes?: string;
    description?: string;
    last_maintenance?: string; // format: YYYY-MM-DD
}

// –°–æ–∑–¥–∞–Ω–∏–µ –Ω–æ–≤–æ–≥–æ –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—è (–¥–ª—è –º–µ–Ω–µ–¥–∂–µ—Ä–æ–≤ –∏ –∞–¥–º–∏–Ω–æ–≤)
export function useCreateEquipment() {
    const queryClient = useQueryClient();

    return useMutation({
        mutationFn: async (equipmentData: EquipmentCreateData) => {
            const response = await api.post<Equipment>("/equipment/", equipmentData);
            return response.data;
        },
        onSuccess: () => {
            queryClient.invalidateQueries({ queryKey: ["equipment"] });
            queryClient.invalidateQueries({ queryKey: ["availability"] });
            queryClient.invalidateQueries({ queryKey: ["calendar-grid"] });
            toast.success("–û–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏–µ —É—Å–ø–µ—à–Ω–æ —Å–æ–∑–¥–∞–Ω–æ");
        },
        onError: (error: any) => {
            toast.error(error?.response?.data?.detail || "–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—è");
        },
    });
}

// –£–¥–∞–ª–µ–Ω–∏–µ –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—è (–¥–ª—è –º–µ–Ω–µ–¥–∂–µ—Ä–æ–≤ –∏ –∞–¥–º–∏–Ω–æ–≤)
export function useDeleteEquipment() {
    const queryClient = useQueryClient();

    return useMutation({
        mutationFn: async (equipmentId: number) => {
            const response = await api.delete(`/equipment/${equipmentId}`);
            return response.data;
        },
        onSuccess: () => {
            queryClient.invalidateQueries({ queryKey: ["equipment"] });
            queryClient.invalidateQueries({ queryKey: ["availability"] });
            queryClient.invalidateQueries({ queryKey: ["calendar-grid"] });
            toast.success("–û–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏–µ —É–¥–∞–ª–µ–Ω–æ");
        },
        onError: (error: any) => {
            toast.error(error?.response?.data?.detail || "–û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—è");
        },
    });
}

// –ú–∞—Å—Å–æ–≤–æ–µ —É–¥–∞–ª–µ–Ω–∏–µ –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—è
export function useBulkDeleteEquipment() {
    const queryClient = useQueryClient();

    return useMutation({
        mutationFn: async (equipmentIds: number[]) => {
            // –í—ã–ø–æ–ª–Ω—è–µ–º –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ–µ —É–¥–∞–ª–µ–Ω–∏–µ
            const deletePromises = equipmentIds.map(id => 
                api.delete(`/equipment/${id}`)
            );
            await Promise.all(deletePromises);
            return { deleted_count: equipmentIds.length };
        },
        onSuccess: (data) => {
            queryClient.invalidateQueries({ queryKey: ["equipment"] });
            queryClient.invalidateQueries({ queryKey: ["availability"] });
            queryClient.invalidateQueries({ queryKey: ["calendar-grid"] });
            toast.success(`–£–¥–∞–ª–µ–Ω–æ ${data.deleted_count} –µ–¥–∏–Ω–∏—Ü –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—è`);
        },
        onError: (error: any) => {
            toast.error("–û—à–∏–±–∫–∞ –ø—Ä–∏ –º–∞—Å—Å–æ–≤–æ–º —É–¥–∞–ª–µ–Ω–∏–∏ –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—è");
        },
    });
}

// –ú–∞—Å—Å–æ–≤–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Ç–∞—Ä–∏—Ñ–æ–≤
export function useBulkUpdateRates() {
    const queryClient = useQueryClient();

    return useMutation({
        mutationFn: async (updates: { id: number; daily_rate: number }[]) => {
            // –í—ã–ø–æ–ª–Ω—è–µ–º –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ
            const updatePromises = updates.map(({ id, daily_rate }) => 
                api.put(`/equipment/${id}`, { daily_rate })
            );
            await Promise.all(updatePromises);
            return { updated_count: updates.length };
        },
        onSuccess: (data) => {
            queryClient.invalidateQueries({ queryKey: ["equipment"] });
            toast.success(`–û–±–Ω–æ–≤–ª–µ–Ω—ã —Ç–∞—Ä–∏—Ñ—ã –¥–ª—è ${data.updated_count} –µ–¥–∏–Ω–∏—Ü –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—è`);
        },
        onError: (error: any) => {
            toast.error("–û—à–∏–±–∫–∞ –ø—Ä–∏ –º–∞—Å—Å–æ–≤–æ–º –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ —Ç–∞—Ä–∏—Ñ–æ–≤");
        },
    });
}


```


## <a name="srchooksuseAdminHolidayRulests"></a>`src/hooks/useAdminHolidayRules.ts`

```typescript
// path: src/hooks/useAdminHolidayRules.ts

// src/hooks/useAdminHolidayRules.ts

import { useQuery, useMutation, useQueryClient } from "@tanstack/react-query";
import { toast } from "sonner";
import { api } from "@/lib/api";

// –¢–∏–ø—ã, —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–∏–µ Pydantic-—Å—Ö–µ–º–∞–º –Ω–∞ –±—ç–∫–µ–Ω–¥–µ
interface HolidayRuleOut {
    id: number;
    rule_type: string;
    description: string;
    created_at: string;
}

interface RecurringHolidayRuleCreate {
    day_of_week: number;
    start_date: Date;
    end_date: Date;
    description: string;
}

// +++ –ù–ê–ß–ê–õ–û –ò–ó–ú–ï–ù–ï–ù–ò–ô: –î–æ–±–∞–≤–ª—è–µ–º —Ç–∏–ø –¥–ª—è –æ—Ç–≤–µ—Ç–∞ API +++
interface HolidayRuleListResponse {
    items: HolidayRuleOut[];
    total: number;
}
// +++ –ö–û–ù–ï–¶ –ò–ó–ú–ï–ù–ï–ù–ò–ô +++


const HOLIDAY_RULES_KEY = ["holidayRules"];
const HOLIDAYS_QUERY_KEY = ["holidays"];

// 1. –•—É–∫ –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è —Å–ø–∏—Å–∫–∞ –ø—Ä–∞–≤–∏–ª
export function useGetHolidayRules() {
    // +++ –ù–ê–ß–ê–õ–û –ò–ó–ú–ï–ù–ï–ù–ò–ô: –ò—Å–ø—Ä–∞–≤–ª—è–µ–º —Ö—É–∫ –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –æ–±—ä–µ–∫—Ç–æ–º –æ—Ç–≤–µ—Ç–∞ +++
    return useQuery<HolidayRuleListResponse, Error, HolidayRuleOut[]>({
        queryKey: HOLIDAY_RULES_KEY,
        queryFn: async () => {
            // 1. –û–∂–∏–¥–∞–µ–º –æ—Ç API –æ–±—ä–µ–∫—Ç HolidayRuleListResponse
            const response = await api.get<HolidayRuleListResponse>("/holidays/rules");
            return response.data;
        },
        // 2. –° –ø–æ–º–æ—â—å—é `select` –∏–∑–≤–ª–µ–∫–∞–µ–º –∏ –≤–æ–∑–≤—Ä–∞—â–∞–µ–º —Ç–æ–ª—å–∫–æ –º–∞—Å—Å–∏–≤ `items`
        select: (data) => data.items,
    });
    // +++ –ö–û–ù–ï–¶ –ò–ó–ú–ï–ù–ï–ù–ò–ô +++
}

// 2. –•—É–∫ –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –ø—Ä–∞–≤–∏–ª–∞ –µ–∂–µ–Ω–µ–¥–µ–ª—å–Ω—ã—Ö –≤—ã—Ö–æ–¥–Ω—ã—Ö
export function useCreateWeeklyRule() {
    const queryClient = useQueryClient();
    return useMutation({
        mutationFn: (data: RecurringHolidayRuleCreate) => api.post("/holidays/recurring/weekly", data),
        onSuccess: () => {
            toast.success("–ü—Ä–∞–≤–∏–ª–æ –¥–ª—è –µ–∂–µ–Ω–µ–¥–µ–ª—å–Ω—ã—Ö –≤—ã—Ö–æ–¥–Ω—ã—Ö —É—Å–ø–µ—à–Ω–æ —Å–æ–∑–¥–∞–Ω–æ!");
            void queryClient.invalidateQueries({ queryKey: HOLIDAY_RULES_KEY });
            void queryClient.invalidateQueries({ queryKey: HOLIDAYS_QUERY_KEY });
        },
        onError: (error: any) => {
            toast.error(error.response?.data?.detail || "–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –ø—Ä–∞–≤–∏–ª–∞");
        },
    });
}

// 3. –•—É–∫ –¥–ª—è –∏–º–ø–æ—Ä—Ç–∞ –≥–æ—Å—É–¥–∞—Ä—Å—Ç–≤–µ–Ω–Ω—ã—Ö –ø—Ä–∞–∑–¥–Ω–∏–∫–æ–≤
export function useImportPublicHolidays() {
    const queryClient = useQueryClient();
    return useMutation({
        mutationFn: ({ country_code, year }: { country_code: string; year: number }) =>
            api.post(`/holidays/import/public?country_code=${country_code}&year=${year}`),
        onSuccess: () => {
            toast.success("–ì–æ—Å—É–¥–∞—Ä—Å—Ç–≤–µ–Ω–Ω—ã–µ –ø—Ä–∞–∑–¥–Ω–∏–∫–∏ —É—Å–ø–µ—à–Ω–æ –∏–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω—ã!");
            void queryClient.invalidateQueries({ queryKey: HOLIDAY_RULES_KEY });
            void queryClient.invalidateQueries({ queryKey: HOLIDAYS_QUERY_KEY });
        },
        onError: (error: any) => {
            toast.error(error.response?.data?.detail || "–û—à–∏–±–∫–∞ –ø—Ä–∏ –∏–º–ø–æ—Ä—Ç–µ –ø—Ä–∞–∑–¥–Ω–∏–∫–æ–≤");
        },
    });
}


// 4. –•—É–∫ –¥–ª—è —É–¥–∞–ª–µ–Ω–∏—è –ø—Ä–∞–≤–∏–ª–∞
export function useDeleteHolidayRule() {
    const queryClient = useQueryClient();
    return useMutation({
        mutationFn: (ruleId: number) => api.delete(`/holidays/rules/${ruleId}`),
        onSuccess: () => {
            toast.success("–ü—Ä–∞–≤–∏–ª–æ –∏ —Å–≤—è–∑–∞–Ω–Ω—ã–µ —Å –Ω–∏–º –≤—ã—Ö–æ–¥–Ω—ã–µ —É–¥–∞–ª–µ–Ω—ã.");
            void queryClient.invalidateQueries({ queryKey: HOLIDAY_RULES_KEY });
            void queryClient.invalidateQueries({ queryKey: HOLIDAYS_QUERY_KEY });
        },
        onError: (error: any) => {
            toast.error(error.response?.data?.detail || "–û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ –ø—Ä–∞–≤–∏–ª–∞");
        },
    });
}

```


## <a name="srchooksuseAdminHolidaysts"></a>`src/hooks/useAdminHolidays.ts`

```typescript
// path: src/hooks/useAdminHolidays.ts

// src/hooks/useAdminHolidays.ts

import { useQuery, useMutation, useQueryClient } from "@tanstack/react-query";
import { toast } from "sonner";
import { api } from "@/lib/api";
import { formatDate } from "@/lib/utils";
import type { AxiosError } from "axios";
// +++ –ù–ê–ß–ê–õ–û –ò–ó–ú–ï–ù–ï–ù–ò–ô: –ò–º–ø–æ—Ä—Ç–∏—Ä—É–µ–º –Ω—É–∂–Ω—ã–µ —Ç–∏–ø—ã +++
import type { Holiday, HolidayListResponse } from "@/types/holiday";
// +++ –ö–û–ù–ï–¶ –ò–ó–ú–ï–ù–ï–ù–ò–ô +++


// –ù–æ–≤—ã–π —Ç–∏–ø –¥–ª—è –≤–Ω—É—Ç—Ä–µ–Ω–Ω–µ–≥–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è, –≥–¥–µ date —è–≤–ª—è–µ—Ç—Å—è –æ–±—ä–µ–∫—Ç–æ–º Date
export interface HolidayWithDate extends Omit<Holiday, 'date'> {
    date: Date;
}

export interface HolidayCreatePayload {
    date: string; // YYYY-MM-DD
    description?: string;
    force?: boolean; // –§–ª–∞–≥ –¥–ª—è –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è —Å–æ–∑–¥–∞–Ω–∏—è –ø—Ä–∏ –∫–æ–Ω—Ñ–ª–∏–∫—Ç–∞—Ö
}

// –¢–∏–ø –¥–ª—è –æ—à–∏–±–∫–∏ –∫–æ–Ω—Ñ–ª–∏–∫—Ç–∞ –æ—Ç API
interface ConflictErrorData {
    detail: {
        message: string;
        conflicting_reservation_ids: number[];
    };
}

const HOLIDAYS_QUERY_KEY = "holidays";

/**
 * –•—É–∫ –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è —Å–ø–∏—Å–∫–∞ –≤—ã—Ö–æ–¥–Ω—ã—Ö –≤ –∑–∞–¥–∞–Ω–Ω–æ–º –¥–∏–∞–ø–∞–∑–æ–Ω–µ –¥–∞—Ç.
 */
export function useHolidays(startDate: Date, endDate: Date) {
    const formattedStart = formatDate(startDate);
    const formattedEnd = formatDate(endDate);

    // +++ –ù–ê–ß–ê–õ–û –ò–ó–ú–ï–ù–ï–ù–ò–ô: –ü–æ–ª–Ω–æ—Å—Ç—å—é –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–Ω—ã–π —Ö—É–∫ +++
    return useQuery<HolidayListResponse, Error, HolidayWithDate[]>({
        queryKey: [HOLIDAYS_QUERY_KEY, formattedStart, formattedEnd],
        queryFn: async () => {
            const response = await api.get<HolidayListResponse>("/holidays/", {
                params: {
                    start_date: formattedStart,
                    end_date: formattedEnd,
                    // 1. –î–æ–±–∞–≤–ª—è–µ–º –Ω–µ–¥–æ—Å—Ç–∞—é—â–∏–π –ø–∞—Ä–∞–º–µ—Ç—Ä limit
                    limit: 100,
                },
            });
            return response.data; // –í–æ–∑–≤—Ä–∞—â–∞–µ–º –≤–µ—Å—å –æ–±—ä–µ–∫—Ç { items: [...], total: ... }
        },
        // 2. –° –ø–æ–º–æ—â—å—é `select` –∏–∑–≤–ª–µ–∫–∞–µ–º –º–∞—Å—Å–∏–≤ items –∏ –ø—Ä–µ–æ–±—Ä–∞–∑—É–µ–º –¥–∞—Ç—ã
        select: (data) => {
            return data.items.map(h => ({ ...h, date: new Date(h.date) }));
        },
        enabled: !!startDate && !!endDate,
    });
    // +++ –ö–û–ù–ï–¶ –ò–ó–ú–ï–ù–ï–ù–ò–ô +++
}

/**
 * –•—É–∫ –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –Ω–æ–≤–æ–≥–æ –≤—ã—Ö–æ–¥–Ω–æ–≥–æ –¥–Ω—è.
 * –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç —Å–ø–µ—Ü–∏—Ñ–∏—á–µ—Å–∫—É—é –æ—à–∏–±–∫—É –∫–æ–Ω—Ñ–ª–∏–∫—Ç–∞ (409).
 */
export function useCreateHoliday() {
    const queryClient = useQueryClient();
    return useMutation<unknown, AxiosError<ConflictErrorData>, HolidayCreatePayload>({
        mutationFn: (data) => api.post("/holidays/", data),
        onSuccess: () => {
            toast.success("–í—ã—Ö–æ–¥–Ω–æ–π –¥–µ–Ω—å —É—Å–ø–µ—à–Ω–æ –¥–æ–±–∞–≤–ª–µ–Ω");
            void queryClient.invalidateQueries({ queryKey: [HOLIDAYS_QUERY_KEY] });
        },
        onError: (error) => {
            if (error.response?.status === 409) {
                // –û—à–∏–±–∫–∞ –∫–æ–Ω—Ñ–ª–∏–∫—Ç–∞ –±—É–¥–µ—Ç –æ–±—Ä–∞–±–æ—Ç–∞–Ω–∞ –≤ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–µ
                return;
            }
            toast.error(error.response?.data?.detail?.message || "–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –≤—ã—Ö–æ–¥–Ω–æ–≥–æ –¥–Ω—è");
        },
    });
}

/**
 * –•—É–∫ –¥–ª—è —É–¥–∞–ª–µ–Ω–∏—è –≤—ã—Ö–æ–¥–Ω–æ–≥–æ –¥–Ω—è.
 */
export function useDeleteHoliday() {
    const queryClient = useQueryClient();
    return useMutation({
        mutationFn: (date: Date) => api.delete(`/holidays/${formatDate(date)}`),
        onSuccess: () => {
            toast.success("–í—ã—Ö–æ–¥–Ω–æ–π –¥–µ–Ω—å —É–¥–∞–ª–µ–Ω");
            void queryClient.invalidateQueries({ queryKey: [HOLIDAYS_QUERY_KEY] });
        },
        onError: (error: any) => {
            toast.error(error.response?.data?.detail || "–û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ –≤—ã—Ö–æ–¥–Ω–æ–≥–æ –¥–Ω—è");
        },
    });
}

```


## <a name="srchooksuseAdminPromoCodests"></a>`src/hooks/useAdminPromoCodes.ts`

```typescript
// path: src/hooks/useAdminPromoCodes.ts

// src/hooks/useAdminPromoCodes.ts

import { useQuery, useMutation, useQueryClient } from "@tanstack/react-query";
import { api } from "@/lib/api";
import { toast } from "sonner";
// +++ –ù–ê–ß–ê–õ–û –ò–ó–ú–ï–ù–ï–ù–ò–ô: –ò–º–ø–æ—Ä—Ç–∏—Ä—É–µ–º –Ω–æ–≤—ã–π —Ç–∏–ø +++
import type {
    PromoCodeOut,
    PromoCodeCreate,
    PromoCodeUpdate,
    PromoCodeListResponse
} from "@/types/promo_code";
// +++ –ö–û–ù–ï–¶ –ò–ó–ú–ï–ù–ï–ù–ò–ô +++

const PROMO_CODES_QUERY_KEY = ["admin", "promocodes"];

/**
 * –•—É–∫ –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è —Å–ø–∏—Å–∫–∞ –≤—Å–µ—Ö –ø—Ä–æ–º–æ–∫–æ–¥–æ–≤.
 */
export function useAdminPromoCodes() {
    // +++ –ù–ê–ß–ê–õ–û –ò–ó–ú–ï–ù–ï–ù–ò–ô: –ü–æ–ª–Ω–æ—Å—Ç—å—é –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–Ω—ã–π —Ö—É–∫ +++
    return useQuery<PromoCodeListResponse, Error, PromoCodeOut[]>({
        queryKey: PROMO_CODES_QUERY_KEY,
        queryFn: async () => {
            // 1. –£–∫–∞–∑—ã–≤–∞–µ–º, —á—Ç–æ API –≤–µ—Ä–Ω–µ—Ç –æ–±—ä–µ–∫—Ç PromoCodeListResponse
            const response = await api.get<PromoCodeListResponse>("/promocodes/");
            // 2. –í–æ–∑–≤—Ä–∞—â–∞–µ–º –≤–µ—Å—å –æ–±—ä–µ–∫—Ç { items: [...], total: ... }
            return response.data;
        },
        // 3. –° –ø–æ–º–æ—â—å—é –æ–ø—Ü–∏–∏ `select` –∏–∑–≤–ª–µ–∫–∞–µ–º —Ç–æ–ª—å–∫–æ –º–∞—Å—Å–∏–≤ `items`.
        //    –ö–æ–º–ø–æ–Ω–µ–Ω—Ç, –∏—Å–ø–æ–ª—å–∑—É—é—â–∏–π —Ö—É–∫, –ø–æ–ª—É—á–∏—Ç —É–∂–µ –≥–æ—Ç–æ–≤—ã–π –º–∞—Å—Å–∏–≤.
        select: (data) => data.items,
        staleTime: 5 * 60 * 1000, // 5 –º–∏–Ω—É—Ç
    });
    // +++ –ö–û–ù–ï–¶ –ò–ó–ú–ï–ù–ï–ù–ò–ô +++
}

/**
 * –ó–∞–ø—Ä–∞—à–∏–≤–∞–µ—Ç –Ω–æ–≤—ã–π —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –∫–æ–¥ —Å –±—ç–∫–µ–Ω–¥–∞.
 */
export async function fetchGeneratedPromoCode(): Promise<string> {
    try {
        const response = await api.get<{ generated_code: string }>("/promocodes/generate/new-code");
        return response.data.generated_code;
    } catch (error) {
        toast.error("–û—à–∏–±–∫–∞ –ø—Ä–∏ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –∫–æ–¥–∞");
        console.error("Failed to generate promo code:", error);
        return "";
    }
}

/**
 * –•—É–∫ –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –Ω–æ–≤–æ–≥–æ –ø—Ä–æ–º–æ–∫–æ–¥–∞.
 */
export function useCreatePromoCode() {
    const queryClient = useQueryClient();
    return useMutation({
        mutationFn: async (data: PromoCodeCreate) => {
            const response = await api.post<PromoCodeOut>("/promocodes/", data);
            return response.data;
        },
        onSuccess: () => {
            void queryClient.invalidateQueries({ queryKey: PROMO_CODES_QUERY_KEY });
            toast.success("–ü—Ä–æ–º–æ–∫–æ–¥ —É—Å–ø–µ—à–Ω–æ —Å–æ–∑–¥–∞–Ω");
        },
        onError: (error: any) => {
            toast.error(error?.response?.data?.detail || "–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –ø—Ä–æ–º–æ–∫–æ–¥–∞");
        },
    });
}

/**
 * –•—É–∫ –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –ø—Ä–æ–º–æ–∫–æ–¥–∞.
 */
export function useUpdatePromoCode() {
    const queryClient = useQueryClient();
    return useMutation({
        mutationFn: async ({ id, data }: { id: number; data: PromoCodeUpdate }) => {
            const response = await api.put<PromoCodeOut>(`/promocodes/${id}`, data);
            return response.data;
        },
        onSuccess: (updatedPromoCode) => {
            void queryClient.invalidateQueries({ queryKey: PROMO_CODES_QUERY_KEY });
            toast.success(`–ü—Ä–æ–º–æ–∫–æ–¥ "${updatedPromoCode.code}" —É—Å–ø–µ—à–Ω–æ –æ–±–Ω–æ–≤–ª–µ–Ω`);
        },
        onError: (error: any) => {
            toast.error(error?.response?.data?.detail || "–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ –ø—Ä–æ–º–æ–∫–æ–¥–∞");
        },
    });
}

/**
 * –•—É–∫ –¥–ª—è —É–¥–∞–ª–µ–Ω–∏—è –ø—Ä–æ–º–æ–∫–æ–¥–∞.
 */
export function useDeletePromoCode() {
    const queryClient = useQueryClient();
    return useMutation({
        mutationFn: (id: number) => api.delete(`/promocodes/${id}`),
        onSuccess: () => {
            void queryClient.invalidateQueries({ queryKey: PROMO_CODES_QUERY_KEY });
            toast.success("–ü—Ä–æ–º–æ–∫–æ–¥ —É–¥–∞–ª–µ–Ω");
        },
        onError: (error: any) => {
            toast.error(error?.response?.data?.detail || "–û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ –ø—Ä–æ–º–æ–∫–æ–¥–∞");
        },
    });
}

```


## <a name="srchooksuseAdminRentalsts"></a>`src/hooks/useAdminRentals.ts`

```typescript
// path: src/hooks/useAdminRentals.ts

// src/hooks/useAdminRentals.ts

import { useInfiniteQuery, useMutation, useQueryClient, type QueryFunctionContext } from "@tanstack/react-query";
import { toast } from "sonner";
import { api } from "@/lib/api";
// +++ –ò–ó–ú–ï–ù–ï–ù–ò–ï: –ò–º–ø–æ—Ä—Ç–∏—Ä—É–µ–º –æ–±–Ω–æ–≤–ª–µ–Ω–Ω—ã–µ —Ç–∏–ø—ã +++
import type { AdminRentalListResponse, RentalReturnRequest, AdminRentalOut } from "@/types/rental";


export interface AdminRentalsParams {
    status?: "active" | "overdue" | "completed" | null;
    search?: string;
    limit?: number;
}

const ADMIN_RENTALS_QUERY_KEY = ["adminRentals"];
const ADMIN_RESERVATIONS_QUERY_KEY = "adminReservations";

interface ConvertReservationPayload {
    reservationId: number;
    data: {
        notes_on_issue?: string;
        deposit_amount: number;
        force_issue_on_holiday?: boolean;
    };
}

// +++ –ù–ê–ß–ê–õ–û: –û–ë–ù–û–í–õ–ï–ù–ù–´–ô –¢–ò–ü –î–õ–Ø PAYLOAD –í–û–ó–í–†–ê–¢–ê +++
interface ReturnRentalPayload {
    rentalId: number;
    data: RentalReturnRequest;
}
// +++ –ö–û–ù–ï–¶: –û–ë–ù–û–í–õ–ï–ù–ù–û–ì–û –¢–ò–ü–ê +++


export function useAdminRentals(params: AdminRentalsParams = {}) {
    const { limit = 10, ...otherParams } = params;

    return useInfiniteQuery<AdminRentalListResponse, Error>({
        queryKey: [ADMIN_RENTALS_QUERY_KEY, otherParams],
        queryFn: async ({ pageParam = 0 }: QueryFunctionContext) => {
            const skip = (pageParam as number) * limit;
            const response = await api.get<AdminRentalListResponse>("/admin/rentals/", {
                params: { ...otherParams, skip, limit },
            });
            return response.data;
        },
        initialPageParam: 0,
        getNextPageParam: (lastPage, allPages) => {
            const loadedItems = allPages.reduce((acc, page) => acc + page.items.length, 0);
            if (loadedItems < lastPage.total) {
                return allPages.length;
            }
            return undefined;
        },
        staleTime: 60 * 1000,
    });
}

export function useConvertReservationToRental() {
    const queryClient = useQueryClient();
    return useMutation({
        mutationFn: ({ reservationId, data }: ConvertReservationPayload) =>
            api.post(`/admin/rentals/from-reservation/${reservationId}`, data),
        onSuccess: () => {
            toast.success("–†–µ–∑–µ—Ä–≤ —É—Å–ø–µ—à–Ω–æ –∫–æ–Ω–≤–µ—Ä—Ç–∏—Ä–æ–≤–∞–Ω –≤ –∞—Ä–µ–Ω–¥—É!");
            void queryClient.invalidateQueries({ queryKey: [ADMIN_RENTALS_QUERY_KEY] });
            void queryClient.invalidateQueries({ queryKey: [ADMIN_RESERVATIONS_QUERY_KEY] });
        },
        onError: (error: any) => {
            console.error("Conversion error:", error);
            throw error;
        },
    });
}

export function useDeleteAdminRental() {
    const queryClient = useQueryClient();
    return useMutation({
        mutationFn: (rentalId: number) => api.delete(`/admin/rentals/${rentalId}`),
        onSuccess: () => {
            toast.success("–ê—Ä–µ–Ω–¥–∞ —É—Å–ø–µ—à–Ω–æ —É–¥–∞–ª–µ–Ω–∞");
            void queryClient.invalidateQueries({ queryKey: [ADMIN_RENTALS_QUERY_KEY] });
        },
        onError: (error: any) => {
            toast.error(error?.response?.data?.detail || "–û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ –∞—Ä–µ–Ω–¥—ã");
        },
    });
}

export function useReturnRental() {
    const queryClient = useQueryClient();
    return useMutation({
        // +++ –ò–ó–ú–ï–ù–ï–ù–ò–ï: –ú—É—Ç–∞—Ü–∏—è —Ç–µ–ø–µ—Ä—å –ø—Ä–∏–Ω–∏–º–∞–µ—Ç –Ω–æ–≤—ã–π payload +++
        mutationFn: ({ rentalId, data }: ReturnRentalPayload) =>
            api.post(`/admin/rentals/${rentalId}/return`, data),
        onSuccess: (_data, variables) => {
            toast.success("–í–æ–∑–≤—Ä–∞—Ç –∞—Ä–µ–Ω–¥—ã —É—Å–ø–µ—à–Ω–æ –æ—Ñ–æ—Ä–º–ª–µ–Ω!");
            queryClient.setQueryData(
                [ADMIN_RENTALS_QUERY_KEY],
                (oldData: any) => {
                    if (!oldData) return oldData;
                    const newPages = oldData.pages.map((page: AdminRentalListResponse) => ({
                        ...page,
                        items: page.items.filter((rental: AdminRentalOut) => rental.id !== variables.rentalId),
                        total: page.total - 1
                    }));
                    return { ...oldData, pages: newPages };
                }
            );
            void queryClient.invalidateQueries({ queryKey: [ADMIN_RENTALS_QUERY_KEY] });
            void queryClient.invalidateQueries({ queryKey: ["availability"] });
            void queryClient.invalidateQueries({ queryKey: ["calendar-grid"] });
        },
        onError: (error: any) => {
            toast.error(error?.response?.data?.detail || "–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ñ–æ—Ä–º–ª–µ–Ω–∏–∏ –≤–æ–∑–≤—Ä–∞—Ç–∞");
        },
    });
}

export function useRevertRentalToReservation() {
    const queryClient = useQueryClient();
    return useMutation({
        mutationFn: (rentalId: number) =>
            api.post(`/admin/rentals/${rentalId}/revert-to-reservation`),
        onSuccess: () => {
            toast.success("–í—ã–¥–∞—á–∞ –∞—Ä–µ–Ω–¥—ã —É—Å–ø–µ—à–Ω–æ –æ—Ç–º–µ–Ω–µ–Ω–∞!");
            void queryClient.invalidateQueries({ queryKey: [ADMIN_RENTALS_QUERY_KEY] });
            void queryClient.invalidateQueries({ queryKey: [ADMIN_RESERVATIONS_QUERY_KEY] });
        },
        onError: (error: any) => {
            const errorMessage = error?.response?.data?.detail || "–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–º–µ–Ω–µ –≤—ã–¥–∞—á–∏ –∞—Ä–µ–Ω–¥—ã";
            toast.error(errorMessage);
        },
    });
}

```


## <a name="srchooksuseAdminReservationsts"></a>`src/hooks/useAdminReservations.ts`

```typescript
// path: src/hooks/useAdminReservations.ts

// src/hooks/useAdminReservations.ts

import { useInfiniteQuery, useMutation, useQueryClient, type QueryFunctionContext } from "@tanstack/react-query";
import { toast } from "sonner";
import { api } from "@/lib/api";
import type { AdminReservationListResponse } from "@/types/reservation";
import { transformAccessoryLinks } from "@/lib/utils";

export interface AdminReservationsParams {
    status?: "active" | "completed" | "fulfilled" | "cancelled" | "overdue" | null;
    search?: string;
    limit?: number;
}

const ADMIN_RESERVATIONS_QUERY_KEY = ["adminReservations"];

export function useAdminReservations(params: AdminReservationsParams = {}) {
    const { limit = 10, ...otherParams } = params;

    return useInfiniteQuery<AdminReservationListResponse, Error>({
        queryKey: [ADMIN_RESERVATIONS_QUERY_KEY, otherParams],
        queryFn: async ({ pageParam = 0 }: QueryFunctionContext) => {
            const skip = (pageParam as number) * limit;
            const response = await api.get<AdminReservationListResponse>("/admin/reservations/", {
                params: { ...otherParams, skip, limit },
            });
            return response.data;
        },
        initialPageParam: 0,
        getNextPageParam: (lastPage, allPages) => {
            const loadedItems = allPages.reduce((acc, page) => acc + page.items.length, 0);
            if (loadedItems < lastPage.total) {
                return allPages.length;
            }
            return undefined;
        },
        staleTime: 60 * 1000,
        select: (data) => ({
            ...data,
            pages: data.pages.map(page => ({
                ...page,
                items: page.items.map(transformAccessoryLinks)
            }))
        }),
    });
}

export function useCreateAdminReservation() {
    const queryClient = useQueryClient();
    return useMutation({
        mutationFn: (data: any) => api.post("/admin/reservations/", data),
        onSuccess: () => {
            toast.success("–†–µ–∑–µ—Ä–≤ —É—Å–ø–µ—à–Ω–æ —Å–æ–∑–¥–∞–Ω");
            void queryClient.invalidateQueries({ queryKey: [ADMIN_RESERVATIONS_QUERY_KEY] });
        },
        onError: (error: any) => {
            toast.error(error?.response?.data?.detail || "–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ —Ä–µ–∑–µ—Ä–≤–∞");
        },
    });
}

export function useDeleteAdminReservation() {
    const queryClient = useQueryClient();
    return useMutation({
        mutationFn: (reservationId: number) => api.delete(`/admin/reservations/${reservationId}`),
        onSuccess: () => {
            toast.success("–†–µ–∑–µ—Ä–≤ —É—Å–ø–µ—à–Ω–æ —É–¥–∞–ª–µ–Ω");
            void queryClient.invalidateQueries({ queryKey: [ADMIN_RESERVATIONS_QUERY_KEY] });
        },
        onError: (error: any) => {
            toast.error(error?.response?.data?.detail || "–û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ —Ä–µ–∑–µ—Ä–≤–∞");
        },
    });
}

export function useBulkDeleteAdminReservations() {
    const queryClient = useQueryClient();
    return useMutation({
        mutationFn: (reservationIds: number[]) => {
            const payload = { reservation_ids: reservationIds };

            // --- –ò–ó–ú–ï–ù–ï–ù–ò–ï: –ü–û–õ–ù–û–°–¢–¨–Æ –ú–ï–ù–Ø–ï–ú –ü–£–¢–¨ ---
            return api.post(`/admin/reservations/delete-many`, payload);
        },
        onSuccess: () => {
            toast.success("–í—ã–±—Ä–∞–Ω–Ω—ã–µ —Ä–µ–∑–µ—Ä–≤—ã —É—Å–ø–µ—à–Ω–æ —É–¥–∞–ª–µ–Ω—ã");
            void queryClient.invalidateQueries({ queryKey: [ADMIN_RESERVATIONS_QUERY_KEY] });
        },
        onError: (error: any) => {
            toast.error(error?.response?.data?.detail || "–û—à–∏–±–∫–∞ –ø—Ä–∏ –º–∞—Å—Å–æ–≤–æ–º —É–¥–∞–ª–µ–Ω–∏–∏ —Ä–µ–∑–µ—Ä–≤–æ–≤");
        },
    });
}

```


## <a name="srchooksuseAdminUsersts"></a>`src/hooks/useAdminUsers.ts`

```typescript
// path: src/hooks/useAdminUsers.ts

// src/hooks/useAdminUsers.ts

import { useQuery, useInfiniteQuery, useMutation, useQueryClient } from "@tanstack/react-query";
import { UserService } from "@/core/services";
import { toast } from "sonner";
import type { UserListResponse, UserRole, UserPaymentRequest } from "@/types/user";
import type { AdminUserCreateFormSchema, AdminUserUpdateSchema } from "@/lib/validationSchemas";

// –¢–∏–ø –¥–ª—è –¥–∞–Ω–Ω—ã—Ö, –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º—ã—Ö –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏
type AdminUserUpdatePayload = {
    userId: number;
    data: AdminUserUpdateSchema;
};

// –°–æ–∑–¥–∞–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (—Ç–æ–ª—å–∫–æ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä)
export function useAdminCreateUser() {
    const queryClient = useQueryClient();
    return useMutation({
        mutationFn: async (userData: AdminUserCreateFormSchema) => {
            return await UserService.createUser(userData);
        },
        onSuccess: () => {
            void queryClient.invalidateQueries({ queryKey: ["admin", "users"] });
            toast.success("–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —É—Å–ø–µ—à–Ω–æ —Å–æ–∑–¥–∞–Ω");
        },
        onError: (error: unknown) => {
            const apiError = error as { response?: { data?: { detail?: string } } }
            toast.error(apiError?.response?.data?.detail || "–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è");
        },
    });
}

// –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (–∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä/–º–µ–Ω–µ–¥–∂–µ—Ä)
export function useAdminUpdateUser() {
    const queryClient = useQueryClient();
    return useMutation({
        mutationFn: async ({ userId, data }: AdminUserUpdatePayload) => {
            return await UserService.updateUser({ id: userId, ...data });
        },
        onSuccess: (updatedUser) => {
            void queryClient.invalidateQueries({ queryKey: ["admin", "users"] });
            toast.success(`–ü—Ä–æ—Ñ–∏–ª—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è ${updatedUser.full_name} —É—Å–ø–µ—à–Ω–æ –æ–±–Ω–æ–≤–ª–µ–Ω.`);
        },
        onError: (error: unknown) => {
            const apiError = error as { response?: { data?: { detail?: string } } }
            toast.error(apiError?.response?.data?.detail || "–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ –ø—Ä–æ—Ñ–∏–ª—è.");
        }
    });
}

// –ü–æ–ª—É—á–µ–Ω–∏–µ –≤—Å–µ—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π —Å –ø–∞–≥–∏–Ω–∞—Ü–∏–µ–π (–¥–ª—è –º–µ–Ω–µ–¥–∂–µ—Ä–æ–≤ –∏ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–≤)
export function useAdminUsers() {
    return useInfiniteQuery<UserListResponse>({
        queryKey: ["admin", "users"],
        queryFn: async ({ pageParam = 0 }) => {
            const skip = (pageParam as number) * 15; // 15 –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—É
            return await UserService.getAllUsers(skip, 15);
        },
        initialPageParam: 0,
        getNextPageParam: (lastPage, allPages) => {
            const totalLoaded = allPages.reduce((acc, page) => acc + page.items.length, 0);
            return totalLoaded < lastPage.total ? allPages.length : undefined;
        },
        staleTime: 5 * 60 * 1000, // 5 –º–∏–Ω—É—Ç
    });
}

// –ò–∑–º–µ–Ω–µ–Ω–∏–µ —Ä–æ–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (—Ç–æ–ª—å–∫–æ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä)
export function useUpdateUserRole() {
    const queryClient = useQueryClient();
    return useMutation({
        // –ò–ó–ú–ï–ù–ï–ù–ò–ï: –£–∫–∞–∑—ã–≤–∞–µ–º –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–π —Ç–∏–ø UserRole –≤–º–µ—Å—Ç–æ string
        mutationFn: async ({ userId, newRole }: { userId: number; newRole: UserRole }) => {
            return await UserService.updateUserRole(userId, newRole);
        },
        onSuccess: () => {
            void queryClient.invalidateQueries({ queryKey: ["admin", "users"] });
            toast.success("–†–æ–ª—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è —É—Å–ø–µ—à–Ω–æ –∏–∑–º–µ–Ω–µ–Ω–∞");
        },
        onError: (error: unknown) => {
            const apiError = error as { response?: { data?: { detail?: string } } }
            toast.error(apiError?.response?.data?.detail || "–û—à–∏–±–∫–∞ –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ —Ä–æ–ª–∏");
        },
    });
}

// –ë–ª–æ–∫–∏—Ä–æ–≤–∫–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (—Ç–æ–ª—å–∫–æ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä)
export function useBlockUser() {
    const queryClient = useQueryClient();
    return useMutation({
        mutationFn: async (userId: number) => {
            return await UserService.toggleUserStatus(userId, false);
        },
        onSuccess: () => {
            void queryClient.invalidateQueries({ queryKey: ["admin", "users"] });
            toast.success("–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω");
        },
        onError: (error: unknown) => {
            const apiError = error as { response?: { data?: { detail?: string } } }
            toast.error(apiError?.response?.data?.detail || "–û—à–∏–±–∫–∞ –ø—Ä–∏ –±–ª–æ–∫–∏—Ä–æ–≤–∫–µ");
        },
    });
}

// –†–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∫–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (—Ç–æ–ª—å–∫–æ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä)
export function useUnblockUser() {
    const queryClient = useQueryClient();
    return useMutation({
        mutationFn: async (userId: number) => {
            return await UserService.toggleUserStatus(userId, true);
        },
        onSuccess: () => {
            void queryClient.invalidateQueries({ queryKey: ["admin", "users"] });
            toast.success("–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Ä–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω");
        },
        onError: (error: unknown) => {
            const apiError = error as { response?: { data?: { detail?: string } } }
            toast.error(apiError?.response?.data?.detail || "–û—à–∏–±–∫–∞ –ø—Ä–∏ —Ä–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∫–µ");
        },
    });
}

// –£–¥–∞–ª–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (—Ç–æ–ª—å–∫–æ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä)
export function useDeleteUser() {
    const queryClient = useQueryClient();
    return useMutation({
        mutationFn: async (userId: number) => {
            await UserService.deleteUser(userId);
        },
        onSuccess: () => {
            void queryClient.invalidateQueries({ queryKey: ["admin", "users"] });
            toast.success("–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∏ —Å–≤—è–∑–∞–Ω–Ω—ã–π –∫–ª–∏–µ–Ω—Ç —É–¥–∞–ª–µ–Ω—ã");
        },
        onError: (error: unknown) => {
            const apiError = error as { response?: { data?: { detail?: string } } }
            toast.error(apiError?.response?.data?.detail || "–û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏");
        },
    });
}

/**
 * –•—É–∫ –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –ø–ª–∞—Ç–µ–∂–∞ –∏ –ø–æ–ø–æ–ª–Ω–µ–Ω–∏—è –±–∞–ª–∞–Ω—Å–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è.
 */
export function useAddUserPayment() {
    const queryClient = useQueryClient();
    return useMutation({
        mutationFn: async ({ userId, data }: { userId: number; data: UserPaymentRequest }) => {
            return await UserService.addUserPayment(userId, data);
        },
        onSuccess: (updatedUser) => {
            void queryClient.invalidateQueries({ queryKey: ["admin", "users"] });
            // –ú–æ–∂–Ω–æ —Ç–∞–∫–∂–µ —Ç–æ—á–µ—á–Ω–æ –æ–±–Ω–æ–≤–∏—Ç—å –∫—ç—à –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è, –µ—Å–ª–∏ –æ–Ω –≥–¥–µ-—Ç–æ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è
            toast.success(`–ë–∞–ª–∞–Ω—Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è ${updatedUser.full_name} —É—Å–ø–µ—à–Ω–æ –ø–æ–ø–æ–ª–Ω–µ–Ω.`);
        },
        onError: (error: unknown) => {
            const apiError = error as { response?: { data?: { detail?: string } } };
            toast.error(apiError?.response?.data?.detail || "–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–ø–æ–ª–Ω–µ–Ω–∏–∏ –±–∞–ª–∞–Ω—Å–∞.");
        },
    });
}

```


## <a name="srchooksuseAllEquipmentts"></a>`src/hooks/useAllEquipment.ts`

```typescript
// path: src/hooks/useAllEquipment.ts

// src/hooks/useAllEquipment.ts

import { useQuery } from "@tanstack/react-query";
import { EquipmentService } from "@/core/services";
import { handleQueryError } from "@/lib/queryHelpers";

// –≠—Ç–æ—Ç —Ö—É–∫ –±—É–¥–µ—Ç –∑–∞–≥—Ä—É–∂–∞—Ç—å –í–°–ï –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏–µ –¥–ª—è —Ñ–æ—Ä–º –∏ –≤—ã–ø–∞–¥–∞—é—â–∏—Ö —Å–ø–∏—Å–∫–æ–≤
export function useAllEquipment() {
    return useQuery({
        queryKey: ["allEquipment"], // –£–Ω–∏–∫–∞–ª—å–Ω—ã–π –∫–ª—é—á
        queryFn: async () => {
            try {
                // –ó–∞–ø—Ä–∞—à–∏–≤–∞–µ–º –±–æ–ª—å—à–æ–π –ª–∏–º–∏—Ç, —á—Ç–æ–±—ã –ø–æ–ª—É—á–∏—Ç—å –≤—Å–µ –∑–∞–ø–∏—Å–∏
                const response = await EquipmentService.getAllEquipment(0, 1000);
                return response.items; // –í–æ–∑–≤—Ä–∞—â–∞–µ–º —Ç–æ–ª—å–∫–æ –º–∞—Å—Å–∏–≤
            } catch (error) {
                handleQueryError(error);
                throw error;
            }
        },
        staleTime: 60 * 60 * 1000, // –ö—ç—à–∏—Ä—É–µ–º –Ω–∞ —á–∞—Å
    });
}

```


## <a name="srchooksuseAssociationsts"></a>`src/hooks/useAssociations.ts`

```typescript
// path: src/hooks/useAssociations.ts

// src/hooks/useAssociations.ts

import { useQuery } from "@tanstack/react-query";
import { api } from "@/lib/api";
import type { Association, AssociationListResponse } from "@/types/association"; // –ò–º–ø–æ—Ä—Ç–∏—Ä—É–µ–º –æ–±–∞ —Ç–∏–ø–∞

const ASSOCIATIONS_QUERY_KEY = ["associations"];

export function useAssociations() {
    // –ò–ó–ú–ï–ù–ï–ù–ò–ï: –•—É–∫ —Ç–µ–ø–µ—Ä—å –æ–∂–∏–¥–∞–µ—Ç Association[] –∫–∞–∫ –∫–æ–Ω–µ—á–Ω—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç –¥–ª—è –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–∞
    return useQuery<Association[]>({
        queryKey: ASSOCIATIONS_QUERY_KEY,
        queryFn: async () => {
            // –ó–∞–ø—Ä–∞—à–∏–≤–∞–µ–º —É API –æ–±—ä–µ–∫—Ç AssociationListResponse
            const response = await api.get<AssociationListResponse>("/associations/");
            // –ê –≤–æ–∑–≤—Ä–∞—â–∞–µ–º —Ç–æ–ª—å–∫–æ –º–∞—Å—Å–∏–≤ `items`
            return response.data.items;
        },
        staleTime: 5 * 60 * 1000, // 5 –º–∏–Ω—É—Ç
    });
}

```


## <a name="srchooksuseAvailabilityCheckts"></a>`src/hooks/useAvailabilityCheck.ts`

```typescript
// path: src/hooks/useAvailabilityCheck.ts

// src/hooks/useAvailabilityCheck.ts

import { useQuery } from "@tanstack/react-query";
import { useMemo } from "react";
import { AvailabilityService } from "@/core/services";
import type { AvailabilityInfo } from "@/types/availability";
import { handleQueryError } from "@/lib/queryHelpers";

export interface UseAvailabilityCheckProps {
    equipmentIds: number[];
    startDate: Date;
    endDate: Date;
    excludeReservationId?: number;
    enabled?: boolean;
}

export interface UseAvailabilityCheckReturn {
    isLoading: boolean;
    isError: boolean;
    availabilityMap: Record<number, AvailabilityInfo>;
    conflictingItemIds: number[];
    hasConflicts: boolean;
    error: Error | null;
}

/**
 * –¶–µ–Ω—Ç—Ä–∞–ª—å–Ω—ã–π —Ö—É–∫ –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏ –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—è.
 * –ò—Å–ø–æ–ª—å–∑—É–µ—Ç useQuery –∏–∑ @tanstack/react-query –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –∏ –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö –æ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏.
 * 
 * @param props - –ü–∞—Ä–∞–º–µ—Ç—Ä—ã –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏
 * @returns –û–±—ä–µ–∫—Ç —Å –¥–∞–Ω–Ω—ã–º–∏ –æ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏ –∏ —Å—Ç–∞—Ç—É—Å–æ–º –∑–∞–≥—Ä—É–∑–∫–∏
 */
export function useAvailabilityCheck({
    equipmentIds,
    startDate,
    endDate,
    excludeReservationId,
    enabled = true
}: UseAvailabilityCheckProps): UseAvailabilityCheckReturn {
    
    // –§–æ—Ä–º–∏—Ä—É–µ–º —É–Ω–∏–∫–∞–ª—å–Ω—ã–π queryKey –Ω–∞ –æ—Å–Ω–æ–≤–µ –≤—Ö–æ–¥–Ω—ã—Ö –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤
    const queryKey = useMemo(() => {
        const stringifiedIds = JSON.stringify([...equipmentIds].sort((a, b) => a - b));
        return [
            "availability-check",
            stringifiedIds,
            startDate.toISOString(),
            endDate.toISOString(),
            excludeReservationId
        ] as const;
    }, [equipmentIds, startDate, endDate, excludeReservationId]);

    // –ü—Ä–æ–≤–µ—Ä—è–µ–º –≤–∞–ª–∏–¥–Ω–æ—Å—Ç—å –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤
    const isParamsValid = useMemo(() => {
        return !!(
            equipmentIds.length > 0 &&
            startDate && !isNaN(startDate.getTime()) &&
            endDate && !isNaN(endDate.getTime()) &&
            startDate <= endDate
        );
    }, [equipmentIds, startDate, endDate]);

    const query = useQuery({
        queryKey,
        queryFn: async (): Promise<AvailabilityInfo[]> => {
            if (!isParamsValid) return [];
            
            try {
                return await AvailabilityService.getStatuses({
                    equipmentIds,
                    startDate,
                    endDate,
                    excludeReservationId
                });
            } catch (error: unknown) {
                console.error("[useAvailabilityCheck] Error fetching availability:", error);
                handleQueryError(error);
                throw error;
            }
        },
        enabled: enabled && isParamsValid,
        staleTime: 30 * 1000, // 30 —Å–µ–∫—É–Ω–¥
        gcTime: 5 * 60 * 1000, // 5 –º–∏–Ω—É—Ç
    });

    // –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –¥–∞–Ω–Ω—ã–µ –∏ —Å–æ–∑–¥–∞–µ–º –∫–∞—Ä—Ç—É –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏
    const processedData = useMemo(() => {
        const availabilityData = query.data || [];
        
        // –°–æ–∑–¥–∞–µ–º –∫–∞—Ä—Ç—É –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏ –¥–ª—è –±—ã—Å—Ç—Ä–æ–≥–æ –¥–æ—Å—Ç—É–ø–∞
        const availabilityMap: Record<number, AvailabilityInfo> = {};
        availabilityData.forEach((info) => {
            availabilityMap[info.equipment_id] = info;
        });

        // –ù–∞—Ö–æ–¥–∏–º ID –≤—Å–µ—Ö –∫–æ–Ω—Ñ–ª–∏–∫—Ç–Ω—ã—Ö –ø–æ–∑–∏—Ü–∏–π
        const conflictingItemIds = availabilityData
            .filter(info => info.status === "reserved" || info.status === "rented")
            .map(info => info.equipment_id);

        return {
            availabilityMap,
            conflictingItemIds,
            hasConflicts: conflictingItemIds.length > 0
        };
    }, [query.data]);

    return {
        isLoading: query.isLoading,
        isError: query.isError,
        availabilityMap: processedData.availabilityMap,
        conflictingItemIds: processedData.conflictingItemIds,
        hasConflicts: processedData.hasConflicts,
        error: query.error
    };
}


```


## <a name="srchooksuseBalanceHistoryts"></a>`src/hooks/useBalanceHistory.ts`

```typescript
// path: src/hooks/useBalanceHistory.ts

// src/hooks/useBalanceHistory.ts

import { useQuery } from "@tanstack/react-query";
import { UserService } from "@/core/services";
import type { BalanceHistoryListResponse } from "@/types/balanceHistory";
import { useCurrentUser } from "./useProfile";

const PAGE_SIZE = 15;

/**
 * –•—É–∫ –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –ø–∞–≥–∏–Ω–∏—Ä–æ–≤–∞–Ω–Ω–æ–π –∏—Å—Ç–æ—Ä–∏–∏ –±–∞–ª–∞–Ω—Å–∞ –¢–ï–ö–£–©–ï–ì–û –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è.
 */
export function useBalanceHistory(page: number) {
    const { data: user } = useCurrentUser();

    return useQuery<BalanceHistoryListResponse>({
        queryKey: ["balanceHistory", "me", page],
        queryFn: async () => {
            const skip = (page - 1) * PAGE_SIZE;
            return await UserService.getMyBalanceHistory(skip, PAGE_SIZE);
        },
        enabled: !!user, // –í—ã–ø–æ–ª–Ω—è—Ç—å –∑–∞–ø—Ä–æ—Å —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω
        staleTime: 60 * 1000, // 1 –º–∏–Ω—É—Ç–∞
    });
}

/**
 * –•—É–∫ –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –ø–∞–≥–∏–Ω–∏—Ä–æ–≤–∞–Ω–Ω–æ–π –∏—Å—Ç–æ—Ä–∏–∏ –±–∞–ª–∞–Ω—Å–∞ –õ–Æ–ë–û–ì–û –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (–¥–ª—è –∞–¥–º–∏–Ω–æ–≤).
 */
export function useAdminBalanceHistory(userId: number, page: number) {
    const { data: currentUser } = useCurrentUser();
    const isManager = currentUser?.role === 'admin' || currentUser?.role === 'manager';

    return useQuery<BalanceHistoryListResponse>({
        queryKey: ["balanceHistory", "admin", userId, page],
        queryFn: async () => {
            const skip = (page - 1) * PAGE_SIZE;
            return await UserService.getUserBalanceHistory(userId, skip, PAGE_SIZE);
        },
        enabled: isManager && !!userId, // –í—ã–ø–æ–ª–Ω—è—Ç—å –∑–∞–ø—Ä–æ—Å —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ —Ç–µ–∫—É—â–∏–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å - –∞–¥–º–∏–Ω/–º–µ–Ω–µ–¥–∂–µ—Ä
        staleTime: 60 * 1000,
    });
}

```


## <a name="srchooksuseCalendarGridts"></a>`src/hooks/useCalendarGrid.ts`

```typescript
// path: src/hooks/useCalendarGrid.ts

// src/hooks/useCalendarGrid.ts

import { useQuery } from "@tanstack/react-query"
import { useDateStore } from "@/store/dateStore"
import { useFilterStore } from "@/store/filterStore"
import { useSearchStore } from "@/store/searchStore"
import { useEquipment } from "./useEquipment"
import { formatDate } from "@/lib/utils"
import { CalendarService } from "@/core/services"
import type { CalendarGridData } from "@/core/services"
import { useMemo } from "react" // <-- –î–æ–±–∞–≤–ª—è–µ–º –∏–º–ø–æ—Ä—Ç useMemo

export function useCalendarGrid() {
    const { startDate, endDate } = useDateStore()
    const { type, brand } = useFilterStore()
    const { query } = useSearchStore()
    // –ò–ó–ú–ï–ù–ï–ù–ò–ï: useEquipment –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –æ–±—ä–µ–∫—Ç —Å–æ —Å—Ç—Ä–∞–Ω–∏—Ü–∞–º–∏, –∞ –Ω–µ –ø—Ä–æ—Å—Ç–æ –¥–∞–Ω–Ω—ã–µ
    const { data: equipmentPages, isLoading: isLoadingEquipment } = useEquipment()

    // –ò–ó–ú–ï–ù–ï–ù–ò–ï: "–†–∞–∑–≤–æ—Ä–∞—á–∏–≤–∞–µ–º" –≤—Å–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã –≤ –æ–¥–∏–Ω –ø–ª–æ—Å–∫–∏–π –º–∞—Å—Å–∏–≤
    const allEquipment = useMemo(() =>
            equipmentPages?.pages.flatMap(page => page.items) ?? [],
        [equipmentPages]);

    // –¢–µ–ø–µ—Ä—å —Ñ–∏–ª—å—Ç—Ä—É–µ–º –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π –º–∞—Å—Å–∏–≤ allEquipment
    const filteredIds = CalendarService.filterEquipmentForCalendar(
        allEquipment,
        {
            type: type || undefined,
            brand: brand || undefined,
            query: query || undefined
        }
    )

    const formattedStartDateAPI = startDate ? formatDate(startDate) : null
    const formattedEndDateAPI = endDate ? formatDate(endDate) : null

    const enabled =
        !!formattedStartDateAPI &&
        !!formattedEndDateAPI &&
        !isLoadingEquipment &&
        filteredIds.length > 0

    const queryKey = CalendarService.createQueryKey(
        formattedStartDateAPI!,
        formattedEndDateAPI!,
        filteredIds
    )

    return useQuery<CalendarGridData>({
        queryKey: queryKey,
        queryFn: async () => {
            if (!formattedStartDateAPI || !formattedEndDateAPI) {
                return {}
            }
            if (filteredIds.length === 0) {
                return {}
            }

            return CalendarService.getDayStatuses(
                formattedStartDateAPI,
                formattedEndDateAPI,
                filteredIds
            )
        },
        enabled,
        staleTime: 60 * 1000,
        placeholderData: (previousData) => previousData,
    })
}

```


## <a name="srchooksuseDailyAvailabilityts"></a>`src/hooks/useDailyAvailability.ts`

```typescript
// path: src/hooks/useDailyAvailability.ts

// src/hooks/useDailyAvailability.ts
import { useQuery } from "@tanstack/react-query";
import { api } from "@/lib/api";
import { formatDate } from "@/lib/utils";
import type { DayStatus } from "@/types/availability";

type DailyAvailabilityData = Record<number, Record<string, DayStatus>>; // { equipmentId: { "DD.MM.YYYY": DayStatus } }

type Params = {
    ids: number[];
    start: Date;
    end: Date;
};

export function useDailyAvailability({ ids, start, end }: Params) {
    const formattedStartDate = formatDate(start);
    const formattedEndDate = formatDate(end);

    // Sort IDs to ensure consistent query key
    const sortedIds = JSON.stringify([...ids].sort((a, b) => a - b));

    return useQuery<DailyAvailabilityData>({
        queryKey: ["daily-availability", sortedIds, formattedStartDate, formattedEndDate],
        queryFn: async () => {
            const resp = await api.get("/calendar/day-statuses", {
                params: {
                    start: formattedStartDate,
                    end: formattedEndDate,
                    ids,
                },
            });
            // The actual data is nested inside equipment_day_statuses
            const result = resp.data?.equipment_day_statuses ?? {};
            

            
            return result;
        },
        enabled: ids.length > 0 && !!start && !!end,
        staleTime: 5 * 60 * 1000, // 5 mins
    });
}

```


## <a name="srchooksuseDateRangets"></a>`src/hooks/useDateRange.ts`

```typescript
// path: src/hooks/useDateRange.ts

// src/hooks/useDateRange.ts

import { useState, useEffect } from 'react';
import { formatDate } from '@/lib/utils';
import { DateService } from '@/core/services';

interface UseDateRangeProps {
    startDate: Date;
    endDate: Date;
    onRangeChange: (startDate: Date, endDate: Date, source?: 'calendar' | 'slider' | 'manual', holidays?: Date[]) => void;
    holidays?: Date[];
}

interface UseDateRangeReturn {
    localStartDate: string;
    localEndDate: string;
    handleStartDateChange: (e: React.ChangeEvent<HTMLInputElement>) => void;
    handleEndDateChange: (e: React.ChangeEvent<HTMLInputElement>) => void;
}

export function useDateRange({
                                 startDate,
                                 endDate,
                                 onRangeChange,
                                 holidays = [] // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∑–Ω–∞—á–µ–Ω–∏–µ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
                             }: UseDateRangeProps): UseDateRangeReturn {
    // –õ–æ–∫–∞–ª—å–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ –¥–ª—è input'–æ–≤ –≤—Å–µ–≥–¥–∞ –≤ —Ñ–æ—Ä–º–∞—Ç–µ 'YYYY-MM-DD'
    const [localStartDate, setLocalStartDate] = useState<string>(formatDate(startDate));
    const [localEndDate, setLocalEndDate] = useState<string>(formatDate(endDate));

    // –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä—É–µ–º –ª–æ–∫–∞–ª—å–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ, –µ—Å–ª–∏ –ø—Ä–æ–ø—Å—ã –∏–∑–º–µ–Ω–∏–ª–∏—Å—å –∏–∑–≤–Ω–µ
    useEffect(() => {
        setLocalStartDate(formatDate(startDate));
        setLocalEndDate(formatDate(endDate));
    }, [startDate, endDate]);

    const handleStartDateChange = (e: React.ChangeEvent<HTMLInputElement>) => {
        const newStartDate = new Date(e.target.value);
        if (DateService.isValidDate(newStartDate)) {
            // –ï—Å–ª–∏ –¥–∞—Ç–∞ –æ–∫–æ–Ω—á–∞–Ω–∏—è –æ–∫–∞–∑–∞–ª–∞—Å—å —Ä–∞–Ω—å—à–µ –Ω–æ–≤–æ–π –¥–∞—Ç—ã –Ω–∞—á–∞–ª–∞, –∫–æ—Ä—Ä–µ–∫—Ç–∏—Ä—É–µ–º –µ–µ
            const adjustedRange = DateService.adjustDateRange(newStartDate, endDate);
            // –í—ã–∑—ã–≤–∞–µ–º –∫–æ–ª–±—ç–∫ —Å –æ–±—ä–µ–∫—Ç–∞–º–∏ Date –∏ –ø–µ—Ä–µ–¥–∞–µ–º holidays
            onRangeChange(adjustedRange.startDate, adjustedRange.endDate, 'manual', holidays);
        }
    };

    const handleEndDateChange = (e: React.ChangeEvent<HTMLInputElement>) => {
        const newEndDate = new Date(e.target.value);
        if (DateService.isValidDate(newEndDate)) {
            // –ï—Å–ª–∏ –¥–∞—Ç–∞ –æ–∫–æ–Ω—á–∞–Ω–∏—è –æ–∫–∞–∑–∞–ª–∞—Å—å —Ä–∞–Ω—å—à–µ –¥–∞—Ç—ã –Ω–∞—á–∞–ª–∞, –∫–æ—Ä—Ä–µ–∫—Ç–∏—Ä—É–µ–º –µ–µ
            const adjustedRange = DateService.adjustDateRange(startDate, newEndDate);
            // –í—ã–∑—ã–≤–∞–µ–º –∫–æ–ª–±—ç–∫ —Å –æ–±—ä–µ–∫—Ç–∞–º–∏ Date –∏ –ø–µ—Ä–µ–¥–∞–µ–º holidays
            onRangeChange(adjustedRange.startDate, adjustedRange.endDate, 'manual', holidays);
        }
    };

    return {
        localStartDate,
        localEndDate,
        handleStartDateChange,
        handleEndDateChange,
    };
}

```


## <a name="srchooksuseEditReservationts"></a>`src/hooks/useEditReservation.ts`

```typescript
// path: src/hooks/useEditReservation.ts

// src/hooks/useEditReservation.ts
import { useMutation, useQueryClient } from "@tanstack/react-query";
import { ReservationService } from "@/core/services";

interface EditReservationInput {
    id: number;
    start_date: string;
    end_date: string;
    equipment_ids: number[];
    promo_code?: string;
    selected_accessories?: Record<number, number[]>;
    isAdminContext?: boolean;
    // ‚ú® –ù–û–í–´–ô –§–õ–ê–ì
    confirm_date_adjustment?: boolean;
}

export function useEditReservation() {
    const queryClient = useQueryClient();

    return useMutation({
        mutationFn: async (data: EditReservationInput) => {
            console.log(`[useEditReservation] –û—Ç–ø—Ä–∞–≤–∫–∞ –∑–∞–ø—Ä–æ—Å–∞ –Ω–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Ä–µ–∑–µ—Ä–≤–∞ ${data.id}`);
            console.log(`[useEditReservation] –î–∞–Ω–Ω—ã–µ:`, data);

            const { id, isAdminContext, ...payload } = data;
            
            // –ü—Ä–µ–æ–±—Ä–∞–∑—É–µ–º –¥–∞–Ω–Ω—ã–µ –≤ —Ñ–æ—Ä–º–∞—Ç, –æ–∂–∏–¥–∞–µ–º—ã–π —Å–µ—Ä–≤–∏—Å–æ–º
            const servicePayload = {
                id,
                start_date: payload.start_date,
                end_date: payload.end_date,
                equipment_ids: payload.equipment_ids,
                selected_accessories: payload.selected_accessories || {},
                promo_code: payload.promo_code,
                isAdminContext
            };

            console.log(`[useEditReservation] –û—Ç–ø—Ä–∞–≤–∫–∞ –∑–∞–ø—Ä–æ—Å–∞ —á–µ—Ä–µ–∑ —Å–µ—Ä–≤–∏—Å`);

            const response = await ReservationService.updateReservation(servicePayload);

            console.log(`[useEditReservation] –û—Ç–≤–µ—Ç —Å–µ—Ä–≤–µ—Ä–∞:`, response);
            return response;
        },
        onSuccess: async (_data, variables) => {
            console.log(`[useEditReservation] –£—Å–ø–µ—à–Ω–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Ä–µ–∑–µ—Ä–≤–∞ ${variables.id}`);
            if (variables.isAdminContext) {
                await queryClient.invalidateQueries({ queryKey: ["adminReservations"] });
            }
            await queryClient.invalidateQueries({ queryKey: ["reservations"] });
            await queryClient.invalidateQueries({ queryKey: ["availability"] });
            await queryClient.invalidateQueries({ queryKey: ["calendar-grid"] });
        },
        onError: (error: unknown, variables) => {
            console.error(`[useEditReservation] –û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ —Ä–µ–∑–µ—Ä–≤–∞ ${variables.id}:`, error);
        },
    });
}

```


## <a name="srchooksuseEquipmentts"></a>`src/hooks/useEquipment.ts`

```typescript
// path: src/hooks/useEquipment.ts

// src/hooks/useEquipment.ts

import { useInfiniteQuery, type QueryFunctionContext } from "@tanstack/react-query";
import { EquipmentService, type EquipmentListResponse, type EquipmentFilterParams } from "@/core/services/EquipmentService";
import { handleQueryError } from "@/lib/queryHelpers";
import { PAGINATION_CONSTANTS } from "@/constants/paginationConstants";
import { formatDate } from "@/lib/utils";

export function useEquipment(filters: EquipmentFilterParams = {}) {
    // –î–µ—Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä—É–µ–º –≤—Å–µ –≤–æ–∑–º–æ–∂–Ω—ã–µ —Ñ–∏–ª—å—Ç—Ä—ã
    const { query, type, brand, associationId, availableOnly, startDate, endDate } = filters;

    return useInfiniteQuery<EquipmentListResponse, Error>({
        // –î–æ–±–∞–≤–ª—è–µ–º –Ω–æ–≤—ã–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –≤ –∫–ª—é—á –∑–∞–ø—Ä–æ—Å–∞ –¥–ª—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–≥–æ –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏—è
        queryKey: ["equipment", {
            query,
            type,
            brand,
            associationId,
            availableOnly,
            // –ò—Å–ø–æ–ª—å–∑—É–µ–º –æ—Ç—Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –¥–∞—Ç—ã –≤ –∫–ª—é—á–µ, —á—Ç–æ–±—ã –∏–∑–±–µ–∂–∞—Ç—å –ø—Ä–æ–±–ª–µ–º —Å –æ–±—ä–µ–∫—Ç–∞–º–∏ Date
            startDate: startDate ? formatDate(startDate) : undefined,
            endDate: endDate ? formatDate(endDate) : undefined,
        }],

        queryFn: async ({ pageParam = 0 }: QueryFunctionContext): Promise<EquipmentListResponse> => {
            const pageSize = PAGINATION_CONSTANTS.HOME_PAGE_SIZE;
            const skip = (pageParam as number) * pageSize;
            try {
                // –ü–µ—Ä–µ–¥–∞–µ–º –≤–µ—Å—å –æ–±—ä–µ–∫—Ç filters –≤ —Å–µ—Ä–≤–∏—Å
                return await EquipmentService.getAllEquipment(skip, pageSize, filters);
            } catch (error) {
                handleQueryError(error);
                throw error; // –ü—Ä–æ–±—Ä–∞—Å—ã–≤–∞–µ–º –æ—à–∏–±–∫—É –¥–∞–ª—å—à–µ –¥–ª—è react-query
            }
        },
        initialPageParam: 0,
        getNextPageParam: (lastPage, allPages) => {
            const loadedItems = allPages.flatMap(page => page.items).length;

            if (loadedItems < lastPage.total) {
                return allPages.length;
            }
            return undefined;
        },
        staleTime: 5 * 60 * 1000, // 5 –º–∏–Ω—É—Ç
    });
}

```


## <a name="srchooksuseEquipmentAvailabilityts"></a>`src/hooks/useEquipmentAvailability.ts`

```typescript
// path: src/hooks/useEquipmentAvailability.ts

import { useQuery } from "@tanstack/react-query";
import { api } from "@/lib/api";

interface EquipmentAvailability {
    hasActiveReservations: boolean;
    hasActiveRentals: boolean;
    activeReservationsCount: number;
    activeRentalsCount: number;
}

export function useEquipmentAvailability(equipmentId: number) {
    return useQuery({
        queryKey: ["equipment-availability", equipmentId],
        queryFn: async () => {
            const response = await api.get<EquipmentAvailability>(`/equipment/${equipmentId}/availability`);
            return response.data;
        },
    });
} 

```


## <a name="srchooksuseEquipmentMapts"></a>`src/hooks/useEquipmentMap.ts`

```typescript
// path: src/hooks/useEquipmentMap.ts

// src/hooks/useEquipmentMap.ts

import { useMemo } from "react";
import type { Equipment } from "@/types/equipment";
import type { InfiniteData } from "@tanstack/react-query";
import type { EquipmentListResponse } from "@/core/services";

/**
 * –•—É–∫ –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –∫–∞—Ä—Ç—ã –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—è –ø–æ ID –∏–∑ –¥–∞–Ω–Ω—ã—Ö useInfiniteQuery
 * @param equipmentPages - –û–±—ä–µ–∫—Ç InfiniteData, –≤–æ–∑–≤—Ä–∞—â–∞–µ–º—ã–π —Ö—É–∫–æ–º useEquipment
 * @returns –ö–∞—Ä—Ç–∞ –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—è, –≥–¥–µ –∫–ª—é—á - ID –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—è
 */
export const useEquipmentMap = (equipmentPages: InfiniteData<EquipmentListResponse, unknown> | undefined) => {
    return useMemo(() => {
        // –ò–ó–ú–ï–ù–ï–ù–ò–ï: "–†–∞–∑–≤–æ—Ä–∞—á–∏–≤–∞–µ–º" –≤—Å–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã –≤ –æ–¥–∏–Ω –ø–ª–æ—Å–∫–∏–π –º–∞—Å—Å–∏–≤ `allEquipment`
        const allEquipment = equipmentPages?.pages.flatMap(page => page.items) ?? [];

        const map: Record<number, Equipment> = {};
        // –¢–µ–ø–µ—Ä—å allEquipment - —ç—Ç–æ –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π –º–∞—Å—Å–∏–≤, –∏ forEach –±—É–¥–µ—Ç —Ä–∞–±–æ—Ç–∞—Ç—å
        allEquipment.forEach((e: Equipment) => {
            map[e.id] = e;
        });
        return map;
    }, [equipmentPages]);
};

```


## <a name="srchooksuseErrorHandlerts"></a>`src/hooks/useErrorHandler.ts`

```typescript
// path: src/hooks/useErrorHandler.ts

// src/hooks/useErrorHandler.ts
import { useCallback } from "react"

type UseErrorHandler = () => (error: unknown) => void

/**
 * –•—É–∫, –ø—Ä–æ–±—Ä–∞—Å—ã–≤–∞—é—â–∏–π –æ—à–∏–±–∫—É –≤–æ –≤–Ω–µ—à–Ω–∏–π ErrorBoundary —á–µ—Ä–µ–∑ throw.
 * –í—ã–∑—ã–≤–∞–µ—Ç—Å—è –≤—Ä—É—á–Ω—É—é –∏–∑ async-–∫–æ–Ω—Ç–µ–∫—Å—Ç–∞.
 */
export const useErrorHandler: UseErrorHandler = () => {
    return useCallback((error: unknown) => {
        if (error instanceof Error) {
            throw error
        } else {
            throw new Error("–ü—Ä–æ–∏–∑–æ—à–ª–∞ –Ω–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞")
        }
    }, [])
}


```


## <a name="srchooksuseInlineReservationEdittsx"></a>`src/hooks/useInlineReservationEdit.tsx`

```tsx
// path: src/hooks/useInlineReservationEdit.tsx

// src/hooks/useInlineReservationEdit.tsx

import React, { useMemo, useState, useEffect } from "react";
import { useReserveStore } from "@/store/reserveStore";
import { useReservationState, type EquipmentDisplayDetail } from "./reservation/useReservationState";
import { useReservationData } from "./reservation/useReservationData";
import { useEditReservation } from "./useEditReservation";
import type { Reservation } from "@/types/reservation";
import { ReservationEditContext, type ReservationEditContextValue } from "@/contexts/ReservationEditContext";
import { toast } from "sonner";
import { formatDate } from "@/lib/utils"; // <-- 1. –î–û–ë–ê–í–õ–ï–ù –ò–ú–ü–û–†–¢
import { useAllEquipment } from "./useAllEquipment";
import type { Equipment } from "@/types/equipment";

/**
 * –û—Å–Ω–æ–≤–Ω–æ–π —Ö—É–∫, –∫–æ—Ç–æ—Ä—ã–π –∏–Ω–∫–∞–ø—Å—É–ª–∏—Ä—É–µ—Ç –≤—Å—é —Å–ª–æ–∂–Ω—É—é –ª–æ–≥–∏–∫—É —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è —Ä–µ–∑–µ—Ä–≤–∞.
 * –û–Ω –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –≤–Ω—É—Ç—Ä–∏ –ø—Ä–æ–≤–∞–π–¥–µ—Ä–∞ ReservationEditProvider.
 */
const useInlineReservationEditLogic = (
    reservation: Reservation,
    initialEquipmentForDisplay: ReadonlyArray<EquipmentDisplayDetail>,
    onFullCancellation: (() => Promise<void> | void) | undefined,
    isAdminContext: boolean,
    onFinishEditing: () => void
): ReservationEditContextValue => {

    const { state, actions: stateActions, dialogs } = useReservationState(
        reservation,
        initialEquipmentForDisplay
    );

    const {
        availabilityMap, hasConflicts, isCheckingAvailability, isCalculatingPrice,
        financials, setPromoCode, applyPromoCode, removePromoCode, appliedPromoCode,
        priceDetails,
    } = useReservationData(reservation, state);

    const { data: allEquipment = [] } = useAllEquipment();

    const equipmentMap = useMemo(() =>
            new Map(allEquipment.map(e => [e.id, e])),
        [allEquipment]
    );

    useEffect(() => {
        const reserveStoreState = useReserveStore.getState();

        if (reserveStoreState.addToReservationMode === reservation.id && reserveStoreState.items.length > 0) {

            if (allEquipment.length > 0) {
                const newItemsData = reserveStoreState.items.map(itemInStore => {
                    const fullItemData = allEquipment.find((eq: Equipment) => eq.id === itemInStore.id);
                    return fullItemData || itemInStore;
                });

                stateActions.addEquipmentItems(newItemsData);
                reserveStoreState.clear();
            }
        }
    }, [allEquipment, reservation.id, stateActions]);

    const [holidayConflict, setHolidayConflict] = useState<{ message: string, suggested_end_date: string } | null>(null);
    const editApiMutation = useEditReservation();

    const finalHasChanges = useMemo(() => {
        const promoCodeChanged = appliedPromoCode !== (reservation.promo_code || "");
        return state.hasChanges || promoCodeChanged;
    }, [state.hasChanges, appliedPromoCode, reservation.promo_code]);

    const saveChanges = async (confirmAdjustment: boolean = false): Promise<boolean> => {
        if (!finalHasChanges && !confirmAdjustment) {
            toast.info("–ù–µ—Ç –∏–∑–º–µ–Ω–µ–Ω–∏–π –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è.");
            return false;
        }
        if (hasConflicts) {
            toast.error("–ù–µ–≤–æ–∑–º–æ–∂–Ω–æ —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å —Ä–µ–∑–µ—Ä–≤ —Å –∫–æ–Ω—Ñ–ª–∏–∫—Ç–∞–º–∏.");
            return false;
        }
        if (state.currentEquipmentDetails.length === 0) {
            toast.error("–†–µ–∑–µ—Ä–≤ –¥–æ–ª–∂–µ–Ω —Å–æ–¥–µ—Ä–∂–∞—Ç—å —Ö–æ—Ç—è –±—ã –æ–¥–Ω—É –ø–æ–∑–∏—Ü–∏—é.");
            return false;
        }

        try {
            await editApiMutation.mutateAsync({
                id: reservation.id,
                // V-- 2. –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï –ó–î–ï–°–¨ --V
                start_date: formatDate(state.startDate),
                end_date: formatDate(state.endDate),
                // ^-- –ö–û–ù–ï–¶ –ò–°–ü–†–ê–í–õ–ï–ù–ò–Ø --^
                equipment_ids: state.currentEquipmentDetails.map(eq => eq.id),
                promo_code: appliedPromoCode,
                selected_accessories: state.localSelectedAccessories,
                isAdminContext,
                confirm_date_adjustment: confirmAdjustment,
            });
            toast.success("–†–µ–∑–µ—Ä–≤ —É—Å–ø–µ—à–Ω–æ –æ–±–Ω–æ–≤–ª–µ–Ω!");
            if (holidayConflict) setHolidayConflict(null);
            onFinishEditing();
            return true;
        } catch (error) {
            const errorDetail = (error as any)?.response?.data?.detail;

            let parsedDetail = null;
            if (typeof errorDetail === 'string') {
                try { parsedDetail = JSON.parse(errorDetail); } catch (e) { /* –û—à–∏–±–∫–∞ –Ω–µ –≤ —Ñ–æ—Ä–º–∞—Ç–µ JSON */ }
            } else {
                parsedDetail = errorDetail;
            }

            if (
                (error as any).response?.status === 409 &&
                parsedDetail?.error_type === "END_DATE_IS_HOLIDAY"
            ) {
                setHolidayConflict(parsedDetail);
            } else {
                const message = typeof errorDetail === 'string' ? errorDetail : "–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–π.";
                toast.error(message);
            }
            return false;
        }
    };

    const handleConfirmHolidayAdjustment = () => {
        void saveChanges(true);
    };

    const { clear: clearReserveStore, setReservationId } = useReserveStore.getState();

    const cancelEdit = () => {
        clearReserveStore();
        onFinishEditing();
    };

    const editStateForUI = useMemo(() => ({
        ...state,
        hasChanges: finalHasChanges,
        newlyAddedEquipmentIdsAsArray: Array.from(state.newlyAddedEquipmentIds)
    }), [state, finalHasChanges]);

    return {
        reservationId: reservation.id,
        editState: editStateForUI,
        availabilityMap,
        hasConflicts,
        isLoading: editApiMutation.isPending || isCheckingAvailability,
        isCheckingAvailability,
        isSaving: editApiMutation.isPending,
        isCalculatingPrice,
        isCancelling: false,
        isCancelConfirmationVisible: dialogs.isCancelConfirmationVisible,
        startEdit: () => setReservationId(reservation.id),
        cancelEdit,
        saveChanges: () => saveChanges(false),
        equipmentMap,
        allEquipment,
        updateDates: stateActions.updateDates,
        addEquipmentItems: stateActions.addEquipmentItems,
        removeEquipmentItem: stateActions.removeEquipmentItem,
        handleConfirmFullCancellation: async () => { if (onFullCancellation) await onFullCancellation() },
        handleCloseCancellationDialog: () => dialogs.setCancelConfirmationVisible(false),
        financials,
        priceDetails,
        setPromoCode,
        applyPromoCode,
        removePromoCode,
        localSelectedAccessories: state.localSelectedAccessories,
        toggleAccessory: stateActions.toggleAccessory,
        holidayConflict: holidayConflict,
        confirmHolidayAdjustment: handleConfirmHolidayAdjustment,
        cancelHolidayAdjustment: () => setHolidayConflict(null),
    };
};

/**
 * –ö–æ–º–ø–æ–Ω–µ–Ω—Ç-–ø—Ä–æ–≤–∞–π–¥–µ—Ä, –∫–æ—Ç–æ—Ä—ã–π –æ–±–æ—Ä–∞—á–∏–≤–∞–µ—Ç –¥–æ—á–µ—Ä–Ω–∏–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã
 * –∏ –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª—è–µ—Ç –∏–º –¥–æ—Å—Ç—É–ø –∫–æ –≤—Å–µ–π –ª–æ–≥–∏–∫–µ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è —á–µ—Ä–µ–∑ —Ö—É–∫ useReservationEditContext.
 */
export const ReservationEditProvider: React.FC<{
    children: React.ReactNode;
    reservation: Reservation;
    initialEquipmentForDisplay: ReadonlyArray<EquipmentDisplayDetail>;
    onFullCancellation?: (() => Promise<void> | void) | undefined;
    isAdminContext?: boolean;
    onFinishEditing: () => void;
}> = (props) => {
    const contextValue = useInlineReservationEditLogic(
        props.reservation,
        props.initialEquipmentForDisplay,
        props.onFullCancellation,
        props.isAdminContext || false,
        props.onFinishEditing
    );

    return (
        <ReservationEditContext.Provider value={contextValue}>
            {props.children}
        </ReservationEditContext.Provider>
    );
};

```


## <a name="srchooksuseMyRentalsts"></a>`src/hooks/useMyRentals.ts`

```typescript
// path: src/hooks/useMyRentals.ts

import { useInfiniteQuery, type QueryFunctionContext } from "@tanstack/react-query";
import { api } from "@/lib/api";
import type { AdminRentalListResponse } from "@/types/rental";
import { useCurrentUser } from "./useProfile";

const MY_RENTALS_KEY = "myRentals";

interface UseMyRentalsParams {
    search?: string;
    status?: string;
    sort?: string;
}

export function useMyRentals(params?: UseMyRentalsParams, limit: number = 10) {
    const { data: user } = useCurrentUser();

    return useInfiniteQuery<AdminRentalListResponse, Error>({
        queryKey: [MY_RENTALS_KEY, params],
        queryFn: async ({ pageParam = 0 }: QueryFunctionContext) => {
            const skip = (pageParam as number) * limit;
            const response = await api.get<AdminRentalListResponse>("/user/rentals", {
                params: { skip, limit, ...params },
            });
            return response.data;
        },
        initialPageParam: 0,
        getNextPageParam: (lastPage, allPages) => {
            const loadedItems = allPages.reduce((acc, page) => acc + page.items.length, 0);
            if (loadedItems < lastPage.total) {
                return allPages.length;
            }
            return undefined;
        },
        enabled: !!user, // –í—ã–ø–æ–ª–Ω—è—Ç—å –∑–∞–ø—Ä–æ—Å —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω
    });
}


```


## <a name="srchooksuseNetworkStatusts"></a>`src/hooks/useNetworkStatus.ts`

```typescript
// path: src/hooks/useNetworkStatus.ts

// src/hooks/useNetworkStatus.ts
import { useEffect, useState } from "react"

/**
 * –•—É–∫ –æ—Ç—Å–ª–µ–∂–∏–≤–∞–µ—Ç —Å—Ç–∞—Ç—É—Å –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è (online/offline).
 * –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç true ‚Äî –µ—Å–ª–∏ –≤ —Å–µ—Ç–∏, false ‚Äî –µ—Å–ª–∏ –æ—Ñ—Ñ–ª–∞–π–Ω.
 */
export function useNetworkStatus(): boolean {
    const [isOnline, setIsOnline] = useState(navigator.onLine)

    useEffect(() => {
        const handleOnline = () => setIsOnline(true)
        const handleOffline = () => setIsOnline(false)

        window.addEventListener("online", handleOnline)
        window.addEventListener("offline", handleOffline)

        return () => {
            window.removeEventListener("online", handleOnline)
            window.removeEventListener("offline", handleOffline)
        }
    }, [])

    return isOnline
}


```


## <a name="srchooksusePhoneValidationts"></a>`src/hooks/usePhoneValidation.ts`

```typescript
// path: src/hooks/usePhoneValidation.ts

// src/hooks/usePhoneValidation.ts

import { useState, useCallback } from 'react';
import { PhoneService } from '@/core/services';

interface UsePhoneValidationOptions {
    format?: 'russian' | 'international';
    required?: boolean;
    onValidationChange?: (isValid: boolean) => void;
}

interface UsePhoneValidationReturn {
    isValid: boolean;
    error: string | null;
    validatePhone: (phone: string) => boolean;
    clearError: () => void;
}

/**
 * –•—É–∫ –¥–ª—è –≤–∞–ª–∏–¥–∞—Ü–∏–∏ —Ç–µ–ª–µ—Ñ–æ–Ω–Ω—ã—Ö –Ω–æ–º–µ—Ä–æ–≤ –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏
 */
export function usePhoneValidation(options: UsePhoneValidationOptions = {}): UsePhoneValidationReturn {
    const {
        format = 'russian',
        required = false,
        onValidationChange
    } = options;

    const [isValid, setIsValid] = useState(false);
    const [error, setError] = useState<string | null>(null);

    const validatePhone = useCallback((phone: string): boolean => {
        // –ï—Å–ª–∏ –ø–æ–ª–µ –Ω–µ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ –∏ –ø—É—Å—Ç–æ–µ, —Å—á–∏—Ç–∞–µ–º –≤–∞–ª–∏–¥–Ω—ã–º
        if (!required && !phone.trim()) {
            setIsValid(true);
            setError(null);
            onValidationChange?.(true);
            return true;
        }

        // –ï—Å–ª–∏ –ø–æ–ª–µ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ –∏ –ø—É—Å—Ç–æ–µ
        if (required && !phone.trim()) {
            setIsValid(false);
            setError('–ù–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞ –æ–±—è–∑–∞—Ç–µ–ª–µ–Ω');
            onValidationChange?.(false);
            return false;
        }

        // –ò—Å–ø–æ–ª—å–∑—É–µ–º PhoneService –¥–ª—è –≤–∞–ª–∏–¥–∞—Ü–∏–∏
        const validationResult = PhoneService.validate(phone);
        
        if (!validationResult.isValid) {
            setIsValid(false);
            setError(validationResult.error || '–ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π –Ω–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞');
            onValidationChange?.(false);
            return false;
        }

        // –í—Å–µ –ø—Ä–æ–≤–µ—Ä–∫–∏ –ø—Ä–æ–π–¥–µ–Ω—ã
        setIsValid(true);
        setError(null);
        onValidationChange?.(true);
        return true;
    }, [format, required, onValidationChange]);

    const clearError = useCallback(() => {
        setError(null);
    }, []);

    return {
        isValid,
        error,
        validatePhone,
        clearError
    };
}

/**
 * –•—É–∫ –¥–ª—è –≤–∞–ª–∏–¥–∞—Ü–∏–∏ —Ç–µ–ª–µ—Ñ–æ–Ω–∞ —Å debounce
 */
export function usePhoneValidationWithDebounce(
    options: UsePhoneValidationOptions & { debounceMs?: number } = {}
): UsePhoneValidationReturn & { debouncedValidate: (phone: string) => void } {
    const { debounceMs = 500, ...validationOptions } = options;
    const [debounceTimeout, setDebounceTimeout] = useState<NodeJS.Timeout | null>(null);
    
    const baseValidation = usePhoneValidation(validationOptions);

    const debouncedValidate = useCallback((phone: string) => {
        // –û—á–∏—â–∞–µ–º –ø—Ä–µ–¥—ã–¥—É—â–∏–π —Ç–∞–π–º–∞—É—Ç
        if (debounceTimeout) {
            clearTimeout(debounceTimeout);
        }

        // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –Ω–æ–≤—ã–π —Ç–∞–π–º–∞—É—Ç
        const timeout = setTimeout(() => {
            baseValidation.validatePhone(phone);
        }, debounceMs);

        setDebounceTimeout(timeout);
    }, [baseValidation, debounceMs, debounceTimeout]);

    return {
        ...baseValidation,
        debouncedValidate
    };
} 

```


## <a name="srchooksuseProfilets"></a>`src/hooks/useProfile.ts`

```typescript
// path: src/hooks/useProfile.ts

import { useQuery, useMutation, useQueryClient } from "@tanstack/react-query";
import { api } from "@/lib/api";
import type { UserOut } from "@/types/user";
import { handleQueryError } from "@/lib/queryHelpers";

/**
 * –¢–∏–ø –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –ø—Ä–æ—Ñ–∏–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
 */
type ProfileUpdatePayload = {
    full_name: string;
    email: string;
    phone?: string;
};

/**
 * –¢–∏–ø –æ—à–∏–±–∫–∏ API
 */
type APIError = {
    response?: {
        status?: number;
        data?: {
            detail?: string;
        };
    };
    message?: string;
};

/**
 * –•—É–∫ –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö —Ç–µ–∫—É—â–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
 * @returns Query –æ–±—ä–µ–∫—Ç —Å –¥–∞–Ω–Ω—ã–º–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
 */
export function useCurrentUser() {
    return useQuery<UserOut | null, Error>({
        queryKey: ["current_user"],
        queryFn: async () => {
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ —Ç–æ–∫–µ–Ω–∞ –ø–µ—Ä–µ–¥ –∑–∞–ø—Ä–æ—Å–æ–º
            const accessToken = localStorage.getItem("access_token");
            if (!accessToken) {
                return null;
            }

            try {
                const res = await api.get<UserOut>("/user/");
                return res.data;
            } catch (error: unknown) {
                const apiError = error as APIError;
                if (apiError.response?.status === 401) {
                    // –û—á–∏—â–∞–µ–º –Ω–µ–¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω—ã–π —Ç–æ–∫–µ–Ω
                    localStorage.removeItem("access_token");
                    return null;
                }
                console.error("[useCurrentUser] Error fetching user data:", apiError);
                handleQueryError(error);
                throw error;
            }
        },
        staleTime: 1000 * 60 * 10, // –∫—ç—à –Ω–∞ 10 –º–∏–Ω—É—Ç
        retry: (failureCount, error) => {
            // –ù–µ –ø–æ–≤—Ç–æ—Ä—è–µ–º –∑–∞–ø—Ä–æ—Å –ø—Ä–∏ 401 –æ—à–∏–±–∫–µ
            if (error instanceof Error && error.message.includes("401")) {
                return false;
            }
            return failureCount < 3;
        },
        // –ù–µ –≤—ã–ø–æ–ª–Ω—è–µ–º –∑–∞–ø—Ä–æ—Å, –µ—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω
        enabled: !!localStorage.getItem("access_token"),
    });
}

/**
 * –•—É–∫ –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö –ø—Ä–æ—Ñ–∏–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
 * @returns Mutation –æ–±—ä–µ–∫—Ç –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –ø—Ä–æ—Ñ–∏–ª—è
 */
export function useProfileUpdate() {
    const queryClient = useQueryClient();

    return useMutation<void, Error, ProfileUpdatePayload>({
        mutationFn: async (data: ProfileUpdatePayload) => {
            try {
                await api.put("/user/", data);
            } catch (error: unknown) {
                console.error("[useProfileUpdate] Error updating profile:", error);
                handleQueryError(error);
                throw error;
            }
        },
        onSuccess: () => {
            queryClient.invalidateQueries({ queryKey: ["current_user"] });
        },
        onError: (error: Error) => {
            console.error("[useProfileUpdate] Mutation error:", error);
        },
    });
}


```


## <a name="srchooksuseReservationManagementts"></a>`src/hooks/useReservationManagement.ts`

```typescript
// path: src/hooks/useReservationManagement.ts

// src/hooks/useReservationManagement.ts

import { useEffect, useMemo } from 'react';
import { useLocation } from 'react-router-dom';
import { useReserveStore } from '@/store/reserveStore';
import type { Equipment } from '@/types/equipment';
import type { AvailabilityInfo, EquipmentStatus } from '@/types/availability';

type UseReservationManagementReturn = {
    editingReservationId: number | null;
    intent: string | null;
    getEquipmentStatus: (eq: Equipment) => EquipmentStatus | "my_reservation" | "added";
};

export function useReservationManagement(
    filteredItems: Equipment[],
    availabilityMap: Record<number, AvailabilityInfo>,
    availableOnly: boolean
): UseReservationManagementReturn {
    const location = useLocation();
    const { items: selectedItems, addToReservationMode } = useReserveStore();

    const editingReservationEquipmentIds = useMemo(() => {
        if (location.state?.intent === "add_to_reservation" && location.state?.reservationId) {
            return new Set(location.state?.equipmentIds || []);
        }
        return new Set<number>();
    }, [location.state]);

    useEffect(() => {
        const intent = location.state?.intent;
        const reservationIdFromLocation = location.state?.reservationId;
        const storeActions = useReserveStore.getState();

        if (intent === "add_to_reservation" && reservationIdFromLocation) {
            if (storeActions.addToReservationMode !== reservationIdFromLocation) {
                storeActions.clear();
                storeActions.setAddToReservationMode(reservationIdFromLocation);
            }
        } else if (intent === "add_to_new_reservation") {
            if (storeActions.addToReservationMode !== null) {
                storeActions.clear();
            }
        } else {
            if (storeActions.addToReservationMode !== null) {
                storeActions.clear();
            }
        }
    }, [location.state]);

    // availabilityMap —Ç–µ–ø–µ—Ä—å –ø–µ—Ä–µ–¥–∞–µ—Ç—Å—è –∫–∞–∫ –ø–∞—Ä–∞–º–µ—Ç—Ä, –Ω–µ –Ω—É–∂–Ω–æ —Å–æ–∑–¥–∞–≤–∞—Ç—å –µ–≥–æ –∑–¥–µ—Å—å


    const getEquipmentStatus = (eq: Equipment): EquipmentStatus | "my_reservation" | "added" => {
        if (location.state?.intent === "add_to_reservation" && location.state?.reservationId === addToReservationMode) {
            if (editingReservationEquipmentIds.has(eq.id)) {
                return "my_reservation";
            }
            if (selectedItems.some(i => i.id === eq.id)) {
                return "added";
            }
        }

        const itemAvailability = availabilityMap[eq.id];

        // --- –ù–ê–ß–ê–õ–û –ò–ó–ú–ï–ù–ï–ù–ò–ô (–í–û–ó–í–†–ê–©–ê–ï–ú –ö–ê–ö –ë–´–õ–û) ---
        // –¢–µ–ø–µ—Ä—å –±—ç–∫–µ–Ω–¥ —Å–∞–º –æ—Ç–¥–∞–µ—Ç –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π —Å—Ç–∞—Ç—É—Å, –Ω–∞–º –Ω–µ –Ω—É–∂–Ω–∞ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –ª–æ–≥–∏–∫–∞
        return itemAvailability?.status ?? "available";
        // --- –ö–û–ù–ï–¶ –ò–ó–ú–ï–ù–ï–ù–ò–ô ---
    };

    return {
        editingReservationId: location.state?.reservationId ?? null,
        intent: location.state?.intent ?? null,
        getEquipmentStatus
    };
}

```


## <a name="srchooksuseReservationsts"></a>`src/hooks/useReservations.ts`

```typescript
// path: src/hooks/useReservations.ts

// src/hooks/useReservations.ts

import { useQuery, useMutation, useQueryClient } from "@tanstack/react-query";
import { ReservationService, type ReservationCreateInput } from "@/core/services/ReservationService";
import type { Reservation } from "@/types/reservation";
import { handleQueryError } from "@/lib/queryHelpers";
import { useCurrentUser } from "./useProfile";
import { toast } from "sonner";
import { transformAccessoryLinks } from "@/lib/utils";

const RESERVATIONS_KEY = ["reservations"];

const invalidateReservationQueries = (queryClient: ReturnType<typeof useQueryClient>) => {
    void queryClient.invalidateQueries({ queryKey: RESERVATIONS_KEY });
    void queryClient.invalidateQueries({ queryKey: ["availability"] });
    void queryClient.invalidateQueries({ queryKey: ["calendar-grid"] });
};

const handleMutationError = (error: unknown, contextMessage: string) => {
    console.error(`[useReservations] Error on ${contextMessage}:`, error);
    const apiError = error as { response?: { data?: { detail?: any } } };
    const detail = apiError.response?.data?.detail;
    let message = `–û—à–∏–±–∫–∞: ${contextMessage}`;

    if (typeof detail === 'string') {
        message = detail;
    } else if (typeof detail?.message === 'string') {
        message = detail.message;
    }

    toast.error(message);

    if (detail?.unavailable_ids) {
        const errorToThrow = new Error(message);
        (errorToThrow as any).unavailable_ids = detail.unavailable_ids;
        throw errorToThrow;
    }
};

interface UseReservationsParams {
    search?: string;
    status?: string;
    sort?: string;
}

export function useReservations(params?: UseReservationsParams) {
    const queryClient = useQueryClient();
    const { data: user } = useCurrentUser();

    const reservationsQuery = useQuery<Reservation[], Error>({
        queryKey: [...RESERVATIONS_KEY, params],
        queryFn: async (): Promise<Reservation[]> => {
            try {
                return await ReservationService.getUserReservations(params);
            } catch (error) {
                handleQueryError(error);
                throw error;
            }
        },
        enabled: !!user,
        staleTime: 5 * 60 * 1000,
        select: (data) => data.map(transformAccessoryLinks),
    });

    const createReservation = useMutation({
        mutationFn: (data: ReservationCreateInput) => ReservationService.createReservation(data),
        onSuccess: () => {
            invalidateReservationQueries(queryClient);
        },
        onError: (error) => handleMutationError(error, "–Ω–µ —É–¥–∞–ª–æ—Å—å —Å–æ–∑–¥–∞—Ç—å —Ä–µ–∑–µ—Ä–≤")
    });

    const updateReservation = useMutation({
        mutationFn: (data: any) => ReservationService.updateReservation(data),
        onSuccess: () => {
            invalidateReservationQueries(queryClient);
            toast.success("–†–µ–∑–µ—Ä–≤ —É—Å–ø–µ—à–Ω–æ –æ–±–Ω–æ–≤–ª–µ–Ω!");
        },
        onError: (error) => handleMutationError(error, "–Ω–µ —É–¥–∞–ª–æ—Å—å –æ–±–Ω–æ–≤–∏—Ç—å —Ä–µ–∑–µ—Ä–≤")
    });

    const deleteReservation = useMutation({
        mutationFn: (id: number) => ReservationService.cancelReservation(id),
        onSuccess: () => {
            invalidateReservationQueries(queryClient);
            toast.success("–†–µ–∑–µ—Ä–≤ —É—Å–ø–µ—à–Ω–æ —É–¥–∞–ª–µ–Ω!");
        },
        onError: (error) => handleMutationError(error, "–Ω–µ —É–¥–∞–ª–æ—Å—å —É–¥–∞–ª–∏—Ç—å —Ä–µ–∑–µ—Ä–≤")
    });

    return {
        reservationsQuery,
        createReservation,
        updateReservation,
        deleteReservation,
    };
}

```


## <a name="srchooksuseUpdateEquipmentDetailsts"></a>`src/hooks/useUpdateEquipmentDetails.ts`

```typescript
// path: src/hooks/useUpdateEquipmentDetails.ts

// src/hooks/useUpdateEquipmentDetails.ts
import { useMutation, useQueryClient } from "@tanstack/react-query";
import { toast } from "sonner";
import { api } from "@/lib/api";
import type { Equipment } from "@/types/equipment";
import type { EquipmentUpdateExtendedSchema } from "@/lib/validationSchemas";

interface UpdateEquipmentPayload {
    id: number;
    data: EquipmentUpdateExtendedSchema;
}

export function useUpdateEquipmentDetails() {
    const queryClient = useQueryClient();

    return useMutation<Equipment, Error, UpdateEquipmentPayload>({
        mutationFn: async ({ id, data }) => {
            const payload: Record<string, string | number | boolean | string[] | number[] | null> = {};
            for (const key in data) {
                if (Object.prototype.hasOwnProperty.call(data, key)) {
                    const typedKey = key as keyof EquipmentUpdateExtendedSchema;
                    if (data[typedKey] !== undefined) {
                        payload[typedKey] = data[typedKey];
                    }
                }
            }
            const response = await api.put<Equipment>(`/equipment/${id}`, payload);
            return response.data;
        },
        onSuccess: async (updatedEquipment, variables) => { // <--- –î–æ–±–∞–≤–ª–µ–Ω async
            toast.success(`–û–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏–µ "${updatedEquipment.name}" —É—Å–ø–µ—à–Ω–æ –æ–±–Ω–æ–≤–ª–µ–Ω–æ!`);

            // –ò–Ω–≤–∞–ª–∏–¥–∞—Ü–∏—è –∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∫—ç—à–∞
            // 1. –ò–Ω–≤–∞–ª–∏–¥–∏—Ä—É–µ–º –æ–±—â–∏–π —Å–ø–∏—Å–æ–∫ –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—è
            await queryClient.invalidateQueries({ queryKey: ["equipment"] }); // <--- –î–æ–±–∞–≤–ª–µ–Ω await

            // 2. –ú–æ–∂–Ω–æ —Ç–∞–∫–∂–µ —Ç–æ—á–µ—á–Ω–æ –æ–±–Ω–æ–≤–∏—Ç—å –∫—ç—à –¥–ª—è —ç—Ç–æ–≥–æ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ —ç–ª–µ–º–µ–Ω—Ç–∞,
            // –µ—Å–ª–∏ –æ–Ω –≥–¥–µ-—Ç–æ –∑–∞–ø—Ä–∞—à–∏–≤–∞–µ—Ç—Å—è –ø–æ –æ—Ç–¥–µ–ª—å–Ω–æ–º—É –∫–ª—é—á—É (–Ω–∞–ø—Ä–∏–º–µ—Ä, ["equipment", variables.id])
            // await queryClient.setQueryData(["equipment", variables.id], updatedEquipment); // <--- –î–æ–±–∞–≤–ª–µ–Ω await, –µ—Å–ª–∏ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è

            queryClient.setQueryData<Equipment[]>(["equipment"], (oldData) =>
                oldData?.map((item) =>
                    item.id === variables.id ? { ...item, ...updatedEquipment } : item
                ) ?? []
            );

            // 4. –ò–Ω–≤–∞–ª–∏–¥–∏—Ä—É–µ–º –¥–∞–Ω–Ω—ã–µ –æ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏
            await queryClient.invalidateQueries({ queryKey: ["availability"] }); // <--- –î–æ–±–∞–≤–ª–µ–Ω await
            await queryClient.invalidateQueries({ queryKey: ["calendar-grid"] }); // <--- –î–æ–±–∞–≤–ª–µ–Ω await
            await queryClient.invalidateQueries({ queryKey: ["calendar-events"] }); // <--- –î–æ–±–∞–≤–ª–µ–Ω await
        },
        onError: (error) => {
            toast.error(`–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—è: ${error.message}`);
            console.error("–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—è:", error);
        },
    });
}

```


## <a name="srchooksuseVisibleItemsts"></a>`src/hooks/useVisibleItems.ts`

```typescript
// path: src/hooks/useVisibleItems.ts

import { useState, useEffect } from 'react';

/**
 * –£–ø—Ä–∞–≤–ª—è–µ—Ç –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ–º –≤–∏–¥–∏–º—ã—Ö —ç–ª–µ–º–µ–Ω—Ç–æ–≤ –≤ —Å–ø–∏—Å–∫–µ —Å —É—á–µ—Ç–æ–º —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏.
 * @param totalCount –û–±—â–µ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —ç–ª–µ–º–µ–Ω—Ç–æ–≤ –≤ –æ—Ç—Ñ–∏–ª—å—Ç—Ä–æ–≤–∞–Ω–Ω–æ–º —Å–ø–∏—Å–∫–µ.
 */
export function useVisibleItems(totalCount: number) {
    // `intendedSize` ‚Äî —ç—Ç–æ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —ç–ª–µ–º–µ–Ω—Ç–æ–≤, –∫–æ—Ç–æ—Ä–æ–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å *—Ö–æ—á–µ—Ç* –≤–∏–¥–µ—Ç—å (–Ω–∞–ø—Ä–∏–º–µ—Ä, –ø–æ—Å–ª–µ –Ω–∞–∂–∞—Ç–∏—è –∫–Ω–æ–ø–∫–∏ "24").
    const [intendedSize, setIntendedSize] = useState(12);

    // `visibleCount` ‚Äî —ç—Ç–æ —Ñ–∞–∫—Ç–∏—á–µ—Å–∫–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —ç–ª–µ–º–µ–Ω—Ç–æ–≤ –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è, –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–Ω–æ–µ `totalCount`.
    const [visibleCount, setVisibleCount] = useState(12);

    // `increaseVisibleCount` –æ–±–Ω–æ–≤–ª—è–µ—Ç –Ω–∞–º–µ—Ä–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è —É–≤–∏–¥–µ—Ç—å –±–æ–ª—å—à–µ —ç–ª–µ–º–µ–Ω—Ç–æ–≤.
    const increaseVisibleCount = (step: number = 12) => {
        setIntendedSize((prev) => prev + step);
    };

    // `setVisibility` (–ø–µ—Ä–µ–∏–º–µ–Ω–æ–≤–∞–Ω–∞ –¥–ª—è —è—Å–Ω–æ—Å—Ç–∏ –≤ `setIntendedSize`) –≤—ã–∑—ã–≤–∞–µ—Ç—Å—è –∫–Ω–æ–ø–∫–∞–º–∏ "12", "24", –∏ —Ç.–¥.
    const setVisibility = (count: number) => {
        setIntendedSize(count);
    };

    // –≠—Ç–æ—Ç useEffect —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä—É–µ—Ç —Ñ–∞–∫—Ç–∏—á–µ—Å–∫–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –≤–∏–¥–∏–º—ã—Ö —ç–ª–µ–º–µ–Ω—Ç–æ–≤.
    // –û–Ω —Å—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç, –∫–æ–≥–¥–∞ –º–µ–Ω—è–µ—Ç—Å—è –ª–∏–±–æ –Ω–∞–º–µ—Ä–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (`intendedSize`), –ª–∏–±–æ –æ–±—â–µ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —ç–ª–µ–º–µ–Ω—Ç–æ–≤ (`totalCount`).
    useEffect(() => {
        // –ï—Å–ª–∏ –æ–±—â–µ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ä–∞–≤–Ω–æ 0, –Ω–∏—á–µ–≥–æ –Ω–µ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º.
        if (totalCount === 0) {
            setVisibleCount(0);
        } else {
            // –í –æ—Å—Ç–∞–ª—å–Ω—ã—Ö —Å–ª—É—á–∞—è—Ö –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –º–µ–Ω—å—à–µ–µ –∏–∑ –¥–≤—É—Ö:
            // –ª–∏–±–æ —Å–∫–æ–ª—å–∫–æ —Ö–æ—á–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å, –ª–∏–±–æ —Å–∫–æ–ª—å–∫–æ –µ—Å—Ç—å –≤—Å–µ–≥–æ.
            setVisibleCount(Math.min(intendedSize, totalCount));
        }
    }, [intendedSize, totalCount]);

    return { visibleCount, setVisibleCount: setVisibility, increaseVisibleCount };
}

```


## <a name="srcindexcss"></a>`src/index.css`

```css
// path: src/index.css

@tailwind base;
@tailwind components;
@tailwind utilities;

/* –ë–∞–∑–æ–≤—ã–µ —Å—Ç–∏–ª–∏ html/body */
html,
body {
  margin: 0;
  padding: 0;
  min-height: 100vh;
  background-color: #f9fafb; /* Tailwind gray-50 */
  color: #111827; /* Tailwind gray-900 */
  font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI",
  Roboto, Helvetica, Arial, sans-serif;
  line-height: 1.5;
  -webkit-font-smoothing: antialiased;
}

a {
  color: inherit;
  text-decoration: none;
}

button {
  cursor: pointer;
  font-family: inherit;
}


@layer base {
  :root {
    --background: 0 0% 100%;
    --foreground: 0 0% 3.9%;
    --card: 0 0% 100%;
    --card-foreground: 0 0% 3.9%;
    --popover: 0 0% 100%;
    --popover-foreground: 0 0% 3.9%;
    --primary: 0 0% 9%;
    --primary-foreground: 0 0% 98%;
    --secondary: 0 0% 96.1%;
    --secondary-foreground: 0 0% 9%;
    --muted: 0 0% 96.1%;
    --muted-foreground: 0 0% 45.1%;
    --accent: 0 0% 96.1%;
    --accent-foreground: 0 0% 9%;
    --destructive: 0 84.2% 60.2%;
    --destructive-foreground: 0 0% 98%;
    --border: 0 0% 89.8%;
    --input: 0 0% 89.8%;
    --ring: 0 0% 3.9%;
    --chart-1: 12 76% 61%;
    --chart-2: 173 58% 39%;
    --chart-3: 197 37% 24%;
    --chart-4: 43 74% 66%;
    --chart-5: 27 87% 67%;
    --radius: 0.5rem;
  }
  .dark {
    --background: 0 0% 3.9%;
    --foreground: 0 0% 98%;
    --card: 0 0% 3.9%;
    --card-foreground: 0 0% 98%;
    --popover: 0 0% 3.9%;
    --popover-foreground: 0 0% 98%;
    --primary: 0 0% 98%;
    --primary-foreground: 0 0% 9%;
    --secondary: 0 0% 14.9%;
    --secondary-foreground: 0 0% 98%;
    --muted: 0 0% 14.9%;
    --muted-foreground: 0 0% 63.9%;
    --accent: 0 0% 14.9%;
    --accent-foreground: 0 0% 98%;
    --destructive: 0 62.8% 30.6%;
    --destructive-foreground: 0 0% 98%;
    --border: 0 0% 14.9%;
    --input: 0 0% 14.9%;
    --ring: 0 0% 83.1%;
    --chart-1: 220 70% 50%;
    --chart-2: 160 60% 45%;
    --chart-3: 30 80% 55%;
    --chart-4: 280 65% 60%;
    --chart-5: 340 75% 55%;
  }
}

@layer base {
  * {
    @apply border-border;
  }
  body {
    @apply bg-background text-foreground;
  }
}

/* –ü–æ–¥—Å–≤–µ—Ç–∫–∞ –≤–µ—Ä—Ç–∏–∫–∞–ª—å–Ω–æ–≥–æ —Å—Ç–æ–ª–±—Ü–∞ "–°–µ–≥–æ–¥–Ω—è" */
.today-column {
  box-shadow: inset -1px 0 0 0 rgba(59, 130, 246, 0.5),
    /* sky-500 */ inset 1px 0 0 0 rgba(59, 130, 246, 0.5);
}

/* === –°–¢–ò–õ–ò –î–õ–Ø REACT-DAY-PICKER === */
/* –£–¥–∞–ª—è–µ–º —Å—Ç–∞—Ä—ã–π –±–ª–æ–∫ —Å—Ç–∏–ª–µ–π –∏ –∑–∞–º–µ–Ω—è–µ–º –µ–≥–æ –Ω–∞ —ç—Ç–æ—Ç */
@layer components {
  .day-range-start {
    @apply rounded-r-none;
  }
  .day-range-end {
    @apply rounded-l-none;
  }
  .day-outside {
    @apply text-muted-foreground opacity-50;
  }
}

/* –í —Å–∞–º—ã–π –∫–æ–Ω–µ—Ü —Ñ–∞–π–ª–∞ src/index.css */

.super-test-border {
  border: 10px dashed lime !important;
}


@layer components {
  /* –ë–∞–∑–æ–≤—ã–π —Å—Ç–∏–ª—å –¥–ª—è –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ –¥–Ω—è (–∫—Ä—É–∂–æ–∫) */
  .day-selected {
    @apply bg-sky-600 text-white hover:bg-sky-700 focus:bg-sky-700 rounded-full;
  }

  /* –ù–∞—á–∞–ª–æ –¥–∏–∞–ø–∞–∑–æ–Ω–∞ - —Å–∫—Ä—É–≥–ª–µ–Ω–∏–µ —Ç–æ–ª—å–∫–æ —Å–ª–µ–≤–∞ */
  .day-range-start {
    @apply rounded-r-none;
  }

  /* –ö–æ–Ω–µ—Ü –¥–∏–∞–ø–∞–∑–æ–Ω–∞ - —Å–∫—Ä—É–≥–ª–µ–Ω–∏–µ —Ç–æ–ª—å–∫–æ —Å–ø—Ä–∞–≤–∞ */
  .day-range-end {
    @apply rounded-l-none;
  }

  /* –î–Ω–∏ –≤ —Å–µ—Ä–µ–¥–∏–Ω–µ –¥–∏–∞–ø–∞–∑–æ–Ω–∞ - —É–±–∏—Ä–∞–µ–º —Å–∫—Ä—É–≥–ª–µ–Ω–∏–µ –∏ –¥–æ–±–∞–≤–ª—è–µ–º —Ñ–æ–Ω */
  .day-range-middle {
    @apply bg-sky-100 text-gray-800 rounded-none hover:bg-sky-200;
  }
}




```


## <a name="srclibapits"></a>`src/lib/api.ts`

```typescript
// path: src/lib/api.ts

import axios from "axios"

// –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –∑–Ω–∞—á–µ–Ω–∏—è cookie –ø–æ –∏–º–µ–Ω–∏
function getCookie(name: string): string | null {
  const match = document.cookie.match(new RegExp('(^| )' + name + '=([^;]+)'));
  if (match) {
    return match[2];
  }
  return null;
}

export const api = axios.create({
  baseURL: "http://localhost:8000", // –∏–ª–∏ –∞–∫—Ç—É–∞–ª—å–Ω—ã–π —Ö–æ—Å—Ç [cite: 1]
})

// Interceptor –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ –æ—Ç–≤–µ—Ç–æ–≤
api.interceptors.response.use(
  (response) => response,
  (error) => {
    // –ï—Å–ª–∏ –ø–æ–ª—É—á–∞–µ–º 401 –æ—à–∏–±–∫—É, –æ—á–∏—â–∞–µ–º —Ç–æ–∫–µ–Ω
    if (error.response?.status === 401) {
      localStorage.removeItem("access_token");
    }
    return Promise.reject(error);
  }
)

// Interceptor –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è —Ç–æ–∫–µ–Ω–æ–≤ (Authorization –∏ CSRF)
api.interceptors.request.use(
    (config) => {
      // 1. –î–æ–±–∞–≤–ª—è–µ–º Authorization: Bearer <token>
      const accessToken = localStorage.getItem("access_token") // [cite: 1]
      if (accessToken) {
        config.headers.Authorization = `Bearer ${accessToken}` // [cite: 1]
      }

      // 2. –î–æ–±–∞–≤–ª—è–µ–º CSRF-—Ç–æ–∫–µ–Ω
      // –ë—ç–∫–µ–Ω–¥ (fastapi-csrf-protect) –æ–±—ã—á–Ω–æ —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç CSRF-—Ç–æ–∫–µ–Ω –≤ cookie
      // —Å –∏–º–µ–Ω–µ–º 'fastapi-csrf-token'. –§—Ä–æ–Ω—Ç–µ–Ω–¥ –¥–æ–ª–∂–µ–Ω –ø—Ä–æ—á–∏—Ç–∞—Ç—å –µ–≥–æ
      // –∏ –æ—Ç–ø—Ä–∞–≤–∏—Ç—å –≤ –∑–∞–≥–æ–ª–æ–≤–∫–µ 'X-CSRF-Token'.
      // –≠—Ç–æ –Ω—É–∂–Ω–æ –¥–ª—è –º–µ—Ç–æ–¥–æ–≤, –∏–∑–º–µ–Ω—è—é—â–∏—Ö —Å–æ—Å—Ç–æ—è–Ω–∏–µ (POST, PUT, DELETE, PATCH).
      const csrfToken = getCookie("fastapi-csrf-token") // –ò–º—è cookie –æ—Ç fastapi-csrf-protect
      if (csrfToken) {
        config.headers["X-CSRF-Token"] = csrfToken
      }

      // –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏ (–º–æ–∂–Ω–æ —É–±—Ä–∞—Ç—å –≤ production)
      // console.log("Request Config:", config.method?.toUpperCase(), config.url, config.headers);

      return config
    },
    (error) => {
      // –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫ –∑–∞–ø—Ä–æ—Å–∞ (–µ—Å–ª–∏ –Ω—É–∂–Ω–æ)
      return Promise.reject(error)
    }
)

```


## <a name="srclibqueryClientts"></a>`src/lib/queryClient.ts`

```typescript
// path: src/lib/queryClient.ts

// src/lib/queryClient.ts
import { QueryClient, QueryCacheNotifyEvent, Query } from "@tanstack/react-query"

export const queryClient = new QueryClient({
    defaultOptions: {
        queries: {
            staleTime: 1000 * 60,
            refetchOnWindowFocus: true,
            retry: 1
        }
    }
})

// üîß –ü–æ–¥–ø–∏—Å–∫–∞ –Ω–∞ —Å–æ–±—ã—Ç–∏—è –æ—à–∏–±–æ–∫ –≤ –∫—ç—à–µ
queryClient.getQueryCache().subscribe((event: QueryCacheNotifyEvent) => {
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —Å–æ–¥–µ—Ä–∂–∏—Ç –ª–∏ —Å–æ–±—ã—Ç–∏–µ –æ–±—ä–µ–∫—Ç Query
    const query = 'query' in event ? (event as { query: Query }).query : undefined

    if (
        query?.state.status === "error" &&
        isUnauthorizedError(query.state.error)
    ) {
        handleUnauthorized()
    }
})

function isUnauthorizedError(error: unknown): boolean {
    return error instanceof Error && error.message.includes("401")
}

function handleUnauthorized() {
    localStorage.removeItem("access_token")
    window.location.href = "/"
}


```


## <a name="srclibqueryHelpersts"></a>`src/lib/queryHelpers.ts`

```typescript
// path: src/lib/queryHelpers.ts

import { toast } from "sonner"

export function handleQueryError(error: unknown) {
    const message =
        error instanceof Error
            ? error.message
            : typeof error === "string"
                ? error
                : "–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞ –∑–∞–ø—Ä–æ—Å–∞"
    toast.error(message)
    console.error("[Query error]", error)
}


```


## <a name="srclibsortingUtilsts"></a>`src/lib/sortingUtils.ts`

```typescript
// path: src/lib/sortingUtils.ts

// src/lib/sortingUtils.ts

import { differenceInDays } from "date-fns";
import type { PickupReturnItem, OverdueRentalItem } from "@/hooks/admin/useDashboardData";

/**
 * –°–æ—Ä—Ç–∏—Ä—É–µ—Ç –≤—ã–¥–∞—á–∏ –ø–æ –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç—É:
 * 1. –í—ã–¥–∞—á–∏ –Ω–∞ —Å–µ–≥–æ–¥–Ω—è (–±–µ–∑ start_date –∏–ª–∏ start_date = —Å–µ–≥–æ–¥–Ω—è)
 * 2. –ü—Ä–æ—Å—Ä–æ—á–µ–Ω–Ω—ã–µ –≤—ã–¥–∞—á–∏ –ø–æ –∫–æ–ª–∏—á–µ—Å—Ç–≤—É –¥–Ω–µ–π –ø—Ä–æ—Å—Ä–æ—á–∫–∏ (–ø–æ –≤–æ–∑—Ä–∞—Å—Ç–∞–Ω–∏—é)
 */
export const sortPickupsByPriority = (pickups: PickupReturnItem[], today: Date): PickupReturnItem[] => {
    return [...pickups].sort((a, b) => {
        const aStartDate = a.start_date ? new Date(a.start_date) : null;
        const bStartDate = b.start_date ? new Date(b.start_date) : null;
        
        // –ï—Å–ª–∏ —É —ç–ª–µ–º–µ–Ω—Ç–∞ –Ω–µ—Ç start_date, —Å—á–∏—Ç–∞–µ–º –µ–≥–æ –≤—ã–¥–∞—á–µ–π –Ω–∞ —Å–µ–≥–æ–¥–Ω—è
        const aIsToday = !aStartDate || aStartDate.getTime() === today.getTime();
        const bIsToday = !bStartDate || bStartDate.getTime() === today.getTime();
        
        // –°–Ω–∞—á–∞–ª–∞ –≤—ã–¥–∞—á–∏ –Ω–∞ —Å–µ–≥–æ–¥–Ω—è
        if (aIsToday && !bIsToday) return -1;
        if (!aIsToday && bIsToday) return 1;
        
        // –ï—Å–ª–∏ –æ–±–∞ –Ω–µ –Ω–∞ —Å–µ–≥–æ–¥–Ω—è, —Å–æ—Ä—Ç–∏—Ä—É–µ–º –ø–æ –∫–æ–ª–∏—á–µ—Å—Ç–≤—É –¥–Ω–µ–π –ø—Ä–æ—Å—Ä–æ—á–∫–∏
        if (!aIsToday && !bIsToday) {
            const aDaysPassed = aStartDate ? differenceInDays(today, aStartDate) : 0;
            const bDaysPassed = bStartDate ? differenceInDays(today, bStartDate) : 0;
            return aDaysPassed - bDaysPassed; // –ú–µ–Ω—å—à–µ –¥–Ω–µ–π –ø—Ä–æ—Å—Ä–æ—á–∫–∏ - –≤—ã—à–µ –≤ —Å–ø–∏—Å–∫–µ
        }
        
        return 0;
    });
};

/**
 * –°–æ—Ä—Ç–∏—Ä—É–µ—Ç –ø—Ä–æ—Å—Ä–æ—á–µ–Ω–Ω—ã–µ –∞—Ä–µ–Ω–¥—ã –ø–æ –∫–æ–ª–∏—á–µ—Å—Ç–≤—É –¥–Ω–µ–π –ø—Ä–æ—Å—Ä–æ—á–∫–∏ (–ø–æ –≤–æ–∑—Ä–∞—Å—Ç–∞–Ω–∏—é)
 */
export const sortOverdueRentalsByDays = (overdueRentals: OverdueRentalItem[]): OverdueRentalItem[] => {
    return [...overdueRentals].sort((a, b) => {
        // –ò—Å–ø–æ–ª—å–∑—É–µ–º days_overdue –µ—Å–ª–∏ –µ—Å—Ç—å, –∏–Ω–∞—á–µ –≤—ã—á–∏—Å–ª—è–µ–º —Ä–∞–∑–Ω–æ—Å—Ç—å
        const aDaysOverdue = a.days_overdue ?? 0;
        const bDaysOverdue = b.days_overdue ?? 0;
        
        return aDaysOverdue - bDaysOverdue; // –ú–µ–Ω—å—à–µ –¥–Ω–µ–π –ø—Ä–æ—Å—Ä–æ—á–∫–∏ - –≤—ã—à–µ –≤ —Å–ø–∏—Å–∫–µ
    });
};

/**
 * –°–æ–∑–¥–∞–µ—Ç —Å–µ–≥–æ–¥–Ω—è—à–Ω—é—é –¥–∞—Ç—É —Å –æ–±–Ω—É–ª–µ–Ω–Ω—ã–º –≤—Ä–µ–º–µ–Ω–µ–º –¥–ª—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–≥–æ —Å—Ä–∞–≤–Ω–µ–Ω–∏—è
 */
export const getTodayDate = (): Date => {
    const today = new Date();
    today.setHours(0, 0, 0, 0);
    return today;
};


```


## <a name="srclibutilsts"></a>`src/lib/utils.ts`

```typescript
// path: src/lib/utils.ts

// src/lib/utils.ts

import { clsx, type ClassValue } from "clsx"
import { twMerge } from "tailwind-merge"

/**
 * –¶–µ–Ω—Ç—Ä–∞–ª–∏–∑–æ–≤–∞–Ω–Ω–æ —Ä–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ—Ç –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ç–∞—Ä–∏—Ñ–∏—Ü–∏—Ä—É–µ–º—ã—Ö –¥–Ω–µ–π (–Ω–æ—á–µ–π), –≤—ã—á–∏—Ç–∞—è –ø—Ä–∞–∑–¥–Ω–∏–∫–∏.
 * @param start - –î–∞—Ç–∞ –Ω–∞—á–∞–ª–∞
 * @param end - –î–∞—Ç–∞ –æ–∫–æ–Ω—á–∞–Ω–∏—è
 * @param holidays - –ú–∞—Å—Å–∏–≤ –¥–∞—Ç, —è–≤–ª—è—é—â–∏—Ö—Å—è –≤—ã—Ö–æ–¥–Ω—ã–º–∏
 * @returns –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ç–∞—Ä–∏—Ñ–∏—Ü–∏—Ä—É–µ–º—ã—Ö –¥–Ω–µ–π.
 */
export function calculateDayCount(
    start?: Date | null,
    end?: Date | null,
    holidays: Date[] = []
): number {
  // –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ—Å—Ç—å –¥–∞—Ç
  if (!start || !end || start >= end) {
    return 0;
  }

  // –°—á–∏—Ç–∞–µ–º –æ–±—â–µ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ "–Ω–æ—á–µ–π"
  const totalDays = Math.round((end.getTime() - start.getTime()) / (1000 * 60 * 60 * 24));

  if (holidays.length === 0) {
    return Math.max(0, totalDays);
  }

  // –°–æ–∑–¥–∞–µ–º –º–Ω–æ–∂–µ—Å—Ç–≤–æ –¥–∞—Ç –ø—Ä–∞–∑–¥–Ω–∏–∫–æ–≤ (–≤ —Ñ–æ—Ä–º–∞—Ç–µ YYYY-MM-DD) –¥–ª—è –±—ã—Å—Ç—Ä–æ–π –ø—Ä–æ–≤–µ—Ä–∫–∏
  const holidaySet = new Set(holidays.map(h => formatDate(h)));

  let nonBillableDays = 0;
  // –ü—Ä–æ–≤–µ—Ä—è–µ–º –∫–∞–∂–¥—ã–π –¥–µ–Ω—å –≤–Ω—É—Ç—Ä–∏ –¥–∏–∞–ø–∞–∑–æ–Ω–∞
  for (let i = 0; i < totalDays; i++) {
    const currentDay = new Date(start);
    currentDay.setDate(start.getDate() + i);

    // –ü—Ä–æ–ø—É—Å–∫–∞–µ–º —Å–∞–º –¥–µ–Ω—å –Ω–∞—á–∞–ª–∞, —Ç–∞–∫ –∫–∞–∫ –ø–æ –ø—Ä–∞–≤–∏–ª–∞–º –æ–Ω —Ç–∞—Ä–∏—Ñ–∏—Ü–∏—Ä—É–µ—Ç—Å—è
    if (i === 0) continue;

    if (holidaySet.has(formatDate(currentDay))) {
      nonBillableDays++;
    }
  }

  return Math.max(0, totalDays - nonBillableDays);
}

/**
 * –£–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç—Ç–µ—Ä –¥–∞—Ç—ã (YYYY-MM-DD)
 * –ü—Ä–∏–Ω–∏–º–∞–µ—Ç Date –∏–ª–∏ —Å—Ç—Ä–æ–∫—É, –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Å—Ç—Ä–æ–∫—É –≤ —Ñ–æ—Ä–º–∞—Ç–µ '2024-05-21'
 * –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–ª—è API –∏ input[type="date"]
 */
export function formatDate(date: Date | string | null | undefined): string {
  if (!date) return "";
  const d = typeof date === "string" ? new Date(date) : date;
  if (isNaN(d.getTime())) return "";
  const year = d.getFullYear();
  const month = String(d.getMonth() + 1).padStart(2, "0");
  const day = String(d.getDate()).padStart(2, "0");
  return `${year}-${month}-${day}`;
}

/**
 * –§–æ—Ä–º–∞—Ç—Ç–µ—Ä –¥–∞—Ç—ã –¥–ª—è UI (–î–î.–ú–ú.–ì–ì–ì–ì)
 * –ü—Ä–∏–Ω–∏–º–∞–µ—Ç Date –∏–ª–∏ —Å—Ç—Ä–æ–∫—É, –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Å—Ç—Ä–æ–∫—É –≤ —Ñ–æ—Ä–º–∞—Ç–µ '21.05.2024'
 * –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ –¥–ª—è –≤—ã–≤–æ–¥–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é!
 */
export function formatDateEuropean(date: Date | string | null | undefined): string {
  if (!date) return "";
  const d = typeof date === "string" ? new Date(date) : date;
  if (isNaN(d.getTime())) return "";
  const day = String(d.getDate()).padStart(2, "0");
  const month = String(d.getMonth() + 1).padStart(2, "0");
  const year = d.getFullYear();
  return `${day}.${month}.${year}`;
}

/**
 * –§–æ—Ä–º–∞—Ç—Ç–µ—Ä –¥–∏–∞–ø–∞–∑–æ–Ω–∞ –¥–∞—Ç –¥–ª—è UI (–Ω–∞–ø—Ä–∏–º–µ—Ä: 21.05.2024 ‚Äî 28.05.2024)
 */
export function formatDateRangeEuropean(start?: Date | string | null, end?: Date | string | null): string {
  if (!start || !end) return "";
  return `${formatDateEuropean(start)} ‚Äî ${formatDateEuropean(end)}`;
}

/**
 * –ë–µ–∑–æ–ø–∞—Å–Ω–æ —Ñ–æ—Ä–º–∞—Ç–∏—Ä—É–µ—Ç —á–∏—Å–ª–æ–≤–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ –≤ —Å—Ç—Ä–æ–∫—É —Å —Ä–∞–∑–¥–µ–ª–∏—Ç–µ–ª—è–º–∏ —Ç—ã—Å—è—á
 * @param value - —á–∏—Å–ª–æ–≤–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ –¥–ª—è —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
 * @param fallback - –∑–Ω–∞—á–µ–Ω–∏–µ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é, –µ—Å–ª–∏ value –Ω–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–æ
 * @returns –æ—Ç—Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–Ω–∞—è —Å—Ç—Ä–æ–∫–∞
 */
export function formatNumber(value: number | null | undefined, fallback: string = "0"): string {
  if (value === null || value === undefined || isNaN(value)) {
    return fallback;
  }
  return value.toLocaleString('ru-RU');
}

/**
 * –£—Ç–∏–ª–∏—Ç–∞ –æ–±—ä–µ–¥–∏–Ω–µ–Ω–∏—è –∫–ª–∞—Å—Å–æ–≤ —Å –ø–æ–¥–¥–µ—Ä–∂–∫–æ–π Tailwind –∏ clsx
 */
export function cn(...inputs: ClassValue[]) {
  return twMerge(clsx(inputs));
}

/**
 * –í—ã—á–∏—Å–ª—è–µ—Ç –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –¥–Ω–µ–π –ø—Ä–æ—Å—Ä–æ—á–∫–∏ –¥–ª—è –∞—Ä–µ–Ω–¥—ã
 * @param dueDate - –î–∞—Ç–∞ –≤–æ–∑–≤—Ä–∞—Ç–∞ (—Å—Ç—Ä–æ–∫–∞ –∏–ª–∏ Date)
 * @param daysOverdue - –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –¥–Ω–µ–π –ø—Ä–æ—Å—Ä–æ—á–∫–∏ —Å –±—ç–∫–µ–Ω–¥–∞ (–µ—Å–ª–∏ –µ—Å—Ç—å)
 * @returns –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –¥–Ω–µ–π –ø—Ä–æ—Å—Ä–æ—á–∫–∏
 */
export function calculateDaysOverdue(dueDate: string | Date | null | undefined, daysOverdue?: number | null): number {
  // –ï—Å–ª–∏ –±—ç–∫–µ–Ω–¥ –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–∏–ª –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –¥–Ω–µ–π –ø—Ä–æ—Å—Ä–æ—á–∫–∏, –∏—Å–ø–æ–ª—å–∑—É–µ–º –µ–≥–æ
  if (daysOverdue !== undefined && daysOverdue !== null) {
    return daysOverdue;
  }
  
  // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ dueDate –≤–∞–ª–∏–¥–µ–Ω
  if (!dueDate) {
    return 0;
  }
  
  // –í—ã—á–∏—Å–ª—è–µ–º –Ω–∞ –∫–ª–∏–µ–Ω—Ç–µ, –µ—Å–ª–∏ –ø–æ–ª–µ –Ω–µ –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª–µ–Ω–æ
  const due = typeof dueDate === "string" ? new Date(dueDate) : dueDate;
  
  // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –¥–∞—Ç–∞ –≤–∞–ª–∏–¥–Ω–∞
  if (isNaN(due.getTime())) {
    return 0;
  }
  
  const today = new Date();
  
  // –°–±—Ä–∞—Å—ã–≤–∞–µ–º –≤—Ä–µ–º—è –¥–ª—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–≥–æ —Å—Ä–∞–≤–Ω–µ–Ω–∏—è –¥–∞—Ç
  today.setHours(0, 0, 0, 0);
  due.setHours(0, 0, 0, 0);
  
  const diffTime = today.getTime() - due.getTime();
  const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
  
  return diffDays > 0 ? diffDays : 0;
}

/**
 * –ü—Ä–µ–æ–±—Ä–∞–∑—É–µ—Ç accessory_links –≤ selected_accessories –¥–ª—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏ —Å –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–∞–º–∏
 * @param reservation - –û–±—ä–µ–∫—Ç —Ä–µ–∑–µ—Ä–≤–∞ —Å accessory_links
 * @returns –û–±—ä–µ–∫—Ç —Ä–µ–∑–µ—Ä–≤–∞ —Å –¥–æ–±–∞–≤–ª–µ–Ω–Ω—ã–º selected_accessories
 */
export function transformAccessoryLinks<T extends { accessory_links?: Array<{ equipment_id: number; accessory: { id: number } }> }>(reservation: T): T & { selected_accessories: Record<number, number[]> } {
  if (!reservation.accessory_links || reservation.accessory_links.length === 0) {
    return { ...reservation, selected_accessories: {} };
  }
  
  const selected_accessories = reservation.accessory_links.reduce((acc, link) => {
    if (!acc[link.equipment_id]) {
      acc[link.equipment_id] = [];
    }
    acc[link.equipment_id].push(link.accessory.id);
    return acc;
  }, {} as Record<number, number[]>);
  
  return { ...reservation, selected_accessories };
}

```


## <a name="srclibvalidationSchemasts"></a>`src/lib/validationSchemas.ts`

```typescript
// path: src/lib/validationSchemas.ts

// src/lib/validationSchemas.ts

import { z } from "zod";
import { USER_ROLE_VALUES } from "@/constants/userConstants";
import { validateRussianPhone } from "@/utils/phoneUtils";

// --- –ê—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è ---
export const authSchema = z.object({
    email: z.string().min(1, "Email –æ–±—è–∑–∞—Ç–µ–ª–µ–Ω").email("–ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π email"),
    password: z.string().min(6, "–ü–∞—Ä–æ–ª—å –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –Ω–µ –º–µ–Ω–µ–µ 6 —Å–∏–º–≤–æ–ª–æ–≤"),
    fullName: z.string().min(2, "–§–ò–û –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å –Ω–µ –∫–æ—Ä–æ—á–µ 2 —Å–∏–º–≤–æ–ª–æ–≤").optional(),
    phone: z.string().optional().refine(val => !val || validateRussianPhone(val), {
        message: "–ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç –Ω–æ–º–µ—Ä–∞ —Ç–µ–ª–µ—Ñ–æ–Ω–∞. –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ —Ñ–æ—Ä–º–∞—Ç: +7 (XXX) XXX-XX-XX",
    }),
    privacyPolicyAccepted: z.boolean().optional(),
    termsAccepted: z.boolean().optional(),
});
export type AuthSchema = z.infer<typeof authSchema>;


// --- –†–µ–∑–µ—Ä–≤—ã ---
// –≠—Ç–∞ Zod-—Å—Ö–µ–º–∞ —Ç–µ–ø–µ—Ä—å —è–≤–ª—è–µ—Ç—Å—è –ï–î–ò–ù–°–¢–í–ï–ù–ù–´–ú –∏—Å—Ç–æ—á–Ω–∏–∫–æ–º –ø—Ä–∞–≤–¥—ã –¥–ª—è —Ç–∏–ø–∞ –¥–∞–Ω–Ω—ã—Ö –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ —Ä–µ–∑–µ—Ä–≤–∞.
export const reservationCreateSchema = z.object({
    user_id: z.number().optional(), // –î–ª—è —Å–æ–∑–¥–∞–Ω–∏—è —Ä–µ–∑–µ—Ä–≤–∞ –∞–¥–º–∏–Ω–æ–º
    equipment_ids: z.array(z.number()).min(1, "–ù–µ–æ–±—Ö–æ–¥–∏–º–æ –≤—ã–±—Ä–∞—Ç—å —Ö–æ—Ç—è –±—ã –æ–¥–Ω–æ –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏–µ –¥–ª—è —Ä–µ–∑–µ—Ä–≤–∞."),
    start_date: z.string().refine((date) => /^\d{4}-\d{2}-\d{2}$/.test(date) && !isNaN(new Date(date).getTime()), {
        message: "–ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω–∞—è –¥–∞—Ç–∞ –Ω–∞—á–∞–ª–∞.",
    }),
    end_date: z.string().refine((date) => /^\d{4}-\d{2}-\d{2}$/.test(date) && !isNaN(new Date(date).getTime()), {
        message: "–ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω–∞—è –¥–∞—Ç–∞ –æ–∫–æ–Ω—á–∞–Ω–∏—è.",
    }),
    selected_accessories: z.record(z.array(z.number())).default({}),
    promo_code: z.string().optional(),
}).refine(data => new Date(data.end_date) > new Date(data.start_date), {
    message: "–î–∞—Ç–∞ –æ–∫–æ–Ω—á–∞–Ω–∏—è –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å –ø–æ–∑–∂–µ –¥–∞—Ç—ã –Ω–∞—á–∞–ª–∞.",
    path: ["end_date"],
});

// –≠–∫—Å–ø–æ—Ä—Ç–∏—Ä—É–µ–º —Ç–∏–ø, —Å–æ–∑–¥–∞–Ω–Ω—ã–π –Ω–∞ –æ—Å–Ω–æ–≤–µ Zod-—Å—Ö–µ–º—ã.
// –¢–µ–ø–µ—Ä—å —ç—Ç–æ—Ç —Ç–∏–ø –±—É–¥–µ—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å—Å—è –≤ —Å–µ—Ä–≤–∏—Å–∞—Ö –∏ —Ö—É–∫–∞—Ö, –≥–∞—Ä–∞–Ω—Ç–∏—Ä—É—è —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ.
export type ReservationCreateInput = z.infer<typeof reservationCreateSchema>;


// --- –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º–∏ (–ê–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å) ---
export const adminUserCreateFormSchema = z.object({
    full_name: z.string().min(2, "–§–ò–û –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ"),
    email: z.string().min(1, "Email –æ–±—è–∑–∞—Ç–µ–ª–µ–Ω").email("–ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π email"),
    password: z.string().min(6, "–ü–∞—Ä–æ–ª—å –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –Ω–µ –º–µ–Ω–µ–µ 6 —Å–∏–º–≤–æ–ª–æ–≤"),
    phone: z.string().optional(),
    role: z.enum(USER_ROLE_VALUES, {
        errorMap: () => ({ message: "–ù–µ–æ–±—Ö–æ–¥–∏–º–æ –≤—ã–±—Ä–∞—Ç—å —Ä–æ–ª—å." })
    }),
    privacyPolicyAccepted: z.boolean(),
    termsAccepted: z.boolean(),
    emailVerified: z.boolean(),
});
export type AdminUserCreateFormSchema = z.infer<typeof adminUserCreateFormSchema>;

export const adminUserUpdateSchema = z.object({
    full_name: z.string().min(2, "–§–ò–û –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ").optional(),
    phone: z.string().optional(),
    status: z.string().optional(),
    notes: z.string().optional(),
    balance: z.coerce.number().optional()
});
export type AdminUserUpdateSchema = z.infer<typeof adminUserUpdateSchema>;

export const adminUserRoleUpdateSchema = z.object({
    role: z.enum(USER_ROLE_VALUES, {
        errorMap: () => ({ message: "–ù–µ–æ–±—Ö–æ–¥–∏–º–æ –≤—ã–±—Ä–∞—Ç—å —Ä–æ–ª—å." })
    })
});
export type AdminUserRoleUpdateSchema = z.infer<typeof adminUserRoleUpdateSchema>;


// --- –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏–µ–º ---
export const equipmentUpdateExtendedSchema = z.object({
    equipment_type: z.string().min(1, "–¢–∏–ø –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—è –Ω–µ –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –ø—É—Å—Ç—ã–º.").optional(),
    brand: z.string().min(1, "–ë—Ä–µ–Ω–¥ –Ω–µ –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –ø—É—Å—Ç—ã–º.").optional(),
    name: z.string().min(1, "–ù–∞–∑–≤–∞–Ω–∏–µ –Ω–µ –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å –ø—É—Å—Ç—ã–º.").optional(),
    serial_number: z.string().nullable().optional(),
    condition: z.string().optional(),
    daily_rate: z.preprocess(
        (val) => (val === "" || val === null || val === undefined) ? undefined : parseFloat(String(val)),
        z.number({ invalid_type_error: "–°—Ç–æ–∏–º–æ—Å—Ç—å –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å —á–∏—Å–ª–æ–º." })
            .positive("–°—Ç–æ–∏–º–æ—Å—Ç—å –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å –ø–æ–ª–æ–∂–∏—Ç–µ–ª—å–Ω—ã–º —á–∏—Å–ª–æ–º.")
            .optional()
    ),
    notes: z.string().nullable().optional(),
    description: z.string().nullable().optional(),
    last_maintenance: z.string().nullable().optional().refine(val => val === null || val === undefined || val === "" || /^\d{4}-\d{2}-\d{2}$/.test(val), {
        message: "–î–∞—Ç–∞ –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ –¢–û –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å –≤ —Ñ–æ—Ä–º–∞—Ç–µ –ì–ì–ì–ì-–ú–ú-–î–î –∏–ª–∏ –æ—Ç—Å—É—Ç—Å—Ç–≤–æ–≤–∞—Ç—å.",
    }).transform(val => (val === "" ? undefined : val)),
    short_description: z.string().nullable().optional(),
    image_url: z.string().nullable().optional(),
    image_urls: z.array(z.string()).optional(),
    accessory_ids: z.array(z.number()).optional(),
});
export type EquipmentUpdateExtendedSchema = z.infer<typeof equipmentUpdateExtendedSchema>;


// --- –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∞–∫—Å–µ—Å—Å—É–∞—Ä–∞–º–∏ ---
export const accessorySchema = z.object({
    name: z.string().min(2, { message: "–ù–∞–∑–≤–∞–Ω–∏–µ –¥–æ–ª–∂–Ω–æ —Å–æ–¥–µ—Ä–∂–∞—Ç—å –º–∏–Ω–∏–º—É–º 2 —Å–∏–º–≤–æ–ª–∞." }),
    accessory_type: z.string().optional(),
    price: z.preprocess(
        (value) => (value === "" ? undefined : value),
        z.coerce.number({ invalid_type_error: "–¶–µ–Ω–∞ –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å —á–∏—Å–ª–æ–º." })
            .min(0, { message: "–¶–µ–Ω–∞ –Ω–µ –º–æ–∂–µ—Ç –±—ã—Ç—å –æ—Ç—Ä–∏—Ü–∞—Ç–µ–ª—å–Ω–æ–π." })
            .optional()
    ),
    description: z.string().optional(),
});
export type AccessorySchema = z.infer<typeof accessorySchema>;


// --- –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø—Ä–æ–º–æ–∫–æ–¥–∞–º–∏ ---
export const promoCodeFormSchema = z.object({
    code: z.string().min(3, "–ö–æ–¥ –¥–æ–ª–∂–µ–Ω —Å–æ–¥–µ—Ä–∂–∞—Ç—å –º–∏–Ω–∏–º—É–º 3 —Å–∏–º–≤–æ–ª–∞").max(50),
    description: z.string().optional(),
    discount_percentage: z.coerce.number({ invalid_type_error: "–°–∫–∏–¥–∫–∞ –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å —á–∏—Å–ª–æ–º" })
        .min(1, "–°–∫–∏–¥–∫–∞ –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å –±–æ–ª—å—à–µ 0")
        .max(50, "–ú–∞–∫—Å–∏–º–∞–ª—å–Ω–∞—è —Å–∫–∏–¥–∫–∞ 50%"),
    is_active: z.boolean().default(true),
    valid_from: z.date().optional(),
    expires_at: z.date().optional(),
    max_uses: z.preprocess(
        (val) => (val === "" || val === null || val === undefined) ? undefined : parseInt(String(val), 10),
        z.number().positive("–ó–Ω–∞—á–µ–Ω–∏–µ –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å –±–æ–ª—å—à–µ 0").optional()
    ),
    max_uses_per_user: z.preprocess(
        (val) => (val === "" || val === null || val === undefined) ? undefined : parseInt(String(val), 10),
        z.number().positive("–ó–Ω–∞—á–µ–Ω–∏–µ –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å –±–æ–ª—å—à–µ 0").optional()
    ),
    min_order_amount: z.preprocess(
        (val) => (val === "" || val === null || val === undefined) ? undefined : parseFloat(String(val)),
        z.number().positive("–ó–Ω–∞—á–µ–Ω–∏–µ –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å –±–æ–ª—å—à–µ 0").optional()
    ),
    applicable_to_equipment_ids: z.array(z.number()).optional(),
    applicable_to_equipment_types: z.array(z.string()).optional(),
    specific_to_user_id: z.coerce.number().optional(),
}).refine(data => {
    if (data.valid_from && data.expires_at) {
        return data.expires_at >= data.valid_from;
    }
    return true;
}, {
    message: "–î–∞—Ç–∞ –æ–∫–æ–Ω—á–∞–Ω–∏—è –Ω–µ –º–æ–∂–µ—Ç –±—ã—Ç—å —Ä–∞–Ω—å—à–µ –¥–∞—Ç—ã –Ω–∞—á–∞–ª–∞",
    path: ["expires_at"],
});
export type PromoCodeFormData = z.infer<typeof promoCodeFormSchema>;

// +++ –ù–ê–ß–ê–õ–û: –ù–æ–≤–∞—è —Å—Ö–µ–º–∞ –¥–ª—è —Ñ–æ—Ä–º—ã –ø–æ–ø–æ–ª–Ω–µ–Ω–∏—è –±–∞–ª–∞–Ω—Å–∞ +++
export const userPaymentSchema = z.object({
    amount: z.coerce
        .number({ invalid_type_error: "–°—É–º–º–∞ –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å —á–∏—Å–ª–æ–º" })
        .positive("–°—É–º–º–∞ –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å –±–æ–ª—å—à–µ –Ω—É–ª—è"),
    payment_method: z.string().min(1, "–ù–µ–æ–±—Ö–æ–¥–∏–º–æ –≤—ã–±—Ä–∞—Ç—å –º–µ—Ç–æ–¥ –æ–ø–ª–∞—Ç—ã"),
    description: z.string().optional(),
});
export type UserPaymentSchema = z.infer<typeof userPaymentSchema>;
// +++ –ö–û–ù–ï–¶: –ù–æ–≤–∞—è —Å—Ö–µ–º–∞ +++

```


## <a name="srcmaintsx"></a>`src/main.tsx`

```tsx
// path: src/main.tsx

// src/main.tsx

import React from "react";
import ReactDOM from "react-dom/client";
import {BrowserRouter} from "react-router-dom";
import App from "./app/App";

// 1. –°–ù–ê–ß–ê–õ–ê –∏–º–ø–æ—Ä—Ç–∏—Ä—É–µ–º —Å—Ç–∏–ª–∏ –±–∏–±–ª–∏–æ—Ç–µ–∫–∏
import 'react-day-picker/dist/style.css';

// 2. –ü–û–¢–û–ú –∏–º–ø–æ—Ä—Ç–∏—Ä—É–µ–º –Ω–∞—à–∏ —Å–æ–±—Å—Ç–≤–µ–Ω–Ω—ã–µ —Å—Ç–∏–ª–∏ –¥–ª—è –∏—Ö –ø–µ—Ä–µ–æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è
import "./index.css";

import {QueryClientProvider} from "@tanstack/react-query";
import {queryClient} from "./lib/queryClient";
import {ReactQueryDevtools} from "@tanstack/react-query-devtools";
import ErrorBoundary from "./components/ErrorBoundary";
import NetworkStatus from "./components/NetworkStatus";

ReactDOM.createRoot(document.getElementById("root")!).render(
    <React.StrictMode>
        <QueryClientProvider client={queryClient}>
            <ErrorBoundary>
                <BrowserRouter>
                    <App/>
                    <NetworkStatus/>
                </BrowserRouter>
            </ErrorBoundary>
            <ReactQueryDevtools initialIsOpen={false}/>
        </QueryClientProvider>
    </React.StrictMode>
);

```


## <a name="srcpagesAccessoryManagementPagetsx"></a>`src/pages/AccessoryManagementPage.tsx`

```tsx
// path: src/pages/AccessoryManagementPage.tsx

// src/pages/AccessoryManagementPage.tsx

import AdminNavigation from "@/components/admin/AdminNavigation";
// ‚úÖ –ò–ú–ü–û–†–¢–ò–†–£–ï–ú –†–ï–ê–õ–¨–ù–´–ô –ö–û–ú–ü–û–ù–ï–ù–¢
import AccessoryTable from "@/components/admin/AccessoryTable";
import { Button } from "@/components/ui/button";
import { Shield, Paperclip } from "lucide-react";
import { useNavigate } from "react-router-dom";
import { useCurrentUser } from "@/hooks/useProfile";

export default function AccessoryManagementPage() {
    const { data: currentUser } = useCurrentUser();
    const navigate = useNavigate();
    const isManager = currentUser?.role === "manager" || currentUser?.role === "admin";

    if (!isManager) {
        return (
            <div className="max-w-4xl mx-auto px-4 py-8 text-center">
                <Shield className="w-16 h-16 text-gray-400 mx-auto mb-4" />
                <h1 className="text-2xl font-bold text-gray-900 mb-2">–î–æ—Å—Ç—É–ø –æ–≥—Ä–∞–Ω–∏—á–µ–Ω</h1>
                <p className="text-gray-600 mb-4">
                    –£ –≤–∞—Å –Ω–µ—Ç –ø—Ä–∞–≤ –¥–ª—è –¥–æ—Å—Ç—É–ø–∞ –∫ —ç—Ç–æ–º—É —Ä–∞–∑–¥–µ–ª—É.
                </p>
                <Button onClick={() => navigate("/")}>–ù–∞ –≥–ª–∞–≤–Ω—É—é</Button>
            </div>
        );
    }

    return (
        <div className="max-w-7xl mx-auto px-4 py-6 space-y-6">
            <AdminNavigation />
            <div className="flex items-center gap-3">
                <Paperclip className="w-8 h-8 text-purple-600" />
                <div>
                    <h1 className="text-3xl font-bold text-gray-900">
                        –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∞–∫—Å–µ—Å—Å—É–∞—Ä–∞–º–∏
                    </h1>
                    <p className="text-gray-600 mt-1">
                        –î–æ–±–∞–≤–ª–µ–Ω–∏–µ, —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∏ —É–¥–∞–ª–µ–Ω–∏–µ –∞–∫—Å–µ—Å—Å—É–∞—Ä–æ–≤.
                    </p>
                </div>
            </div>
            <div className="bg-white rounded-lg border shadow-sm p-6">
                {/* ‚úÖ –ó–ê–ú–ï–ù–Ø–ï–ú –ó–ê–ì–õ–£–®–ö–£ –ù–ê –ö–û–ú–ü–û–ù–ï–ù–¢ */}
                <AccessoryTable />
            </div>
        </div>
    );
}

```


## <a name="srcpagesCalendarPagetsx"></a>`src/pages/CalendarPage.tsx`

```tsx
// path: src/pages/CalendarPage.tsx

// src/pages/CalendarPage.tsx

import { useEffect, useState, useMemo, useCallback } from "react";
import { useDateStore } from "@/store/dateStore";
import { useEquipment } from "@/hooks/useEquipment";
import { useAllEquipment } from "@/hooks/useAllEquipment"; // ++ 1. –ò–º–ø–æ—Ä—Ç–∏—Ä—É–µ–º —Ö—É–∫ –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –≤—Å–µ—Ö –¥–∞–Ω–Ω—ã—Ö –¥–ª—è —Ñ–∏–ª—å—Ç—Ä–æ–≤
import CalendarFiltersBlock from "@/components/calendar/CalendarFiltersBlock";
import CalendarTable from "@/components/calendar/CalendarTable";
import { useCalendarSelectionStore } from "@/store/calendarSelectionStore";
import { Button } from "@/components/ui/button";
import { Home, ArrowLeft, Loader2 } from "lucide-react";
import { useNavigate } from "react-router-dom";

export default function CalendarPage() {
    const { setRange } = useDateStore();
    const { setSelectedGroupId } = useCalendarSelectionStore();
    const navigate = useNavigate();

    // -- –£–¥–∞–ª—è–µ–º –Ω–µ–∏—Å–ø–æ–ª—å–∑—É–µ–º—ã–π currentUser --

    const [typeFilter, setTypeFilter] = useState<string | null>(null);
    const [brandFilter, setBrandFilter] = useState<string | null>(null);
    const [searchText, setSearchText] = useState<string>("");
    const [isLoadingAll, setIsLoadingAll] = useState(false);

    // ++ 2. –ü–æ–ª—É—á–∞–µ–º –ü–û–õ–ù–´–ô —Å–ø–∏—Å–æ–∫ –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—è –û–î–ò–ù —Ä–∞–∑ –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –æ–ø—Ü–∏–π –≤ —Ñ–∏–ª—å—Ç—Ä–∞—Ö ++
    const { data: allEquipmentForFilters = [] } = useAllEquipment();

    // ++ 3. –ü–æ–ª—É—á–∞–µ–º –ü–ê–ì–ò–ù–ò–†–û–í–ê–ù–ù–´–ô –∏ —É–∂–µ –æ—Ç—Ñ–∏–ª—å—Ç—Ä–æ–≤–∞–Ω–Ω—ã–π —Å–µ—Ä–≤–µ—Ä–æ–º —Å–ø–∏—Å–æ–∫ –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –≤ —Ç–∞–±–ª–∏—Ü–µ ++
    const {
        data: equipmentPages,
        fetchNextPage,
        hasNextPage,
        isFetchingNextPage
    } = useEquipment({
        type: typeFilter,
        brand: brandFilter,
        query: searchText
    });

    const paginatedAndFilteredEquipment = useMemo(() => equipmentPages?.pages.flatMap(page => page.items) ?? [], [equipmentPages]);

    // ++ 4. –û–±–æ—Ä–∞—á–∏–≤–∞–µ–º —Ñ—É–Ω–∫—Ü–∏—é –≤ useCallback –∏ –¥–æ–±–∞–≤–ª—è–µ–º –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ useEffect, —á—Ç–æ–±—ã –∏—Å–ø—Ä–∞–≤–∏—Ç—å –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ ++
    const resetToDefaultRange = useCallback(() => {
        const today = new Date();
        const expectedStart = new Date(today);
        expectedStart.setDate(today.getDate() - 3);
        const expectedEnd = new Date(today);
        expectedEnd.setDate(today.getDate() + 13);
        setRange(expectedStart, expectedEnd);
    }, [setRange]);

    useEffect(() => {
        resetToDefaultRange();
    }, [resetToDefaultRange]);

    const handleResetAll = () => {
        resetToDefaultRange();
        setTypeFilter(null);
        setBrandFilter(null);
        setSearchText("");
        setSelectedGroupId(null);
    };

    const handleLoadAll = () => {
        setIsLoadingAll(true);
    };

    useEffect(() => {
        if (isLoadingAll && hasNextPage && !isFetchingNextPage) {
            // ++ 5. –î–æ–±–∞–≤–ª—è–µ–º `void` —á—Ç–æ–±—ã –∏—Å–ø—Ä–∞–≤–∏—Ç—å –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ –æ –Ω–µ–∏—Å–ø–æ–ª—å–∑—É–µ–º–æ–º Promise ++
            void fetchNextPage();
        }
        if (isLoadingAll && !hasNextPage && !isFetchingNextPage) {
            setIsLoadingAll(false);
        }
    }, [isLoadingAll, hasNextPage, isFetchingNextPage, fetchNextPage]);

    return (
        <div className="p-4 space-y-4">
            <div className="flex justify-between items-center mb-4">
                <div className="flex gap-2">
                    <Button variant="outline" onClick={() => navigate(-1)} className="flex items-center gap-2">
                        <ArrowLeft className="w-4 h-4" /> –ù–∞–∑–∞–¥
                    </Button>
                    <Button variant="outline" onClick={() => navigate("/")} className="flex items-center gap-2">
                        <Home className="w-4 h-4" /> –ù–∞ –≥–ª–∞–≤–Ω—É—é
                    </Button>
                </div>
            </div>

            <div className="flex flex-wrap gap-4 p-4 bg-white rounded-lg border shadow-sm mb-4">
                <div className="flex items-center gap-2"><div className="w-4 h-4 bg-emerald-50 rounded"></div><span className="text-sm">–°–≤–æ–±–æ–¥–Ω–æ</span></div>
                <div className="flex items-center gap-2"><div className="w-4 h-4 bg-amber-300 rounded"></div><span className="text-sm">–†–µ–∑–µ—Ä–≤</span></div>
                <div className="flex items-center gap-2"><div className="w-4 h-4 bg-rose-400 rounded"></div><span className="text-sm">–ê—Ä–µ–Ω–¥–∞</span></div>
                {/* –ü—Ä–æ–≤–µ—Ä–∫—É –Ω–∞ currentUser –º–æ–∂–Ω–æ —É–±—Ä–∞—Ç—å, –µ—Å–ª–∏ –æ–Ω–∞ –±–æ–ª—å—à–µ –Ω–∏–≥–¥–µ –Ω–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è, –ª–∏–±–æ –æ—Å—Ç–∞–≤–∏—Ç—å –¥–ª—è –±—É–¥—É—â–∏—Ö —Ä–∞—Å—à–∏—Ä–µ–Ω–∏–π */}
                <div className="flex items-center gap-2"><div className="w-4 h-4 bg-amber-500 rounded"></div><span className="text-sm">–ú–æ–π —Ä–µ–∑–µ—Ä–≤</span></div>
            </div>

            {/* ++ 6. –ü–µ—Ä–µ–¥–∞–µ–º –ü–û–õ–ù–´–ô —Å–ø–∏—Å–æ–∫ –≤ –±–ª–æ–∫ —Ñ–∏–ª—å—Ç—Ä–æ–≤ –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –≤—Å–µ—Ö –æ–ø—Ü–∏–π ++ */}
            <CalendarFiltersBlock
                equipment={allEquipmentForFilters}
                typeFilter={typeFilter}
                setTypeFilter={setTypeFilter}
                brandFilter={brandFilter}
                setBrandFilter={setBrandFilter}
                searchText={searchText}
                setSearchText={setSearchText}
                onReset={handleResetAll}
            />
            {/* ++ 7. –ü–µ—Ä–µ–¥–∞–µ–º –ü–ê–ì–ò–ù–ò–†–û–í–ê–ù–ù–´–ô —Å–ø–∏—Å–æ–∫ –≤ —Ç–∞–±–ª–∏—Ü—É –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è ++ */}
            <CalendarTable equipment={paginatedAndFilteredEquipment} />

            {hasNextPage && (
                <div className="flex justify-center items-center gap-4 mt-4">
                    <Button variant="outline" onClick={() => fetchNextPage()} disabled={isFetchingNextPage || isLoadingAll}>
                        {isFetchingNextPage && !isLoadingAll ? (
                            <><Loader2 className="mr-2 h-4 w-4 animate-spin" /> –ó–∞–≥—Ä—É–∑–∫–∞...</>
                        ) : ( "–ó–∞–≥—Ä—É–∑–∏—Ç—å –µ—â—ë" )}
                    </Button>
                    <Button variant="secondary" onClick={handleLoadAll} disabled={isFetchingNextPage || isLoadingAll}>
                        {isLoadingAll ? (
                            <><Loader2 className="mr-2 h-4 w-4 animate-spin" /> –ó–∞–≥—Ä—É–∑–∫–∞ –≤—Å–µ—Ö...</>
                        ) : ( "–ó–∞–≥—Ä—É–∑–∏—Ç—å –≤—Å—ë" )}
                    </Button>
                </div>
            )}
        </div>
    );
}

```


## <a name="srcpagesCalendarTestPagetsx"></a>`src/pages/CalendarTestPage.tsx`

```tsx
// path: src/pages/CalendarTestPage.tsx

// src/pages/CalendarTestPage.tsx
// –≠—Ç–æ—Ç —Ñ–∞–π–ª —Å–æ–¥–µ—Ä–∂–∏—Ç –ø–æ–ª–Ω—ã–π –∫–æ–¥ –¥–ª—è —Å—Ç—Ä–∞–Ω–∏—Ü—ã —Å –∫–∞—Å—Ç–æ–º–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–º –∫–∞–ª–µ–Ω–¥–∞—Ä—ë–º.

import { useState } from 'react';
import { DayPicker, type DateRange } from 'react-day-picker';
import { ru } from 'date-fns/locale'; // –ò–º–ø–æ—Ä—Ç–∏—Ä—É–µ–º —Ä—É—Å—Å–∫—É—é –ª–æ–∫–∞–ª—å –¥–ª—è –Ω–∞–∑–≤–∞–Ω–∏–π

export default function CalendarTestPage() {
    // –õ–æ–∫–∞–ª—å–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ –¥–∏–∞–ø–∞–∑–æ–Ω–∞ –¥–∞—Ç
    const [range, setRange] = useState<DateRange | undefined>();

    return (
        // –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –¥–ª—è —Ü–µ–Ω—Ç—Ä–∏—Ä–æ–≤–∞–Ω–∏—è –∫–∞–ª–µ–Ω–¥–∞—Ä—è –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–µ
        <div className="p-10 bg-gray-100 min-h-screen flex flex-col items-center justify-center">
            <h1 className="text-3xl font-bold text-gray-800 text-center mb-6">
                –¢–µ—Å—Ç–æ–≤—ã–π –∫–∞–ª–µ–Ω–¥–∞—Ä—å —Å –∫—Ä–∞—Å–Ω—ã–º –≤—ã–¥–µ–ª–µ–Ω–∏–µ–º
            </h1>

            <div className="bg-white p-4 rounded-lg shadow-lg border">
                <DayPicker
                    mode="range"
                    locale={ru} // –ò—Å–ø–æ–ª—å–∑—É–µ–º —Ä—É—Å—Å–∫—É—é –ª–æ–∫–∞–ª—å
                    selected={range}
                    onSelect={setRange}
                    numberOfMonths={2}
                    showOutsideDays
                    // –°—Ç–∏–ª–∏ –¥–ª—è –æ—Å–Ω–æ–≤–Ω—ã—Ö —ç–ª–µ–º–µ–Ω—Ç–æ–≤ –∫–∞–ª–µ–Ω–¥–∞—Ä—è, –≤–∑—è—Ç—ã–µ –∏–∑ –≤–∞—à–µ–≥–æ –ø—Ä–æ–µ–∫—Ç–∞
                    classNames={{
                        months: 'flex flex-col sm:flex-row space-y-4 sm:space-x-4 sm:space-y-0',
                        month: 'space-y-4',
                        table: 'w-full border-collapse space-y-1',
                        head_row: 'flex',
                        head_cell: 'text-muted-foreground rounded-md w-9 font-normal text-[0.8rem]',
                        row: 'flex w-full mt-2',
                        cell: 'h-9 w-9 text-center text-sm p-0 relative [&:has([aria-selected])]:bg-accent first:[&:has([aria-selected])]:rounded-l-md last:[&:has([aria-selected])]:rounded-r-md focus-within:relative focus-within:z-20',
                        day: 'h-9 w-9 p-0 font-normal aria-selected:opacity-100',
                        nav: 'space-x-1 flex items-center',
                        caption: 'flex justify-center pt-1 relative items-center',
                        caption_label: 'text-sm font-medium',
                        nav_button: 'h-7 w-7 bg-transparent p-0 opacity-50 hover:opacity-100'
                    }}
                    // –°—Ç–∏–ª–∏ –¥–ª—è —Å–æ—Å—Ç–æ—è–Ω–∏–π –¥–Ω–µ–π (–º–æ–¥–∏—Ñ–∏–∫–∞—Ç–æ—Ä–æ–≤)
                    modifiersClassNames={{
                        today: 'bg-accent text-accent-foreground',
                        // –°–∏–Ω–∏–µ —Ü–≤–µ—Ç–∞ –¥–ª—è –≤—ã–±—Ä–∞–Ω–Ω—ã—Ö –¥–∞—Ç
                        selected: 'bg-sky-600 text-white hover:bg-sky-600 hover:text-white focus:bg-sky-600 focus:text-white',
                        // –°–∫—Ä—É–≥–ª–µ–Ω–∏—è –¥–ª—è –Ω–∞—á–∞–ª–∞ –∏ –∫–æ–Ω—Ü–∞ –¥–∏–∞–ø–∞–∑–æ–Ω–∞
                        range_start: 'rounded-l-full',
                        range_end: 'rounded-r-full',
                        range_middle: 'aria-selected:bg-sky-100 aria-selected:text-sky-900',
                        outside: 'day-outside text-muted-foreground opacity-50',
                        disabled: 'text-muted-foreground opacity-50',
                    }}
                />
            </div>
            <div className="mt-4 p-4 bg-white rounded-lg shadow-lg border text-sm text-gray-700">
                <p>–í—ã–±—Ä–∞–Ω–Ω—ã–π –¥–∏–∞–ø–∞–∑–æ–Ω:</p>
                {range?.from ? (
                    <pre className="mt-2 font-mono">{JSON.stringify(range, null, 2)}</pre>
                ) : (
                    <p className="text-gray-500 italic mt-1">–ù–∏—á–µ–≥–æ –Ω–µ –≤—ã–±—Ä–∞–Ω–æ</p>
                )}
            </div>
        </div>
    );
}

```


## <a name="srcpagesContactPagetsx"></a>`src/pages/ContactPage.tsx`

```tsx
// path: src/pages/ContactPage.tsx

// src/pages/ContactPage.tsx
import { Button } from "@/components/ui/button"
import { useNavigate, useLocation } from "react-router-dom"

export default function ContactPage() {
    const navigate = useNavigate()
    const location = useLocation()

    const backTo = location.state?.from || -1

    const telegramBot = "d30manager"
    const message = encodeURIComponent(
        "–ó–¥—Ä–∞–≤—Å—Ç–≤—É–π—Ç–µ, —è —Ö–æ—á—É –æ—Ç–º–µ–Ω–∏—Ç—å —Ä–µ–∑–µ—Ä–≤. –î–æ –µ–≥–æ –æ–∫–æ–Ω—á–∞–Ω–∏—è –æ—Å—Ç–∞–ª–æ—Å—å –º–µ–Ω–µ–µ 2 –¥–Ω–µ–π."
    )
    const telegramLink = `https://t.me/${telegramBot}?start=${message}`

    return (
        <div className="max-w-2xl mx-auto px-4 py-6 sm:py-8 space-y-6">
            <h1 className="text-2xl font-bold text-center sm:text-left">–°–≤—è–∑—å —Å –º–µ–Ω–µ–¥–∂–µ—Ä–æ–º</h1>

            <p className="text-sm text-gray-700">
                –ï—Å–ª–∏ –≤—ã —Ö–æ—Ç–∏—Ç–µ –æ—Ç–º–µ–Ω–∏—Ç—å —Ä–µ–∑–µ—Ä–≤, –¥–æ –æ–∫–æ–Ω—á–∞–Ω–∏—è –∫–æ—Ç–æ—Ä–æ–≥–æ –æ—Å—Ç–∞–ª–æ—Å—å –º–µ–Ω–µ–µ 2-—Ö –¥–Ω–µ–π,
                –ø–æ–∂–∞–ª—É–π—Å—Ç–∞, —Å–≤—è–∂–∏—Ç–µ—Å—å —Å –Ω–∞–º–∏ –ª—é–±—ã–º —É–¥–æ–±–Ω—ã–º —Å–ø–æ—Å–æ–±–æ–º:
            </p>

            <ul className="text-sm text-gray-800 list-disc list-inside space-y-1">
                <li>Email:{" "}
                    <a href="mailto:info@digital30.ru" className="text-sky-600 hover:underline">
                        info@digital30.ru
                    </a>
                </li>
                <li>–¢–µ–ª–µ—Ñ–æ–Ω: <span className="font-semibold">+7 (908) 6177177</span></li>
                <li>Telegram:{" "}
                    <a href={`https://t.me/${telegramBot}`} className="text-sky-600 hover:underline">
                        @{telegramBot}
                    </a>
                </li>
            </ul>

            <div className="flex flex-col sm:flex-row gap-3 pt-4 sm:pt-6">
                <Button
                    onClick={() => window.open(telegramLink, "_blank")}
                    variant="default"
                    className="w-full sm:w-auto"
                >
                    üí¨ –ù–∞–ø–∏—Å–∞—Ç—å –≤ Telegram
                </Button>

                <Button
                    variant="outline"
                    onClick={() => typeof backTo === "string" ? navigate(backTo) : navigate(-1)}
                    className="w-full sm:w-auto"
                >
                    ‚Üê –í–µ—Ä–Ω—É—Ç—å—Å—è –Ω–∞–∑–∞–¥
                </Button>
            </div>
        </div>
    )
}


```


## <a name="srcpagesEquipmentManagementPagetsx"></a>`src/pages/EquipmentManagementPage.tsx`

```tsx
// path: src/pages/EquipmentManagementPage.tsx

// src/pages/EquipmentManagementPage.tsx

import { useState, useEffect, useMemo } from "react";
import { useCurrentUser } from "@/hooks/useProfile";
import AdminNavigation from "@/components/admin/AdminNavigation";
import EquipmentTable from "@/components/admin/EquipmentTable";
import EquipmentEditDialog from "@/components/admin/EquipmentEditDialog";
import { Button } from "@/components/ui/button";
import { Shield, Package } from "lucide-react";
import { useNavigate } from "react-router-dom";
import type { Equipment } from "@/types/equipment";
import { useEquipment } from "@/hooks/useEquipment";
import type { EquipmentListResponse } from "@/core/services/EquipmentService";

export default function EquipmentManagementPage() {
    const { data: currentUser } = useCurrentUser();
    const navigate = useNavigate();

    // ‚úÖ –ò–ó–ú–ï–ù–ï–ù–ò–ï: –ü–æ–ª—É—á–∞–µ–º –∏–∑ —Ö—É–∫–∞ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –¥–ª—è –ø–∞–≥–∏–Ω–∞—Ü–∏–∏
    const {
        data: equipmentPages,
        fetchNextPage,
        hasNextPage,
        isFetchingNextPage
    } = useEquipment();

    // "–†–∞—Å–ø–ª—é—â–∏–≤–∞–µ–º" —Å—Ç—Ä–∞–Ω–∏—Ü—ã –≤ –æ–¥–∏–Ω –æ–±—â–∏–π –º–∞—Å—Å–∏–≤ —Å –ø–æ–º–æ—â—å—é useMemo
    const allEquipment = useMemo(() =>
            equipmentPages?.pages.flatMap((page: EquipmentListResponse) => page.items) ?? [],
        [equipmentPages]);

    const [selectedEquipment, setSelectedEquipment] = useState<Equipment | null>(null);
    const [showEditDialog, setShowEditDialog] = useState(false);

    const isAdmin = currentUser?.role === "admin";
    const isManager = currentUser?.role === "manager" || isAdmin;

    useEffect(() => {
        if (!showEditDialog) {
            document.body.style.overflow = '';
        }
    }, [showEditDialog]);

    if (!isManager) {
        return (
            <div className="max-w-4xl mx-auto px-4 py-8">
                <div className="text-center">
                    <Shield className="w-16 h-16 text-gray-400 mx-auto mb-4" />
                    <h1 className="text-2xl font-bold text-gray-900 mb-2">
                        –î–æ—Å—Ç—É–ø –æ–≥—Ä–∞–Ω–∏—á–µ–Ω
                    </h1>
                    <p className="text-gray-600 mb-4">
                        –£ –≤–∞—Å –Ω–µ—Ç –ø—Ä–∞–≤ –¥–ª—è –¥–æ—Å—Ç—É–ø–∞ –∫ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—é –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏–µ–º.
                    </p>
                    <Button onClick={() => navigate("/")}>
                        –ù–∞ –≥–ª–∞–≤–Ω—É—é
                    </Button>
                </div>
            </div>
        );
    }

    const handleEditEquipment = (equipment: Equipment) => {
        setSelectedEquipment(equipment);
        setShowEditDialog(true);
    };

    const handleCloseDialog = () => {
        setShowEditDialog(false);
        setSelectedEquipment(null);
    };

    return (
        <div className="max-w-7xl mx-auto px-4 py-6 space-y-6">
            <AdminNavigation />

            <div className="flex items-center justify-between">
                <div className="flex items-center gap-3">
                    <Package className="w-8 h-8 text-green-600" />
                    <div>
                        <h1 className="text-3xl font-bold text-gray-900">
                            –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏–µ–º
                        </h1>
                        <p className="text-gray-600 mt-1">
                            –î–æ–±–∞–≤–ª–µ–Ω–∏–µ, —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∏ —É–¥–∞–ª–µ–Ω–∏–µ –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—è –¥–ª—è –∞—Ä–µ–Ω–¥—ã
                        </p>
                    </div>
                </div>
            </div>

            <div className="bg-white rounded-lg border shadow-sm p-6">
                {/* ‚úÖ –ò–ó–ú–ï–ù–ï–ù–ò–ï: –ü–µ—Ä–µ–¥–∞–µ–º –Ω–æ–≤—ã–µ —Å–≤–æ–π—Å—Ç–≤–∞ –¥–ª—è –ø–∞–≥–∏–Ω–∞—Ü–∏–∏ –≤ —Ç–∞–±–ª–∏—Ü—É */}
                <EquipmentTable
                    onEditEquipment={handleEditEquipment}
                    equipment={allEquipment}
                    onLoadMore={fetchNextPage}
                    hasNextPage={hasNextPage}
                    isFetchingNextPage={isFetchingNextPage}
                />
            </div>

            {/* –ë–ª–æ–∫–∏ —Å —Å–æ–≤–µ—Ç–∞–º–∏ –∏ —Å–æ—Å—Ç–æ—è–Ω–∏—è–º–∏ –æ—Å—Ç–∞—é—Ç—Å—è –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π */}
            <div className="bg-blue-50 border border-blue-200 rounded-lg p-4">
                <h3 className="font-semibold text-blue-900 mb-3">üí° –ü–æ–ª–µ–∑–Ω—ã–µ —Å–æ–≤–µ—Ç—ã</h3>
                <div className="grid grid-cols-1 md:grid-cols-2 gap-4 text-sm text-blue-800">
                    <div>
                        <p className="font-medium mb-2">–î–æ–±–∞–≤–ª–µ–Ω–∏–µ –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—è:</p>
                        <ul className="space-y-1">
                            <li>‚Ä¢ –£–∫–∞–∑—ã–≤–∞–π—Ç–µ –ø–æ–¥—Ä–æ–±–Ω–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ –¥–ª—è –∫–ª–∏–µ–Ω—Ç–æ–≤</li>
                            <li>‚Ä¢ –î–æ–±–∞–≤–ª—è–π—Ç–µ —Å–µ—Ä–∏–π–Ω—ã–µ –Ω–æ–º–µ—Ä–∞ –¥–ª—è —É—á–µ—Ç–∞</li>
                            <li>‚Ä¢ –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–π—Ç–µ –∞–∫—Ç—É–∞–ª—å–Ω—ã–µ —Ç–∞—Ä–∏—Ñ—ã</li>
                        </ul>
                    </div>
                    <div>
                        <p className="font-medium mb-2">–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ:</p>
                        <ul className="space-y-1">
                            <li>‚Ä¢ –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –ø–æ–∏—Å–∫ –¥–ª—è –±—ã—Å—Ç—Ä–æ–≥–æ –Ω–∞—Ö–æ–∂–¥–µ–Ω–∏—è</li>
                            <li>‚Ä¢ –í—ã–¥–µ–ª—è–π—Ç–µ –Ω–µ—Å–∫–æ–ª—å–∫–æ —ç–ª–µ–º–µ–Ω—Ç–æ–≤ –¥–ª—è –º–∞—Å—Å–æ–≤—ã—Ö –æ–ø–µ—Ä–∞—Ü–∏–π</li>
                            <li>‚Ä¢ –†–µ–≥—É–ª—è—Ä–Ω–æ –æ–±–Ω–æ–≤–ª—è–π—Ç–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—è</li>
                        </ul>
                    </div>
                </div>
            </div>
            <div className="bg-gray-50 rounded-lg p-4">
                <h3 className="font-semibold text-gray-900 mb-3">–°–æ—Å—Ç–æ—è–Ω–∏—è –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—è</h3>
                <div className="grid grid-cols-2 md:grid-cols-5 gap-3 text-sm">
                    <div className="bg-green-100 text-green-800 p-2 rounded text-center">
                        <div className="font-medium">–í–µ–ª–∏–∫–æ–ª–µ–ø–Ω–æ</div>
                        <div className="text-xs">–ö–∞–∫ –Ω–æ–≤–æ–µ</div>
                    </div>
                    <div className="bg-blue-100 text-blue-800 p-2 rounded text-center">
                        <div className="font-medium">–û—Ç–ª–∏—á–Ω–æ</div>
                        <div className="text-xs">–ú–∏–Ω–∏–º–∞–ª—å–Ω—ã–π –∏–∑–Ω–æ—Å</div>
                    </div>
                    <div className="bg-yellow-100 text-yellow-800 p-2 rounded text-center">
                        <div className="font-medium">–•–æ—Ä–æ—à–æ</div>
                        <div className="text-xs">–ù–µ–±–æ–ª—å—à–∏–µ –ø–æ—Ç–µ—Ä—Ç–æ—Å—Ç–∏</div>
                    </div>
                    <div className="bg-orange-100 text-orange-800 p-2 rounded text-center">
                        <div className="font-medium">–£–¥–æ–≤–ª–µ—Ç–≤–æ—Ä–∏—Ç–µ–ª—å–Ω–æ</div>
                        <div className="text-xs">–ó–∞–º–µ—Ç–Ω—ã–π –∏–∑–Ω–æ—Å</div>
                    </div>
                    <div className="bg-red-100 text-red-800 p-2 rounded text-center">
                        <div className="font-medium">–¢—Ä–µ–±—É–µ—Ç —Ä–µ–º–æ–Ω—Ç–∞</div>
                        <div className="text-xs">–ù–µ —Å–¥–∞–µ—Ç—Å—è</div>
                    </div>
                </div>
            </div>

            {selectedEquipment && (
                <EquipmentEditDialog
                    open={showEditDialog}
                    onClose={handleCloseDialog}
                    equipment={selectedEquipment}
                />
            )}
        </div>
    );
}

```


## <a name="srcpagesHomePagetsx"></a>`src/pages/HomePage.tsx`

```tsx
// path: src/pages/HomePage.tsx

// src/pages/HomePage.tsx

import { useEffect, useRef, useState, useMemo } from "react";
import { useNavigate, useLocation } from "react-router-dom";
import { useReserveStore } from "@/store/reserveStore";
import { X } from "lucide-react";

// –ö–æ–º–ø–æ–Ω–µ–Ω—Ç—ã
import AuthStatus from "@/components/AuthStatus";
import DateRangeSelector from "@/components/DateRangeSelector";
import DiscountCalculator from "@/components/DiscountCalculator";
import ReservationFooter from "@/components/ReservationFooter";
import EquipmentCatalog from "@/components/catalog/EquipmentCatalog";
import UserSession from "@/components/session/UserSession";
import { Button } from "@/components/ui/button";

// –•—É–∫–∏
import { useReservationManagement } from "@/hooks/useReservationManagement";
import { useDateStore } from "@/store/dateStore";
import { useHolidayStore } from "@/store/holidayStore";
import { useEquipmentData } from "@/hooks/data/useEquipmentData";
import { useAppFilters } from "@/hooks/features/useAppFilters";

export default function HomePage() {
    const navigate = useNavigate();
    const location = useLocation();
    const containerRef = useRef<HTMLDivElement>(null);
    const { clearItemsOnly, items: selectedItems = [] } = useReserveStore();
    
    // –ü–æ–ª—É—á–∞–µ–º –Ω—É–∂–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –∏ —Ñ—É–Ω–∫—Ü–∏–∏ –∏–∑ —Ö—Ä–∞–Ω–∏–ª–∏—â
    const { setRange, initializeDates } = useDateStore();
    const { holidays, fetchHolidays } = useHolidayStore();
    const [datesInitialized, setDatesInitialized] = useState(false);

    // –ü–æ–ª—É—á–∞–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ —Ñ–∏–ª—å—Ç—Ä–æ–≤ –¥–ª—è –ø–µ—Ä–µ–¥–∞—á–∏ –≤ EquipmentCatalog
    const { query, type, brand, availableOnly, associationId, startDate, endDate } = useAppFilters();

    // –ü–æ–ª—É—á–∞–µ–º –¥–∞–Ω–Ω—ã–µ –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—è –¥–ª—è useReservationManagement
    const {
        equipment,
        availabilityData,
    } = useEquipmentData({ query, type, brand, associationId, availableOnly, startDate, endDate });

    // –°–æ–∑–¥–∞–µ–º availabilityMap –∏–∑ availabilityData –¥–ª—è useReservationManagement
    const availabilityMap = useMemo(() => {
        const map: Record<number, any> = {};
        availabilityData?.forEach((info) => {
            map[info.equipment_id] = info;
        });
        return map;
    }, [availabilityData]);

    // –ü–æ–ª—É—á–∞–µ–º –ª–æ–≥–∏–∫—É —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è —Ä–µ–∑–µ—Ä–≤–∞–º–∏
    const {
        editingReservationId,
        intent,
    } = useReservationManagement(equipment, availabilityMap, availableOnly);

    // +++ –ù–ê–ß–ê–õ–û: –î–û–ë–ê–í–õ–ï–ù–ê –õ–û–ì–ò–ö–ê –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–ò –î–ê–¢ +++
    // 1. –ó–∞–≥—Ä—É–∂–∞–µ–º –≤—ã—Ö–æ–¥–Ω—ã–µ –ø—Ä–∏ –º–æ–Ω—Ç–∏—Ä–æ–≤–∞–Ω–∏–∏ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–∞
    useEffect(() => {
        const today = new Date();
        const futureDate = new Date();
        futureDate.setDate(today.getDate() + 30); // –ó–∞–≥—Ä—É–∂–∞–µ–º –Ω–∞ 30 –¥–Ω–µ–π –≤–ø–µ—Ä–µ–¥
        fetchHolidays(today, futureDate);
    }, [fetchHolidays]);

    // 2. –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –¥–∞—Ç—ã, –∫–∞–∫ —Ç–æ–ª—å–∫–æ –≤—ã—Ö–æ–¥–Ω—ã–µ –∑–∞–≥—Ä—É–∂–µ–Ω—ã
    useEffect(() => {
        // –í—ã–ø–æ–ª–Ω—è–µ–º —Ç–æ–ª—å–∫–æ –æ–¥–∏–Ω —Ä–∞–∑, –∫–æ–≥–¥–∞ –ø–æ—è–≤–∏–ª–∏—Å—å –¥–∞–Ω–Ω—ã–µ –æ –≤—ã—Ö–æ–¥–Ω—ã—Ö
        if (holidays.length > 0 && !datesInitialized) {
            initializeDates(holidays);
            setDatesInitialized(true);
        }
    }, [holidays, initializeDates, datesInitialized]);
    // +++ –ö–û–ù–ï–¶ +++

    // –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –¥–∞—Ç –∏–∑ —Å–æ—Å—Ç–æ—è–Ω–∏—è –Ω–∞–≤–∏–≥–∞—Ü–∏–∏
    useEffect(() => {
        const start = (location.state as any)?.startDate;
        const end = (location.state as any)?.endDate;
        if (start && end) {
            const startDate = new Date(start);
            const endDate = new Date(end);
            setRange(startDate, endDate, 'manual', holidays); // –ü–µ—Ä–µ–¥–∞–µ–º –ø—Ä–∞–∑–¥–Ω–∏–∫–∏ –¥–ª—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–≥–æ —Ä–∞—Å—á–µ—Ç–∞
        }
    }, [location.state, setRange, holidays]);

    const handleCompleteAddition = () => {
        const { addToReservationMode } = useReserveStore.getState();
        if (addToReservationMode) {
            navigate(location.state?.from || "/reservations/my", {
                replace: true,
                state: {
                    continueEditing: addToReservationMode,
                },
            });
        } else {
            navigate("/reserve/create");
        }
    };

    const handleCancelAddition = () => {
        useReserveStore.getState().clear();
        navigate("/reservations/my", {
            replace: true,
            state: {
                continueEditing: editingReservationId,
            },
        });
    };

    return (
        <div className="bg-gray-50 min-h-screen">
            <div ref={containerRef} className="max-w-7xl mx-auto px-4 py-6 space-y-4 pb-20">
                <AuthStatus />
                <UserSession />

                {editingReservationId && (
                    <div className="flex items-center justify-between p-3 bg-sky-100 border border-sky-300 text-sky-700 rounded-md text-sm shadow">
                        <span>
                            –í—ã –¥–æ–±–∞–≤–ª—è–µ—Ç–µ –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏–µ –∫ —Ä–µ–∑–µ—Ä–≤—É <strong>#{editingReservationId}</strong>. –ö–æ–≥–¥–∞ –∑–∞–∫–æ–Ω—á–∏—Ç–µ, –Ω–∞–∂–º–∏—Ç–µ –∫–Ω–æ–ø–∫—É –≤–Ω–∏–∑—É —Å—Ç—Ä–∞–Ω–∏—Ü—ã.
                        </span>
                        <Button
                            variant="ghost"
                            size="sm"
                            onClick={handleCancelAddition}
                            className="text-sky-700 hover:bg-sky-200 hover:text-sky-800 flex-shrink-0"
                        >
                            <X className="w-4 h-4 mr-1.5" />
                            –û—Ç–º–µ–Ω–∏—Ç—å –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ
                        </Button>
                    </div>
                )}

                <h1 className="text-2xl font-bold mt-4 text-center">–ö–∞—Ç–∞–ª–æ–≥ –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—è</h1>

                <DateRangeSelector containerRef={containerRef} />
                <DiscountCalculator />

                <EquipmentCatalog 
                    editingReservationId={editingReservationId}
                    intent={intent}
                />
            </div>

            <ReservationFooter
                selectedCount={selectedItems.length}
                onClick={handleCompleteAddition}
                onReset={clearItemsOnly}
                isEditingMode={!!editingReservationId}
                intent={intent || ''}
            />
        </div>
    );
}

```


## <a name="srcpagesMyReservationsPagetsx"></a>`src/pages/MyReservationsPage.tsx`

```tsx
// path: src/pages/MyReservationsPage.tsx

// src/pages/MyReservationsPage.tsx
import { useState, useEffect, useMemo } from "react";
import { useNavigate, useLocation } from "react-router-dom";
import { Button } from "@/components/ui/button";
import { ToggleGroup, ToggleGroupItem } from "@/components/ui/toggle-group";
import MyReservationList from "../components/MyReservationList";
import { useCurrentUser } from "@/hooks/useProfile";
import UserInfoBlock from "@/components/UserInfoBlock";
import { useMyRentals } from "@/hooks/useMyRentals";
import MyRentalsList from "@/components/rental/MyRentalsList";
import { ClipboardList, Truck } from "lucide-react";
import OrderToolbar from "@/components/shared/OrderToolbar";
import { useOrderFilterStore } from "@/store/orderFilterStore";
import { useReservations } from "@/hooks/useReservations";

interface MyReservationsLocationState {
    from?: string;
    continueEditing?: number;
    highlightRentalId?: number;
    highlightReservationId?: number;
}

export default function MyReservationsPage() {
    const { data: user, isLoading } = useCurrentUser();
    const navigate = useNavigate();
    const location = useLocation();

    const [activeTab, setActiveTab] = useState<'reservations' | 'rentals'>('reservations');
    const [highlightId, setHighlightId] = useState<number | null>(null);

    const locationState = location.state as MyReservationsLocationState | null;

    const cameFrom = locationState?.from;
    const continueEditingReservationId = locationState?.continueEditing;

    // –ü–æ–ª—É—á–∞–µ–º –ø–∞—Ä–∞–º–µ—Ç—Ä—ã —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏ –∏–∑ —Å—Ç–æ—Ä–∞
    const { searchQuery, statusFilter, sortOption } = useOrderFilterStore();

    // –û–ø—Ä–µ–¥–µ–ª—è–µ–º –∫–æ–Ω—Ç–µ–∫—Å—Ç –¥–ª—è OrderToolbar
    const toolbarContext = useMemo(() => {
        return activeTab === 'reservations' ? 'user-reservations' : 'user-rentals';
    }, [activeTab]);

    // –ü–æ–¥–≥–æ—Ç–∞–≤–ª–∏–≤–∞–µ–º –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –¥–ª—è API –∑–∞–ø—Ä–æ—Å–æ–≤
    const apiParams = useMemo(() => ({
        search: searchQuery || undefined,
        status: statusFilter === 'all' ? undefined : statusFilter,
        sort: sortOption
    }), [searchQuery, statusFilter, sortOption]);

    // –ü–æ–ª—É—á–∞–µ–º –¥–∞–Ω–Ω—ã–µ —Å —Å–µ—Ä–≤–µ—Ä–Ω–æ–π —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–µ–π
    const { reservationsQuery } = useReservations(apiParams);
    const { data: rentalsData } = useMyRentals(apiParams);

    useEffect(() => {
        const { highlightRentalId, highlightReservationId } = locationState || {};
        if (highlightRentalId) {
            setActiveTab('rentals');
            setHighlightId(highlightRentalId);
        } else if (highlightReservationId) {
            setActiveTab('reservations');
            setHighlightId(highlightReservationId);
        }
    }, [locationState]);

    useEffect(() => {
        // –°–±—Ä–æ—Å –ø–æ–¥—Å–≤–µ—Ç–∫–∏ —á–µ—Ä–µ–∑ –Ω–µ–∫–æ—Ç–æ—Ä–æ–µ –≤—Ä–µ–º—è
        if (highlightId) {
            const timer = setTimeout(() => {
                setHighlightId(null);
                navigate(location.pathname, { replace: true, state: {} });
            }, 2500);
            return () => clearTimeout(timer);
        }
    }, [highlightId, navigate, location.pathname]);

    useEffect(() => {
        if (continueEditingReservationId) {
            console.log(`[MyReservationsPage] Processing return from equipment addition to reservation #${continueEditingReservationId}`);
        }
    }, [continueEditingReservationId]);

    if (isLoading) {
        return (
            <p className="text-center mt-12 text-sm text-gray-500">
                –ó–∞–≥—Ä—É–∑–∫–∞ –ø—Ä–æ—Ñ–∏–ª—è...
            </p>
        );
    }

    if (!user) {
        return (
            <div className="text-center mt-12">
                <p className="text-lg">
                    –¢–æ–ª—å–∫–æ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –º–æ–≥—É—Ç –ø—Ä–æ—Å–º–∞—Ç—Ä–∏–≤–∞—Ç—å —Å–≤–æ–∏ —Ä–µ–∑–µ—Ä–≤—ã.
                </p>
                <Button className="mt-4" onClick={() => navigate("/reserve/create")}>
                    –í–æ–π—Ç–∏ –∏ –æ—Ñ–æ—Ä–º–∏—Ç—å —Ä–µ–∑–µ—Ä–≤
                </Button>
            </div>
        );
    }

    const handleEditProfile = () => {
        navigate("/profile", { state: { from: location.pathname } });
    };

    return (
        <div className="max-w-4xl mx-auto px-4 py-6 space-y-6">
            <div className="mb-6">
                <UserInfoBlock onEditProfile={handleEditProfile} />
            </div>

            <div className="flex items-center justify-between">
                <h1 className="text-2xl font-bold">–ú–æ–∏ –∑–∞–∫–∞–∑—ã</h1>
                <div className="flex items-center gap-3">
                    <Button variant="secondary" onClick={() => navigate(cameFrom || "/")}>
                        ‚Üê –ù–∞–∑–∞–¥
                    </Button>
                    <Button variant="outline" onClick={() => navigate("/")}>
                        –ù–∞ –≥–ª–∞–≤–Ω—É—é
                    </Button>
                </div>
            </div>

            {/* –í–∫–ª–∞–¥–∫–∏ */}
            <ToggleGroup
                type="single"
                value={activeTab}
                onValueChange={(value) => { if (value) setActiveTab(value as any); }}
                className="w-full"
            >
                <ToggleGroupItem value="reservations" className="w-1/2 data-[state=on]:bg-sky-100 data-[state=on]:text-sky-800">
                    <ClipboardList className="w-4 h-4 mr-2" />
                    –†–µ–∑–µ—Ä–≤—ã
                </ToggleGroupItem>
                <ToggleGroupItem value="rentals" className="w-1/2 data-[state=on]:bg-orange-100 data-[state=on]:text-orange-800">
                    <Truck className="w-4 h-4 mr-2" />
                    –ê—Ä–µ–Ω–¥—ã
                </ToggleGroupItem>
            </ToggleGroup>

            {/* –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–∏ —Ä–µ–∑–µ—Ä–≤–∞ */}
            {continueEditingReservationId && activeTab === 'reservations' && (
                <div className="p-3 bg-sky-100 border border-sky-300 text-sky-700 rounded-md text-sm">
                    –í—ã –≤–µ—Ä–Ω—É–ª–∏—Å—å –∫ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—é —Ä–µ–∑–µ—Ä–≤–∞ #{continueEditingReservationId}. –í—ã–±—Ä–∞–Ω–Ω—ã–µ –ø–æ–∑–∏—Ü–∏–∏ –¥–æ–±–∞–≤–ª–µ–Ω—ã.
                </div>
            )}

            {/* –¢—É–ª–±–∞—Ä —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏ */}
            <OrderToolbar context={toolbarContext} showHideCompletedCheckbox={true} />

            {/* –£—Å–ª–æ–≤–Ω—ã–π —Ä–µ–Ω–¥–µ—Ä–∏–Ω–≥ —Å–ø–∏—Å–∫–æ–≤ */}
            <div>
                {activeTab === 'reservations' ? (
                    <MyReservationList
                        continueEditingReservationId={continueEditingReservationId}
                        highlightId={highlightId}
                        reservationsData={reservationsQuery.data}
                        isLoading={reservationsQuery.isLoading}
                        isError={reservationsQuery.isError}
                    />
                ) : (
                    <MyRentalsList 
                        highlightId={highlightId}
                        rentalsData={rentalsData}
                    />
                )}
            </div>
        </div>
    );
}

```


## <a name="srcpagesProfilePagetsx"></a>`src/pages/ProfilePage.tsx`

```tsx
// path: src/pages/ProfilePage.tsx

// src/pages/ProfilePage.tsx

import { useState, useEffect } from "react"
import { Input } from "@/components/ui/input"
import { Label } from "@/components/ui/label"
import { Button } from "@/components/ui/button"
import { useNavigate, useLocation } from "react-router-dom"
import { useProfileUpdate, useCurrentUser } from "@/hooks/useProfile"
import { useAuthStore } from "@/store/authStore"
import { toast } from "sonner"
import { PhoneInput } from "@/components/ui/phone-input"
import { Alert, AlertDescription } from "@/components/ui/alert"
import { AlertCircle, CheckCircle } from "lucide-react"
// ‚úÖ 1. –ò–º–ø–æ—Ä—Ç–∏—Ä—É–µ–º –Ω–∞—à –Ω–æ–≤—ã–π –∫–æ–º–ø–æ–Ω–µ–Ω—Ç –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –∏—Å—Ç–æ—Ä–∏–∏
import BalanceHistoryTable from "@/components/profile/BalanceHistoryTable";

// –§—É–Ω–∫—Ü–∏—è –≤–∞–ª–∏–¥–∞—Ü–∏–∏ —Ç–µ–ª–µ—Ñ–æ–Ω–∞
const validatePhone = (phone: string): boolean => {
    if (!phone) return true; // –ü—É—Å—Ç–æ–π —Ç–µ–ª–µ—Ñ–æ–Ω —Ä–∞–∑—Ä–µ—à–µ–Ω
    return /^\+7 \(\d{3}\) \d{3}-\d{2}-\d{2}$/.test(phone);
};

export default function ProfilePage() {
    const navigate = useNavigate()
    const location = useLocation()
    const { logout } = useAuthStore()

    const backTo = location.state?.from || "/"

    const { data: user, isLoading } = useCurrentUser()
    const updateProfile = useProfileUpdate()

    const [fullName, setFullName] = useState("")
    const [email, setEmail] = useState("")
    const [phone, setPhone] = useState("")
    const [emailChanged, setEmailChanged] = useState(false)
    const [originalEmail, setOriginalEmail] = useState("")
    const [showEmailWarning, setShowEmailWarning] = useState(false)

    useEffect(() => {
        if (user) {
            setFullName(user.full_name)
            setEmail(user.email)
            setPhone(user.phone || "")
            setOriginalEmail(user.email)
        }
    }, [user])

    // –û—Ç—Å–ª–µ–∂–∏–≤–∞–µ–º –∏–∑–º–µ–Ω–µ–Ω–∏—è email
    useEffect(() => {
        if (originalEmail && email !== originalEmail) {
            setEmailChanged(true)
            setShowEmailWarning(true)
        } else {
            setEmailChanged(false)
            setShowEmailWarning(false)
        }
    }, [email, originalEmail])

    const handleUpdate = async (e: React.FormEvent) => {
        e.preventDefault()

        // –í–∞–ª–∏–¥–∞—Ü–∏—è —Ç–µ–ª–µ—Ñ–æ–Ω–∞
        if (!validatePhone(phone)) {
            toast.error("–ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç –Ω–æ–º–µ—Ä–∞ —Ç–µ–ª–µ—Ñ–æ–Ω–∞")
            return
        }

        try {
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –∏–∑–º–µ–Ω–∏–ª—Å—è –ª–∏ email
            const emailChanged = user && email !== user.email;

            await updateProfile.mutateAsync({ full_name: fullName, email, phone }) // <<< –ò–ó–ú–ï–ù–ï–ù–ò–ï: –ü–µ—Ä–µ–¥–∞–µ–º —Ç–µ–ª–µ—Ñ–æ–Ω
            toast.success("–ü—Ä–æ—Ñ–∏–ª—å —É—Å–ø–µ—à–Ω–æ –æ–±–Ω–æ–≤–ª—ë–Ω")

            // <<< –ò–ó–ú–ï–ù–ï–ù–ò–ï: –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ-–∑–∞–≥–ª—É—à–∫—É, –µ—Å–ª–∏ email –±—ã–ª –∏–∑–º–µ–Ω–µ–Ω
            if (emailChanged) {
                toast.info("–ù–∞ –≤–∞—à—É –Ω–æ–≤—É—é –ø–æ—á—Ç—É –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∞ —Å—Å—ã–ª–∫–∞ –¥–ª—è –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è (—Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª –≤ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ).")
                // –í –±—É–¥—É—â–µ–º –∑–¥–µ—Å—å –º–æ–∂–Ω–æ –±—É–¥–µ—Ç —Å–±—Ä–æ—Å–∏—Ç—å email –≤ —Ñ–æ—Ä–º–µ –æ–±—Ä–∞—Ç–Ω–æ –Ω–∞ —Å—Ç–∞—Ä—ã–π,
                // –ø–æ–∫–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –ø–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç –Ω–æ–≤—ã–π.
            }

        } catch (err) {
            console.error(err)
            toast.error("–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ –ø—Ä–æ—Ñ–∏–ª—è")
        }
    }

    if (isLoading) {
        return <p className="text-center mt-12 text-gray-500">–ó–∞–≥—Ä—É–∑–∫–∞...</p>
    }

    if (!user) {
        return (
            <div className="text-center mt-12">
                <p className="text-lg">–í—ã –Ω–µ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω—ã.</p>
                <Button className="mt-4" onClick={() => navigate("/")}>
                    –ù–∞ –≥–ª–∞–≤–Ω—É—é
                </Button>
            </div>
        )
    }

    return (
        // ‚úÖ 2. –£–≤–µ–ª–∏—á–∏–≤–∞–µ–º –º–∞–∫—Å–∏–º–∞–ª—å–Ω—É—é —à–∏—Ä–∏–Ω—É –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞, —á—Ç–æ–±—ã —Ç–∞–±–ª–∏—Ü–∞ –ø–æ–º–µ—Å—Ç–∏–ª–∞—Å—å
        <div className="max-w-4xl mx-auto px-4 py-8 space-y-6">
            <div className="bg-white border rounded-lg shadow-sm p-6 space-y-4">
                <h1 className="text-xl font-bold text-center">–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –ø—Ä–æ—Ñ–∏–ª—å</h1>

                <form onSubmit={handleUpdate} className="space-y-4">
                    <div>
                        <Label htmlFor="fullName">–§–ò–û</Label>
                        <Input
                            id="fullName"
                            type="text"
                            value={fullName}
                            onChange={(e) => setFullName(e.target.value)}
                            required
                        />
                    </div>

                    <div>
                        <Label htmlFor="email">Email</Label>
                        <Input
                            id="email"
                            type="email"
                            value={email}
                            onChange={(e) => setEmail(e.target.value)}
                            required
                        />
                    </div>

                    {/* +++ –ù–ê–ß–ê–õ–û: –ù–æ–≤–æ–µ –ø–æ–ª–µ –¥–ª—è —Ç–µ–ª–µ—Ñ–æ–Ω–∞ +++ */}
                    <div>
                        <Label htmlFor="phone">–¢–µ–ª–µ—Ñ–æ–Ω</Label>
                        <PhoneInput
                            id="phone"
                            value={phone}
                            onChange={(e) => setPhone(e.target.value)}
                            placeholder="+7 (___) ___-__-__"
                        />
                    </div>
                    {/* +++ –ö–û–ù–ï–¶: –ù–æ–≤–æ–µ –ø–æ–ª–µ –¥–ª—è —Ç–µ–ª–µ—Ñ–æ–Ω–∞ +++ */}

                    {showEmailWarning && (
                        <Alert>
                            <AlertCircle className="h-4 w-4" />
                            <AlertDescription>
                                –ü–æ—Å–ª–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è email –ø–æ—Ç—Ä–µ–±—É–µ—Ç—Å—è –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –Ω–æ–≤–æ–≥–æ –∞–¥—Ä–µ—Å–∞.
                                –ù–∞ —É–∫–∞–∑–∞–Ω–Ω—É—é –ø–æ—á—Ç—É –±—É–¥–µ—Ç –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∞ —Å—Å—ã–ª–∫–∞ –¥–ª—è –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è.
                            </AlertDescription>
                        </Alert>
                    )}

                    <div className="flex justify-between items-center pt-2">
                        <Button type="submit" disabled={updateProfile.isPending}>
                            {updateProfile.isPending ? "–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ..." : "–°–æ—Ö—Ä–∞–Ω–∏—Ç—å"}
                        </Button>
                        <Button type="button" variant="ghost" onClick={() => navigate(backTo)}>
                            –ù–∞–∑–∞–¥
                        </Button>
                    </div>
                </form>

                <div className="pt-4 border-t text-center space-y-2">
                    <p className="text-xs text-gray-500">
                        –î–ª—è –∏–∑–º–µ–Ω–µ–Ω–∏—è –ø–∞—Ä–æ–ª—è –æ–±—Ä–∞—Ç–∏—Ç–µ—Å—å –∫ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—É.
                    </p>
                    <Button
                        variant="link"
                        className="text-red-600"
                        onClick={() => {
                            logout()
                            navigate("/")
                        }}
                    >
                        –í—ã–π—Ç–∏ –∏–∑ –∞–∫–∫–∞—É–Ω—Ç–∞
                    </Button>
                </div>
            </div>

            {/* ‚úÖ 3. –î–æ–±–∞–≤–ª—è–µ–º –Ω–æ–≤—ã–π –±–ª–æ–∫ —Å –∏—Å—Ç–æ—Ä–∏–µ–π –±–∞–ª–∞–Ω—Å–∞ */}
            <div className="bg-white border rounded-lg shadow-sm p-6 space-y-4">
                <h2 className="text-xl font-bold">–ò—Å—Ç–æ—Ä–∏—è –±–∞–ª–∞–Ω—Å–∞</h2>
                <BalanceHistoryTable userId={user.id} />
            </div>
        </div>
    )
}

```


## <a name="srcpagesReservePagetsx"></a>`src/pages/ReservePage.tsx`

```tsx
// path: src/pages/ReservePage.tsx

// src/pages/ReservePage.tsx
import { useNavigate, useLocation } from "react-router-dom";
import { useState, useMemo } from "react";
import AuthForm from "@/components/AuthForm";
import UserInfoBlock from "@/components/UserInfoBlock";
import CancelReservationDialog from "@/components/CancelReservationDialog";
import { Button } from "@/components/ui/button";
import { useReserveSubmission } from "@/hooks/reservation/submission/useReserveSubmission";
import { formatDate } from "@/lib/utils";
import { ShoppingCart } from "lucide-react";

import ReservationItemsList from "@/components/reservation/ReservationItemsList";
import FinancialSummaryBlock from "@/components/shared/FinancialSummaryBlock";

export default function ReservePage() {
    const navigate = useNavigate();
    const location = useLocation();

    const {
        items,
        user,
        startDate,
        endDate,
        setStartDate,
        setEndDate,
        availabilityMap,
        unavailableIdsFromAPI,
        invalidItems,
        submitMessage,
        reservationSuccess,
        clearReserveStore,
        removeItemFromStore,
        isAccessorySelected,
        toggleAccessory,
        isLoadingAvailability,
        isSubmitting,
        isApplyingPromoCode,
        priceDetails,
        accessoriesDailyTotal,
        promoCode,
        promoCodeMessage,
        applyPromoCode,
        setPromoCode,
        removePromoCode,
        handleSubmit,
        selectedAccessories,
    } = useReserveSubmission();

    const [showCancelDialog, setShowCancelDialog] = useState(false);

    const handleConfirmCancel = () => {
        clearReserveStore();
        navigate("/");
    };

    const isFormValid = useMemo(() => {
        return !!(user && invalidItems.length === 0 && unavailableIdsFromAPI.length === 0);
    }, [user, invalidItems.length, unavailableIdsFromAPI.length]);

    // ‚úÖ –î–û–ë–ê–í–õ–ï–ù–û: –†–∞—Å—á–µ—Ç –º–∏–Ω–∏–º–∞–ª—å–Ω–æ–π –¥–∞—Ç—ã –¥–ª—è –ø–æ–ª—è "–ö–æ–Ω–µ—Ü"
    const minEndDate = useMemo(() => {
        const nextDay = new Date(startDate);
        nextDay.setDate(startDate.getDate() + 1);
        return formatDate(nextDay);
    }, [startDate]);

    if (items.length === 0 && !reservationSuccess) {
        return (
            <div className="text-center mt-12 p-4">
                <ShoppingCart className="mx-auto h-16 w-16 text-gray-300" />
                <p className="mt-4 text-lg text-gray-700">–í–∞—à–∞ –∫–æ—Ä–∑–∏–Ω–∞ –ø—É—Å—Ç–∞.</p>
                <p className="mt-1 text-sm text-gray-500">–í—ã –µ—â–µ –Ω–µ –≤—ã–±—Ä–∞–ª–∏ –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏–µ –¥–ª—è —Ä–µ–∑–µ—Ä–≤–∞.</p>
                <Button
                    variant="default"
                    className="mt-6"
                    onClick={() => navigate("/", { state: { intent: "add_to_new_reservation" } })}
                >
                    –ü–µ—Ä–µ–π—Ç–∏ –∫ –≤—ã–±–æ—Ä—É –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—è
                </Button>
            </div>
        );
    }

    if (reservationSuccess) {
        return (
            <div className="text-center pt-8 space-y-4 p-6 bg-green-50 rounded-lg border border-green-200 max-w-3xl mx-auto">
                <p className="text-xl font-semibold text-green-700">‚úÖ –†–µ–∑–µ—Ä–≤ —É—Å–ø–µ—à–Ω–æ —Å–æ–∑–¥–∞–Ω!</p>
                {submitMessage && (<p className="text-sm text-green-600">{submitMessage}</p>)}
                <div className="flex gap-3 justify-center">
                    <Button variant="outline" onClick={() => navigate("/")}>–ù–∞ –≥–ª–∞–≤–Ω—É—é</Button>
                    <Button variant="default" onClick={() => navigate("/reservations/my")}>–ö –º–æ–∏–º —Ä–µ–∑–µ—Ä–≤–∞–º</Button>
                </div>
            </div>
        );
    }

    return (
        <>
            <div className="max-w-3xl mx-auto px-4 py-6 space-y-6">
                <div className="flex items-center justify-between">
                    <h1 className="text-2xl font-bold">–û—Ñ–æ—Ä–º–ª–µ–Ω–∏–µ —Ä–µ–∑–µ—Ä–≤–∞</h1>
                    <button
                        onClick={() => navigate("/", { state: { intent: "add_to_new_reservation" } })}
                        className="text-sm text-sky-600 hover:underline"
                    >
                        ‚Üê –í–µ—Ä–Ω—É—Ç—å—Å—è –∫ –≤—ã–±–æ—Ä—É
                    </button>
                </div>

                {!user ? <AuthForm /> : <UserInfoBlock onEditProfile={() => navigate("/profile", { state: { from: location.pathname } })} />}

                <div className="p-4 border rounded-md shadow-sm bg-white">
                    <h2 className="text-lg font-semibold mb-3 text-gray-700">–î–∞—Ç—ã —Ä–µ–∑–µ—Ä–≤–∞:</h2>
                    <div className="flex flex-col sm:flex-row justify-center items-center gap-4">
                        <div className="flex flex-col items-start w-full sm:w-auto">
                            <label htmlFor="start-date" className="text-sm text-gray-600 mb-1">–ù–∞—á–∞–ª–æ:</label>
                            <input id="start-date" type="date" className="border rounded px-3 py-1 text-sm shadow-sm w-full focus:ring-sky-500 focus:border-sky-500"
                                   value={formatDate(startDate)}
                                   onChange={(e) => { const d = new Date(e.target.value); if(!isNaN(d.getTime())) setStartDate(d); }}
                                   min={formatDate(new Date())} />
                        </div>
                        <div className="flex flex-col items-start w-full sm:w-auto">
                            <label htmlFor="end-date" className="text-sm text-gray-600 mb-1">–ö–æ–Ω–µ—Ü:</label>
                            <input id="end-date" type="date" className="border rounded px-3 py-1 text-sm shadow-sm w-full focus:ring-sky-500 focus:border-sky-500"
                                   value={formatDate(endDate)}
                                   onChange={(e) => { const d = new Date(e.target.value); if(!isNaN(d.getTime())) setEndDate(d); }}
                                // ‚úÖ –ò–ó–ú–ï–ù–ï–ù–ò–ï: –£—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ –º–∏–Ω–∏–º–∞–ª—å–Ω–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ –¥–ª—è –ø–æ–ª—è
                                   min={minEndDate} />
                        </div>
                    </div>
                </div>

                {isLoadingAvailability && <p className="text-center text-gray-500 py-3">–ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏...</p>}

                <ReservationItemsList
                    items={items}
                    selectedAccessories={selectedAccessories}
                    availabilityMap={availabilityMap}
                    unavailableIdsFromAPI={unavailableIdsFromAPI}
                    invalidItems={invalidItems}
                    onRemoveItem={removeItemFromStore}
                    onRemoveAccessory={toggleAccessory}
                    isAccessorySelected={isAccessorySelected}
                    onToggleAccessory={toggleAccessory}
                />

                <FinancialSummaryBlock
                    priceDetails={priceDetails}
                    accessoriesDailyTotal={accessoriesDailyTotal}
                    promoCode={promoCode}
                    setPromoCode={setPromoCode}
                    applyPromoCode={applyPromoCode}
                    removePromoCode={removePromoCode}
                    promoCodeMessage={promoCodeMessage}
                    isLoading={isLoadingAvailability}
                    isApplyingPromoCode={isApplyingPromoCode}
                    isSubmitting={isSubmitting}
                    isFormValid={isFormValid}
                    onCancel={() => setShowCancelDialog(true)}
                    onAddMore={() => navigate("/", { state: { intent: "add_to_new_reservation" } })}
                    onSubmit={handleSubmit}
                    variant="default"
                    showActions={true}
                />
            </div>

            <CancelReservationDialog
                open={showCancelDialog}
                onClose={() => setShowCancelDialog(false)}
                onConfirm={handleConfirmCancel}
            />
        </>
    );
}

```


## <a name="srcpagesUserManagementPagetsx"></a>`src/pages/UserManagementPage.tsx`

```tsx
// path: src/pages/UserManagementPage.tsx

// src/pages/UserManagementPage.tsx

import { useMemo } from "react";
import { useCurrentUser } from "@/hooks/useProfile";
import { useAdminUsers } from "@/hooks/useAdminUsers";
import AdminNavigation from "@/components/admin/AdminNavigation";
import UserTable from "@/components/admin/UserTable";
import { Button } from "@/components/ui/button";
import { Shield, Users } from "lucide-react";
import { useNavigate } from "react-router-dom";

export default function UserManagementPage() {
    const { data: currentUser } = useCurrentUser();
    const navigate = useNavigate();
    
    // –ü–æ–ª—É—á–∞–µ–º –¥–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π —Å –ø–∞–≥–∏–Ω–∞—Ü–∏–µ–π
    const {
        data: usersData,
        isLoading,
        error,
        fetchNextPage,
        hasNextPage,
        isFetchingNextPage,
    } = useAdminUsers();

    // –û–±—ä–µ–¥–∏–Ω—è–µ–º –≤—Å–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã –≤ –æ–¥–∏–Ω –º–∞—Å—Å–∏–≤ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
    const allUsers = useMemo(() => {
        if (!usersData?.pages) return [];
        return usersData.pages.flatMap(page => page.items);
    }, [usersData]);

    const isAdmin = currentUser?.role === "admin";
    const isManager = currentUser?.role === "manager" || isAdmin;

    // –ï—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –∏–º–µ–µ—Ç –ø—Ä–∞–≤ –¥–æ—Å—Ç—É–ø–∞
    if (!isManager) {
        return (
            <div className="max-w-4xl mx-auto px-4 py-8">
                <div className="text-center">
                    <Shield className="w-16 h-16 text-gray-400 mx-auto mb-4" />
                    <h1 className="text-2xl font-bold text-gray-900 mb-2">
                        –î–æ—Å—Ç—É–ø –æ–≥—Ä–∞–Ω–∏—á–µ–Ω
                    </h1>
                    <p className="text-gray-600 mb-4">
                        –£ –≤–∞—Å –Ω–µ—Ç –ø—Ä–∞–≤ –¥–ª—è –¥–æ—Å—Ç—É–ø–∞ –∫ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—é –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º–∏.
                    </p>
                    <Button onClick={() => navigate("/")}>
                        –ù–∞ –≥–ª–∞–≤–Ω—É—é
                    </Button>
                </div>
            </div>
        );
    }

    return (
        <div className="max-w-7xl mx-auto px-4 py-6 space-y-6">
            <AdminNavigation />

            {/* –ó–∞–≥–æ–ª–æ–≤–æ–∫ —Å—Ç—Ä–∞–Ω–∏—Ü—ã */}
            <div className="flex items-center justify-between">
                <div className="flex items-center gap-3">
                    <Users className="w-8 h-8 text-blue-600" />
                    <div>
                        <h1 className="text-3xl font-bold text-gray-900">
                            –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º–∏
                        </h1>
                        <p className="text-gray-600 mt-1">
                            {isAdmin
                                ? "–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —É—á–µ—Ç–Ω—ã–º–∏ –∑–∞–ø–∏—Å—è–º–∏, —Ä–æ–ª—è–º–∏ –∏ –ø—Ä–∞–≤–∞–º–∏ –¥–æ—Å—Ç—É–ø–∞"
                                : "–ü—Ä–æ—Å–º–æ—Ç—Ä –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π —Å–∏—Å—Ç–µ–º—ã"
                            }
                        </p>
                    </div>
                </div>
            </div>

            {/* –û—Å–Ω–æ–≤–Ω–æ–π –∫–æ–Ω—Ç–µ–Ω—Ç */}
            <div className="bg-white rounded-lg border shadow-sm p-6">
                <UserTable 
                    users={allUsers}
                    isLoading={isLoading}
                    error={error}
                    onLoadMore={fetchNextPage}
                    hasNextPage={hasNextPage}
                    isFetchingNextPage={isFetchingNextPage}
                />
            </div>

            {/* –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –¥–ª—è –º–µ–Ω–µ–¥–∂–µ—Ä–æ–≤ */}
            {!isAdmin && (
                <div className="bg-amber-50 border border-amber-200 rounded-lg p-4">
                    <div className="flex items-start gap-3">
                        <Shield className="w-5 h-5 text-amber-600 mt-0.5" />
                        <div className="text-sm">
                            <p className="font-medium text-amber-800 mb-1">
                                –û–≥—Ä–∞–Ω–∏—á–µ–Ω–Ω—ã–π –¥–æ—Å—Ç—É–ø
                            </p>
                            <p className="text-amber-700">
                                –ö–∞–∫ –º–µ–Ω–µ–¥–∂–µ—Ä, –≤—ã –º–æ–∂–µ—Ç–µ –ø—Ä–æ—Å–º–∞—Ç—Ä–∏–≤–∞—Ç—å —Å–ø–∏—Å–æ–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π, –Ω–æ –Ω–µ –º–æ–∂–µ—Ç–µ:
                            </p>
                            <ul className="list-disc list-inside mt-2 text-amber-700 space-y-1">
                                <li>–ò–∑–º–µ–Ω—è—Ç—å —Ä–æ–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π</li>
                                <li>–ë–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å –∏–ª–∏ —Ä–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π</li>
                                <li>–£–¥–∞–ª—è—Ç—å —É—á–µ—Ç–Ω—ã–µ –∑–∞–ø–∏—Å–∏</li>
                            </ul>
                            <p className="text-amber-700 mt-2">
                                –î–ª—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è —ç—Ç–∏—Ö –¥–µ–π—Å—Ç–≤–∏–π –æ–±—Ä–∞—Ç–∏—Ç–µ—Å—å –∫ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—É.
                            </p>
                        </div>
                    </div>
                </div>
            )}

            {/* –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —Ä–æ–ª—è—Ö */}
            <div className="bg-gray-50 rounded-lg p-4">
                <h3 className="font-semibold text-gray-900 mb-3">–û–ø–∏—Å–∞–Ω–∏–µ —Ä–æ–ª–µ–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π</h3>
                <div className="grid grid-cols-1 md:grid-cols-3 gap-4 text-sm">
                    <div className="bg-white p-3 rounded border">
                        <div className="font-medium text-gray-900 mb-2">üë§ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å</div>
                        <ul className="text-gray-600 space-y-1">
                            <li>‚Ä¢ –ü—Ä–æ—Å–º–æ—Ç—Ä –∫–∞—Ç–∞–ª–æ–≥–∞ –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—è</li>
                            <li>‚Ä¢ –°–æ–∑–¥–∞–Ω–∏–µ –∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Å–≤–æ–∏–º–∏ —Ä–µ–∑–µ—Ä–≤–∞–º–∏</li>
                            <li>‚Ä¢ –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–æ–±—Å—Ç–≤–µ–Ω–Ω–æ–≥–æ –ø—Ä–æ—Ñ–∏–ª—è</li>
                        </ul>
                    </div>
                    <div className="bg-white p-3 rounded border">
                        <div className="font-medium text-blue-900 mb-2">üõ°Ô∏è –ú–µ–Ω–µ–¥–∂–µ—Ä</div>
                        <ul className="text-gray-600 space-y-1">
                            <li>‚Ä¢ –í—Å–µ –ø—Ä–∞–≤–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è</li>
                            <li>‚Ä¢ –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏–µ–º</li>
                            <li>‚Ä¢ –ü—Ä–æ—Å–º–æ—Ç—Ä –≤—Å–µ—Ö —Ä–µ–∑–µ—Ä–≤–æ–≤</li>
                            <li>‚Ä¢ –ü—Ä–æ—Å–º–æ—Ç—Ä —Å–ø–∏—Å–∫–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π</li>
                        </ul>
                    </div>
                    <div className="bg-white p-3 rounded border">
                        <div className="font-medium text-red-900 mb-2">üëë –ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä</div>
                        <ul className="text-gray-600 space-y-1">
                            <li>‚Ä¢ –í—Å–µ –ø—Ä–∞–≤–∞ –º–µ–Ω–µ–¥–∂–µ—Ä–∞</li>
                            <li>‚Ä¢ –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º–∏</li>
                            <li>‚Ä¢ –ò–∑–º–µ–Ω–µ–Ω–∏–µ —Ä–æ–ª–µ–π</li>
                            <li>‚Ä¢ –ë–ª–æ–∫–∏—Ä–æ–≤–∫–∞ –∏ —É–¥–∞–ª–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π</li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    );
}

```


## <a name="srcpagesadminAllReservationsManagementPagetsx"></a>`src/pages/admin/AllReservationsManagementPage.tsx`

```tsx
// path: src/pages/admin/AllReservationsManagementPage.tsx

// src/pages/admin/AllReservationsManagementPage.tsx

import { useState, useMemo, useEffect } from "react";
import { useLocation, useNavigate } from "react-router-dom";
import AdminNavigation from "@/components/admin/AdminNavigation";
import { useAdminReservations, useBulkDeleteAdminReservations } from "@/hooks/useAdminReservations";
import { Button } from "@/components/ui/button";
import { ClipboardList, Plus, Loader2, ClipboardX } from "lucide-react";
import AllReservationsList from "@/components/admin/AllReservationsList";
import CreateReservationDialog from "@/components/admin/CreateReservationDialog";
import ConvertReservationDialog from "@/components/admin/ConvertReservationDialog";
import type { AdminReservationOut } from "@/types/reservation";
import { useAllEquipment } from "@/hooks/useAllEquipment";
import { useAdminReservationSelectionStore } from "@/store/adminReservationSelectionStore";
import { AdminReservationToolbar } from "@/components/admin/AdminReservationToolbar";
import { ConfirmationDialog } from "@/components/ui/confirmation-dialog";
import OrderToolbar from "@/components/shared/OrderToolbar";
import { useOrderFilterStore } from "@/store/orderFilterStore";

export default function AllReservationsManagementPage() {
    const location = useLocation();
    const navigate = useNavigate();
    const [localHighlightId, setLocalHighlightId] = useState<number | null>(null);

    const [isCreateDialogOpen, setCreateDialogOpen] = useState(false);
    const [conversionTarget, setConversionTarget] = useState<AdminReservationOut | null>(null);
    const [isConfirmingDelete, setConfirmingDelete] = useState(false);

    // –ü–æ–ª—É—á–∞–µ–º –ø–∞—Ä–∞–º–µ—Ç—Ä—ã —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏ –∏–∑ —Å—Ç–æ—Ä–∞
    const { searchQuery, statusFilter, setSearchQuery, setStatusFilter } = useOrderFilterStore();

    // –≠—Ç–æ—Ç useEffect –æ–±—Ä–∞–±–æ—Ç–∞–µ—Ç —Å–æ—Å—Ç–æ—è–Ω–∏–µ, –ø–µ—Ä–µ–¥–∞–Ω–Ω–æ–µ –ø—Ä–∏ –Ω–∞–≤–∏–≥–∞—Ü–∏–∏
    useEffect(() => {
        const state = location.state as { highlightId?: number; statusFilterOverride?: string } | null;
        if (state?.highlightId) {
            setLocalHighlightId(state.highlightId);
        }
        if (state?.statusFilterOverride) {
            setStatusFilter(state.statusFilterOverride);
            setSearchQuery(""); // –°–±—Ä–∞—Å—ã–≤–∞–µ–º –ø–æ–∏—Å–∫ –¥–ª—è —á–∏—Å—Ç–æ—Ç—ã
        }
    }, [location.state, setStatusFilter, setSearchQuery]);

    // –≠—Ç–æ—Ç useEffect —Å–±—Ä–æ—Å–∏—Ç –ø–æ–¥—Å–≤–µ—Ç–∫—É —á–µ—Ä–µ–∑ 3 —Å–µ–∫—É–Ω–¥—ã
    useEffect(() => {
        if (localHighlightId) {
            const timer = setTimeout(() => {
                setLocalHighlightId(null);
                // –û—á–∏—â–∞–µ–º location.state, —á—Ç–æ–±—ã –ø–æ–¥—Å–≤–µ—Ç–∫–∞ –Ω–µ "–∑–∞–ª–∏–ø–∞–ª–∞" –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
                navigate(location.pathname, { replace: true, state: {} });
            }, 3000);
            return () => clearTimeout(timer);
        }
    }, [localHighlightId, navigate, location.pathname]);

    const {
        data,
        isLoading: isLoadingReservations,
        error,
        fetchNextPage,
        hasNextPage,
        isFetchingNextPage
    } = useAdminReservations({
        search: searchQuery,
        status: statusFilter === "all" ? undefined : statusFilter,
    });

    const { data: allEquipment = [], isLoading: isLoadingEquipment } = useAllEquipment();
    const { selectedIds, clearSelection } = useAdminReservationSelectionStore();
    const bulkDeleteMutation = useBulkDeleteAdminReservations();

    useEffect(() => {
        return () => {
            clearSelection();
        };
    }, []);

    const equipmentMap = useMemo(() => {
        return new Map(allEquipment.map(e => [e.id, e]));
    }, [allEquipment]);

    const allReservations = useMemo(() => {
        const flatList = data?.pages.flatMap(page => page.items) ?? [];
        return Array.from(new Map(flatList.map(item => [item.id, item])).values());
    }, [data]);

    const visibleReservationIds = useMemo(() => allReservations.map(r => r.id), [allReservations]);

    const isLoading = isLoadingReservations || isLoadingEquipment;

    const handleBulkDelete = () => {
        if (selectedIds.length === 0) return;
        setConfirmingDelete(true);
    };

    const confirmBulkDelete = () => {
        bulkDeleteMutation.mutate(selectedIds, {
            onSuccess: () => {
                clearSelection();
                setConfirmingDelete(false);
            },
            onError: () => {
                setConfirmingDelete(false);
            }
        });
    };

    return (
        <div className="max-w-7xl mx-auto px-4 py-6 space-y-6">
            <AdminNavigation />

            <div className="flex items-center gap-3">
                <ClipboardList className="w-8 h-8 text-indigo-600" />
                <div>
                    <h1 className="text-3xl font-bold text-gray-900">
                        –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Ä–µ–∑–µ—Ä–≤–∞–º–∏
                    </h1>
                    <p className="text-gray-600 mt-1">
                        –ü—Ä–æ—Å–º–æ—Ç—Ä, —Å–æ–∑–¥–∞–Ω–∏–µ –∏ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –≤—Å–µ—Ö —Ä–µ–∑–µ—Ä–≤–æ–≤ –≤ —Å–∏—Å—Ç–µ–º–µ.
                    </p>
                </div>
            </div>

            <div className="bg-white rounded-lg border shadow-sm p-4 flex flex-col md:flex-row items-center justify-between gap-4">
                <div className="w-full">
                    <OrderToolbar context="admin-reservations" />
                </div>
                <Button onClick={() => setCreateDialogOpen(true)} className="w-full md:w-auto">
                    <Plus className="mr-2 h-4 w-4" />
                    –°–æ–∑–¥–∞—Ç—å —Ä–µ–∑–µ—Ä–≤
                </Button>
            </div>

            <AdminReservationToolbar
                visibleReservationIds={visibleReservationIds}
                onBulkDelete={handleBulkDelete}
                isDeleting={bulkDeleteMutation.isPending}
            />

            <div className="bg-white rounded-lg border shadow-sm p-4 md:p-6">
                {isLoading && <p className="text-center text-gray-500 py-4">–ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö...</p>}
                {error && <p className="text-center text-red-600 py-4">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö: {error.message}</p>}

                {!isLoading && !error && allReservations.length === 0 && (
                    <div className="flex flex-col items-center justify-center text-center p-12 space-y-4 bg-gray-50/50 rounded-lg border-2 border-dashed">
                        <ClipboardX className="w-16 h-16 text-gray-400" />
                        <h3 className="text-lg font-semibold text-gray-800">–†–µ–∑–µ—Ä–≤—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã</h3>
                        <p className="text-sm text-gray-500">–ü–æ–ø—Ä–æ–±—É–π—Ç–µ –∏–∑–º–µ–Ω–∏—Ç—å —Ñ–∏–ª—å—Ç—Ä—ã –∏–ª–∏ —Å–æ–∑–¥–∞–π—Ç–µ –Ω–æ–≤—ã–π —Ä–µ–∑–µ—Ä–≤.</p>
                    </div>
                )}

                {!isLoading && !error && allReservations.length > 0 && (
                    <AllReservationsList
                        reservations={allReservations}
                        onConvertToRental={setConversionTarget}
                        equipmentMap={equipmentMap}
                        highlightId={localHighlightId}
                    />
                )}
                {hasNextPage && (
                    <div className="flex justify-center mt-6">
                        <Button
                            variant="outline"
                            onClick={() => fetchNextPage()}
                            disabled={isFetchingNextPage}
                        >
                            {isFetchingNextPage ? (
                                <><Loader2 className="mr-2 h-4 w-4 animate-spin" /> –ó–∞–≥—Ä—É–∑–∫–∞...</>
                            ) : "–ó–∞–≥—Ä—É–∑–∏—Ç—å –µ—â–µ"}
                        </Button>
                    </div>
                )}
            </div>

            <CreateReservationDialog
                isOpen={isCreateDialogOpen}
                onClose={() => setCreateDialogOpen(false)}
            />
            <ConvertReservationDialog
                reservation={conversionTarget}
                open={!!conversionTarget}
                onClose={() => setConversionTarget(null)}
                equipmentMap={equipmentMap}
            />

            <ConfirmationDialog
                open={isConfirmingDelete}
                onOpenChange={setConfirmingDelete}
                title="–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç–µ —É–¥–∞–ª–µ–Ω–∏–µ"
                description={`–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å ${selectedIds.length} —Ä–µ–∑–µ—Ä–≤(–æ–≤)? –≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ –Ω–µ–ª—å–∑—è –æ—Ç–º–µ–Ω–∏—Ç—å.`}
                confirmText="–î–∞, —É–¥–∞–ª–∏—Ç—å"
                cancelText="–û—Ç–º–µ–Ω–∞"
                onConfirm={confirmBulkDelete}
                variant="destructive"
            />
        </div>
    );
}

```


## <a name="srcpagesadminAssociationManagementPagetsx"></a>`src/pages/admin/AssociationManagementPage.tsx`

```tsx
// path: src/pages/admin/AssociationManagementPage.tsx

import AdminNavigation from "@/components/admin/AdminNavigation";
import AssociationTable from "@/components/admin/AssociationTable";
import { Tags } from "lucide-react";

export default function AssociationManagementPage() {
    return (
        <div className="max-w-7xl mx-auto px-4 py-6 space-y-6">
            <AdminNavigation />
            <div className="flex items-center gap-3">
                <Tags className="w-8 h-8 text-green-600" />
                <div>
                    <h1 className="text-3xl font-bold text-gray-900">
                        –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∞—Å—Å–æ—Ü–∏–∞—Ü–∏—è–º–∏
                    </h1>
                    <p className="text-gray-600 mt-1">
                        –°–æ–∑–¥–∞–≤–∞–π—Ç–µ –∏ —Ä–µ–¥–∞–∫—Ç–∏—Ä—É–π—Ç–µ –ø–æ–¥–±–æ—Ä–∫–∏ –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—è –¥–ª—è –±—ã—Å—Ç—Ä–æ–≥–æ –¥–æ—Å—Ç—É–ø–∞.
                    </p>
                </div>
            </div>
            <div className="bg-white rounded-lg border shadow-sm p-6">
                <AssociationTable />
            </div>
        </div>
    );
}



```


## <a name="srcpagesadminDashboardPagetsx"></a>`src/pages/admin/DashboardPage.tsx`

```tsx
// path: src/pages/admin/DashboardPage.tsx

// src/pages/admin/DashboardPage.tsx

import { useCurrentUser } from "@/hooks/useProfile";
import { useDashboardData } from "@/hooks/admin/useDashboardData";
import AdminNavigation from "@/components/admin/AdminNavigation";
import TodayFocusWidget from "@/components/admin/dashboard/TodayFocusWidget";
import KpiCardsWidget from "@/components/admin/dashboard/KpiCardsWidget";
import ActivityFeedWidget from "@/components/admin/dashboard/ActivityFeedWidget";
import PopularEquipmentChart from "@/components/admin/dashboard/PopularEquipmentChart";
import { Card, CardContent } from "@/components/ui/card";
import { Alert, AlertDescription } from "@/components/ui/alert";
import { Skeleton } from "@/components/ui/skeleton";
import { AlertCircle, RefreshCw } from "lucide-react";
import { Button } from "@/components/ui/button";

export default function DashboardPage() {
    const { data: currentUser } = useCurrentUser();
    const { data: dashboardData, isLoading, isError, error, refetch } = useDashboardData();

    const isAdmin = currentUser?.role === "admin";
    const isManager = currentUser?.role === "manager" || isAdmin;

    if (!isManager) {
        return (
            <div className="max-w-7xl mx-auto px-4 py-6">
                <AdminNavigation />
                <div className="flex items-center justify-center min-h-[400px]">
                    <Alert className="max-w-md">
                        <AlertCircle className="h-4 w-4" />
                        <AlertDescription>
                            –î–æ—Å—Ç—É–ø –æ–≥—Ä–∞–Ω–∏—á–µ–Ω. –¢—Ä–µ–±—É—é—Ç—Å—è –ø—Ä–∞–≤–∞ –º–µ–Ω–µ–¥–∂–µ—Ä–∞ –∏–ª–∏ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞.
                        </AlertDescription>
                    </Alert>
                </div>
            </div>
        );
    }

    if (isError) {
        return (
            <div className="max-w-7xl mx-auto px-4 py-6 space-y-6">
                <AdminNavigation />
                <div className="flex items-center justify-center min-h-[400px]">
                    <Card className="max-w-md">
                        <CardContent className="pt-6">
                            <Alert variant="destructive">
                                <AlertCircle className="h-4 w-4" />
                                <AlertDescription className="mt-2">
                                    <div className="font-medium mb-2">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö</div>
                                    <div className="text-sm text-muted-foreground mb-4">
                                        {error?.message || "–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –¥–∞–Ω–Ω—ã–µ –¥–∞—à–±–æ—Ä–¥–∞"}
                                    </div>
                                    <Button 
                                        onClick={() => refetch()} 
                                        variant="outline" 
                                        size="sm"
                                        className="w-full"
                                    >
                                        <RefreshCw className="w-4 h-4 mr-2" />
                                        –ü–æ–ø—Ä–æ–±–æ–≤–∞—Ç—å —Å–Ω–æ–≤–∞
                                    </Button>
                                </AlertDescription>
                            </Alert>
                        </CardContent>
                    </Card>
                </div>
            </div>
        );
    }

    return (
        <div className="max-w-7xl mx-auto px-4 py-6 space-y-6">
            <AdminNavigation />

            {/* –ó–∞–≥–æ–ª–æ–≤–æ–∫ */}
            <div className="flex items-center justify-between">
                <div>
                    <h1 className="text-3xl font-bold text-gray-900">
                        –ü–∞–Ω–µ–ª—å —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è
                    </h1>
                    <p className="text-gray-600 mt-1">
                        –î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å, {currentUser?.full_name}!
                    </p>
                </div>
                <div className="flex items-center gap-2">
                    {isLoading && (
                        <div className="flex items-center gap-2 text-sm text-gray-500">
                            <RefreshCw className="w-4 h-4 animate-spin" />
                            –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ...
                        </div>
                    )}
                    <Button 
                        onClick={() => refetch()} 
                        variant="outline" 
                        size="sm"
                        disabled={isLoading}
                    >
                        <RefreshCw className={`w-4 h-4 mr-2 ${isLoading ? 'animate-spin' : ''}`} />
                        –û–±–Ω–æ–≤–∏—Ç—å
                    </Button>
                </div>
            </div>

            {/* KPI Cards */}
            {isLoading ? (
                <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                    {Array.from({ length: 8 }).map((_, index) => (
                        <Card key={index}>
                            <CardContent className="p-6">
                                <div className="space-y-2">
                                    <Skeleton className="h-4 w-20" />
                                    <Skeleton className="h-8 w-16" />
                                    <Skeleton className="h-3 w-24" />
                                </div>
                            </CardContent>
                        </Card>
                    ))}
                </div>
            ) : (
                <KpiCardsWidget 
                    data={dashboardData?.kpi || {
                        total_users: 0,
                        active_users: 0,
                        total_equipment: 0,
                        total_reservations: 0,
                        revenue_today: 0,
                        revenue_this_month: 0,
                        occupancy_rate: 0,
                        avg_rental_duration: 0
                    }} 
                    isLoading={false} 
                />
            )}

            {/* –û—Å–Ω–æ–≤–Ω–æ–π –∫–æ–Ω—Ç–µ–Ω—Ç - –∞–¥–∞–ø—Ç–∏–≤–Ω–∞—è —Å–µ—Ç–∫–∞ */}
            <div className="grid grid-cols-1 lg:grid-cols-3 gap-6">
                {/* –õ–µ–≤–∞—è –∫–æ–ª–æ–Ω–∫–∞ - –§–æ–∫—É—Å –Ω–∞ —Å–µ–≥–æ–¥–Ω—è */}
                <div className="lg:col-span-1">
                    {isLoading ? (
                        <Card>
                            <CardContent className="p-6">
                                <div className="space-y-4">
                                    <Skeleton className="h-6 w-32" />
                                    {Array.from({ length: 3 }).map((_, index) => (
                                        <div key={index} className="space-y-2">
                                            <Skeleton className="h-4 w-24" />
                                            <Skeleton className="h-16 w-full" />
                                        </div>
                                    ))}
                                </div>
                            </CardContent>
                        </Card>
                    ) : (
                        <TodayFocusWidget 
                            data={{
                                pickups_today: dashboardData?.pickups_today || [],
                                returns_today: dashboardData?.returns_today || [],
                                overdue_rentals: dashboardData?.overdue_rentals || []
                            }} 
                            isLoading={false} 
                        />
                    )}
                </div>

                {/* –ü—Ä–∞–≤–∞—è –∫–æ–ª–æ–Ω–∫–∞ - –õ–µ–Ω—Ç–∞ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ –∏ –≥—Ä–∞—Ñ–∏–∫ */}
                <div className="lg:col-span-2 space-y-6">
                    {/* –õ–µ–Ω—Ç–∞ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ */}
                    <ActivityFeedWidget 
                        data={dashboardData?.recent_activity || []} 
                        isLoading={isLoading} 
                    />

                    {/* –ì—Ä–∞—Ñ–∏–∫ –ø–æ–ø—É–ª—è—Ä–Ω–æ–≥–æ –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—è */}
                    <PopularEquipmentChart 
                        data={dashboardData?.popular_equipment || []} 
                        isLoading={isLoading} 
                    />
                </div>
            </div>

            {/* –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è */}
            {!isLoading && dashboardData && (
                <div className="text-center text-sm text-gray-500 pt-4 border-t">
                    <p>
                        –î–∞–Ω–Ω—ã–µ –æ–±–Ω–æ–≤–ª—è—é—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∫–∞–∂–¥—ã–µ 2 –º–∏–Ω—É—Ç—ã. 
                        –ü–æ—Å–ª–µ–¥–Ω–µ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ: {new Date().toLocaleTimeString('ru-RU')}
                    </p>
                </div>
            )}
        </div>
    );
}


```


## <a name="srcpagesadminHolidayManagementPagetsx"></a>`src/pages/admin/HolidayManagementPage.tsx`

```tsx
// path: src/pages/admin/HolidayManagementPage.tsx

// src/pages/admin/HolidayManagementPage.tsx

import AdminNavigation from "@/components/admin/AdminNavigation";
import HolidayManager from "@/components/admin/HolidayManager"; // –≠—Ç–æ—Ç –∫–æ–º–ø–æ–Ω–µ–Ω—Ç –º—ã —Å–æ–∑–¥–∞–¥–∏–º –¥–∞–ª–µ–µ
import { CalendarDays } from "lucide-react";

export default function HolidayManagementPage() {
    return (
        <div className="max-w-7xl mx-auto px-4 py-6 space-y-6">
            <AdminNavigation />
            <div className="flex items-center gap-3">
                <CalendarDays className="w-8 h-8 text-cyan-600" />
                <div>
                    <h1 className="text-3xl font-bold text-gray-900">
                        –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –≤—ã—Ö–æ–¥–Ω—ã–º–∏ –¥–Ω—è–º–∏
                    </h1>
                    <p className="text-gray-600 mt-1">
                        –ù–∞–∑–Ω–∞—á—å—Ç–µ –ø—Ä–∞–∑–¥–Ω–∏—á–Ω—ã–µ –∏ –Ω–µ—Ä–∞–±–æ—á–∏–µ –¥–Ω–∏, –∫–æ—Ç–æ—Ä—ã–µ –Ω–µ –±—É–¥—É—Ç —Ç–∞—Ä–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞—Ç—å—Å—è.
                    </p>
                </div>
            </div>
            <div className="bg-white rounded-lg border shadow-sm p-6">
                <HolidayManager />
            </div>
        </div>
    );
}

```


## <a name="srcpagesadminPromoCodeManagementPagetsx"></a>`src/pages/admin/PromoCodeManagementPage.tsx`

```tsx
// path: src/pages/admin/PromoCodeManagementPage.tsx

// src/pages/admin/PromoCodeManagementPage.tsx

import AdminNavigation from "@/components/admin/AdminNavigation";
import { TicketPercent } from "lucide-react";
import PromoCodeTable from "@/components/admin/PromoCodeTable";
import DurationDiscountManager from "@/components/admin/DurationDiscountManager";

export default function PromoCodeManagementPage() {
    return (
        <div className="max-w-7xl mx-auto px-4 py-6 space-y-6">
            <AdminNavigation />

            <div className="flex items-center gap-3">
                <TicketPercent className="w-8 h-8 text-purple-600" />
                <div>
                    <h1 className="text-3xl font-bold text-gray-900">
                        –ü—Ä–æ–º–æ–∫–æ–¥—ã –∏ —Å–∫–∏–¥–∫–∏
                    </h1>
                    <p className="text-gray-600 mt-1">
                        –°–æ–∑–¥–∞–Ω–∏–µ, —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∏ –ø—Ä–æ—Å–º–æ—Ç—Ä –ø—Ä–æ–º–æ–∫–æ–¥–æ–≤ –∏ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏—Ö —Å–∫–∏–¥–æ–∫.
                    </p>
                </div>
            </div>

            {/* –ë–ª–æ–∫ —Å –ø—Ä–æ–º–æ–∫–æ–¥–∞–º–∏ (–æ—Å—Ç–∞–µ—Ç—Å—è –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π) */}
            <div className="bg-white rounded-lg border shadow-sm p-6">
                <PromoCodeTable />
            </div>

            {/* 2. <-- –î–û–ë–ê–í–õ–Ø–ï–ú –ù–û–í–´–ô –ë–õ–û–ö –î–õ–Ø –£–ü–†–ê–í–õ–ï–ù–ò–Ø –°–ö–ò–î–ö–ê–ú–ò */}
            <div className="bg-white rounded-lg border shadow-sm p-6">
                <DurationDiscountManager />
            </div>
        </div>
    );
}

```


## <a name="srcpagesadminRentalManagementPagetsx"></a>`src/pages/admin/RentalManagementPage.tsx`

```tsx
// path: src/pages/admin/RentalManagementPage.tsx

// src/pages/admin/RentalManagementPage.tsx

import { useState, useMemo, useEffect } from "react";
import { useLocation, useNavigate } from "react-router-dom";
import AdminNavigation from "@/components/admin/AdminNavigation";
import { Button } from "@/components/ui/button";
import { Truck, Plus, Loader2 } from "lucide-react";
import { useAdminRentals } from "@/hooks/useAdminRentals";
import AllRentalsList from "@/components/admin/AllRentalsList";
import ReturnRentalDialog from "@/components/admin/ReturnRentalDialog";
import type { AdminRentalOut } from "@/types/rental";
import OrderToolbar from "@/components/shared/OrderToolbar";
import { useOrderFilterStore } from "@/store/orderFilterStore";



export default function RentalManagementPage() {
    const location = useLocation();
    const navigate = useNavigate();
    const [localHighlightId, setLocalHighlightId] = useState<number | null>(null);
    const [returnTarget, setReturnTarget] = useState<AdminRentalOut | null>(null);

    // –ü–æ–ª—É—á–∞–µ–º –ø–∞—Ä–∞–º–µ—Ç—Ä—ã —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏ –∏–∑ —Å—Ç–æ—Ä–∞
    const { searchQuery, statusFilter, setSearchQuery, setStatusFilter } = useOrderFilterStore();

    const {
        data,
        isLoading,
        error,
        fetchNextPage,
        hasNextPage,
        isFetchingNextPage
    } = useAdminRentals({
        search: searchQuery,
        status: statusFilter === "all" ? undefined : (statusFilter as "active" | "overdue" | "completed" | null),
    });

    const allRentals = useMemo(() => data?.pages.flatMap(page => page.items) ?? [], [data]);

    // –≠—Ç–æ—Ç useEffect –æ–±—Ä–∞–±–æ—Ç–∞–µ—Ç —Å–æ—Å—Ç–æ—è–Ω–∏–µ, –ø–µ—Ä–µ–¥–∞–Ω–Ω–æ–µ –ø—Ä–∏ –Ω–∞–≤–∏–≥–∞—Ü–∏–∏
    useEffect(() => {
        const state = location.state as { highlightId?: number; statusFilterOverride?: string } | null;
        if (state?.highlightId) {
            setLocalHighlightId(state.highlightId);
        }
        if (state?.statusFilterOverride) {
            setStatusFilter(state.statusFilterOverride);
            setSearchQuery(""); // –°–±—Ä–∞—Å—ã–≤–∞–µ–º –ø–æ–∏—Å–∫ –¥–ª—è —á–∏—Å—Ç–æ—Ç—ã
        }
    }, [location.state, setStatusFilter, setSearchQuery]);

    // –≠—Ç–æ—Ç useEffect —Å–±—Ä–æ—Å–∏—Ç –ø–æ–¥—Å–≤–µ—Ç–∫—É —á–µ—Ä–µ–∑ 3 —Å–µ–∫—É–Ω–¥—ã
    useEffect(() => {
        if (localHighlightId) {
            const timer = setTimeout(() => {
                setLocalHighlightId(null);
                // –û—á–∏—â–∞–µ–º location.state, —á—Ç–æ–±—ã –ø–æ–¥—Å–≤–µ—Ç–∫–∞ –Ω–µ "–∑–∞–ª–∏–ø–∞–ª–∞" –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
                navigate(location.pathname, { replace: true, state: {} });
            }, 3000);
            return () => clearTimeout(timer);
        }
    }, [localHighlightId, navigate, location.pathname]);

    return (
        <div className="max-w-7xl mx-auto px-4 py-6 space-y-6">
            <AdminNavigation />

            <div className="flex items-center gap-3">
                <Truck className="w-8 h-8 text-orange-600" />
                <div>
                    <h1 className="text-3xl font-bold text-gray-900">
                        –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ê—Ä–µ–Ω–¥–∞–º–∏
                    </h1>
                    <p className="text-gray-600 mt-1">
                        –ü—Ä–æ—Å–º–æ—Ç—Ä, —Å–æ–∑–¥–∞–Ω–∏–µ –∏ –∑–∞–≤–µ—Ä—à–µ–Ω–∏–µ —Ñ–∏–∑–∏—á–µ—Å–∫–æ–π –≤—ã–¥–∞—á–∏ –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—è.
                    </p>
                </div>
            </div>

            <div className="bg-white rounded-lg border shadow-sm p-4 flex flex-col md:flex-row items-center justify-between gap-4">
                <div className="w-full">
                    <OrderToolbar context="admin-rentals" />
                </div>
                <Button disabled className="w-full md:w-auto">
                    <Plus className="mr-2 h-4 w-4" />
                    –°–æ–∑–¥–∞—Ç—å –∞—Ä–µ–Ω–¥—É
                </Button>
            </div>

            <div className="bg-white rounded-lg border shadow-sm p-4 md:p-6">
                {isLoading && <p className="text-center text-gray-500 py-4">–ó–∞–≥—Ä—É–∑–∫–∞ –∞—Ä–µ–Ω–¥...</p>}
                {error && <p className="text-center text-red-600 py-4">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö: {error.message}</p>}
                {!isLoading && !error && (
                    <AllRentalsList rentals={allRentals} onReturn={setReturnTarget} highlightId={localHighlightId} />
                )}
                {hasNextPage && (
                    <div className="flex justify-center mt-6">
                        <Button
                            variant="outline"
                            onClick={() => fetchNextPage()}
                            disabled={isFetchingNextPage}
                        >
                            {isFetchingNextPage ? (
                                <><Loader2 className="mr-2 h-4 w-4 animate-spin" /> –ó–∞–≥—Ä—É–∑–∫–∞...</>
                            ) : "–ó–∞–≥—Ä—É–∑–∏—Ç—å –µ—â–µ"}
                        </Button>
                    </div>
                )}
            </div>

            <ReturnRentalDialog
                rental={returnTarget}
                open={!!returnTarget}
                onClose={() => setReturnTarget(null)}
            />
        </div>
    );
}

```


## <a name="srcstoreadminReservationSelectionStorets"></a>`src/store/adminReservationSelectionStore.ts`

```typescript
// path: src/store/adminReservationSelectionStore.ts

// src/store/adminReservationSelectionStore.ts

import { create } from 'zustand';

type SelectionState = {
    selectedIds: number[];
    toggleId: (id: number) => void;
    setSelectedIds: (ids: number[]) => void;
    clearSelection: () => void;
};

export const useAdminReservationSelectionStore = create<SelectionState>((set) => ({
    selectedIds: [],
    toggleId: (id) =>
        set((state) => ({
            selectedIds: state.selectedIds.includes(id)
                ? state.selectedIds.filter((selectedId) => selectedId !== id)
                : [...state.selectedIds, id],
        })),
    setSelectedIds: (ids) => set({ selectedIds: ids }),
    clearSelection: () => set({ selectedIds: [] }),
}));

```


## <a name="srcstoreauthStorets"></a>`src/store/authStore.ts`

```typescript
// path: src/store/authStore.ts

// src/store/authStore.ts

import { create } from "zustand"
import { api } from "@/lib/api"
import { queryClient } from "@/lib/queryClient"

// <<< –ò–ó–ú–ï–ù–ï–ù–ò–ï: –û–±–Ω–æ–≤–ª—è–µ–º —Ç–∏–ø –¥–∞–Ω–Ω—ã—Ö –¥–ª—è —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏
type RegisterPayload = {
    full_name: string
    email: string
    password: string
    phone?: string
    privacy_policy_accepted: boolean
    terms_accepted: boolean
}

type AuthStore = {
    loading: boolean
    error: string | null
    login: (email: string, password: string) => Promise<void>
    register: (data: RegisterPayload) => Promise<void>
    logout: () => void
}

export const useAuthStore = create<AuthStore>((set) => ({
    loading: false,
    error: null,

    login: async (email, password) => {
        set({ loading: true, error: null })
        try {
            const response = await api.post(
                "/auth/token",
                new URLSearchParams({ username: email, password }),
                {
                    headers: {
                        "Content-Type": "application/x-www-form-urlencoded",
                    },
                }
            )

            const token = response.data.access_token
            localStorage.setItem("access_token", token)

            // ‚úÖ –û–±–Ω–æ–≤–ª—è–µ–º –∫—ç—à –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
            await queryClient.invalidateQueries({ queryKey: ["current_user"] })
        } catch (err: unknown) {
            const error = err as { response?: { data?: { detail?: string } } }
            set({
                error: error?.response?.data?.detail || "–û—à–∏–±–∫–∞ –≤—Ö–æ–¥–∞",
            })
        } finally {
            set({ loading: false })
        }
    },

    // <<< –ò–ó–ú–ï–ù–ï–ù–ò–ï: –û–±–Ω–æ–≤–ª—è–µ–º —Ñ—É–Ω–∫—Ü–∏—é register –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ –≤—Å–µ—Ö –ø–æ–ª–µ–π
    register: async (data) => {
        set({ loading: true, error: null })
        try {
            await api.post("/auth/register", data) // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –ø–æ–ª–Ω—ã–π –æ–±—ä–µ–∫—Ç `data`

            // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –≤—Ö–æ–¥–∏–º –ø–æ—Å–ª–µ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏
            const response = await api.post(
                "/auth/token",
                new URLSearchParams({ username: data.email, password: data.password }),
                {
                    headers: {
                        "Content-Type": "application/x-www-form-urlencoded",
                    },
                }
            )

            const token = response.data.access_token
            localStorage.setItem("access_token", token)

            // ‚úÖ –û–±–Ω–æ–≤–ª—è–µ–º –∫—ç—à –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
            await queryClient.invalidateQueries({ queryKey: ["current_user"] })
        } catch (err: unknown) {
            const error = err as { response?: { data?: { detail?: string } } }
            set({
                error: error?.response?.data?.detail || "–û—à–∏–±–∫–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏",
            })
        } finally {
            set({ loading: false })
        }
    },

    logout: () => {
        localStorage.removeItem("access_token")
        queryClient.invalidateQueries({ queryKey: ["current_user"] })
    },
}))

```


## <a name="srcstorecalendarSelectionStorets"></a>`src/store/calendarSelectionStore.ts`

```typescript
// path: src/store/calendarSelectionStore.ts

// src/store/calendarSelectionStore.ts
import { create } from "zustand";

type CalendarSelectionState = {
    selectedGroupId: string | null;
    setSelectedGroupId: (id: string | null) => void;
};

export const useCalendarSelectionStore = create<CalendarSelectionState>((set) => ({
    selectedGroupId: null,
    setSelectedGroupId: (id) => set({ selectedGroupId: id }),
}));


```


## <a name="srcstoredateStorets"></a>`src/store/dateStore.ts`

```typescript
// path: src/store/dateStore.ts

// src/store/dateStore.ts

import { create } from "zustand";
import { calculateDayCount } from "@/lib/utils";
import { addDays } from "date-fns";
import { DateService } from "@/core/services/DateService";

type DateState = {
    startDate: Date;
    endDate: Date;
    dayCount: number;
    // +++ –î–û–ë–ê–í–õ–ï–ù–ê –ù–û–í–ê–Ø –§–£–ù–ö–¶–ò–Ø –í –¢–ò–ü +++
    initializeDates: (holidays: Date[]) => void;
    setRange: (from: Date, to: Date, source?: 'calendar' | 'slider' | 'manual', holidays?: Date[]) => void;
    setStartDate: (date: Date, holidays?: Date[]) => void;
    setEndDate: (date: Date, holidays?: Date[]) => void;
    setDayCount: (days: number, holidays?: Date[]) => void;
    reset: (holidays?: Date[]) => void;
};

// –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏
function normalizeDate(date: Date): Date {
    const local = new Date(date);
    local.setHours(12, 0, 0, 0); // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –≤—Ä–µ–º—è –Ω–∞ –ø–æ–ª–¥–µ–Ω—å –¥–ª—è –∏–∑–±–µ–∂–∞–Ω–∏—è –ø—Ä–æ–±–ª–µ–º —Å —á–∞—Å–æ–≤—ã–º–∏ –ø–æ—è—Å–∞–º–∏
    return local;
}

function isValidDate(date: Date): boolean {
    return date instanceof Date && !isNaN(date.getTime());
}

function isValidDateRange(start: Date, end: Date): boolean {
    return isValidDate(start) && isValidDate(end) && start < end;
}

// –ù–∞—á–∞–ª—å–Ω—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
const defaultStart = normalizeDate(new Date());
const defaultEnd = normalizeDate(new Date(new Date().setDate(new Date().getDate() + 1)));

export const useDateStore = create<DateState>((set, get) => ({
    startDate: defaultStart,
    endDate: defaultEnd,
    dayCount: 1,

    // +++ –ù–ê–ß–ê–õ–û: –ù–û–í–ê–Ø –§–£–ù–ö–¶–ò–Ø –î–õ–Ø –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–ò –î–ê–¢ +++
    initializeDates: (holidays: Date[]) => {
        const today = normalizeDate(new Date());
        // –°–¥–≤–∏–≥–∞–µ–º –¥–∞—Ç—É –Ω–∞—á–∞–ª–∞, –µ—Å–ª–∏ —Å–µ–≥–æ–¥–Ω—è –≤—ã—Ö–æ–¥–Ω–æ–π
        const initialStartDate = DateService.adjustDateIfHoliday(today, holidays);
        // –ù–∞—Ö–æ–¥–∏–º —Å–ª–µ–¥—É—é—â–∏–π —Ä–∞–±–æ—á–∏–π –¥–µ–Ω—å –ø–æ—Å–ª–µ —Å–∫–æ—Ä—Ä–µ–∫—Ç–∏—Ä–æ–≤–∞–Ω–Ω–æ–π –¥–∞—Ç—ã –Ω–∞—á–∞–ª–∞
        const initialEndDate = DateService.findNextWorkingDay(initialStartDate, holidays, 1);

        // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –Ω–æ–≤—ã–π –¥–∏–∞–ø–∞–∑–æ–Ω
        get().setRange(initialStartDate, initialEndDate, 'manual', holidays);
    },
    // +++ –ö–û–ù–ï–¶: –ù–û–í–ê–Ø –§–£–ù–ö–¶–ò–Ø +++

    setRange: (from, to, source, holidays = []) => {
        const currentState = get();
        const normalizedFrom = normalizeDate(from);
        let normalizedTo = normalizeDate(to);

        if (normalizedFrom.getTime() >= normalizedTo.getTime()) {
            normalizedTo = new Date(normalizedFrom);
            normalizedTo.setDate(normalizedTo.getDate() + 1);
        }

        normalizedTo = DateService.adjustDateIfHoliday(normalizedTo, holidays);

        if (
            normalizedFrom.getTime() === currentState.startDate.getTime() &&
            normalizedTo.getTime() === currentState.endDate.getTime()
        ) {
            return;
        }

        if (!isValidDateRange(normalizedFrom, normalizedTo)) {
            console.error("[dateStore] Invalid date range:", { from, to });
            return;
        }

        const newDayCount = calculateDayCount(normalizedFrom, normalizedTo, holidays);

        set({
            startDate: normalizedFrom,
            endDate: normalizedTo,
            dayCount: newDayCount,
        });
    },

    setStartDate: (date, holidays = []) => {
        if (!isValidDate(date)) return;
        const state = get();
        const normalizedDate = normalizeDate(date);
        if (isValidDateRange(normalizedDate, state.endDate)) {
            get().setRange(normalizedDate, state.endDate, 'manual', holidays);
        } else {
            const newEndDate = new Date(normalizedDate);
            newEndDate.setDate(newEndDate.getDate() + 1);
            get().setRange(normalizedDate, newEndDate, 'manual', holidays);
        }
    },

    setEndDate: (date, holidays = []) => {
        if (!isValidDate(date)) return;
        const state = get();
        const normalizedDate = normalizeDate(date);
        if (isValidDateRange(state.startDate, normalizedDate)) {
            get().setRange(state.startDate, normalizedDate, 'manual', holidays);
        }
    },

    setDayCount: (days, holidays = []) => {
        const state = get();
        const potentialEndDate = addDays(state.startDate, days);
        get().setRange(state.startDate, potentialEndDate, 'slider', holidays);
    },

    reset: (holidays = []) => {
        const newStart = normalizeDate(new Date());
        const newEnd = normalizeDate(new Date());
        newEnd.setDate(newEnd.getDate() + 1);
        get().setRange(newStart, newEnd, 'manual', holidays);
    },
}));

```


## <a name="srcstorefilterStorets"></a>`src/store/filterStore.ts`

```typescript
// path: src/store/filterStore.ts

// src/store/filterStore.ts
import { create } from "zustand"

type FilterState = {
  brand: string
  type: string | null
  associationId: number | null
  availableOnly: boolean
  setBrand: (brand: string) => void
  setType: (type: string | null) => void
  setAssociationId: (id: number | null) => void
  setAvailableOnly: (value: boolean) => void
  reset: () => void
}

export const useFilterStore = create<FilterState>((set) => ({
  brand: "__all__",            // –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é –ø–æ–∫–∞–∑—ã–≤–∞—Ç—å –≤—Å–µ –±—Ä–µ–Ω–¥—ã
  type: null,                  // <-- –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é –ø–æ–∫–∞–∑—ã–≤–∞—Ç—å –≤—Å–µ —Ç–∏–ø—ã
  associationId: null,
  availableOnly: false,
  setBrand: (brand) => set({ brand }),
  setType: (type) => set({ type }),
  setAssociationId: (id) => set({ associationId: id }),
  setAvailableOnly: (value) => set({ availableOnly: value }),
  reset: () => set({
    brand: "__all__",
    type: null,               // <-- –°–±—Ä–æ—Å –¥–æ–ª–∂–µ–Ω —Ç–æ–∂–µ –¥–∞–≤–∞—Ç—å null
    associationId: null,
    availableOnly: false,
  }),
}))


```


## <a name="srcstoreholidayStorets"></a>`src/store/holidayStore.ts`

```typescript
// path: src/store/holidayStore.ts

// src/store/holidayStore.ts

import { create } from 'zustand';
import { api } from '@/lib/api';
import { formatDate } from '@/lib/utils';
import type { Holiday, HolidayListResponse } from '@/types/holiday';

type HolidayState = {
    holidays: Date[];
    isLoading: boolean;
    lastFetchedRange: { start: string; end: string } | null;
    fetchHolidays: (start: Date, end: Date) => Promise<void>;
};

export const useHolidayStore = create<HolidayState>((set, get) => ({
    holidays: [],
    isLoading: false,
    lastFetchedRange: null,

    fetchHolidays: async (start, end) => {
        const formattedStart = formatDate(start);
        const formattedEnd = formatDate(end);
        const currentRange = get().lastFetchedRange;

        if (
            get().holidays.length > 0 &&
            currentRange?.start === formattedStart &&
            currentRange?.end === formattedEnd
        ) {
            return;
        }

        set({ isLoading: true });
        try {
            const response = await api.get<HolidayListResponse>('/holidays/', {
                params: {
                    start_date: formattedStart,
                    end_date: formattedEnd,
                    // –ò–ó–ú–ï–ù–ï–ù–ò–ï: –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –ª–∏–º–∏—Ç –≤ 100, —á—Ç–æ–±—ã —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–æ–≤–∞—Ç—å –≤–∞–ª–∏–¥–∞—Ü–∏–∏ –±—ç–∫–µ–Ω–¥–∞
                    limit: 100
                },
            });

            const holidayDates = response.data.items.map((h: Holiday) => new Date(h.date));
            set({
                holidays: holidayDates,
                lastFetchedRange: { start: formattedStart, end: formattedEnd },
            });
        } catch (error) {
            console.error("Failed to fetch holidays:", error);
            set({ holidays: [], lastFetchedRange: null });
        } finally {
            set({ isLoading: false });
        }
    },
}));

```


## <a name="srcstoreorderFilterStorets"></a>`src/store/orderFilterStore.ts`

```typescript
// path: src/store/orderFilterStore.ts

import { create } from "zustand"

export type SortOption =
    | "start_asc"
    | "start_desc"
    | "end_asc"
    | "end_desc"
    | "count_asc"
    | "count_desc"
    | "id_asc"
    | "id_desc"

export type OrderContext = 
    | "user-reservations"
    | "user-rentals"
    | "admin-reservations"
    | "admin-rentals"

type OrderFilterState = {
    searchQuery: string
    statusFilter: string | null
    sortOption: SortOption
    setSearchQuery: (query: string) => void
    setStatusFilter: (filter: string | null) => void
    setSortOption: (option: SortOption) => void
    resetFilters: () => void
}

export const useOrderFilterStore = create<OrderFilterState>()((set) => ({
    searchQuery: "",
    statusFilter: "active",
    sortOption: "id_desc",
    setSearchQuery: (query) => set({ searchQuery: query }),
    setStatusFilter: (filter) => set({ statusFilter: filter }),
    setSortOption: (option) => set({ sortOption: option }),
    resetFilters: () => set({ 
        searchQuery: "", 
        statusFilter: "active", 
        sortOption: "id_desc" 
    }),
}))


```


## <a name="srcstorepromoCodeStorets"></a>`src/store/promoCodeStore.ts`

```typescript
// path: src/store/promoCodeStore.ts

// src/store/promoCodeStore.ts

import { create } from "zustand";
import { toast } from "sonner";

type PromoCodeState = {
    promoCode: string;
    promoCodePercentage: number;
    promoCodeMessage: string;
};

type PromoCodeActions = {
    setPromoCode: (code: string) => void;
    setPromoCodeResult: (percentage: number, message: string) => void;
    removePromoCode: () => void;
    clearPromoCode: () => void; // –î–ª—è —Å–±—Ä–æ—Å–∞ –±–µ–∑ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
};

type PromoCodeStore = PromoCodeState & PromoCodeActions;

export const usePromoCodeStore = create<PromoCodeStore>((set) => ({
    // State
    promoCode: "",
    promoCodePercentage: 0,
    promoCodeMessage: "",

    // Actions
    setPromoCode: (code) => set({ promoCode: code, promoCodeMessage: "" }), // –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –ø—Ä–∏ –Ω–æ–≤–æ–º –≤–≤–æ–¥–µ

    setPromoCodeResult: (percentage, message) => set({
        promoCodePercentage: percentage,
        promoCodeMessage: message
    }),

    removePromoCode: () => {
        set({ promoCode: "", promoCodePercentage: 0, promoCodeMessage: "" });
        toast.info("–ü—Ä–æ–º–æ–∫–æ–¥ —Å–±—Ä–æ—à–µ–Ω.");
    },

    // "–¢–∏—Ö–∏–π" —Å–±—Ä–æ—Å, –∏—Å–ø–æ–ª—å–∑—É–µ–º—ã–π –ø—Ä–æ–≥—Ä–∞–º–º–Ω–æ –ø—Ä–∏ –∑–∞–∫—Ä—ã—Ç–∏–∏ —Ñ–æ—Ä–º/–¥–∏–∞–ª–æ–≥–æ–≤
    clearPromoCode: () => set({ promoCode: "", promoCodePercentage: 0, promoCodeMessage: "" }),
}));

```


## <a name="srcstorereserveStorets"></a>`src/store/reserveStore.ts`

```typescript
// path: src/store/reserveStore.ts

// src/store/reserveStore.ts
import { create } from "zustand";
import { subscribeWithSelector } from "zustand/middleware";
import type { Equipment } from "@/types/equipment";

type ReserveState = {
    items: Equipment[];
    reservationId: number | null;
    addToReservationMode: number | null;
    selectedAccessories: Record<number, number[]>;
};

type ReserveActions = {
    toggle: (equipment: Equipment) => void;
    add: (equipment: Equipment) => void;
    // üëá –î–û–ë–ê–í–õ–ï–ù –ù–û–í–´–ô –ú–ï–¢–û–î –í –¢–ò–ü
    addWithAccessories: (equipment: Equipment, accessoryIds: number[]) => void;
    remove: (equipmentId: number) => void;
    bulkAdd: (equipmentList: Equipment[]) => void;
    clear: () => void;
    clearItemsOnly: () => void;
    isSelected: (equipmentId: number) => boolean;
    setReservationId: (id: number | null) => void;
    setAddToReservationMode: (reservationId: number | null) => void;
    completeAddition: () => Equipment[];
    logState: () => void;
    toggleAccessory: (equipmentId: number, accessoryId: number) => void;
    isAccessorySelected: (equipmentId: number, accessoryId: number) => boolean;
    clearAccessoriesForEquipment: (equipmentId: number) => void;
};

type ReserveStore = ReserveState & ReserveActions;

const isEquipmentSelected = (items: Equipment[], equipmentId: number) =>
    items.some((item) => item.id === equipmentId);

export const useReserveStore = create<ReserveStore>()(
    subscribeWithSelector((set, get) => ({
        items: [],
        reservationId: null,
        addToReservationMode: null,
        selectedAccessories: {},

        toggle: (equipment: Equipment) => {
            const currentItems = get().items;
            const isAlreadySelected = isEquipmentSelected(currentItems, equipment.id);

            if (isAlreadySelected) {
                get().clearAccessoriesForEquipment(equipment.id);
            }

            const newItems = isAlreadySelected
                ? currentItems.filter((item) => item.id !== equipment.id)
                : [...currentItems, equipment];

            set({ items: newItems });
        },

        add: (equipment: Equipment) => {
            const currentItems = get().items;
            if (!isEquipmentSelected(currentItems, equipment.id)) {
                set({ items: [...currentItems, equipment] });
            }
        },

        // üëá –†–ï–ê–õ–ò–ó–ê–¶–ò–Ø –ù–û–í–û–ì–û –ú–ï–¢–û–î–ê
        addWithAccessories: (equipment, accessoryIds) => {
            set(state => {
                // –î–æ–±–∞–≤–ª—è–µ–º –æ—Å–Ω–æ–≤–Ω–æ–µ –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏–µ, –µ—Å–ª–∏ –µ–≥–æ –µ—â–µ –Ω–µ—Ç
                const items = state.items.some(i => i.id === equipment.id)
                    ? state.items
                    : [...state.items, equipment];

                // –î–æ–±–∞–≤–ª—è–µ–º –∏–ª–∏ –æ–±–Ω–æ–≤–ª—è–µ–º –∞–∫—Å–µ—Å—Å—É–∞—Ä—ã –¥–ª—è —ç—Ç–æ–≥–æ –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—è
                const newSelectedAccessories = { ...state.selectedAccessories };
                if (accessoryIds.length > 0) {
                    newSelectedAccessories[equipment.id] = accessoryIds;
                } else {
                    // –ï—Å–ª–∏ –ø–µ—Ä–µ–¥–∞–Ω –ø—É—Å—Ç–æ–π –º–∞—Å—Å–∏–≤, —É–¥–∞–ª—è–µ–º –∞–∫—Å–µ—Å—Å—É–∞—Ä—ã –¥–ª—è —ç—Ç–æ–≥–æ —ç–ª–µ–º–µ–Ω—Ç–∞
                    delete newSelectedAccessories[equipment.id];
                }

                return { items, selectedAccessories: newSelectedAccessories };
            });
        },

        remove: (equipmentId: number) => {
            get().clearAccessoriesForEquipment(equipmentId);
            set(state => ({
                items: state.items.filter((item) => item.id !== equipmentId)
            }));
        },

        bulkAdd: (equipmentList: Equipment[]) => {
            set(state => {
                const currentIds = new Set(state.items.map(item => item.id));
                const newEquipment = equipmentList.filter(eq => !currentIds.has(eq.id));
                return { items: [...state.items, ...newEquipment] };
            });
        },

        clear: () => {
            set({
                items: [],
                reservationId: null,
                addToReservationMode: null,
                selectedAccessories: {},
            });
        },

        clearItemsOnly: () => {
            set({ items: [], selectedAccessories: {} });
        },

        isSelected: (equipmentId: number) => isEquipmentSelected(get().items, equipmentId),

        setReservationId: (id: number | null) => set({ reservationId: id }),

        setAddToReservationMode: (reservationId: number | null) => set({ addToReservationMode: reservationId }),

        completeAddition: () => {
            const state = get();
            const addedItems = [...state.items];
            set({ items: [], addToReservationMode: null, selectedAccessories: {} });
            return addedItems;
        },

        logState: () => {
            console.log(`[ReserveStore] Current state:`, get());
        },

        toggleAccessory: (equipmentId, accessoryId) => {
            set(state => {
                const currentSelection = state.selectedAccessories[equipmentId] || [];
                const isSelected = currentSelection.includes(accessoryId);
                const newSelection = isSelected
                    ? currentSelection.filter(id => id !== accessoryId)
                    : [...currentSelection, accessoryId];

                const newSelectedAccessories = { ...state.selectedAccessories };

                if (newSelection.length > 0) {
                    newSelectedAccessories[equipmentId] = newSelection;
                } else {
                    delete newSelectedAccessories[equipmentId];
                }

                return { selectedAccessories: newSelectedAccessories };
            });
        },

        isAccessorySelected: (equipmentId, accessoryId) => {
            const selection = get().selectedAccessories[equipmentId];
            return selection ? selection.includes(accessoryId) : false;
        },

        clearAccessoriesForEquipment: (equipmentId) => {
            set(state => {
                if (!state.selectedAccessories[equipmentId]) {
                    return state;
                }
                const newSelections = { ...state.selectedAccessories };
                delete newSelections[equipmentId];
                return { selectedAccessories: newSelections };
            });
        }
    }))
);

// –ü–æ–¥–ø–∏—Å–∫–∏ –Ω–∞ –∏–∑–º–µ–Ω–µ–Ω–∏—è –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏ (–æ—Å—Ç–∞—é—Ç—Å—è –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π)
useReserveStore.subscribe(
    (state) => state.items,
    (items, previousItems) => {
        if (items.length !== previousItems.length) {
            console.log(`[ReserveStore] Items changed: ${previousItems.length} -> ${items.length}`);
        }
    }
);

useReserveStore.subscribe(
    (state) => state.reservationId,
    (reservationId, previousReservationId) => {
        if (reservationId !== previousReservationId) {
            console.log(`[ReserveStore] Reservation ID changed: ${previousReservationId} -> ${reservationId}`);
        }
    }
);

useReserveStore.subscribe(
    (state) => state.addToReservationMode,
    (addToReservationMode, previousAddToReservationMode) => {
        if (addToReservationMode !== previousAddToReservationMode) {
            console.log(`[ReserveStore] Add to reservation mode changed: ${previousAddToReservationMode} -> ${addToReservationMode}`);
        }
    }
);

```


## <a name="srcstoresandboxCalculatorStorets"></a>`src/store/sandboxCalculatorStore.ts`

```typescript
// path: src/store/sandboxCalculatorStore.ts

// src/store/sandboxCalculatorStore.ts

import { create } from "zustand";
import { useDateStore } from "./dateStore";
import { useHolidayStore } from "./holidayStore";
import { api } from "@/lib/api";
import type { DurationDiscount, DiscountListResponse } from "@/types/discount";

type SandboxCalculatorState = {
    durationDiscountTiers: DurationDiscount[];
    durationDiscountPercentage: number;
    isLoadingTiers: boolean;
    isCalculatorVisible: boolean;
};

type SandboxCalculatorActions = {
    fetchDiscountTiers: () => Promise<void>;
    setDaysFromCalendar: (days: number) => void;
    setDaysFromSlider: (days: number) => void;
    toggleCalculator: () => void;
    _calculateDurationDiscount: (dayCount: number) => void;
    syncWithDateStore: () => void;
    refreshCalculator: () => void;
};

type SandboxCalculatorStore = SandboxCalculatorState & SandboxCalculatorActions;

export const useSandboxCalculatorStore = create<SandboxCalculatorStore>((set, get) => ({
    durationDiscountTiers: [],
    durationDiscountPercentage: 0,
    isLoadingTiers: false,
    isCalculatorVisible: false,

    _calculateDurationDiscount: (dayCount: number) => {
        const tiers = get().durationDiscountTiers;
        const applicableDiscount = tiers
            .filter(tier => dayCount >= tier.min_days)
            .sort((a, b) => b.min_days - a.min_days)[0];
        set({
            durationDiscountPercentage: applicableDiscount ? applicableDiscount.discount_percentage : 0,
        });
    },

    syncWithDateStore: () => {
        const { dayCount } = useDateStore.getState();
        const { holidays } = useHolidayStore.getState();
        const { _calculateDurationDiscount, isCalculatorVisible, fetchDiscountTiers } = get();

        if (dayCount >= 4 && !isCalculatorVisible) {
            set({ isCalculatorVisible: true });
            void fetchDiscountTiers();
        }

        if (get().durationDiscountTiers.length > 0) {
            _calculateDurationDiscount(dayCount);
        }
    },

    fetchDiscountTiers: async () => {
        if (get().durationDiscountTiers.length > 0 || get().isLoadingTiers) return;
        set({ isLoadingTiers: true });
        try {
            const response = await api.get<DiscountListResponse>("/discounts/");
            set({ durationDiscountTiers: response.data.items, isLoadingTiers: false });
            const { dayCount } = useDateStore.getState();
            get()._calculateDurationDiscount(dayCount);
        } catch (error) {
            console.error("Failed to fetch discount tiers:", error);
            set({ isLoadingTiers: false });
        }
    },

    setDaysFromCalendar: (days: number) => {
        const { isCalculatorVisible, fetchDiscountTiers, _calculateDurationDiscount } = get();

        if (!isCalculatorVisible && days >= 4) {
            void fetchDiscountTiers();
        }
        if (get().durationDiscountTiers.length > 0) {
            _calculateDurationDiscount(days);
        }
        if (days >= 4) {
            set({ isCalculatorVisible: true });
        }
    },

    setDaysFromSlider: (days: number) => {
        const dateStore = useDateStore.getState();
        const { holidays } = useHolidayStore.getState();

        // --- –ò–ó–ú–ï–ù–ï–ù–ò–ï –ó–î–ï–°–¨ ---
        // –¢–µ–ø–µ—Ä—å —ç—Ç–∞ —Ñ—É–Ω–∫—Ü–∏—è —Ç–æ–ª—å–∫–æ –ø–µ—Ä–µ–¥–∞–µ—Ç –¥–∞–Ω–Ω—ã–µ –≤ dateStore
        // –∏ –±–æ–ª—å—à–µ –Ω–µ –≤—ã–∑—ã–≤–∞–µ—Ç —Ä–∞—Å—á–µ—Ç —Å–∫–∏–¥–∫–∏ –Ω–∞–ø—Ä—è–º—É—é.
        dateStore.setDayCount(days, holidays);
        // -------------------------

        if (days >= 4) set({ isCalculatorVisible: true });
    },

    toggleCalculator: () => {
        const alreadyVisible = get().isCalculatorVisible;
        if (!alreadyVisible) void get().fetchDiscountTiers();
        set({ isCalculatorVisible: !alreadyVisible });
    },

    refreshCalculator: () => {
        const { dayCount } = useDateStore.getState();
        const { _calculateDurationDiscount } = get();

        if (get().durationDiscountTiers.length > 0 && dayCount > 0) {
            _calculateDurationDiscount(dayCount);
        }
    },
}));

```


## <a name="srcstoresearchStorets"></a>`src/store/searchStore.ts`

```typescript
// path: src/store/searchStore.ts

import { create } from "zustand"

interface SearchState {
  query: string
  setQuery: (value: string) => void
}

export const useSearchStore = create<SearchState>((set) => ({
  query: "",
  setQuery: (value) => set({ query: value })
}))


```


## <a name="srcstoreviewModeStorets"></a>`src/store/viewModeStore.ts`

```typescript
// path: src/store/viewModeStore.ts

// src/store/viewModeStore.ts

import { create } from "zustand";

// –ò—Å–ø–æ–ª—å–∑—É–µ–º 'default' –∏ 'compact' –¥–ª—è –µ–¥–∏–Ω–æ–æ–±—Ä–∞–∑–∏—è
export type ViewMode = 'default' | 'compact';

type ViewState = {
  viewMode: ViewMode;
  setViewMode: (mode: ViewMode) => void;
};

export const useViewModeStore = create<ViewState>((set) => ({
  viewMode: 'default', // –ò—Å—Ö–æ–¥–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ
  // –ë–æ–ª–µ–µ —è–≤–Ω—ã–π –º–µ—Ç–æ–¥ —É—Å—Ç–∞–Ω–æ–≤–∫–∏, –∫–æ—Ç–æ—Ä—ã–π –ø–æ–Ω–∞–¥–æ–±–∏—Ç—Å—è –¥–ª—è ToggleGroup
  setViewMode: (mode) => set({ viewMode: mode }),
}));

```


## <a name="srctypesaccessoryts"></a>`src/types/accessory.ts`

```typescript
// path: src/types/accessory.ts

// src/types/accessory.ts

export interface Accessory {
    id: number;
    name: string;
    accessory_type: string;
    price: number;
    description?: string;
}

// –î–û–ë–ê–í–õ–Ø–ï–ú –≠–¢–û–¢ –ò–ù–¢–ï–†–§–ï–ô–°
export interface AccessoryListResponse {
    items: Accessory[];
    total: number;
}

```


## <a name="srctypesassociationts"></a>`src/types/association.ts`

```typescript
// path: src/types/association.ts

// src/types/association.ts

export interface Association {
    id: number;
    name: string;
    description?: string;
    sort_order: number;
    equipment_ids: number[];
}

export type AssociationCreate = Omit<Association, 'id'>;
export type AssociationUpdate = Partial<AssociationCreate>;

// –î–û–ë–ê–í–¨–¢–ï –≠–¢–û–¢ –≠–ö–°–ü–û–†–¢
export interface AssociationListResponse {
    items: Association[];
    total: number;
}

```


## <a name="srctypesavailabilityts"></a>`src/types/availability.ts`

```typescript
// path: src/types/availability.ts

// src/types/availability.ts

export type EquipmentStatus = "available" | "reserved" | "rented";

export interface AvailabilityInfo {
  equipment_id: number;
  status: EquipmentStatus;
  start_date?: string | null;
  end_date?: string | null;
  details: string;
}

// –î–û–ë–ê–í–¨–¢–ï –≠–¢–û–¢ –ò–ù–¢–ï–†–§–ï–ô–°
// –û–Ω –æ–ø–∏—Å—ã–≤–∞–µ—Ç —Å—Ç—Ä—É–∫—Ç—É—Ä—É –æ—Ç–≤–µ—Ç–∞ –æ—Ç /calendar/view
export interface AvailabilityListResponse {
  items: AvailabilityInfo[];
  total: number;
}


export interface ConflictDetail {
  type: 'reservation' | 'rental';
  id: number;
  user_name?: string; // –ò–º—è –∫–ª–∏–µ–Ω—Ç–∞ –≤ –∫–æ–Ω—Ñ–ª–∏–∫—Ç–µ
  start_date: string;
  end_date: string;
}

export interface EquipmentConflictInfo {
  equipment_id: number;
  conflicts: ConflictDetail[];
}

export interface DayStatus {
  status: EquipmentStatus;
  group_id: string | null;
  is_user_reservation: boolean;
}

```


## <a name="srctypesbalanceHistoryts"></a>`src/types/balanceHistory.ts`

```typescript
// path: src/types/balanceHistory.ts

// src/types/balanceHistory.ts

export interface BalanceHistoryEntry {
    id: number;
    user_id: number;
    rental_id: number | null;
    amount: number;
    operation_type: string;
    description: string | null;
    created_at: string; // –î–∞—Ç–∞ –≤ —Ñ–æ—Ä–º–∞—Ç–µ ISO-—Å—Ç—Ä–æ–∫–∏
}

export interface BalanceHistoryListResponse {
    items: BalanceHistoryEntry[];
    total: number;
}

```


## <a name="srctypesdiscountts"></a>`src/types/discount.ts`

```typescript
// path: src/types/discount.ts

// src/types/discount.ts

// –¢–∏–ø –¥–ª—è —Å–∫–∏–¥–∫–∏, –∫–∞–∫ –æ–Ω–∞ –ø—Ä–∏—Ö–æ–¥–∏—Ç –æ—Ç API
export interface DurationDiscount {
    id: number;
    min_days: number;
    discount_percentage: number;
}

// –¢–∏–ø –¥–ª—è –¥–∞–Ω–Ω—ã—Ö, –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º—ã—Ö –Ω–∞ API –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è —Å–∫–∏–¥–∫–∏
export type DiscountPayload = Omit<DurationDiscount, 'id'>;

// –¢–∏–ø –¥–ª—è –æ—Ç–≤–µ—Ç–∞ –æ—Ç API —Å–æ —Å–ø–∏—Å–∫–æ–º —Å–∫–∏–¥–æ–∫
export interface DiscountListResponse {
    items: DurationDiscount[];
    total: number;
}

```


## <a name="srctypesequipmentts"></a>`src/types/equipment.ts`

```typescript
// path: src/types/equipment.ts

// src/types/equipment.ts

// ‚úÖ –î–û–ë–ê–í–õ–ï–ù –ò–ú–ü–û–†–¢
import type { Accessory } from "./accessory";

export interface Equipment {
  id: number;
  equipment_type: string;
  brand: string;
  name: string;
  serial_number?: string;
  condition: string;
  daily_rate: number;
  notes?: string;
  description?: string;
  last_maintenance?: string;
  image_url?: string;
  image_urls?: string[];
  short_description?: string;
  // ‚úÖ –î–û–ë–ê–í–õ–ï–ù–û –ü–û–õ–ï
  accessories: Accessory[];
}

```


## <a name="srctypesholidayts"></a>`src/types/holiday.ts`

```typescript
// path: src/types/holiday.ts

// src/types/holiday.ts

// –¢–∏–ø –¥–ª—è –æ–¥–Ω–æ–≥–æ –≤—ã—Ö–æ–¥–Ω–æ–≥–æ –¥–Ω—è, –∫–∞–∫ –æ–Ω –ø—Ä–∏—Ö–æ–¥–∏—Ç –æ—Ç API
export interface Holiday {
    date: string; // –§–æ—Ä–º–∞—Ç 'YYYY-MM-DD'
    description: string | null;
    created_at: string;
    created_by_id: number;
}

// –¢–∏–ø –¥–ª—è –æ—Ç–≤–µ—Ç–∞ API —Å–æ —Å–ø–∏—Å–∫–æ–º –≤—ã—Ö–æ–¥–Ω—ã—Ö
export interface HolidayListResponse {
    items: Holiday[];
    total: number;
}

```


## <a name="srctypespromo_codets"></a>`src/types/promo_code.ts`

```typescript
// path: src/types/promo_code.ts

// src/types/promo_code.ts

// –¢–∏–ø –¥–ª—è –¥–∞–Ω–Ω—ã—Ö, –∫–æ—Ç–æ—Ä—ã–µ –º—ã –ø–æ–ª—É—á–∞–µ–º –æ—Ç API –ø—Ä–∏ –∑–∞–ø—Ä–æ—Å–µ —Å–ø–∏—Å–∫–∞ –ø—Ä–æ–º–æ–∫–æ–¥–æ–≤
export interface PromoCodeOut {
    id: number;
    code: string;
    description: string | null;
    discount_percentage: number;
    is_active: boolean;
    valid_from: string | null; // –î–∞—Ç—ã –ø—Ä–∏—Ö–æ–¥—è—Ç –∫–∞–∫ —Å—Ç—Ä–æ–∫–∏ –≤ —Ñ–æ—Ä–º–∞—Ç–µ ISO
    expires_at: string | null;
    max_uses: number | null;
    times_used: number;
    max_uses_per_user: number | null;
    min_order_amount: number | null;
    specific_to_user_id: number | null;
    applicable_to_equipment_ids: number[] | null;
    applicable_to_equipment_types: string[] | null;
    created_at: string;
    created_by_id: number;
    creator_email?: string; // –û–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ–µ –ø–æ–ª–µ –¥–ª—è —É–¥–æ–±—Å—Ç–≤–∞
}

// –¢–∏–ø –¥–ª—è –¥–∞–Ω–Ω—ã—Ö, –∫–æ—Ç–æ—Ä—ã–µ –º—ã –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º –Ω–∞ API –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –ø—Ä–æ–º–æ–∫–æ–¥–∞
// –ü–æ–ª—è, –∫–æ—Ç–æ—Ä—ã–µ –≥–µ–Ω–µ—Ä–∏—Ä—É—é—Ç—Å—è —Å–µ—Ä–≤–µ—Ä–æ–º (id, times_used, created_at –∏ —Ç.–¥.), –∑–¥–µ—Å—å –æ—Ç—Å—É—Ç—Å—Ç–≤—É—é—Ç.
export type PromoCodeCreate = Omit<PromoCodeOut, 'id' | 'times_used' | 'created_at' | 'created_by_id' | 'creator_email'>;

// –¢–∏–ø –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è. –í—Å–µ –ø–æ–ª—è –æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω—ã, —Ç–∞–∫ –∫–∞–∫ –º—ã –º–æ–∂–µ–º –æ–±–Ω–æ–≤–ª—è—Ç—å –∏—Ö –ø–æ –æ–¥–Ω–æ–º—É.
export type PromoCodeUpdate = Partial<PromoCodeCreate>;

// +++ –ù–ê–ß–ê–õ–û –ò–ó–ú–ï–ù–ï–ù–ò–ô: –î–æ–±–∞–≤—å—Ç–µ —ç—Ç–æ—Ç –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å +++
// –û–Ω –æ–ø–∏—Å—ã–≤–∞–µ—Ç —Å—Ç—Ä—É–∫—Ç—É—Ä—É –æ—Ç–≤–µ—Ç–∞ API —Å –ø–∞–≥–∏–Ω–∞—Ü–∏–µ–π
export interface PromoCodeListResponse {
    items: PromoCodeOut[];
    total: number;
}
// +++ –ö–û–ù–ï–¶ –ò–ó–ú–ï–ù–ï–ù–ò–ô +++

```


## <a name="srctypesrentalts"></a>`src/types/rental.ts`

```typescript
// path: src/types/rental.ts

// src/types/rental.ts

import type { UserOut } from "./user";
import type { Equipment } from "./equipment";
import type { Accessory } from "./accessory";

export interface RentalAccessoryDetail {
    equipment_id: number;
    accessory: Accessory;
}

export interface RentalReturnRequest {
    actual_return_date: string; // –§–æ—Ä–º–∞—Ç 'YYYY-MM-DD'
    notes_on_return?: string;
    accessories_returned_confirmation: boolean;
}

export interface AdminRentalOut {
    id: number;
    user_id: number;
    created_by_id: number;
    reservation_id: number | null;
    start_date: string;
    end_date: string;
    actual_return_date: string | null;
    status: 'active' | 'overdue' | 'completed';
    total_cost: number;
    discount_amount: number;
    promo_code: string | null;
    final_cost: number | null;
    deposit_amount: number;
    prepayment_amount: number;
    accessories_cost: number;
    remaining_amount: number;
    notes_on_issue: string | null;
    notes_on_return: string | null;
    created_at: string;
    updated_at: string;
    user: UserOut;
    created_by: UserOut;
    equipment: Equipment[];
    // --- –ò–ó–ú–ï–ù–ï–ù–ò–ï –ó–î–ï–°–¨ ---
    accessory_links: RentalAccessoryDetail[];
    // -------------------------
    days_remaining: number | null;
    overdue_days: number | null;
    overdue_surcharge: number | null;
}

export interface AdminRentalListResponse {
    items: AdminRentalOut[];
    total: number;
}

```


## <a name="srctypesreservationts"></a>`src/types/reservation.ts`

```typescript
// path: src/types/reservation.ts

// src/types/reservation.ts

import type { UserOut } from "./user";
import type { Accessory } from "./accessory";

export interface AccessoryLink {
    equipment_id: number;
    accessory: Accessory;
}

export interface Reservation {
    id: number;
    equipment_ids: number[];
    start_date: string;
    end_date: string;
    status: 'active' | 'fulfilled' | 'cancelled' | 'overdue';
    total_cost?: number;
    discount_amount?: number;
    promo_code?: string | null;
    selected_accessories?: Record<number, number[]>;
    accessory_links?: AccessoryLink[];
    rental_id?: number | null;
}

export interface ReservationWithNames extends Reservation {
    equipment_names: string[];
}

export interface ReservationListResponse {
    items: Reservation[];
    total: number;
}

/* // –ó–∞–∫–æ–º–º–µ–Ω—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å
export interface ReservationItem {
    id: number;
    user_id: number;
    equipment_ids: number[];
    start_date: string;
    end_date: string;
    status: 'active' | 'fulfilled' | 'cancelled' | 'overdue';
    selected_accessories?: Record<number, number[]>;
    total_cost?: number;
    discount_amount?: number;
    promo_code?: string | null;
    rental_id?: number | null;
}
*/

export interface AdminReservationOut {
    id: number;
    user_id: number;
    equipment_ids: number[];
    start_date: string;
    end_date: string;
    status: 'active' | 'fulfilled' | 'cancelled' | 'overdue';
    selected_accessories?: Record<number, number[]>;
    accessory_links?: AccessoryLink[];
    user_info: UserOut;
    total_cost?: number;
    discount_amount?: number;
    promo_code?: string | null;
    rental_id?: number | null;
}

export interface AdminReservationListResponse {
    items: AdminReservationOut[];
    total: number;
}

```


## <a name="srctypesuserts"></a>`src/types/user.ts`

```typescript
// path: src/types/user.ts

// src/types/user.ts

import { z } from "zod";
import { USER_ROLE_VALUES, type UserRole as UserRoleType } from "@/constants/userConstants";

export type UserRole = UserRoleType;

// –°—Ö–µ–º–∞ –¥–ª—è –≤–∞–ª–∏–¥–∞—Ü–∏–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
export const userOutSchema = z.object({
    id: z.number(),
    full_name: z.string(),
    email: z.string().email(),
    role: z.enum(USER_ROLE_VALUES),
    is_active: z.boolean().nullable().transform((val) => val ?? false),
    phone: z.string().nullable().optional(),
    status: z.string().nullable().optional(),
    balance: z.number().optional(),
    notes: z.string().nullable().optional(),
    privacy_policy_accepted: z.boolean(),
    terms_accepted: z.boolean(),
    email_verified: z.boolean(),
    created_at: z.string().datetime(),
});

// –¢–∏–ø, –∫–æ—Ç–æ—Ä—ã–π –ø–æ–ª—É—á–∞–µ—Ç—Å—è –∏–∑ —Å—Ö–µ–º—ã
export type UserOut = z.infer<typeof userOutSchema>;

// +++ –î–û–ë–ê–í–¨–¢–ï –≠–¢–û–¢ –ò–ù–¢–ï–†–§–ï–ô–° +++
// –û–Ω –æ–ø–∏—Å—ã–≤–∞–µ—Ç —Å—Ç—Ä—É–∫—Ç—É—Ä—É –æ—Ç–≤–µ—Ç–∞ –æ—Ç /user/admin/users
export interface UserListResponse {
    items: UserOut[];
    total: number;
}

// +++ –ù–ê–ß–ê–õ–û: –¢–∏–ø –¥–ª—è –∑–∞–ø—Ä–æ—Å–∞ –Ω–∞ –ø–æ–ø–æ–ª–Ω–µ–Ω–∏–µ –±–∞–ª–∞–Ω—Å–∞ +++
export interface UserPaymentRequest {
    amount: number;
    payment_method: string;
    description?: string;
}
// +++ –ö–û–ù–ï–¶: –¢–∏–ø –¥–ª—è –∑–∞–ø—Ä–æ—Å–∞ +++

```


## <a name="srcutilsphoneUtilsts"></a>`src/utils/phoneUtils.ts`

```typescript
// path: src/utils/phoneUtils.ts

// src/utils/phoneUtils.ts

/**
 * –£—Ç–∏–ª–∏—Ç—ã –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å —Ç–µ–ª–µ—Ñ–æ–Ω–Ω—ã–º–∏ –Ω–æ–º–µ—Ä–∞–º–∏
 */

// –†–µ–≥—É–ª—è—Ä–Ω—ã–µ –≤—ã—Ä–∞–∂–µ–Ω–∏—è –¥–ª—è –≤–∞–ª–∏–¥–∞—Ü–∏–∏ —Ä–∞–∑–ª–∏—á–Ω—ã—Ö —Ñ–æ—Ä–º–∞—Ç–æ–≤ —Ç–µ–ª–µ—Ñ–æ–Ω–æ–≤
export const PHONE_PATTERNS = {
    // –†–æ—Å—Å–∏–π—Å–∫–∏–π —Ñ–æ—Ä–º–∞—Ç: +7 (XXX) XXX-XX-XX
    RUSSIAN: /^\+7\s?\(?(\d{3})\)?\s?(\d{3})-?(\d{2})-?(\d{2})$/,
    // –ú–µ–∂–¥—É–Ω–∞—Ä–æ–¥–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç: +X (XXX) XXX-XXXX
    INTERNATIONAL: /^\+\d{1,3}\s?\(?(\d{3})\)?\s?(\d{3})-?(\d{4})$/,
    // –ü—Ä–æ—Å—Ç–æ–π —Ñ–æ—Ä–º–∞—Ç: —Ç–æ–ª—å–∫–æ —Ü–∏—Ñ—Ä—ã
    DIGITS_ONLY: /^\+?[\d\s\-\(\)]+$/,
} as const;

/**
 * –í–∞–ª–∏–¥–∏—Ä—É–µ—Ç —Ä–æ—Å—Å–∏–π—Å–∫–∏–π –Ω–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞
 */
export function validateRussianPhone(phone: string): boolean {
    if (!phone) return false;

    // –£–¥–∞–ª—è–µ–º –≤—Å—ë, —á—Ç–æ –Ω–µ —è–≤–ª—è–µ—Ç—Å—è —Ü–∏—Ñ—Ä–æ–π
    const cleanPhone = phone.replace(/[^\d]/g, '');

    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –Ω–æ–º–µ—Ä –Ω–∞—á–∏–Ω–∞–µ—Ç—Å—è —Å 7 –∏–ª–∏ 8 –∏ –∏–º–µ–µ—Ç 11 —Ü–∏—Ñ—Ä
    if (!/^[78]\d{10}$/.test(cleanPhone)) {
        return false;
    }

    return true;
}

/**
 * –í–∞–ª–∏–¥–∏—Ä—É–µ—Ç –º–µ–∂–¥—É–Ω–∞—Ä–æ–¥–Ω—ã–π –Ω–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞
 */
export function validateInternationalPhone(phone: string): boolean {
    if (!phone) return false;
    
    // –£–±–∏—Ä–∞–µ–º –≤—Å–µ –ø—Ä–æ–±–µ–ª—ã –∏ –¥–µ—Ñ–∏—Å—ã –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏
    const cleanPhone = phone.replace(/[\s\-\(\)]/g, '');
    
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –Ω–æ–º–µ—Ä –Ω–∞—á–∏–Ω–∞–µ—Ç—Å—è —Å + –∏ –∏–º–µ–µ—Ç –æ—Ç 7 –¥–æ 15 —Ü–∏—Ñ—Ä
    if (!/^\+\d{7,15}$/.test(cleanPhone)) {
        return false;
    }
    
    return true;
}

/**
 * –ù–æ—Ä–º–∞–ª–∏–∑—É–µ—Ç –Ω–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞ –∫ —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–æ–º—É —Ñ–æ—Ä–º–∞—Ç—É
 */
export function normalizePhone(phone: string, format: 'russian' | 'international' = 'russian'): string {
    if (!phone) return '';
    
    // –£–±–∏—Ä–∞–µ–º –≤—Å–µ —Å–∏–º–≤–æ–ª—ã –∫—Ä–æ–º–µ —Ü–∏—Ñ—Ä –∏ +
    const cleanPhone = phone.replace(/[^\d+]/g, '');
    
    if (format === 'russian') {
        // –î–ª—è —Ä–æ—Å—Å–∏–π—Å–∫–∏—Ö –Ω–æ–º–µ—Ä–æ–≤
        if (cleanPhone.startsWith('8')) {
            return cleanPhone.replace(/^8/, '+7');
        }
        if (cleanPhone.startsWith('7')) {
            return '+' + cleanPhone;
        }
        if (cleanPhone.startsWith('+7')) {
            return cleanPhone;
        }
        // –ï—Å–ª–∏ –Ω–æ–º–µ—Ä –Ω–∞—á–∏–Ω–∞–µ—Ç—Å—è —Å 9, –¥–æ–±–∞–≤–ª—è–µ–º +7
        if (cleanPhone.startsWith('9') && cleanPhone.length === 10) {
            return '+7' + cleanPhone;
        }
    }
    
    return cleanPhone;
}

/**
 * –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ—Ç –Ω–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞ –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è
 */
export function formatPhone(phone: string, format: 'russian' | 'international' = 'russian'): string {
    if (!phone) return '';
    
    const normalized = normalizePhone(phone, format);
    
    if (format === 'russian') {
        // –§–æ—Ä–º–∞—Ç: +7 (XXX) XXX-XX-XX
        const match = normalized.match(/^\+7(\d{3})(\d{3})(\d{2})(\d{2})$/);
        if (match) {
            return `+7 (${match[1]}) ${match[2]}-${match[3]}-${match[4]}`;
        }
    } else {
        // –§–æ—Ä–º–∞—Ç: +X (XXX) XXX-XXXX
        const match = normalized.match(/^\+(\d{1,3})(\d{3})(\d{3})(\d{4})$/);
        if (match) {
            return `+${match[1]} (${match[2]}) ${match[3]}-${match[4]}`;
        }
    }
    
    return normalized;
}

/**
 * –ò–∑–≤–ª–µ–∫–∞–µ—Ç —Ç–æ–ª—å–∫–æ —Ü–∏—Ñ—Ä—ã –∏–∑ –Ω–æ–º–µ—Ä–∞ —Ç–µ–ª–µ—Ñ–æ–Ω–∞
 */
export function extractDigits(phone: string): string {
    if (!phone) return '';
    return phone.replace(/\D/g, '');
}

/**
 * –ü—Ä–æ–≤–µ—Ä—è–µ—Ç, —è–≤–ª—è–µ—Ç—Å—è –ª–∏ –Ω–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞ –ø–æ–ª–Ω—ã–º
 */
export function isPhoneComplete(phone: string, format: 'russian' | 'international' = 'russian'): boolean {
    if (!phone) return false;
    
    const digits = extractDigits(phone);
    
    if (format === 'russian') {
        // –†–æ—Å—Å–∏–π—Å–∫–∏–π –Ω–æ–º–µ—Ä –¥–æ–ª–∂–µ–Ω –∏–º–µ—Ç—å 11 —Ü–∏—Ñ—Ä (—Å –∫–æ–¥–æ–º —Å—Ç—Ä–∞–Ω—ã)
        return digits.length === 11 && digits.startsWith('7');
    } else {
        // –ú–µ–∂–¥—É–Ω–∞—Ä–æ–¥–Ω—ã–π –Ω–æ–º–µ—Ä –¥–æ–ª–∂–µ–Ω –∏–º–µ—Ç—å –æ—Ç 7 –¥–æ 15 —Ü–∏—Ñ—Ä
        return digits.length >= 7 && digits.length <= 15;
    }
}

/**
 * –ü–æ–ª—É—á–∞–µ—Ç –∫–æ–¥ —Å—Ç—Ä–∞–Ω—ã –∏–∑ –Ω–æ–º–µ—Ä–∞ —Ç–µ–ª–µ—Ñ–æ–Ω–∞
 */
export function getCountryCode(phone: string): string | null {
    if (!phone) return null;
    
    const normalized = normalizePhone(phone, 'international');
    const match = normalized.match(/^\+(\d{1,3})/);
    
    return match ? match[1] : null;
}

/**
 * –ü—Ä–æ–≤–µ—Ä—è–µ—Ç, —è–≤–ª—è–µ—Ç—Å—è –ª–∏ –Ω–æ–º–µ—Ä —Ä–æ—Å—Å–∏–π—Å–∫–∏–º
 */
export function isRussianPhone(phone: string): boolean {
    if (!phone) return false;
    
    const countryCode = getCountryCode(phone);
    return countryCode === '7';
} 

```


## <a name="srcvite-envdts"></a>`src/vite-env.d.ts`

```typescript
// path: src/vite-env.d.ts

/// <reference types="vite/client" />


```


## <a name="tailwindconfigjs"></a>`tailwind.config.js`

```javascript
// path: tailwind.config.js

/** @type {import('tailwindcss').Config} */
export default {
	darkMode: ["class"],
	content: [
		"./index.html",
		"./src/**/*.{js,ts,jsx,tsx,css}",
	],
	theme: {
		extend: {
			borderRadius: {
				lg: 'var(--radius)',
				md: 'calc(var(--radius) - 2px)',
				sm: 'calc(var(--radius) - 4px)'
			},
			colors: {
				background: 'hsl(var(--background))',
				foreground: 'hsl(var(--foreground))',
				card: {
					DEFAULT: 'hsl(var(--card))',
					foreground: 'hsl(var(--card-foreground))'
				},
				popover: {
					DEFAULT: 'hsl(var(--popover))',
					foreground: 'hsl(var(--popover-foreground))'
				},
				primary: {
					DEFAULT: 'hsl(var(--primary))',
					foreground: 'hsl(var(--primary-foreground))'
				},
				secondary: {
					DEFAULT: 'hsl(var(--secondary))',
					foreground: 'hsl(var(--secondary-foreground))'
				},
				muted: {
					DEFAULT: 'hsl(var(--muted))',
					foreground: 'hsl(var(--muted-foreground))'
				},
				accent: {
					DEFAULT: 'hsl(var(--accent))',
					foreground: 'hsl(var(--accent-foreground))'
				},
				destructive: {
					DEFAULT: 'hsl(var(--destructive))',
					foreground: 'hsl(var(--destructive-foreground))'
				},
				border: 'hsl(var(--border))',
				input: 'hsl(var(--input))',
				ring: 'hsl(var(--ring))',
				chart: {
					'1': 'hsl(var(--chart-1))',
					'2': 'hsl(var(--chart-2))',
					'3': 'hsl(var(--chart-3))',
					'4': 'hsl(var(--chart-4))',
					'5': 'hsl(var(--chart-5))'
				}
			}
		}
	},
	plugins: [
		require('tailwindcss-animate'),
		require('@tailwindcss/typography'),
	],
}

```


## <a name="tsconfigappjson"></a>`tsconfig.app.json`

```json
// path: tsconfig.app.json

{
  "compilerOptions": {
    "tsBuildInfoFile": "./node_modules/.tmp/tsconfig.app.tsbuildinfo",
    "target": "ES2020",
    "useDefineForClassFields": true,
    "lib": ["ES2020", "DOM", "DOM.Iterable"],
    "module": "ESNext",
    "skipLibCheck": true,

    /* Bundler mode */
    "moduleResolution": "bundler",
    "allowImportingTsExtensions": true,
    "verbatimModuleSyntax": true,
    "moduleDetection": "force",
    "noEmit": true,
    "jsx": "react-jsx",

    /* Linting */
    "strict": true,
    "noUnusedLocals": true,
    "noUnusedParameters": true,
    "erasableSyntaxOnly": true,
    "noFallthroughCasesInSwitch": true,
    "noUncheckedSideEffectImports": true,

    /* ‚úÖ –î–æ–±–∞–≤–ª—è–µ–º –¥–ª—è alias */
    "baseUrl": ".",
    "paths": {
      "@/*": ["src/*"]
    }
  },
  "include": ["src"]
}


```


## <a name="tsconfigjson"></a>`tsconfig.json`

```json
// path: tsconfig.json

{
  "compilerOptions": {
    "target": "ESNext",
    "useDefineForClassFields": true,
    "module": "ESNext",
    "moduleResolution": "bundler",
    "strict": true,
    "jsx": "react-jsx",

    // ‚úÖ –¥–æ–±–∞–≤–ª—è–µ–º
    "baseUrl": ".",
    "paths": {
      "@/*": ["src/*"]
    },
    "allowSyntheticDefaultImports": true
  },
  "include": ["src"]
}


```


## <a name="tsconfignodejson"></a>`tsconfig.node.json`

```json
// path: tsconfig.node.json

{
  "compilerOptions": {
    "tsBuildInfoFile": "./node_modules/.tmp/tsconfig.node.tsbuildinfo",
    "target": "ES2022",
    "lib": ["ES2023"],
    "module": "ESNext",
    "skipLibCheck": true,

    /* Bundler mode */
    "moduleResolution": "bundler",
    "types": ["node"],
    "allowImportingTsExtensions": true,
    "verbatimModuleSyntax": true,
    "moduleDetection": "force",
    "noEmit": true,

    /* Linting */
    "strict": true,
    "noUnusedLocals": true,
    "noUnusedParameters": true,
    "erasableSyntaxOnly": true,
    "noFallthroughCasesInSwitch": true,
    "noUncheckedSideEffectImports": true
  },
  "include": ["vite.config.ts"]
}


```


## <a name="viteconfigts"></a>`vite.config.ts`

```typescript
// path: vite.config.ts

import { defineConfig } from 'vite'
import react from '@vitejs/plugin-react'
import { fileURLToPath, URL } from 'url' // –ò–º–ø–æ—Ä—Ç–∏—Ä—É–µ–º —É—Ç–∏–ª–∏—Ç—ã –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –ø—É—Ç—è–º–∏

export default defineConfig({
  plugins: [react()],

  server: {
    port: 5173,
    strictPort: true,
  },

  resolve: {
    alias: {
      // –ò—Å–ø–æ–ª—å–∑—É–µ–º —Å–æ–≤—Ä–µ–º–µ–Ω–Ω—ã–π —Å–ø–æ—Å–æ–± –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è alias
      "@": fileURLToPath(new URL('./src', import.meta.url))
    }
  }
})

```


## üì¶ –ó–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –ø—Ä–æ–µ–∫—Ç–∞

- `@fullcalendar/core`: ^6.1.17
- `@fullcalendar/daygrid`: ^6.1.17
- `@fullcalendar/interaction`: ^6.1.17
- `@fullcalendar/react`: ^6.1.17
- `@fullcalendar/resource-timeline`: ^6.1.17
- `@hookform/resolvers`: ^5.0.1
- `@radix-ui/react-checkbox`: ^1.3.1
- `@radix-ui/react-dialog`: ^1.1.14
- `@radix-ui/react-label`: ^2.1.6
- `@radix-ui/react-popover`: ^1.1.14
- `@radix-ui/react-scroll-area`: ^1.2.9
- `@radix-ui/react-select`: ^2.2.4
- `@radix-ui/react-slot`: ^1.2.2
- `@radix-ui/react-switch`: ^1.2.5
- `@radix-ui/react-toggle`: ^1.1.8
- `@radix-ui/react-toggle-group`: ^1.1.9
- `@tanstack/react-query`: ^5.76.1
- `@tanstack/react-query-devtools`: ^5.76.1
- `@types/react-input-mask`: ^3.0.6
- `@uiw/react-md-editor`: ^4.0.7
- `axios`: ^1.9.0
- `class-variance-authority`: ^0.7.1
- `clsx`: ^2.1.1
- `cmdk`: ^1.1.1
- `date-fns`: ^4.1.0
- `lucide-react`: ^0.511.0
- `react`: ^19.1.0
- `react-day-picker`: ^9.7.0
- `react-dom`: ^19.1.0
- `react-error-boundary`: ^6.0.0
- `react-hook-form`: ^7.56.4
- `react-imask`: ^7.6.1
- `react-markdown`: ^10.1.0
- `react-router-dom`: ^7.6.0
- `rehype-sanitize`: ^6.0.0
- `sonner`: ^2.0.3
- `tailwind-merge`: ^3.3.0
- `tailwindcss-animate`: ^1.0.7
- `zod`: ^3.25.28
- `zustand`: ^5.0.4

### Dev-–∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏

- `@eslint/js`: ^9.25.0
- `@tailwindcss/typography`: ^0.5.16
- `@types/mocha`: ^10.0.10
- `@types/node`: ^24.0.10
- `@types/react`: ^19.1.2
- `@types/react-dom`: ^19.1.2
- `@vitejs/plugin-react`: ^4.4.1
- `autoprefixer`: ^10.4.15
- `eslint`: ^9.25.0
- `eslint-plugin-react-hooks`: ^5.2.0
- `eslint-plugin-react-refresh`: ^0.4.19
- `globals`: ^16.0.0
- `postcss`: ^8.4.38
- `tailwindcss`: ^3.4.1
- `typescript`: ~5.8.3
- `typescript-eslint`: ^8.30.1
- `vite`: ^6.3.5


```


## <a name="rentalappmainsplitpy"></a>`rental-app-main/split.py`

```python
// path: rental-app-main/split.py

import os
from pathlib import Path
import fnmatch

# –ü–∞–ø–∫–∞ –ø—Ä–æ–µ–∫—Ç–∞
project_root = Path(__file__).resolve().parent
output_filename = project_root / "smart_react_code.md"

# –ß—Ç–æ –≤–∫–ª—é—á–∞–µ–º
INCLUDE_DIRS = {"src", 'public'}
INCLUDE_FILES = {"App.tsx", "main.tsx", 'requirements.txt', 'package.json', 'package-lock.json',
                 'tsconfig.json', 'tsconfig.node.json', 'tsconfig.app.json', 'vite.config.json'}
INCLUDE_EXTENSIONS = {".tsx", ".html", ".ts", 'svg', '.css', '.js', '.txt'}

# –ß—Ç–æ –ø–æ–ª–Ω–æ—Å—Ç—å—é –∏—Å–∫–ª—é—á–∞–µ–º (–∏ –Ω–µ –æ—Ç–æ–±—Ä–∞–∂–∞–µ–º –≤ —Å—Ç—Ä—É–∫—Ç—É—Ä–µ)
EXCLUDE_DIRS = {'.git', '.venv', 'node_modules'}
EXCLUDE_FILES = {'*.pyc', '*.pyo', '*.db', '__init__.py'}

# –ü–æ—Ä–æ–≥ —É—Å–µ—á–µ–Ω–∏—è
MAX_LINES = 350
TRUNCATE_LINES = 50

def is_excluded(file_path: Path) -> bool:
    return any(fnmatch.fnmatch(file_path.name, pattern) for pattern in EXCLUDE_FILES)

def is_included(file_path: Path) -> bool:
    parts = file_path.relative_to(project_root).parts
    return (
            file_path.name in INCLUDE_FILES or
            (parts and parts[0] in INCLUDE_DIRS and file_path.suffix in INCLUDE_EXTENSIONS)
    )

def collect_files():
    included = []
    for root, dirs, files in os.walk(project_root):
        # —É–¥–∞–ª—è–µ–º —Å–∏—Å—Ç–µ–º–Ω—ã–µ –ø–∞–ø–∫–∏ –Ω–∞ –º–µ—Å—Ç–µ ‚Äî –Ω–µ –ø–æ–ø–∞–¥—É—Ç –¥–∞–∂–µ –≤ –æ–±—Ö–æ–¥
        dirs[:] = [d for d in dirs if d not in EXCLUDE_DIRS]
        for file in files:
            path = Path(root) / file
            rel_path = path.relative_to(project_root)
            if any(part in EXCLUDE_DIRS for part in rel_path.parts):
                continue
            if is_excluded(path):
                continue
            if is_included(path):
                included.append(path)
    return included

def summarize_structure(included, truncation_map):
    lines = ["# –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –ø—Ä–æ–µ–∫—Ç–∞\n"]
    for file in sorted(included, key=lambda x: str(x)):
        rel = file.relative_to(project_root)
        if truncation_map.get(str(rel)):
            lines.append(f"- ‚ö†Ô∏è `{rel}` (—É—Å–µ—á—ë–Ω)")
        else:
            lines.append(f"- ‚úÖ `{rel}`")
    return "\n".join(lines)

def write_output(included):
    truncation_map = {}
    with open(output_filename, "w", encoding="utf-8") as out:
        out.write("# –°–∂–∞—Ç—ã–π –∏—Å—Ö–æ–¥–Ω—ã–π –∫–æ–¥ –ø—Ä–æ–µ–∫—Ç–∞ —Ñ—Ä–æ–Ω—Ç—ç–Ω–¥–∞ –¥–ª—è AI-–ø–æ–º–æ—â–Ω–∏–∫–∞\n\n")

        code_blocks = []
        for path in sorted(included, key=lambda p: str(p.relative_to(project_root))):
            rel_path = path.relative_to(project_root)
            ext = path.suffix
            block = [f"\n\n## `{rel_path}`\n\n"]
            block.append("```python\n" if ext == ".py" else "```html\n")

            try:
                lines = path.read_text(encoding="utf-8").splitlines()
                if len(lines) > MAX_LINES:
                    truncation_map[str(rel_path)] = True
                    block.extend(lines[:TRUNCATE_LINES])
                    block.append(f"# ... truncated ({len(lines)} lines total)")
                    block.append("# ‚ö†Ô∏è –ü–æ–ª–Ω—ã–π –∫–æ–¥ –¥–æ—Å—Ç—É–ø–µ–Ω –≤ –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω–æ–º —Ñ–∞–π–ª–µ")
                else:
                    block.extend(lines)
            except Exception as e:
                block.append(f"# –û—à–∏–±–∫–∞ —á—Ç–µ–Ω–∏—è —Ñ–∞–π–ª–∞: {e}")
            block.append("\n```\n")
            code_blocks.append("\n".join(block))

        structure = summarize_structure(included, truncation_map)
        out.write(structure)
        out.write("\n\n---\n")
        out.write("\n".join(code_blocks))

def main():
    included_files = collect_files()
    write_output(included_files)
    print(f"‚úÖ –§–∞–π–ª '{output_filename.name}' —É—Å–ø–µ—à–Ω–æ —Å–æ–∑–¥–∞–Ω.")

if __name__ == "__main__":
    main()


```


## <a name="rentalappmainsplitoptimizedpy"></a>`rental-app-main/split_optimized.py`

```python
// path: rental-app-main/split_optimized.py

import os
import json
import fnmatch
import argparse
from pathlib import Path
from collections import defaultdict

project_root = Path(__file__).resolve().parent
output_filename = project_root / "smart_react_code.md"

INCLUDE_DIRS = {"src", "public"}
INCLUDE_FILES = {
    "App.tsx", "main.tsx", "package.json", "package-lock.json",
    "tsconfig.json", "tsconfig.node.json", "tsconfig.app.json", "vite.config.json", 'tailwind.config.js', 'postcss.config.js', 'vite.config.ts',
    'postcss.config.cjs'
}
INCLUDE_EXTENSIONS = {".tsx", ".html", ".ts", ".svg", ".css", ".js", ".txt"}

EXCLUDE_DIRS = {".git", ".venv", "node_modules", ".idea", ".vscode", "dist", "build"}
EXCLUDE_FILES = {"*.pyc", "*.pyo", "*.db", "__init__.py"}

IMPORTANT_FILES = {
    "App.tsx", "HomePage.tsx", "ReservePage.tsx", "ReserveEditPage.tsx"
}
EXCLUDED_UI_COMPONENTS = {"src/components/ui"}

MAX_LINES = 400
TRUNCATE_LINES = 50


def is_excluded(file_path: Path, include_ui=False) -> bool:
    if not include_ui:
        for excluded_dir in EXCLUDED_UI_COMPONENTS:
            if excluded_dir in str(file_path).replace("\\", "/"):
                return True
    return any(fnmatch.fnmatch(file_path.name, pattern) for pattern in EXCLUDE_FILES)


def is_included(file_path: Path, light=False) -> bool:
    parts = file_path.relative_to(project_root).parts
    if light and not any(part in ["components", "pages", "types"] for part in parts):
        return False
    return (
            file_path.name in INCLUDE_FILES or
            (parts and parts[0] in INCLUDE_DIRS and file_path.suffix in INCLUDE_EXTENSIONS)
    )


def collect_files(light=False, include_ui=False):
    included = []
    for root, dirs, files in os.walk(project_root):
        dirs[:] = [d for d in dirs if d not in EXCLUDE_DIRS]
        for file in files:
            path = Path(root) / file
            rel_path = path.relative_to(project_root)
            if any(part in EXCLUDE_DIRS for part in rel_path.parts):
                continue
            if is_excluded(path, include_ui=include_ui):
                continue
            if is_included(path, light):
                included.append(path)
    return included


def summarize_structure(grouped, truncation_map):
    lines = ["# üìÅ –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –ø—Ä–æ–µ–∫—Ç–∞"]
    for folder in sorted(grouped):
        lines.append(f"\n### `{folder}`")
        for file in sorted(grouped[folder], key=lambda x: str(x)):
            rel = file.relative_to(project_root)
            icon = "‚ö†Ô∏è" if truncation_map.get(str(rel)) else "‚úÖ"
            star = "‚≠ê" if rel.name in IMPORTANT_FILES else ""
            lines.append(f"- {star} {icon} `{rel}`")
    return "\n".join(lines)


def write_output(included, light=False, include_ui=False):
    truncation_map = {}
    grouped = defaultdict(list)
    for file in included:
        grouped[str(file.relative_to(project_root).parent)].append(file)

    with open(output_filename, "w", encoding="utf-8") as out:
        out.write("# ü§ñ –°–∂–∞—Ç—ã–π –∏—Å—Ö–æ–¥–Ω—ã–π –∫–æ–¥ —Ñ—Ä–æ–Ω—Ç–µ–Ω–¥–∞ –¥–ª—è AI-–ø–æ–º–æ—â–Ω–∏–∫–∞\n\n")

        out.write("## üîó –ë—ã—Å—Ç—Ä–∞—è –Ω–∞–≤–∏–≥–∞—Ü–∏—è –ø–æ —Ñ–∞–π–ª–∞–º\n")
        for path in sorted(included, key=lambda p: str(p.relative_to(project_root))):
            rel_path = path.relative_to(project_root)
            anchor = str(rel_path).replace("/", "").replace(".", "").replace("\\", "")
            out.write(f"- [{rel_path}](#{anchor})\n")
        out.write("\n---\n\n")

        structure = summarize_structure(grouped, truncation_map)
        out.write(structure)
        out.write("\n\n---\n")

        for path in sorted(included, key=lambda p: str(p.relative_to(project_root))):
            rel_path = path.relative_to(project_root)
            ext = path.suffix
            block = [f"\n\n## `{rel_path}`\n\n"]
            block.append("```python\n" if ext == ".py" else "```html\n")

            try:
                lines = path.read_text(encoding="utf-8").splitlines()
                if len(lines) > MAX_LINES:
                    truncation_map[str(rel_path)] = True
                    block.extend(lines[:TRUNCATE_LINES])
                    block.append(f"# ... truncated ({len(lines)} lines total)")
                    block.append("# ‚ö†Ô∏è –ü–æ–ª–Ω—ã–π –∫–æ–¥ –¥–æ—Å—Ç—É–ø–µ–Ω –≤ –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω–æ–º —Ñ–∞–π–ª–µ")
                else:
                    block.extend(lines)
            except Exception as e:
                block.append(f"# –û—à–∏–±–∫–∞ —á—Ç–µ–Ω–∏—è —Ñ–∞–π–ª–∞: {e}")
            block.append("\n```\n")
            out.write("\n".join(block))

        pkg_path = project_root / "package.json"
        if pkg_path.exists():
            try:
                deps = json.loads(pkg_path.read_text(encoding="utf-8")).get("dependencies", {})
                out.write("\n\n## üì¶ –ó–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –ø—Ä–æ–µ–∫—Ç–∞\n\n")
                for name, version in sorted(deps.items()):
                    out.write(f"- `{name}`: {version}\n")
            except Exception as e:
                out.write(f"\n\n## –û—à–∏–±–∫–∞ —á—Ç–µ–Ω–∏—è package.json: {e}\n")


def main():
    parser = argparse.ArgumentParser()
    parser.add_argument("--light", action="store_true", help="–°–æ–±—Ä–∞—Ç—å —Ç–æ–ª—å–∫–æ –∫–ª—é—á–µ–≤—ã–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã –∏ —Ç–∏–ø—ã")
    parser.add_argument("--include-ui", action="store_true", help="–í–∫–ª—é—á–∏—Ç—å –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã –∏–∑ src/components/ui")
    args = parser.parse_args()
    included_files = collect_files(light=args.light, include_ui=args.include_ui)
    write_output(included_files, light=args.light, include_ui=args.include_ui)

    readme_path = project_root / "README_AI.md"
    with open(readme_path, "w", encoding="utf-8") as readme:
        readme.write("# üìò –ò–Ω—Å—Ç—Ä—É–∫—Ü–∏—è –¥–ª—è AI-–ø–æ–º–æ—â–Ω–∏–∫–∞\n\n")
        readme.write("–≠—Ç–æ—Ç –ø—Ä–æ–µ–∫—Ç —Å–æ–±—Ä–∞–Ω —Å–∫—Ä–∏–ø—Ç–æ–º `split_optimized.py` –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞ –ò–ò.\n\n")
        readme.write("## üìÇ –°–æ–¥–µ—Ä–∂–∏–º–æ–µ\n")
        readme.write("- `smart_react_code.md` ‚Äî –æ—Å–Ω–æ–≤–Ω–æ–π —Ñ–∞–π–ª —Å –∫–æ–¥–æ–º\n")
        readme.write("- `README_AI.md` ‚Äî —ç—Ç–∞ –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—è\n\n")
        readme.write("## üöÄ –ö–∞–∫ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å\n")
        readme.write("–ü–µ—Ä–µ–¥–∞–π `smart_react_code.md` –≤ AI-–ø–æ–º–æ—â–Ω–∏–∫. –û–Ω —Å–æ–¥–µ—Ä–∂–∏—Ç —Å—Ç—Ä—É–∫—Ç—É—Ä—É, –æ–≥–ª–∞–≤–ª–µ–Ω–∏–µ, –∫–ª—é—á–µ–≤—ã–µ —É—á–∞—Å—Ç–∫–∏ –∫–æ–¥–∞.\n")
        readme.write("–ü–æ —É–º–æ–ª—á–∞–Ω–∏—é UI-–∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã (`src/components/ui`) –∏—Å–∫–ª—é—á–µ–Ω—ã, –≤–∫–ª—é—á–∏ –∏—Ö —Ñ–ª–∞–≥–æ–º `--include-ui` –ø—Ä–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏.\n")

    print(f"‚úÖ –§–∞–π–ª '{output_filename.name}' –∏ README_AI.md —É—Å–ø–µ—à–Ω–æ —Å–æ–∑–¥–∞–Ω—ã.")


if __name__ == "__main__":
    main()


```


## <a name="rentalappmainsplitoptimizedgempy"></a>`rental-app-main/split_optimized_gem.py`

```python
// path: rental-app-main/split_optimized_gem.py

import os
import json
import fnmatch
import argparse
from pathlib import Path
from collections import defaultdict

# <<< –ò–ó–ú–ï–ù–ï–ù–ò–ï: –ü—É—Ç—å –∫ –ø—Ä–æ–µ–∫—Ç—É –æ–ø—Ä–µ–¥–µ–ª—è–µ—Ç—Å—è –æ—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω–æ —Å–∫—Ä–∏–ø—Ç–∞
project_root = Path(__file__).resolve().parent
output_filename = project_root / "smart_react_code_gem.md"

# --- –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –≤–∫–ª—é—á–µ–Ω–∏–π ---
INCLUDE_DIRS = {"src", "public"}
INCLUDE_FILES = {
    "package.json", # package-lock.json —É–±—Ä–∞–Ω
    "tsconfig.json", "tsconfig.node.json", "tsconfig.app.json",
    'tailwind.config.js', 'postcss.config.js', 'vite.config.ts',
}
# <<< –ò–ó–ú–ï–ù–ï–ù–ò–ï: .svg —É–±—Ä–∞–Ω –æ—Ç—Å—é–¥–∞, –±—É–¥–µ—Ç –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—Ç—å—Å—è –æ—Ç–¥–µ–ª—å–Ω–æ
INCLUDE_EXTENSIONS = {".tsx", ".ts", ".css", ".js"}

# <<< –ò–ó–ú–ï–ù–ï–ù–ò–ï: –ù–æ–≤–∞—è –∫–æ–Ω—Å—Ç–∞–Ω—Ç–∞ –¥–ª—è –ª–µ–≥–∫–æ–≤–µ—Å–Ω—ã—Ö —Ñ–∞–π–ª–æ–≤, —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ –∫–æ—Ç–æ—Ä—ã—Ö –Ω–µ –Ω—É–∂–Ω–æ
LIGHTWEIGHT_EXTENSIONS = {".svg"}

# --- –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –∏—Å–∫–ª—é—á–µ–Ω–∏–π ---
EXCLUDE_DIRS = {".git", ".venv", "node_modules", ".idea", ".vscode", "dist", "build"}
# <<< –ò–ó–ú–ï–ù–ï–ù–ò–ï: –î–æ–±–∞–≤–ª–µ–Ω package-lock.json –≤ –∏—Å–∫–ª—é—á–µ–Ω–∏—è
EXCLUDE_FILES = {"*.pyc", "*.pyo", "*.db", "__init__.py", "package-lock.json"}
EXCLUDED_UI_COMPONENTS = {"src/components/ui"} # –û—Ç–ª–∏—á–Ω–æ–µ –ø—Ä–∞–≤–∏–ª–æ, –æ—Å—Ç–∞–≤–ª—è–µ–º!

# --- –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –¥–ª—è —É–ª—É—á—à–µ–Ω–∏—è —á–∏—Ç–∞–µ–º–æ—Å—Ç–∏ ---
IMPORTANT_FILES = {
    "App.tsx", "HomePage.tsx", "ReservePage.tsx"
}
# <<< –ò–ó–ú–ï–ù–ï–ù–ò–ï: –£–ª—É—á—à–µ–Ω–Ω–∞—è –ª–æ–≥–∏–∫–∞ –¥–ª—è —Ä–µ–∂–∏–º–∞ --light
LIGHT_MODE_INCLUDE_DIRS = {"src/pages", "src/components", "src/hooks", "src/store", "src/lib", "src/types", "src/utils", "src/contexts",
                           "src/constants"}

def is_excluded(file_path: Path, include_ui=False) -> bool:
    """–ü—Ä–æ–≤–µ—Ä—è–µ—Ç, –¥–æ–ª–∂–µ–Ω –ª–∏ —Ñ–∞–π–ª –±—ã—Ç—å –ø–æ–ª–Ω–æ—Å—Ç—å—é –∏—Å–∫–ª—é—á–µ–Ω."""
    if not include_ui:
        # –ò—Å–ø–æ–ª—å–∑—É–µ–º as_posix() –¥–ª—è —É–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω–æ—Å—Ç–∏ –ø—É—Ç–µ–π
        if any(excluded_dir in file_path.as_posix() for excluded_dir in EXCLUDED_UI_COMPONENTS):
            return True
    return any(fnmatch.fnmatch(file_path.name, pattern) for pattern in EXCLUDE_FILES)


def is_included(file_path: Path, light=False) -> bool:
    """–ü—Ä–æ–≤–µ—Ä—è–µ—Ç, –¥–æ–ª–∂–µ–Ω –ª–∏ —Ñ–∞–π–ª –±—ã—Ç—å –≤–∫–ª—é—á–µ–Ω –≤ —Å–±–æ—Ä–∫—É."""
    rel_path_posix = file_path.relative_to(project_root).as_posix()

    if light:
        # –í–∫–ª—é—á–∞–µ–º –∫–ª—é—á–µ–≤—ã–µ —Ñ–∞–π–ª—ã –∏ —Ñ–∞–π–ª—ã –∏–∑ –≤–∞–∂–Ω—ã—Ö –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–π
        is_in_light_dir = any(rel_path_posix.startswith(d) for d in LIGHT_MODE_INCLUDE_DIRS)
        return file_path.name in INCLUDE_FILES or is_in_light_dir

    # –°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π —Ä–µ–∂–∏–º
    parts = file_path.relative_to(project_root).parts
    return (
            file_path.name in INCLUDE_FILES or
            (parts and parts[0] in INCLUDE_DIRS and (file_path.suffix in INCLUDE_EXTENSIONS or file_path.suffix in LIGHTWEIGHT_EXTENSIONS))
    )


def collect_files(light=False, include_ui=False):
    """–°–æ–±–∏—Ä–∞–µ—Ç –≤—Å–µ —Ñ–∞–π–ª—ã, —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–∏–µ –∫—Ä–∏—Ç–µ—Ä–∏—è–º."""
    included = []
    for root, dirs, files in os.walk(project_root, topdown=True):
        # –ü—Ä–µ–æ–±—Ä–∞–∑—É–µ–º root –≤ Path –¥–ª—è —É–¥–æ–±—Å—Ç–≤–∞
        root_path = Path(root)

        # –≠—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ –æ—Ç—Å–µ–∫–∞–µ–º –Ω–µ–Ω—É–∂–Ω—ã–µ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏
        dirs[:] = [d for d in dirs if (root_path / d).relative_to(project_root).as_posix() not in EXCLUDE_DIRS and d not in EXCLUDE_DIRS]

        for file in files:
            path = root_path / file
            if is_excluded(path, include_ui=include_ui):
                continue
            if is_included(path, light):
                included.append(path)
    return included


def summarize_structure(grouped, included_files):
    """–°–æ–∑–¥–∞–µ—Ç —Ç–µ–∫—Å—Ç–æ–≤–æ–µ –ø—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω–∏–µ —Å—Ç—Ä—É–∫—Ç—É—Ä—ã –ø—Ä–æ–µ–∫—Ç–∞."""
    lines = ["# üìÅ –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –ø—Ä–æ–µ–∫—Ç–∞"]
    # –°–æ–∑–¥–∞–µ–º –º–Ω–æ–∂–µ—Å—Ç–≤–æ –ø—É—Ç–µ–π –¥–ª—è –±—ã—Å—Ç—Ä–æ–π –ø—Ä–æ–≤–µ—Ä–∫–∏ –Ω–∞–ª–∏—á–∏—è —Ñ–∞–π–ª–∞
    included_set = {str(f.relative_to(project_root)) for f in included_files}

    for folder in sorted(grouped):
        lines.append(f"\n### `{folder if folder != '.' else '.'}`")
        for file_path_str in sorted(grouped[folder]):
            if file_path_str not in included_set:
                continue

            file_path = project_root / file_path_str
            # <<< –ò–ó–ú–ï–ù–ï–ù–ò–ï: –∏–∫–æ–Ω–∫–∞ —Ç–µ–ø–µ—Ä—å –∑–∞–≤–∏—Å–∏—Ç –æ—Ç —Ç–∏–ø–∞ —Ñ–∞–π–ª–∞, –∞ –Ω–µ –æ—Ç —É—Å–µ—á–µ–Ω–∏—è
            icon = "üìÑ" if file_path.suffix not in LIGHTWEIGHT_EXTENSIONS else "üñºÔ∏è"
            star = "‚≠ê" if file_path.name in IMPORTANT_FILES else ""
            lines.append(f"- {star} ‚úÖ `{file_path_str}`") # –£–±—Ä–∞–ª–∏ ‚ö†Ô∏è, —Ç–∞–∫ –∫–∞–∫ —É—Å–µ—á–µ–Ω–∏–µ –±–æ–ª—å—à–µ –Ω–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è
    return "\n".join(lines)


def write_output(included, light=False):
    """–ó–∞–ø–∏—Å—ã–≤–∞–µ—Ç —Å–æ–±—Ä–∞–Ω–Ω—ã–π –∫–æ–¥ –≤ –≤—ã—Ö–æ–¥–Ω–æ–π —Ñ–∞–π–ª."""
    grouped = defaultdict(list)
    for file in included:
        rel_path = file.relative_to(project_root)
        grouped[str(rel_path.parent)].append(str(rel_path))

    with open(output_filename, "w", encoding="utf-8") as out:
        out.write("# ü§ñ –°–∂–∞—Ç—ã–π –∏—Å—Ö–æ–¥–Ω—ã–π –∫–æ–¥ —Ñ—Ä–æ–Ω—Ç–µ–Ω–¥–∞ –¥–ª—è AI-–ø–æ–º–æ—â–Ω–∏–∫–∞\n\n")

        # --- –°–µ–∫—Ü–∏—è –Ω–∞–≤–∏–≥–∞—Ü–∏–∏ ---
        out.write("## üîó –ë—ã—Å—Ç—Ä–∞—è –Ω–∞–≤–∏–≥–∞—Ü–∏—è –ø–æ —Ñ–∞–π–ª–∞–º\n")
        for path in sorted(included, key=lambda p: str(p.relative_to(project_root))):
            rel_path_str = str(path.relative_to(project_root)).replace("\\", "/")
            anchor = rel_path_str.replace("/", "").replace(".", "")
            out.write(f"- [{rel_path_str}](#{anchor})\n")
        out.write("\n---\n\n")

        # --- –°–µ–∫—Ü–∏—è —Å—Ç—Ä—É–∫—Ç—É—Ä—ã ---
        structure = summarize_structure(grouped, included)
        out.write(structure)
        out.write("\n\n---\n")

        # --- –°–µ–∫—Ü–∏—è —Å –∫–æ–¥–æ–º ---
        for path in sorted(included, key=lambda p: str(p.relative_to(project_root))):
            rel_path = path.relative_to(project_root)
            rel_path_str = str(rel_path).replace("\\", "/")
            anchor = rel_path_str.replace("/", "").replace(".", "")

            out.write(f'\n\n## <a name="{anchor}"></a>`{rel_path_str}`\n\n')

            # <<< –ò–ó–ú–ï–ù–ï–ù–ò–ï: –°–ø–µ—Ü–∏–∞–ª—å–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ –¥–ª—è "–ª–µ–≥–∫–æ–≤–µ—Å–Ω—ã—Ö" —Ñ–∞–π–ª–æ–≤
            if path.suffix in LIGHTWEIGHT_EXTENSIONS:
                out.write(f"```\n\n```\n")
                continue

            # –û–ø—Ä–µ–¥–µ–ª—è–µ–º —è–∑—ã–∫ –¥–ª—è –ø–æ–¥—Å–≤–µ—Ç–∫–∏ —Å–∏–Ω—Ç–∞–∫—Å–∏—Å–∞
            lang_map = {'.tsx': 'tsx', '.ts': 'typescript', '.css': 'css', '.js': 'javascript', '.json': 'json'}
            lang = lang_map.get(path.suffix, 'html')

            block = [f"```{lang}"]
            try:
                # <<< –ò–ó–ú–ï–ù–ï–ù–ò–ï: –£–±—Ä–∞–Ω –º–µ—Ö–∞–Ω–∏–∑–º —É—Å–µ—á–µ–Ω–∏—è. –õ—É—á—à–µ –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–∏—Ç—å –ø–æ–ª–Ω—ã–π –∫–æ–¥, –µ—Å–ª–∏ —Ñ–∞–π–ª –≤–∫–ª—é—á–µ–Ω.
                content = path.read_text(encoding="utf-8")
                # –î–æ–±–∞–≤–ª—è–µ–º –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π —Å –ø—É—Ç–µ–º –∫ —Ñ–∞–π–ª—É –¥–ª—è –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ–≥–æ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞
                block.insert(1, f"// {rel_path_str}\n")
                block.append(content)
            except Exception as e:
                block.append(f"# –û—à–∏–±–∫–∞ —á—Ç–µ–Ω–∏—è —Ñ–∞–π–ª–∞: {e}")
            block.append("\n```\n")
            out.write("\n".join(block))

        # --- –°–µ–∫—Ü–∏—è –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π ---
        pkg_path = project_root / "package.json"
        if pkg_path.exists():
            try:
                pkg_data = json.loads(pkg_path.read_text(encoding="utf-8"))
                deps = pkg_data.get("dependencies", {})
                dev_deps = pkg_data.get("devDependencies", {})

                out.write("\n\n## üì¶ –ó–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –ø—Ä–æ–µ–∫—Ç–∞\n\n")
                for name, version in sorted(deps.items()):
                    out.write(f"- `{name}`: {version}\n")

                if dev_deps:
                    out.write("\n### Dev-–∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏\n\n")
                    for name, version in sorted(dev_deps.items()):
                        out.write(f"- `{name}`: {version}\n")

            except Exception as e:
                out.write(f"\n\n## –û—à–∏–±–∫–∞ —á—Ç–µ–Ω–∏—è package.json: {e}\n")

def main():
    parser = argparse.ArgumentParser(description="–°–±–æ—Ä—â–∏–∫ –∫–æ–¥–∞ –ø—Ä–æ–µ–∫—Ç–∞ –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞ –ò–ò.")
    parser.add_argument("--light", action="store_true", help="–°–æ–±—Ä–∞—Ç—å —Ç–æ–ª—å–∫–æ –∫–ª—é—á–µ–≤—ã–µ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏ (pages, components, hooks, store, lib, types, utils).")
    parser.add_argument("--include-ui", action="store_true", help="–í–∫–ª—é—á–∏—Ç—å –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã –∏–∑ src/components/ui.")
    args = parser.parse_args()

    print("–°–±–æ—Ä–∫–∞ —Ñ–∞–π–ª–æ–≤...")
    included_files = collect_files(light=args.light, include_ui=args.include_ui)

    print(f"–ù–∞–π–¥–µ–Ω–æ {len(included_files)} —Ñ–∞–π–ª–æ–≤ –¥–ª—è –≤–∫–ª—é—á–µ–Ω–∏—è.")
    write_output(included_files, light=args.light)

    print(f"‚úÖ –§–∞–π–ª '{output_filename.name}' —É—Å–ø–µ—à–Ω–æ —Å–æ–∑–¥–∞–Ω.")

if __name__ == "__main__":
    main()

```


## <a name="rentalappmainsplitoptimizedgemNEW1py"></a>`rental-app-main/split_optimized_gem_NEW_1.py`

```python
// path: rental-app-main/split_optimized_gem_NEW_1.py

import os
import json
import fnmatch
import argparse
from pathlib import Path
from collections import defaultdict
import re # ### –ò–ó–ú–ï–ù–ï–ù–ò–ï: –î–æ–±–∞–≤–ª–µ–Ω –º–æ–¥—É–ª—å –¥–ª—è —Ä–µ–≥—É–ª—è—Ä–Ω—ã—Ö –≤—ã—Ä–∞–∂–µ–Ω–∏–π

# <<< –ò–ó–ú–ï–ù–ï–ù–ò–ï: –ü—É—Ç—å –∫ –ø—Ä–æ–µ–∫—Ç—É –æ–ø—Ä–µ–¥–µ–ª—è–µ—Ç—Å—è –æ—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω–æ —Å–∫—Ä–∏–ø—Ç–∞
project_root = Path(__file__).resolve().parent
output_filename = project_root / "smart_react_code_gem_v2.md"

# --- –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –≤–∫–ª—é—á–µ–Ω–∏–π ---
INCLUDE_DIRS = {"src", "public"}
INCLUDE_FILES = {
    "package.json",
    "tsconfig.json", "tsconfig.node.json", "tsconfig.app.json",
    'tailwind.config.js', 'postcss.config.js', 'vite.config.ts',
}
INCLUDE_EXTENSIONS = {".tsx", ".ts", ".css", ".js"}
LIGHTWEIGHT_EXTENSIONS = {".svg"}

# --- –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –∏—Å–∫–ª—é—á–µ–Ω–∏–π ---
EXCLUDE_DIRS = {".git", ".venv", "node_modules", ".idea", ".vscode", "dist", "build"}
EXCLUDE_FILES = {"*.pyc", "*.pyo", "*.db", "__init__.py", "package-lock.json"}
EXCLUDED_UI_COMPONENTS = {"src/components/ui"}

# --- –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –¥–ª—è —É–ª—É—á—à–µ–Ω–∏—è —á–∏—Ç–∞–µ–º–æ—Å—Ç–∏ ---
IMPORTANT_FILES = {
    "App.tsx", "HomePage.tsx", "ReservePage.tsx", "AdminPanelPage.tsx"
}
# <<< –ò–ó–ú–ï–ù–ï–ù–ò–ï: –ù–æ–≤–∞—è, –±–æ–ª–µ–µ –≥–∏–±–∫–∞—è —Å–∏—Å—Ç–µ–º–∞ –ø—Ä–æ—Ñ–∏–ª–µ–π ---
PROFILES = {
    "full": {
        "include_dirs": {"src", "public"},
        "description": "–ü–æ–ª–Ω–∞—è —Å–±–æ—Ä–∫–∞ –≤—Å–µ–≥–æ –ø—Ä–æ–µ–∫—Ç–∞."
    },
    "light": {
        "include_dirs": {"src/pages", "src/components", "src/hooks", "src/store", "src/lib", "src/types", "src/utils", "src/contexts", "src/constants"},
        "description": "–°–±–æ—Ä–∫–∞ —Ç–æ–ª—å–∫–æ –∫–ª—é—á–µ–≤—ã—Ö –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–π —Å –±–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫–æ–π."
    },
    "user": {
        "include_dirs": {"src/pages", "src/components", "src/hooks", "src/store", "src/lib", "src/types", "src/utils", "src/contexts", "src/constants"},
        "exclude_paths": {"src/pages/admin", "src/components/admin"},
        "description": "–°–±–æ—Ä–∫–∞ —Ç–æ–ª—å–∫–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–æ–π —á–∞—Å—Ç–∏ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è (–±–µ–∑ –∞–¥–º–∏–Ω–∫–∏)."
    },
    "admin": {
        "include_dirs": {"src/pages/admin", "src/components/admin", "src/hooks/admin", "src/store", "src/lib", "src/types", "src/utils", "src/hooks/useAdmin"},
        "description": "–°–±–æ—Ä–∫–∞ —Ç–æ–ª—å–∫–æ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–∏–≤–Ω–æ–π —á–∞—Å—Ç–∏ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è."
    }
}


def is_excluded(file_path: Path, profile_config: dict, include_ui=False) -> bool:
    """–ü—Ä–æ–≤–µ—Ä—è–µ—Ç, –¥–æ–ª–∂–µ–Ω –ª–∏ —Ñ–∞–π–ª –±—ã—Ç—å –ø–æ–ª–Ω–æ—Å—Ç—å—é –∏—Å–∫–ª—é—á–µ–Ω."""
    rel_path_posix = file_path.relative_to(project_root).as_posix()

    if not include_ui and any(ex_dir in rel_path_posix for ex_dir in EXCLUDED_UI_COMPONENTS):
        return True

    # <<< –ò–ó–ú–ï–ù–ï–ù–ò–ï: –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ –∏—Å–∫–ª—é—á–µ–Ω–∏—è –∏–∑ –ø—Ä–æ—Ñ–∏–ª—è
    if "exclude_paths" in profile_config and any(ex_path in rel_path_posix for ex_path in profile_config["exclude_paths"]):
        return True

    return any(fnmatch.fnmatch(file_path.name, pattern) for pattern in EXCLUDE_FILES)


def is_included(file_path: Path, profile_config: dict) -> bool:
    """–ü—Ä–æ–≤–µ—Ä—è–µ—Ç, –¥–æ–ª–∂–µ–Ω –ª–∏ —Ñ–∞–π–ª –±—ã—Ç—å –≤–∫–ª—é—á–µ–Ω –≤ —Å–±–æ—Ä–∫—É –Ω–∞ –æ—Å–Ω–æ–≤–µ –ø—Ä–æ—Ñ–∏–ª—è."""
    rel_path_posix = file_path.relative_to(project_root).as_posix()

    # –í–∫–ª—é—á–∞–µ–º –∫–ª—é—á–µ–≤—ã–µ —Ñ–∞–π–ª—ã –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ –≤—Å–µ–≥–¥–∞
    if file_path.name in INCLUDE_FILES:
        return True

    # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–∞—Ö–æ–¥–∏—Ç—Å—è –ª–∏ —Ñ–∞–π–ª –≤ –æ–¥–Ω–æ–π –∏–∑ —Ä–∞–∑—Ä–µ—à–µ–Ω–Ω—ã—Ö –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–π –ø—Ä–æ—Ñ–∏–ª—è
    if not any(rel_path_posix.startswith(d) for d in profile_config["include_dirs"]):
        return False

    # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ä–∞—Å—à–∏—Ä–µ–Ω–∏–µ —Ñ–∞–π–ª–∞
    return file_path.suffix in INCLUDE_EXTENSIONS or file_path.suffix in LIGHTWEIGHT_EXTENSIONS


def collect_files(profile: str, include_ui=False):
    """–°–æ–±–∏—Ä–∞–µ—Ç –≤—Å–µ —Ñ–∞–π–ª—ã, —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–∏–µ –≤—ã–±—Ä–∞–Ω–Ω–æ–º—É –ø—Ä–æ—Ñ–∏–ª—é."""
    if profile not in PROFILES:
        raise ValueError(f"–ü—Ä–æ—Ñ–∏–ª—å '{profile}' –Ω–µ –Ω–∞–π–¥–µ–Ω.")
    profile_config = PROFILES[profile]
    print(f"–ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –ø—Ä–æ—Ñ–∏–ª—å: '{profile}' ({profile_config['description']})")

    included = []
    for root, dirs, files in os.walk(project_root, topdown=True):
        root_path = Path(root)
        dirs[:] = [d for d in dirs if (root_path / d).relative_to(project_root).as_posix() not in EXCLUDE_DIRS and d not in EXCLUDE_DIRS]

        for file in files:
            path = root_path / file
            if is_excluded(path, profile_config, include_ui=include_ui):
                continue
            if is_included(path, profile_config):
                included.append(path)
    return included

# <<< –ò–ó–ú–ï–ù–ï–ù–ò–ï: –ü–æ–ª–Ω–æ—Å—Ç—å—é –ø–µ—Ä–µ–ø–∏—Å–∞–Ω–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –∏–µ—Ä–∞—Ä—Ö–∏—á–µ—Å–∫–æ–≥–æ –¥–µ—Ä–µ–≤–∞ ---
def generate_tree_structure(included_files):
    """–°–æ–∑–¥–∞–µ—Ç —Ç–µ–∫—Å—Ç–æ–≤–æ–µ –ø—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω–∏–µ –∏–µ—Ä–∞—Ä—Ö–∏—á–µ—Å–∫–æ–π —Å—Ç—Ä—É–∫—Ç—É—Ä—ã –ø—Ä–æ–µ–∫—Ç–∞."""
    tree = defaultdict(list)
    for path in included_files:
        rel_path = path.relative_to(project_root)
        parent = str(rel_path.parent)
        tree[parent].append(rel_path)

    lines = ["# üìÅ –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –ø—Ä–æ–µ–∫—Ç–∞ (–∏–µ—Ä–∞—Ä—Ö–∏—è)"]

    def build_tree(folder: str, prefix: str = ""):
        # –ü–æ–ª—É—á–∞–µ–º –∏ —Å–æ—Ä—Ç–∏—Ä—É–µ–º —Ñ–∞–π–ª—ã –∏ –ø–æ–¥–ø–∞–ø–∫–∏
        files = sorted([f for f in tree.get(folder, []) if f.parent.name == folder or folder == '.'])
        subfolders = sorted([d for d in tree if Path(d).parent == Path(folder) and d != folder])

        # –°–Ω–∞—á–∞–ª–∞ –≤—ã–≤–æ–¥–∏–º –ø–æ–¥–ø–∞–ø–∫–∏
        for i, subfolder in enumerate(subfolders):
            is_last = (i == len(subfolders) - 1) and (len(files) == 0)
            lines.append(f"{prefix}{'‚îî‚îÄ‚îÄ ' if is_last else '‚îú‚îÄ‚îÄ '}`{Path(subfolder).name}/`")
            build_tree(subfolder, prefix + ('    ' if is_last else '‚îÇ   '))

        # –ó–∞—Ç–µ–º –≤—ã–≤–æ–¥–∏–º —Ñ–∞–π–ª—ã
        for i, file_path in enumerate(files):
            is_last = i == len(files) - 1
            icon = "üñºÔ∏è" if file_path.suffix in LIGHTWEIGHT_EXTENSIONS else "üìÑ"
            star = "‚≠ê" if file_path.name in IMPORTANT_FILES else ""
            lines.append(f"{prefix}{'‚îî‚îÄ‚îÄ ' if is_last else '‚îú‚îÄ‚îÄ '}{star}{icon} `{file_path.name}`")

    lines.append(f"`{project_root.name}/`")
    build_tree('.', '    ')
    return "\n".join(lines)


def write_output(included, strip_comments=False, strip_empty_lines=False):
    """–ó–∞–ø–∏—Å—ã–≤–∞–µ—Ç —Å–æ–±—Ä–∞–Ω–Ω—ã–π –∫–æ–¥ –≤ –≤—ã—Ö–æ–¥–Ω–æ–π —Ñ–∞–π–ª —Å –æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ–π –æ—á–∏—Å—Ç–∫–æ–π."""
    with open(output_filename, "w", encoding="utf-8") as out:
        out.write("# ü§ñ –°–∂–∞—Ç—ã–π –∏—Å—Ö–æ–¥–Ω—ã–π –∫–æ–¥ —Ñ—Ä–æ–Ω—Ç–µ–Ω–¥–∞ –¥–ª—è AI-–ø–æ–º–æ—â–Ω–∏–∫–∞\n\n")

        # --- –°–µ–∫—Ü–∏—è –Ω–∞–≤–∏–≥–∞—Ü–∏–∏ ---
        out.write("## üîó –ë—ã—Å—Ç—Ä–∞—è –Ω–∞–≤–∏–≥–∞—Ü–∏—è –ø–æ —Ñ–∞–π–ª–∞–º\n")
        for path in sorted(included, key=lambda p: str(p.relative_to(project_root))):
            rel_path_str = str(path.relative_to(project_root)).replace("\\", "/")
            anchor = rel_path_str.replace("/", "").replace(".", "")
            out.write(f"- [{rel_path_str}](#{anchor})\n")
        out.write("\n---\n\n")

        # --- –°–µ–∫—Ü–∏—è —Å—Ç—Ä—É–∫—Ç—É—Ä—ã (–Ω–æ–≤–æ–µ –∏–µ—Ä–∞—Ä—Ö–∏—á–µ—Å–∫–æ–µ –¥–µ—Ä–µ–≤–æ) ---
        structure = generate_tree_structure(included)
        out.write(structure)
        out.write("\n\n---\n")

        # --- –°–µ–∫—Ü–∏—è —Å –∫–æ–¥–æ–º ---
        for path in sorted(included, key=lambda p: str(p.relative_to(project_root))):
            rel_path = path.relative_to(project_root)
            rel_path_str = str(rel_path).replace("\\", "/")
            anchor = rel_path_str.replace("/", "").replace(".", "")
            out.write(f'\n\n## <a name="{anchor}"></a>`{rel_path_str}`\n\n')

            if path.suffix in LIGHTWEIGHT_EXTENSIONS:
                out.write(f"```\n[–°–æ–¥–µ—Ä–∂–∏–º–æ–µ SVG —Ñ–∞–π–ª–∞ '{path.name}' –Ω–µ –≤–∫–ª—é—á–µ–Ω–æ –¥–ª—è —ç–∫–æ–Ω–æ–º–∏–∏ –º–µ—Å—Ç–∞]\n```\n")
                continue

            lang_map = {'.tsx': 'tsx', '.ts': 'typescript', '.css': 'css', '.js': 'javascript', '.json': 'json'}
            lang = lang_map.get(path.suffix, '')

            block = [f"```{lang}"]
            try:
                content = path.read_text(encoding="utf-8")

                # <<< –ò–ó–ú–ï–ù–ï–ù–ò–ï: –û–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–∞—è –æ—á–∏—Å—Ç–∫–∞ –∫–æ–Ω—Ç–µ–Ω—Ç–∞ ---
                if strip_comments:
                    content = re.sub(r'//.*|/\*[\s\S]*?\*/', '', content)
                if strip_empty_lines:
                    content = "\n".join([line for line in content.splitlines() if line.strip()])

                block.insert(1, f"// path: {rel_path_str}\n")
                block.append(content)
            except Exception as e:
                block.append(f"# –û—à–∏–±–∫–∞ —á—Ç–µ–Ω–∏—è —Ñ–∞–π–ª–∞: {e}")
            block.append("\n```\n")
            out.write("\n".join(block))

        # --- –°–µ–∫—Ü–∏—è –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π ---
        pkg_path = project_root / "package.json"
        if pkg_path.exists():
            try:
                pkg_data = json.loads(pkg_path.read_text(encoding="utf-8"))
                deps = pkg_data.get("dependencies", {})
                dev_deps = pkg_data.get("devDependencies", {})

                out.write("\n\n## üì¶ –ó–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –ø—Ä–æ–µ–∫—Ç–∞\n\n")
                if deps:
                    for name, version in sorted(deps.items()):
                        out.write(f"- `{name}`: {version}\n")
                else:
                    out.write("–û—Å–Ω–æ–≤–Ω—ã–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã.\n")

                if dev_deps:
                    out.write("\n### Dev-–∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏\n\n")
                    for name, version in sorted(dev_deps.items()):
                        out.write(f"- `{name}`: {version}\n")
                else:
                    out.write("Dev-–∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã.\n")
            except Exception as e:
                out.write(f"\n\n## –û—à–∏–±–∫–∞ —á—Ç–µ–Ω–∏—è package.json: {e}\n")


def main():
    parser = argparse.ArgumentParser(description="–°–±–æ—Ä—â–∏–∫ –∫–æ–¥–∞ –ø—Ä–æ–µ–∫—Ç–∞ –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞ –ò–ò.")
    # <<< –ò–ó–ú–ï–ù–ï–ù–ò–ï: –ó–∞–º–µ–Ω–∞ --light –Ω–∞ --profile ---
    parser.add_argument("--profile", default="full", choices=PROFILES.keys(),
                        help="–ü—Ä–æ—Ñ–∏–ª—å —Å–±–æ—Ä–∫–∏: full, light, user, admin.")
    parser.add_argument("--include-ui", action="store_true", help="–í–∫–ª—é—á–∏—Ç—å –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã –∏–∑ src/components/ui.")
    # <<< –ò–ó–ú–ï–ù–ï–ù–ò–ï: –ù–æ–≤—ã–µ —Ñ–ª–∞–≥–∏ –¥–ª—è –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏ ---
    parser.add_argument("--strip-comments", action="store_true", help="–£–¥–∞–ª–∏—Ç—å –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏ –∏–∑ –∫–æ–¥–∞.")
    parser.add_argument("--strip-empty-lines", action="store_true", help="–£–¥–∞–ª–∏—Ç—å –ø—É—Å—Ç—ã–µ —Å—Ç—Ä–æ–∫–∏ –∏–∑ –∫–æ–¥–∞.")

    args = parser.parse_args()

    print("–°–±–æ—Ä–∫–∞ —Ñ–∞–π–ª–æ–≤...")
    included_files = collect_files(profile=args.profile, include_ui=args.include_ui)

    print(f"–ù–∞–π–¥–µ–Ω–æ {len(included_files)} —Ñ–∞–π–ª–æ–≤ –¥–ª—è –≤–∫–ª—é—á–µ–Ω–∏—è.")
    write_output(included_files, strip_comments=args.strip_comments, strip_empty_lines=args.strip_empty_lines)

    print(f"‚úÖ –§–∞–π–ª '{output_filename.name}' —É—Å–ø–µ—à–Ω–æ —Å–æ–∑–¥–∞–Ω.")

if __name__ == "__main__":
    main()

```


## <a name="rentalappmainsplitoptimizedgrokpy"></a>`rental-app-main/split_optimized_grok.py`

```python
// path: rental-app-main/split_optimized_grok.py

import os
import json
import fnmatch
import argparse
from pathlib import Path
from collections import defaultdict

project_root = Path(__file__).resolve().parent
output_filename = project_root / "smart_react_code_grok.md"

INCLUDE_DIRS = {"src", "public"}
INCLUDE_FILES = {
    "App.tsx", "main.tsx", "package.json",
    "tsconfig.json", "tsconfig.node.json", "tsconfig.app.json", "vite.config.json", 'tailwind.config.js', 'postcss.config.js', 'vite.config.ts',
    'postcss.config.cjs'
}
INCLUDE_EXTENSIONS = {".tsx", ".html", ".ts", ".svg", ".css", ".js", ".txt"}

EXCLUDE_DIRS = {".git", ".venv", "node_modules", ".idea", ".vscode", "dist", "build"}
EXCLUDE_FILES = {"*.pyc", "*.pyo", "*.db", "__init__.py", "package-lock.json"}  # –ò—Å–∫–ª—é—á–µ–Ω package-lock.json –∏–∑-–∑–∞ —Ä–∞–∑–º–µ—Ä–∞

EXCLUDED_UI_COMPONENTS = {"src/components/ui"}

IMPORTANT_FILES = {
    "App.tsx", "HomePage.tsx", "ReservePage.tsx", "ReserveEditPage.tsx"
}

MAX_LINES = 200  # –£–º–µ–Ω—å—à–µ–Ω–æ –¥–ª—è –±–æ–ª–µ–µ –∞–≥—Ä–µ—Å—Å–∏–≤–Ω–æ–π —É—Å–µ—á–µ–Ω–∏—è
TRUNCATE_LINES = 30  # –£–º–µ–Ω—å—à–µ–Ω–æ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Å—Ç—Ä–æ–∫ –¥–ª—è —É—Å–µ—á–µ–Ω–∏—è
MAX_TOTAL_SIZE_KB = 200  # –ù–æ–≤—ã–π –ª–∏–º–∏—Ç: –º–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–π —Ä–∞–∑–º–µ—Ä –≤—ã—Ö–æ–¥–Ω–æ–≥–æ —Ñ–∞–π–ª–∞ –≤ KB (–ø—Ä–∏–º–µ—Ä–Ω–æ 200k —Å–∏–º–≤–æ–ª–æ–≤ ~ 200KB)


def is_excluded(file_path: Path, include_ui=False) -> bool:
    if not include_ui:
        for excluded_dir in EXCLUDED_UI_COMPONENTS:
            if excluded_dir in str(file_path).replace("\\", "/"):
                return True
    return any(fnmatch.fnmatch(file_path.name, pattern) for pattern in EXCLUDE_FILES)


def is_included(file_path: Path, light=False) -> bool:
    parts = file_path.relative_to(project_root).parts
    if light and not any(part in ["components", "pages", "types", "hooks", "store", "utils", "lib"] for part in parts):
        return False
    return (
            file_path.name in INCLUDE_FILES or
            (parts and parts[0] in INCLUDE_DIRS and file_path.suffix in INCLUDE_EXTENSIONS)
    )


def collect_files(light=False, include_ui=False):
    included = []
    for root, dirs, files in os.walk(project_root):
        dirs[:] = [d for d in dirs if d not in EXCLUDE_DIRS]
        for file in files:
            path = Path(root) / file
            rel_path = path.relative_to(project_root)
            if any(part in EXCLUDE_DIRS for part in rel_path.parts):
                continue
            if is_excluded(path, include_ui=include_ui):
                continue
            if is_included(path, light):
                included.append(path)
    return included


def summarize_structure(grouped, truncation_map):
    lines = ["# üìÅ –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –ø—Ä–æ–µ–∫—Ç–∞"]
    for folder in sorted(grouped):
        lines.append(f"\n### `{folder}`")
        for file in sorted(grouped[folder], key=lambda x: str(x)):
            rel = file.relative_to(project_root)
            icon = "‚ö†Ô∏è" if truncation_map.get(str(rel)) else "‚úÖ"
            star = "‚≠ê" if rel.name in IMPORTANT_FILES else ""
            lines.append(f"- {star} {icon} `{rel}`")
    return "\n".join(lines)


def estimate_size(content: str) -> int:
    return len(content.encode('utf-8')) // 1024  # –†–∞–∑–º–µ—Ä –≤ KB


def write_output(included):
    truncation_map = {}
    grouped = defaultdict(list)
    for file in included:
        grouped[str(file.relative_to(project_root).parent)].append(file)

    content_parts = []
    current_size = 0

    content_parts.append("# ü§ñ –°–∂–∞—Ç—ã–π –∏—Å—Ö–æ–¥–Ω—ã–π –∫–æ–¥ —Ñ—Ä–æ–Ω—Ç–µ–Ω–¥–∞ –¥–ª—è AI-–ø–æ–º–æ—â–Ω–∏–∫–∞\n\n")

    content_parts.append("## üîó –ë—ã—Å—Ç—Ä–∞—è –Ω–∞–≤–∏–≥–∞—Ü–∏—è –ø–æ —Ñ–∞–π–ª–∞–º\n")
    for path in sorted(included, key=lambda p: str(p.relative_to(project_root))):
        rel_path = path.relative_to(project_root)
        anchor = str(rel_path).replace("/", "").replace(".", "").replace("\\", "")
        content_parts.append(f"- [{rel_path}](#{anchor})\n")
    content_parts.append("\n---\n\n")

    structure = summarize_structure(grouped, truncation_map)
    content_parts.append(structure)
    content_parts.append("\n\n---\n")

    # –°–æ—Ä—Ç–∏—Ä—É–µ–º —Ñ–∞–π–ª—ã: —Å–Ω–∞—á–∞–ª–∞ –≤–∞–∂–Ω—ã–µ, –ø–æ—Ç–æ–º –æ—Å—Ç–∞–ª—å–Ω—ã–µ
    sorted_included = sorted(
        included,
        key=lambda p: (0 if p.name in IMPORTANT_FILES else 1, str(p.relative_to(project_root)))
    )

    for path in sorted_included:
        rel_path = path.relative_to(project_root)
        ext = path.suffix
        block = [f"\n\n## `{rel_path}`\n\n"]
        block.append("```python\n" if ext == ".py" else "```html\n")

        try:
            lines = path.read_text(encoding="utf-8").splitlines()
            if len(lines) > MAX_LINES:
                truncation_map[str(rel_path)] = True
                block.extend(lines[:TRUNCATE_LINES])
                block.append(f"# ... truncated ({len(lines)} lines total)")
                block.append("# ‚ö†Ô∏è –ü–æ–ª–Ω—ã–π –∫–æ–¥ –¥–æ—Å—Ç—É–ø–µ–Ω –≤ –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω–æ–º —Ñ–∞–π–ª–µ")
            else:
                block.extend(lines)
        except Exception as e:
            block.append(f"# –û—à–∏–±–∫–∞ —á—Ç–µ–Ω–∏—è —Ñ–∞–π–ª–∞: {e}")
        block.append("\n```\n")

        new_block = "\n".join(block)
        block_size = estimate_size(new_block)
        if current_size + block_size > MAX_TOTAL_SIZE_KB:
            content_parts.append("\n\n# ‚ö†Ô∏è –§–∞–π–ª —É—Å–µ—á–µ–Ω: –ø—Ä–µ–≤—ã—à–µ–Ω –ª–∏–º–∏—Ç —Ä–∞–∑–º–µ—Ä–∞. –ò—Å–∫–ª—é—á–µ–Ω—ã –º–µ–Ω–µ–µ –∫—Ä–∏—Ç–∏—á–Ω—ã–µ —Ñ–∞–π–ª—ã.\n")
            break  # –ü—Ä–µ–∫—Ä–∞—â–∞–µ–º –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ, –µ—Å–ª–∏ –ø—Ä–µ–≤—ã—à–µ–Ω –ª–∏–º–∏—Ç
        content_parts.append(new_block)
        current_size += block_size

    pkg_path = project_root / "package.json"
    if pkg_path.exists():
        try:
            deps = json.loads(pkg_path.read_text(encoding="utf-8")).get("dependencies", {})
            content_parts.append("\n\n## üì¶ –ó–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –ø—Ä–æ–µ–∫—Ç–∞\n\n")
            for name, version in sorted(deps.items()):
                content_parts.append(f"- `{name}`: {version}\n")
        except Exception as e:
            content_parts.append(f"\n\n## –û—à–∏–±–∫–∞ —á—Ç–µ–Ω–∏—è package.json: {e}\n")

    full_content = "".join(content_parts)
    with open(output_filename, "w", encoding="utf-8") as out:
        out.write(full_content)


def main():
    parser = argparse.ArgumentParser()
    parser.add_argument("--no-light", action="store_true", help="–û—Ç–∫–ª—é—á–∏—Ç—å light —Ä–µ–∂–∏–º (—Å–æ–±—Ä–∞—Ç—å –≤—Å–µ —Ñ–∞–π–ª—ã –≤–º–µ—Å—Ç–æ –∫–ª—é—á–µ–≤—ã—Ö)")
    parser.add_argument("--include-ui", action="store_true", help="–í–∫–ª—é—á–∏—Ç—å –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã –∏–∑ src/components/ui")
    args = parser.parse_args()
    light = not args.no_light  # –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é light=True, --no-light –æ—Ç–∫–ª—é—á–∞–µ—Ç
    included_files = collect_files(light=light, include_ui=args.include_ui)
    write_output(included_files)

    readme_path = project_root / "README_AI.md"
    with open(readme_path, "w", encoding="utf-8") as readme:
        readme.write("# üìò –ò–Ω—Å—Ç—Ä—É–∫—Ü–∏—è –¥–ª—è AI-–ø–æ–º–æ—â–Ω–∏–∫–∞\n\n")
        readme.write("–≠—Ç–æ—Ç –ø—Ä–æ–µ–∫—Ç —Å–æ–±—Ä–∞–Ω —Å–∫—Ä–∏–ø—Ç–æ–º `split_optimized.py` –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞ –ò–ò.\n\n")
        readme.write("## üìÇ –°–æ–¥–µ—Ä–∂–∏–º–æ–µ\n")
        readme.write("- `smart_react_code.md` ‚Äî –æ—Å–Ω–æ–≤–Ω–æ–π —Ñ–∞–π–ª —Å –∫–æ–¥–æ–º\n")
        readme.write("- `README_AI.md` ‚Äî —ç—Ç–∞ –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—è\n\n")
        readme.write("## üöÄ –ö–∞–∫ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å\n")
        readme.write("–ü–µ—Ä–µ–¥–∞–π `smart_react_code.md` –≤ AI-–ø–æ–º–æ—â–Ω–∏–∫. –û–Ω —Å–æ–¥–µ—Ä–∂–∏—Ç —Å—Ç—Ä—É–∫—Ç—É—Ä—É, –æ–≥–ª–∞–≤–ª–µ–Ω–∏–µ, –∫–ª—é—á–µ–≤—ã–µ —É—á–∞—Å—Ç–∫–∏ –∫–æ–¥–∞.\n")
        readme.write("–ü–æ —É–º–æ–ª—á–∞–Ω–∏—é –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è light —Ä–µ–∂–∏–º –¥–ª—è —É–º–µ–Ω—å—à–µ–Ω–∏—è —Ä–∞–∑–º–µ—Ä–∞ (—Ç–æ–ª—å–∫–æ –∫–ª—é—á–µ–≤—ã–µ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏: components, pages, types, hooks, store, utils, lib). –ß—Ç–æ–±—ã —Å–æ–±—Ä–∞—Ç—å –≤—Å–µ —Ñ–∞–π–ª—ã, –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ --no-light.\n")
        readme.write("UI-–∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã (`src/components/ui`) –∏—Å–∫–ª—é—á–µ–Ω—ã, –≤–∫–ª—é—á–∏ –∏—Ö —Ñ–ª–∞–≥–æ–º `--include-ui` –ø—Ä–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏.\n")
        readme.write("–ú–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–π —Ä–∞–∑–º–µ—Ä —Ñ–∞–π–ª–∞ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω ~200KB –¥–ª—è –∫–æ–º—Ñ–æ—Ä—Ç–Ω–æ–π —Ä–∞–±–æ—Ç—ã —Å –∫–æ–Ω—Ç–µ–∫—Å—Ç–æ–º AI.\n")

    print(f"‚úÖ –§–∞–π–ª '{output_filename.name}' –∏ README_AI.md —É—Å–ø–µ—à–Ω–æ —Å–æ–∑–¥–∞–Ω—ã.")


if __name__ == "__main__":
    main()

```


## <a name="rentalappmainsrcappApptsx"></a>`rental-app-main/src/app/App.tsx`

```tsx
// path: rental-app-main/src/app/App.tsx

// src/app/App.tsx

import { Routes, Route } from "react-router-dom";
import HomePage from "../pages/HomePage";
import ReservePage from "../pages/ReservePage";
import ProfilePage from "../pages/ProfilePage";
import MyReservationsPage from "../pages/MyReservationsPage";
import ContactPage from "../pages/ContactPage";
import CalendarPage from "../pages/CalendarPage";
import RequireAuth from "../components/RequireAuth";
import { Toaster } from "sonner"; // <--- 1. –î–û–ë–ê–í–¨–¢–ï –≠–¢–û–¢ –ò–ú–ü–û–†–¢

// –ò–º–ø–æ—Ä—Ç—ã –¥–ª—è –∞–¥–º–∏–Ω –ø–∞–Ω–µ–ª–∏
import DashboardPage from "../pages/admin/DashboardPage";
import UserManagementPage from "../pages/UserManagementPage";
import EquipmentManagementPage from "../pages/EquipmentManagementPage";
import AccessoryManagementPage from "../pages/AccessoryManagementPage";
import AllReservationsManagementPage from "../pages/admin/AllReservationsManagementPage";
import PromoCodeManagementPage from "../pages/admin/PromoCodeManagementPage";
import CalendarTestPage from "../pages/CalendarTestPage";
import HolidayManagementPage from "../pages/admin/HolidayManagementPage";
import AssociationManagementPage from "../pages/admin/AssociationManagementPage";
import RentalManagementPage from "../pages/admin/RentalManagementPage";


function App() {
    return (
        // +++ 2. –û–ë–ï–†–ù–ò–¢–ï –í–°–ï –í –§–†–ê–ì–ú–ï–ù–¢ –ò –î–û–ë–ê–í–¨–¢–ï TOASTER +++
        <>
            <Routes>
                {/* –û—Å–Ω–æ–≤–Ω—ã–µ –º–∞—Ä—à—Ä—É—Ç—ã */}
                <Route path="/test-calendar" element={<CalendarTestPage />} />
                <Route path="/" element={<HomePage />} />
                <Route path="/reserve/create" element={<ReservePage />} />
                <Route path="/contacts" element={<ContactPage />} />
                <Route path="/calendar" element={<CalendarPage />} />

                {/* –ú–∞—Ä—à—Ä—É—Ç—ã, —Ç—Ä–µ–±—É—é—â–∏–µ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ */}
                <Route
                    path="/profile"
                    element={
                        <RequireAuth>
                            <ProfilePage />
                        </RequireAuth>
                    }
                />
                <Route
                    path="/reservations/my"
                    element={
                        <RequireAuth>
                            <MyReservationsPage />
                        </RequireAuth>
                    }
                />

                {/* –ú–∞—Ä—à—Ä—É—Ç—ã –∞–¥–º–∏–Ω-–ø–∞–Ω–µ–ª–∏ */}
                <Route
                    path="/admin"
                    element={
                        <RequireAuth role={["manager", "admin"]}>
                            <DashboardPage />
                        </RequireAuth>
                    }
                />
                <Route
                    path="/admin/rentals"
                    element={
                        <RequireAuth role={["manager", "admin"]}>
                            <RentalManagementPage />
                        </RequireAuth>
                    }
                />
                <Route
                    path="/admin/users"
                    element={
                        <RequireAuth role={["manager", "admin"]}>
                            <UserManagementPage />
                        </RequireAuth>
                    }
                />
                <Route
                    path="/admin/equipment"
                    element={
                        <RequireAuth role={["manager", "admin"]}>
                            <EquipmentManagementPage />
                        </RequireAuth>
                    }
                />
                <Route
                    path="/admin/accessories"
                    element={
                        <RequireAuth role={["manager", "admin"]}>
                            <AccessoryManagementPage />
                        </RequireAuth>
                    }
                />
                <Route
                    path="/admin/reservations"
                    element={
                        <RequireAuth role={["manager", "admin"]}>
                            <AllReservationsManagementPage />
                        </RequireAuth>
                    }
                />
                <Route
                    path="/admin/promocodes"
                    element={
                        <RequireAuth role={["manager", "admin"]}>
                            <PromoCodeManagementPage />
                        </RequireAuth>
                    }
                />
                <Route
                    path="/admin/holidays"
                    element={
                        <RequireAuth role={["admin"]}>
                            <HolidayManagementPage />
                        </RequireAuth>
                    }
                />
                <Route
                    path="/admin/associations"
                    element={
                        <RequireAuth role={["manager", "admin"]}>
                            <AssociationManagementPage />
                        </RequireAuth>
                    }
                />

            </Routes>
            <Toaster richColors position="top-right" />
        </>
    );
}

export default App;

```


## <a name="rentalappmainsrcassetsreactsvg"></a>`rental-app-main/src/assets/react.svg`

```
[–°–æ–¥–µ—Ä–∂–∏–º–æ–µ SVG —Ñ–∞–π–ª–∞ 'react.svg' –Ω–µ –≤–∫–ª—é—á–µ–Ω–æ –¥–ª—è —ç–∫–æ–Ω–æ–º–∏–∏ –º–µ—Å—Ç–∞]
```


## <a name="rentalappmainsrccomponentsAssociationFiltertsx"></a>`rental-app-main/src/components/AssociationFilter.tsx`

```tsx
// path: rental-app-main/src/components/AssociationFilter.tsx

// src/components/AssociationFilter.tsx

import { useMemo } from "react"; // <--- –î–û–ë–ê–í–ò–¢–¨ –ò–ú–ü–û–†–¢
import { ToggleGroup, ToggleGroupItem } from "@/components/ui/toggle-group";
import { useFilterStore } from "@/store/filterStore";
import { useAssociations } from "@/hooks/useAssociations";
import { getFilterToggleClass } from "@/components/ui/filter-toggle";
import { Tags, List } from "lucide-react";

export default function AssociationFilter() {
    const { associationId, setAssociationId } = useFilterStore();
    const { data: allAssociations = [], isLoading } = useAssociations();

    // +++ –ù–ê–ß–ê–õ–û –ò–ó–ú–ï–ù–ï–ù–ò–ô +++
    // –§–∏–ª—å—Ç—Ä—É–µ–º –∞—Å—Å–æ—Ü–∏–∞—Ü–∏–∏, –æ—Å—Ç–∞–≤–ª—è—è —Ç–æ–ª—å–∫–æ —Ç–µ, –∫ –∫–æ—Ç–æ—Ä—ã–º –ø—Ä–∏–≤—è–∑–∞–Ω–æ –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏–µ
    const associationsWithEquipment = useMemo(() => {
        return allAssociations.filter(assoc => assoc.equipment_ids && assoc.equipment_ids.length > 0);
    }, [allAssociations]);

    // –¢–µ–ø–µ—Ä—å –ø—Ä–æ–≤–µ—Ä—è–µ–º –æ—Ç—Ñ–∏–ª—å—Ç—Ä–æ–≤–∞–Ω–Ω—ã–π —Å–ø–∏—Å–æ–∫
    if (isLoading || associationsWithEquipment.length === 0) {
        return null; // –ù–µ —Ä–µ–Ω–¥–µ—Ä–∏–º –Ω–∏—á–µ–≥–æ, –µ—Å–ª–∏ –¥–∞–Ω–Ω—ã—Ö –Ω–µ—Ç –∏–ª–∏ –≤—Å–µ –∞—Å—Å–æ—Ü–∏–∞—Ü–∏–∏ "–ø—É—Å—Ç—ã–µ"
    }
    // +++ –ö–û–ù–ï–¶ –ò–ó–ú–ï–ù–ï–ù–ò–ô +++

    return (
        <ToggleGroup
            type="single"
            value={associationId?.toString() ?? "__all__"}
            onValueChange={(val: string) => setAssociationId(val === "__all__" ? null : Number(val))}
            className="flex flex-wrap gap-2"
        >
            <ToggleGroupItem value="__all__" className={getFilterToggleClass("green")}>
                <List />
                –í—Å–µ –ø–æ–¥–±–æ—Ä–∫–∏
            </ToggleGroupItem>

            {/* –ò—Å–ø–æ–ª—å–∑—É–µ–º –æ—Ç—Ñ–∏–ª—å—Ç—Ä–æ–≤–∞–Ω–Ω—ã–π —Å–ø–∏—Å–æ–∫ –¥–ª—è —Ä–µ–Ω–¥–µ—Ä–∏–Ω–≥–∞ */}
            {associationsWithEquipment.map((assoc) => (
                <ToggleGroupItem
                    key={assoc.id}
                    value={assoc.id.toString()}
                    className={getFilterToggleClass("green")}
                >
                    <Tags className="h-4 w-4" />
                    {assoc.name}
                </ToggleGroupItem>
            ))}
        </ToggleGroup>
    );
}


```


## <a name="rentalappmainsrccomponentsAuthFormtsx"></a>`rental-app-main/src/components/AuthForm.tsx`

```tsx
// path: rental-app-main/src/components/AuthForm.tsx

// src/components/AuthForm.tsx

import { useState } from "react";
import { useForm, Controller } from "react-hook-form";
import { zodResolver } from "@hookform/resolvers/zod";
import { authSchema, AuthSchema } from "@/lib/validationSchemas";
import { useAuthStore } from "@/store/authStore";
import { Input } from "@/components/ui/input";
import { Button } from "@/components/ui/button";
import { Checkbox } from "@/components/ui/checkbox";
import { Label } from "@/components/ui/label";
import { PhoneInput } from "@/components/ui/phone-input";
import { Eye, EyeOff, Mail, Lock, User, LogIn, UserPlus, Phone, Calendar } from "lucide-react"; // <<< –ò–ó–ú–ï–ù–ï–ù–ò–ï: –î–æ–±–∞–≤–ª–µ–Ω–∞ –∏–∫–æ–Ω–∫–∞ Calendar
import { useNavigate } from "react-router-dom"; // <<< –ò–ó–ú–ï–ù–ï–ù–ò–ï: –î–æ–±–∞–≤–ª–µ–Ω useNavigate

export default function AuthForm() {
    const { login, register: registerUser, error, loading } = useAuthStore();
    const [isRegister, setIsRegister] = useState(false);
    const [showPassword, setShowPassword] = useState(false);
    const [phoneError, setPhoneError] = useState("");
    const [emailError, setEmailError] = useState("");
    const navigate = useNavigate(); // <<< –ò–ó–ú–ï–ù–ï–ù–ò–ï: –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º —Ö—É–∫

    const {
        register: formRegister,
        handleSubmit,
        control,
        formState: { errors, isValid },
        reset
    } = useForm<AuthSchema>({
        resolver: zodResolver(authSchema),
        mode: "onChange",
        defaultValues: {
            privacyPolicyAccepted: false,
            termsAccepted: false,
        }
    });

    const onSubmit = async (data: AuthSchema) => {
        try {
            if (isRegister) {
                if (!data.privacyPolicyAccepted || !data.termsAccepted) {
                    // –≠—Ç–∞ –ø—Ä–æ–≤–µ—Ä–∫–∞ –æ—Å—Ç–∞–µ—Ç—Å—è –Ω–∞ —Å–ª—É—á–∞–π, –µ—Å–ª–∏ Zod –ø–æ –∫–∞–∫–æ–π-—Ç–æ –ø—Ä–∏—á–∏–Ω–µ –±—É–¥–µ—Ç –æ–±–æ–π–¥–µ–Ω
                    throw new Error("–ù–µ–æ–±—Ö–æ–¥–∏–º–æ –ø—Ä–∏–Ω—è—Ç—å —É—Å–ª–æ–≤–∏—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –∏ –ø–æ–ª–∏—Ç–∏–∫—É –∫–æ–Ω—Ñ–∏–¥–µ–Ω—Ü–∏–∞–ª—å–Ω–æ—Å—Ç–∏.");
                }
                await registerUser({
                    email: data.email,
                    password: data.password,
                    full_name: data.fullName ?? "",
                    phone: data.phone,
                    privacy_policy_accepted: data.privacyPolicyAccepted,
                    terms_accepted: data.termsAccepted,
                });
            } else {
                await login(data.email, data.password);
            }
            reset();
        } catch (err) {
            // –û—à–∏–±–∫–∏ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—é—Ç—Å—è –≤ zustand
            console.error("Auth error:", err);
        }
    };

    const validatePhoneRealTime = (value: string) => {
        if (!value) { setPhoneError(""); return; }
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –Ω–æ–º–µ—Ä —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç –º–∞—Å–∫–µ +7 (XXX) XXX-XX-XX
        const phoneRegex = /^\+7 \(\d{3}\) \d{3}-\d{2}-\d{2}$/;
        setPhoneError(phoneRegex.test(value) ? "" : "–í–≤–µ–¥–∏—Ç–µ –ø–æ–ª–Ω—ã–π –Ω–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞");
    };

    const validateEmailRealTime = (value: string) => {
        if (!value) { setEmailError(""); return; }
        const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
        setEmailError(emailRegex.test(value) ? "" : "–í–≤–µ–¥–∏—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π email");
    };

    const toggleMode = () => {
        setIsRegister(!isRegister);
        reset({
            email: '', password: '', fullName: '', phone: '',
            privacyPolicyAccepted: false, termsAccepted: false,
        });
        setPhoneError("");
        setEmailError("");
    };

    const registrationFields = (
        <>
            <div className="grid grid-cols-1 sm:grid-cols-2 gap-4">
                <div>
                    <Label htmlFor="fullName">–§–ò–û *</Label>
                    <div className="relative">
                        <User className="absolute left-3 top-1/2 -translate-y-1/2 h-4 w-4 text-gray-400" />
                        <Input id="fullName" {...formRegister("fullName")} placeholder="–ò–≤–∞–Ω –ò–≤–∞–Ω–æ–≤" className="pl-9" />
                    </div>
                    {errors.fullName && <p className="text-xs text-red-600 mt-1">{errors.fullName.message}</p>}
                </div>
                <div>
                    <Label htmlFor="phone">–¢–µ–ª–µ—Ñ–æ–Ω</Label>
                    <div className="relative">
                        <Phone className="absolute left-3 top-1/2 -translate-y-1/2 h-4 w-4 text-gray-400" />
                        <Controller
                            control={control}
                            name="phone"
                            render={({ field }) => (
                                <PhoneInput
                                    id="phone"
                                    {...field}
                                    placeholder="+7 (___) ___-__-__"
                                    className="pl-9"
                                    error={!!phoneError}
                                    onChange={(e) => {
                                        field.onChange(e);
                                        validatePhoneRealTime(e.target.value);
                                    }}
                                />
                            )}
                        />
                    </div>
                    {(errors.phone || phoneError) && <p className="text-xs text-red-600 mt-1">{phoneError || errors.phone?.message}</p>}
                </div>
            </div>

            <div className="grid grid-cols-1 sm:grid-cols-2 gap-4">
                <div>
                    <Label htmlFor="emailReg">Email *</Label>
                    <div className="relative">
                        <Mail className="absolute left-3 top-1/2 -translate-y-1/2 h-4 w-4 text-gray-400" />
                        <Input
                            id="emailReg" type="email" {...formRegister("email")}
                            placeholder="your@email.com" className="pl-9"
                            onChange={(e) => {
                                formRegister("email").onChange(e);
                                validateEmailRealTime(e.target.value);
                            }}
                        />
                    </div>
                    {(errors.email || emailError) && <p className="text-xs text-red-600 mt-1">{emailError || errors.email?.message}</p>}
                </div>
                <div>
                    <Label htmlFor="passwordReg">–ü–∞—Ä–æ–ª—å *</Label>
                    <div className="relative">
                        <Lock className="absolute left-3 top-1/2 -translate-y-1/2 h-4 w-4 text-gray-400" />
                        <Input id="passwordReg" type={showPassword ? "text" : "password"} {...formRegister("password")} placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" className="pl-9 pr-10" />
                        <Button type="button" variant="ghost" size="icon" className="absolute right-1 top-1/2 -translate-y-1/2 h-8 w-8" onClick={() => setShowPassword(p => !p)}>
                            {showPassword ? <EyeOff className="h-4 w-4" /> : <Eye className="h-4 w-4" />}
                        </Button>
                    </div>
                    {errors.password && <p className="text-xs text-red-600 mt-1">{errors.password.message}</p>}
                </div>
            </div>

            <div className="space-y-3 pt-2">
                <Controller
                    control={control}
                    name="privacyPolicyAccepted"
                    render={({ field }) => (
                        <div className="flex items-start space-x-2">
                            <Checkbox id="privacy" checked={field.value} onCheckedChange={field.onChange} />
                            <div className="grid gap-1.5 leading-none">
                                <Label htmlFor="privacy" className="text-sm font-normal cursor-pointer">
                                    –Ø —Å–æ–≥–ª–∞—Å–µ–Ω —Å <a href="#" onClick={(e) => e.preventDefault()} className="text-sky-600 hover:underline">–ø–æ–ª–∏—Ç–∏–∫–æ–π –æ–±—Ä–∞–±–æ—Ç–∫–∏ –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö</a> *
                                </Label>
                                {errors.privacyPolicyAccepted && <p className="text-xs text-red-600">{errors.privacyPolicyAccepted.message}</p>}
                            </div>
                        </div>
                    )}
                />
                <Controller
                    control={control}
                    name="termsAccepted"
                    render={({ field }) => (
                        <div className="flex items-start space-x-2">
                            <Checkbox id="terms" checked={field.value} onCheckedChange={field.onChange} />
                            <div className="grid gap-1.5 leading-none">
                                <Label htmlFor="terms" className="text-sm font-normal cursor-pointer">
                                    –Ø –ø—Ä–∏–Ω–∏–º–∞—é <a href="#" onClick={(e) => e.preventDefault()} className="text-sky-600 hover:underline">—É—Å–ª–æ–≤–∏—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è —Å–µ—Ä–≤–∏—Å–∞</a> *
                                </Label>
                                {errors.termsAccepted && <p className="text-xs text-red-600">{errors.termsAccepted.message}</p>}
                            </div>
                        </div>
                    )}
                />
            </div>
        </>
    );

    const loginFields = (
        <div className="grid grid-cols-1 sm:grid-cols-2 gap-4">
            <div>
                <Label htmlFor="emailLogin">Email</Label>
                <div className="relative">
                    <Mail className="absolute left-3 top-1/2 -translate-y-1/2 h-4 w-4 text-gray-400" />
                    <Input
                        id="emailLogin" type="email" {...formRegister("email")}
                        placeholder="your@email.com" className="pl-9"
                        onChange={(e) => {
                            formRegister("email").onChange(e);
                            validateEmailRealTime(e.target.value);
                        }}
                    />
                </div>
                {(errors.email || emailError) && <p className="text-xs text-red-600 mt-1">{emailError || errors.email?.message}</p>}
            </div>
            <div>
                <Label htmlFor="passwordLogin">–ü–∞—Ä–æ–ª—å</Label>
                <div className="relative">
                    <Lock className="absolute left-3 top-1/2 -translate-y-1/2 h-4 w-4 text-gray-400" />
                    <Input id="passwordLogin" type={showPassword ? "text" : "password"} {...formRegister("password")} placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" className="pl-9 pr-10" />
                    <Button type="button" variant="ghost" size="icon" className="absolute right-1 top-1/2 -translate-y-1/2 h-8 w-8" onClick={() => setShowPassword(p => !p)}>
                        {showPassword ? <EyeOff className="h-4 w-4" /> : <Eye className="h-4 w-4" />}
                    </Button>
                </div>
                {errors.password && <p className="text-xs text-red-600 mt-1">{errors.password.message}</p>}
            </div>
        </div>
    );

    return (
        <div className="w-full">
            <form onSubmit={handleSubmit(onSubmit)} className="bg-white border border-gray-200 rounded-lg shadow-sm p-6 space-y-6">
                <h2 className="text-xl font-semibold text-center">{isRegister ? "–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è" : "–í—Ö–æ–¥ –≤ –∞–∫–∫–∞—É–Ω—Ç"}</h2>

                {isRegister ? registrationFields : loginFields}

                {error && (
                    <div className="p-3 bg-red-50 border border-red-200 rounded text-sm text-red-600">
                        {error}
                    </div>
                )}

                {/* +++ –ù–ê–ß–ê–õ–û: –ò–∑–º–µ–Ω–µ–Ω–Ω—ã–π –±–ª–æ–∫ –∫–Ω–æ–ø–æ–∫ +++ */}
                <div className="pt-4 border-t space-y-4">
                    <Button type="submit" disabled={!isValid || loading} className="w-full">
                        {loading ? "–ó–∞–≥—Ä—É–∑–∫–∞..." : (isRegister ? <><UserPlus className="mr-2 h-4 w-4" />–ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è</> : <><LogIn className="mr-2 h-4 w-4" />–í–æ–π—Ç–∏</>)}
                    </Button>
                    <div className="flex justify-center items-center gap-4 text-sm">
                        <Button
                            type="button"
                            variant="outline"
                            size="sm"
                            onClick={() => navigate("/calendar")}
                        >
                            <Calendar className="mr-2 h-4 w-4" />
                            –ö–∞–ª–µ–Ω–¥–∞—Ä—å
                        </Button>
                        <Button type="button" variant="link" onClick={toggleMode} className="text-gray-600">
                            {isRegister ? "–£–∂–µ –µ—Å—Ç—å –∞–∫–∫–∞—É–Ω—Ç? –í–æ–π—Ç–∏" : "–ù–µ—Ç –∞–∫–∫–∞—É–Ω—Ç–∞?"}
                        </Button>
                    </div>
                </div>
                {/* +++ –ö–û–ù–ï–¶: –ò–∑–º–µ–Ω–µ–Ω–Ω—ã–π –±–ª–æ–∫ –∫–Ω–æ–ø–æ–∫ +++ */}
            </form>
        </div>
    );
}

```


## <a name="rentalappmainsrccomponentsAuthStatustsx"></a>`rental-app-main/src/components/AuthStatus.tsx`

```tsx
// path: rental-app-main/src/components/AuthStatus.tsx

import { useCurrentUser } from "@/hooks/useProfile";
import { useAuthStore } from "@/store/authStore";

export default function AuthStatus() {
    const { data: user, isLoading, isError } = useCurrentUser();
    const { logout } = useAuthStore();

    if (isLoading) {
        return (
            <div className="bg-gray-50 border border-gray-200 rounded-md p-2 mb-2">
                <div className="flex items-center justify-center">
                    <div className="animate-spin rounded-full h-3 w-3 border-b-2 border-gray-400 mr-2"></div>
                    <span className="text-xs text-gray-500">–ü—Ä–æ–≤–µ—Ä–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏...</span>
                </div>
            </div>
        );
    }

    if (isError) {
        return (
            <div className="bg-gray-50 border border-gray-200 rounded-md p-2 mb-2">
                <div className="flex items-center justify-between">
                    <span className="text-xs text-gray-500">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ø—Ä–æ—Ñ–∏–ª—è</span>
                    <button
                        onClick={logout}
                        className="text-xs text-gray-400 hover:text-gray-600 underline"
                    >
                        –í—ã–π—Ç–∏
                    </button>
                </div>
            </div>
        );
    }

    if (!user) {
        return (
            <div className="bg-gray-50 border border-gray-200 rounded-md p-2 mb-2">
                <div className="flex items-center justify-center">
                    <span className="text-xs text-gray-500">–í–æ–π–¥–∏—Ç–µ –≤ —Å–∏—Å—Ç–µ–º—É –¥–ª—è –¥–æ—Å—Ç—É–ø–∞ –∫ –ø–æ–ª–Ω–æ–º—É —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—É</span>
                </div>
            </div>
        );
    }

    return null; // –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω, –Ω–∏—á–µ–≥–æ –Ω–µ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º
} 

```


## <a name="rentalappmainsrccomponentsAvailabilityStriptsx"></a>`rental-app-main/src/components/AvailabilityStrip.tsx`

```tsx
// path: rental-app-main/src/components/AvailabilityStrip.tsx

// src/components/AvailabilityStrip.tsx

import { useState } from 'react';
import { Popover, PopoverContent, PopoverAnchor } from '@/components/ui/popover';
import { useDateStore } from '@/store/dateStore';
import type { DayStatus } from '@/types/availability';
import { format } from 'date-fns';
import { ru } from 'date-fns/locale';
import { Button } from './ui/button';
import { useHolidayStore } from '@/store/holidayStore';
import { DateService } from '@/core/services/DateService';
import { toast } from 'sonner';

interface AvailabilityStripProps {
    dailyStatus?: Record<string, DayStatus>;
}

const cellColorMap: Record<string, string> = {
    available: 'bg-green-500 hover:bg-green-600',
    reserved: 'bg-yellow-500 hover:bg-yellow-600',
    rented: 'bg-red-500 hover:bg-red-600',
    default: 'bg-gray-400 hover:bg-gray-500'
};

type PopoverData = {
    date: Date;
    status: string;
};

export default function AvailabilityStrip({ dailyStatus = {} }: AvailabilityStripProps) {
    const { setRange } = useDateStore();
    const holidays = useHolidayStore((state) => state.holidays);

    const [isPopoverOpen, setPopoverOpen] = useState(false);
    const [popoverData, setPopoverData] = useState<PopoverData | null>(null);

    const today = new Date();
    today.setHours(0, 0, 0, 0);

    const dates = Array.from({ length: 30 }, (_, i) => {
        const date = new Date();
        date.setDate(today.getDate() + i);
        return date;
    });

    const handleCellClick = (date: Date, status: string) => {
        setPopoverData({ date, status });
        setPopoverOpen(true);
    };

    // +++ –ù–ê–ß–ê–õ–û: –û–ë–ù–û–í–õ–ï–ù–ù–ê–Ø –õ–û–ì–ò–ö–ê –û–ë–†–ê–ë–û–¢–ß–ò–ö–ê +++
    const handleSetAsStartDate = () => {
        if (!popoverData) return;

        const originalStartDate = popoverData.date;

        // 1. –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å–¥–≤–∏–≥–∞–µ–º –¥–∞—Ç—É, –µ—Å–ª–∏ –æ–Ω–∞ –ø–æ–ø–∞–ª–∞ –Ω–∞ –≤—ã—Ö–æ–¥–Ω–æ–π
        const adjustedStartDate = DateService.adjustDateIfHoliday(originalStartDate, holidays);

        // 2. –†–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ–º –¥–∞—Ç—É –æ–∫–æ–Ω—á–∞–Ω–∏—è –æ—Ç *—Å–∫–æ—Ä—Ä–µ–∫—Ç–∏—Ä–æ–≤–∞–Ω–Ω–æ–π* –¥–∞—Ç—ã –Ω–∞—á–∞–ª–∞
        const finalEndDate = DateService.findNextWorkingDay(adjustedStartDate, holidays, 1);

        // 3. –ü—Ä–æ–≤–µ—Ä—è–µ–º, –±—ã–ª–∞ –ª–∏ –¥–∞—Ç–∞ –Ω–∞—á–∞–ª–∞ –∏–∑–º–µ–Ω–µ–Ω–∞
        if (adjustedStartDate.getTime() !== originalStartDate.getTime()) {
            // 4. –ï—Å–ª–∏ –¥–∞ - –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ
            toast.info(`–î–∞—Ç–∞ –Ω–∞—á–∞–ª–∞ —Å–¥–≤–∏–Ω—É—Ç–∞ —Å ${format(originalStartDate, 'dd.MM.yyyy')} –Ω–∞ ${format(adjustedStartDate, 'dd.MM.yyyy')}, —Ç–∞–∫ –∫–∞–∫ –≤—ã–±—Ä–∞–Ω–Ω—ã–π –¥–µ–Ω—å —è–≤–ª—è–µ—Ç—Å—è –≤—ã—Ö–æ–¥–Ω—ã–º.`);
        }

        // 5. –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –Ω–æ–≤—ã–π, –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π –¥–∏–∞–ø–∞–∑–æ–Ω –¥–∞—Ç
        setRange(adjustedStartDate, finalEndDate);
        setPopoverOpen(false);
    };
    // +++ –ö–û–ù–ï–¶: –û–ë–ù–û–í–õ–ï–ù–ù–ê–Ø –õ–û–ì–ò–ö–ê –û–ë–†–ê–ë–û–¢–ß–ò–ö–ê +++

    const statusTextMap: Record<string, string> = {
        available: '–°–≤–æ–±–æ–¥–Ω–æ',
        reserved: '–í —Ä–µ–∑–µ—Ä–≤–µ',
        rented: '–í –∞—Ä–µ–Ω–¥–µ',
        default: '–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö'
    };

    return (
        <Popover open={isPopoverOpen} onOpenChange={setPopoverOpen}>
            <PopoverAnchor asChild>
                <div
                    className="w-full h-3 mt-auto flex rounded-sm overflow-hidden border border-gray-400 cursor-pointer"
                    title="–ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å –∏ –≤—ã–±—Ä–∞—Ç—å –¥–∞—Ç—ã"
                >
                    {dates.map(date => {
                        const dateStr = format(date, 'dd.MM.yyyy');
                        const status = dailyStatus[dateStr]?.status ?? 'available';
                        const color = cellColorMap[status] ?? cellColorMap.default;

                        return (
                            <button
                                key={dateStr}
                                className={`flex-1 h-full transition-colors focus:outline-none focus:ring-2 focus:ring-sky-500 z-10 ${color}`}
                                onClick={() => handleCellClick(date, status)}
                                aria-label={`–°—Ç–∞—Ç—É—Å –Ω–∞ ${dateStr}: ${statusTextMap[status]}`}
                            />
                        );
                    })}
                </div>
            </PopoverAnchor>

            <PopoverContent
                className="w-auto p-3 bg-white border rounded-md shadow-lg text-sm"
                side="bottom"
                align="center"
                onCloseAutoFocus={(e) => e.preventDefault()}
                sideOffset={5}
            >
                {popoverData && (
                    <div className="space-y-2">
                        <p>
                            <strong>–î–∞—Ç–∞:</strong> {format(popoverData.date, "PPP", { locale: ru })}
                        </p>
                        <p>
                            <strong>–°—Ç–∞—Ç—É—Å:</strong> {statusTextMap[popoverData.status] ?? '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ'}
                        </p>
                        {popoverData.status === 'available' && (
                            <Button
                                size="sm"
                                className="mt-2 w-full"
                                onClick={handleSetAsStartDate}
                            >
                                –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –¥–∞—Ç–æ–π –Ω–∞—á–∞–ª–∞ —Ä–µ–∑–µ—Ä–≤–∞
                            </Button>
                        )}
                    </div>
                )}
            </PopoverContent>
        </Popover>
    );
}

```


## <a name="rentalappmainsrccomponentsAvailableCheckboxtsx"></a>`rental-app-main/src/components/AvailableCheckbox.tsx`

```tsx
// path: rental-app-main/src/components/AvailableCheckbox.tsx

import { Checkbox } from "@/components/ui/checkbox"
import { useFilterStore } from "@/store/filterStore"
import { Label } from "@/components/ui/label"

export default function AvailableCheckbox() {
  const { availableOnly, setAvailableOnly } = useFilterStore()

  return (
    <div className="flex items-center space-x-2">
      <Checkbox
        id="available-only"
        checked={availableOnly}
        onCheckedChange={(checked) => setAvailableOnly(Boolean(checked))}
      />
      <Label htmlFor="available-only">–¢–æ–ª—å–∫–æ –¥–æ—Å—Ç—É–ø–Ω–æ–µ</Label>
    </div>
  )
}


```


## <a name="rentalappmainsrccomponentsBrandFiltertsx"></a>`rental-app-main/src/components/BrandFilter.tsx`

```tsx
// path: rental-app-main/src/components/BrandFilter.tsx

// src/components/BrandFilter.tsx
import { useMemo } from "react"
import { useFilterStore } from "@/store/filterStore"
import type { Equipment } from "@/types/equipment"
import {
    Select,
    SelectContent,
    SelectItem,
    SelectTrigger,
    SelectValue,
} from "@/components/ui/select"

interface BrandFilterProps {
    items: Equipment[]
}

export default function BrandFilter({ items }: BrandFilterProps) {
    const { brand, setBrand } = useFilterStore()

    const brands = useMemo(() => {
        const set = new Set(items.map((i) => i.brand))
        return Array.from(set)
    }, [items])

    return (
        <Select value={brand} onValueChange={setBrand}>
            <SelectTrigger className="w-[200px] border border-sky-300 shadow-sm hover:shadow-md">
                <SelectValue placeholder="–í—Å–µ –±—Ä–µ–Ω–¥—ã" />
            </SelectTrigger>
            <SelectContent>
                <SelectItem value="__all__">–í—Å–µ –±—Ä–µ–Ω–¥—ã</SelectItem>
                {brands.map((b) => (
                    <SelectItem key={b} value={b}>
                        {b}
                    </SelectItem>
                ))}
            </SelectContent>
        </Select>
    )
}


```


## <a name="rentalappmainsrccomponentsCancelReservationDialogtsx"></a>`rental-app-main/src/components/CancelReservationDialog.tsx`

```tsx
// path: rental-app-main/src/components/CancelReservationDialog.tsx

// src/components/CancelReservationDialog.tsx
import {
    Dialog,
    DialogContent,
    DialogHeader,
    DialogTitle, // –ò–º–ø–æ—Ä—Ç–∏—Ä—É–µ–º DialogTitle
    DialogDescription, // –ò–º–ø–æ—Ä—Ç–∏—Ä—É–µ–º DialogDescription
    DialogFooter,
} from "@/components/ui/dialog";
import { Button } from "@/components/ui/button";

type Props = {
    open: boolean;
    onClose: () => void;
    onConfirm: () => void;
};

export default function CancelReservationDialog({ open, onClose, onConfirm }: Props) {
    return (
        <Dialog open={open} onOpenChange={onClose}>
            <DialogContent>
                <DialogHeader>
                    {/* üëá –ò–°–ü–û–õ–¨–ó–£–ï–ú DialogTitle –≤–º–µ—Å—Ç–æ h2 */}
                    <DialogTitle className="text-lg font-semibold">–û—Ç–º–µ–Ω–∏—Ç—å –æ—Ñ–æ—Ä–º–ª–µ–Ω–∏–µ?</DialogTitle>
                </DialogHeader>
                {/* üëá –ò–°–ü–û–õ–¨–ó–£–ï–ú DialogDescription –≤–º–µ—Å—Ç–æ p */}
                <DialogDescription className="text-sm text-gray-600">
                    –í—Å–µ –≤—ã–±—Ä–∞–Ω–Ω—ã–µ –ø–æ–∑–∏—Ü–∏–∏ –±—É–¥—É—Ç —É–¥–∞–ª–µ–Ω—ã, –∞ –≤—ã –≤–µ—Ä–Ω—ë—Ç–µ—Å—å –Ω–∞ –≥–ª–∞–≤–Ω—É—é —Å—Ç—Ä–∞–Ω–∏—Ü—É.
                </DialogDescription>
                <DialogFooter className="pt-4">
                    <Button variant="ghost" onClick={onClose}>
                        –û—Ç–º–µ–Ω–∞
                    </Button>
                    <Button
                        className="bg-red-700 hover:bg-red-800 text-white"
                        onClick={onConfirm}
                    >
                        –ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å –æ—Ç–º–µ–Ω—É
                    </Button>
                </DialogFooter>
            </DialogContent>
        </Dialog>
    );
}

```


## <a name="rentalappmainsrccomponentsCardShelltsx"></a>`rental-app-main/src/components/CardShell.tsx`

```tsx
// path: rental-app-main/src/components/CardShell.tsx

import { Card, CardContent, CardFooter, CardHeader } from "@/components/ui/card"
import { ReactNode } from "react"

type Props = {
    title: string
    status?: ReactNode
    children: ReactNode
    footer?: ReactNode
    className?: string
}

export default function CardShell({ title, status, children, footer, className = "" }: Props) {
    return (
        <Card className={`w-full rounded-xl border shadow-sm hover:shadow-md transition ${className}`}>
            <CardHeader className="flex justify-between items-start">
                <h3 className="text-lg font-semibold">{title}</h3>
                {status && <div>{status}</div>}
            </CardHeader>
            <CardContent className="space-y-2 text-sm text-gray-700">
                {children}
            </CardContent>
            {footer && <CardFooter className="pt-2">{footer}</CardFooter>}
        </Card>
    )
}


```


## <a name="rentalappmainsrccomponentsCompactEquipmentCardtsx"></a>`rental-app-main/src/components/CompactEquipmentCard.tsx`

```tsx
// path: rental-app-main/src/components/CompactEquipmentCard.tsx

// src/components/CompactEquipmentCard.tsx

import React, { useMemo, useCallback } from "react";
import { CheckCircle } from "lucide-react";
import { useReserveStore } from "@/store/reserveStore";
import { useDateStore } from "@/store/dateStore";
import { useSandboxCalculatorStore } from "@/store/sandboxCalculatorStore";
import { usePromoCodeStore } from "@/store/promoCodeStore";
import { formatDateRangeEuropean } from "@/lib/utils";

// –¢–∏–ø—ã
import type { Equipment } from "@/types/equipment";
import type { DayStatus, EquipmentStatus } from "@/types/availability";

interface CompactEquipmentCardProps {
    equipment: Equipment;
    status?: EquipmentStatus | "my_reservation" | "added";
    startDate?: string;
    endDate?: string;
    dailyStatus?: Record<string, DayStatus>;
}

// --- –ù–ê–ß–ê–õ–û –ò–ó–ú–ï–ù–ï–ù–ò–ô ---

// 1. –£–ø—Ä–æ—â–∞–µ–º —Å—Ç–∏–ª–∏, —É–¥–∞–ª—è—è `ending_today`
const COMPACT_STATUS_STYLES: Record<EquipmentStatus | "my_reservation" | "added", string> = {
    available: "bg-white border-gray-200 hover:bg-gray-50",
    reserved: "bg-rose-100 border-rose-300",
    rented: "bg-red-200 border-red-400",
    my_reservation: "bg-sky-50 border-sky-200 hover:bg-sky-100",
    added: "bg-green-100 border-green-300",
};
// --- –ö–û–ù–ï–¶ –ò–ó–ú–ï–ù–ï–ù–ò–ô ---

const COMPACT_SELECTED_STYLES = "ring-2 ring-offset-1 ring-green-500 border-green-500 bg-green-100";

const CompactEquipmentCardComponent: React.FC<CompactEquipmentCardProps> = ({
                                                                       equipment,
                                                                       status = "available",
                                                                       startDate,
                                                                       endDate,
                                                                   }) => {
    const { toggle, isSelected, selectedAccessories } = useReserveStore();
    const { dayCount } = useDateStore();
    const { durationDiscountPercentage } = useSandboxCalculatorStore();
    const { promoCodePercentage } = usePromoCodeStore();
    const isSelectedByUser = isSelected(equipment.id);

    const accessoriesDailyRate = useMemo(() => {
        const selectedForThisCard = selectedAccessories[equipment.id] || [];
        return equipment.accessories?.reduce((total, acc) =>
            selectedForThisCard.includes(acc.id) ? total + acc.price : total, 0) ?? 0;
    }, [equipment.accessories, equipment.id, selectedAccessories]);

    const totalDiscountPercentage = useMemo(() =>
            durationDiscountPercentage + promoCodePercentage,
        [durationDiscountPercentage, promoCodePercentage]
    );

    const priceData = useMemo(() => {
        const totalDailyRate = equipment.daily_rate + accessoriesDailyRate;
        const priceBefore = totalDailyRate * dayCount;
        const priceAfter = priceBefore * (1 - totalDiscountPercentage / 100);

        return {
            dailyRate: totalDailyRate,
            totalPrice: priceAfter,
            discountPercentage: totalDiscountPercentage,
            days: dayCount,
        };
    }, [equipment.daily_rate, accessoriesDailyRate, dayCount, totalDiscountPercentage]);

    // --- –ù–ê–ß–ê–õ–û –ò–ó–ú–ï–ù–ï–ù–ò–ô: –£–¥–∞–ª—è–µ–º useMemo –¥–ª—è finalStatus ---
    // const finalStatus: DisplayStatus = useMemo(() => { ... }); // –≠–¢–û–¢ –ë–õ–û–ö –ü–û–õ–ù–û–°–¢–¨–Æ –£–î–ê–õ–ï–ù
    // --- –ö–û–ù–ï–¶ –ò–ó–ú–ï–ù–ï–ù–ò–ô ---

    const handleCardClick = useCallback((e: React.MouseEvent<HTMLDivElement>) => {
        if ((e.target as HTMLElement).closest("button, a, label, input[type='checkbox']")) return;
        // --- –ò–ó–ú–ï–ù–ï–ù–ò–ï: –ò—Å–ø–æ–ª—å–∑—É–µ–º `status` –Ω–∞–ø—Ä—è–º—É—é ---
        if (status === 'available' || status === 'added') {
            toggle(equipment);
        }
    }, [status, toggle, equipment]);

    const handleDoubleClick = useCallback((e: React.MouseEvent<HTMLDivElement>) => {
        if ((e.target as HTMLElement).closest("button, a, label, input[type='checkbox']")) return;
        // --- –ò–ó–ú–ï–ù–ï–ù–ò–ï: –ò—Å–ø–æ–ª—å–∑—É–µ–º `status` –Ω–∞–ø—Ä—è–º—É—é ---
        if (status === 'available' || status === 'added') {
            toggle(equipment);
        }
    }, [status, toggle, equipment]);

    // --- –ò–ó–ú–ï–ù–ï–ù–ò–ï: –ò—Å–ø–æ–ª—å–∑—É–µ–º `status` –¥–ª—è –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è —Å—Ç–∏–ª—è ---
    const backgroundClass = isSelectedByUser
        ? COMPACT_SELECTED_STYLES
        : COMPACT_STATUS_STYLES[status];

    const dateRangeDisplay = (startDate && endDate)
        ? `(${formatDateRangeEuropean(startDate, endDate)})`
        : "";

    return (
        <div
            className={`relative p-3 rounded-lg border transition-all duration-200 cursor-pointer ${backgroundClass}`}
            onClick={handleCardClick}
            onDoubleClick={handleDoubleClick}
            tabIndex={0}
        >
            {isSelectedByUser && (
                <div className="absolute top-1 right-1 z-10 bg-green-600 text-white rounded-full p-0.5 shadow">
                    <CheckCircle className="w-3 h-3" />
                </div>
            )}

            <div className="space-y-2">
                <div className="space-y-1">
                    <h3 className="text-sm font-semibold text-gray-900 truncate" title={equipment.name}>
                        {equipment.name}
                    </h3>
                    <p className="text-xs text-gray-500">
                        {equipment.brand} ‚Ä¢ {equipment.equipment_type}
                    </p>
                    {dateRangeDisplay && (
                        <p className="text-xs text-gray-400">{dateRangeDisplay}</p>
                    )}
                </div>

                <div className="space-y-1">
                    <div className="flex justify-between items-center">
                        <span className="text-xs text-gray-600">
                            {priceData.days} {priceData.days === 1 ? '–¥–µ–Ω—å' : priceData.days < 5 ? '–¥–Ω—è' : '–¥–Ω–µ–π'}
                        </span>
                        <span className="text-sm font-semibold text-gray-900">
                            {priceData.totalPrice.toLocaleString('ru-RU')} ‚ÇΩ
                        </span>
                    </div>

                    {priceData.discountPercentage > 0 && (
                        <div className="text-xs text-green-600">
                            –°–∫–∏–¥–∫–∞: {priceData.discountPercentage.toFixed(0)}%
                        </div>
                    )}
                </div>

                {/* --- –ù–ê–ß–ê–õ–û –ò–ó–ú–ï–ù–ï–ù–ò–ô: –£–ø—Ä–æ—â–µ–Ω–Ω—ã–π –±–ª–æ–∫ —Å—Ç–∞—Ç—É—Å–∞ --- */}
                <div className="text-xs">
                    {status === 'available' && (
                        <span className="text-green-600 font-medium">–°–≤–æ–±–æ–¥–Ω–æ</span>
                    )}
                    {status === 'reserved' && (
                        <span className="text-red-600 font-medium">–í —Ä–µ–∑–µ—Ä–≤–µ</span>
                    )}
                    {status === 'rented' && (
                        <span className="text-red-700 font-medium">–í –∞—Ä–µ–Ω–¥–µ</span>
                    )}
                    {status === 'my_reservation' && (
                        <span className="text-sky-600 font-medium">–í —ç—Ç–æ–º —Ä–µ–∑–µ—Ä–≤–µ</span>
                    )}
                    {status === 'added' && (
                        <span className="text-emerald-600 font-medium">–î–æ–±–∞–≤–ª–µ–Ω–æ</span>
                    )}
                </div>
                {/* --- –ö–û–ù–ï–¶ –ò–ó–ú–ï–ù–ï–ù–ò–ô --- */}
            </div>
        </div>
    );
};

// –ú–µ–º–æ–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω–∞—è –≤–µ—Ä—Å–∏—è –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–∞ –¥–ª—è –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏
const CompactEquipmentCard = React.memo(CompactEquipmentCardComponent);

export default CompactEquipmentCard;

```


## <a name="rentalappmainsrccomponentsConfirmItemRemovalDialogtsx"></a>`rental-app-main/src/components/ConfirmItemRemovalDialog.tsx`

```tsx
// path: rental-app-main/src/components/ConfirmItemRemovalDialog.tsx

// src/components/ConfirmItemRemovalDialog.tsx
import {
    Dialog,
    DialogContent,
    DialogHeader,
    DialogTitle,
    DialogDescription,
    DialogFooter,
} from "@/components/ui/dialog";
import { Button } from "@/components/ui/button";

type Props = {
    open: boolean;
    onClose: () => void;
    onConfirm: () => void;
    isConfirming: boolean;
    variant?: 'removeItem' | 'cancelReservation'; // ‚ú® –ù–û–í–´–ô –ü–†–û–ü–°
};

export default function ConfirmItemRemovalDialog({
                                                     open,
                                                     onClose,
                                                     onConfirm,
                                                     isConfirming,
                                                     variant = 'removeItem' // ‚ú® –ó–ù–ê–ß–ï–ù–ò–ï –ü–û –£–ú–û–õ–ß–ê–ù–ò–Æ
                                                 }: Props) {

    // ‚ú® –ö–û–ù–¢–ï–ù–¢ –î–õ–Ø –†–ê–ó–ù–´–• –í–ê–†–ò–ê–ù–¢–û–í –î–ò–ê–õ–û–ì–ê
    const content = {
        removeItem: {
            title: "–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç–µ –¥–µ–π—Å—Ç–≤–∏–µ",
            description: "–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å —ç—Ç—É –ø–æ–∑–∏—Ü–∏—é –∏–∑ —Ä–µ–∑–µ—Ä–≤–∞?",
            cancelText: "–û—Ç–º–µ–Ω–∞",
            confirmText: "–£–¥–∞–ª–∏—Ç—å",
            confirmLoadingText: "–£–¥–∞–ª–µ–Ω–∏–µ..."
        },
        cancelReservation: {
            title: "–£–¥–∞–ª–µ–Ω–∏–µ –ø–æ—Å–ª–µ–¥–Ω–µ–π –ø–æ–∑–∏—Ü–∏–∏",
            description: "–í—ã —É–¥–∞–ª–∏–ª–∏ –ø–æ—Å–ª–µ–¥–Ω—é—é –ø–æ–∑–∏—Ü–∏—é. –•–æ—Ç–∏—Ç–µ –æ—Ç–º–µ–Ω–∏—Ç—å —Ä–µ–∑–µ—Ä–≤ –ø–æ–ª–Ω–æ—Å—Ç—å—é?",
            cancelText: "–í–µ—Ä–Ω—É—Ç—å—Å—è –∫ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—é",
            confirmText: "–û—Ç–º–µ–Ω–∏—Ç—å —Ä–µ–∑–µ—Ä–≤",
            confirmLoadingText: "–û—Ç–º–µ–Ω–∞..."
        }
    }[variant];

    return (
        <Dialog open={open} onOpenChange={onClose}>
            <DialogContent>
                <DialogHeader>
                    <DialogTitle>{content.title}</DialogTitle>
                </DialogHeader>
                <DialogDescription>{content.description}</DialogDescription>
                <DialogFooter className="pt-4">
                    <Button variant="ghost" onClick={onClose} disabled={isConfirming}>
                        {content.cancelText}
                    </Button>
                    <Button
                        variant="destructive"
                        onClick={onConfirm}
                        disabled={isConfirming}
                    >
                        {isConfirming ? content.confirmLoadingText : content.confirmText}
                    </Button>
                </DialogFooter>
            </DialogContent>
        </Dialog>
    );
}

```


## <a name="rentalappmainsrccomponentsDateRangeSelectortsx"></a>`rental-app-main/src/components/DateRangeSelector.tsx`

```tsx
// path: rental-app-main/src/components/DateRangeSelector.tsx

// src/components/DateRangeSelector.tsx

import { useState, type RefObject, useCallback, useEffect, useRef } from 'react';
import { DayPicker, type DateRange } from 'react-day-picker';
import { ru } from 'date-fns/locale';
import { format, addMonths, startOfMonth, endOfMonth } from 'date-fns';
import { ChevronsDown, ChevronsUp } from "lucide-react";
import { useDateStore } from "@/store/dateStore";
import { useSandboxCalculatorStore } from "@/store/sandboxCalculatorStore";
import { useDateRange } from "@/hooks/useDateRange";
import { useHolidayStore } from "@/store/holidayStore";
import { DateService } from '@/core/services/DateService';

interface DateRangeSelectorProps {
    containerRef: RefObject<HTMLDivElement | null>;
}

export default function DateRangeSelector({ containerRef }: DateRangeSelectorProps) {
    const { startDate, endDate, setRange } = useDateStore();
    const { isCalculatorVisible, syncWithDateStore, refreshCalculator } = useSandboxCalculatorStore();

    const [collapsed, setCollapsed] = useState(true);
    const [month, setMonth] = useState(startDate);

    const lastChangeSource = useRef<'calendar' | 'slider' | 'manual' | null>(null);
    const [isAutoUpdating, setIsAutoUpdating] = useState(false);

    const { holidays, fetchHolidays } = useHolidayStore();

    useEffect(() => {
        const firstDayToFetch = startOfMonth(addMonths(month, -1));
        const lastDayToFetch = endOfMonth(addMonths(month, 2));
        void fetchHolidays(firstDayToFetch, lastDayToFetch);
    }, [month, fetchHolidays]);

    // ‚úÖ –ù–û–í–û–ï: –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä—É–µ–º –∫–∞–ª—å–∫—É–ª—è—Ç–æ—Ä –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ –≤—ã—Ö–æ–¥–Ω—ã—Ö –¥–Ω–µ–π
    useEffect(() => {
        if (holidays.length > 0) {
            refreshCalculator();
        }
    }, [holidays, refreshCalculator]);

    // ‚úÖ –ù–û–í–û–ï: –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä—É–µ–º –∫–∞–ª—å–∫—É–ª—è—Ç–æ—Ä –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ –¥–Ω–µ–π
    useEffect(() => {
        const { dayCount } = useDateStore.getState();
        if (dayCount > 0) {
            syncWithDateStore();
        }
    }, [startDate, endDate, syncWithDateStore]);

    const handleRangeChange = useCallback((newStart: Date, newEnd: Date, source?: 'calendar' | 'slider' | 'manual') => {
        lastChangeSource.current = source || 'manual';

        if (source === 'slider') {
            setIsAutoUpdating(true);
            setTimeout(() => setIsAutoUpdating(false), 1000);
        }

        setRange(newStart, newEnd, source, holidays);

        if (source !== 'slider') {
            syncWithDateStore();
        }
    }, [holidays, setRange, syncWithDateStore]);

    useEffect(() => {
        if (lastChangeSource.current === 'slider') {
            lastChangeSource.current = null;
            return;
        }

        lastChangeSource.current = null;
    }, [startDate, endDate]);

    const {
        localStartDate,
        localEndDate,
        handleStartDateChange,
        handleEndDateChange,
    } = useDateRange({
        startDate,
        endDate,
        onRangeChange: handleRangeChange,
        holidays
    });

    const handleSelect = (selectedRange: DateRange | undefined) => {
        if (!selectedRange?.from) return;

        const selectionStartDate = selectedRange.from;
        const finalEndDate = selectedRange.to ?? DateService.findNextWorkingDay(selectionStartDate, holidays, 1);

        const finalRange = { from: selectionStartDate, to: finalEndDate };

        if (finalRange.from && finalRange.to) {
            const { dayCount } = useDateStore.getState();
            const willCalculatorAppear = !isCalculatorVisible && dayCount >= 4;

            if (willCalculatorAppear && containerRef.current) {
                containerRef.current.style.overflowAnchor = 'none';
            }

            handleRangeChange(finalRange.from, finalRange.to, 'calendar');

            if (willCalculatorAppear && containerRef.current) {
                setTimeout(() => {
                    if (containerRef.current) containerRef.current.style.overflowAnchor = 'auto';
                }, 0);
            }
        }
    };

    const today = new Date();
    today.setHours(0, 0, 0, 0);

    const disabledDays = [
        ...holidays,
        { before: today }
    ];

    function formatDateForInput(date: Date): string {
        const year = date.getFullYear();
        const month = String(date.getMonth() + 1).padStart(2, "0");
        const day = String(date.getDate()).padStart(2, "0");
        return `${year}-${month}-${day}`;
    }

    const minEndDate = (() => {
        const start = new Date(localStartDate);
        const timezoneOffset = start.getTimezoneOffset() * 60000;
        const startUTC = new Date(start.getTime() + timezoneOffset);
        startUTC.setDate(startUTC.getDate() + 1);
        return formatDateForInput(startUTC);
    })();

    return (
        <div className="mb-4 border rounded-md p-4 bg-white shadow-sm">
            <div className="flex justify-between items-center mb-2">
                <h2 className="text-base font-semibold text-gray-700">–í—ã–±–∏—Ä–∞–π—Ç–µ –¥–∞—Ç—ã –Ω–∞—á–∞–ª–∞ –∏ –æ–∫–æ–Ω—á–∞–Ω–∏—è –∞—Ä–µ–Ω–¥—ã:</h2>
                <button
                    onClick={() => setCollapsed(!collapsed)}
                    className="text-gray-600 hover:text-gray-800 transition p-1"
                    title={collapsed ? "–†–∞–∑–≤–µ—Ä–Ω—É—Ç—å –∫–∞–ª–µ–Ω–¥–∞—Ä—å" : "–°–≤–µ—Ä–Ω—É—Ç—å –∫–∞–ª–µ–Ω–¥–∞—Ä—å"}
                >
                    {collapsed ? <ChevronsDown className="w-5 h-5" /> : <ChevronsUp className="w-5 h-5" />}
                </button>
            </div>

            {collapsed ? (
                    <div
                        className="flex justify-center items-center gap-4 mt-4 cursor-pointer group"
                        onClick={() => setCollapsed(false)}
                        title="–ù–∞–∂–º–∏—Ç–µ, —á—Ç–æ–±—ã –∏–∑–º–µ–Ω–∏—Ç—å –¥–∞—Ç—ã"
                    >
                        <div className="text-center p-3 rounded-lg bg-sky-50 border-2 border-sky-200 w-40 transition-all group-hover:border-sky-400 group-hover:shadow-lg">
                            <div className="text-sm font-medium text-sky-700">–ù–∞—á–∞–ª–æ</div>
                            <div className="text-4xl font-bold text-sky-900 leading-tight">{format(startDate, "dd")}</div>
                            <div className="text-lg font-semibold text-sky-800 capitalize">{format(startDate, "LLLL", { locale: ru })}</div>
                            <div className="text-sm text-sky-600">{format(startDate, "yyyy")}</div>
                        </div>
                        <div className="text-3xl font-light text-gray-300 pb-8">-</div>
                        <div className={`text-center p-3 rounded-lg w-40 transition-all group-hover:shadow-lg ${
                            isAutoUpdating
                                ? 'bg-green-50 border-2 border-green-300 animate-pulse'
                                : 'bg-sky-50 border-2 border-sky-200 group-hover:border-sky-400'
                        }`}>
                            <div className="text-sm font-medium text-sky-700">
                                {isAutoUpdating ? '–û–±–Ω–æ–≤–ª—è–µ—Ç—Å—è...' : '–û–∫–æ–Ω—á–∞–Ω–∏–µ'}
                            </div>
                            <div className="text-4xl font-bold text-sky-900 leading-tight">{format(endDate, "dd")}</div>
                            <div className="text-lg font-semibold text-sky-800 capitalize">{format(endDate, "LLLL", { locale: ru })}</div>
                            <div className="text-sm text-sky-600">{format(endDate, "yyyy")}</div>
                        </div>
                    </div>
                ) :
                <>
                    <div className="flex justify-center mb-4">
                        <DayPicker
                            mode="range"
                            locale={ru}
                            selected={{ from: startDate, to: endDate }}
                            onSelect={handleSelect}
                            month={month}
                            onMonthChange={setMonth}
                            showOutsideDays
                            numberOfMonths={2}
                            disabled={disabledDays}
                            min={2}
                            modifiers={{ holiday: holidays }}
                            classNames={{
                                months: 'flex flex-col sm:flex-row space-y-4 sm:space-x-4 sm:space-y-0',
                                month: 'space-y-4',
                                table: 'w-full border-collapse space-y-1',
                                head_row: 'flex',
                                head_cell: 'text-muted-foreground rounded-md w-9 font-normal text-[0.8rem]',
                                row: 'flex w-full mt-2',
                                cell: 'h-9 w-9 text-center text-sm p-0 relative [&:has([aria-selected])]:bg-accent first:[&:has([aria-selected])]:rounded-l-md last:[&:has([aria-selected])]:rounded-r-md focus-within:relative focus-within:z-20',
                                day: 'h-9 w-9 p-0 font-normal aria-selected:opacity-100',
                                nav: 'space-x-1 flex items-center',
                                caption: 'flex justify-center pt-1 relative items-center',
                                caption_label: 'text-sm font-medium',
                                nav_button: 'h-7 w-7 bg-transparent p-0 opacity-50 hover:opacity-100'
                            }}
                            modifiersClassNames={{
                                today: 'bg-accent text-accent-foreground',
                                selected: 'bg-sky-600 text-white hover:bg-sky-600 hover:text-white focus:bg-sky-600 focus:text-white',
                                range_start: 'rounded-l-full',
                                range_end: 'rounded-r-full',
                                range_middle: 'aria-selected:bg-sky-100 aria-selected:text-sky-900',
                                outside: 'day-outside text-muted-foreground opacity-50',
                                disabled: 'text-muted-foreground opacity-50 cursor-not-allowed',
                                holiday: 'text-red-600 bg-red-50 border-red-200 font-bold',
                            }}
                        />
                    </div>
                    <div className="flex flex-col sm:flex-row gap-4 justify-center">
                        <label className="text-sm text-gray-700">
                            –°:
                            <input
                                type="date"
                                value={localStartDate}
                                onChange={handleStartDateChange}
                                className="ml-2 border border-gray-300 rounded px-2 py-1 text-sm"
                                min={formatDateForInput(new Date())}
                            />
                        </label>
                        <label className="text-sm text-gray-700">
                            –ü–æ:
                            <input
                                type="date"
                                value={localEndDate}
                                onChange={handleEndDateChange}
                                className="ml-2 border border-gray-300 rounded px-2 py-1 text-sm"
                                min={minEndDate}
                            />
                        </label>
                    </div>
                </>
            }
        </div>
    );
}

```


## <a name="rentalappmainsrccomponentsDateRangeSelectorcalendarcss"></a>`rental-app-main/src/components/DateRangeSelector/calendar.css`

```css
// path: rental-app-main/src/components/DateRangeSelector/calendar.css

/* src/components/DateRangeSelector/calendar.css */

/* –û–±—â–∏–µ —Å—Ç–∏–ª–∏ –¥–ª—è –¥–Ω—è, –∫–æ—Ç–æ—Ä—ã–µ —É–∂–µ –µ—Å—Ç—å –≤ index.css, –Ω–æ –º—ã –º–æ–∂–µ–º –∏—Ö –¥–æ–ø–æ–ª–Ω–∏—Ç—å */
.calendar-day {
    padding: 0.5rem;
    border-radius: 0; /* –£–±–∏—Ä–∞–µ–º —Å–∫—Ä—É–≥–ª–µ–Ω–∏–µ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é –¥–ª—è —Å—Ä–µ–¥–Ω–∏—Ö –¥–Ω–µ–π */
    color: #1f2937; /* –¶–≤–µ—Ç —Ç–µ–∫—Å—Ç–∞ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é */
    transition: background-color 0.2s, color 0.2s;
}

/* –°—Ç–∏–ª–∏ –¥–ª—è –¥–Ω–µ–π –≤–Ω—É—Ç—Ä–∏ –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ –¥–∏–∞–ø–∞–∑–æ–Ω–∞ (–¥—É–±–ª–∏—Ä—É—é—Ç index.css –¥–ª—è –Ω–∞–¥–µ–∂–Ω–æ—Å—Ç–∏) */
.range-middle {
    background-color: #e0f2fe; /* Tailwind sky-100 */
}

/* –°—Ç–∏–ª–∏ –¥–ª—è –Ω–∞—á–∞–ª—å–Ω–æ–π –∏ –∫–æ–Ω–µ—á–Ω–æ–π –¥–∞—Ç –¥–∏–∞–ø–∞–∑–æ–Ω–∞ (–¥—É–±–ª–∏—Ä—É—é—Ç index.css –¥–ª—è –Ω–∞–¥–µ–∂–Ω–æ—Å—Ç–∏) */
.range-start,
.range-end {
    background-color: #0284c7; /* Tailwind sky-600 */
    color: white;
    border-radius: 50%; /* –î–µ–ª–∞–µ–º –∏—Ö –∫—Ä—É–≥–ª—ã–º–∏ */
}

/* –£–±–∏—Ä–∞–µ–º —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–æ–µ –≤—ã–¥–µ–ª–µ–Ω–∏–µ –¥–ª—è –æ–¥–∏–Ω–æ—á–Ω—ã—Ö –∫–ª–∏–∫–æ–≤ –≤ —Ä–µ–∂–∏–º–µ –¥–∏–∞–ø–∞–∑–æ–Ω–∞ */
.day-selected:not([class*="range-"]) {
    background-color: transparent;
    color: inherit;
}

/* –°—Ç–∏–ª–∏ –¥–ª—è –Ω–∞–≤–∏–≥–∞—Ü–∏–∏ –∏ –∑–∞–≥–æ–ª–æ–≤–∫–æ–≤ (–¥—É–±–ª–∏—Ä—É—é—Ç index.css –¥–ª—è –Ω–∞–¥–µ–∂–Ω–æ—Å—Ç–∏) */
.calendar-caption {
    font-weight: bold;
    font-size: 1.1rem;
    text-transform: capitalize;
    padding-bottom: 0.5rem;
}

.calendar-nav {
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.calendar-head-cell {
    font-weight: 500;
    color: #4b5563; /* gray-600 */
    font-size: 0.8rem;
}

.calendar-cell {
    padding: 1px; /* –ù–µ–±–æ–ª—å—à–æ–π –æ—Ç—Å—Ç—É–ø –º–µ–∂–¥—É —è—á–µ–π–∫–∞–º–∏ –¥–ª—è –≤–∏–∑—É–∞–ª—å–Ω–æ–≥–æ —Ä–∞–∑–¥–µ–ª–µ–Ω–∏—è */
}

```


## <a name="rentalappmainsrccomponentsDiscountCalculatortsx"></a>`rental-app-main/src/components/DiscountCalculator.tsx`

```tsx
// path: rental-app-main/src/components/DiscountCalculator.tsx

// src/components/DiscountCalculator.tsx

import { useState, useMemo, useRef, useCallback, useEffect } from 'react'; // 1. –î–æ–±–∞–≤–ª–µ–Ω –∏–º–ø–æ—Ä—Ç useEffect
import { useSandboxCalculatorStore } from '@/store/sandboxCalculatorStore';
import { useDateStore } from '@/store/dateStore';
import { usePromoCodeStore } from '@/store/promoCodeStore';
import { useReserveStore } from '@/store/reserveStore';
import { Card, CardContent } from '@/components/ui/card';
import { Label } from "@/components/ui/label";
import { ChevronRight, Percent, Loader2 } from "lucide-react";
import PromoCodeInput from './PromoCodeInput';
import type { ChangeEvent } from 'react';
import { toast } from 'sonner';
import { api } from '@/lib/api';

export default function DiscountCalculator() {
    const { dayCount } = useDateStore();
    const {
        setDaysFromSlider, isCalculatorVisible, toggleCalculator,
        isLoadingTiers, durationDiscountPercentage,
        syncWithDateStore // 2. –ü–æ–ª—É—á–∞–µ–º —Ñ—É–Ω–∫—Ü–∏—é —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏
    } = useSandboxCalculatorStore();

    const {
        promoCode, setPromoCode, promoCodePercentage,
        promoCodeMessage, setPromoCodeResult, removePromoCode
    } = usePromoCodeStore();

    const { items } = useReserveStore();

    const [isApplyingPromoCode, setIsApplyingPromoCode] = useState(false);

    const debounceTimeoutRef = useRef<NodeJS.Timeout | null>(null);

    // 3. --- –î–û–ë–ê–í–õ–ï–ù –≠–¢–û–¢ –ë–õ–û–ö ---
    // –≠—Ç–æ—Ç —ç—Ñ—Ñ–µ–∫—Ç —Å–ª–µ–¥–∏—Ç –∑–∞ –∏–∑–º–µ–Ω–µ–Ω–∏–µ–º `dayCount` –≤ —Ö—Ä–∞–Ω–∏–ª–∏—â–µ –¥–∞—Ç.
    // –ö–∞–∫ —Ç–æ–ª—å–∫–æ `dayCount` –æ–±–Ω–æ–≤–∏–ª—Å—è (–ø–æ—Å–ª–µ —É—á–µ—Ç–∞ –≤—ã—Ö–æ–¥–Ω—ã—Ö),
    // –º—ã –∑–∞–ø—É—Å–∫–∞–µ–º `syncWithDateStore`, –∫–æ—Ç–æ—Ä—ã–π –ø–µ—Ä–µ—Å—á–∏—Ç—ã–≤–∞–µ—Ç —Å–∫–∏–¥–∫—É,
    // –∏—Å–ø–æ–ª—å–∑—É—è —É–∂–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –¥–Ω–µ–π.
    useEffect(() => {
        syncWithDateStore();
    }, [dayCount, syncWithDateStore]);
    // ----------------------------

    const handleApplyPromoCode = async () => {
        const currentItems = useReserveStore.getState().items;
        const currentDays = useDateStore.getState().dayCount;

        if (currentItems.length === 0) {
            toast.info("–í—ã–±–µ—Ä–∏—Ç–µ –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏–µ, —á—Ç–æ–±—ã –ø—Ä–∏–º–µ–Ω–∏—Ç—å –ø—Ä–æ–º–æ–∫–æ–¥.");
            return;
        }
        if (!promoCode) {
            toast.info("–í–≤–µ–¥–∏—Ç–µ –ø—Ä–æ–º–æ–∫–æ–¥");
            return;
        }

        const totalDailyRate = currentItems.reduce((sum, item) => sum + item.daily_rate, 0);
        const orderAmount = totalDailyRate * currentDays;

        setIsApplyingPromoCode(true);
        try {
            const response = await api.post("/promocodes/validate", {
                code: promoCode,
                order_amount: orderAmount,
                equipment_ids: currentItems.map(item => item.id)
            });
            setPromoCodeResult(response.data.discount_percentage, response.data.message);
            toast.success(response.data.message);
        } catch (error: unknown) {
            const apiError = error as { response?: { data?: { detail?: string } } }
            const errorMessage = apiError.response?.data?.detail || "–ù–µ —É–¥–∞–ª–æ—Å—å –ø—Ä–∏–º–µ–Ω–∏—Ç—å –ø—Ä–æ–º–æ–∫–æ–¥";
            setPromoCodeResult(0, errorMessage);
            toast.error(errorMessage);
        } finally {
            setIsApplyingPromoCode(false);
        }
    };

    const handleSliderChange = useCallback((event: ChangeEvent<HTMLInputElement>) => {
        const newDays = Number(event.target.value);

        if (debounceTimeoutRef.current) {
            clearTimeout(debounceTimeoutRef.current);
        }

        debounceTimeoutRef.current = setTimeout(() => {
            setDaysFromSlider(newDays);
        }, 10);
    }, [setDaysFromSlider]);

    const totalDiscountPercentage = useMemo(() => durationDiscountPercentage + promoCodePercentage, [durationDiscountPercentage, promoCodePercentage]);

    const getDiscountInfo = (percent: number) => {
        if (percent >= 25) return {label: "–ú–∞–∫—Å–∏–º—É–º –≤—ã–≥–æ–¥—ã!", className: "text-amber-600 font-bold"};
        if (percent >= 20) return {label: "–û—Ç–ª–∏—á–Ω–∞—è —Å–∫–∏–¥–∫–∞!", className: "text-purple-600 font-bold"};
        if (percent >= 15) return {label: "–•–æ—Ä–æ—à–∞—è —Å–∫–∏–¥–∫–∞", className: "text-green-600 font-bold"};
        if (percent > 0) return {label: "–ù–µ–±–æ–ª—å—à–∞—è —Å–∫–∏–¥–∫–∞", className: "text-sky-600"};
        return {label: "–°–∫–∏–¥–∫–∞ –∑–∞–≤–∏—Å–∏—Ç –æ—Ç –¥–Ω–µ–π", className: "text-gray-500"};
    };

    const discountInfo = getDiscountInfo(totalDiscountPercentage);
    const requirementMessage = items.length === 0 ? "–í—ã–±–µ—Ä–∏—Ç–µ –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏–µ –¥–ª—è –ø—Ä–æ–º–æ–∫–æ–¥–∞." : "";

    if (!isCalculatorVisible) {
        return (
            <Card
                className="my-4 bg-gray-50/50 hover:bg-gray-100 cursor-pointer transition"
                onClick={toggleCalculator}
            >
                <CardContent className="p-3">
                    <div className="flex items-center justify-between">
                        <div className="flex items-center gap-3">
                            <Percent className="w-5 h-5 text-purple-500"/>
                            <div className="text-sm">
                                <p className="text-gray-800">
                                    <span className="text-base font-bold text-purple-600">–ï—Å—Ç—å –ø—Ä–æ–º–æ–∫–æ–¥?</span>
                                    <span className="font-medium"> –∏–ª–∏ —Ö–æ—Ç–∏—Ç–µ —Ä–∞—Å—Å—á–∏—Ç–∞—Ç—å —Å–∫–∏–¥–∫—É?</span>
                                </p>
                            </div>
                        </div>
                        <ChevronRight className="w-5 h-5 text-gray-400"/>
                    </div>
                </CardContent>
            </Card>
        );
    }

    return (
        <Card className="my-4 bg-white border-sky-200 shadow-md">
            <CardContent className="p-4">
                <div className="flex flex-col md:flex-row items-center justify-between gap-6 w-full">
                    <div className="w-full md:flex-1">
                        <Label htmlFor="days-slider" className="mb-2 block text-sm text-gray-700">
                            –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –¥–Ω–µ–π: <span className="font-bold">{dayCount}</span>
                            <span className="ml-2 text-xs text-gray-500">(–¥–≤–∏–≥–∞–π—Ç–µ –ø–æ–ª–∑—É–Ω–æ–∫ –¥–ª—è –∏–∑–º–µ–Ω–µ–Ω–∏—è –¥–∞—Ç)</span>
                        </Label>
                        <input id="days-slider" type="range" min="1" max="30" value={dayCount} onChange={handleSliderChange}
                               className="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer accent-sky-600"/>
                    </div>
                    <div className="flex-shrink-0 text-center bg-sky-50 py-2 px-4 rounded-lg border w-full md:w-auto min-w-[160px]">
                        {isLoadingTiers ? (
                            <div className="flex items-center justify-center text-gray-500"><Loader2 className="h-4 w-4 animate-spin mr-2" /> –ó–∞–≥—Ä—É–∑–∫–∞...</div>
                        ) : (
                            <>
                                <div className={`text-2xl font-bold transition-colors duration-300 ${discountInfo.className}`}>–°–∫–∏–¥–∫–∞: {totalDiscountPercentage}%</div>
                                <p className={`text-xs mt-1 transition-colors duration-300 ${discountInfo.className}`}>{discountInfo.label}</p>
                            </>
                        )}
                    </div>
                    <div className="w-full md:flex-1">
                        <PromoCodeInput
                            promoCode={promoCode}
                            setPromoCode={setPromoCode}
                            applyPromoCode={handleApplyPromoCode}
                            removePromoCode={removePromoCode}
                            promoCodeMessage={promoCodeMessage}
                            isLoading={isApplyingPromoCode}
                            requirementMessage={requirementMessage}
                        />
                    </div>
                </div>
            </CardContent>
        </Card>
    );
}

```


## <a name="rentalappmainsrccomponentsEquipmentGridtsx"></a>`rental-app-main/src/components/EquipmentGrid.tsx`

```tsx
// path: rental-app-main/src/components/EquipmentGrid.tsx

// src/components/EquipmentGrid.tsx

import EquipmentCard from '@/components/equipment-card';
import CompactEquipmentCard from '@/components/CompactEquipmentCard';
import { Button } from "@/components/ui/button";
import { PackageSearch, FilterX, Loader2 } from "lucide-react";
import type { Equipment } from "@/types/equipment";
// ‚úÖ –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï: –î–æ–±–∞–≤–ª—è–µ–º –∏–º–ø–æ—Ä—Ç –Ω–µ–¥–æ—Å—Ç–∞—é—â–∏—Ö —Ç–∏–ø–æ–≤
import type { AvailabilityInfo, DayStatus, EquipmentStatus } from "@/types/availability";
import type { ViewMode } from '@/store/viewModeStore';

interface EquipmentGridProps {
    isLoading: boolean;
    items: Equipment[];
    // ‚úÖ –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï: –£–±–∏—Ä–∞–µ–º –Ω–µ–∏—Å–ø–æ–ª—å–∑—É–µ–º—ã–π –ø–∞—Ä–∞–º–µ—Ç—Ä
    // totalItemCount: number;
    hasActiveFilters: boolean;
    getEquipmentStatus: (eq: Equipment) => EquipmentStatus | "my_reservation" | "added";
    dailyAvailabilityData?: Record<number, Record<string, DayStatus>>;
    availabilityData?: AvailabilityInfo[];
    onShowMore: () => void;
    onResetFilters: () => void;
    viewMode: ViewMode;
    isFetchingNextPage: boolean;
    hasNextPage: boolean | undefined;
}

export default function EquipmentGrid({
                                          isLoading,
                                          items,
                                          // ‚úÖ –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï: –£–±–∏—Ä–∞–µ–º –Ω–µ–∏—Å–ø–æ–ª—å–∑—É–µ–º—ã–π –ø–∞—Ä–∞–º–µ—Ç—Ä
                                          // totalItemCount,
                                          hasActiveFilters,
                                          getEquipmentStatus,
                                          dailyAvailabilityData,
                                          availabilityData,
                                          onShowMore,
                                          onResetFilters,
                                          viewMode,
                                          isFetchingNextPage,
                                          hasNextPage,
                                      }: EquipmentGridProps) {

    if (isLoading && items.length === 0) {
        return <p className="text-gray-500 text-sm col-span-full text-center py-5">–ó–∞–≥—Ä—É–∑–∫–∞ –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—è...</p>;
    }

    if (items.length === 0) {
        return (
            <div className="col-span-full my-8">
                <div className="flex flex-col items-center justify-center text-center p-8 space-y-4 bg-gray-50/50 rounded-lg border-2 border-dashed">
                    {hasActiveFilters ? <FilterX className="w-16 h-16 text-gray-400" /> : <PackageSearch className="w-16 h-16 text-gray-400" />}
                    <div className="space-y-1">
                        <h3 className="text-lg font-semibold text-gray-800">{hasActiveFilters ? "–ù–∏—á–µ–≥–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ" : "–ö–∞—Ç–∞–ª–æ–≥ –ø–æ–∫–∞ –ø—É—Å—Ç"}</h3>
                        <p className="text-sm text-gray-500">{hasActiveFilters ? "–ü–æ–ø—Ä–æ–±—É–π—Ç–µ –∏–∑–º–µ–Ω–∏—Ç—å –∏–ª–∏ —Å–±—Ä–æ—Å–∏—Ç—å —Ñ–∏–ª—å—Ç—Ä—ã." : "–ó–¥–µ—Å—å –ø–æ—è–≤–∏—Ç—Å—è –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏–µ –¥–ª—è –∞—Ä–µ–Ω–¥—ã."}</p>
                    </div>
                    {hasActiveFilters && (
                        <div className="mt-4">
                            <Button variant="outline" onClick={onResetFilters}>
                                –°–±—Ä–æ—Å–∏—Ç—å —Ñ–∏–ª—å—Ç—Ä—ã
                            </Button>
                        </div>
                    )}
                </div>
            </div>
        );
    }

    const gridClasses = viewMode === "compact"
        ? "grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 2xl:grid-cols-5 gap-3 mt-4"
        : "grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-4 sm:gap-6 mt-4";

    return (
        <>
            <div className={gridClasses}>
                {items.map((eq) => {
                    const availability = availabilityData?.find(a => a.equipment_id === eq.id);
                    const equipmentDailyStatus = dailyAvailabilityData?.[eq.id];
                    const status = getEquipmentStatus(eq);

                    const equipmentProps = {
                        equipment: eq,
                        status,
                        startDate: availability?.start_date ?? undefined,
                        endDate: availability?.end_date ?? undefined,
                        dailyStatus: equipmentDailyStatus,
                    };

                    return viewMode === "compact" ? (
                        <CompactEquipmentCard key={eq.id} {...equipmentProps} />
                    ) : (
                        <EquipmentCard key={eq.id} {...equipmentProps} />
                    );
                })}
            </div>
            {hasNextPage && (
                <div className="flex justify-center mt-8">
                    <Button
                        variant="outline"
                        onClick={onShowMore}
                        disabled={isFetchingNextPage}
                    >
                        {isFetchingNextPage ? (
                            <>
                                <Loader2 className="mr-2 h-4 w-4 animate-spin" />
                                –ó–∞–≥—Ä—É–∑–∫–∞...
                            </>
                        ) : (
                            "–ü–æ–∫–∞–∑–∞—Ç—å –µ—â—ë"
                        )}
                    </Button>
                </div>
            )}
        </>
    );
}

```


## <a name="rentalappmainsrccomponentsErrorBoundarytsx"></a>`rental-app-main/src/components/ErrorBoundary.tsx`

```tsx
// path: rental-app-main/src/components/ErrorBoundary.tsx

// src/components/ErrorBoundary.tsx

import { ErrorBoundary as ReactErrorBoundary } from "react-error-boundary"
import ErrorMessage from "./ErrorMessage"

type Props = {
    children: React.ReactNode
}

/**
 * –ì–ª–æ–±–∞–ª—å–Ω—ã–π –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –æ—à–∏–±–æ–∫ –¥–ª—è –≤—Å–µ–≥–æ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è.
 * –ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç –∫–æ–º–ø–æ–Ω–µ–Ω—Ç `ErrorMessage` –ø—Ä–∏ —Å–±–æ–µ –¥–µ—Ä–µ–≤–∞ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤.
 */
export default function ErrorBoundary({ children }: Props) {
    return (
        <ReactErrorBoundary
            fallbackRender={({ error, resetErrorBoundary }) => (
                <ErrorMessage error={error} onRetry={resetErrorBoundary} />
            )}
        >
            {children}
        </ReactErrorBoundary>
    )
}


```


## <a name="rentalappmainsrccomponentsErrorMessagetsx"></a>`rental-app-main/src/components/ErrorMessage.tsx`

```tsx
// path: rental-app-main/src/components/ErrorMessage.tsx

import { AlertCircle, RotateCcw } from "lucide-react"

type Props = {
    error: Error
    onRetry?: () => void
}

export default function ErrorMessage({ error, onRetry }: Props) {
    return (
        <div className="bg-red-50 border border-red-300 text-red-700 p-4 rounded-md shadow-sm text-sm">
            <div className="flex items-start gap-2">
                <AlertCircle className="w-4 h-4 mt-0.5" />
                <div>
                    <p className="font-semibold mb-1">–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞:</p>
                    <pre className="whitespace-pre-wrap break-words">{error.message}</pre>
                </div>
            </div>
            {onRetry && (
                <button
                    onClick={onRetry}
                    className="mt-3 inline-flex items-center text-sm text-sky-700 hover:underline"
                >
                    <RotateCcw className="w-4 h-4 mr-1" />
                    –ü–æ–≤—Ç–æ—Ä–∏—Ç—å
                </button>
            )}
        </div>
    )
}


```


## <a name="rentalappmainsrccomponentsFilterPaneltsx"></a>`rental-app-main/src/components/FilterPanel.tsx`

```tsx
// path: rental-app-main/src/components/FilterPanel.tsx

// src/components/FilterPanel.tsx

import SearchInput from "@/components/SearchInput";
import AvailableCheckbox from "@/components/AvailableCheckbox";
import TypeFilter from "@/components/TypeFilter";
import BrandFilter from "@/components/BrandFilter";
import AssociationFilter from "@/components/AssociationFilter";
import ViewModeToggle from "@/components/ViewModeToggle";
import type { Equipment } from "@/types/equipment";

interface FilterPanelProps {
    // ‚úÖ –¢–∏–ø–∏–∑–∞—Ü–∏—è –Ω–µ –º–µ–Ω—è–µ—Ç—Å—è, –Ω–æ —Ç–µ–ø–µ—Ä—å —Å—é–¥–∞ –±—É–¥–µ—Ç –ø—Ä–∏—Ö–æ–¥–∏—Ç—å –ø–æ–ª–Ω—ã–π —Å–ø–∏—Å–æ–∫
    equipmentData: Equipment[];
}

export default function FilterPanel({ equipmentData }: FilterPanelProps) {
    return (
        <div className="bg-white border border-gray-200 shadow-sm rounded-lg p-4 space-y-4">
            <div className="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4">
                <SearchInput />
                <div className="flex items-center gap-2">
                    <AvailableCheckbox />
                    <ViewModeToggle />
                </div>
            </div>
            <div className="flex flex-wrap gap-2 sm:gap-3">
                {/* ‚úÖ –ü–µ—Ä–µ–¥–∞–µ–º –ø–æ–ª–Ω—ã–π —Å–ø–∏—Å–æ–∫ –¥–∞–ª—å—à–µ */}
                <TypeFilter items={equipmentData} />
            </div>
            <div className="flex flex-wrap gap-2 sm:gap-3">
                {/* ‚úÖ AssociationFilter —É–∂–µ –ø–æ–ª—É—á–∞–µ—Ç –ø–æ–ª–Ω—ã–π —Å–ø–∏—Å–æ–∫ –∞—Å—Å–æ—Ü–∏–∞—Ü–∏–π –∏–∑ —Å–≤–æ–µ–≥–æ —Ö—É–∫–∞, –µ–≥–æ —Ç—Ä–æ–≥–∞—Ç—å –Ω–µ –Ω–∞–¥–æ */}
                <AssociationFilter />
            </div>
            <div className="flex flex-wrap gap-2 sm:gap-3">
                {/* ‚úÖ –ü–µ—Ä–µ–¥–∞–µ–º –ø–æ–ª–Ω—ã–π —Å–ø–∏—Å–æ–∫ –¥–∞–ª—å—à–µ */}
                <BrandFilter items={equipmentData} />
            </div>
        </div>
    );
}

```


## <a name="rentalappmainsrccomponentsMyReservationListtsx"></a>`rental-app-main/src/components/MyReservationList.tsx`

```tsx
// path: rental-app-main/src/components/MyReservationList.tsx

// src/components/MyReservationList.tsx

import { useMemo, useState } from "react";
import { useReservations } from "@/hooks/useReservations";
import { useAllEquipment } from "@/hooks/useAllEquipment";
import { ReservationService } from "@/core/services";
import ReservationCard from "./ReservationCard";
import { Checkbox } from "@/components/ui/checkbox";
import { useNavigate } from "react-router-dom";
import { useReserveStore } from "@/store/reserveStore";
import { useDateStore } from "@/store/dateStore";
import { Button } from "@/components/ui/button";
import { FileText, FilterX } from "lucide-react";
import ConfirmItemRemovalDialog from "./ConfirmItemRemovalDialog";

import type { Equipment } from "@/types/equipment";
import type { Reservation, ReservationWithNames } from "@/types/reservation";

interface MyReservationListProps {
    continueEditingReservationId?: number;
    highlightId?: number | null;
    reservationsData?: Reservation[];
    isLoading?: boolean;
    isError?: boolean;
}

const LoadingState = () => (
    <p className="text-center py-4">–ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö...</p>
);

const ErrorState = ({ message }: { message: string }) => (
    <p className="text-red-600 text-center py-4">{message}</p>
);

export default function MyReservationList({
                                              continueEditingReservationId,
                                              highlightId,
                                              reservationsData: propReservationsData,
                                              isLoading: propIsLoading,
                                              isError: propIsError,
                                          }: MyReservationListProps) {
    const { data: allEquipment = [], isLoading: isLoadingEquipment, isError: isEquipmentError } = useAllEquipment();

    const equipmentMap = useMemo(() => {
        const map: Record<number, Equipment> = {};
        allEquipment.forEach(e => { map[e.id] = e; });
        return map;
    }, [allEquipment]);

    const { deleteReservation, updateReservation } = useReservations();

    // –ò—Å–ø–æ–ª—å–∑—É–µ–º –¥–∞–Ω–Ω—ã–µ –∏–∑ –ø—Ä–æ–ø—Å–æ–≤ –∏–ª–∏ –∑–∞–≥—Ä—É–∂–∞–µ–º –∏—Ö —Å–∞–º–æ—Å—Ç–æ—è—Ç–µ–ª—å–Ω–æ
    const reservationsData: Reservation[] = useMemo(() => propReservationsData ?? [], [propReservationsData]);
    const isLoadingReservations = propIsLoading ?? false;
    const isReservationsError = propIsError ?? false;

    const navigate = useNavigate();
    const reserveStore = useReserveStore();
    const dateStore = useDateStore();

    const [deletingId, setDeletingId] = useState<number | null>(null);
    const [hideCompleted, setHideCompleted] = useState<boolean>(false);
    const [itemToRemove, setItemToRemove] = useState<{ reservationId: number; equipmentId: number } | null>(null);

    const reservationsWithNames: ReservationWithNames[] = useMemo(() =>
            ReservationService.createReservationsWithNames(reservationsData, equipmentMap),
        [reservationsData, equipmentMap]
    );

    const filteredByStatus = useMemo(() =>
            hideCompleted
                ? reservationsWithNames.filter((r: ReservationWithNames) => 
                    // –°–∫—Ä—ã–≤–∞–µ–º —Ä–µ–∑–µ—Ä–≤—ã —Å–æ —Å—Ç–∞—Ç—É—Å–∞–º–∏ 'fulfilled' (–≤—ã–¥–∞–Ω –≤ –∞—Ä–µ–Ω–¥—É) –∏ 'cancelled' (–æ—Ç–º–µ–Ω–µ–Ω)
                    r.status !== 'fulfilled' && r.status !== 'cancelled'
                )
                : reservationsWithNames,
        [hideCompleted, reservationsWithNames]
    );

    // –¢–µ–ø–µ—Ä—å –¥–∞–Ω–Ω—ã–µ —É–∂–µ –æ—Ç—Ñ–∏–ª—å—Ç—Ä–æ–≤–∞–Ω—ã –∏ –æ—Ç—Å–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω—ã –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ
    const finalReservations = filteredByStatus;

    if (isLoadingReservations || isLoadingEquipment) {
        return <LoadingState />;
    }

    if (isReservationsError) {
        return <ErrorState message="–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ä–µ–∑–µ—Ä–≤–æ–≤" />;
    }

    if (isEquipmentError) {
        return <ErrorState message="–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—è" />;
    }

    const cancelReservation = async (id: number) => {
        setDeletingId(id);
        try {
            await deleteReservation.mutateAsync(id);
        } catch (error) {
            console.error(`[MyReservationList] Error cancelling reservation ${id}:`, error);
            alert("–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–º–µ–Ω–µ —Ä–µ–∑–µ—Ä–≤–∞.");
        } finally {
            setDeletingId(null);
        }
    };

    const removeItemFromReservation = async (
        reservationId: number,
        equipmentIdToRemove: number
    ) => {
        const reservation = reservationsData.find((r: Reservation) => r.id === reservationId);
        if (!reservation) return;

        const newEquipmentIdsList = reservation.equipment_ids.filter((id: number) => id !== equipmentIdToRemove);
        try {
            if (newEquipmentIdsList.length === 0) {
                await deleteReservation.mutateAsync(reservationId);
            } else {
                await updateReservation.mutateAsync({
                    id: reservationId,
                    equipment_ids: newEquipmentIdsList,
                    start_date: reservation.start_date,
                    end_date: reservation.end_date,
                });
            }
        } catch (error) {
            console.error(`[MyReservationList] Error removing equipment from reservation:`, error);
            alert("–û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ –ø–æ–∑–∏—Ü–∏–∏ –∏–∑ —Ä–µ–∑–µ—Ä–≤–∞.");
        }
    };

    const requestItemRemoval = (reservationId: number, equipmentId: number) => {
        setItemToRemove({ reservationId, equipmentId });
    };

    const confirmItemRemoval = () => {
        if (itemToRemove) {
            void removeItemFromReservation(itemToRemove.reservationId, itemToRemove.equipmentId)
                .finally(() => {
                    setItemToRemove(null);
                });
        }
    };

    const cancelItemRemoval = () => {
        setItemToRemove(null);
    };


    const repeatReservation = (r: ReservationWithNames) => {
        reserveStore.clear();
        const validEquipment = r.equipment_ids
            .map((id: number) => equipmentMap[id])
            .filter((eq): eq is Equipment => Boolean(eq));
        reserveStore.bulkAdd(validEquipment);
        dateStore.setRange(new Date(r.start_date), new Date(r.end_date));
        navigate("/", {
            state: {
                intent: "add_to_existing_reservation",
                reservationId: r.id,
                startDate: r.start_date,
                endDate: r.end_date,
                equipmentIds: r.equipment_ids
            }
        });
    };

    const renderedCards = finalReservations
        .map((r: ReservationWithNames) => {
            const equipmentListForCard = r.equipment_ids
                .map((id: number) => {
                    const eq = equipmentMap[id];
                    return eq ? { id, label: `${eq.equipment_type} ${eq.brand} ${eq.name}` } : null;
                })
                .filter((item): item is { id: number; label: string } => Boolean(item));

            if (r.equipment_ids.length === 0) {
                return null;
            }

            const autoStartEditForThisCard = r.id === continueEditingReservationId;

            return (
                <ReservationCard
                    key={`${r.id}-${r.equipment_ids.join('-')}-${r.start_date}-${r.end_date}`}
                    id={r.id}
                    start_date={r.start_date}
                    end_date={r.end_date}
                    status={r.status}
                    equipment={equipmentListForCard}
                    onCancel={() => cancelReservation(r.id)}
                    cancelDisabled={deletingId === r.id}
                    onRemoveItem={(equipmentId) => requestItemRemoval(r.id, equipmentId)}
                    onRepeat={() => repeatReservation(r)}
                    autoStartEdit={autoStartEditForThisCard}
                    total_cost={r.total_cost}
                    discount_amount={r.discount_amount}
                    promo_code={r.promo_code}
                    selected_accessories={r.selected_accessories}
                    accessory_links={r.accessory_links}
                    highlightId={highlightId}
                    rental_id={r.rental_id}
                />
            );
        })
        .filter(Boolean);

    const hasFilters = (filteredByStatus.length > 0) &&
        finalReservations.length === 0 &&
        reservationsData.length > 0;

    return (
        <div>
            <div className="mb-4 flex items-center gap-2">
                <Checkbox
                    id="hideCompleted"
                    checked={hideCompleted}
                    onCheckedChange={(checked) => setHideCompleted(Boolean(checked))}
                />
                <label htmlFor="hideCompleted" className="text-sm text-gray-700">
                    –°–∫—Ä—ã—Ç—å –∑–∞–≤–µ—Ä—à—ë–Ω–Ω—ã–µ —Ä–µ–∑–µ—Ä–≤—ã
                </label>
            </div>
            {renderedCards.length === 0 ? (
                <div className="my-8">
                    <div className="flex flex-col items-center justify-center text-center p-8 space-y-4 bg-gray-50/50 rounded-lg border-2 border-dashed">
                        {hasFilters ? <FilterX className="w-16 h-16 text-gray-400" /> : <FileText className="w-16 h-16 text-gray-400" />}
                        <div className="space-y-1">
                            <h3 className="text-lg font-semibold text-gray-800">
                                {hasFilters ? "–†–µ–∑–µ—Ä–≤—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã" : "–£ –≤–∞—Å –ø–æ–∫–∞ –Ω–µ—Ç —Ä–µ–∑–µ—Ä–≤–æ–≤"}
                            </h3>
                            <p className="text-sm text-gray-500">
                                {hasFilters
                                    ? "–ù–∏ –æ–¥–∏–Ω –∏–∑ –≤–∞—à–∏—Ö —Ä–µ–∑–µ—Ä–≤–æ–≤ –Ω–µ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç –∑–∞–¥–∞–Ω–Ω—ã–º —Ñ–∏–ª—å—Ç—Ä–∞–º."
                                    : "–ó–¥–µ—Å—å –±—É–¥—É—Ç –æ—Ç–æ–±—Ä–∞–∂–∞—Ç—å—Å—è –≤–∞—à–∏ –±—É–¥—É—â–∏–µ –∏ –ø—Ä–æ—à–ª—ã–µ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è."}
                            </p>
                        </div>
                        {!hasFilters && (
                            <div className="mt-4">
                                <Button onClick={() => navigate("/")}>–°–æ–∑–¥–∞—Ç—å –ø–µ—Ä–≤—ã–π —Ä–µ–∑–µ—Ä–≤</Button>
                            </div>
                        )}
                    </div>
                </div>
            ) : (
                <ul className="space-y-4">{renderedCards}</ul>
            )}

            <ConfirmItemRemovalDialog
                open={!!itemToRemove}
                onClose={cancelItemRemoval}
                onConfirm={confirmItemRemoval}
                isConfirming={updateReservation.isPending || deleteReservation.isPending}
            />
        </div>
    );
}

```


## <a name="rentalappmainsrccomponentsNetworkStatustsx"></a>`rental-app-main/src/components/NetworkStatus.tsx`

```tsx
// path: rental-app-main/src/components/NetworkStatus.tsx

// src/components/NetworkStatus.tsx
import { useNetworkStatus } from "@/hooks/useNetworkStatus"
import { WifiOff, Wifi } from "lucide-react"

export default function NetworkStatus() {
    const isOnline = useNetworkStatus()

    return (
        <div
            className={`fixed bottom-4 left-4 z-50 text-xs font-medium px-3 py-1.5 rounded-md shadow-lg transition
      ${isOnline ? "bg-green-100 text-green-700 border border-green-300" : "bg-red-100 text-red-700 border border-red-300"}
      `}
        >
            <div className="flex items-center gap-2">
                {isOnline ? <Wifi className="w-4 h-4" /> : <WifiOff className="w-4 h-4" />}
                {isOnline ? "–í —Å–µ—Ç–∏" : "–ù–µ—Ç –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è"}
            </div>
        </div>
    )
}


```


## <a name="rentalappmainsrccomponentsPromoCodeInputtsx"></a>`rental-app-main/src/components/PromoCodeInput.tsx`

```tsx
// path: rental-app-main/src/components/PromoCodeInput.tsx

// src/components/PromoCodeInput.tsx
import { Input } from "@/components/ui/input";
import { Button } from "@/components/ui/button";
import { Label } from "@/components/ui/label";
import { TicketPercent, CheckCircle, XCircle, Loader2, AlertTriangle } from "lucide-react";
import { toast } from "sonner";

interface PromoCodeInputProps {
    promoCode: string;
    setPromoCode: (code: string) => void;
    applyPromoCode: () => void;
    removePromoCode?: () => void;
    promoCodeMessage: string;
    disabled?: boolean;
    isLoading?: boolean;
    requirementMessage?: string;
}

export default function PromoCodeInput({
                                           promoCode,
                                           setPromoCode,
                                           applyPromoCode,
                                           removePromoCode,
                                           promoCodeMessage,
                                           disabled = false,
                                           isLoading = false,
                                           requirementMessage,
                                       }: PromoCodeInputProps) {

    const handleApply = () => {
        if (!promoCode.trim()) {
            toast.info("–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–≤–µ–¥–∏—Ç–µ –ø—Ä–æ–º–æ–∫–æ–¥.");
            return;
        }
        applyPromoCode();
    };

    const isApplied = promoCodeMessage && promoCodeMessage.length > 0;
    const isSuccess = isApplied && promoCodeMessage.includes("—É—Å–ø–µ—à–Ω–æ");
    const isDisabledByRequirement = !!requirementMessage;

    return (
        <div className="space-y-2">
            <div className="flex justify-between items-center">
                <Label htmlFor="promo-code" className="text-sm font-medium">–ï—Å—Ç—å –ø—Ä–æ–º–æ–∫–æ–¥?</Label>
                {/* –ë—ã–ª–æ: {isSuccess && removePromoCode && ( */}
                {/* –°—Ç–∞–ª–æ: –£—Å–ª–æ–≤–∏–µ —Ç–µ–ø–µ—Ä—å –∑–∞–≤–∏—Å–∏—Ç –æ—Ç –Ω–∞–ª–∏—á–∏—è —Ç–µ–∫—Å—Ç–∞ –≤ –ø–æ–ª–µ –ø—Ä–æ–º–æ–∫–æ–¥–∞ */}
                {promoCode && removePromoCode && (
                    <button onClick={removePromoCode} className="text-xs text-gray-500 hover:text-red-600 hover:underline">–°–±—Ä–æ—Å–∏—Ç—å</button>
                )}
            </div>
            <div className="flex items-center gap-2">
                <div className="relative flex-grow">
                    <TicketPercent className="absolute left-2.5 top-2.5 h-4 w-4 text-gray-400" />
                    <Input
                        id="promo-code"
                        type="text"
                        placeholder="SALE15"
                        value={promoCode}
                        onChange={(e) => setPromoCode(e.target.value)}
                        disabled={disabled || isLoading || isSuccess || isDisabledByRequirement}
                        className="pl-8"
                    />
                    {isSuccess && promoCode && (
                        <CheckCircle className="absolute right-2.5 top-2.5 h-4 w-4 text-green-500" />
                    )}
                </div>
                <Button
                    type="button"
                    variant="outline"
                    onClick={handleApply}
                    disabled={disabled || isLoading || isSuccess || isDisabledByRequirement}
                >
                    {isLoading ? <Loader2 className="h-4 w-4 animate-spin" /> : "–ü—Ä–∏–º–µ–Ω–∏—Ç—å"}
                </Button>
            </div>

            {isDisabledByRequirement && (
                <div className="flex items-center gap-1.5 text-xs mt-1.5 text-orange-600">
                    <AlertTriangle className="h-4 w-4" />
                    <span>{requirementMessage}</span>
                </div>
            )}

            {!isDisabledByRequirement && isApplied && (
                <div className={`flex items-center gap-1.5 text-xs mt-1.5 ${isSuccess ? "text-green-600" : "text-red-600"}`}>
                    {!isSuccess && <XCircle className="h-3.5 w-3.5" />}
                    <span>{promoCodeMessage}</span>
                </div>
            )}
        </div>
    );
}

```


## <a name="rentalappmainsrccomponentsRequireAuthtsx"></a>`rental-app-main/src/components/RequireAuth.tsx`

```tsx
// path: rental-app-main/src/components/RequireAuth.tsx

import { ReactNode } from "react"
import { Navigate, useLocation } from "react-router-dom"
import { useCurrentUser } from "@/hooks/useProfile"

type Props = {
    children: ReactNode
    role?: string | string[] // –î–æ–±–∞–≤–ª–µ–Ω –ø—Ä–æ–ø—Å role
}

export default function RequireAuth({ children, role }: Props) {
    const { data: user, isLoading } = useCurrentUser()
    const location = useLocation()

    if (isLoading) {
        return <p>–ó–∞–≥—Ä—É–∑–∫–∞ –ø—Ä–æ—Ñ–∏–ª—è...</p>
    }
    if (!user) {
        return <Navigate to="/" replace state={{ from: location.pathname }} />
    }
    // –î–æ–±–∞–≤–ª–µ–Ω–∞ –ø—Ä–æ–≤–µ—Ä–∫–∞ —Ä–æ–ª–∏
    if (role && !(Array.isArray(role) ? role.includes(user.role) : user.role === role)) {
        return <Navigate to="/" replace state={{ from: location.pathname }} />
    }

    return <>{children}</>
}


```


## <a name="rentalappmainsrccomponentsReservationCardtsx"></a>`rental-app-main/src/components/ReservationCard.tsx`

```tsx
// path: rental-app-main/src/components/ReservationCard.tsx

// src/components/ReservationCard.tsx
import { useEffect, useMemo, useState } from "react";
import { useNavigate, useLocation } from "react-router-dom";
import { ReservationEditProvider } from "@/hooks/useInlineReservationEdit"; // ‚ú® –ò–º–ø–æ—Ä—Ç–∏—Ä—É–µ–º –ø—Ä–æ–≤–∞–π–¥–µ—Ä
import EditableReservationCard from "./reservation/EditableReservationCard";
import ViewReservationCard from "./reservation/ViewReservationCard";
import type { Reservation, AccessoryLink } from "@/types/reservation";
import type { EquipmentDisplayDetail } from "@/hooks/reservation/useReservationState";

type Props = {
    id: number;
    equipment: EquipmentDisplayDetail[];
    start_date: string;
    end_date: string;
    status: Reservation['status'];
    onRemoveItem?: (equipmentId: number) => void;
    onCancel?: () => void;
    cancelDisabled?: boolean;
    onRepeat?: () => void;
    autoStartEdit?: boolean;
    total_cost?: number;
    discount_amount?: number;
    promo_code?: string | null;
    selected_accessories?: Record<number, number[]>;
    accessory_links?: AccessoryLink[];
    highlightId?: number | null;
    rental_id?: number | null;
};

export default function ReservationCard({
                                            id, equipment, start_date, end_date, status, onRemoveItem, onCancel,
                                            cancelDisabled, onRepeat, autoStartEdit = false,
                                            total_cost, discount_amount, promo_code, selected_accessories,
                                            accessory_links, highlightId, rental_id
                                        }: Props) {
    const navigate = useNavigate();
    const location = useLocation();

    // ‚ú® 1. –£–ø—Ä–∞–≤–ª—è–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ–º —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –ø—Ä—è–º–æ –∑–¥–µ—Å—å.
    const [isEditing, setIsEditing] = useState(autoStartEdit);
    const [hasAutoStarted, setHasAutoStarted] = useState(false);

    // –≠—Ç–æ—Ç –æ–±—ä–µ–∫—Ç –≤—Å–µ –µ—â–µ –Ω—É–∂–µ–Ω –¥–ª—è –ø–µ—Ä–µ–¥–∞—á–∏ –≤ –ø—Ä–æ–≤–∞–π–¥–µ—Ä.
    const reservationForProvider: Reservation = useMemo(() => ({
        id, equipment_ids: equipment.map(e => e.id), start_date, end_date, status,
        total_cost, discount_amount, promo_code,
        selected_accessories: selected_accessories || {},
    }), [id, equipment, start_date, end_date, status, total_cost, discount_amount, promo_code, selected_accessories]);

    useEffect(() => {
        if (autoStartEdit && !isEditing && !hasAutoStarted) {
            setIsEditing(true);
            setHasAutoStarted(true);
        }
    }, [autoStartEdit, isEditing, hasAutoStarted]);


    // ‚ú® 2. –ú—ã –±–æ–ª—å—à–µ –Ω–µ –∏—Å–ø–æ–ª—å–∑—É–µ–º —Ö—É–∫ useInlineReservationEdit –Ω–∞–ø—Ä—è–º—É—é –∑–¥–µ—Å—å.
    // –í–º–µ—Å—Ç–æ —ç—Ç–æ–≥–æ –º—ã —É–ø—Ä–∞–≤–ª—è–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ–º isEditing –∏ —Ä–µ–Ω–¥–µ—Ä–∏–º –ª–∏–±–æ View, –ª–∏–±–æ Provider+Edit.

    const isHighlighted = highlightId === id;

    return (
        <div className={`transition-all duration-300 ${
            isHighlighted 
                ? "ring-2 ring-sky-500 bg-sky-50 shadow-lg rounded-2xl" 
                : ""
        }`}>
            {isEditing ? (
                // ‚ú® 3. –û–±–æ—Ä–∞—á–∏–≤–∞–µ–º –∫–æ–º–ø–æ–Ω–µ–Ω—Ç —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –≤ –Ω–∞—à –Ω–æ–≤—ã–π –ø—Ä–æ–≤–∞–π–¥–µ—Ä.
                <ReservationEditProvider
                    reservation={reservationForProvider}
                    initialEquipmentForDisplay={equipment}
                    onFullCancellation={onCancel}
                    isAdminContext={false}
                    // ‚ú® 4. –ü–µ—Ä–µ–¥–∞–µ–º –∫–æ–ª–±—ç–∫ –¥–ª—è –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è.
                    onFinishEditing={() => {
                        setIsEditing(false);
                        // –ï—Å–ª–∏ —ç—Ç–æ –±—ã–ª–æ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ, —á–∏—Å—Ç–∏–º —Å—Ç–µ–π—Ç –≤ location
                        if (autoStartEdit) {
                            navigate(location.pathname, { replace: true, state: {} });
                        }
                    }}
                >
                    {/* EditableReservationCard —Ç–µ–ø–µ—Ä—å –Ω–µ –ø—Ä–∏–Ω–∏–º–∞–µ—Ç –ø—Ä–æ–ø—Å–æ–≤! */}
                    <EditableReservationCard />
                </ReservationEditProvider>
            ) : (
                <ViewReservationCard
                    id={id}
                    equipment={equipment}
                    start_date={start_date}
                    end_date={end_date}
                    status={status}
                    // ‚ú® 5. –ö–Ω–æ–ø–∫–∞ "–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å" —Ç–µ–ø–µ—Ä—å –ø—Ä–æ—Å—Ç–æ –ø–µ—Ä–µ–∫–ª—é—á–∞–µ—Ç –ª–æ–∫–∞–ª—å–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ.
                    onEdit={status === 'active' ? () => setIsEditing(true) : undefined}
                    onCancel={onCancel}
                    onRemoveItem={onRemoveItem}
                    onRepeat={onRepeat}
                    cancelDisabled={cancelDisabled}
                    total_cost={total_cost}
                    discount_amount={discount_amount}
                    promo_code={promo_code}
                    accessory_links={accessory_links}
                    rental_id={rental_id}
                />
            )}

            {/* –î–∏–∞–ª–æ–≥ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è —É–¥–∞–ª–µ–Ω–∏—è –æ—Å—Ç–∞–µ—Ç—Å—è –∑–¥–µ—Å—å, —Ç.–∫. –æ–Ω —Å–≤—è–∑–∞–Ω —Å ViewReservationCard */}
            {/* –ï–≥–æ –ª–æ–≥–∏–∫–∞ –±—É–¥–µ—Ç –ø–µ—Ä–µ—Å–º–æ—Ç—Ä–µ–Ω–∞, –µ—Å–ª–∏ –ø–æ—Ç—Ä–µ–±—É–µ—Ç—Å—è –≤ —Ä–µ–∂–∏–º–µ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è */}
            {/* <ConfirmItemRemovalDialog ... />  <- –º–æ–∂–Ω–æ –ø–æ–∫–∞ –æ—Å—Ç–∞–≤–∏—Ç—å –∏–ª–∏ –∑–∞–∫–æ–º–º–µ–Ω—Ç–∏—Ä–æ–≤–∞—Ç—å */}
        </div>
    );
}

```


## <a name="rentalappmainsrccomponentsReservationFootertsx"></a>`rental-app-main/src/components/ReservationFooter.tsx`

```tsx
// path: rental-app-main/src/components/ReservationFooter.tsx

// src/components/ReservationFooter.tsx

import { Button } from "@/components/ui/button";
import { ArrowRight, X } from "lucide-react";

interface ReservationFooterProps {
    selectedCount: number;
    onClick: () => void;
    // ‚úÖ –î–æ–±–∞–≤–ª—è–µ–º –Ω–æ–≤–æ–µ —Å–≤–æ–π—Å—Ç–≤–æ –¥–ª—è —Å–±—Ä–æ—Å–∞
    onReset: () => void;
    isEditingMode: boolean;
    intent?: string;
}

export default function ReservationFooter({ selectedCount, onClick, onReset, isEditingMode, intent }: ReservationFooterProps) {
    if (selectedCount === 0) {
        return null;
    }

    const buttonText = isEditingMode && intent !== "add_to_new_reservation"
        ? `‚úîÔ∏è –î–æ–±–∞–≤–∏—Ç—å –∫ —Ä–µ–∑–µ—Ä–≤—É (${selectedCount})`
        : `üì• –û—Ñ–æ—Ä–º–∏—Ç—å (${selectedCount})`;

    return (
        <div className="fixed bottom-0 left-0 right-0 z-50 p-4 bg-background/90 backdrop-blur-sm border-t border-border shadow-[0_-4px_15px_rgba(0,0,0,0.08)]">
            <div className="max-w-7xl mx-auto flex justify-between items-center">
                {/* ‚úÖ –ù–æ–≤–∞—è –∫–Ω–æ–ø–∫–∞ "–°–±—Ä–æ—Å–∏—Ç—å –≤—ã–±–æ—Ä" —Å–ª–µ–≤–∞ */}
                <Button
                    onClick={onReset}
                    variant="destructive"
                    size="lg"
                    className="flex items-center gap-2"
                >
                    <X className="h-5 w-5" />
                    –°–±—Ä–æ—Å–∏—Ç—å –≤—ã–±–æ—Ä
                </Button>

                {/* –ë–ª–æ–∫ —Å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–µ–π –∏ –æ—Å–Ω–æ–≤–Ω–æ–π –∫–Ω–æ–ø–∫–æ–π —Å–ø—Ä–∞–≤–∞ */}
                <div className="flex items-center gap-4">
                    <div className="text-sm text-foreground">
                        <span className="font-semibold">–í—ã–±—Ä–∞–Ω–æ –¥–ª—è —Ä–µ–∑–µ—Ä–≤–∞:</span>
                        <span className="ml-2 font-bold text-lg">{selectedCount} –ø–æ–∑.</span>
                    </div>
                    <Button
                        onClick={onClick}
                        size="lg"
                        className="bg-green-600 hover:bg-green-700 text-white shadow-lg flex items-center gap-2"
                    >
                        {buttonText}
                        <ArrowRight className="h-5 w-5" />
                    </Button>
                </div>
            </div>
        </div>
    );
}

```


## <a name="rentalappmainsrccomponentsReservationListtsx"></a>`rental-app-main/src/components/ReservationList.tsx`

```tsx
// path: rental-app-main/src/components/ReservationList.tsx

import { useReserveSubmission } from "@/hooks/reservation/submission/useReserveSubmission"
import type { Equipment } from "@/types/equipment"

export default function ReservationList() {
    const {
        items,
        unavailableIdsFromAPI,
        submitMessage,
        reservationSuccess,
        removeItemFromStore,
        clearReserveStore,
        handleSubmit,
    } = useReserveSubmission()

    if (items.length === 0) return null

    return (
        <div className="mt-6 p-4 border rounded bg-white shadow-sm max-w-2xl mx-auto">
            <h2 className="text-lg font-bold mb-4">–í—ã–±—Ä–∞–Ω–Ω–æ–µ –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏–µ:</h2>

            <ul className="space-y-2 mb-4">
                {items.map((item: Equipment) => (
                    <li
                        key={item.id}
                        className={`flex justify-between items-center border-b pb-1 ${
                            unavailableIdsFromAPI.includes(item.id) ? "bg-red-50 border-red-600" : ""
                        }`}
                    >
                        <div>
                            <p className="font-medium">{item.name}</p>
                            <p className="text-sm text-gray-500">
                                {item.brand} ‚Ä¢ {item.equipment_type}
                            </p>
                            {unavailableIdsFromAPI.includes(item.id) && (
                                <p className="text-xs text-red-600 pt-1">
                                    –≠—Ç–æ –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏–µ —Å—Ç–∞–ª–æ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω—ã–º
                                </p>
                            )}
                        </div>
                        <button
                            onClick={() => removeItemFromStore(item.id)}
                            className="text-red-600 hover:underline text-sm"
                        >
                            –£–¥–∞–ª–∏—Ç—å
                        </button>
                    </li>
                ))}
            </ul>

            <div className="flex justify-between items-center">
                <button
                    onClick={clearReserveStore}
                    className="text-gray-600 hover:underline text-sm"
                >
                    –û—á–∏—Å—Ç–∏—Ç—å –≤—Å—ë
                </button>
                <button
                    onClick={handleSubmit}
                    className="bg-sky-700 text-white px-4 py-2 rounded hover:bg-sky-800 text-sm font-medium"
                    disabled={unavailableIdsFromAPI.length > 0}
                >
                    üì§ –û—Ç–ø—Ä–∞–≤–∏—Ç—å —Ä–µ–∑–µ—Ä–≤
                </button>
            </div>

            {submitMessage && (
                <p
                    className={`text-sm mt-3 text-center ${
                        reservationSuccess ? "text-green-700" : "text-red-600"
                    }`}
                >
                    {submitMessage}
                </p>
            )}
        </div>
    )
}


```


## <a name="rentalappmainsrccomponentsReserveEquipmentCardtsx"></a>`rental-app-main/src/components/ReserveEquipmentCard.tsx`

```tsx
// path: rental-app-main/src/components/ReserveEquipmentCard.tsx

// src/components/ReserveEquipmentCard.tsx
import { useState } from "react";
import { Trash2, Paperclip, ChevronDown } from "lucide-react";
import { Checkbox } from "@/components/ui/checkbox";
import { Label } from "@/components/ui/label";
import type { Equipment } from "@/types/equipment";
import type { AvailabilityInfo, EquipmentStatus } from "@/types/availability";
import { Card, CardContent } from "@/components/ui/card";
import { formatDateRangeEuropean } from "@/lib/utils";

type Props = {
    equipment: Equipment;
    availability?: AvailabilityInfo;
    onRemove: (id: number) => void;
    // ‚úÖ –î–û–ë–ê–í–õ–ï–ù–´ –ù–û–í–´–ï –°–í–û–ô–°–¢–í–ê
    isAccessorySelected: (equipmentId: number, accessoryId: number) => boolean;
    onToggleAccessory: (equipmentId: number, accessoryId: number) => void;
};

const statusTextMap: Record<EquipmentStatus | string, string> = {
    available: "–°–≤–æ–±–æ–¥–Ω–æ",
    reserved: "–í —Ä–µ–∑–µ—Ä–≤–µ (–¥—Ä—É–≥–∏–º)",
    rented: "–í –∞—Ä–µ–Ω–¥–µ (–¥—Ä—É–≥–∏–º)",
    my_reservation: "–í —ç—Ç–æ–º —Ä–µ–∑–µ—Ä–≤–µ",
};

const statusColorMap: Record<EquipmentStatus | string, string> = {
    available: "text-green-600",
    reserved: "text-rose-500",
    rented: "text-red-600",
    my_reservation: "text-sky-700",
};

const bgColorMap: Record<EquipmentStatus | string, string> = {
    available: "bg-white",
    reserved: "bg-rose-50 border-rose-200",
    rented: "bg-rose-100 border-rose-300",
    my_reservation: "bg-sky-50 border-sky-200",
};

function formatDateRange(start?: string, end?: string) {
    if (!start || !end) return "";
    return `(${formatDateRangeEuropean(start, end)})`;
}

export default function ReserveEquipmentCard({
                                                 equipment,
                                                 availability,
                                                 onRemove,
                                                 // ‚úÖ –ü–û–õ–£–ß–ê–ï–ú –ù–û–í–´–ï –°–í–û–ô–°–¢–í–ê
                                                 isAccessorySelected,
                                                 onToggleAccessory
                                             }: Props) {
    const status = availability?.status ?? "available";
    const statusText = statusTextMap[status] || "–ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π —Å—Ç–∞—Ç—É—Å";
    const colorClass = statusColorMap[status] || "text-gray-500";
    const bgClass = bgColorMap[status] || "bg-gray-50";
    const dateRange = (status === "reserved" || status === "rented")
        ? formatDateRange(availability?.start_date, availability?.end_date)
        : "";
    const isExternalConflict = status === "reserved" || status === "rented";

    // ‚úÖ –°–û–°–¢–û–Ø–ù–ò–ï –î–õ–Ø –û–¢–û–ë–†–ê–ñ–ï–ù–ò–Ø –°–ü–ò–°–ö–ê –ê–ö–°–ï–°–°–£–ê–†–û–í
    const [showAccessories, setShowAccessories] = useState(false);

    return (
        <Card
            className={`rounded-xl px-4 py-4 sm:px-6 shadow-sm transition border w-full flex flex-col ${bgClass}`}
        >
            <CardContent className="p-0 flex-1 flex flex-col sm:flex-row justify-between items-start gap-4">
                <div className="flex-1">
                    <h3 className="text-base sm:text-lg font-semibold mb-1">{equipment.name}</h3>
                    <p className="text-xs sm:text-sm text-gray-500 mb-1">
                        {equipment.brand} ‚Ä¢ {equipment.equipment_type}
                    </p>
                    <p className="text-xs sm:text-sm mb-1">
                        –°–æ—Å—Ç–æ—è–Ω–∏–µ: <strong>{equipment.condition}</strong>
                    </p>
                    <p className="text-sm sm:text-base font-bold mb-1">{equipment.daily_rate} ‚ÇΩ / –¥–µ–Ω—å</p>

                    <p className={`text-sm font-semibold mt-2 ${colorClass}`}>
                        {statusText}
                        {dateRange && <span className="ml-1 text-xs font-normal">{dateRange}</span>}
                    </p>

                    {/* ‚úÖ –ù–ê–ß–ê–õ–û –ë–õ–û–ö–ê –í–´–ë–û–†–ê –ê–ö–°–ï–°–°–£–ê–†–û–í */}
                    {equipment.accessories && equipment.accessories.length > 0 && (
                        <div className="mt-3 border-t pt-3">
                            <button
                                className="w-full flex justify-between items-center text-sm font-medium text-gray-600 hover:text-sky-700 p-1 -m-1 rounded"
                                onClick={() => setShowAccessories(prev => !prev)}
                            >
                                <span className="flex items-center gap-2">
                                    <Paperclip className="w-4 h-4" />
                                    –î–æ–±–∞–≤–∏—Ç—å –∞–∫—Å–µ—Å—Å—É–∞—Ä—ã ({equipment.accessories.length})
                                </span>
                                <ChevronDown className={`w-5 h-5 transition-transform ${showAccessories ? 'rotate-180' : ''}`} />
                            </button>
                            {showAccessories && (
                                <div className="mt-2 space-y-2 pl-1 animate-in fade-in-0 slide-in-from-top-2 duration-300">
                                    {equipment.accessories.map(acc => (
                                        <div key={acc.id} className="flex items-center justify-between p-1 rounded hover:bg-gray-50">
                                            <Label htmlFor={`reserve-acc-${equipment.id}-${acc.id}`} className="flex items-center gap-2 text-xs font-normal cursor-pointer">
                                                <Checkbox
                                                    id={`reserve-acc-${equipment.id}-${acc.id}`}
                                                    checked={isAccessorySelected(equipment.id, acc.id)}
                                                    onCheckedChange={() => onToggleAccessory(equipment.id, acc.id)}
                                                />
                                                {acc.name}
                                            </Label>
                                            <span className="text-xs text-gray-500">{acc.price} ‚ÇΩ</span>
                                        </div>
                                    ))}
                                </div>
                            )}
                        </div>
                    )}
                    {/* ‚úÖ –ö–û–ù–ï–¶ –ë–õ–û–ö–ê –í–´–ë–û–†–ê –ê–ö–°–ï–°–°–£–ê–†–û–í */}
                </div>

                <button
                    onClick={() => onRemove(equipment.id)}
                    className={`rounded px-2 py-1 sm:px-3 text-xs sm:text-sm font-medium flex items-center gap-1 mt-1 self-start sm:self-center 
                        ${isExternalConflict
                        ? "bg-red-500 text-white hover:bg-red-600"
                        : "bg-slate-500 text-white hover:bg-slate-600"
                    }`}
                    title="–£–¥–∞–ª–∏—Ç—å –∏–∑ —Ä–µ–∑–µ—Ä–≤–∞"
                >
                    <Trash2 size={14} className="sm:size-4" />
                    –£–¥–∞–ª–∏—Ç—å
                </button>
            </CardContent>
        </Card>
    );
}

```


## <a name="rentalappmainsrccomponentsSearchInputtsx"></a>`rental-app-main/src/components/SearchInput.tsx`

```tsx
// path: rental-app-main/src/components/SearchInput.tsx

import { useSearchStore } from "../store/searchStore"
import { Input } from "@/components/ui/input"

export default function SearchInput() {
  const { query, setQuery } = useSearchStore()

  return (
    <Input
      type="text"
      placeholder="–ü–æ–∏—Å–∫ –ø–æ –Ω–∞–∑–≤–∞–Ω–∏—é..."
      value={query}
      onChange={(e) => setQuery(e.target.value)}
      className="w-full max-w-sm"
    />
  )
}


```


## <a name="rentalappmainsrccomponentsStatusBadgetsx"></a>`rental-app-main/src/components/StatusBadge.tsx`

```tsx
// path: rental-app-main/src/components/StatusBadge.tsx

export default function StatusBadge({ status }: { status: "active" | "past" }) {
    const isActive = status === "active"
    return (
        <span
            className={`text-xs font-medium px-2 py-1 rounded-full inline-block
        ${isActive
                ? "bg-green-100 text-green-700 border border-green-300"
                : "bg-gray-100 text-gray-500 border border-gray-300"
            }`}
        >
      {isActive ? "–ê–∫—Ç–∏–≤–µ–Ω" : "–ó–∞–≤–µ—Ä—à—ë–Ω"}
    </span>
    )
}


```


## <a name="rentalappmainsrccomponentsTypeFiltertsx"></a>`rental-app-main/src/components/TypeFilter.tsx`

```tsx
// path: rental-app-main/src/components/TypeFilter.tsx

// src/components/TypeFilter.tsx
import { ToggleGroup, ToggleGroupItem } from "@/components/ui/toggle-group"
import { useFilterStore } from "@/store/filterStore"
import { useMemo, type ReactNode } from "react"
import type { Equipment } from "@/types/equipment"
import { getFilterToggleClass } from "@/components/ui/filter-toggle"
import {
    Camera,
    Aperture,
    Lightbulb,
    Mic,
    Video,
    Grip,
    Headphones,
    Laptop,
    Package,
    List,
} from "lucide-react"

// –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è —Å–æ–ø–æ—Å—Ç–∞–≤–ª–µ–Ω–∏—è —Ç–∏–ø–∞ –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—è —Å –∏–∫–æ–Ω–∫–æ–π
const getIconForType = (type: string): ReactNode => {
    const iconMap: Record<string, ReactNode> = {
        "–§–æ—Ç–æ–∫–∞–º–µ—Ä–∞": <Camera />,
        "–û–±—ä–µ–∫—Ç–∏–≤": <Aperture />,
        "–°–≤–µ—Ç": <Lightbulb />,
        "–ú–∏–∫—Ä–æ—Ñ–æ–Ω": <Mic />,
        "–≠–∫—à–Ω –∫–∞–º–µ—Ä–∞": <Video />,
        "–®—Ç–∞—Ç–∏–≤—ã": <Grip />,
        "–ê—É–¥–∏–æ–æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏–µ": <Headphones />,
        "–ö–æ–º–ø—å—é—Ç–µ—Ä–Ω–∞—è —Ç–µ—Ö–Ω–∏–∫–∞": <Laptop />,
        "–ü—Ä–æ—á–µ–µ": <Package />,
    }
    // –í–æ–∑–≤—Ä–∞—â–∞–µ–º —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â—É—é –∏–∫–æ–Ω–∫—É –∏–ª–∏ null, –µ—Å–ª–∏ —Å–æ–≤–ø–∞–¥–µ–Ω–∏—è –Ω–µ –Ω–∞–π–¥–µ–Ω—ã
    return iconMap[type] || null
}

interface TypeFilterProps {
    items: Equipment[]
}

export default function TypeFilter({ items }: TypeFilterProps) {
    const { type, setType } = useFilterStore()

    const types = useMemo(() => {
        const uniqueTypes = new Set(items.map((eq) => eq.equipment_type))
        return Array.from(uniqueTypes)
    }, [items])

    return (
        <ToggleGroup
            type="single"
            value={type ?? "__all__"}
            onValueChange={(val: string) => setType(val === "__all__" ? null : val)}
            className="flex flex-wrap gap-2"
        >
            <ToggleGroupItem
                value="__all__"
                className={getFilterToggleClass()}
            >
                <List />
                –í—Å–µ
            </ToggleGroupItem>

            {types.map((t) => (
                <ToggleGroupItem
                    key={t}
                    value={t}
                    className={getFilterToggleClass()}
                >
                    {getIconForType(t)}
                    {t}
                </ToggleGroupItem>
            ))}
        </ToggleGroup>
    )
}

```


## <a name="rentalappmainsrccomponentsUserInfoBlocktsx"></a>`rental-app-main/src/components/UserInfoBlock.tsx`

```tsx
// path: rental-app-main/src/components/UserInfoBlock.tsx

// src/components/UserInfoBlock.tsx
import { Button } from "@/components/ui/button";
import { useNavigate, useLocation } from "react-router-dom";
import { useCurrentUser } from "@/hooks/useProfile";
import { useAuthStore } from "@/store/authStore";
import {
    Shield,
    Calendar,
    Edit,
    FileText,
    LogOut,
    Settings,
    HelpCircle,
    AlertTriangle,
    Send
} from "lucide-react";

type Props = {
    onEditProfile?: () => void;
    showExtraLinks?: boolean;
};

export default function UserInfoBlock({ onEditProfile, showExtraLinks = false }: Props) {
    const { data: user, isLoading, isError } = useCurrentUser();
    const { logout } = useAuthStore();
    const navigate = useNavigate();
    const location = useLocation();

    if (isLoading) {
        return (
            <div className="w-full">
                <div className="bg-gradient-to-r from-white to-gray-50 border border-gray-200 rounded-lg shadow-sm p-4">
                    <p className="text-center text-sm text-gray-500">–ó–∞–≥—Ä—É–∑–∫–∞...</p>
                </div>
            </div>
        );
    }

    if (isError || !user) {
        return (
            <div className="w-full">
                <div className="bg-gradient-to-r from-white to-gray-50 border border-gray-200 rounded-lg shadow-sm p-4">
                    <p className="text-center text-sm text-red-600">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ø—Ä–æ—Ñ–∏–ª—è</p>
                </div>
            </div>
        );
    }

    const isAdmin = user.role === "admin";
    const isManager = user.role === "manager" || isAdmin;

    const getRoleInfo = () => {
        if (isAdmin) return { label: "–ê–¥–º–∏–Ω", color: "text-red-600", icon: "üëë", bg: "bg-red-50" };
        if (isManager) return { label: "–ú–µ–Ω–µ–¥–∂–µ—Ä", color: "text-blue-600", icon: "üõ°Ô∏è", bg: "bg-blue-50" };
        return { label: "–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å", color: "text-gray-600", icon: "üë§", bg: "bg-gray-50" };
    };

    const roleInfo = getRoleInfo();

    // ‚úÖ –ò–ó–ú–ï–ù–ï–ù–ò–ï: –î–æ–±–∞–≤–ª—è–µ–º —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∏ –ø—Ä–æ–≤–µ—Ä–∫—É –±–∞–ª–∞–Ω—Å–∞
    const balance = user.balance ?? 0;
    const balanceColor = balance < 0 ? 'text-red-600' : 'text-green-700';

    return (
        <div className="w-full">
            <div className="bg-gradient-to-r from-white to-gray-50 border border-gray-200 rounded-lg shadow-sm">
                <div className="flex flex-col lg:flex-row items-stretch">
                    <div className="flex-1 p-3 lg:p-4">
                        <div className="flex items-center gap-3">
                            <div className={`w-12 h-12 ${roleInfo.bg} rounded-full flex items-center justify-center text-lg flex-shrink-0`}>
                                {roleInfo.icon}
                            </div>
                            <div className="flex-1 min-w-0">
                                <div className="flex flex-col lg:flex-row lg:items-start lg:gap-6">
                                    <div className="min-w-0">
                                        <div>
                                            <h3 className="font-semibold text-gray-900 text-sm truncate">
                                                {user.full_name}
                                            </h3>
                                            <p className="text-xs text-gray-600 truncate">{user.email}</p>
                                        </div>
                                    </div>
                                    <div className="flex items-center gap-4 mt-2 lg:mt-0">
                                        <div className="flex items-center gap-1">
                                            <Shield className="w-3 h-3 text-gray-400" />
                                            <span className={`text-xs font-medium ${roleInfo.color}`}>
                                                {roleInfo.label}
                                            </span>
                                        </div>
                                        <div className="flex items-center gap-1 text-xs text-gray-500">
                                            <span>–ë–∞–ª–∞–Ω—Å:</span>
                                            {/* ‚úÖ –ò–ó–ú–ï–ù–ï–ù–ò–ï: –ü—Ä–∏–º–µ–Ω—è–µ–º —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∏ —Ü–≤–µ—Ç */}
                                            <span className={`font-semibold ${balanceColor}`}>
                                                {balance.toLocaleString('ru-RU', { style: 'currency', currency: 'RUB' })}
                                            </span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    {showExtraLinks && (
                        <div className="p-3 lg:p-4 lg:border-l lg:border-r border-gray-200 lg:w-[260px] lg:flex-shrink-0">
                            <h4 className="text-xs text-gray-500 mb-2 font-semibold">–ü–æ–ª–µ–∑–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è:</h4>
                            <div className="space-y-1.5">
                                <a
                                    href="/how-it-works"
                                    onClick={(e) => {
                                        e.preventDefault();
                                        alert("–°—Ç—Ä–∞–Ω–∏—Ü–∞ '–ö–∞–∫ —Ä–∞–±–æ—Ç–∞–µ—Ç –ø—Ä–æ–∫–∞—Ç?' –µ—â–µ –Ω–µ —Å–æ–∑–¥–∞–Ω–∞.");
                                    }}
                                    className="flex items-center text-sm text-gray-700 hover:text-sky-600 hover:underline transition-colors duration-150"
                                >
                                    <HelpCircle className="w-4 h-4 mr-2 text-gray-400 flex-shrink-0" />
                                    –ö–∞–∫ —Ä–∞–±–æ—Ç–∞–µ—Ç –ø—Ä–æ–∫–∞—Ç?
                                </a>
                                <a
                                    href="/rules"
                                    onClick={(e) => {
                                        e.preventDefault();
                                        alert("–°—Ç—Ä–∞–Ω–∏—Ü–∞ '–ù–∞—à–∏ –ø—Ä–∞–≤–∏–ª–∞' –µ—â–µ –Ω–µ —Å–æ–∑–¥–∞–Ω–∞.");
                                    }}
                                    className="flex items-center text-sm text-gray-700 hover:text-sky-600 hover:underline transition-colors duration-150"
                                >
                                    <AlertTriangle className="w-4 h-4 mr-2 text-orange-400 flex-shrink-0" />
                                    –ù–∞—à–∏ –ø—Ä–∞–≤–∏–ª–∞
                                </a>
                                <button
                                    onClick={() => navigate("/contacts", { state: { from: location.pathname } })}
                                    className="flex items-center text-sm text-gray-700 hover:text-sky-600 hover:underline w-full text-left transition-colors duration-150"
                                >
                                    <Send className="w-4 h-4 mr-2 text-blue-400 flex-shrink-0" />
                                    –°–≤—è–∑–∞—Ç—å—Å—è —Å –Ω–∞–º–∏
                                </button>
                            </div>
                        </div>
                    )}

                    <div className="border-t lg:border-t-0 lg:border-l bg-gray-50 lg:bg-transparent p-3 lg:p-4 lg:w-[300px] lg:ml-auto lg:flex-shrink-0">
                        <div className="flex gap-2 w-full">
                            <div className="flex flex-col gap-2 flex-1">
                                <Button
                                    variant="default"
                                    onClick={() =>
                                        navigate("/reservations/my", { state: { from: location.pathname } })
                                    }
                                    className="h-8 px-3 text-xs flex items-center justify-center gap-1.5 w-full"
                                    size="sm"
                                >
                                    <FileText className="w-3 h-3" />
                                    –ú–æ–∏ –∑–∞–∫–∞–∑—ã
                                </Button>
                                <Button
                                    onClick={() => navigate("/calendar", { state: { from: location.pathname } })}
                                    className="h-8 px-3 text-xs flex items-center justify-center gap-1.5 bg-amber-500 hover:bg-amber-600 text-white w-full"
                                    size="sm"
                                >
                                    <Calendar className="w-3 h-3" />
                                    –ö–∞–ª–µ–Ω–¥–∞—Ä—å
                                </Button>
                                {isManager && (
                                    <Button
                                        variant="secondary"
                                        onClick={() => navigate("/admin")}
                                        className="h-8 px-3 text-xs flex items-center justify-center gap-1.5 bg-gray-800 hover:bg-gray-700 text-white w-full"
                                        size="sm"
                                    >
                                        <Settings className="w-3 h-3" />
                                        {isAdmin ? "–ê–¥–º–∏–Ω –ø–∞–Ω–µ–ª—å" : "–ü–∞–Ω–µ–ª—å –º–µ–Ω–µ–¥–∂–µ—Ä–∞"}
                                    </Button>
                                )}
                            </div>
                            <div className="flex flex-col gap-2">
                                <Button
                                    variant="outline"
                                    onClick={
                                        onEditProfile
                                            ? onEditProfile
                                            : () => navigate("/profile", { state: { from: location.pathname } })
                                    }
                                    className="h-8 px-3 text-xs flex items-center justify-center gap-1.5"
                                    size="sm"
                                >
                                    <Edit className="w-3 h-3" />
                                    –ü—Ä–æ—Ñ–∏–ª—å
                                </Button>
                                <Button
                                    variant="destructive"
                                    onClick={logout}
                                    className="h-8 px-3 text-xs flex items-center justify-center gap-1.5"
                                    size="sm"
                                >
                                    <LogOut className="w-3 h-3" />
                                    –í—ã–π—Ç–∏
                                </Button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    );
}

```


## <a name="rentalappmainsrccomponentsViewModeToggletsx"></a>`rental-app-main/src/components/ViewModeToggle.tsx`

```tsx
// path: rental-app-main/src/components/ViewModeToggle.tsx

// src/components/ViewModeToggle.tsx

import { ToggleGroup, ToggleGroupItem } from "@/components/ui/toggle-group";
import { LayoutGrid, List } from "lucide-react";
// –ò–º–ø–æ—Ä—Ç–∏—Ä—É–µ–º –æ–±–Ω–æ–≤–ª–µ–Ω–Ω—ã–π —Å—Ç–æ—Ä
import { useViewModeStore, type ViewMode } from "@/store/viewModeStore";

export default function ViewModeToggle() {
  // –ò—Å–ø–æ–ª—å–∑—É–µ–º –Ω–æ–≤—ã–µ –º–µ—Ç–æ–¥—ã –∏–∑ —Å—Ç–æ—Ä–∞
  const { viewMode, setViewMode } = useViewModeStore();

  return (
      <ToggleGroup
          type="single"
          value={viewMode}
          onValueChange={(value: ViewMode) => {
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –∑–Ω–∞—á–µ–Ω–∏–µ –Ω–µ –ø—É—Å—Ç–æ–µ, –ø—Ä–µ–∂–¥–µ —á–µ–º –æ–±–Ω–æ–≤–ª—è—Ç—å —Å—Ç–æ—Ä
            if (value) setViewMode(value);
          }}
          className="flex items-center"
          aria-label="–ü–µ—Ä–µ–∫–ª—é—á–∞—Ç–µ–ª—å –≤–∏–¥–∞ –∫–∞—Ä—Ç–æ—á–µ–∫"
      >
        <ToggleGroupItem value="default" aria-label="–°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π –≤–∏–¥" className="p-2 h-9 w-9">
          <LayoutGrid className="h-4 w-4" />
        </ToggleGroupItem>
        <ToggleGroupItem value="compact" aria-label="–ö–æ–º–ø–∞–∫—Ç–Ω—ã–π –≤–∏–¥" className="p-2 h-9 w-9">
          <List className="h-4 w-4" />
        </ToggleGroupItem>
      </ToggleGroup>
  );
}

```


## <a name="rentalappmainsrccomponentsadminAccessoryDialogstsx"></a>`rental-app-main/src/components/admin/AccessoryDialogs.tsx`

```tsx
// path: rental-app-main/src/components/admin/AccessoryDialogs.tsx

// src/components/admin/AccessoryDialogs.tsx
import { useForm } from "react-hook-form";
import { zodResolver } from "@hookform/resolvers/zod";
import { useEffect } from "react";
import { accessorySchema, AccessorySchema } from "@/lib/validationSchemas";
import { useCreateAccessory, useUpdateAccessory, useAccessory } from "@/hooks/useAdminAccessories";
import type { Accessory } from "@/types/accessory";

import { Button } from "@/components/ui/button";
import { Input } from "@/components/ui/input";
import { Label } from "@/components/ui/label";
import { Textarea } from "@/components/ui/textarea";
import {
    Dialog,
    DialogContent,
    DialogHeader,
    DialogTitle,
    DialogFooter,
    DialogDescription,
} from "@/components/ui/dialog";

// --- –î–∏–∞–ª–æ–≥ —Å–æ–∑–¥–∞–Ω–∏—è ---
interface CreateProps {
    open: boolean;
    onClose: () => void;
}
export function AccessoryCreateDialog({ open, onClose }: CreateProps) {
    const createMutation = useCreateAccessory();
    const { register, handleSubmit, formState: { errors, isValid }, reset } = useForm<AccessorySchema>({
        resolver: zodResolver(accessorySchema) as any,
        mode: "onChange",
    });

    const onSubmit = (data: AccessorySchema) => {
        createMutation.mutate(data, {
            onSuccess: () => {
                reset();
                onClose();
            },
        });
    };

    return (
        <Dialog open={open} onOpenChange={onClose}>
            <DialogContent>
                <DialogHeader>
                    <DialogTitle>–ù–æ–≤—ã–π –∞–∫—Å–µ—Å—Å—É–∞—Ä</DialogTitle>
                    <DialogDescription>–°–æ–∑–¥–∞–π—Ç–µ –Ω–æ–≤—É—é –∑–∞–ø–∏—Å—å –≤ –∫–∞—Ç–∞–ª–æ–≥–µ –∞–∫—Å–µ—Å—Å—É–∞—Ä–æ–≤.</DialogDescription>
                </DialogHeader>
                <form onSubmit={handleSubmit(onSubmit)} className="space-y-4 py-2">
                    {/* ... –ø–æ–ª—è —Ñ–æ—Ä–º—ã ... */}
                    <div>
                        <Label htmlFor="name">–ù–∞–∑–≤–∞–Ω–∏–µ *</Label>
                        <Input id="name" {...register("name")} placeholder="–ê–∫–∫—É–º—É–ª—è—Ç–æ—Ä LP-E6" />
                        {errors.name && <p className="text-xs text-red-600 mt-1">{errors.name.message}</p>}
                    </div>
                    <div className="grid grid-cols-2 gap-4">
                        <div>
                            <Label htmlFor="accessory_type">–¢–∏–ø</Label>
                            <Input id="accessory_type" {...register("accessory_type")} placeholder="–ü–∏—Ç–∞–Ω–∏–µ"/>
                        </div>
                        <div>
                            <Label htmlFor="price">–¶–µ–Ω–∞ (‚ÇΩ/–¥–µ–Ω—å)</Label>
                            <Input id="price" type="number" step="0.01" {...register("price")} placeholder="100"/>
                            {errors.price && <p className="text-xs text-red-600 mt-1">{errors.price.message}</p>}
                        </div>
                    </div>
                    <div>
                        <Label htmlFor="description">–û–ø–∏—Å–∞–Ω–∏–µ</Label>
                        <Textarea id="description" {...register("description")} placeholder="–î–ª—è –∫–∞–º–µ—Ä Canon R, R5, R6..." />
                    </div>
                    <DialogFooter>
                        <Button type="button" variant="ghost" onClick={onClose}>–û—Ç–º–µ–Ω–∞</Button>
                        <Button type="submit" disabled={!isValid || createMutation.isPending}>
                            {createMutation.isPending ? "–°–æ–∑–¥–∞–Ω–∏–µ..." : "–°–æ–∑–¥–∞—Ç—å"}
                        </Button>
                    </DialogFooter>
                </form>
            </DialogContent>
        </Dialog>
    );
}

// --- –î–∏–∞–ª–æ–≥ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è ---
interface EditProps {
    accessory: Accessory | null;
    open: boolean;
    onClose: () => void;
}
export function AccessoryEditDialog({ accessory, open, onClose }: EditProps) {
    const updateMutation = useUpdateAccessory();
    const { data: accessoryData, isLoading } = useAccessory(accessory?.id || null);
    
    const { register, handleSubmit, formState: { errors, isValid }, reset } = useForm<AccessorySchema>({
        resolver: zodResolver(accessorySchema) as any,
        mode: "onChange",
        defaultValues: {
            name: "",
            accessory_type: "",
            price: 0,
            description: "",
        },
    });

    // –û–±–Ω–æ–≤–ª—è–µ–º —Ñ–æ—Ä–º—É –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –¥–∞–Ω–Ω—ã—Ö –∞–∫—Å–µ—Å—Å—É–∞—Ä–∞
    useEffect(() => {
        if (accessoryData) {
            reset({
                name: accessoryData.name || "",
                accessory_type: accessoryData.accessory_type || "",
                price: accessoryData.price || 0,
                description: accessoryData.description || "",
            });
        }
    }, [accessoryData, reset]);

    const onSubmit = (data: AccessorySchema) => {
        if (!accessoryData) return;
        updateMutation.mutate({ id: accessoryData.id, data }, {
            onSuccess: () => {
                onClose();
            },
        });
    };

    if (!accessory) return null;
    
    if (isLoading) {
        return (
            <Dialog open={open} onOpenChange={onClose}>
                <DialogContent>
                    <DialogHeader>
                        <DialogTitle>–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –∞–∫—Å–µ—Å—Å—É–∞—Ä</DialogTitle>
                    </DialogHeader>
                    <div className="flex items-center justify-center py-8">
                        <p>–ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö –∞–∫—Å–µ—Å—Å—É–∞—Ä–∞...</p>
                    </div>
                </DialogContent>
            </Dialog>
        );
    }

    return (
        <Dialog open={open} onOpenChange={onClose}>
            <DialogContent>
                <DialogHeader>
                    <DialogTitle>–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –∞–∫—Å–µ—Å—Å—É–∞—Ä</DialogTitle>
                    <DialogDescription>"{accessoryData?.name || accessory.name}"</DialogDescription>
                </DialogHeader>
                <form onSubmit={handleSubmit(onSubmit)} className="space-y-4 py-2">
                    {/* ... –ø–æ–ª—è —Ñ–æ—Ä–º—ã ... */}
                    <div>
                        <Label htmlFor="edit-name">–ù–∞–∑–≤–∞–Ω–∏–µ *</Label>
                        <Input id="edit-name" {...register("name")} />
                        {errors.name && <p className="text-xs text-red-600 mt-1">{errors.name.message}</p>}
                    </div>
                    <div className="grid grid-cols-2 gap-4">
                        <div>
                            <Label htmlFor="edit-accessory_type">–¢–∏–ø</Label>
                            <Input id="edit-accessory_type" {...register("accessory_type")} />
                        </div>
                        <div>
                            <Label htmlFor="edit-price">–¶–µ–Ω–∞ (‚ÇΩ/–¥–µ–Ω—å)</Label>
                            <Input id="edit-price" type="number" step="0.01" {...register("price")} />
                            {errors.price && <p className="text-xs text-red-600 mt-1">{errors.price.message}</p>}
                        </div>
                    </div>
                    <div>
                        <Label htmlFor="edit-description">–û–ø–∏—Å–∞–Ω–∏–µ</Label>
                        <Textarea id="edit-description" {...register("description")} />
                    </div>
                    <DialogFooter>
                        <Button type="button" variant="ghost" onClick={onClose}>–û—Ç–º–µ–Ω–∞</Button>
                        <Button type="submit" disabled={!isValid || updateMutation.isPending}>
                            {updateMutation.isPending ? "–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ..." : "–°–æ—Ö—Ä–∞–Ω–∏—Ç—å"}
                        </Button>
                    </DialogFooter>
                </form>
            </DialogContent>
        </Dialog>
    );
}

```


## <a name="rentalappmainsrccomponentsadminAccessoryTabletsx"></a>`rental-app-main/src/components/admin/AccessoryTable.tsx`

```tsx
// path: rental-app-main/src/components/admin/AccessoryTable.tsx

// src/components/admin/AccessoryTable.tsx

import { useState } from "react";
import { useAccessories, useDeleteAccessory } from "@/hooks/useAdminAccessories";
import type { Accessory } from "@/types/accessory";
import { AccessoryCreateDialog, AccessoryEditDialog } from "./AccessoryDialogs";

import { Button } from "@/components/ui/button";
import { Input } from "@/components/ui/input";
import {
    Table,
    TableBody,
    TableCell,
    TableHead,
    TableHeader,
    TableRow,
} from "@/components/ui/table";
import { Plus, Edit, Trash2, Search, Wrench, ChevronLeft, ChevronRight } from "lucide-react";

const PAGE_SIZE = 15;

export default function AccessoryTable() {
    // +++ –ù–ê–ß–ê–õ–û –ò–ó–ú–ï–ù–ï–ù–ò–ô +++
    const [currentPage, setCurrentPage] = useState(1);
    const { data: accessoriesResponse, isLoading, error } = useAccessories(currentPage, PAGE_SIZE);
    const deleteMutation = useDeleteAccessory();

    const accessories = accessoriesResponse?.items ?? [];
    const totalAccessories = accessoriesResponse?.total ?? 0;
    const totalPages = Math.ceil(totalAccessories / PAGE_SIZE);
    // +++ –ö–û–ù–ï–¶ –ò–ó–ú–ï–ù–ï–ù–ò–ô +++

    const [search, setSearch] = useState("");
    const [isCreateOpen, setCreateOpen] = useState(false);
    const [editingAccessory, setEditingAccessory] = useState<Accessory | null>(null);

    const filteredAccessories = accessories.filter(acc =>
        acc.name.toLowerCase().includes(search.toLowerCase()) ||
        (acc.accessory_type && acc.accessory_type.toLowerCase().includes(search.toLowerCase()))
    );

    const handleDelete = (id: number) => {
        if (window.confirm("–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å —ç—Ç–æ—Ç –∞–∫—Å–µ—Å—Å—É–∞—Ä?")) {
            deleteMutation.mutate(id);
        }
    };

    if (isLoading) return <p>–ó–∞–≥—Ä—É–∑–∫–∞ –∞–∫—Å–µ—Å—Å—É–∞—Ä–æ–≤...</p>;
    if (error) return <p className="text-red-600">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö.</p>;

    return (
        <>
            <div className="flex items-center justify-between gap-4 mb-4">
                <div className="relative w-full max-w-sm">
                    <Search className="absolute left-3 top-2.5 h-4 w-4 text-muted-foreground" />
                    <Input
                        placeholder="–ü–æ–∏—Å–∫ –ø–æ –Ω–∞–∑–≤–∞–Ω–∏—é –∏–ª–∏ —Ç–∏–ø—É..."
                        value={search}
                        onChange={(e) => setSearch(e.target.value)}
                        className="pl-10"
                    />
                </div>
                <Button onClick={() => setCreateOpen(true)}>
                    <Plus className="mr-2 h-4 w-4" /> –î–æ–±–∞–≤–∏—Ç—å –∞–∫—Å–µ—Å—Å—É–∞—Ä
                </Button>
            </div>
            {filteredAccessories.length > 0 ? (
                <>
                    <div className="border rounded-md">
                        <Table>
                            <TableHeader>
                                <TableRow>
                                    <TableHead className="w-[100px]">ID</TableHead>
                                    <TableHead>–ù–∞–∑–≤–∞–Ω–∏–µ</TableHead>
                                    <TableHead>–¢–∏–ø</TableHead>
                                    <TableHead>–¶–µ–Ω–∞</TableHead>
                                    <TableHead className="text-right">–î–µ–π—Å—Ç–≤–∏—è</TableHead>
                                </TableRow>
                            </TableHeader>
                            <TableBody>
                                {filteredAccessories.map((acc) => (
                                    <TableRow key={acc.id}>
                                        <TableCell>{acc.id}</TableCell>
                                        <TableCell className="font-medium">{acc.name}</TableCell>
                                        <TableCell>{acc.accessory_type}</TableCell>
                                        <TableCell>{acc.price} ‚ÇΩ</TableCell>
                                        <TableCell className="text-right">
                                            <Button variant="ghost" size="icon" onClick={() => setEditingAccessory(acc)}>
                                                <Edit className="h-4 w-4" />
                                            </Button>
                                            <Button variant="ghost" size="icon" onClick={() => handleDelete(acc.id)} disabled={deleteMutation.isPending}>
                                                <Trash2 className="h-4 w-4 text-red-500" />
                                            </Button>
                                        </TableCell>
                                    </TableRow>
                                ))}
                            </TableBody>
                        </Table>
                    </div>
                    {/* +++ –ù–ê–ß–ê–õ–û: –ö–Ω–æ–ø–∫–∏ –ø–∞–≥–∏–Ω–∞—Ü–∏–∏ +++ */}
                    <div className="flex items-center justify-end space-x-2 py-4">
                        <span className="text-sm text-muted-foreground">
                            –°—Ç—Ä–∞–Ω–∏—Ü–∞ {currentPage} –∏–∑ {totalPages}
                        </span>
                        <Button
                            variant="outline"
                            size="sm"
                            onClick={() => setCurrentPage(prev => Math.max(prev - 1, 1))}
                            disabled={currentPage === 1}
                        >
                            <ChevronLeft className="h-4 w-4" />
                            –ù–∞–∑–∞–¥
                        </Button>
                        <Button
                            variant="outline"
                            size="sm"
                            onClick={() => setCurrentPage(prev => Math.min(prev + 1, totalPages))}
                            disabled={currentPage === totalPages}
                        >
                            –í–ø–µ—Ä–µ–¥
                            <ChevronRight className="h-4 w-4" />
                        </Button>
                    </div>
                    {/* +++ –ö–û–ù–ï–¶: –ö–Ω–æ–ø–∫–∏ –ø–∞–≥–∏–Ω–∞—Ü–∏–∏ +++ */}
                </>
            ) : (
                <div className="text-center py-12 px-4 border rounded-md">
                    <Wrench className="w-16 h-16 text-gray-300 mx-auto mb-3" />
                    <h3 className="text-lg font-semibold text-gray-700">–ê–∫—Å–µ—Å—Å—É–∞—Ä—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã</h3>
                    <p className="text-sm text-gray-500 mt-1">{search ? "–ü–æ–ø—Ä–æ–±—É–π—Ç–µ –∏–∑–º–µ–Ω–∏—Ç—å –ø–æ–∏—Å–∫–æ–≤—ã–π –∑–∞–ø—Ä–æ—Å." : "–î–æ–±–∞–≤—å—Ç–µ –ø–µ—Ä–≤—ã–π –∞–∫—Å–µ—Å—Å—É–∞—Ä, —á—Ç–æ–±—ã –æ–Ω –ø–æ—è–≤–∏–ª—Å—è –≤ —Å–ø–∏—Å–∫–µ."}</p>
                </div>
            )}

            <AccessoryCreateDialog open={isCreateOpen} onClose={() => setCreateOpen(false)} />
            <AccessoryEditDialog accessory={editingAccessory} open={!!editingAccessory} onClose={() => setEditingAccessory(null)} />
        </>
    );
}

```


## <a name="rentalappmainsrccomponentsadminAdminNavigationtsx"></a>`rental-app-main/src/components/admin/AdminNavigation.tsx`

```tsx
// path: rental-app-main/src/components/admin/AdminNavigation.tsx

// src/components/admin/AdminNavigation.tsx

import { useCurrentUser } from "@/hooks/useProfile";
import { Button } from "@/components/ui/button";
import { useNavigate, useLocation } from "react-router-dom";
import { Users, Package, Shield, Home, Paperclip, ClipboardList, TicketPercent, CalendarDays, Tags, Truck } from "lucide-react"; // <-- –î–æ–±–∞–≤–ª–µ–Ω–∞ –∏–∫–æ–Ω–∫–∞ Truck

export default function AdminNavigation() {
    const { data: user } = useCurrentUser();
    const navigate = useNavigate();
    const location = useLocation();

    const isAdmin = user?.role === "admin";
    const isManager = user?.role === "manager" || isAdmin;

    if (!isManager) return null;

    const navigationItems = [
        {
            path: "/admin",
            label: "–û–±–∑–æ—Ä",
            icon: <Shield className="w-4 h-4" />,
            accessible: isManager
        },
        {
            path: "/admin/reservations",
            label: "–í—Å–µ —Ä–µ–∑–µ—Ä–≤—ã",
            icon: <ClipboardList className="w-4 h-4" />,
            accessible: isManager
        },
        // +++ –ù–û–í–´–ô –ü–£–ù–ö–¢ –ú–ï–ù–Æ +++
        {
            path: "/admin/rentals",
            label: "–ê—Ä–µ–Ω–¥—ã",
            icon: <Truck className="w-4 h-4" />,
            accessible: isManager
        },
        // ++++++++++++++++++++++++
        {
            path: "/admin/users",
            label: "–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏",
            icon: <Users className="w-4 h-4" />,
            accessible: isManager,
        },
        {
            path: "/admin/equipment",
            label: "–û–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏–µ",
            icon: <Package className="w-4 h-4" />,
            accessible: isManager
        },
        {
            path: "/admin/accessories",
            label: "–ê–∫—Å–µ—Å—Å—É–∞—Ä—ã",
            icon: <Paperclip className="w-4 h-4" />,
            accessible: isManager
        },
        {
            path: "/admin/associations",
            label: "–ê—Å—Å–æ—Ü–∏–∞—Ü–∏–∏",
            icon: <Tags className="w-4 h-4" />,
            accessible: isManager
        },
        {
            path: "/admin/promocodes",
            label: "–ü—Ä–æ–º–æ–∫–æ–¥—ã –∏ –°–∫–∏–¥–∫–∏",
            icon: <TicketPercent className="w-4 h-4" />,
            accessible: isManager
        },
        {
            path: "/admin/holidays",
            label: "–í—ã—Ö–æ–¥–Ω—ã–µ –¥–Ω–∏",
            icon: <CalendarDays className="w-4 h-4" />,
            accessible: isAdmin
        }
    ];

    const isActive = (path: string) => {
        if (path === "/admin") {
            return location.pathname === "/admin";
        }
        return location.pathname.startsWith(path);
    };

    return (
        <div className="bg-white border rounded-lg shadow-sm p-4 mb-6">
            <div className="flex items-center justify-between mb-4">
                <h2 className="text-lg font-semibold text-gray-900">
                    –ü–∞–Ω–µ–ª—å —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è
                </h2>
                <Button
                    variant="outline"
                    size="sm"
                    onClick={() => navigate("/")}
                >
                    <Home className="w-4 h-4 mr-2" />
                    –ù–∞ –≥–ª–∞–≤–Ω—É—é
                </Button>
            </div>

            <div className="flex items-center text-sm text-gray-600 mb-4">
                <span>–†–æ–ª—å: </span>
                <span className={`ml-1 font-medium ${
                    isAdmin ? "text-red-600" : "text-blue-600"
                }`}>
                    {user?.role === "admin" ? "–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä" : "–ú–µ–Ω–µ–¥–∂–µ—Ä"}
                </span>
            </div>

            <div className="flex flex-wrap gap-2">
                {navigationItems
                    .filter(item => item.accessible)
                    .map((item) => (
                        <Button
                            key={item.path}
                            variant={isActive(item.path) ? "default" : "outline"}
                            size="sm"
                            onClick={() => navigate(item.path)}
                            className="flex items-center gap-2"
                        >
                            {item.icon}
                            <span>{item.label}</span>
                        </Button>
                    ))
                }
            </div>
        </div>
    );
}

```


## <a name="rentalappmainsrccomponentsadminAdminRentalCardtsx"></a>`rental-app-main/src/components/admin/AdminRentalCard.tsx`

```tsx
// path: rental-app-main/src/components/admin/AdminRentalCard.tsx

// src/components/admin/AdminRentalCard.tsx

import { useState, useMemo, useRef, useEffect } from "react";
import { useNavigate, useLocation } from "react-router-dom";
import { Card, CardContent } from "@/components/ui/card";
import { Button } from "@/components/ui/button";
// ‚úÖ –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï 1: –£–±–∏—Ä–∞–µ–º –Ω–µ–∏—Å–ø–æ–ª—å–∑—É–µ–º—ã–µ –∏–∫–æ–Ω–∫–∏ Wallet, Landmark, Paperclip
import { Calendar, Edit, Package, Trash2, User, Truck, RotateCcw, List, ChevronDown, Link as LinkIcon, ReceiptText } from "lucide-react";
import { formatDateEuropean, cn } from "@/lib/utils";
import RentalStatusBadge from "./RentalStatusBadge";
import type { AdminRentalOut } from "@/types/rental";
import { useCurrentUser } from "@/hooks/useProfile";
import { useDeleteAdminRental, useRevertRentalToReservation } from "@/hooks/useAdminRentals";
import { ConfirmationDialog } from "@/components/ui/confirmation-dialog";
import type { Equipment } from "@/types/equipment";
import EditableRentalCard from "./EditableRentalCard";
import EquipmentWithAccessoriesList from "@/components/shared/EquipmentWithAccessoriesList";
import { RENTAL_CARD_STYLES } from "@/constants/statusStyles";

interface Props {
    rental: AdminRentalOut;
    onReturn: (rental: AdminRentalOut) => void;
    highlightId?: number;
}

const isToday = (dateString: string): boolean => {
    const date = new Date(dateString);
    const today = new Date();
    return date.getFullYear() === today.getFullYear() &&
        date.getMonth() === today.getMonth() &&
        date.getDate() === today.getDate();
};

export default function AdminRentalCard({ rental, onReturn, highlightId }: Props) {
    const { data: currentUser } = useCurrentUser();
    const deleteMutation = useDeleteAdminRental();
    const revertMutation = useRevertRentalToReservation();
    const [isConfirmingRevert, setConfirmingRevert] = useState(false);
    const [isExpanded, setIsExpanded] = useState(true);
    const [isEditing, setIsEditing] = useState(false);
    const navigate = useNavigate();
    const location = useLocation();
    const cardRef = useRef<HTMLDivElement>(null);

    const isHighlighted = highlightId === rental.id;

    const isAdmin = currentUser?.role === 'admin';
    const canRevert = rental.reservation_id && rental.status !== 'completed' && isToday(rental.created_at);

    const handleDelete = () => {
        if (window.confirm(`–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ –±–µ–∑–≤–æ–∑–≤—Ä–∞—Ç–Ω–æ —É–¥–∞–ª–∏—Ç—å –∞—Ä–µ–Ω–¥—É #${rental.id}? –≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ –Ω–µ–ª—å–∑—è –æ—Ç–º–µ–Ω–∏—Ç—å.`)) {
            deleteMutation.mutate(rental.id);
        }
    };

    const handleRevert = () => {
        revertMutation.mutate(rental.id, {
            onSuccess: () => setConfirmingRevert(false),
            onError: () => setConfirmingRevert(false),
        });
    };


    const handleNavigateToReservation = (reservationId: number) => {
        navigate('/admin/reservations', {
            state: {
                highlightId: reservationId,
                statusFilterOverride: 'all'
            }
        });
    };

    useEffect(() => {
        if (isHighlighted && cardRef.current) {
            cardRef.current.scrollIntoView({
                behavior: "smooth",
                block: "center",
            });
        }
    }, [isHighlighted]);

    if (isEditing) {
        return <EditableRentalCard rental={rental} onCancel={() => setIsEditing(false)} />;
    }

    const statusClass = RENTAL_CARD_STYLES[rental.status] || RENTAL_CARD_STYLES.default;
    
    const highlightClass = isHighlighted
        ? "ring-2 ring-offset-2 ring-amber-500 border-amber-400 bg-amber-50"
        : "";

    return (
        <>
            <div ref={cardRef} className={`relative w-full rounded-lg border transition-all hover:shadow-md ${highlightClass}`}>
                <Card className={cn("w-full", statusClass)}>
                    <CardContent className="p-4">
                        <div className="flex flex-col md:flex-row gap-4 justify-between">
                            {/* –ë–ª–æ–∫ —Å –æ—Å–Ω–æ–≤–Ω–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–µ–π */}
                            <div className="flex-1 space-y-2.5">
                                <div className="flex items-center gap-4">
                                    <h3 className="font-bold text-lg text-orange-700 flex items-center gap-2">
                                        <Truck className="w-5 h-5"/> –ê—Ä–µ–Ω–¥–∞ #{rental.id}
                                    </h3>
                                    <RentalStatusBadge status={rental.status} />
                                </div>
                                <div className="text-sm text-gray-700 space-y-1.5 pl-1">
                                    <div className="flex items-center gap-2">
                                        <User className="w-4 h-4 text-gray-500" />
                                        <span>{rental.user.full_name} ({rental.user.email})</span>
                                    </div>
                                    <div className="flex items-center gap-2">
                                        <span className="text-gray-600">–ë–∞–ª–∞–Ω—Å:</span>
                                        <span className={`font-medium ${(rental.user.balance ?? 0) < 0 ? 'text-red-600' : 'text-green-700'}`}>
                                            {(rental.user.balance ?? 0).toLocaleString('ru-RU')} ‚ÇΩ
                                        </span>
                                    </div>
                                    {rental.reservation_id && (
                                        <div className="flex items-center gap-2">
                                            <LinkIcon className="w-4 h-4 text-gray-500" />
                                            <button
                                                onClick={() => handleNavigateToReservation(rental.reservation_id!)}
                                                className="text-sky-600 hover:underline hover:text-sky-700 transition-colors"
                                            >
                                                –ò–∑ —Ä–µ–∑–µ—Ä–≤–∞ #{rental.reservation_id}
                                            </button>
                                        </div>
                                    )}
                                    <div className="flex items-center gap-2">
                                        <Calendar className="w-4 h-4 text-gray-500" />
                                        <span>{formatDateEuropean(rental.start_date)} ‚Äî {formatDateEuropean(rental.end_date)}</span>
                                    </div>
                                    <div className="flex items-start gap-2">
                                        <Package className="w-4 h-4 text-gray-500 mt-0.5 flex-shrink-0" />
                                        <div className="flex-1">
                                            <button
                                                onClick={() => setIsExpanded(!isExpanded)}
                                                className="flex items-center text-left w-full hover:text-sky-700 transition-colors disabled:hover:text-current disabled:cursor-not-allowed"
                                            >
                                                <span>–ü–æ–∑–∏—Ü–∏–π –≤ –∞—Ä–µ–Ω–¥–µ: {rental.equipment.length + (rental.accessory_links?.length ?? 0)}</span>
                                                <ChevronDown className={`w-4 h-4 ml-1 transition-transform ${isExpanded ? 'rotate-180' : ''}`} />
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            {/* –§–∏–Ω–∞–Ω—Å–æ–≤—ã–π –±–ª–æ–∫ */}
                            <div className="flex-shrink-0 md:w-64 bg-slate-50 p-3 rounded-lg border space-y-2">
                                <h4 className="font-semibold text-sm text-slate-800 flex items-center gap-2"><ReceiptText className="w-4 h-4"/>–§–∏–Ω–∞–Ω—Å—ã</h4>
                                <div className="text-xs space-y-1.5 text-slate-700">
                                    <div className="flex justify-between"><span>–û–±—â–∞—è —Å—Ç–æ–∏–º–æ—Å—Ç—å:</span> <span className="font-medium">{rental.total_cost.toLocaleString('ru-RU')} ‚ÇΩ</span></div>
                                    {rental.accessories_cost > 0 && (
                                        <div className="flex justify-between"><span>–í —Ç.—á. –∞–∫—Å–µ—Å—Å—É–∞—Ä—ã:</span> <span className="font-medium">{rental.accessories_cost.toLocaleString('ru-RU')} ‚ÇΩ</span></div>
                                    )}
                                    {rental.discount_amount > 0 && (
                                        <div className="flex justify-between"><span>–°–∫–∏–¥–∫–∞:</span> <span className="font-medium text-green-600">-{rental.discount_amount.toLocaleString('ru-RU')} ‚ÇΩ</span></div>
                                    )}
                                    {rental.prepayment_amount > 0 && (
                                        <div className="flex justify-between"><span>–ü—Ä–µ–¥–æ–ø–ª–∞—Ç–∞:</span> <span className="font-medium text-blue-600">{rental.prepayment_amount.toLocaleString('ru-RU')} ‚ÇΩ</span></div>
                                    )}
                                    <div className="flex justify-between pt-1 border-t">
                                        <span className="font-semibold text-base">–û—Å—Ç–∞—Ç–æ–∫ –∫ –æ–ø–ª–∞—Ç–µ:</span>
                                        <span className="font-bold text-base">{rental.remaining_amount.toLocaleString('ru-RU')} ‚ÇΩ</span>
                                    </div>
                                    {rental.status === 'completed' && rental.final_cost !== null && (
                                        <div className="flex justify-between pt-1 border-t border-dashed">
                                            <span className="font-semibold">–ò—Ç–æ–≥–æ–≤–∞—è —Å—Ç–æ–∏–º–æ—Å—Ç—å:</span>
                                            <span className="font-bold">{rental.final_cost.toLocaleString('ru-RU')} ‚ÇΩ</span>
                                        </div>
                                    )}
                                    <div className="flex justify-between pt-2 border-t text-slate-500">
                                        <span>–í–Ω–µ—Å–µ–Ω–Ω—ã–π –∑–∞–ª–æ–≥:</span>
                                        <span className="font-medium">{rental.deposit_amount.toLocaleString('ru-RU')} ‚ÇΩ</span>
                                    </div>
                                </div>
                            </div>

                            {/* –ë–ª–æ–∫ —Å –∫–Ω–æ–ø–∫–∞–º–∏ –¥–µ–π—Å—Ç–≤–∏–π */}
                            <div className="flex md:flex-col items-center md:items-end justify-between md:justify-start gap-2 border-t md:border-t-0 md:border-l pt-3 md:pt-0 md:pl-4">
                                <div className="flex flex-col gap-2">
                                    {canRevert && (
                                        <Button size="sm" variant="outline" onClick={() => setConfirmingRevert(true)} className="text-amber-700 border-amber-300 hover:bg-amber-50 hover:text-amber-800">
                                            <RotateCcw className="mr-2 h-4 w-4" />
                                            –û—Ç–º–µ–Ω–∏—Ç—å –≤—ã–¥–∞—á—É
                                        </Button>
                                    )}
                                    <Button size="sm" variant="outline" onClick={() => setIsEditing(true)}>
                                        <Edit className="mr-2 h-4 w-4" />
                                        –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å
                                    </Button>
                                    {rental.status !== 'completed' && (
                                        <Button size="sm" variant="default" onClick={() => onReturn(rental)}>
                                            <RotateCcw className="mr-2 h-4 w-4" />
                                            –û—Ñ–æ—Ä–º–∏—Ç—å –≤–æ–∑–≤—Ä–∞—Ç
                                        </Button>
                                    )}
                                </div>
                                {isAdmin && (
                                    <Button onClick={handleDelete} size="sm" variant="destructive" disabled={deleteMutation.isPending}>
                                        <Trash2 className="mr-2 h-4 w-4" />
                                        {deleteMutation.isPending ? "–£–¥–∞–ª–µ–Ω–∏–µ..." : "–£–¥–∞–ª–∏—Ç—å"}
                                    </Button>
                                )}
                            </div>
                        </div>

                        {/* –†–∞–∑–≤–æ—Ä–∞—á–∏–≤–∞–µ–º—ã–π –±–ª–æ–∫ —Å —Å–æ—Å—Ç–∞–≤–æ–º –∞—Ä–µ–Ω–¥—ã */}
                        {isExpanded && (
                            <div className="mt-3 pt-3 border-t border-dashed animate-in fade-in-0 slide-in-from-top-2 duration-300">
                                <div className="flex items-center gap-2 text-sm font-semibold text-gray-600 mb-2">
                                    <List className="w-4 h-4" />
                                    <span>–°–æ—Å—Ç–∞–≤ –∞—Ä–µ–Ω–¥—ã:</span>
                                </div>
                                <EquipmentWithAccessoriesList
                                    equipment={rental.equipment.map(equipmentItem => ({
                                        id: equipmentItem.id,
                                        name: `${equipmentItem.equipment_type} ${equipmentItem.brand} ${equipmentItem.name}`
                                    }))}
                                    accessoryLinks={rental.accessory_links || []}
                                    title=""
                                    showTitle={false}
                                    className="border-t-0 pt-0"
                                />
                            </div>
                        )}
                    </CardContent>
                </Card>
            </div>

            <ConfirmationDialog
                open={isConfirmingRevert}
                onOpenChange={setConfirmingRevert}
                title="–û—Ç–º–µ–Ω–∏—Ç—å –≤—ã–¥–∞—á—É –∞—Ä–µ–Ω–¥—ã?"
                description={`–ê—Ä–µ–Ω–¥–∞ #${rental.id} –±—É–¥–µ—Ç —É–¥–∞–ª–µ–Ω–∞, –∞ –∏—Å—Ö–æ–¥–Ω—ã–π —Ä–µ–∑–µ—Ä–≤ #${rental.reservation_id} —Å–Ω–æ–≤–∞ —Å—Ç–∞–Ω–µ—Ç –∞–∫—Ç–∏–≤–Ω—ã–º. –≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ –Ω–µ–ª—å–∑—è –±—É–¥–µ—Ç –æ—Ç–º–µ–Ω–∏—Ç—å.`}
                confirmText="–î–∞, –æ—Ç–º–µ–Ω–∏—Ç—å –≤—ã–¥–∞—á—É"
                cancelText="–ù–∞–∑–∞–¥"
                onConfirm={handleRevert}
                variant="destructive"
            />
        </>
    );
}

```


## <a name="rentalappmainsrccomponentsadminAdminReservationCardtsx"></a>`rental-app-main/src/components/admin/AdminReservationCard.tsx`

```tsx
// path: rental-app-main/src/components/admin/AdminReservationCard.tsx

// src/components/admin/AdminReservationCard.tsx

import { useState, useMemo, useRef, useEffect } from "react";
import { useLocation, useNavigate } from "react-router-dom";
import { Card, CardContent } from "@/components/ui/card";
import { Button } from "@/components/ui/button";
import { Calendar, Edit, Package, Trash2, User, Truck, CheckCircle, AlertTriangle, XCircle, List } from "lucide-react";
import { formatDateEuropean, cn } from "@/lib/utils";
import type { AdminReservationOut } from "@/types/reservation";
import { useDeleteAdminReservation } from "@/hooks/useAdminReservations";
import { ReservationEditProvider } from "@/hooks/useInlineReservationEdit";
import EditableReservationCard from "@/components/reservation/EditableReservationCard";
import type { Equipment } from "@/types/equipment";
import { Checkbox } from "@/components/ui/checkbox";
import { useAdminReservationSelectionStore } from "@/store/adminReservationSelectionStore";
import EquipmentWithAccessoriesList from "@/components/shared/EquipmentWithAccessoriesList";
import FinancialInfoBlock from "@/components/shared/FinancialInfoBlock";
import { RESERVATION_CARD_STYLES } from "@/constants/statusStyles";

interface Props {
    reservation: AdminReservationOut;
    onConvertToRental: (reservation: AdminReservationOut) => void;
    equipmentMap: Map<number, Equipment>;
    highlightId?: number;
}

const getStatusInfo = (reservation: AdminReservationOut) => {
    const now = new Date();
    now.setHours(0, 0, 0, 0);
    const endDate = new Date(reservation.end_date);

    if (reservation.status === 'fulfilled') {
        return { text: "–í—ã–ø–æ–ª–Ω–µ–Ω", Icon: CheckCircle, className: "text-green-600 bg-green-50 border-green-200", isActionable: false };
    }
    if (reservation.status === 'cancelled') {
        return { text: "–û—Ç–º–µ–Ω–µ–Ω", Icon: XCircle, className: "text-gray-600 bg-gray-100 border-gray-200", isActionable: false };
    }
    if (endDate < now || reservation.status === 'overdue') {
        return { text: "–ü—Ä–æ—Å—Ä–æ—á–µ–Ω", Icon: AlertTriangle, className: "text-orange-600 bg-orange-50 border-orange-200", isActionable: true };
    }
    return { text: "–ê–∫—Ç–∏–≤–µ–Ω", Icon: Calendar, className: "text-blue-600 bg-blue-50 border-blue-200", isActionable: true };
};

export default function AdminReservationCard({ reservation, onConvertToRental, equipmentMap, highlightId }: Props) {
    const [isEditing, setIsEditing] = useState(false);
    const [isExpanded, setIsExpanded] = useState(false);
    const deleteReservationMutation = useDeleteAdminReservation();
    const cardRef = useRef<HTMLDivElement>(null);
    const navigate = useNavigate();
    const location = useLocation();

    const { selectedIds, toggleId } = useAdminReservationSelectionStore();
    const isSelected = selectedIds.includes(reservation.id);
    const isHighlighted = highlightId === reservation.id;

    const statusInfo = useMemo(() => getStatusInfo(reservation), [reservation]);

    useEffect(() => {
        if (isHighlighted && cardRef.current) {
            cardRef.current.scrollIntoView({
                behavior: "smooth",
                block: "center",
            });
        }
    }, [isHighlighted]);


    const handleDelete = () => {
        if (window.confirm(`–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å —Ä–µ–∑–µ—Ä–≤ #${reservation.id} –¥–ª—è –∫–ª–∏–µ–Ω—Ç–∞ "${reservation.user_info.full_name}"?`)) {
            deleteReservationMutation.mutate(reservation.id);
        }
    };

    const handleNavigateToRental = () => {
        if (reservation.rental_id) {
            navigate('/admin/rentals', {
                state: {
                    highlightId: reservation.rental_id,
                    statusFilterOverride: 'all'
                }
            });
        }
    };

    const initialEquipmentForDisplay = useMemo(() =>
            reservation.equipment_ids
                .map(id => {
                    const equipment = equipmentMap.get(id);
                    if (!equipment) {
                        return { id, label: `–û–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏–µ #${id} (–Ω–µ –Ω–∞–π–¥–µ–Ω–æ)` };
                    }
                    return { id, label: `${equipment.equipment_type} ${equipment.brand} ${equipment.name}` };
                }),
        [reservation.equipment_ids, equipmentMap]
    );

    const equipmentListForDisplay = useMemo(() =>
        reservation.equipment_ids.map(id => {
            const equipment = equipmentMap.get(id);
            return equipment
                ? `${equipment.equipment_type} ${equipment.brand} ${equipment.name}`
                : `–û–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏–µ #${id} (–Ω–µ –Ω–∞–π–¥–µ–Ω–æ)`;
        }), [reservation.equipment_ids, equipmentMap]);

    if (isEditing) {
        return (
            <ReservationEditProvider
                reservation={reservation}
                initialEquipmentForDisplay={initialEquipmentForDisplay}
                onFullCancellation={handleDelete}
                isAdminContext={true}
                onFinishEditing={() => setIsEditing(false)}
            >
                <EditableReservationCard />
            </ReservationEditProvider>
        );
    }

    const statusClass = RESERVATION_CARD_STYLES[reservation.status] || RESERVATION_CARD_STYLES.default;
    
    const highlightClass = isHighlighted
        ? "ring-2 ring-offset-2 ring-amber-500 border-amber-400 bg-amber-50"
        : isSelected
            ? 'ring-2 ring-sky-500 border-sky-400'
            : 'border-gray-200';

    return (
        <div ref={cardRef} className={`relative w-full rounded-lg border transition-all hover:shadow-md ${highlightClass}`}>
            <div className="absolute top-4 left-4 z-10">
                <Checkbox
                    checked={isSelected}
                    onCheckedChange={() => toggleId(reservation.id)}
                    aria-label={`–í—ã–±—Ä–∞—Ç—å —Ä–µ–∑–µ—Ä–≤ #${reservation.id}`}
                    className="bg-white h-5 w-5"
                />
            </div>
            <Card className={cn("w-full", statusClass)}>
                <CardContent className="p-4 pl-12">
                    <div className="flex flex-col md:flex-row gap-4 justify-between">
                        <div className="flex-1 space-y-2.5">
                            <div className="flex items-center gap-4">
                                <h3 className="font-bold text-lg text-indigo-700">–†–µ–∑–µ—Ä–≤ #{reservation.id}</h3>
                                <span className={`flex items-center gap-1.5 text-xs font-medium px-2 py-1 rounded-md border ${statusInfo.className}`}>
                                    <statusInfo.Icon className="w-3.5 h-3.5" />
                                    {statusInfo.text}
                                </span>
                            </div>
                            <div className="text-sm text-gray-700 space-y-1.5 pl-1">
                                <div className="flex items-center gap-2">
                                    <User className="w-4 h-4 text-gray-500" />
                                    <span>{reservation.user_info.full_name} ({reservation.user_info.email})</span>
                                </div>
                                <div className="flex items-center gap-2">
                                    <Calendar className="w-4 h-4 text-gray-500" />
                                    <span>{formatDateEuropean(reservation.start_date)} ‚Äî {formatDateEuropean(reservation.end_date)}</span>
                                </div>
                                <div className="flex items-start gap-2">
                                    <Package className="w-4 h-4 text-gray-500 mt-1 flex-shrink-0" />
                                    <div className="flex-1">
                                        <div className="flex items-center text-left w-full">
                                            <span>–ü–æ–∑–∏—Ü–∏–π –≤ —Ä–µ–∑–µ—Ä–≤–µ: {equipmentListForDisplay.length}</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        {/* –§–∏–Ω–∞–Ω—Å–æ–≤—ã–π –±–ª–æ–∫ */}
                        <FinancialInfoBlock
                            totalCost={reservation.total_cost}
                            discountAmount={reservation.discount_amount}
                            promoCode={reservation.promo_code}
                            variant="admin"
                        />

                        <div className="flex md:flex-col items-center md:items-end justify-between md:justify-start gap-2 border-t md:border-t-0 md:border-l pt-3 md:pt-0 md:pl-4">
                            {statusInfo.isActionable ? (
                                <>
                                    <Button onClick={() => onConvertToRental(reservation)} size="sm" className="bg-green-600 hover:bg-green-700 w-full md:w-auto">
                                        <Truck className="mr-2 h-4 w-4" />
                                        –í—ã–¥–∞—Ç—å –≤ –∞—Ä–µ–Ω–¥—É
                                    </Button>
                                    <Button onClick={() => setIsEditing(true)} size="sm" variant="outline" className="w-full md:w-auto">
                                        <Edit className="mr-2 h-4 w-4" />
                                        –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å
                                    </Button>
                                </>
                            ) : (
                                <div className="text-sm text-gray-500 flex items-center gap-2 pr-2">
                                    <span>–î–µ–π—Å—Ç–≤–∏–π –Ω–µ—Ç</span>
                                </div>
                            )}

                            {/* –ö–Ω–æ–ø–∫–∞ –ø–µ—Ä–µ—Ö–æ–¥–∞ –∫ –∞—Ä–µ–Ω–¥–µ –¥–ª—è –≤—ã–ø–æ–ª–Ω–µ–Ω–Ω—ã—Ö —Ä–µ–∑–µ—Ä–≤–æ–≤ */}
                            {reservation.status === 'fulfilled' && reservation.rental_id && (
                                <Button onClick={handleNavigateToRental} size="sm" variant="outline" className="w-full md:w-auto text-orange-600 hover:text-orange-700 hover:bg-orange-50 border-orange-200">
                                    <Truck className="mr-2 h-4 w-4" />
                                    –ü–µ—Ä–µ–π—Ç–∏ –∫ –∞—Ä–µ–Ω–¥–µ
                                </Button>
                            )}

                            <Button onClick={handleDelete} size="sm" variant="destructive" disabled={deleteReservationMutation.isPending} className="w-full md:w-auto">
                                <Trash2 className="mr-2 h-4 w-4" />
                                {deleteReservationMutation.isPending ? "–£–¥–∞–ª–µ–Ω–∏–µ..." : "–£–¥–∞–ª–∏—Ç—å"}
                            </Button>
                        </div>
                    </div>

                    {equipmentListForDisplay.length > 0 && (
                        <div className="mt-3 pt-3 border-t border-dashed animate-in fade-in-0 slide-in-from-top-2 duration-300">
                            <div className="flex items-center gap-2 text-sm font-semibold text-gray-600 mb-2">
                                <List className="w-4 h-4" />
                                <span>–°–æ—Å—Ç–∞–≤ —Ä–µ–∑–µ—Ä–≤–∞:</span>
                            </div>
                            <EquipmentWithAccessoriesList
                                equipment={reservation.equipment_ids.map(equipmentId => {
                                    const equipment = equipmentMap.get(equipmentId);
                                    return {
                                        id: equipmentId,
                                        name: equipment
                                            ? `${equipment.equipment_type} ${equipment.brand} ${equipment.name}`
                                            : `–û–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏–µ #${equipmentId} (–Ω–µ –Ω–∞–π–¥–µ–Ω–æ)`
                                    };
                                })}
                                accessoryLinks={reservation.accessory_links || []}
                                title=""
                                showTitle={false}
                                className="border-t-0 pt-0"
                            />
                        </div>
                    )}
                </CardContent>
            </Card>
        </div>
    );
}

```


## <a name="rentalappmainsrccomponentsadminAdminReservationToolbartsx"></a>`rental-app-main/src/components/admin/AdminReservationToolbar.tsx`

```tsx
// path: rental-app-main/src/components/admin/AdminReservationToolbar.tsx

// src/components/admin/AdminReservationToolbar.tsx

import { Button } from '@/components/ui/button';
import { Checkbox } from '@/components/ui/checkbox';
import { Trash2 } from 'lucide-react';
import { useAdminReservationSelectionStore } from '@/store/adminReservationSelectionStore';

interface Props {
    visibleReservationIds: number[];
    onBulkDelete: () => void;
    isDeleting: boolean;
}

export function AdminReservationToolbar({ visibleReservationIds, onBulkDelete, isDeleting }: Props) {
    const { selectedIds, setSelectedIds, clearSelection } = useAdminReservationSelectionStore();

    const isAllSelected = visibleReservationIds.length > 0 && selectedIds.length === visibleReservationIds.length;
    const isSomeSelected = selectedIds.length > 0 && selectedIds.length < visibleReservationIds.length;

    const handleSelectAll = (checked: boolean | 'indeterminate') => {
        if (checked === true) {
            setSelectedIds(visibleReservationIds);
        } else {
            clearSelection();
        }
    };

    return (
        <div className="flex items-center gap-4 p-3 bg-slate-50 border rounded-md mb-4 h-14">
            <div className="flex items-center gap-2">
                <Checkbox
                    id="select-all"
                    checked={isAllSelected ? true : (isSomeSelected ? 'indeterminate' : false)}
                    onCheckedChange={handleSelectAll}
                    aria-label="–í—ã–±—Ä–∞—Ç—å –≤—Å–µ –≤–∏–¥–∏–º—ã–µ —Ä–µ–∑–µ—Ä–≤—ã"
                />
                <label htmlFor="select-all" className="text-sm font-medium text-slate-700 cursor-pointer">
                    –í—ã–±—Ä–∞—Ç—å –≤—Å–µ
                </label>
            </div>

            {selectedIds.length > 0 && (
                <div className="flex items-center gap-4 animate-in fade-in-0 duration-300">
          <span className="text-sm text-slate-500">
            –í—ã–±—Ä–∞–Ω–æ: {selectedIds.length}
          </span>
                    <Button
                        size="sm"
                        variant="destructive"
                        onClick={onBulkDelete}
                        disabled={isDeleting}
                    >
                        <Trash2 className="w-4 h-4 mr-2" />
                        {isDeleting ? '–£–¥–∞–ª–µ–Ω–∏–µ...' : '–£–¥–∞–ª–∏—Ç—å –≤—ã–±—Ä–∞–Ω–Ω–æ–µ'}
                    </Button>
                </div>
            )}
        </div>
    );
}

```


## <a name="rentalappmainsrccomponentsadminAllRentalsListtsx"></a>`rental-app-main/src/components/admin/AllRentalsList.tsx`

```tsx
// path: rental-app-main/src/components/admin/AllRentalsList.tsx

// src/components/admin/AllRentalsList.tsx

// +++ –î–û–ë–ê–í–¨–¢–ï –ò–ú–ü–û–†–¢ AdminRentalOut +++
import type { AdminRentalOut } from "@/types/rental";
import { ClipboardX } from "lucide-react";
import AdminRentalCard from "./AdminRentalCard";

// +++ –ò–ó–ú–ï–ù–ò–¢–ï –ò–ù–¢–ï–†–§–ï–ô–° Props +++
interface Props {
    rentals: AdminRentalOut[];
    onReturn: (rental: AdminRentalOut) => void;
    highlightId?: number | null;
}

export default function AllRentalsList({ rentals, onReturn, highlightId }: Props) {
    if (!rentals || rentals.length === 0) {
        return (
            <div className="flex flex-col items-center justify-center text-center p-12 space-y-4 bg-gray-50/50 rounded-lg border-2 border-dashed">
                <ClipboardX className="w-16 h-16 text-gray-400" />
                <h3 className="text-lg font-semibold text-gray-800">–ê—Ä–µ–Ω–¥—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã</h3>
                <p className="text-sm text-gray-500">–ü–æ–ø—Ä–æ–±—É–π—Ç–µ –∏–∑–º–µ–Ω–∏—Ç—å —Ñ–∏–ª—å—Ç—Ä—ã –∏–ª–∏ –ø–æ–∏—Å–∫–æ–≤—ã–π –∑–∞–ø—Ä–æ—Å.</p>
            </div>
        );
    }

    return (
        <div className="space-y-4">
            {/* +++ –ü–ï–†–ï–î–ê–ô–¢–ï –ü–†–û–ü–° onReturn –í –ö–ê–†–¢–û–ß–ö–£ +++ */}
            {rentals.map((rental) => (
                <AdminRentalCard key={rental.id} rental={rental} onReturn={onReturn} highlightId={highlightId} />
            ))}
        </div>
    );
}

```


## <a name="rentalappmainsrccomponentsadminAllReservationsListtsx"></a>`rental-app-main/src/components/admin/AllReservationsList.tsx`

```tsx
// path: rental-app-main/src/components/admin/AllReservationsList.tsx

// src/components/admin/AllReservationsList.tsx

import type { AdminReservationOut } from "@/types/reservation";
import AdminReservationCard from "./AdminReservationCard";
import type { Equipment } from "@/types/equipment";

interface Props {
    reservations: AdminReservationOut[];
    onConvertToRental: (reservation: AdminReservationOut) => void;
    equipmentMap: Map<number, Equipment>;
    highlightId?: number;
}

export default function AllReservationsList({ reservations, onConvertToRental, equipmentMap, highlightId }: Props) {
    return (
        <div className="space-y-4">
            {reservations.map((reservation) => (
                <AdminReservationCard
                    key={reservation.id}
                    reservation={reservation}
                    onConvertToRental={onConvertToRental}
                    equipmentMap={equipmentMap}
                    highlightId={highlightId}
                />
            ))}
        </div>
    );
}

```


## <a name="rentalappmainsrccomponentsadminAssociationTabletsx"></a>`rental-app-main/src/components/admin/AssociationTable.tsx`

```tsx
// path: rental-app-main/src/components/admin/AssociationTable.tsx

// src/components/admin/AssociationTable.tsx

import { useState, useMemo, useEffect } from "react";
import { useAdminAssociations, useCreateAssociation, useUpdateAssociation, useDeleteAssociation } from "@/hooks/useAdminAssociations";
// ‚ùå –£–î–ê–õ–ï–ù–û: –ë–æ–ª—å—à–µ –Ω–µ –∏—Å–ø–æ–ª—å–∑—É–µ–º –ø–∞–≥–∏–Ω–∏—Ä–æ–≤–∞–Ω–Ω—ã–π —Ö—É–∫ –¥–ª—è –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—è
// import { useEquipment } from "@/hooks/useEquipment";
// ‚úÖ –î–û–ë–ê–í–õ–ï–ù–û: –ò—Å–ø–æ–ª—å–∑—É–µ–º —Ö—É–∫, –∫–æ—Ç–æ—Ä—ã–π –∑–∞–≥—Ä—É–∂–∞–µ—Ç –ü–û–õ–ù–´–ô —Å–ø–∏—Å–æ–∫ –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—è –¥–ª—è –Ω–∞—à–µ–≥–æ "—Å–ø—Ä–∞–≤–æ—á–Ω–∏–∫–∞"
import { useAllEquipment } from "@/hooks/useAllEquipment";
import { useForm, Controller } from "react-hook-form";
import { zodResolver } from "@hookform/resolvers/zod";
import { z } from "zod";
import type { Association } from "@/types/association";
// ‚ùå –£–î–ê–õ–ï–ù–û: –≠—Ç–æ—Ç —Ç–∏–ø –±–æ–ª—å—à–µ –Ω–µ –Ω—É–∂–µ–Ω, —Ç–∞–∫ –∫–∞–∫ –º—ã –Ω–µ —Ä–∞–±–æ—Ç–∞–µ–º —Å –ø–∞–≥–∏–Ω–∞—Ü–∏–µ–π –∑–¥–µ—Å—å
// import type { EquipmentListResponse } from "@/core/services/EquipmentService";

// UI Components
import { Button } from "@/components/ui/button";
import { Dialog, DialogContent, DialogHeader, DialogTitle, DialogFooter, DialogDescription } from "@/components/ui/dialog";
import { Input } from "@/components/ui/input";
import { Label } from "@/components/ui/label";
import { MultiSelect } from "@/components/ui/multi-select";
import { Table, TableBody, TableCell, TableHead, TableHeader, TableRow } from "@/components/ui/table";
import { Plus, Edit, Trash2, Tags, Loader2 } from "lucide-react";

const associationSchema = z.object({
    name: z.string().min(3, "–ù–∞–∑–≤–∞–Ω–∏–µ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ"),
    description: z.string().optional(),
    sort_order: z.coerce.number(),
    equipment_ids: z.array(z.number()),
});
type AssociationFormData = z.infer<typeof associationSchema>;

// --- –ö–æ–º–ø–æ–Ω–µ–Ω—Ç –¥–∏–∞–ª–æ–≥–æ–≤–æ–≥–æ –æ–∫–Ω–∞ (–±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π –≤ –ª–æ–≥–∏–∫–µ) ---
function AssociationDialog({ open, onClose, association, allEquipment }: {
    open: boolean;
    onClose: () => void;
    association: Association | null;
    allEquipment: { value: string, label: string }[];
}) {
    const createMutation = useCreateAssociation();
    const updateMutation = useUpdateAssociation();

    const {
        register,
        handleSubmit,
        control,
        reset,
        formState: { errors, isValid },
    } = useForm<AssociationFormData>({
        resolver: zodResolver(associationSchema),
        mode: "onChange",
    });

    useEffect(() => {
        if (open) {
            reset({
                name: association?.name ?? "",
                description: association?.description ?? "",
                sort_order: association?.sort_order ?? 0,
                equipment_ids: association?.equipment_ids ?? [],
            });
        }
    }, [association, open, reset]);

    const onSubmit = (data: AssociationFormData) => {
        const handleSuccess = () => {
            reset();
            onClose();
        };

        if (association) {
            updateMutation.mutate({ id: association.id, data }, { onSuccess: handleSuccess });
        } else {
            createMutation.mutate(data, { onSuccess: handleSuccess });
        }
    };

    return (
        <Dialog open={open} onOpenChange={onClose}>
            <DialogContent>
                <DialogHeader>
                    <DialogTitle>{association ? "–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –∞—Å—Å–æ—Ü–∏–∞—Ü–∏—é" : "–ù–æ–≤–∞—è –∞—Å—Å–æ—Ü–∏–∞—Ü–∏—è"}</DialogTitle>
                    <DialogDescription>
                        {association ? `–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ "${association.name}"` : "–°–æ–∑–¥–∞–π—Ç–µ –Ω–æ–≤—É—é –ø–æ–¥–±–æ—Ä–∫—É –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—è."}
                    </DialogDescription>
                </DialogHeader>
                <form onSubmit={handleSubmit(onSubmit)} className="space-y-4 py-2">
                    <div>
                        <Label htmlFor="assoc-name">–ù–∞–∑–≤–∞–Ω–∏–µ *</Label>
                        <Input id="assoc-name" {...register("name")} placeholder="–ù–∞–±–æ—Ä –¥–ª—è —Å—Ç—Ä–∏–º–∏–Ω–≥–∞" />
                        {errors.name && <p className="text-xs text-red-600 mt-1">{errors.name.message}</p>}
                    </div>
                    <div>
                        <Label htmlFor="assoc-sort">–ü–æ—Ä—è–¥–æ–∫ —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∏</Label>
                        <Input id="assoc-sort" type="number" {...register("sort_order")} />
                    </div>
                    <div>
                        <Label>–û–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏–µ –≤ –ø–æ–¥–±–æ—Ä–∫–µ</Label>
                        <Controller
                            name="equipment_ids"
                            control={control}
                            render={({ field }) => (
                                <MultiSelect
                                    placeholder="–í—ã–±–µ—Ä–∏—Ç–µ –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏–µ..."
                                    options={allEquipment}
                                    value={field.value.map(String)}
                                    onValueChange={(selected) => field.onChange(selected.map(Number))}
                                />
                            )}
                        />
                    </div>
                    <DialogFooter>
                        <Button type="button" variant="ghost" onClick={onClose}>–û—Ç–º–µ–Ω–∞</Button>
                        <Button type="submit" disabled={!isValid || createMutation.isPending || updateMutation.isPending}>
                            {createMutation.isPending || updateMutation.isPending ? "–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ..." : "–°–æ—Ö—Ä–∞–Ω–∏—Ç—å"}
                        </Button>
                    </DialogFooter>
                </form>
            </DialogContent>
        </Dialog>
    );
}

// --- –û—Å–Ω–æ–≤–Ω–æ–π –∫–æ–º–ø–æ–Ω–µ–Ω—Ç —Ç–∞–±–ª–∏—Ü—ã ---
export default function AssociationTable() {
    const { data: associations = [], isLoading } = useAdminAssociations();
    // ‚úÖ –ò–ó–ú–ï–ù–ï–ù–û: –ó–∞–≥—Ä—É–∂–∞–µ–º –≤–µ—Å—å —Å–ø–∏—Å–æ–∫ –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—è –æ–¥–∏–Ω —Ä–∞–∑.
    const { data: allEquipment = [] } = useAllEquipment();
    const deleteMutation = useDeleteAssociation();

    // ‚úÖ –ò–ó–ú–ï–ù–ï–ù–û: –ü—Ä–µ–æ–±—Ä–∞–∑—É–µ–º –ø–æ–ª–Ω—ã–π —Å–ø–∏—Å–æ–∫ –≤ —Ñ–æ—Ä–º–∞—Ç –¥–ª—è –≤—ã–ø–∞–¥–∞—é—â–µ–≥–æ –º–µ–Ω—é.
    const equipmentOptions = useMemo(() =>
            allEquipment.map(e => ({ value: e.id.toString(), label: e.name })),
        [allEquipment]
    );

    const [isDialogOpen, setDialogOpen] = useState(false);
    const [editingAssoc, setEditingAssoc] = useState<Association | null>(null);

    const handleEdit = (assoc: Association) => { setEditingAssoc(assoc); setDialogOpen(true); };
    const handleCreate = () => { setEditingAssoc(null); setDialogOpen(true); };
    const handleDelete = (id: number) => { if (window.confirm("–£–¥–∞–ª–∏—Ç—å –∞—Å—Å–æ—Ü–∏–∞—Ü–∏—é?")) deleteMutation.mutate(id); };

    if (isLoading) return <div className="flex items-center gap-2"><Loader2 className="animate-spin" /> –ó–∞–≥—Ä—É–∑–∫–∞...</div>;

    return (
        <>
            <div className="flex justify-end mb-4">
                <Button onClick={handleCreate}><Plus className="mr-2 h-4 w-4" /> –°–æ–∑–¥–∞—Ç—å</Button>
            </div>
            {associations.length > 0 ? (
                <Table>
                    <TableHeader>
                        <TableRow>
                            <TableHead>–ü–æ—Ä—è–¥–æ–∫</TableHead>
                            <TableHead>–ù–∞–∑–≤–∞–Ω–∏–µ</TableHead>
                            <TableHead>–ö–æ–ª-–≤–æ –µ–¥.</TableHead>
                            <TableHead className="text-right">–î–µ–π—Å—Ç–≤–∏—è</TableHead>
                        </TableRow>
                    </TableHeader>
                    <TableBody>
                        {associations.map((assoc) => (
                            <TableRow key={assoc.id}>
                                <TableCell>{assoc.sort_order}</TableCell>
                                <TableCell className="font-medium">{assoc.name}</TableCell>
                                <TableCell>{assoc.equipment_ids.length}</TableCell>
                                <TableCell className="text-right">
                                    <Button variant="ghost" size="icon" onClick={() => handleEdit(assoc)}><Edit className="h-4 w-4" /></Button>
                                    <Button variant="ghost" size="icon" onClick={() => handleDelete(assoc.id)}><Trash2 className="h-4 w-4 text-red-500" /></Button>
                                </TableCell>
                            </TableRow>
                        ))}
                    </TableBody>
                </Table>
            ) : (
                <div className="text-center py-10 border-dashed border-2 rounded-lg">
                    <Tags className="mx-auto h-12 w-12 text-gray-300" />
                    <h3 className="mt-2 text-sm font-semibold text-gray-800">–ê—Å—Å–æ—Ü–∏–∞—Ü–∏–∏ –Ω–µ —Å–æ–∑–¥–∞–Ω—ã</h3>
                    <p className="mt-1 text-sm text-gray-500">–ù–∞–∂–º–∏—Ç–µ "–°–æ–∑–¥–∞—Ç—å", —á—Ç–æ–±—ã –¥–æ–±–∞–≤–∏—Ç—å –ø–µ—Ä–≤—É—é.</p>
                </div>
            )}
            {/* ‚úÖ –¢–µ–ø–µ—Ä—å –≤ –¥–∏–∞–ª–æ–≥ –≥–∞—Ä–∞–Ω—Ç–∏—Ä–æ–≤–∞–Ω–Ω–æ –ø–µ—Ä–µ–¥–∞–µ—Ç—Å—è –ü–û–õ–ù–´–ô —Å–ø–∏—Å–æ–∫ –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—è */}
            {isDialogOpen && <AssociationDialog open={isDialogOpen} onClose={() => setDialogOpen(false)} association={editingAssoc} allEquipment={equipmentOptions} />}
        </>
    );
}

```


## <a name="rentalappmainsrccomponentsadminConvertReservationDialogtsx"></a>`rental-app-main/src/components/admin/ConvertReservationDialog.tsx`

```tsx
// path: rental-app-main/src/components/admin/ConvertReservationDialog.tsx

// path: rental-app-main/src/components/admin/ConvertReservationDialog.tsx

import { useState, useEffect, useMemo } from "react";
import { Dialog, DialogContent, DialogHeader, DialogTitle, DialogFooter, DialogDescription } from "@/components/ui/dialog";
import { Button } from "@/components/ui/button";
import { Label } from "@/components/ui/label";
import { Input } from "@/components/ui/input";
import { Textarea } from "@/components/ui/textarea";
import { useConvertReservationToRental } from "@/hooks/useAdminRentals";
import type { AdminReservationOut } from "@/types/reservation";
import type { Equipment } from "@/types/equipment";
import ReservationFinancialSummary from "./ReservationFinancialSummary";
import { useAvailabilityCheck } from "@/hooks/useAvailabilityCheck";
// +++ 1. –ò–ú–ü–û–†–¢–ò–†–£–ï–ú –î–ò–ê–õ–û–ì –ü–û–î–¢–í–ï–†–ñ–î–ï–ù–ò–Ø –ò –¢–ò–ü –û–®–ò–ë–ö–ò +++
import { ConfirmationDialog } from "@/components/ui/confirmation-dialog";
import type { AxiosError } from "axios";
// +++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++

interface Props {
    reservation: AdminReservationOut | null;
    open: boolean;
    onClose: () => void;
    equipmentMap: Map<number, Equipment>;
}

export default function ConvertReservationDialog({ reservation, open, onClose, equipmentMap }: Props) {
    const [notes, setNotes] = useState("");
    const [deposit, setDeposit] = useState("0");
    const [prepayment, setPrepayment] = useState("0");
    const convertMutation = useConvertReservationToRental();

    // +++ 2. –î–û–ë–ê–í–õ–Ø–ï–ú –°–û–°–¢–û–Ø–ù–ò–ï –î–õ–Ø –£–ü–†–ê–í–õ–ï–ù–ò–Ø –ö–û–ù–§–õ–ò–ö–¢–û–ú –í–´–•–û–î–ù–û–ì–û –î–ù–Ø +++
    const [holidayConflict, setHolidayConflict] = useState<string | null>(null);
    // +++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++

    const { newStartDate, newEndDate } = useMemo(() => {
        const today = new Date();
        today.setHours(0, 0, 0, 0);
        if (!reservation) return { newStartDate: today, newEndDate: today };
        const originalEndDate = new Date(reservation.end_date);
        
        // –ï—Å–ª–∏ –¥–∞—Ç–∞ –æ–∫–æ–Ω—á–∞–Ω–∏—è —Ä–µ–∑–µ—Ä–≤–∞ —É–∂–µ –ø—Ä–æ—à–ª–∞ –∏–ª–∏ –Ω–∞—Å—Ç—É–ø–∞–µ—Ç —Å–µ–≥–æ–¥–Ω—è, 
        // —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –¥–∞—Ç—É –æ–∫–æ–Ω—á–∞–Ω–∏—è –Ω–∞ –∑–∞–≤—Ç—Ä–∞
        const finalEndDate = originalEndDate <= today 
            ? new Date(today.getTime() + 24 * 60 * 60 * 1000) // –∑–∞–≤—Ç—Ä–∞
            : originalEndDate;
            
        return { newStartDate: today, newEndDate: finalEndDate };
    }, [reservation]);

    const { hasConflicts, conflictingItemIds, isLoading: isCheckingAvailability } = useAvailabilityCheck({
        equipmentIds: reservation?.equipment_ids || [],
        startDate: newStartDate,
        endDate: newEndDate,
        excludeReservationId: reservation?.id,
    });

    useEffect(() => {
        if (!open) {
            setNotes("");
            setDeposit("0");
            setPrepayment("0");
            // +++ 3. –°–ë–†–ê–°–´–í–ê–ï–ú –°–û–°–¢–û–Ø–ù–ò–ï –ö–û–ù–§–õ–ò–ö–¢–ê –ü–†–ò –ó–ê–ö–†–´–¢–ò–ò +++
            setHolidayConflict(null);
            // +++++++++++++++++++++++++++++++++++++++++++++++++++++++++
        }
    }, [open]);

    // +++ 4. –û–ë–ù–û–í–õ–Ø–ï–ú –õ–û–ì–ò–ö–£ –û–ë–†–ê–ë–û–¢–ö–ò –û–¢–ü–†–ê–í–ö–ò –§–û–†–ú–´ +++
    const handleSubmit = async (force: boolean = false) => {
        if (!reservation) return;

        try {
            await convertMutation.mutateAsync({
                reservationId: reservation.id,
                data: {
                    notes_on_issue: notes,
                    deposit_amount: parseFloat(deposit) || 0,
                    prepayment_amount: parseFloat(prepayment) || 0,
                    force_issue_on_holiday: force, // –ü–µ—Ä–µ–¥–∞–µ–º —Ñ–ª–∞–≥ `force`
                },
            });
            onClose();
        } catch (error) {
            // –¢–∏–ø–∏–∑–∏—Ä—É–µ–º –æ—à–∏–±–∫—É –¥–ª—è –¥–æ—Å—Ç—É–ø–∞ –∫ –¥–µ—Ç–∞–ª—è–º
            const axiosError = error as AxiosError<{ detail?: { error_type?: string; message?: string } }>;
            const detail = axiosError.response?.data?.detail;

            // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ —ç—Ç–æ –∏–º–µ–Ω–Ω–æ –æ—à–∏–±–∫–∞ –∫–æ–Ω—Ñ–ª–∏–∫—Ç–∞ –≤—ã—Ö–æ–¥–Ω–æ–≥–æ –¥–Ω—è
            if (axiosError.response?.status === 409 && detail?.error_type === "ISSUE_ON_HOLIDAY") {
                setHolidayConflict(detail.message || "–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç–µ –¥–µ–π—Å—Ç–≤–∏–µ.");
            } else {
                // –î–ª—è –¥—Ä—É–≥–∏—Ö –æ—à–∏–±–æ–∫ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –æ–±—â–µ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
                console.error("–û—à–∏–±–∫–∞ –ø—Ä–∏ –∫–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏–∏ —Ä–µ–∑–µ—Ä–≤–∞:", error);
                // –î—Ä—É–≥–∏–µ –æ—à–∏–±–∫–∏ –±—É–¥—É—Ç –æ–±—Ä–∞–±–æ—Ç–∞–Ω—ã –≤ —Ö—É–∫–µ useConvertReservationToRental
            }
        }
    };

    // +++ 5. –î–û–ë–ê–í–õ–Ø–ï–ú –û–ë–†–ê–ë–û–¢–ß–ò–ö –î–õ–Ø –§–û–†–°–ò–†–û–í–ê–ù–ù–û–ô –û–¢–ü–†–ê–í–ö–ò +++
    const handleForceSubmit = () => {
        setHolidayConflict(null); // –ó–∞–∫—Ä—ã–≤–∞–µ–º –¥–∏–∞–ª–æ–≥ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è
        void handleSubmit(true); // –ü–æ–≤—Ç–æ—Ä–Ω–æ –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º —Å —Ñ–ª–∞–≥–æ–º force = true
    };
    // +++++++++++++++++++++++++++++++++++++++++++++++++++++++++++

    if (!reservation) return null;

    return (
        <>
            <Dialog open={open} onOpenChange={onClose}>
                <DialogContent className="sm:max-w-lg">
                    <DialogHeader>
                        <DialogTitle>–í—ã–¥–∞—á–∞ –∞—Ä–µ–Ω–¥—ã –∏–∑ —Ä–µ–∑–µ—Ä–≤–∞ #{reservation.id}</DialogTitle>
                        <DialogDescription>
                            –î–ª—è –∫–ª–∏–µ–Ω—Ç–∞: <strong>{reservation.user_info.full_name}</strong>
                        </DialogDescription>
                    </DialogHeader>

                    <div className="space-y-4 py-2">
                        <ReservationFinancialSummary
                            reservation={reservation}
                            open={open}
                            hasConflicts={hasConflicts}
                            conflictingItemIds={conflictingItemIds}
                            isCheckingAvailability={isCheckingAvailability}
                            equipmentMap={equipmentMap}
                        />

                        <div>
                            <Label htmlFor="deposit_amount">–°—É–º–º–∞ –∑–∞–ª–æ–≥–∞ (‚ÇΩ)</Label>
                            <Input id="deposit_amount" type="number" value={deposit} onChange={(e) => setDeposit(e.target.value)} placeholder="0" />
                        </div>
                        <div>
                            <Label htmlFor="prepayment_amount">–ü—Ä–µ–¥–æ–ø–ª–∞—Ç–∞ (‚ÇΩ)</Label>
                            <Input id="prepayment_amount" type="number" value={prepayment} onChange={(e) => setPrepayment(e.target.value)} placeholder="0" />
                        </div>
                        <div>
                            <Label htmlFor="notes_on_issue">–ó–∞–º–µ—Ç–∫–∏ –ø—Ä–∏ –≤—ã–¥–∞—á–µ</Label>
                            <Textarea id="notes_on_issue" value={notes} onChange={(e) => setNotes(e.target.value)} placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: –º–µ–ª–∫–∞—è —Ü–∞—Ä–∞–ø–∏–Ω–∞ –Ω–∞ –∫–æ—Ä–ø—É—Å–µ..." />
                        </div>
                    </div>

                    <DialogFooter>
                        <Button variant="ghost" onClick={onClose}>–û—Ç–º–µ–Ω–∞</Button>
                        <Button onClick={() => handleSubmit(false)} disabled={convertMutation.isPending || isCheckingAvailability || hasConflicts}>
                            {convertMutation.isPending ? "–û–±—Ä–∞–±–æ—Ç–∫–∞..." : "–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å –∏ –≤—ã–¥–∞—Ç—å"}
                        </Button>
                    </DialogFooter>
                </DialogContent>
            </Dialog>

            {/* +++ 6. –î–û–ë–ê–í–õ–Ø–ï–ú –î–ò–ê–õ–û–ì –ü–û–î–¢–í–ï–†–ñ–î–ï–ù–ò–Ø +++ */}
            <ConfirmationDialog
                open={!!holidayConflict}
                onOpenChange={() => setHolidayConflict(null)}
                title="–ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –≤—ã–¥–∞—á–∏"
                description={holidayConflict || ""}
                confirmText="–î–∞, –≤—ã–¥–∞—Ç—å"
                cancelText="–û—Ç–º–µ–Ω–∞"
                onConfirm={handleForceSubmit}
                variant="destructive"
            />
            {/* +++++++++++++++++++++++++++++++++++++++ */}
        </>
    );
}

```


## <a name="rentalappmainsrccomponentsadminCreateReservationDialogtsx"></a>`rental-app-main/src/components/admin/CreateReservationDialog.tsx`

```tsx
// path: rental-app-main/src/components/admin/CreateReservationDialog.tsx

// src/components/admin/CreateReservationDialog.tsx
import { Dialog, DialogContent, DialogHeader, DialogTitle, DialogFooter, DialogDescription } from "@/components/ui/dialog";
import { Button } from "@/components/ui/button";
import { ArrowRight, ArrowLeft } from "lucide-react";
import { useCreateReservationDialog } from "@/hooks/admin/create-reservation/useCreateReservationDialog";
import { CreateReservationStep1Details } from "./CreateReservationStep1Details";
import { CreateReservationStep2Accessories } from "./CreateReservationStep2Accessories";
import FinancialSummaryBlock from "@/components/shared/FinancialSummaryBlock";

interface Props {
    isOpen: boolean;
    onClose: () => void;
}

export default function CreateReservationDialog({ isOpen, onClose }: Props) {
    const {
        step, setStep, form, users, isLoadingUsers, clientPopoverOpen,
        setClientPopoverOpen, equipmentSearch, setEquipmentSearch,
        isLoadingEquipment, filteredAndGroupedEquipment, availabilityMap,
        equipmentWithAccessories, isLoadingAvailability, hasConflictsInSelection,
        isSubmitting, handleNextStep, onSubmit, handleCloseDialog,
        financialData // ‚úÖ 2. –ü–æ–ª—É—á–∞–µ–º –µ–¥–∏–Ω—ã–π –æ–±—ä–µ–∫—Ç —Å —Ñ–∏–Ω–∞–Ω—Å–æ–≤—ã–º–∏ –¥–∞–Ω–Ω—ã–º–∏
    } = useCreateReservationDialog({ isOpen, onClose });

    const { formState: { isValid } } = form;

    const formId = "create-reservation-admin-form";

    return (
        <Dialog open={isOpen} onOpenChange={onClose}>
            <DialogContent className="sm:max-w-[700px] h-[90vh] flex flex-col p-0">
                <DialogHeader className="p-6 pb-4">
                    <DialogTitle>–°–æ–∑–¥–∞—Ç—å –Ω–æ–≤—ã–π —Ä–µ–∑–µ—Ä–≤ (–®–∞–≥ {step === 'details' ? 1 : 2} –∏–∑ 2)</DialogTitle>
                    <DialogDescription>
                        {step === 'details'
                            ? "–í—ã–±–µ—Ä–∏—Ç–µ –∫–ª–∏–µ–Ω—Ç–∞, –¥–∞—Ç—ã –∏ –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏–µ –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è."
                            : "–í—ã–±–µ—Ä–∏—Ç–µ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –∞–∫—Å–µ—Å—Å—É–∞—Ä—ã –¥–ª—è –ø–æ–∑–∏—Ü–∏–π –≤ —Ä–µ–∑–µ—Ä–≤–µ."
                        }
                    </DialogDescription>
                </DialogHeader>

                <div className="flex-1 overflow-y-auto px-6">
                    <form id={formId} onSubmit={onSubmit} className="contents">
                        {step === 'details' ? (
                            <CreateReservationStep1Details
                                form={form}
                                users={users}
                                isLoadingUsers={isLoadingUsers}
                                clientPopoverOpen={clientPopoverOpen}
                                setClientPopoverOpen={setClientPopoverOpen}
                                equipmentSearch={equipmentSearch}
                                setEquipmentSearch={setEquipmentSearch}
                                isLoadingEquipment={isLoadingEquipment}
                                filteredAndGroupedEquipment={filteredAndGroupedEquipment}
                                availabilityMap={availabilityMap}
                            />
                        ) : (
                            <CreateReservationStep2Accessories
                                form={form}
                                equipmentWithAccessories={equipmentWithAccessories}
                            />
                        )}
                    </form>
                </div>

                <DialogFooter className="p-6 pt-4 border-t items-center">
                    {step === 'details' ? (
                        <>
                            {/* –ò—Å–ø–æ–ª—å–∑—É–µ–º —É–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω—ã–π –∫–æ–º–ø–æ–Ω–µ–Ω—Ç –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è —Å–≤–æ–¥–∫–∏ */}
                            <FinancialSummaryBlock
                                priceDetails={financialData.priceDetails}
                                promoCode={financialData.promoCode}
                                setPromoCode={financialData.setPromoCode}
                                applyPromoCode={financialData.applyPromoCode}
                                promoCodeMessage={financialData.promoCodeMessage}
                                isLoading={isLoadingAvailability}
                                isApplyingPromoCode={financialData.isApplyingPromoCode}
                                isSubmitting={isSubmitting}
                                hasConflicts={hasConflictsInSelection}
                                variant="admin"
                                showActions={false}
                            />
                            <Button type="button" variant="ghost" onClick={handleCloseDialog}>–û—Ç–º–µ–Ω–∞</Button>
                            <Button type="button" onClick={handleNextStep} disabled={!isValid || isSubmitting || hasConflictsInSelection || isLoadingAvailability}>
                                {equipmentWithAccessories.length > 0 ? "–î–∞–ª–µ–µ" : "–°–æ–∑–¥–∞—Ç—å —Ä–µ–∑–µ—Ä–≤"}
                                {equipmentWithAccessories.length > 0 && <ArrowRight className="ml-2 h-4 w-4" />}
                            </Button>
                        </>
                    ) : (
                        <>
                            <Button type="button" variant="ghost" onClick={() => setStep('details')} className="mr-auto">
                                <ArrowLeft className="mr-2 h-4 w-4" /> –ù–∞–∑–∞–¥
                            </Button>
                            <Button type="button" variant="ghost" onClick={handleCloseDialog}>–û—Ç–º–µ–Ω–∞</Button>
                            <Button type="submit" form={formId} disabled={isSubmitting}>
                                {isSubmitting ? "–°–æ–∑–¥–∞–Ω–∏–µ..." : "–°–æ–∑–¥–∞—Ç—å —Ä–µ–∑–µ—Ä–≤"}
                            </Button>
                        </>
                    )}
                </DialogFooter>
            </DialogContent>
        </Dialog>
    );
}

```


## <a name="rentalappmainsrccomponentsadminCreateReservationStep1Detailstsx"></a>`rental-app-main/src/components/admin/CreateReservationStep1Details.tsx`

```tsx
// path: rental-app-main/src/components/admin/CreateReservationStep1Details.tsx

// src/components/admin/CreateReservationStep1Details.tsx
import { useState } from "react";
import { Controller, UseFormReturn } from "react-hook-form";
import { Input } from "@/components/ui/input";
import { Label } from "@/components/ui/label";
import { Popover, PopoverContent, PopoverTrigger } from "@/components/ui/popover";
// ‚úÖ –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï: –î–æ–±–∞–≤–ª—è–µ–º CommandInput –≤ –∏–º–ø–æ—Ä—Ç
import { Command, CommandEmpty, CommandGroup, CommandInput, CommandItem, CommandList } from "@/components/ui/command";
import { Button } from "@/components/ui/button";
import { Checkbox } from "@/components/ui/checkbox";
import { Check, ChevronsUpDown, Search, ChevronRight } from "lucide-react";
import type { CreateReservationFormData } from "@/hooks/admin/create-reservation/useCreateReservationForm";
import type { UserOut } from "@/types/user";
import type { Equipment } from "@/types/equipment";
import type { AvailabilityInfo } from "@/types/availability";

const EquipmentNode = ({ item, isChecked, onCheckedChange, availability }: {
    item: Equipment;
    isChecked: boolean;
    onCheckedChange: (checked: boolean) => void;
    availability?: AvailabilityInfo;
}) => {
    const hasConflict = !!availability && availability.status !== 'available';
    const conflictColorClass = availability?.status === 'rented' ? 'bg-red-100' : 'bg-amber-100';
    const hoverClass = hasConflict ? '' : 'hover:bg-gray-50';

    return (
        <div className={`p-2 rounded-md transition-colors ${hasConflict ? conflictColorClass : ''} ${hoverClass}`}>
            <div className="flex items-center justify-between">
                <div className="flex items-center gap-3 flex-1">
                    <Checkbox id={`eq-${item.id}`} checked={isChecked} onCheckedChange={onCheckedChange} />
                    <Label htmlFor={`eq-${item.id}`} className="font-normal w-full cursor-pointer text-sm">{item.brand} {item.name}</Label>
                </div>
                {hasConflict && <span className="text-xs font-medium">{availability?.status === 'rented' ? '–ê—Ä–µ–Ω–¥–∞' : '–†–µ–∑–µ—Ä–≤'}</span>}
            </div>
            {hasConflict && availability?.details && <div className="text-xs text-gray-600 mt-1 pl-8">- {availability.details}</div>}
        </div>
    );
};

interface Props {
    form: UseFormReturn<CreateReservationFormData>;
    users?: UserOut[];
    isLoadingUsers: boolean;
    clientPopoverOpen: boolean;
    setClientPopoverOpen: (isOpen: boolean) => void;
    equipmentSearch: string;
    setEquipmentSearch: (query: string) => void;
    isLoadingEquipment: boolean;
    filteredAndGroupedEquipment: { tree: Record<string, Record<string, Equipment[]>>, visibleIds: number[] };
    availabilityMap: Record<number, AvailabilityInfo>;
}

export const CreateReservationStep1Details = ({
                                                  form, users, isLoadingUsers, clientPopoverOpen, setClientPopoverOpen,
                                                  equipmentSearch, setEquipmentSearch, isLoadingEquipment,
                                                  filteredAndGroupedEquipment, availabilityMap
                                              }: Props) => {
    const { register, control, formState: { errors } } = form;
    const [collapsedSections, setCollapsedSections] = useState<Record<string, boolean>>({});

    const toggleSection = (key: string) => {
        setCollapsedSections(prev => ({ ...prev, [key]: !prev[key] }));
    };

    return (
        <div className="space-y-4">
            <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                    <Label>–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å *</Label>
                    <Controller
                        control={control}
                        name="user_id"
                        render={({ field }) => (
                            <Popover open={clientPopoverOpen} onOpenChange={setClientPopoverOpen}>
                                <PopoverTrigger asChild>
                                    <Button variant="outline" role="combobox" className="w-full justify-between" disabled={isLoadingUsers}>
                                        {field.value ? users?.find(u => u.id === field.value)?.full_name : "–í—ã–±–µ—Ä–∏—Ç–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è..."}
                                        <ChevronsUpDown className="ml-2 h-4 w-4 shrink-0 opacity-50" />
                                    </Button>
                                </PopoverTrigger>
                                <PopoverContent className="w-[--radix-popover-trigger-width] p-0">
                                    <Command>
                                        <CommandInput placeholder="–ü–æ–∏—Å–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è..." />
                                        <CommandList><CommandEmpty>–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã.</CommandEmpty>
                                            <CommandGroup>
                                                {users?.map((user) => (
                                                    <CommandItem key={user.id} value={`${user.full_name} ${user.email}`} onSelect={() => { form.setValue("user_id", user.id, { shouldValidate: true }); setClientPopoverOpen(false); }}>
                                                        <Check className={`mr-2 h-4 w-4 ${field.value === user.id ? "opacity-100" : "opacity-0"}`} />
                                                        {user.full_name}
                                                    </CommandItem>
                                                ))}
                                            </CommandGroup>
                                        </CommandList>
                                    </Command>
                                </PopoverContent>
                            </Popover>
                        )}
                    />
                    {errors.user_id && <p className="text-xs text-red-600 mt-1">{errors.user_id.message}</p>}
                </div>
                <div className="grid grid-cols-2 gap-2">
                    <div><Label htmlFor="start_date">–ù–∞—á–∞–ª–æ *</Label><Input id="start_date" type="date" {...register("start_date")} />{errors.start_date && <p className="text-xs text-red-600 mt-1">{errors.start_date.message}</p>}</div>
                    <div><Label htmlFor="end_date">–û–∫–æ–Ω—á–∞–Ω–∏–µ *</Label><Input id="end_date" type="date" {...register("end_date")} />{errors.end_date && <p className="text-xs text-red-600 mt-1">{errors.end_date.message}</p>}</div>
                </div>
            </div>

            <div className="space-y-2">
                <Label>–û–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏–µ *</Label>
                <div className="relative"><Search className="absolute left-3 top-2.5 h-4 w-4 text-muted-foreground" /><Input placeholder="–ü–æ–∏—Å–∫..." value={equipmentSearch} onChange={(e) => setEquipmentSearch(e.target.value)} className="pl-10" /></div>
                <div className="rounded-md border p-2">
                    {isLoadingEquipment ? <p className="text-center py-4">–ó–∞–≥—Ä—É–∑–∫–∞...</p> : (
                        <Controller name="equipment_ids" control={control}
                                    render={({ field }) => (
                                        <div className="space-y-3">
                                            {Object.keys(filteredAndGroupedEquipment.tree).map(type => {
                                                const isTypeCollapsed = collapsedSections[type];
                                                return (
                                                    <div key={type}>
                                                        <button type="button" onClick={() => toggleSection(type)} className="w-full flex items-center gap-1 font-semibold text-md sticky top-0 bg-white/80 backdrop-blur-sm py-1 cursor-pointer z-10">
                                                            <ChevronRight className={`w-4 h-4 transition-transform ${!isTypeCollapsed ? 'rotate-90' : ''}`} />
                                                            {type}
                                                        </button>
                                                        {!isTypeCollapsed && Object.keys(filteredAndGroupedEquipment.tree[type]).map(brand => {
                                                            const brandKey = `${type}-${brand}`;
                                                            const isBrandCollapsed = collapsedSections[brandKey];
                                                            return (
                                                                <div key={brandKey} className="pl-4">
                                                                    <button type="button" onClick={() => toggleSection(brandKey)} className="w-full flex items-center gap-1 font-medium text-sm text-gray-600 hover:text-black">
                                                                        <ChevronRight className={`w-4 h-4 transition-transform ${!isBrandCollapsed ? 'rotate-90' : ''}`} />
                                                                        {brand}
                                                                    </button>
                                                                    {!isBrandCollapsed && (
                                                                        <div className="space-y-1 pl-4 border-l ml-2 py-1">
                                                                            {filteredAndGroupedEquipment.tree[type][brand].map(item => (
                                                                                <EquipmentNode key={item.id} item={item} availability={availabilityMap[item.id]}
                                                                                               isChecked={field.value?.includes(item.id)}
                                                                                               onCheckedChange={(checked) => field.onChange(checked ? [...field.value, item.id] : field.value.filter(id => id !== item.id))} />
                                                                            ))}
                                                                        </div>
                                                                    )}
                                                                </div>
                                                            )})}
                                                    </div>
                                                )})}
                                        </div>
                                    )}
                        />
                    )}
                </div>
                {errors.equipment_ids && <p className="text-xs text-red-600 mt-1">{errors.equipment_ids.message}</p>}
            </div>
        </div>
    );
};

```


## <a name="rentalappmainsrccomponentsadminCreateReservationStep2Accessoriestsx"></a>`rental-app-main/src/components/admin/CreateReservationStep2Accessories.tsx`

```tsx
// path: rental-app-main/src/components/admin/CreateReservationStep2Accessories.tsx

// src/components/admin/CreateReservationStep2Accessories.tsx
import { Controller, UseFormReturn } from "react-hook-form";
import { Card, CardContent, CardHeader, CardTitle } from "@/components/ui/card";
import { Checkbox } from "@/components/ui/checkbox";
import { Label } from "@/components/ui/label";
import { ScrollArea } from "@/components/ui/scroll-area";
import { Paperclip } from "lucide-react";
import type { CreateReservationFormData } from "@/hooks/admin/create-reservation/useCreateReservationForm";
import type { Equipment } from "@/types/equipment";

interface Props {
    form: UseFormReturn<CreateReservationFormData>;
    equipmentWithAccessories: Equipment[];
}

export const CreateReservationStep2Accessories = ({ form, equipmentWithAccessories }: Props) => {
    const { control } = form;

    return (
        <div className="space-y-4 overflow-hidden flex flex-col flex-1">
            <ScrollArea className="flex-1 -mx-6 px-6">
                <div className="space-y-4 pb-4">
                    {equipmentWithAccessories.map(equipmentItem => (
                        <Card key={equipmentItem.id}>
                            <CardHeader className="pb-2">
                                <CardTitle className="text-base flex items-center gap-2">
                                    <Paperclip className="h-4 w-4" />
                                    {equipmentItem.name}
                                </CardTitle>
                            </CardHeader>
                            <CardContent>
                                <Controller
                                    name={`selected_accessories.${equipmentItem.id}`}
                                    control={control}
                                    render={({ field }) => (
                                        <div className="space-y-2">
                                            {equipmentItem.accessories.map(acc => (
                                                <div key={acc.id} className="flex items-center justify-between hover:bg-slate-50 p-2 rounded">
                                                    <Label htmlFor={`acc-${equipmentItem.id}-${acc.id}`} className="flex items-center gap-2 font-normal cursor-pointer">
                                                        <Checkbox id={`acc-${equipmentItem.id}-${acc.id}`}
                                                                  checked={field.value?.includes(acc.id)}
                                                                  onCheckedChange={(checked) => {
                                                                      const currentIds = field.value || [];
                                                                      const newIds = checked ? [...currentIds, acc.id] : currentIds.filter(id => id !== acc.id);
                                                                      field.onChange(newIds);
                                                                  }}
                                                        />
                                                        {acc.name}
                                                    </Label>
                                                    <span className="text-xs text-muted-foreground">{acc.price} ‚ÇΩ</span>
                                                </div>
                                            ))}
                                        </div>
                                    )}
                                />
                            </CardContent>
                        </Card>
                    ))}
                </div>
            </ScrollArea>
        </div>
    );
};

```


## <a name="rentalappmainsrccomponentsadminDurationDiscountManagertsx"></a>`rental-app-main/src/components/admin/DurationDiscountManager.tsx`

```tsx
// path: rental-app-main/src/components/admin/DurationDiscountManager.tsx

// src/components/admin/DurationDiscountManager.tsx

import { useState, useMemo } from 'react';
import { useDurationDiscounts, useCreateDurationDiscount, useDeleteDurationDiscount } from '@/hooks/useAdminDiscounts';
// +++ –ù–ê–ß–ê–õ–û –ò–ó–ú–ï–ù–ï–ù–ò–ô: –ò—Å–ø—Ä–∞–≤–ª—è–µ–º –∏–º–ø–æ—Ä—Ç —Ç–∏–ø–æ–≤ +++
import type { DiscountPayload, DurationDiscount } from '@/types/discount';
// +++ –ö–û–ù–ï–¶ –ò–ó–ú–ï–ù–ï–ù–ò–ô +++
import { Button } from '@/components/ui/button';
import { Input } from '@/components/ui/input';
import { Table, TableBody, TableCell, TableHead, TableHeader, TableRow } from '@/components/ui/table';
import { PlusCircle, Trash2, Loader2, ChevronLeft, ChevronRight } from 'lucide-react';
import { Alert, AlertDescription, AlertTitle } from "@/components/ui/alert";

const PAGE_SIZE = 10;

export default function DurationDiscountManager() {
    const [currentPage, setCurrentPage] = useState(1);
    const { data: discountResponse, isLoading, isError } = useDurationDiscounts(currentPage, PAGE_SIZE);

    const discounts = useMemo(() => discountResponse?.items ?? [], [discountResponse]);
    const totalDiscounts = useMemo(() => discountResponse?.total ?? 0, [discountResponse]);
    const totalPages = Math.ceil(totalDiscounts / PAGE_SIZE);

    const createMutation = useCreateDurationDiscount();
    const deleteMutation = useDeleteDurationDiscount();

    const [newItem, setNewItem] = useState<DiscountPayload>({ min_days: 0, discount_percentage: 0 });

    const handleCreate = () => {
        if (!newItem.min_days || newItem.min_days <= 0) {
            alert("–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –¥–Ω–µ–π –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å –±–æ–ª—å—à–µ 0.");
            return;
        }
        if (!newItem.discount_percentage || newItem.discount_percentage <= 0) {
            alert("–ü—Ä–æ—Ü–µ–Ω—Ç —Å–∫–∏–¥–∫–∏ –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –±–æ–ª—å—à–µ 0.");
            return;
        }
        createMutation.mutate(newItem, {
            onSuccess: () => setNewItem({ min_days: 0, discount_percentage: 0 })
        });
    };

    if (isLoading) {
        return <div className="flex items-center gap-2 text-gray-500"><Loader2 className="h-4 w-4 animate-spin"/>–ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö –æ —Å–∫–∏–¥–∫–∞—Ö...</div>;
    }

    if (isError) {
        return <Alert variant="destructive"><AlertTitle>–û—à–∏–±–∫–∞!</AlertTitle><AlertDescription>–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –¥–∞–Ω–Ω—ã–µ –æ —Å–∫–∏–¥–∫–∞—Ö.</AlertDescription></Alert>;
    }

    return (
        <div className="space-y-4">
            <div className="border rounded-md">
                <Table>
                    <TableHeader>
                        <TableRow>
                            <TableHead className="w-[40%]">–ú–∏–Ω–∏–º–∞–ª—å–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –¥–Ω–µ–π</TableHead>
                            <TableHead className="w-[40%]">–ü—Ä–æ—Ü–µ–Ω—Ç —Å–∫–∏–¥–∫–∏ (%)</TableHead>
                            <TableHead className="text-right">–î–µ–π—Å—Ç–≤–∏—è</TableHead>
                        </TableRow>
                    </TableHeader>
                    <TableBody>
                        {discounts.map((d: DurationDiscount) => (
                            <TableRow key={d.id}>
                                <TableCell>{d.min_days}</TableCell>
                                <TableCell>{d.discount_percentage}%</TableCell>
                                <TableCell className="text-right">
                                    <Button variant="ghost" size="icon" onClick={() => deleteMutation.mutate(d.id)} disabled={deleteMutation.isPending}>
                                        <Trash2 className="h-4 w-4 text-red-500" />
                                    </Button>
                                </TableCell>
                            </TableRow>
                        ))}
                        <TableRow>
                            <TableCell>
                                <Input type="number" placeholder="–ù–∞–ø—Ä. 7" value={newItem.min_days || ''} onChange={e => setNewItem((p: DiscountPayload) => ({...p, min_days: parseInt(e.target.value, 10) || 0}))} />
                            </TableCell>
                            <TableCell>
                                <Input type="number" placeholder="–ù–∞–ø—Ä. 15" value={newItem.discount_percentage || ''} onChange={e => setNewItem((p: DiscountPayload) => ({...p, discount_percentage: parseInt(e.target.value, 10) || 0}))} />
                            </TableCell>
                            <TableCell className="text-right">
                                <Button size="sm" onClick={handleCreate} disabled={createMutation.isPending}>
                                    {createMutation.isPending ? <Loader2 className="mr-2 h-4 w-4 animate-spin"/> : <PlusCircle className="mr-2 h-4 w-4" />}
                                    –î–æ–±–∞–≤–∏—Ç—å
                                </Button>
                            </TableCell>
                        </TableRow>
                    </TableBody>
                </Table>
            </div>

            <div className="flex items-center justify-end space-x-2 pt-2">
                <span className="text-sm text-muted-foreground">
                    –°—Ç—Ä–∞–Ω–∏—Ü–∞ {currentPage} –∏–∑ {totalPages > 0 ? totalPages : 1}
                </span>
                <Button
                    variant="outline"
                    size="sm"
                    onClick={() => setCurrentPage(prev => Math.max(prev - 1, 1))}
                    disabled={currentPage === 1}
                >
                    <ChevronLeft className="h-4 w-4 mr-1" />
                    –ù–∞–∑–∞–¥
                </Button>
                <Button
                    variant="outline"
                    size="sm"
                    onClick={() => setCurrentPage(prev => Math.min(prev + 1, totalPages))}
                    disabled={currentPage >= totalPages}
                >
                    –í–ø–µ—Ä–µ–¥
                    <ChevronRight className="h-4 w-4 ml-1" />
                </Button>
            </div>

            <p className="text-sm text-gray-600 pt-2">
                <strong>–ö–∞–∫ —ç—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç:</strong> –°–∏—Å—Ç–µ–º–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø—Ä–∏–º–µ–Ω–∏—Ç —Å–∫–∏–¥–∫—É —Å –Ω–∞–∏–±–æ–ª—å—à–∏–º –ø–æ—Ä–æ–≥–æ–º –¥–Ω–µ–π, –∫–æ—Ç–æ—Ä—ã–π –Ω–µ –ø—Ä–µ–≤—ã—à–∞–µ—Ç –æ–±—â–µ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –¥–Ω–µ–π –∞—Ä–µ–Ω–¥—ã.
                <br />
                <em>–ù–∞–ø—Ä–∏–º–µ—Ä, –µ—Å–ª–∏ –µ—Å—Ç—å —Å–∫–∏–¥–∫–∏ –¥–ª—è 3 –∏ 7 –¥–Ω–µ–π, –∞ –∞—Ä–µ–Ω–¥–∞ –Ω–∞ 8 –¥–Ω–µ–π, –±—É–¥–µ—Ç –ø—Ä–∏–º–µ–Ω–µ–Ω–∞ —Å–∫–∏–¥–∫–∞ –¥–ª—è 7 –¥–Ω–µ–π.</em>
            </p>
        </div>
    );
}

```


## <a name="rentalappmainsrccomponentsadminEditableRentalCardtsx"></a>`rental-app-main/src/components/admin/EditableRentalCard.tsx`

```tsx
// path: rental-app-main/src/components/admin/EditableRentalCard.tsx

// components/admin/EditableRentalCard.tsx (–ù–û–í–´–ô –§–ê–ô–õ)

import { Card, CardContent } from "@/components/ui/card";
import { Button } from "@/components/ui/button";
import { Input } from "@/components/ui/input";
import { Label } from "@/components/ui/label";
import { Textarea } from "@/components/ui/textarea";
import { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from "@/components/ui/select";
import { Save, X, Loader2 } from "lucide-react";
import { useAdminRentalEdit } from "@/hooks/admin/useAdminRentalEdit";
import type { AdminRentalOut } from "@/types/reservation";

interface Props {
    rental: AdminRentalOut;
    onCancel: () => void;
}

export default function EditableRentalCard({ rental, onCancel }: Props) {
    const { register, handleSubmit, errors, isValid, isDirty, isSaving } = useAdminRentalEdit({
        rental,
        onSuccess: onCancel, // –ó–∞–∫—Ä—ã–≤–∞–µ–º —Ñ–æ—Ä–º—É –ø—Ä–∏ —É—Å–ø–µ—Ö–µ
    });

    const statusOptions = [
        { value: "active", label: "–ê–∫—Ç–∏–≤–Ω–∞" },
        { value: "overdue", label: "–ü—Ä–æ—Å—Ä–æ—á–µ–Ω–∞" },
        { value: "completed", label: "–ó–∞–≤–µ—Ä—à–µ–Ω–∞" },
    ];

    return (
        <Card className="w-full transition-shadow border-2 border-dashed border-sky-400 bg-sky-50/50">
            <form onSubmit={handleSubmit}>
                <CardContent className="p-4 space-y-4">
                    <h3 className="font-semibold text-lg text-sky-800">–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∞—Ä–µ–Ω–¥—ã #{rental.id}</h3>
                    <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                        {/* –î–∞—Ç—ã */}
                        <div className="space-y-2">
                            <Label htmlFor="end_date">–î–∞—Ç–∞ –≤–æ–∑–≤—Ä–∞—Ç–∞ (–ø–ª–∞–Ω)</Label>
                            <Input id="end_date" type="date" {...register("end_date")} />
                            {errors.end_date && <p className="text-xs text-red-600 mt-1">{errors.end_date.message}</p>}
                        </div>
                        <div className="space-y-2">
                            <Label htmlFor="actual_return_date">–î–∞—Ç–∞ –≤–æ–∑–≤—Ä–∞—Ç–∞ (—Ñ–∞–∫—Ç)</Label>
                            <Input id="actual_return_date" type="date" {...register("actual_return_date")} />
                            {errors.actual_return_date && <p className="text-xs text-red-600 mt-1">{errors.actual_return_date.message}</p>}
                        </div>

                        {/* –°—Ç–∞—Ç—É—Å –∏ –§–∏–Ω–∞–Ω—Å—ã */}
                        <div className="space-y-2">
                            <Label htmlFor="status">–°—Ç–∞—Ç—É—Å</Label>
                            <select id="status" {...register("status")} className="w-full p-2 border rounded-md">
                                {statusOptions.map(opt => <option key={opt.value} value={opt.value}>{opt.label}</option>)}
                            </select>
                        </div>
                        <div className="space-y-2">
                            <Label htmlFor="deposit_amount">–ó–∞–ª–æ–≥ (‚ÇΩ)</Label>
                            <Input id="deposit_amount" type="number" {...register("deposit_amount")} />
                        </div>
                        <div className="space-y-2">
                            <Label htmlFor="final_cost">–ò—Ç–æ–≥–æ–≤–∞—è —Å—Ç–æ–∏–º–æ—Å—Ç—å (‚ÇΩ)</Label>
                            <Input id="final_cost" type="number" {...register("final_cost")} placeholder="–û—Å—Ç–∞–≤—å—Ç–µ –ø—É—Å—Ç—ã–º –¥–ª—è –∞–≤—Ç–æ—Ä–∞—Å—á–µ—Ç–∞" />
                        </div>
                    </div>

                    {/* –ó–∞–º–µ—Ç–∫–∏ */}
                    <div className="space-y-2">
                        <Label htmlFor="notes_on_issue">–ó–∞–º–µ—Ç–∫–∏ –ø—Ä–∏ –≤—ã–¥–∞—á–µ</Label>
                        <Textarea id="notes_on_issue" {...register("notes_on_issue")} rows={2} />
                    </div>
                    <div className="space-y-2">
                        <Label htmlFor="notes_on_return">–ó–∞–º–µ—Ç–∫–∏ –ø—Ä–∏ –≤–æ–∑–≤—Ä–∞—Ç–µ</Label>
                        <Textarea id="notes_on_return" {...register("notes_on_return")} rows={2} />
                    </div>

                    {/* –ö–Ω–æ–ø–∫–∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è */}
                    <div className="flex justify-end gap-2 pt-2 border-t">
                        <Button type="button" variant="ghost" onClick={onCancel} disabled={isSaving}>
                            <X className="mr-2 h-4 w-4" /> –û—Ç–º–µ–Ω–∞
                        </Button>
                        <Button type="submit" disabled={!isValid || !isDirty || isSaving}>
                            {isSaving ? <Loader2 className="mr-2 h-4 w-4 animate-spin" /> : <Save className="mr-2 h-4 w-4" />}
                            –°–æ—Ö—Ä–∞–Ω–∏—Ç—å
                        </Button>
                    </div>
                </CardContent>
            </form>
        </Card>
    );
}

```


## <a name="rentalappmainsrccomponentsadminEquipmentCreateDialogtsx"></a>`rental-app-main/src/components/admin/EquipmentCreateDialog.tsx`

```tsx
// path: rental-app-main/src/components/admin/EquipmentCreateDialog.tsx

// src/components/admin/EquipmentCreateDialog.tsx

import { useMemo } from "react";
import { useForm, Controller } from "react-hook-form";
import { zodResolver } from "@hookform/resolvers/zod";
import { z } from "zod";
import { useCreateEquipment } from "@/hooks/useAdminEquipment";
import { EQUIPMENT_CONDITIONS } from "@/constants/equipmentConstants";

import {
    Dialog,
    DialogContent,
    DialogHeader,
    DialogTitle,
    DialogFooter,
} from "@/components/ui/dialog";
import { Button } from "@/components/ui/button";
import { Input } from "@/components/ui/input";
import { Label } from "@/components/ui/label";
import { Textarea } from "@/components/ui/textarea";
import {
    Select,
    SelectContent,
    SelectItem,
    SelectTrigger,
    SelectValue,
} from "@/components/ui/select";
import type { Equipment } from "@/types/equipment";
import { CreatableSelect } from "@/components/ui/CreatableSelect";

const equipmentCreateSchema = z.object({
    equipment_type: z.string().min(1, "–¢–∏–ø –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—è –æ–±—è–∑–∞—Ç–µ–ª–µ–Ω"),
    brand: z.string().min(1, "–ë—Ä–µ–Ω–¥ –æ–±—è–∑–∞—Ç–µ–ª–µ–Ω"),
    name: z.string().min(1, "–ù–∞–∑–≤–∞–Ω–∏–µ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ"),
    serial_number: z.string().optional(),
    condition: z.string().min(1, "–°–æ—Å—Ç–æ—è–Ω–∏–µ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ"),
    daily_rate: z.number().min(0, "–¢–∞—Ä–∏—Ñ –Ω–µ –º–æ–∂–µ—Ç –±—ã—Ç—å –æ—Ç—Ä–∏—Ü–∞—Ç–µ–ª—å–Ω—ã–º"),
    notes: z.string().optional(),
    description: z.string().optional(),
    last_maintenance: z.string().optional(),
});

type EquipmentCreateFormData = z.infer<typeof equipmentCreateSchema>;

interface EquipmentCreateDialogProps {
    open: boolean;
    onClose: () => void;
    equipment: Equipment[];
}

export default function EquipmentCreateDialog({
                                                  open,
                                                  onClose,
                                                  equipment
                                              }: EquipmentCreateDialogProps) {
    const createEquipmentMutation = useCreateEquipment();

    const {
        register,
        handleSubmit,
        formState: { errors, isValid },
        reset,
        setValue,
        control,
    } = useForm<EquipmentCreateFormData>({
        resolver: zodResolver(equipmentCreateSchema),
        defaultValues: {
            condition: "–í–µ–ª–∏–∫–æ–ª–µ–ø–Ω–æ",
            daily_rate: 0,
        },
        mode: "onChange",
    });

    const equipmentTypes = useMemo(() => {
        const types = new Set(equipment.map(e => e.equipment_type));
        return Array.from(types).sort((a,b) => a.localeCompare(b));
    }, [equipment]);

    const equipmentBrands = useMemo(() => {
        const brands = new Set(equipment.map(e => e.brand));
        return Array.from(brands).sort((a,b) => a.localeCompare(b));
    }, [equipment]);

    const onSubmit = async (data: EquipmentCreateFormData) => {
        try {
            await createEquipmentMutation.mutateAsync(data);
            reset();
            onClose();
        } catch (error) {
            // –û—à–∏–±–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∞–µ—Ç—Å—è –≤ —Ö—É–∫–µ
        }
    };

    const handleClose = () => {
        reset();
        onClose();
    };

    return (
        <Dialog open={open} onOpenChange={handleClose}>
            <DialogContent className="max-w-2xl max-h-[90vh] overflow-y-auto">
                <DialogHeader>
                    <DialogTitle>–î–æ–±–∞–≤–∏—Ç—å –Ω–æ–≤–æ–µ –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏–µ</DialogTitle>
                </DialogHeader>

                <form onSubmit={handleSubmit(onSubmit)} className="space-y-4">
                    <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                        {/* –¢–∏–ø –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—è */}
                        <div>
                            <Label htmlFor="equipment_type">–¢–∏–ø –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—è *</Label>
                            <Controller
                                name="equipment_type"
                                control={control}
                                render={({ field }) => (
                                    <CreatableSelect
                                        value={field.value}
                                        onChange={field.onChange}
                                        options={equipmentTypes}
                                        placeholder="–í—ã–±–µ—Ä–∏—Ç–µ –∏–ª–∏ —Å–æ–∑–¥–∞–π—Ç–µ —Ç–∏–ø"
                                        dialogTitle="–ù–æ–≤—ã–π —Ç–∏–ø –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—è"
                                        dialogDescription="–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –¥–ª—è –Ω–æ–≤–æ–≥–æ —Ç–∏–ø–∞."
                                        dialogLabel="–ù–∞–∑–≤–∞–Ω–∏–µ"
                                    />
                                )}
                            />
                            {errors.equipment_type && (
                                <p className="text-xs text-red-600 mt-1">
                                    {errors.equipment_type.message}
                                </p>
                            )}
                        </div>

                        {/* –ë—Ä–µ–Ω–¥ */}
                        <div>
                            <Label htmlFor="brand">–ë—Ä–µ–Ω–¥ *</Label>
                            <Controller
                                name="brand"
                                control={control}
                                render={({ field }) => (
                                    <CreatableSelect
                                        value={field.value}
                                        onChange={field.onChange}
                                        options={equipmentBrands}
                                        placeholder="–í—ã–±–µ—Ä–∏—Ç–µ –∏–ª–∏ —Å–æ–∑–¥–∞–π—Ç–µ –±—Ä–µ–Ω–¥"
                                        dialogTitle="–ù–æ–≤—ã–π –±—Ä–µ–Ω–¥"
                                        dialogDescription="–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –¥–ª—è –Ω–æ–≤–æ–≥–æ –±—Ä–µ–Ω–¥–∞."
                                        dialogLabel="–ù–∞–∑–≤–∞–Ω–∏–µ"
                                    />
                                )}
                            />
                            {errors.brand && (
                                <p className="text-xs text-red-600 mt-1">
                                    {errors.brand.message}
                                </p>
                            )}
                        </div>
                    </div>

                    <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                        {/* –ù–∞–∑–≤–∞–Ω–∏–µ */}
                        <div>
                            <Label htmlFor="name">–ù–∞–∑–≤–∞–Ω–∏–µ *</Label>
                            <Input
                                id="name"
                                {...register("name")}
                                placeholder="EOS R5, MacBook Pro 14..."
                            />
                            {errors.name && (
                                <p className="text-xs text-red-600 mt-1">
                                    {errors.name.message}
                                </p>
                            )}
                        </div>

                        {/* –°–µ—Ä–∏–π–Ω—ã–π –Ω–æ–º–µ—Ä */}
                        <div>
                            <Label htmlFor="serial_number">–°–µ—Ä–∏–π–Ω—ã–π –Ω–æ–º–µ—Ä</Label>
                            <Input
                                id="serial_number"
                                {...register("serial_number")}
                                placeholder="–ù–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ"
                            />
                        </div>
                    </div>

                    <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                        {/* –°–æ—Å—Ç–æ—è–Ω–∏–µ */}
                        <div>
                            <Label htmlFor="condition">–°–æ—Å—Ç–æ—è–Ω–∏–µ *</Label>
                            <Select
                                onValueChange={(value) => setValue("condition", value, { shouldValidate: true })}
                                defaultValue="–í–µ–ª–∏–∫–æ–ª–µ–ø–Ω–æ"
                            >
                                <SelectTrigger>
                                    <SelectValue placeholder="–í—ã–±–µ—Ä–∏—Ç–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ" />
                                </SelectTrigger>
                                <SelectContent>
                                    {EQUIPMENT_CONDITIONS.map((condition) => (
                                        <SelectItem key={condition} value={condition}>
                                            {condition}
                                        </SelectItem>
                                    ))}
                                </SelectContent>
                            </Select>
                            {errors.condition && (
                                <p className="text-xs text-red-600 mt-1">
                                    {errors.condition.message}
                                </p>
                            )}
                        </div>

                        {/* –¢–∞—Ä–∏—Ñ –∑–∞ –¥–µ–Ω—å */}
                        <div>
                            <Label htmlFor="daily_rate">–¢–∞—Ä–∏—Ñ –∑–∞ –¥–µ–Ω—å (‚ÇΩ) *</Label>
                            <Input
                                id="daily_rate"
                                type="number"
                                step="0.01"
                                min="0"
                                {...register("daily_rate", { valueAsNumber: true })}
                                placeholder="0"
                            />
                            {errors.daily_rate && (
                                <p className="text-xs text-red-600 mt-1">
                                    {errors.daily_rate.message}
                                </p>
                            )}
                        </div>
                    </div>

                    {/* –î–∞—Ç–∞ –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ –¢–û */}
                    <div>
                        <Label htmlFor="last_maintenance">–î–∞—Ç–∞ –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ –¢–û</Label>
                        <Input
                            id="last_maintenance"
                            type="date"
                            {...register("last_maintenance")}
                        />
                    </div>

                    {/* –û–ø–∏—Å–∞–Ω–∏–µ */}
                    <div>
                        <Label htmlFor="description">–û–ø–∏—Å–∞–Ω–∏–µ</Label>
                        <Textarea
                            id="description"
                            {...register("description")}
                            placeholder="–ü–æ–¥—Ä–æ–±–Ω–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—è, –µ–≥–æ –æ—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏..."
                            rows={3}
                        />
                    </div>

                    {/* –ó–∞–º–µ—Ç–∫–∏ */}
                    <div>
                        <Label htmlFor="notes">–ó–∞–º–µ—Ç–∫–∏ (–≤–∏–¥–Ω—ã —Ç–æ–ª—å–∫–æ –ø–µ—Ä—Å–æ–Ω–∞–ª—É)</Label>
                        <Textarea
                            id="notes"
                            {...register("notes")}
                            placeholder="–í–Ω—É—Ç—Ä–µ–Ω–Ω–∏–µ –∑–∞–º–µ—Ç–∫–∏ –æ —Å–æ—Å—Ç–æ—è–Ω–∏–∏, –æ—Å–æ–±–µ–Ω–Ω–æ—Å—Ç—è—Ö..."
                            rows={2}
                        />
                    </div>

                    <DialogFooter className="pt-4">
                        <Button type="button" variant="outline" onClick={handleClose}>
                            –û—Ç–º–µ–Ω–∞
                        </Button>
                        <Button
                            type="submit"
                            disabled={!isValid || createEquipmentMutation.isPending}
                        >
                            {createEquipmentMutation.isPending ? "–°–æ–∑–¥–∞–Ω–∏–µ..." : "–°–æ–∑–¥–∞—Ç—å –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏–µ"}
                        </Button>
                    </DialogFooter>
                </form>
            </DialogContent>
        </Dialog>
    );
}

```


## <a name="rentalappmainsrccomponentsadminEquipmentEditDialogtsx"></a>`rental-app-main/src/components/admin/EquipmentEditDialog.tsx`

```tsx
// path: rental-app-main/src/components/admin/EquipmentEditDialog.tsx

// src/components/admin/EquipmentEditDialog.tsx

import { Dialog, DialogContent, DialogHeader, DialogTitle } from "@/components/ui/dialog";
import EquipmentEditForm from "@/components/equipment/EquipmentEditForm";
import type { Equipment } from "@/types/equipment";

interface Props {
    open: boolean;
    onClose: () => void;
    equipment: Equipment;
}

export default function EquipmentEditDialog({ open, onClose, equipment }: Props) {
    const handleSuccess = () => {
        onClose();
    };

    return (
        <Dialog open={open} onOpenChange={onClose} modal={false}>
            <DialogContent className="max-w-2xl">
                <DialogHeader>
                    <DialogTitle>–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—è</DialogTitle>
                </DialogHeader>
                <EquipmentEditForm
                    equipment={equipment}
                    onSuccess={handleSuccess}
                    onCancel={onClose}
                />
            </DialogContent>
        </Dialog>
    );
}

```


## <a name="rentalappmainsrccomponentsadminEquipmentStatstsx"></a>`rental-app-main/src/components/admin/EquipmentStats.tsx`

```tsx
// path: rental-app-main/src/components/admin/EquipmentStats.tsx

// src/components/admin/EquipmentStats.tsx
import { useMemo } from 'react';
import type { Equipment } from "@/types/equipment";

interface Props {
    equipment: Equipment[];
}

export const EquipmentStats = ({ equipment }: Props) => {
    const stats = useMemo(() => {
        const totalCount = equipment.length;
        if (totalCount === 0) {
            return { totalCount: 0, typesCount: 0, brandsCount: 0, avgRate: 0 };
        }
        return {
            totalCount,
            typesCount: new Set(equipment.map(item => item.equipment_type)).size,
            brandsCount: new Set(equipment.map(item => item.brand)).size,
            avgRate: Math.round(equipment.reduce((sum, item) => sum + item.daily_rate, 0) / totalCount),
        };
    }, [equipment]);

    return (
        <div className="grid grid-cols-2 sm:grid-cols-4 gap-4 pt-4 border-t">
            <div className="text-center">
                <div className="text-2xl font-bold">{stats.totalCount}</div>
                <div className="text-sm text-muted-foreground">–í—Å–µ–≥–æ –µ–¥–∏–Ω–∏—Ü</div>
            </div>
            <div className="text-center">
                <div className="text-2xl font-bold">{stats.typesCount}</div>
                <div className="text-sm text-muted-foreground">–¢–∏–ø–æ–≤</div>
            </div>
            <div className="text-center">
                <div className="text-2xl font-bold">{stats.brandsCount}</div>
                <div className="text-sm text-muted-foreground">–ë—Ä–µ–Ω–¥–æ–≤</div>
            </div>
            <div className="text-center">
                <div className="text-2xl font-bold">{stats.avgRate.toLocaleString()} ‚ÇΩ</div>
                <div className="text-sm text-muted-foreground">–°—Ä–µ–¥–Ω–∏–π —Ç–∞—Ä–∏—Ñ</div>
            </div>
        </div>
    );
};

```


## <a name="rentalappmainsrccomponentsadminEquipmentTabletsx"></a>`rental-app-main/src/components/admin/EquipmentTable.tsx`

```tsx
// path: rental-app-main/src/components/admin/EquipmentTable.tsx

// src/components/admin/EquipmentTable.tsx

import { useState } from "react";
import { Table, TableBody, TableHead, TableHeader, TableRow } from "@/components/ui/table";
import { Package, PackageSearch, Loader2 } from "lucide-react"; // ‚úÖ –î–æ–±–∞–≤–ª–µ–Ω –∏–º–ø–æ—Ä—Ç Loader2
import { Button } from "@/components/ui/button"; // ‚úÖ –î–æ–±–∞–≤–ª–µ–Ω –∏–º–ø–æ—Ä—Ç Button
import EquipmentCreateDialog from "./EquipmentCreateDialog";
import { useEquipmentTableLogic } from "@/hooks/admin/useEquipmentTableLogic";
import { EquipmentTableToolbar } from "./EquipmentTableToolbar";
import { EquipmentTableRow } from "./EquipmentTableRow";
import { EquipmentStats } from "./EquipmentStats";
import type { Equipment } from "@/types/equipment";

interface EquipmentTableProps {
    onEditEquipment?: (equipment: Equipment) => void;
    equipment: Equipment[];
    // ‚úÖ –ù–ê–ß–ê–õ–û: –î–æ–±–∞–≤–ª—è–µ–º –Ω–æ–≤—ã–µ —Å–≤–æ–π—Å—Ç–≤–∞ –¥–ª—è –ø–∞–≥–∏–Ω–∞—Ü–∏–∏
    hasNextPage?: boolean;
    isFetchingNextPage?: boolean;
    onLoadMore: () => void;
    // ‚úÖ –ö–û–ù–ï–¶: –ù–æ–≤—ã–µ —Å–≤–æ–π—Å—Ç–≤–∞ –¥–ª—è –ø–∞–≥–∏–Ω–∞—Ü–∏–∏
}

export default function EquipmentTable({
                                           onEditEquipment,
                                           equipment,
                                           hasNextPage,
                                           isFetchingNextPage,
                                           onLoadMore
                                       }: EquipmentTableProps) {
    const [showCreateDialog, setShowCreateDialog] = useState(false);

    const {
        isManager,
        isLoading,
        error,
        filteredEquipment,
        searchQuery,
        selectedIds,
        deleteEquipmentMutation,
        bulkDeleteMutation,
        handlers,
    } = useEquipmentTableLogic(equipment);

    if (isLoading) return <div className="flex justify-center p-4">–ó–∞–≥—Ä—É–∑–∫–∞ –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—è...</div>;
    if (error) return <div className="flex justify-center p-4 text-red-500">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—è</div>;

    return (
        <div className="space-y-4">
            <EquipmentTableToolbar
                searchQuery={searchQuery}
                onSearchChange={handlers.setSearchQuery}
                onAdd={() => setShowCreateDialog(true)}
                onBulkDelete={handlers.handleBulkDelete}
                selectedCount={selectedIds.length}
                totalCount={equipment.length}
                filteredCount={filteredEquipment.length}
                isManager={isManager}
                isDeleting={bulkDeleteMutation.isPending}
            />

            {filteredEquipment.length > 0 ? (
                <div className="border rounded-md">
                    <Table>
                        <TableHeader>
                            <TableRow>
                                {isManager && <TableHead className="w-12"></TableHead>}
                                <TableHead><Package className="inline mr-2 h-4 w-4" />–¢–∏–ø</TableHead>
                                <TableHead>–ë—Ä–µ–Ω–¥</TableHead>
                                <TableHead>–ù–∞–∑–≤–∞–Ω–∏–µ</TableHead>
                                <TableHead>–°–µ—Ä–∏–π–Ω—ã–π –Ω–æ–º–µ—Ä</TableHead>
                                <TableHead>–°–æ—Å—Ç–æ—è–Ω–∏–µ</TableHead>
                                <TableHead>–¢–∞—Ä–∏—Ñ/–¥–µ–Ω—å</TableHead>
                                {isManager && <TableHead>–î–µ–π—Å—Ç–≤–∏—è</TableHead>}
                            </TableRow>
                        </TableHeader>
                        <TableBody>
                            {filteredEquipment.map((item) => (
                                <EquipmentTableRow
                                    key={item.id}
                                    item={item}
                                    isSelected={selectedIds.includes(item.id)}
                                    isManager={isManager}
                                    isDeleting={deleteEquipmentMutation.isPending}
                                    onSelectItem={handlers.handleSelectItem}
                                    onEdit={onEditEquipment!}
                                    onDelete={handlers.handleDelete}
                                />
                            ))}
                        </TableBody>
                    </Table>
                </div>
            ) : (
                <div className="text-center py-12 px-4 border rounded-md">
                    <PackageSearch className="w-16 h-16 text-gray-300 mx-auto mb-3" />
                    <h3 className="text-lg font-semibold text-gray-700">–û–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏–µ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ</h3>
                    <p className="text-sm text-gray-500 max-w-sm">
                        {searchQuery ? "–ü–æ–ø—Ä–æ–±—É–π—Ç–µ –∏–∑–º–µ–Ω–∏—Ç—å –ø–æ–∏—Å–∫–æ–≤—ã–π –∑–∞–ø—Ä–æ—Å." : "–î–æ–±–∞–≤—å—Ç–µ –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏–µ, —á—Ç–æ–±—ã –æ–Ω–æ –ø–æ—è–≤–∏–ª–æ—Å—å –≤ —Å–ø–∏—Å–∫–µ."}
                    </p>
                </div>
            )}

            {/* ‚úÖ –ù–ê–ß–ê–õ–û: –ë–ª–æ–∫ —Å –∫–Ω–æ–ø–∫–æ–π –ø–∞–≥–∏–Ω–∞—Ü–∏–∏ */}
            {hasNextPage && (
                <div className="flex justify-center pt-2">
                    <Button
                        variant="outline"
                        onClick={onLoadMore}
                        disabled={isFetchingNextPage}
                    >
                        {isFetchingNextPage ? (
                            <>
                                <Loader2 className="mr-2 h-4 w-4 animate-spin" />
                                –ó–∞–≥—Ä—É–∑–∫–∞...
                            </>
                        ) : (
                            "–ó–∞–≥—Ä—É–∑–∏—Ç—å –µ—â—ë"
                        )}
                    </Button>
                </div>
            )}
            {/* ‚úÖ –ö–û–ù–ï–¶: –ë–ª–æ–∫ —Å –∫–Ω–æ–ø–∫–æ–π –ø–∞–≥–∏–Ω–∞—Ü–∏–∏ */}

            <EquipmentStats equipment={equipment} />

            <EquipmentCreateDialog
                open={showCreateDialog}
                onClose={() => setShowCreateDialog(false)}
                equipment={equipment}
            />
        </div>
    );
}

```


## <a name="rentalappmainsrccomponentsadminEquipmentTableRowtsx"></a>`rental-app-main/src/components/admin/EquipmentTableRow.tsx`

```tsx
// path: rental-app-main/src/components/admin/EquipmentTableRow.tsx

// src/components/admin/EquipmentTableRow.tsx

import { TableCell, TableRow } from "@/components/ui/table";
import { Checkbox } from "@/components/ui/checkbox";
import { Button } from "@/components/ui/button";
import { Edit, Trash2 } from "lucide-react";
import type { Equipment } from "@/types/equipment";
import { getConditionVariantClass } from "@/constants/equipmentConstants";

interface Props {
    item: Equipment;
    isSelected: boolean;
    isManager: boolean;
    isDeleting: boolean;
    onSelectItem: (id: number, checked: boolean) => void;
    onEdit: (item: Equipment) => void;
    onDelete: (id: number) => void;
}

export const EquipmentTableRow = ({ item, isSelected, isManager, isDeleting, onSelectItem, onEdit, onDelete }: Props) => (
    <TableRow>
        {isManager && (
            <TableCell>
                <Checkbox
                    checked={isSelected}
                    onCheckedChange={(checked) => onSelectItem(item.id, Boolean(checked))}
                />
            </TableCell>
        )}
        <TableCell className="font-medium">{item.equipment_type}</TableCell>
        <TableCell>{item.brand}</TableCell>
        <TableCell>{item.name}</TableCell>
        <TableCell>{item.serial_number || "‚Äî"}</TableCell>
        <TableCell>
            {/* ‚úÖ –ò–ó–ú–ï–ù–ï–ù–ò–ï: –ò—Å–ø–æ–ª—å–∑—É–µ–º –∏–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω–Ω—É—é —Ñ—É–Ω–∫—Ü–∏—é */}
            <span className={`text-xs px-2 py-1 rounded-full font-medium ${getConditionVariantClass(item.condition)}`}>
                {item.condition}
            </span>
        </TableCell>
        <TableCell className="font-medium">{item.daily_rate.toLocaleString()} ‚ÇΩ</TableCell>
        {isManager && (
            <TableCell>
                <div className="flex gap-2">
                    <Button variant="outline" size="icon" onClick={() => onEdit(item)}>
                        <Edit className="h-4 w-4" />
                    </Button>
                    <Button variant="destructive" size="icon" onClick={() => onDelete(item.id)} disabled={isDeleting}>
                        <Trash2 className="h-4 w-4" />
                    </Button>
                </div>
            </TableCell>
        )}
    </TableRow>
);

```


## <a name="rentalappmainsrccomponentsadminEquipmentTableToolbartsx"></a>`rental-app-main/src/components/admin/EquipmentTableToolbar.tsx`

```tsx
// path: rental-app-main/src/components/admin/EquipmentTableToolbar.tsx

// src/components/admin/EquipmentTableToolbar.tsx
import { Button } from "@/components/ui/button";
import { Input } from "@/components/ui/input";
import { Plus, Search, Trash2 } from "lucide-react";

interface Props {
    searchQuery: string;
    onSearchChange: (value: string) => void;
    onAdd: () => void;
    onBulkDelete: () => void;
    selectedCount: number;
    totalCount: number;
    filteredCount: number;
    isManager: boolean;
    isDeleting: boolean;
}

export const EquipmentTableToolbar = ({
                                          searchQuery,
                                          onSearchChange,
                                          onAdd,
                                          onBulkDelete,
                                          selectedCount,
                                          totalCount,
                                          filteredCount,
                                          isManager,
                                          isDeleting
                                      }: Props) => (
    <div className="flex flex-col sm:flex-row gap-4 items-start sm:items-center justify-between">
        <div className="relative flex-1 w-full sm:w-auto sm:max-w-sm">
            <Search className="absolute left-3 top-2.5 h-4 w-4 text-muted-foreground" />
            <Input
                placeholder="–ü–æ–∏—Å–∫ –ø–æ –Ω–∞–∑–≤–∞–Ω–∏—é, –±—Ä–µ–Ω–¥—É, —Ç–∏–ø—É..."
                value={searchQuery}
                onChange={(e) => onSearchChange(e.target.value)}
                className="pl-10"
            />
        </div>
        <div className="flex flex-col sm:flex-row gap-2 items-stretch sm:items-center w-full sm:w-auto">
            <span className="text-sm text-muted-foreground text-center sm:text-left">
                –ù–∞–π–¥–µ–Ω–æ: {filteredCount} –∏–∑ {totalCount}
            </span>
            {selectedCount > 0 && isManager && (
                <Button variant="destructive" size="sm" onClick={onBulkDelete} disabled={isDeleting}>
                    <Trash2 className="h-4 w-4 mr-2" />
                    –£–¥–∞–ª–∏—Ç—å ({selectedCount})
                </Button>
            )}
            {isManager && (
                <Button onClick={onAdd} size="sm" className="flex items-center gap-2">
                    <Plus className="h-4 w-4" />
                    –î–æ–±–∞–≤–∏—Ç—å –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏–µ
                </Button>
            )}
        </div>
    </div>
);

```


## <a name="rentalappmainsrccomponentsadminHolidayManagertsx"></a>`rental-app-main/src/components/admin/HolidayManager.tsx`

```tsx
// path: rental-app-main/src/components/admin/HolidayManager.tsx

// src/components/admin/HolidayManager.tsx

import { useState, useMemo } from 'react';
import { DayPicker } from 'react-day-picker';
import { ru } from 'date-fns/locale';
import { format, startOfMonth, endOfMonth } from 'date-fns';
import { useHolidays, useCreateHoliday, useDeleteHoliday, type HolidayWithDate } from '@/hooks/useAdminHolidays';
import { useGetHolidayRules, useCreateWeeklyRule, useImportPublicHolidays, useDeleteHolidayRule } from '@/hooks/useAdminHolidayRules';

import { Button } from '@/components/ui/button';
import { Input } from '@/components/ui/input';
import { Trash2, CalendarPlus, Globe, Repeat } from 'lucide-react';
import { Dialog, DialogContent, DialogHeader, DialogTitle, DialogFooter, DialogDescription } from "@/components/ui/dialog";
import { toast } from 'sonner';
import { Card, CardContent, CardHeader, CardTitle, CardDescription } from "@/components/ui/card";
import { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from "@/components/ui/select";
import { Label } from "@/components/ui/label";
import { Table, TableBody, TableCell, TableHead, TableHeader, TableRow } from "@/components/ui/table";

type ConflictInfo = {
    date: Date;
    description: string;
    conflicting_reservation_ids: number[];
};

// --- –ù–æ–≤—ã–π –∫–æ–º–ø–æ–Ω–µ–Ω—Ç –¥–ª—è —Ñ–æ—Ä–º—ã –µ–∂–µ–Ω–µ–¥–µ–ª—å–Ω—ã—Ö –ø—Ä–∞–≤–∏–ª ---
function WeeklyRuleForm({ isLoading }: { isLoading: boolean }) {
    const [dayOfWeek, setDayOfWeek] = useState<string>("6"); // 6 = –í–æ—Å–∫—Ä–µ—Å–µ–Ω—å–µ
    const [startDate, setStartDate] = useState<string>(format(new Date(), 'yyyy-MM-dd'));
    const [endDate, setEndDate] = useState<string>(`${new Date().getFullYear()}-12-31`);
    const createRuleMutation = useCreateWeeklyRule();

    const daysOfWeek = [
        { label: "–ü–æ–Ω–µ–¥–µ–ª—å–Ω–∏–∫", value: "0" },
        { label: "–í—Ç–æ—Ä–Ω–∏–∫", value: "1" },
        { label: "–°—Ä–µ–¥–∞", value: "2" },
        { label: "–ß–µ—Ç–≤–µ—Ä–≥", value: "3" },
        { label: "–ü—è—Ç–Ω–∏—Ü–∞", value: "4" },
        { label: "–°—É–±–±–æ—Ç–∞", value: "5" },
        { label: "–í–æ—Å–∫—Ä–µ—Å–µ–Ω—å–µ", value: "6" },
    ];

    const handleSubmit = (e: React.FormEvent) => {
        e.preventDefault();
        const selectedDay = daysOfWeek.find(d => d.value === dayOfWeek);
        createRuleMutation.mutate({
            day_of_week: parseInt(dayOfWeek, 10),
            start_date: new Date(startDate),
            end_date: new Date(endDate),
            description: `–ï–∂–µ–Ω–µ–¥–µ–ª—å–Ω—ã–π –≤—ã—Ö–æ–¥–Ω–æ–π: ${selectedDay?.label}`
        });
    };

    return (
        <Card>
            <CardHeader>
                <CardTitle className="flex items-center gap-2"><Repeat className="w-5 h-5" /> –ï–∂–µ–Ω–µ–¥–µ–ª—å–Ω—ã–µ –≤—ã—Ö–æ–¥–Ω—ã–µ</CardTitle>
                <CardDescription>–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å–¥–µ–ª–∞—Ç—å –≤—ã—Ö–æ–¥–Ω—ã–º–∏ –≤—Å–µ –≤—ã–±—Ä–∞–Ω–Ω—ã–µ –¥–Ω–∏ –Ω–µ–¥–µ–ª–∏ –≤ –ø–µ—Ä–∏–æ–¥–µ.</CardDescription>
            </CardHeader>
            <CardContent>
                <form onSubmit={handleSubmit} className="space-y-4">
                    <div className="grid grid-cols-1 sm:grid-cols-3 gap-4">
                        <div>
                            <Label>–î–µ–Ω—å –Ω–µ–¥–µ–ª–∏</Label>
                            <Select value={dayOfWeek} onValueChange={setDayOfWeek}>
                                <SelectTrigger><SelectValue /></SelectTrigger>
                                <SelectContent>
                                    {daysOfWeek.map(day => (
                                        <SelectItem key={day.value} value={day.value}>{day.label}</SelectItem>
                                    ))}
                                </SelectContent>
                            </Select>
                        </div>
                        <div>
                            <Label>–ù–∞—á–∏–Ω–∞—è —Å</Label>
                            <Input type="date" value={startDate} onChange={e => setStartDate(e.target.value)} />
                        </div>
                        <div>
                            <Label>–ó–∞–∫–∞–Ω—á–∏–≤–∞—è</Label>
                            <Input type="date" value={endDate} onChange={e => setEndDate(e.target.value)} />
                        </div>
                    </div>
                    <Button type="submit" disabled={isLoading || createRuleMutation.isPending} className="w-full sm:w-auto">
                        {createRuleMutation.isPending ? "–°–æ–∑–¥–∞–Ω–∏–µ..." : "–°–æ–∑–¥–∞—Ç—å –ø—Ä–∞–≤–∏–ª–æ"}
                    </Button>
                </form>
            </CardContent>
        </Card>
    );
}

// --- –ù–æ–≤—ã–π –∫–æ–º–ø–æ–Ω–µ–Ω—Ç –¥–ª—è —Ñ–æ—Ä–º—ã –∏–º–ø–æ—Ä—Ç–∞ ---
function PublicHolidayImportForm({ isLoading }: { isLoading: boolean }) {
    const [year, setYear] = useState<number>(new Date().getFullYear());
    const [countryCode, setCountryCode] = useState<string>("RU");
    const importMutation = useImportPublicHolidays();

    const handleSubmit = (e: React.FormEvent) => {
        e.preventDefault();
        importMutation.mutate({ year, country_code: countryCode });
    };

    return (
        <Card>
            <CardHeader>
                <CardTitle className="flex items-center gap-2"><Globe className="w-5 h-5" /> –ò–º–ø–æ—Ä—Ç –≥–æ—Å. –ø—Ä–∞–∑–¥–Ω–∏–∫–æ–≤</CardTitle>
                <CardDescription>–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –¥–æ–±–∞–≤–∏—Ç—å –æ—Ñ–∏—Ü–∏–∞–ª—å–Ω—ã–µ –ø—Ä–∞–∑–¥–Ω–∏–∫–∏ –¥–ª—è —Å—Ç—Ä–∞–Ω—ã.</CardDescription>
            </CardHeader>
            <CardContent>
                <form onSubmit={handleSubmit} className="flex flex-col sm:flex-row items-end gap-4">
                    <div className="flex-grow">
                        <Label>–ì–æ–¥</Label>
                        <Input type="number" value={year} onChange={e => setYear(parseInt(e.target.value, 10))} />
                    </div>
                    <div className="flex-grow">
                        <Label>–ö–æ–¥ —Å—Ç—Ä–∞–Ω—ã (ISO 3166-1)</Label>
                        <Input value={countryCode} onChange={e => setCountryCode(e.target.value.toUpperCase())} placeholder="RU" />
                    </div>
                    <Button type="submit" disabled={isLoading || importMutation.isPending}>
                        {importMutation.isPending ? "–ò–º–ø–æ—Ä—Ç..." : "–ò–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å"}
                    </Button>
                </form>
            </CardContent>
        </Card>
    );
}


// --- –û—Å–Ω–æ–≤–Ω–æ–π –∫–æ–º–ø–æ–Ω–µ–Ω—Ç HolidayManager ---
export default function HolidayManager() {
    const [month, setMonth] = useState(new Date());
    const [description, setDescription] = useState("");
    const [conflict, setConflict] = useState<ConflictInfo | null>(null);

    const startDate = startOfMonth(month);
    const endDate = endOfMonth(month);

    const { data: holidays = [], isLoading: isLoadingHolidays } = useHolidays(startDate, endDate);
    const createMutation = useCreateHoliday();
    const deleteMutation = useDeleteHoliday();

    const { data: rules = [], isLoading: isLoadingRules } = useGetHolidayRules();
    const deleteRuleMutation = useDeleteHolidayRule();

    const holidayDates = useMemo(() => holidays.map((h: HolidayWithDate) => h.date), [holidays]);
    const holidaySet = useMemo(() => new Set(holidays.map((h: HolidayWithDate) => format(h.date, "yyyy-MM-dd"))), [holidays]);

    const handleDaySelect = (day: Date | undefined) => {
        if (!day) return;

        if (holidaySet.has(format(day, "yyyy-MM-dd"))) {
            toast.info("–≠—Ç–æ—Ç –¥–µ–Ω—å —É–∂–µ —è–≤–ª—è–µ—Ç—Å—è –≤—ã—Ö–æ–¥–Ω—ã–º.");
            return;
        }

        createMutation.mutate({
            date: format(day, "yyyy-MM-dd"),
            description: description || undefined,
        }, {
            onError: (error: any) => {
                if (error.response?.status === 409) {
                    setConflict({
                        date: day,
                        description: description,
                        conflicting_reservation_ids: error.response.data.detail.conflicting_reservation_ids,
                    });
                }
            },
            onSuccess: () => setDescription("")
        });
    };

    const handleForceCreate = () => {
        if (!conflict) return;
        createMutation.mutate(
            { date: format(conflict.date, "yyyy-MM-dd"), description: conflict.description, force: true },
            { onSuccess: () => setConflict(null) }
        );
    };

    const handleDeleteHoliday = (date: Date) => {
        if (window.confirm(`–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å –≤—ã—Ö–æ–¥–Ω–æ–π ${format(date, 'dd.MM.yyyy')}?`)) {
            deleteMutation.mutate(date);
        }
    };

    const handleDeleteRule = (ruleId: number) => {
        if (window.confirm(`–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å —ç—Ç–æ –ø—Ä–∞–≤–∏–ª–æ –∏ –≤—Å–µ —Å–æ–∑–¥–∞–Ω–Ω—ã–µ –∏–º –±—É–¥—É—â–∏–µ –≤—ã—Ö–æ–¥–Ω—ã–µ?`)) {
            deleteRuleMutation.mutate(ruleId);
        }
    };

    const isLoading = isLoadingHolidays || isLoadingRules;

    return (
        <div className="space-y-6">

            <div className="space-y-4">
                <WeeklyRuleForm isLoading={isLoading} />
                <PublicHolidayImportForm isLoading={isLoading} />
            </div>

            <Card>
                <CardHeader>
                    <CardTitle className="flex items-center gap-2"><CalendarPlus className="w-5 h-5" /> –†—É—á–Ω–æ–µ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ</CardTitle>
                    <CardDescription>–í—ã–±–µ—Ä–∏—Ç–µ –¥–∞—Ç—É –≤ –∫–∞–ª–µ–Ω–¥–∞—Ä–µ, —á—Ç–æ–±—ã —Å–¥–µ–ª–∞—Ç—å –µ–µ –≤—ã—Ö–æ–¥–Ω—ã–º, –∏–ª–∏ —É–¥–∞–ª–∏—Ç–µ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π.</CardDescription>
                </CardHeader>
                <CardContent className="grid grid-cols-1 md:grid-cols-2 gap-8">
                    <div>
                        <div className="space-y-2 mb-4">
                            <Label htmlFor="holiday-desc">–ù–∞–∑–≤–∞–Ω–∏–µ (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)</Label>
                            <Input id="holiday-desc" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä, –ö–æ—Ä–ø–æ—Ä–∞—Ç–∏–≤" value={description} onChange={(e) => setDescription(e.target.value)} />
                        </div>
                        <div className="flex justify-center border rounded-md p-2">
                            <DayPicker
                                mode="single" locale={ru} month={month} onMonthChange={setMonth}
                                onSelect={handleDaySelect} modifiers={{ holidays: holidayDates }}
                                modifiersClassNames={{ holidays: 'bg-red-100 text-red-800 rounded-md' }}
                                footer={isLoadingHolidays ? <p className="text-center text-sm p-2">–ó–∞–≥—Ä—É–∑–∫–∞...</p> : <p className="text-center text-sm p-2">–í—ã–±—Ä–∞–Ω –º–µ—Å—è—Ü: {format(month, "LLLL yyyy", { locale: ru })}</p>}
                            />
                        </div>
                    </div>
                    <div>
                        <h3 className="text-md font-semibold mb-4">–í—ã—Ö–æ–¥–Ω—ã–µ –≤ —ç—Ç–æ–º –º–µ—Å—è—Ü–µ:</h3>
                        {holidays.length > 0 ? (
                            <div className="space-y-2 max-h-96 overflow-y-auto pr-2">
                                {holidays.map((holiday: HolidayWithDate) => (
                                    <div key={holiday.date.toString()} className="flex items-center justify-between p-2 bg-gray-50 rounded-md">
                                        <div>
                                            <span className="font-medium">{format(holiday.date, 'PPP', { locale: ru })}</span>
                                            {holiday.description && <span className="text-gray-600 text-sm ml-2">- {holiday.description}</span>}
                                        </div>
                                        <Button variant="ghost" size="icon" onClick={() => handleDeleteHoliday(holiday.date)} disabled={deleteMutation.isPending}><Trash2 className="h-4 w-4 text-red-500" /></Button>
                                    </div>
                                ))}
                            </div>
                        ) : (<p className="text-sm text-gray-500">–í —ç—Ç–æ–º –º–µ—Å—è—Ü–µ –≤—ã—Ö–æ–¥–Ω—ã–µ –Ω–µ –Ω–∞–∑–Ω–∞—á–µ–Ω—ã.</p>)}
                    </div>
                </CardContent>
            </Card>

            <Card>
                <CardHeader>
                    <CardTitle>–ê–∫—Ç–∏–≤–Ω—ã–µ –ø—Ä–∞–≤–∏–ª–∞ –∞–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü–∏–∏</CardTitle>
                </CardHeader>
                <CardContent>
                    <Table>
                        <TableHeader>
                            <TableRow>
                                <TableHead>–û–ø–∏—Å–∞–Ω–∏–µ</TableHead>
                                <TableHead>–¢–∏–ø</TableHead>
                                <TableHead>–î–∞—Ç–∞ —Å–æ–∑–¥–∞–Ω–∏—è</TableHead>
                                <TableHead className="text-right">–î–µ–π—Å—Ç–≤–∏—è</TableHead>
                            </TableRow>
                        </TableHeader>
                        <TableBody>
                            {isLoadingRules ? <TableRow><TableCell colSpan={4} className="text-center">–ó–∞–≥—Ä—É–∑–∫–∞ –ø—Ä–∞–≤–∏–ª...</TableCell></TableRow> :
                                rules.length === 0 ? <TableRow><TableCell colSpan={4} className="text-center">–ù–µ—Ç –∞–∫—Ç–∏–≤–Ω—ã—Ö –ø—Ä–∞–≤–∏–ª.</TableCell></TableRow> :
                                    rules.map(rule => (
                                        <TableRow key={rule.id}>
                                            <TableCell>{rule.description}</TableCell>
                                            <TableCell><span className="text-xs font-mono bg-slate-100 px-2 py-1 rounded">{rule.rule_type}</span></TableCell>
                                            <TableCell>{format(new Date(rule.created_at), 'dd.MM.yyyy HH:mm')}</TableCell>
                                            <TableCell className="text-right">
                                                <Button variant="ghost" size="icon" onClick={() => handleDeleteRule(rule.id)} disabled={deleteRuleMutation.isPending}><Trash2 className="h-4 w-4 text-red-500" /></Button>
                                            </TableCell>
                                        </TableRow>
                                    ))}
                        </TableBody>
                    </Table>
                </CardContent>
            </Card>

            <Dialog open={!!conflict} onOpenChange={() => setConflict(null)}>
                <DialogContent>
                    <DialogHeader>
                        <DialogTitle>–û–±–Ω–∞—Ä—É–∂–µ–Ω –∫–æ–Ω—Ñ–ª–∏–∫—Ç</DialogTitle>
                        <DialogDescription>
                            –í—ã–±—Ä–∞–Ω–Ω–∞—è –¥–∞—Ç–∞ —è–≤–ª—è–µ—Ç—Å—è –¥–∞—Ç–æ–π –Ω–∞—á–∞–ª–∞ –∏–ª–∏ –æ–∫–æ–Ω—á–∞–Ω–∏—è –¥–ª—è —Å–ª–µ–¥—É—é—â–∏—Ö —Ä–µ–∑–µ—Ä–≤–æ–≤:
                            <strong className="block my-2">ID: {conflict?.conflicting_reservation_ids.join(', ')}</strong>
                            –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ —ç—Ç–æ–≥–æ –¥–Ω—è –≤—ã—Ö–æ–¥–Ω—ã–º —Å–¥–µ–ª–∞–µ—Ç —ç—Ç–∏ —Ä–µ–∑–µ—Ä–≤—ã –Ω–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–º–∏. –í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ –ø—Ä–æ–¥–æ–ª–∂–∏—Ç—å?
                        </DialogDescription>
                    </DialogHeader>
                    <DialogFooter>
                        <Button variant="ghost" onClick={() => setConflict(null)}>–û—Ç–º–µ–Ω–∞</Button>
                        <Button variant="destructive" onClick={handleForceCreate} disabled={createMutation.isPending}>
                            {createMutation.isPending ? "–û–±—Ä–∞–±–æ—Ç–∫–∞..." : "–î–∞, –≤—Å–µ —Ä–∞–≤–Ω–æ –Ω–∞–∑–Ω–∞—á–∏—Ç—å"}
                        </Button>
                    </DialogFooter>
                </DialogContent>
            </Dialog>
        </div>
    );
}

```


## <a name="rentalappmainsrccomponentsadminPromoCodeDialogtsx"></a>`rental-app-main/src/components/admin/PromoCodeDialog.tsx`

```tsx
// path: rental-app-main/src/components/admin/PromoCodeDialog.tsx

// src/components/admin/PromoCodeDialog.tsx

import { useEffect, useMemo } from "react";
import { useForm, Controller } from "react-hook-form";
import { zodResolver } from "@hookform/resolvers/zod";
import { Button } from "@/components/ui/button";
import { Dialog, DialogContent, DialogHeader, DialogTitle, DialogFooter, DialogDescription } from "@/components/ui/dialog";
import { Input } from "@/components/ui/input";
import { Label } from "@/components/ui/label";
import { Switch } from "@/components/ui/switch";
import { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from "@/components/ui/select";
import { toast } from "sonner";
import { RefreshCw } from "lucide-react";

import { useCreatePromoCode, useUpdatePromoCode, fetchGeneratedPromoCode } from "@/hooks/useAdminPromoCodes";
import { useEquipment } from "@/hooks/useEquipment";
import { useAdminUsers } from "@/hooks/useAdminUsers";
import { useCurrentUser } from "@/hooks/useProfile";
import type { PromoCodeOut, PromoCodeCreate } from "@/types/promo_code";
import { promoCodeFormSchema, PromoCodeFormData } from "@/lib/validationSchemas";
import { MultiSelect } from "@/components/ui/multi-select";

interface Props {
    promoCode?: PromoCodeOut | null;
    open: boolean;
    onClose: () => void;
}

export function PromoCodeDialog({ promoCode, open, onClose }: Props) {
    const { data: user } = useCurrentUser();
    const createMutation = useCreatePromoCode();
    const updateMutation = useUpdatePromoCode();

    // +++ –ù–ê–ß–ê–õ–û –ò–ó–ú–ï–ù–ï–ù–ò–ô +++
    // 1. –ü–æ–ª—É—á–∞–µ–º –æ–±—ä–µ–∫—Ç —Å –ø–∞–≥–∏–Ω–∞—Ü–∏–µ–π –æ—Ç useInfiniteQuery
    const { data: equipmentPages } = useEquipment();
    const { data: usersResponse, isLoading: isLoadingUsers } = useAdminUsers();

    // 2. "–†–∞–∑–≤–æ—Ä–∞—á–∏–≤–∞–µ–º" —Å—Ç—Ä–∞–Ω–∏—Ü—ã –≤ –æ–¥–∏–Ω –ø–ª–æ—Å–∫–∏–π –º–∞—Å—Å–∏–≤ allEquipment
    const allEquipment = useMemo(() =>
            equipmentPages?.pages.flatMap(page => page.items) ?? [],
        [equipmentPages]);

    // 3. –ê–Ω–∞–ª–æ–≥–∏—á–Ω–æ –ø–æ—Å—Ç—É–ø–∞–µ–º —Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º–∏
    const users = useMemo(() => 
        usersResponse?.pages?.flatMap(page => page.items) ?? [], 
        [usersResponse]
    );
    // +++ –ö–û–ù–ï–¶ –ò–ó–ú–ï–ù–ï–ù–ò–ô +++


    const {
        register,
        handleSubmit,
        control,
        reset,
        setValue,
        formState: { errors, isValid },
    } = useForm<PromoCodeFormData>({
        resolver: zodResolver(promoCodeFormSchema) as any,
        mode: "onChange",
    });

    useEffect(() => {
        if (open) {
            if (promoCode) {
                reset({
                    code: promoCode.code,
                    description: promoCode.description ?? undefined,
                    discount_percentage: promoCode.discount_percentage,
                    is_active: promoCode.is_active,
                    valid_from: promoCode.valid_from ? new Date(promoCode.valid_from) : undefined,
                    expires_at: promoCode.expires_at ? new Date(promoCode.expires_at) : undefined,
                    max_uses: promoCode.max_uses ?? undefined,
                    max_uses_per_user: promoCode.max_uses_per_user ?? undefined,
                    min_order_amount: promoCode.min_order_amount ?? undefined,
                    specific_to_user_id: promoCode.specific_to_user_id ?? undefined,
                    applicable_to_equipment_ids: promoCode.applicable_to_equipment_ids ?? [],
                    applicable_to_equipment_types: promoCode.applicable_to_equipment_types ?? [],
                });
            } else {
                reset({
                    code: "",
                    description: "",
                    discount_percentage: 10,
                    is_active: true,
                    max_uses_per_user: 1,
                    applicable_to_equipment_ids: [],
                    applicable_to_equipment_types: [],
                });
            }
        }
    }, [promoCode, open, reset]);

    const onSubmit = (data: PromoCodeFormData) => {
        const maxDiscount = user?.role === 'admin' ? 50 : 20;
        if (data.discount_percentage > maxDiscount) {
            toast.error(`–ú–∞–∫—Å–∏–º–∞–ª—å–Ω–∞—è —Å–∫–∏–¥–∫–∞ –¥–ª—è –≤–∞—à–µ–π —Ä–æ–ª–∏: ${maxDiscount}%`);
            return;
        }

        const payload = {
            ...data,
            valid_from: data.valid_from ? data.valid_from.toISOString() : null,
            expires_at: data.expires_at ? data.expires_at.toISOString() : null,
        };

        if (promoCode) {
            updateMutation.mutate({ id: promoCode.id, data: payload }, { onSuccess: onClose });
        } else {
            createMutation.mutate(payload as PromoCodeCreate, { onSuccess: onClose });
        }
    };

    const handleGenerateCode = async () => {
        const newCode = await fetchGeneratedPromoCode();
        if (newCode) {
            setValue("code", newCode, { shouldValidate: true, shouldDirty: true });
        }
    };

    const isLoading = createMutation.isPending || updateMutation.isPending;

    // +++ –ù–ê–ß–ê–õ–û –ò–ó–ú–ï–ù–ï–ù–ò–ô: –ò—Å–ø–æ–ª—å–∑—É–µ–º `allEquipment` –≤–º–µ—Å—Ç–æ `equipments` +++
    const equipmentOptions = useMemo(() => allEquipment.map(e => ({ value: e.id.toString(), label: e.name })), [allEquipment]);
    const equipmentTypeOptions = useMemo(() => [...new Set(allEquipment.map(e => e.equipment_type))].map(type => ({ value: type, label: type })), [allEquipment]);
    // +++ –ö–û–ù–ï–¶ –ò–ó–ú–ï–ù–ï–ù–ò–ô +++
    const userOptions = useMemo(() => users.map((u: any) => ({ value: u.id.toString(), label: `${u.full_name} (${u.email})` })), [users]);

    return (
        <Dialog open={open} onOpenChange={onClose}>
            <DialogContent className="sm:max-w-[700px] max-h-[90vh] overflow-y-auto">
                <DialogHeader>
                    <DialogTitle>{promoCode ? "–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –ø—Ä–æ–º–æ–∫–æ–¥" : "–°–æ–∑–¥–∞—Ç—å –Ω–æ–≤—ã–π –ø—Ä–æ–º–æ–∫–æ–¥"}</DialogTitle>
                    <DialogDescription>{promoCode ? `–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ "${promoCode.code}"` : "–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –¥–µ—Ç–∞–ª–∏ –¥–ª—è –Ω–æ–≤–æ–≥–æ –ø—Ä–æ–º–æ–∫–æ–¥–∞."}</DialogDescription>
                </DialogHeader>
                <form onSubmit={handleSubmit(onSubmit)} className="space-y-4 py-4 pr-2">
                    <div className="grid grid-cols-4 items-center gap-4">
                        <Label htmlFor="code" className="text-right">–ö–æ–¥ *</Label>
                        <div className="col-span-3 flex items-center gap-2">
                            <Input id="code" {...register("code")} className="flex-grow" placeholder="SUMMER25"/>
                            <Button type="button" variant="outline" size="icon" onClick={handleGenerateCode} title="–°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –∫–æ–¥"><RefreshCw className="h-4 w-4" /></Button>
                        </div>
                        {errors.code && <p className="col-start-2 col-span-3 text-xs text-red-500 mt-1">{errors.code.message}</p>}
                    </div>

                    <div className="grid grid-cols-4 items-center gap-4">
                        <Label htmlFor="discount_percentage" className="text-right">–°–∫–∏–¥–∫–∞, % *</Label>
                        <div className="col-span-3"><Input id="discount_percentage" type="number" {...register("discount_percentage")} /></div>
                        {errors.discount_percentage && <p className="col-start-2 col-span-3 text-xs text-red-500 mt-1">{errors.discount_percentage.message}</p>}
                    </div>

                    <div className="grid grid-cols-4 items-center gap-4">
                        <Label htmlFor="description" className="text-right">–û–ø–∏—Å–∞–Ω–∏–µ</Label>
                        <div className="col-span-3"><Input id="description" {...register("description")} placeholder="–î–ª—è –≤–Ω—É—Ç—Ä–µ–Ω–Ω–µ–≥–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è"/></div>
                    </div>

                    <div className="grid grid-cols-4 items-center gap-4">
                        <Label className="text-right">–õ–∏–º–∏—Ç—ã</Label>
                        <div className="col-span-3 grid grid-cols-3 gap-2">
                            <Input type="number" {...register("max_uses")} placeholder="–í—Å–µ–≥–æ"/>
                            <Input type="number" {...register("max_uses_per_user")} placeholder="–ù–∞ —é–∑–µ—Ä–∞"/>
                            <Input type="number" {...register("min_order_amount")} placeholder="–ú–∏–Ω. —Å—É–º–º–∞ ‚ÇΩ"/>
                        </div>
                    </div>

                    <div className="grid grid-cols-4 items-center gap-4">
                        <Label className="text-right">–°—Ä–æ–∫ –¥–µ–π—Å—Ç–≤–∏—è</Label>
                        <div className="col-span-3 grid grid-cols-2 gap-2">
                            <Controller control={control} name="valid_from" render={({ field }) => (<Input type="date" onChange={(e) => field.onChange(e.target.valueAsDate)} value={field.value ? field.value.toISOString().split('T')[0] : ''}/>)} />
                            <Controller control={control} name="expires_at" render={({ field }) => (<Input type="date" onChange={(e) => field.onChange(e.target.valueAsDate)} value={field.value ? field.value.toISOString().split('T')[0] : ''}/>)} />
                        </div>
                        {errors.expires_at && <p className="col-start-2 col-span-3 text-xs text-red-500 mt-1">{errors.expires_at.message}</p>}
                    </div>

                    <div className="grid grid-cols-4 items-center gap-4">
                        <Label className="text-right">–î–ª—è —Ç–æ–≤–∞—Ä–æ–≤</Label>
                        <div className="col-span-3">
                            <Controller control={control} name="applicable_to_equipment_ids" render={({ field }) => (<MultiSelect placeholder="–î–ª—è –≤—Å–µ–≥–æ –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—è" options={equipmentOptions} value={field.value?.map(String) || []} onValueChange={(selected) => field.onChange(selected.map(Number))} />)} />
                        </div>
                    </div>

                    <div className="grid grid-cols-4 items-center gap-4">
                        <Label className="text-right">–î–ª—è —Ç–∏–ø–æ–≤</Label>
                        <div className="col-span-3">
                            <Controller control={control} name="applicable_to_equipment_types" render={({ field }) => (<MultiSelect placeholder="–î–ª—è –≤—Å–µ—Ö —Ç–∏–ø–æ–≤" options={equipmentTypeOptions} value={field.value || []} onValueChange={field.onChange}/>)} />
                        </div>
                    </div>

                    <div className="grid grid-cols-4 items-center gap-4">
                        <Label className="text-right">–î–ª—è —é–∑–µ—Ä–∞</Label>
                        <div className="col-span-3">
                            <Controller control={control} name="specific_to_user_id"
                                        render={({ field }) => (
                                            <Select
                                                onValueChange={(value) => field.onChange(value === 'all' ? undefined : Number(value))}
                                                value={field.value?.toString()}
                                                disabled={isLoadingUsers}
                                            >
                                                <SelectTrigger><SelectValue placeholder="–î–ª—è –≤—Å–µ—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π" /></SelectTrigger>
                                                <SelectContent>
                                                    <SelectItem value="all">–î–ª—è –≤—Å–µ—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π</SelectItem>
                                                    {userOptions.map((opt: any) => <SelectItem key={opt.value} value={opt.value}>{opt.label}</SelectItem>)}
                                                </SelectContent>
                                            </Select>
                                        )}
                            />
                        </div>
                    </div>

                    <div className="grid grid-cols-4 items-center gap-4">
                        <Label className="text-right">–°—Ç–∞—Ç—É—Å</Label>
                        <div className="col-span-3 flex items-center space-x-2">
                            <Controller control={control} name="is_active" render={({ field }) => (
                                <Switch id="is_active" checked={field.value} onCheckedChange={field.onChange} />
                            )} />
                            <Label htmlFor="is_active" className="font-normal cursor-pointer">–ê–∫—Ç–∏–≤–µ–Ω</Label>
                        </div>
                    </div>

                    <DialogFooter>
                        <Button type="button" variant="ghost" onClick={onClose}>–û—Ç–º–µ–Ω–∞</Button>
                        <Button type="submit" disabled={!isValid || isLoading}>
                            {isLoading ? "–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ..." : "–°–æ—Ö—Ä–∞–Ω–∏—Ç—å"}
                        </Button>
                    </DialogFooter>
                </form>
            </DialogContent>
        </Dialog>
    );
}

```


## <a name="rentalappmainsrccomponentsadminPromoCodeTabletsx"></a>`rental-app-main/src/components/admin/PromoCodeTable.tsx`

```tsx
// path: rental-app-main/src/components/admin/PromoCodeTable.tsx

// src/components/admin/PromoCodeTable.tsx

import { useState } from "react";
import { useAdminPromoCodes, useDeletePromoCode } from "@/hooks/useAdminPromoCodes";
import { PromoCodeDialog } from "./PromoCodeDialog";
import type { PromoCodeOut } from "@/types/promo_code";
import { formatDateEuropean } from "@/lib/utils";

import { Button } from "@/components/ui/button";
import { Input } from "@/components/ui/input";
import { Badge } from "@/components/ui/badge";
import { Table, TableBody, TableCell, TableHead, TableHeader, TableRow } from "@/components/ui/table";
// ‚úÖ –£–±—Ä–∞–Ω–∞ –∏–∫–æ–Ω–∫–∞ AlertCircle
import { Plus, Edit, Trash2, Search, Ticket } from "lucide-react";

export default function PromoCodeTable() {
    const { data: promoCodes = [], isLoading, error } = useAdminPromoCodes();
    const deleteMutation = useDeletePromoCode();

    const [search, setSearch] = useState("");
    const [isDialogOpen, setDialogOpen] = useState(false);
    const [editingPromoCode, setEditingPromoCode] = useState<PromoCodeOut | null>(null);

    const filteredPromoCodes = promoCodes.filter(pc =>
        pc.code.toLowerCase().includes(search.toLowerCase()) ||
        pc.description?.toLowerCase().includes(search.toLowerCase())
    );

    const handleCreate = () => {
        setEditingPromoCode(null);
        setDialogOpen(true);
    };

    const handleEdit = (promoCode: PromoCodeOut) => {
        setEditingPromoCode(promoCode);
        setDialogOpen(true);
    };

    const handleDelete = (id: number) => {
        if (window.confirm("–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å —ç—Ç–æ—Ç –ø—Ä–æ–º–æ–∫–æ–¥? –î–µ–π—Å—Ç–≤–∏–µ –Ω–µ–æ–±—Ä–∞—Ç–∏–º–æ.")) {
            deleteMutation.mutate(id);
        }
    };

    if (isLoading) return <p className="text-center py-4">–ó–∞–≥—Ä—É–∑–∫–∞ –ø—Ä–æ–º–æ–∫–æ–¥–æ–≤...</p>;
    if (error) return <p className="text-center text-red-600 py-4">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö.</p>;

    return (
        <>
            <div className="flex flex-col sm:flex-row items-center justify-between gap-4 mb-4">
                <div className="relative w-full sm:max-w-xs">
                    <Search className="absolute left-3 top-2.5 h-4 w-4 text-muted-foreground" />
                    <Input
                        placeholder="–ü–æ–∏—Å–∫ –ø–æ –∫–æ–¥—É –∏–ª–∏ –æ–ø–∏—Å–∞–Ω–∏—é..."
                        value={search}
                        onChange={(e) => setSearch(e.target.value)}
                        className="pl-10"
                    />
                </div>
                <Button onClick={handleCreate} className="w-full sm:w-auto">
                    <Plus className="mr-2 h-4 w-4" /> –î–æ–±–∞–≤–∏—Ç—å –ø—Ä–æ–º–æ–∫–æ–¥
                </Button>
            </div>

            {filteredPromoCodes.length > 0 ? (
                <div className="border rounded-md overflow-x-auto">
                    <Table>
                        <TableHeader>
                            <TableRow>
                                <TableHead>–ö–æ–¥</TableHead>
                                <TableHead>–°–∫–∏–¥–∫–∞</TableHead>
                                <TableHead>–°—Ç–∞—Ç—É—Å</TableHead>
                                <TableHead>–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è</TableHead>
                                <TableHead>–°—Ä–æ–∫ –¥–µ–π—Å—Ç–≤–∏—è</TableHead>
                                <TableHead className="text-right">–î–µ–π—Å—Ç–≤–∏—è</TableHead>
                            </TableRow>
                        </TableHeader>
                        <TableBody>
                            {filteredPromoCodes.map((pc) => (
                                <TableRow key={pc.id}>
                                    <TableCell className="font-medium">{pc.code}</TableCell>
                                    <TableCell>{pc.discount_percentage}%</TableCell>
                                    <TableCell>
                                        <Badge variant={pc.is_active ? "default" : "secondary"}>
                                            {pc.is_active ? "–ê–∫—Ç–∏–≤–µ–Ω" : "–ù–µ–∞–∫—Ç–∏–≤–µ–Ω"}
                                        </Badge>
                                    </TableCell>
                                    <TableCell>
                                        {pc.times_used} / {pc.max_uses ?? '‚àû'}
                                    </TableCell>
                                    <TableCell>
                                        {pc.expires_at ? formatDateEuropean(pc.expires_at) : '–ë–µ—Å—Å—Ä–æ—á–Ω–æ'}
                                    </TableCell>
                                    <TableCell className="text-right">
                                        <Button variant="ghost" size="icon" onClick={() => handleEdit(pc)}>
                                            <Edit className="h-4 w-4" />
                                        </Button>
                                        <Button variant="ghost" size="icon" onClick={() => handleDelete(pc.id)} disabled={deleteMutation.isPending}>
                                            <Trash2 className="h-4 w-4 text-red-500" />
                                        </Button>
                                    </TableCell>
                                </TableRow>
                            ))}
                        </TableBody>
                    </Table>
                </div>
            ) : (
                <div className="text-center py-12 px-4 border-2 border-dashed rounded-lg">
                    <Ticket className="w-16 h-16 text-gray-300 mx-auto mb-3" />
                    <h3 className="text-lg font-semibold text-gray-700">–ü—Ä–æ–º–æ–∫–æ–¥—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã</h3>
                    <p className="text-sm text-gray-500 mt-1">
                        {search ? "–ü–æ–ø—Ä–æ–±—É–π—Ç–µ –∏–∑–º–µ–Ω–∏—Ç—å –ø–æ–∏—Å–∫–æ–≤—ã–π –∑–∞–ø—Ä–æ—Å." : "–î–æ–±–∞–≤—å—Ç–µ –ø–µ—Ä–≤—ã–π –ø—Ä–æ–º–æ–∫–æ–¥, —á—Ç–æ–±—ã –æ–Ω –ø–æ—è–≤–∏–ª—Å—è –≤ —Å–ø–∏—Å–∫–µ."}
                    </p>
                </div>
            )}

            <PromoCodeDialog
                open={isDialogOpen}
                onClose={() => setDialogOpen(false)}
                promoCode={editingPromoCode}
            />
        </>
    );
}

```


## <a name="rentalappmainsrccomponentsadminRentalStatusBadgetsx"></a>`rental-app-main/src/components/admin/RentalStatusBadge.tsx`

```tsx
// path: rental-app-main/src/components/admin/RentalStatusBadge.tsx

// src/components/admin/RentalStatusBadge.tsx

import { Badge } from "@/components/ui/badge";

type RentalStatus = 'active' | 'overdue' | 'completed';

interface Props {
    status: RentalStatus;
}

export default function RentalStatusBadge({ status }: Props) {
    const statusConfig = {
        active: { text: "–ê–∫—Ç–∏–≤–Ω–∞", className: "bg-green-100 text-green-800 border-green-200" },
        overdue: { text: "–ü—Ä–æ—Å—Ä–æ—á–µ–Ω–∞", className: "bg-red-100 text-red-800 border-red-200" },
        completed: { text: "–ó–∞–≤–µ—Ä—à–µ–Ω–∞", className: "bg-gray-100 text-gray-800 border-gray-200" },
    };

    const config = statusConfig[status] || statusConfig.completed;

    return (
        <Badge variant="outline" className={`font-medium ${config.className}`}>
            {config.text}
        </Badge>
    );
}

```


## <a name="rentalappmainsrccomponentsadminReservationFinancialSummarytsx"></a>`rental-app-main/src/components/admin/ReservationFinancialSummary.tsx`

```tsx
// path: rental-app-main/src/components/admin/ReservationFinancialSummary.tsx

// src/components/admin/ReservationFinancialSummary.tsx

import { useMemo } from "react";
import { usePriceCalculator } from "@/hooks/reservation/usePriceCalculator";
import { AlertCircle, Loader2, ReceiptText } from "lucide-react";
import type { AdminReservationOut } from "@/types/reservation";
import type { Equipment } from "@/types/equipment"; // –ò–º–ø–æ—Ä—Ç–∏—Ä—É–µ–º —Ç–∏–ø Equipment

interface ReservationFinancialSummaryProps {
    reservation: AdminReservationOut;
    open: boolean;
    // +++ –ù–ê–ß–ê–õ–û: –ù–æ–≤—ã–µ –ø—Ä–æ–ø—Å—ã –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –∫–æ–Ω—Ñ–ª–∏–∫—Ç–æ–≤ +++
    hasConflicts: boolean;
    conflictingItemIds: number[];
    isCheckingAvailability: boolean;
    equipmentMap: Map<number, Equipment>;
    // +++ –ö–û–ù–ï–¶: –ù–æ–≤—ã–µ –ø—Ä–æ–ø—Å—ã +++
}

export default function ReservationFinancialSummary({
                                                        reservation,
                                                        open,
                                                        hasConflicts,
                                                        conflictingItemIds,
                                                        isCheckingAvailability,
                                                        equipmentMap
                                                    }: ReservationFinancialSummaryProps) {

    const { newStartDate, newEndDate, newDateRangeIsValid } = useMemo(() => {
        const today = new Date();
        today.setHours(0, 0, 0, 0);

        const originalEndDate = new Date(reservation.end_date);

        return {
            newStartDate: today,
            newEndDate: originalEndDate,
            newDateRangeIsValid: originalEndDate > today,
        };
    }, [reservation]);

    const { data: priceDetails, isFetching: isCalculatingPrice, error: priceError } = usePriceCalculator({
        equipmentIds: reservation.equipment_ids || [],
        startDate: newStartDate!,
        endDate: newEndDate!,
        selectedAccessories: reservation.selected_accessories || {},
        promoCode: reservation.promo_code || undefined,
        enabled: open && newDateRangeIsValid,
    });

    const finalCost = priceDetails?.final_total ?? reservation.total_cost ?? 0;

    // +++ –ü–æ–ª—É—á–∞–µ–º –∏–º–µ–Ω–∞ –∫–æ–Ω—Ñ–ª–∏–∫—Ç–Ω–æ–≥–æ –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—è +++
    const conflictingEquipmentNames = useMemo(() =>
            conflictingItemIds.map(id => equipmentMap.get(id)?.name).filter(Boolean).join(', '),
        [conflictingItemIds, equipmentMap]);

    return (
        <div className="p-3 bg-slate-50 border rounded-lg space-y-2">
            <h4 className="flex items-center gap-2 text-sm font-semibold text-gray-800">
                <ReceiptText className="w-5 h-5 text-sky-600" />
                –§–∏–Ω–∞–Ω—Å–æ–≤–∞—è —Å–≤–æ–¥–∫–∞
            </h4>

            {(isCalculatingPrice || isCheckingAvailability) ? (
                <div className="flex items-center justify-center gap-2 text-sm text-gray-500 py-4">
                    <Loader2 className="h-4 w-4 animate-spin" />
                    {isCheckingAvailability ? "–ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏..." : "–ü–µ—Ä–µ—Å—á–µ—Ç —Å—Ç–æ–∏–º–æ—Å—Ç–∏..."}
                </div>
            ) : hasConflicts ? (
                // +++ –ù–ê–ß–ê–õ–û: –ù–æ–≤—ã–π –±–ª–æ–∫ –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –æ—à–∏–±–∫–∏ –∫–æ–Ω—Ñ–ª–∏–∫—Ç–∞ +++
                <div className="text-sm text-red-700 font-medium p-2 bg-red-100 border border-red-200 rounded-md space-y-1">
                    <div className="flex items-center gap-2">
                        <AlertCircle className="h-4 w-4" />
                        <span>–ö–æ–Ω—Ñ–ª–∏–∫—Ç –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è!</span>
                    </div>
                    <p className="text-xs font-normal pl-6">
                        –û–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏–µ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–æ –≤ –Ω–æ–≤–æ–º –ø–µ—Ä–∏–æ–¥–µ: <strong>{conflictingEquipmentNames}</strong>.
                    </p>
                </div>
                // +++ –ö–û–ù–ï–¶: –ù–æ–≤—ã–π –±–ª–æ–∫ +++
            ) : priceError || !newDateRangeIsValid ? (
                <div className="flex items-center gap-2 text-sm text-red-600 font-medium p-2 bg-red-50 rounded-md">
                    <AlertCircle className="h-4 w-4" />
                    <span>{priceError ? "–ù–µ —É–¥–∞–ª–æ—Å—å —Ä–∞—Å—Å—á–∏—Ç–∞—Ç—å —Ü–µ–Ω—É." : "–ù–µ–≤–æ–∑–º–æ–∂–Ω–æ –≤—ã–¥–∞—Ç—å: —Ä–µ–∑–µ—Ä–≤ —É–∂–µ –∑–∞–∫–æ–Ω—á–∏–ª—Å—è."}</span>
                </div>
            ) : (
                <div className="text-xs text-gray-700 space-y-1.5 border-t pt-2">
                    <div className="flex justify-between">
                        <span>–ü–µ—Ä–∏–æ–¥ —Ä–µ–∑–µ—Ä–≤–∞:</span>
                        <span className="font-medium">{new Date(reservation.start_date).toLocaleDateString()} - {new Date(reservation.end_date).toLocaleDateString()}</span>
                    </div>
                    <div className="flex justify-between">
                        <span>–°—Ç–æ–∏–º–æ—Å—Ç—å —Ä–µ–∑–µ—Ä–≤–∞:</span>
                        <span className="font-medium">{reservation.total_cost?.toLocaleString('ru-RU')} ‚ÇΩ</span>
                    </div>
                    <hr className="border-dashed my-1"/>
                    <div className="flex justify-between">
                        <span>–ù–æ–≤—ã–π –ø–µ—Ä–∏–æ–¥ –∞—Ä–µ–Ω–¥—ã:</span>
                        <span className="font-medium">{newStartDate?.toLocaleDateString()} - {newEndDate?.toLocaleDateString()}</span>
                    </div>
                    {priceDetails && (priceDetails.discount_amount > 0) && (
                        <div className="flex justify-between text-green-600">
                            <span>–°–∫–∏–¥–∫–∞ ({priceDetails.duration_discount_percentage}%):</span>
                            <span className="font-medium">- {priceDetails.discount_amount.toLocaleString('ru-RU')} ‚ÇΩ</span>
                        </div>
                    )}
                    <div className="flex justify-between text-base font-bold pt-1 border-t mt-1">
                        <span>–ò—Ç–æ–≥–æ –∫ —Å–ø–∏—Å–∞–Ω–∏—é —Å –±–∞–ª–∞–Ω—Å–∞:</span>
                        <span className="text-sky-700">{finalCost.toLocaleString('ru-RU')} ‚ÇΩ</span>
                    </div>
                </div>
            )}
        </div>
    );
}

```


## <a name="rentalappmainsrccomponentsadminReturnAccessoriesChecklisttsx"></a>`rental-app-main/src/components/admin/ReturnAccessoriesChecklist.tsx`

```tsx
// path: rental-app-main/src/components/admin/ReturnAccessoriesChecklist.tsx

// src/components/admin/ReturnAccessoriesChecklist.tsx

import { Label } from "@/components/ui/label";
import { Checkbox } from "@/components/ui/checkbox";
import type { AdminRentalOut } from "@/types/rental";
import type { Accessory } from "@/types/accessory";
import type { Equipment } from "@/types/equipment";

interface Props {
    rental: AdminRentalOut;
    accessoriesByEquipment: Record<number, Accessory[]>;
    checkedAccessories: Set<string>;
    handleToggleAccessory: (equipmentId: number, accessoryId: number) => void;
    totalAccessoriesCount: number;
}

export default function ReturnAccessoriesChecklist({
    rental,
    accessoriesByEquipment,
    checkedAccessories,
    handleToggleAccessory,
    totalAccessoriesCount,
}: Props) {
    if (totalAccessoriesCount === 0) {
        return null;
    }

    return (
        <div className="space-y-3 pt-3 border-t">
            <Label className="font-semibold">–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç–µ –≤–æ–∑–≤—Ä–∞—Ç –∞–∫—Å–µ—Å—Å—É–∞—Ä–æ–≤:</Label>
            <div className="space-y-2 max-h-48 overflow-y-auto rounded-md border p-3 bg-slate-50">
                {rental.equipment.map((eq: Equipment) => (
                    accessoriesByEquipment[eq.id] && (
                        <div key={eq.id}>
                            <p className="text-sm font-medium text-gray-700">{eq.name}</p>
                            <ul className="pl-4 mt-1 space-y-1">
                                {accessoriesByEquipment[eq.id].map((acc: Accessory) => {
                                    const key = `${eq.id}-${acc.id}`;
                                    return (
                                        <li key={key} className="flex items-center">
                                            <Checkbox
                                                id={key}
                                                checked={checkedAccessories.has(key)}
                                                onCheckedChange={() => handleToggleAccessory(eq.id, acc.id)}
                                            />
                                            <Label htmlFor={key} className="ml-2 text-sm font-normal cursor-pointer">
                                                {acc.name}
                                            </Label>
                                        </li>
                                    );
                                })}
                            </ul>
                        </div>
                    )
                ))}
            </div>
        </div>
    );
}


```


## <a name="rentalappmainsrccomponentsadminReturnFinancialstsx"></a>`rental-app-main/src/components/admin/ReturnFinancials.tsx`

```tsx
// path: rental-app-main/src/components/admin/ReturnFinancials.tsx

// src/components/admin/ReturnFinancials.tsx

import { Button } from "@/components/ui/button";
import { Label } from "@/components/ui/label";
import { Input } from "@/components/ui/input";
import { Textarea } from "@/components/ui/textarea";
import type { AdminRentalOut } from "@/types/rental";

interface Props {
    rental: AdminRentalOut;
    dynamicRemainingAmount: number;
    paymentAmount: string;
    setPaymentAmount: (value: string) => void;
    paymentDescription: string;
    setPaymentDescription: (value: string) => void;
    paymentApplied: boolean;
    handleApplyPayment: () => void;
    handleCancelPayment: () => void;
    isApplyingPayment: boolean;
    handleAutoFillPayment: () => void;
    overdueSurcharge?: number;
}

export default function ReturnFinancials({
    rental,
    dynamicRemainingAmount,
    paymentAmount,
    setPaymentAmount,
    paymentDescription,
    setPaymentDescription,
    paymentApplied,
    handleApplyPayment,
    handleCancelPayment,
    isApplyingPayment,
    handleAutoFillPayment,
    overdueSurcharge,
}: Props) {
    return (
        <div className="space-y-4 pt-3 border-t">
            <Label className="font-semibold text-base">–§–∏–Ω–∞–Ω—Å–æ–≤–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è</Label>
            
            {/* –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏–æ–Ω–Ω—ã–µ –ø–æ–ª—è */}
            <div className="space-y-2 bg-slate-50 p-3 rounded-md">
                <div className="flex justify-between">
                    <span className="text-sm text-gray-600">–¢–µ–∫—É—â–∏–π –±–∞–ª–∞–Ω—Å –∫–ª–∏–µ–Ω—Ç–∞:</span>
                    <span className="font-medium">{(rental.user.balance || 0).toLocaleString()} ‚ÇΩ</span>
                </div>
                <div className="flex justify-between">
                    <span className="text-sm text-gray-600">–°—Ç–æ–∏–º–æ—Å—Ç—å –∞—Ä–µ–Ω–¥—ã:</span>
                    <span className="font-medium">{rental.total_cost.toLocaleString()} ‚ÇΩ</span>
                </div>
                <div className="flex justify-between">
                    <span className="text-sm text-gray-600">–í–Ω–µ—Å–µ–Ω–Ω–∞—è –ø—Ä–µ–¥–æ–ø–ª–∞—Ç–∞:</span>
                    <span className="font-medium">{rental.prepayment_amount.toLocaleString()} ‚ÇΩ</span>
                </div>
                <div className="flex justify-between">
                    <span className="text-sm text-gray-600">–û—Å—Ç–∞—Ç–æ–∫ –∫ –æ–ø–ª–∞—Ç–µ:</span>
                    <span className={`font-medium ${dynamicRemainingAmount > 0 ? 'text-red-600' : 'text-green-600'}`}>
                        {dynamicRemainingAmount.toLocaleString()} ‚ÇΩ
                    </span>
                </div>
                <div className="flex justify-between">
                    <span className="text-sm text-gray-600">–í–Ω–µ—Å–µ–Ω–Ω—ã–π –∑–∞–ª–æ–≥:</span>
                    <span className="font-medium">{rental.deposit_amount.toLocaleString()} ‚ÇΩ</span>
                </div>
                {overdueSurcharge && overdueSurcharge > 0 && (
                    <div className="flex justify-between text-red-600 font-semibold pt-2 border-t border-dashed">
                        <span>–®—Ç—Ä–∞—Ñ –∑–∞ –ø—Ä–æ—Å—Ä–æ—á–∫—É:</span>
                        <span>+ {overdueSurcharge.toLocaleString()} ‚ÇΩ</span>
                    </div>
                )}
            </div>

            {/* –ü–æ–ª—è –¥–ª—è –ø–ª–∞—Ç–µ–∂–∞ */}
            <div className="space-y-3">
                <div>
                    <div className="flex items-center justify-between mb-1">
                        <Label htmlFor="payment_amount">–°—É–º–º–∞ –ø–ª–∞—Ç–µ–∂–∞</Label>
                        {!paymentApplied && dynamicRemainingAmount > 0 && (
                            <Button
                                type="button"
                                variant="ghost"
                                size="sm"
                                onClick={handleAutoFillPayment}
                                className="text-xs h-6 px-2"
                            >
                                –ó–∞–ø–æ–ª–Ω–∏—Ç—å –æ—Å—Ç–∞—Ç–æ–∫
                            </Button>
                        )}
                    </div>
                    <Input
                        id="payment_amount"
                        type="number"
                        value={paymentAmount}
                        onChange={(e) => setPaymentAmount(e.target.value)}
                        placeholder="–í–≤–µ–¥–∏—Ç–µ —Å—É–º–º—É"
                        disabled={paymentApplied}
                        className={paymentApplied ? "bg-green-50 border-green-200" : ""}
                    />
                    {paymentApplied && (
                        <p className="text-xs text-green-600 mt-1 flex items-center">
                            <span className="mr-1">‚úì</span>
                            –ü–ª–∞—Ç–µ–∂ —É—á—Ç–µ–Ω
                        </p>
                    )}
                </div>
                
                <div>
                    <Label htmlFor="payment_description">–û–ø–∏—Å–∞–Ω–∏–µ –ø–ª–∞—Ç–µ–∂–∞</Label>
                    <Textarea
                        id="payment_description"
                        value={paymentDescription}
                        onChange={(e) => setPaymentDescription(e.target.value)}
                        placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: –ß–∞—Å—Ç–∏—á–Ω–∞—è –æ–ø–ª–∞—Ç–∞ –ø—Ä–∏ –≤–æ–∑–≤—Ä–∞—Ç–µ"
                        disabled={paymentApplied}
                        className={paymentApplied ? "bg-green-50 border-green-200" : ""}
                    />
                </div>

                {/* –ö–Ω–æ–ø–∫–∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –ø–ª–∞—Ç–µ–∂–æ–º */}
                <div className="flex gap-2">
                    <Button
                        type="button"
                        variant="outline"
                        onClick={handleApplyPayment}
                        disabled={!paymentAmount || paymentApplied || isApplyingPayment}
                        className="flex-1"
                    >
                        {isApplyingPayment ? "–û–±—Ä–∞–±–æ—Ç–∫–∞..." : "–í–Ω–µ—Å—Ç–∏ –ø–ª–∞—Ç–µ–∂"}
                    </Button>
                    
                    {paymentApplied && (
                        <Button
                            type="button"
                            variant="destructive"
                            onClick={handleCancelPayment}
                            className="flex-1"
                        >
                            –û—Ç–º–µ–Ω–∏—Ç—å –ø–ª–∞—Ç–µ–∂
                        </Button>
                    )}
                </div>
            </div>
        </div>
    );
}


```


## <a name="rentalappmainsrccomponentsadminReturnRentalDialogtsx"></a>`rental-app-main/src/components/admin/ReturnRentalDialog.tsx`

```tsx
// path: rental-app-main/src/components/admin/ReturnRentalDialog.tsx

// src/components/admin/ReturnRentalDialog.tsx

import { Dialog, DialogContent, DialogHeader, DialogTitle, DialogFooter, DialogDescription } from "@/components/ui/dialog";
import { Button } from "@/components/ui/button";
import { Label } from "@/components/ui/label";
import { Input } from "@/components/ui/input";
import { Textarea } from "@/components/ui/textarea";
import type { AdminRentalOut } from "@/types/rental";
import { useRentalReturnForm } from "@/hooks/admin/useRentalReturnForm";
import ReturnFinancials from "./ReturnFinancials";
import ReturnAccessoriesChecklist from "./ReturnAccessoriesChecklist";

interface Props {
    rental: AdminRentalOut | null;
    open: boolean;
    onClose: () => void;
}

export default function ReturnRentalDialog({ rental, open, onClose }: Props) {
    const {
        // –°–æ—Å—Ç–æ—è–Ω–∏—è
        paymentAmount,
        setPaymentAmount,
        paymentDescription,
        setPaymentDescription,
        paymentApplied,
        checkedAccessories,
        dynamicRemainingAmount,
        
        // –§—É–Ω–∫—Ü–∏–∏-–æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏
        handleApplyPayment,
        handleCancelPayment,
        handleToggleAccessory,
        handleAutoFillPayment,
        onSubmit,
        
        // –°–æ—Å—Ç–æ—è–Ω–∏—è –º—É—Ç–∞—Ü–∏–π
        isSubmittingReturn,
        isApplyingPayment,
        
        // –î–∞–Ω–Ω—ã–µ —Ñ–æ—Ä–º—ã –æ—Ç react-hook-form
        register,
        handleSubmit,
        formState: { errors, isValid },
        
        // –î—Ä—É–≥–∏–µ –≤—ã—á–∏—Å–ª—è–µ–º—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è
        accessoriesByEquipment,
        allAccessoriesChecked,
        totalAccessoriesCount,
    } = useRentalReturnForm({ rental, onClose });

    if (!rental) return null;

    return (
        <Dialog open={open} onOpenChange={onClose}>
            <DialogContent>
                <DialogHeader>
                    <DialogTitle>–û—Ñ–æ—Ä–º–ª–µ–Ω–∏–µ –≤–æ–∑–≤—Ä–∞—Ç–∞ –∞—Ä–µ–Ω–¥—ã #{rental.id}</DialogTitle>
                    <DialogDescription>
                        –ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç–µ –≤–æ–∑–≤—Ä–∞—Ç –æ—Ç –∫–ª–∏–µ–Ω—Ç–∞: <strong>{rental.user.full_name}</strong>.
                    </DialogDescription>
                </DialogHeader>
                <form onSubmit={handleSubmit(onSubmit)} className="space-y-4 py-2">
                    <div>
                        <Label htmlFor="actual_return_date">–§–∞–∫—Ç–∏—á–µ—Å–∫–∞—è –¥–∞—Ç–∞ –≤–æ–∑–≤—Ä–∞—Ç–∞ *</Label>
                        <Input
                            id="actual_return_date"
                            type="date"
                            {...register("actual_return_date")}
                        />
                        {errors.actual_return_date && <p className="text-xs text-red-600 mt-1">{errors.actual_return_date.message}</p>}
                    </div>
                    <div>
                        <Label htmlFor="notes_on_return">–ó–∞–º–µ—Ç–∫–∏ –ø—Ä–∏ –≤–æ–∑–≤—Ä–∞—Ç–µ</Label>
                        <Textarea
                            id="notes_on_return"
                            {...register("notes_on_return")}
                            placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏–µ —á–∏—Å—Ç–æ–µ, –∫–æ–º–ø–ª–µ–∫—Ç–∞—Ü–∏—è –ø–æ–ª–Ω–∞—è..."
                        />
                    </div>

                    {/* –§–∏–Ω–∞–Ω—Å–æ–≤—ã–π –±–ª–æ–∫ */}
                    <ReturnFinancials
                        rental={rental}
                        dynamicRemainingAmount={dynamicRemainingAmount}
                        paymentAmount={paymentAmount}
                        setPaymentAmount={setPaymentAmount}
                        paymentDescription={paymentDescription}
                        setPaymentDescription={setPaymentDescription}
                        paymentApplied={paymentApplied}
                        handleApplyPayment={handleApplyPayment}
                        handleCancelPayment={handleCancelPayment}
                        isApplyingPayment={isApplyingPayment}
                        handleAutoFillPayment={handleAutoFillPayment}
                        overdueSurcharge={rental.overdue_surcharge || undefined}
                    />

                    {/* –°–ø–∏—Å–æ–∫ –∞–∫—Å–µ—Å—Å—É–∞—Ä–æ–≤ */}
                    <ReturnAccessoriesChecklist
                        rental={rental}
                        accessoriesByEquipment={accessoriesByEquipment}
                        checkedAccessories={checkedAccessories}
                        handleToggleAccessory={handleToggleAccessory}
                        totalAccessoriesCount={totalAccessoriesCount}
                    />

                    <DialogFooter>
                        <Button type="button" variant="ghost" onClick={onClose}>–û—Ç–º–µ–Ω–∞</Button>
                        <Button
                            type="submit"
                            disabled={!isValid || isSubmittingReturn || (totalAccessoriesCount > 0 && !allAccessoriesChecked)}
                        >
                            {isSubmittingReturn ? "–û–±—Ä–∞–±–æ—Ç–∫–∞..." : "–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å –≤–æ–∑–≤—Ä–∞—Ç"}
                        </Button>
                    </DialogFooter>
                </form>
            </DialogContent>
        </Dialog>
    );
}

```


## <a name="rentalappmainsrccomponentsadminUserCreateDialogtsx"></a>`rental-app-main/src/components/admin/UserCreateDialog.tsx`

```tsx
// path: rental-app-main/src/components/admin/UserCreateDialog.tsx

// src/components/admin/UserCreateDialog.tsx

import { useForm, Controller } from "react-hook-form";
import { zodResolver } from "@hookform/resolvers/zod";
import { adminUserCreateFormSchema, type AdminUserCreateFormSchema } from "@/lib/validationSchemas";
import { useAdminCreateUser } from "@/hooks/useAdminUsers";
import { USER_ROLE_OPTIONS, USER_ROLES } from "@/constants/userConstants";

import { Button } from "@/components/ui/button";
import { Input } from "@/components/ui/input";
import { Label } from "@/components/ui/label";
import { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from "@/components/ui/select";
import { Dialog, DialogContent, DialogHeader, DialogTitle, DialogFooter, DialogDescription } from "@/components/ui/dialog";
import { PhoneInput } from "@/components/ui/phone-input";

interface Props {
    open: boolean;
    onClose: () => void;
}

export function UserCreateDialog({ open, onClose }: Props) {
    const createMutation = useAdminCreateUser();
    const { register, handleSubmit, formState: { errors, isValid }, reset, control } = useForm<AdminUserCreateFormSchema>({
        resolver: zodResolver(adminUserCreateFormSchema),
        mode: "onChange",
        defaultValues: {
            role: USER_ROLES.USER,
            privacyPolicyAccepted: true,
            termsAccepted: true,
            emailVerified: true,
        }
    });

    const onSubmit = (data: AdminUserCreateFormSchema) => {
        createMutation.mutate(data, {
            onSuccess: () => {
                reset();
                onClose();
            },
        });
    };

    const handleDialogClose = () => {
        reset();
        onClose();
    }

    return (
        <Dialog open={open} onOpenChange={handleDialogClose}>
            <DialogContent>
                <DialogHeader>
                    <DialogTitle>–ù–æ–≤—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å</DialogTitle>
                    <DialogDescription>
                        –°–æ–∑–¥–∞–Ω–∏–µ –Ω–æ–≤–æ–π —É—á–µ—Ç–Ω–æ–π –∑–∞–ø–∏—Å–∏ –∏ —Å–≤—è–∑–∞–Ω–Ω–æ–≥–æ –ø—Ä–æ—Ñ–∏–ª—è –∫–ª–∏–µ–Ω—Ç–∞.
                    </DialogDescription>
                </DialogHeader>
                <form onSubmit={handleSubmit(onSubmit)} className="space-y-4 py-2">
                    <div>
                        <Label htmlFor="create-full_name">–§–ò–û *</Label>
                        <Input id="create-full_name" {...register("full_name")} placeholder="–ò–≤–∞–Ω –ü–µ—Ç—Ä–æ–≤" />
                        {errors.full_name && <p className="text-xs text-red-600 mt-1">{errors.full_name.message}</p>}
                    </div>

                    <div>
                        <Label htmlFor="create-email">Email *</Label>
                        <Input id="create-email" type="email" {...register("email")} placeholder="user@example.com" />
                        {errors.email && <p className="text-xs text-red-600 mt-1">{errors.email.message}</p>}
                    </div>

                    {/* +++ –ù–ê–ß–ê–õ–û: –ù–æ–≤–æ–µ –ø–æ–ª–µ –¥–ª—è —Ç–µ–ª–µ—Ñ–æ–Ω–∞ +++ */}
                    <div>
                        <Label htmlFor="create-phone">–¢–µ–ª–µ—Ñ–æ–Ω</Label>
                        <Controller
                            name="phone"
                            control={control}
                            render={({ field }) => (
                                <PhoneInput
                                    id="create-phone"
                                    placeholder="+7 (___) ___-__-__"
                                    {...field} // –ü–µ—Ä–µ–¥–∞–µ–º –≤—Å–µ —Å–≤–æ–π—Å—Ç–≤–∞ –ø–æ–ª—è (value, onChange, onBlur, ref)
                                />
                            )}
                        />
                        {errors.phone && <p className="text-xs text-red-600 mt-1">{errors.phone.message}</p>}
                    </div>
                    {/* +++ –ö–û–ù–ï–¶: –ù–æ–≤–æ–µ –ø–æ–ª–µ –¥–ª—è —Ç–µ–ª–µ—Ñ–æ–Ω–∞ +++ */}

                    <div>
                        <Label htmlFor="create-password">–ü–∞—Ä–æ–ª—å *</Label>
                        <Input id="create-password" type="password" {...register("password")} placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" />
                        {errors.password && <p className="text-xs text-red-600 mt-1">{errors.password.message}</p>}
                    </div>

                    <div>
                        <Label htmlFor="create-role">–†–æ–ª—å *</Label>
                        <Controller
                            name="role"
                            control={control}
                            render={({ field }) => (
                                <Select onValueChange={field.onChange} defaultValue={field.value}>
                                    <SelectTrigger id="create-role">
                                        <SelectValue placeholder="–í—ã–±–µ—Ä–∏—Ç–µ —Ä–æ–ª—å" />
                                    </SelectTrigger>
                                    <SelectContent>
                                        {USER_ROLE_OPTIONS.map(option => (
                                            <SelectItem key={option.value} value={option.value}>
                                                {option.label}
                                            </SelectItem>
                                        ))}
                                    </SelectContent>
                                </Select>
                            )}
                        />
                        {errors.role && <p className="text-xs text-red-600 mt-1">{errors.role.message}</p>}
                    </div>

                    <DialogFooter className="pt-4">
                        <Button type="button" variant="ghost" onClick={handleDialogClose}>–û—Ç–º–µ–Ω–∞</Button>
                        <Button type="submit" disabled={!isValid || createMutation.isPending}>
                            {createMutation.isPending ? "–°–æ–∑–¥–∞–Ω–∏–µ..." : "–°–æ–∑–¥–∞—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è"}
                        </Button>
                    </DialogFooter>
                </form>
            </DialogContent>
        </Dialog>
    );
}

```


## <a name="rentalappmainsrccomponentsadminUserEditDialogtsx"></a>`rental-app-main/src/components/admin/UserEditDialog.tsx`

```tsx
// path: rental-app-main/src/components/admin/UserEditDialog.tsx

// src/components/admin/UserEditDialog.tsx

import { useEffect, useState } from "react";
import { useForm, Controller } from "react-hook-form";
import { zodResolver } from "@hookform/resolvers/zod";
import { adminUserUpdateSchema, type AdminUserUpdateSchema } from "@/lib/validationSchemas";
import { useAdminUpdateUser, useUpdateUserRole } from "@/hooks/useAdminUsers";
import { useCurrentUser } from "@/hooks/useProfile";
import { USER_ROLE_OPTIONS, USER_ROLE_LABELS } from "@/constants/userConstants";
import type { UserOut, UserRole } from "@/types/user"; // ‚úÖ –ò–ó–ú–ï–ù–ï–ù–ò–ï: –î–æ–±–∞–≤–ª–µ–Ω –∏–º–ø–æ—Ä—Ç UserRole

import { Button } from "@/components/ui/button";
import { Input } from "@/components/ui/input";
import { Label } from "@/components/ui/label";
import { Textarea } from "@/components/ui/textarea";
import { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from "@/components/ui/select";
import { Dialog, DialogContent, DialogHeader, DialogTitle, DialogFooter, DialogDescription } from "@/components/ui/dialog";
import { ConfirmationDialog } from "@/components/ui/confirmation-dialog";
import { PhoneInput } from "@/components/ui/phone-input";

interface Props {
    user: UserOut | null;
    open: boolean;
    onClose: () => void;
}

const statusOptions = [
    { value: "–ê–∫—Ç–∏–≤–Ω—ã–π", label: "–ê–∫—Ç–∏–≤–Ω—ã–π" },
    { value: "–¢—Ä–µ–±—É–µ—Ç –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è", label: "–¢—Ä–µ–±—É–µ—Ç –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è" },
    { value: "–ó–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω", label: "–ó–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω" },
];

export function UserEditDialog({ user, open, onClose }: Props) {
    const { data: currentUser } = useCurrentUser();
    const isAdmin = currentUser?.role === 'admin';
    const updateMutation = useAdminUpdateUser();
    const updateRoleMutation = useUpdateUserRole();
    const [showRoleConfirmation, setShowRoleConfirmation] = useState(false);
    const [pendingRoleChange, setPendingRoleChange] = useState<string | null>(null);

    const { register, handleSubmit, formState: { errors, isValid, isDirty }, reset, control } = useForm<AdminUserUpdateSchema>({
        resolver: zodResolver(adminUserUpdateSchema),
        mode: "onChange",
    });

    useEffect(() => {
        if (user && open) {
            const formData = {
                full_name: user.full_name,
                phone: user.phone || "",
                status: user.status || "",
                notes: user.notes || "",
                balance: user.balance,
            };
            reset(formData);
        }
    }, [user, open, reset]); // ‚úÖ –ò–ó–ú–ï–ù–ï–ù–ò–ï: `reset` –∑–¥–µ—Å—å –±–µ–∑–æ–ø–∞—Å–µ–Ω, –æ—Å—Ç–∞–≤–ª—è–µ–º –µ–≥–æ –¥–ª—è —Å–±—Ä–æ—Å–∞ —Ñ–æ—Ä–º—ã –ø—Ä–∏ —Å–º–µ–Ω–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è

    const handleRoleChange = (newRole: string) => {
        if (!user || !isAdmin || currentUser?.role !== 'admin') return;
        if (newRole !== user.role) {
            setPendingRoleChange(newRole);
            setShowRoleConfirmation(true);
        }
    };

    const confirmRoleChange = () => {
        if (!user || !pendingRoleChange || !isAdmin) return;

        // ‚úÖ –ò–ó–ú–ï–ù–ï–ù–ò–ï: –ü—Ä–∏–≤–æ–¥–∏–º —Å—Ç—Ä–æ–∫—É –∫ —Ç–∏–ø—É UserRole, —á—Ç–æ–±—ã –∏—Å–ø—Ä–∞–≤–∏—Ç—å –æ—à–∏–±–∫—É TS2322
        updateRoleMutation.mutate({ userId: user.id, newRole: pendingRoleChange as UserRole }, {
            onSuccess: () => {
                setPendingRoleChange(null);
                setShowRoleConfirmation(false);
            },
        });
    };

    const onSubmit = (data: AdminUserUpdateSchema) => {
        if (!user) return;
        updateMutation.mutate({ userId: user.id, data }, {
            onSuccess: () => {
                onClose();
            },
        });
    };

    if (!user) return null;

    return (
        <>
            <Dialog open={open} onOpenChange={onClose}>
                <DialogContent className="sm:max-w-[600px]">
                    <DialogHeader>
                        <DialogTitle>–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –ø—Ä–æ—Ñ–∏–ª—è</DialogTitle>
                        <DialogDescription>
                            –í—ã –∏–∑–º–µ–Ω—è–µ—Ç–µ –¥–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è: <strong>{user.full_name}</strong>
                        </DialogDescription>
                    </DialogHeader>
                    <form onSubmit={handleSubmit(onSubmit)} className="space-y-4 py-2">
                        <div>
                            <Label htmlFor="edit-email">Email (–Ω–µ–ª—å–∑—è –∏–∑–º–µ–Ω–∏—Ç—å)</Label>
                            <Input id="edit-email" value={user.email} disabled />
                        </div>

                        <div className="grid grid-cols-1 sm:grid-cols-2 gap-4">
                            <div>
                                <Label htmlFor="edit-full_name">–§–ò–û *</Label>
                                <Input id="edit-full_name" {...register("full_name")} />
                                {errors.full_name && <p className="text-xs text-red-600 mt-1">{errors.full_name.message}</p>}
                            </div>
                            <div>
                                <Label htmlFor="edit-phone">–¢–µ–ª–µ—Ñ–æ–Ω</Label>
                                {/* ‚úÖ –ò–ó–ú–ï–ù–ï–ù–ò–ï: –û–±–æ—Ä–∞—á–∏–≤–∞–µ–º PhoneInput –≤ Controller –¥–ª—è —Å—Ç–∞–±–∏–ª—å–Ω–æ–π —Ä–∞–±–æ—Ç—ã */}
                                <Controller
                                    name="phone"
                                    control={control}
                                    render={({ field }) => (
                                        <PhoneInput id="edit-phone" {...field} />
                                    )}
                                />
                                {errors.phone && <p className="text-xs text-red-600 mt-1">{errors.phone.message}</p>}
                            </div>
                        </div>

                        <div className="grid grid-cols-1 sm:grid-cols-2 gap-4">
                            <div>
                                <Label htmlFor="edit-role">–†–æ–ª—å</Label>
                                <Select
                                    onValueChange={handleRoleChange}
                                    value={user.role}
                                    disabled={!isAdmin}
                                >
                                    <SelectTrigger id="edit-role">
                                        <SelectValue />
                                    </SelectTrigger>
                                    <SelectContent>
                                        {USER_ROLE_OPTIONS.map(option => (
                                            <SelectItem key={option.value} value={option.value}>
                                                {option.label}
                                            </SelectItem>
                                        ))}
                                    </SelectContent>
                                </Select>
                                {!isAdmin && <p className="text-xs text-gray-500 mt-1">–¢–æ–ª—å–∫–æ –∞–¥–º–∏–Ω –º–æ–∂–µ—Ç –º–µ–Ω—è—Ç—å —Ä–æ–ª—å.</p>}
                            </div>
                            <div>
                                <Label htmlFor="edit-status">–°—Ç–∞—Ç—É—Å</Label>
                                <Controller
                                    name="status"
                                    control={control}
                                    render={({ field }) => (
                                        <Select onValueChange={field.onChange} value={field.value}>
                                            <SelectTrigger id="edit-status">
                                                <SelectValue />
                                            </SelectTrigger>
                                            <SelectContent>
                                                {statusOptions.map(option => (
                                                    <SelectItem key={option.value} value={option.value}>
                                                        {option.label}
                                                    </SelectItem>
                                                ))}
                                            </SelectContent>
                                        </Select>
                                    )}
                                />
                            </div>
                        </div>

                        <div>
                            <Label htmlFor="edit-balance">–ë–∞–ª–∞–Ω—Å</Label>
                            <Input id="edit-balance" type="number" step="0.01" {...register("balance")} placeholder="0.00" />
                            {errors.balance && <p className="text-xs text-red-600 mt-1">{errors.balance.message}</p>}
                        </div>

                        <div>
                            <Label htmlFor="edit-notes">–ó–∞–º–µ—Ç–∫–∏ (–≤–∏–¥–Ω—ã —Ç–æ–ª—å–∫–æ –ø–µ—Ä—Å–æ–Ω–∞–ª—É)</Label>
                            <Textarea id="edit-notes" {...register("notes")} placeholder="–í–Ω—É—Ç—Ä–µ–Ω–Ω—è—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –∫–ª–∏–µ–Ω—Ç–µ..." />
                        </div>

                        <DialogFooter className="pt-4">
                            <Button type="button" variant="ghost" onClick={onClose}>–û—Ç–º–µ–Ω–∞</Button>
                            <Button type="submit" disabled={!isDirty || !isValid || updateMutation.isPending}>
                                {updateMutation.isPending ? "–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ..." : "–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è"}
                            </Button>
                        </DialogFooter>
                    </form>
                </DialogContent>
            </Dialog>

            <ConfirmationDialog
                open={showRoleConfirmation}
                onOpenChange={setShowRoleConfirmation}
                title="–ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è —Ä–æ–ª–∏"
                description={`–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ –∏–∑–º–µ–Ω–∏—Ç—å —Ä–æ–ª—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è "${user?.full_name}" —Å "${USER_ROLE_LABELS[user?.role as keyof typeof USER_ROLE_LABELS] || user?.role}" –Ω–∞ "${pendingRoleChange ? USER_ROLE_LABELS[pendingRoleChange as keyof typeof USER_ROLE_LABELS] || pendingRoleChange : ''}"?`}
                confirmText="–ò–∑–º–µ–Ω–∏—Ç—å —Ä–æ–ª—å"
                cancelText="–û—Ç–º–µ–Ω–∞"
                onConfirm={confirmRoleChange}
                variant="destructive"
            />
        </>
    );
}

```


## <a name="rentalappmainsrccomponentsadminUserPaymentDialogtsx"></a>`rental-app-main/src/components/admin/UserPaymentDialog.tsx`

```tsx
// path: rental-app-main/src/components/admin/UserPaymentDialog.tsx

// src/components/admin/UserPaymentDialog.tsx

import { useForm, Controller } from "react-hook-form";
import { zodResolver } from "@hookform/resolvers/zod";
import { userPaymentSchema, type UserPaymentSchema } from "@/lib/validationSchemas";
import { useAddUserPayment } from "@/hooks/useAdminUsers";
import type { UserOut } from "@/types/user";

import { Button } from "@/components/ui/button";
import { Input } from "@/components/ui/input";
import { Label } from "@/components/ui/label";
import { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from "@/components/ui/select";
import { Textarea } from "@/components/ui/textarea";
import {
    Dialog,
    DialogContent,
    DialogHeader,
    DialogTitle,
    DialogFooter,
    DialogDescription,
} from "@/components/ui/dialog";

const PAYMENT_METHODS = ["–ù–∞–ª–∏—á–Ω—ã–µ", "–ö–∞—Ä—Ç–∞", "–ü–µ—Ä–µ–≤–æ–¥"];

interface Props {
    user: UserOut | null;
    open: boolean;
    onClose: () => void;
}

export function UserPaymentDialog({ user, open, onClose }: Props) {
    const paymentMutation = useAddUserPayment();
    const { register, handleSubmit, formState: { errors, isValid }, reset, control } = useForm<UserPaymentSchema>({
        resolver: zodResolver(userPaymentSchema),
        mode: "onChange",
    });

    const onSubmit = (data: UserPaymentSchema) => {
        if (!user) return;

        paymentMutation.mutate({ userId: user.id, data }, {
            onSuccess: () => {
                reset();
                onClose();
            },
        });
    };

    const handleDialogClose = () => {
        if (paymentMutation.isPending) return;
        reset();
        onClose();
    };

    if (!user) return null;

    // –ò–ó–ú–ï–ù–ï–ù–ò–ï: –î–æ–±–∞–≤–ª—è–µ–º ?? 0 –¥–ª—è –±–µ–∑–æ–ø–∞—Å–Ω–æ–≥–æ –¥–æ—Å—Ç—É–ø–∞ –∫ –±–∞–ª–∞–Ω—Å—É
    const currentBalance = user.balance ?? 0;

    return (
        <Dialog open={open} onOpenChange={handleDialogClose}>
            <DialogContent>
                <DialogHeader>
                    <DialogTitle>–ü–æ–ø–æ–ª–Ω–µ–Ω–∏–µ –±–∞–ª–∞–Ω—Å–∞</DialogTitle>
                    <DialogDescription>
                        –í—ã –ø–æ–ø–æ–ª–Ω—è–µ—Ç–µ –±–∞–ª–∞–Ω—Å –¥–ª—è <strong>{user.full_name}</strong>.
                        –¢–µ–∫—É—â–∏–π –±–∞–ª–∞–Ω—Å:
                        <span className={`font-bold ${currentBalance < 0 ? 'text-red-600' : 'text-green-700'}`}>
                            {' '}{currentBalance.toLocaleString('ru-RU')} ‚ÇΩ
                        </span>
                    </DialogDescription>
                </DialogHeader>
                <form onSubmit={handleSubmit(onSubmit)} className="space-y-4 py-2">
                    <div className="grid grid-cols-2 gap-4">
                        <div>
                            <Label htmlFor="payment-amount">–°—É–º–º–∞ (‚ÇΩ) *</Label>
                            <Input id="payment-amount" type="number" step="0.01" {...register("amount")} placeholder="1000" />
                            {errors.amount && <p className="text-xs text-red-600 mt-1">{errors.amount.message}</p>}
                        </div>
                        <div>
                            <Label htmlFor="payment-method">–ú–µ—Ç–æ–¥ –æ–ø–ª–∞—Ç—ã *</Label>
                            <Controller
                                name="payment_method"
                                control={control}
                                render={({ field }) => (
                                    <Select onValueChange={field.onChange} defaultValue={field.value}>
                                        <SelectTrigger id="payment-method">
                                            <SelectValue placeholder="–í—ã–±–µ—Ä–∏—Ç–µ –º–µ—Ç–æ–¥" />
                                        </SelectTrigger>
                                        <SelectContent>
                                            {PAYMENT_METHODS.map(method => (
                                                <SelectItem key={method} value={method}>{method}</SelectItem>
                                            ))}
                                        </SelectContent>
                                    </Select>
                                )}
                            />
                            {errors.payment_method && <p className="text-xs text-red-600 mt-1">{errors.payment_method.message}</p>}
                        </div>
                    </div>
                    <div>
                        <Label htmlFor="payment-description">–û–ø–∏—Å–∞–Ω–∏–µ (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)</Label>
                        <Textarea id="payment-description" {...register("description")} placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä, –æ–ø–ª–∞—Ç–∞ –∑–∞–ª–æ–≥–∞ –∑–∞ –∞—Ä–µ–Ω–¥—É #123" />
                    </div>
                    <DialogFooter className="pt-4">
                        <Button type="button" variant="ghost" onClick={handleDialogClose} disabled={paymentMutation.isPending}>
                            –û—Ç–º–µ–Ω–∞
                        </Button>
                        <Button type="submit" disabled={!isValid || paymentMutation.isPending}>
                            {paymentMutation.isPending ? "–ü–æ–ø–æ–ª–Ω–µ–Ω–∏–µ..." : "–ü–æ–ø–æ–ª–Ω–∏—Ç—å –±–∞–ª–∞–Ω—Å"}
                        </Button>
                    </DialogFooter>
                </form>
            </DialogContent>
        </Dialog>
    );
}

```


## <a name="rentalappmainsrccomponentsadminUserTabletsx"></a>`rental-app-main/src/components/admin/UserTable.tsx`

```tsx
// path: rental-app-main/src/components/admin/UserTable.tsx

// src/components/admin/UserTable.tsx

import { useState } from "react";
import { Table, TableBody, TableCell, TableHead, TableHeader, TableRow } from "@/components/ui/table";
import { Button } from "@/components/ui/button";
import { UserSearch, Loader2 } from "lucide-react";
import { UserCreateDialog } from "./UserCreateDialog";
import { useUserTableLogic } from "@/hooks/admin/useUserTableLogic";
import { UserTableToolbar } from "./UserTableToolbar";
import { UserTableRow } from "./UserTableRow";
import { UserEditDialog } from "./UserEditDialog";
import { UserPaymentDialog } from "./UserPaymentDialog";
import type { UserOut } from "@/types/user";

interface UserTableProps {
    users: UserOut[];
    isLoading: boolean;
    error: unknown;
    onLoadMore: () => void;
    hasNextPage: boolean;
    isFetchingNextPage: boolean;
}

export default function UserTable({
    users,
    isLoading,
    error,
    onLoadMore,
    hasNextPage,
    isFetchingNextPage,
}: UserTableProps) {
    const [isCreateDialogOpen, setCreateDialogOpen] = useState(false);
    const [isEditDialogOpen, setEditDialogOpen] = useState(false);
    const [selectedUser, setSelectedUser] = useState<UserOut | null>(null);
    const [paymentUser, setPaymentUser] = useState<UserOut | null>(null);

    const {
        currentUser,
        filteredUsers,
        isAdmin,
        searchQuery,
        setSearchQuery,
        confirmDelete,
        mutations,
        handlers,
    } = useUserTableLogic(users);

    const handleEdit = (user: UserOut) => {
        setSelectedUser(user);
        setEditDialogOpen(true);
    };

    const handleAddPayment = (user: UserOut) => {
        setPaymentUser(user);
    };

    if (isLoading) {
        return <div className="text-center py-8">–ó–∞–≥—Ä—É–∑–∫–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π...</div>;
    }

    if (error) {
        return <div className="text-center py-8 text-red-600">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π</div>;
    }

    return (
        <>
            <div className="space-y-4">
                <UserTableToolbar
                    searchQuery={searchQuery}
                    onSearchChange={setSearchQuery}
                    onAddUser={() => setCreateDialogOpen(true)}
                    filteredUserCount={filteredUsers.length}
                    isAdmin={isAdmin}
                />

                <div className="rounded-md border">
                    <Table>
                        <TableHeader>
                            <TableRow>
                                <TableHead>–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å</TableHead>
                                <TableHead>Email</TableHead>
                                <TableHead>–†–æ–ª—å</TableHead>
                                <TableHead>–°—Ç–∞—Ç—É—Å</TableHead>
                                <TableHead>–î–∞—Ç–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏</TableHead>
                                {isAdmin && <TableHead className="text-right">–î–µ–π—Å—Ç–≤–∏—è</TableHead>}
                            </TableRow>
                        </TableHeader>
                        <TableBody>
                            {filteredUsers.length > 0 ? (
                                filteredUsers.map((user) => (
                                    <UserTableRow
                                        key={user.id}
                                        user={user}
                                        currentUser={currentUser}
                                        isAdmin={isAdmin}
                                        confirmDeleteId={confirmDelete}
                                        handlers={handlers}
                                        mutations={mutations}
                                        onEdit={handleEdit}
                                        onAddPayment={handleAddPayment}
                                    />
                                ))
                            ) : (
                                <TableRow>
                                    <TableCell colSpan={isAdmin ? 6 : 5} className="h-24 text-center">
                                        <div className="flex flex-col items-center justify-center text-center p-4">
                                            <UserSearch className="w-16 h-16 text-gray-300 mb-3" />
                                            <h3 className="text-lg font-semibold text-gray-700">–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã</h3>
                                            <p className="text-sm text-gray-500 max-w-sm">
                                                {searchQuery
                                                    ? "–ü–æ–ø—Ä–æ–±—É–π—Ç–µ –∏–∑–º–µ–Ω–∏—Ç—å –ø–æ–∏—Å–∫–æ–≤—ã–π –∑–∞–ø—Ä–æ—Å."
                                                    : "–í —Å–∏—Å—Ç–µ–º–µ –ø–æ–∫–∞ –Ω–µ—Ç –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π."}
                                            </p>
                                        </div>
                                    </TableCell>
                                </TableRow>
                            )}
                        </TableBody>
                    </Table>
                </div>

                {/* –ö–Ω–æ–ø–∫–∞ Load More */}
                {hasNextPage && (
                    <div className="flex justify-center mt-6">
                        <Button
                            onClick={onLoadMore}
                            disabled={isFetchingNextPage}
                            variant="outline"
                            className="min-w-[120px]"
                        >
                            {isFetchingNextPage ? (
                                <>
                                    <Loader2 className="w-4 h-4 mr-2 animate-spin" />
                                    –ó–∞–≥—Ä—É–∑–∫–∞...
                                </>
                            ) : (
                                "–ó–∞–≥—Ä—É–∑–∏—Ç—å –µ—â–µ"
                            )}
                        </Button>
                    </div>
                )}

                {!isAdmin && (
                    <div className="bg-blue-50 border border-blue-200 rounded-lg p-4 text-sm text-blue-800">
                        <strong>–†–µ–∂–∏–º –º–µ–Ω–µ–¥–∂–µ—Ä–∞:</strong> –í—ã –º–æ–∂–µ—Ç–µ –ø—Ä–æ—Å–º–∞—Ç—Ä–∏–≤–∞—Ç—å —Å–ø–∏—Å–æ–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π, –Ω–æ –Ω–µ –º–æ–∂–µ—Ç–µ –∏—Ö –∏–∑–º–µ–Ω—è—Ç—å, –±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å –∏–ª–∏ —É–¥–∞–ª—è—Ç—å.
                    </div>
                )}
            </div>

            <UserCreateDialog open={isCreateDialogOpen} onClose={() => setCreateDialogOpen(false)} />

            <UserEditDialog
                user={selectedUser}
                open={isEditDialogOpen}
                onClose={() => {
                    setEditDialogOpen(false);
                    setSelectedUser(null);
                }}
            />

            <UserPaymentDialog
                user={paymentUser}
                open={!!paymentUser}
                onClose={() => setPaymentUser(null)}
            />
        </>
    );
}

```


## <a name="rentalappmainsrccomponentsadminUserTableRowtsx"></a>`rental-app-main/src/components/admin/UserTableRow.tsx`

```tsx
// path: rental-app-main/src/components/admin/UserTableRow.tsx

// src/components/admin/UserTableRow.tsx

import type { UserOut } from "@/types/user";
import { TableCell, TableRow } from "@/components/ui/table";
import { Badge } from "@/components/ui/badge";
import { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from "@/components/ui/select";
import { Button } from "@/components/ui/button";
import { Shield, ShieldCheck, UserCheck, UserX, Trash2, Pencil, DollarSign } from "lucide-react";
import type { useUserTableLogic } from "@/hooks/admin/useUserTableLogic";
import { USER_ROLE_LABELS, USER_ROLE_BADGE_VARIANTS, USER_ROLE_OPTIONS } from "@/constants/userConstants";
import { formatDateEuropean } from "@/lib/utils";

type Handlers = ReturnType<typeof useUserTableLogic>['handlers'];
type Mutations = ReturnType<typeof useUserTableLogic>['mutations'];

interface Props {
    user: UserOut;
    currentUser: UserOut | null | undefined;
    isAdmin: boolean;
    confirmDeleteId: number | null;
    handlers: Handlers;
    mutations: Mutations;
    onEdit: (user: UserOut) => void;
    onAddPayment: (user: UserOut) => void;
}

export function UserTableRow({ user, currentUser, isAdmin, confirmDeleteId, handlers, mutations, onEdit, onAddPayment }: Props) {
    return (
        <TableRow key={user.id}>
            <TableCell className="font-medium">
                <div className="flex items-center gap-2">
                    {user.role === "admin" && <ShieldCheck className="w-4 h-4 text-red-500" />}
                    {user.role === "manager" && <Shield className="w-4 h-4 text-blue-500" />}
                    {user.full_name}
                    {user.id === currentUser?.id && <Badge variant="outline" className="text-xs">–≠—Ç–æ –≤—ã</Badge>}
                </div>
            </TableCell>
            <TableCell>{user.email}</TableCell>
            <TableCell>
                {isAdmin && user.id !== currentUser?.id ? (
                    <Select value={user.role} onValueChange={(value) => handlers.handleRoleChange(user.id, value)}>
                        <SelectTrigger className="w-32"><SelectValue /></SelectTrigger>
                        <SelectContent>
                            {USER_ROLE_OPTIONS.map(option => (
                                <SelectItem key={option.value} value={option.value}>
                                    {option.label}
                                </SelectItem>
                            ))}
                        </SelectContent>
                    </Select>
                ) : (
                    <Badge variant={USER_ROLE_BADGE_VARIANTS[user.role]}>
                        {USER_ROLE_LABELS[user.role]}
                    </Badge>
                )}
            </TableCell>
            <TableCell>
                <Badge variant={user.is_active ? "default" : "secondary"}>{user.is_active ? "–ê–∫—Ç–∏–≤–µ–Ω" : "–ó–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω"}</Badge>
            </TableCell>
            <TableCell className="text-sm text-gray-600">
                {formatDateEuropean(user.created_at)}
            </TableCell>
            {isAdmin && (
                <TableCell className="text-right">
                    <div className="flex items-center justify-end gap-2">
                        {user.id !== currentUser?.id ? (
                            <>
                                <Button variant="outline" size="icon" onClick={() => onAddPayment(user)} className="h-8 w-8 text-green-600 border-green-300 hover:bg-green-50 hover:text-green-700">
                                    <DollarSign className="w-4 h-4" />
                                </Button>
                                <Button variant="outline" size="icon" onClick={() => onEdit(user)} className="h-8 w-8">
                                    <Pencil className="w-4 h-4" />
                                </Button>
                                <Button variant="outline" size="sm" onClick={() => handlers.handleToggleBlock(user)} disabled={mutations.blockUser.isPending || mutations.unblockUser.isPending}>
                                    {user.is_active ? <UserX className="w-4 h-4" /> : <UserCheck className="w-4 h-4" />}
                                </Button>
                                <Button variant={confirmDeleteId === user.id ? "destructive" : "outline"} size="sm" onClick={() => handlers.handleDelete(user.id)} disabled={mutations.deleteUser.isPending}>
                                    <Trash2 className="w-4 h-4" />
                                    {confirmDeleteId === user.id && <span className="ml-1 text-xs">–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å</span>}
                                </Button>
                            </>
                        ) : (
                            <Button variant="outline" size="icon" onClick={() => onAddPayment(user)} className="h-8 w-8 text-green-600 border-green-300 hover:bg-green-50 hover:text-green-700">
                                <DollarSign className="w-4 h-4" />
                            </Button>
                        )}
                    </div>
                </TableCell>
            )}
        </TableRow>
    );
}

```


## <a name="rentalappmainsrccomponentsadminUserTableToolbartsx"></a>`rental-app-main/src/components/admin/UserTableToolbar.tsx`

```tsx
// path: rental-app-main/src/components/admin/UserTableToolbar.tsx

// src/components/admin/UserTableToolbar.tsx
import { Input } from "@/components/ui/input";
import { Button } from "@/components/ui/button";
import { Search, Plus } from "lucide-react";

interface Props {
    searchQuery: string;
    onSearchChange: (query: string) => void;
    onAddUser: () => void;
    filteredUserCount: number;
    isAdmin: boolean;
}

export function UserTableToolbar({
                                     searchQuery,
                                     onSearchChange,
                                     onAddUser,
                                     filteredUserCount,
                                     isAdmin
                                 }: Props) {
    return (
        <div className="flex flex-col sm:flex-row gap-4 items-center justify-between">
            <div className="relative flex-grow max-w-sm w-full">
                <Search className="absolute left-3 top-1/2 -translate-y-1/2 text-gray-400 w-4 h-4" />
                <Input
                    placeholder="–ü–æ–∏—Å–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π..."
                    value={searchQuery}
                    onChange={(e) => onSearchChange(e.target.value)}
                    className="pl-10"
                />
            </div>
            <div className="flex items-center gap-4">
                <p className="text-sm text-gray-600">
                    –ù–∞–π–¥–µ–Ω–æ: {filteredUserCount}
                </p>
                {isAdmin && (
                    <Button size="sm" onClick={onAddUser}>
                        <Plus className="w-4 h-4 mr-2" />
                        –î–æ–±–∞–≤–∏—Ç—å
                    </Button>
                )}
            </div>
        </div>
    );
}

```


## <a name="rentalappmainsrccomponentsadmindashboardActivityFeedWidgettsx"></a>`rental-app-main/src/components/admin/dashboard/ActivityFeedWidget.tsx`

```tsx
// path: rental-app-main/src/components/admin/dashboard/ActivityFeedWidget.tsx

// src/components/admin/dashboard/ActivityFeedWidget.tsx

import { Card, CardContent, CardHeader, CardTitle } from "@/components/ui/card";
import { Skeleton } from "@/components/ui/skeleton";
import { Badge } from "@/components/ui/badge";
import { 
    Activity,
    Plus,
    X,
    Play,
    CheckCircle,
    UserPlus,
    Package,
    Calendar
} from "lucide-react";
import { formatDistanceToNow } from "date-fns";
import { ru } from "date-fns/locale";
import type { ActivityFeedItem } from "@/hooks/admin/useDashboardData";

interface ActivityFeedWidgetProps {
    data: ActivityFeedItem[];
    isLoading: boolean;
}

export default function ActivityFeedWidget({ data, isLoading }: ActivityFeedWidgetProps) {
    const getActivityIcon = (type: ActivityFeedItem['type']) => {
        switch (type) {
            case 'reservation_created':
                return <Calendar className="w-4 h-4 text-blue-600" />;
            case 'reservation_cancelled':
                return <X className="w-4 h-4 text-red-600" />;
            case 'rental_started':
                return <Play className="w-4 h-4 text-green-600" />;
            case 'rental_completed':
                return <CheckCircle className="w-4 h-4 text-green-600" />;
            case 'user_registered':
                return <UserPlus className="w-4 h-4 text-purple-600" />;
            case 'equipment_added':
                return <Package className="w-4 h-4 text-orange-600" />;
            default:
                return <Activity className="w-4 h-4 text-gray-600" />;
        }
    };

    const getActivityColor = (type: ActivityFeedItem['type']) => {
        switch (type) {
            case 'reservation_created':
                return 'bg-blue-50 border-blue-200';
            case 'reservation_cancelled':
                return 'bg-red-50 border-red-200';
            case 'rental_started':
                return 'bg-green-50 border-green-200';
            case 'rental_completed':
                return 'bg-green-50 border-green-200';
            case 'user_registered':
                return 'bg-purple-50 border-purple-200';
            case 'equipment_added':
                return 'bg-orange-50 border-orange-200';
            default:
                return 'bg-gray-50 border-gray-200';
        }
    };

    const getActivityBadgeVariant = (type: ActivityFeedItem['type']) => {
        switch (type) {
            case 'reservation_created':
                return 'default' as const;
            case 'reservation_cancelled':
                return 'destructive' as const;
            case 'rental_started':
                return 'secondary' as const;
            case 'rental_completed':
                return 'secondary' as const;
            case 'user_registered':
                return 'outline' as const;
            case 'equipment_added':
                return 'outline' as const;
            default:
                return 'outline' as const;
        }
    };

    const getActivityTypeLabel = (type: ActivityFeedItem['type']) => {
        switch (type) {
            case 'reservation_created':
                return '–†–µ–∑–µ—Ä–≤ —Å–æ–∑–¥–∞–Ω';
            case 'reservation_cancelled':
                return '–†–µ–∑–µ—Ä–≤ –æ—Ç–º–µ–Ω–µ–Ω';
            case 'rental_started':
                return '–ê—Ä–µ–Ω–¥–∞ –Ω–∞—á–∞—Ç–∞';
            case 'rental_completed':
                return '–ê—Ä–µ–Ω–¥–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞';
            case 'user_registered':
                return '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω';
            case 'equipment_added':
                return '–û–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏–µ –¥–æ–±–∞–≤–ª–µ–Ω–æ';
            default:
                return '–°–æ–±—ã—Ç–∏–µ';
        }
    };

    if (isLoading) {
        return (
            <Card>
                <CardHeader>
                    <CardTitle className="flex items-center gap-2">
                        <Activity className="w-5 h-5" />
                        –õ–µ–Ω—Ç–∞ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏
                    </CardTitle>
                </CardHeader>
                <CardContent className="space-y-4">
                    {Array.from({ length: 5 }).map((_, index) => (
                        <div key={index} className="flex items-start gap-3 p-3 border rounded-lg">
                            <Skeleton className="w-8 h-8 rounded-full" />
                            <div className="flex-1 space-y-2">
                                <Skeleton className="h-4 w-3/4" />
                                <Skeleton className="h-3 w-1/2" />
                            </div>
                            <Skeleton className="h-6 w-16" />
                        </div>
                    ))}
                </CardContent>
            </Card>
        );
    }

    return (
        <Card>
            <CardHeader>
                <CardTitle className="flex items-center gap-2">
                    <Activity className="w-5 h-5" />
                    –õ–µ–Ω—Ç–∞ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏
                </CardTitle>
            </CardHeader>
            <CardContent>
                <div className="space-y-3">
                    {data.length > 0 ? (
                        data.map((activity) => (
                            <div 
                                key={activity.id}
                                className={`flex items-start gap-3 p-3 border rounded-lg ${getActivityColor(activity.type)}`}
                            >
                                <div className="flex-shrink-0 mt-0.5">
                                    {getActivityIcon(activity.type)}
                                </div>
                                <div className="flex-1 min-w-0">
                                    <p className="text-sm font-medium text-gray-900 mb-1">
                                        {activity.description}
                                    </p>
                                    <div className="flex items-center gap-2 text-xs text-gray-500">
                                        <span>
                                            {formatDistanceToNow(new Date(activity.timestamp), { 
                                                addSuffix: true, 
                                                locale: ru 
                                            })}
                                        </span>
                                        {activity.user_name && (
                                            <>
                                                <span>‚Ä¢</span>
                                                <span>{activity.user_name}</span>
                                            </>
                                        )}
                                        {activity.equipment_name && (
                                            <>
                                                <span>‚Ä¢</span>
                                                <span>{activity.equipment_name}</span>
                                            </>
                                        )}
                                    </div>
                                </div>
                                <div className="flex-shrink-0">
                                    <Badge 
                                        variant={getActivityBadgeVariant(activity.type)}
                                        className="text-xs"
                                    >
                                        {getActivityTypeLabel(activity.type)}
                                    </Badge>
                                </div>
                            </div>
                        ))
                    ) : (
                        <div className="text-center py-8 text-sm text-gray-500">
                            <Activity className="w-8 h-8 mx-auto mb-2 text-gray-400" />
                            <p>–ù–µ—Ç –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏</p>
                            <p className="text-xs">–°–æ–±—ã—Ç–∏—è –ø–æ—è–≤—è—Ç—Å—è –∑–¥–µ—Å—å –ø–æ –º–µ—Ä–µ –∏—Ö –≤–æ–∑–Ω–∏–∫–Ω–æ–≤–µ–Ω–∏—è</p>
                        </div>
                    )}
                </div>
            </CardContent>
        </Card>
    );
}


```


## <a name="rentalappmainsrccomponentsadmindashboardKpiCardsWidgettsx"></a>`rental-app-main/src/components/admin/dashboard/KpiCardsWidget.tsx`

```tsx
// path: rental-app-main/src/components/admin/dashboard/KpiCardsWidget.tsx

// src/components/admin/dashboard/KpiCardsWidget.tsx

import { Card, CardContent, CardHeader, CardTitle } from "@/components/ui/card";
import { Skeleton } from "@/components/ui/skeleton";
import { 
    Users, 
    UserCheck, 
    Package, 
    Calendar,
    DollarSign,
    TrendingUp,
    BarChart3,
    Clock
} from "lucide-react";
import type { DashboardSummary } from "@/hooks/admin/useDashboardData";

interface KpiCardsWidgetProps {
    data: DashboardSummary['kpi'];
    isLoading: boolean;
}

export default function KpiCardsWidget({ data, isLoading }: KpiCardsWidgetProps) {
    if (isLoading) {
        return (
            <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                {Array.from({ length: 8 }).map((_, index) => (
                    <Card key={index}>
                        <CardHeader className="flex flex-row items-center justify-between space-y-0 pb-2">
                            <Skeleton className="h-4 w-20" />
                            <Skeleton className="h-4 w-4" />
                        </CardHeader>
                        <CardContent>
                            <Skeleton className="h-8 w-16 mb-1" />
                            <Skeleton className="h-3 w-24" />
                        </CardContent>
                    </Card>
                ))}
            </div>
        );
    }

    const kpiCards = [
        {
            title: "–í—Å–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π",
            value: data.total_users.toLocaleString(),
            description: `${data.active_users} –∞–∫—Ç–∏–≤–Ω—ã—Ö`,
            icon: <Users className="h-4 w-4 text-muted-foreground" />,
            trend: data.active_users > 0 ? "positive" : "neutral"
        },
        {
            title: "–ê–∫—Ç–∏–≤–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏",
            value: data.active_users.toLocaleString(),
            description: `${Math.round((data.active_users / data.total_users) * 100)}% –æ—Ç –æ–±—â–µ–≥–æ —á–∏—Å–ª–∞`,
            icon: <UserCheck className="h-4 w-4 text-muted-foreground" />,
            trend: "positive"
        },
        {
            title: "–í—Å–µ–≥–æ –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—è",
            value: data.total_equipment.toLocaleString(),
            description: "–ï–¥–∏–Ω–∏—Ü –≤ –∫–∞—Ç–∞–ª–æ–≥–µ",
            icon: <Package className="h-4 w-4 text-muted-foreground" />,
            trend: "neutral"
        },
        {
            title: "–í—Å–µ–≥–æ —Ä–µ–∑–µ—Ä–≤–æ–≤",
            value: data.total_reservations.toLocaleString(),
            description: "–ó–∞ –≤—Å–µ –≤—Ä–µ–º—è",
            icon: <Calendar className="h-4 w-4 text-muted-foreground" />,
            trend: "positive"
        },
        {
            title: "–í—ã—Ä—É—á–∫–∞ —Å–µ–≥–æ–¥–Ω—è",
            value: `${data.revenue_today.toLocaleString()} ‚ÇΩ`,
            description: "–ó–∞ —Ç–µ–∫—É—â–∏–π –¥–µ–Ω—å",
            icon: <DollarSign className="h-4 w-4 text-muted-foreground" />,
            trend: data.revenue_today > 0 ? "positive" : "neutral"
        },
        {
            title: "–í—ã—Ä—É—á–∫–∞ –∑–∞ –º–µ—Å—è—Ü",
            value: `${data.revenue_this_month.toLocaleString()} ‚ÇΩ`,
            description: "–ó–∞ —Ç–µ–∫—É—â–∏–π –º–µ—Å—è—Ü",
            icon: <TrendingUp className="h-4 w-4 text-muted-foreground" />,
            trend: "positive"
        },
        {
            title: "–ó–∞–≥—Ä—É–∂–µ–Ω–Ω–æ—Å—Ç—å",
            value: `${data.occupancy_rate.toFixed(1)}%`,
            description: "–°—Ä–µ–¥–Ω—è—è –∑–∞–≥—Ä—É–∂–µ–Ω–Ω–æ—Å—Ç—å",
            icon: <BarChart3 className="h-4 w-4 text-muted-foreground" />,
            trend: data.occupancy_rate > 70 ? "positive" : data.occupancy_rate > 40 ? "neutral" : "negative"
        },
        {
            title: "–°—Ä–µ–¥–Ω—è—è –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å",
            value: `${data.avg_rental_duration.toFixed(1)} –¥–Ω.`,
            description: "–ê—Ä–µ–Ω–¥—ã",
            icon: <Clock className="h-4 w-4 text-muted-foreground" />,
            trend: "neutral"
        }
    ];

    const getTrendColor = (trend: string) => {
        switch (trend) {
            case "positive":
                return "text-green-600";
            case "negative":
                return "text-red-600";
            default:
                return "text-gray-600";
        }
    };

    return (
        <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
            {kpiCards.map((card, index) => (
                <Card key={index} className="hover:shadow-md transition-shadow">
                    <CardHeader className="flex flex-row items-center justify-between space-y-0 pb-2">
                        <CardTitle className="text-sm font-medium">{card.title}</CardTitle>
                        {card.icon}
                    </CardHeader>
                    <CardContent>
                        <div className={`text-2xl font-bold ${getTrendColor(card.trend)}`}>
                            {card.value}
                        </div>
                        <p className="text-xs text-muted-foreground">
                            {card.description}
                        </p>
                    </CardContent>
                </Card>
            ))}
        </div>
    );
}


```


## <a name="rentalappmainsrccomponentsadmindashboardPopularEquipmentCharttsx"></a>`rental-app-main/src/components/admin/dashboard/PopularEquipmentChart.tsx`

```tsx
// path: rental-app-main/src/components/admin/dashboard/PopularEquipmentChart.tsx

// src/components/admin/dashboard/PopularEquipmentChart.tsx

import { Card, CardContent, CardHeader, CardTitle } from "@/components/ui/card";
import { Skeleton } from "@/components/ui/skeleton";
import { Badge } from "@/components/ui/badge";
import { BarChart3, TrendingUp, Package } from "lucide-react";
import type { PopularEquipmentItem } from "@/hooks/admin/useDashboardData";
import { formatNumber } from "@/lib/utils";

interface PopularEquipmentChartProps {
    data: PopularEquipmentItem[];
    isLoading: boolean;
}

export default function PopularEquipmentChart({ data, isLoading }: PopularEquipmentChartProps) {
    if (isLoading) {
        return (
            <Card>
                <CardHeader>
                    <CardTitle className="flex items-center gap-2">
                        <BarChart3 className="w-5 h-5" />
                        –ü–æ–ø—É–ª—è—Ä–Ω–æ–µ –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏–µ
                    </CardTitle>
                </CardHeader>
                <CardContent className="space-y-4">
                    {Array.from({ length: 5 }).map((_, index) => (
                        <div key={index} className="space-y-2">
                            <div className="flex justify-between items-center">
                                <Skeleton className="h-4 w-32" />
                                <Skeleton className="h-4 w-16" />
                            </div>
                            <Skeleton className="h-6 w-full" />
                        </div>
                    ))}
                </CardContent>
            </Card>
        );
    }

    if (data.length === 0) {
        return (
            <Card>
                <CardHeader>
                    <CardTitle className="flex items-center gap-2">
                        <BarChart3 className="w-5 h-5" />
                        –ü–æ–ø—É–ª—è—Ä–Ω–æ–µ –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏–µ
                    </CardTitle>
                </CardHeader>
                <CardContent>
                    <div className="text-center py-8 text-sm text-gray-500">
                        <BarChart3 className="w-8 h-8 mx-auto mb-2 text-gray-400" />
                        <p>–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –ø–æ—Å—Ç—Ä–æ–µ–Ω–∏—è –≥—Ä–∞—Ñ–∏–∫–∞</p>
                        <p className="text-xs">–î–∞–Ω–Ω—ã–µ –ø–æ—è–≤—è—Ç—Å—è –ø–æ—Å–ª–µ –ø–µ—Ä–≤—ã—Ö –∞—Ä–µ–Ω–¥</p>
                    </div>
                </CardContent>
            </Card>
        );
    }

    // –°–æ—Ä—Ç–∏—Ä—É–µ–º –¥–∞–Ω–Ω—ã–µ –ø–æ –∫–æ–ª–∏—á–µ—Å—Ç–≤—É –∞—Ä–µ–Ω–¥ (–ø–æ —É–±—ã–≤–∞–Ω–∏—é)
    const sortedData = [...data].sort((a, b) => (b.rental_count || 0) - (a.rental_count || 0));
    
    // –ë–µ—Ä–µ–º —Ç–æ–ø-10 –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è
    const topData = sortedData.slice(0, 10);
    
    // –î–æ–±–∞–≤–ª—è–µ–º fallback ID –¥–ª—è —ç–ª–µ–º–µ–Ω—Ç–æ–≤ –±–µ–∑ equipment_id
    const dataWithIds = topData.map((item, index) => ({
        ...item,
        equipment_id: item.equipment_id || `fallback-${index}`
    }));
    
    
    // –ù–∞—Ö–æ–¥–∏–º –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ –¥–ª—è –Ω–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏–∏
    const maxRentals = topData.length > 0 ? Math.max(...topData.map(item => item.rental_count || 0)) : 0;


    const totalRentals = data.reduce((sum, item) => sum + (item.rental_count || 0), 0);
    const totalRevenue = data.reduce((sum, item) => sum + (item.revenue || 0), 0);

    return (
        <Card>
            <CardHeader>
                <CardTitle className="flex items-center gap-2">
                    <BarChart3 className="w-5 h-5" />
                    –ü–æ–ø—É–ª—è—Ä–Ω–æ–µ –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏–µ
                </CardTitle>
            </CardHeader>
            <CardContent className="space-y-6">
                {/* –°–≤–æ–¥–Ω–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ */}
                <div className="grid grid-cols-2 gap-4 p-4 bg-gray-50 rounded-lg">
                    <div className="text-center">
                        <div className="flex items-center justify-center gap-1 mb-1">
                            <Package className="w-4 h-4 text-blue-600" />
                            <span className="text-sm font-medium text-gray-600">–í—Å–µ–≥–æ –∞—Ä–µ–Ω–¥</span>
                        </div>
                        <div className="text-2xl font-bold text-gray-900">
                            {formatNumber(totalRentals, "0")}
                        </div>
                    </div>
                    <div className="text-center">
                        <div className="flex items-center justify-center gap-1 mb-1">
                            <TrendingUp className="w-4 h-4 text-green-600" />
                            <span className="text-sm font-medium text-gray-600">–í—ã—Ä—É—á–∫–∞</span>
                        </div>
                        <div className="text-2xl font-bold text-gray-900">
                            {formatNumber(totalRevenue, "0")} ‚ÇΩ
                        </div>
                    </div>
                </div>

                {/* –ì—Ä–∞—Ñ–∏–∫ */}
                <div className="space-y-4">
                    {dataWithIds.map((item, index) => (
                        <div key={item.equipment_id} className="space-y-2">
                            <div className="flex justify-between items-center">
                                <div className="flex items-center gap-2">
                                    <span className="text-sm font-medium text-gray-900 truncate max-w-[200px]">
                                        {item.equipment_name}
                                    </span>
                                    {index < 3 && (
                                        <Badge 
                                            variant={index === 0 ? "default" : "secondary"}
                                            className="text-xs"
                                        >
                                            #{index + 1}
                                        </Badge>
                                    )}
                                </div>
                                <div className="text-right">
                                    <div className="text-sm font-semibold text-gray-900">
                                        {formatNumber(item.rental_count, "0")}
                                    </div>
                                    <div className="text-xs text-gray-500">
                                        {formatNumber(item.revenue, "0")} ‚ÇΩ
                                    </div>
                                </div>
                            </div>
                            <div className="relative">
                                <div className="w-full bg-gray-200 rounded-full h-6 overflow-hidden">
                                    <div 
                                        className={`h-full transition-all duration-500 ease-out ${
                                            index === 0 
                                                ? 'bg-gradient-to-r from-blue-500 to-blue-600' 
                                                : index === 1 
                                                ? 'bg-gradient-to-r from-green-500 to-green-600'
                                                : index === 2
                                                ? 'bg-gradient-to-r from-yellow-500 to-yellow-600'
                                                : 'bg-gradient-to-r from-gray-400 to-gray-500'
                                        }`}
                                        style={{ width: `${maxRentals > 0 ? ((item.rental_count || 0) / maxRentals) * 100 : 0}%` }}
                                    />
                                </div>
                                <div className="absolute inset-0 flex items-center justify-center">
                                    <span className="text-xs font-medium text-white mix-blend-difference">
                                        {maxRentals > 0 ? (((item.rental_count || 0) / maxRentals) * 100).toFixed(1) : 0}%
                                    </span>
                                </div>
                            </div>
                        </div>
                    ))}
                </div>

                {/* –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è */}
                {data.length > 10 && (
                    <div className="text-center text-sm text-gray-500 pt-2 border-t">
                        –ü–æ–∫–∞–∑–∞–Ω—ã —Ç–æ–ø-10 –∏–∑ {data.length} –ø–æ–∑–∏—Ü–∏–π
                    </div>
                )}
            </CardContent>
        </Card>
    );
}


```


## <a name="rentalappmainsrccomponentsadmindashboardTodayFocusWidgettsx"></a>`rental-app-main/src/components/admin/dashboard/TodayFocusWidget.tsx`

```tsx
// path: rental-app-main/src/components/admin/dashboard/TodayFocusWidget.tsx

// src/components/admin/dashboard/TodayFocusWidget.tsx

import { useNavigate } from "react-router-dom";
import { Card, CardContent, CardHeader, CardTitle } from "@/components/ui/card";
import { Badge } from "@/components/ui/badge";
import { Skeleton } from "@/components/ui/skeleton";
import { 
    Package, 
    ArrowUpCircle, 
    ArrowDownCircle, 
    AlertTriangle,
    Clock,
    User
} from "lucide-react";
import { differenceInDays } from "date-fns";
import { calculateDaysOverdue } from "@/lib/utils";
import { sortPickupsByPriority, sortOverdueRentalsByDays, getTodayDate } from "@/lib/sortingUtils";
import type { PickupReturnItem, OverdueRentalItem } from "@/hooks/admin/useDashboardData";

interface TodayFocusWidgetProps {
    data: {
        pickups_today: PickupReturnItem[];
        returns_today: PickupReturnItem[];
        overdue_rentals: OverdueRentalItem[];
    };
    isLoading: boolean;
}

export default function TodayFocusWidget({ data, isLoading }: TodayFocusWidgetProps) {
    const navigate = useNavigate();
    
    // –ü–æ–ª—É—á–∞–µ–º —Å–µ–≥–æ–¥–Ω—è—à–Ω—é—é –¥–∞—Ç—É —Å –æ–±–Ω—É–ª–µ–Ω–Ω—ã–º –≤—Ä–µ–º–µ–Ω–µ–º –¥–ª—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–≥–æ —Å—Ä–∞–≤–Ω–µ–Ω–∏—è
    const today = getTodayDate();

    const handlePickupClick = (item: PickupReturnItem) => {
        navigate('/admin/reservations', {
            state: {
                highlightId: item.id,
                statusFilterOverride: 'active' // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∞–∫—Ç–∏–≤–Ω—ã–µ, —á—Ç–æ–±—ã –Ω–∞–π—Ç–∏ –Ω—É–∂–Ω—ã–π
            }
        });
    };

    const handleReturnClick = (item: PickupReturnItem) => {
        navigate('/admin/rentals', {
            state: {
                highlightId: item.id,
                statusFilterOverride: 'active'
            }
        });
    };

    const handleOverdueClick = (item: OverdueRentalItem) => {
        navigate('/admin/rentals', {
            state: {
                highlightId: item.id,
                statusFilterOverride: 'overdue'
            }
        });
    };

    if (isLoading) {
        return (
            <Card>
                <CardHeader>
                    <CardTitle className="flex items-center gap-2">
                        <Package className="w-5 h-5" />
                        –§–æ–∫—É—Å –Ω–∞ —Å–µ–≥–æ–¥–Ω—è
                    </CardTitle>
                </CardHeader>
                <CardContent className="space-y-4">
                    <div className="space-y-2">
                        <Skeleton className="h-4 w-24" />
                        <Skeleton className="h-16 w-full" />
                    </div>
                    <div className="space-y-2">
                        <Skeleton className="h-4 w-24" />
                        <Skeleton className="h-16 w-full" />
                    </div>
                    <div className="space-y-2">
                        <Skeleton className="h-4 w-24" />
                        <Skeleton className="h-16 w-full" />
                    </div>
                </CardContent>
            </Card>
        );
    }

    const renderPickupItem = (item: PickupReturnItem) => {
        // –û–ø—Ä–µ–¥–µ–ª—è–µ–º, —è–≤–ª—è–µ—Ç—Å—è –ª–∏ –≤—ã–¥–∞—á–∞ "–æ–∂–∏–¥–∞—é—â–µ–π"
        const itemStartDate = item.start_date ? new Date(item.start_date) : null;
        const isPendingPickup = itemStartDate && itemStartDate < today;
        const daysPassed = itemStartDate ? differenceInDays(today, itemStartDate) : 0;

        // –û–ø—Ä–µ–¥–µ–ª—è–µ–º –∫–ª–∞—Å—Å—ã –∏ —Ç–µ–∫—Å—Ç –Ω–∞ –æ—Å–Ω–æ–≤–µ —Å—Ç–∞—Ç—É—Å–∞
        const bgColor = isPendingPickup ? "bg-cyan-50 hover:bg-cyan-100" : "bg-blue-50 hover:bg-blue-100";
        const iconColor = isPendingPickup ? "text-cyan-600" : "text-blue-600";
        const badgeText = isPendingPickup ? `–ö –≤—ã–¥–∞—á–µ (-${daysPassed} –¥–Ω.)` : "–í—ã–¥–∞—á–∞ —Å–µ–≥–æ–¥–Ω—è";
        const badgeVariant = isPendingPickup ? "outline" : "secondary";

        return (
            <div 
                key={item.id}
                className={`flex items-center justify-between p-3 rounded-lg cursor-pointer ${bgColor} transition-colors`}
                onClick={() => handlePickupClick(item)}
            >
                <div className="flex-1 min-w-0">
                    <div className="flex items-center gap-2 mb-1">
                        <User className={`w-4 h-4 ${iconColor} flex-shrink-0`} />
                        <span className="font-medium text-sm truncate">{item.user_name}</span>
                    </div>
                    <div className="flex items-center gap-2 text-xs text-gray-600">
                        <Package className="w-3 h-3 flex-shrink-0" />
                        <span className="truncate">{item.equipment_name}</span>
                    </div>
                </div>
                <div className="text-right ml-2">
                    <div className="flex items-center justify-end gap-1 text-xs text-gray-500 mb-1">
                        <Clock className="w-3 h-3" />
                        <span>{item.scheduled_time ? new Date(item.scheduled_time).toLocaleDateString('ru-RU') : '–ù–µ —É–∫–∞–∑–∞–Ω–æ'}</span>
                    </div>
                    <Badge variant={badgeVariant} className="text-xs">
                        {badgeText}
                    </Badge>
                </div>
            </div>
        );
    };

    const renderReturnItem = (item: PickupReturnItem) => (
        <div 
            key={item.id}
            className="flex items-center justify-between p-3 bg-green-50 rounded-lg cursor-pointer hover:bg-green-100 transition-colors"
            onClick={() => handleReturnClick(item)}
        >
            <div className="flex-1 min-w-0">
                <div className="flex items-center gap-2 mb-1">
                    <User className="w-4 h-4 text-green-600 flex-shrink-0" />
                    <span className="font-medium text-sm truncate">{item.user_name}</span>
                </div>
                <div className="flex items-center gap-2 text-xs text-gray-600">
                    <Package className="w-3 h-3 flex-shrink-0" />
                    <span className="truncate">{item.equipment_name}</span>
                </div>
            </div>
            <div className="text-right ml-2">
                <div className="flex items-center justify-end gap-1 text-xs text-gray-500 mb-1">
                    <Clock className="w-3 h-3" />
                    <span>{item.scheduled_time ? new Date(item.scheduled_time).toLocaleDateString('ru-RU') : '–ù–µ —É–∫–∞–∑–∞–Ω–æ'}</span>
                </div>
                <Badge variant="secondary" className="text-xs">
                    {item.status}
                </Badge>
            </div>
        </div>
    );

    const renderOverdueItem = (item: OverdueRentalItem) => {
        // –ò—Å–ø–æ–ª—å–∑—É–µ–º —É—Ç–∏–ª–∏—Ç–∞—Ä–Ω—É—é —Ñ—É–Ω–∫—Ü–∏—é –¥–ª—è –≤—ã—á–∏—Å–ª–µ–Ω–∏—è –¥–Ω–µ–π –ø—Ä–æ—Å—Ä–æ—á–∫–∏
        const daysOverdue = calculateDaysOverdue(item.due_date, item.days_overdue);

        return (
            <div 
                key={item.id}
                className="flex items-center justify-between p-3 bg-red-50 rounded-lg cursor-pointer hover:bg-red-100 transition-colors"
                onClick={() => handleOverdueClick(item)}
            >
                <div className="flex-1 min-w-0">
                    <div className="flex items-center gap-2 mb-1">
                        <User className="w-4 h-4 text-red-600 flex-shrink-0" />
                        <span className="font-medium text-sm truncate">{item.user_name}</span>
                    </div>
                    <div className="flex items-center gap-2 text-xs text-gray-600">
                        <Package className="w-3 h-3 flex-shrink-0" />
                        <span className="truncate">{item.equipment_name}</span>
                    </div>
                </div>
                <div className="text-right ml-2">
                    <div className="flex items-center justify-end gap-1 text-xs text-red-600 mb-1">
                        <AlertTriangle className="w-3 h-3" />
                        <span>
                            {daysOverdue > 0 ? `${daysOverdue} –¥–Ω.` : '–ü—Ä–æ—Å—Ä–æ—á–µ–Ω–æ'}
                        </span>
                    </div>
                    <Badge variant="destructive" className="text-xs">
                        –ü—Ä–æ—Å—Ä–æ—á–µ–Ω–æ
                    </Badge>
                </div>
            </div>
        );
    };

    return (
        <Card>
            <CardHeader>
                <CardTitle className="flex items-center gap-2">
                    <Package className="w-5 h-5" />
                    –§–æ–∫—É—Å –Ω–∞ —Å–µ–≥–æ–¥–Ω—è
                </CardTitle>
            </CardHeader>
            <CardContent className="space-y-6">
                {/* –í—ã–¥–∞—á–∏ —Å–µ–≥–æ–¥–Ω—è */}
                <div>
                    <div className="flex items-center gap-2 mb-3">
                        <ArrowUpCircle className="w-4 h-4 text-blue-600" />
                        <h3 className="font-medium text-sm">–í—ã–¥–∞—á–∏ —Å–µ–≥–æ–¥–Ω—è</h3>
                        <Badge variant="outline" className="text-xs">
                            {data.pickups_today.length}
                        </Badge>
                    </div>
                    <div className="space-y-2">
                        {data.pickups_today.length > 0 ? (
                            sortPickupsByPriority(data.pickups_today, today).map(renderPickupItem)
                        ) : (
                            <div className="text-center py-4 text-sm text-gray-500">
                                –°–µ–≥–æ–¥–Ω—è –Ω–µ—Ç –≤—ã–¥–∞—á
                            </div>
                        )}
                    </div>
                </div>

                {/* –í–æ–∑–≤—Ä–∞—Ç—ã —Å–µ–≥–æ–¥–Ω—è */}
                <div>
                    <div className="flex items-center gap-2 mb-3">
                        <ArrowDownCircle className="w-4 h-4 text-green-600" />
                        <h3 className="font-medium text-sm">–í–æ–∑–≤—Ä–∞—Ç—ã —Å–µ–≥–æ–¥–Ω—è</h3>
                        <Badge variant="outline" className="text-xs">
                            {data.returns_today.length}
                        </Badge>
                    </div>
                    <div className="space-y-2">
                        {data.returns_today.length > 0 ? (
                            data.returns_today.map(renderReturnItem)
                        ) : (
                            <div className="text-center py-4 text-sm text-gray-500">
                                –°–µ–≥–æ–¥–Ω—è –Ω–µ—Ç –≤–æ–∑–≤—Ä–∞—Ç–æ–≤
                            </div>
                        )}
                    </div>
                </div>

                {/* –ü—Ä–æ—Å—Ä–æ—á–µ–Ω–Ω—ã–µ –∞—Ä–µ–Ω–¥—ã */}
                <div>
                    <div className="flex items-center gap-2 mb-3">
                        <AlertTriangle className="w-4 h-4 text-red-600" />
                        <h3 className="font-medium text-sm">–ü—Ä–æ—Å—Ä–æ—á–µ–Ω–Ω—ã–µ –∞—Ä–µ–Ω–¥—ã</h3>
                        <Badge variant="outline" className="text-xs">
                            {data.overdue_rentals.length}
                        </Badge>
                    </div>
                    <div className="space-y-2">
                        {data.overdue_rentals.length > 0 ? (
                            sortOverdueRentalsByDays(data.overdue_rentals).map(renderOverdueItem)
                        ) : (
                            <div className="text-center py-4 text-sm text-gray-500">
                                –ù–µ—Ç –ø—Ä–æ—Å—Ä–æ—á–µ–Ω–Ω—ã—Ö –∞—Ä–µ–Ω–¥
                            </div>
                        )}
                    </div>
                </div>
            </CardContent>
        </Card>
    );
}


```


## <a name="rentalappmainsrccomponentscalendarCalendarDateInputRangetsx"></a>`rental-app-main/src/components/calendar/CalendarDateInputRange.tsx`

```tsx
// path: rental-app-main/src/components/calendar/CalendarDateInputRange.tsx

// src/components/calendar/CalendarDateInputRange.tsx

import { useDateStore } from "@/store/dateStore";
import { useDateRange } from "@/hooks/useDateRange";

export default function CalendarDateInputRange() {
    // ‚úÖ –ò–°–ü–†–ê–í–õ–ï–ù–û: –ü–æ–ª—É—á–∞–µ–º –∞–∫—Ç—É–∞–ª—å–Ω—ã–µ startDate, endDate –∏ setRange –∏–∑ —Ö—Ä–∞–Ω–∏–ª–∏—â–∞
    const { startDate, endDate, setRange } = useDateStore();

    const {
        localStartDate,
        localEndDate,
        handleStartDateChange,
        handleEndDateChange
    } = useDateRange({
        // ‚úÖ –ò–°–ü–†–ê–í–õ–ï–ù–û: –ü–µ—Ä–µ–¥–∞—ë–º –∞–∫—Ç—É–∞–ª—å–Ω—ã–µ –¥–∞—Ç—ã –≤ —Ö—É–∫
        startDate,
        endDate,
        onRangeChange: (start, end, source) => setRange(start, end, source)
    });

    return (
        <div className="flex items-center gap-2" role="group" aria-labelledby="date-range-label">
            <span id="date-range-label" className="sr-only">–í—ã–±–æ—Ä –¥–∏–∞–ø–∞–∑–æ–Ω–∞ –¥–∞—Ç –∫–∞–ª–µ–Ω–¥–∞—Ä—è</span>
            <label htmlFor="calendar-start-date" className="text-sm text-gray-700 shrink-0">
                –°:
            </label>
            <input
                id="calendar-start-date"
                type="date"
                value={localStartDate}
                onChange={handleStartDateChange}
                className="border border-gray-300 rounded px-2 py-1.5 text-sm focus:ring-2 focus:ring-sky-500 focus:border-sky-500"
                aria-label="–î–∞—Ç–∞ –Ω–∞—á–∞–ª–∞ –¥–ª—è –∫–∞–ª–µ–Ω–¥–∞—Ä—è"
            />

            <label htmlFor="calendar-end-date" className="text-sm text-gray-700 shrink-0">
                –ü–æ:
            </label>
            <input
                id="calendar-end-date"
                type="date"
                value={localEndDate}
                onChange={handleEndDateChange}
                className="border border-gray-300 rounded px-2 py-1.5 text-sm focus:ring-2 focus:ring-sky-500 focus:border-sky-500"
                aria-label="–î–∞—Ç–∞ –æ–∫–æ–Ω—á–∞–Ω–∏—è –¥–ª—è –∫–∞–ª–µ–Ω–¥–∞—Ä—è"
                min={localStartDate}
            />
        </div>
    );
}

```


## <a name="rentalappmainsrccomponentscalendarCalendarFiltersBlocktsx"></a>`rental-app-main/src/components/calendar/CalendarFiltersBlock.tsx`

```tsx
// path: rental-app-main/src/components/calendar/CalendarFiltersBlock.tsx

// src/components/calendar/CalendarFiltersBlock.tsx
import CalendarDateInputRange from "@/components/calendar/CalendarDateInputRange";
import { Button } from "@/components/ui/button";
import { FilterX } from "lucide-react";
import type { Equipment } from "@/types/equipment";

type Props = {
    equipment: Equipment[];
    typeFilter: string | null;
    setTypeFilter: (v: string | null) => void;
    brandFilter: string | null;
    setBrandFilter: (v: string | null) => void;
    searchText: string;
    setSearchText: (v: string) => void;
    onReset: () => void;
};

export default function CalendarFiltersBlock({
                                                 equipment,
                                                 typeFilter,
                                                 setTypeFilter,
                                                 brandFilter,
                                                 setBrandFilter,
                                                 searchText,
                                                 setSearchText,
                                                 onReset,
                                             }: Props) {
    const types = Array.from(new Set(equipment.map((e) => e.equipment_type)));
    const brands = Array.from(new Set(equipment.map((e) => e.brand)));

    return (
        <div className="flex flex-col gap-4 mb-5 p-4 bg-gray-50 border border-gray-200 rounded-lg shadow-sm print:hidden">
            <div className="flex flex-col md:flex-row md:items-end md:justify-between gap-2">
                <div className="flex flex-col gap-2">
                    <input
                        type="text"
                        placeholder="–ü–æ–∏—Å–∫ –ø–æ –Ω–∞–∑–≤–∞–Ω–∏—é..."
                        value={searchText}
                        onChange={(e) => setSearchText(e.target.value)}
                        className="border px-3 py-1 rounded-md text-sm w-[250px]"
                    />
                    <CalendarDateInputRange />
                </div>
                <Button
                    variant="ghost"
                    onClick={onReset}
                    className="text-gray-600 hover:text-sky-700"
                >
                    <FilterX className="w-4 h-4 mr-1" />
                    –°–±—Ä–æ—Å–∏—Ç—å
                </Button>
            </div>

            <div className="flex flex-wrap items-center gap-2">
                <span className="text-sm text-gray-600 mr-2">–¢–∏–ø:</span>
                <Button
                    variant="filter"
                    data-state={typeFilter === null ? "on" : "off"}
                    onClick={() => setTypeFilter(null)}
                >
                    –í—Å–µ
                </Button>
                {types.map((type) => (
                    <Button
                        key={type}
                        variant="filter"
                        data-state={typeFilter === type ? "on" : "off"}
                        onClick={() => setTypeFilter(type)}
                    >
                        {type}
                    </Button>
                ))}
            </div>

            <div className="flex flex-wrap items-center gap-2">
                <span className="text-sm text-gray-600 mr-2">–ë—Ä–µ–Ω–¥:</span>
                <Button
                    variant="filter"
                    data-state={brandFilter === null ? "on" : "off"}
                    onClick={() => setBrandFilter(null)}
                >
                    –í—Å–µ
                </Button>
                {brands.map((brand) => (
                    <Button
                        key={brand}
                        variant="filter"
                        data-state={brandFilter === brand ? "on" : "off"}
                        onClick={() => setBrandFilter(brand)}
                    >
                        {brand}
                    </Button>
                ))}
            </div>
        </div>
    );
}


```


## <a name="rentalappmainsrccomponentscalendarCalendarTabletsx"></a>`rental-app-main/src/components/calendar/CalendarTable.tsx`

```tsx
// path: rental-app-main/src/components/calendar/CalendarTable.tsx

// src/components/calendar/CalendarTable.tsx
import { useCalendarGrid } from "@/hooks/useCalendarGrid";
import { format } from "date-fns";
import { useDateStore } from "@/store/dateStore";
import { useCalendarSelectionStore } from "@/store/calendarSelectionStore";
// import { useCurrentUser } from "@/hooks/useProfile"; // –ù–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –Ω–∞–ø—Ä—è–º—É—é –¥–ª—è —Å—Ç–∏–ª–∏–∑–∞—Ü–∏–∏
import type { DayStatus, EquipmentStatus } from "@/types/availability";

type Equipment = {
    id: number;
    name: string;
    brand: string;
    equipment_type: string;
};

function getDateRange(start: Date, end: Date): Date[] {
    const days = [];
    let d = new Date(start);
    while (d <= end) {
        days.push(new Date(d));
        d.setDate(d.getDate() + 1);
    }
    return days;
}

function formatDateToDayMonthYear(date: Date): string {
    return format(date, "dd.MM.yyyy");
}

const cellBgMap: Record<string, string> = {
    available: "bg-emerald-50",
    reserved: "bg-amber-300",  // –ß—É–∂–∏–µ —Ä–µ–∑–µ—Ä–≤—ã
    rented: "bg-rose-400",     // –ß—É–∂–∏–µ –∞—Ä–µ–Ω–¥—ã
};

const userCellBgMap: Record<string, string> = {
    available: "bg-emerald-50", // –°–≤–æ–±–æ–¥–Ω—ã–µ —è—á–µ–π–∫–∏ –æ–¥–∏–Ω–∞–∫–æ–≤—ã –¥–ª—è –≤—Å–µ—Ö
    reserved: "bg-amber-500",  // –°–í–û–ô —Ä–µ–∑–µ—Ä–≤ - —Ç–µ–º–Ω–µ–µ
    rented: "bg-rose-600",     // –°–í–û–Ø –∞—Ä–µ–Ω–¥–∞ (–µ—Å–ª–∏ –ø—Ä–∏–º–µ–Ω–∏–º–æ –∏ –Ω—É–∂–Ω–æ –æ—Ç–ª–∏—á–∞—Ç—å) - —Ç–µ–º–Ω–µ–µ
};

export default function CalendarTable({ equipment }: { equipment: Equipment[] }) {
    const { startDate, endDate } = useDateStore();
    const { data: calendarDataFromHook, isLoading, isError, refetch } = useCalendarGrid();
    const { selectedGroupId, setSelectedGroupId } = useCalendarSelectionStore();

    if (!startDate || !endDate) return null;
    if (isLoading) return <div className="p-6 text-center">–ó–∞–≥—Ä—É–∑–∫–∞...</div>;
    if (isError)
        return (
            <div className="p-6 text-center text-red-700">
                –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ <button onClick={() => refetch()} className="underline hover:text-red-800">–ü–æ–≤—Ç–æ—Ä–∏—Ç—å</button>
            </div>
        );
    if (!equipment.length || !calendarDataFromHook || Object.keys(calendarDataFromHook).length === 0)
        return <div className="p-6 text-center text-gray-500">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –≤—ã–±—Ä–∞–Ω–Ω—ã—Ö —Ñ–∏–ª—å—Ç—Ä–æ–≤</div>;

    const dateRange = getDateRange(startDate, endDate);
    const todayStr = formatDateToDayMonthYear(new Date());

    return (
        <div
            className="overflow-x-auto rounded-xl border bg-white shadow"
            onClick={() => setSelectedGroupId(null)} // —Å–±—Ä–æ—Å –≤—ã–¥–µ–ª–µ–Ω–∏—è –ø—Ä–∏ –∫–ª–∏–∫–µ –≤–Ω–µ —è—á–µ–µ–∫
        >
            <table className="min-w-max table-auto border-collapse">
                <thead>
                <tr>
                    <th
                        className="sticky left-0 z-20 bg-white border-b px-4 py-2 text-sm font-semibold min-w-[220px]"
                        style={{ boxShadow: "2px 0 6px -2px #e0e7ef" }}
                    >
                        –û–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏–µ
                    </th>
                    {dateRange.map((date) => {
                        const dateStr = formatDateToDayMonthYear(date);
                        const isToday = dateStr === todayStr;

                        return (
                            <th
                                key={dateStr}
                                className={`sticky top-0 z-10 border-b px-2 py-1 text-xs font-medium min-w-[90px] truncate ${
                                    isToday
                                        ? "bg-sky-100 text-sky-800 border-sky-400 border-b-2 today-column"
                                        : "bg-white"
                                }`}
                            >
                                {dateStr}
                            </th>
                        );
                    })}
                </tr>
                </thead>
                <tbody>
                {equipment.map((item) => (
                    <tr key={item.id}>
                        <td className="sticky left-0 bg-white border-r px-3 py-1 z-10 min-w-[220px] text-xs text-gray-800 truncate">
                            {item.equipment_type} {item.brand} {item.name}
                        </td>
                        {dateRange.map((date) => {
                            const dateStr = formatDateToDayMonthYear(date);

                            const cellItemData = calendarDataFromHook[item.id]?.[dateStr];

                            let cell: DayStatus | undefined;

                            // –ë—ç–∫–µ–Ω–¥ —Ç–µ–ø–µ—Ä—å –≤—Å–µ–≥–¥–∞ –¥–æ–ª–∂–µ–Ω –≤–æ–∑–≤—Ä–∞—â–∞—Ç—å –æ–±—ä–µ–∫—Ç DayStatusItem (–∫–æ—Ç–æ—Ä—ã–π —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç DayStatus –Ω–∞ —Ñ—Ä–æ–Ω—Ç–µ)
                            if (typeof cellItemData === 'object' && cellItemData !== null && 'status' in cellItemData) {
                                cell = cellItemData as DayStatus;
                            } else if (typeof cellItemData === 'string') {
                                // –≠—Ç–æ—Ç –±–ª–æ–∫ –¥–ª—è –æ–±—Ä–∞—Ç–Ω–æ–π —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏, –µ—Å–ª–∏ –±—ç–∫–µ–Ω–¥ –í–î–†–£–ì –≤–µ—Ä–Ω–µ—Ç —Å—Ç—Ä–æ–∫—É
                                console.warn(`[CalendarTable] Received string status for ${item.name} on ${dateStr}. Expected DayStatus object.`);
                                cell = { status: cellItemData as EquipmentStatus, group_id: null, is_user_reservation: false };
                            }

                            const status: EquipmentStatus = cell?.status || "available";
                            const groupId: string | null = cell?.group_id || null;
                            const isUserReservation: boolean = cell?.is_user_reservation || false;
                            const isToday = dateStr === todayStr;

                            const isHighlighted: boolean = !!(groupId && groupId === selectedGroupId);

                            const handleClick = (e: React.MouseEvent) => {
                                e.stopPropagation();
                                setSelectedGroupId(groupId === selectedGroupId ? null : groupId);
                            };

                            const currentBgMap = isUserReservation ? userCellBgMap : cellBgMap;
                            const bgColor = currentBgMap[status] || currentBgMap['available']; // –§–æ–ª–±—ç–∫ –Ω–∞ 'available'

                            return (
                                <td
                                    key={dateStr}
                                    className={`p-[2px] border border-white ${isToday ? "today-column" : ""}`}
                                    onClick={handleClick}
                                    style={{ cursor: groupId ? 'pointer' : 'default' }} // –î–æ–±–∞–≤–ª—è–µ–º –∫—É—Ä—Å–æ—Ä, –µ—Å–ª–∏ –µ—Å—Ç—å groupId
                                >
                                    <div
                                        className={`w-full h-6 rounded-md transition-colors ${bgColor} ${
                                            isHighlighted ? "ring-2 ring-black/40 ring-inset opacity-90" : ""
                                        }`}
                                        title={status + (isUserReservation ? " (–º–æ–π)" : "") + (groupId ? ` (–≥—Ä—É–ø–ø–∞: ${groupId})` : "")}
                                    >
                                        <span className="sr-only">{status}{isUserReservation ? " (–º–æ–π)" : ""}{groupId ? ` (–≥—Ä—É–ø–ø–∞: ${groupId})` : ""}</span>
                                    </div>
                                </td>
                            );
                        })}
                    </tr>
                ))}
                </tbody>
            </table>
        </div>
    );
}

```


## <a name="rentalappmainsrccomponentscatalogEquipmentCatalogtsx"></a>`rental-app-main/src/components/catalog/EquipmentCatalog.tsx`

```tsx
// path: rental-app-main/src/components/catalog/EquipmentCatalog.tsx

// src/components/catalog/EquipmentCatalog.tsx

import { useMemo } from "react";
import FilterPanel from "@/components/FilterPanel";
import EquipmentGrid from "@/components/EquipmentGrid";
import { useAppFilters } from "@/hooks/features/useAppFilters";
import { useAssociations } from "@/hooks/useAssociations";
import { useAllEquipment } from "@/hooks/useAllEquipment";
import { useEquipmentData } from "@/hooks/data/useEquipmentData";
import { useReservationManagement } from "@/hooks/useReservationManagement";
import { useViewModeStore } from "@/store/viewModeStore";

interface EquipmentCatalogProps {
    editingReservationId?: number;
    intent?: string;
}

/**
 * –ö–æ–º–ø–æ–Ω–µ–Ω—Ç –∫–∞—Ç–∞–ª–æ–≥–∞ –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—è.
 * –ò–Ω–∫–∞–ø—Å—É–ª–∏—Ä—É–µ—Ç –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –∏ —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏—é –∫–∞—Ç–∞–ª–æ–≥–∞ –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—è.
 */
export default function EquipmentCatalog({ editingReservationId: _editingReservationId, intent: _intent }: EquipmentCatalogProps) {
    const { viewMode } = useViewModeStore();

    // 1. –ü–æ–ª—É—á–∞–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ —Ñ–∏–ª—å—Ç—Ä–æ–≤
    const { query, type, brand, availableOnly, associationId, reset: resetFilters, startDate, endDate } = useAppFilters();

    // 2. –ü–æ–ª—É—á–∞–µ–º –¥–∞–Ω–Ω—ã–µ –¥–ª—è —Ñ–∏–ª—å—Ç—Ä–æ–≤
    const { data: _associations = [] } = useAssociations();
    const { data: allEquipmentForFilters = [] } = useAllEquipment();

    // 3. –í—ã–∑—ã–≤–∞–µ–º —Ö—É–∫ –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö —Å —É—á–µ—Ç–æ–º —Ñ–∏–ª—å—Ç—Ä–æ–≤
    const {
        equipment,
        totalEquipmentCount: _totalEquipmentCount,
        availabilityData,
        dailyAvailabilityData,
        isLoading,
        isFetchingNextPage,
        hasNextPage,
        fetchNextPage
    } = useEquipmentData({ 
        query, 
        type: type || undefined, 
        brand, 
        associationId: associationId || undefined, 
        availableOnly, 
        startDate: startDate as Date | undefined, 
        endDate: endDate as Date | undefined 
    });

    // –°–æ–∑–¥–∞–µ–º availabilityMap –∏–∑ availabilityData –¥–ª—è useReservationManagement
    const availabilityMap = useMemo(() => {
        const map: Record<number, any> = {};
        availabilityData?.forEach((info) => {
            map[info.equipment_id] = info;
        });
        return map;
    }, [availabilityData]);

    // 4. –í—ã–∑—ã–≤–∞–µ–º —Ö—É–∫ –¥–ª—è –ª–æ–≥–∏–∫–∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è —Ä–µ–∑–µ—Ä–≤–∞–º–∏
    const {
        getEquipmentStatus
    } = useReservationManagement(equipment, availabilityMap, availableOnly);

    // –í—ã—á–∏—Å–ª—è–µ–º –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è
    const hasActiveFilters = !!(type || (brand && brand !== "__all__") || query || associationId);

    return (
        <>
            <FilterPanel equipmentData={allEquipmentForFilters} />

            <EquipmentGrid
                isLoading={isLoading}
                items={equipment}
                hasActiveFilters={hasActiveFilters}
                getEquipmentStatus={getEquipmentStatus}
                dailyAvailabilityData={dailyAvailabilityData}
                availabilityData={availabilityData}
                onShowMore={fetchNextPage}
                onResetFilters={resetFilters}
                viewMode={viewMode}
                isFetchingNextPage={isFetchingNextPage}
                hasNextPage={hasNextPage}
            />
        </>
    );
}


```


## <a name="rentalappmainsrccomponentsequipmentcardAccessoriesSectiontsx"></a>`rental-app-main/src/components/equipment-card/AccessoriesSection.tsx`

```tsx
// path: rental-app-main/src/components/equipment-card/AccessoriesSection.tsx

// src/components/equipment-card/AccessoriesSection.tsx
import React from 'react';
import { Paperclip, ChevronDown } from "lucide-react";
import { Label } from "@/components/ui/label";
import { Checkbox } from "@/components/ui/checkbox";
import type { Equipment } from "@/types/equipment";

interface AccessoriesSectionProps {
    equipment: Equipment;
    isExpanded: boolean;
    isDisabled: boolean;
    onToggleExpand: (e: React.MouseEvent) => void;
    onToggleAccessory: (accId: number) => void;
    isAccessorySelected: (eqId: number, accId: number) => boolean;
}

export const AccessoriesSection: React.FC<AccessoriesSectionProps> = ({
                                                                          equipment, isExpanded, isDisabled, onToggleExpand, onToggleAccessory, isAccessorySelected
                                                                      }) => {
    if (!equipment.accessories?.length) return null;

    return (
        <div className="mt-3 border-t pt-3">
            <button
                className="w-full flex justify-between items-center text-sm font-medium text-gray-600 hover:text-sky-700 p-1 -m-1 rounded"
                onClick={onToggleExpand}
                aria-expanded={isExpanded}
            >
                <span className="flex items-center gap-2">
                    <Paperclip className="w-4 h-4" />
                    –ê–∫—Å–µ—Å—Å—É–∞—Ä—ã ({equipment.accessories.length})
                </span>
                <ChevronDown className={`w-5 h-5 transition-transform ${isExpanded ? 'rotate-180' : ''}`} />
            </button>
            {isExpanded && (
                <div className="mt-2 space-y-2 pl-1 animate-in fade-in-0 slide-in-from-top-2 duration-300">
                    {equipment.accessories.map(acc => (
                        <div key={acc.id} className="flex items-center justify-between p-1 rounded hover:bg-gray-50">
                            <Label htmlFor={`acc-${equipment.id}-${acc.id}`} className="flex items-center gap-2 text-xs font-normal cursor-pointer">
                                <Checkbox
                                    id={`acc-${equipment.id}-${acc.id}`}
                                    checked={isAccessorySelected(equipment.id, acc.id)}
                                    onCheckedChange={() => onToggleAccessory(acc.id)}
                                    disabled={isDisabled}
                                />
                                {acc.name}
                            </Label>
                            <span className="text-xs text-gray-500">{acc.price} ‚ÇΩ</span>
                        </div>
                    ))}
                </div>
            )}
        </div>
    );
};

```


## <a name="rentalappmainsrccomponentsequipmentcardCardFootertsx"></a>`rental-app-main/src/components/equipment-card/CardFooter.tsx`

```tsx
// path: rental-app-main/src/components/equipment-card/CardFooter.tsx

// src/components/equipment-card/CardFooter.tsx
import React from 'react';
import AvailabilityStrip from "@/components/AvailabilityStrip";
import { STATUS_TEXT_STYLES, STATUS_TEXTS } from './constants';
import type { DayStatus, EquipmentStatus } from "@/types/availability";

interface CardFooterProps {
    status: EquipmentStatus | "my_reservation" | "added";
    dateRange: string;
    selected: boolean;
    onToggleSelection: (e: React.MouseEvent) => void;
    dailyStatus?: Record<string, DayStatus>;
}

export const CardFooter: React.FC<CardFooterProps> = ({
                                                          status, dateRange, selected, onToggleSelection, dailyStatus
                                                      }) => (
    <div className="mt-auto pt-4 space-y-2">
        <div className="flex justify-between items-center">
            <p className={`text-sm font-semibold ${STATUS_TEXT_STYLES[status]}`}>
                {STATUS_TEXTS[status]}
                {dateRange && <span className="ml-1 text-xs font-normal">{dateRange}</span>}
            </p>
            {(status === 'available' || status === 'added') && (
                <button
                    onClick={onToggleSelection}
                    className={`px-3 py-1 rounded text-sm font-medium transition ${
                        status === 'added'
                            ? "bg-rose-100 text-rose-700 hover:bg-rose-200"
                            : selected
                                ? "bg-sky-700 text-white hover:bg-sky-800"
                                : "bg-sky-100 text-sky-700 hover:bg-sky-200"
                    }`}
                >
                    {status === 'added' ? "–û—Ç–º–µ–Ω–∏—Ç—å" : (selected ? "‚úî –í —Ä–µ–∑–µ—Ä–≤–µ" : "‚ûï –í —Ä–µ–∑–µ—Ä–≤")}
                </button>
            )}
        </div>
        <AvailabilityStrip dailyStatus={dailyStatus} />
    </div>
);

```


## <a name="rentalappmainsrccomponentsequipmentcardCardImagetsx"></a>`rental-app-main/src/components/equipment-card/CardImage.tsx`

```tsx
// path: rental-app-main/src/components/equipment-card/CardImage.tsx

// src/components/equipment-card/CardImage.tsx
import React from 'react';
import { Image as ImageIcon } from "lucide-react";

interface CardImageProps {
    imageUrl?: string;
    name: string;
}

export const CardImage: React.FC<CardImageProps> = ({ imageUrl, name }) => (
    <div className="relative w-full h-40 bg-gray-100 flex items-center justify-center overflow-hidden">
        {imageUrl ? (
            <img
                src={imageUrl}
                alt={name}
                className="w-full h-full object-cover transition-transform duration-300 group-hover:scale-105"
                loading="lazy"
            />
        ) : (
            <ImageIcon className="w-12 h-12 text-gray-300" />
        )}
        <div className="absolute inset-0 bg-black/40 transition-opacity duration-300 group-hover:opacity-0 group-focus-within:opacity-0" />
    </div>
);

```


## <a name="rentalappmainsrccomponentsequipmentcardDiscountInfotsx"></a>`rental-app-main/src/components/equipment-card/DiscountInfo.tsx`

```tsx
// path: rental-app-main/src/components/equipment-card/DiscountInfo.tsx

// src/components/equipment-card/DiscountInfo.tsx
import React from 'react';
import { getDayEnding } from './constants';

interface DiscountInfoProps {
    days: number;
    percentage: number;
    priceBefore: number;
    priceAfter: number;
}

export const DiscountInfo: React.FC<DiscountInfoProps> = ({ days, percentage, priceBefore, priceAfter }) => (
    <div className="mt-2 p-2 bg-gray-50 rounded-md border border-dashed">
        <div className="flex justify-between items-center text-sm">
            <span>{days} {getDayEnding(days)}:</span>
            {percentage > 0 ? (
                <div className="flex items-baseline gap-2">
                    <span className="text-gray-500 line-through">{Math.round(priceBefore).toLocaleString('ru-RU')} ‚ÇΩ</span>
                    <span className="font-bold text-base text-green-600">{Math.round(priceAfter).toLocaleString('ru-RU')} ‚ÇΩ</span>
                </div>
            ) : (
                <span className="font-bold text-base text-gray-800">{Math.round(priceBefore).toLocaleString('ru-RU')} ‚ÇΩ</span>
            )}
        </div>
        {percentage > 0 && <div className="text-xs text-right text-gray-500">–°–∫–∏–¥–∫–∞ {percentage}%</div>}
    </div>
);

```


## <a name="rentalappmainsrccomponentsequipmentcardEquipmentCardtsx"></a>`rental-app-main/src/components/equipment-card/EquipmentCard.tsx`

```tsx
// path: rental-app-main/src/components/equipment-card/EquipmentCard.tsx

// src/components/equipment-card/EquipmentCard.tsx
import React, { useState } from "react";
import { CheckCircle } from "lucide-react";
import { formatDateRangeEuropean } from "@/lib/utils";
import { useEquipmentCardViewModel } from "@/hooks/features/useEquipmentCardViewModel";

// –ü–æ–¥–∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã
import { CardImage } from "./CardImage";
import { DiscountInfo } from "./DiscountInfo";
import { AccessoriesSection } from "./AccessoriesSection";
import { CardFooter } from "./CardFooter";
import { STATUS_BACKGROUND_STYLES } from './constants';
import EquipmentDetailsDialog from "@/components/equipment/EquipmentDetailsDialog";

// –¢–∏–ø—ã
import type { Equipment } from "@/types/equipment";
import type { DayStatus, EquipmentStatus } from "@/types/availability";

interface EquipmentCardProps {
    equipment: Equipment;
    status?: EquipmentStatus | "my_reservation" | "added";
    startDate?: string;
    endDate?: string;
    dailyStatus?: Record<string, DayStatus>;
}

const EquipmentCardComponent: React.FC<EquipmentCardProps> = ({ equipment, status = "available", startDate, endDate, dailyStatus }) => {
    const [showDetails, setShowDetails] = useState(false);
    const [showAccessories, setShowAccessories] = useState(false);

    // –ü–æ–ª—É—á–∞–µ–º –≤—Å–µ –¥–∞–Ω–Ω—ã–µ –∏ —Ñ—É–Ω–∫—Ü–∏–∏ –∏–∑ —Ö—É–∫–∞-ViewModel
    const {
        isSelectedByUser,
        isCalculatorVisible,
        discountData,
        handleToggleAccessory,
        handleToggleSelection,
        isAccessorySelected,
    } = useEquipmentCardViewModel({ equipment, status });

    const handleCardClick = (e: React.MouseEvent<HTMLDivElement>) => {
        if ((e.target as HTMLElement).closest("button, a, label, input[type='checkbox']")) return;
        setShowDetails(true);
    };

    const handleDoubleClick = (e: React.MouseEvent<HTMLDivElement>) => {
        if ((e.target as HTMLElement).closest("button, a, label, input[type='checkbox']")) return;
        if (status === 'available' || status === 'added') handleToggleSelection();
    };

    const stopPropagationAndToggle = (e: React.MouseEvent, action: () => void) => {
        e.stopPropagation();
        action();
    };

    const backgroundClass = STATUS_BACKGROUND_STYLES[status] || 'bg-white';
    const selectionClass = isSelectedByUser ? "ring-2 ring-offset-1 ring-sky-500 border-sky-400" : "border-gray-200 hover:shadow-lg";
    const dateRangeDisplay = (startDate && endDate) ? `(${formatDateRangeEuropean(startDate, endDate)})` : "";

    return (
        <>
            <div
                className={`relative group rounded-xl shadow transition w-full max-w-sm flex flex-col justify-between cursor-pointer overflow-hidden ${backgroundClass} ${selectionClass}`}
                onClick={handleCardClick}
                onDoubleClick={handleDoubleClick}
                tabIndex={0}
            >
                {isSelectedByUser && <div className="absolute top-2.5 right-2.5 z-10 bg-sky-600 text-white rounded-full p-1 shadow"><CheckCircle className="w-5 h-5" /></div>}

                <CardImage imageUrl={equipment.image_url} name={equipment.name} />

                <div className="p-4 flex-1 flex flex-col">
                    <div className="flex-grow">
                        <h3 className="text-lg font-semibold mb-1">{equipment.name}</h3>
                        <p className="text-sm text-gray-500 mb-2">{equipment.brand} ‚Ä¢ {equipment.equipment_type}</p>
                        {equipment.short_description && <p className="text-sm italic text-gray-600 mb-2">"{equipment.short_description}"</p>}
                        <p className="text-sm mb-1">–°–æ—Å—Ç–æ—è–Ω–∏–µ: <strong>{equipment.condition}</strong></p>
                        <p className="text-base font-bold mb-1">{equipment.daily_rate} ‚ÇΩ / –¥–µ–Ω—å</p>
                        {isCalculatorVisible && <DiscountInfo {...discountData} />}
                    </div>

                    <AccessoriesSection
                        equipment={equipment}
                        isExpanded={showAccessories}
                        isDisabled={status !== 'available' && status !== 'added'}
                        onToggleExpand={(e) => stopPropagationAndToggle(e, () => setShowAccessories(p => !p))}
                        onToggleAccessory={handleToggleAccessory}
                        isAccessorySelected={isAccessorySelected}
                    />

                    <CardFooter
                        status={status}
                        dateRange={dateRangeDisplay}
                        selected={isSelectedByUser}
                        onToggleSelection={(e) => stopPropagationAndToggle(e, handleToggleSelection)}
                        dailyStatus={dailyStatus}
                    />
                </div>
            </div>

            <EquipmentDetailsDialog
                open={showDetails}
                onClose={() => setShowDetails(false)}
                equipment={equipment}
                availability={{ equipment_id: equipment.id, status: status as EquipmentStatus, details: "" }}
            />
        </>
    );
};

// –ú–µ–º–æ–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω–∞—è –≤–µ—Ä—Å–∏—è –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–∞ –¥–ª—è –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏
export const EquipmentCard = React.memo(EquipmentCardComponent);

```


## <a name="rentalappmainsrccomponentsequipmentcardconstantsts"></a>`rental-app-main/src/components/equipment-card/constants.ts`

```typescript
// path: rental-app-main/src/components/equipment-card/constants.ts

// src/components/equipment-card/constants.ts

import type { EquipmentStatus } from "@/types/availability";

type StatusKey = EquipmentStatus | "my_reservation" | "added";

// –°—Ç–∏–ª–∏ –¢–û–õ–¨–ö–û –¥–ª—è —Ü–≤–µ—Ç–∞ —Ç–µ–∫—Å—Ç–∞
export const STATUS_TEXT_STYLES: Record<StatusKey, string> = {
    available: "text-green-600",
    reserved: "text-yellow-500",
    rented: "text-red-600",
    my_reservation: "text-sky-700",
    added: "text-emerald-600",
};

// –°—Ç–∏–ª–∏ –¢–û–õ–¨–ö–û –¥–ª—è —Ü–≤–µ—Ç–∞ —Ñ–æ–Ω–∞
export const STATUS_BACKGROUND_STYLES: Record<StatusKey, string> = {
    available: "bg-white",
    reserved: "bg-white",
    rented: "bg-white",
    my_reservation: "bg-sky-50",
    added: "bg-emerald-50",
};

// –¢–µ–∫—Å—Ç–æ–≤—ã–µ –æ–ø–∏—Å–∞–Ω–∏—è –¥–ª—è —Å—Ç–∞—Ç—É—Å–æ–≤
export const STATUS_TEXTS: Record<StatusKey, string> = {
    available: "–°–≤–æ–±–æ–¥–Ω–æ",
    reserved: "–í —Ä–µ–∑–µ—Ä–≤–µ",
    rented: "–í –∞—Ä–µ–Ω–¥–µ",
    my_reservation: "–í —ç—Ç–æ–º —Ä–µ–∑–µ—Ä–≤–µ",
    added: "–î–æ–±–∞–≤–ª–µ–Ω–æ",
};

// –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –ø—Ä–∞–≤–∏–ª—å–Ω–æ–≥–æ –æ–∫–æ–Ω—á–∞–Ω–∏—è —Å–ª–æ–≤–∞ "–¥–µ–Ω—å"
export const getDayEnding = (num: number): string => {
    if (num > 10 && num < 20) return '–¥–Ω–µ–π';
    const lastDigit = num % 10;
    if (lastDigit === 1) return '–¥–µ–Ω—å';
    if (lastDigit > 1 && lastDigit < 5) return '–¥–Ω—è';
    return '–¥–Ω–µ–π';
};

```


## <a name="rentalappmainsrccomponentsequipmentcardindexts"></a>`rental-app-main/src/components/equipment-card/index.ts`

```typescript
// path: rental-app-main/src/components/equipment-card/index.ts

// src/components/equipment-card/index.ts

export { EquipmentCard as default } from './EquipmentCard';

```


## <a name="rentalappmainsrccomponentsequipmentEquipmentDetailsDialogtsx"></a>`rental-app-main/src/components/equipment/EquipmentDetailsDialog.tsx`

```tsx
// path: rental-app-main/src/components/equipment/EquipmentDetailsDialog.tsx

// src/components/equipment/EquipmentDetailsDialog.tsx
import { useState, useEffect } from "react"; // 1. –ò–º–ø–æ—Ä—Ç–∏—Ä—É–µ–º useEffect
import { Dialog, DialogContent, DialogFooter, DialogHeader, DialogTitle } from "@/components/ui/dialog";
import EquipmentDetailsView from "@/components/equipment/EquipmentDetailsView";
import EquipmentEditForm from "./EquipmentEditForm";
import type { Equipment } from "@/types/equipment";
import type { AvailabilityInfo } from "@/types/availability";
import { Button } from "@/components/ui/button";
import { useReserveStore } from "@/store/reserveStore";
import { useCurrentUser } from "@/hooks/useProfile";
import { Pencil, Check } from "lucide-react";

type Props = {
    open: boolean;
    onClose: () => void;
    equipment: Equipment;
    availability?: AvailabilityInfo;
};

export default function EquipmentDetailsDialog({ open, onClose, equipment, availability }: Props) {
    const { addWithAccessories, isSelected } = useReserveStore();
    const { data: currentUser } = useCurrentUser();

    const [isEditing, setIsEditing] = useState(false);
    const [stagedAccessoryIds, setStagedAccessoryIds] = useState<Set<number>>(new Set());

    // 2. –î–æ–±–∞–≤–ª—è–µ–º —ç—Ç–æ—Ç –±–ª–æ–∫ useEffect
    useEffect(() => {
        if (!open) {
            document.body.style.overflow = '';
        }
    }, [open]);

    const selected = isSelected(equipment.id);
    const isAvailableForReservation = availability?.status === "available";
    const userRole = currentUser?.role;
    const canEdit = userRole === "admin" || userRole === "manager";
    const canViewAdminInfo = canEdit;

    const handleMainActionClick = () => {
        if (!selected) {
            addWithAccessories(equipment, Array.from(stagedAccessoryIds));
        }
        onClose();
    };

    const handleEditClick = () => {
        setIsEditing(true);
    };

    const handleDialogCloseTrigger = () => {
        setIsEditing(false);
        setStagedAccessoryIds(new Set());
        onClose();
    };

    const handleToggleStagedAccessory = (accessoryId: number) => {
        setStagedAccessoryIds(prev => {
            const newSet = new Set(prev);
            if (newSet.has(accessoryId)) {
                newSet.delete(accessoryId);
            } else {
                newSet.add(accessoryId);
            }
            return newSet;
        });
    };

    return (
        <Dialog open={open} onOpenChange={(isOpen) => !isOpen && handleDialogCloseTrigger()}>
            <DialogContent className="max-w-xl p-6">
                <DialogHeader className="pb-4">
                    <DialogTitle className="text-lg sm:text-xl">
                        {isEditing ? `–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ: ${equipment.name}` : "–î–µ—Ç–∞–ª–∏ –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—è"}
                    </DialogTitle>
                </DialogHeader>

                {isEditing ? (
                    <EquipmentEditForm
                        equipment={equipment}
                        onSuccess={() => { setIsEditing(false); onClose(); }}
                        onCancel={() => setIsEditing(false) }
                    />
                ) : (
                    <EquipmentDetailsView
                        equipment={equipment}
                        canViewAdminInfo={canViewAdminInfo}
                        canToggleAccessories={isAvailableForReservation}
                        isMainSelected={selected}
                        stagedAccessoryIds={stagedAccessoryIds}
                        onToggleStagedAccessory={handleToggleStagedAccessory}
                    />
                )}

                {!isEditing && (
                    <DialogFooter className="pt-4 mt-4 border-t border-gray-200 flex flex-col sm:flex-row sm:justify-end sm:items-center gap-2">
                        {canEdit && (
                            <Button
                                variant="secondary"
                                onClick={handleEditClick}
                                className="w-full sm:w-auto order-last sm:order-none"
                            >
                                <Pencil size={15} className="mr-1.5" />
                                –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å
                            </Button>
                        )}
                        {isAvailableForReservation && (
                            <Button
                                onClick={handleMainActionClick}
                                variant="default"
                                className="w-full sm:w-auto"
                            >
                                {selected
                                    ? <><Check size={16} className="mr-1.5" />–ì–æ—Ç–æ–≤–æ</>
                                    : "‚ûï –î–æ–±–∞–≤–∏—Ç—å –≤ —Ä–µ–∑–µ—Ä–≤"
                                }
                            </Button>
                        )}
                    </DialogFooter>
                )}
            </DialogContent>
        </Dialog>
    );
}

```


## <a name="rentalappmainsrccomponentsequipmentEquipmentDetailsViewtsx"></a>`rental-app-main/src/components/equipment/EquipmentDetailsView.tsx`

```tsx
// path: rental-app-main/src/components/equipment/EquipmentDetailsView.tsx

// src/components/equipment/EquipmentDetailsView.tsx
import type { Equipment } from "@/types/equipment";
import { formatDateEuropean } from "@/lib/utils";
import ReactMarkdown from 'react-markdown';
import { Image as ImageIcon, Paperclip, Plus, Check } from "lucide-react";
import { Button } from "@/components/ui/button";
import { useReserveStore } from "@/store/reserveStore";

type Props = {
    equipment: Equipment;
    canViewAdminInfo: boolean;
    canToggleAccessories: boolean;
    // üëá –ò–ó–ú–ï–ù–ï–ù–ò–ï: –ù–æ–≤—ã–µ –ø—Ä–æ–ø—Å—ã –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è —Å–æ—Å—Ç–æ—è–Ω–∏–µ–º
    isMainSelected: boolean;
    stagedAccessoryIds: Set<number>;
    onToggleStagedAccessory: (accessoryId: number) => void;
};

export default function EquipmentDetailsView({
                                                 equipment,
                                                 canViewAdminInfo,
                                                 canToggleAccessories,
                                                 isMainSelected,
                                                 stagedAccessoryIds,
                                                 onToggleStagedAccessory
                                             }: Props) {
    const { toggleAccessory, isAccessorySelected } = useReserveStore();

    // üëá –ò–ó–ú–ï–ù–ï–ù–ò–ï: –û–±—Ä–∞–±–æ—Ç—á–∏–∫ —Ç–µ–ø–µ—Ä—å —Ä–∞–∑–¥–µ–ª—è–µ—Ç –ª–æ–≥–∏–∫—É
    const handleToggleAccessory = (accessoryId: number) => {
        // –ï—Å–ª–∏ –æ—Å–Ω–æ–≤–Ω–æ–π —Ç–æ–≤–∞—Ä —É–∂–µ –≤ —Ä–µ–∑–µ—Ä–≤–µ, —Ä–∞–±–æ—Ç–∞–µ–º —Å –≥–ª–æ–±–∞–ª—å–Ω—ã–º —Å—Ç–æ—Ä–æ–º
        if (isMainSelected) {
            toggleAccessory(equipment.id, accessoryId);
        } else {
            // –ò–Ω–∞—á–µ - —Ä–∞–±–æ—Ç–∞–µ–º —Å –ª–æ–∫–∞–ª—å–Ω—ã–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ–º "–æ—Ç–º–µ—á–µ–Ω–Ω—ã—Ö"
            onToggleStagedAccessory(accessoryId);
        }
    };

    const allImages = [equipment.image_url, ...(equipment.image_urls || [])].filter(Boolean) as string[];

    return (
        <div className="space-y-3 text-sm">
            {/* ... –±–ª–æ–∫ —Å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è–º–∏ –∏ –æ–ø–∏—Å–∞–Ω–∏–µ–º –æ—Å—Ç–∞–µ—Ç—Å—è –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π ... */}
            {allImages.length > 0 ? (
                <div className="flex overflow-x-auto space-x-2 pb-2 -mx-1 px-1">
                    {allImages.map((url, index) => (
                        <div key={index} className="flex-shrink-0 w-48 h-32 rounded-lg overflow-hidden bg-gray-100 border">
                            <img src={url} alt={`${equipment.name} image ${index + 1}`} className="w-full h-full object-cover" />
                        </div>
                    ))}
                </div>
            ) : (
                <div className="w-full h-32 bg-gray-100 flex items-center justify-center rounded-lg border">
                    <ImageIcon className="w-12 h-12 text-gray-300" />
                </div>
            )}

            <h3 className="text-base sm:text-lg font-bold text-gray-900 leading-tight pt-2">
                {equipment.equipment_type} {equipment.brand} {equipment.name}
            </h3>

            <div className="mt-2 space-y-1">
                <p><span className="font-medium text-gray-700">–¶–µ–Ω–∞:</span> {equipment.daily_rate} ‚ÇΩ / –¥–µ–Ω—å</p>
                <p><span className="font-medium text-gray-700">–°–æ—Å—Ç–æ—è–Ω–∏–µ:</span> {equipment.condition}</p>
            </div>

            {equipment.accessories && equipment.accessories.length > 0 && (
                <div className="pt-3 mt-3 border-t">
                    <p className="font-semibold text-gray-800 mb-2 flex items-center gap-2">
                        <Paperclip className="w-4 h-4 text-gray-500"/>
                        –î–æ—Å—Ç—É–ø–Ω—ã–µ –∞–∫—Å–µ—Å—Å—É–∞—Ä—ã:
                    </p>
                    <ul className="space-y-1.5">
                        {equipment.accessories.map(acc => {
                            // üëá –ò–ó–ú–ï–ù–ï–ù–ò–ï: –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—Ç–∞—Ç—É—Å –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Ç–æ–≥–æ, –¥–æ–±–∞–≤–ª–µ–Ω –ª–∏ —Ç–æ–≤–∞—Ä –≤ —Ä–µ–∑–µ—Ä–≤
                            const isAdded = isMainSelected
                                ? isAccessorySelected(equipment.id, acc.id)
                                : stagedAccessoryIds.has(acc.id);

                            return (
                                <li key={acc.id} className="flex justify-between items-center bg-gray-50/70 p-2 rounded-md hover:bg-gray-100 transition-colors">
                                    <div>
                                        <span className="font-medium">{acc.name}</span>
                                        <span className="text-xs text-gray-600 ml-2">{acc.price} ‚ÇΩ</span>
                                    </div>
                                    <Button
                                        size="icon"
                                        variant={isAdded ? "default" : "outline"}
                                        className={`h-7 w-7 shrink-0 ${isAdded ? 'bg-green-600 hover:bg-green-700' : ''}`}
                                        onClick={() => handleToggleAccessory(acc.id)}
                                        aria-label={isAdded ? "–£–±—Ä–∞—Ç—å –∞–∫—Å–µ—Å—Å—É–∞—Ä" : "–î–æ–±–∞–≤–∏—Ç—å –∞–∫—Å–µ—Å—Å—É–∞—Ä"}
                                        disabled={!canToggleAccessories}
                                    >
                                        {isAdded ? <Check className="h-4 w-4" /> : <Plus className="h-4 w-4" />}
                                    </Button>
                                </li>
                            );
                        })}
                    </ul>
                </div>
            )}

            {/* ... –æ—Å—Ç–∞–ª—å–Ω—ã–µ –±–ª–æ–∫–∏ (–æ–ø–∏—Å–∞–Ω–∏–µ, —Å–ª—É–∂–µ–±–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è) –æ—Å—Ç–∞—é—Ç—Å—è –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π ... */}
            {equipment.description && (
                <div className="pt-3 mt-3 border-t">
                    <p className="font-semibold text-gray-800 mb-1">–û–ø–∏—Å–∞–Ω–∏–µ:</p>
                    <div className="prose prose-sm max-w-none text-gray-700 bg-gray-50 p-3 rounded-md border border-gray-200">
                        <ReactMarkdown>{equipment.description}</ReactMarkdown>
                    </div>
                </div>
            )}

            {canViewAdminInfo && (equipment.notes || equipment.last_maintenance) && (
                <div className="pt-3 mt-3 border-t space-y-2">
                    <h4 className="text-sm font-semibold text-sky-700">–°–ª—É–∂–µ–±–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è:</h4>
                    {equipment.last_maintenance && (
                        <p className="text-xs text-gray-600"><strong>–ü–æ—Å–ª–µ–¥–Ω–µ–µ –¢–û:</strong> {formatDateEuropean(equipment.last_maintenance)}</p>
                    )}
                    {equipment.notes && (
                        <div>
                            <p className="text-xs font-semibold text-gray-600 mb-0.5">–ó–∞–º–µ—Ç–∫–∏:</p>
                            <p className="text-xs text-gray-500 whitespace-pre-wrap bg-gray-50 p-2 rounded-md border border-gray-200">{equipment.notes}</p>
                        </div>
                    )}
                </div>
            )}
        </div>
    );
}

```


## <a name="rentalappmainsrccomponentsequipmentEquipmentEditFormtsx"></a>`rental-app-main/src/components/equipment/EquipmentEditForm.tsx`

```tsx
// path: rental-app-main/src/components/equipment/EquipmentEditForm.tsx

// src/components/equipment/EquipmentEditForm.tsx

import { useForm, Controller } from "react-hook-form";
import { zodResolver } from "@hookform/resolvers/zod";
import {
    equipmentUpdateExtendedSchema,
    type EquipmentUpdateExtendedSchema as EquipmentUpdateFormData
} from "@/lib/validationSchemas";
import { useUpdateEquipmentDetails } from "@/hooks/useUpdateEquipmentDetails";
import { useAccessories } from "@/hooks/useAdminAccessories";
import type { Equipment } from "@/types/equipment";
import type { Accessory } from "@/types/accessory"; // –î–æ–±–∞–≤–ª—è–µ–º –∏–º–ø–æ—Ä—Ç —Ç–∏–ø–∞ Accessory
import { Input } from "@/components/ui/input";
import { Button } from "@/components/ui/button";
import { Label } from "@/components/ui/label";
import { Textarea } from "@/components/ui/textarea";
import { formatDate } from "@/lib/utils";
import MDEditor from '@uiw/react-md-editor';
import rehypeSanitize from 'rehype-sanitize';
import { Checkbox } from "@/components/ui/checkbox";
import { useAllEquipment } from "@/hooks/useAllEquipment";
import { CreatableSelect } from "@/components/ui/CreatableSelect";
import { useMemo } from "react";

type Props = {
    equipment: Equipment;
    onSuccess: (updatedData: Equipment) => void;
    onCancel: () => void;
};

export default function EquipmentEditForm({ equipment, onSuccess, onCancel }: Props) {
    const { data: allEquipmentData = [] } = useAllEquipment();
    // –ó–∞–ø—Ä–∞—à–∏–≤–∞–µ–º –∞–∫—Å–µ—Å—Å—É–∞—Ä—ã —Å –ø–∞–≥–∏–Ω–∞—Ü–∏–µ–π (–±–µ—Ä–µ–º –æ–¥–Ω—É –±–æ–ª—å—à—É—é "—Å—Ç—Ä–∞–Ω–∏—Ü—É")
    const { data: accessoriesResponse, isLoading: isLoadingAccessories } = useAccessories(1, 500);
    // –ò–∑–≤–ª–µ–∫–∞–µ–º –º–∞—Å—Å–∏–≤ .items –∏–∑ –æ—Ç–≤–µ—Ç–∞
    const allAccessories = accessoriesResponse?.items || [];

    const equipmentTypes = useMemo(() => {
        const types = new Set(allEquipmentData.map(e => e.equipment_type));
        return Array.from(types).sort((a, b) => a.localeCompare(b));
    }, [allEquipmentData]);

    const equipmentBrands = useMemo(() => {
        const brands = new Set(allEquipmentData.map(e => e.brand));
        return Array.from(brands).sort((a, b) => a.localeCompare(b));
    }, [allEquipmentData]);

    const {
        register,
        handleSubmit,
        control,
        formState: { errors, isDirty, isValid },
    } = useForm<EquipmentUpdateFormData>({
        resolver: zodResolver(equipmentUpdateExtendedSchema) as any,
        defaultValues: {
            equipment_type: equipment.equipment_type ?? undefined,
            brand: equipment.brand ?? undefined,
            name: equipment.name ?? undefined,
            serial_number: equipment.serial_number ?? undefined,
            condition: equipment.condition ?? undefined,
            daily_rate: equipment.daily_rate ?? undefined,
            notes: equipment.notes ?? undefined,
            description: equipment.description ?? undefined,
            last_maintenance: equipment.last_maintenance ? formatDate(equipment.last_maintenance) : undefined,
            short_description: equipment.short_description ?? undefined,
            image_url: equipment.image_url ?? undefined,
            image_urls: equipment.image_urls ?? [],
            accessory_ids: equipment.accessories?.map(acc => acc.id) ?? [],
        },
        mode: "onChange",
    });

    const updateEquipmentMutation = useUpdateEquipmentDetails();

    const onSubmitHandler = async (data: EquipmentUpdateFormData) => {
        await updateEquipmentMutation.mutateAsync(
            { id: equipment.id, data },
            {
                onSuccess: (updatedEquipmentDataFromApi) => {
                    onSuccess(updatedEquipmentDataFromApi);
                },
            }
        );
    };

    return (
        <form onSubmit={handleSubmit(onSubmitHandler)} className="space-y-4 py-4 max-h-[75vh] overflow-y-auto pr-4">
            {/* ... –æ—Å—Ç–∞–ª—å–Ω–∞—è —á–∞—Å—Ç—å —Ñ–æ—Ä–º—ã –æ—Å—Ç–∞–µ—Ç—Å—è –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π ... */}
            <div>
                <Label htmlFor="name">–ù–∞–∑–≤–∞–Ω–∏–µ</Label>
                <Input id="name" {...register("name")} />
                {errors.name && <p className="text-xs text-red-600 mt-1">{errors.name.message}</p>}
            </div>

            <div className="grid grid-cols-1 sm:grid-cols-2 gap-4">
                <div>
                    <Label htmlFor="equipment_type">–¢–∏–ø –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—è</Label>
                    <Controller
                        name="equipment_type"
                        control={control}
                        render={({ field }) => (
                            <CreatableSelect
                                value={field.value}
                                onChange={field.onChange}
                                options={equipmentTypes}
                                placeholder="–í—ã–±–µ—Ä–∏—Ç–µ –∏–ª–∏ —Å–æ–∑–¥–∞–π—Ç–µ —Ç–∏–ø"
                                dialogTitle="–ù–æ–≤—ã–π —Ç–∏–ø –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—è"
                                dialogDescription="–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –¥–ª—è –Ω–æ–≤–æ–≥–æ —Ç–∏–ø–∞."
                                dialogLabel="–ù–∞–∑–≤–∞–Ω–∏–µ"
                            />
                        )}
                    />
                    {errors.equipment_type && <p className="text-xs text-red-600 mt-1">{errors.equipment_type.message}</p>}
                </div>
                <div>
                    <Label htmlFor="brand">–ë—Ä–µ–Ω–¥</Label>
                    <Controller
                        name="brand"
                        control={control}
                        render={({ field }) => (
                            <CreatableSelect
                                value={field.value}
                                onChange={field.onChange}
                                options={equipmentBrands}
                                placeholder="–í—ã–±–µ—Ä–∏—Ç–µ –∏–ª–∏ —Å–æ–∑–¥–∞–π—Ç–µ –±—Ä–µ–Ω–¥"
                                dialogTitle="–ù–æ–≤—ã–π –±—Ä–µ–Ω–¥"
                                dialogDescription="–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –¥–ª—è –Ω–æ–≤–æ–≥–æ –±—Ä–µ–Ω–¥–∞."
                                dialogLabel="–ù–∞–∑–≤–∞–Ω–∏–µ"
                            />
                        )}
                    />
                    {errors.brand && <p className="text-xs text-red-600 mt-1">{errors.brand.message}</p>}
                </div>
            </div>

            <div>
                <Label htmlFor="short_description">–ö—Ä–∞—Ç–∫–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ (–¥–ª—è –∫–∞—Ä—Ç–æ—á–∫–∏)</Label>
                <Input id="short_description" {...register("short_description")} placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: –ü—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω–∞—è –±–µ–∑–∑–µ—Ä–∫–∞–ª—å–Ω–∞—è –∫–∞–º–µ—Ä–∞..." />
                {errors.short_description && <p className="text-xs text-red-600 mt-1">{errors.short_description.message}</p>}
            </div>

            <div>
                <Label htmlFor="image_url">URL –æ—Å–Ω–æ–≤–Ω–æ–≥–æ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è</Label>
                <Input id="image_url" {...register("image_url")} placeholder="https://example.com/main_image.jpg" />
                {errors.image_url && <p className="text-xs text-red-600 mt-1">{errors.image_url.message}</p>}
            </div>

            <div>
                <Label htmlFor="image_urls">URL –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã—Ö –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π (–∫–∞–∂–¥—ã–π —Å –Ω–æ–≤–æ–π —Å—Ç—Ä–æ–∫–∏)</Label>
                <Controller
                    name="image_urls"
                    control={control}
                    render={({ field }) => (
                        <Textarea
                            id="image_urls"
                            placeholder={"https://example.com/image1.jpg\nhttps://example.com/image2.jpg"}
                            value={Array.isArray(field.value) ? field.value.join('\n') : ''}
                            onChange={(e) => {
                                const urls = e.target.value ? e.target.value.split('\n') : [];
                                field.onChange(urls);
                            }}
                            rows={4}
                        />
                    )}
                />
                {errors.image_urls && <p className="text-xs text-red-600 mt-1">{errors.image_urls.message as string}</p>}
            </div>

            <div>
                <Label htmlFor="serial_number">–°–µ—Ä–∏–π–Ω—ã–π –Ω–æ–º–µ—Ä</Label>
                <Input id="serial_number" {...register("serial_number")} />
                {errors.serial_number && <p className="text-xs text-red-600 mt-1">{errors.serial_number.message}</p>}
            </div>

            <div className="grid grid-cols-1 sm:grid-cols-2 gap-4">
                <div>
                    <Label htmlFor="condition">–°–æ—Å—Ç–æ—è–Ω–∏–µ</Label>
                    <Input id="condition" {...register("condition")} />
                    {errors.condition && <p className="text-xs text-red-600 mt-1">{errors.condition.message}</p>}
                </div>
                <div>
                    <Label htmlFor="daily_rate">–¶–µ–Ω–∞ –∑–∞ –¥–µ–Ω—å (‚ÇΩ)</Label>
                    <Controller
                        name="daily_rate"
                        control={control}
                        render={({ field }) => (
                            <Input
                                {...field}
                                id="daily_rate"
                                type="number"
                                value={field.value ?? ""}
                                onChange={(e) => {
                                    const val = e.target.value;
                                    field.onChange(val === '' ? undefined : parseFloat(val));
                                }}
                                step="0.01"
                                placeholder="0.00"
                            />
                        )}
                    />
                    {errors.daily_rate && <p className="text-xs text-red-600 mt-1">{errors.daily_rate.message}</p>}
                </div>
            </div>

            <div>
                <Label htmlFor="description">–û–ø–∏—Å–∞–Ω–∏–µ (Markdown)</Label>
                <Controller
                    name="description"
                    control={control}
                    render={({ field }) => (
                        <div data-color-mode="light">
                            <MDEditor
                                value={field.value ?? ""}
                                onChange={(val) => field.onChange(val ?? "")}
                                previewOptions={{ rehypePlugins: [[rehypeSanitize]] }}
                                height={250}
                            />
                        </div>
                    )}
                />
                {errors.description && <p className="text-xs text-red-600 mt-1">{errors.description.message}</p>}
            </div>

            <div className="space-y-2 pt-4 border-t">
                <Label>–ü—Ä–∏–≤—è–∑–∞–Ω–Ω—ã–µ –∞–∫—Å–µ—Å—Å—É–∞—Ä—ã</Label>
                <p className="text-sm text-muted-foreground">
                    –í—ã–±–µ—Ä–∏—Ç–µ –∞–∫—Å–µ—Å—Å—É–∞—Ä—ã, –∫–æ—Ç–æ—Ä—ã–µ –±—É–¥—É—Ç –ø—Ä–µ–¥–ª–∞–≥–∞—Ç—å—Å—è –≤–º–µ—Å—Ç–µ —Å —ç—Ç–∏–º –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏–µ–º.
                </p>
                {isLoadingAccessories ? (
                    <p className="text-sm text-muted-foreground">–ó–∞–≥—Ä—É–∑–∫–∞ —Å–ø–∏—Å–∫–∞ –∞–∫—Å–µ—Å—Å—É–∞—Ä–æ–≤...</p>
                ) : (
                    <Controller
                        control={control}
                        name="accessory_ids"
                        render={({ field }) => (
                            <div className="space-y-2 max-h-48 overflow-y-auto rounded-md border p-4 bg-slate-50">
                                {allAccessories.map((accessory: Accessory) => ( // –î–æ–±–∞–≤–ª—è–µ–º —Ç–∏–ø –¥–ª—è accessory
                                    <div key={accessory.id} className="flex items-center justify-between hover:bg-slate-100 p-2 rounded">
                                        <div className="flex items-center gap-2">
                                            <Checkbox
                                                id={`accessory-${accessory.id}`}
                                                checked={field.value?.includes(accessory.id)}
                                                onCheckedChange={(checked) => {
                                                    const currentIds = field.value ?? [];
                                                    const newIds = checked
                                                        ? [...currentIds, accessory.id]
                                                        : currentIds.filter(id => id !== accessory.id);
                                                    field.onChange(newIds);
                                                }}
                                            />
                                            <Label htmlFor={`accessory-${accessory.id}`} className="font-normal cursor-pointer">
                                                {accessory.name}
                                            </Label>
                                        </div>
                                        <span className="text-xs text-muted-foreground">{accessory.price} ‚ÇΩ</span>
                                    </div>
                                ))}
                            </div>
                        )}
                    />
                )}
            </div>

            <div>
                <Label htmlFor="notes">–ó–∞–º–µ—Ç–∫–∏ (–≤–∏–¥–Ω–æ —Ç–æ–ª—å–∫–æ –º–µ–Ω–µ–¥–∂–µ—Ä–∞–º/–∞–¥–º–∏–Ω–∞–º)</Label>
                <Textarea id="notes" {...register("notes")} rows={3} />
                {errors.notes && <p className="text-xs text-red-600 mt-1">{errors.notes.message}</p>}
            </div>

            <div>
                <Label htmlFor="last_maintenance">–î–∞—Ç–∞ –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ –¢–û (–≤–∏–¥–Ω–æ —Ç–æ–ª—å–∫–æ –º–µ–Ω–µ–¥–∂–µ—Ä–∞–º/–∞–¥–º–∏–Ω–∞–º)</Label>
                <Input
                    id="last_maintenance"
                    type="date"
                    {...register("last_maintenance")}
                />
                {errors.last_maintenance && <p className="text-xs text-red-600 mt-1">{errors.last_maintenance.message}</p>}
            </div>

            <div className="flex justify-end gap-3 pt-4 border-t mt-6">
                <Button type="button" variant="ghost" onClick={onCancel}>
                    –û—Ç–º–µ–Ω–∞
                </Button>
                <Button type="submit" disabled={!isDirty || !isValid || updateEquipmentMutation.isPending}>
                    {updateEquipmentMutation.isPending ? "–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ..." : "–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è"}
                </Button>
            </div>
        </form>
    );
}

```


## <a name="rentalappmainsrccomponentsprofileBalanceHistoryTabletsx"></a>`rental-app-main/src/components/profile/BalanceHistoryTable.tsx`

```tsx
// path: rental-app-main/src/components/profile/BalanceHistoryTable.tsx

// src/components/profile/BalanceHistoryTable.tsx

import { useState } from "react";
import { useBalanceHistory, useAdminBalanceHistory } from "@/hooks/useBalanceHistory";
import {
    Table,
    TableBody,
    TableCell,
    TableHead,
    TableHeader,
    TableRow,
    TableCaption,
} from "@/components/ui/table";
import { Button } from "@/components/ui/button";
import { formatDateEuropean } from "@/lib/utils";
import { Loader2, AlertTriangle, ChevronLeft, ChevronRight, Inbox } from "lucide-react";

interface Props {
    userId: number;
    // –§–ª–∞–≥, –æ–ø—Ä–µ–¥–µ–ª—è—é—â–∏–π, –∏—Å–ø–æ–ª—å–∑—É–µ–º –ª–∏ –º—ã –∞–¥–º–∏–Ω—Å–∫–∏–π —Ö—É–∫ –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö
    isAdminView?: boolean;
}

export default function BalanceHistoryTable({ userId, isAdminView = false }: Props) {
    const [currentPage, setCurrentPage] = useState(1);

    // –í –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Ñ–ª–∞–≥–∞ isAdminView, –∏—Å–ø–æ–ª—å–∑—É–µ–º —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–∏–π —Ö—É–∫
    const queryResult = isAdminView
        ? useAdminBalanceHistory(userId, currentPage)
        : useBalanceHistory(currentPage);

    const { data: historyResponse, isLoading, isError, error } = queryResult;

    const history = historyResponse?.items ?? [];
    const totalEntries = historyResponse?.total ?? 0;
    const totalPages = Math.ceil(totalEntries / 15); // 15 - PAGE_SIZE –∏–∑ —Ö—É–∫–∞

    if (isLoading) {
        return (
            <div className="flex items-center justify-center gap-2 text-gray-500 py-8">
                <Loader2 className="h-5 w-5 animate-spin" />
                <span>–ó–∞–≥—Ä—É–∑–∫–∞ –∏—Å—Ç–æ—Ä–∏–∏ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π...</span>
            </div>
        );
    }

    if (isError) {
        return (
            <div className="flex items-center justify-center gap-2 text-red-600 bg-red-50 p-4 rounded-md">
                <AlertTriangle className="h-5 w-5" />
                <span>–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏: {error?.message || "–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –¥–∞–Ω–Ω—ã–µ"}</span>
            </div>
        );
    }

    if (history.length === 0) {
        return (
            <div className="text-center py-10 text-gray-500 border-2 border-dashed rounded-lg">
                <Inbox className="mx-auto h-12 w-12 text-gray-300" />
                <p className="mt-2 font-medium">–ò—Å—Ç–æ—Ä–∏—è —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π –ø—É—Å—Ç–∞</p>
                <p className="text-sm">–ó–¥–µ—Å—å –±—É–¥—É—Ç –æ—Ç–æ–±—Ä–∞–∂–∞—Ç—å—Å—è –≤—Å–µ –¥–≤–∏–∂–µ–Ω–∏—è –ø–æ –≤–∞—à–µ–º—É —Å—á–µ—Ç—É.</p>
            </div>
        );
    }

    return (
        <div className="space-y-4">
            <div className="border rounded-lg">
                <Table>
                    <TableCaption>
                        {totalEntries > 0 ? `–ü–æ–∫–∞–∑–∞–Ω–æ ${history.length} –∏–∑ ${totalEntries} –∑–∞–ø–∏—Å–µ–π.` : '–ó–∞–ø–∏—Å–µ–π –Ω–µ –Ω–∞–π–¥–µ–Ω–æ.'}
                    </TableCaption>
                    <TableHeader>
                        <TableRow>
                            <TableHead className="w-[120px]">–î–∞—Ç–∞</TableHead>
                            <TableHead>–¢–∏–ø –æ–ø–µ—Ä–∞—Ü–∏–∏</TableHead>
                            <TableHead>–û–ø–∏—Å–∞–Ω–∏–µ</TableHead>
                            <TableHead className="text-right w-[150px]">–°—É–º–º–∞</TableHead>
                        </TableRow>
                    </TableHeader>
                    <TableBody>
                        {history.map((entry) => {
                            const amountColor = entry.amount < 0 ? 'text-red-600' : 'text-green-600';
                            const amountSign = entry.amount > 0 ? '+' : '';

                            return (
                                <TableRow key={entry.id}>
                                    <TableCell className="font-medium text-xs">
                                        {formatDateEuropean(entry.created_at)}
                                    </TableCell>
                                    <TableCell className="text-xs">{entry.operation_type}</TableCell>
                                    <TableCell className="text-xs">{entry.description}</TableCell>
                                    <TableCell className={`text-right font-semibold ${amountColor}`}>
                                        {amountSign} {entry.amount.toLocaleString('ru-RU', { style: 'currency', currency: 'RUB' })}
                                    </TableCell>
                                </TableRow>
                            );
                        })}
                    </TableBody>
                </Table>
            </div>

            {totalPages > 1 && (
                <div className="flex items-center justify-end space-x-2">
                    <span className="text-sm text-muted-foreground">
                        –°—Ç—Ä–∞–Ω–∏—Ü–∞ {currentPage} –∏–∑ {totalPages}
                    </span>
                    <Button
                        variant="outline"
                        size="sm"
                        onClick={() => setCurrentPage(prev => Math.max(prev - 1, 1))}
                        disabled={currentPage === 1}
                    >
                        <ChevronLeft className="h-4 w-4 mr-1" />
                        –ù–∞–∑–∞–¥
                    </Button>
                    <Button
                        variant="outline"
                        size="sm"
                        onClick={() => setCurrentPage(prev => Math.min(prev + 1, totalPages))}
                        disabled={currentPage === totalPages}
                    >
                        –í–ø–µ—Ä–µ–¥
                        <ChevronRight className="h-4 w-4 ml-1" />
                    </Button>
                </div>
            )}
        </div>
    );
}

```


## <a name="rentalappmainsrccomponentsrentalMyRentalCardtsx"></a>`rental-app-main/src/components/rental/MyRentalCard.tsx`

```tsx
// path: rental-app-main/src/components/rental/MyRentalCard.tsx

// src/components/rental/MyRentalCard.tsx

import { useState } from "react";
import { Card } from "@/components/ui/card";
import { Button } from "@/components/ui/button";
import RentalStatusBadge from "./RentalStatusBadge";
import { CalendarRange, Truck, ExternalLink, ChevronDown, Paperclip, Tag, ReceiptText, Clock, AlertTriangle } from "lucide-react";
import { useNavigate } from "react-router-dom";
import { formatDateEuropean, calculateDaysOverdue } from "@/lib/utils";
import type { AdminRentalOut } from "@/types/rental";
import { RENTAL_CARD_STYLES } from "@/constants/statusStyles";

interface MyRentalCardProps {
    rental: AdminRentalOut;
    highlightId?: number | null;
}

export default function MyRentalCard({ rental, highlightId }: MyRentalCardProps) {
    const navigate = useNavigate();
    const [expandedAccessories, setExpandedAccessories] = useState<Record<number, boolean>>({});
    
    const isHighlighted = highlightId === rental.id;
    
    const toggleAccessories = (equipmentId: number) => {
        setExpandedAccessories(prev => ({
            ...prev,
            [equipmentId]: !prev[equipmentId]
        }));
    };
    
    
    const start = rental.start_date ? new Date(rental.start_date) : null;
    const end = rental.end_date ? new Date(rental.end_date) : null;
    const actualReturn = rental.actual_return_date ? new Date(rental.actual_return_date) : null;

    const handleReservationClick = () => {
        if (rental.reservation_id) {
            navigate("/reservations/my", { 
                state: { 
                    highlightReservationId: rental.reservation_id,
                    from: "rental"
                } 
            });
        }
    };

    // –õ–æ–≥–∏–∫–∞ –¥–ª—è —Å—Ç–∏–ª–∏–∑–∞—Ü–∏–∏ –∫–∞—Ä—Ç–æ—á–∫–∏ –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Å—Ç–∞—Ç—É—Å–∞
    const statusClass = RENTAL_CARD_STYLES[rental.status] || RENTAL_CARD_STYLES.default;

    return (
        <Card 
            className={`p-4 space-y-4 transition-all duration-300 ${statusClass} ${isHighlighted ? "ring-2 ring-orange-500 shadow-lg" : ""}`}
        >
            {/* –ó–∞–≥–æ–ª–æ–≤–æ–∫ —Å ID –∏ —Å—Ç–∞—Ç—É—Å–æ–º */}
            <div className="flex items-center justify-between">
                <div className="flex items-center gap-3">
                    <Truck className="w-5 h-5 text-orange-600" />
                    <h3 className="text-lg font-semibold text-gray-900">
                        –ê—Ä–µ–Ω–¥–∞ #{rental.id}
                    </h3>
                </div>
                <div className="flex items-center gap-2">
                    <RentalStatusBadge status={rental.status} />
                    {/* –°—Å—ã–ª–∫–∞ –Ω–∞ —Ä–µ–∑–µ—Ä–≤ */}
                    {rental.reservation_id && (
                        <Button
                            variant="outline"
                            size="sm"
                            onClick={handleReservationClick}
                            className="text-sky-600 hover:text-sky-700 hover:bg-sky-50 border-sky-200"
                        >
                            <ExternalLink className="w-3 h-3 mr-1" />
                            –†–µ–∑–µ—Ä–≤ #{rental.reservation_id}
                        </Button>
                    )}
                </div>
            </div>

            {/* –î–∞—Ç—ã */}
            <div className="flex items-center gap-2 text-sm text-gray-600">
                <CalendarRange className="w-4 h-4" />
                <span>
                    {start && end && (
                        <>
                            {formatDateEuropean(start)} - {formatDateEuropean(end)}
                        </>
                    )}
                </span>
            </div>

            {/* –§–∞–∫—Ç–∏—á–µ—Å–∫–∞—è –¥–∞—Ç–∞ –≤–æ–∑–≤—Ä–∞—Ç–∞ */}
            {actualReturn && (
                <div className="text-sm text-gray-600">
                    <span className="font-medium">–í–æ–∑–≤—Ä–∞—Ç:</span> {formatDateEuropean(actualReturn)}
                </div>
            )}

            {/* –°–æ—Å—Ç–∞–≤ –∞—Ä–µ–Ω–¥—ã */}
            <div className="space-y-2 pt-3 border-t">
                <h4 className="font-medium text-sm text-gray-800">–°–æ—Å—Ç–∞–≤ –∞—Ä–µ–Ω–¥—ã:</h4>
                <div className="space-y-2">
                    {rental.equipment.map((item) => {
                        const accessoriesForItem = rental.accessory_links?.filter(link => link.equipment_id === item.id);
                        return (
                            <div key={item.id} className="text-sm text-gray-700 bg-gray-50/70 p-2 rounded-md border">
                                <p>‚Ä¢ {item.name}</p>
                                {accessoriesForItem && accessoriesForItem.length > 0 && (
                                    <div className="mt-2 pl-4">
                                        <button onClick={() => toggleAccessories(item.id)} className="flex items-center text-xs text-sky-700 hover:underline font-medium">
                                            <Paperclip className="w-3 h-3 mr-1" />
                                            –ê–∫—Å–µ—Å—Å—É–∞—Ä—ã ({accessoriesForItem.length})
                                            <ChevronDown className={`w-4 h-4 ml-1 transition-transform ${expandedAccessories[item.id] ? 'rotate-180' : ''}`} />
                                        </button>
                                        {expandedAccessories[item.id] && (
                                            <ul className="list-disc list-inside text-xs text-gray-600 mt-1 pl-2 animate-in fade-in duration-200">
                                                {accessoriesForItem.map(link => (
                                                    <li key={link.accessory.id}>{link.accessory.name}</li>
                                                ))}
                                            </ul>
                                        )}
                                    </div>
                                )}
                            </div>
                        );
                    })}
                </div>
            </div>

            {/* –§–∏–Ω–∞–Ω—Å–æ–≤—ã–π –±–ª–æ–∫ —Å —Ç–∞–π–º–µ—Ä–æ–º */}
            <div className="flex items-start justify-between pt-3 border-t flex-wrap-reverse gap-4">
                {/* –§–∏–Ω–∞–Ω—Å–æ–≤—ã–π –±–ª–æ–∫ */}
                <div className="text-xs space-y-1.5 text-slate-700 flex-grow">
                    <h4 className="font-semibold text-sm text-slate-800 flex items-center gap-2 mb-2"><ReceiptText className="w-4 h-4"/>–§–∏–Ω–∞–Ω—Å—ã</h4>
                    <div className="flex justify-between gap-4"><span>–°—Ç–æ–∏–º–æ—Å—Ç—å –∞—Ä–µ–Ω–¥—ã:</span> <span className="font-medium">{rental.total_cost.toLocaleString('ru-RU')} ‚ÇΩ</span></div>
                    {rental.discount_amount > 0 && (
                        <div className="flex justify-between gap-4 text-green-600"><span>–°–∫–∏–¥–∫–∞:</span> <span className="font-medium">- {rental.discount_amount.toLocaleString('ru-RU')} ‚ÇΩ</span></div>
                    )}
                    {rental.promo_code && (
                        <div className="flex justify-between items-center gap-4 text-purple-600"><span>–ü—Ä–æ–º–æ–∫–æ–¥:</span> <span className="font-medium flex items-center gap-1"><Tag className="w-3 h-3"/>{rental.promo_code}</span></div>
                    )}
                    {rental.overdue_surcharge && rental.overdue_surcharge > 0 && (
                        <div className="flex justify-between gap-4 text-red-600 font-bold pt-1 border-t border-dashed mt-1"><span>–î–æ–ø–ª–∞—Ç–∞ –∑–∞ –ø—Ä–æ—Å—Ä–æ—á–∫—É:</span> <span>{rental.overdue_surcharge.toLocaleString('ru-RU')} ‚ÇΩ</span></div>
                    )}
                </div>
                
                {/* –¢–∞–π–º–µ—Ä —Å—Ç–∞—Ç—É—Å–∞ */}
                {(() => {
                    if (rental.status === 'overdue') {
                        const daysOverdue = calculateDaysOverdue(rental.end_date, rental.overdue_days);
                        return (
                            <div className="flex items-center gap-2 px-2 py-1 rounded-md border text-xs font-medium text-red-600 bg-red-100/60 border-red-200">
                                <AlertTriangle className="w-4 h-4"/>
                                {`–ü—Ä–æ—Å—Ä–æ—á–µ–Ω–∞ –Ω–∞ ${daysOverdue} –¥–Ω.`}
                            </div>
                        );
                    }
                    if (rental.status === 'active' && rental.days_remaining !== null) {
                        const daysLeft = rental.days_remaining;
                        if (daysLeft <= 1) {
                            return (
                                <div className="flex items-center gap-2 px-2 py-1 rounded-md border text-xs font-medium text-orange-600 bg-orange-100/60 border-orange-200">
                                    <Clock className="w-4 h-4"/>
                                    {`–û—Å—Ç–∞–ª—Å—è ${daysLeft} –¥–µ–Ω—å`}
                                </div>
                            );
                        }
                        return (
                            <div className="flex items-center gap-2 px-2 py-1 rounded-md border text-xs font-medium text-green-700 bg-green-100/60 border-green-200">
                                <Clock className="w-4 h-4"/>
                                {`–û—Å—Ç–∞–ª–æ—Å—å ${daysLeft} –¥–Ω.`}
                            </div>
                        );
                    }
                    return null;
                })()}
            </div>


            {/* –ó–∞–º–µ—Ç–∫–∏ */}
            {rental.notes_on_issue && (
                <div className="pt-2 border-t">
                    <div className="text-sm">
                        <span className="font-medium text-gray-700">–ó–∞–º–µ—Ç–∫–∏ –ø—Ä–∏ –≤—ã–¥–∞—á–µ:</span>
                        <p className="text-gray-600 mt-1">{rental.notes_on_issue}</p>
                    </div>
                </div>
            )}

            {rental.notes_on_return && (
                <div className="pt-2 border-t">
                    <div className="text-sm">
                        <span className="font-medium text-gray-700">–ó–∞–º–µ—Ç–∫–∏ –ø—Ä–∏ –≤–æ–∑–≤—Ä–∞—Ç–µ:</span>
                        <p className="text-gray-600 mt-1">{rental.notes_on_return}</p>
                    </div>
                </div>
            )}
        </Card>
    );
}


```


## <a name="rentalappmainsrccomponentsrentalMyRentalsListtsx"></a>`rental-app-main/src/components/rental/MyRentalsList.tsx`

```tsx
// path: rental-app-main/src/components/rental/MyRentalsList.tsx

// src/components/rental/MyRentalsList.tsx

import { useMemo } from "react";
import { useMyRentals } from "@/hooks/useMyRentals";
import MyRentalCard from "./MyRentalCard";
import { Button } from "@/components/ui/button";
import { RefreshCw, Truck } from "lucide-react";

interface MyRentalsListProps {
    highlightId?: number | null;
    rentalsData?: any;
}

const LoadingState = () => (
    <div className="text-center py-8">
        <div className="flex items-center justify-center mb-4">
            <RefreshCw className="w-8 h-8 animate-spin text-orange-600" />
        </div>
        <p className="text-gray-600">–ó–∞–≥—Ä—É–∑–∫–∞ –∞—Ä–µ–Ω–¥...</p>
    </div>
);

const ErrorState = ({ message, onRetry }: { message: string; onRetry: () => void }) => (
    <div className="text-center py-8">
        <div className="flex items-center justify-center mb-4">
            <Truck className="w-8 h-8 text-gray-400" />
        </div>
        <p className="text-red-600 mb-4">{message}</p>
        <Button onClick={onRetry} variant="outline" size="sm">
            <RefreshCw className="w-4 h-4 mr-2" />
            –ü–æ–ø—Ä–æ–±–æ–≤–∞—Ç—å —Å–Ω–æ–≤–∞
        </Button>
    </div>
);

const EmptyState = () => (
    <div className="text-center py-12">
        <div className="flex items-center justify-center mb-4">
            <Truck className="w-12 h-12 text-gray-400" />
        </div>
        <h3 className="text-lg font-medium text-gray-900 mb-2">–ù–µ—Ç –∞—Ä–µ–Ω–¥</h3>
        <p className="text-gray-600">
            –£ –≤–∞—Å –ø–æ–∫–∞ –Ω–µ—Ç –∞–∫—Ç–∏–≤–Ω—ã—Ö –∏–ª–∏ –∑–∞–≤–µ—Ä—à–µ–Ω–Ω—ã—Ö –∞—Ä–µ–Ω–¥.
        </p>
    </div>
);

export default function MyRentalsList({ highlightId, rentalsData: propRentalsData }: MyRentalsListProps) {
    const { data, isLoading, isError, error, fetchNextPage, hasNextPage, isFetchingNextPage, refetch } = useMyRentals();

    // –ò—Å–ø–æ–ª—å–∑—É–µ–º –¥–∞–Ω–Ω—ã–µ –∏–∑ –ø—Ä–æ–ø—Å–æ–≤ –∏–ª–∏ –∑–∞–≥—Ä—É–∂–∞–µ–º –∏—Ö —Å–∞–º–æ—Å—Ç–æ—è—Ç–µ–ª—å–Ω–æ
    const allRentals = useMemo(() => {
        if (propRentalsData?.pages) {
            return propRentalsData.pages.flatMap(page => page.items);
        }
        if (data?.pages) {
            return data.pages.flatMap(page => page.items);
        }
        return [];
    }, [propRentalsData, data]);

    if (isLoading) {
        return <LoadingState />;
    }

    if (isError) {
        return (
            <ErrorState 
                message={error?.message || "–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –∞—Ä–µ–Ω–¥"} 
                onRetry={() => refetch()} 
            />
        );
    }

    if (allRentals.length === 0) {
        return <EmptyState />;
    }

    return (
        <div className="space-y-4">
            {/* –°–ø–∏—Å–æ–∫ –∞—Ä–µ–Ω–¥ */}
            <div className="space-y-4">
                {allRentals.map((rental) => (
                    <MyRentalCard 
                        key={rental.id} 
                        rental={rental} 
                        highlightId={highlightId}
                    />
                ))}
            </div>

            {/* –ö–Ω–æ–ø–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã—Ö –∞—Ä–µ–Ω–¥ */}
            {hasNextPage && (
                <div className="text-center pt-4">
                    <Button
                        onClick={() => fetchNextPage()}
                        disabled={isFetchingNextPage}
                        variant="outline"
                        size="sm"
                    >
                        {isFetchingNextPage ? (
                            <>
                                <RefreshCw className="w-4 h-4 mr-2 animate-spin" />
                                –ó–∞–≥—Ä—É–∑–∫–∞...
                            </>
                        ) : (
                            "–ó–∞–≥—Ä—É–∑–∏—Ç—å –µ—â–µ"
                        )}
                    </Button>
                </div>
            )}
        </div>
    );
}


```


## <a name="rentalappmainsrccomponentsrentalRentalStatusBadgetsx"></a>`rental-app-main/src/components/rental/RentalStatusBadge.tsx`

```tsx
// path: rental-app-main/src/components/rental/RentalStatusBadge.tsx

// src/components/rental/RentalStatusBadge.tsx

import { Badge } from "@/components/ui/badge";

type Status = 'active' | 'overdue' | 'completed';

interface Props {
    status: Status;
}

const statusConfig: Record<Status, { text: string; className: string }> = {
    active: {
        text: "–ê–∫—Ç–∏–≤–Ω–∞",
        className: "bg-green-100 text-green-800 border-green-200",
    },
    overdue: {
        text: "–ü—Ä–æ—Å—Ä–æ—á–µ–Ω–∞",
        className: "bg-orange-100 text-orange-800 border-orange-200",
    },
    completed: {
        text: "–ó–∞–≤–µ—Ä—à–µ–Ω–∞",
        className: "bg-gray-100 text-gray-800 border-gray-200",
    },
};

export default function RentalStatusBadge({ status }: Props) {
    const config = statusConfig[status] || statusConfig.completed;

    return (
        <Badge variant="outline" className={`font-medium ${config.className}`}>
            {config.text}
        </Badge>
    );
}


```


## <a name="rentalappmainsrccomponentsreservationAvailableAccessoriesDropdowntsx"></a>`rental-app-main/src/components/reservation/AvailableAccessoriesDropdown.tsx`

```tsx
// path: rental-app-main/src/components/reservation/AvailableAccessoriesDropdown.tsx

// src/components/reservation/AvailableAccessoriesDropdown.tsx

import { useState } from 'react';
import { Paperclip, ChevronDown, PlusCircle } from 'lucide-react';
import { Button } from '@/components/ui/button';
import { Accessory } from '@/types/accessory';

interface Props {
    accessories: Accessory[];
    equipmentId: number;
    onToggleAccessory: (equipmentId: number, accessoryId: number) => void;
    disabled?: boolean;
    hasTopBorder: boolean;
}

export const AvailableAccessoriesDropdown = ({ accessories, equipmentId, onToggleAccessory, disabled, hasTopBorder }: Props) => {
    const [isExpanded, setExpanded] = useState(false);

    if (accessories.length === 0) {
        return null;
    }

    return (
        <div className={`pt-2 mt-2 ${hasTopBorder ? 'border-t border-dashed' : ''}`}>
            <button
                className="w-full flex justify-between items-center text-sm font-medium text-gray-600 hover:text-sky-700 p-1 -m-1 rounded"
                onClick={(e) => { e.stopPropagation(); setExpanded(p => !p); }}
                aria-expanded={isExpanded}
                disabled={disabled}
            >
                <span className="flex items-center gap-2">
                    <Paperclip className="w-4 h-4" />
                    –î–æ–±–∞–≤–∏—Ç—å –∞–∫—Å–µ—Å—Å—É–∞—Ä—ã ({accessories.length})
                </span>
                <ChevronDown className={`w-5 h-5 transition-transform ${isExpanded ? 'rotate-180' : ''}`} />
            </button>
            {isExpanded && (
                <div className="mt-2 space-y-1 pl-1 animate-in fade-in-0 slide-in-from-top-2 duration-300">
                    {accessories.map(acc => (
                        <div key={acc.id} className="flex items-center justify-between p-1 rounded hover:bg-gray-50">
                            <span className="text-xs font-normal">
                                {acc.name} ({acc.price} ‚ÇΩ)
                            </span>
                            <Button
                                size="sm"
                                variant="ghost"
                                className="h-6 px-2 text-xs"
                                onClick={() => onToggleAccessory(equipmentId, acc.id)}
                                disabled={disabled}
                            >
                                <PlusCircle className="w-3.5 h-3.5 mr-1" />
                                –î–æ–±–∞–≤–∏—Ç—å
                            </Button>
                        </div>
                    ))}
                </div>
            )}
        </div>
    );
}

```


## <a name="rentalappmainsrccomponentsreservationEditableDateRangetsx"></a>`rental-app-main/src/components/reservation/EditableDateRange.tsx`

```tsx
// path: rental-app-main/src/components/reservation/EditableDateRange.tsx

// src/components/reservation/EditableDateRange.tsx

import { CalendarRange } from "lucide-react";
import { useDateRange } from "@/hooks/useDateRange";
import { formatDate, formatDateEuropean } from "@/lib/utils";

interface EditableDateRangeProps {
    startDate: Date;
    endDate: Date;
    onChange: (startDate: Date, endDate: Date, source?: 'calendar' | 'slider' | 'manual') => void;
    disabled?: boolean;
}

export default function EditableDateRange({
                                              startDate,
                                              endDate,
                                              onChange,
                                              disabled = false
                                          }: EditableDateRangeProps) {
    const {
        localStartDate,
        localEndDate,
        handleStartDateChange,
        handleEndDateChange
    } = useDateRange({
        // ‚úÖ –ò–°–ü–†–ê–í–õ–ï–ù–û: –ú–µ–Ω—è–µ–º initialStartDate/initialEndDate –Ω–∞ startDate/endDate
        startDate: startDate,
        endDate: endDate,
        onRangeChange: onChange
    });

    const today = formatDate(new Date());

    return (
        <div className="space-y-3">
            <div className="flex items-center gap-2 text-sm font-medium text-gray-700">
                <CalendarRange className="w-4 h-4" />
                –î–∞—Ç—ã —Ä–µ–∑–µ—Ä–≤–∞:
            </div>

            <div className="grid grid-cols-1 sm:grid-cols-2 gap-3">
                <div className="space-y-1">
                    <label htmlFor="edit-start-date" className="block text-xs text-gray-600">
                        –ù–∞—á–∞–ª–æ:
                    </label>
                    <input
                        id="edit-start-date"
                        type="date"
                        value={localStartDate}
                        onChange={handleStartDateChange}
                        disabled={disabled}
                        min={today}
                        className={`w-full px-3 py-2 text-sm border rounded-md focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-colors ${
                            disabled
                                ? 'bg-gray-100 cursor-not-allowed'
                                : 'bg-white hover:border-blue-300'
                        }`}
                    />
                    <div className="text-xs text-gray-500">
                        {formatDateEuropean(new Date(localStartDate))}
                    </div>
                </div>

                <div className="space-y-1">
                    <label htmlFor="edit-end-date" className="block text-xs text-gray-600">
                        –û–∫–æ–Ω—á–∞–Ω–∏–µ:
                    </label>
                    <input
                        id="edit-end-date"
                        type="date"
                        value={localEndDate}
                        onChange={handleEndDateChange}
                        disabled={disabled}
                        min={localStartDate}
                        className={`w-full px-3 py-2 text-sm border rounded-md focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-colors ${
                            disabled
                                ? 'bg-gray-100 cursor-not-allowed'
                                : 'bg-white hover:border-blue-300'
                        }`}
                    />
                    <div className="text-xs text-gray-500">
                        {formatDateEuropean(new Date(localEndDate))}
                    </div>
                </div>
            </div>
        </div>
    );
}

```


## <a name="rentalappmainsrccomponentsreservationEditableEquipmentItemtsx"></a>`rental-app-main/src/components/reservation/EditableEquipmentItem.tsx`

```tsx
// path: rental-app-main/src/components/reservation/EditableEquipmentItem.tsx

// src/components/reservation/EditableEquipmentItem.tsx
import { X } from "lucide-react";
import EquipmentItemWithConflicts from "./EquipmentItemWithConflicts";
import { AvailableAccessoriesDropdown } from "./AvailableAccessoriesDropdown"; // <-- –ù–æ–≤—ã–π –∏–º–ø–æ—Ä—Ç
import type { Equipment } from "@/types/equipment";
import type { AvailabilityInfo } from "@/types/availability";
import { Button } from "@/components/ui/button";

interface Props {
    itemDetail: { id: number; label: string };
    fullEquipmentItem: Equipment | undefined;
    isNew: boolean;
    hasConflict: boolean;
    availability?: AvailabilityInfo;
    selectedAccessoryIds: number[];
    onRemove: (id: number) => void;
    onToggleAccessory: (equipmentId: number, accessoryId: number) => void;
    disabled?: boolean;
}

export default function EditableEquipmentItem({
                                                  itemDetail,
                                                  fullEquipmentItem,
                                                  isNew,
                                                  hasConflict,
                                                  availability,
                                                  selectedAccessoryIds,
                                                  onRemove,
                                                  onToggleAccessory,
                                                  disabled
                                              }: Props) {

    if (!fullEquipmentItem) {
        return <div className="p-3 bg-gray-100 rounded-md text-sm text-red-600">–û—à–∏–±–∫–∞: –¥–∞–Ω–Ω—ã–µ –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—è –Ω–µ –Ω–∞–π–¥–µ–Ω—ã.</div>;
    }

    // –†–∞–∑–¥–µ–ª—è–µ–º –∞–∫—Å–µ—Å—Å—É–∞—Ä—ã –Ω–∞ —É–∂–µ –≤—ã–±—Ä–∞–Ω–Ω—ã–µ –∏ –¥–æ—Å—Ç—É–ø–Ω—ã–µ –¥–ª—è –≤—ã–±–æ—Ä–∞
    const selectedAccessoryDetails = fullEquipmentItem.accessories?.filter(
        acc => selectedAccessoryIds.includes(acc.id)
    ) || [];

    const availableAccessoriesDetails = fullEquipmentItem.accessories?.filter(
        acc => !selectedAccessoryIds.includes(acc.id)
    ) || [];


    return (
        <div className="bg-white p-3 rounded-md border">
            {/* –ë–ª–æ–∫ —Å –æ—Å–Ω–æ–≤–Ω–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–µ–π –æ–± –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏–∏ (–±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π) */}
            <EquipmentItemWithConflicts
                item={itemDetail}
                isNew={isNew}
                hasConflict={hasConflict}
                availability={availability}
                onRemove={onRemove}
                disabled={disabled}
            />

            {/* –ë–ª–æ–∫ –¥–ª—è —É–∂–µ –¥–æ–±–∞–≤–ª–µ–Ω–Ω—ã—Ö –∞–∫—Å–µ—Å—Å—É–∞—Ä–æ–≤ */}
            {selectedAccessoryDetails.length > 0 && (
                <div className="pl-8 pr-2 pt-2 border-t mt-2">
                    <p className="text-xs font-medium text-gray-500 mb-1">–î–æ–±–∞–≤–ª–µ–Ω–Ω—ã–µ –∞–∫—Å–µ—Å—Å—É–∞—Ä—ã:</p>
                    <ul className="space-y-1">
                        {selectedAccessoryDetails.map(acc => (
                            <li key={acc.id} className="flex justify-between items-center text-xs text-gray-800 hover:bg-slate-50 p-1 rounded">
                                <span>- {acc.name} <strong>({acc.price} ‚ÇΩ)</strong></span>
                                <Button
                                    variant="ghost"
                                    size="icon"
                                    className="h-5 w-5 text-gray-400 hover:bg-red-50 hover:text-red-600"
                                    onClick={() => onToggleAccessory(fullEquipmentItem.id, acc.id)}
                                    disabled={disabled}
                                    title="–£–±—Ä–∞—Ç—å –∞–∫—Å–µ—Å—Å—É–∞—Ä"
                                >
                                    <X className="w-3 h-3" />
                                </Button>
                            </li>
                        ))}
                    </ul>
                </div>
            )}

            {/* –í—ã–ø–∞–¥–∞—é—â–∏–π —Å–ø–∏—Å–æ–∫ –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –Ω–æ–≤—ã—Ö –∞–∫—Å–µ—Å—Å—É–∞—Ä–æ–≤ */}
            <AvailableAccessoriesDropdown
                accessories={availableAccessoriesDetails}
                equipmentId={fullEquipmentItem.id}
                onToggleAccessory={onToggleAccessory}
                disabled={disabled}
                hasTopBorder={selectedAccessoryDetails.length > 0}
            />
        </div>
    );
}

```


## <a name="rentalappmainsrccomponentsreservationEditableReservationCardtsx"></a>`rental-app-main/src/components/reservation/EditableReservationCard.tsx`

```tsx
// path: rental-app-main/src/components/reservation/EditableReservationCard.tsx

// src/components/reservation/EditableReservationCard.tsx

import React from "react"; // ‚úÖ –£–±—Ä–∞–ª–∏ –Ω–µ–∏—Å–ø–æ–ª—å–∑—É–µ–º—ã–π useMemo
import { Card } from "@/components/ui/card";
import { Button } from "@/components/ui/button";
import { Badge } from "@/components/ui/badge";
import { Loader2, Plus, Save, X, AlertTriangle, Sparkles } from "lucide-react";
import EditableDateRange from "./EditableDateRange";
import FinancialSummaryBlock from "@/components/shared/FinancialSummaryBlock";
import EditableEquipmentItem from "./EditableEquipmentItem";
import { useReservationEditContext } from "@/contexts/ReservationEditContext";
import { useNavigate } from "react-router-dom";
import HolidayConfirmationDialog from "./HolidayConfirmationDialog";
import { formatDateEuropean } from "@/lib/utils"; // ‚úÖ –î–æ–±–∞–≤–∏–ª–∏ –Ω–µ–¥–æ—Å—Ç–∞—é—â–∏–π –∏–º–ø–æ—Ä—Ç

export default function EditableReservationCard() {
    const {
        reservationId,
        editState,
        availabilityMap,
        equipmentMap,
        hasConflicts,
        saveChanges,
        cancelEdit,
        updateDates,
        removeEquipmentItem,
        isLoading,
        isCheckingAvailability,
        isSaving,
        localSelectedAccessories,
        toggleAccessory,
        holidayConflict,
        confirmHolidayAdjustment,
        cancelHolidayAdjustment,
        priceDetails,
        financials,
        setPromoCode,
        applyPromoCode,
        removePromoCode,
    } = useReservationEditContext();

    const navigate = useNavigate();

    const displayNewItemsCount = editState.newlyAddedEquipmentIdsAsArray.length;
    const equipmentToDisplay = editState.currentEquipmentDetails;
    const totalItemsInEdit = equipmentToDisplay.length;

    const onAddEquipment = () => {
        navigate("/", {
            state: {
                intent: "add_to_reservation",
                reservationId: reservationId,
                equipmentIds: editState.currentEquipmentDetails.map(eq => eq.id),
                startDate: editState.startDate.toISOString(),
                endDate: editState.endDate.toISOString(),
            }
        });
    };

    return (
        <>
            <Card className="w-full px-5 py-4 rounded-2xl border shadow-md bg-blue-50 border-blue-300 transition-all">
                <div className="space-y-4">
                    <div className="flex justify-between items-center">
                        <div className="flex items-center gap-2">
                            <div className="text-base font-semibold text-blue-700">
                                ‚úèÔ∏è –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Ä–µ–∑–µ—Ä–≤–∞ #{reservationId}
                            </div>
                            {isCheckingAvailability && (
                                <div className="flex items-center gap-1 text-xs text-blue-600">
                                    <Loader2 className="w-3 h-3 animate-spin" />
                                    –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏...
                                </div>
                            )}
                        </div>
                        <div className="flex items-center gap-2">
                            <Badge variant="outline" className="bg-blue-100 text-blue-700 border-blue-300">
                                –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ
                            </Badge>
                            {displayNewItemsCount > 0 && (
                                <Badge variant="outline" className="bg-green-100 text-green-700 border-green-300">
                                    <Sparkles className="w-3 h-3 mr-1" />
                                    +{displayNewItemsCount} –Ω–æ–≤—ã—Ö
                                </Badge>
                            )}
                        </div>
                    </div>

                    <div className="grid grid-cols-1 md:grid-cols-3 gap-6">
                        <div className="md:col-span-2 space-y-4">
                            {hasConflicts && (
                                <div className="flex items-start gap-2 p-3 bg-red-50 border border-red-200 rounded-md">
                                    <AlertTriangle className="w-4 h-4 text-red-600 mt-0.5 flex-shrink-0" />
                                    <div className="text-sm text-red-700">
                                        <div className="font-medium">–û–±–Ω–∞—Ä—É–∂–µ–Ω—ã –∫–æ–Ω—Ñ–ª–∏–∫—Ç—ã!</div>
                                        <div className="text-xs mt-1">
                                            –ù–µ–∫–æ—Ç–æ—Ä–æ–µ –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏–µ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–æ –Ω–∞ –≤—ã–±—Ä–∞–Ω–Ω—ã–µ –¥–∞—Ç—ã.
                                            –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –∏—Å–ø—Ä–∞–≤—å—Ç–µ –∫–æ–Ω—Ñ–ª–∏–∫—Ç—ã –ø–µ—Ä–µ–¥ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ–º.
                                        </div>
                                    </div>
                                </div>
                            )}

                            <EditableDateRange
                                startDate={editState.startDate}
                                endDate={editState.endDate}
                                onChange={updateDates}
                                disabled={isLoading}
                            />

                            <div className="space-y-3">
                                <div className="flex justify-between items-center">
                                    <div className="text-sm font-medium text-gray-700">
                                        –û–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏–µ ({totalItemsInEdit} –ø–æ–∑.
                                        {displayNewItemsCount > 0 && (
                                            <span className="text-green-600">
                                                , –∏–∑ –Ω–∏—Ö {displayNewItemsCount} –Ω–æ–≤—ã—Ö
                                            </span>
                                        )}
                                        ):
                                    </div>
                                    <Button
                                        variant="outline"
                                        size="sm"
                                        onClick={onAddEquipment}
                                        disabled={isLoading}
                                        className="text-xs px-3 py-1 h-7"
                                    >
                                        <Plus className="w-3 h-3 mr-1" />
                                        –î–æ–±–∞–≤–∏—Ç—å
                                    </Button>
                                </div>
                                {totalItemsInEdit === 0 ? (
                                    <div className="text-sm text-gray-500 text-center py-6 border border-dashed border-gray-300 rounded-md">
                                        –ù–µ—Ç –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—è –≤ —Ä–µ–∑–µ—Ä–≤–µ.{" "}
                                        <button
                                            onClick={onAddEquipment}
                                            disabled={isLoading}
                                            className="text-blue-600 hover:underline"
                                        >
                                            –î–æ–±–∞–≤–∏—Ç—å –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏–µ
                                        </button>
                                    </div>
                                ) : (
                                    <div className="space-y-2">
                                        {equipmentToDisplay.map((itemDetail) => {
                                            const availability = availabilityMap[itemDetail.id];
                                            const itemHasConflict = !!availability && (
                                                availability.status === "reserved" || availability.status === "rented"
                                            );
                                            const isNew = editState.newlyAddedEquipmentIdsAsArray.includes(itemDetail.id);

                                            return (
                                                <EditableEquipmentItem
                                                    key={itemDetail.id}
                                                    itemDetail={itemDetail}
                                                    fullEquipmentItem={equipmentMap.get(itemDetail.id)}
                                                    isNew={isNew}
                                                    hasConflict={itemHasConflict}
                                                    availability={availability}
                                                    selectedAccessoryIds={localSelectedAccessories[itemDetail.id] || []}
                                                    onRemove={() => removeEquipmentItem(itemDetail.id)}
                                                    onToggleAccessory={toggleAccessory}
                                                    disabled={isLoading}
                                                />
                                            );
                                        })}
                                    </div>
                                )}
                            </div>
                        </div>

                        <div className="md:col-span-1">
                            <FinancialSummaryBlock
                                priceDetails={priceDetails}
                                promoCode={financials.promoCode}
                                setPromoCode={setPromoCode}
                                applyPromoCode={applyPromoCode}
                                removePromoCode={removePromoCode}
                                promoCodeMessage={financials.promoCodeMessage}
                                isLoading={isCheckingAvailability}
                                hasConflicts={hasConflicts}
                                variant="inline"
                                showActions={false}
                            />
                        </div>
                    </div>

                    <div className="flex flex-col sm:flex-row justify-end items-center gap-3 pt-4 border-t border-blue-200 mt-4">
                        <Button
                            variant="ghost"
                            onClick={cancelEdit}
                            disabled={isLoading}
                            className="text-sm mr-auto"
                        >
                            <X className="w-4 h-4 mr-1" />
                            –û—Ç–º–µ–Ω–∞
                        </Button>
                        <Button
                            onClick={() => saveChanges()}
                            disabled={!editState.hasChanges || hasConflicts || isLoading || totalItemsInEdit === 0}
                            className="text-sm min-w-[120px]"
                        >
                            {isSaving ? (
                                <>
                                    <Loader2 className="w-4 h-4 mr-1 animate-spin" />
                                    –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ...
                                </>
                            ) : (
                                <>
                                    <Save className="w-4 h-4 mr-1" />
                                    –°–æ—Ö—Ä–∞–Ω–∏—Ç—å
                                </>
                            )}
                        </Button>
                    </div>

                    <div className="text-xs text-gray-500 bg-gray-50 border border-gray-200 rounded p-2 space-y-1 mt-4">
                        <div>üí° –ü–æ–¥—Å–∫–∞–∑–∫–∏:</div>
                        <ul className="space-y-0.5 ml-3">
                            <li>‚Ä¢ –ó–µ–ª–µ–Ω—ã–º –æ—Ç–º–µ—á–µ–Ω—ã –Ω–æ–≤—ã–µ –ø–æ–∑–∏—Ü–∏–∏, –¥–æ–±–∞–≤–ª–µ–Ω–Ω—ã–µ –ø—Ä–∏ —Ç–µ–∫—É—â–µ–º —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–∏.</li>
                            <li>‚Ä¢ –ñ–µ–ª—Ç—ã–º/–∫—Ä–∞—Å–Ω—ã–º –æ—Ç–º–µ—á–µ–Ω—ã –∫–æ–Ω—Ñ–ª–∏–∫—Ç—ã —Å –¥—Ä—É–≥–∏–º–∏ —Ä–µ–∑–µ—Ä–≤–∞–º–∏.</li>
                            <li>‚Ä¢ –ù–∞–∂–º–∏—Ç–µ "–î–æ–±–∞–≤–∏—Ç—å –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏–µ" –¥–ª—è –≤—ã–±–æ—Ä–∞ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã—Ö –ø–æ–∑–∏—Ü–∏–π.</li>
                            <li>‚Ä¢ –ö–Ω–æ–ø–∫–∞ "–°–æ—Ö—Ä–∞–Ω–∏—Ç—å" –∞–∫—Ç–∏–≤–Ω–∞ —Ç–æ–ª—å–∫–æ –ø—Ä–∏ –Ω–∞–ª–∏—á–∏–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–π –∏ –æ—Ç—Å—É—Ç—Å—Ç–≤–∏–∏ –∫–æ–Ω—Ñ–ª–∏–∫—Ç–æ–≤.</li>
                            <li>‚Ä¢ –ü–æ—Å–ª–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –Ω–æ–≤—ã–µ –ø–æ–∑–∏—Ü–∏–∏ —Å—Ç–∞–Ω—É—Ç –æ–±—ã—á–Ω—ã–º–∏ —á–∞—Å—Ç—è–º–∏ —Ä–µ–∑–µ—Ä–≤–∞.</li>
                        </ul>
                    </div>
                </div>
            </Card>

            <HolidayConfirmationDialog
                open={!!holidayConflict}
                message={holidayConflict?.message || ""}
                suggestedDate={holidayConflict ? formatDateEuropean(new Date(holidayConflict.suggested_end_date)) : ""}
                onConfirm={confirmHolidayAdjustment}
                onCancel={cancelHolidayAdjustment}
                isConfirming={isSaving}
            />
        </>
    );
}

```


## <a name="rentalappmainsrccomponentsreservationEquipmentItemWithConflictstsx"></a>`rental-app-main/src/components/reservation/EquipmentItemWithConflicts.tsx`

```tsx
// path: rental-app-main/src/components/reservation/EquipmentItemWithConflicts.tsx

// src/components/reservation/EquipmentItemWithConflicts.tsx
import { Button } from "@/components/ui/button";
import { MinusCircle, AlertTriangle, CheckCircle, Sparkles } from "lucide-react";
import { formatDateRangeEuropean } from "@/lib/utils";
import type { AvailabilityInfo } from "@/types/availability";

interface EquipmentItemWithConflictsProps {
    item: { id: number; label: string };
    isNew: boolean;
    hasConflict: boolean;
    availability?: AvailabilityInfo;
    onRemove?: (id: number) => void;
    disabled?: boolean;
}

export default function EquipmentItemWithConflicts({
                                                       item,
                                                       isNew,
                                                       hasConflict,
                                                       availability,
                                                       onRemove,
                                                       disabled = false
                                                   }: EquipmentItemWithConflictsProps) {

    const getStatusInfo = () => {
        if (hasConflict && availability) {
            const dateRange = availability.start_date && availability.end_date
                ? formatDateRangeEuropean(availability.start_date, availability.end_date)
                : "";

            if (availability.status === "reserved") {
                return {
                    icon: <AlertTriangle className="w-4 h-4" />,
                    color: "text-yellow-600",
                    bgColor: "bg-yellow-50 border-yellow-200",
                    status: "–ó–∞—Ä–µ–∑–µ—Ä–≤–∏—Ä–æ–≤–∞–Ω–æ",
                    dateText: dateRange
                };
            } else if (availability.status === "rented") {
                return {
                    icon: <AlertTriangle className="w-4 h-4" />,
                    color: "text-red-600",
                    bgColor: "bg-red-50 border-red-200",
                    status: "–í –∞—Ä–µ–Ω–¥–µ",
                    dateText: dateRange
                };
            }
        }

        if (isNew) {
            return {
                icon: <Sparkles className="w-4 h-4" />,
                color: "text-green-600",
                bgColor: "bg-green-50 border-green-200",
                status: "–ù–æ–≤–∞—è –ø–æ–∑–∏—Ü–∏—è",
                dateText: ""
            };
        }

        return {
            icon: <CheckCircle className="w-4 h-4" />,
            color: "text-gray-600",
            bgColor: "bg-gray-50 border-gray-200",
            status: "–î–æ—Å—Ç—É–ø–Ω–æ",
            dateText: ""
        };
    };

    const statusInfo = getStatusInfo();

    return (
        <div className={`flex justify-between items-start p-3 rounded-md border transition-colors ${statusInfo.bgColor}`}>
            <div className="flex-1 min-w-0">
                <div className="flex items-start gap-2">
                    <div className={`flex-shrink-0 mt-0.5 ${statusInfo.color}`}>
                        {statusInfo.icon}
                    </div>

                    <div className="flex-1 min-w-0">
                        <div className="text-sm font-medium text-gray-900 truncate">
                            {item.label}
                        </div>

                        <div className={`text-xs ${statusInfo.color} mt-1`}>
                            {statusInfo.status}
                            {statusInfo.dateText && (
                                <span className="ml-1 font-normal">
                  ({statusInfo.dateText})
                </span>
                            )}
                        </div>

                        {hasConflict && (
                            <div className="text-xs text-red-600 mt-1 font-medium">
                                ‚ö†Ô∏è –ö–æ–Ω—Ñ–ª–∏–∫—Ç: –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏–µ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–æ –Ω–∞ –≤—ã–±—Ä–∞–Ω–Ω—ã–µ –¥–∞—Ç—ã
                            </div>
                        )}
                    </div>
                </div>
            </div>

            {onRemove && (
                <Button
                    variant="ghost"
                    size="icon"
                    onClick={() => onRemove(item.id)}
                    disabled={disabled}
                    className={`ml-2 h-8 w-8 flex-shrink-0 hover:text-red-700 ${
                        disabled
                            ? "text-gray-400 cursor-not-allowed"
                            : hasConflict
                                ? "text-red-500 hover:bg-red-100"
                                : "text-gray-500 hover:bg-gray-100"
                    }`}
                    title="–£–¥–∞–ª–∏—Ç—å –∏–∑ —Ä–µ–∑–µ—Ä–≤–∞"
                >
                    <MinusCircle className="w-4 h-4" />
                </Button>
            )}
        </div>
    );
}

```


## <a name="rentalappmainsrccomponentsreservationHolidayConfirmationDialogtsx"></a>`rental-app-main/src/components/reservation/HolidayConfirmationDialog.tsx`

```tsx
// path: rental-app-main/src/components/reservation/HolidayConfirmationDialog.tsx

// src/components/reservation/HolidayConfirmationDialog.tsx
import {
    Dialog,
    DialogContent,
    DialogHeader,
    DialogTitle,
    DialogDescription,
    DialogFooter,
} from "@/components/ui/dialog";
import { Button } from "@/components/ui/button";
import { AlertTriangle } from "lucide-react";

type Props = {
    open: boolean;
    message: string;
    suggestedDate: string;
    onConfirm: () => void;
    onCancel: () => void;
    isConfirming: boolean;
};

export default function HolidayConfirmationDialog({
                                                      open,
                                                      message,
                                                      suggestedDate,
                                                      onConfirm,
                                                      onCancel,
                                                      isConfirming,
                                                  }: Props) {
    return (
        <Dialog open={open} onOpenChange={onCancel}>
            <DialogContent>
                <DialogHeader>
                    <DialogTitle className="flex items-center gap-2">
                        <AlertTriangle className="text-amber-500" />
                        –î–∞—Ç–∞ –æ–∫–æ–Ω—á–∞–Ω–∏—è - –≤—ã—Ö–æ–¥–Ω–æ–π
                    </DialogTitle>
                </DialogHeader>
                <DialogDescription>
                    <p>{message}</p>
                    <p className="mt-2">
                        –í—ã —Ö–æ—Ç–∏—Ç–µ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∏–∑–º–µ–Ω–∏—Ç—å –¥–∞—Ç—É –æ–∫–æ–Ω—á–∞–Ω–∏—è –Ω–∞ –±–ª–∏–∂–∞–π—à–∏–π —Ä–∞–±–æ—á–∏–π –¥–µ–Ω—å:
                        <strong className="text-gray-800"> {suggestedDate}</strong>?
                    </p>
                </DialogDescription>
                <DialogFooter className="pt-4">
                    <Button variant="ghost" onClick={onCancel} disabled={isConfirming}>
                        –ù–µ—Ç, —è –≤—ã–±–µ—Ä—É –¥—Ä—É–≥—É—é –¥–∞—Ç—É
                    </Button>
                    <Button
                        onClick={onConfirm}
                        disabled={isConfirming}
                    >
                        {isConfirming ? "–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ..." : "–î–∞, –∏–∑–º–µ–Ω–∏—Ç—å"}
                    </Button>
                </DialogFooter>
            </DialogContent>
        </Dialog>
    );
}

```


## <a name="rentalappmainsrccomponentsreservationReservationItemsListtsx"></a>`rental-app-main/src/components/reservation/ReservationItemsList.tsx`

```tsx
// path: rental-app-main/src/components/reservation/ReservationItemsList.tsx

// src/components/reservation/ReservationItemsList.tsx
import ReserveEquipmentCard from "@/components/ReserveEquipmentCard";
import { Button } from "@/components/ui/button";
import { Paperclip, X } from "lucide-react";
import type { Equipment } from "@/types/equipment";
import type { AvailabilityInfo } from "@/types/availability";

interface Props {
    items: Equipment[];
    selectedAccessories: Record<number, number[]>;
    availabilityMap: Record<number, AvailabilityInfo>;
    unavailableIdsFromAPI: number[];
    invalidItems: number[];
    onRemoveItem: (id: number) => void;
    onRemoveAccessory: (equipmentId: number, accessoryId: number) => void;
    // ‚úÖ –î–û–ë–ê–í–õ–ï–ù–´ –ù–û–í–´–ï –°–í–û–ô–°–¢–í–ê
    isAccessorySelected: (equipmentId: number, accessoryId: number) => boolean;
    onToggleAccessory: (equipmentId: number, accessoryId: number) => void;
}

export default function ReservationItemsList({
                                                 items,
                                                 selectedAccessories,
                                                 availabilityMap,
                                                 unavailableIdsFromAPI,
                                                 invalidItems,
                                                 onRemoveItem,
                                                 onRemoveAccessory,
                                                 // ‚úÖ –ü–û–õ–£–ß–ê–ï–ú –ù–û–í–´–ï –°–í–û–ô–°–¢–í–ê
                                                 isAccessorySelected,
                                                 onToggleAccessory,
                                             }: Props) {
    return (
        <div className="space-y-4 pt-4">
            {items.map((item) => {
                const selectedAccessoryIds = selectedAccessories[item.id] || [];
                const selectedAccessoryDetails = item.accessories?.filter(acc =>
                    selectedAccessoryIds.includes(acc.id)
                ) || [];

                return (
                    <div
                        key={item.id}
                        className={`border rounded-lg overflow-hidden shadow-sm transition-all ${
                            unavailableIdsFromAPI.includes(item.id) || invalidItems.includes(item.id)
                                ? "border-red-400 bg-red-50"
                                : "border-gray-200 bg-white"
                        }`}
                    >
                        <ReserveEquipmentCard
                            equipment={item}
                            availability={availabilityMap[item.id]}
                            onRemove={() => onRemoveItem(item.id)}
                            // ‚úÖ –ü–ï–†–ï–î–ê–ï–ú –§–£–ù–ö–¶–ò–ò –í –ö–ê–†–¢–û–ß–ö–£
                            isAccessorySelected={isAccessorySelected}
                            onToggleAccessory={onToggleAccessory}
                        />

                        {selectedAccessoryDetails.length > 0 && (
                            <div className="px-4 pb-3 pt-2 bg-slate-50 border-t border-dashed">
                                <h4 className="flex items-center gap-1.5 text-xs font-semibold text-gray-600 mb-2">
                                    <Paperclip className="h-3.5 w-3.5" />
                                    –î–æ–ø. –∞–∫—Å–µ—Å—Å—É–∞—Ä—ã:
                                </h4>
                                <ul className="space-y-1.5">
                                    {selectedAccessoryDetails.map(acc => (
                                        <li key={acc.id} className="flex items-center justify-between text-xs hover:bg-slate-100 p-1 rounded-md">
                                            <span className="text-gray-800">{acc.name}</span>
                                            <div className="flex items-center gap-2">
                                                <span className="text-gray-500 font-medium">{acc.price} ‚ÇΩ</span>
                                                <Button
                                                    variant="ghost"
                                                    size="icon"
                                                    className="h-5 w-5 text-gray-400 hover:text-red-500 hover:bg-red-50"
                                                    onClick={() => onRemoveAccessory(item.id, acc.id)}
                                                    title="–£–¥–∞–ª–∏—Ç—å –∞–∫—Å–µ—Å—Å—É–∞—Ä"
                                                >
                                                    <X className="h-3 w-3" />
                                                </Button>
                                            </div>
                                        </li>
                                    ))}
                                </ul>
                            </div>
                        )}

                        {(unavailableIdsFromAPI.includes(item.id) || invalidItems.includes(item.id)) && (
                            <p className="text-sm text-red-600 px-4 pb-2 pt-0">
                                –≠—Ç–æ –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏–µ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–æ –Ω–∞ –≤—ã–±—Ä–∞–Ω–Ω—ã–µ –¥–∞—Ç—ã.
                            </p>
                        )}
                    </div>
                )
            })}
        </div>
    );
}

```


## <a name="rentalappmainsrccomponentsreservationReservationStatusBadgetsx"></a>`rental-app-main/src/components/reservation/ReservationStatusBadge.tsx`

```tsx
// path: rental-app-main/src/components/reservation/ReservationStatusBadge.tsx

// src/components/reservation/ReservationStatusBadge.tsx

import { Badge } from "@/components/ui/badge";
import type { Reservation } from "@/types/reservation";

type Status = Reservation['status'];

interface Props {
    status: Status;
}

const statusConfig: Record<Status, { text: string; className: string }> = {
    active: {
        text: "–ê–∫—Ç–∏–≤–µ–Ω",
        className: "bg-green-100 text-green-800 border-green-200",
    },
    fulfilled: {
        text: "–í—ã–¥–∞–Ω –≤ –∞—Ä–µ–Ω–¥—É",
        className: "bg-blue-100 text-blue-800 border-blue-200",
    },
    cancelled: {
        text: "–û—Ç–º–µ–Ω–µ–Ω",
        className: "bg-gray-100 text-gray-800 border-gray-200",
    },
    overdue: {
        text: "–ü—Ä–æ—Å—Ä–æ—á–µ–Ω",
        className: "bg-orange-100 text-orange-800 border-orange-200",
    },
};

export default function ReservationStatusBadge({ status }: Props) {
    const config = statusConfig[status] || statusConfig.cancelled;

    return (
        <Badge variant="outline" className={`font-medium ${config.className}`}>
            {config.text}
        </Badge>
    );
}


```


## <a name="rentalappmainsrccomponentsreservationViewReservationCardtsx"></a>`rental-app-main/src/components/reservation/ViewReservationCard.tsx`

```tsx
// path: rental-app-main/src/components/reservation/ViewReservationCard.tsx

// src/components/reservation/ViewReservationCard.tsx

import { Button } from "@/components/ui/button";
import { Card } from "@/components/ui/card";
import ReservationStatusBadge from "./ReservationStatusBadge";
import { MinusCircle, CalendarRange, Edit2, RotateCcw, Trash2, ExternalLink } from "lucide-react";
import { useNavigate, useLocation } from "react-router-dom";
import { formatDateEuropean } from "@/lib/utils";
import type { Reservation, AccessoryLink } from "@/types/reservation";
import { useState } from "react";
import EquipmentWithAccessoriesList from "@/components/shared/EquipmentWithAccessoriesList";
import FinancialInfoBlock from "@/components/shared/FinancialInfoBlock";
import { RESERVATION_CARD_STYLES } from "@/constants/statusStyles";

interface ViewReservationCardProps {
    id: number;
    equipment: { id: number; label: string }[];
    start_date: string;
    end_date: string;
    status: Reservation['status'];
    onEdit?: () => void;
    onCancel?: () => void;
    onRemoveItem?: (equipmentId: number) => void;
    onRepeat?: () => void;
    cancelDisabled?: boolean;
    total_cost?: number;
    discount_amount?: number;
    promo_code?: string | null;
    rental_id?: number | null;
    accessory_links?: AccessoryLink[];
}

export default function ViewReservationCard(props: ViewReservationCardProps) {
    const {
        id,
        equipment,
        start_date,
        end_date,
        status,
        onEdit,
        onCancel,
        onRemoveItem,
        onRepeat,
        cancelDisabled,
        total_cost,
        discount_amount,
        promo_code,
        rental_id,
        accessory_links,
    } = props;

    const navigate = useNavigate();
    const location = useLocation();

    const start = start_date ? new Date(start_date) : null;
    const end = end_date ? new Date(end_date) : null;

    const now = new Date();
    const isPast = !!end && end < now;

    const msPerDay = 1000 * 60 * 60 * 24;
    const daysUntilStart = start ? Math.ceil((start.getTime() - now.getTime()) / msPerDay) : null;
    const daysUntilEnd = end ? Math.floor((end.getTime() - now.getTime()) / msPerDay) : null;

    const isProtected = !isPast && daysUntilEnd !== null && daysUntilEnd < 2;
    const isActionable = status === 'active';
    const canBeRepeated = status === 'fulfilled' || status === 'cancelled';
    const cardColor = RESERVATION_CARD_STYLES[status] || RESERVATION_CARD_STYLES.default;

    const getStatusInfo = () => {
        if (isPast) {
            return {
                showMessage: false,
                message: "",
                className: ""
            };
        }

        if (daysUntilStart !== null) {
            if (daysUntilStart <= 0) {
                return {
                    showMessage: true,
                    message: "–†–µ–∑–µ—Ä–≤ —É–∂–µ –Ω–∞—á–∞–ª—Å—è",
                    className: "text-green-600"
                };
            } else if (daysUntilStart <= 3) {
                return {
                    showMessage: true,
                    message: `–î–æ –Ω–∞—á–∞–ª–∞ —Ä–µ–∑–µ—Ä–≤–∞: ${daysUntilStart} –¥–Ω.`,
                    className: "text-orange-600 font-medium"
                };
            } else {
                return {
                    showMessage: true,
                    message: `–î–æ –Ω–∞—á–∞–ª–∞ —Ä–µ–∑–µ—Ä–≤–∞: ${daysUntilStart} –¥–Ω.`,
                    className: "text-gray-600"
                };
            }
        }

        return {
            showMessage: false,
            message: "",
            className: ""
        };
    };

    const statusInfo = getStatusInfo();

    const handleRentalClick = () => {
        if (rental_id) {
            navigate("/reservations/my", {
                state: {
                    highlightRentalId: rental_id,
                    from: "reservation"
                }
            });
        }
    };

    return (
        <Card className={`w-full px-5 py-4 rounded-2xl border shadow-sm hover:shadow-md transition-all ${cardColor}`}>
            <div className="space-y-3">
                <div className="flex justify-between items-center">
                    <div className="text-base font-semibold text-sky-700">–†–µ–∑–µ—Ä–≤ #{id}</div>
                    <div className="flex items-center gap-2">
                        <ReservationStatusBadge status={status} />
                        {rental_id && status === 'fulfilled' && (
                            <Button
                                variant="outline"
                                size="sm"
                                onClick={handleRentalClick}
                                className="text-orange-600 hover:text-orange-700 hover:bg-orange-50 border-orange-200"
                            >
                                <ExternalLink className="w-3 h-3 mr-1" />
                                –ê—Ä–µ–Ω–¥–∞ #{rental_id}
                            </Button>
                        )}
                    </div>
                </div>

                <div className="flex flex-col sm:flex-row sm:justify-between sm:items-center gap-2 pt-2 border-t border-dashed">
                    {start && end ? (
                        <div className="flex items-center gap-2 text-sm">
                            <CalendarRange className="w-4 h-4 text-gray-500 flex-shrink-0" />
                            <span>{formatDateEuropean(start)} ‚Äî {formatDateEuropean(end)}</span>
                        </div>
                    ) : (
                        <p className="text-red-600 text-sm">–û—à–∏–±–∫–∞ –≤ –¥–∞—Ç–µ —Ä–µ–∑–µ—Ä–≤–∞</p>
                    )}

                    <FinancialInfoBlock
                        totalCost={total_cost}
                        discountAmount={discount_amount}
                        promoCode={promo_code}
                        variant="default"
                        className="justify-start sm:justify-end"
                    />
                </div>

                {statusInfo.showMessage && status === 'active' && (
                    <div className="flex items-center gap-2 text-sm">
                        <div className={`px-2 py-1 rounded-md text-xs ${statusInfo.className} bg-opacity-10`}>
                            {statusInfo.message}
                        </div>
                    </div>
                )}

                {/* –°–æ—Å—Ç–∞–≤ —Ä–µ–∑–µ—Ä–≤–∞ */}
                <EquipmentWithAccessoriesList
                    equipment={equipment.map(item => ({ id: item.id, name: item.label }))}
                    accessoryLinks={accessory_links || []}
                    title="–°–æ—Å—Ç–∞–≤ —Ä–µ–∑–µ—Ä–≤–∞:"
                    showTitle={true}
                    className="pt-2 border-t"
                    showRemoveButton={isActionable && !!onRemoveItem}
                    onRemoveItem={onRemoveItem}
                    isRemoveDisabled={isProtected}
                    removeButtonTitle={isProtected ? "–£–¥–∞–ª–µ–Ω–∏–µ —á–µ—Ä–µ–∑ –º–µ–Ω–µ–¥–∂–µ—Ä–∞" : "–£–¥–∞–ª–∏—Ç—å –∏–∑ —Ä–µ–∑–µ—Ä–≤–∞"}
                />

                {canBeRepeated && onRepeat ? (
                    <div className="flex justify-end pt-2 border-t border-gray-200">
                        <Button variant="outline" size="sm" onClick={onRepeat}>
                            <RotateCcw className="w-4 h-4 mr-1" />
                            –ü–æ–≤—Ç–æ—Ä–∏—Ç—å —Ä–µ–∑–µ—Ä–≤
                        </Button>
                    </div>
                ) : (
                    <div className="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-2 pt-2 border-t border-gray-200">
                        {isProtected ? (
                            <div className="flex flex-col gap-2">
                                <p className="text-sm font-medium text-rose-700">
                                    –û—Ç–º–µ–Ω–∞ –∏ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Ç–æ–ª—å–∫–æ —á–µ—Ä–µ–∑ –º–µ–Ω–µ–¥–∂–µ—Ä–∞
                                </p>
                                <Button
                                    variant="outline"
                                    size="sm"
                                    onClick={() => navigate("/contacts", { state: { from: location.pathname } })}
                                >
                                    –ù–∞–ø–∏—Å–∞—Ç—å –º–µ–Ω–µ–¥–∂–µ—Ä—É
                                </Button>
                            </div>
                        ) : (
                            <div className="text-sm text-gray-600">
                                {daysUntilEnd !== null && daysUntilEnd >= 0 && (
                                    <span>–î–æ –æ–∫–æ–Ω—á–∞–Ω–∏—è: {daysUntilEnd} –¥–Ω.</span>
                                )}
                            </div>
                        )}

                        <div className="flex gap-2 justify-end w-full sm:w-auto">
                            {isActionable && onEdit && !isProtected && (
                                <Button variant="secondary" size="sm" onClick={onEdit}>
                                    <Edit2 className="w-4 h-4 mr-1" />
                                    –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å
                                </Button>
                            )}
                            {isActionable && onCancel && !isProtected && (
                                <Button
                                    variant="destructive"
                                    size="sm"
                                    disabled={cancelDisabled}
                                    onClick={onCancel}
                                >
                                    <Trash2 className="w-4 h-4 mr-1" />
                                    {cancelDisabled ? "–û—Ç–º–µ–Ω–∞..." : "–û—Ç–º–µ–Ω–∏—Ç—å"}
                                </Button>
                            )}
                        </div>
                    </div>
                )}
            </div>
        </Card>
    );
}

```


## <a name="rentalappmainsrccomponentssessionUserSessiontsx"></a>`rental-app-main/src/components/session/UserSession.tsx`

```tsx
// path: rental-app-main/src/components/session/UserSession.tsx

// src/components/session/UserSession.tsx

import AuthForm from "@/components/AuthForm";
import UserInfoBlock from "@/components/UserInfoBlock";
import { useCurrentUser } from "@/hooks/useProfile";

/**
 * –ö–æ–º–ø–æ–Ω–µ–Ω—Ç –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–æ–π —Å–µ—Å—Å–∏–µ–π.
 * –û—Ç–æ–±—Ä–∞–∂–∞–µ—Ç —Ñ–æ—Ä–º—É –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ –¥–ª—è –≥–æ—Å—Ç–µ–π –∏–ª–∏ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ –¥–ª—è –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω–Ω—ã—Ö.
 */
export default function UserSession() {
    const { data: user } = useCurrentUser();

    return user ? <UserInfoBlock showExtraLinks={true} /> : <AuthForm />;
}


```


## <a name="rentalappmainsrccomponentssharedEquipmentWithAccessoriesListtsx"></a>`rental-app-main/src/components/shared/EquipmentWithAccessoriesList.tsx`

```tsx
// path: rental-app-main/src/components/shared/EquipmentWithAccessoriesList.tsx

// src/components/shared/EquipmentWithAccessoriesList.tsx

import { useState } from "react";
import { Paperclip, ChevronDown, MinusCircle } from "lucide-react";
import { Button } from "@/components/ui/button";
import type { AccessoryLink } from "@/types/reservation";

interface EquipmentItem {
    id: number;
    name: string;
}

interface EquipmentWithAccessoriesListProps {
    equipment: EquipmentItem[];
    accessoryLinks?: AccessoryLink[];
    title?: string;
    showTitle?: boolean;
    className?: string;
    showRemoveButton?: boolean;
    onRemoveItem?: (equipmentId: number) => void;
    isRemoveDisabled?: boolean;
    removeButtonTitle?: string;
}

export default function EquipmentWithAccessoriesList({
    equipment,
    accessoryLinks = [],
    title = "–°–æ—Å—Ç–∞–≤ —Ä–µ–∑–µ—Ä–≤–∞:",
    showTitle = true,
    className = "",
    showRemoveButton = false,
    onRemoveItem,
    isRemoveDisabled = false,
    removeButtonTitle = "–£–¥–∞–ª–∏—Ç—å –∏–∑ —Ä–µ–∑–µ—Ä–≤–∞"
}: EquipmentWithAccessoriesListProps) {
    const [expandedAccessories, setExpandedAccessories] = useState<Record<number, boolean>>({});

    // –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏ –æ—Ç—Å—É—Ç—Å—Ç–≤—É—é—â–∏—Ö –∞–∫—Å–µ—Å—Å—É–∞—Ä–æ–≤
    const missingAccessories = accessoryLinks.filter(link => !link.accessory);
    if (missingAccessories.length > 0) {
        console.warn('–û–±–Ω–∞—Ä—É–∂–µ–Ω—ã AccessoryLink —Å –æ—Ç—Å—É—Ç—Å—Ç–≤—É—é—â–∏–º–∏ accessory:', missingAccessories);
    }

    const toggleAccessories = (equipmentId: number) => {
        setExpandedAccessories(prev => ({
            ...prev,
            [equipmentId]: !prev[equipmentId]
        }));
    };

    if (equipment.length === 0) {
        return (
            <div className={`space-y-2 pt-2 border-t ${className}`}>
                {showTitle && (
                    <h4 className="font-medium text-sm text-gray-800">{title}</h4>
                )}
                <div className="text-sm text-gray-500 italic">–ù–µ—Ç –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—è –≤ —Ä–µ–∑–µ—Ä–≤–µ</div>
            </div>
        );
    }

    return (
        <div className={`space-y-2 pt-2 border-t ${className}`}>
            {showTitle && (
                <h4 className="font-medium text-sm text-gray-800">{title}</h4>
            )}
            <div className="space-y-2">
                {equipment.map((item) => {
                    // –§–∏–ª—å—Ç—Ä—É–µ–º –∞–∫—Å–µ—Å—Å—É–∞—Ä—ã, —á—Ç–æ–±—ã —É–±–µ–¥–∏—Ç—å—Å—è, —á—Ç–æ –¥–∞–Ω–Ω—ã–µ –æ –Ω–∏—Ö —Å—É—â–µ—Å—Ç–≤—É—é—Ç
                    const accessoriesForItem = accessoryLinks.filter(link => 
                        link.equipment_id === item.id && link.accessory
                    );
                    
                    return (
                        <div key={item.id} className="text-sm text-gray-700 bg-gray-50/70 p-2 rounded-md border">
                            <div className="flex justify-between items-center">
                                <p>‚Ä¢ {item.name}</p>
                                {showRemoveButton && onRemoveItem && (
                                    <Button
                                        variant="ghost"
                                        size="icon"
                                        onClick={() => onRemoveItem(item.id)}
                                        className={`hover:text-rose-700 ${
                                            isRemoveDisabled ? "text-gray-400 cursor-not-allowed" : "text-rose-500"
                                        }`}
                                        title={removeButtonTitle}
                                        aria-label="–£–¥–∞–ª–∏—Ç—å –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏–µ"
                                        disabled={isRemoveDisabled}
                                    >
                                        <MinusCircle className="w-4 h-4" />
                                    </Button>
                                )}
                            </div>
                            {accessoriesForItem.length > 0 && (
                                <div className="mt-2 pl-4">
                                    <button 
                                        onClick={() => toggleAccessories(item.id)} 
                                        className="flex items-center text-xs text-sky-700 hover:underline font-medium"
                                    >
                                        <Paperclip className="w-3 h-3 mr-1" />
                                        –ê–∫—Å–µ—Å—Å—É–∞—Ä—ã ({accessoriesForItem.length})
                                        <ChevronDown className={`w-4 h-4 ml-1 transition-transform ${expandedAccessories[item.id] ? 'rotate-180' : ''}`} />
                                    </button>
                                    {expandedAccessories[item.id] && (
                                        <ul className="list-disc list-inside text-xs text-gray-600 mt-1 pl-2 animate-in fade-in duration-200">
                                            {accessoriesForItem.map(link => {
                                                // –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –∑–∞—â–∏—Ç–∞ –Ω–∞ —Å–ª—É—á–∞–π, –µ—Å–ª–∏ accessory —Å—Ç–∞–ª null –ø–æ—Å–ª–µ —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏
                                                if (!link.accessory) {
                                                    console.warn('–û–±–Ω–∞—Ä—É–∂–µ–Ω AccessoryLink —Å –æ—Ç—Å—É—Ç—Å—Ç–≤—É—é—â–∏–º accessory:', link);
                                                    return null;
                                                }
                                                return (
                                                    <li key={link.accessory.id}>{link.accessory.name}</li>
                                                );
                                            })}
                                        </ul>
                                    )}
                                </div>
                            )}
                        </div>
                    );
                })}
            </div>
        </div>
    );
}


```


## <a name="rentalappmainsrccomponentssharedFinancialInfoBlocktsx"></a>`rental-app-main/src/components/shared/FinancialInfoBlock.tsx`

```tsx
// path: rental-app-main/src/components/shared/FinancialInfoBlock.tsx

// src/components/shared/FinancialInfoBlock.tsx

import { Tag, Receipt, ReceiptText } from "lucide-react";
import { cn } from "@/lib/utils";

interface FinancialInfoBlockProps {
    totalCost?: number | null;
    discountAmount?: number | null;
    promoCode?: string | null;
    variant?: 'default' | 'compact' | 'admin';
    className?: string;
}

export default function FinancialInfoBlock({
    totalCost,
    discountAmount,
    promoCode,
    variant = 'default',
    className
}: FinancialInfoBlockProps) {
    // –ê–¥–º–∏–Ω—Å–∫–∏–π —Å—Ç–∏–ª—å - –∫–∞–∫ –≤ AdminRentalCard
    if (variant === 'admin') {
        return (
            <div className={cn("flex-shrink-0 md:w-64 bg-slate-50 p-3 rounded-lg border space-y-2", className)}>
                <h4 className="font-semibold text-sm text-slate-800 flex items-center gap-2">
                    <ReceiptText className="w-4 h-4"/>–§–∏–Ω–∞–Ω—Å—ã
                </h4>
                <div className="text-xs space-y-1.5 text-slate-700">
                    <div className="flex justify-between">
                        <span>–û–±—â–∞—è —Å—Ç–æ–∏–º–æ—Å—Ç—å:</span> 
                        <span className="font-medium">{totalCost?.toLocaleString('ru-RU') ?? '–ù/–î'} ‚ÇΩ</span>
                    </div>
                    {promoCode && (
                        <div className="flex justify-between">
                            <span>–ü—Ä–æ–º–æ–∫–æ–¥:</span> 
                            <span className="font-medium text-purple-600">{promoCode}</span>
                        </div>
                    )}
                    {(discountAmount ?? 0) > 0 && (
                        <div className="flex justify-between">
                            <span>–°–∫–∏–¥–∫–∞:</span> 
                            <span className="font-medium text-green-600">-{discountAmount?.toLocaleString('ru-RU')} ‚ÇΩ</span>
                        </div>
                    )}
                </div>
            </div>
        );
    }

    // –ö–æ–º–ø–∞–∫—Ç–Ω—ã–π –∏ —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π —Å—Ç–∏–ª–∏ (–æ–±—ä–µ–¥–∏–Ω–µ–Ω—ã –¥–ª—è —É—Å—Ç—Ä–∞–Ω–µ–Ω–∏—è –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏—è)
    const isCompact = variant === 'compact';
    const containerClasses = isCompact 
        ? "flex flex-wrap items-center justify-start gap-x-4 gap-y-1 text-sm pt-2 border-t border-dashed"
        : "flex flex-wrap items-center justify-start gap-x-4 gap-y-1 text-sm";
    
    return (
        <div className={cn(containerClasses, className)}>
            {promoCode && (
                <div className="flex items-center gap-1.5 text-xs text-purple-600 self-end">
                    <Tag className="w-3 h-3" />
                    <span>{promoCode}</span>
                </div>
            )}
            <div className="text-right">
                <div className="flex items-center gap-1.5 font-semibold">
                    <Receipt className="w-4 h-4 text-gray-500" />
                    –ò—Ç–æ–≥:
                    <span className="text-gray-800">
                        {totalCost?.toLocaleString('ru-RU') ?? '–ù/–î'} ‚ÇΩ
                    </span>
                </div>
                {(discountAmount ?? 0) > 0 && (
                    <div className="text-xs text-green-600 mt-0.5">
                        —Å–æ —Å–∫–∏–¥–∫–æ–π –≤ {discountAmount?.toLocaleString('ru-RU')} ‚ÇΩ
                    </div>
                )}
            </div>
        </div>
    );
}


```


## <a name="rentalappmainsrccomponentssharedFinancialSummaryBlocktsx"></a>`rental-app-main/src/components/shared/FinancialSummaryBlock.tsx`

```tsx
// path: rental-app-main/src/components/shared/FinancialSummaryBlock.tsx

// src/components/shared/FinancialSummaryBlock.tsx

import { Button } from "@/components/ui/button";
import PromoCodeInput from "@/components/PromoCodeInput";
import { ReceiptText, Loader2, AlertTriangle } from "lucide-react";
import { cn } from "@/lib/utils";
import type { PriceDetails } from "@/hooks/reservation/usePriceCalculator";

interface FinancialSummaryBlockProps {
    // –î–∞–Ω–Ω—ã–µ –æ —Å—Ç–æ–∏–º–æ—Å—Ç–∏
    priceDetails?: PriceDetails | null;
    
    // –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —Ñ–∏–Ω–∞–Ω—Å–æ–≤—ã–µ –¥–∞–Ω–Ω—ã–µ
    accessoriesDailyTotal?: number;
    
    // –ü—Ä–æ–º–æ–∫–æ–¥
    promoCode: string;
    setPromoCode: (code: string) => void;
    applyPromoCode: () => void;
    removePromoCode?: () => void;
    promoCodeMessage?: string;
    
    // –°–æ—Å—Ç–æ—è–Ω–∏—è –∑–∞–≥—Ä—É–∑–∫–∏
    isLoading?: boolean;
    isApplyingPromoCode?: boolean;
    isSubmitting?: boolean;
    
    // –í–∞–ª–∏–¥–∞—Ü–∏—è
    isFormValid?: boolean;
    hasConflicts?: boolean;
    
    // –î–µ–π—Å—Ç–≤–∏—è
    onCancel?: () => void;
    onAddMore?: () => void;
    onSubmit?: () => void;
    
    // –°—Ç–∏–ª–∏–∑–∞—Ü–∏—è
    variant?: 'default' | 'compact' | 'admin' | 'inline';
    className?: string;
    showActions?: boolean;
}

/**
 * –£–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω—ã–π –∫–æ–º–ø–æ–Ω–µ–Ω—Ç –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è —Ñ–∏–Ω–∞–Ω—Å–æ–≤–æ–π —Å–≤–æ–¥–∫–∏ —Ä–µ–∑–µ—Ä–≤–∞.
 * –ó–∞–º–µ–Ω—è–µ—Ç ReservationSummary, AdminReservationSummary –∏ ReservationFinancialSummary.
 */
export default function FinancialSummaryBlock({
    priceDetails,
    accessoriesDailyTotal = 0,
    promoCode,
    setPromoCode,
    applyPromoCode,
    removePromoCode,
    promoCodeMessage = "",
    isLoading = false,
    isApplyingPromoCode = false,
    isSubmitting = false,
    isFormValid = true,
    hasConflicts = false,
    onCancel,
    onAddMore,
    onSubmit,
    variant = 'default',
    className,
    showActions = true
}: FinancialSummaryBlockProps) {
    
    // –ò–∑–≤–ª–µ–∫–∞–µ–º –¥–∞–Ω–Ω—ã–µ –∏–∑ priceDetails
    const dayCount = priceDetails?.day_count ?? 0;
    const fullTotal = priceDetails?.full_total ?? 0;
    const finalTotal = priceDetails?.final_total ?? 0;
    const discountAmount = priceDetails?.discount_amount ?? 0;
    const durationDiscountPercentage = priceDetails?.duration_discount_percentage ?? 0;
    const promoDiscountPercentage = priceDetails?.promo_discount_percentage ?? 0;
    const totalDiscountPercentage = durationDiscountPercentage + promoDiscountPercentage;
    const apiPromoCodeMessage = priceDetails?.promo_code_message ?? "";
    
    // –ò—Å–ø–æ–ª—å–∑—É–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –∏–∑ API –∏–ª–∏ –ø–µ—Ä–µ–¥–∞–Ω–Ω–æ–µ
    const displayPromoCodeMessage = apiPromoCodeMessage || promoCodeMessage;
    
    // –ö–æ–º–ø–∞–∫—Ç–Ω—ã–π –≤–∞—Ä–∏–∞–Ω—Ç –¥–ª—è –∫–∞—Ä—Ç–æ—á–µ–∫
    if (variant === 'compact') {
        return (
            <div className={cn("flex flex-wrap items-center justify-start gap-x-4 gap-y-1 text-sm", className)}>
                {promoCode && (
                    <div className="flex items-center gap-1.5 text-xs text-purple-600 self-end">
                        <span className="px-1.5 py-0.5 bg-purple-100 rounded text-xs">
                            {promoCode}
                        </span>
                    </div>
                )}
                <div className="text-right">
                    <div className="flex items-center gap-1.5 font-semibold">
                        <ReceiptText className="w-4 h-4 text-gray-500" />
                        –ò—Ç–æ–≥:
                        <span className="text-gray-800">
                            {finalTotal.toLocaleString('ru-RU')} ‚ÇΩ
                        </span>
                    </div>
                    {discountAmount > 0 && (
                        <div className="text-xs text-green-600 mt-0.5">
                            —Å–æ —Å–∫–∏–¥–∫–æ–π –≤ {discountAmount.toLocaleString('ru-RU')} ‚ÇΩ
                        </div>
                    )}
                </div>
            </div>
        );
    }
    
    // –ê–¥–º–∏–Ω—Å–∫–∏–π –≤–∞—Ä–∏–∞–Ω—Ç
    if (variant === 'admin') {
        return (
            <div className={cn("flex-1 space-y-2 text-sm", className)}>
                <div className="grid grid-cols-2 gap-x-4 gap-y-1">
                    <span className="text-gray-600">–î–Ω–µ–π –∞—Ä–µ–Ω–¥—ã:</span>
                    <span className="font-medium text-right">{dayCount}</span>

                    <span className="text-gray-600">–°—É–º–º–∞ –±–µ–∑ —Å–∫–∏–¥–∫–∏:</span>
                    <span className="font-medium text-right">{fullTotal.toLocaleString('ru-RU')} ‚ÇΩ</span>

                    {totalDiscountPercentage > 0 && (
                        <>
                            <span className="text-green-600">–°–∫–∏–¥–∫–∞ ({totalDiscountPercentage}%):</span>
                            <span className="font-medium text-green-600 text-right">- {discountAmount.toLocaleString('ru-RU')} ‚ÇΩ</span>
                        </>
                    )}

                    <span className="font-semibold text-base mt-1">–ò—Ç–æ–≥–æ:</span>
                    <span className="font-bold text-base text-right mt-1">{finalTotal.toLocaleString('ru-RU')} ‚ÇΩ</span>
                </div>

                <div className="pt-2">
                    <PromoCodeInput
                        promoCode={promoCode}
                        setPromoCode={setPromoCode}
                        applyPromoCode={applyPromoCode}
                        promoCodeMessage={displayPromoCodeMessage}
                        disabled={isSubmitting || isLoading}
                        isLoading={isApplyingPromoCode}
                    />
                </div>

                {isLoading && (
                    <div className="flex items-center gap-2 text-xs text-gray-500 pt-1">
                        <Loader2 className="h-3 w-3 animate-spin" />
                        <span>–ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏...</span>
                    </div>
                )}
                {hasConflicts && (
                    <div className="flex items-center gap-2 text-xs text-red-600 font-medium pt-1">
                        <AlertTriangle className="h-4 w-4" />
                        <span>–û–±–Ω–∞—Ä—É–∂–µ–Ω—ã –∫–æ–Ω—Ñ–ª–∏–∫—Ç—ã –≤ –≤—ã–±–æ—Ä–µ!</span>
                    </div>
                )}
            </div>
        );
    }
    
    // Inline –≤–∞—Ä–∏–∞–Ω—Ç –¥–ª—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
    if (variant === 'inline') {
        return (
            <div className={cn("space-y-3", className)}>
                <div className="flex items-center gap-2 text-sm font-medium text-gray-700">
                    <ReceiptText className="w-4 h-4" />
                    –§–∏–Ω–∞–Ω—Å–æ–≤–∞—è —Å–≤–æ–¥–∫–∞
                </div>
                
                {isLoading ? (
                    <div className="text-center py-4 text-gray-500 flex items-center justify-center gap-2">
                        <Loader2 className="h-4 w-4 animate-spin" />
                        –†–∞—Å—á–µ—Ç —Å—Ç–æ–∏–º–æ—Å—Ç–∏...
                    </div>
                ) : (
                    <div className="text-sm text-gray-700 space-y-2">
                        <div className="flex justify-between">
                            <span>–ê—Ä–µ–Ω–¥–∞ –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—è ({dayCount} –¥–Ω.):</span>
                            <span>{fullTotal.toLocaleString('ru-RU')} ‚ÇΩ</span>
                        </div>
                        
                        {accessoriesDailyTotal > 0 && (
                            <div className="flex justify-between text-gray-600 pl-4">
                                <span>- –≤ —Ç.—á. –∞–∫—Å–µ—Å—Å—É–∞—Ä—ã ({accessoriesDailyTotal.toLocaleString('ru-RU')} ‚ÇΩ/–¥–µ–Ω—å):</span>
                                <span>{(accessoriesDailyTotal * dayCount).toLocaleString('ru-RU')} ‚ÇΩ</span>
                            </div>
                        )}
                        
                        <div className="flex justify-between pt-2 border-t border-dashed">
                            <span>–°—É–º–º–∞ –±–µ–∑ —Å–∫–∏–¥–∫–∏:</span>
                            <strong>{fullTotal.toLocaleString('ru-RU')} ‚ÇΩ</strong>
                        </div>
                        
                        {totalDiscountPercentage > 0 && (
                            <div className="flex justify-between text-green-600">
                                <span>–°–∫–∏–¥–∫–∞ ({totalDiscountPercentage}%):</span>
                                <strong>- {discountAmount.toLocaleString('ru-RU', { minimumFractionDigits: 2, maximumFractionDigits: 2 })} ‚ÇΩ</strong>
                            </div>
                        )}
                        
                        <div className="flex justify-between text-base font-bold pt-2 border-t mt-2">
                            <span>–ö –æ–ø–ª–∞—Ç–µ:</span>
                            <span className="text-sky-700 ml-2">{finalTotal.toLocaleString('ru-RU', { minimumFractionDigits: 2, maximumFractionDigits: 2 })} ‚ÇΩ</span>
                        </div>
                    </div>
                )}
                
                <div className="pt-2">
                    <PromoCodeInput
                        promoCode={promoCode}
                        setPromoCode={setPromoCode}
                        applyPromoCode={applyPromoCode}
                        removePromoCode={removePromoCode}
                        promoCodeMessage={displayPromoCodeMessage}
                        disabled={isSubmitting || isLoading}
                        isLoading={isApplyingPromoCode}
                    />
                </div>
            </div>
        );
    }
    
    // –°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π –≤–∞—Ä–∏–∞–Ω—Ç (–∫–∞–∫ ReservationSummary)
    return (
        <div className={cn("mt-6 p-4 border rounded-lg bg-white shadow-sm space-y-4", className)}>
            <div className="flex items-center gap-2 text-lg font-semibold text-gray-800">
                <ReceiptText className="w-6 h-6 text-sky-600" />
                –ò—Ç–æ–≥–æ–≤—ã–π —Ä–∞—Å—á–µ—Ç
            </div>

            <div className="border-t pt-4">
                <PromoCodeInput
                    promoCode={promoCode}
                    setPromoCode={setPromoCode}
                    applyPromoCode={applyPromoCode}
                    removePromoCode={removePromoCode}
                    promoCodeMessage={displayPromoCodeMessage}
                    disabled={isSubmitting || isLoading}
                    isLoading={isApplyingPromoCode}
                />
            </div>

            {isLoading ? (
                <div className="text-center py-4 text-gray-500 flex items-center justify-center gap-2">
                    <Loader2 className="h-4 w-4 animate-spin" />
                    –†–∞—Å—á–µ—Ç —Å—Ç–æ–∏–º–æ—Å—Ç–∏...
                </div>
            ) : (
                <div className="text-sm text-gray-700 space-y-2 border-t pt-4">
                    <div className="flex justify-between">
                        <span>–ê—Ä–µ–Ω–¥–∞ –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—è ({dayCount} –¥–Ω.):</span>
                    </div>
                    {accessoriesDailyTotal > 0 && (
                        <div className="flex justify-between text-gray-600 pl-4">
                            <span>- –≤ —Ç.—á. –∞–∫—Å–µ—Å—Å—É–∞—Ä—ã ({accessoriesDailyTotal.toLocaleString('ru-RU')} ‚ÇΩ/–¥–µ–Ω—å):</span>
                            <span>{(accessoriesDailyTotal * dayCount).toLocaleString('ru-RU')} ‚ÇΩ</span>
                        </div>
                    )}
                    <div className="flex justify-between pt-2 border-t border-dashed">
                        <span>–°—É–º–º–∞ –±–µ–∑ —Å–∫–∏–¥–∫–∏:</span>
                        <strong>{fullTotal.toLocaleString('ru-RU')} ‚ÇΩ</strong>
                    </div>
                    {totalDiscountPercentage > 0 && (
                        <div className="flex justify-between text-green-600">
                            <span>–°–∫–∏–¥–∫–∞ ({totalDiscountPercentage}%):</span>
                            <strong>- {discountAmount.toLocaleString('ru-RU', { minimumFractionDigits: 2, maximumFractionDigits: 2 })} ‚ÇΩ</strong>
                        </div>
                    )}
                    <div className="flex justify-between text-base font-bold pt-2 border-t mt-2">
                        <span>–ö –æ–ø–ª–∞—Ç–µ:</span>
                        <span className="text-sky-700 ml-2">{finalTotal.toLocaleString('ru-RU', { minimumFractionDigits: 2, maximumFractionDigits: 2 })} ‚ÇΩ</span>
                    </div>
                </div>
            )}

            {showActions && (onCancel || onAddMore || onSubmit) && (
                <div className="flex flex-col sm:flex-row justify-end items-center pt-3 gap-3">
                    {onCancel && (
                        <Button variant="ghost" className="text-red-600 hover:bg-red-50 w-full sm:w-auto" onClick={onCancel}>
                            –û—Ç–º–µ–Ω–∏—Ç—å –æ—Ñ–æ—Ä–º–ª–µ–Ω–∏–µ
                        </Button>
                    )}
                    {onAddMore && (
                        <Button variant="outline" className="w-full sm:w-auto" onClick={onAddMore}>
                            –î–æ–±–∞–≤–∏—Ç—å –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏–µ
                        </Button>
                    )}
                    {onSubmit && (
                        <Button
                            disabled={!isFormValid || isSubmitting || isLoading || isApplyingPromoCode}
                            className="px-6 py-2 w-full sm:w-auto"
                            onClick={onSubmit}
                        >
                            {isSubmitting ? "–û–±—Ä–∞–±–æ—Ç–∫–∞..." : "–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å —Ä–µ–∑–µ—Ä–≤"}
                        </Button>
                    )}
                </div>
            )}
        </div>
    );
}


```


## <a name="rentalappmainsrccomponentssharedOrderToolbartsx"></a>`rental-app-main/src/components/shared/OrderToolbar.tsx`

```tsx
// path: rental-app-main/src/components/shared/OrderToolbar.tsx

import { Input } from "@/components/ui/input"
import { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from "@/components/ui/select"
import { Checkbox } from "@/components/ui/checkbox"
import { Label } from "@/components/ui/label"
import { useOrderFilterStore, type SortOption, type OrderContext } from "@/store/orderFilterStore"

interface OrderToolbarProps {
    context: OrderContext
    showHideCompletedCheckbox?: boolean
}

export default function OrderToolbar({ context, showHideCompletedCheckbox }: OrderToolbarProps) {
    const { searchQuery, statusFilter, sortOption, setSearchQuery, setStatusFilter, setSortOption } = useOrderFilterStore()

    // –û–ø—Ä–µ–¥–µ–ª—è–µ–º placeholder –¥–ª—è –ø–æ–∏—Å–∫–∞ –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞
    const getSearchPlaceholder = () => {
        switch (context) {
            case "user-reservations":
            case "user-rentals":
                return "–ü–æ–∏—Å–∫ –ø–æ –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—é..."
            case "admin-reservations":
            case "admin-rentals":
                return "–ü–æ–∏—Å–∫ –ø–æ –∫–ª–∏–µ–Ω—Ç—É..."
            default:
                return "–ü–æ–∏—Å–∫..."
        }
    }

    // –û–ø—Ä–µ–¥–µ–ª—è–µ–º –æ–ø—Ü–∏–∏ —Å—Ç–∞—Ç—É—Å–∞ –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞
    const getStatusOptions = () => {
        switch (context) {
            case "user-reservations":
                return [
                    { value: "active", label: "–ê–∫—Ç–∏–≤–Ω—ã–µ" },
                    { value: "completed", label: "–ó–∞–≤–µ—Ä—à–µ–Ω–Ω—ã–µ" },
                    { value: "all", label: "–í—Å–µ" }
                ]
            case "user-rentals":
                return [
                    { value: "active", label: "–ê–∫—Ç–∏–≤–Ω—ã–µ" },
                    { value: "overdue", label: "–ü—Ä–æ—Å—Ä–æ—á–µ–Ω–Ω—ã–µ" },
                    { value: "completed", label: "–ó–∞–≤–µ—Ä—à–µ–Ω–Ω—ã–µ" },
                    { value: "all", label: "–í—Å–µ" }
                ]
            case "admin-reservations":
                return [
                    { value: "active", label: "–ê–∫—Ç–∏–≤–Ω—ã–µ" },
                    { value: "completed", label: "–ó–∞–≤–µ—Ä—à–µ–Ω–Ω—ã–µ" },
                    { value: "all", label: "–í—Å–µ" }
                ]
            case "admin-rentals":
                return [
                    { value: "active", label: "–ê–∫—Ç–∏–≤–Ω—ã–µ" },
                    { value: "overdue", label: "–ü—Ä–æ—Å—Ä–æ—á–µ–Ω–Ω—ã–µ" },
                    { value: "completed", label: "–ó–∞–≤–µ—Ä—à–µ–Ω–Ω—ã–µ" },
                    { value: "all", label: "–í—Å–µ" }
                ]
            default:
                return []
        }
    }

    const statusOptions = getStatusOptions()

    // –õ–æ–≥–∏–∫–∞ –¥–ª—è —á–µ–∫–±–æ–∫—Å–∞ "–°–∫—Ä—ã—Ç—å –∑–∞–≤–µ—Ä—à–µ–Ω–Ω—ã–µ"
    const isHideCompletedChecked = statusFilter !== 'all'
    const handleHideCompletedChange = (checked: boolean | 'indeterminate') => {
        // –ï—Å–ª–∏ indeterminate, —Å—á–∏—Ç–∞–µ–º –∫–∞–∫ false
        setStatusFilter(checked === true ? 'active' : 'all')
    }

    return (
        <div className="mb-4 flex flex-wrap items-center gap-4">
            <Input
                type="text"
                placeholder={getSearchPlaceholder()}
                value={searchQuery}
                onChange={(e) => setSearchQuery(e.target.value)}
                className="max-w-xs"
            />
            
            {showHideCompletedCheckbox ? (
                <div className="flex items-center space-x-2">
                    <Checkbox
                        id="hide-completed-orders"
                        checked={isHideCompletedChecked}
                        onCheckedChange={handleHideCompletedChange}
                    />
                    <Label htmlFor="hide-completed-orders">–°–∫—Ä—ã—Ç—å –∑–∞–≤–µ—Ä—à–µ–Ω–Ω—ã–µ</Label>
                </div>
            ) : (
                <Select value={statusFilter || "active"} onValueChange={setStatusFilter}>
                    <SelectTrigger className="w-52">
                        <SelectValue placeholder="–§–∏–ª—å—Ç—Ä –ø–æ —Å—Ç–∞—Ç—É—Å—É" />
                    </SelectTrigger>
                    <SelectContent>
                        {statusOptions.map((option) => (
                            <SelectItem key={option.value} value={option.value}>
                                {option.label}
                            </SelectItem>
                        ))}
                    </SelectContent>
                </Select>
            )}

            <Select value={sortOption} onValueChange={(val) => setSortOption(val as SortOption)}>
                <SelectTrigger className="w-52">
                    <SelectValue placeholder="–°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞" />
                </SelectTrigger>
                <SelectContent>
                    <SelectItem value="id_desc">–ù–æ–º–µ—Ä ‚Üì</SelectItem>
                    <SelectItem value="id_asc">–ù–æ–º–µ—Ä ‚Üë</SelectItem>
                    <SelectItem value="start_desc">–ù–∞—á–∞–ª–æ ‚Üì</SelectItem>
                    <SelectItem value="start_asc">–ù–∞—á–∞–ª–æ ‚Üë</SelectItem>
                    <SelectItem value="end_desc">–û–∫–æ–Ω—á–∞–Ω–∏–µ ‚Üì</SelectItem>
                    <SelectItem value="end_asc">–û–∫–æ–Ω—á–∞–Ω–∏–µ ‚Üë</SelectItem>
                    <SelectItem value="count_desc">–ü–æ–∑–∏—Ü–∏–π ‚Üì</SelectItem>
                    <SelectItem value="count_asc">–ü–æ–∑–∏—Ü–∏–π ‚Üë</SelectItem>
                </SelectContent>
            </Select>
        </div>
    )
}


```


## <a name="rentalappmainsrccomponentsuiAdminButtontsx"></a>`rental-app-main/src/components/ui/AdminButton.tsx`

```tsx
// path: rental-app-main/src/components/ui/AdminButton.tsx

// src/components/AdminButton.tsx


import { useCurrentUser } from "@/hooks/useProfile";
import { Button } from "@/components/ui/button";
import { Shield } from "lucide-react";
import { useNavigate } from "react-router-dom";

export default function AdminButton() {
    const { data: user, isLoading } = useCurrentUser();
    const navigate = useNavigate();

    const isAdmin = user?.role === "admin";
    const isManager = user?.role === "manager" || isAdmin;

    if (isLoading || !isManager) return null;

    return (
        <Button
            onClick={() => navigate("/admin")}
            variant="default"
            className="bg-gray-800 hover:bg-gray-700"
        >
            <Shield className="w-4 h-4 mr-2" />
            {isAdmin ? "–ê–¥–º–∏–Ω –ø–∞–Ω–µ–ª—å" : "–ü–∞–Ω–µ–ª—å –º–µ–Ω–µ–¥–∂–µ—Ä–∞"}
        </Button>
    );
}


```


## <a name="rentalappmainsrccomponentsuiCreatableSelecttsx"></a>`rental-app-main/src/components/ui/CreatableSelect.tsx`

```tsx
// path: rental-app-main/src/components/ui/CreatableSelect.tsx

// src/components/ui/CreatableSelect.tsx

import { useState, useMemo, useEffect } from "react";
import {
    Dialog, DialogContent, DialogHeader, DialogTitle, DialogFooter, DialogDescription
} from "@/components/ui/dialog";
import {
    Select, SelectContent, SelectItem, SelectTrigger, SelectValue
} from "@/components/ui/select";
import { Button } from "@/components/ui/button";
import { Input } from "@/components/ui/input";
import { Label } from "@/components/ui/label";

// --- –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–π –∫–æ–º–ø–æ–Ω–µ–Ω—Ç: –î–∏–∞–ª–æ–≥ –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –Ω–æ–≤–æ–≥–æ —ç–ª–µ–º–µ–Ω—Ç–∞ ---
const AddNewItemDialog = ({ open, onClose, onSave, title, description, label }: {
    open: boolean;
    onClose: () => void;
    onSave: (newItem: string) => void;
    title: string;
    description: string;
    label: string;
}) => {
    const [newItem, setNewItem] = useState("");

    const handleSave = () => {
        if (newItem.trim()) {
            onSave(newItem.trim());
        }
    };

    // –°–±—Ä–∞—Å—ã–≤–∞–µ–º –ø–æ–ª–µ –≤–≤–æ–¥–∞, –∫–æ–≥–¥–∞ –¥–∏–∞–ª–æ–≥ –æ—Ç–∫—Ä—ã–≤–∞–µ—Ç—Å—è
    useEffect(() => {
        if (open) {
            setNewItem("");
        }
    }, [open]);

    return (
        <Dialog open={open} onOpenChange={onClose}>
            <DialogContent className="sm:max-w-[425px]">
                <DialogHeader>
                    <DialogTitle>{title}</DialogTitle>
                    <DialogDescription>{description}</DialogDescription>
                </DialogHeader>
                <div className="grid gap-4 py-4">
                    <div className="grid grid-cols-4 items-center gap-4">
                        <Label htmlFor="new-item-name" className="text-right">{label}</Label>
                        <Input
                            id="new-item-name"
                            value={newItem}
                            onChange={(e) => setNewItem(e.target.value)}
                            className="col-span-3"
                            autoFocus
                            onKeyDown={(e) => { if (e.key === 'Enter') handleSave(); }}
                        />
                    </div>
                </div>
                <DialogFooter>
                    <Button type="button" variant="ghost" onClick={onClose}>–û—Ç–º–µ–Ω–∞</Button>
                    <Button type="button" onClick={handleSave} disabled={!newItem.trim()}>–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</Button>
                </DialogFooter>
            </DialogContent>
        </Dialog>
    );
};

// --- –û—Å–Ω–æ–≤–Ω–æ–π –∫–æ–º–ø–æ–Ω–µ–Ω—Ç CreatableSelect ---
interface CreatableSelectProps {
    value?: string;
    onChange: (value: string) => void;
    options: string[];
    placeholder?: string;
    dialogTitle: string;
    dialogDescription: string;
    dialogLabel: string;
    className?: string;
}

export function CreatableSelect({
                                    value,
                                    onChange,
                                    options,
                                    placeholder = "–í—ã–±–µ—Ä–∏—Ç–µ –∑–Ω–∞—á–µ–Ω–∏–µ...",
                                    dialogTitle,
                                    dialogDescription,
                                    dialogLabel,
                                    className
                                }: CreatableSelectProps) {
    const [isAddingNew, setIsAddingNew] = useState(false);
    const [customOptions, setCustomOptions] = useState<string[]>([]);

    const allOptions = useMemo(() => {
        const combined = new Set([...options, ...customOptions]);
        return Array.from(combined).sort((a, b) => a.localeCompare(b));
    }, [options, customOptions]);

    const handleSelect = (selectedValue: string) => {
        if (selectedValue === "add_new") {
            setIsAddingNew(true);
        } else {
            onChange(selectedValue);
        }
    };

    const handleSaveNew = (newItem: string) => {
        if (!allOptions.includes(newItem)) {
            setCustomOptions(prev => [...prev, newItem]);
        }
        onChange(newItem);
        setIsAddingNew(false);
    };

    return (
        <>
            <Select onValueChange={handleSelect} value={value || ""}>
                <SelectTrigger className={className}>
                    <SelectValue placeholder={placeholder} />
                </SelectTrigger>
                <SelectContent>
                    {allOptions.map((opt) => (
                        <SelectItem key={opt} value={opt}>
                            {opt}
                        </SelectItem>
                    ))}
                    <SelectItem value="add_new" className="text-sky-600 font-semibold">
                        + –î–æ–±–∞–≤–∏—Ç—å –Ω–æ–≤—ã–π...
                    </SelectItem>
                </SelectContent>
            </Select>

            <AddNewItemDialog
                open={isAddingNew}
                onClose={() => setIsAddingNew(false)}
                onSave={handleSaveNew}
                title={dialogTitle}
                description={dialogDescription}
                label={dialogLabel}
            />
        </>
    );
}

```


## <a name="rentalappmainsrccomponentsuialerttsx"></a>`rental-app-main/src/components/ui/alert.tsx`

```tsx
// path: rental-app-main/src/components/ui/alert.tsx

import * as React from "react"
import { cva, type VariantProps } from "class-variance-authority"

import { cn } from "@/lib/utils"

const alertVariants = cva(
  "relative w-full rounded-lg border p-4 [&>svg~*]:pl-7 [&>svg+div]:translate-y-[-3px] [&>svg]:absolute [&>svg]:left-4 [&>svg]:top-4 [&>svg]:text-foreground",
  {
    variants: {
      variant: {
        default: "bg-background text-foreground",
        destructive:
          "border-destructive/50 text-destructive dark:border-destructive [&>svg]:text-destructive",
      },
    },
    defaultVariants: {
      variant: "default",
    },
  }
)

const Alert = React.forwardRef<
  HTMLDivElement,
  React.HTMLAttributes<HTMLDivElement> & VariantProps<typeof alertVariants>
>(({ className, variant, ...props }, ref) => (
  <div
    ref={ref}
    role="alert"
    className={cn(alertVariants({ variant }), className)}
    {...props}
  />
))
Alert.displayName = "Alert"

const AlertTitle = React.forwardRef<
  HTMLParagraphElement,
  React.HTMLAttributes<HTMLHeadingElement>
>(({ className, ...props }, ref) => (
  <h5
    ref={ref}
    className={cn("mb-1 font-medium leading-none tracking-tight", className)}
    {...props}
  />
))
AlertTitle.displayName = "AlertTitle"

const AlertDescription = React.forwardRef<
  HTMLParagraphElement,
  React.HTMLAttributes<HTMLParagraphElement>
>(({ className, ...props }, ref) => (
  <div
    ref={ref}
    className={cn("text-sm [&_p]:leading-relaxed", className)}
    {...props}
  />
))
AlertDescription.displayName = "AlertDescription"

export { Alert, AlertTitle, AlertDescription }


```


## <a name="rentalappmainsrccomponentsuibadgetsx"></a>`rental-app-main/src/components/ui/badge.tsx`

```tsx
// path: rental-app-main/src/components/ui/badge.tsx

import * as React from "react"
import { cva, type VariantProps } from "class-variance-authority"

import { cn } from "@/lib/utils"

const badgeVariants = cva(
  "inline-flex items-center rounded-md border px-2.5 py-0.5 text-xs font-semibold transition-colors focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2",
  {
    variants: {
      variant: {
        default:
          "border-transparent bg-primary text-primary-foreground shadow hover:bg-primary/80",
        secondary:
          "border-transparent bg-secondary text-secondary-foreground hover:bg-secondary/80",
        destructive:
          "border-transparent bg-destructive text-destructive-foreground shadow hover:bg-destructive/80",
        outline: "text-foreground",
      },
    },
    defaultVariants: {
      variant: "default",
    },
  }
)

export interface BadgeProps
  extends React.HTMLAttributes<HTMLDivElement>,
    VariantProps<typeof badgeVariants> {}

function Badge({ className, variant, ...props }: BadgeProps) {
  return (
    <div className={cn(badgeVariants({ variant }), className)} {...props} />
  )
}

export { Badge, badgeVariants }


```


## <a name="rentalappmainsrccomponentsuibuttontsx"></a>`rental-app-main/src/components/ui/button.tsx`

```tsx
// path: rental-app-main/src/components/ui/button.tsx

// src/components/ui/button.tsx

import * as React from "react";
import { Slot } from "@radix-ui/react-slot";
import { cva, type VariantProps } from "class-variance-authority";
import { cn } from "@/lib/utils";

const buttonVariants = cva(
    "inline-flex items-center justify-center gap-2 whitespace-nowrap rounded-md text-sm font-medium transition-colors focus-visible:outline-none focus-visible:ring-1 focus-visible:ring-ring disabled:pointer-events-none disabled:opacity-50 [&_svg]:pointer-events-none [&_svg]:size-4 [&_svg]:shrink-0",
    {
        variants: {
            variant: {
                default: "bg-primary text-primary-foreground shadow hover:bg-primary/90",
                destructive: "bg-destructive text-destructive-foreground shadow-sm hover:bg-destructive/90",
                outline: "border border-input bg-background shadow-sm hover:bg-accent hover:text-accent-foreground",
                secondary: "bg-secondary text-secondary-foreground shadow-sm hover:bg-secondary/80",
                ghost: "hover:bg-accent hover:text-accent-foreground",
                link: "text-primary underline-offset-4 hover:underline",
                filter: "h-8 px-3 rounded-full border border-gray-300 text-gray-700 data-[state=on]:bg-sky-600 data-[state=on]:text-white hover:bg-sky-100 hover:text-gray-900 transition-colors",

                // –û–±–Ω–æ–≤–ª–µ–Ω–Ω—ã–µ –≤–∞—Ä–∏–∞–Ω—Ç—ã –¥–ª—è —Å–æ—Å—Ç–æ—è–Ω–∏–π –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—è –≤ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–∏ —Å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ–º
                conditionExcellent: // –í–µ–ª–∏–∫–æ–ª–µ–ø–Ω–æ (—Å–≤–µ—Ç–ª–æ-–∑–µ–ª–µ–Ω—ã–π —Ñ–æ–Ω, —Ç–µ–º–Ω—ã–π —Ç–µ–∫—Å—Ç)
                    "bg-green-200 text-green-800 shadow-sm hover:bg-green-300 focus-visible:ring-green-400",
                conditionGreat: // –û—Ç–ª–∏—á–Ω–æ (—Å–≤–µ—Ç–ª–æ-–≥–æ–ª—É–±–æ–π —Ñ–æ–Ω, —Ç–µ–º–Ω—ã–π —Ç–µ–∫—Å—Ç)
                    "bg-sky-200 text-sky-800 shadow-sm hover:bg-sky-300 focus-visible:ring-sky-400",
                conditionGood: // –•–æ—Ä–æ—à–æ (—Å–≤–µ—Ç–ª–æ-–∂–µ–ª—Ç—ã–π —Ñ–æ–Ω, —Ç–µ–º–Ω—ã–π —Ç–µ–∫—Å—Ç)
                    "bg-yellow-200 text-yellow-800 shadow-sm hover:bg-yellow-300 focus-visible:ring-yellow-400",
                conditionSatisfactory: // –£–¥–æ–≤–ª–µ—Ç–≤–æ—Ä–∏—Ç–µ–ª—å–Ω–æ (—Å–≤–µ—Ç–ª–æ-–æ—Ä–∞–Ω–∂–µ–≤—ã–π/–ø–µ—Ä—Å–∏–∫–æ–≤—ã–π —Ñ–æ–Ω, —Ç–µ–º–Ω—ã–π —Ç–µ–∫—Å—Ç)
                    "bg-orange-200 text-orange-800 shadow-sm hover:bg-orange-300 focus-visible:ring-orange-400",
                conditionBad: // –ü–ª–æ—Ö–æ / –¢—Ä–µ–±—É–µ—Ç —Ä–µ–º–æ–Ω—Ç–∞ (—Å–≤–µ—Ç–ª–æ-–∫—Ä–∞—Å–Ω—ã–π/—Ä–æ–∑–æ–≤—ã–π —Ñ–æ–Ω, —Ç–µ–º–Ω—ã–π —Ç–µ–∫—Å—Ç)
                    "bg-red-200 text-red-800 shadow-sm hover:bg-red-300 focus-visible:ring-red-400",
            },
            size: {
                default: "h-9 px-4 py-2",
                sm: "h-8 rounded-md px-3 text-xs",
                lg: "h-10 rounded-md px-8",
                icon: "h-9 w-9",
            },
        },
        defaultVariants: {
            variant: "default",
            size: "default",
        },
    }
);

export interface ButtonProps
    extends React.ButtonHTMLAttributes<HTMLButtonElement>,
        VariantProps<typeof buttonVariants> {
    asChild?: boolean;
}

const Button = React.forwardRef<HTMLButtonElement, ButtonProps>(
    ({ className, variant, size, asChild = false, ...props }, ref) => {
        const Comp = asChild ? Slot : "button";
        return (
            <Comp
                className={cn(buttonVariants({ variant, size, className }))}
                ref={ref}
                {...props}
            />
        );
    }
);
Button.displayName = "Button";

export { Button, buttonVariants };

```


## <a name="rentalappmainsrccomponentsuicardtsx"></a>`rental-app-main/src/components/ui/card.tsx`

```tsx
// path: rental-app-main/src/components/ui/card.tsx

import * as React from "react"

import { cn } from "@/lib/utils"

const Card = React.forwardRef<
  HTMLDivElement,
  React.HTMLAttributes<HTMLDivElement>
>(({ className, ...props }, ref) => (
  <div
    ref={ref}
    className={cn(
      "rounded-xl border bg-card text-card-foreground shadow",
      className
    )}
    {...props}
  />
))
Card.displayName = "Card"

const CardHeader = React.forwardRef<
  HTMLDivElement,
  React.HTMLAttributes<HTMLDivElement>
>(({ className, ...props }, ref) => (
  <div
    ref={ref}
    className={cn("flex flex-col space-y-1.5 p-6", className)}
    {...props}
  />
))
CardHeader.displayName = "CardHeader"

const CardTitle = React.forwardRef<
  HTMLDivElement,
  React.HTMLAttributes<HTMLDivElement>
>(({ className, ...props }, ref) => (
  <div
    ref={ref}
    className={cn("font-semibold leading-none tracking-tight", className)}
    {...props}
  />
))
CardTitle.displayName = "CardTitle"

const CardDescription = React.forwardRef<
  HTMLDivElement,
  React.HTMLAttributes<HTMLDivElement>
>(({ className, ...props }, ref) => (
  <div
    ref={ref}
    className={cn("text-sm text-muted-foreground", className)}
    {...props}
  />
))
CardDescription.displayName = "CardDescription"

const CardContent = React.forwardRef<
  HTMLDivElement,
  React.HTMLAttributes<HTMLDivElement>
>(({ className, ...props }, ref) => (
  <div ref={ref} className={cn("p-6 pt-0", className)} {...props} />
))
CardContent.displayName = "CardContent"

const CardFooter = React.forwardRef<
  HTMLDivElement,
  React.HTMLAttributes<HTMLDivElement>
>(({ className, ...props }, ref) => (
  <div
    ref={ref}
    className={cn("flex items-center p-6 pt-0", className)}
    {...props}
  />
))
CardFooter.displayName = "CardFooter"

export { Card, CardHeader, CardFooter, CardTitle, CardDescription, CardContent }


```


## <a name="rentalappmainsrccomponentsuicheckboxtsx"></a>`rental-app-main/src/components/ui/checkbox.tsx`

```tsx
// path: rental-app-main/src/components/ui/checkbox.tsx

import * as React from "react"
import * as CheckboxPrimitive from "@radix-ui/react-checkbox"
import { Check } from "lucide-react"

import { cn } from "@/lib/utils"

const Checkbox = React.forwardRef<
  React.ElementRef<typeof CheckboxPrimitive.Root>,
  React.ComponentPropsWithoutRef<typeof CheckboxPrimitive.Root>
>(({ className, ...props }, ref) => (
  <CheckboxPrimitive.Root
    ref={ref}
    className={cn(
      "peer h-4 w-4 shrink-0 rounded-sm border border-primary shadow focus-visible:outline-none focus-visible:ring-1 focus-visible:ring-ring disabled:cursor-not-allowed disabled:opacity-50 data-[state=checked]:bg-primary data-[state=checked]:text-primary-foreground",
      className
    )}
    {...props}
  >
    <CheckboxPrimitive.Indicator
      className={cn("flex items-center justify-center text-current")}
    >
      <Check className="h-4 w-4" />
    </CheckboxPrimitive.Indicator>
  </CheckboxPrimitive.Root>
))
Checkbox.displayName = CheckboxPrimitive.Root.displayName

export { Checkbox }


```


## <a name="rentalappmainsrccomponentsuicommandtsx"></a>`rental-app-main/src/components/ui/command.tsx`

```tsx
// path: rental-app-main/src/components/ui/command.tsx

import * as React from "react"
import { type DialogProps } from "@radix-ui/react-dialog"
import { Command as CommandPrimitive } from "cmdk"
import { Search } from "lucide-react"

import { cn } from "@/lib/utils"
import { Dialog, DialogContent } from "@/components/ui/dialog"

const Command = React.forwardRef<
  React.ElementRef<typeof CommandPrimitive>,
  React.ComponentPropsWithoutRef<typeof CommandPrimitive>
>(({ className, ...props }, ref) => (
  <CommandPrimitive
    ref={ref}
    className={cn(
      "flex h-full w-full flex-col overflow-hidden rounded-md bg-popover text-popover-foreground",
      className
    )}
    {...props}
  />
))
Command.displayName = CommandPrimitive.displayName

const CommandDialog = ({ children, ...props }: DialogProps) => {
  return (
    <Dialog {...props}>
      <DialogContent className="overflow-hidden p-0">
        <Command className="[&_[cmdk-group-heading]]:px-2 [&_[cmdk-group-heading]]:font-medium [&_[cmdk-group-heading]]:text-muted-foreground [&_[cmdk-group]:not([hidden])_~[cmdk-group]]:pt-0 [&_[cmdk-group]]:px-2 [&_[cmdk-input-wrapper]_svg]:h-5 [&_[cmdk-input-wrapper]_svg]:w-5 [&_[cmdk-input]]:h-12 [&_[cmdk-item]]:px-2 [&_[cmdk-item]]:py-3 [&_[cmdk-item]_svg]:h-5 [&_[cmdk-item]_svg]:w-5">
          {children}
        </Command>
      </DialogContent>
    </Dialog>
  )
}

const CommandInput = React.forwardRef<
  React.ElementRef<typeof CommandPrimitive.Input>,
  React.ComponentPropsWithoutRef<typeof CommandPrimitive.Input>
>(({ className, ...props }, ref) => (
  <div className="flex items-center border-b px-3" cmdk-input-wrapper="">
    <Search className="mr-2 h-4 w-4 shrink-0 opacity-50" />
    <CommandPrimitive.Input
      ref={ref}
      className={cn(
        "flex h-10 w-full rounded-md bg-transparent py-3 text-sm outline-none placeholder:text-muted-foreground disabled:cursor-not-allowed disabled:opacity-50",
        className
      )}
      {...props}
    />
  </div>
))

CommandInput.displayName = CommandPrimitive.Input.displayName

const CommandList = React.forwardRef<
  React.ElementRef<typeof CommandPrimitive.List>,
  React.ComponentPropsWithoutRef<typeof CommandPrimitive.List>
>(({ className, ...props }, ref) => (
  <CommandPrimitive.List
    ref={ref}
    className={cn("max-h-[300px] overflow-y-auto overflow-x-hidden", className)}
    {...props}
  />
))

CommandList.displayName = CommandPrimitive.List.displayName

const CommandEmpty = React.forwardRef<
  React.ElementRef<typeof CommandPrimitive.Empty>,
  React.ComponentPropsWithoutRef<typeof CommandPrimitive.Empty>
>((props, ref) => (
  <CommandPrimitive.Empty
    ref={ref}
    className="py-6 text-center text-sm"
    {...props}
  />
))

CommandEmpty.displayName = CommandPrimitive.Empty.displayName

const CommandGroup = React.forwardRef<
  React.ElementRef<typeof CommandPrimitive.Group>,
  React.ComponentPropsWithoutRef<typeof CommandPrimitive.Group>
>(({ className, ...props }, ref) => (
  <CommandPrimitive.Group
    ref={ref}
    className={cn(
      "overflow-hidden p-1 text-foreground [&_[cmdk-group-heading]]:px-2 [&_[cmdk-group-heading]]:py-1.5 [&_[cmdk-group-heading]]:text-xs [&_[cmdk-group-heading]]:font-medium [&_[cmdk-group-heading]]:text-muted-foreground",
      className
    )}
    {...props}
  />
))

CommandGroup.displayName = CommandPrimitive.Group.displayName

const CommandSeparator = React.forwardRef<
  React.ElementRef<typeof CommandPrimitive.Separator>,
  React.ComponentPropsWithoutRef<typeof CommandPrimitive.Separator>
>(({ className, ...props }, ref) => (
  <CommandPrimitive.Separator
    ref={ref}
    className={cn("-mx-1 h-px bg-border", className)}
    {...props}
  />
))
CommandSeparator.displayName = CommandPrimitive.Separator.displayName

const CommandItem = React.forwardRef<
  React.ElementRef<typeof CommandPrimitive.Item>,
  React.ComponentPropsWithoutRef<typeof CommandPrimitive.Item>
>(({ className, ...props }, ref) => (
  <CommandPrimitive.Item
    ref={ref}
    className={cn(
      "relative flex cursor-default gap-2 select-none items-center rounded-sm px-2 py-1.5 text-sm outline-none data-[disabled=true]:pointer-events-none data-[selected=true]:bg-accent data-[selected=true]:text-accent-foreground data-[disabled=true]:opacity-50 [&_svg]:pointer-events-none [&_svg]:size-4 [&_svg]:shrink-0",
      className
    )}
    {...props}
  />
))

CommandItem.displayName = CommandPrimitive.Item.displayName

const CommandShortcut = ({
  className,
  ...props
}: React.HTMLAttributes<HTMLSpanElement>) => {
  return (
    <span
      className={cn(
        "ml-auto text-xs tracking-widest text-muted-foreground",
        className
      )}
      {...props}
    />
  )
}
CommandShortcut.displayName = "CommandShortcut"

export {
  Command,
  CommandDialog,
  CommandInput,
  CommandList,
  CommandEmpty,
  CommandGroup,
  CommandItem,
  CommandShortcut,
  CommandSeparator,
}


```


## <a name="rentalappmainsrccomponentsuiconfirmationdialogtsx"></a>`rental-app-main/src/components/ui/confirmation-dialog.tsx`

```tsx
// path: rental-app-main/src/components/ui/confirmation-dialog.tsx

import React from "react";
import {
  Dialog,
  DialogContent,
  DialogDescription,
  DialogFooter,
  DialogHeader,
  DialogTitle,
} from "./dialog";
import { Button } from "./button";
import { AlertTriangle } from "lucide-react";

interface ConfirmationDialogProps {
  open: boolean;
  onOpenChange: (open: boolean) => void;
  title: string;
  description: string;
  confirmText?: string;
  cancelText?: string;
  onConfirm: () => void;
  onCancel?: () => void;
  variant?: "default" | "destructive";
}

export function ConfirmationDialog({
  open,
  onOpenChange,
  title,
  description,
  confirmText = "–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å",
  cancelText = "–û—Ç–º–µ–Ω–∞",
  onConfirm,
  onCancel,
  variant = "default",
}: ConfirmationDialogProps) {
  const handleConfirm = () => {
    onConfirm();
    onOpenChange(false);
  };

  const handleCancel = () => {
    onCancel?.();
    onOpenChange(false);
  };

  return (
    <Dialog open={open} onOpenChange={onOpenChange}>
      <DialogContent className="sm:max-w-[425px]">
        <DialogHeader>
          <div className="flex items-center gap-2">
            {variant === "destructive" && (
              <AlertTriangle className="h-5 w-5 text-red-500" />
            )}
            <DialogTitle>{title}</DialogTitle>
          </div>
          <DialogDescription>{description}</DialogDescription>
        </DialogHeader>
        <DialogFooter>
          <Button variant="outline" onClick={handleCancel}>
            {cancelText}
          </Button>
          <Button
            variant={variant === "destructive" ? "destructive" : "default"}
            onClick={handleConfirm}
          >
            {confirmText}
          </Button>
        </DialogFooter>
      </DialogContent>
    </Dialog>
  );
} 

```


## <a name="rentalappmainsrccomponentsuidialogtsx"></a>`rental-app-main/src/components/ui/dialog.tsx`

```tsx
// path: rental-app-main/src/components/ui/dialog.tsx

import * as React from "react"
import * as DialogPrimitive from "@radix-ui/react-dialog"
import { X } from "lucide-react"

import { cn } from "@/lib/utils"

const Dialog = DialogPrimitive.Root

const DialogTrigger = DialogPrimitive.Trigger

const DialogPortal = DialogPrimitive.Portal

const DialogClose = DialogPrimitive.Close

const DialogOverlay = React.forwardRef<
  React.ElementRef<typeof DialogPrimitive.Overlay>,
  React.ComponentPropsWithoutRef<typeof DialogPrimitive.Overlay>
>(({ className, ...props }, ref) => (
  <DialogPrimitive.Overlay
    ref={ref}
    className={cn(
      "fixed inset-0 z-50 bg-black/80  data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0",
      className
    )}
    {...props}
  />
))
DialogOverlay.displayName = DialogPrimitive.Overlay.displayName

const DialogContent = React.forwardRef<
  React.ElementRef<typeof DialogPrimitive.Content>,
  React.ComponentPropsWithoutRef<typeof DialogPrimitive.Content>
>(({ className, children, ...props }, ref) => (
  <DialogPortal>
    <DialogOverlay />
    <DialogPrimitive.Content
      ref={ref}
      className={cn(
        "fixed left-[50%] top-[50%] z-50 grid w-full max-w-lg translate-x-[-50%] translate-y-[-50%] gap-4 border bg-background p-6 shadow-lg duration-200 data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[state=closed]:slide-out-to-left-1/2 data-[state=closed]:slide-out-to-top-[48%] data-[state=open]:slide-in-from-left-1/2 data-[state=open]:slide-in-from-top-[48%] sm:rounded-lg",
        className
      )}
      {...props}
    >
      {children}
      <DialogPrimitive.Close className="absolute right-4 top-4 rounded-sm opacity-70 ring-offset-background transition-opacity hover:opacity-100 focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2 disabled:pointer-events-none data-[state=open]:bg-accent data-[state=open]:text-muted-foreground">
        <X className="h-4 w-4" />
        <span className="sr-only">Close</span>
      </DialogPrimitive.Close>
    </DialogPrimitive.Content>
  </DialogPortal>
))
DialogContent.displayName = DialogPrimitive.Content.displayName

const DialogHeader = ({
  className,
  ...props
}: React.HTMLAttributes<HTMLDivElement>) => (
  <div
    className={cn(
      "flex flex-col space-y-1.5 text-center sm:text-left",
      className
    )}
    {...props}
  />
)
DialogHeader.displayName = "DialogHeader"

const DialogFooter = ({
  className,
  ...props
}: React.HTMLAttributes<HTMLDivElement>) => (
  <div
    className={cn(
      "flex flex-col-reverse sm:flex-row sm:justify-end sm:space-x-2",
      className
    )}
    {...props}
  />
)
DialogFooter.displayName = "DialogFooter"

const DialogTitle = React.forwardRef<
  React.ElementRef<typeof DialogPrimitive.Title>,
  React.ComponentPropsWithoutRef<typeof DialogPrimitive.Title>
>(({ className, ...props }, ref) => (
  <DialogPrimitive.Title
    ref={ref}
    className={cn(
      "text-lg font-semibold leading-none tracking-tight",
      className
    )}
    {...props}
  />
))
DialogTitle.displayName = DialogPrimitive.Title.displayName

const DialogDescription = React.forwardRef<
  React.ElementRef<typeof DialogPrimitive.Description>,
  React.ComponentPropsWithoutRef<typeof DialogPrimitive.Description>
>(({ className, ...props }, ref) => (
  <DialogPrimitive.Description
    ref={ref}
    className={cn("text-sm text-muted-foreground", className)}
    {...props}
  />
))
DialogDescription.displayName = DialogPrimitive.Description.displayName

export {
  Dialog,
  DialogPortal,
  DialogOverlay,
  DialogTrigger,
  DialogClose,
  DialogContent,
  DialogHeader,
  DialogFooter,
  DialogTitle,
  DialogDescription,
}


```


## <a name="rentalappmainsrccomponentsuifiltertoggletsx"></a>`rental-app-main/src/components/ui/filter-toggle.tsx`

```tsx
// path: rental-app-main/src/components/ui/filter-toggle.tsx

// src/components/ui/filter-toggle.tsx
import { cva } from "class-variance-authority"
import { cn } from "@/lib/utils"

// –ë–∞–∑–æ–≤—ã–µ —Å—Ç–∏–ª–∏ –¥–ª—è –∫–Ω–æ–ø–æ–∫ —Ñ–∏–ª—å—Ç—Ä–∞
export const filterToggleBaseClass = cva(
    "capitalize px-2 py-1 rounded text-sm font-medium transition-colors"
)

// –ò—Ç–æ–≥–æ–≤—ã–π –∫–ª–∞—Å—Å —Å–æ —Å—Ç–∏–ª—è–º–∏ –ø–æ —Å–æ—Å—Ç–æ—è–Ω–∏—é ToggleGroupItem
export function getFilterToggleClass(color = "sky") {
    const colorClasses = {
        sky: "data-[state=on]:bg-sky-600 data-[state=on]:text-white data-[state=off]:bg-sky-100 data-[state=off]:text-sky-600 data-[state=off]:hover:bg-sky-200",
        green: "data-[state=on]:bg-green-600 data-[state=on]:text-white data-[state=off]:bg-green-100 data-[state=off]:text-green-600 data-[state=off]:hover:bg-green-200"
    };
    
    return cn(
        filterToggleBaseClass(),
        colorClasses[color as keyof typeof colorClasses] || colorClasses.sky
    )
}


```


## <a name="rentalappmainsrccomponentsuiinputtsx"></a>`rental-app-main/src/components/ui/input.tsx`

```tsx
// path: rental-app-main/src/components/ui/input.tsx

import * as React from "react"

import { cn } from "@/lib/utils"

const Input = React.forwardRef<HTMLInputElement, React.ComponentProps<"input">>(
  ({ className, type, ...props }, ref) => {
    return (
      <input
        type={type}
        className={cn(
          "flex h-9 w-full rounded-md border border-input bg-transparent px-3 py-1 text-base shadow-sm transition-colors file:border-0 file:bg-transparent file:text-sm file:font-medium file:text-foreground placeholder:text-muted-foreground focus-visible:outline-none focus-visible:ring-1 focus-visible:ring-ring disabled:cursor-not-allowed disabled:opacity-50 md:text-sm",
          className
        )}
        ref={ref}
        {...props}
      />
    )
  }
)
Input.displayName = "Input"

export { Input }


```


## <a name="rentalappmainsrccomponentsuilabeltsx"></a>`rental-app-main/src/components/ui/label.tsx`

```tsx
// path: rental-app-main/src/components/ui/label.tsx

import * as React from "react"
import * as LabelPrimitive from "@radix-ui/react-label"
import { cva, type VariantProps } from "class-variance-authority"

import { cn } from "@/lib/utils"

const labelVariants = cva(
  "text-sm font-medium leading-none peer-disabled:cursor-not-allowed peer-disabled:opacity-70"
)

const Label = React.forwardRef<
  React.ElementRef<typeof LabelPrimitive.Root>,
  React.ComponentPropsWithoutRef<typeof LabelPrimitive.Root> &
    VariantProps<typeof labelVariants>
>(({ className, ...props }, ref) => (
  <LabelPrimitive.Root
    ref={ref}
    className={cn(labelVariants(), className)}
    {...props}
  />
))
Label.displayName = LabelPrimitive.Root.displayName

export { Label }


```


## <a name="rentalappmainsrccomponentsuimultiselecttsx"></a>`rental-app-main/src/components/ui/multi-select.tsx`

```tsx
// path: rental-app-main/src/components/ui/multi-select.tsx

// src/components/ui/multi-select.tsx

"use client";

import * as React from "react";
import { cva, type VariantProps } from "class-variance-authority";
import { X } from "lucide-react";

import { cn } from "@/lib/utils";
import { Badge } from "@/components/ui/badge";
import { Command, CommandList, CommandItem } from "@/components/ui/command"; // ‚úÖ –ò–°–ü–†–ê–í–õ–ï–ù–û: –£–±—Ä–∞–Ω –Ω–µ–∏—Å–ø–æ–ª—å–∑—É–µ–º—ã–π CommandGroup
import { Command as CommandPrimitive } from "cmdk";

const multiSelectVariants = cva(
    "m-0 flex flex-wrap gap-1 rounded-md border border-input bg-background p-1 text-sm ring-offset-background focus-within:ring-2 focus-within:ring-ring focus-within:ring-offset-2",
    {
        variants: {
            variant: {
                default: "h-10",
                compact: "h-auto min-h-10",
            },
        },
        defaultVariants: {
            variant: "default",
        },
    }
);

interface MultiSelectProps
    extends React.HTMLAttributes<HTMLDivElement>,
        VariantProps<typeof multiSelectVariants> {
    placeholder?: string;
    options: {
        label: string;
        value: string;
        icon?: React.ReactNode;
    }[];
    value: string[];
    onValueChange: (value: string[]) => void;
    disabled?: boolean;
    maxCount?: number;
}

const MultiSelect = React.forwardRef<
    // ‚úÖ –ò–°–ü–†–ê–í–õ–ï–ù–û: –¢–∏–ø ref –∏–∑–º–µ–Ω–µ–Ω –Ω–∞ HTMLInputElement
    HTMLInputElement,
    MultiSelectProps
>(
    (
        {
            placeholder,
            options,
            value,
            onValueChange,
            disabled,
            variant,
            maxCount = 5,
            className,
            ...props
        },
        ref
    ) => {
        const [open, setOpen] = React.useState(false);
        const [inputValue, setInputValue] = React.useState("");

        const handleSelect = (val: string) => {
            if (!value.includes(val)) {
                onValueChange([...value, val]);
            }
        };

        const handleDeselect = (val: string) => {
            onValueChange(value.filter((v) => v !== val));
        };

        const handleKeyDown = (e: React.KeyboardEvent<HTMLDivElement>) => {
            const input = e.currentTarget.querySelector("input");
            if (input) {
                if (e.key === "Delete" || e.key === "Backspace") {
                    if (input.value === "" && value.length > 0) {
                        handleDeselect(value[value.length - 1]);
                    }
                }
                if (e.key === "Escape") {
                    input.blur();
                }
            }
        };

        const selected = options.filter((opt) => value.includes(opt.value));
        const unselected = options.filter((opt) => !value.includes(opt.value));

        return (
            <Command
                onKeyDown={handleKeyDown}
                className="overflow-visible bg-transparent"
            >
                <div className={cn(multiSelectVariants({ variant }), className)}>
                    <div className="flex flex-wrap items-center gap-1">
                        {selected.map((option) => (
                            <Badge
                                key={option.value}
                                variant="secondary"
                                className="gap-1 whitespace-nowrap"
                            >
                                {option.label}
                                <button
                                    type="button"
                                    className="ml-1 rounded-full outline-none ring-offset-background focus:ring-2 focus:ring-ring focus:ring-offset-2"
                                    onKeyDown={(e) => {
                                        if (e.key === "Enter") handleDeselect(option.value);
                                    }}
                                    onMouseDown={(e) => {
                                        e.preventDefault();
                                        e.stopPropagation();
                                    }}
                                    onClick={() => handleDeselect(option.value)}
                                >
                                    <X className="h-3 w-3 text-muted-foreground hover:text-foreground" />
                                </button>
                            </Badge>
                        ))}
                        <CommandPrimitive.Input
                            ref={ref}
                            placeholder={selected.length > 0 ? "" : placeholder}
                            className="w-fit flex-1 bg-transparent p-1 outline-none placeholder:text-muted-foreground"
                            value={inputValue}
                            onValueChange={setInputValue}
                            onBlur={() => setOpen(false)}
                            onFocus={() => setOpen(true)}
                            disabled={disabled}
                            {...props}
                        />
                    </div>
                </div>
                <div className="relative mt-2">
                    {open && unselected.length > 0 ? (
                        <div className="absolute top-0 z-10 w-full rounded-md border bg-popover text-popover-foreground shadow-md outline-none animate-in">
                            <CommandList>
                                {unselected.map((option) => (
                                    <CommandItem
                                        key={option.value}
                                        onMouseDown={(e) => {
                                            e.preventDefault();
                                            e.stopPropagation();
                                        }}
                                        onSelect={() => handleSelect(option.value)}
                                        className="cursor-pointer"
                                    >
                                        {option.label}
                                    </CommandItem>
                                ))}
                            </CommandList>
                        </div>
                    ) : null}
                </div>
            </Command>
        );
    }
);

MultiSelect.displayName = "MultiSelect";

export { MultiSelect };

```


## <a name="rentalappmainsrccomponentsuiphoneinputmd"></a>`rental-app-main/src/components/ui/phone-input.md`

```markdown
// path: rental-app-main/src/components/ui/phone-input.md

# PhoneInput Component

–ö–æ–º–ø–æ–Ω–µ–Ω—Ç –¥–ª—è –≤–≤–æ–¥–∞ —Ç–µ–ª–µ—Ñ–æ–Ω–Ω—ã—Ö –Ω–æ–º–µ—Ä–æ–≤ —Å –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–º —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ–º –∏ –≤–∞–ª–∏–¥–∞—Ü–∏–µ–π.

## –û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏

- ‚úÖ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Ä–æ—Å—Å–∏–π—Å–∫–∏—Ö –Ω–æ–º–µ—Ä–æ–≤ (+7 (XXX) XXX-XX-XX)
- ‚úÖ –ü–æ–¥–¥–µ—Ä–∂–∫–∞ –º–µ–∂–¥—É–Ω–∞—Ä–æ–¥–Ω—ã—Ö –Ω–æ–º–µ—Ä–æ–≤
- ‚úÖ –í–∞–ª–∏–¥–∞—Ü–∏—è –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏
- ‚úÖ –°–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å —Å react-hook-form
- ‚úÖ –î–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å (ARIA –∞—Ç—Ä–∏–±—É—Ç—ã)
- ‚úÖ –ü–æ–¥–¥–µ—Ä–∂–∫–∞ –æ—à–∏–±–æ–∫ –∏ —Å–æ—Å—Ç–æ—è–Ω–∏–π
- ‚úÖ –ú–µ–º–æ–∏–∑–∞—Ü–∏—è –¥–ª—è –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏

## –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ

### –ë–∞–∑–æ–≤–æ–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ

```tsx
import { PhoneInput } from "@/components/ui/phone-input";

function MyForm() {
  const [phone, setPhone] = useState("");

  return (
    <PhoneInput
      value={phone}
      onChange={(e) => setPhone(e.target.value)}
      placeholder="+7 (___) ___-__-__"
    />
  );
}
```

### –° react-hook-form

```tsx
import { useForm } from "react-hook-form";
import { PhoneInput } from "@/components/ui/phone-input";

function MyForm() {
  const { register, handleSubmit } = useForm();

  return (
    <form onSubmit={handleSubmit(onSubmit)}>
      <PhoneInput
        {...register("phone")}
        placeholder="+7 (___) ___-__-__"
      />
    </form>
  );
}
```

### –° –≤–∞–ª–∏–¥–∞—Ü–∏–µ–π –æ—à–∏–±–æ–∫

```tsx
import { PhoneInput } from "@/components/ui/phone-input";

function MyForm() {
  const [phone, setPhone] = useState("");
  const [error, setError] = useState(false);

  return (
    <PhoneInput
      value={phone}
      onChange={(e) => setPhone(e.target.value)}
      error={error}
      placeholder="+7 (___) ___-__-__"
    />
  );
}
```

### –° –≤–∞–ª–∏–¥–∞—Ü–∏–µ–π –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏

```tsx
import { PhoneInput } from "@/components/ui/phone-input";
import { usePhoneValidation } from "@/hooks/usePhoneValidation";

function MyForm() {
  const [phone, setPhone] = useState("");
  const { isValid, error, validatePhone } = usePhoneValidation({
    required: true,
    onValidationChange: (isValid) => {
      console.log("Phone validation:", isValid);
    }
  });

  return (
    <div>
      <PhoneInput
        value={phone}
        onChange={(e) => {
          setPhone(e.target.value);
          validatePhone(e.target.value);
        }}
        error={!!error}
        placeholder="+7 (___) ___-__-__"
      />
      {error && <p className="text-red-500 text-sm">{error}</p>}
    </div>
  );
}
```

### –ú–µ–∂–¥—É–Ω–∞—Ä–æ–¥–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç

```tsx
import { PhoneInput } from "@/components/ui/phone-input";

function MyForm() {
  const [phone, setPhone] = useState("");

  return (
    <PhoneInput
      value={phone}
      onChange={(e) => setPhone(e.target.value)}
      format="international"
      placeholder="+X (XXX) XXX-XXXX"
    />
  );
}
```

## Props

| Prop | –¢–∏–ø | –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é | –û–ø–∏—Å–∞–Ω–∏–µ |
|------|-----|--------------|----------|
| `value` | `string` | - | –ó–Ω–∞—á–µ–Ω–∏–µ –ø–æ–ª—è |
| `onChange` | `(e: ChangeEvent<HTMLInputElement>) => void` | - | –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∏–∑–º–µ–Ω–µ–Ω–∏—è |
| `error` | `boolean` | `false` | –ü–æ–∫–∞–∑—ã–≤–∞—Ç—å –ª–∏ –æ—à–∏–±–∫—É |
| `format` | `'russian' \| 'international'` | `'russian'` | –§–æ—Ä–º–∞—Ç –Ω–æ–º–µ—Ä–∞ |
| `onValidationChange` | `(isValid: boolean) => void` | - | –ö–æ–ª–±—ç–∫ –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ –≤–∞–ª–∏–¥–Ω–æ—Å—Ç–∏ |
| `className` | `string` | - | –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ CSS –∫–ª–∞—Å—Å—ã |
| `placeholder` | `string` | - | –ü–ª–µ–π—Å—Ö–æ–ª–¥–µ—Ä |
| `disabled` | `boolean` | `false` | –û—Ç–∫–ª—é—á–µ–Ω–æ –ª–∏ –ø–æ–ª–µ |
| `required` | `boolean` | `false` | –û–±—è–∑–∞—Ç–µ–ª—å–Ω–æ–µ –ª–∏ –ø–æ–ª–µ |

## –°–æ–±—ã—Ç–∏—è

–ö–æ–º–ø–æ–Ω–µ–Ω—Ç –≥–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–µ —Å–æ–±—ã—Ç–∏—è `ChangeEvent<HTMLInputElement>` —Å –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–º–∏ –¥–∞–Ω–Ω—ã–º–∏ –≤ `target.dataset`:

- `isValid`: `boolean` - —è–≤–ª—è–µ—Ç—Å—è –ª–∏ –Ω–æ–º–µ—Ä –ø–æ–ª–Ω—ã–º –∏ –≤–∞–ª–∏–¥–Ω—ã–º
- `unmaskedValue`: `string` - –Ω–æ–º–µ—Ä –±–µ–∑ —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏—è

## –í–∞–ª–∏–¥–∞—Ü–∏—è

–ö–æ–º–ø–æ–Ω–µ–Ω—Ç –∏—Å–ø–æ–ª—å–∑—É–µ—Ç –≤—Å—Ç—Ä–æ–µ–Ω–Ω—É—é –≤–∞–ª–∏–¥–∞—Ü–∏—é —á–µ—Ä–µ–∑ `react-imask` –∏ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —É—Ç–∏–ª–∏—Ç—ã –∏–∑ `@/utils/phoneUtils`:

- –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ñ–æ—Ä–º–∞—Ç–∞ –Ω–æ–º–µ—Ä–∞
- –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–ª–Ω–æ—Ç—ã –Ω–æ–º–µ—Ä–∞
- –ü–æ–¥–¥–µ—Ä–∂–∫–∞ —Ä–æ—Å—Å–∏–π—Å–∫–∏—Ö (+7) –∏ –º–µ–∂–¥—É–Ω–∞—Ä–æ–¥–Ω—ã—Ö –Ω–æ–º–µ—Ä–æ–≤
- –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –Ω–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏—è

## –î–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å

–ö–æ–º–ø–æ–Ω–µ–Ω—Ç –≤–∫–ª—é—á–∞–µ—Ç —Å–ª–µ–¥—É—é—â–∏–µ ARIA –∞—Ç—Ä–∏–±—É—Ç—ã:

- `aria-invalid`: —É–∫–∞–∑—ã–≤–∞–µ—Ç –Ω–∞ –Ω–∞–ª–∏—á–∏–µ –æ—à–∏–±–∫–∏
- `aria-describedby`: —Å–≤—è–∑—ã–≤–∞–µ—Ç —Å —Å–æ–æ–±—â–µ–Ω–∏–µ–º –æ–± –æ—à–∏–±–∫–µ
- `inputMode="tel"`: –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç —Ü–∏—Ñ—Ä–æ–≤—É—é –∫–ª–∞–≤–∏–∞—Ç—É—Ä—É –Ω–∞ –º–æ–±–∏–ª—å–Ω—ã—Ö —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞—Ö
- `autoComplete="tel"`: –ø–æ–º–æ–≥–∞–µ—Ç –±—Ä–∞—É–∑–µ—Ä—É –∞–≤—Ç–æ–∑–∞–ø–æ–ª–Ω–∏—Ç—å –ø–æ–ª–µ

## –£—Ç–∏–ª–∏—Ç—ã

–î–ª—è —Ä–∞–±–æ—Ç—ã —Å —Ç–µ–ª–µ—Ñ–æ–Ω–Ω—ã–º–∏ –Ω–æ–º–µ—Ä–∞–º–∏ –¥–æ—Å—Ç—É–ø–Ω—ã —É—Ç–∏–ª–∏—Ç—ã –≤ `@/utils/phoneUtils`:

```tsx
import { 
  validateRussianPhone,
  formatPhone,
  normalizePhone,
  isPhoneComplete 
} from "@/utils/phoneUtils";

// –í–∞–ª–∏–¥–∞—Ü–∏—è
const isValid = validateRussianPhone("+7 (999) 123-45-67");

// –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ
const formatted = formatPhone("79991234567");

// –ù–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏—è
const normalized = normalizePhone("8 (999) 123-45-67");

// –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–ª–Ω–æ—Ç—ã
const isComplete = isPhoneComplete("+7 (999) 123-45-67");
```

## –•—É–∫–∏

–î–ª—è –≤–∞–ª–∏–¥–∞—Ü–∏–∏ –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ —Ö—É–∫–∏ –∏–∑ `@/hooks/usePhoneValidation`:

```tsx
import { usePhoneValidation, usePhoneValidationWithDebounce } from "@/hooks/usePhoneValidation";

// –û–±—ã—á–Ω–∞—è –≤–∞–ª–∏–¥–∞—Ü–∏—è
const { isValid, error, validatePhone } = usePhoneValidation({
  required: true
});

// –í–∞–ª–∏–¥–∞—Ü–∏—è —Å debounce
const { debouncedValidate } = usePhoneValidationWithDebounce({
  debounceMs: 500
});
``` 

```


## <a name="rentalappmainsrccomponentsuiphoneinputtsx"></a>`rental-app-main/src/components/ui/phone-input.tsx`

```tsx
// path: rental-app-main/src/components/ui/phone-input.tsx

// src/components/ui/phone-input.tsx

import * as React from "react";
import { useIMask } from "react-imask";
import { Input } from "@/components/ui/input";
import { cn } from "@/lib/utils";

// –£–ª—É—á—à–µ–Ω–Ω–∞—è —Ç–∏–ø–∏–∑–∞—Ü–∏—è —Å –ø–æ–¥–¥–µ—Ä–∂–∫–æ–π –≤—Å–µ—Ö –≤–æ–∑–º–æ–∂–Ω—ã—Ö –ø—Ä–æ–ø—Å–æ–≤ Input
interface PhoneInputProps extends Omit<React.InputHTMLAttributes<HTMLInputElement>, 'onChange'> {
    error?: boolean;
    onChange?: (e: React.ChangeEvent<HTMLInputElement>) => void;
    // –î–æ–±–∞–≤–ª—è–µ–º –ø–æ–¥–¥–µ—Ä–∂–∫—É —Ä–∞–∑–ª–∏—á–Ω—ã—Ö —Ñ–æ—Ä–º–∞—Ç–æ–≤ —Ç–µ–ª–µ—Ñ–æ–Ω–æ–≤
    format?: 'russian' | 'international';
    // –î–æ–±–∞–≤–ª—è–µ–º –ø–æ–¥–¥–µ—Ä–∂–∫—É –≤–∞–ª–∏–¥–∞—Ü–∏–∏ –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏
    onValidationChange?: (isValid: boolean) => void;
}

const PhoneInput = React.forwardRef<HTMLInputElement, PhoneInputProps>(
    ({ 
        onChange, 
        error, 
        format = 'russian',
        onValidationChange,
        className,
        ...props 
    }, ref) => {
        // –û–ø—Ä–µ–¥–µ–ª—è–µ–º –º–∞—Å–∫—É –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Ñ–æ—Ä–º–∞—Ç–∞
        const maskConfig = format === 'russian' 
            ? { 
                mask: "+7 (000) 000-00-00",
                lazy: false,
                placeholderChar: '_'
              }
            : { 
                mask: "+{1}(000)000-0000",
                lazy: false,
                placeholderChar: '_'
              };

        const { ref: imaskRef, value: maskedValue, setValue } = useIMask(
            maskConfig,
            {
                onAccept: (value: any, mask: any) => {
                    console.log('PhoneInput onAccept:', { value, maskedValue, isComplete: mask.masked.isComplete });
                    
                    if (onChange) {
                        // –°–æ–∑–¥–∞–µ–º –ø—Ä–æ—Å—Ç–æ–µ —Å–æ–±—ã—Ç–∏–µ —Å –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã–º–∏ —Å–≤–æ–π—Å—Ç–≤–∞–º–∏
                        const event = {
                            target: {
                                name: props.name,
                                value: value,
                            },
                        } as unknown as React.ChangeEvent<HTMLInputElement>;
                        
                        onChange(event);
                    }

                    // –£–≤–µ–¥–æ–º–ª—è–µ–º –æ —Å–æ—Å—Ç–æ—è–Ω–∏–∏ –≤–∞–ª–∏–¥–∞—Ü–∏–∏
                    if (onValidationChange) {
                        onValidationChange(mask.masked.isComplete);
                    }
                }
            }
        );

        // –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä—É–µ–º –≤–Ω–µ—à–Ω–µ–µ –∑–Ω–∞—á–µ–Ω–∏–µ —Å –º–∞—Å–∫–æ–π
        React.useEffect(() => {
            const currentValue = props.value as string || '';
            if (currentValue !== maskedValue) {
                setValue(currentValue);
            }
        }, [props.value, maskedValue, setValue]);

        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∏–∑–º–µ–Ω–µ–Ω–∏—è –∑–Ω–∞—á–µ–Ω–∏—è
        const handleChange = React.useCallback((e: React.ChangeEvent<HTMLInputElement>) => {
            setValue(e.target.value);
        }, [setValue]);

        // –ú–µ–º–æ–∏–∑–∏—Ä—É–µ–º —Ñ—É–Ω–∫—Ü–∏—é —É—Å—Ç–∞–Ω–æ–≤–∫–∏ refs –¥–ª—è –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏
        const setRefs = React.useCallback(
            (node: HTMLInputElement | null) => {
                // Ref –æ—Ç useIMask
                (imaskRef as React.MutableRefObject<HTMLInputElement | null>).current = node;

                // –í–Ω–µ—à–Ω–∏–π ref –æ—Ç react-hook-form
                if (typeof ref === 'function') {
                    ref(node);
                } else if (ref) {
                    ref.current = node;
                }
            },
            [ref, imaskRef]
        );

        // –î–æ–±–∞–≤–ª—è–µ–º aria-–∞—Ç—Ä–∏–±—É—Ç—ã –¥–ª—è –ª—É—á—à–µ–π –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏
        const accessibilityProps = {
            'aria-invalid': error ? true : false,
            'aria-describedby': error ? `${props.id}-error` : undefined,
            'inputMode': 'tel' as const,
            'autoComplete': 'tel' as const,
        };

        return (
            <Input
                {...props}
                {...accessibilityProps}
                ref={setRefs}
                value={maskedValue || ''}
                onChange={handleChange}
                className={cn(
                    error && "border-red-500 focus-visible:ring-red-500",
                    className
                )}
            />
        );
    }
);

PhoneInput.displayName = "PhoneInput";

export { PhoneInput };
export type { PhoneInputProps };

```


## <a name="rentalappmainsrccomponentsuipopovertsx"></a>`rental-app-main/src/components/ui/popover.tsx`

```tsx
// path: rental-app-main/src/components/ui/popover.tsx

import * as React from "react"
import * as PopoverPrimitive from "@radix-ui/react-popover"

import { cn } from "@/lib/utils"

const Popover = PopoverPrimitive.Root

const PopoverTrigger = PopoverPrimitive.Trigger

const PopoverAnchor = PopoverPrimitive.Anchor

const PopoverContent = React.forwardRef<
  React.ElementRef<typeof PopoverPrimitive.Content>,
  React.ComponentPropsWithoutRef<typeof PopoverPrimitive.Content>
>(({ className, align = "center", sideOffset = 4, ...props }, ref) => (
  <PopoverPrimitive.Portal>
    <PopoverPrimitive.Content
      ref={ref}
      align={align}
      sideOffset={sideOffset}
      className={cn(
        "z-50 w-72 rounded-md border bg-popover p-4 text-popover-foreground shadow-md outline-none data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2 origin-[--radix-popover-content-transform-origin]",
        className
      )}
      {...props}
    />
  </PopoverPrimitive.Portal>
))
PopoverContent.displayName = PopoverPrimitive.Content.displayName

export { Popover, PopoverTrigger, PopoverContent, PopoverAnchor }


```


## <a name="rentalappmainsrccomponentsuiscrollareatsx"></a>`rental-app-main/src/components/ui/scroll-area.tsx`

```tsx
// path: rental-app-main/src/components/ui/scroll-area.tsx

// src/components/ui/scroll-area.tsx

import * as React from "react"
import * as ScrollAreaPrimitive from "@radix-ui/react-scroll-area"

import { cn } from "@/lib/utils"

const ScrollArea = React.forwardRef<
    React.ElementRef<typeof ScrollAreaPrimitive.Root>,
    React.ComponentPropsWithoutRef<typeof ScrollAreaPrimitive.Root>
>(({ className, children, ...props }, ref) => (
    <ScrollAreaPrimitive.Root
        ref={ref}
        className={cn("relative overflow-hidden", className)}
        {...props}
    >
        <ScrollAreaPrimitive.Viewport className="h-full w-full rounded-[inherit]">
            {children}
        </ScrollAreaPrimitive.Viewport>
        <ScrollBar />
        <ScrollAreaPrimitive.Corner />
    </ScrollAreaPrimitive.Root>
))
ScrollArea.displayName = ScrollAreaPrimitive.Root.displayName

const ScrollBar = React.forwardRef<
    React.ElementRef<typeof ScrollAreaPrimitive.Scrollbar>,
    React.ComponentPropsWithoutRef<typeof ScrollAreaPrimitive.Scrollbar>
>(({ className, orientation = "vertical", ...props }, ref) => (
    <ScrollAreaPrimitive.Scrollbar
        ref={ref}
        orientation={orientation}
        className={cn(
            "flex touch-none select-none transition-colors",
            orientation === "vertical" &&
            "h-full w-2.5 border-l border-l-transparent p-[1px]",
            orientation === "horizontal" &&
            "h-2.5 flex-col border-t border-t-transparent p-[1px]",
            className
        )}
        {...props}
    >
        <ScrollAreaPrimitive.Thumb className="relative flex-1 rounded-full bg-border" />
    </ScrollAreaPrimitive.Scrollbar>
))
ScrollBar.displayName = ScrollAreaPrimitive.Scrollbar.displayName

export { ScrollArea, ScrollBar }

```


## <a name="rentalappmainsrccomponentsuiselecttsx"></a>`rental-app-main/src/components/ui/select.tsx`

```tsx
// path: rental-app-main/src/components/ui/select.tsx

import * as React from "react"
import * as SelectPrimitive from "@radix-ui/react-select"
import { Check, ChevronDown, ChevronUp } from "lucide-react"

import { cn } from "@/lib/utils"

const Select = SelectPrimitive.Root

const SelectGroup = SelectPrimitive.Group

const SelectValue = SelectPrimitive.Value

const SelectTrigger = React.forwardRef<
  React.ElementRef<typeof SelectPrimitive.Trigger>,
  React.ComponentPropsWithoutRef<typeof SelectPrimitive.Trigger>
>(({ className, children, ...props }, ref) => (
  <SelectPrimitive.Trigger
    ref={ref}
    className={cn(
      "flex h-9 w-full items-center justify-between whitespace-nowrap rounded-md border border-input bg-transparent px-3 py-2 text-sm shadow-sm ring-offset-background data-[placeholder]:text-muted-foreground focus:outline-none focus:ring-1 focus:ring-ring disabled:cursor-not-allowed disabled:opacity-50 [&>span]:line-clamp-1",
      className
    )}
    {...props}
  >
    {children}
    <SelectPrimitive.Icon asChild>
      <ChevronDown className="h-4 w-4 opacity-50" />
    </SelectPrimitive.Icon>
  </SelectPrimitive.Trigger>
))
SelectTrigger.displayName = SelectPrimitive.Trigger.displayName

const SelectScrollUpButton = React.forwardRef<
  React.ElementRef<typeof SelectPrimitive.ScrollUpButton>,
  React.ComponentPropsWithoutRef<typeof SelectPrimitive.ScrollUpButton>
>(({ className, ...props }, ref) => (
  <SelectPrimitive.ScrollUpButton
    ref={ref}
    className={cn(
      "flex cursor-default items-center justify-center py-1",
      className
    )}
    {...props}
  >
    <ChevronUp className="h-4 w-4" />
  </SelectPrimitive.ScrollUpButton>
))
SelectScrollUpButton.displayName = SelectPrimitive.ScrollUpButton.displayName

const SelectScrollDownButton = React.forwardRef<
  React.ElementRef<typeof SelectPrimitive.ScrollDownButton>,
  React.ComponentPropsWithoutRef<typeof SelectPrimitive.ScrollDownButton>
>(({ className, ...props }, ref) => (
  <SelectPrimitive.ScrollDownButton
    ref={ref}
    className={cn(
      "flex cursor-default items-center justify-center py-1",
      className
    )}
    {...props}
  >
    <ChevronDown className="h-4 w-4" />
  </SelectPrimitive.ScrollDownButton>
))
SelectScrollDownButton.displayName =
  SelectPrimitive.ScrollDownButton.displayName

const SelectContent = React.forwardRef<
  React.ElementRef<typeof SelectPrimitive.Content>,
  React.ComponentPropsWithoutRef<typeof SelectPrimitive.Content>
>(({ className, children, position = "popper", ...props }, ref) => (
  <SelectPrimitive.Portal>
    <SelectPrimitive.Content
      ref={ref}
      className={cn(
        "relative z-50 max-h-[--radix-select-content-available-height] min-w-[8rem] overflow-y-auto overflow-x-hidden rounded-md border bg-popover text-popover-foreground shadow-md data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2 origin-[--radix-select-content-transform-origin]",
        position === "popper" &&
          "data-[side=bottom]:translate-y-1 data-[side=left]:-translate-x-1 data-[side=right]:translate-x-1 data-[side=top]:-translate-y-1",
        className
      )}
      position={position}
      {...props}
    >
      <SelectScrollUpButton />
      <SelectPrimitive.Viewport
        className={cn(
          "p-1",
          position === "popper" &&
            "h-[var(--radix-select-trigger-height)] w-full min-w-[var(--radix-select-trigger-width)]"
        )}
      >
        {children}
      </SelectPrimitive.Viewport>
      <SelectScrollDownButton />
    </SelectPrimitive.Content>
  </SelectPrimitive.Portal>
))
SelectContent.displayName = SelectPrimitive.Content.displayName

const SelectLabel = React.forwardRef<
  React.ElementRef<typeof SelectPrimitive.Label>,
  React.ComponentPropsWithoutRef<typeof SelectPrimitive.Label>
>(({ className, ...props }, ref) => (
  <SelectPrimitive.Label
    ref={ref}
    className={cn("px-2 py-1.5 text-sm font-semibold", className)}
    {...props}
  />
))
SelectLabel.displayName = SelectPrimitive.Label.displayName

const SelectItem = React.forwardRef<
  React.ElementRef<typeof SelectPrimitive.Item>,
  React.ComponentPropsWithoutRef<typeof SelectPrimitive.Item>
>(({ className, children, ...props }, ref) => (
  <SelectPrimitive.Item
    ref={ref}
    className={cn(
      "relative flex w-full cursor-default select-none items-center rounded-sm py-1.5 pl-2 pr-8 text-sm outline-none focus:bg-accent focus:text-accent-foreground data-[disabled]:pointer-events-none data-[disabled]:opacity-50",
      className
    )}
    {...props}
  >
    <span className="absolute right-2 flex h-3.5 w-3.5 items-center justify-center">
      <SelectPrimitive.ItemIndicator>
        <Check className="h-4 w-4" />
      </SelectPrimitive.ItemIndicator>
    </span>
    <SelectPrimitive.ItemText>{children}</SelectPrimitive.ItemText>
  </SelectPrimitive.Item>
))
SelectItem.displayName = SelectPrimitive.Item.displayName

const SelectSeparator = React.forwardRef<
  React.ElementRef<typeof SelectPrimitive.Separator>,
  React.ComponentPropsWithoutRef<typeof SelectPrimitive.Separator>
>(({ className, ...props }, ref) => (
  <SelectPrimitive.Separator
    ref={ref}
    className={cn("-mx-1 my-1 h-px bg-muted", className)}
    {...props}
  />
))
SelectSeparator.displayName = SelectPrimitive.Separator.displayName

export {
  Select,
  SelectGroup,
  SelectValue,
  SelectTrigger,
  SelectContent,
  SelectLabel,
  SelectItem,
  SelectSeparator,
  SelectScrollUpButton,
  SelectScrollDownButton,
}


```


## <a name="rentalappmainsrccomponentsuiskeletontsx"></a>`rental-app-main/src/components/ui/skeleton.tsx`

```tsx
// path: rental-app-main/src/components/ui/skeleton.tsx

import * as React from "react"
import { cn } from "@/lib/utils"

function Skeleton({
  className,
  ...props
}: React.HTMLAttributes<HTMLDivElement>) {
  return (
    <div
      className={cn("animate-pulse rounded-md bg-muted", className)}
      {...props}
    />
  )
}

export { Skeleton }


```


## <a name="rentalappmainsrccomponentsuiswitchtsx"></a>`rental-app-main/src/components/ui/switch.tsx`

```tsx
// path: rental-app-main/src/components/ui/switch.tsx

import * as React from "react"
import * as SwitchPrimitives from "@radix-ui/react-switch"

import { cn } from "@/lib/utils"

const Switch = React.forwardRef<
  React.ElementRef<typeof SwitchPrimitives.Root>,
  React.ComponentPropsWithoutRef<typeof SwitchPrimitives.Root>
>(({ className, ...props }, ref) => (
  <SwitchPrimitives.Root
    className={cn(
      "peer inline-flex h-5 w-9 shrink-0 cursor-pointer items-center rounded-full border-2 border-transparent shadow-sm transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 focus-visible:ring-offset-background disabled:cursor-not-allowed disabled:opacity-50 data-[state=checked]:bg-primary data-[state=unchecked]:bg-input",
      className
    )}
    {...props}
    ref={ref}
  >
    <SwitchPrimitives.Thumb
      className={cn(
        "pointer-events-none block h-4 w-4 rounded-full bg-background shadow-lg ring-0 transition-transform data-[state=checked]:translate-x-4 data-[state=unchecked]:translate-x-0"
      )}
    />
  </SwitchPrimitives.Root>
))
Switch.displayName = SwitchPrimitives.Root.displayName

export { Switch }


```


## <a name="rentalappmainsrccomponentsuitabletsx"></a>`rental-app-main/src/components/ui/table.tsx`

```tsx
// path: rental-app-main/src/components/ui/table.tsx

//src/components/ui/table.tsx


import * as React from "react";
import { cn } from "@/lib/utils";

const Table = React.forwardRef<
    HTMLTableElement,
    React.HTMLAttributes<HTMLTableElement>
>(({ className, ...props }, ref) => (
    <div className="relative w-full overflow-auto">
        <table
            ref={ref}
            className={cn("w-full caption-bottom text-sm", className)}
            {...props}
        />
    </div>
));
Table.displayName = "Table";

const TableHeader = React.forwardRef<
    HTMLTableSectionElement,
    React.HTMLAttributes<HTMLTableSectionElement>
>(({ className, ...props }, ref) => (
    <thead ref={ref} className={cn("[&_tr]:border-b", className)} {...props} />
));
TableHeader.displayName = "TableHeader";

const TableBody = React.forwardRef<
    HTMLTableSectionElement,
    React.HTMLAttributes<HTMLTableSectionElement>
>(({ className, ...props }, ref) => (
    <tbody
        ref={ref}
        className={cn("[&_tr:last-child]:border-0", className)}
        {...props}
    />
));
TableBody.displayName = "TableBody";

const TableFooter = React.forwardRef<
    HTMLTableSectionElement,
    React.HTMLAttributes<HTMLTableSectionElement>
>(({ className, ...props }, ref) => (
    <tfoot
        ref={ref}
        className={cn(
            "border-t bg-muted/50 font-medium [&>tr]:last:border-b-0",
            className
        )}
        {...props}
    />
));
TableFooter.displayName = "TableFooter";

const TableRow = React.forwardRef<
    HTMLTableRowElement,
    React.HTMLAttributes<HTMLTableRowElement>
>(({ className, ...props }, ref) => (
    <tr
        ref={ref}
        className={cn(
            "border-b transition-colors hover:bg-muted/50 data-[state=selected]:bg-muted",
            className
        )}
        {...props}
    />
));
TableRow.displayName = "TableRow";

const TableHead = React.forwardRef<
    HTMLTableCellElement,
    React.ThHTMLAttributes<HTMLTableCellElement>
>(({ className, ...props }, ref) => (
    <th
        ref={ref}
        className={cn(
            "h-12 px-4 text-left align-middle font-medium text-muted-foreground [&:has([role=checkbox])]:pr-0",
            className
        )}
        {...props}
    />
));
TableHead.displayName = "TableHead";

const TableCell = React.forwardRef<
    HTMLTableCellElement,
    React.TdHTMLAttributes<HTMLTableCellElement>
>(({ className, ...props }, ref) => (
    <td
        ref={ref}
        className={cn("p-4 align-middle [&:has([role=checkbox])]:pr-0", className)}
        {...props}
    />
));
TableCell.displayName = "TableCell";

const TableCaption = React.forwardRef<
    HTMLTableCaptionElement,
    React.HTMLAttributes<HTMLTableCaptionElement>
>(({ className, ...props }, ref) => (
    <caption
        ref={ref}
        className={cn("mt-4 text-sm text-muted-foreground", className)}
        {...props}
    />
));
TableCaption.displayName = "TableCaption";

export {
    Table,
    TableHeader,
    TableBody,
    TableFooter,
    TableHead,
    TableRow,
    TableCell,
    TableCaption,
};


```


## <a name="rentalappmainsrccomponentsuitextareatsx"></a>`rental-app-main/src/components/ui/textarea.tsx`

```tsx
// path: rental-app-main/src/components/ui/textarea.tsx

import * as React from "react"

import { cn } from "@/lib/utils"

const Textarea = React.forwardRef<
  HTMLTextAreaElement,
  React.ComponentProps<"textarea">
>(({ className, ...props }, ref) => {
  return (
    <textarea
      className={cn(
        "flex min-h-[60px] w-full rounded-md border border-input bg-transparent px-3 py-2 text-base shadow-sm placeholder:text-muted-foreground focus-visible:outline-none focus-visible:ring-1 focus-visible:ring-ring disabled:cursor-not-allowed disabled:opacity-50 md:text-sm",
        className
      )}
      ref={ref}
      {...props}
    />
  )
})
Textarea.displayName = "Textarea"

export { Textarea }


```


## <a name="rentalappmainsrccomponentsuitogglegrouptsx"></a>`rental-app-main/src/components/ui/toggle-group.tsx`

```tsx
// path: rental-app-main/src/components/ui/toggle-group.tsx

"use client"

import * as React from "react"
import * as ToggleGroupPrimitive from "@radix-ui/react-toggle-group"
import { type VariantProps } from "class-variance-authority"

import { cn } from "@/lib/utils"
import { toggleVariants } from "@/components/ui/toggle"

const ToggleGroupContext = React.createContext<
  VariantProps<typeof toggleVariants>
>({
  size: "default",
  variant: "default",
})

const ToggleGroup = React.forwardRef<
  React.ElementRef<typeof ToggleGroupPrimitive.Root>,
  React.ComponentPropsWithoutRef<typeof ToggleGroupPrimitive.Root> &
    VariantProps<typeof toggleVariants>
>(({ className, variant, size, children, ...props }, ref) => (
  <ToggleGroupPrimitive.Root
    ref={ref}
    className={cn("flex items-center justify-center gap-1", className)}
    {...props}
  >
    <ToggleGroupContext.Provider value={{ variant, size }}>
      {children}
    </ToggleGroupContext.Provider>
  </ToggleGroupPrimitive.Root>
))

ToggleGroup.displayName = ToggleGroupPrimitive.Root.displayName

const ToggleGroupItem = React.forwardRef<
  React.ElementRef<typeof ToggleGroupPrimitive.Item>,
  React.ComponentPropsWithoutRef<typeof ToggleGroupPrimitive.Item> &
    VariantProps<typeof toggleVariants>
>(({ className, children, variant, size, ...props }, ref) => {
  const context = React.useContext(ToggleGroupContext)

  return (
    <ToggleGroupPrimitive.Item
      ref={ref}
      className={cn(
        toggleVariants({
          variant: context.variant || variant,
          size: context.size || size,
        }),
        className
      )}
      {...props}
    >
      {children}
    </ToggleGroupPrimitive.Item>
  )
})

ToggleGroupItem.displayName = ToggleGroupPrimitive.Item.displayName

export { ToggleGroup, ToggleGroupItem }


```


## <a name="rentalappmainsrccomponentsuitoggletsx"></a>`rental-app-main/src/components/ui/toggle.tsx`

```tsx
// path: rental-app-main/src/components/ui/toggle.tsx

import * as React from "react"
import * as TogglePrimitive from "@radix-ui/react-toggle"
import { cva, type VariantProps } from "class-variance-authority"

import { cn } from "@/lib/utils"

const toggleVariants = cva(
  "inline-flex items-center justify-center gap-2 rounded-md text-sm font-medium transition-colors hover:bg-muted hover:text-muted-foreground focus-visible:outline-none focus-visible:ring-1 focus-visible:ring-ring disabled:pointer-events-none disabled:opacity-50 data-[state=on]:bg-accent data-[state=on]:text-accent-foreground [&_svg]:pointer-events-none [&_svg]:size-4 [&_svg]:shrink-0",
  {
    variants: {
      variant: {
        default: "bg-transparent",
        outline:
          "border border-input bg-transparent shadow-sm hover:bg-accent hover:text-accent-foreground",
      },
      size: {
        default: "h-9 px-2 min-w-9",
        sm: "h-8 px-1.5 min-w-8",
        lg: "h-10 px-2.5 min-w-10",
      },
    },
    defaultVariants: {
      variant: "default",
      size: "default",
    },
  }
)

const Toggle = React.forwardRef<
  React.ElementRef<typeof TogglePrimitive.Root>,
  React.ComponentPropsWithoutRef<typeof TogglePrimitive.Root> &
    VariantProps<typeof toggleVariants>
>(({ className, variant, size, ...props }, ref) => (
  <TogglePrimitive.Root
    ref={ref}
    className={cn(toggleVariants({ variant, size, className }))}
    {...props}
  />
))

Toggle.displayName = TogglePrimitive.Root.displayName

export { Toggle, toggleVariants }


```


## <a name="rentalappmainsrcconstantsequipmentConstantsts"></a>`rental-app-main/src/constants/equipmentConstants.ts`

```typescript
// path: rental-app-main/src/constants/equipmentConstants.ts

// src/constants/equipmentConstants.ts

/**
 * –°–ø–∏—Å–æ–∫ –≤–æ–∑–º–æ–∂–Ω—ã—Ö —Å–æ—Å—Ç–æ—è–Ω–∏–π –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—è.
 * –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–ª—è –≤—ã–ø–∞–¥–∞—é—â–∏—Ö —Å–ø–∏—Å–∫–æ–≤ –≤ —Ñ–æ—Ä–º–∞—Ö –∏ –¥–ª—è –≤–∞–ª–∏–¥–∞—Ü–∏–∏.
 */
export const EQUIPMENT_CONDITIONS: readonly string[] = [
    "–í–µ–ª–∏–∫–æ–ª–µ–ø–Ω–æ",
    "–û—Ç–ª–∏—á–Ω–æ",
    "–•–æ—Ä–æ—à–æ",
    "–£–¥–æ–≤–ª–µ—Ç–≤–æ—Ä–∏—Ç–µ–ª—å–Ω–æ",
    "–¢—Ä–µ–±—É–µ—Ç —Ä–µ–º–æ–Ω—Ç–∞",
];

/**
 * –£—Ç–∏–ª–∏—Ç–∞ –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è Tailwind CSS –∫–ª–∞—Å—Å–æ–≤ –¥–ª—è —Å—Ç–∏–ª–∏–∑–∞—Ü–∏–∏ —Å–æ—Å—Ç–æ—è–Ω–∏—è –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—è.
 * @param condition –°—Ç—Ä–æ–∫–∞ —Å –Ω–∞–∑–≤–∞–Ω–∏–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏—è.
 * @returns –°—Ç—Ä–æ–∫–∞ —Å CSS –∫–ª–∞—Å—Å–∞–º–∏ –¥–ª—è —Ñ–æ–Ω–∞ –∏ —Ç–µ–∫—Å—Ç–∞.
 */
export function getConditionVariantClass(condition: string): string {
    switch (condition) {
        case "–í–µ–ª–∏–∫–æ–ª–µ–ø–Ω–æ":
            return "bg-green-100 text-green-800";
        case "–û—Ç–ª–∏—á–Ω–æ":
            return "bg-sky-100 text-sky-800";
        case "–•–æ—Ä–æ—à–æ":
            return "bg-yellow-100 text-yellow-800";
        case "–£–¥–æ–≤–ª–µ—Ç–≤–æ—Ä–∏—Ç–µ–ª—å–Ω–æ":
            return "bg-orange-100 text-orange-800";
        case "–¢—Ä–µ–±—É–µ—Ç —Ä–µ–º–æ–Ω—Ç–∞":
            return "bg-red-100 text-red-800";
        default:
            return "bg-gray-100 text-gray-800";
    }
};

```


## <a name="rentalappmainsrcconstantspaginationConstantsts"></a>`rental-app-main/src/constants/paginationConstants.ts`

```typescript
// path: rental-app-main/src/constants/paginationConstants.ts

// src/constants/paginationConstants.ts

export const PAGINATION_CONSTANTS = {
    HOME_PAGE_SIZE: 12,
    ADMIN_PAGE_SIZE: 10,
};

```


## <a name="rentalappmainsrcconstantsstatusStylests"></a>`rental-app-main/src/constants/statusStyles.ts`

```typescript
// path: rental-app-main/src/constants/statusStyles.ts

// src/constants/statusStyles.ts

// –°—Ç–∏–ª–∏ –¥–ª—è –∫–∞—Ä—Ç–æ—á–µ–∫ –†–ï–ó–ï–†–í–û–í
export const RESERVATION_CARD_STYLES: Record<string, string> = {
    active: "bg-white hover:shadow-md",
    fulfilled: "bg-blue-50 border-blue-200 text-gray-800",
    cancelled: "bg-gray-100 border-gray-300 text-gray-600 hover:shadow-sm",
    overdue: "bg-orange-50 border-orange-200 text-gray-800",
    default: "bg-white hover:shadow-md"
};

// –°—Ç–∏–ª–∏ –¥–ª—è –∫–∞—Ä—Ç–æ—á–µ–∫ –ê–†–ï–ù–î–´
export const RENTAL_CARD_STYLES: Record<string, string> = {
    active: "bg-white hover:shadow-md",
    completed: "bg-gray-100 border-gray-200 text-gray-600 hover:shadow-sm",
    overdue: "bg-red-50/70 border-red-300",
    default: "bg-white hover:shadow-md"
};


```


## <a name="rentalappmainsrcconstantsuserConstantsts"></a>`rental-app-main/src/constants/userConstants.ts`

```typescript
// path: rental-app-main/src/constants/userConstants.ts

// src/constants/userConstants.ts

/**
 * –°–∏—Å—Ç–µ–º–Ω—ã–µ –∏–º–µ–Ω–∞ —Ä–æ–ª–µ–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π.
 * –ò—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è –¥–ª—è –æ–±—â–µ–Ω–∏—è —Å API –∏ –≤ –ª–æ–≥–∏–∫–µ.
 */
export const USER_ROLES = {
    USER: "user",
    MANAGER: "manager",
    ADMIN: "admin",
} as const;

// –°–æ–∑–¥–∞–µ–º —Ç–∏–ø –Ω–∞ –æ—Å–Ω–æ–≤–µ –∫–ª—é—á–µ–π –æ–±—ä–µ–∫—Ç–∞ USER_ROLES –¥–ª—è —É–¥–æ–±—Å—Ç–≤–∞
type UserRoleKey = keyof typeof USER_ROLES;

/**
 * –¢–∏–ø –¥–ª—è —Å–∏—Å—Ç–µ–º–Ω—ã—Ö –∏–º–µ–Ω —Ä–æ–ª–µ–π.
 * –ü—Ä–∏–º–µ—Ä: 'user' | 'manager' | 'admin'
 */
export type UserRole = (typeof USER_ROLES)[UserRoleKey];

// ‚úÖ –ò–ó–ú–ï–ù–ï–ù–ò–ï: –°–æ–∑–¥–∞–µ–º –º–∞—Å—Å–∏–≤ —Ä–æ–ª–µ–π –∏ —è–≤–Ω–æ —É–∫–∞–∑—ã–≤–∞–µ–º TypeScript,
// —á—Ç–æ —ç—Ç–æ –Ω–µ–ø—É—Å—Ç–æ–π –∫–æ—Ä—Ç–µ–∂ –∏–∑ –Ω–∞—à–∏—Ö –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã—Ö —Ä–æ–ª–µ–π.
// –≠—Ç–æ –∏ –µ—Å—Ç—å –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –æ—à–∏–±–∫–∏.
export const USER_ROLE_VALUES = Object.values(USER_ROLES) as [UserRole, ...UserRole[]];

/**
 * –ú–µ—Ç–∫–∏ —Ä–æ–ª–µ–π –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –≤ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–µ.
 */
export const USER_ROLE_LABELS: Record<UserRole, string> = {
    [USER_ROLES.USER]: "–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å",
    [USER_ROLES.MANAGER]: "–ú–µ–Ω–µ–¥–∂–µ—Ä",
    [USER_ROLES.ADMIN]: "–ê–¥–º–∏–Ω",
};

/**
 * –í–∞—Ä–∏–∞–Ω—Ç—ã (—Ü–≤–µ—Ç–∞) –¥–ª—è –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–∞ Badge –∏–∑ UI-–±–∏–±–ª–∏–æ—Ç–µ–∫–∏.
 */
export const USER_ROLE_BADGE_VARIANTS: Record<UserRole, "secondary" | "default" | "destructive"> = {
    [USER_ROLES.USER]: "secondary",
    [USER_ROLES.MANAGER]: "default",
    [USER_ROLES.ADMIN]: "destructive",
};

/**
 * –ü–æ–ª–Ω—ã–π –Ω–∞–±–æ—Ä –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –∫–∞–∂–¥–æ–π —Ä–æ–ª–∏, —É–¥–æ–±–Ω—ã–π –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ UI-—ç–ª–µ–º–µ–Ω—Ç–æ–≤.
 */
export const USER_ROLE_OPTIONS = (Object.keys(USER_ROLES) as UserRoleKey[]).map(key => ({
    value: USER_ROLES[key],
    label: USER_ROLE_LABELS[USER_ROLES[key]],
}));

```


## <a name="rentalappmainsrccontextsReservationEditContexttsx"></a>`rental-app-main/src/contexts/ReservationEditContext.tsx`

```tsx
// path: rental-app-main/src/contexts/ReservationEditContext.tsx

// src/contexts/ReservationEditContext.tsx

import { createContext, useContext } from 'react';
import type { AvailabilityInfo } from '@/types/availability';
import type { EditState } from '@/hooks/reservation/useReservationState';
import type { Equipment } from '@/types/equipment'; // ‚úÖ –î–æ–±–∞–≤–ª–µ–Ω –∏–º–ø–æ—Ä—Ç
import type { PriceDetails } from '@/hooks/reservation/usePriceCalculator';

export type ReservationEditContextValue = {
    reservationId: number;
    editState: EditState & { hasChanges: boolean; newlyAddedEquipmentIdsAsArray: number[] };
    availabilityMap: Record<number, AvailabilityInfo>;
    hasConflicts: boolean;
    isLoading: boolean;
    isCheckingAvailability: boolean;
    isSaving: boolean;
    isCalculatingPrice: boolean;
    isCancelling: boolean;
    isCancelConfirmationVisible: boolean;
    startEdit: () => void;
    cancelEdit: () => void;
    saveChanges: () => Promise<boolean | void>;
    // ‚úÖ –î–û–ë–ê–í–õ–ï–ù–´ –≠–¢–ò –î–í–ê –°–í–û–ô–°–¢–í–ê
    equipmentMap: Map<number, Equipment>;
    allEquipment: Equipment[];
    updateDates: (newStartDate: Date, newEndDate: Date) => void;
    addEquipmentItems: (itemsToAdd: any[]) => void;
    removeEquipmentItem: (idToRemove: number) => void;
    handleConfirmFullCancellation: () => Promise<void>;
    handleCloseCancellationDialog: () => void;
    financials: {
        dayCount: number;
        fullTotal: number;
        finalTotal: number;
        discountAmount: number;
        durationDiscountAmount: number;
        durationDiscountPercentage: number;
        promoDiscountAmount: number;
        promoCodePercentage: number;
        promoCodeMessage: string;
        promoCode: string;
    };
    priceDetails?: PriceDetails | null; // –î–æ–±–∞–≤–ª—è–µ–º priceDetails –∏–∑ usePriceCalculator
    setPromoCode: (code: string) => void;
    applyPromoCode: () => void;
    removePromoCode: () => void;
    localSelectedAccessories: Record<number, number[]>;
    toggleAccessory: (equipmentId: number, accessoryId: number) => void;
    holidayConflict: { message: string, suggested_end_date: string } | null;
    confirmHolidayAdjustment: () => void;
    cancelHolidayAdjustment: () => void;
};

export const ReservationEditContext = createContext<ReservationEditContextValue | null>(null);

export const useReservationEditContext = () => {
    const context = useContext(ReservationEditContext);
    if (!context) {
        throw new Error('useReservationEditContext must be used within a ReservationEditProvider');
    }
    return context;
};

```


## <a name="rentalappmainsrccoreservicesAccessoryServicets"></a>`rental-app-main/src/core/services/AccessoryService.ts`

```typescript
// path: rental-app-main/src/core/services/AccessoryService.ts

// src/core/services/AccessoryService.ts

import { api } from "@/lib/api";
import type { Accessory, AccessoryListResponse } from "@/types/accessory"; // –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ AccessoryListResponse –∏–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω

export interface AccessoryCreateInput {
    name: string;
    accessory_type: string;
    price: number;
    description?: string;
}

export interface AccessoryUpdateInput extends AccessoryCreateInput {
    id: number;
}

export interface AccessoryFilterOptions {
    search?: string;
    accessoryType?: string;
    minPrice?: number;
    maxPrice?: number;
}

export interface AccessoryValidationResult {
    isValid: boolean;
    errors: string[];
}

export class AccessoryService {
    /**
     * –ü–æ–ª—É—á–∞–µ—Ç –≤—Å–µ –∞–∫—Å–µ—Å—Å—É–∞—Ä—ã —Å –ø–∞–≥–∏–Ω–∞—Ü–∏–µ–π
     */
    static async getAllAccessories(skip: number, limit: number): Promise<AccessoryListResponse> {
        const response = await api.get("/accessories/", {
            params: { skip, limit }
        });
        // –í–ê–ñ–ù–û: API –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –æ–±—ä–µ–∫—Ç { items: [], total: 0 },
        // –∏ —Ç–µ–ø–µ—Ä—å –Ω–∞—à —Å–µ—Ä–≤–∏—Å –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ –µ–≥–æ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç.
        return response.data;
    }

    /**
     * –ü–æ–ª—É—á–∞–µ—Ç –∞–∫—Å–µ—Å—Å—É–∞—Ä –ø–æ ID
     */
    static async getAccessoryById(id: number): Promise<Accessory> {
        const response = await api.get(`/accessories/${id}`);
        return response.data;
    }

    /**
     * –°–æ–∑–¥–∞–µ—Ç –Ω–æ–≤—ã–π –∞–∫—Å–µ—Å—Å—É–∞—Ä
     */
    static async createAccessory(input: AccessoryCreateInput): Promise<Accessory> {
        const response = await api.post("/accessories/", input);
        return response.data;
    }

    /**
     * –û–±–Ω–æ–≤–ª—è–µ—Ç –∞–∫—Å–µ—Å—Å—É–∞—Ä
     */
    static async updateAccessory(input: AccessoryUpdateInput): Promise<Accessory> {
        const response = await api.put(`/accessories/${input.id}`, input);
        return response.data;
    }

    /**
     * –£–¥–∞–ª—è–µ—Ç –∞–∫—Å–µ—Å—Å—É–∞—Ä
     */
    static async deleteAccessory(id: number): Promise<void> {
        await api.delete(`/accessories/${id}`);
    }

    /**
     * –ü–æ–ª—É—á–∞–µ—Ç –∞–∫—Å–µ—Å—Å—É–∞—Ä—ã –¥–ª—è –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—è
     */
    static async getAccessoriesForEquipment(equipmentId: number): Promise<Accessory[]> {
        const response = await api.get(`/equipment/${equipmentId}/accessories`);
        return response.data;
    }

    /**
     * –§–∏–ª—å—Ç—Ä—É–µ—Ç –∞–∫—Å–µ—Å—Å—É–∞—Ä—ã –ø–æ –∑–∞–¥–∞–Ω–Ω—ã–º –∫—Ä–∏—Ç–µ—Ä–∏—è–º
     */
    static filterAccessories(
        accessories: Accessory[],
        filters: AccessoryFilterOptions
    ): Accessory[] {
        return accessories.filter(accessory => {
            // –§–∏–ª—å—Ç—Ä –ø–æ –ø–æ–∏—Å–∫—É
            if (filters.search) {
                const searchLower = filters.search.toLowerCase();
                const matchesSearch =
                    accessory.name.toLowerCase().includes(searchLower) ||
                    accessory.accessory_type.toLowerCase().includes(searchLower) ||
                    (accessory.description && accessory.description.toLowerCase().includes(searchLower));

                if (!matchesSearch) {
                    return false;
                }
            }

            // –§–∏–ª—å—Ç—Ä –ø–æ —Ç–∏–ø—É –∞–∫—Å–µ—Å—Å—É–∞—Ä–∞
            if (filters.accessoryType && accessory.accessory_type !== filters.accessoryType) {
                return false;
            }

            // –§–∏–ª—å—Ç—Ä –ø–æ –º–∏–Ω–∏–º–∞–ª—å–Ω–æ–π —Ü–µ–Ω–µ
            if (filters.minPrice !== undefined && accessory.price < filters.minPrice) {
                return false;
            }

            // –§–∏–ª—å—Ç—Ä –ø–æ –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–π —Ü–µ–Ω–µ
            if (filters.maxPrice !== undefined && accessory.price > filters.maxPrice) {
                return false;
            }

            return true;
        });
    }

    /**
     * –ì—Ä—É–ø–ø–∏—Ä—É–µ—Ç –∞–∫—Å–µ—Å—Å—É–∞—Ä—ã –ø–æ —Ç–∏–ø—É
     */
    static groupAccessoriesByType(accessories: Accessory[]): Record<string, Accessory[]> {
        return accessories.reduce((acc, accessory) => {
            const type = accessory.accessory_type;
            if (!acc[type]) {
                acc[type] = [];
            }
            acc[type].push(accessory);
            return acc;
        }, {} as Record<string, Accessory[]>);
    }

    /**
     * –°–æ—Ä—Ç–∏—Ä—É–µ—Ç –∞–∫—Å–µ—Å—Å—É–∞—Ä—ã –ø–æ –∑–∞–¥–∞–Ω–Ω–æ–º—É –∫—Ä–∏—Ç–µ—Ä–∏—é
     */
    static sortAccessories(
        accessories: Accessory[],
        sortBy: 'name' | 'accessory_type' | 'price',
        sortOrder: 'asc' | 'desc' = 'asc'
    ): Accessory[] {
        return [...accessories].sort((a, b) => {
            let aValue: any = a[sortBy];
            let bValue: any = b[sortBy];

            // –î–ª—è —á–∏—Å–µ–ª (price)
            if (sortBy === 'price') {
                aValue = Number(aValue) || 0;
                bValue = Number(bValue) || 0;
            }

            // –°—Ç—Ä–æ–∫–æ–≤–æ–µ —Å—Ä–∞–≤–Ω–µ–Ω–∏–µ
            if (typeof aValue === 'string' && typeof bValue === 'string') {
                aValue = aValue.toLowerCase();
                bValue = bValue.toLowerCase();
            }

            if (aValue < bValue) {
                return sortOrder === 'asc' ? -1 : 1;
            }
            if (aValue > bValue) {
                return sortOrder === 'asc' ? 1 : -1;
            }
            return 0;
        });
    }

    /**
     * –í–∞–ª–∏–¥–∏—Ä—É–µ—Ç –¥–∞–Ω–Ω—ã–µ –∞–∫—Å–µ—Å—Å—É–∞—Ä–∞
     */
    static validateAccessoryData(input: AccessoryCreateInput): AccessoryValidationResult {
        const errors: string[] = [];

        if (!input.name?.trim()) {
            errors.push("–ù–∞–∑–≤–∞–Ω–∏–µ –∞–∫—Å–µ—Å—Å—É–∞—Ä–∞ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ");
        }

        if (!input.accessory_type?.trim()) {
            errors.push("–¢–∏–ø –∞–∫—Å–µ—Å—Å—É–∞—Ä–∞ –æ–±—è–∑–∞—Ç–µ–ª–µ–Ω");
        }

        if (input.price <= 0) {
            errors.push("–¶–µ–Ω–∞ –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å –±–æ–ª—å—à–µ –Ω—É–ª—è");
        }

        return {
            isValid: errors.length === 0,
            errors
        };
    }

    /**
     * –†–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ—Ç –æ–±—â—É—é —Å—Ç–æ–∏–º–æ—Å—Ç—å –≤—ã–±—Ä–∞–Ω–Ω—ã—Ö –∞–∫—Å–µ—Å—Å—É–∞—Ä–æ–≤
     */
    static calculateAccessoriesTotal(
        selectedAccessories: Record<number, number[]>,
        allAccessories: Accessory[]
    ): number {
        let total = 0;

        Object.entries(selectedAccessories).forEach(([equipmentId, accessoryIds]) => {
            accessoryIds.forEach(accessoryId => {
                const accessory = allAccessories.find(acc => acc.id === accessoryId);
                if (accessory) {
                    total += accessory.price;
                }
            });
        });

        return total;
    }

    /**
     * –ü–æ–ª—É—á–∞–µ—Ç –∞–∫—Å–µ—Å—Å—É–∞—Ä—ã –ø–æ –∏—Ö ID
     */
    static getAccessoriesByIds(
        accessoryIds: number[],
        allAccessories: Accessory[]
    ): Accessory[] {
        return allAccessories.filter(accessory => accessoryIds.includes(accessory.id));
    }

    /**
     * –ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç –∫–ª—é—á –¥–ª—è –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏—è –∞–∫—Å–µ—Å—Å—É–∞—Ä–æ–≤
     */
    static generateAccessoriesCacheKey(filters?: AccessoryFilterOptions): string {
        return JSON.stringify(["accessories", filters]);
    }

    /**
     * –ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç –∫–ª—é—á –¥–ª—è –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏—è –∞–∫—Å–µ—Å—Å—É–∞—Ä–æ–≤ –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—è
     */
    static generateEquipmentAccessoriesCacheKey(equipmentId: number): string {
        return JSON.stringify(["equipment-accessories", equipmentId]);
    }
}

```


## <a name="rentalappmainsrccoreservicesAvailabilityServicets"></a>`rental-app-main/src/core/services/AvailabilityService.ts`

```typescript
// path: rental-app-main/src/core/services/AvailabilityService.ts

// src/core/services/AvailabilityService.ts

import { api } from "@/lib/api";
import { formatDate } from "@/lib/utils";
import type { AvailabilityInfo, AvailabilityListResponse, DayStatus } from "@/types/availability";

export interface AvailabilityStatusParams {
    equipmentIds: number[];
    startDate: Date;
    endDate: Date;
    excludeReservationId?: number;
}

export interface DailyStatusParams {
    equipmentIds: number[];
    startDate: Date;
    endDate: Date;
    excludeReservationId?: number;
}

export interface ConflictCheckParams {
    equipmentIds: number[];
    startDate: Date;
    endDate: Date;
    excludeReservationId?: number;
}

/**
 * –°–µ—Ä–≤–∏—Å –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å—é –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—è.
 * –¶–µ–Ω—Ç—Ä–∞–ª–∏–∑—É–µ—Ç –≤—Å–µ API-–∑–∞–ø—Ä–æ—Å—ã, —Å–≤—è–∑–∞–Ω–Ω—ã–µ —Å –ø—Ä–æ–≤–µ—Ä–∫–æ–π –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏.
 */
export class AvailabilityService {
    /**
     * –ü–æ–ª—É—á–∞–µ—Ç –æ–±—â–∏–π —Å—Ç–∞—Ç—É—Å (available, rented, reserved) –¥–ª—è —Å–ø–∏—Å–∫–∞ –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—è.
     * –í—ã–∑—ã–≤–∞–µ—Ç —ç–Ω–¥–ø–æ–∏–Ω—Ç /calendar/view.
     */
    static async getStatuses(params: AvailabilityStatusParams): Promise<AvailabilityInfo[]> {
        if (!params.startDate || !params.endDate || params.equipmentIds.length === 0) {
            return [];
        }

        const searchParams = new URLSearchParams();
        
        searchParams.append("start", formatDate(params.startDate));
        searchParams.append("end", formatDate(params.endDate));
        
        params.equipmentIds.forEach(id => {
            searchParams.append("ids", id.toString());
        });

        if (params.excludeReservationId !== undefined) {
            searchParams.append("exclude_reservation_id", params.excludeReservationId.toString());
        }

        const response = await api.get<AvailabilityListResponse>(`/calendar/view?${searchParams.toString()}`);
        return response.data.items;
    }

    /**
     * –ü–æ–ª—É—á–∞–µ—Ç —Å—Ç–∞—Ç—É—Å—ã –ø–æ –¥–Ω—è–º –¥–ª—è –∫–∞–ª–µ–Ω–¥–∞—Ä—è-–ø–æ–ª–æ—Å–∫–∏.
     * –í—ã–∑—ã–≤–∞–µ—Ç —ç–Ω–¥–ø–æ–∏–Ω—Ç /calendar/day-statuses.
     */
    static async getDailyStatuses(params: DailyStatusParams): Promise<Record<number, DayStatus[]>> {
        if (!params.startDate || !params.endDate || params.equipmentIds.length === 0) {
            return {};
        }

        const searchParams = new URLSearchParams();
        
        searchParams.append("start", formatDate(params.startDate));
        searchParams.append("end", formatDate(params.endDate));
        
        params.equipmentIds.forEach(id => {
            searchParams.append("ids", id.toString());
        });

        if (params.excludeReservationId !== undefined) {
            searchParams.append("exclude_reservation_id", params.excludeReservationId.toString());
        }

        const response = await api.get<Record<number, DayStatus[]>>(`/calendar/day-statuses?${searchParams.toString()}`);
        return response.data;
    }

    /**
     * –ü—Ä–æ–≤–µ—Ä—è–µ—Ç –∫–æ–Ω—Ñ–ª–∏–∫—Ç—ã –¥–ª—è —É–∫–∞–∑–∞–Ω–Ω–æ–≥–æ –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—è.
     * –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Å–ø–∏—Å–æ–∫ ID –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—è —Å –∫–æ–Ω—Ñ–ª–∏–∫—Ç–∞–º–∏.
     * –≠—Ç–æ—Ç –º–µ—Ç–æ–¥ –º–æ–∂–µ—Ç –±—ã—Ç—å –æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω—ã–º, –µ—Å–ª–∏ getStatuses –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏.
     */
    static async checkConflicts(params: ConflictCheckParams): Promise<number[]> {
        const statuses = await this.getStatuses(params);
        
        return statuses
            .filter(info => info.status === "reserved" || info.status === "rented")
            .map(info => info.equipment_id);
    }
}


```


## <a name="rentalappmainsrccoreservicesCalendarServicets"></a>`rental-app-main/src/core/services/CalendarService.ts`

```typescript
// path: rental-app-main/src/core/services/CalendarService.ts

// src/core/services/CalendarService.ts
import { api } from "@/lib/api";
import type { DayStatus } from "@/types/availability";
import type { Equipment } from "@/types/equipment";

export interface CalendarGridData {
  [equipmentId: number]: {
    [date: string]: DayStatus;
  };
}

export interface CalendarFilterOptions {
  type?: string;
  brand?: string;
  query?: string;
}

export class CalendarService {
  /**
   * –ü–æ–ª—É—á–∞–µ—Ç —Å—Ç–∞—Ç—É—Å—ã –¥–Ω–µ–π –¥–ª—è –∫–∞–ª–µ–Ω–¥–∞—Ä—è
   */
  static async getDayStatuses(
    startDate: string,
    endDate: string,
    equipmentIds: number[]
  ): Promise<CalendarGridData> {
    if (!startDate || !endDate) {
      console.warn(
        "[CalendarService] getDayStatuses –≤—ã–∑–≤–∞–Ω —Å –Ω–µ–≤–∞–ª–∏–¥–Ω—ã–º–∏ –¥–∞—Ç–∞–º–∏"
      );
      return {};
    }

    if (equipmentIds.length === 0) {
      console.warn(
        "[CalendarService] getDayStatuses –≤—ã–∑–≤–∞–Ω —Å –ø—É—Å—Ç—ã–º —Å–ø–∏—Å–∫–æ–º ID –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—è"
      );
      return {};
    }

    try {
      const response = await api.get("/calendar/day-statuses", {
        params: {
          start: startDate,
          end: endDate,
          ids: equipmentIds,
        },
      });

      console.log(
        "[CalendarService] API response for /calendar/day-statuses:",
        response
      );

      if (
        response?.data?.equipment_day_statuses !== undefined
      ) {
        return response.data.equipment_day_statuses;
      } else {
        console.error(
          "[CalendarService] API response did not contain 'equipment_day_statuses'",
          response?.data
        );
        return {};
      }
    } catch (error) {
      console.error(
        "[CalendarService] Error fetching /calendar/day-statuses:",
        error
      );
      throw error;
    }
  }

  /**
   * –§–∏–ª—å—Ç—Ä—É–µ—Ç –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏–µ –¥–ª—è –∫–∞–ª–µ–Ω–¥–∞—Ä—è –ø–æ –∑–∞–¥–∞–Ω–Ω—ã–º –∫—Ä–∏—Ç–µ—Ä–∏—è–º
   */
  static filterEquipmentForCalendar(
    equipment: Equipment[],
    options: CalendarFilterOptions
  ): number[] {
    return equipment
      .filter((item) => {
        // –§–∏–ª—å—Ç—Ä –ø–æ —Ç–∏–ø—É
        if (options.type && options.type !== item.equipment_type) {
          return false;
        }

        // –§–∏–ª—å—Ç—Ä –ø–æ –±—Ä–µ–Ω–¥—É
        if (options.brand && options.brand !== "__all__" && options.brand !== item.brand) {
          return false;
        }

        // –§–∏–ª—å—Ç—Ä –ø–æ –ø–æ–∏—Å–∫–æ–≤–æ–º—É –∑–∞–ø—Ä–æ—Å—É
        if (options.query) {
          const query = options.query.toLowerCase();
          const matchesQuery =
            item.name?.toLowerCase().includes(query) ||
            item.brand?.toLowerCase().includes(query) ||
            item.equipment_type?.toLowerCase().includes(query);
          
          if (!matchesQuery) {
            return false;
          }
        }

        return true;
      })
      .map((item) => item.id);
  }

  /**
   * –°–æ–∑–¥–∞–µ—Ç –∫–ª—é—á –∑–∞–ø—Ä–æ—Å–∞ –¥–ª—è –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏—è
   */
  static createQueryKey(
    startDate: string,
    endDate: string,
    equipmentIds: number[]
  ): string[] {
    return [
      "calendar-grid",
      startDate,
      endDate,
      JSON.stringify(equipmentIds.sort((a, b) => a - b)),
    ];
  }
} 

```


## <a name="rentalappmainsrccoreservicesDateServicets"></a>`rental-app-main/src/core/services/DateService.ts`

```typescript
// path: rental-app-main/src/core/services/DateService.ts

// src/core/services/DateService.ts

import { addDays, format } from 'date-fns';

export interface DateRange {
  startDate: Date;
  endDate: Date;
}

export interface DateRangeValidationResult {
  isValid: boolean;
  error?: string;
  adjustedRange?: DateRange;
}

export class DateService {
  /**
   * –ö–æ—Ä—Ä–µ–∫—Ç–∏—Ä—É–µ—Ç –¥–∞—Ç—É, –µ—Å–ª–∏ –æ–Ω–∞ –≤—ã–ø–∞–¥–∞–µ—Ç –Ω–∞ –≤—ã—Ö–æ–¥–Ω–æ–π, —Å–¥–≤–∏–≥–∞—è –µ—ë –Ω–∞ –±–ª–∏–∂–∞–π—à–∏–π —Ä–∞–±–æ—á–∏–π –¥–µ–Ω—å.
   * @param date - –ü—Ä–æ–≤–µ—Ä—è–µ–º–∞—è –¥–∞—Ç–∞
   * @param holidays - –ú–∞—Å—Å–∏–≤ –¥–∞—Ç-–≤—ã—Ö–æ–¥–Ω—ã—Ö
   * @returns –°–∫–æ—Ä—Ä–µ–∫—Ç–∏—Ä–æ–≤–∞–Ω–Ω–∞—è –¥–∞—Ç–∞
   */
  static adjustDateIfHoliday(date: Date, holidays: Date[]): Date {
    let adjustedDate = new Date(date);
    const holidaySet = new Set(holidays.map(h => format(h, 'yyyy-MM-dd')));

    // –ü–æ–∫–∞ –∏—Ç–æ–≥–æ–≤–∞—è –¥–∞—Ç–∞ —è–≤–ª—è–µ—Ç—Å—è –≤—ã—Ö–æ–¥–Ω—ã–º, –¥–æ–±–∞–≤–ª—è–µ–º –æ–¥–∏–Ω –¥–µ–Ω—å
    while (holidaySet.has(format(adjustedDate, 'yyyy-MM-dd'))) {
      adjustedDate = addDays(adjustedDate, 1);
    }
    return adjustedDate;
  }

  /**
   * –í–∞–ª–∏–¥–∏—Ä—É–µ—Ç –¥–∏–∞–ø–∞–∑–æ–Ω –¥–∞—Ç
   */
  static validateDateRange(startDate: Date, endDate: Date): DateRangeValidationResult {
    if (!startDate || !endDate) {
      return {
        isValid: false,
        error: '–î–∞—Ç—ã –Ω–∞—á–∞–ª–∞ –∏ –æ–∫–æ–Ω—á–∞–Ω–∏—è –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã'
      };
    }

    if (isNaN(startDate.getTime()) || isNaN(endDate.getTime())) {
      return {
        isValid: false,
        error: '–ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç –¥–∞—Ç—ã'
      };
    }

    if (startDate >= endDate) {
      return {
        isValid: false,
        error: '–î–∞—Ç–∞ –æ–∫–æ–Ω—á–∞–Ω–∏—è –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å –ø–æ–∑–∂–µ –¥–∞—Ç—ã –Ω–∞—á–∞–ª–∞'
      };
    }

    return {
      isValid: true
    };
  }

  /**
   * –ö–æ—Ä—Ä–µ–∫—Ç–∏—Ä—É–µ—Ç –¥–∏–∞–ø–∞–∑–æ–Ω –¥–∞—Ç, –µ—Å–ª–∏ endDate —Ä–∞–Ω—å—à–µ startDate
   */
  static adjustDateRange(startDate: Date, endDate: Date): DateRange {
    if (startDate >= endDate) {
      const adjustedEndDate = new Date(startDate);
      adjustedEndDate.setDate(adjustedEndDate.getDate() + 1);
      return {
        startDate,
        endDate: adjustedEndDate
      };
    }

    return { startDate, endDate };
  }

  /**
   * –ü—Ä–æ–≤–µ—Ä—è–µ—Ç, —è–≤–ª—è–µ—Ç—Å—è –ª–∏ –¥–∞—Ç–∞ –≤–∞–ª–∏–¥–Ω–æ–π
   */
  static isValidDate(date: Date): boolean {
    return date instanceof Date && !isNaN(date.getTime());
  }

  /**
   * –°–æ–∑–¥–∞–µ—Ç —Å–ª–µ–¥—É—é—â—É—é –¥–∞—Ç—É –ø–æ—Å–ª–µ —É–∫–∞–∑–∞–Ω–Ω–æ–π
   */
  static getNextDay(date: Date): Date {
    const nextDay = new Date(date);
    nextDay.setDate(nextDay.getDate() + 1);
    return nextDay;
  }

  /**
   * –°–æ–∑–¥–∞–µ—Ç –ø—Ä–µ–¥—ã–¥—É—â—É—é –¥–∞—Ç—É –ø–µ—Ä–µ–¥ —É–∫–∞–∑–∞–Ω–Ω–æ–π
   */
  static getPreviousDay(date: Date): Date {
    const previousDay = new Date(date);
    previousDay.setDate(previousDay.getDate() - 1);
    return previousDay;
  }

  /**
   * –í—ã—á–∏—Å–ª—è–µ—Ç –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –¥–Ω–µ–π –º–µ–∂–¥—É –¥–≤—É–º—è –¥–∞—Ç–∞–º–∏
   */
  static getDaysDifference(startDate: Date, endDate: Date): number {
    const timeDiff = endDate.getTime() - startDate.getTime();
    return Math.ceil(timeDiff / (1000 * 3600 * 24));
  }

  /**
   * –ü—Ä–æ–≤–µ—Ä—è–µ—Ç, –Ω–∞—Ö–æ–¥–∏—Ç—Å—è –ª–∏ –¥–∞—Ç–∞ –≤ –∑–∞–¥–∞–Ω–Ω–æ–º –¥–∏–∞–ø–∞–∑–æ–Ω–µ
   */
  static isDateInRange(date: Date, startDate: Date, endDate: Date): boolean {
    return date >= startDate && date <= endDate;
  }

  /**
   * –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ—Ç –¥–∞—Ç—É –≤ —Å—Ç—Ä–æ–∫—É –¥–ª—è API (YYYY-MM-DD)
   */
  static formatDateForAPI(date: Date): string {
    return date.toISOString().split('T')[0];
  }

  /**
   * –ü–∞—Ä—Å–∏—Ç —Å—Ç—Ä–æ–∫—É –¥–∞—Ç—ã –≤ –æ–±—ä–µ–∫—Ç Date
   */
  static parseDate(dateString: string): Date | null {
    const date = new Date(dateString);
    return this.isValidDate(date) ? date : null;
  }

  /**
   * –ù–∞—Ö–æ–¥–∏—Ç —Å–ª–µ–¥—É—é—â–∏–π —Ä–∞–±–æ—á–∏–π –¥–µ–Ω—å, –∏—Å–∫–ª—é—á–∞—è –ø—Ä–∞–∑–¥–Ω–∏–∫–∏
   * @param startDate - –Ω–∞—á–∞–ª—å–Ω–∞—è –¥–∞—Ç–∞
   * @param holidays - –º–∞—Å—Å–∏–≤ –¥–∞—Ç –ø—Ä–∞–∑–¥–Ω–∏–∫–æ–≤
   * @param daysToAdd - –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –¥–Ω–µ–π –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é 1)
   * @returns –î–∞—Ç–∞ —Å–ª–µ–¥—É—é—â–µ–≥–æ —Ä–∞–±–æ—á–µ–≥–æ –¥–Ω—è
   */
  static findNextWorkingDay(startDate: Date, holidays: Date[], daysToAdd: number = 1): Date {
    let finalDate = addDays(startDate, daysToAdd);

    // –°–æ–∑–¥–∞–µ–º Set –∏–∑ –¥–∞—Ç –ø—Ä–∞–∑–¥–Ω–∏–∫–æ–≤ –¥–ª—è –±—ã—Å—Ç—Ä–æ–π –ø—Ä–æ–≤–µ—Ä–∫–∏
    const holidaySet = new Set(holidays.map(h => format(h, 'yyyy-MM-dd')));

    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–µ —è–≤–ª—è–µ—Ç—Å—è –ª–∏ –∫–æ–Ω–µ—á–Ω–∞—è –¥–∞—Ç–∞ –≤—ã—Ö–æ–¥–Ω—ã–º.
    // –ï—Å–ª–∏ –¥–∞, —Å–¥–≤–∏–≥–∞–µ–º –µ–µ –≤–ø–µ—Ä–µ–¥ –¥–æ —Ç–µ—Ö –ø–æ—Ä, –ø–æ–∫–∞ –Ω–µ –Ω–∞–π–¥–µ–º —Ä–∞–±–æ—á–∏–π –¥–µ–Ω—å.
    while (holidaySet.has(format(finalDate, 'yyyy-MM-dd'))) {
      finalDate = addDays(finalDate, 1);
    }

    return finalDate;
  }

  /**
   * –°–æ–∑–¥–∞–µ—Ç –¥–∏–∞–ø–∞–∑–æ–Ω –¥–∞—Ç —Å –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–º –ø–æ–∏—Å–∫–æ–º —Ä–∞–±–æ—á–µ–≥–æ –¥–Ω—è –æ–∫–æ–Ω—á–∞–Ω–∏—è
   * @param startDate - –¥–∞—Ç–∞ –Ω–∞—á–∞–ª–∞
   * @param holidays - –º–∞—Å—Å–∏–≤ –¥–∞—Ç –ø—Ä–∞–∑–¥–Ω–∏–∫–æ–≤
   * @param daysToAdd - –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –¥–Ω–µ–π –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é 1)
   * @returns –û–±—ä–µ–∫—Ç —Å –¥–∞—Ç–∞–º–∏ –Ω–∞—á–∞–ª–∞ –∏ –æ–∫–æ–Ω—á–∞–Ω–∏—è
   */
  static createWorkingDayRange(startDate: Date, holidays: Date[], daysToAdd: number = 1): DateRange {
    const endDate = this.findNextWorkingDay(startDate, holidays, daysToAdd);
    return {
      startDate,
      endDate
    };
  }
}

```


## <a name="rentalappmainsrccoreservicesEquipmentServicets"></a>`rental-app-main/src/core/services/EquipmentService.ts`

```typescript
// path: rental-app-main/src/core/services/EquipmentService.ts

// src/core/services/EquipmentService.ts

import { api } from "@/lib/api";
import type { Equipment } from "@/types/equipment";
import type { AvailabilityInfo, AvailabilityListResponse } from "@/types/availability";
import { formatDate } from "@/lib/utils"; // 1. –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ —ç—Ç–æ—Ç –∏–º–ø–æ—Ä—Ç –ø—Ä–∏—Å—É—Ç—Å—Ç–≤—É–µ—Ç

export interface EquipmentListResponse {
    items: Equipment[];
    total: number;
}

export interface EquipmentFilterParams {
    query?: string;
    type?: string | null;
    brand?: string | null;
    associationId?: number | null;
    startDate?: Date | null;
    endDate?: Date | null;
    availableOnly?: boolean;
}

export class EquipmentService {
    static async getAllEquipment(
        skip: number,
        limit: number,
        filters: EquipmentFilterParams = {}
    ): Promise<EquipmentListResponse> {
        const params: Record<string, any> = { skip, limit };

        if (filters.query) {
            params.query = filters.query;
        }
        if (filters.type) {
            params.type = filters.type;
        }
        if (filters.brand) {
            params.brand = filters.brand;
        }
        if (filters.associationId) {
            params.associationId = filters.associationId;
        }

        if (filters.availableOnly && filters.startDate && filters.endDate) {
            params.availableOnly = true;
            params.startDate = formatDate(filters.startDate);
            params.endDate = formatDate(filters.endDate);
        }

        const response = await api.get<EquipmentListResponse>("/equipment/", { params });
        return response.data;
    }

    static async checkAvailability(input: { ids: number[]; start: Date | null; end: Date | null; excludeReservationId?: number; }): Promise<AvailabilityInfo[]> {
        if (!input.start || !input.end || input.ids.length === 0) {
            return [];
        }

        const searchParams = new URLSearchParams();

        // V-- 2. –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï –ó–î–ï–°–¨ --V
        searchParams.append("start", formatDate(input.start));
        searchParams.append("end", formatDate(input.end));
        // ^-- –ö–û–ù–ï–¶ –ò–°–ü–†–ê–í–õ–ï–ù–ò–Ø --^

        input.ids.forEach(id => {
            searchParams.append("ids", id.toString());
        });

        if (input.excludeReservationId !== undefined) {
            searchParams.append("exclude_reservation_id", input.excludeReservationId.toString());
        }

        const response = await api.get<AvailabilityListResponse>(`/calendar/view?${searchParams.toString()}`);
        return response.data.items;
    }

    static filterAndGroupEquipment(
        allEquipment: Equipment[],
        searchQuery: string
    ): { tree: Record<string, Record<string, Equipment[]>>; visibleIds: number[] } {
        const lowerCaseQuery = searchQuery.toLowerCase();
        const filtered = searchQuery
            ? allEquipment.filter(item =>
                item.name.toLowerCase().includes(lowerCaseQuery) ||
                item.brand.toLowerCase().includes(lowerCaseQuery) ||
                item.equipment_type.toLowerCase().includes(lowerCaseQuery)
            )
            : allEquipment;

        const visibleIds = filtered.map(item => item.id);

        const tree: Record<string, Record<string, Equipment[]>> = {};
        for (const eq of filtered) {
            if (!tree[eq.equipment_type]) {
                tree[eq.equipment_type] = {};
            }
            if (!tree[eq.equipment_type][eq.brand]) {
                tree[eq.equipment_type][eq.brand] = [];
            }
            tree[eq.equipment_type][eq.brand].push(eq);
        }

        return { tree, visibleIds };
    }

    static filterEquipment(
        equipmentData: Equipment[],
        params: EquipmentFilterParams
    ): Equipment[] {
        let result = equipmentData;
        if (params.query) {
            const lowerCaseQuery = params.query.toLowerCase();
            result = result.filter((item) =>
                item.name.toLowerCase().includes(lowerCaseQuery) ||
                item.brand.toLowerCase().includes(lowerCaseQuery) ||
                item.equipment_type.toLowerCase().includes(lowerCaseQuery)
            );
        }
        if (params.type) {
            result = result.filter((item) => item.equipment_type === params.type);
        }
        if (params.brand && params.brand !== "__all__") {
            result = result.filter((item) => item.brand === params.brand);
        }
        return result;
    }

    static async getEquipmentById(id: number): Promise<Equipment> {
        const response = await api.get(`/equipment/${id}`);
        return response.data;
    }

    static async createEquipment(input: Omit<Equipment, 'id' | 'accessories' | 'associations'>): Promise<Equipment> {
        const response = await api.post("/equipment/", input);
        return response.data;
    }

    static async updateEquipment(id: number, input: Partial<Omit<Equipment, 'id'>>): Promise<Equipment> {
        const response = await api.put(`/equipment/${id}`, input);
        return response.data;
    }

    static async deleteEquipment(id: number): Promise<void> {
        await api.delete(`/equipment/${id}`);
    }
}

```


## <a name="rentalappmainsrccoreservicesPhoneServicets"></a>`rental-app-main/src/core/services/PhoneService.ts`

```typescript
// path: rental-app-main/src/core/services/PhoneService.ts

// src/core/services/PhoneService.ts

export interface PhoneValidationResult {
  isValid: boolean;
  error?: string;
  normalizedPhone?: string;
}

export class PhoneService {
  /**
   * –í–∞–ª–∏–¥–∏—Ä—É–µ—Ç —Ä–æ—Å—Å–∏–π—Å–∫–∏–π —Ç–µ–ª–µ—Ñ–æ–Ω–Ω—ã–π –Ω–æ–º–µ—Ä
   */
  static validate(phone: string): PhoneValidationResult {
    if (!phone) {
      return {
        isValid: false,
        error: '–ù–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞ –æ–±—è–∑–∞—Ç–µ–ª–µ–Ω'
      };
    }

    const normalized = this.normalize(phone);
    
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –Ω–æ–º–µ—Ä —Å–æ–¥–µ—Ä–∂–∏—Ç —Ç–æ–ª—å–∫–æ —Ü–∏—Ñ—Ä—ã
    if (!/^\d+$/.test(normalized)) {
      return {
        isValid: false,
        error: '–ù–æ–º–µ—Ä –¥–æ–ª–∂–µ–Ω —Å–æ–¥–µ—Ä–∂–∞—Ç—å —Ç–æ–ª—å–∫–æ —Ü–∏—Ñ—Ä—ã'
      };
    }

    // –ü—Ä–æ–≤–µ—Ä—è–µ–º –¥–ª–∏–Ω—É (10 –∏–ª–∏ 11 —Ü–∏—Ñ—Ä –¥–ª—è —Ä–æ—Å—Å–∏–π—Å–∫–∏—Ö –Ω–æ–º–µ—Ä–æ–≤)
    if (normalized.length < 10 || normalized.length > 11) {
      return {
        isValid: false,
        error: '–ù–æ–º–µ—Ä –¥–æ–ª–∂–µ–Ω —Å–æ–¥–µ—Ä–∂–∞—Ç—å 10 –∏–ª–∏ 11 —Ü–∏—Ñ—Ä'
      };
    }

    // –ï—Å–ª–∏ 11 —Ü–∏—Ñ—Ä, –ø–µ—Ä–≤–∞—è –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å 7 –∏–ª–∏ 8
    if (normalized.length === 11 && !['7', '8'].includes(normalized[0])) {
      return {
        isValid: false,
        error: '–ù–æ–º–µ—Ä –¥–æ–ª–∂–µ–Ω –Ω–∞—á–∏–Ω–∞—Ç—å—Å—è —Å 7 –∏–ª–∏ 8'
      };
    }

    return {
      isValid: true,
      normalizedPhone: normalized
    };
  }

  /**
   * –ù–æ—Ä–º–∞–ª–∏–∑—É–µ—Ç —Ç–µ–ª–µ—Ñ–æ–Ω–Ω—ã–π –Ω–æ–º–µ—Ä (—É–±–∏—Ä–∞–µ—Ç –≤—Å–µ —Å–∏–º–≤–æ–ª—ã –∫—Ä–æ–º–µ —Ü–∏—Ñ—Ä)
   */
  static normalize(phone: string): string {
    return phone.replace(/\D/g, '');
  }

  /**
   * –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ—Ç —Ç–µ–ª–µ—Ñ–æ–Ω–Ω—ã–π –Ω–æ–º–µ—Ä –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è
   */
  static format(phone: string): string {
    const normalized = this.normalize(phone);
    
    if (normalized.length === 11) {
      // +7 (XXX) XXX-XX-XX
      return `+7 (${normalized.slice(1, 4)}) ${normalized.slice(4, 7)}-${normalized.slice(7, 9)}-${normalized.slice(9)}`;
    } else if (normalized.length === 10) {
      // +7 (XXX) XXX-XX-XX (–¥–æ–±–∞–≤–ª—è–µ–º 7 –≤ –Ω–∞—á–∞–ª–æ)
      return `+7 (${normalized.slice(0, 3)}) ${normalized.slice(3, 6)}-${normalized.slice(6, 8)}-${normalized.slice(8)}`;
    }
    
    return phone; // –í–æ–∑–≤—Ä–∞—â–∞–µ–º –∫–∞–∫ –µ—Å—Ç—å, –µ—Å–ª–∏ –Ω–µ —É–¥–∞–µ—Ç—Å—è –æ—Ç—Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞—Ç—å
  }

  /**
   * –ü–æ–ª—É—á–∞–µ—Ç –ø–æ–ª–Ω—ã–π –Ω–æ–º–µ—Ä –¥–ª—è API (–≤—Å–µ–≥–¥–∞ 11 —Ü–∏—Ñ—Ä —Å 7 –≤ –Ω–∞—á–∞–ª–µ)
   */
  static getFullNumber(phone: string): string {
    const normalized = this.normalize(phone);
    
    if (normalized.length === 11) {
      return normalized;
    } else if (normalized.length === 10) {
      return `7${normalized}`;
    }
    
    return normalized; // –í–æ–∑–≤—Ä–∞—â–∞–µ–º –∫–∞–∫ –µ—Å—Ç—å, –µ—Å–ª–∏ –Ω–µ —É–¥–∞–µ—Ç—Å—è –æ–±—Ä–∞–±–æ—Ç–∞—Ç—å
  }
} 

```


## <a name="rentalappmainsrccoreservicesPromoCodeServicets"></a>`rental-app-main/src/core/services/PromoCodeService.ts`

```typescript
// path: rental-app-main/src/core/services/PromoCodeService.ts

// src/core/services/PromoCodeService.ts

import { api } from "@/lib/api";
import type { PromoCodeOut, PromoCodeCreate, PromoCodeUpdate } from "@/types/promo_code";

export interface PromoCodeValidationResult {
    isValid: boolean;
    message: string | null;
    discountPercentage: number;
}

export interface PromoCodeFilterOptions {
    isActive?: boolean;
    search?: string;
}

export class PromoCodeService {
    /**
     * –ü–æ–ª—É—á–∞–µ—Ç –≤—Å–µ –ø—Ä–æ–º–æ–∫–æ–¥—ã
     */
    static async getAllPromoCodes(): Promise<PromoCodeOut[]> {
        const response = await api.get("/promocodes/");
        return response.data;
    }

    /**
     * –ü–æ–ª—É—á–∞–µ—Ç –ø—Ä–æ–º–æ–∫–æ–¥ –ø–æ ID
     */
    static async getPromoCodeById(id: number): Promise<PromoCodeOut> {
        const response = await api.get(`/promocodes/${id}`);
        return response.data;
    }

    /**
     * –°–æ–∑–¥–∞–µ—Ç –Ω–æ–≤—ã–π –ø—Ä–æ–º–æ–∫–æ–¥
     */
    static async createPromoCode(input: PromoCodeCreate): Promise<PromoCodeOut> {
        const response = await api.post("/promocodes/", input);
        return response.data;
    }

    /**
     * –û–±–Ω–æ–≤–ª—è–µ—Ç –ø—Ä–æ–º–æ–∫–æ–¥
     */
    static async updatePromoCode(id: number, input: PromoCodeUpdate): Promise<PromoCodeOut> {
        const response = await api.put(`/promocodes/${id}`, input);
        return response.data;
    }

    /**
     * –£–¥–∞–ª—è–µ—Ç –ø—Ä–æ–º–æ–∫–æ–¥
     */
    static async deletePromoCode(id: number): Promise<void> {
        await api.delete(`/promocodes/${id}`);
    }

    /**
     * –ê–∫—Ç–∏–≤–∏—Ä—É–µ—Ç/–¥–µ–∞–∫—Ç–∏–≤–∏—Ä—É–µ—Ç –ø—Ä–æ–º–æ–∫–æ–¥
     */
    static async togglePromoCodeStatus(id: number, isActive: boolean): Promise<PromoCodeOut> {
        const response = await api.patch(`/promocodes/${id}/toggle-status`, { is_active: isActive });
        return response.data;
    }

    /**
     * –í–∞–ª–∏–¥–∏—Ä—É–µ—Ç –ø—Ä–æ–º–æ–∫–æ–¥ –¥–ª—è –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ –∑–∞–∫–∞–∑–∞
     */
    static async validatePromoCode(
        code: string,
        equipmentIds: number[],
        totalAmount: number,
        userId?: number
    ): Promise<PromoCodeValidationResult> {
        try {
            const response = await api.post("/promocodes/validate", {
                code,
                equipment_ids: equipmentIds,
                total_amount: totalAmount,
                user_id: userId
            });
            return response.data;
        } catch (error: any) {
            return {
                isValid: false,
                message: error.response?.data?.detail || "–ü—Ä–æ–º–æ–∫–æ–¥ –Ω–µ–¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª–µ–Ω",
                discountPercentage: 0
            };
        }
    }

    /**
     * –§–∏–ª—å—Ç—Ä—É–µ—Ç –ø—Ä–æ–º–æ–∫–æ–¥—ã –ø–æ –∑–∞–¥–∞–Ω–Ω—ã–º –∫—Ä–∏—Ç–µ—Ä–∏—è–º
     */
    static filterPromoCodes(
        promoCodes: PromoCodeOut[],
        filters: PromoCodeFilterOptions
    ): PromoCodeOut[] {
        return promoCodes.filter(promo => {
            // –§–∏–ª—å—Ç—Ä –ø–æ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏
            if (filters.isActive !== undefined && promo.is_active !== filters.isActive) {
                return false;
            }

            // –§–∏–ª—å—Ç—Ä –ø–æ –ø–æ–∏—Å–∫—É
            if (filters.search) {
                const searchLower = filters.search.toLowerCase();
                const matchesSearch = 
                    promo.code.toLowerCase().includes(searchLower) ||
                    (promo.description && promo.description.toLowerCase().includes(searchLower));
                
                if (!matchesSearch) {
                    return false;
                }
            }

            return true;
        });
    }

    /**
     * –í–∞–ª–∏–¥–∏—Ä—É–µ—Ç –¥–∞–Ω–Ω—ã–µ –ø—Ä–æ–º–æ–∫–æ–¥–∞ –ø–µ—Ä–µ–¥ —Å–æ–∑–¥–∞–Ω–∏–µ–º/–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ–º
     */
    static validatePromoCodeData(input: PromoCodeCreate): { isValid: boolean; errors: string[] } {
        const errors: string[] = [];

        if (!input.code?.trim()) {
            errors.push("–ö–æ–¥ –ø—Ä–æ–º–æ–∫–æ–¥–∞ –æ–±—è–∑–∞—Ç–µ–ª–µ–Ω");
        }

        if (input.discount_percentage <= 0 || input.discount_percentage > 100) {
            errors.push("–ü—Ä–æ—Ü–µ–Ω—Ç —Å–∫–∏–¥–∫–∏ –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –æ—Ç 1 –¥–æ 100");
        }

        if (input.valid_from && input.expires_at) {
            const validFrom = new Date(input.valid_from);
            const expiresAt = new Date(input.expires_at);
            
            if (validFrom >= expiresAt) {
                errors.push("–î–∞—Ç–∞ –æ–∫–æ–Ω—á–∞–Ω–∏—è –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å –ø–æ–∑–∂–µ –¥–∞—Ç—ã –Ω–∞—á–∞–ª–∞");
            }
        }

        if (input.max_uses !== null && input.max_uses <= 0) {
            errors.push("–ú–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–π –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å –±–æ–ª—å—à–µ –Ω—É–ª—è");
        }

        if (input.max_uses_per_user !== null && input.max_uses_per_user <= 0) {
            errors.push("–ú–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–π –Ω–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å –±–æ–ª—å—à–µ –Ω—É–ª—è");
        }

        if (input.min_order_amount !== null && input.min_order_amount <= 0) {
            errors.push("–ú–∏–Ω–∏–º–∞–ª—å–Ω–∞—è —Å—É–º–º–∞ –∑–∞–∫–∞–∑–∞ –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å –±–æ–ª—å—à–µ –Ω—É–ª—è");
        }

        return {
            isValid: errors.length === 0,
            errors
        };
    }

    /**
     * –ü—Ä–æ–≤–µ—Ä—è–µ—Ç, –∞–∫—Ç–∏–≤–µ–Ω –ª–∏ –ø—Ä–æ–º–æ–∫–æ–¥ –≤ –¥–∞–Ω–Ω—ã–π –º–æ–º–µ–Ω—Ç
     */
    static isPromoCodeActive(promoCode: PromoCodeOut): boolean {
        if (!promoCode.is_active) {
            return false;
        }

        const now = new Date();

        // –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–∞—Ç—ã –Ω–∞—á–∞–ª–∞
        if (promoCode.valid_from) {
            const validFrom = new Date(promoCode.valid_from);
            if (now < validFrom) {
                return false;
            }
        }

        // –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–∞—Ç—ã –æ–∫–æ–Ω—á–∞–Ω–∏—è
        if (promoCode.expires_at) {
            const expiresAt = new Date(promoCode.expires_at);
            if (now > expiresAt) {
                return false;
            }
        }

        // –ü—Ä–æ–≤–µ—Ä–∫–∞ –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–≥–æ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–π
        if (promoCode.max_uses !== null && promoCode.times_used >= promoCode.max_uses) {
            return false;
        }

        return true;
    }

    /**
     * –ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç –∫–ª—é—á –¥–ª—è –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏—è –ø—Ä–æ–º–æ–∫–æ–¥–æ–≤
     */
    static generatePromoCodesCacheKey(filters?: PromoCodeFilterOptions): string {
        return JSON.stringify(["promo-codes", filters]);
    }

    /**
     * –ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç –∫–ª—é—á –¥–ª—è –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏—è –≤–∞–ª–∏–¥–∞—Ü–∏–∏ –ø—Ä–æ–º–æ–∫–æ–¥–∞
     */
    static generateValidationCacheKey(
        code: string,
        equipmentIds: number[],
        totalAmount: number,
        userId?: number
    ): string {
        return JSON.stringify([
            "promo-code-validation",
            code,
            equipmentIds.sort(),
            totalAmount,
            userId
        ]);
    }
} 

```


## <a name="rentalappmainsrccoreservicesReservationServicets"></a>`rental-app-main/src/core/services/ReservationService.ts`

```typescript
// path: rental-app-main/src/core/services/ReservationService.ts

// src/core/services/ReservationService.ts

import { api } from "@/lib/api";
import type { Equipment } from "@/types/equipment";
import type { Reservation, ReservationWithNames, ReservationListResponse } from "@/types/reservation";

// –ï–¥–∏–Ω—ã–π —Ç–∏–ø –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è —Ä–µ–∑–µ—Ä–≤–∞, –∫–æ—Ç–æ—Ä—ã–π –±—É–¥–µ—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å—Å—è –≤–µ–∑–¥–µ
export interface ReservationCreateInput {
    user_id?: number;
    start_date: string;
    end_date: string;
    equipment_ids: number[];
    selected_accessories: Record<number, number[]>;
    promo_code?: string;
}

export interface ReservationUpdateInput {
    id: number;
    start_date: string;
    end_date: string;
    equipment_ids: number[];
    selected_accessories: Record<number, number[]>;
    promo_code?: string;
    isAdminContext?: boolean;
}

export class ReservationService {
    /**
     * –†–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ—Ç —Å—Ç–æ–∏–º–æ—Å—Ç—å —Ä–µ–∑–µ—Ä–≤–∞
     */
    static async calculatePrice(input: Omit<ReservationCreateInput, 'user_id'>): Promise<any> {
        const payload = {
            ...input,
            selected_accessories: input.selected_accessories || {},
            promo_code: input.promo_code || null,
        };

        const response = await api.post("/reservations/calculate", payload);
        return response.data;
    }

    /**
     * –°–æ–∑–¥–∞–µ—Ç –Ω–æ–≤—ã–π —Ä–µ–∑–µ—Ä–≤
     */
    static async createReservation(input: ReservationCreateInput) {
        const { user_id, ...payload } = input;
        const finalPayload = user_id !== undefined ? { user_id, ...payload } : payload;

        const response = await api.post("/reservations/", finalPayload);
        return response.data;
    }

    /**
     * –û–±–Ω–æ–≤–ª—è–µ—Ç —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π —Ä–µ–∑–µ—Ä–≤
     */
    static async updateReservation(input: ReservationUpdateInput) {
        const { isAdminContext, id, ...payload } = input;
        const url = isAdminContext
            ? `/admin/reservations/${id}`
            : `/reservations/${id}`;

        const response = await api.put(url, payload);
        return response.data;
    }

    /**
     * –û—Ç–º–µ–Ω—è–µ—Ç —Ä–µ–∑–µ—Ä–≤
     */
    static async cancelReservation(id: number) {
        const response = await api.delete(`/reservations/${id}`);
        return response.data;
    }

    /**
     * –ü–æ–ª—É—á–∞–µ—Ç —Å–ø–∏—Å–æ–∫ —Ä–µ–∑–µ—Ä–≤–æ–≤ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
     */
    static async getUserReservations(params?: { search?: string; status?: string; sort?: string }): Promise<Reservation[]> {
        // –£–∫–∞–∑—ã–≤–∞–µ–º, —á—Ç–æ –æ–∂–∏–¥–∞–µ–º –æ–±—ä–µ–∫—Ç —Å –ø–∞–≥–∏–Ω–∞—Ü–∏–µ–π
        const response = await api.get<ReservationListResponse>("/reservations/", {
            params: params ? {
                search: params.search,
                status: params.status,
                sort: params.sort
            } : undefined
        });
        // –í–æ–∑–≤—Ä–∞—â–∞–µ–º —Ç–æ–ª—å–∫–æ –º–∞—Å—Å–∏–≤ items
        return response.data.items;
    }

    /**
     * –ü–æ–ª—É—á–∞–µ—Ç –≤—Å–µ —Ä–µ–∑–µ—Ä–≤—ã (–¥–ª—è –∞–¥–º–∏–Ω–∞)
     */
    static async getAllReservations() {
        // –ü—Ä–∏–º–µ—á–∞–Ω–∏–µ: —ç—Ç–æ—Ç –º–µ—Ç–æ–¥ –Ω–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–ª—è –ø–∞–≥–∏–Ω–∞—Ü–∏–∏, –Ω–æ –æ—Å—Ç–∞–≤–ª–µ–Ω –¥–ª—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏.
        // –î–ª—è –ø–∞–≥–∏–Ω–∏—Ä–æ–≤–∞–Ω–Ω–æ–≥–æ —Å–ø–∏—Å–∫–∞ –∞–¥–º–∏–Ω–∞ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è /admin/reservations
        const response = await api.get("/reservations/");
        return response.data;
    }

    /**
     * –ü–æ–ª—É—á–∞–µ—Ç –¥–µ—Ç–∞–ª–∏ —Ä–µ–∑–µ—Ä–≤–∞ –ø–æ ID
     */
    static async getReservationById(id: number) {
        const response = await api.get(`/reservations/${id}`);
        return response.data;
    }

    /**
     * –ü—Ä–µ–æ–±—Ä–∞–∑—É–µ—Ç —Ä–µ–∑–µ—Ä–≤—ã, –¥–æ–±–∞–≤–ª—è—è –∏–º–µ–Ω–∞ –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—è
     */
    static createReservationsWithNames(
        reservationsData: Reservation[],
        equipmentMap: Record<number, Equipment>
    ): ReservationWithNames[] {
        if (!reservationsData || reservationsData.length === 0) {
            return [];
        }

        return reservationsData.map((r: Reservation) => ({
            ...r,
            equipment_names: r.equipment_ids
                .map((id: number) => equipmentMap[id])
                .filter((eq): eq is Equipment => Boolean(eq))
                .map((eq: Equipment) => `${eq.equipment_type} ${eq.brand} ${eq.name}`),
        }));
    }
}

```


## <a name="rentalappmainsrccoreservicesUserServicets"></a>`rental-app-main/src/core/services/UserService.ts`

```typescript
// path: rental-app-main/src/core/services/UserService.ts

// src/core/services/UserService.ts

import { api } from "@/lib/api";
import type { UserOut, UserRole, UserListResponse, UserPaymentRequest } from "@/types/user";
import type { BalanceHistoryListResponse } from "@/types/balanceHistory";

export interface UserCreateInput {
    full_name: string;
    email: string;
    password: string;
    role: UserRole;
    phone?: string;
    privacyPolicyAccepted: boolean;
    termsAccepted: boolean;
    emailVerified: boolean;
}

export interface UserUpdateInput extends Partial<UserCreateInput> {
    id: number;
}

export interface UserFilterOptions {
    search?: string;
    role?: UserRole;
    isActive?: boolean;
    status?: string;
}

export interface UserValidationResult {
    isValid: boolean;
    errors: string[];
}

export class UserService {
    /**
     * –ü—Ä–µ–æ–±—Ä–∞–∑—É–µ—Ç camelCase –ø–æ–ª—è –≤ snake_case –¥–ª—è API
     */
    private static toApiFormat(input: Partial<UserCreateInput>): Record<string, any> {
        const apiPayload: Record<string, any> = {};

        if (input.full_name !== undefined) apiPayload.full_name = input.full_name;
        if (input.email !== undefined) apiPayload.email = input.email;
        if (input.password !== undefined) apiPayload.password = input.password;
        if (input.role !== undefined) apiPayload.role = input.role;
        if (input.phone !== undefined) apiPayload.phone = input.phone;
        if (input.privacyPolicyAccepted !== undefined) apiPayload.privacy_policy_accepted = input.privacyPolicyAccepted;
        if (input.termsAccepted !== undefined) apiPayload.terms_accepted = input.termsAccepted;
        if (input.emailVerified !== undefined) apiPayload.email_verified = input.emailVerified;

        return apiPayload;
    }

    /**
     * –ü–æ–ª—É—á–∞–µ—Ç –≤—Å–µ—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π —Å –ø–∞–≥–∏–Ω–∞—Ü–∏–µ–π
     */
    static async getAllUsers(skip: number = 0, limit: number = 15): Promise<UserListResponse> {
        try {
            const response = await api.get<UserListResponse>("/user/admin/users", {
                params: { skip, limit }
            });
            return response.data;
        } catch (error) {
            console.error("–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π:", error);
            throw error;
        }
    }

    /**
     * –ü–æ–ª—É—á–∞–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –ø–æ ID
     */
    static async getUserById(id: number): Promise<UserOut> {
        try {
            const response = await api.get(`/user/admin/users/${id}`);
            return response.data;
        } catch (error) {
            console.error(`–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è —Å ID ${id}:`, error);
            throw error;
        }
    }

    /**
     * –°–æ–∑–¥–∞–µ—Ç –Ω–æ–≤–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
     */
    static async createUser(input: UserCreateInput): Promise<UserOut> {
        try {
            const apiPayload = this.toApiFormat(input);
            const response = await api.post("/user/admin/users", apiPayload);
            return response.data;
        } catch (error) {
            console.error("–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:", error);
            throw error;
        }
    }

    /**
     * –û–±–Ω–æ–≤–ª—è–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
     */
    static async updateUser(input: UserUpdateInput): Promise<UserOut> {
        try {
            const { id, ...updateData } = input;
            const apiPayload = this.toApiFormat(updateData);
            const response = await api.put(`/user/admin/users/${id}`, apiPayload);
            return response.data;
        } catch (error) {
            console.error(`–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è —Å ID ${input.id}:`, error);
            throw error;
        }
    }

    /**
     * –û–±–Ω–æ–≤–ª—è–µ—Ç —Ä–æ–ª—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (—Ç–æ–ª—å–∫–æ –∞–¥–º–∏–Ω)
     */
    static async updateUserRole(userId: number, newRole: UserRole): Promise<any> {
        try {
            // –ò–ó–ú–ï–ù–ï–ù–ò–ï: –û—Ç–ø—Ä–∞–≤–ª—è–µ–º `new_role` –∫–∞–∫ –ø–∞—Ä–∞–º–µ—Ç—Ä –∑–∞–ø—Ä–æ—Å–∞, –∞ –Ω–µ –≤ —Ç–µ–ª–µ.
            // –¢–∞–∫–∂–µ –º–µ–Ω—è–µ–º –æ–∂–∏–¥–∞–µ–º—ã–π —Ç–∏–ø –æ—Ç–≤–µ—Ç–∞ –Ω–∞ `any`, —Ç–∞–∫ –∫–∞–∫ API –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç { message: "..." }
            const response = await api.put(`/user/admin/users/${userId}/role?new_role=${newRole}`);
            return response.data;
        } catch (error) {
            console.error(`–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ —Ä–æ–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è ${userId}:`, error);
            throw error;
        }
    }

    /**
     * –£–¥–∞–ª—è–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
     */
    static async deleteUser(id: number): Promise<void> {
        try {
            await api.delete(`/user/admin/users/${id}`);
        } catch (error) {
            console.error(`–û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è —Å ID ${id}:`, error);
            throw error;
        }
    }

    /**
     * –ê–∫—Ç–∏–≤–∏—Ä—É–µ—Ç/–¥–µ–∞–∫—Ç–∏–≤–∏—Ä—É–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
     */
    static async toggleUserStatus(id: number, isActive: boolean): Promise<UserOut> {
        try {
            const endpoint = isActive ? `/user/admin/users/${id}/unblock` : `/user/admin/users/${id}/block`;
            const response = await api.put(endpoint);
            return response.data;
        } catch (error) {
            console.error(`–û—à–∏–±–∫–∞ –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ —Å—Ç–∞—Ç—É—Å–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è ${id}:`, error);
            throw error;
        }
    }

    /**
     * –ü–æ–ª—É—á–∞–µ—Ç –ø—Ä–æ—Ñ–∏–ª—å —Ç–µ–∫—É—â–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
     */
    static async getCurrentUserProfile(): Promise<UserOut> {
        try {
            const response = await api.get("/user/");
            return response.data;
        } catch (error) {
            console.error("–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ –ø—Ä–æ—Ñ–∏–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:", error);
            throw error;
        }
    }

    /**
     * –û–±–Ω–æ–≤–ª—è–µ—Ç –ø—Ä–æ—Ñ–∏–ª—å —Ç–µ–∫—É—â–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
     */
    static async updateCurrentUserProfile(input: Partial<UserCreateInput>): Promise<UserOut> {
        try {
            const apiPayload = this.toApiFormat(input);
            const response = await api.put("/user/", apiPayload);
            return response.data;
        } catch (error) {
            console.error("–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ –ø—Ä–æ—Ñ–∏–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:", error);
            throw error;
        }
    }

    /**
     * –ü–æ–ª—É—á–∞–µ—Ç –∏—Å—Ç–æ—Ä–∏—é –±–∞–ª–∞–Ω—Å–∞ –¥–ª—è —Ç–µ–∫—É—â–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è —Å –ø–∞–≥–∏–Ω–∞—Ü–∏–µ–π.
     */
    static async getMyBalanceHistory(skip: number, limit: number): Promise<BalanceHistoryListResponse> {
        try {
            const response = await api.get<BalanceHistoryListResponse>("/user/balance-history", {
                params: { skip, limit }
            });
            return response.data;
        } catch (error) {
            console.error("–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ –∏—Å—Ç–æ—Ä–∏–∏ –±–∞–ª–∞–Ω—Å–∞:", error);
            throw error;
        }
    }

    /**
     * –ü–æ–ª—É—á–∞–µ—Ç –∏—Å—Ç–æ—Ä–∏—é –±–∞–ª–∞–Ω—Å–∞ –¥–ª—è –ª—é–±–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –ø–æ ID (–¥–ª—è –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–≤).
     */
    static async getUserBalanceHistory(userId: number, skip: number, limit: number): Promise<BalanceHistoryListResponse> {
        try {
            const response = await api.get<BalanceHistoryListResponse>(`/user/admin/users/${userId}/balance-history`, {
                params: { skip, limit }
            });
            return response.data;
        } catch (error) {
            console.error(`–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ –∏—Å—Ç–æ—Ä–∏–∏ –±–∞–ª–∞–Ω—Å–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è ${userId}:`, error);
            throw error;
        }
    }

    /**
     * –†–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–µ—Ç –ø–ª–∞—Ç–µ–∂ –∏ –ø–æ–ø–æ–ª–Ω—è–µ—Ç –±–∞–ª–∞–Ω—Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (–¥–ª—è –º–µ–Ω–µ–¥–∂–µ—Ä–æ–≤/–∞–¥–º–∏–Ω–æ–≤).
     */
    static async addUserPayment(userId: number, data: UserPaymentRequest): Promise<UserOut> {
        try {
            const response = await api.post<UserOut>(`/user/admin/users/${userId}/add-payment`, data);
            return response.data;
        } catch (error) {
            console.error(`–û—à–∏–±–∫–∞ –ø—Ä–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–∏ –ø–ª–∞—Ç–µ–∂–∞ –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è ${userId}:`, error);
            throw error;
        }
    }

    /**
     * –§–∏–ª—å—Ç—Ä—É–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –ø–æ –∑–∞–¥–∞–Ω–Ω—ã–º –∫—Ä–∏—Ç–µ—Ä–∏—è–º
     */
    static filterUsers(
        users: UserOut[],
        filters: UserFilterOptions
    ): UserOut[] {
        return users.filter(user => {
            if (filters.search) {
                const searchLower = filters.search.toLowerCase();
                const matchesSearch =
                    user.full_name.toLowerCase().includes(searchLower) ||
                    user.email.toLowerCase().includes(searchLower) ||
                    (user.phone && user.phone.toLowerCase().includes(searchLower));
                if (!matchesSearch) return false;
            }
            if (filters.role && user.role !== filters.role) return false;
            if (filters.isActive !== undefined && user.is_active !== filters.isActive) return false;
            if (filters.status && user.status !== filters.status) return false;
            return true;
        });
    }

    /**
     * –í–∞–ª–∏–¥–∏—Ä—É–µ—Ç –¥–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
     */
    static validateUserData(input: UserCreateInput): UserValidationResult {
        const errors: string[] = [];
        if (!input.full_name?.trim()) errors.push("–ü–æ–ª–Ω–æ–µ –∏–º—è –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ");
        if (!input.email?.trim()) {
            errors.push("Email –æ–±—è–∑–∞—Ç–µ–ª–µ–Ω");
        } else if (!this.isValidEmail(input.email)) {
            errors.push("–ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç email");
        }
        if (!input.role) errors.push("–†–æ–ª—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–∞");
        if (input.phone && !this.isValidPhone(input.phone)) errors.push("–ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç —Ç–µ–ª–µ—Ñ–æ–Ω–∞");
        if (!input.privacyPolicyAccepted) errors.push("–ù–µ–æ–±—Ö–æ–¥–∏–º–æ –ø—Ä–∏–Ω—è—Ç—å –ø–æ–ª–∏—Ç–∏–∫—É –∫–æ–Ω—Ñ–∏–¥–µ–Ω—Ü–∏–∞–ª—å–Ω–æ—Å—Ç–∏");
        if (!input.termsAccepted) errors.push("–ù–µ–æ–±—Ö–æ–¥–∏–º–æ –ø—Ä–∏–Ω—è—Ç—å —É—Å–ª–æ–≤–∏—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è");
        return { isValid: errors.length === 0, errors };
    }

    /**
     * –ü—Ä–æ–≤–µ—Ä—è–µ—Ç –≤–∞–ª–∏–¥–Ω–æ—Å—Ç—å email
     */
    private static isValidEmail(email: string): boolean {
        const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
        return emailRegex.test(email);
    }

    /**
     * –ü—Ä–æ–≤–µ—Ä—è–µ—Ç –≤–∞–ª–∏–¥–Ω–æ—Å—Ç—å —Ç–µ–ª–µ—Ñ–æ–Ω–∞
     */
    private static isValidPhone(phone: string): boolean {
        const phoneRegex = /^[+]?[0-9\s-()]+$/;
        return phoneRegex.test(phone) && phone.replace(/\D/g, '').length >= 10;
    }

    /**
     * –°–æ—Ä—Ç–∏—Ä—É–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –ø–æ –∑–∞–¥–∞–Ω–Ω–æ–º—É –∫—Ä–∏—Ç–µ—Ä–∏—é
     */
    static sortUsers(
        users: UserOut[],
        sortBy: 'full_name' | 'email' | 'role' | 'created_at' | 'balance',
        sortOrder: 'asc' | 'desc' = 'asc'
    ): UserOut[] {
        return [...users].sort((a, b) => {
            let aValue: string | number | Date = a[sortBy] as string | number | Date;
            let bValue: string | number | Date = b[sortBy] as string | number | Date;

            if (aValue === null || aValue === undefined) aValue = '';
            if (bValue === null || bValue === undefined) bValue = '';

            if (sortBy === 'created_at') {
                aValue = new Date(aValue as string).getTime();
                bValue = new Date(bValue as string).getTime();
            }

            if (sortBy === 'balance') {
                aValue = Number(aValue) || 0;
                bValue = Number(bValue) || 0;
            }

            if (typeof aValue === 'string' && typeof bValue === 'string') {
                aValue = aValue.toLowerCase();
                bValue = bValue.toLowerCase();
            }

            if (aValue < bValue) return sortOrder === 'asc' ? -1 : 1;
            if (aValue > bValue) return sortOrder === 'asc' ? 1 : -1;
            return 0;
        });
    }

    /**
     * –ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç –∫–ª—é—á –¥–ª—è –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
     */
    static generateUsersCacheKey(filters?: UserFilterOptions): string {
        return JSON.stringify(["users", filters]);
    }

    /**
     * –ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç –∫–ª—é—á –¥–ª—è –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏—è –ø—Ä–æ—Ñ–∏–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
     */
    static generateUserProfileCacheKey(): string {
        return JSON.stringify(["user-profile"]);
    }
}

```


## <a name="rentalappmainsrccoreservicesindexts"></a>`rental-app-main/src/core/services/index.ts`

```typescript
// path: rental-app-main/src/core/services/index.ts

// src/core/services/index.ts

// –≠–∫—Å–ø–æ—Ä—Ç –≤—Å–µ—Ö —Å–µ—Ä–≤–∏—Å–æ–≤
export { ReservationService } from './ReservationService';
export { EquipmentService } from './EquipmentService';
export { AvailabilityService } from './AvailabilityService';
export { PromoCodeService } from './PromoCodeService';
export { UserService } from './UserService';
export { AccessoryService } from './AccessoryService';
export { PhoneService } from './PhoneService';
export { CalendarService } from './CalendarService';
export { DateService } from './DateService';

// –≠–∫—Å–ø–æ—Ä—Ç —Ç–∏–ø–æ–≤
export type {
    ReservationCreateInput,
    ReservationUpdateInput
} from './ReservationService';

export type {
    EquipmentListResponse,
    EquipmentFilterParams
} from './EquipmentService';

export type {
    PromoCodeValidationResult,
    PromoCodeFilterOptions
} from './PromoCodeService';

export type {
    UserCreateInput,
    UserUpdateInput,
    UserFilterOptions,
    UserValidationResult
} from './UserService';

export type {
    AccessoryCreateInput,
    AccessoryUpdateInput,
    AccessoryFilterOptions,
    AccessoryValidationResult
} from './AccessoryService';

export type {
    PhoneValidationResult
} from './PhoneService';

export type {
    CalendarGridData,
    CalendarFilterOptions
} from './CalendarService';

export type {
    DateRange,
    DateRangeValidationResult
} from './DateService';

export type {
    AvailabilityStatusParams,
    DailyStatusParams,
    ConflictCheckParams
} from './AvailabilityService';

```


## <a name="rentalappmainsrchooksadmincreatereservationuseCreateReservationDatats"></a>`rental-app-main/src/hooks/admin/create-reservation/useCreateReservationData.ts`

```typescript
// path: rental-app-main/src/hooks/admin/create-reservation/useCreateReservationData.ts

// src/hooks/admin/create-reservation/useCreateReservationData.ts

import { useMemo } from "react";
import { useAdminUsers } from "@/hooks/useAdminUsers";
import { useEquipment } from "@/hooks/useEquipment";
import { useAvailabilityCheck } from "@/hooks/useAvailabilityCheck";
import { EquipmentService } from "@/core/services";
import type { Equipment } from "@/types/equipment";

interface UseCreateReservationDataInputs {
    equipmentSearch: string;
    watchedStartDate: string;
    watchedEndDate: string;
    watchedEquipmentIds: number[];
}

/**
 * –•—É–∫ –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –∏ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –¥–∞–Ω–Ω—ã—Ö –¥–ª—è —Ñ–æ—Ä–º—ã —Å–æ–∑–¥–∞–Ω–∏—è —Ä–µ–∑–µ—Ä–≤–∞.
 * –°–æ–¥–µ—Ä–∂–∏—Ç –≤—Å—é –ª–æ–≥–∏–∫—É –ø–æ–ª—É—á–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö: –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏, –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏–µ, –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å.
 */
export const useCreateReservationData = ({
    equipmentSearch,
    watchedStartDate,
    watchedEndDate,
    watchedEquipmentIds
}: UseCreateReservationDataInputs) => {

    // 1. –ó–∞–≥—Ä—É–∑–∫–∞ –∏—Å—Ö–æ–¥–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö
    const { data: usersResponse, isLoading: isLoadingUsers } = useAdminUsers();
    const { data: equipmentPages, isLoading: isLoadingEquipment } = useEquipment({}); // –í—ã–∑—ã–≤–∞–µ–º —Å –ø—É—Å—Ç—ã–º –æ–±—ä–µ–∫—Ç–æ–º —Ñ–∏–ª—å—Ç—Ä–æ–≤

    // 2. "–†–∞–∑–≤–æ—Ä–∞—á–∏–≤–∞–µ–º" —Å—Ç—Ä–∞–Ω–∏—Ü—ã –≤ –æ–¥–∏–Ω –ø–ª–æ—Å–∫–∏–π –º–∞—Å—Å–∏–≤ `allEquipment`
    const allEquipment = useMemo(() =>
        equipmentPages?.pages.flatMap((page) => page.items) ?? [],
        [equipmentPages]);

    const users = useMemo(() => 
        usersResponse?.pages?.flatMap(page => page.items) ?? [], 
        [usersResponse]
    );

    // 3. –§–∏–ª—å—Ç—Ä–∞—Ü–∏—è –∏ –≥—Ä—É–ø–ø–∏—Ä–æ–≤–∫–∞ –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—è
    const filteredAndGroupedEquipment = useMemo(() => {
        return EquipmentService.filterAndGroupEquipment(allEquipment, equipmentSearch);
    }, [allEquipment, equipmentSearch]);

    // 4. –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏ –æ—Ç—Ñ–∏–ª—å—Ç—Ä–æ–≤–∞–Ω–Ω–æ–≥–æ –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—è
    const { validStartDate, validEndDate } = useMemo(() => {
        const start = watchedStartDate ? new Date(watchedStartDate) : null;
        const end = watchedEndDate ? new Date(watchedEndDate) : null;
        return {
            validStartDate: start && !isNaN(start.getTime()) ? start : null,
            validEndDate: end && !isNaN(end.getTime()) ? end : null,
        }
    }, [watchedStartDate, watchedEndDate]);

    const { 
        availabilityMap, 
        hasConflicts: hasConflictsInSelection, 
        isLoading: isLoadingAvailability 
    } = useAvailabilityCheck({
        equipmentIds: filteredAndGroupedEquipment.visibleIds,
        startDate: validStartDate || new Date(),
        endDate: validEndDate || new Date(),
        enabled: !!(validStartDate && validEndDate && filteredAndGroupedEquipment.visibleIds.length > 0)
    });

    // –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—è —Å –∞–∫—Å–µ—Å—Å—É–∞—Ä–∞–º–∏
    const getEquipmentWithAccessories = (allEq: Equipment[], ids: number[]): Equipment[] => {
        const selectedIds = new Set(ids);
        return allEq.filter(eq => selectedIds.has(eq.id) && eq.accessories && eq.accessories.length > 0);
    };

    const equipmentWithAccessories = useMemo(() => getEquipmentWithAccessories(allEquipment, watchedEquipmentIds), [watchedEquipmentIds, allEquipment]);

    return {
        users,
        isLoadingUsers,
        allEquipment,
        isLoadingEquipment,
        filteredAndGroupedEquipment,
        availabilityMap,
        isLoadingAvailability,
        hasConflictsInSelection,
        equipmentWithAccessories
    };
};


```


## <a name="rentalappmainsrchooksadmincreatereservationuseCreateReservationDialogts"></a>`rental-app-main/src/hooks/admin/create-reservation/useCreateReservationDialog.ts`

```typescript
// path: rental-app-main/src/hooks/admin/create-reservation/useCreateReservationDialog.ts

// src/hooks/admin/create-reservation/useCreateReservationDialog.ts

import { useState, useEffect, useCallback } from "react";
import { useCreateAdminReservation } from "@/hooks/useAdminReservations";
import { useAdminReservationCalculator } from "../useAdminReservationCalculator";
import { formatDate } from "@/lib/utils";
import { useCreateReservationData } from "./useCreateReservationData";
import { useCreateReservationForm, type CreateReservationFormData } from "./useCreateReservationForm";

const todayDate = new Date();
const tomorrowDate = new Date();
tomorrowDate.setDate(todayDate.getDate() + 1);

/**
 * –£–ü–†–û–©–ï–ù–ù–´–ô –•–£–ö-–û–†–ö–ï–°–¢–†–ê–¢–û–†
 * –£–ø—Ä–∞–≤–ª—è–µ—Ç —Å–æ—Å—Ç–æ—è–Ω–∏–µ–º –¥–∏–∞–ª–æ–≥–∞ —Å–æ–∑–¥–∞–Ω–∏—è —Ä–µ–∑–µ—Ä–≤–∞, –∏—Å–ø–æ–ª—å–∑—É—è –¥–æ—á–µ—Ä–Ω–∏–µ —Ö—É–∫–∏ –¥–ª—è –¥–∞–Ω–Ω—ã—Ö –∏ —Ä–∞—Å—á–µ—Ç–æ–≤.
 */
export const useCreateReservationDialog = ({ isOpen, onClose }: { isOpen: boolean; onClose: () => void }) => {
    // 1. –°–æ—Å—Ç–æ—è–Ω–∏–µ UI –¥–∏–∞–ª–æ–≥–∞
    const [step, setStep] = useState<'details' | 'accessories'>('details');
    const [equipmentSearch, setEquipmentSearch] = useState("");
    const [clientPopoverOpen, setClientPopoverOpen] = useState(false);

    // 2. –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Ñ–æ—Ä–º–æ–π —á–µ—Ä–µ–∑ —Å–ø–µ—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–π —Ö—É–∫
    const { form, watch, trigger, handleSubmit, reset } = useCreateReservationForm();

    const watchedStartDate = watch("start_date");
    const watchedEndDate = watch("end_date");
    const watchedEquipmentIds = watch("equipment_ids");

    // 3. –ü–æ–ª—É—á–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö —á–µ—Ä–µ–∑ —Å–ø–µ—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–π —Ö—É–∫
    const {
        users,
        isLoadingUsers,
        allEquipment,
        isLoadingEquipment,
        filteredAndGroupedEquipment,
        availabilityMap,
        isLoadingAvailability,
        hasConflictsInSelection,
        equipmentWithAccessories,
    } = useCreateReservationData({
        equipmentSearch,
        watchedStartDate,
        watchedEndDate,
        watchedEquipmentIds,
    });

    // 4. –†–∞—Å—á–µ—Ç —Ñ–∏–Ω–∞–Ω—Å–æ–≤
    const financialData = useAdminReservationCalculator(watch, allEquipment);

    // 5. –õ–æ–≥–∏–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ —Ñ–æ—Ä–º—ã
    const createReservationMutation = useCreateAdminReservation();

    const handleCloseDialog = useCallback(() => onClose(), [onClose]);

    const processSubmit = useCallback((data: CreateReservationFormData) => {
        if (hasConflictsInSelection) {
            alert("–ù–µ–ª—å–∑—è —Å–æ–∑–¥–∞—Ç—å —Ä–µ–∑–µ—Ä–≤, —Ç–∞–∫ –∫–∞–∫ –≤ –≤–∞—à–µ–º –≤—ã–±–æ—Ä–µ –µ—Å—Ç—å –∫–æ–Ω—Ñ–ª–∏–∫—Ç–Ω—ã–µ –ø–æ–∑–∏—Ü–∏–∏.");
            return;
        }
        createReservationMutation.mutate(data, { onSuccess: handleCloseDialog });
    }, [hasConflictsInSelection, createReservationMutation, handleCloseDialog]);

    const handleNextStep = useCallback(async () => {
        const isValid = await trigger(["user_id", "start_date", "end_date", "equipment_ids"]);
        if (!isValid) return;

        if (equipmentWithAccessories.length > 0) {
            setStep('accessories');
        } else {
            // ‚úÖ –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï: –î–æ–±–∞–≤–ª–µ–Ω–æ –∫–ª—é—á–µ–≤–æ–µ —Å–ª–æ–≤–æ `await` –¥–ª—è –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ–≥–æ –≤—ã–∑–æ–≤–∞.
            await handleSubmit(processSubmit)();
        }
    }, [trigger, equipmentWithAccessories, handleSubmit, processSubmit]);

    // 6. –°–±—Ä–æ—Å —Å–æ—Å—Ç–æ—è–Ω–∏—è –ø—Ä–∏ –∑–∞–∫—Ä—ã—Ç–∏–∏ –¥–∏–∞–ª–æ–≥–∞
    useEffect(() => {
        if (!isOpen) {
            reset({
                equipment_ids: [], 
                selected_accessories: {},
                start_date: formatDate(todayDate), 
                end_date: formatDate(tomorrowDate),
            });
            setEquipmentSearch("");
            setStep('details');
        }
    }, [isOpen, reset]);

    // 7. –í–æ–∑–≤—Ä–∞—â–∞–µ–º –µ–¥–∏–Ω—ã–π –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å –¥–ª—è –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–∞
    return {
        step,
        form,
        isSubmitting: createReservationMutation.isPending,
        users,
        isLoadingUsers,
        clientPopoverOpen,
        setClientPopoverOpen,
        equipmentSearch,
        setEquipmentSearch,
        isLoadingEquipment,
        filteredAndGroupedEquipment,
        equipmentWithAccessories,
        availabilityMap,
        isLoadingAvailability,
        hasConflictsInSelection,
        setStep,
        handleNextStep,
        onSubmit: handleSubmit(processSubmit),
        handleCloseDialog,
        financialData,
    };
};


```


## <a name="rentalappmainsrchooksadmincreatereservationuseCreateReservationFormts"></a>`rental-app-main/src/hooks/admin/create-reservation/useCreateReservationForm.ts`

```typescript
// path: rental-app-main/src/hooks/admin/create-reservation/useCreateReservationForm.ts

// src/hooks/admin/create-reservation/useCreateReservationForm.ts

import { useForm } from "react-hook-form";
import { zodResolver } from "@hookform/resolvers/zod";
import { z } from "zod";
import { formatDate } from "@/lib/utils";

const createSchema = z.object({
    user_id: z.coerce.number().min(1, "–ù–µ–æ–±—Ö–æ–¥–∏–º–æ –≤—ã–±—Ä–∞—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è"),
    start_date: z.string().min(1, "–ù–µ–æ–±—Ö–æ–¥–∏–º–æ —É–∫–∞–∑–∞—Ç—å –¥–∞—Ç—É –Ω–∞—á–∞–ª–∞"),
    end_date: z.string().min(1, "–ù–µ–æ–±—Ö–æ–¥–∏–º–æ —É–∫–∞–∑–∞—Ç—å –¥–∞—Ç—É –æ–∫–æ–Ω—á–∞–Ω–∏—è"),
    equipment_ids: z.array(z.number()).min(1, "–í—ã–±–µ—Ä–∏—Ç–µ —Ö–æ—Ç—è –±—ã –æ–¥–Ω—É –ø–æ–∑–∏—Ü–∏—é –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—è"),
    selected_accessories: z.record(z.array(z.number())).optional(),
}).refine(data => new Date(data.end_date) >= new Date(data.start_date), {
    message: "–î–∞—Ç–∞ –æ–∫–æ–Ω—á–∞–Ω–∏—è –Ω–µ –º–æ–∂–µ—Ç –±—ã—Ç—å —Ä–∞–Ω—å—à–µ –¥–∞—Ç—ã –Ω–∞—á–∞–ª–∞",
    path: ["end_date"],
});

export type CreateReservationFormData = z.infer<typeof createSchema>;

const todayDate = new Date();
const tomorrowDate = new Date();
tomorrowDate.setDate(todayDate.getDate() + 1);

/**
 * –•—É–∫ –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è —Ñ–æ—Ä–º–æ–π —Å–æ–∑–¥–∞–Ω–∏—è —Ä–µ–∑–µ—Ä–≤–∞.
 * –°–æ–¥–µ—Ä–∂–∏—Ç –≤—Å—é –ª–æ–≥–∏–∫—É, —Å–≤—è–∑–∞–Ω–Ω—É—é —Å react-hook-form.
 */
export const useCreateReservationForm = () => {
    const form = useForm<CreateReservationFormData>({
        resolver: zodResolver(createSchema), 
        mode: "onChange",
        defaultValues: {
            equipment_ids: [], 
            selected_accessories: {},
            start_date: formatDate(todayDate), 
            end_date: formatDate(tomorrowDate),
        },
    });

    const { watch, trigger, handleSubmit, reset } = form;

    return {
        form,
        watch,
        trigger,
        handleSubmit,
        reset,
    };
};


```


## <a name="rentalappmainsrchooksadminuseAdminRentalEditts"></a>`rental-app-main/src/hooks/admin/useAdminRentalEdit.ts`

```typescript
// path: rental-app-main/src/hooks/admin/useAdminRentalEdit.ts

// hooks/admin/useAdminRentalEdit.ts (–ù–û–í–´–ô –§–ê–ô–õ)

import { useForm } from "react-hook-form";
import { zodResolver } from "@hookform/resolvers/zod";
import { z } from "zod";
import { useMutation, useQueryClient } from "@tanstack/react-query";
import { toast } from "sonner";
import { api } from "@/lib/api";
import { formatDate } from "@/lib/utils";
import type { AdminRentalOut } from "@/types/reservation";

// –°—Ö–µ–º–∞ –≤–∞–ª–∏–¥–∞—Ü–∏–∏ –¥–ª—è —Ñ–æ—Ä–º—ã —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
const rentalEditSchema = z.object({
    end_date: z.string().optional(),
    actual_return_date: z.string().nullable().optional(),
    status: z.string().optional(),
    final_cost: z.coerce.number().optional(),
    deposit_amount: z.coerce.number().optional(),
    notes_on_issue: z.string().optional(),
    notes_on_return: z.string().optional(),
});

type RentalEditFormData = z.infer<typeof rentalEditSchema>;

interface UseAdminRentalEditProps {
    rental: AdminRentalOut;
    onSuccess: () => void;
}

export function useAdminRentalEdit({ rental, onSuccess }: UseAdminRentalEditProps) {
    const queryClient = useQueryClient();

    const { register, handleSubmit, formState: { errors, isValid, isDirty } } = useForm<RentalEditFormData>({
        resolver: zodResolver(rentalEditSchema),
        defaultValues: {
            end_date: formatDate(rental.end_date),
            actual_return_date: rental.actual_return_date ? formatDate(rental.actual_return_date) : null,
            status: rental.status,
            final_cost: rental.final_cost ?? undefined,
            deposit_amount: rental.deposit_amount,
            notes_on_issue: rental.notes_on_issue ?? "",
            notes_on_return: rental.notes_on_return ?? "",
        },
        mode: "onChange",
    });

    const updateMutation = useMutation({
        mutationFn: (data: RentalEditFormData) => api.put(`/admin/rentals/${rental.id}`, data),
        onSuccess: () => {
            toast.success("–ê—Ä–µ–Ω–¥–∞ —É—Å–ø–µ—à–Ω–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∞");
            void queryClient.invalidateQueries({ queryKey: ["adminRentals"] });
            onSuccess(); // –ó–∞–∫—Ä—ã–≤–∞–µ–º —Ñ–æ—Ä–º—É —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
        },
        onError: (error: any) => {
            toast.error(error?.response?.data?.detail || "–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ –∞—Ä–µ–Ω–¥—ã");
        },
    });

    const onSubmit = (data: RentalEditFormData) => {
        updateMutation.mutate(data);
    };

    return {
        register,
        handleSubmit: handleSubmit(onSubmit),
        errors,
        isValid,
        isDirty,
        isSaving: updateMutation.isPending,
    };
}

```


## <a name="rentalappmainsrchooksadminuseAdminReservationCalculatorts"></a>`rental-app-main/src/hooks/admin/useAdminReservationCalculator.ts`

```typescript
// path: rental-app-main/src/hooks/admin/useAdminReservationCalculator.ts

// src/hooks/admin/useAdminReservationCalculator.ts

import { useMemo } from "react";
import { UseFormWatch } from "react-hook-form";
import { usePromoCodeStore } from "@/store/promoCodeStore";
import { usePriceCalculator } from "../reservation/usePriceCalculator";
import type { CreateReservationFormData } from "./create-reservation/useCreateReservationForm";
import type { Equipment } from "@/types/equipment";

/**
 * –•—É–∫ –¥–ª—è —Ä–∞—Å—á–µ—Ç–∞ —Å—Ç–æ–∏–º–æ—Å—Ç–∏ —Ä–µ–∑–µ—Ä–≤–∞ –≤ –∞–¥–º–∏–Ω-–ø–∞–Ω–µ–ª–∏.
 * –ò—Å–ø–æ–ª—å–∑—É–µ—Ç —Ü–µ–Ω—Ç—Ä–∞–ª–∏–∑–æ–≤–∞–Ω–Ω—ã–π usePriceCalculator –∫–∞–∫ –µ–¥–∏–Ω—ã–π –∏—Å—Ç–æ—á–Ω–∏–∫ –ø—Ä–∞–≤–¥—ã.
 */
export function useAdminReservationCalculator(
    watch: UseFormWatch<CreateReservationFormData>,
    allEquipment: Equipment[] = []
) {
    const watchedStartDateStr = watch("start_date");
    const watchedEndDateStr = watch("end_date");
    const watchedEquipmentIds = watch("equipment_ids");
    const watchedSelectedAccessories = watch("selected_accessories") || {};

    const { promoCode, setPromoCode, promoCodeMessage } = usePromoCodeStore();

    const startDate = useMemo(() => watchedStartDateStr ? new Date(watchedStartDateStr) : new Date(), [watchedStartDateStr]);
    const endDate = useMemo(() => watchedEndDateStr ? new Date(watchedEndDateStr) : new Date(), [watchedEndDateStr]);

    const equipmentForCalc = useMemo(() =>
            allEquipment.filter(e => watchedEquipmentIds.includes(e.id)),
        [allEquipment, watchedEquipmentIds]
    );

    // –ò—Å–ø–æ–ª—å–∑—É–µ–º —Ä–∞—Å—à–∏—Ä–µ–Ω–Ω—ã–π usePriceCalculator
    const priceCalculator = usePriceCalculator({
        equipmentIds: equipmentForCalc.map(i => i.id),
        startDate,
        endDate,
        selectedAccessories: watchedSelectedAccessories,
        promoCode: promoCode,
        enabled: watchedEquipmentIds.length > 0 && !!watchedStartDateStr && !!watchedEndDateStr
    });

    const applyPromoCode = () => {
        console.log("Applying promo code from admin calculator context:", promoCode);
    };

    // –í–æ–∑–≤—Ä–∞—â–∞–µ–º –¥–∞–Ω–Ω—ã–µ –∏–∑ —Ü–µ–Ω—Ç—Ä–∞–ª–∏–∑–æ–≤–∞–Ω–Ω–æ–≥–æ —Ö—É–∫–∞
    return {
        // –û—Å–Ω–æ–≤–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –∏–∑ usePriceCalculator
        priceDetails: priceCalculator.priceDetails,
        
        // –§–∏–Ω–∞–Ω—Å–æ–≤—ã–µ –¥–∞–Ω–Ω—ã–µ –∏–∑ usePriceCalculator
        dayCount: priceCalculator.dayCount,
        fullTotal: priceCalculator.fullTotal,
        finalTotal: priceCalculator.finalTotal,
        discountAmount: priceCalculator.discountAmount,
        totalDiscountPercentage: priceCalculator.totalDiscountPercentage,
        durationDiscountPercentage: priceCalculator.durationDiscountPercentage,
        promoDiscountPercentage: priceCalculator.promoDiscountPercentage,
        
        // –ü—Ä–æ–º–æ–∫–æ–¥
        promoCode,
        setPromoCode,
        applyPromoCode,
        promoCodeMessage: priceCalculator.promoCodeMessage || promoCodeMessage,
        
        // –°–æ—Å—Ç–æ—è–Ω–∏—è –∑–∞–≥—Ä—É–∑–∫–∏
        isApplyingPromoCode: priceCalculator.isApplyingPromoCode,
        isCalculatingPrice: priceCalculator.isCalculatingPrice,
        isFetchingPrice: priceCalculator.isFetchingPrice,
    };
}

```


## <a name="rentalappmainsrchooksadminuseDashboardDatats"></a>`rental-app-main/src/hooks/admin/useDashboardData.ts`

```typescript
// path: rental-app-main/src/hooks/admin/useDashboardData.ts

// src/hooks/admin/useDashboardData.ts

import { useQuery } from "@tanstack/react-query";
import { api } from "@/lib/api";

// –¢–∏–ø—ã –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –¥–∞—à–±–æ—Ä–¥–∞
export interface DashboardSummary {
    pickups_today: PickupReturnItem[];
    returns_today: PickupReturnItem[];
    overdue_rentals: OverdueRentalItem[];
    kpi: {
        total_users: number;
        active_users: number;
        total_equipment: number;
        total_reservations: number;
        revenue_today: number;
        revenue_this_month: number;
        occupancy_rate: number;
        avg_rental_duration: number;
    };
    recent_activity: ActivityFeedItem[];
    popular_equipment: PopularEquipmentItem[];
}

export interface PickupReturnItem {
    id: number;
    user_name: string;
    equipment_name: string;
    scheduled_time: string | null;
    status: string;
    start_date?: string;
}

export interface OverdueRentalItem {
    id: number;
    user_name: string;
    equipment_name: string;
    due_date: string | null;
    days_overdue: number | null;
}

export interface ActivityFeedItem {
    id: number;
    type: 'reservation_created' | 'reservation_cancelled' | 'rental_started' | 'rental_completed' | 'user_registered' | 'equipment_added';
    description: string;
    timestamp: string;
    user_name?: string;
    equipment_name?: string;
}

export interface PopularEquipmentItem {
    equipment_id: number;
    equipment_name: string;
    rental_count: number;
    revenue: number;
}

export const useDashboardData = () => {
    return useQuery({
        queryKey: ['admin', 'dashboardSummary'],
        queryFn: async (): Promise<DashboardSummary> => {
            const response = await api.get('/admin/dashboard-summary');
            return response.data;
        },
        staleTime: 5 * 60 * 1000, // 5 –º–∏–Ω—É—Ç
        refetchInterval: 2 * 60 * 1000, // 2 –º–∏–Ω—É—Ç—ã
        retry: 3,
        retryDelay: (attemptIndex) => Math.min(1000 * 2 ** attemptIndex, 30000),
    });
};


```


## <a name="rentalappmainsrchooksadminuseEquipmentTableLogicts"></a>`rental-app-main/src/hooks/admin/useEquipmentTableLogic.ts`

```typescript
// path: rental-app-main/src/hooks/admin/useEquipmentTableLogic.ts

// src/hooks/admin/useEquipmentTableLogic.ts
import { useState, useMemo } from "react";
import { useQueryClient } from "@tanstack/react-query";
import { useCurrentUser } from "@/hooks/useProfile";
// ‚õîÔ∏è –£–¥–∞–ª—è–µ–º useEquipment, —Ç–∞–∫ –∫–∞–∫ —Ö—É–∫ –±–æ–ª—å—à–µ –Ω–µ –±—É–¥–µ—Ç –∑–∞–≥—Ä—É–∂–∞—Ç—å –¥–∞–Ω–Ω—ã–µ —Å–∞–º
// import { useEquipment } from "@/hooks/useEquipment";
import { useDeleteEquipment, useBulkDeleteEquipment } from "@/hooks/useAdminEquipment";
import { api } from "@/lib/api";
import { toast } from "sonner";
import type { Equipment } from "@/types/equipment"; // ‚úÖ –î–æ–±–∞–≤–ª—è–µ–º –∏–º–ø–æ—Ä—Ç —Ç–∏–ø–∞

interface EquipmentAvailability {
    hasActiveReservations: boolean;
    hasActiveRentals: boolean;
    activeReservationsCount: number;
    activeRentalsCount: number;
}

// ‚úÖ –•—É–∫ —Ç–µ–ø–µ—Ä—å –ø—Ä–∏–Ω–∏–º–∞–µ—Ç –º–∞—Å—Å–∏–≤ –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—è –∫–∞–∫ –∞—Ä–≥—É–º–µ–Ω—Ç
export const useEquipmentTableLogic = (equipment: Equipment[] = []) => {
    const queryClient = useQueryClient();
    const { data: currentUser } = useCurrentUser();
    // ‚õîÔ∏è –£–¥–∞–ª—è–µ–º –≤–Ω—É—Ç—Ä–µ–Ω–Ω–∏–π –≤—ã–∑–æ–≤ useEquipment()
    // const { data: equipment = [], isLoading, error } = useEquipment();

    const [searchQuery, setSearchQuery] = useState("");
    const [selectedIds, setSelectedIds] = useState<number[]>([]);

    const deleteEquipmentMutation = useDeleteEquipment();
    const bulkDeleteMutation = useBulkDeleteEquipment();

    const isManager = currentUser?.role === "manager" || currentUser?.role === "admin";

    const filteredEquipment = useMemo(() => {
        const lowerCaseQuery = searchQuery.toLowerCase();
        return equipment.filter(item =>
            item.name.toLowerCase().includes(lowerCaseQuery) ||
            item.brand.toLowerCase().includes(lowerCaseQuery) ||
            item.equipment_type.toLowerCase().includes(lowerCaseQuery) ||
            (item.serial_number && item.serial_number.toLowerCase().includes(lowerCaseQuery))
        );
    }, [equipment, searchQuery]);

    const handleSelectAll = (checked: boolean) => {
        setSelectedIds(checked ? filteredEquipment.map(item => item.id) : []);
    };

    const handleSelectItem = (itemId: number, checked: boolean) => {
        setSelectedIds(prev =>
            checked ? [...prev, itemId] : prev.filter(id => id !== itemId)
        );
    };

    const handleDelete = async (itemId: number) => {
        if (!isManager) return;

        try {
            const availability = await queryClient.fetchQuery<EquipmentAvailability>({
                queryKey: ["equipment-availability", itemId],
                queryFn: async () => (await api.get<EquipmentAvailability>(`/equipment/${itemId}/availability`)).data,
            });

            if (availability.hasActiveReservations || availability.hasActiveRentals) {
                const messages = [];
                if (availability.hasActiveReservations) messages.push(`${availability.activeReservationsCount} –∞–∫—Ç–∏–≤–Ω—ã—Ö —Ä–µ–∑–µ—Ä–≤–æ–≤`);
                if (availability.hasActiveRentals) messages.push(`${availability.activeRentalsCount} –∞–∫—Ç–∏–≤–Ω—ã—Ö –∞—Ä–µ–Ω–¥`);
                toast.error(`–ù–µ–≤–æ–∑–º–æ–∂–Ω–æ —É–¥–∞–ª–∏—Ç—å: —É –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—è –µ—Å—Ç—å ${messages.join(" –∏ ")}.`);
                return;
            }

            const equipmentToDelete = filteredEquipment.find(item => item.id === itemId);
            if (window.confirm(`–£–¥–∞–ª–∏—Ç—å "${equipmentToDelete?.name}"? –î–µ–π—Å—Ç–≤–∏–µ –Ω–µ–ª—å–∑—è –æ—Ç–º–µ–Ω–∏—Ç—å.`)) {
                deleteEquipmentMutation.mutate(itemId);
            }
        } catch (err) {
            toast.error("–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø—Ä–æ–≤–µ—Ä–∫–µ —Å—Ç–∞—Ç—É—Å–∞ –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—è.");
            console.error("Availability check failed:", err);
        }
    };

    const handleBulkDelete = () => {
        if (!isManager || selectedIds.length === 0) return;
        if (window.confirm(`–£–¥–∞–ª–∏—Ç—å ${selectedIds.length} –µ–¥. –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—è?`)) {
            bulkDeleteMutation.mutate(selectedIds, {
                onSuccess: () => setSelectedIds([]),
            });
        }
    };

    const handlers = {
        setSearchQuery,
        handleSelectAll,
        handleSelectItem,
        handleDelete,
        handleBulkDelete
    };

    return {
        isManager,
        // ‚úÖ –¢–∞–∫ –∫–∞–∫ –∑–∞–≥—Ä—É–∑–∫–∞ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç –≤—ã—à–µ, –∑–¥–µ—Å—å –º—ã —Å—á–∏—Ç–∞–µ–º, —á—Ç–æ –µ—ë –Ω–µ—Ç
        isLoading: false,
        error: null,
        equipment,
        filteredEquipment,
        searchQuery,
        selectedIds,
        deleteEquipmentMutation,
        bulkDeleteMutation,
        handlers,
    };
};

```


## <a name="rentalappmainsrchooksadminuseRentalReturnFormts"></a>`rental-app-main/src/hooks/admin/useRentalReturnForm.ts`

```typescript
// path: rental-app-main/src/hooks/admin/useRentalReturnForm.ts

// src/hooks/admin/useRentalReturnForm.ts

import { useForm } from "react-hook-form";
import { zodResolver } from "@hookform/resolvers/zod";
import { z } from "zod";
import { useReturnRental } from "@/hooks/useAdminRentals";
import { useAddUserPayment } from "@/hooks/useAdminUsers";
import { useQueryClient } from "@tanstack/react-query";
import { toast } from "sonner";
import type { AdminRentalOut, RentalAccessoryDetail } from "@/types/rental";
import { formatDate } from "@/lib/utils";
import { useState, useMemo, useEffect } from "react";
import type { Accessory } from "@/types/accessory";
import type { Equipment } from "@/types/equipment";

interface Props {
    rental: AdminRentalOut | null;
    onClose: () => void;
}

const returnSchema = z.object({
    actual_return_date: z.string().min(1, "–î–∞—Ç–∞ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–∞"),
    notes_on_return: z.string().optional(),
});

type ReturnFormData = z.infer<typeof returnSchema>;

export function useRentalReturnForm({ rental, onClose }: Props) {
    const returnMutation = useReturnRental();
    const queryClient = useQueryClient();
    const paymentMutation = useAddUserPayment();
    
    const { register, handleSubmit, formState: { errors, isValid }, reset } = useForm<ReturnFormData>({
        resolver: zodResolver(returnSchema),
        mode: "onChange",
        defaultValues: {
            actual_return_date: formatDate(new Date()),
            notes_on_return: "",
        },
    });

    const [checkedAccessories, setCheckedAccessories] = useState<Set<string>>(new Set());
    
    // –°–æ—Å—Ç–æ—è–Ω–∏–µ –¥–ª—è –ø–ª–∞—Ç–µ–∂–∞
    const [paymentAmount, setPaymentAmount] = useState("");
    const [paymentDescription, setPaymentDescription] = useState("");
    const [paymentApplied, setPaymentApplied] = useState(false);

    // –î–∏–Ω–∞–º–∏—á–µ—Å–∫–∏–π –ø–µ—Ä–µ—Å—á–µ—Ç –æ—Å—Ç–∞—Ç–∫–∞ —Å —É—á–µ—Ç–æ–º —à—Ç—Ä–∞—Ñ–∞ –∑–∞ –ø—Ä–æ—Å—Ä–æ—á–∫—É
    const dynamicRemainingAmount = useMemo(() => {
        if (!rental) return 0;
        
        const remaining = rental.remaining_amount || 0;
        const surcharge = rental.overdue_surcharge || 0;
        const payment = parseFloat(paymentAmount) || 0;

        // –ò—Ç–æ–≥–æ–≤—ã–π –æ—Å—Ç–∞—Ç–æ–∫ = (–û—Å—Ç–∞—Ç–æ–∫ –ø–æ –∞—Ä–µ–Ω–¥–µ) + (–®—Ç—Ä–∞—Ñ) - (–í–Ω–µ—Å–µ–Ω–Ω—ã–π –ø–ª–∞—Ç–µ–∂)
        return Math.max(0, remaining + surcharge - payment);
    }, [rental, paymentAmount]);

    // –ì—Ä—É–ø–ø–∏—Ä–æ–≤–∫–∞ –∞–∫—Å–µ—Å—Å—É–∞—Ä–æ–≤ –ø–æ –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—é
    const accessoriesByEquipment = useMemo(() => {
        if (!rental?.accessory_links) return {};
        return rental.accessory_links.reduce((acc: Record<number, Accessory[]>, current: RentalAccessoryDetail) => {
            const equipmentId = current.equipment_id;
            (acc[equipmentId] = acc[equipmentId] || []).push(current.accessory);
            return acc;
        }, {} as Record<number, Accessory[]>);
    }, [rental]);

    const totalAccessoriesCount = rental?.accessory_links?.length ?? 0;
    const allAccessoriesChecked = checkedAccessories.size === totalAccessoriesCount;

    const handleToggleAccessory = (equipmentId: number, accessoryId: number) => {
        const key = `${equipmentId}-${accessoryId}`;
        setCheckedAccessories(prev => {
            const newSet = new Set(prev);
            if (newSet.has(key)) {
                newSet.delete(key);
            } else {
                newSet.add(key);
            }
            return newSet;
        });
    };

    // –õ–æ–≥–∏–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –ø–ª–∞—Ç–µ–∂–∞
    const handleApplyPayment = async () => {
        if (!rental || !paymentAmount) return;
        
        try {
            await paymentMutation.mutateAsync({
                userId: rental.user.id,
                data: {
                    amount: parseFloat(paymentAmount),
                    payment_method: "cash",
                    description: paymentDescription || `–ü–ª–∞—Ç–µ–∂ –ø—Ä–∏ –≤–æ–∑–≤—Ä–∞—Ç–µ –∞—Ä–µ–Ω–¥—ã #${rental.id}`
                }
            });
            
            setPaymentApplied(true);
            toast.success("–ü–ª–∞—Ç–µ–∂ —É—Å–ø–µ—à–Ω–æ –∑–∞–Ω–µ—Å–µ–Ω.");
            
            // –ò–Ω–≤–∞–ª–∏–¥–∏—Ä—É–µ–º –∑–∞–ø—Ä–æ—Å—ã –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö
            await queryClient.invalidateQueries({ queryKey: ["admin", "users"] });
            await queryClient.invalidateQueries({ queryKey: ["adminRentals"] });
        } catch (error) {
            console.error("–û—à–∏–±–∫–∞ –ø—Ä–∏ –≤–Ω–µ—Å–µ–Ω–∏–∏ –ø–ª–∞—Ç–µ–∂–∞:", error);
        }
    };

    // –õ–æ–≥–∏–∫–∞ –æ—Ç–º–µ–Ω—ã –ø–ª–∞—Ç–µ–∂–∞
    const handleCancelPayment = () => {
        setPaymentAmount("");
        setPaymentDescription("");
        setPaymentApplied(false);
        toast.info("–í–≤–æ–¥ –ø–ª–∞—Ç–µ–∂–∞ –æ—Ç–º–µ–Ω–µ–Ω.");
    };

    // –ê–≤—Ç–æ–∑–∞–ø–æ–ª–Ω–µ–Ω–∏–µ —Å—É–º–º—ã –ø–ª–∞—Ç–µ–∂–∞ —Å —É—á–µ—Ç–æ–º —à—Ç—Ä–∞—Ñ–∞ –∑–∞ –ø—Ä–æ—Å—Ä–æ—á–∫—É
    const handleAutoFillPayment = () => {
        if (rental) {
            const remaining = rental.remaining_amount || 0;
            const surcharge = rental.overdue_surcharge || 0;
            const totalAmount = remaining + surcharge;
            setPaymentAmount(totalAmount.toString());
        }
    };

    useEffect(() => {
        if (rental) {
            setCheckedAccessories(new Set());
            setPaymentAmount("");
            setPaymentDescription("");
            setPaymentApplied(false);
            reset({
                actual_return_date: formatDate(new Date()),
                notes_on_return: "",
            });
        }
    }, [rental, reset]);

    const onSubmit = (data: ReturnFormData) => {
        if (!rental) return;
        returnMutation.mutate(
            {
                rentalId: rental.id,
                data: {
                    ...data,
                    accessories_returned_confirmation: allAccessoriesChecked,
                }
            },
            {
                onSuccess: () => {
                    reset();
                    onClose();
                },
            }
        );
    };

    return {
        // –°–æ—Å—Ç–æ—è–Ω–∏—è
        paymentAmount,
        setPaymentAmount,
        paymentDescription,
        setPaymentDescription,
        paymentApplied,
        checkedAccessories,
        dynamicRemainingAmount,
        
        // –§—É–Ω–∫—Ü–∏–∏-–æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏
        handleApplyPayment,
        handleCancelPayment,
        handleToggleAccessory,
        handleAutoFillPayment,
        onSubmit,
        
        // –°–æ—Å—Ç–æ—è–Ω–∏—è –º—É—Ç–∞—Ü–∏–π
        isSubmittingReturn: returnMutation.isPending,
        isApplyingPayment: paymentMutation.isPending,
        
        // –î–∞–Ω–Ω—ã–µ —Ñ–æ—Ä–º—ã –æ—Ç react-hook-form
        register,
        handleSubmit,
        formState: { errors, isValid },
        
        // –î—Ä—É–≥–∏–µ –≤—ã—á–∏—Å–ª—è–µ–º—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è
        accessoriesByEquipment,
        allAccessoriesChecked,
        totalAccessoriesCount,
    };
}


```


## <a name="rentalappmainsrchooksadminuseUserTableLogicts"></a>`rental-app-main/src/hooks/admin/useUserTableLogic.ts`

```typescript
// path: rental-app-main/src/hooks/admin/useUserTableLogic.ts

// src/hooks/admin/useUserTableLogic.ts

import { useState, useMemo } from "react";
import { useCurrentUser } from "@/hooks/useProfile";
import {
    useUpdateUserRole,
    useBlockUser,
    useUnblockUser,
    useDeleteUser
} from "@/hooks/useAdminUsers";
import type { UserOut, UserRole } from "@/types/user";

export function useUserTableLogic(users: UserOut[]) {
    const { data: currentUser } = useCurrentUser();

    const [searchQuery, setSearchQuery] = useState("");
    const [confirmDelete, setConfirmDelete] = useState<number | null>(null);

    const updateRoleMutation = useUpdateUserRole();
    const blockUserMutation = useBlockUser();
    const unblockUserMutation = useUnblockUser();
    const deleteUserMutation = useDeleteUser();

    const isAdmin = currentUser?.role === "admin";

    const filteredUsers = useMemo(() => {
        return users.filter(user =>
            user.full_name.toLowerCase().includes(searchQuery.toLowerCase()) ||
            user.email.toLowerCase().includes(searchQuery.toLowerCase()) ||
            user.role.toLowerCase().includes(searchQuery.toLowerCase())
        );
    }, [users, searchQuery]);

    const handleRoleChange = (userId: number, newRole: string) => {
        if (!isAdmin) return;
        // –ò–ó–ú–ï–ù–ï–ù–ò–ï: –ü—Ä–∏–≤–æ–¥–∏–º string –∫ —Ç–∏–ø—É UserRole –ø–µ—Ä–µ–¥ –≤—ã–∑–æ–≤–æ–º –º—É—Ç–∞—Ü–∏–∏
        updateRoleMutation.mutate({ userId, newRole: newRole as UserRole });
    };

    const handleToggleBlock = (user: UserOut) => {
        if (!isAdmin) return;
        if (user.is_active) {
            blockUserMutation.mutate(user.id);
        } else {
            unblockUserMutation.mutate(user.id);
        }
    };

    const handleDelete = (userId: number) => {
        if (!isAdmin) return;
        if (confirmDelete === userId) {
            deleteUserMutation.mutate(userId);
            setConfirmDelete(null);
        } else {
            setConfirmDelete(userId);
            setTimeout(() => setConfirmDelete(null), 5000);
        }
    };

    return {
        currentUser,
        filteredUsers,
        isAdmin,
        searchQuery,
        setSearchQuery,
        confirmDelete,
        mutations: {
            updateRole: updateRoleMutation,
            blockUser: blockUserMutation,
            unblockUser: unblockUserMutation,
            deleteUser: deleteUserMutation,
        },
        handlers: {
            handleRoleChange,
            handleToggleBlock,
            handleDelete,
        },
    };
}

```


## <a name="rentalappmainsrchooksdatauseEquipmentDatats"></a>`rental-app-main/src/hooks/data/useEquipmentData.ts`

```typescript
// path: rental-app-main/src/hooks/data/useEquipmentData.ts

// src/hooks/data/useEquipmentData.ts

import { useMemo } from "react";
import { useEquipment } from "@/hooks/useEquipment";
import { useAvailabilityCheck } from "@/hooks/useAvailabilityCheck";
import { useDailyAvailability } from "@/hooks/useDailyAvailability";
import { useReserveStore } from "@/store/reserveStore";
import type { Equipment } from "@/types/equipment";
import type { AvailabilityInfo, DailyAvailabilityData } from "@/types/availability";

export interface EquipmentFilters {
    query?: string;
    type?: string;
    brand?: string;
    associationId?: number;
    availableOnly?: boolean;
    startDate?: Date;
    endDate?: Date;
}

export interface UseEquipmentDataReturn {
    equipment: Equipment[];
    totalEquipmentCount: number;
    availabilityData: AvailabilityInfo[];
    dailyAvailabilityData: DailyAvailabilityData | undefined;
    isLoading: boolean;
    isFetchingNextPage: boolean;
    hasNextPage: boolean;
    fetchNextPage: () => void;
}

export const useEquipmentData = (filters: EquipmentFilters): UseEquipmentDataReturn => {
    const { addToReservationMode } = useReserveStore();

    // –ó–∞–≥—Ä—É–∂–∞–µ–º –ø–∞–≥–∏–Ω–∏—Ä–æ–≤–∞–Ω–Ω—ã–π —Å–ø–∏—Å–æ–∫ –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—è
    const {
        data: equipmentPages,
        fetchNextPage,
        hasNextPage,
        isLoading,
        isFetchingNextPage
    } = useEquipment(filters);

    // –ò–∑–≤–ª–µ–∫–∞–µ–º –ø–ª–æ—Å–∫–∏–π –º–∞—Å—Å–∏–≤ –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—è
    const equipment = useMemo(() =>
        equipmentPages?.pages.flatMap(page => page.items) ?? [],
        [equipmentPages]
    );

    const totalEquipmentCount = equipmentPages?.pages[0]?.total ?? 0;

    // –ó–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ –æ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏ –¥–ª—è –≤—Å–µ–≥–æ –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—è
    const { availabilityMap } = useAvailabilityCheck({
        equipmentIds: equipment.map(e => e.id),
        startDate: filters.startDate || new Date(),
        endDate: filters.endDate || new Date(),
        excludeReservationId: addToReservationMode || undefined,
        enabled: !!(filters.startDate && filters.endDate && equipment.length > 0)
    });

    // –ü—Ä–µ–æ–±—Ä–∞–∑—É–µ–º availabilityMap –æ–±—Ä–∞—Ç–Ω–æ –≤ –º–∞—Å—Å–∏–≤ –¥–ª—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏
    const availabilityData = useMemo(() => 
        Object.values(availabilityMap), 
        [availabilityMap]
    );

    // –ó–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ –æ –µ–∂–µ–¥–Ω–µ–≤–Ω–æ–π –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏ –¥–ª—è –≤–∏–¥–∏–º—ã—Ö —ç–ª–µ–º–µ–Ω—Ç–æ–≤
    const thirtyDaysFromNow = useMemo(() => new Date(Date.now() + 30 * 24 * 60 * 60 * 1000), []);
    const { data: dailyAvailabilityData } = useDailyAvailability({
        ids: equipment.map(item => item.id),
        start: new Date(),
        end: thirtyDaysFromNow,
    });

    return {
        equipment,
        totalEquipmentCount,
        availabilityData,
        dailyAvailabilityData,
        isLoading,
        isFetchingNextPage,
        hasNextPage,
        fetchNextPage
    };
};



```


## <a name="rentalappmainsrchooksfeaturesuseAppFiltersts"></a>`rental-app-main/src/hooks/features/useAppFilters.ts`

```typescript
// path: rental-app-main/src/hooks/features/useAppFilters.ts

// src/hooks/features/useAppFilters.ts

import { useSearchStore } from "@/store/searchStore";
import { useFilterStore } from "@/store/filterStore";
import { useDateStore } from "@/store/dateStore";

/**
 * –•—É–∫ –¥–ª—è –∏–Ω–∫–∞–ø—Å—É–ª—è—Ü–∏–∏ –ª–æ–≥–∏–∫–∏ –ø–æ–ª—É—á–µ–Ω–∏—è –≤—Å–µ—Ö —Ñ–∏–ª—å—Ç—Ä–æ–≤ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
 * –û–±—ä–µ–¥–∏–Ω—è–µ—Ç —Å–æ—Å—Ç–æ—è–Ω–∏–µ –∏–∑ —Ç—Ä–µ—Ö —Å—Ç–æ—Ä–æ–≤: –ø–æ–∏—Å–∫–∞, —Ñ–∏–ª—å—Ç—Ä–æ–≤ –∏ –¥–∞—Ç
 */
export const useAppFilters = () => {
    const search = useSearchStore();
    const filters = useFilterStore();
    const dates = useDateStore();

    return {
        // –ü–æ–∏—Å–∫
        query: search.query,
        
        // –§–∏–ª—å—Ç—Ä—ã
        type: filters.type,
        brand: filters.brand,
        availableOnly: filters.availableOnly,
        associationId: filters.associationId,
        reset: filters.reset,
        
        // –î–∞—Ç—ã
        startDate: dates.startDate,
        endDate: dates.endDate,
    };
};



```


## <a name="rentalappmainsrchooksfeaturesuseEquipmentCardViewModelts"></a>`rental-app-main/src/hooks/features/useEquipmentCardViewModel.ts`

```typescript
// path: rental-app-main/src/hooks/features/useEquipmentCardViewModel.ts

// src/hooks/features/useEquipmentCardViewModel.ts

import { useMemo, useCallback } from "react";
import { useReserveStore } from "@/store/reserveStore";
import { useDateStore } from "@/store/dateStore";
import { useSandboxCalculatorStore } from "@/store/sandboxCalculatorStore";
import { usePromoCodeStore } from "@/store/promoCodeStore";
import type { Equipment } from "@/types/equipment";
import type { EquipmentStatus } from "@/types/availability";

interface UseEquipmentCardViewModelProps {
    equipment: Equipment;
    status?: EquipmentStatus | "my_reservation" | "added";
}

/**
 * –•—É–∫ –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –ª–æ–≥–∏–∫–æ–π –∫–∞—Ä—Ç–æ—á–∫–∏ –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—è.
 * –°–æ–¥–µ—Ä–∂–∏—Ç –≤—Å–µ —Ö—É–∫–∏, —Ä–∞—Å—á–µ—Ç—ã –∏ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Å–æ–±—ã—Ç–∏–π –¥–ª—è EquipmentCard.
 */
export const useEquipmentCardViewModel = ({ equipment, status: _status = "available" }: UseEquipmentCardViewModelProps) => {
    // –ü–æ–ª—É—á–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö –∏–∑ –≤—Å–µ—Ö —Å—Ç–æ—Ä–æ–≤
    const { toggle, isSelected, toggleAccessory, isAccessorySelected, selectedAccessories } = useReserveStore();
    const { dayCount } = useDateStore();
    const { isCalculatorVisible, durationDiscountPercentage } = useSandboxCalculatorStore();
    const { promoCodePercentage } = usePromoCodeStore();

    // –ü—Ä–æ–≤–µ—Ä–∫–∞ –≤—ã–±—Ä–∞–Ω–Ω–æ—Å—Ç–∏ –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—è
    const isSelectedByUser = isSelected(equipment.id);

    // –†–∞—Å—á–µ—Ç —Å—É—Ç–æ—á–Ω–æ–π —Å—Ç–æ–∏–º–æ—Å—Ç–∏ –∞–∫—Å–µ—Å—Å—É–∞—Ä–æ–≤
    const accessoriesDailyRate = useMemo(() => {
        const selectedForThisCard = selectedAccessories[equipment.id] || [];
        return equipment.accessories?.reduce((total, acc) => 
            selectedForThisCard.includes(acc.id) ? total + acc.price : total, 0) ?? 0;
    }, [equipment.accessories, equipment.id, selectedAccessories]);

    // –†–∞—Å—á–µ—Ç –æ–±—â–µ–π —Å–∫–∏–¥–∫–∏
    const totalDiscountPercentage = useMemo(() => 
        durationDiscountPercentage + promoCodePercentage, 
        [durationDiscountPercentage, promoCodePercentage]
    );

    // –î–∞–Ω–Ω—ã–µ –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è —Å–∫–∏–¥–∫–∏
    const discountData = useMemo(() => {
        const totalDailyRate = equipment.daily_rate + accessoriesDailyRate;
        const priceBefore = totalDailyRate * dayCount;
        return {
            days: dayCount,
            percentage: totalDiscountPercentage,
            priceBefore,
            priceAfter: priceBefore * (1 - totalDiscountPercentage / 100),
        };
    }, [equipment.daily_rate, accessoriesDailyRate, dayCount, totalDiscountPercentage]);

    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è –∞–∫—Å–µ—Å—Å—É–∞—Ä–∞
    const handleToggleAccessory = useCallback((accessoryId: number) => {
        if (!isSelectedByUser) toggle(equipment);
        toggleAccessory(equipment.id, accessoryId);
    }, [isSelectedByUser, toggle, equipment, toggleAccessory]);

    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è –≤—ã–±–æ—Ä–∞ –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—è
    const handleToggleSelection = useCallback(() => {
        toggle(equipment);
    }, [toggle, equipment]);

    return {
        // –°–æ—Å—Ç–æ—è–Ω–∏–µ
        isSelectedByUser,
        isCalculatorVisible,
        
        // –†–∞—Å—á–µ—Ç—ã
        accessoriesDailyRate,
        totalDiscountPercentage,
        discountData,
        
        // –§—É–Ω–∫—Ü–∏–∏
        handleToggleAccessory,
        handleToggleSelection,
        isAccessorySelected,
    };
};


```


## <a name="rentalappmainsrchooksreservationsubmissionuseReservationFormDatats"></a>`rental-app-main/src/hooks/reservation/submission/useReservationFormData.ts`

```typescript
// path: rental-app-main/src/hooks/reservation/submission/useReservationFormData.ts

// src/hooks/reservation/submission/useReservationFormData.ts

import { useReserveStore } from "@/store/reserveStore";
import { useDateStore } from "@/store/dateStore";
import { usePromoCodeStore } from "@/store/promoCodeStore";
import { useCurrentUser } from "@/hooks/useProfile";

/**
 * –•—É–∫-–∞–≥—Ä–µ–≥–∞—Ç–æ—Ä –¥–ª—è —Å–±–æ—Ä–∞ –¥–∞–Ω–Ω—ã—Ö –∏–∑ —Ä–∞–∑–ª–∏—á–Ω—ã—Ö —Ö—Ä–∞–Ω–∏–ª–∏—â (Zustand).
 * –°–æ–±–∏—Ä–∞–µ—Ç –∏ –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –µ–¥–∏–Ω—ã–π –æ–±—ä–µ–∫—Ç —Å–æ –≤—Å–µ–º–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã–º–∏ –¥–∞–Ω–Ω—ã–º–∏ –¥–ª—è —Å—Ç—Ä–∞–Ω–∏—Ü—ã –æ—Ñ–æ—Ä–º–ª–µ–Ω–∏—è.
 */
export const useReservationFormData = () => {
    // –ü–æ–ª—É—á–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö –∏–∑ –≤—Å–µ—Ö —Å—Ç–æ—Ä–æ–≤
    const { data: user } = useCurrentUser();
    const { startDate, endDate, setStartDate, setEndDate, dayCount } = useDateStore();
    const { 
        items, 
        selectedAccessories, 
        remove: removeItemFromStore, 
        clear: clearReserveStore, 
        isAccessorySelected, 
        toggleAccessory 
    } = useReserveStore();
    const { 
        promoCode: promoCodeInput, 
        setPromoCode: setPromoCodeInput, 
        removePromoCode 
    } = usePromoCodeStore();

    return {
        // –î–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        user,
        
        // –î–∞–Ω–Ω—ã–µ –¥–∞—Ç
        startDate,
        endDate,
        dayCount,
        
        // –î–∞–Ω–Ω—ã–µ —Ä–µ–∑–µ—Ä–≤–∞
        items,
        selectedAccessories,
        
        // –ü—Ä–æ–º–æ–∫–æ–¥
        promoCodeInput,
        
        // –§—É–Ω–∫—Ü–∏–∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –¥–∞—Ç–∞–º–∏
        setStartDate,
        setEndDate,
        
        // –§—É–Ω–∫—Ü–∏–∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è —Ä–µ–∑–µ—Ä–≤–æ–º
        removeItemFromStore,
        clearReserveStore,
        isAccessorySelected,
        toggleAccessory,
        
        // –§—É–Ω–∫—Ü–∏–∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –ø—Ä–æ–º–æ–∫–æ–¥–æ–º
        setPromoCodeInput,
        removePromoCode,
    };
};


```


## <a name="rentalappmainsrchooksreservationsubmissionuseReserveSubmissionts"></a>`rental-app-main/src/hooks/reservation/submission/useReserveSubmission.ts`

```typescript
// path: rental-app-main/src/hooks/reservation/submission/useReserveSubmission.ts

// src/hooks/reservation/submission/useReserveSubmission.ts

import { useMemo, useState } from "react";
import { toast } from "sonner";
import { useReservations } from "@/hooks/useReservations";
import { useAvailabilityCheck } from "@/hooks/useAvailabilityCheck";
import { reservationCreateSchema, type ReservationCreateInput } from "@/lib/validationSchemas";
import { usePriceCalculator } from "../usePriceCalculator";
import { formatDate } from "@/lib/utils";
import { useReservationFormData } from "./useReservationFormData";

/**
 * –•—É–∫-–∫–æ–æ—Ä–¥–∏–Ω–∞—Ç–æ—Ä –¥–ª—è —Å—Ç—Ä–∞–Ω–∏—Ü—ã –æ—Ñ–æ—Ä–º–ª–µ–Ω–∏—è —Ä–µ–∑–µ—Ä–≤–∞.
 * –ò—Å–ø–æ–ª—å–∑—É–µ—Ç —Ö—É–∫-–∞–≥—Ä–µ–≥–∞—Ç–æ—Ä –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö –∏ —Å–æ–¥–µ—Ä–∂–∏—Ç –ª–æ–≥–∏–∫—É –æ–±—Ä–∞–±–æ—Ç–∫–∏ –∏ –æ—Ç–ø—Ä–∞–≤–∫–∏ —Ñ–æ—Ä–º—ã.
 */
export function useReserveSubmission() {
    // –ü–æ–ª—É—á–µ–Ω–∏–µ –≤—Å–µ—Ö –¥–∞–Ω–Ω—ã—Ö —á–µ—Ä–µ–∑ —Ö—É–∫-–∞–≥—Ä–µ–≥–∞—Ç–æ—Ä
    const {
        user,
        startDate,
        endDate,
        dayCount,
        items,
        selectedAccessories,
        promoCodeInput,
        setStartDate,
        setEndDate,
        removeItemFromStore,
        clearReserveStore,
        isAccessorySelected,
        toggleAccessory,
        setPromoCodeInput,
        removePromoCode,
    } = useReservationFormData();

    // –õ–æ–∫–∞–ª—å–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ –¥–ª—è –ø—Ä–æ–º–æ–∫–æ–¥–∞, –∫–æ—Ç–æ—Ä—ã–π –±—ã–ª –ø—Ä–∏–º–µ–Ω–µ–Ω –∫ —Ä–∞—Å—á–µ—Ç—É
    const [appliedPromoCode, setAppliedPromoCode] = useState(promoCodeInput);

    // --- –†–ê–°–ß–ï–¢–´ –ò –ü–†–û–í–ï–†–ö–ò ---
    const equipmentIds = useMemo(() => items.map(i => i.id), [items]);

    // –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏ –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—è –Ω–∞ –≤—ã–±—Ä–∞–Ω–Ω—ã–µ –¥–∞—Ç—ã
    const { availabilityMap, conflictingItemIds, isLoading: isCheckingAvailability } = useAvailabilityCheck({
        equipmentIds, startDate, endDate
    });

    // –†–∞—Å—á–µ—Ç –∏—Ç–æ–≥–æ–≤–æ–π —Å—Ç–æ–∏–º–æ—Å—Ç–∏ —Å –ø–æ–º–æ—â—å—é —Ä–∞—Å—à–∏—Ä–µ–Ω–Ω–æ–≥–æ usePriceCalculator
    const priceCalculator = usePriceCalculator({
        equipmentIds, startDate, endDate, selectedAccessories, promoCode: appliedPromoCode
    });

    // –†–∞—Å—á–µ—Ç —Å—É—Ç–æ—á–Ω–æ–π —Å—Ç–æ–∏–º–æ—Å—Ç–∏ –∞–∫—Å–µ—Å—Å—É–∞—Ä–æ–≤ (–¥–ª—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏)
    const accessoriesDailyTotal = useMemo(() => {
        return items.reduce((total, item) => {
            const selectedForThisItem = selectedAccessories[item.id] || [];
            return total + (item.accessories?.reduce((accTotal, accessory) =>
                selectedForThisItem.includes(accessory.id) ? accTotal + accessory.price : accTotal, 0) ?? 0);
        }, 0);
    }, [items, selectedAccessories]);

    // --- –õ–û–ì–ò–ö–ê –û–¢–ü–†–ê–í–ö–ò –§–û–†–ú–´ ---
    const { createReservation } = useReservations();
    const { isPending: isSubmitting, isSuccess: reservationSuccess, mutateAsync, error } = createReservation;

    // –ò–∑–≤–ª–µ–∫–∞–µ–º ID –Ω–µ–¥–æ—Å—Ç—É–ø–Ω—ã—Ö —Ç–æ–≤–∞—Ä–æ–≤ –∏–∑ –æ—à–∏–±–∫–∏, –µ—Å–ª–∏ –æ–Ω–∞ –µ—Å—Ç—å
    const unavailableIdsFromAPI = useMemo(() => (error as { unavailable_ids?: number[] })?.unavailable_ids ?? [], [error]);

    const handleSubmit = async () => {
        if (!user) {
            toast.error("–ù–µ–æ–±—Ö–æ–¥–∏–º–æ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞—Ç—å—Å—è –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è —Ä–µ–∑–µ—Ä–≤–∞.");
            return;
        }
        if (conflictingItemIds.length > 0) {
            toast.error("–ù–µ–∫–æ—Ç–æ—Ä—ã–µ –≤—ã–±—Ä–∞–Ω–Ω—ã–µ –ø–æ–∑–∏—Ü–∏–∏ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω—ã. –£–¥–∞–ª–∏—Ç–µ –∏—Ö –∏–ª–∏ –∏–∑–º–µ–Ω–∏—Ç–µ –¥–∞—Ç—ã.");
            return;
        }

        const payload: ReservationCreateInput = {
            equipment_ids: items.map(i => i.id),
            start_date: formatDate(startDate),
            end_date: formatDate(endDate),
            selected_accessories: selectedAccessories,
            promo_code: appliedPromoCode || undefined,
        };

        const validationResult = reservationCreateSchema.safeParse(payload);
        if (!validationResult.success) {
            const errorMessages = validationResult.error.errors.map(e => e.message).join("\n");
            toast.error(`–û—à–∏–±–∫–∞ –≤–∞–ª–∏–¥–∞—Ü–∏–∏ –¥–∞–Ω–Ω—ã—Ö:\n${errorMessages}`);
            return;
        }

        try {
            await mutateAsync(validationResult.data);
            toast.success("–†–µ–∑–µ—Ä–≤ —É—Å–ø–µ—à–Ω–æ —Å–æ–∑–¥–∞–Ω!");
            clearReserveStore();
            // –û—á–∏—â–∞–µ–º –ø—Ä–æ–º–æ–∫–æ–¥ –ø–æ—Å–ª–µ —É—Å–ø–µ—à–Ω–æ–≥–æ —Ä–µ–∑–µ—Ä–≤–∞
            removePromoCode();
        } catch (e: unknown) {
            // –û—à–∏–±–∫–∏ (–≤–∫–ª—é—á–∞—è 409 —Å –∫–æ–Ω—Ñ–ª–∏–∫—Ç–∞–º–∏) —Ç–µ–ø–µ—Ä—å –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—é—Ç—Å—è –∏ –æ—Ç–æ–±—Ä–∞–∂–∞—é—Ç—Å—è
            // —Ü–µ–Ω—Ç—Ä–∞–ª–∏–∑–æ–≤–∞–Ω–Ω–æ –≤ —Ö—É–∫–µ useReservations. –ó–¥–µ—Å—å –º—ã –ø—Ä–æ—Å—Ç–æ –ª–æ–≥–∏—Ä—É–µ–º –∏—Ö.
            console.error("Submission failed:", e);
        }
    };

    // –§—É–Ω–∫—Ü–∏—è, –∫–æ—Ç–æ—Ä–∞—è "—Ñ–∏–∫—Å–∏—Ä—É–µ—Ç" –≤–≤–µ–¥–µ–Ω–Ω—ã–π –ø—Ä–æ–º–æ–∫–æ–¥ –¥–ª—è —Ä–∞—Å—á–µ—Ç–∞
    const applyPromoCode = () => {
        setAppliedPromoCode(promoCodeInput);
    };

    // --- –í–û–ó–í–†–ê–¢ –î–ê–ù–ù–´–• –î–õ–Ø UI ---
    // –°–æ–±–∏—Ä–∞–µ–º –≤—Å–µ –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã–µ –¥–∞–Ω–Ω—ã–µ –∏ —Ñ—É–Ω–∫—Ü–∏–∏ –≤ –æ–¥–∏–Ω –æ–±—ä–µ–∫—Ç –¥–ª—è –ø–µ—Ä–µ–¥–∞—á–∏ –≤ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç
    return {
        // –î–∞–Ω–Ω—ã–µ –∏ —Å–æ—Å—Ç–æ—è–Ω–∏–µ
        items,
        user,
        startDate,
        endDate,
        availabilityMap,
        unavailableIdsFromAPI,
        invalidItems: conflictingItemIds,
        isLoadingAvailability: isCheckingAvailability || priceCalculator.isCalculatingPrice,
        isSubmitting,
        isApplyingPromoCode: priceCalculator.isApplyingPromoCode,
        reservationSuccess,
        submitMessage: (error as Error)?.message,
        selectedAccessories,
        // –§–∏–Ω–∞–Ω—Å–æ–≤—ã–µ —Ä–∞—Å—á–µ—Ç—ã –∏–∑ —Ü–µ–Ω—Ç—Ä–∞–ª–∏–∑–æ–≤–∞–Ω–Ω–æ–≥–æ —Ö—É–∫–∞
        priceDetails: priceCalculator.priceDetails,
        dayCount: priceCalculator.dayCount || dayCount,
        fullTotal: priceCalculator.fullTotal,
        totalDiscountPercentage: priceCalculator.totalDiscountPercentage,
        discountAmount: priceCalculator.discountAmount,
        finalTotal: priceCalculator.finalTotal,
        accessoriesDailyTotal,
        // –ü—Ä–æ–º–æ–∫–æ–¥
        promoCode: promoCodeInput,
        promoCodeMessage: priceCalculator.promoCodeMessage,
        // –§—É–Ω–∫—Ü–∏–∏ –∏ –¥–µ–π—Å—Ç–≤–∏—è
        setStartDate,
        setEndDate,
        clearReserveStore,
        removeItemFromStore,
        isAccessorySelected,
        toggleAccessory,
        setPromoCode: setPromoCodeInput,
        applyPromoCode,
        removePromoCode,
        handleSubmit,
    };
}


```


## <a name="rentalappmainsrchooksreservationusePriceCalculatorts"></a>`rental-app-main/src/hooks/reservation/usePriceCalculator.ts`

```typescript
// path: rental-app-main/src/hooks/reservation/usePriceCalculator.ts

// src/hooks/reservation/usePriceCalculator.ts

import { useQuery } from "@tanstack/react-query";
import { ReservationService, type PriceDetails } from "@/core/services";
import { formatDate } from "@/lib/utils";

interface UsePriceCalculatorInput {
    equipmentIds: number[];
    startDate: Date;
    endDate: Date;
    selectedAccessories: Record<number, number[]>;
    promoCode?: string;
    enabled?: boolean;
}

export { type PriceDetails };

/**
 * –ï–¥–∏–Ω—ã–π —Ö—É–∫ –¥–ª—è —Ä–∞—Å—á–µ—Ç–∞ —Å—Ç–æ–∏–º–æ—Å—Ç–∏ —Ä–µ–∑–µ—Ä–≤–∞.
 * –Ø–≤–ª—è–µ—Ç—Å—è –µ–¥–∏–Ω—Å—Ç–≤–µ–Ω–Ω—ã–º –∏—Å—Ç–æ—á–Ω–∏–∫–æ–º –ø—Ä–∞–≤–¥—ã –¥–ª—è –≤—Å–µ—Ö —Ñ–∏–Ω–∞–Ω—Å–æ–≤—ã—Ö —Ä–∞—Å—á–µ—Ç–æ–≤ –≤ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏.
 */
export const usePriceCalculator = ({
    equipmentIds, 
    startDate, 
    endDate, 
    selectedAccessories, 
    promoCode, 
    enabled = true
}: UsePriceCalculatorInput) => {

    const queryKey = [
        "priceCalculation",
        [...equipmentIds].sort(),
        formatDate(startDate),
        formatDate(endDate),
        JSON.stringify(selectedAccessories),
        promoCode || ""
    ];

    const query = useQuery<PriceDetails>({
        queryKey: queryKey,
        queryFn: async () => {
            return ReservationService.calculatePrice({
                equipment_ids: equipmentIds,
                start_date: formatDate(startDate),
                end_date: formatDate(endDate),
                selected_accessories: selectedAccessories,
                promo_code: promoCode
            });
        },
        enabled: enabled && equipmentIds.length > 0 && !!startDate && !!endDate && startDate < endDate,
        staleTime: 5000,
    });

    // –í–æ–∑–≤—Ä–∞—â–∞–µ–º —Ä–∞—Å—à–∏—Ä–µ–Ω–Ω—ã–π –æ–±—ä–µ–∫—Ç —Å –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–º–∏ –≤—ã—á–∏—Å–ª—è–µ–º—ã–º–∏ –ø–æ–ª—è–º–∏
    return {
        ...query,
        // –û—Å–Ω–æ–≤–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –∏–∑ API
        priceDetails: query.data,
        
        // –í—ã—á–∏—Å–ª—è–µ–º—ã–µ –ø–æ–ª—è –¥–ª—è —É–¥–æ–±—Å—Ç–≤–∞ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è
        dayCount: query.data?.day_count ?? 0,
        fullTotal: query.data?.full_total ?? 0,
        finalTotal: query.data?.final_total ?? 0,
        discountAmount: query.data?.discount_amount ?? 0,
        durationDiscountPercentage: query.data?.duration_discount_percentage ?? 0,
        promoDiscountPercentage: query.data?.promo_discount_percentage ?? 0,
        totalDiscountPercentage: (query.data?.duration_discount_percentage ?? 0) + (query.data?.promo_discount_percentage ?? 0),
        promoCodeMessage: query.data?.promo_code_message ?? "",
        
        // –°–æ—Å—Ç–æ—è–Ω–∏—è –∑–∞–≥—Ä—É–∑–∫–∏
        isCalculatingPrice: query.isLoading,
        isFetchingPrice: query.isFetching,
        isApplyingPromoCode: query.isFetching && !!promoCode,
    };
};

```


## <a name="rentalappmainsrchooksreservationuseReservationActionsts"></a>`rental-app-main/src/hooks/reservation/useReservationActions.ts`

```typescript
// path: rental-app-main/src/hooks/reservation/useReservationActions.ts

// src/hooks/reservation/useReservationActions.ts

import { useState, useCallback, useMemo } from "react";
import { toast } from "sonner";
import { useReserveStore } from "@/store/reserveStore";
import { useEditReservation } from "../useEditReservation";
import { ReservationService } from "@/core/services";
import type { Reservation } from "@/types/reservation";
import { type EditState } from "./useReservationState";

export function useReservationActions({
                                          reservation,
                                          state,
                                          hasConflicts,
                                          appliedPromoCode,
                                          onFullCancellation,
                                          isAdminContext,
                                          onFinishEditing, // ‚ú® 1. –ü—Ä–∏–Ω–∏–º–∞–µ–º –∫–æ–ª–±—ç–∫
                                      }: {
    reservation: Reservation,
    state: EditState,
    hasConflicts: boolean,
    appliedPromoCode: string,
    onFullCancellation?: () => Promise<void> | void,
    isAdminContext: boolean,
    onFinishEditing: () => void; // ‚ú® 2. –î–æ–±–∞–≤–ª—è–µ–º –µ–≥–æ –≤ —Ç–∏–ø
}) {
    const editApiMutation = useEditReservation();
    const { clear: clearReserveStore } = useReserveStore();

    const finalHasChanges = useMemo(() => {
        const promoCodeChanged = appliedPromoCode !== (reservation.promo_code || "");
        return state.hasChanges || promoCodeChanged;
    }, [state.hasChanges, appliedPromoCode, reservation.promo_code]);

    const saveChanges = useCallback(async (): Promise<boolean> => {
        if (!finalHasChanges) {
            toast.info("–ù–µ—Ç –∏–∑–º–µ–Ω–µ–Ω–∏–π –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è.");
            return false;
        }
        if (hasConflicts) {
            toast.error("–ù–µ–≤–æ–∑–º–æ–∂–Ω–æ —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å —Ä–µ–∑–µ—Ä–≤ —Å –∫–æ–Ω—Ñ–ª–∏–∫—Ç–∞–º–∏.");
            return false;
        }
        if (state.currentEquipmentDetails.length === 0) {
            toast.error("–†–µ–∑–µ—Ä–≤ –¥–æ–ª–∂–µ–Ω —Å–æ–¥–µ—Ä–∂–∞—Ç—å —Ö–æ—Ç—è –±—ã –æ–¥–Ω—É –ø–æ–∑–∏—Ü–∏—é.");
            return false;
        }

        try {
            await editApiMutation.mutateAsync({
                id: reservation.id,
                start_date: state.startDate.toISOString().split('T')[0],
                end_date: state.endDate.toISOString().split('T')[0],
                equipment_ids: state.currentEquipmentDetails.map(eq => eq.id),
                promo_code: appliedPromoCode || undefined,
                selected_accessories: state.localSelectedAccessories,
                isAdminContext,
            });
            toast.success("–†–µ–∑–µ—Ä–≤ —É—Å–ø–µ—à–Ω–æ –æ–±–Ω–æ–≤–ª–µ–Ω!");
            clearReserveStore();
            onFinishEditing(); // ‚ú® 3. –í—ã–∑—ã–≤–∞–µ–º –∫–æ–ª–±—ç–∫ –ø–æ—Å–ª–µ —É—Å–ø–µ—à–Ω–æ–≥–æ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è
            return true;
        } catch (error) {
            toast.error("–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–π.");
            return false;
        }
    }, [
        reservation.id, state, finalHasChanges, hasConflicts,
        appliedPromoCode, editApiMutation, clearReserveStore, isAdminContext, onFinishEditing
    ]);

    const [isCancelling, setIsCancelling] = useState(false);

    const handleConfirmFullCancellation = useCallback(async () => {
        if (!onFullCancellation) return;
        setIsCancelling(true);
        try {
            await onFullCancellation();
        } catch (error) {
            toast.error("–ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–º–µ–Ω–∏—Ç—å —Ä–µ–∑–µ—Ä–≤.");
        } finally {
            setIsCancelling(false);
        }
    }, [onFullCancellation]);

    return {
        saveChanges,
        isSaving: editApiMutation.isPending,
        handleConfirmFullCancellation,
        isCancelling,
        finalHasChanges,
    };
}

```


## <a name="rentalappmainsrchooksreservationuseReservationDatats"></a>`rental-app-main/src/hooks/reservation/useReservationData.ts`

```typescript
// path: rental-app-main/src/hooks/reservation/useReservationData.ts

// src/hooks/reservation/useReservationData.ts

import { useState, useMemo, useEffect } from "react";
import { usePriceCalculator } from "./usePriceCalculator";
import { useAvailabilityCheck } from "@/hooks/useAvailabilityCheck";
import type { EditState } from "./useReservationState";
import type { Reservation } from "@/types/reservation";

const emptyFinancials = {
    dayCount: 0,
    fullTotal: 0,
    finalTotal: 0,
    discountAmount: 0,
    durationDiscountAmount: 0,
    durationDiscountPercentage: 0,
    promoDiscountAmount: 0,
    promoCodePercentage: 0,
    promoCodeMessage: "",
};

export function useReservationData(reservation: Reservation, state: EditState) {
    const [promoCode, setPromoCode] = useState(reservation.promo_code || "");
    const [appliedPromoCode, setAppliedPromoCode] = useState(reservation.promo_code || "");

    const { availabilityMap, hasConflicts, isLoading: isCheckingAvailability } = useAvailabilityCheck({
        equipmentIds: state.currentEquipmentDetails.map(eq => eq.id),
        startDate: state.startDate,
        endDate: state.endDate,
        // ‚ú® –ì–õ–ê–í–ù–û–ï –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï: –ú—ã –≤—Å–µ–≥–¥–∞ –≤ —Ä–µ–∂–∏–º–µ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è,
        // –ø–æ—ç—Ç–æ–º—É –≤—Å–µ–≥–¥–∞ –ø–µ—Ä–µ–¥–∞–µ–º ID –¥–ª—è –∏—Å–∫–ª—é—á–µ–Ω–∏—è.
        excludeReservationId: reservation.id,
    });

    const priceCalculator = usePriceCalculator({
        equipmentIds: state.currentEquipmentDetails.map(i => i.id),
        startDate: state.startDate,
        endDate: state.endDate,
        selectedAccessories: state.localSelectedAccessories,
        promoCode: appliedPromoCode,
        enabled: true // –•—É–∫ –∞–∫—Ç–∏–≤–µ–Ω –≤—Å–µ–≥–¥–∞, –∫–æ–≥–¥–∞ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è
    });

    const financials = useMemo(() => {
        if (!priceCalculator.priceDetails) {
            return { ...emptyFinancials, promoCode: promoCode };
        }
        const priceDetails = priceCalculator.priceDetails;
        const durationDiscountAmount = priceDetails.full_total * (priceDetails.duration_discount_percentage / 100);
        const promoDiscountAmount = priceDetails.full_total * (priceDetails.promo_discount_percentage / 100);
        return {
            dayCount: priceDetails.day_count,
            fullTotal: priceDetails.full_total,
            finalTotal: priceDetails.final_total,
            discountAmount: priceDetails.discount_amount,
            durationDiscountAmount,
            durationDiscountPercentage: priceDetails.duration_discount_percentage,
            promoDiscountAmount,
            promoCodePercentage: priceDetails.promo_discount_percentage,
            promoCodeMessage: priceDetails.promo_code_message ?? "",
            promoCode: promoCode,
        };
    }, [priceCalculator.priceDetails, promoCode]);

    const applyPromoCode = () => setAppliedPromoCode(promoCode);
    const removePromoCode = () => {
        setPromoCode("");
        setAppliedPromoCode("");
    };

    return {
        availabilityMap,
        hasConflicts,
        isCheckingAvailability,
        isCalculatingPrice: priceCalculator.isCalculatingPrice,
        financials,
        promoCode,
        setPromoCode,
        applyPromoCode,
        removePromoCode,
        appliedPromoCode,
        priceDetails: priceCalculator.priceDetails,
    };
}

```


## <a name="rentalappmainsrchooksreservationuseReservationEditStatets"></a>`rental-app-main/src/hooks/reservation/useReservationEditState.ts`

```typescript
// path: rental-app-main/src/hooks/reservation/useReservationEditState.ts

// src/hooks/reservation/useReservationEditState.ts
import { useState, useMemo, useCallback, useEffect } from "react";
import type { Reservation } from "@/types/reservation";
// ‚ùå –£–¥–∞–ª–µ–Ω –Ω–µ–∏—Å–ø–æ–ª—å–∑—É–µ–º—ã–π –∏–º–ø–æ—Ä—Ç `Equipment`
// import type { Equipment } from "@/types/equipment";

// ‚úÖ –û–ø–µ—á–∞—Ç–∫–∞ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∞: –ø–µ—Ä–µ–∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è -> –ø–µ—Ä–µ–∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è
// –ò–Ω—Ç–µ—Ä—Ñ–µ–π—Å—ã –≤—ã–Ω–µ—Å–µ–Ω—ã –¥–ª—è –ø–µ—Ä–µ–∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è
export interface EquipmentDisplayDetail {
    id: number;
    label: string;
}

export interface EditState {
    isEditing: boolean;
    startDate: Date;
    endDate: Date;
    originalEquipmentIds: ReadonlySet<number>;
    currentEquipmentDetails: EquipmentDisplayDetail[];
    newlyAddedEquipmentIds: ReadonlySet<number>;
    hasChanges: boolean;
}

/**
 * –£–ø—Ä–∞–≤–ª—è–µ—Ç –æ—Å–Ω–æ–≤–Ω—ã–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ–º —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è —Ä–µ–∑–µ—Ä–≤–∞.
 */
export function useReservationEditState(
    reservation: Reservation,
    initialEquipmentForDisplay: ReadonlyArray<EquipmentDisplayDetail>
) {
    const initialStartDate = useMemo(() => new Date(reservation.start_date), [reservation.start_date]);
    const initialEndDate = useMemo(() => new Date(reservation.end_date), [reservation.end_date]);
    const initialOriginalIds = useMemo(() => new Set(reservation.equipment_ids), [reservation.equipment_ids]);
    const initialCurrentDetails = useMemo(() => [...initialEquipmentForDisplay], [initialEquipmentForDisplay]);

    const [editState, setEditState] = useState<EditState>({
        isEditing: false,
        startDate: initialStartDate,
        endDate: initialEndDate,
        originalEquipmentIds: initialOriginalIds,
        currentEquipmentDetails: initialCurrentDetails,
        newlyAddedEquipmentIds: new Set<number>(),
        hasChanges: false
    });

    const calculateChanges = useCallback((
        currentState: EditState
    ): boolean => {
        const datesChanged =
            currentState.startDate.getTime() !== initialStartDate.getTime() ||
            currentState.endDate.getTime() !== initialEndDate.getTime();

        const currentIdSet = new Set(currentState.currentEquipmentDetails.map(eq => eq.id));
        const equipmentChanged =
            initialOriginalIds.size !== currentIdSet.size ||
            !Array.from(initialOriginalIds).every(id => currentIdSet.has(id));

        return datesChanged || equipmentChanged;
    }, [initialStartDate, initialEndDate, initialOriginalIds]);

    // –°–±—Ä–æ—Å —Å–æ—Å—Ç–æ—è–Ω–∏—è, –µ—Å–ª–∏ –ø—Ä–æ–ø—Å—ã —Ä–µ–∑–µ—Ä–≤–∞ –∏–∑–º–µ–Ω–∏–ª–∏—Å—å –∏–∑–≤–Ω–µ
    useEffect(() => {
        if (!editState.isEditing) {
            setEditState({
                isEditing: false,
                startDate: initialStartDate,
                endDate: initialEndDate,
                originalEquipmentIds: initialOriginalIds,
                currentEquipmentDetails: initialCurrentDetails,
                newlyAddedEquipmentIds: new Set<number>(),
                hasChanges: false,
            });
        }
    }, [initialStartDate, initialEndDate, initialOriginalIds, initialCurrentDetails, editState.isEditing]);

    const resetToInitialState = useCallback(() => {
        setEditState({
            isEditing: false,
            startDate: initialStartDate,
            endDate: initialEndDate,
            originalEquipmentIds: initialOriginalIds,
            currentEquipmentDetails: initialCurrentDetails,
            newlyAddedEquipmentIds: new Set<number>(),
            hasChanges: false,
        });
    }, [initialStartDate, initialEndDate, initialOriginalIds, initialCurrentDetails]);

    return {
        editState,
        setEditState,
        calculateChanges,
        initialOriginalIds,
        initialStartDate,
        initialEndDate,
        resetToInitialState,
    };
}

```


## <a name="rentalappmainsrchooksreservationuseReservationStatets"></a>`rental-app-main/src/hooks/reservation/useReservationState.ts`

```typescript
// path: rental-app-main/src/hooks/reservation/useReservationState.ts

// src/hooks/reservation/useReservationState.ts

import { useState, useMemo, useCallback, useEffect } from "react";
import type { Reservation } from "@/types/reservation";
import type { Equipment } from "@/types/equipment";

export interface EquipmentDisplayDetail {
    id: number;
    label: string;
}

export interface EditState {
    // isEditing: boolean; // ‚ú® –£–î–ê–õ–ï–ù–û
    startDate: Date;
    endDate: Date;
    originalEquipmentIds: ReadonlySet<number>;
    currentEquipmentDetails: EquipmentDisplayDetail[];
    newlyAddedEquipmentIds: ReadonlySet<number>;
    localSelectedAccessories: Record<number, number[]>;
    hasChanges: boolean;
}

function createDisplayLabel(equipmentItem: Equipment): string {
    return `${equipmentItem.equipment_type} ${equipmentItem.brand} ${equipmentItem.name}`;
}

export function useReservationState(
    reservation: Reservation,
    initialEquipmentForDisplay: ReadonlyArray<EquipmentDisplayDetail>
) {
    const initialValues = useMemo(() => ({
        startDate: new Date(reservation.start_date),
        endDate: new Date(reservation.end_date),
        equipmentIds: new Set(reservation.equipment_ids),
        equipmentDetails: [...initialEquipmentForDisplay],
        accessories: reservation.selected_accessories || {},
    }), [reservation, initialEquipmentForDisplay]);

    const [state, setState] = useState<Omit<EditState, 'hasChanges'>>({ // ‚ú® hasChanges —É–±—Ä–∞–Ω–æ –∏–∑ –Ω–∞—á–∞–ª—å–Ω–æ–≥–æ —Å–æ—Å—Ç–æ—è–Ω–∏—è
        startDate: initialValues.startDate,
        endDate: initialValues.endDate,
        originalEquipmentIds: initialValues.equipmentIds,
        currentEquipmentDetails: initialValues.equipmentDetails,
        newlyAddedEquipmentIds: new Set<number>(),
        localSelectedAccessories: initialValues.accessories,
    });

    // ‚ú® –í—ã—á–∏—Å–ª—è–µ–º hasChanges —á–µ—Ä–µ–∑ useMemo
    const hasChanges = useMemo(() => {
        const datesChanged =
            state.startDate.getTime() !== initialValues.startDate.getTime() ||
            state.endDate.getTime() !== initialValues.endDate.getTime();

        const currentIdSet = new Set(state.currentEquipmentDetails.map(eq => eq.id));
        const equipmentChanged =
            initialValues.equipmentIds.size !== currentIdSet.size ||
            !Array.from(initialValues.equipmentIds).every(id => currentIdSet.has(id));

        const accessoriesChanged =
            JSON.stringify(state.localSelectedAccessories) !== JSON.stringify(initialValues.accessories);

        return datesChanged || equipmentChanged || accessoriesChanged;
    }, [state, initialValues]);


    const [isCancelConfirmationVisible, setCancelConfirmationVisible] = useState(false);

    const updateDates = useCallback((newStartDate: Date, newEndDate: Date) => {
        setState(prev => ({ ...prev, startDate: newStartDate, endDate: newEndDate }));
    }, []);

    const addEquipmentItems = useCallback((itemsToAdd: Equipment[]) => {
        setState(prev => {
            const currentIds = new Set(prev.currentEquipmentDetails.map(d => d.id));
            const newDetails = itemsToAdd
                .filter(item => !currentIds.has(item.id))
                .map(item => ({ id: item.id, label: createDisplayLabel(item) }));

            if (newDetails.length === 0) return prev;

            const newNewlyAddedIds = new Set(prev.newlyAddedEquipmentIds);
            itemsToAdd.forEach(item => {
                if (!initialValues.equipmentIds.has(item.id)) {
                    newNewlyAddedIds.add(item.id);
                }
            });

            return {
                ...prev,
                currentEquipmentDetails: [...prev.currentEquipmentDetails, ...newDetails],
                newlyAddedEquipmentIds: newNewlyAddedIds,
            };
        });
    }, [initialValues.equipmentIds]);

    const removeEquipmentItem = useCallback((idToRemove: number) => {
        if (state.currentEquipmentDetails.length <= 1) {
            setCancelConfirmationVisible(true);
        } else {
            setState(prev => {
                const newDetails = prev.currentEquipmentDetails.filter(eq => eq.id !== idToRemove);
                const newNewlyAddedIds = new Set(prev.newlyAddedEquipmentIds);
                newNewlyAddedIds.delete(idToRemove);

                const newAccessories = { ...prev.localSelectedAccessories };
                delete newAccessories[idToRemove];

                return {
                    ...prev,
                    currentEquipmentDetails: newDetails,
                    newlyAddedEquipmentIds: newNewlyAddedIds,
                    localSelectedAccessories: newAccessories,
                };
            });
        }
    }, [state.currentEquipmentDetails.length]);

    const toggleAccessory = useCallback((equipmentId: number, accessoryId: number) => {
        setState(prev => {
            const newAccessoriesState = { ...prev.localSelectedAccessories };
            const currentSelection = newAccessoriesState[equipmentId] || [];
            const isSelected = currentSelection.includes(accessoryId);

            const newSelection = isSelected
                ? currentSelection.filter(id => id !== accessoryId)
                : [...currentSelection, accessoryId];

            if (newSelection.length > 0) {
                newAccessoriesState[equipmentId] = newSelection;
            } else {
                delete newAccessoriesState[equipmentId];
            }
            return { ...prev, localSelectedAccessories: newAccessoriesState };
        });
    }, []);

    return {
        // ‚ú® –í–æ–∑–≤—Ä–∞—â–∞–µ–º –≤—ã—á–∏—Å–ª–µ–Ω–Ω–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ hasChanges
        state: { ...state, hasChanges },
        actions: {
            updateDates,
            addEquipmentItems,
            removeEquipmentItem,
            toggleAccessory,
        },
        dialogs: {
            isCancelConfirmationVisible,
            setCancelConfirmationVisible,
        },
    };
}

```


## <a name="rentalappmainsrchooksuseAdminAccessoriests"></a>`rental-app-main/src/hooks/useAdminAccessories.ts`

```typescript
// path: rental-app-main/src/hooks/useAdminAccessories.ts

// src/hooks/useAdminAccessories.ts

import { useQuery, useMutation, useQueryClient } from "@tanstack/react-query";
import { api } from "@/lib/api";
import { toast } from "sonner";
import type { Accessory, AccessoryListResponse } from "@/types/accessory";
import { AccessoryService } from "@/core/services";

// –¢–∏–ø—ã –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è
type AccessoryPayload = {
    name: string;
    accessory_type?: string;
    price?: number;
    description?: string;
};

// +++ –ù–ê–ß–ê–õ–û –ò–ó–ú–ï–ù–ï–ù–ò–ô +++
// –î–æ–±–∞–≤–ª—è–µ–º –∑–Ω–∞—á–µ–Ω–∏—è –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é –¥–ª—è —Å—Ç—Ä–∞–Ω–∏—Ü—ã –∏ —Ä–∞–∑–º–µ—Ä–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
export function useAccessories(page: number = 1, pageSize: number = 20) {
// +++ –ö–û–ù–ï–¶ –ò–ó–ú–ï–ù–ï–ù–ò–ô +++
    const skip = (page - 1) * pageSize;

    return useQuery<AccessoryListResponse>({
        queryKey: ["accessories", page, pageSize],
        queryFn: async () => {
            return await AccessoryService.getAllAccessories(skip, pageSize);
        },
        staleTime: 5 * 60 * 1000, // 5 –º–∏–Ω—É—Ç
    });
}

// –°–æ–∑–¥–∞–Ω–∏–µ –Ω–æ–≤–æ–≥–æ –∞–∫—Å–µ—Å—Å—É–∞—Ä–∞
export function useCreateAccessory() {
    const queryClient = useQueryClient();
    return useMutation({
        mutationFn: (data: AccessoryPayload) => api.post<Accessory>("/accessories/", data),
        onSuccess: () => {
            void queryClient.invalidateQueries({ queryKey: ["accessories"] });
            toast.success("–ê–∫—Å–µ—Å—Å—É–∞—Ä —É—Å–ø–µ—à–Ω–æ —Å–æ–∑–¥–∞–Ω");
        },
        onError: (error: any) => {
            toast.error(error?.response?.data?.detail || "–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –∞–∫—Å–µ—Å—Å—É–∞—Ä–∞");
        },
    });
}

// –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∞–∫—Å–µ—Å—Å—É–∞—Ä–∞
export function useUpdateAccessory() {
    const queryClient = useQueryClient();
    return useMutation({
        mutationFn: ({ id, data }: { id: number, data: AccessoryPayload }) =>
            api.put<Accessory>(`/accessories/${id}`, data),
        onSuccess: () => {
            void queryClient.invalidateQueries({ queryKey: ["accessories"] });
            toast.success("–ê–∫—Å–µ—Å—Å—É–∞—Ä —É—Å–ø–µ—à–Ω–æ –æ–±–Ω–æ–≤–ª–µ–Ω");
        },
        onError: (error: any) => {
            toast.error(error?.response?.data?.detail || "–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ –∞–∫—Å–µ—Å—Å—É–∞—Ä–∞");
        },
    });
}

// –ü–æ–ª—É—á–µ–Ω–∏–µ –∞–∫—Å–µ—Å—Å—É–∞—Ä–∞ –ø–æ ID
export function useAccessory(id: number | null) {
    return useQuery<Accessory>({
        queryKey: ["accessory", id],
        queryFn: async () => {
            if (!id) throw new Error("ID –∞–∫—Å–µ—Å—Å—É–∞—Ä–∞ –Ω–µ —É–∫–∞–∑–∞–Ω");
            const response = await api.get<Accessory>(`/accessories/${id}`);
            return response.data;
        },
        enabled: !!id,
        staleTime: 5 * 60 * 1000, // 5 –º–∏–Ω—É—Ç
    });
}

// –£–¥–∞–ª–µ–Ω–∏–µ –∞–∫—Å–µ—Å—Å—É–∞—Ä–∞
export function useDeleteAccessory() {
    const queryClient = useQueryClient();
    return useMutation({
        mutationFn: (id: number) => api.delete(`/accessories/${id}`),
        onSuccess: () => {
            void queryClient.invalidateQueries({ queryKey: ["accessories"] });
            toast.success("–ê–∫—Å–µ—Å—Å—É–∞—Ä —É–¥–∞–ª–µ–Ω");
        },
        onError: (error: any) => {
            toast.error(error?.response?.data?.detail || "–û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ –∞–∫—Å–µ—Å—Å—É–∞—Ä–∞");
        },
    });
}

```


## <a name="rentalappmainsrchooksuseAdminAssociationsts"></a>`rental-app-main/src/hooks/useAdminAssociations.ts`

```typescript
// path: rental-app-main/src/hooks/useAdminAssociations.ts

// src/hooks/useAdminAssociations.ts

import { useQuery, useMutation, useQueryClient } from "@tanstack/react-query";
import { api } from "@/lib/api";
import { toast } from "sonner";
// +++ –ù–ê–ß–ê–õ–û –ò–ó–ú–ï–ù–ï–ù–ò–ô: –ò–º–ø–æ—Ä—Ç–∏—Ä—É–µ–º —Ç–∏–ø –¥–ª—è –æ—Ç–≤–µ—Ç–∞ —Å –ø–∞–≥–∏–Ω–∞—Ü–∏–µ–π +++
import type { Association, AssociationCreate, AssociationUpdate, AssociationListResponse } from "@/types/association";
// +++ –ö–û–ù–ï–¶ –ò–ó–ú–ï–ù–ï–ù–ò–ô +++

const ADMIN_ASSOCIATIONS_KEY = ["admin", "associations"];

// –•—É–∫ –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö —Ç–∞–∫–æ–π –∂–µ, –∫–∞–∫ –∏ –ø—É–±–ª–∏—á–Ω—ã–π, –Ω–æ —Å –¥—Ä—É–≥–∏–º –∫–ª—é—á–æ–º
export function useAdminAssociations() {
    // +++ –ù–ê–ß–ê–õ–û –ò–ó–ú–ï–ù–ï–ù–ò–ô: –ò—Å–ø—Ä–∞–≤–ª—è–µ–º —Ö—É–∫ –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –æ–±—ä–µ–∫—Ç–æ–º –æ—Ç–≤–µ—Ç–∞ +++
    return useQuery<AssociationListResponse, Error, Association[]>({
        queryKey: ADMIN_ASSOCIATIONS_KEY,
        queryFn: async () => {
            // 1. –û–∂–∏–¥–∞–µ–º –æ—Ç API –æ–±—ä–µ–∫—Ç AssociationListResponse
            const response = await api.get<AssociationListResponse>("/associations/");
            return response.data; // –í–æ–∑–≤—Ä–∞—â–∞–µ–º –≤–µ—Å—å –æ–±—ä–µ–∫—Ç { items: [...], total: ... }
        },
        // 2. –° –ø–æ–º–æ—â—å—é `select` –∏–∑–≤–ª–µ–∫–∞–µ–º –∏ –≤–æ–∑–≤—Ä–∞—â–∞–µ–º —Ç–æ–ª—å–∫–æ –º–∞—Å—Å–∏–≤ `items`
        select: (data) => data.items,
    });
    // +++ –ö–û–ù–ï–¶ –ò–ó–ú–ï–ù–ï–ù–ò–ô +++
}

export function useCreateAssociation() {
    const queryClient = useQueryClient();
    return useMutation({
        mutationFn: (data: AssociationCreate) => api.post<Association>("/associations/", data),
        onSuccess: () => {
            void queryClient.invalidateQueries({ queryKey: ADMIN_ASSOCIATIONS_KEY });
            toast.success("–ê—Å—Å–æ—Ü–∏–∞—Ü–∏—è —É—Å–ø–µ—à–Ω–æ —Å–æ–∑–¥–∞–Ω–∞");
        },
        onError: (e: any) => toast.error(e.response?.data?.detail || "–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è"),
    });
}

export function useUpdateAssociation() {
    const queryClient = useQueryClient();
    return useMutation({
        mutationFn: ({ id, data }: { id: number, data: AssociationUpdate }) =>
            api.put<Association>(`/associations/${id}`, data),
        onSuccess: () => {
            void queryClient.invalidateQueries({ queryKey: ADMIN_ASSOCIATIONS_KEY });
            toast.success("–ê—Å—Å–æ—Ü–∏–∞—Ü–∏—è —É—Å–ø–µ—à–Ω–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∞");
        },
        onError: (e: any) => toast.error(e.response?.data?.detail || "–û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è"),
    });
}

export function useDeleteAssociation() {
    const queryClient = useQueryClient();
    return useMutation({
        mutationFn: (id: number) => api.delete(`/associations/${id}`),
        onSuccess: () => {
            void queryClient.invalidateQueries({ queryKey: ADMIN_ASSOCIATIONS_KEY });
            toast.success("–ê—Å—Å–æ—Ü–∏–∞—Ü–∏—è —É–¥–∞–ª–µ–Ω–∞");
        },
        onError: (e: any) => toast.error(e.response?.data?.detail || "–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è"),
    });
}

```


## <a name="rentalappmainsrchooksuseAdminDiscountsts"></a>`rental-app-main/src/hooks/useAdminDiscounts.ts`

```typescript
// path: rental-app-main/src/hooks/useAdminDiscounts.ts

// src/hooks/useAdminDiscounts.ts

import { useQuery, useMutation, useQueryClient } from "@tanstack/react-query";
import { api } from "@/lib/api";
import { toast } from "sonner";
// +++ –ù–ê–ß–ê–õ–û –ò–ó–ú–ï–ù–ï–ù–ò–ô: –ò—Å–ø—Ä–∞–≤–ª—è–µ–º –∏–º–ø–æ—Ä—Ç +++
import type { DurationDiscount, DiscountPayload, DiscountListResponse } from "@/types/discount";
// +++ –ö–û–ù–ï–¶ –ò–ó–ú–ï–ù–ï–ù–ò–ô +++

const DURATION_DISCOUNTS_KEY = "durationDiscounts";

export const useDurationDiscounts = (page: number = 1, pageSize: number = 10) => {
    const skip = (page - 1) * pageSize;
    return useQuery<DiscountListResponse>({
        queryKey: [DURATION_DISCOUNTS_KEY, page, pageSize],
        queryFn: async () => {
            const response = await api.get<DiscountListResponse>("/discounts/", {
                params: { skip, limit: pageSize }
            });
            return response.data;
        },
    });
};

export const useCreateDurationDiscount = () => {
    const queryClient = useQueryClient();
    return useMutation({
        mutationFn: (data: DiscountPayload) => api.post("/discounts/", data),
        onSuccess: () => {
            toast.success("–ù–æ–≤—ã–π —É—Ä–æ–≤–µ–Ω—å —Å–∫–∏–¥–∫–∏ –¥–æ–±–∞–≤–ª–µ–Ω");
            void queryClient.invalidateQueries({ queryKey: [DURATION_DISCOUNTS_KEY] });
        },
        onError: (e: any) => toast.error(e.response?.data?.detail || "–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è"),
    });
};

export const useUpdateDurationDiscount = () => {
    const queryClient = useQueryClient();
    return useMutation({
        mutationFn: ({ id, ...data }: DurationDiscount) => api.put(`/discounts/${id}`, data),
        onSuccess: () => {
            toast.success("–°–∫–∏–¥–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∞");
            void queryClient.invalidateQueries({ queryKey: [DURATION_DISCOUNTS_KEY] });
        },
        onError: (e: any) => toast.error(e.response?.data?.detail || "–û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è"),
    });
};

export const useDeleteDurationDiscount = () => {
    const queryClient = useQueryClient();
    return useMutation({
        mutationFn: (id: number) => api.delete(`/discounts/${id}`),
        onSuccess: () => {
            toast.success("–°–∫–∏–¥–∫–∞ —É–¥–∞–ª–µ–Ω–∞");
            void queryClient.invalidateQueries({ queryKey: [DURATION_DISCOUNTS_KEY] });
        },
        onError: (e: any) => toast.error(e.response?.data?.detail || "–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è"),
    });
};

```


## <a name="rentalappmainsrchooksuseAdminEquipmentts"></a>`rental-app-main/src/hooks/useAdminEquipment.ts`

```typescript
// path: rental-app-main/src/hooks/useAdminEquipment.ts

//src/hooks/useAdminEquipment.ts


import { useMutation, useQueryClient } from "@tanstack/react-query";
import { api } from "@/lib/api";
import { toast } from "sonner";
import type { Equipment } from "@/types/equipment";

export interface EquipmentCreateData {
    equipment_type: string;
    brand: string;
    name: string;
    serial_number?: string;
    condition?: string;
    daily_rate?: number;
    notes?: string;
    description?: string;
    last_maintenance?: string; // format: YYYY-MM-DD
}

// –°–æ–∑–¥–∞–Ω–∏–µ –Ω–æ–≤–æ–≥–æ –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—è (–¥–ª—è –º–µ–Ω–µ–¥–∂–µ—Ä–æ–≤ –∏ –∞–¥–º–∏–Ω–æ–≤)
export function useCreateEquipment() {
    const queryClient = useQueryClient();

    return useMutation({
        mutationFn: async (equipmentData: EquipmentCreateData) => {
            const response = await api.post<Equipment>("/equipment/", equipmentData);
            return response.data;
        },
        onSuccess: () => {
            queryClient.invalidateQueries({ queryKey: ["equipment"] });
            queryClient.invalidateQueries({ queryKey: ["availability"] });
            queryClient.invalidateQueries({ queryKey: ["calendar-grid"] });
            toast.success("–û–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏–µ —É—Å–ø–µ—à–Ω–æ —Å–æ–∑–¥–∞–Ω–æ");
        },
        onError: (error: any) => {
            toast.error(error?.response?.data?.detail || "–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—è");
        },
    });
}

// –£–¥–∞–ª–µ–Ω–∏–µ –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—è (–¥–ª—è –º–µ–Ω–µ–¥–∂–µ—Ä–æ–≤ –∏ –∞–¥–º–∏–Ω–æ–≤)
export function useDeleteEquipment() {
    const queryClient = useQueryClient();

    return useMutation({
        mutationFn: async (equipmentId: number) => {
            const response = await api.delete(`/equipment/${equipmentId}`);
            return response.data;
        },
        onSuccess: () => {
            queryClient.invalidateQueries({ queryKey: ["equipment"] });
            queryClient.invalidateQueries({ queryKey: ["availability"] });
            queryClient.invalidateQueries({ queryKey: ["calendar-grid"] });
            toast.success("–û–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏–µ —É–¥–∞–ª–µ–Ω–æ");
        },
        onError: (error: any) => {
            toast.error(error?.response?.data?.detail || "–û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—è");
        },
    });
}

// –ú–∞—Å—Å–æ–≤–æ–µ —É–¥–∞–ª–µ–Ω–∏–µ –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—è
export function useBulkDeleteEquipment() {
    const queryClient = useQueryClient();

    return useMutation({
        mutationFn: async (equipmentIds: number[]) => {
            // –í—ã–ø–æ–ª–Ω—è–µ–º –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ–µ —É–¥–∞–ª–µ–Ω–∏–µ
            const deletePromises = equipmentIds.map(id => 
                api.delete(`/equipment/${id}`)
            );
            await Promise.all(deletePromises);
            return { deleted_count: equipmentIds.length };
        },
        onSuccess: (data) => {
            queryClient.invalidateQueries({ queryKey: ["equipment"] });
            queryClient.invalidateQueries({ queryKey: ["availability"] });
            queryClient.invalidateQueries({ queryKey: ["calendar-grid"] });
            toast.success(`–£–¥–∞–ª–µ–Ω–æ ${data.deleted_count} –µ–¥–∏–Ω–∏—Ü –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—è`);
        },
        onError: (error: any) => {
            toast.error("–û—à–∏–±–∫–∞ –ø—Ä–∏ –º–∞—Å—Å–æ–≤–æ–º —É–¥–∞–ª–µ–Ω–∏–∏ –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—è");
        },
    });
}

// –ú–∞—Å—Å–æ–≤–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Ç–∞—Ä–∏—Ñ–æ–≤
export function useBulkUpdateRates() {
    const queryClient = useQueryClient();

    return useMutation({
        mutationFn: async (updates: { id: number; daily_rate: number }[]) => {
            // –í—ã–ø–æ–ª–Ω—è–µ–º –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ
            const updatePromises = updates.map(({ id, daily_rate }) => 
                api.put(`/equipment/${id}`, { daily_rate })
            );
            await Promise.all(updatePromises);
            return { updated_count: updates.length };
        },
        onSuccess: (data) => {
            queryClient.invalidateQueries({ queryKey: ["equipment"] });
            toast.success(`–û–±–Ω–æ–≤–ª–µ–Ω—ã —Ç–∞—Ä–∏—Ñ—ã –¥–ª—è ${data.updated_count} –µ–¥–∏–Ω–∏—Ü –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—è`);
        },
        onError: (error: any) => {
            toast.error("–û—à–∏–±–∫–∞ –ø—Ä–∏ –º–∞—Å—Å–æ–≤–æ–º –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ —Ç–∞—Ä–∏—Ñ–æ–≤");
        },
    });
}


```


## <a name="rentalappmainsrchooksuseAdminHolidayRulests"></a>`rental-app-main/src/hooks/useAdminHolidayRules.ts`

```typescript
// path: rental-app-main/src/hooks/useAdminHolidayRules.ts

// src/hooks/useAdminHolidayRules.ts

import { useQuery, useMutation, useQueryClient } from "@tanstack/react-query";
import { toast } from "sonner";
import { api } from "@/lib/api";

// –¢–∏–ø—ã, —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–∏–µ Pydantic-—Å—Ö–µ–º–∞–º –Ω–∞ –±—ç–∫–µ–Ω–¥–µ
interface HolidayRuleOut {
    id: number;
    rule_type: string;
    description: string;
    created_at: string;
}

interface RecurringHolidayRuleCreate {
    day_of_week: number;
    start_date: Date;
    end_date: Date;
    description: string;
}

// +++ –ù–ê–ß–ê–õ–û –ò–ó–ú–ï–ù–ï–ù–ò–ô: –î–æ–±–∞–≤–ª—è–µ–º —Ç–∏–ø –¥–ª—è –æ—Ç–≤–µ—Ç–∞ API +++
interface HolidayRuleListResponse {
    items: HolidayRuleOut[];
    total: number;
}
// +++ –ö–û–ù–ï–¶ –ò–ó–ú–ï–ù–ï–ù–ò–ô +++


const HOLIDAY_RULES_KEY = ["holidayRules"];
const HOLIDAYS_QUERY_KEY = ["holidays"];

// 1. –•—É–∫ –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è —Å–ø–∏—Å–∫–∞ –ø—Ä–∞–≤–∏–ª
export function useGetHolidayRules() {
    // +++ –ù–ê–ß–ê–õ–û –ò–ó–ú–ï–ù–ï–ù–ò–ô: –ò—Å–ø—Ä–∞–≤–ª—è–µ–º —Ö—É–∫ –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –æ–±—ä–µ–∫—Ç–æ–º –æ—Ç–≤–µ—Ç–∞ +++
    return useQuery<HolidayRuleListResponse, Error, HolidayRuleOut[]>({
        queryKey: HOLIDAY_RULES_KEY,
        queryFn: async () => {
            // 1. –û–∂–∏–¥–∞–µ–º –æ—Ç API –æ–±—ä–µ–∫—Ç HolidayRuleListResponse
            const response = await api.get<HolidayRuleListResponse>("/holidays/rules");
            return response.data;
        },
        // 2. –° –ø–æ–º–æ—â—å—é `select` –∏–∑–≤–ª–µ–∫–∞–µ–º –∏ –≤–æ–∑–≤—Ä–∞—â–∞–µ–º —Ç–æ–ª—å–∫–æ –º–∞—Å—Å–∏–≤ `items`
        select: (data) => data.items,
    });
    // +++ –ö–û–ù–ï–¶ –ò–ó–ú–ï–ù–ï–ù–ò–ô +++
}

// 2. –•—É–∫ –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –ø—Ä–∞–≤–∏–ª–∞ –µ–∂–µ–Ω–µ–¥–µ–ª—å–Ω—ã—Ö –≤—ã—Ö–æ–¥–Ω—ã—Ö
export function useCreateWeeklyRule() {
    const queryClient = useQueryClient();
    return useMutation({
        mutationFn: (data: RecurringHolidayRuleCreate) => api.post("/holidays/recurring/weekly", data),
        onSuccess: () => {
            toast.success("–ü—Ä–∞–≤–∏–ª–æ –¥–ª—è –µ–∂–µ–Ω–µ–¥–µ–ª—å–Ω—ã—Ö –≤—ã—Ö–æ–¥–Ω—ã—Ö —É—Å–ø–µ—à–Ω–æ —Å–æ–∑–¥–∞–Ω–æ!");
            void queryClient.invalidateQueries({ queryKey: HOLIDAY_RULES_KEY });
            void queryClient.invalidateQueries({ queryKey: HOLIDAYS_QUERY_KEY });
        },
        onError: (error: any) => {
            toast.error(error.response?.data?.detail || "–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –ø—Ä–∞–≤–∏–ª–∞");
        },
    });
}

// 3. –•—É–∫ –¥–ª—è –∏–º–ø–æ—Ä—Ç–∞ –≥–æ—Å—É–¥–∞—Ä—Å—Ç–≤–µ–Ω–Ω—ã—Ö –ø—Ä–∞–∑–¥–Ω–∏–∫–æ–≤
export function useImportPublicHolidays() {
    const queryClient = useQueryClient();
    return useMutation({
        mutationFn: ({ country_code, year }: { country_code: string; year: number }) =>
            api.post(`/holidays/import/public?country_code=${country_code}&year=${year}`),
        onSuccess: () => {
            toast.success("–ì–æ—Å—É–¥–∞—Ä—Å—Ç–≤–µ–Ω–Ω—ã–µ –ø—Ä–∞–∑–¥–Ω–∏–∫–∏ —É—Å–ø–µ—à–Ω–æ –∏–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω—ã!");
            void queryClient.invalidateQueries({ queryKey: HOLIDAY_RULES_KEY });
            void queryClient.invalidateQueries({ queryKey: HOLIDAYS_QUERY_KEY });
        },
        onError: (error: any) => {
            toast.error(error.response?.data?.detail || "–û—à–∏–±–∫–∞ –ø—Ä–∏ –∏–º–ø–æ—Ä—Ç–µ –ø—Ä–∞–∑–¥–Ω–∏–∫–æ–≤");
        },
    });
}


// 4. –•—É–∫ –¥–ª—è —É–¥–∞–ª–µ–Ω–∏—è –ø—Ä–∞–≤–∏–ª–∞
export function useDeleteHolidayRule() {
    const queryClient = useQueryClient();
    return useMutation({
        mutationFn: (ruleId: number) => api.delete(`/holidays/rules/${ruleId}`),
        onSuccess: () => {
            toast.success("–ü—Ä–∞–≤–∏–ª–æ –∏ —Å–≤—è–∑–∞–Ω–Ω—ã–µ —Å –Ω–∏–º –≤—ã—Ö–æ–¥–Ω—ã–µ —É–¥–∞–ª–µ–Ω—ã.");
            void queryClient.invalidateQueries({ queryKey: HOLIDAY_RULES_KEY });
            void queryClient.invalidateQueries({ queryKey: HOLIDAYS_QUERY_KEY });
        },
        onError: (error: any) => {
            toast.error(error.response?.data?.detail || "–û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ –ø—Ä–∞–≤–∏–ª–∞");
        },
    });
}

```


## <a name="rentalappmainsrchooksuseAdminHolidaysts"></a>`rental-app-main/src/hooks/useAdminHolidays.ts`

```typescript
// path: rental-app-main/src/hooks/useAdminHolidays.ts

// src/hooks/useAdminHolidays.ts

import { useQuery, useMutation, useQueryClient } from "@tanstack/react-query";
import { toast } from "sonner";
import { api } from "@/lib/api";
import { formatDate } from "@/lib/utils";
import type { AxiosError } from "axios";
// +++ –ù–ê–ß–ê–õ–û –ò–ó–ú–ï–ù–ï–ù–ò–ô: –ò–º–ø–æ—Ä—Ç–∏—Ä—É–µ–º –Ω—É–∂–Ω—ã–µ —Ç–∏–ø—ã +++
import type { Holiday, HolidayListResponse } from "@/types/holiday";
// +++ –ö–û–ù–ï–¶ –ò–ó–ú–ï–ù–ï–ù–ò–ô +++


// –ù–æ–≤—ã–π —Ç–∏–ø –¥–ª—è –≤–Ω—É—Ç—Ä–µ–Ω–Ω–µ–≥–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è, –≥–¥–µ date —è–≤–ª—è–µ—Ç—Å—è –æ–±—ä–µ–∫—Ç–æ–º Date
export interface HolidayWithDate extends Omit<Holiday, 'date'> {
    date: Date;
}

export interface HolidayCreatePayload {
    date: string; // YYYY-MM-DD
    description?: string;
    force?: boolean; // –§–ª–∞–≥ –¥–ª—è –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è —Å–æ–∑–¥–∞–Ω–∏—è –ø—Ä–∏ –∫–æ–Ω—Ñ–ª–∏–∫—Ç–∞—Ö
}

// –¢–∏–ø –¥–ª—è –æ—à–∏–±–∫–∏ –∫–æ–Ω—Ñ–ª–∏–∫—Ç–∞ –æ—Ç API
interface ConflictErrorData {
    detail: {
        message: string;
        conflicting_reservation_ids: number[];
    };
}

const HOLIDAYS_QUERY_KEY = "holidays";

/**
 * –•—É–∫ –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è —Å–ø–∏—Å–∫–∞ –≤—ã—Ö–æ–¥–Ω—ã—Ö –≤ –∑–∞–¥–∞–Ω–Ω–æ–º –¥–∏–∞–ø–∞–∑–æ–Ω–µ –¥–∞—Ç.
 */
export function useHolidays(startDate: Date, endDate: Date) {
    const formattedStart = formatDate(startDate);
    const formattedEnd = formatDate(endDate);

    // +++ –ù–ê–ß–ê–õ–û –ò–ó–ú–ï–ù–ï–ù–ò–ô: –ü–æ–ª–Ω–æ—Å—Ç—å—é –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–Ω—ã–π —Ö—É–∫ +++
    return useQuery<HolidayListResponse, Error, HolidayWithDate[]>({
        queryKey: [HOLIDAYS_QUERY_KEY, formattedStart, formattedEnd],
        queryFn: async () => {
            const response = await api.get<HolidayListResponse>("/holidays/", {
                params: {
                    start_date: formattedStart,
                    end_date: formattedEnd,
                    // 1. –î–æ–±–∞–≤–ª—è–µ–º –Ω–µ–¥–æ—Å—Ç–∞—é—â–∏–π –ø–∞—Ä–∞–º–µ—Ç—Ä limit
                    limit: 100,
                },
            });
            return response.data; // –í–æ–∑–≤—Ä–∞—â–∞–µ–º –≤–µ—Å—å –æ–±—ä–µ–∫—Ç { items: [...], total: ... }
        },
        // 2. –° –ø–æ–º–æ—â—å—é `select` –∏–∑–≤–ª–µ–∫–∞–µ–º –º–∞—Å—Å–∏–≤ items –∏ –ø—Ä–µ–æ–±—Ä–∞–∑—É–µ–º –¥–∞—Ç—ã
        select: (data) => {
            return data.items.map(h => ({ ...h, date: new Date(h.date) }));
        },
        enabled: !!startDate && !!endDate,
    });
    // +++ –ö–û–ù–ï–¶ –ò–ó–ú–ï–ù–ï–ù–ò–ô +++
}

/**
 * –•—É–∫ –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –Ω–æ–≤–æ–≥–æ –≤—ã—Ö–æ–¥–Ω–æ–≥–æ –¥–Ω—è.
 * –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç —Å–ø–µ—Ü–∏—Ñ–∏—á–µ—Å–∫—É—é –æ—à–∏–±–∫—É –∫–æ–Ω—Ñ–ª–∏–∫—Ç–∞ (409).
 */
export function useCreateHoliday() {
    const queryClient = useQueryClient();
    return useMutation<unknown, AxiosError<ConflictErrorData>, HolidayCreatePayload>({
        mutationFn: (data) => api.post("/holidays/", data),
        onSuccess: () => {
            toast.success("–í—ã—Ö–æ–¥–Ω–æ–π –¥–µ–Ω—å —É—Å–ø–µ—à–Ω–æ –¥–æ–±–∞–≤–ª–µ–Ω");
            void queryClient.invalidateQueries({ queryKey: [HOLIDAYS_QUERY_KEY] });
        },
        onError: (error) => {
            if (error.response?.status === 409) {
                // –û—à–∏–±–∫–∞ –∫–æ–Ω—Ñ–ª–∏–∫—Ç–∞ –±—É–¥–µ—Ç –æ–±—Ä–∞–±–æ—Ç–∞–Ω–∞ –≤ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–µ
                return;
            }
            toast.error(error.response?.data?.detail?.message || "–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –≤—ã—Ö–æ–¥–Ω–æ–≥–æ –¥–Ω—è");
        },
    });
}

/**
 * –•—É–∫ –¥–ª—è —É–¥–∞–ª–µ–Ω–∏—è –≤—ã—Ö–æ–¥–Ω–æ–≥–æ –¥–Ω—è.
 */
export function useDeleteHoliday() {
    const queryClient = useQueryClient();
    return useMutation({
        mutationFn: (date: Date) => api.delete(`/holidays/${formatDate(date)}`),
        onSuccess: () => {
            toast.success("–í—ã—Ö–æ–¥–Ω–æ–π –¥–µ–Ω—å —É–¥–∞–ª–µ–Ω");
            void queryClient.invalidateQueries({ queryKey: [HOLIDAYS_QUERY_KEY] });
        },
        onError: (error: any) => {
            toast.error(error.response?.data?.detail || "–û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ –≤—ã—Ö–æ–¥–Ω–æ–≥–æ –¥–Ω—è");
        },
    });
}

```


## <a name="rentalappmainsrchooksuseAdminPromoCodests"></a>`rental-app-main/src/hooks/useAdminPromoCodes.ts`

```typescript
// path: rental-app-main/src/hooks/useAdminPromoCodes.ts

// src/hooks/useAdminPromoCodes.ts

import { useQuery, useMutation, useQueryClient } from "@tanstack/react-query";
import { api } from "@/lib/api";
import { toast } from "sonner";
// +++ –ù–ê–ß–ê–õ–û –ò–ó–ú–ï–ù–ï–ù–ò–ô: –ò–º–ø–æ—Ä—Ç–∏—Ä—É–µ–º –Ω–æ–≤—ã–π —Ç–∏–ø +++
import type {
    PromoCodeOut,
    PromoCodeCreate,
    PromoCodeUpdate,
    PromoCodeListResponse
} from "@/types/promo_code";
// +++ –ö–û–ù–ï–¶ –ò–ó–ú–ï–ù–ï–ù–ò–ô +++

const PROMO_CODES_QUERY_KEY = ["admin", "promocodes"];

/**
 * –•—É–∫ –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è —Å–ø–∏—Å–∫–∞ –≤—Å–µ—Ö –ø—Ä–æ–º–æ–∫–æ–¥–æ–≤.
 */
export function useAdminPromoCodes() {
    // +++ –ù–ê–ß–ê–õ–û –ò–ó–ú–ï–ù–ï–ù–ò–ô: –ü–æ–ª–Ω–æ—Å—Ç—å—é –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–Ω—ã–π —Ö—É–∫ +++
    return useQuery<PromoCodeListResponse, Error, PromoCodeOut[]>({
        queryKey: PROMO_CODES_QUERY_KEY,
        queryFn: async () => {
            // 1. –£–∫–∞–∑—ã–≤–∞–µ–º, —á—Ç–æ API –≤–µ—Ä–Ω–µ—Ç –æ–±—ä–µ–∫—Ç PromoCodeListResponse
            const response = await api.get<PromoCodeListResponse>("/promocodes/");
            // 2. –í–æ–∑–≤—Ä–∞—â–∞–µ–º –≤–µ—Å—å –æ–±—ä–µ–∫—Ç { items: [...], total: ... }
            return response.data;
        },
        // 3. –° –ø–æ–º–æ—â—å—é –æ–ø—Ü–∏–∏ `select` –∏–∑–≤–ª–µ–∫–∞–µ–º —Ç–æ–ª—å–∫–æ –º–∞—Å—Å–∏–≤ `items`.
        //    –ö–æ–º–ø–æ–Ω–µ–Ω—Ç, –∏—Å–ø–æ–ª—å–∑—É—é—â–∏–π —Ö—É–∫, –ø–æ–ª—É—á–∏—Ç —É–∂–µ –≥–æ—Ç–æ–≤—ã–π –º–∞—Å—Å–∏–≤.
        select: (data) => data.items,
        staleTime: 5 * 60 * 1000, // 5 –º–∏–Ω—É—Ç
    });
    // +++ –ö–û–ù–ï–¶ –ò–ó–ú–ï–ù–ï–ù–ò–ô +++
}

/**
 * –ó–∞–ø—Ä–∞—à–∏–≤–∞–µ—Ç –Ω–æ–≤—ã–π —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –∫–æ–¥ —Å –±—ç–∫–µ–Ω–¥–∞.
 */
export async function fetchGeneratedPromoCode(): Promise<string> {
    try {
        const response = await api.get<{ generated_code: string }>("/promocodes/generate/new-code");
        return response.data.generated_code;
    } catch (error) {
        toast.error("–û—à–∏–±–∫–∞ –ø—Ä–∏ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –∫–æ–¥–∞");
        console.error("Failed to generate promo code:", error);
        return "";
    }
}

/**
 * –•—É–∫ –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –Ω–æ–≤–æ–≥–æ –ø—Ä–æ–º–æ–∫–æ–¥–∞.
 */
export function useCreatePromoCode() {
    const queryClient = useQueryClient();
    return useMutation({
        mutationFn: async (data: PromoCodeCreate) => {
            const response = await api.post<PromoCodeOut>("/promocodes/", data);
            return response.data;
        },
        onSuccess: () => {
            void queryClient.invalidateQueries({ queryKey: PROMO_CODES_QUERY_KEY });
            toast.success("–ü—Ä–æ–º–æ–∫–æ–¥ —É—Å–ø–µ—à–Ω–æ —Å–æ–∑–¥–∞–Ω");
        },
        onError: (error: any) => {
            toast.error(error?.response?.data?.detail || "–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –ø—Ä–æ–º–æ–∫–æ–¥–∞");
        },
    });
}

/**
 * –•—É–∫ –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –ø—Ä–æ–º–æ–∫–æ–¥–∞.
 */
export function useUpdatePromoCode() {
    const queryClient = useQueryClient();
    return useMutation({
        mutationFn: async ({ id, data }: { id: number; data: PromoCodeUpdate }) => {
            const response = await api.put<PromoCodeOut>(`/promocodes/${id}`, data);
            return response.data;
        },
        onSuccess: (updatedPromoCode) => {
            void queryClient.invalidateQueries({ queryKey: PROMO_CODES_QUERY_KEY });
            toast.success(`–ü—Ä–æ–º–æ–∫–æ–¥ "${updatedPromoCode.code}" —É—Å–ø–µ—à–Ω–æ –æ–±–Ω–æ–≤–ª–µ–Ω`);
        },
        onError: (error: any) => {
            toast.error(error?.response?.data?.detail || "–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ –ø—Ä–æ–º–æ–∫–æ–¥–∞");
        },
    });
}

/**
 * –•—É–∫ –¥–ª—è —É–¥–∞–ª–µ–Ω–∏—è –ø—Ä–æ–º–æ–∫–æ–¥–∞.
 */
export function useDeletePromoCode() {
    const queryClient = useQueryClient();
    return useMutation({
        mutationFn: (id: number) => api.delete(`/promocodes/${id}`),
        onSuccess: () => {
            void queryClient.invalidateQueries({ queryKey: PROMO_CODES_QUERY_KEY });
            toast.success("–ü—Ä–æ–º–æ–∫–æ–¥ —É–¥–∞–ª–µ–Ω");
        },
        onError: (error: any) => {
            toast.error(error?.response?.data?.detail || "–û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ –ø—Ä–æ–º–æ–∫–æ–¥–∞");
        },
    });
}

```


## <a name="rentalappmainsrchooksuseAdminRentalsts"></a>`rental-app-main/src/hooks/useAdminRentals.ts`

```typescript
// path: rental-app-main/src/hooks/useAdminRentals.ts

// src/hooks/useAdminRentals.ts

import { useInfiniteQuery, useMutation, useQueryClient, type QueryFunctionContext } from "@tanstack/react-query";
import { toast } from "sonner";
import { api } from "@/lib/api";
// +++ –ò–ó–ú–ï–ù–ï–ù–ò–ï: –ò–º–ø–æ—Ä—Ç–∏—Ä—É–µ–º –æ–±–Ω–æ–≤–ª–µ–Ω–Ω—ã–µ —Ç–∏–ø—ã +++
import type { AdminRentalListResponse, RentalReturnRequest, AdminRentalOut } from "@/types/rental";


export interface AdminRentalsParams {
    status?: "active" | "overdue" | "completed" | null;
    search?: string;
    limit?: number;
}

const ADMIN_RENTALS_QUERY_KEY = ["adminRentals"];
const ADMIN_RESERVATIONS_QUERY_KEY = ["adminReservations"];

interface ConvertReservationPayload {
    reservationId: number;
    data: {
        notes_on_issue?: string;
        deposit_amount: number;
        prepayment_amount?: number;
        force_issue_on_holiday?: boolean;
    };
}

// +++ –ù–ê–ß–ê–õ–û: –û–ë–ù–û–í–õ–ï–ù–ù–´–ô –¢–ò–ü –î–õ–Ø PAYLOAD –í–û–ó–í–†–ê–¢–ê +++
interface ReturnRentalPayload {
    rentalId: number;
    data: RentalReturnRequest;
}
// +++ –ö–û–ù–ï–¶: –û–ë–ù–û–í–õ–ï–ù–ù–û–ì–û –¢–ò–ü–ê +++


export function useAdminRentals(params: AdminRentalsParams = {}) {
    const { limit = 10, ...otherParams } = params;

    return useInfiniteQuery<AdminRentalListResponse, Error>({
        queryKey: [ADMIN_RENTALS_QUERY_KEY, otherParams],
        queryFn: async ({ pageParam = 0 }: QueryFunctionContext) => {
            const skip = (pageParam as number) * limit;
            const response = await api.get<AdminRentalListResponse>("/admin/rentals/", {
                params: { ...otherParams, skip, limit },
            });
            return response.data;
        },
        initialPageParam: 0,
        getNextPageParam: (lastPage, allPages) => {
            const loadedItems = allPages.reduce((acc, page) => acc + page.items.length, 0);
            if (loadedItems < lastPage.total) {
                return allPages.length;
            }
            return undefined;
        },
        staleTime: 60 * 1000,
    });
}

export function useConvertReservationToRental() {
    const queryClient = useQueryClient();
    return useMutation({
        mutationFn: ({ reservationId, data }: ConvertReservationPayload) =>
            api.post(`/admin/rentals/from-reservation/${reservationId}`, data),
        onSuccess: async () => {
            toast.success("–†–µ–∑–µ—Ä–≤ —É—Å–ø–µ—à–Ω–æ –∫–æ–Ω–≤–µ—Ä—Ç–∏—Ä–æ–≤–∞–Ω –≤ –∞—Ä–µ–Ω–¥—É!");
            await queryClient.invalidateQueries({ queryKey: [ADMIN_RENTALS_QUERY_KEY] });
            await queryClient.invalidateQueries({ queryKey: [ADMIN_RESERVATIONS_QUERY_KEY] });
        },
        onError: (error: any) => {
            console.error("Conversion error:", error);
            throw error;
        },
    });
}

export function useDeleteAdminRental() {
    const queryClient = useQueryClient();
    return useMutation({
        mutationFn: (rentalId: number) => api.delete(`/admin/rentals/${rentalId}`),
        onSuccess: async () => {
            toast.success("–ê—Ä–µ–Ω–¥–∞ —É—Å–ø–µ—à–Ω–æ —É–¥–∞–ª–µ–Ω–∞");
            await queryClient.invalidateQueries({ queryKey: [ADMIN_RENTALS_QUERY_KEY] });
        },
        onError: (error: any) => {
            toast.error(error?.response?.data?.detail || "–û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ –∞—Ä–µ–Ω–¥—ã");
        },
    });
}

export function useReturnRental() {
    const queryClient = useQueryClient();
    return useMutation({
        // +++ –ò–ó–ú–ï–ù–ï–ù–ò–ï: –ú—É—Ç–∞—Ü–∏—è —Ç–µ–ø–µ—Ä—å –ø—Ä–∏–Ω–∏–º–∞–µ—Ç –Ω–æ–≤—ã–π payload +++
        mutationFn: ({ rentalId, data }: ReturnRentalPayload) =>
            api.post(`/admin/rentals/${rentalId}/return`, data),
        onSuccess: async (_data, variables) => {
            toast.success("–í–æ–∑–≤—Ä–∞—Ç –∞—Ä–µ–Ω–¥—ã —É—Å–ø–µ—à–Ω–æ –æ—Ñ–æ—Ä–º–ª–µ–Ω!");
            await queryClient.invalidateQueries({ queryKey: [ADMIN_RENTALS_QUERY_KEY] });
            await queryClient.invalidateQueries({ queryKey: ["availability"] });
            await queryClient.invalidateQueries({ queryKey: ["calendar-grid"] });
        },
        onError: (error: any) => {
            toast.error(error?.response?.data?.detail || "–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ñ–æ—Ä–º–ª–µ–Ω–∏–∏ –≤–æ–∑–≤—Ä–∞—Ç–∞");
        },
    });
}

export function useRevertRentalToReservation() {
    const queryClient = useQueryClient();
    return useMutation({
        mutationFn: (rentalId: number) =>
            api.post(`/admin/rentals/${rentalId}/revert-to-reservation`),
        onSuccess: async () => {
            toast.success("–í—ã–¥–∞—á–∞ –∞—Ä–µ–Ω–¥—ã —É—Å–ø–µ—à–Ω–æ –æ—Ç–º–µ–Ω–µ–Ω–∞!");
            await queryClient.invalidateQueries({ queryKey: [ADMIN_RENTALS_QUERY_KEY] });
            await queryClient.invalidateQueries({ queryKey: [ADMIN_RESERVATIONS_QUERY_KEY] });
        },
        onError: (error: any) => {
            const errorMessage = error?.response?.data?.detail || "–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–º–µ–Ω–µ –≤—ã–¥–∞—á–∏ –∞—Ä–µ–Ω–¥—ã";
            toast.error(errorMessage);
        },
    });
}

```


## <a name="rentalappmainsrchooksuseAdminReservationsts"></a>`rental-app-main/src/hooks/useAdminReservations.ts`

```typescript
// path: rental-app-main/src/hooks/useAdminReservations.ts

// src/hooks/useAdminReservations.ts

import { useInfiniteQuery, useMutation, useQueryClient, type QueryFunctionContext } from "@tanstack/react-query";
import { toast } from "sonner";
import { api } from "@/lib/api";
import type { AdminReservationListResponse } from "@/types/reservation";
import { transformAccessoryLinks } from "@/lib/utils";

export interface AdminReservationsParams {
    status?: "active" | "completed" | "fulfilled" | "cancelled" | "overdue" | null;
    search?: string;
    limit?: number;
}

const ADMIN_RESERVATIONS_QUERY_KEY = ["adminReservations"];

export function useAdminReservations(params: AdminReservationsParams = {}) {
    const { limit = 10, ...otherParams } = params;

    return useInfiniteQuery<AdminReservationListResponse, Error>({
        queryKey: [ADMIN_RESERVATIONS_QUERY_KEY, otherParams],
        queryFn: async ({ pageParam = 0 }: QueryFunctionContext) => {
            const skip = (pageParam as number) * limit;
            const response = await api.get<AdminReservationListResponse>("/admin/reservations/", {
                params: { ...otherParams, skip, limit },
            });
            return response.data;
        },
        initialPageParam: 0,
        getNextPageParam: (lastPage, allPages) => {
            const loadedItems = allPages.reduce((acc, page) => acc + page.items.length, 0);
            if (loadedItems < lastPage.total) {
                return allPages.length;
            }
            return undefined;
        },
        staleTime: 60 * 1000,
        select: (data) => ({
            ...data,
            pages: data.pages.map(page => ({
                ...page,
                items: page.items.map(transformAccessoryLinks)
            }))
        }),
    });
}

export function useCreateAdminReservation() {
    const queryClient = useQueryClient();
    return useMutation({
        mutationFn: (data: any) => api.post("/admin/reservations/", data),
        onSuccess: async () => {
            toast.success("–†–µ–∑–µ—Ä–≤ —É—Å–ø–µ—à–Ω–æ —Å–æ–∑–¥–∞–Ω");
            await queryClient.invalidateQueries({ queryKey: [ADMIN_RESERVATIONS_QUERY_KEY] });
        },
        onError: (error: any) => {
            toast.error(error?.response?.data?.detail || "–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ —Ä–µ–∑–µ—Ä–≤–∞");
        },
    });
}

export function useDeleteAdminReservation() {
    const queryClient = useQueryClient();
    return useMutation({
        mutationFn: (reservationId: number) => api.delete(`/admin/reservations/${reservationId}`),
        onSuccess: async () => {
            toast.success("–†–µ–∑–µ—Ä–≤ —É—Å–ø–µ—à–Ω–æ —É–¥–∞–ª–µ–Ω");
            await queryClient.invalidateQueries({ queryKey: [ADMIN_RESERVATIONS_QUERY_KEY] });
        },
        onError: (error: any) => {
            toast.error(error?.response?.data?.detail || "–û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ —Ä–µ–∑–µ—Ä–≤–∞");
        },
    });
}

export function useBulkDeleteAdminReservations() {
    const queryClient = useQueryClient();
    return useMutation({
        mutationFn: (reservationIds: number[]) => {
            const payload = { reservation_ids: reservationIds };

            // --- –ò–ó–ú–ï–ù–ï–ù–ò–ï: –ü–û–õ–ù–û–°–¢–¨–Æ –ú–ï–ù–Ø–ï–ú –ü–£–¢–¨ ---
            return api.post(`/admin/reservations/delete-many`, payload);
        },
        onSuccess: async () => {
            toast.success("–í—ã–±—Ä–∞–Ω–Ω—ã–µ —Ä–µ–∑–µ—Ä–≤—ã —É—Å–ø–µ—à–Ω–æ —É–¥–∞–ª–µ–Ω—ã");
            await queryClient.invalidateQueries({ queryKey: [ADMIN_RESERVATIONS_QUERY_KEY] });
        },
        onError: (error: any) => {
            toast.error(error?.response?.data?.detail || "–û—à–∏–±–∫–∞ –ø—Ä–∏ –º–∞—Å—Å–æ–≤–æ–º —É–¥–∞–ª–µ–Ω–∏–∏ —Ä–µ–∑–µ—Ä–≤–æ–≤");
        },
    });
}

```


## <a name="rentalappmainsrchooksuseAdminUsersts"></a>`rental-app-main/src/hooks/useAdminUsers.ts`

```typescript
// path: rental-app-main/src/hooks/useAdminUsers.ts

// src/hooks/useAdminUsers.ts

import { useQuery, useInfiniteQuery, useMutation, useQueryClient } from "@tanstack/react-query";
import { UserService } from "@/core/services";
import { toast } from "sonner";
import type { UserListResponse, UserRole, UserPaymentRequest } from "@/types/user";
import type { AdminUserCreateFormSchema, AdminUserUpdateSchema } from "@/lib/validationSchemas";

// –¢–∏–ø –¥–ª—è –¥–∞–Ω–Ω—ã—Ö, –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º—ã—Ö –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏
type AdminUserUpdatePayload = {
    userId: number;
    data: AdminUserUpdateSchema;
};

// –°–æ–∑–¥–∞–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (—Ç–æ–ª—å–∫–æ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä)
export function useAdminCreateUser() {
    const queryClient = useQueryClient();
    return useMutation({
        mutationFn: async (userData: AdminUserCreateFormSchema) => {
            return await UserService.createUser(userData);
        },
        onSuccess: () => {
            void queryClient.invalidateQueries({ queryKey: ["admin", "users"] });
            toast.success("–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —É—Å–ø–µ—à–Ω–æ —Å–æ–∑–¥–∞–Ω");
        },
        onError: (error: unknown) => {
            const apiError = error as { response?: { data?: { detail?: string } } }
            toast.error(apiError?.response?.data?.detail || "–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è");
        },
    });
}

// –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (–∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä/–º–µ–Ω–µ–¥–∂–µ—Ä)
export function useAdminUpdateUser() {
    const queryClient = useQueryClient();
    return useMutation({
        mutationFn: async ({ userId, data }: AdminUserUpdatePayload) => {
            return await UserService.updateUser({ id: userId, ...data });
        },
        onSuccess: (updatedUser) => {
            void queryClient.invalidateQueries({ queryKey: ["admin", "users"] });
            toast.success(`–ü—Ä–æ—Ñ–∏–ª—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è ${updatedUser.full_name} —É—Å–ø–µ—à–Ω–æ –æ–±–Ω–æ–≤–ª–µ–Ω.`);
        },
        onError: (error: unknown) => {
            const apiError = error as { response?: { data?: { detail?: string } } }
            toast.error(apiError?.response?.data?.detail || "–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ –ø—Ä–æ—Ñ–∏–ª—è.");
        }
    });
}

// –ü–æ–ª—É—á–µ–Ω–∏–µ –≤—Å–µ—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π —Å –ø–∞–≥–∏–Ω–∞—Ü–∏–µ–π (–¥–ª—è –º–µ–Ω–µ–¥–∂–µ—Ä–æ–≤ –∏ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–≤)
export function useAdminUsers() {
    return useInfiniteQuery<UserListResponse>({
        queryKey: ["admin", "users"],
        queryFn: async ({ pageParam = 0 }) => {
            const skip = (pageParam as number) * 15; // 15 –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—É
            return await UserService.getAllUsers(skip, 15);
        },
        initialPageParam: 0,
        getNextPageParam: (lastPage, allPages) => {
            const totalLoaded = allPages.reduce((acc, page) => acc + page.items.length, 0);
            return totalLoaded < lastPage.total ? allPages.length : undefined;
        },
        staleTime: 5 * 60 * 1000, // 5 –º–∏–Ω—É—Ç
    });
}

// –ò–∑–º–µ–Ω–µ–Ω–∏–µ —Ä–æ–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (—Ç–æ–ª—å–∫–æ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä)
export function useUpdateUserRole() {
    const queryClient = useQueryClient();
    return useMutation({
        // –ò–ó–ú–ï–ù–ï–ù–ò–ï: –£–∫–∞–∑—ã–≤–∞–µ–º –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–π —Ç–∏–ø UserRole –≤–º–µ—Å—Ç–æ string
        mutationFn: async ({ userId, newRole }: { userId: number; newRole: UserRole }) => {
            return await UserService.updateUserRole(userId, newRole);
        },
        onSuccess: () => {
            void queryClient.invalidateQueries({ queryKey: ["admin", "users"] });
            toast.success("–†–æ–ª—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è —É—Å–ø–µ—à–Ω–æ –∏–∑–º–µ–Ω–µ–Ω–∞");
        },
        onError: (error: unknown) => {
            const apiError = error as { response?: { data?: { detail?: string } } }
            toast.error(apiError?.response?.data?.detail || "–û—à–∏–±–∫–∞ –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ —Ä–æ–ª–∏");
        },
    });
}

// –ë–ª–æ–∫–∏—Ä–æ–≤–∫–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (—Ç–æ–ª—å–∫–æ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä)
export function useBlockUser() {
    const queryClient = useQueryClient();
    return useMutation({
        mutationFn: async (userId: number) => {
            return await UserService.toggleUserStatus(userId, false);
        },
        onSuccess: () => {
            void queryClient.invalidateQueries({ queryKey: ["admin", "users"] });
            toast.success("–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω");
        },
        onError: (error: unknown) => {
            const apiError = error as { response?: { data?: { detail?: string } } }
            toast.error(apiError?.response?.data?.detail || "–û—à–∏–±–∫–∞ –ø—Ä–∏ –±–ª–æ–∫–∏—Ä–æ–≤–∫–µ");
        },
    });
}

// –†–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∫–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (—Ç–æ–ª—å–∫–æ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä)
export function useUnblockUser() {
    const queryClient = useQueryClient();
    return useMutation({
        mutationFn: async (userId: number) => {
            return await UserService.toggleUserStatus(userId, true);
        },
        onSuccess: () => {
            void queryClient.invalidateQueries({ queryKey: ["admin", "users"] });
            toast.success("–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Ä–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω");
        },
        onError: (error: unknown) => {
            const apiError = error as { response?: { data?: { detail?: string } } }
            toast.error(apiError?.response?.data?.detail || "–û—à–∏–±–∫–∞ –ø—Ä–∏ —Ä–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∫–µ");
        },
    });
}

// –£–¥–∞–ª–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (—Ç–æ–ª—å–∫–æ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä)
export function useDeleteUser() {
    const queryClient = useQueryClient();
    return useMutation({
        mutationFn: async (userId: number) => {
            await UserService.deleteUser(userId);
        },
        onSuccess: () => {
            void queryClient.invalidateQueries({ queryKey: ["admin", "users"] });
            toast.success("–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∏ —Å–≤—è–∑–∞–Ω–Ω—ã–π –∫–ª–∏–µ–Ω—Ç —É–¥–∞–ª–µ–Ω—ã");
        },
        onError: (error: unknown) => {
            const apiError = error as { response?: { data?: { detail?: string } } }
            toast.error(apiError?.response?.data?.detail || "–û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏");
        },
    });
}

/**
 * –•—É–∫ –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –ø–ª–∞—Ç–µ–∂–∞ –∏ –ø–æ–ø–æ–ª–Ω–µ–Ω–∏—è –±–∞–ª–∞–Ω—Å–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è.
 */
export function useAddUserPayment() {
    const queryClient = useQueryClient();
    return useMutation({
        mutationFn: async ({ userId, data }: { userId: number; data: UserPaymentRequest }) => {
            return await UserService.addUserPayment(userId, data);
        },
        onSuccess: (updatedUser) => {
            void queryClient.invalidateQueries({ queryKey: ["admin", "users"] });
            // –ú–æ–∂–Ω–æ —Ç–∞–∫–∂–µ —Ç–æ—á–µ—á–Ω–æ –æ–±–Ω–æ–≤–∏—Ç—å –∫—ç—à –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è, –µ—Å–ª–∏ –æ–Ω –≥–¥–µ-—Ç–æ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è
            toast.success(`–ë–∞–ª–∞–Ω—Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è ${updatedUser.full_name} —É—Å–ø–µ—à–Ω–æ –ø–æ–ø–æ–ª–Ω–µ–Ω.`);
        },
        onError: (error: unknown) => {
            const apiError = error as { response?: { data?: { detail?: string } } };
            toast.error(apiError?.response?.data?.detail || "–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–ø–æ–ª–Ω–µ–Ω–∏–∏ –±–∞–ª–∞–Ω—Å–∞.");
        },
    });
}

```


## <a name="rentalappmainsrchooksuseAllEquipmentts"></a>`rental-app-main/src/hooks/useAllEquipment.ts`

```typescript
// path: rental-app-main/src/hooks/useAllEquipment.ts

// src/hooks/useAllEquipment.ts

import { useQuery } from "@tanstack/react-query";
import { EquipmentService } from "@/core/services";
import { handleQueryError } from "@/lib/queryHelpers";

// –≠—Ç–æ—Ç —Ö—É–∫ –±—É–¥–µ—Ç –∑–∞–≥—Ä—É–∂–∞—Ç—å –í–°–ï –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏–µ –¥–ª—è —Ñ–æ—Ä–º –∏ –≤—ã–ø–∞–¥–∞—é—â–∏—Ö —Å–ø–∏—Å–∫–æ–≤
export function useAllEquipment() {
    return useQuery({
        queryKey: ["allEquipment"], // –£–Ω–∏–∫–∞–ª—å–Ω—ã–π –∫–ª—é—á
        queryFn: async () => {
            try {
                // –ó–∞–ø—Ä–∞—à–∏–≤–∞–µ–º –±–æ–ª—å—à–æ–π –ª–∏–º–∏—Ç, —á—Ç–æ–±—ã –ø–æ–ª—É—á–∏—Ç—å –≤—Å–µ –∑–∞–ø–∏—Å–∏
                const response = await EquipmentService.getAllEquipment(0, 1000);
                return response.items; // –í–æ–∑–≤—Ä–∞—â–∞–µ–º —Ç–æ–ª—å–∫–æ –º–∞—Å—Å–∏–≤
            } catch (error) {
                handleQueryError(error);
                throw error;
            }
        },
        staleTime: 60 * 60 * 1000, // –ö—ç—à–∏—Ä—É–µ–º –Ω–∞ —á–∞—Å
    });
}

```


## <a name="rentalappmainsrchooksuseAssociationsts"></a>`rental-app-main/src/hooks/useAssociations.ts`

```typescript
// path: rental-app-main/src/hooks/useAssociations.ts

// src/hooks/useAssociations.ts

import { useQuery } from "@tanstack/react-query";
import { api } from "@/lib/api";
import type { Association, AssociationListResponse } from "@/types/association"; // –ò–º–ø–æ—Ä—Ç–∏—Ä—É–µ–º –æ–±–∞ —Ç–∏–ø–∞

const ASSOCIATIONS_QUERY_KEY = ["associations"];

export function useAssociations() {
    // –ò–ó–ú–ï–ù–ï–ù–ò–ï: –•—É–∫ —Ç–µ–ø–µ—Ä—å –æ–∂–∏–¥–∞–µ—Ç Association[] –∫–∞–∫ –∫–æ–Ω–µ—á–Ω—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç –¥–ª—è –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–∞
    return useQuery<Association[]>({
        queryKey: ASSOCIATIONS_QUERY_KEY,
        queryFn: async () => {
            // –ó–∞–ø—Ä–∞—à–∏–≤–∞–µ–º —É API –æ–±—ä–µ–∫—Ç AssociationListResponse
            const response = await api.get<AssociationListResponse>("/associations/");
            // –ê –≤–æ–∑–≤—Ä–∞—â–∞–µ–º —Ç–æ–ª—å–∫–æ –º–∞—Å—Å–∏–≤ `items`
            return response.data.items;
        },
        staleTime: 5 * 60 * 1000, // 5 –º–∏–Ω—É—Ç
    });
}

```


## <a name="rentalappmainsrchooksuseAvailabilityCheckts"></a>`rental-app-main/src/hooks/useAvailabilityCheck.ts`

```typescript
// path: rental-app-main/src/hooks/useAvailabilityCheck.ts

// src/hooks/useAvailabilityCheck.ts

import { useQuery } from "@tanstack/react-query";
import { useMemo } from "react";
import { AvailabilityService } from "@/core/services";
import type { AvailabilityInfo } from "@/types/availability";
import { handleQueryError } from "@/lib/queryHelpers";

export interface UseAvailabilityCheckProps {
    equipmentIds: number[];
    startDate: Date;
    endDate: Date;
    excludeReservationId?: number;
    enabled?: boolean;
}

export interface UseAvailabilityCheckReturn {
    isLoading: boolean;
    isError: boolean;
    availabilityMap: Record<number, AvailabilityInfo>;
    conflictingItemIds: number[];
    hasConflicts: boolean;
    error: Error | null;
}

/**
 * –¶–µ–Ω—Ç—Ä–∞–ª—å–Ω—ã–π —Ö—É–∫ –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏ –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—è.
 * –ò—Å–ø–æ–ª—å–∑—É–µ—Ç useQuery –∏–∑ @tanstack/react-query –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –∏ –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö –æ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏.
 * 
 * @param props - –ü–∞—Ä–∞–º–µ—Ç—Ä—ã –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏
 * @returns –û–±—ä–µ–∫—Ç —Å –¥–∞–Ω–Ω—ã–º–∏ –æ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏ –∏ —Å—Ç–∞—Ç—É—Å–æ–º –∑–∞–≥—Ä—É–∑–∫–∏
 */
export function useAvailabilityCheck({
    equipmentIds,
    startDate,
    endDate,
    excludeReservationId,
    enabled = true
}: UseAvailabilityCheckProps): UseAvailabilityCheckReturn {
    
    // –§–æ—Ä–º–∏—Ä—É–µ–º —É–Ω–∏–∫–∞–ª—å–Ω—ã–π queryKey –Ω–∞ –æ—Å–Ω–æ–≤–µ –≤—Ö–æ–¥–Ω—ã—Ö –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤
    const queryKey = useMemo(() => {
        const stringifiedIds = JSON.stringify([...equipmentIds].sort((a, b) => a - b));
        return [
            "availability-check",
            stringifiedIds,
            startDate.toISOString(),
            endDate.toISOString(),
            excludeReservationId
        ] as const;
    }, [equipmentIds, startDate, endDate, excludeReservationId]);

    // –ü—Ä–æ–≤–µ—Ä—è–µ–º –≤–∞–ª–∏–¥–Ω–æ—Å—Ç—å –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤
    const isParamsValid = useMemo(() => {
        return !!(
            equipmentIds.length > 0 &&
            startDate && !isNaN(startDate.getTime()) &&
            endDate && !isNaN(endDate.getTime()) &&
            startDate <= endDate
        );
    }, [equipmentIds, startDate, endDate]);

    const query = useQuery({
        queryKey,
        queryFn: async (): Promise<AvailabilityInfo[]> => {
            if (!isParamsValid) return [];
            
            try {
                return await AvailabilityService.getStatuses({
                    equipmentIds,
                    startDate,
                    endDate,
                    excludeReservationId
                });
            } catch (error: unknown) {
                console.error("[useAvailabilityCheck] Error fetching availability:", error);
                handleQueryError(error);
                throw error;
            }
        },
        enabled: enabled && isParamsValid,
        staleTime: 30 * 1000, // 30 —Å–µ–∫—É–Ω–¥
        gcTime: 5 * 60 * 1000, // 5 –º–∏–Ω—É—Ç
    });

    // –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –¥–∞–Ω–Ω—ã–µ –∏ —Å–æ–∑–¥–∞–µ–º –∫–∞—Ä—Ç—É –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏
    const processedData = useMemo(() => {
        const availabilityData = query.data || [];
        
        // –°–æ–∑–¥–∞–µ–º –∫–∞—Ä—Ç—É –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏ –¥–ª—è –±—ã—Å—Ç—Ä–æ–≥–æ –¥–æ—Å—Ç—É–ø–∞
        const availabilityMap: Record<number, AvailabilityInfo> = {};
        availabilityData.forEach((info) => {
            availabilityMap[info.equipment_id] = info;
        });

        // –ù–∞—Ö–æ–¥–∏–º ID –≤—Å–µ—Ö –∫–æ–Ω—Ñ–ª–∏–∫—Ç–Ω—ã—Ö –ø–æ–∑–∏—Ü–∏–π
        const conflictingItemIds = availabilityData
            .filter(info => info.status === "reserved" || info.status === "rented")
            .map(info => info.equipment_id);

        return {
            availabilityMap,
            conflictingItemIds,
            hasConflicts: conflictingItemIds.length > 0
        };
    }, [query.data]);

    return {
        isLoading: query.isLoading,
        isError: query.isError,
        availabilityMap: processedData.availabilityMap,
        conflictingItemIds: processedData.conflictingItemIds,
        hasConflicts: processedData.hasConflicts,
        error: query.error
    };
}


```


## <a name="rentalappmainsrchooksuseBalanceHistoryts"></a>`rental-app-main/src/hooks/useBalanceHistory.ts`

```typescript
// path: rental-app-main/src/hooks/useBalanceHistory.ts

// src/hooks/useBalanceHistory.ts

import { useQuery } from "@tanstack/react-query";
import { UserService } from "@/core/services";
import type { BalanceHistoryListResponse } from "@/types/balanceHistory";
import { useCurrentUser } from "./useProfile";

const PAGE_SIZE = 15;

/**
 * –•—É–∫ –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –ø–∞–≥–∏–Ω–∏—Ä–æ–≤–∞–Ω–Ω–æ–π –∏—Å—Ç–æ—Ä–∏–∏ –±–∞–ª–∞–Ω—Å–∞ –¢–ï–ö–£–©–ï–ì–û –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è.
 */
export function useBalanceHistory(page: number) {
    const { data: user } = useCurrentUser();

    return useQuery<BalanceHistoryListResponse>({
        queryKey: ["balanceHistory", "me", page],
        queryFn: async () => {
            const skip = (page - 1) * PAGE_SIZE;
            return await UserService.getMyBalanceHistory(skip, PAGE_SIZE);
        },
        enabled: !!user, // –í—ã–ø–æ–ª–Ω—è—Ç—å –∑–∞–ø—Ä–æ—Å —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω
        staleTime: 60 * 1000, // 1 –º–∏–Ω—É—Ç–∞
    });
}

/**
 * –•—É–∫ –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –ø–∞–≥–∏–Ω–∏—Ä–æ–≤–∞–Ω–Ω–æ–π –∏—Å—Ç–æ—Ä–∏–∏ –±–∞–ª–∞–Ω—Å–∞ –õ–Æ–ë–û–ì–û –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (–¥–ª—è –∞–¥–º–∏–Ω–æ–≤).
 */
export function useAdminBalanceHistory(userId: number, page: number) {
    const { data: currentUser } = useCurrentUser();
    const isManager = currentUser?.role === 'admin' || currentUser?.role === 'manager';

    return useQuery<BalanceHistoryListResponse>({
        queryKey: ["balanceHistory", "admin", userId, page],
        queryFn: async () => {
            const skip = (page - 1) * PAGE_SIZE;
            return await UserService.getUserBalanceHistory(userId, skip, PAGE_SIZE);
        },
        enabled: isManager && !!userId, // –í—ã–ø–æ–ª–Ω—è—Ç—å –∑–∞–ø—Ä–æ—Å —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ —Ç–µ–∫—É—â–∏–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å - –∞–¥–º–∏–Ω/–º–µ–Ω–µ–¥–∂–µ—Ä
        staleTime: 60 * 1000,
    });
}

```


## <a name="rentalappmainsrchooksuseCalendarGridts"></a>`rental-app-main/src/hooks/useCalendarGrid.ts`

```typescript
// path: rental-app-main/src/hooks/useCalendarGrid.ts

// src/hooks/useCalendarGrid.ts

import { useQuery } from "@tanstack/react-query"
import { useDateStore } from "@/store/dateStore"
import { useFilterStore } from "@/store/filterStore"
import { useSearchStore } from "@/store/searchStore"
import { useEquipment } from "./useEquipment"
import { formatDate } from "@/lib/utils"
import { CalendarService } from "@/core/services"
import type { CalendarGridData } from "@/core/services"
import { useMemo } from "react" // <-- –î–æ–±–∞–≤–ª—è–µ–º –∏–º–ø–æ—Ä—Ç useMemo

export function useCalendarGrid() {
    const { startDate, endDate } = useDateStore()
    const { type, brand } = useFilterStore()
    const { query } = useSearchStore()
    // –ò–ó–ú–ï–ù–ï–ù–ò–ï: useEquipment –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –æ–±—ä–µ–∫—Ç —Å–æ —Å—Ç—Ä–∞–Ω–∏—Ü–∞–º–∏, –∞ –Ω–µ –ø—Ä–æ—Å—Ç–æ –¥–∞–Ω–Ω—ã–µ
    const { data: equipmentPages, isLoading: isLoadingEquipment } = useEquipment()

    // –ò–ó–ú–ï–ù–ï–ù–ò–ï: "–†–∞–∑–≤–æ—Ä–∞—á–∏–≤–∞–µ–º" –≤—Å–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã –≤ –æ–¥–∏–Ω –ø–ª–æ—Å–∫–∏–π –º–∞—Å—Å–∏–≤
    const allEquipment = useMemo(() =>
            equipmentPages?.pages.flatMap(page => page.items) ?? [],
        [equipmentPages]);

    // –¢–µ–ø–µ—Ä—å —Ñ–∏–ª—å—Ç—Ä—É–µ–º –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π –º–∞—Å—Å–∏–≤ allEquipment
    const filteredIds = CalendarService.filterEquipmentForCalendar(
        allEquipment,
        {
            type: type || undefined,
            brand: brand || undefined,
            query: query || undefined
        }
    )

    const formattedStartDateAPI = startDate ? formatDate(startDate) : null
    const formattedEndDateAPI = endDate ? formatDate(endDate) : null

    const enabled =
        !!formattedStartDateAPI &&
        !!formattedEndDateAPI &&
        !isLoadingEquipment &&
        filteredIds.length > 0

    const queryKey = CalendarService.createQueryKey(
        formattedStartDateAPI!,
        formattedEndDateAPI!,
        filteredIds
    )

    return useQuery<CalendarGridData>({
        queryKey: queryKey,
        queryFn: async () => {
            if (!formattedStartDateAPI || !formattedEndDateAPI) {
                return {}
            }
            if (filteredIds.length === 0) {
                return {}
            }

            return CalendarService.getDayStatuses(
                formattedStartDateAPI,
                formattedEndDateAPI,
                filteredIds
            )
        },
        enabled,
        staleTime: 60 * 1000,
        placeholderData: (previousData) => previousData,
    })
}

```


## <a name="rentalappmainsrchooksuseDailyAvailabilityts"></a>`rental-app-main/src/hooks/useDailyAvailability.ts`

```typescript
// path: rental-app-main/src/hooks/useDailyAvailability.ts

// src/hooks/useDailyAvailability.ts
import { useQuery } from "@tanstack/react-query";
import { api } from "@/lib/api";
import { formatDate } from "@/lib/utils";
import type { DayStatus } from "@/types/availability";

type DailyAvailabilityData = Record<number, Record<string, DayStatus>>; // { equipmentId: { "DD.MM.YYYY": DayStatus } }

type Params = {
    ids: number[];
    start: Date;
    end: Date;
};

export function useDailyAvailability({ ids, start, end }: Params) {
    const formattedStartDate = formatDate(start);
    const formattedEndDate = formatDate(end);

    // Sort IDs to ensure consistent query key
    const sortedIds = JSON.stringify([...ids].sort((a, b) => a - b));

    return useQuery<DailyAvailabilityData>({
        queryKey: ["daily-availability", sortedIds, formattedStartDate, formattedEndDate],
        queryFn: async () => {
            const resp = await api.get("/calendar/day-statuses", {
                params: {
                    start: formattedStartDate,
                    end: formattedEndDate,
                    ids,
                },
            });
            // The actual data is nested inside equipment_day_statuses
            const result = resp.data?.equipment_day_statuses ?? {};
            

            
            return result;
        },
        enabled: ids.length > 0 && !!start && !!end,
        staleTime: 5 * 60 * 1000, // 5 mins
    });
}

```


## <a name="rentalappmainsrchooksuseDateRangets"></a>`rental-app-main/src/hooks/useDateRange.ts`

```typescript
// path: rental-app-main/src/hooks/useDateRange.ts

// src/hooks/useDateRange.ts

import { useState, useEffect } from 'react';
import { formatDate } from '@/lib/utils';
import { DateService } from '@/core/services';

interface UseDateRangeProps {
    startDate: Date;
    endDate: Date;
    onRangeChange: (startDate: Date, endDate: Date, source?: 'calendar' | 'slider' | 'manual', holidays?: Date[]) => void;
    holidays?: Date[];
}

interface UseDateRangeReturn {
    localStartDate: string;
    localEndDate: string;
    handleStartDateChange: (e: React.ChangeEvent<HTMLInputElement>) => void;
    handleEndDateChange: (e: React.ChangeEvent<HTMLInputElement>) => void;
}

export function useDateRange({
                                 startDate,
                                 endDate,
                                 onRangeChange,
                                 holidays = [] // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∑–Ω–∞—á–µ–Ω–∏–µ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
                             }: UseDateRangeProps): UseDateRangeReturn {
    // –õ–æ–∫–∞–ª—å–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ –¥–ª—è input'–æ–≤ –≤—Å–µ–≥–¥–∞ –≤ —Ñ–æ—Ä–º–∞—Ç–µ 'YYYY-MM-DD'
    const [localStartDate, setLocalStartDate] = useState<string>(formatDate(startDate));
    const [localEndDate, setLocalEndDate] = useState<string>(formatDate(endDate));

    // –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä—É–µ–º –ª–æ–∫–∞–ª—å–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ, –µ—Å–ª–∏ –ø—Ä–æ–ø—Å—ã –∏–∑–º–µ–Ω–∏–ª–∏—Å—å –∏–∑–≤–Ω–µ
    useEffect(() => {
        setLocalStartDate(formatDate(startDate));
        setLocalEndDate(formatDate(endDate));
    }, [startDate, endDate]);

    const handleStartDateChange = (e: React.ChangeEvent<HTMLInputElement>) => {
        const newStartDate = new Date(e.target.value);
        if (DateService.isValidDate(newStartDate)) {
            // –ï—Å–ª–∏ –¥–∞—Ç–∞ –æ–∫–æ–Ω—á–∞–Ω–∏—è –æ–∫–∞–∑–∞–ª–∞—Å—å —Ä–∞–Ω—å—à–µ –Ω–æ–≤–æ–π –¥–∞—Ç—ã –Ω–∞—á–∞–ª–∞, –∫–æ—Ä—Ä–µ–∫—Ç–∏—Ä—É–µ–º –µ–µ
            const adjustedRange = DateService.adjustDateRange(newStartDate, endDate);
            // –í—ã–∑—ã–≤–∞–µ–º –∫–æ–ª–±—ç–∫ —Å –æ–±—ä–µ–∫—Ç–∞–º–∏ Date –∏ –ø–µ—Ä–µ–¥–∞–µ–º holidays
            onRangeChange(adjustedRange.startDate, adjustedRange.endDate, 'manual', holidays);
        }
    };

    const handleEndDateChange = (e: React.ChangeEvent<HTMLInputElement>) => {
        const newEndDate = new Date(e.target.value);
        if (DateService.isValidDate(newEndDate)) {
            // –ï—Å–ª–∏ –¥–∞—Ç–∞ –æ–∫–æ–Ω—á–∞–Ω–∏—è –æ–∫–∞–∑–∞–ª–∞—Å—å —Ä–∞–Ω—å—à–µ –¥–∞—Ç—ã –Ω–∞—á–∞–ª–∞, –∫–æ—Ä—Ä–µ–∫—Ç–∏—Ä—É–µ–º –µ–µ
            const adjustedRange = DateService.adjustDateRange(startDate, newEndDate);
            // –í—ã–∑—ã–≤–∞–µ–º –∫–æ–ª–±—ç–∫ —Å –æ–±—ä–µ–∫—Ç–∞–º–∏ Date –∏ –ø–µ—Ä–µ–¥–∞–µ–º holidays
            onRangeChange(adjustedRange.startDate, adjustedRange.endDate, 'manual', holidays);
        }
    };

    return {
        localStartDate,
        localEndDate,
        handleStartDateChange,
        handleEndDateChange,
    };
}

```


## <a name="rentalappmainsrchooksuseEditReservationts"></a>`rental-app-main/src/hooks/useEditReservation.ts`

```typescript
// path: rental-app-main/src/hooks/useEditReservation.ts

// src/hooks/useEditReservation.ts
import { useMutation, useQueryClient } from "@tanstack/react-query";
import { ReservationService } from "@/core/services";

interface EditReservationInput {
    id: number;
    start_date: string;
    end_date: string;
    equipment_ids: number[];
    promo_code?: string;
    selected_accessories?: Record<number, number[]>;
    isAdminContext?: boolean;
    // ‚ú® –ù–û–í–´–ô –§–õ–ê–ì
    confirm_date_adjustment?: boolean;
}

export function useEditReservation() {
    const queryClient = useQueryClient();

    return useMutation({
        mutationFn: async (data: EditReservationInput) => {
            console.log(`[useEditReservation] –û—Ç–ø—Ä–∞–≤–∫–∞ –∑–∞–ø—Ä–æ—Å–∞ –Ω–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Ä–µ–∑–µ—Ä–≤–∞ ${data.id}`);
            console.log(`[useEditReservation] –î–∞–Ω–Ω—ã–µ:`, data);

            const { id, isAdminContext, ...payload } = data;
            
            // –ü—Ä–µ–æ–±—Ä–∞–∑—É–µ–º –¥–∞–Ω–Ω—ã–µ –≤ —Ñ–æ—Ä–º–∞—Ç, –æ–∂–∏–¥–∞–µ–º—ã–π —Å–µ—Ä–≤–∏—Å–æ–º
            const servicePayload = {
                id,
                start_date: payload.start_date,
                end_date: payload.end_date,
                equipment_ids: payload.equipment_ids,
                selected_accessories: payload.selected_accessories || {},
                promo_code: payload.promo_code,
                isAdminContext
            };

            console.log(`[useEditReservation] –û—Ç–ø—Ä–∞–≤–∫–∞ –∑–∞–ø—Ä–æ—Å–∞ —á–µ—Ä–µ–∑ —Å–µ—Ä–≤–∏—Å`);

            const response = await ReservationService.updateReservation(servicePayload);

            console.log(`[useEditReservation] –û—Ç–≤–µ—Ç —Å–µ—Ä–≤–µ—Ä–∞:`, response);
            return response;
        },
        onSuccess: async (_data, variables) => {
            console.log(`[useEditReservation] –£—Å–ø–µ—à–Ω–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Ä–µ–∑–µ—Ä–≤–∞ ${variables.id}`);
            if (variables.isAdminContext) {
                await queryClient.invalidateQueries({ queryKey: ["adminReservations"] });
            }
            await queryClient.invalidateQueries({ queryKey: ["reservations"] });
            await queryClient.invalidateQueries({ queryKey: ["availability"] });
            await queryClient.invalidateQueries({ queryKey: ["calendar-grid"] });
        },
        onError: (error: unknown, variables) => {
            console.error(`[useEditReservation] –û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ —Ä–µ–∑–µ—Ä–≤–∞ ${variables.id}:`, error);
        },
    });
}

```


## <a name="rentalappmainsrchooksuseEquipmentts"></a>`rental-app-main/src/hooks/useEquipment.ts`

```typescript
// path: rental-app-main/src/hooks/useEquipment.ts

// src/hooks/useEquipment.ts

import { useInfiniteQuery, type QueryFunctionContext } from "@tanstack/react-query";
import { EquipmentService, type EquipmentListResponse, type EquipmentFilterParams } from "@/core/services/EquipmentService";
import { handleQueryError } from "@/lib/queryHelpers";
import { PAGINATION_CONSTANTS } from "@/constants/paginationConstants";
import { formatDate } from "@/lib/utils";

export function useEquipment(filters: EquipmentFilterParams = {}) {
    // –î–µ—Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä—É–µ–º –≤—Å–µ –≤–æ–∑–º–æ–∂–Ω—ã–µ —Ñ–∏–ª—å—Ç—Ä—ã
    const { query, type, brand, associationId, availableOnly, startDate, endDate } = filters;

    return useInfiniteQuery<EquipmentListResponse, Error>({
        // –î–æ–±–∞–≤–ª—è–µ–º –Ω–æ–≤—ã–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –≤ –∫–ª—é—á –∑–∞–ø—Ä–æ—Å–∞ –¥–ª—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–≥–æ –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏—è
        queryKey: ["equipment", {
            query,
            type,
            brand,
            associationId,
            availableOnly,
            // –ò—Å–ø–æ–ª—å–∑—É–µ–º –æ—Ç—Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –¥–∞—Ç—ã –≤ –∫–ª—é—á–µ, —á—Ç–æ–±—ã –∏–∑–±–µ–∂–∞—Ç—å –ø—Ä–æ–±–ª–µ–º —Å –æ–±—ä–µ–∫—Ç–∞–º–∏ Date
            startDate: startDate ? formatDate(startDate) : undefined,
            endDate: endDate ? formatDate(endDate) : undefined,
        }],

        queryFn: async ({ pageParam = 0 }: QueryFunctionContext): Promise<EquipmentListResponse> => {
            const pageSize = PAGINATION_CONSTANTS.HOME_PAGE_SIZE;
            const skip = (pageParam as number) * pageSize;
            try {
                // –ü–µ—Ä–µ–¥–∞–µ–º –≤–µ—Å—å –æ–±—ä–µ–∫—Ç filters –≤ —Å–µ—Ä–≤–∏—Å
                return await EquipmentService.getAllEquipment(skip, pageSize, filters);
            } catch (error) {
                handleQueryError(error);
                throw error; // –ü—Ä–æ–±—Ä–∞—Å—ã–≤–∞–µ–º –æ—à–∏–±–∫—É –¥–∞–ª—å—à–µ –¥–ª—è react-query
            }
        },
        initialPageParam: 0,
        getNextPageParam: (lastPage, allPages) => {
            const loadedItems = allPages.flatMap(page => page.items).length;

            if (loadedItems < lastPage.total) {
                return allPages.length;
            }
            return undefined;
        },
        staleTime: 5 * 60 * 1000, // 5 –º–∏–Ω—É—Ç
    });
}

```


## <a name="rentalappmainsrchooksuseEquipmentAvailabilityts"></a>`rental-app-main/src/hooks/useEquipmentAvailability.ts`

```typescript
// path: rental-app-main/src/hooks/useEquipmentAvailability.ts

import { useQuery } from "@tanstack/react-query";
import { api } from "@/lib/api";

interface EquipmentAvailability {
    hasActiveReservations: boolean;
    hasActiveRentals: boolean;
    activeReservationsCount: number;
    activeRentalsCount: number;
}

export function useEquipmentAvailability(equipmentId: number) {
    return useQuery({
        queryKey: ["equipment-availability", equipmentId],
        queryFn: async () => {
            const response = await api.get<EquipmentAvailability>(`/equipment/${equipmentId}/availability`);
            return response.data;
        },
    });
} 

```


## <a name="rentalappmainsrchooksuseEquipmentMapts"></a>`rental-app-main/src/hooks/useEquipmentMap.ts`

```typescript
// path: rental-app-main/src/hooks/useEquipmentMap.ts

// src/hooks/useEquipmentMap.ts

import { useMemo } from "react";
import type { Equipment } from "@/types/equipment";
import type { InfiniteData } from "@tanstack/react-query";
import type { EquipmentListResponse } from "@/core/services";

/**
 * –•—É–∫ –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –∫–∞—Ä—Ç—ã –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—è –ø–æ ID –∏–∑ –¥–∞–Ω–Ω—ã—Ö useInfiniteQuery
 * @param equipmentPages - –û–±—ä–µ–∫—Ç InfiniteData, –≤–æ–∑–≤—Ä–∞—â–∞–µ–º—ã–π —Ö—É–∫–æ–º useEquipment
 * @returns –ö–∞—Ä—Ç–∞ –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—è, –≥–¥–µ –∫–ª—é—á - ID –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—è
 */
export const useEquipmentMap = (equipmentPages: InfiniteData<EquipmentListResponse, unknown> | undefined) => {
    return useMemo(() => {
        // –ò–ó–ú–ï–ù–ï–ù–ò–ï: "–†–∞–∑–≤–æ—Ä–∞—á–∏–≤–∞–µ–º" –≤—Å–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã –≤ –æ–¥–∏–Ω –ø–ª–æ—Å–∫–∏–π –º–∞—Å—Å–∏–≤ `allEquipment`
        const allEquipment = equipmentPages?.pages.flatMap(page => page.items) ?? [];

        const map: Record<number, Equipment> = {};
        // –¢–µ–ø–µ—Ä—å allEquipment - —ç—Ç–æ –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π –º–∞—Å—Å–∏–≤, –∏ forEach –±—É–¥–µ—Ç —Ä–∞–±–æ—Ç–∞—Ç—å
        allEquipment.forEach((e: Equipment) => {
            map[e.id] = e;
        });
        return map;
    }, [equipmentPages]);
};

```


## <a name="rentalappmainsrchooksuseErrorHandlerts"></a>`rental-app-main/src/hooks/useErrorHandler.ts`

```typescript
// path: rental-app-main/src/hooks/useErrorHandler.ts

// src/hooks/useErrorHandler.ts
import { useCallback } from "react"

type UseErrorHandler = () => (error: unknown) => void

/**
 * –•—É–∫, –ø—Ä–æ–±—Ä–∞—Å—ã–≤–∞—é—â–∏–π –æ—à–∏–±–∫—É –≤–æ –≤–Ω–µ—à–Ω–∏–π ErrorBoundary —á–µ—Ä–µ–∑ throw.
 * –í—ã–∑—ã–≤–∞–µ—Ç—Å—è –≤—Ä—É—á–Ω—É—é –∏–∑ async-–∫–æ–Ω—Ç–µ–∫—Å—Ç–∞.
 */
export const useErrorHandler: UseErrorHandler = () => {
    return useCallback((error: unknown) => {
        if (error instanceof Error) {
            throw error
        } else {
            throw new Error("–ü—Ä–æ–∏–∑–æ—à–ª–∞ –Ω–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞")
        }
    }, [])
}


```


## <a name="rentalappmainsrchooksuseInlineReservationEdittsx"></a>`rental-app-main/src/hooks/useInlineReservationEdit.tsx`

```tsx
// path: rental-app-main/src/hooks/useInlineReservationEdit.tsx

// src/hooks/useInlineReservationEdit.tsx

import React, { useMemo, useState, useEffect } from "react";
import { useReserveStore } from "@/store/reserveStore";
import { useReservationState, type EquipmentDisplayDetail } from "./reservation/useReservationState";
import { useReservationData } from "./reservation/useReservationData";
import { useEditReservation } from "./useEditReservation";
import type { Reservation } from "@/types/reservation";
import { ReservationEditContext, type ReservationEditContextValue } from "@/contexts/ReservationEditContext";
import { toast } from "sonner";
import { formatDate } from "@/lib/utils"; // <-- 1. –î–û–ë–ê–í–õ–ï–ù –ò–ú–ü–û–†–¢
import { useAllEquipment } from "./useAllEquipment";
import type { Equipment } from "@/types/equipment";

/**
 * –û—Å–Ω–æ–≤–Ω–æ–π —Ö—É–∫, –∫–æ—Ç–æ—Ä—ã–π –∏–Ω–∫–∞–ø—Å—É–ª–∏—Ä—É–µ—Ç –≤—Å—é —Å–ª–æ–∂–Ω—É—é –ª–æ–≥–∏–∫—É —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è —Ä–µ–∑–µ—Ä–≤–∞.
 * –û–Ω –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –≤–Ω—É—Ç—Ä–∏ –ø—Ä–æ–≤–∞–π–¥–µ—Ä–∞ ReservationEditProvider.
 */
const useInlineReservationEditLogic = (
    reservation: Reservation,
    initialEquipmentForDisplay: ReadonlyArray<EquipmentDisplayDetail>,
    onFullCancellation: (() => Promise<void> | void) | undefined,
    isAdminContext: boolean,
    onFinishEditing: () => void
): ReservationEditContextValue => {

    const { state, actions: stateActions, dialogs } = useReservationState(
        reservation,
        initialEquipmentForDisplay
    );

    const {
        availabilityMap, hasConflicts, isCheckingAvailability, isCalculatingPrice,
        financials, setPromoCode, applyPromoCode, removePromoCode, appliedPromoCode,
        priceDetails,
    } = useReservationData(reservation, state);

    const { data: allEquipment = [] } = useAllEquipment();

    const equipmentMap = useMemo(() =>
            new Map(allEquipment.map(e => [e.id, e])),
        [allEquipment]
    );

    useEffect(() => {
        const reserveStoreState = useReserveStore.getState();

        if (reserveStoreState.addToReservationMode === reservation.id && reserveStoreState.items.length > 0) {

            if (allEquipment.length > 0) {
                const newItemsData = reserveStoreState.items.map(itemInStore => {
                    const fullItemData = allEquipment.find((eq: Equipment) => eq.id === itemInStore.id);
                    return fullItemData || itemInStore;
                });

                stateActions.addEquipmentItems(newItemsData);
                reserveStoreState.clear();
            }
        }
    }, [allEquipment, reservation.id, stateActions]);

    const [holidayConflict, setHolidayConflict] = useState<{ message: string, suggested_end_date: string } | null>(null);
    const editApiMutation = useEditReservation();

    const finalHasChanges = useMemo(() => {
        const promoCodeChanged = appliedPromoCode !== (reservation.promo_code || "");
        return state.hasChanges || promoCodeChanged;
    }, [state.hasChanges, appliedPromoCode, reservation.promo_code]);

    const saveChanges = async (confirmAdjustment: boolean = false): Promise<boolean> => {
        if (!finalHasChanges && !confirmAdjustment) {
            toast.info("–ù–µ—Ç –∏–∑–º–µ–Ω–µ–Ω–∏–π –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è.");
            return false;
        }
        if (hasConflicts) {
            toast.error("–ù–µ–≤–æ–∑–º–æ–∂–Ω–æ —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å —Ä–µ–∑–µ—Ä–≤ —Å –∫–æ–Ω—Ñ–ª–∏–∫—Ç–∞–º–∏.");
            return false;
        }
        if (state.currentEquipmentDetails.length === 0) {
            toast.error("–†–µ–∑–µ—Ä–≤ –¥–æ–ª–∂–µ–Ω —Å–æ–¥–µ—Ä–∂–∞—Ç—å —Ö–æ—Ç—è –±—ã –æ–¥–Ω—É –ø–æ–∑–∏—Ü–∏—é.");
            return false;
        }

        try {
            await editApiMutation.mutateAsync({
                id: reservation.id,
                // V-- 2. –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï –ó–î–ï–°–¨ --V
                start_date: formatDate(state.startDate),
                end_date: formatDate(state.endDate),
                // ^-- –ö–û–ù–ï–¶ –ò–°–ü–†–ê–í–õ–ï–ù–ò–Ø --^
                equipment_ids: state.currentEquipmentDetails.map(eq => eq.id),
                promo_code: appliedPromoCode,
                selected_accessories: state.localSelectedAccessories,
                isAdminContext,
                confirm_date_adjustment: confirmAdjustment,
            });
            toast.success("–†–µ–∑–µ—Ä–≤ —É—Å–ø–µ—à–Ω–æ –æ–±–Ω–æ–≤–ª–µ–Ω!");
            if (holidayConflict) setHolidayConflict(null);
            onFinishEditing();
            return true;
        } catch (error) {
            const errorDetail = (error as any)?.response?.data?.detail;

            let parsedDetail = null;
            if (typeof errorDetail === 'string') {
                try { parsedDetail = JSON.parse(errorDetail); } catch (e) { /* –û—à–∏–±–∫–∞ –Ω–µ –≤ —Ñ–æ—Ä–º–∞—Ç–µ JSON */ }
            } else {
                parsedDetail = errorDetail;
            }

            if (
                (error as any).response?.status === 409 &&
                parsedDetail?.error_type === "END_DATE_IS_HOLIDAY"
            ) {
                setHolidayConflict(parsedDetail);
            } else {
                const message = typeof errorDetail === 'string' ? errorDetail : "–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–π.";
                toast.error(message);
            }
            return false;
        }
    };

    const handleConfirmHolidayAdjustment = () => {
        void saveChanges(true);
    };

    const { clear: clearReserveStore, setReservationId } = useReserveStore.getState();

    const cancelEdit = () => {
        clearReserveStore();
        onFinishEditing();
    };

    const editStateForUI = useMemo(() => ({
        ...state,
        hasChanges: finalHasChanges,
        newlyAddedEquipmentIdsAsArray: Array.from(state.newlyAddedEquipmentIds)
    }), [state, finalHasChanges]);

    return {
        reservationId: reservation.id,
        editState: editStateForUI,
        availabilityMap,
        hasConflicts,
        isLoading: editApiMutation.isPending || isCheckingAvailability,
        isCheckingAvailability,
        isSaving: editApiMutation.isPending,
        isCalculatingPrice,
        isCancelling: false,
        isCancelConfirmationVisible: dialogs.isCancelConfirmationVisible,
        startEdit: () => setReservationId(reservation.id),
        cancelEdit,
        saveChanges: () => saveChanges(false),
        equipmentMap,
        allEquipment,
        updateDates: stateActions.updateDates,
        addEquipmentItems: stateActions.addEquipmentItems,
        removeEquipmentItem: stateActions.removeEquipmentItem,
        handleConfirmFullCancellation: async () => { if (onFullCancellation) await onFullCancellation() },
        handleCloseCancellationDialog: () => dialogs.setCancelConfirmationVisible(false),
        financials,
        priceDetails,
        setPromoCode,
        applyPromoCode,
        removePromoCode,
        localSelectedAccessories: state.localSelectedAccessories,
        toggleAccessory: stateActions.toggleAccessory,
        holidayConflict: holidayConflict,
        confirmHolidayAdjustment: handleConfirmHolidayAdjustment,
        cancelHolidayAdjustment: () => setHolidayConflict(null),
    };
};

/**
 * –ö–æ–º–ø–æ–Ω–µ–Ω—Ç-–ø—Ä–æ–≤–∞–π–¥–µ—Ä, –∫–æ—Ç–æ—Ä—ã–π –æ–±–æ—Ä–∞—á–∏–≤–∞–µ—Ç –¥–æ—á–µ—Ä–Ω–∏–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã
 * –∏ –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª—è–µ—Ç –∏–º –¥–æ—Å—Ç—É–ø –∫–æ –≤—Å–µ–π –ª–æ–≥–∏–∫–µ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è —á–µ—Ä–µ–∑ —Ö—É–∫ useReservationEditContext.
 */
export const ReservationEditProvider: React.FC<{
    children: React.ReactNode;
    reservation: Reservation;
    initialEquipmentForDisplay: ReadonlyArray<EquipmentDisplayDetail>;
    onFullCancellation?: (() => Promise<void> | void) | undefined;
    isAdminContext?: boolean;
    onFinishEditing: () => void;
}> = (props) => {
    const contextValue = useInlineReservationEditLogic(
        props.reservation,
        props.initialEquipmentForDisplay,
        props.onFullCancellation,
        props.isAdminContext || false,
        props.onFinishEditing
    );

    return (
        <ReservationEditContext.Provider value={contextValue}>
            {props.children}
        </ReservationEditContext.Provider>
    );
};

```


## <a name="rentalappmainsrchooksuseMyRentalsts"></a>`rental-app-main/src/hooks/useMyRentals.ts`

```typescript
// path: rental-app-main/src/hooks/useMyRentals.ts

import { useInfiniteQuery, type QueryFunctionContext } from "@tanstack/react-query";
import { api } from "@/lib/api";
import type { AdminRentalListResponse } from "@/types/rental";
import { useCurrentUser } from "./useProfile";

const MY_RENTALS_KEY = "myRentals";

interface UseMyRentalsParams {
    search?: string;
    status?: string;
    sort?: string;
}

export function useMyRentals(params?: UseMyRentalsParams, limit: number = 10) {
    const { data: user } = useCurrentUser();

    return useInfiniteQuery<AdminRentalListResponse, Error>({
        queryKey: [MY_RENTALS_KEY, params],
        queryFn: async ({ pageParam = 0 }: QueryFunctionContext) => {
            const skip = (pageParam as number) * limit;
            const response = await api.get<AdminRentalListResponse>("/user/rentals", {
                params: { skip, limit, ...params },
            });
            return response.data;
        },
        initialPageParam: 0,
        getNextPageParam: (lastPage, allPages) => {
            const loadedItems = allPages.reduce((acc, page) => acc + page.items.length, 0);
            if (loadedItems < lastPage.total) {
                return allPages.length;
            }
            return undefined;
        },
        enabled: !!user, // –í—ã–ø–æ–ª–Ω—è—Ç—å –∑–∞–ø—Ä–æ—Å —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω
    });
}


```


## <a name="rentalappmainsrchooksuseNetworkStatusts"></a>`rental-app-main/src/hooks/useNetworkStatus.ts`

```typescript
// path: rental-app-main/src/hooks/useNetworkStatus.ts

// src/hooks/useNetworkStatus.ts
import { useEffect, useState } from "react"

/**
 * –•—É–∫ –æ—Ç—Å–ª–µ–∂–∏–≤–∞–µ—Ç —Å—Ç–∞—Ç—É—Å –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è (online/offline).
 * –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç true ‚Äî –µ—Å–ª–∏ –≤ —Å–µ—Ç–∏, false ‚Äî –µ—Å–ª–∏ –æ—Ñ—Ñ–ª–∞–π–Ω.
 */
export function useNetworkStatus(): boolean {
    const [isOnline, setIsOnline] = useState(navigator.onLine)

    useEffect(() => {
        const handleOnline = () => setIsOnline(true)
        const handleOffline = () => setIsOnline(false)

        window.addEventListener("online", handleOnline)
        window.addEventListener("offline", handleOffline)

        return () => {
            window.removeEventListener("online", handleOnline)
            window.removeEventListener("offline", handleOffline)
        }
    }, [])

    return isOnline
}


```


## <a name="rentalappmainsrchooksusePhoneValidationts"></a>`rental-app-main/src/hooks/usePhoneValidation.ts`

```typescript
// path: rental-app-main/src/hooks/usePhoneValidation.ts

// src/hooks/usePhoneValidation.ts

import { useState, useCallback } from 'react';
import { PhoneService } from '@/core/services';

interface UsePhoneValidationOptions {
    format?: 'russian' | 'international';
    required?: boolean;
    onValidationChange?: (isValid: boolean) => void;
}

interface UsePhoneValidationReturn {
    isValid: boolean;
    error: string | null;
    validatePhone: (phone: string) => boolean;
    clearError: () => void;
}

/**
 * –•—É–∫ –¥–ª—è –≤–∞–ª–∏–¥–∞—Ü–∏–∏ —Ç–µ–ª–µ—Ñ–æ–Ω–Ω—ã—Ö –Ω–æ–º–µ—Ä–æ–≤ –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏
 */
export function usePhoneValidation(options: UsePhoneValidationOptions = {}): UsePhoneValidationReturn {
    const {
        format = 'russian',
        required = false,
        onValidationChange
    } = options;

    const [isValid, setIsValid] = useState(false);
    const [error, setError] = useState<string | null>(null);

    const validatePhone = useCallback((phone: string): boolean => {
        // –ï—Å–ª–∏ –ø–æ–ª–µ –Ω–µ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ –∏ –ø—É—Å—Ç–æ–µ, —Å—á–∏—Ç–∞–µ–º –≤–∞–ª–∏–¥–Ω—ã–º
        if (!required && !phone.trim()) {
            setIsValid(true);
            setError(null);
            onValidationChange?.(true);
            return true;
        }

        // –ï—Å–ª–∏ –ø–æ–ª–µ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ –∏ –ø—É—Å—Ç–æ–µ
        if (required && !phone.trim()) {
            setIsValid(false);
            setError('–ù–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞ –æ–±—è–∑–∞—Ç–µ–ª–µ–Ω');
            onValidationChange?.(false);
            return false;
        }

        // –ò—Å–ø–æ–ª—å–∑—É–µ–º PhoneService –¥–ª—è –≤–∞–ª–∏–¥–∞—Ü–∏–∏
        const validationResult = PhoneService.validate(phone);
        
        if (!validationResult.isValid) {
            setIsValid(false);
            setError(validationResult.error || '–ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π –Ω–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞');
            onValidationChange?.(false);
            return false;
        }

        // –í—Å–µ –ø—Ä–æ–≤–µ—Ä–∫–∏ –ø—Ä–æ–π–¥–µ–Ω—ã
        setIsValid(true);
        setError(null);
        onValidationChange?.(true);
        return true;
    }, [format, required, onValidationChange]);

    const clearError = useCallback(() => {
        setError(null);
    }, []);

    return {
        isValid,
        error,
        validatePhone,
        clearError
    };
}

/**
 * –•—É–∫ –¥–ª—è –≤–∞–ª–∏–¥–∞—Ü–∏–∏ —Ç–µ–ª–µ—Ñ–æ–Ω–∞ —Å debounce
 */
export function usePhoneValidationWithDebounce(
    options: UsePhoneValidationOptions & { debounceMs?: number } = {}
): UsePhoneValidationReturn & { debouncedValidate: (phone: string) => void } {
    const { debounceMs = 500, ...validationOptions } = options;
    const [debounceTimeout, setDebounceTimeout] = useState<NodeJS.Timeout | null>(null);
    
    const baseValidation = usePhoneValidation(validationOptions);

    const debouncedValidate = useCallback((phone: string) => {
        // –û—á–∏—â–∞–µ–º –ø—Ä–µ–¥—ã–¥—É—â–∏–π —Ç–∞–π–º–∞—É—Ç
        if (debounceTimeout) {
            clearTimeout(debounceTimeout);
        }

        // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –Ω–æ–≤—ã–π —Ç–∞–π–º–∞—É—Ç
        const timeout = setTimeout(() => {
            baseValidation.validatePhone(phone);
        }, debounceMs);

        setDebounceTimeout(timeout);
    }, [baseValidation, debounceMs, debounceTimeout]);

    return {
        ...baseValidation,
        debouncedValidate
    };
} 

```


## <a name="rentalappmainsrchooksuseProfilets"></a>`rental-app-main/src/hooks/useProfile.ts`

```typescript
// path: rental-app-main/src/hooks/useProfile.ts

import { useQuery, useMutation, useQueryClient } from "@tanstack/react-query";
import { api } from "@/lib/api";
import type { UserOut } from "@/types/user";
import { handleQueryError } from "@/lib/queryHelpers";

/**
 * –¢–∏–ø –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –ø—Ä–æ—Ñ–∏–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
 */
type ProfileUpdatePayload = {
    full_name: string;
    email: string;
    phone?: string;
};

/**
 * –¢–∏–ø –æ—à–∏–±–∫–∏ API
 */
type APIError = {
    response?: {
        status?: number;
        data?: {
            detail?: string;
        };
    };
    message?: string;
};

/**
 * –•—É–∫ –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö —Ç–µ–∫—É—â–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
 * @returns Query –æ–±—ä–µ–∫—Ç —Å –¥–∞–Ω–Ω—ã–º–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
 */
export function useCurrentUser() {
    return useQuery<UserOut | null, Error>({
        queryKey: ["current_user"],
        queryFn: async () => {
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ —Ç–æ–∫–µ–Ω–∞ –ø–µ—Ä–µ–¥ –∑–∞–ø—Ä–æ—Å–æ–º
            const accessToken = localStorage.getItem("access_token");
            if (!accessToken) {
                return null;
            }

            try {
                const res = await api.get<UserOut>("/user/");
                return res.data;
            } catch (error: unknown) {
                const apiError = error as APIError;
                if (apiError.response?.status === 401) {
                    // –û—á–∏—â–∞–µ–º –Ω–µ–¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω—ã–π —Ç–æ–∫–µ–Ω
                    localStorage.removeItem("access_token");
                    return null;
                }
                console.error("[useCurrentUser] Error fetching user data:", apiError);
                handleQueryError(error);
                throw error;
            }
        },
        staleTime: 1000 * 60 * 10, // –∫—ç—à –Ω–∞ 10 –º–∏–Ω—É—Ç
        retry: (failureCount, error) => {
            // –ù–µ –ø–æ–≤—Ç–æ—Ä—è–µ–º –∑–∞–ø—Ä–æ—Å –ø—Ä–∏ 401 –æ—à–∏–±–∫–µ
            if (error instanceof Error && error.message.includes("401")) {
                return false;
            }
            return failureCount < 3;
        },
        // –ù–µ –≤—ã–ø–æ–ª–Ω—è–µ–º –∑–∞–ø—Ä–æ—Å, –µ—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω
        enabled: !!localStorage.getItem("access_token"),
    });
}

/**
 * –•—É–∫ –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö –ø—Ä–æ—Ñ–∏–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
 * @returns Mutation –æ–±—ä–µ–∫—Ç –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –ø—Ä–æ—Ñ–∏–ª—è
 */
export function useProfileUpdate() {
    const queryClient = useQueryClient();

    return useMutation<void, Error, ProfileUpdatePayload>({
        mutationFn: async (data: ProfileUpdatePayload) => {
            try {
                await api.put("/user/", data);
            } catch (error: unknown) {
                console.error("[useProfileUpdate] Error updating profile:", error);
                handleQueryError(error);
                throw error;
            }
        },
        onSuccess: () => {
            queryClient.invalidateQueries({ queryKey: ["current_user"] });
        },
        onError: (error: Error) => {
            console.error("[useProfileUpdate] Mutation error:", error);
        },
    });
}


```


## <a name="rentalappmainsrchooksuseReservationManagementts"></a>`rental-app-main/src/hooks/useReservationManagement.ts`

```typescript
// path: rental-app-main/src/hooks/useReservationManagement.ts

// src/hooks/useReservationManagement.ts

import { useEffect, useMemo } from 'react';
import { useLocation } from 'react-router-dom';
import { useReserveStore } from '@/store/reserveStore';
import type { Equipment } from '@/types/equipment';
import type { AvailabilityInfo, EquipmentStatus } from '@/types/availability';

type UseReservationManagementReturn = {
    editingReservationId: number | null;
    intent: string | null;
    getEquipmentStatus: (eq: Equipment) => EquipmentStatus | "my_reservation" | "added";
};

export function useReservationManagement(
    filteredItems: Equipment[],
    availabilityMap: Record<number, AvailabilityInfo>,
    availableOnly: boolean
): UseReservationManagementReturn {
    const location = useLocation();
    const { items: selectedItems, addToReservationMode } = useReserveStore();

    const editingReservationEquipmentIds = useMemo(() => {
        if (location.state?.intent === "add_to_reservation" && location.state?.reservationId) {
            return new Set(location.state?.equipmentIds || []);
        }
        return new Set<number>();
    }, [location.state]);

    useEffect(() => {
        const intent = location.state?.intent;
        const reservationIdFromLocation = location.state?.reservationId;
        const storeActions = useReserveStore.getState();

        if (intent === "add_to_reservation" && reservationIdFromLocation) {
            if (storeActions.addToReservationMode !== reservationIdFromLocation) {
                storeActions.clear();
                storeActions.setAddToReservationMode(reservationIdFromLocation);
            }
        } else if (intent === "add_to_new_reservation") {
            if (storeActions.addToReservationMode !== null) {
                storeActions.clear();
            }
        } else {
            if (storeActions.addToReservationMode !== null) {
                storeActions.clear();
            }
        }
    }, [location.state]);

    // availabilityMap —Ç–µ–ø–µ—Ä—å –ø–µ—Ä–µ–¥–∞–µ—Ç—Å—è –∫–∞–∫ –ø–∞—Ä–∞–º–µ—Ç—Ä, –Ω–µ –Ω—É–∂–Ω–æ —Å–æ–∑–¥–∞–≤–∞—Ç—å –µ–≥–æ –∑–¥–µ—Å—å


    const getEquipmentStatus = (eq: Equipment): EquipmentStatus | "my_reservation" | "added" => {
        if (location.state?.intent === "add_to_reservation" && location.state?.reservationId === addToReservationMode) {
            if (editingReservationEquipmentIds.has(eq.id)) {
                return "my_reservation";
            }
            if (selectedItems.some(i => i.id === eq.id)) {
                return "added";
            }
        }

        const itemAvailability = availabilityMap[eq.id];

        // --- –ù–ê–ß–ê–õ–û –ò–ó–ú–ï–ù–ï–ù–ò–ô (–í–û–ó–í–†–ê–©–ê–ï–ú –ö–ê–ö –ë–´–õ–û) ---
        // –¢–µ–ø–µ—Ä—å –±—ç–∫–µ–Ω–¥ —Å–∞–º –æ—Ç–¥–∞–µ—Ç –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π —Å—Ç–∞—Ç—É—Å, –Ω–∞–º –Ω–µ –Ω—É–∂–Ω–∞ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –ª–æ–≥–∏–∫–∞
        return itemAvailability?.status ?? "available";
        // --- –ö–û–ù–ï–¶ –ò–ó–ú–ï–ù–ï–ù–ò–ô ---
    };

    return {
        editingReservationId: location.state?.reservationId ?? null,
        intent: location.state?.intent ?? null,
        getEquipmentStatus
    };
}

```


## <a name="rentalappmainsrchooksuseReservationsts"></a>`rental-app-main/src/hooks/useReservations.ts`

```typescript
// path: rental-app-main/src/hooks/useReservations.ts

// src/hooks/useReservations.ts

import { useQuery, useMutation, useQueryClient } from "@tanstack/react-query";
import { ReservationService, type ReservationCreateInput } from "@/core/services/ReservationService";
import type { Reservation } from "@/types/reservation";
import { handleQueryError } from "@/lib/queryHelpers";
import { useCurrentUser } from "./useProfile";
import { toast } from "sonner";
import { transformAccessoryLinks } from "@/lib/utils";

const RESERVATIONS_KEY = ["reservations"];

const invalidateReservationQueries = (queryClient: ReturnType<typeof useQueryClient>) => {
    void queryClient.invalidateQueries({ queryKey: RESERVATIONS_KEY });
    void queryClient.invalidateQueries({ queryKey: ["availability"] });
    void queryClient.invalidateQueries({ queryKey: ["calendar-grid"] });
};

const handleMutationError = (error: unknown, contextMessage: string) => {
    console.error(`[useReservations] Error on ${contextMessage}:`, error);
    const apiError = error as { response?: { data?: { detail?: any } } };
    const detail = apiError.response?.data?.detail;
    let message = `–û—à–∏–±–∫–∞: ${contextMessage}`;

    if (typeof detail === 'string') {
        message = detail;
    } else if (typeof detail?.message === 'string') {
        message = detail.message;
    }

    toast.error(message);

    if (detail?.unavailable_ids) {
        const errorToThrow = new Error(message);
        (errorToThrow as any).unavailable_ids = detail.unavailable_ids;
        throw errorToThrow;
    }
};

interface UseReservationsParams {
    search?: string;
    status?: string;
    sort?: string;
}

export function useReservations(params?: UseReservationsParams) {
    const queryClient = useQueryClient();
    const { data: user } = useCurrentUser();

    const reservationsQuery = useQuery<Reservation[], Error>({
        queryKey: [...RESERVATIONS_KEY, params],
        queryFn: async (): Promise<Reservation[]> => {
            try {
                return await ReservationService.getUserReservations(params);
            } catch (error) {
                handleQueryError(error);
                throw error;
            }
        },
        enabled: !!user,
        staleTime: 5 * 60 * 1000,
        select: (data) => data.map(transformAccessoryLinks),
    });

    const createReservation = useMutation({
        mutationFn: (data: ReservationCreateInput) => ReservationService.createReservation(data),
        onSuccess: () => {
            invalidateReservationQueries(queryClient);
        },
        onError: (error) => handleMutationError(error, "–Ω–µ —É–¥–∞–ª–æ—Å—å —Å–æ–∑–¥–∞—Ç—å —Ä–µ–∑–µ—Ä–≤")
    });

    const updateReservation = useMutation({
        mutationFn: (data: any) => ReservationService.updateReservation(data),
        onSuccess: () => {
            invalidateReservationQueries(queryClient);
            toast.success("–†–µ–∑–µ—Ä–≤ —É—Å–ø–µ—à–Ω–æ –æ–±–Ω–æ–≤–ª–µ–Ω!");
        },
        onError: (error) => handleMutationError(error, "–Ω–µ —É–¥–∞–ª–æ—Å—å –æ–±–Ω–æ–≤–∏—Ç—å —Ä–µ–∑–µ—Ä–≤")
    });

    const deleteReservation = useMutation({
        mutationFn: (id: number) => ReservationService.cancelReservation(id),
        onSuccess: () => {
            invalidateReservationQueries(queryClient);
            toast.success("–†–µ–∑–µ—Ä–≤ —É—Å–ø–µ—à–Ω–æ —É–¥–∞–ª–µ–Ω!");
        },
        onError: (error) => handleMutationError(error, "–Ω–µ —É–¥–∞–ª–æ—Å—å —É–¥–∞–ª–∏—Ç—å —Ä–µ–∑–µ—Ä–≤")
    });

    return {
        reservationsQuery,
        createReservation,
        updateReservation,
        deleteReservation,
    };
}

```


## <a name="rentalappmainsrchooksuseUpdateEquipmentDetailsts"></a>`rental-app-main/src/hooks/useUpdateEquipmentDetails.ts`

```typescript
// path: rental-app-main/src/hooks/useUpdateEquipmentDetails.ts

// src/hooks/useUpdateEquipmentDetails.ts
import { useMutation, useQueryClient } from "@tanstack/react-query";
import { toast } from "sonner";
import { api } from "@/lib/api";
import type { Equipment } from "@/types/equipment";
import type { EquipmentUpdateExtendedSchema } from "@/lib/validationSchemas";

interface UpdateEquipmentPayload {
    id: number;
    data: EquipmentUpdateExtendedSchema;
}

export function useUpdateEquipmentDetails() {
    const queryClient = useQueryClient();

    return useMutation<Equipment, Error, UpdateEquipmentPayload>({
        mutationFn: async ({ id, data }) => {
            const payload: Record<string, string | number | boolean | string[] | number[] | null> = {};
            for (const key in data) {
                if (Object.prototype.hasOwnProperty.call(data, key)) {
                    const typedKey = key as keyof EquipmentUpdateExtendedSchema;
                    if (data[typedKey] !== undefined) {
                        payload[typedKey] = data[typedKey];
                    }
                }
            }
            const response = await api.put<Equipment>(`/equipment/${id}`, payload);
            return response.data;
        },
        onSuccess: async (updatedEquipment, variables) => { // <--- –î–æ–±–∞–≤–ª–µ–Ω async
            toast.success(`–û–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏–µ "${updatedEquipment.name}" —É—Å–ø–µ—à–Ω–æ –æ–±–Ω–æ–≤–ª–µ–Ω–æ!`);

            // –ò–Ω–≤–∞–ª–∏–¥–∞—Ü–∏—è –∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∫—ç—à–∞
            // 1. –ò–Ω–≤–∞–ª–∏–¥–∏—Ä—É–µ–º –æ–±—â–∏–π —Å–ø–∏—Å–æ–∫ –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—è
            await queryClient.invalidateQueries({ queryKey: ["equipment"] }); // <--- –î–æ–±–∞–≤–ª–µ–Ω await

            // 2. –ú–æ–∂–Ω–æ —Ç–∞–∫–∂–µ —Ç–æ—á–µ—á–Ω–æ –æ–±–Ω–æ–≤–∏—Ç—å –∫—ç—à –¥–ª—è —ç—Ç–æ–≥–æ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ —ç–ª–µ–º–µ–Ω—Ç–∞,
            // –µ—Å–ª–∏ –æ–Ω –≥–¥–µ-—Ç–æ –∑–∞–ø—Ä–∞—à–∏–≤–∞–µ—Ç—Å—è –ø–æ –æ—Ç–¥–µ–ª—å–Ω–æ–º—É –∫–ª—é—á—É (–Ω–∞–ø—Ä–∏–º–µ—Ä, ["equipment", variables.id])
            // await queryClient.setQueryData(["equipment", variables.id], updatedEquipment); // <--- –î–æ–±–∞–≤–ª–µ–Ω await, –µ—Å–ª–∏ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è

            queryClient.setQueryData<Equipment[]>(["equipment"], (oldData) =>
                oldData?.map((item) =>
                    item.id === variables.id ? { ...item, ...updatedEquipment } : item
                ) ?? []
            );

            // 4. –ò–Ω–≤–∞–ª–∏–¥–∏—Ä—É–µ–º –¥–∞–Ω–Ω—ã–µ –æ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏
            await queryClient.invalidateQueries({ queryKey: ["availability"] }); // <--- –î–æ–±–∞–≤–ª–µ–Ω await
            await queryClient.invalidateQueries({ queryKey: ["calendar-grid"] }); // <--- –î–æ–±–∞–≤–ª–µ–Ω await
            await queryClient.invalidateQueries({ queryKey: ["calendar-events"] }); // <--- –î–æ–±–∞–≤–ª–µ–Ω await
        },
        onError: (error) => {
            toast.error(`–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—è: ${error.message}`);
            console.error("–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—è:", error);
        },
    });
}

```


## <a name="rentalappmainsrchooksuseVisibleItemsts"></a>`rental-app-main/src/hooks/useVisibleItems.ts`

```typescript
// path: rental-app-main/src/hooks/useVisibleItems.ts

import { useState, useEffect } from 'react';

/**
 * –£–ø—Ä–∞–≤–ª—è–µ—Ç –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ–º –≤–∏–¥–∏–º—ã—Ö —ç–ª–µ–º–µ–Ω—Ç–æ–≤ –≤ —Å–ø–∏—Å–∫–µ —Å —É—á–µ—Ç–æ–º —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏.
 * @param totalCount –û–±—â–µ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —ç–ª–µ–º–µ–Ω—Ç–æ–≤ –≤ –æ—Ç—Ñ–∏–ª—å—Ç—Ä–æ–≤–∞–Ω–Ω–æ–º —Å–ø–∏—Å–∫–µ.
 */
export function useVisibleItems(totalCount: number) {
    // `intendedSize` ‚Äî —ç—Ç–æ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —ç–ª–µ–º–µ–Ω—Ç–æ–≤, –∫–æ—Ç–æ—Ä–æ–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å *—Ö–æ—á–µ—Ç* –≤–∏–¥–µ—Ç—å (–Ω–∞–ø—Ä–∏–º–µ—Ä, –ø–æ—Å–ª–µ –Ω–∞–∂–∞—Ç–∏—è –∫–Ω–æ–ø–∫–∏ "24").
    const [intendedSize, setIntendedSize] = useState(12);

    // `visibleCount` ‚Äî —ç—Ç–æ —Ñ–∞–∫—Ç–∏—á–µ—Å–∫–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —ç–ª–µ–º–µ–Ω—Ç–æ–≤ –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è, –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–Ω–æ–µ `totalCount`.
    const [visibleCount, setVisibleCount] = useState(12);

    // `increaseVisibleCount` –æ–±–Ω–æ–≤–ª—è–µ—Ç –Ω–∞–º–µ—Ä–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è —É–≤–∏–¥–µ—Ç—å –±–æ–ª—å—à–µ —ç–ª–µ–º–µ–Ω—Ç–æ–≤.
    const increaseVisibleCount = (step: number = 12) => {
        setIntendedSize((prev) => prev + step);
    };

    // `setVisibility` (–ø–µ—Ä–µ–∏–º–µ–Ω–æ–≤–∞–Ω–∞ –¥–ª—è —è—Å–Ω–æ—Å—Ç–∏ –≤ `setIntendedSize`) –≤—ã–∑—ã–≤–∞–µ—Ç—Å—è –∫–Ω–æ–ø–∫–∞–º–∏ "12", "24", –∏ —Ç.–¥.
    const setVisibility = (count: number) => {
        setIntendedSize(count);
    };

    // –≠—Ç–æ—Ç useEffect —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä—É–µ—Ç —Ñ–∞–∫—Ç–∏—á–µ—Å–∫–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –≤–∏–¥–∏–º—ã—Ö —ç–ª–µ–º–µ–Ω—Ç–æ–≤.
    // –û–Ω —Å—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç, –∫–æ–≥–¥–∞ –º–µ–Ω—è–µ—Ç—Å—è –ª–∏–±–æ –Ω–∞–º–µ—Ä–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (`intendedSize`), –ª–∏–±–æ –æ–±—â–µ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —ç–ª–µ–º–µ–Ω—Ç–æ–≤ (`totalCount`).
    useEffect(() => {
        // –ï—Å–ª–∏ –æ–±—â–µ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ä–∞–≤–Ω–æ 0, –Ω–∏—á–µ–≥–æ –Ω–µ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º.
        if (totalCount === 0) {
            setVisibleCount(0);
        } else {
            // –í –æ—Å—Ç–∞–ª—å–Ω—ã—Ö —Å–ª—É—á–∞—è—Ö –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –º–µ–Ω—å—à–µ–µ –∏–∑ –¥–≤—É—Ö:
            // –ª–∏–±–æ —Å–∫–æ–ª—å–∫–æ —Ö–æ—á–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å, –ª–∏–±–æ —Å–∫–æ–ª—å–∫–æ –µ—Å—Ç—å –≤—Å–µ–≥–æ.
            setVisibleCount(Math.min(intendedSize, totalCount));
        }
    }, [intendedSize, totalCount]);

    return { visibleCount, setVisibleCount: setVisibility, increaseVisibleCount };
}

```


## <a name="rentalappmainsrcindexcss"></a>`rental-app-main/src/index.css`

```css
// path: rental-app-main/src/index.css

@tailwind base;
@tailwind components;
@tailwind utilities;

/* –ë–∞–∑–æ–≤—ã–µ —Å—Ç–∏–ª–∏ html/body */
html,
body {
  margin: 0;
  padding: 0;
  min-height: 100vh;
  background-color: #f9fafb; /* Tailwind gray-50 */
  color: #111827; /* Tailwind gray-900 */
  font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI",
  Roboto, Helvetica, Arial, sans-serif;
  line-height: 1.5;
  -webkit-font-smoothing: antialiased;
}

a {
  color: inherit;
  text-decoration: none;
}

button {
  cursor: pointer;
  font-family: inherit;
}


@layer base {
  :root {
    --background: 0 0% 100%;
    --foreground: 0 0% 3.9%;
    --card: 0 0% 100%;
    --card-foreground: 0 0% 3.9%;
    --popover: 0 0% 100%;
    --popover-foreground: 0 0% 3.9%;
    --primary: 0 0% 9%;
    --primary-foreground: 0 0% 98%;
    --secondary: 0 0% 96.1%;
    --secondary-foreground: 0 0% 9%;
    --muted: 0 0% 96.1%;
    --muted-foreground: 0 0% 45.1%;
    --accent: 0 0% 96.1%;
    --accent-foreground: 0 0% 9%;
    --destructive: 0 84.2% 60.2%;
    --destructive-foreground: 0 0% 98%;
    --border: 0 0% 89.8%;
    --input: 0 0% 89.8%;
    --ring: 0 0% 3.9%;
    --chart-1: 12 76% 61%;
    --chart-2: 173 58% 39%;
    --chart-3: 197 37% 24%;
    --chart-4: 43 74% 66%;
    --chart-5: 27 87% 67%;
    --radius: 0.5rem;
  }
  .dark {
    --background: 0 0% 3.9%;
    --foreground: 0 0% 98%;
    --card: 0 0% 3.9%;
    --card-foreground: 0 0% 98%;
    --popover: 0 0% 3.9%;
    --popover-foreground: 0 0% 98%;
    --primary: 0 0% 98%;
    --primary-foreground: 0 0% 9%;
    --secondary: 0 0% 14.9%;
    --secondary-foreground: 0 0% 98%;
    --muted: 0 0% 14.9%;
    --muted-foreground: 0 0% 63.9%;
    --accent: 0 0% 14.9%;
    --accent-foreground: 0 0% 98%;
    --destructive: 0 62.8% 30.6%;
    --destructive-foreground: 0 0% 98%;
    --border: 0 0% 14.9%;
    --input: 0 0% 14.9%;
    --ring: 0 0% 83.1%;
    --chart-1: 220 70% 50%;
    --chart-2: 160 60% 45%;
    --chart-3: 30 80% 55%;
    --chart-4: 280 65% 60%;
    --chart-5: 340 75% 55%;
  }
}

@layer base {
  * {
    @apply border-border;
  }
  body {
    @apply bg-background text-foreground;
  }
}

/* –ü–æ–¥—Å–≤–µ—Ç–∫–∞ –≤–µ—Ä—Ç–∏–∫–∞–ª—å–Ω–æ–≥–æ —Å—Ç–æ–ª–±—Ü–∞ "–°–µ–≥–æ–¥–Ω—è" */
.today-column {
  box-shadow: inset -1px 0 0 0 rgba(59, 130, 246, 0.5),
    /* sky-500 */ inset 1px 0 0 0 rgba(59, 130, 246, 0.5);
}

/* === –°–¢–ò–õ–ò –î–õ–Ø REACT-DAY-PICKER === */
/* –£–¥–∞–ª—è–µ–º —Å—Ç–∞—Ä—ã–π –±–ª–æ–∫ —Å—Ç–∏–ª–µ–π –∏ –∑–∞–º–µ–Ω—è–µ–º –µ–≥–æ –Ω–∞ —ç—Ç–æ—Ç */
@layer components {
  .day-range-start {
    @apply rounded-r-none;
  }
  .day-range-end {
    @apply rounded-l-none;
  }
  .day-outside {
    @apply text-muted-foreground opacity-50;
  }
}

/* –í —Å–∞–º—ã–π –∫–æ–Ω–µ—Ü —Ñ–∞–π–ª–∞ src/index.css */

.super-test-border {
  border: 10px dashed lime !important;
}


@layer components {
  /* –ë–∞–∑–æ–≤—ã–π —Å—Ç–∏–ª—å –¥–ª—è –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ –¥–Ω—è (–∫—Ä—É–∂–æ–∫) */
  .day-selected {
    @apply bg-sky-600 text-white hover:bg-sky-700 focus:bg-sky-700 rounded-full;
  }

  /* –ù–∞—á–∞–ª–æ –¥–∏–∞–ø–∞–∑–æ–Ω–∞ - —Å–∫—Ä—É–≥–ª–µ–Ω–∏–µ —Ç–æ–ª—å–∫–æ —Å–ª–µ–≤–∞ */
  .day-range-start {
    @apply rounded-r-none;
  }

  /* –ö–æ–Ω–µ—Ü –¥–∏–∞–ø–∞–∑–æ–Ω–∞ - —Å–∫—Ä—É–≥–ª–µ–Ω–∏–µ —Ç–æ–ª—å–∫–æ —Å–ø—Ä–∞–≤–∞ */
  .day-range-end {
    @apply rounded-l-none;
  }

  /* –î–Ω–∏ –≤ —Å–µ—Ä–µ–¥–∏–Ω–µ –¥–∏–∞–ø–∞–∑–æ–Ω–∞ - —É–±–∏—Ä–∞–µ–º —Å–∫—Ä—É–≥–ª–µ–Ω–∏–µ –∏ –¥–æ–±–∞–≤–ª—è–µ–º —Ñ–æ–Ω */
  .day-range-middle {
    @apply bg-sky-100 text-gray-800 rounded-none hover:bg-sky-200;
  }
}




```


## <a name="rentalappmainsrclibapits"></a>`rental-app-main/src/lib/api.ts`

```typescript
// path: rental-app-main/src/lib/api.ts

import axios from "axios"

// –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –∑–Ω–∞—á–µ–Ω–∏—è cookie –ø–æ –∏–º–µ–Ω–∏
function getCookie(name: string): string | null {
  const match = document.cookie.match(new RegExp('(^| )' + name + '=([^;]+)'));
  if (match) {
    return match[2];
  }
  return null;
}

export const api = axios.create({
  baseURL: "/api",
})

// Interceptor –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ –æ—Ç–≤–µ—Ç–æ–≤
api.interceptors.response.use(
  (response) => response,
  (error) => {
    // –ï—Å–ª–∏ –ø–æ–ª—É—á–∞–µ–º 401 –æ—à–∏–±–∫—É, –æ—á–∏—â–∞–µ–º —Ç–æ–∫–µ–Ω
    if (error.response?.status === 401) {
      localStorage.removeItem("access_token");
    }
    return Promise.reject(error);
  }
)

// Interceptor –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è —Ç–æ–∫–µ–Ω–æ–≤ (Authorization –∏ CSRF)
api.interceptors.request.use(
    (config) => {
      // 1. –î–æ–±–∞–≤–ª—è–µ–º Authorization: Bearer <token>
      const accessToken = localStorage.getItem("access_token") // [cite: 1]
      if (accessToken) {
        config.headers.Authorization = `Bearer ${accessToken}` // [cite: 1]
      }

      // 2. –î–æ–±–∞–≤–ª—è–µ–º CSRF-—Ç–æ–∫–µ–Ω
      // –ë—ç–∫–µ–Ω–¥ (fastapi-csrf-protect) –æ–±—ã—á–Ω–æ —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç CSRF-—Ç–æ–∫–µ–Ω –≤ cookie
      // —Å –∏–º–µ–Ω–µ–º 'fastapi-csrf-token'. –§—Ä–æ–Ω—Ç–µ–Ω–¥ –¥–æ–ª–∂–µ–Ω –ø—Ä–æ—á–∏—Ç–∞—Ç—å –µ–≥–æ
      // –∏ –æ—Ç–ø—Ä–∞–≤–∏—Ç—å –≤ –∑–∞–≥–æ–ª–æ–≤–∫–µ 'X-CSRF-Token'.
      // –≠—Ç–æ –Ω—É–∂–Ω–æ –¥–ª—è –º–µ—Ç–æ–¥–æ–≤, –∏–∑–º–µ–Ω—è—é—â–∏—Ö —Å–æ—Å—Ç–æ—è–Ω–∏–µ (POST, PUT, DELETE, PATCH).
      const csrfToken = getCookie("fastapi-csrf-token") // –ò–º—è cookie –æ—Ç fastapi-csrf-protect
      if (csrfToken) {
        config.headers["X-CSRF-Token"] = csrfToken
      }

      // –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏ (–º–æ–∂–Ω–æ —É–±—Ä–∞—Ç—å –≤ production)
      // console.log("Request Config:", config.method?.toUpperCase(), config.url, config.headers);

      return config
    },
    (error) => {
      // –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫ –∑–∞–ø—Ä–æ—Å–∞ (–µ—Å–ª–∏ –Ω—É–∂–Ω–æ)
      return Promise.reject(error)
    }
)

```


## <a name="rentalappmainsrclibqueryClientts"></a>`rental-app-main/src/lib/queryClient.ts`

```typescript
// path: rental-app-main/src/lib/queryClient.ts

// src/lib/queryClient.ts
import { QueryClient, QueryCacheNotifyEvent, Query } from "@tanstack/react-query"

export const queryClient = new QueryClient({
    defaultOptions: {
        queries: {
            staleTime: 1000 * 60,
            refetchOnWindowFocus: true,
            retry: 1
        }
    }
})

// üîß –ü–æ–¥–ø–∏—Å–∫–∞ –Ω–∞ —Å–æ–±—ã—Ç–∏—è –æ—à–∏–±–æ–∫ –≤ –∫—ç—à–µ
queryClient.getQueryCache().subscribe((event: QueryCacheNotifyEvent) => {
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —Å–æ–¥–µ—Ä–∂–∏—Ç –ª–∏ —Å–æ–±—ã—Ç–∏–µ –æ–±—ä–µ–∫—Ç Query
    const query = 'query' in event ? (event as { query: Query }).query : undefined

    if (
        query?.state.status === "error" &&
        isUnauthorizedError(query.state.error)
    ) {
        handleUnauthorized()
    }
})

function isUnauthorizedError(error: unknown): boolean {
    return error instanceof Error && error.message.includes("401")
}

function handleUnauthorized() {
    localStorage.removeItem("access_token")
    window.location.href = "/"
}


```


## <a name="rentalappmainsrclibqueryHelpersts"></a>`rental-app-main/src/lib/queryHelpers.ts`

```typescript
// path: rental-app-main/src/lib/queryHelpers.ts

import { toast } from "sonner"

export function handleQueryError(error: unknown) {
    const message =
        error instanceof Error
            ? error.message
            : typeof error === "string"
                ? error
                : "–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞ –∑–∞–ø—Ä–æ—Å–∞"
    toast.error(message)
    console.error("[Query error]", error)
}


```


## <a name="rentalappmainsrclibsortingUtilsts"></a>`rental-app-main/src/lib/sortingUtils.ts`

```typescript
// path: rental-app-main/src/lib/sortingUtils.ts

// src/lib/sortingUtils.ts

import { differenceInDays } from "date-fns";
import type { PickupReturnItem, OverdueRentalItem } from "@/hooks/admin/useDashboardData";

/**
 * –°–æ—Ä—Ç–∏—Ä—É–µ—Ç –≤—ã–¥–∞—á–∏ –ø–æ –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç—É:
 * 1. –í—ã–¥–∞—á–∏ –Ω–∞ —Å–µ–≥–æ–¥–Ω—è (–±–µ–∑ start_date –∏–ª–∏ start_date = —Å–µ–≥–æ–¥–Ω—è)
 * 2. –ü—Ä–æ—Å—Ä–æ—á–µ–Ω–Ω—ã–µ –≤—ã–¥–∞—á–∏ –ø–æ –∫–æ–ª–∏—á–µ—Å—Ç–≤—É –¥–Ω–µ–π –ø—Ä–æ—Å—Ä–æ—á–∫–∏ (–ø–æ –≤–æ–∑—Ä–∞—Å—Ç–∞–Ω–∏—é)
 */
export const sortPickupsByPriority = (pickups: PickupReturnItem[], today: Date): PickupReturnItem[] => {
    return [...pickups].sort((a, b) => {
        const aStartDate = a.start_date ? new Date(a.start_date) : null;
        const bStartDate = b.start_date ? new Date(b.start_date) : null;
        
        // –ï—Å–ª–∏ —É —ç–ª–µ–º–µ–Ω—Ç–∞ –Ω–µ—Ç start_date, —Å—á–∏—Ç–∞–µ–º –µ–≥–æ –≤—ã–¥–∞—á–µ–π –Ω–∞ —Å–µ–≥–æ–¥–Ω—è
        const aIsToday = !aStartDate || aStartDate.getTime() === today.getTime();
        const bIsToday = !bStartDate || bStartDate.getTime() === today.getTime();
        
        // –°–Ω–∞—á–∞–ª–∞ –≤—ã–¥–∞—á–∏ –Ω–∞ —Å–µ–≥–æ–¥–Ω—è
        if (aIsToday && !bIsToday) return -1;
        if (!aIsToday && bIsToday) return 1;
        
        // –ï—Å–ª–∏ –æ–±–∞ –Ω–µ –Ω–∞ —Å–µ–≥–æ–¥–Ω—è, —Å–æ—Ä—Ç–∏—Ä—É–µ–º –ø–æ –∫–æ–ª–∏—á–µ—Å—Ç–≤—É –¥–Ω–µ–π –ø—Ä–æ—Å—Ä–æ—á–∫–∏
        if (!aIsToday && !bIsToday) {
            const aDaysPassed = aStartDate ? differenceInDays(today, aStartDate) : 0;
            const bDaysPassed = bStartDate ? differenceInDays(today, bStartDate) : 0;
            return aDaysPassed - bDaysPassed; // –ú–µ–Ω—å—à–µ –¥–Ω–µ–π –ø—Ä–æ—Å—Ä–æ—á–∫–∏ - –≤—ã—à–µ –≤ —Å–ø–∏—Å–∫–µ
        }
        
        return 0;
    });
};

/**
 * –°–æ—Ä—Ç–∏—Ä—É–µ—Ç –ø—Ä–æ—Å—Ä–æ—á–µ–Ω–Ω—ã–µ –∞—Ä–µ–Ω–¥—ã –ø–æ –∫–æ–ª–∏—á–µ—Å—Ç–≤—É –¥–Ω–µ–π –ø—Ä–æ—Å—Ä–æ—á–∫–∏ (–ø–æ –≤–æ–∑—Ä–∞—Å—Ç–∞–Ω–∏—é)
 */
export const sortOverdueRentalsByDays = (overdueRentals: OverdueRentalItem[]): OverdueRentalItem[] => {
    return [...overdueRentals].sort((a, b) => {
        // –ò—Å–ø–æ–ª—å–∑—É–µ–º days_overdue –µ—Å–ª–∏ –µ—Å—Ç—å, –∏–Ω–∞—á–µ –≤—ã—á–∏—Å–ª—è–µ–º —Ä–∞–∑–Ω–æ—Å—Ç—å
        const aDaysOverdue = a.days_overdue ?? 0;
        const bDaysOverdue = b.days_overdue ?? 0;
        
        return aDaysOverdue - bDaysOverdue; // –ú–µ–Ω—å—à–µ –¥–Ω–µ–π –ø—Ä–æ—Å—Ä–æ—á–∫–∏ - –≤—ã—à–µ –≤ —Å–ø–∏—Å–∫–µ
    });
};

/**
 * –°–æ–∑–¥–∞–µ—Ç —Å–µ–≥–æ–¥–Ω—è—à–Ω—é—é –¥–∞—Ç—É —Å –æ–±–Ω—É–ª–µ–Ω–Ω—ã–º –≤—Ä–µ–º–µ–Ω–µ–º –¥–ª—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–≥–æ —Å—Ä–∞–≤–Ω–µ–Ω–∏—è
 */
export const getTodayDate = (): Date => {
    const today = new Date();
    today.setHours(0, 0, 0, 0);
    return today;
};


```


## <a name="rentalappmainsrclibutilsts"></a>`rental-app-main/src/lib/utils.ts`

```typescript
// path: rental-app-main/src/lib/utils.ts

// src/lib/utils.ts

import { clsx, type ClassValue } from "clsx"
import { twMerge } from "tailwind-merge"

/**
 * –¶–µ–Ω—Ç—Ä–∞–ª–∏–∑–æ–≤–∞–Ω–Ω–æ —Ä–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ—Ç –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ç–∞—Ä–∏—Ñ–∏—Ü–∏—Ä—É–µ–º—ã—Ö –¥–Ω–µ–π (–Ω–æ—á–µ–π), –≤—ã—á–∏—Ç–∞—è –ø—Ä–∞–∑–¥–Ω–∏–∫–∏.
 * @param start - –î–∞—Ç–∞ –Ω–∞—á–∞–ª–∞
 * @param end - –î–∞—Ç–∞ –æ–∫–æ–Ω—á–∞–Ω–∏—è
 * @param holidays - –ú–∞—Å—Å–∏–≤ –¥–∞—Ç, —è–≤–ª—è—é—â–∏—Ö—Å—è –≤—ã—Ö–æ–¥–Ω—ã–º–∏
 * @returns –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ç–∞—Ä–∏—Ñ–∏—Ü–∏—Ä—É–µ–º—ã—Ö –¥–Ω–µ–π.
 */
export function calculateDayCount(
    start?: Date | null,
    end?: Date | null,
    holidays: Date[] = []
): number {
  // –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ—Å—Ç—å –¥–∞—Ç
  if (!start || !end || start >= end) {
    return 0;
  }

  // –°—á–∏—Ç–∞–µ–º –æ–±—â–µ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ "–Ω–æ—á–µ–π"
  const totalDays = Math.round((end.getTime() - start.getTime()) / (1000 * 60 * 60 * 24));

  if (holidays.length === 0) {
    return Math.max(0, totalDays);
  }

  // –°–æ–∑–¥–∞–µ–º –º–Ω–æ–∂–µ—Å—Ç–≤–æ –¥–∞—Ç –ø—Ä–∞–∑–¥–Ω–∏–∫–æ–≤ (–≤ —Ñ–æ—Ä–º–∞—Ç–µ YYYY-MM-DD) –¥–ª—è –±—ã—Å—Ç—Ä–æ–π –ø—Ä–æ–≤–µ—Ä–∫–∏
  const holidaySet = new Set(holidays.map(h => formatDate(h)));

  let nonBillableDays = 0;
  // –ü—Ä–æ–≤–µ—Ä—è–µ–º –∫–∞–∂–¥—ã–π –¥–µ–Ω—å –≤–Ω—É—Ç—Ä–∏ –¥–∏–∞–ø–∞–∑–æ–Ω–∞
  for (let i = 0; i < totalDays; i++) {
    const currentDay = new Date(start);
    currentDay.setDate(start.getDate() + i);

    // –ü—Ä–æ–ø—É—Å–∫–∞–µ–º —Å–∞–º –¥–µ–Ω—å –Ω–∞—á–∞–ª–∞, —Ç–∞–∫ –∫–∞–∫ –ø–æ –ø—Ä–∞–≤–∏–ª–∞–º –æ–Ω —Ç–∞—Ä–∏—Ñ–∏—Ü–∏—Ä—É–µ—Ç—Å—è
    if (i === 0) continue;

    if (holidaySet.has(formatDate(currentDay))) {
      nonBillableDays++;
    }
  }

  return Math.max(0, totalDays - nonBillableDays);
}

/**
 * –£–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç—Ç–µ—Ä –¥–∞—Ç—ã (YYYY-MM-DD)
 * –ü—Ä–∏–Ω–∏–º–∞–µ—Ç Date –∏–ª–∏ —Å—Ç—Ä–æ–∫—É, –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Å—Ç—Ä–æ–∫—É –≤ —Ñ–æ—Ä–º–∞—Ç–µ '2024-05-21'
 * –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–ª—è API –∏ input[type="date"]
 */
export function formatDate(date: Date | string | null | undefined): string {
  if (!date) return "";
  const d = typeof date === "string" ? new Date(date) : date;
  if (isNaN(d.getTime())) return "";
  const year = d.getFullYear();
  const month = String(d.getMonth() + 1).padStart(2, "0");
  const day = String(d.getDate()).padStart(2, "0");
  return `${year}-${month}-${day}`;
}

/**
 * –§–æ—Ä–º–∞—Ç—Ç–µ—Ä –¥–∞—Ç—ã –¥–ª—è UI (–î–î.–ú–ú.–ì–ì–ì–ì)
 * –ü—Ä–∏–Ω–∏–º–∞–µ—Ç Date –∏–ª–∏ —Å—Ç—Ä–æ–∫—É, –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Å—Ç—Ä–æ–∫—É –≤ —Ñ–æ—Ä–º–∞—Ç–µ '21.05.2024'
 * –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ –¥–ª—è –≤—ã–≤–æ–¥–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é!
 */
export function formatDateEuropean(date: Date | string | null | undefined): string {
  if (!date) return "";
  const d = typeof date === "string" ? new Date(date) : date;
  if (isNaN(d.getTime())) return "";
  const day = String(d.getDate()).padStart(2, "0");
  const month = String(d.getMonth() + 1).padStart(2, "0");
  const year = d.getFullYear();
  return `${day}.${month}.${year}`;
}

/**
 * –§–æ—Ä–º–∞—Ç—Ç–µ—Ä –¥–∏–∞–ø–∞–∑–æ–Ω–∞ –¥–∞—Ç –¥–ª—è UI (–Ω–∞–ø—Ä–∏–º–µ—Ä: 21.05.2024 ‚Äî 28.05.2024)
 */
export function formatDateRangeEuropean(start?: Date | string | null, end?: Date | string | null): string {
  if (!start || !end) return "";
  return `${formatDateEuropean(start)} ‚Äî ${formatDateEuropean(end)}`;
}

/**
 * –ë–µ–∑–æ–ø–∞—Å–Ω–æ —Ñ–æ—Ä–º–∞—Ç–∏—Ä—É–µ—Ç —á–∏—Å–ª–æ–≤–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ –≤ —Å—Ç—Ä–æ–∫—É —Å —Ä–∞–∑–¥–µ–ª–∏—Ç–µ–ª—è–º–∏ —Ç—ã—Å—è—á
 * @param value - —á–∏—Å–ª–æ–≤–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ –¥–ª—è —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
 * @param fallback - –∑–Ω–∞—á–µ–Ω–∏–µ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é, –µ—Å–ª–∏ value –Ω–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–æ
 * @returns –æ—Ç—Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–Ω–∞—è —Å—Ç—Ä–æ–∫–∞
 */
export function formatNumber(value: number | null | undefined, fallback: string = "0"): string {
  if (value === null || value === undefined || isNaN(value)) {
    return fallback;
  }
  return value.toLocaleString('ru-RU');
}

/**
 * –£—Ç–∏–ª–∏—Ç–∞ –æ–±—ä–µ–¥–∏–Ω–µ–Ω–∏—è –∫–ª–∞—Å—Å–æ–≤ —Å –ø–æ–¥–¥–µ—Ä–∂–∫–æ–π Tailwind –∏ clsx
 */
export function cn(...inputs: ClassValue[]) {
  return twMerge(clsx(inputs));
}

/**
 * –í—ã—á–∏—Å–ª—è–µ—Ç –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –¥–Ω–µ–π –ø—Ä–æ—Å—Ä–æ—á–∫–∏ –¥–ª—è –∞—Ä–µ–Ω–¥—ã
 * @param dueDate - –î–∞—Ç–∞ –≤–æ–∑–≤—Ä–∞—Ç–∞ (—Å—Ç—Ä–æ–∫–∞ –∏–ª–∏ Date)
 * @param daysOverdue - –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –¥–Ω–µ–π –ø—Ä–æ—Å—Ä–æ—á–∫–∏ —Å –±—ç–∫–µ–Ω–¥–∞ (–µ—Å–ª–∏ –µ—Å—Ç—å)
 * @returns –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –¥–Ω–µ–π –ø—Ä–æ—Å—Ä–æ—á–∫–∏
 */
export function calculateDaysOverdue(dueDate: string | Date | null | undefined, daysOverdue?: number | null): number {
  // –ï—Å–ª–∏ –±—ç–∫–µ–Ω–¥ –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–∏–ª –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –¥–Ω–µ–π –ø—Ä–æ—Å—Ä–æ—á–∫–∏, –∏—Å–ø–æ–ª—å–∑—É–µ–º –µ–≥–æ
  if (daysOverdue !== undefined && daysOverdue !== null) {
    return daysOverdue;
  }
  
  // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ dueDate –≤–∞–ª–∏–¥–µ–Ω
  if (!dueDate) {
    return 0;
  }
  
  // –í—ã—á–∏—Å–ª—è–µ–º –Ω–∞ –∫–ª–∏–µ–Ω—Ç–µ, –µ—Å–ª–∏ –ø–æ–ª–µ –Ω–µ –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª–µ–Ω–æ
  const due = typeof dueDate === "string" ? new Date(dueDate) : dueDate;
  
  // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –¥–∞—Ç–∞ –≤–∞–ª–∏–¥–Ω–∞
  if (isNaN(due.getTime())) {
    return 0;
  }
  
  const today = new Date();
  
  // –°–±—Ä–∞—Å—ã–≤–∞–µ–º –≤—Ä–µ–º—è –¥–ª—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–≥–æ —Å—Ä–∞–≤–Ω–µ–Ω–∏—è –¥–∞—Ç
  today.setHours(0, 0, 0, 0);
  due.setHours(0, 0, 0, 0);
  
  const diffTime = today.getTime() - due.getTime();
  const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
  
  return diffDays > 0 ? diffDays : 0;
}

/**
 * –ü—Ä–µ–æ–±—Ä–∞–∑—É–µ—Ç accessory_links –≤ selected_accessories –¥–ª—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏ —Å –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–∞–º–∏
 * @param reservation - –û–±—ä–µ–∫—Ç —Ä–µ–∑–µ—Ä–≤–∞ —Å accessory_links
 * @returns –û–±—ä–µ–∫—Ç —Ä–µ–∑–µ—Ä–≤–∞ —Å –¥–æ–±–∞–≤–ª–µ–Ω–Ω—ã–º selected_accessories
 */
export function transformAccessoryLinks<T extends { accessory_links?: Array<{ equipment_id: number; accessory: { id: number } }> }>(reservation: T): T & { selected_accessories: Record<number, number[]> } {
  if (!reservation.accessory_links || reservation.accessory_links.length === 0) {
    return { ...reservation, selected_accessories: {} };
  }
  
  const selected_accessories = reservation.accessory_links.reduce((acc, link) => {
    if (!acc[link.equipment_id]) {
      acc[link.equipment_id] = [];
    }
    acc[link.equipment_id].push(link.accessory.id);
    return acc;
  }, {} as Record<number, number[]>);
  
  return { ...reservation, selected_accessories };
}

```


## <a name="rentalappmainsrclibvalidationSchemasts"></a>`rental-app-main/src/lib/validationSchemas.ts`

```typescript
// path: rental-app-main/src/lib/validationSchemas.ts

// src/lib/validationSchemas.ts

import { z } from "zod";
import { USER_ROLE_VALUES } from "@/constants/userConstants";
import { validateRussianPhone } from "@/utils/phoneUtils";

// --- –ê—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è ---
export const authSchema = z.object({
    email: z.string().min(1, "Email –æ–±—è–∑–∞—Ç–µ–ª–µ–Ω").email("–ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π email"),
    password: z.string().min(6, "–ü–∞—Ä–æ–ª—å –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –Ω–µ –º–µ–Ω–µ–µ 6 —Å–∏–º–≤–æ–ª–æ–≤"),
    fullName: z.string().min(2, "–§–ò–û –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å –Ω–µ –∫–æ—Ä–æ—á–µ 2 —Å–∏–º–≤–æ–ª–æ–≤").optional(),
    phone: z.string().optional().refine(val => !val || validateRussianPhone(val), {
        message: "–ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç –Ω–æ–º–µ—Ä–∞ —Ç–µ–ª–µ—Ñ–æ–Ω–∞. –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ —Ñ–æ—Ä–º–∞—Ç: +7 (XXX) XXX-XX-XX",
    }),
    privacyPolicyAccepted: z.boolean().optional(),
    termsAccepted: z.boolean().optional(),
});
export type AuthSchema = z.infer<typeof authSchema>;


// --- –†–µ–∑–µ—Ä–≤—ã ---
// –≠—Ç–∞ Zod-—Å—Ö–µ–º–∞ —Ç–µ–ø–µ—Ä—å —è–≤–ª—è–µ—Ç—Å—è –ï–î–ò–ù–°–¢–í–ï–ù–ù–´–ú –∏—Å—Ç–æ—á–Ω–∏–∫–æ–º –ø—Ä–∞–≤–¥—ã –¥–ª—è —Ç–∏–ø–∞ –¥–∞–Ω–Ω—ã—Ö –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ —Ä–µ–∑–µ—Ä–≤–∞.
export const reservationCreateSchema = z.object({
    user_id: z.number().optional(), // –î–ª—è —Å–æ–∑–¥–∞–Ω–∏—è —Ä–µ–∑–µ—Ä–≤–∞ –∞–¥–º–∏–Ω–æ–º
    equipment_ids: z.array(z.number()).min(1, "–ù–µ–æ–±—Ö–æ–¥–∏–º–æ –≤—ã–±—Ä–∞—Ç—å —Ö–æ—Ç—è –±—ã –æ–¥–Ω–æ –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏–µ –¥–ª—è —Ä–µ–∑–µ—Ä–≤–∞."),
    start_date: z.string().refine((date) => /^\d{4}-\d{2}-\d{2}$/.test(date) && !isNaN(new Date(date).getTime()), {
        message: "–ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω–∞—è –¥–∞—Ç–∞ –Ω–∞—á–∞–ª–∞.",
    }),
    end_date: z.string().refine((date) => /^\d{4}-\d{2}-\d{2}$/.test(date) && !isNaN(new Date(date).getTime()), {
        message: "–ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω–∞—è –¥–∞—Ç–∞ –æ–∫–æ–Ω—á–∞–Ω–∏—è.",
    }),
    selected_accessories: z.record(z.array(z.number())).default({}),
    promo_code: z.string().optional(),
}).refine(data => new Date(data.end_date) > new Date(data.start_date), {
    message: "–î–∞—Ç–∞ –æ–∫–æ–Ω—á–∞–Ω–∏—è –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å –ø–æ–∑–∂–µ –¥–∞—Ç—ã –Ω–∞—á–∞–ª–∞.",
    path: ["end_date"],
});

// –≠–∫—Å–ø–æ—Ä—Ç–∏—Ä—É–µ–º —Ç–∏–ø, —Å–æ–∑–¥–∞–Ω–Ω—ã–π –Ω–∞ –æ—Å–Ω–æ–≤–µ Zod-—Å—Ö–µ–º—ã.
// –¢–µ–ø–µ—Ä—å —ç—Ç–æ—Ç —Ç–∏–ø –±—É–¥–µ—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å—Å—è –≤ —Å–µ—Ä–≤–∏—Å–∞—Ö –∏ —Ö—É–∫–∞—Ö, –≥–∞—Ä–∞–Ω—Ç–∏—Ä—É—è —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ.
export type ReservationCreateInput = z.infer<typeof reservationCreateSchema>;


// --- –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º–∏ (–ê–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å) ---
export const adminUserCreateFormSchema = z.object({
    full_name: z.string().min(2, "–§–ò–û –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ"),
    email: z.string().min(1, "Email –æ–±—è–∑–∞—Ç–µ–ª–µ–Ω").email("–ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π email"),
    password: z.string().min(6, "–ü–∞—Ä–æ–ª—å –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –Ω–µ –º–µ–Ω–µ–µ 6 —Å–∏–º–≤–æ–ª–æ–≤"),
    phone: z.string().optional(),
    role: z.enum(USER_ROLE_VALUES, {
        errorMap: () => ({ message: "–ù–µ–æ–±—Ö–æ–¥–∏–º–æ –≤—ã–±—Ä–∞—Ç—å —Ä–æ–ª—å." })
    }),
    privacyPolicyAccepted: z.boolean(),
    termsAccepted: z.boolean(),
    emailVerified: z.boolean(),
});
export type AdminUserCreateFormSchema = z.infer<typeof adminUserCreateFormSchema>;

export const adminUserUpdateSchema = z.object({
    full_name: z.string().min(2, "–§–ò–û –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ").optional(),
    phone: z.string().optional(),
    status: z.string().optional(),
    notes: z.string().optional(),
    balance: z.coerce.number().optional()
});
export type AdminUserUpdateSchema = z.infer<typeof adminUserUpdateSchema>;

export const adminUserRoleUpdateSchema = z.object({
    role: z.enum(USER_ROLE_VALUES, {
        errorMap: () => ({ message: "–ù–µ–æ–±—Ö–æ–¥–∏–º–æ –≤—ã–±—Ä–∞—Ç—å —Ä–æ–ª—å." })
    })
});
export type AdminUserRoleUpdateSchema = z.infer<typeof adminUserRoleUpdateSchema>;


// --- –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏–µ–º ---
export const equipmentUpdateExtendedSchema = z.object({
    equipment_type: z.string().min(1, "–¢–∏–ø –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—è –Ω–µ –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –ø—É—Å—Ç—ã–º.").optional(),
    brand: z.string().min(1, "–ë—Ä–µ–Ω–¥ –Ω–µ –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –ø—É—Å—Ç—ã–º.").optional(),
    name: z.string().min(1, "–ù–∞–∑–≤–∞–Ω–∏–µ –Ω–µ –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å –ø—É—Å—Ç—ã–º.").optional(),
    serial_number: z.string().nullable().optional(),
    condition: z.string().optional(),
    daily_rate: z.preprocess(
        (val) => (val === "" || val === null || val === undefined) ? undefined : parseFloat(String(val)),
        z.number({ invalid_type_error: "–°—Ç–æ–∏–º–æ—Å—Ç—å –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å —á–∏—Å–ª–æ–º." })
            .positive("–°—Ç–æ–∏–º–æ—Å—Ç—å –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å –ø–æ–ª–æ–∂–∏—Ç–µ–ª—å–Ω—ã–º —á–∏—Å–ª–æ–º.")
            .optional()
    ),
    notes: z.string().nullable().optional(),
    description: z.string().nullable().optional(),
    last_maintenance: z.string().nullable().optional().refine(val => val === null || val === undefined || val === "" || /^\d{4}-\d{2}-\d{2}$/.test(val), {
        message: "–î–∞—Ç–∞ –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ –¢–û –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å –≤ —Ñ–æ—Ä–º–∞—Ç–µ –ì–ì–ì–ì-–ú–ú-–î–î –∏–ª–∏ –æ—Ç—Å—É—Ç—Å—Ç–≤–æ–≤–∞—Ç—å.",
    }).transform(val => (val === "" ? undefined : val)),
    short_description: z.string().nullable().optional(),
    image_url: z.string().nullable().optional(),
    image_urls: z.array(z.string()).optional(),
    accessory_ids: z.array(z.number()).optional(),
});
export type EquipmentUpdateExtendedSchema = z.infer<typeof equipmentUpdateExtendedSchema>;


// --- –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∞–∫—Å–µ—Å—Å—É–∞—Ä–∞–º–∏ ---
export const accessorySchema = z.object({
    name: z.string().min(2, { message: "–ù–∞–∑–≤–∞–Ω–∏–µ –¥–æ–ª–∂–Ω–æ —Å–æ–¥–µ—Ä–∂–∞—Ç—å –º–∏–Ω–∏–º—É–º 2 —Å–∏–º–≤–æ–ª–∞." }),
    accessory_type: z.string().optional(),
    price: z.preprocess(
        (value) => (value === "" ? undefined : value),
        z.coerce.number({ invalid_type_error: "–¶–µ–Ω–∞ –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å —á–∏—Å–ª–æ–º." })
            .min(0, { message: "–¶–µ–Ω–∞ –Ω–µ –º–æ–∂–µ—Ç –±—ã—Ç—å –æ—Ç—Ä–∏—Ü–∞—Ç–µ–ª—å–Ω–æ–π." })
            .optional()
    ),
    description: z.string().optional(),
});
export type AccessorySchema = z.infer<typeof accessorySchema>;


// --- –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø—Ä–æ–º–æ–∫–æ–¥–∞–º–∏ ---
export const promoCodeFormSchema = z.object({
    code: z.string().min(3, "–ö–æ–¥ –¥–æ–ª–∂–µ–Ω —Å–æ–¥–µ—Ä–∂–∞—Ç—å –º–∏–Ω–∏–º—É–º 3 —Å–∏–º–≤–æ–ª–∞").max(50),
    description: z.string().optional(),
    discount_percentage: z.coerce.number({ invalid_type_error: "–°–∫–∏–¥–∫–∞ –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å —á–∏—Å–ª–æ–º" })
        .min(1, "–°–∫–∏–¥–∫–∞ –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å –±–æ–ª—å—à–µ 0")
        .max(50, "–ú–∞–∫—Å–∏–º–∞–ª—å–Ω–∞—è —Å–∫–∏–¥–∫–∞ 50%"),
    is_active: z.boolean().default(true),
    valid_from: z.date().optional(),
    expires_at: z.date().optional(),
    max_uses: z.preprocess(
        (val) => (val === "" || val === null || val === undefined) ? undefined : parseInt(String(val), 10),
        z.number().positive("–ó–Ω–∞—á–µ–Ω–∏–µ –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å –±–æ–ª—å—à–µ 0").optional()
    ),
    max_uses_per_user: z.preprocess(
        (val) => (val === "" || val === null || val === undefined) ? undefined : parseInt(String(val), 10),
        z.number().positive("–ó–Ω–∞—á–µ–Ω–∏–µ –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å –±–æ–ª—å—à–µ 0").optional()
    ),
    min_order_amount: z.preprocess(
        (val) => (val === "" || val === null || val === undefined) ? undefined : parseFloat(String(val)),
        z.number().positive("–ó–Ω–∞—á–µ–Ω–∏–µ –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å –±–æ–ª—å—à–µ 0").optional()
    ),
    applicable_to_equipment_ids: z.array(z.number()).optional(),
    applicable_to_equipment_types: z.array(z.string()).optional(),
    specific_to_user_id: z.coerce.number().optional(),
}).refine(data => {
    if (data.valid_from && data.expires_at) {
        return data.expires_at >= data.valid_from;
    }
    return true;
}, {
    message: "–î–∞—Ç–∞ –æ–∫–æ–Ω—á–∞–Ω–∏—è –Ω–µ –º–æ–∂–µ—Ç –±—ã—Ç—å —Ä–∞–Ω—å—à–µ –¥–∞—Ç—ã –Ω–∞—á–∞–ª–∞",
    path: ["expires_at"],
});
export type PromoCodeFormData = z.infer<typeof promoCodeFormSchema>;

// +++ –ù–ê–ß–ê–õ–û: –ù–æ–≤–∞—è —Å—Ö–µ–º–∞ –¥–ª—è —Ñ–æ—Ä–º—ã –ø–æ–ø–æ–ª–Ω–µ–Ω–∏—è –±–∞–ª–∞–Ω—Å–∞ +++
export const userPaymentSchema = z.object({
    amount: z.coerce
        .number({ invalid_type_error: "–°—É–º–º–∞ –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å —á–∏—Å–ª–æ–º" })
        .positive("–°—É–º–º–∞ –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å –±–æ–ª—å—à–µ –Ω—É–ª—è"),
    payment_method: z.string().min(1, "–ù–µ–æ–±—Ö–æ–¥–∏–º–æ –≤—ã–±—Ä–∞—Ç—å –º–µ—Ç–æ–¥ –æ–ø–ª–∞—Ç—ã"),
    description: z.string().optional(),
});
export type UserPaymentSchema = z.infer<typeof userPaymentSchema>;
// +++ –ö–û–ù–ï–¶: –ù–æ–≤–∞—è —Å—Ö–µ–º–∞ +++

```


## <a name="rentalappmainsrcmaintsx"></a>`rental-app-main/src/main.tsx`

```tsx
// path: rental-app-main/src/main.tsx

// src/main.tsx

import React from "react";
import ReactDOM from "react-dom/client";
import {BrowserRouter} from "react-router-dom";
import App from "./app/App";

// 1. –°–ù–ê–ß–ê–õ–ê –∏–º–ø–æ—Ä—Ç–∏—Ä—É–µ–º —Å—Ç–∏–ª–∏ –±–∏–±–ª–∏–æ—Ç–µ–∫–∏
import 'react-day-picker/dist/style.css';

// 2. –ü–û–¢–û–ú –∏–º–ø–æ—Ä—Ç–∏—Ä—É–µ–º –Ω–∞—à–∏ —Å–æ–±—Å—Ç–≤–µ–Ω–Ω—ã–µ —Å—Ç–∏–ª–∏ –¥–ª—è –∏—Ö –ø–µ—Ä–µ–æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è
import "./index.css";

import {QueryClientProvider} from "@tanstack/react-query";
import {queryClient} from "./lib/queryClient";
import {ReactQueryDevtools} from "@tanstack/react-query-devtools";
import ErrorBoundary from "./components/ErrorBoundary";
import NetworkStatus from "./components/NetworkStatus";

ReactDOM.createRoot(document.getElementById("root")!).render(
    <React.StrictMode>
        <QueryClientProvider client={queryClient}>
            <ErrorBoundary>
                <BrowserRouter>
                    <App/>
                    <NetworkStatus/>
                </BrowserRouter>
            </ErrorBoundary>
            <ReactQueryDevtools initialIsOpen={false}/>
        </QueryClientProvider>
    </React.StrictMode>
);

```


## <a name="rentalappmainsrcpagesAccessoryManagementPagetsx"></a>`rental-app-main/src/pages/AccessoryManagementPage.tsx`

```tsx
// path: rental-app-main/src/pages/AccessoryManagementPage.tsx

// src/pages/AccessoryManagementPage.tsx

import AdminNavigation from "@/components/admin/AdminNavigation";
// ‚úÖ –ò–ú–ü–û–†–¢–ò–†–£–ï–ú –†–ï–ê–õ–¨–ù–´–ô –ö–û–ú–ü–û–ù–ï–ù–¢
import AccessoryTable from "@/components/admin/AccessoryTable";
import { Button } from "@/components/ui/button";
import { Shield, Paperclip } from "lucide-react";
import { useNavigate } from "react-router-dom";
import { useCurrentUser } from "@/hooks/useProfile";

export default function AccessoryManagementPage() {
    const { data: currentUser } = useCurrentUser();
    const navigate = useNavigate();
    const isManager = currentUser?.role === "manager" || currentUser?.role === "admin";

    if (!isManager) {
        return (
            <div className="max-w-4xl mx-auto px-4 py-8 text-center">
                <Shield className="w-16 h-16 text-gray-400 mx-auto mb-4" />
                <h1 className="text-2xl font-bold text-gray-900 mb-2">–î–æ—Å—Ç—É–ø –æ–≥—Ä–∞–Ω–∏—á–µ–Ω</h1>
                <p className="text-gray-600 mb-4">
                    –£ –≤–∞—Å –Ω–µ—Ç –ø—Ä–∞–≤ –¥–ª—è –¥–æ—Å—Ç—É–ø–∞ –∫ —ç—Ç–æ–º—É —Ä–∞–∑–¥–µ–ª—É.
                </p>
                <Button onClick={() => navigate("/")}>–ù–∞ –≥–ª–∞–≤–Ω—É—é</Button>
            </div>
        );
    }

    return (
        <div className="max-w-7xl mx-auto px-4 py-6 space-y-6">
            <AdminNavigation />
            <div className="flex items-center gap-3">
                <Paperclip className="w-8 h-8 text-purple-600" />
                <div>
                    <h1 className="text-3xl font-bold text-gray-900">
                        –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∞–∫—Å–µ—Å—Å—É–∞—Ä–∞–º–∏
                    </h1>
                    <p className="text-gray-600 mt-1">
                        –î–æ–±–∞–≤–ª–µ–Ω–∏–µ, —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∏ —É–¥–∞–ª–µ–Ω–∏–µ –∞–∫—Å–µ—Å—Å—É–∞—Ä–æ–≤.
                    </p>
                </div>
            </div>
            <div className="bg-white rounded-lg border shadow-sm p-6">
                {/* ‚úÖ –ó–ê–ú–ï–ù–Ø–ï–ú –ó–ê–ì–õ–£–®–ö–£ –ù–ê –ö–û–ú–ü–û–ù–ï–ù–¢ */}
                <AccessoryTable />
            </div>
        </div>
    );
}

```


## <a name="rentalappmainsrcpagesCalendarPagetsx"></a>`rental-app-main/src/pages/CalendarPage.tsx`

```tsx
// path: rental-app-main/src/pages/CalendarPage.tsx

// src/pages/CalendarPage.tsx

import { useEffect, useState, useMemo, useCallback } from "react";
import { useDateStore } from "@/store/dateStore";
import { useEquipment } from "@/hooks/useEquipment";
import { useAllEquipment } from "@/hooks/useAllEquipment"; // ++ 1. –ò–º–ø–æ—Ä—Ç–∏—Ä—É–µ–º —Ö—É–∫ –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –≤—Å–µ—Ö –¥–∞–Ω–Ω—ã—Ö –¥–ª—è —Ñ–∏–ª—å—Ç—Ä–æ–≤
import CalendarFiltersBlock from "@/components/calendar/CalendarFiltersBlock";
import CalendarTable from "@/components/calendar/CalendarTable";
import { useCalendarSelectionStore } from "@/store/calendarSelectionStore";
import { Button } from "@/components/ui/button";
import { Home, ArrowLeft, Loader2 } from "lucide-react";
import { useNavigate } from "react-router-dom";

export default function CalendarPage() {
    const { setRange } = useDateStore();
    const { setSelectedGroupId } = useCalendarSelectionStore();
    const navigate = useNavigate();

    // -- –£–¥–∞–ª—è–µ–º –Ω–µ–∏—Å–ø–æ–ª—å–∑—É–µ–º—ã–π currentUser --

    const [typeFilter, setTypeFilter] = useState<string | null>(null);
    const [brandFilter, setBrandFilter] = useState<string | null>(null);
    const [searchText, setSearchText] = useState<string>("");
    const [isLoadingAll, setIsLoadingAll] = useState(false);

    // ++ 2. –ü–æ–ª—É—á–∞–µ–º –ü–û–õ–ù–´–ô —Å–ø–∏—Å–æ–∫ –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—è –û–î–ò–ù —Ä–∞–∑ –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –æ–ø—Ü–∏–π –≤ —Ñ–∏–ª—å—Ç—Ä–∞—Ö ++
    const { data: allEquipmentForFilters = [] } = useAllEquipment();

    // ++ 3. –ü–æ–ª—É—á–∞–µ–º –ü–ê–ì–ò–ù–ò–†–û–í–ê–ù–ù–´–ô –∏ —É–∂–µ –æ—Ç—Ñ–∏–ª—å—Ç—Ä–æ–≤–∞–Ω–Ω—ã–π —Å–µ—Ä–≤–µ—Ä–æ–º —Å–ø–∏—Å–æ–∫ –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –≤ —Ç–∞–±–ª–∏—Ü–µ ++
    const {
        data: equipmentPages,
        fetchNextPage,
        hasNextPage,
        isFetchingNextPage
    } = useEquipment({
        type: typeFilter,
        brand: brandFilter,
        query: searchText
    });

    const paginatedAndFilteredEquipment = useMemo(() => equipmentPages?.pages.flatMap(page => page.items) ?? [], [equipmentPages]);

    // ++ 4. –û–±–æ—Ä–∞—á–∏–≤–∞–µ–º —Ñ—É–Ω–∫—Ü–∏—é –≤ useCallback –∏ –¥–æ–±–∞–≤–ª—è–µ–º –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ useEffect, —á—Ç–æ–±—ã –∏—Å–ø—Ä–∞–≤–∏—Ç—å –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ ++
    const resetToDefaultRange = useCallback(() => {
        const today = new Date();
        const expectedStart = new Date(today);
        expectedStart.setDate(today.getDate() - 3);
        const expectedEnd = new Date(today);
        expectedEnd.setDate(today.getDate() + 13);
        setRange(expectedStart, expectedEnd);
    }, [setRange]);

    useEffect(() => {
        resetToDefaultRange();
    }, [resetToDefaultRange]);

    const handleResetAll = () => {
        resetToDefaultRange();
        setTypeFilter(null);
        setBrandFilter(null);
        setSearchText("");
        setSelectedGroupId(null);
    };

    const handleLoadAll = () => {
        setIsLoadingAll(true);
    };

    useEffect(() => {
        if (isLoadingAll && hasNextPage && !isFetchingNextPage) {
            // ++ 5. –î–æ–±–∞–≤–ª—è–µ–º `void` —á—Ç–æ–±—ã –∏—Å–ø—Ä–∞–≤–∏—Ç—å –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ –æ –Ω–µ–∏—Å–ø–æ–ª—å–∑—É–µ–º–æ–º Promise ++
            void fetchNextPage();
        }
        if (isLoadingAll && !hasNextPage && !isFetchingNextPage) {
            setIsLoadingAll(false);
        }
    }, [isLoadingAll, hasNextPage, isFetchingNextPage, fetchNextPage]);

    return (
        <div className="p-4 space-y-4">
            <div className="flex justify-between items-center mb-4">
                <div className="flex gap-2">
                    <Button variant="outline" onClick={() => navigate(-1)} className="flex items-center gap-2">
                        <ArrowLeft className="w-4 h-4" /> –ù–∞–∑–∞–¥
                    </Button>
                    <Button variant="outline" onClick={() => navigate("/")} className="flex items-center gap-2">
                        <Home className="w-4 h-4" /> –ù–∞ –≥–ª–∞–≤–Ω—É—é
                    </Button>
                </div>
            </div>

            <div className="flex flex-wrap gap-4 p-4 bg-white rounded-lg border shadow-sm mb-4">
                <div className="flex items-center gap-2"><div className="w-4 h-4 bg-emerald-50 rounded"></div><span className="text-sm">–°–≤–æ–±–æ–¥–Ω–æ</span></div>
                <div className="flex items-center gap-2"><div className="w-4 h-4 bg-amber-300 rounded"></div><span className="text-sm">–†–µ–∑–µ—Ä–≤</span></div>
                <div className="flex items-center gap-2"><div className="w-4 h-4 bg-rose-400 rounded"></div><span className="text-sm">–ê—Ä–µ–Ω–¥–∞</span></div>
                {/* –ü—Ä–æ–≤–µ—Ä–∫—É –Ω–∞ currentUser –º–æ–∂–Ω–æ —É–±—Ä–∞—Ç—å, –µ—Å–ª–∏ –æ–Ω–∞ –±–æ–ª—å—à–µ –Ω–∏–≥–¥–µ –Ω–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è, –ª–∏–±–æ –æ—Å—Ç–∞–≤–∏—Ç—å –¥–ª—è –±—É–¥—É—â–∏—Ö —Ä–∞—Å—à–∏—Ä–µ–Ω–∏–π */}
                <div className="flex items-center gap-2"><div className="w-4 h-4 bg-amber-500 rounded"></div><span className="text-sm">–ú–æ–π —Ä–µ–∑–µ—Ä–≤</span></div>
            </div>

            {/* ++ 6. –ü–µ—Ä–µ–¥–∞–µ–º –ü–û–õ–ù–´–ô —Å–ø–∏—Å–æ–∫ –≤ –±–ª–æ–∫ —Ñ–∏–ª—å—Ç—Ä–æ–≤ –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –≤—Å–µ—Ö –æ–ø—Ü–∏–π ++ */}
            <CalendarFiltersBlock
                equipment={allEquipmentForFilters}
                typeFilter={typeFilter}
                setTypeFilter={setTypeFilter}
                brandFilter={brandFilter}
                setBrandFilter={setBrandFilter}
                searchText={searchText}
                setSearchText={setSearchText}
                onReset={handleResetAll}
            />
            {/* ++ 7. –ü–µ—Ä–µ–¥–∞–µ–º –ü–ê–ì–ò–ù–ò–†–û–í–ê–ù–ù–´–ô —Å–ø–∏—Å–æ–∫ –≤ —Ç–∞–±–ª–∏—Ü—É –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è ++ */}
            <CalendarTable equipment={paginatedAndFilteredEquipment} />

            {hasNextPage && (
                <div className="flex justify-center items-center gap-4 mt-4">
                    <Button variant="outline" onClick={() => fetchNextPage()} disabled={isFetchingNextPage || isLoadingAll}>
                        {isFetchingNextPage && !isLoadingAll ? (
                            <><Loader2 className="mr-2 h-4 w-4 animate-spin" /> –ó–∞–≥—Ä—É–∑–∫–∞...</>
                        ) : ( "–ó–∞–≥—Ä—É–∑–∏—Ç—å –µ—â—ë" )}
                    </Button>
                    <Button variant="secondary" onClick={handleLoadAll} disabled={isFetchingNextPage || isLoadingAll}>
                        {isLoadingAll ? (
                            <><Loader2 className="mr-2 h-4 w-4 animate-spin" /> –ó–∞–≥—Ä—É–∑–∫–∞ –≤—Å–µ—Ö...</>
                        ) : ( "–ó–∞–≥—Ä—É–∑–∏—Ç—å –≤—Å—ë" )}
                    </Button>
                </div>
            )}
        </div>
    );
}

```


## <a name="rentalappmainsrcpagesCalendarTestPagetsx"></a>`rental-app-main/src/pages/CalendarTestPage.tsx`

```tsx
// path: rental-app-main/src/pages/CalendarTestPage.tsx

// src/pages/CalendarTestPage.tsx
// –≠—Ç–æ—Ç —Ñ–∞–π–ª —Å–æ–¥–µ—Ä–∂–∏—Ç –ø–æ–ª–Ω—ã–π –∫–æ–¥ –¥–ª—è —Å—Ç—Ä–∞–Ω–∏—Ü—ã —Å –∫–∞—Å—Ç–æ–º–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–º –∫–∞–ª–µ–Ω–¥–∞—Ä—ë–º.

import { useState } from 'react';
import { DayPicker, type DateRange } from 'react-day-picker';
import { ru } from 'date-fns/locale'; // –ò–º–ø–æ—Ä—Ç–∏—Ä—É–µ–º —Ä—É—Å—Å–∫—É—é –ª–æ–∫–∞–ª—å –¥–ª—è –Ω–∞–∑–≤–∞–Ω–∏–π

export default function CalendarTestPage() {
    // –õ–æ–∫–∞–ª—å–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ –¥–∏–∞–ø–∞–∑–æ–Ω–∞ –¥–∞—Ç
    const [range, setRange] = useState<DateRange | undefined>();

    return (
        // –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –¥–ª—è —Ü–µ–Ω—Ç—Ä–∏—Ä–æ–≤–∞–Ω–∏—è –∫–∞–ª–µ–Ω–¥–∞—Ä—è –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–µ
        <div className="p-10 bg-gray-100 min-h-screen flex flex-col items-center justify-center">
            <h1 className="text-3xl font-bold text-gray-800 text-center mb-6">
                –¢–µ—Å—Ç–æ–≤—ã–π –∫–∞–ª–µ–Ω–¥–∞—Ä—å —Å –∫—Ä–∞—Å–Ω—ã–º –≤—ã–¥–µ–ª–µ–Ω–∏–µ–º
            </h1>

            <div className="bg-white p-4 rounded-lg shadow-lg border">
                <DayPicker
                    mode="range"
                    locale={ru} // –ò—Å–ø–æ–ª—å–∑—É–µ–º —Ä—É—Å—Å–∫—É—é –ª–æ–∫–∞–ª—å
                    selected={range}
                    onSelect={setRange}
                    numberOfMonths={2}
                    showOutsideDays
                    // –°—Ç–∏–ª–∏ –¥–ª—è –æ—Å–Ω–æ–≤–Ω—ã—Ö —ç–ª–µ–º–µ–Ω—Ç–æ–≤ –∫–∞–ª–µ–Ω–¥–∞—Ä—è, –≤–∑—è—Ç—ã–µ –∏–∑ –≤–∞—à–µ–≥–æ –ø—Ä–æ–µ–∫—Ç–∞
                    classNames={{
                        months: 'flex flex-col sm:flex-row space-y-4 sm:space-x-4 sm:space-y-0',
                        month: 'space-y-4',
                        table: 'w-full border-collapse space-y-1',
                        head_row: 'flex',
                        head_cell: 'text-muted-foreground rounded-md w-9 font-normal text-[0.8rem]',
                        row: 'flex w-full mt-2',
                        cell: 'h-9 w-9 text-center text-sm p-0 relative [&:has([aria-selected])]:bg-accent first:[&:has([aria-selected])]:rounded-l-md last:[&:has([aria-selected])]:rounded-r-md focus-within:relative focus-within:z-20',
                        day: 'h-9 w-9 p-0 font-normal aria-selected:opacity-100',
                        nav: 'space-x-1 flex items-center',
                        caption: 'flex justify-center pt-1 relative items-center',
                        caption_label: 'text-sm font-medium',
                        nav_button: 'h-7 w-7 bg-transparent p-0 opacity-50 hover:opacity-100'
                    }}
                    // –°—Ç–∏–ª–∏ –¥–ª—è —Å–æ—Å—Ç–æ—è–Ω–∏–π –¥–Ω–µ–π (–º–æ–¥–∏—Ñ–∏–∫–∞—Ç–æ—Ä–æ–≤)
                    modifiersClassNames={{
                        today: 'bg-accent text-accent-foreground',
                        // –°–∏–Ω–∏–µ —Ü–≤–µ—Ç–∞ –¥–ª—è –≤—ã–±—Ä–∞–Ω–Ω—ã—Ö –¥–∞—Ç
                        selected: 'bg-sky-600 text-white hover:bg-sky-600 hover:text-white focus:bg-sky-600 focus:text-white',
                        // –°–∫—Ä—É–≥–ª–µ–Ω–∏—è –¥–ª—è –Ω–∞—á–∞–ª–∞ –∏ –∫–æ–Ω—Ü–∞ –¥–∏–∞–ø–∞–∑–æ–Ω–∞
                        range_start: 'rounded-l-full',
                        range_end: 'rounded-r-full',
                        range_middle: 'aria-selected:bg-sky-100 aria-selected:text-sky-900',
                        outside: 'day-outside text-muted-foreground opacity-50',
                        disabled: 'text-muted-foreground opacity-50',
                    }}
                />
            </div>
            <div className="mt-4 p-4 bg-white rounded-lg shadow-lg border text-sm text-gray-700">
                <p>–í—ã–±—Ä–∞–Ω–Ω—ã–π –¥–∏–∞–ø–∞–∑–æ–Ω:</p>
                {range?.from ? (
                    <pre className="mt-2 font-mono">{JSON.stringify(range, null, 2)}</pre>
                ) : (
                    <p className="text-gray-500 italic mt-1">–ù–∏—á–µ–≥–æ –Ω–µ –≤—ã–±—Ä–∞–Ω–æ</p>
                )}
            </div>
        </div>
    );
}

```


## <a name="rentalappmainsrcpagesContactPagetsx"></a>`rental-app-main/src/pages/ContactPage.tsx`

```tsx
// path: rental-app-main/src/pages/ContactPage.tsx

// src/pages/ContactPage.tsx
import { Button } from "@/components/ui/button"
import { useNavigate, useLocation } from "react-router-dom"

export default function ContactPage() {
    const navigate = useNavigate()
    const location = useLocation()

    const backTo = location.state?.from || -1

    const telegramBot = "d30manager"
    const message = encodeURIComponent(
        "–ó–¥—Ä–∞–≤—Å—Ç–≤—É–π—Ç–µ, —è —Ö–æ—á—É –æ—Ç–º–µ–Ω–∏—Ç—å —Ä–µ–∑–µ—Ä–≤. –î–æ –µ–≥–æ –æ–∫–æ–Ω—á–∞–Ω–∏—è –æ—Å—Ç–∞–ª–æ—Å—å –º–µ–Ω–µ–µ 2 –¥–Ω–µ–π."
    )
    const telegramLink = `https://t.me/${telegramBot}?start=${message}`

    return (
        <div className="max-w-2xl mx-auto px-4 py-6 sm:py-8 space-y-6">
            <h1 className="text-2xl font-bold text-center sm:text-left">–°–≤—è–∑—å —Å –º–µ–Ω–µ–¥–∂–µ—Ä–æ–º</h1>

            <p className="text-sm text-gray-700">
                –ï—Å–ª–∏ –≤—ã —Ö–æ—Ç–∏—Ç–µ –æ—Ç–º–µ–Ω–∏—Ç—å —Ä–µ–∑–µ—Ä–≤, –¥–æ –æ–∫–æ–Ω—á–∞–Ω–∏—è –∫–æ—Ç–æ—Ä–æ–≥–æ –æ—Å—Ç–∞–ª–æ—Å—å –º–µ–Ω–µ–µ 2-—Ö –¥–Ω–µ–π,
                –ø–æ–∂–∞–ª—É–π—Å—Ç–∞, —Å–≤—è–∂–∏—Ç–µ—Å—å —Å –Ω–∞–º–∏ –ª—é–±—ã–º —É–¥–æ–±–Ω—ã–º —Å–ø–æ—Å–æ–±–æ–º:
            </p>

            <ul className="text-sm text-gray-800 list-disc list-inside space-y-1">
                <li>Email:{" "}
                    <a href="mailto:info@digital30.ru" className="text-sky-600 hover:underline">
                        info@digital30.ru
                    </a>
                </li>
                <li>–¢–µ–ª–µ—Ñ–æ–Ω: <span className="font-semibold">+7 (908) 6177177</span></li>
                <li>Telegram:{" "}
                    <a href={`https://t.me/${telegramBot}`} className="text-sky-600 hover:underline">
                        @{telegramBot}
                    </a>
                </li>
            </ul>

            <div className="flex flex-col sm:flex-row gap-3 pt-4 sm:pt-6">
                <Button
                    onClick={() => window.open(telegramLink, "_blank")}
                    variant="default"
                    className="w-full sm:w-auto"
                >
                    üí¨ –ù–∞–ø–∏—Å–∞—Ç—å –≤ Telegram
                </Button>

                <Button
                    variant="outline"
                    onClick={() => typeof backTo === "string" ? navigate(backTo) : navigate(-1)}
                    className="w-full sm:w-auto"
                >
                    ‚Üê –í–µ—Ä–Ω—É—Ç—å—Å—è –Ω–∞–∑–∞–¥
                </Button>
            </div>
        </div>
    )
}


```


## <a name="rentalappmainsrcpagesEquipmentManagementPagetsx"></a>`rental-app-main/src/pages/EquipmentManagementPage.tsx`

```tsx
// path: rental-app-main/src/pages/EquipmentManagementPage.tsx

// src/pages/EquipmentManagementPage.tsx

import { useState, useEffect, useMemo } from "react";
import { useCurrentUser } from "@/hooks/useProfile";
import AdminNavigation from "@/components/admin/AdminNavigation";
import EquipmentTable from "@/components/admin/EquipmentTable";
import EquipmentEditDialog from "@/components/admin/EquipmentEditDialog";
import { Button } from "@/components/ui/button";
import { Shield, Package } from "lucide-react";
import { useNavigate } from "react-router-dom";
import type { Equipment } from "@/types/equipment";
import { useEquipment } from "@/hooks/useEquipment";
import type { EquipmentListResponse } from "@/core/services/EquipmentService";

export default function EquipmentManagementPage() {
    const { data: currentUser } = useCurrentUser();
    const navigate = useNavigate();

    // ‚úÖ –ò–ó–ú–ï–ù–ï–ù–ò–ï: –ü–æ–ª—É—á–∞–µ–º –∏–∑ —Ö—É–∫–∞ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –¥–ª—è –ø–∞–≥–∏–Ω–∞—Ü–∏–∏
    const {
        data: equipmentPages,
        fetchNextPage,
        hasNextPage,
        isFetchingNextPage
    } = useEquipment();

    // "–†–∞—Å–ø–ª—é—â–∏–≤–∞–µ–º" —Å—Ç—Ä–∞–Ω–∏—Ü—ã –≤ –æ–¥–∏–Ω –æ–±—â–∏–π –º–∞—Å—Å–∏–≤ —Å –ø–æ–º–æ—â—å—é useMemo
    const allEquipment = useMemo(() =>
            equipmentPages?.pages.flatMap((page: EquipmentListResponse) => page.items) ?? [],
        [equipmentPages]);

    const [selectedEquipment, setSelectedEquipment] = useState<Equipment | null>(null);
    const [showEditDialog, setShowEditDialog] = useState(false);

    const isAdmin = currentUser?.role === "admin";
    const isManager = currentUser?.role === "manager" || isAdmin;

    useEffect(() => {
        if (!showEditDialog) {
            document.body.style.overflow = '';
        }
    }, [showEditDialog]);

    if (!isManager) {
        return (
            <div className="max-w-4xl mx-auto px-4 py-8">
                <div className="text-center">
                    <Shield className="w-16 h-16 text-gray-400 mx-auto mb-4" />
                    <h1 className="text-2xl font-bold text-gray-900 mb-2">
                        –î–æ—Å—Ç—É–ø –æ–≥—Ä–∞–Ω–∏—á–µ–Ω
                    </h1>
                    <p className="text-gray-600 mb-4">
                        –£ –≤–∞—Å –Ω–µ—Ç –ø—Ä–∞–≤ –¥–ª—è –¥–æ—Å—Ç—É–ø–∞ –∫ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—é –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏–µ–º.
                    </p>
                    <Button onClick={() => navigate("/")}>
                        –ù–∞ –≥–ª–∞–≤–Ω—É—é
                    </Button>
                </div>
            </div>
        );
    }

    const handleEditEquipment = (equipment: Equipment) => {
        setSelectedEquipment(equipment);
        setShowEditDialog(true);
    };

    const handleCloseDialog = () => {
        setShowEditDialog(false);
        setSelectedEquipment(null);
    };

    return (
        <div className="max-w-7xl mx-auto px-4 py-6 space-y-6">
            <AdminNavigation />

            <div className="flex items-center justify-between">
                <div className="flex items-center gap-3">
                    <Package className="w-8 h-8 text-green-600" />
                    <div>
                        <h1 className="text-3xl font-bold text-gray-900">
                            –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏–µ–º
                        </h1>
                        <p className="text-gray-600 mt-1">
                            –î–æ–±–∞–≤–ª–µ–Ω–∏–µ, —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∏ —É–¥–∞–ª–µ–Ω–∏–µ –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—è –¥–ª—è –∞—Ä–µ–Ω–¥—ã
                        </p>
                    </div>
                </div>
            </div>

            <div className="bg-white rounded-lg border shadow-sm p-6">
                {/* ‚úÖ –ò–ó–ú–ï–ù–ï–ù–ò–ï: –ü–µ—Ä–µ–¥–∞–µ–º –Ω–æ–≤—ã–µ —Å–≤–æ–π—Å—Ç–≤–∞ –¥–ª—è –ø–∞–≥–∏–Ω–∞—Ü–∏–∏ –≤ —Ç–∞–±–ª–∏—Ü—É */}
                <EquipmentTable
                    onEditEquipment={handleEditEquipment}
                    equipment={allEquipment}
                    onLoadMore={fetchNextPage}
                    hasNextPage={hasNextPage}
                    isFetchingNextPage={isFetchingNextPage}
                />
            </div>

            {/* –ë–ª–æ–∫–∏ —Å —Å–æ–≤–µ—Ç–∞–º–∏ –∏ —Å–æ—Å—Ç–æ—è–Ω–∏—è–º–∏ –æ—Å—Ç–∞—é—Ç—Å—è –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π */}
            <div className="bg-blue-50 border border-blue-200 rounded-lg p-4">
                <h3 className="font-semibold text-blue-900 mb-3">üí° –ü–æ–ª–µ–∑–Ω—ã–µ —Å–æ–≤–µ—Ç—ã</h3>
                <div className="grid grid-cols-1 md:grid-cols-2 gap-4 text-sm text-blue-800">
                    <div>
                        <p className="font-medium mb-2">–î–æ–±–∞–≤–ª–µ–Ω–∏–µ –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—è:</p>
                        <ul className="space-y-1">
                            <li>‚Ä¢ –£–∫–∞–∑—ã–≤–∞–π—Ç–µ –ø–æ–¥—Ä–æ–±–Ω–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ –¥–ª—è –∫–ª–∏–µ–Ω—Ç–æ–≤</li>
                            <li>‚Ä¢ –î–æ–±–∞–≤–ª—è–π—Ç–µ —Å–µ—Ä–∏–π–Ω—ã–µ –Ω–æ–º–µ—Ä–∞ –¥–ª—è —É—á–µ—Ç–∞</li>
                            <li>‚Ä¢ –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–π—Ç–µ –∞–∫—Ç—É–∞–ª—å–Ω—ã–µ —Ç–∞—Ä–∏—Ñ—ã</li>
                        </ul>
                    </div>
                    <div>
                        <p className="font-medium mb-2">–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ:</p>
                        <ul className="space-y-1">
                            <li>‚Ä¢ –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –ø–æ–∏—Å–∫ –¥–ª—è –±—ã—Å—Ç—Ä–æ–≥–æ –Ω–∞—Ö–æ–∂–¥–µ–Ω–∏—è</li>
                            <li>‚Ä¢ –í—ã–¥–µ–ª—è–π—Ç–µ –Ω–µ—Å–∫–æ–ª—å–∫–æ —ç–ª–µ–º–µ–Ω—Ç–æ–≤ –¥–ª—è –º–∞—Å—Å–æ–≤—ã—Ö –æ–ø–µ—Ä–∞—Ü–∏–π</li>
                            <li>‚Ä¢ –†–µ–≥—É–ª—è—Ä–Ω–æ –æ–±–Ω–æ–≤–ª—è–π—Ç–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—è</li>
                        </ul>
                    </div>
                </div>
            </div>
            <div className="bg-gray-50 rounded-lg p-4">
                <h3 className="font-semibold text-gray-900 mb-3">–°–æ—Å—Ç–æ—è–Ω–∏—è –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—è</h3>
                <div className="grid grid-cols-2 md:grid-cols-5 gap-3 text-sm">
                    <div className="bg-green-100 text-green-800 p-2 rounded text-center">
                        <div className="font-medium">–í–µ–ª–∏–∫–æ–ª–µ–ø–Ω–æ</div>
                        <div className="text-xs">–ö–∞–∫ –Ω–æ–≤–æ–µ</div>
                    </div>
                    <div className="bg-blue-100 text-blue-800 p-2 rounded text-center">
                        <div className="font-medium">–û—Ç–ª–∏—á–Ω–æ</div>
                        <div className="text-xs">–ú–∏–Ω–∏–º–∞–ª—å–Ω—ã–π –∏–∑–Ω–æ—Å</div>
                    </div>
                    <div className="bg-yellow-100 text-yellow-800 p-2 rounded text-center">
                        <div className="font-medium">–•–æ—Ä–æ—à–æ</div>
                        <div className="text-xs">–ù–µ–±–æ–ª—å—à–∏–µ –ø–æ—Ç–µ—Ä—Ç–æ—Å—Ç–∏</div>
                    </div>
                    <div className="bg-orange-100 text-orange-800 p-2 rounded text-center">
                        <div className="font-medium">–£–¥–æ–≤–ª–µ—Ç–≤–æ—Ä–∏—Ç–µ–ª—å–Ω–æ</div>
                        <div className="text-xs">–ó–∞–º–µ—Ç–Ω—ã–π –∏–∑–Ω–æ—Å</div>
                    </div>
                    <div className="bg-red-100 text-red-800 p-2 rounded text-center">
                        <div className="font-medium">–¢—Ä–µ–±—É–µ—Ç —Ä–µ–º–æ–Ω—Ç–∞</div>
                        <div className="text-xs">–ù–µ —Å–¥–∞–µ—Ç—Å—è</div>
                    </div>
                </div>
            </div>

            {selectedEquipment && (
                <EquipmentEditDialog
                    open={showEditDialog}
                    onClose={handleCloseDialog}
                    equipment={selectedEquipment}
                />
            )}
        </div>
    );
}

```


## <a name="rentalappmainsrcpagesHomePagetsx"></a>`rental-app-main/src/pages/HomePage.tsx`

```tsx
// path: rental-app-main/src/pages/HomePage.tsx

// src/pages/HomePage.tsx

import { useEffect, useRef, useState, useMemo } from "react";
import { useNavigate, useLocation } from "react-router-dom";
import { useReserveStore } from "@/store/reserveStore";
import { X } from "lucide-react";

// –ö–æ–º–ø–æ–Ω–µ–Ω—Ç—ã
import AuthStatus from "@/components/AuthStatus";
import DateRangeSelector from "@/components/DateRangeSelector";
import DiscountCalculator from "@/components/DiscountCalculator";
import ReservationFooter from "@/components/ReservationFooter";
import EquipmentCatalog from "@/components/catalog/EquipmentCatalog";
import UserSession from "@/components/session/UserSession";
import { Button } from "@/components/ui/button";

// –•—É–∫–∏
import { useReservationManagement } from "@/hooks/useReservationManagement";
import { useDateStore } from "@/store/dateStore";
import { useHolidayStore } from "@/store/holidayStore";
import { useEquipmentData } from "@/hooks/data/useEquipmentData";
import { useAppFilters } from "@/hooks/features/useAppFilters";

export default function HomePage() {
    const navigate = useNavigate();
    const location = useLocation();
    const containerRef = useRef<HTMLDivElement>(null);
    const { clearItemsOnly, items: selectedItems = [] } = useReserveStore();
    
    // –ü–æ–ª—É—á–∞–µ–º –Ω—É–∂–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –∏ —Ñ—É–Ω–∫—Ü–∏–∏ –∏–∑ —Ö—Ä–∞–Ω–∏–ª–∏—â
    const { setRange, initializeDates } = useDateStore();
    const { holidays, fetchHolidays } = useHolidayStore();
    const [datesInitialized, setDatesInitialized] = useState(false);

    // –ü–æ–ª—É—á–∞–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ —Ñ–∏–ª—å—Ç—Ä–æ–≤ –¥–ª—è –ø–µ—Ä–µ–¥–∞—á–∏ –≤ EquipmentCatalog
    const { query, type, brand, availableOnly, associationId, startDate, endDate } = useAppFilters();

    // –ü–æ–ª—É—á–∞–µ–º –¥–∞–Ω–Ω—ã–µ –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—è –¥–ª—è useReservationManagement
    const {
        equipment,
        availabilityData,
    } = useEquipmentData({ query, type, brand, associationId, availableOnly, startDate, endDate });

    // –°–æ–∑–¥–∞–µ–º availabilityMap –∏–∑ availabilityData –¥–ª—è useReservationManagement
    const availabilityMap = useMemo(() => {
        const map: Record<number, any> = {};
        availabilityData?.forEach((info) => {
            map[info.equipment_id] = info;
        });
        return map;
    }, [availabilityData]);

    // –ü–æ–ª—É—á–∞–µ–º –ª–æ–≥–∏–∫—É —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è —Ä–µ–∑–µ—Ä–≤–∞–º–∏
    const {
        editingReservationId,
        intent,
    } = useReservationManagement(equipment, availabilityMap, availableOnly);

    // +++ –ù–ê–ß–ê–õ–û: –î–û–ë–ê–í–õ–ï–ù–ê –õ–û–ì–ò–ö–ê –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–ò –î–ê–¢ +++
    // 1. –ó–∞–≥—Ä—É–∂–∞–µ–º –≤—ã—Ö–æ–¥–Ω—ã–µ –ø—Ä–∏ –º–æ–Ω—Ç–∏—Ä–æ–≤–∞–Ω–∏–∏ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–∞
    useEffect(() => {
        const today = new Date();
        const futureDate = new Date();
        futureDate.setDate(today.getDate() + 30); // –ó–∞–≥—Ä—É–∂–∞–µ–º –Ω–∞ 30 –¥–Ω–µ–π –≤–ø–µ—Ä–µ–¥
        fetchHolidays(today, futureDate);
    }, [fetchHolidays]);

    // 2. –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –¥–∞—Ç—ã, –∫–∞–∫ —Ç–æ–ª—å–∫–æ –≤—ã—Ö–æ–¥–Ω—ã–µ –∑–∞–≥—Ä—É–∂–µ–Ω—ã
    useEffect(() => {
        // –í—ã–ø–æ–ª–Ω—è–µ–º —Ç–æ–ª—å–∫–æ –æ–¥–∏–Ω —Ä–∞–∑, –∫–æ–≥–¥–∞ –ø–æ—è–≤–∏–ª–∏—Å—å –¥–∞–Ω–Ω—ã–µ –æ –≤—ã—Ö–æ–¥–Ω—ã—Ö
        if (holidays.length > 0 && !datesInitialized) {
            initializeDates(holidays);
            setDatesInitialized(true);
        }
    }, [holidays, initializeDates, datesInitialized]);
    // +++ –ö–û–ù–ï–¶ +++

    // –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –¥–∞—Ç –∏–∑ —Å–æ—Å—Ç–æ—è–Ω–∏—è –Ω–∞–≤–∏–≥–∞—Ü–∏–∏
    useEffect(() => {
        const start = (location.state as any)?.startDate;
        const end = (location.state as any)?.endDate;
        if (start && end) {
            const startDate = new Date(start);
            const endDate = new Date(end);
            setRange(startDate, endDate, 'manual', holidays); // –ü–µ—Ä–µ–¥–∞–µ–º –ø—Ä–∞–∑–¥–Ω–∏–∫–∏ –¥–ª—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–≥–æ —Ä–∞—Å—á–µ—Ç–∞
        }
    }, [location.state, setRange, holidays]);

    const handleCompleteAddition = () => {
        const { addToReservationMode } = useReserveStore.getState();
        if (addToReservationMode) {
            navigate(location.state?.from || "/reservations/my", {
                replace: true,
                state: {
                    continueEditing: addToReservationMode,
                },
            });
        } else {
            navigate("/reserve/create");
        }
    };

    const handleCancelAddition = () => {
        useReserveStore.getState().clear();
        navigate("/reservations/my", {
            replace: true,
            state: {
                continueEditing: editingReservationId,
            },
        });
    };

    return (
        <div className="bg-gray-50 min-h-screen">
            <div ref={containerRef} className="max-w-7xl mx-auto px-4 py-6 space-y-4 pb-20">
                <AuthStatus />
                <UserSession />

                {editingReservationId && (
                    <div className="flex items-center justify-between p-3 bg-sky-100 border border-sky-300 text-sky-700 rounded-md text-sm shadow">
                        <span>
                            –í—ã –¥–æ–±–∞–≤–ª—è–µ—Ç–µ –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏–µ –∫ —Ä–µ–∑–µ—Ä–≤—É <strong>#{editingReservationId}</strong>. –ö–æ–≥–¥–∞ –∑–∞–∫–æ–Ω—á–∏—Ç–µ, –Ω–∞–∂–º–∏—Ç–µ –∫–Ω–æ–ø–∫—É –≤–Ω–∏–∑—É —Å—Ç—Ä–∞–Ω–∏—Ü—ã.
                        </span>
                        <Button
                            variant="ghost"
                            size="sm"
                            onClick={handleCancelAddition}
                            className="text-sky-700 hover:bg-sky-200 hover:text-sky-800 flex-shrink-0"
                        >
                            <X className="w-4 h-4 mr-1.5" />
                            –û—Ç–º–µ–Ω–∏—Ç—å –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ
                        </Button>
                    </div>
                )}

                <h1 className="text-2xl font-bold mt-4 text-center">–ö–∞—Ç–∞–ª–æ–≥ –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—è</h1>

                <DateRangeSelector containerRef={containerRef} />
                <DiscountCalculator />

                <EquipmentCatalog 
                    editingReservationId={editingReservationId}
                    intent={intent}
                />
            </div>

            <ReservationFooter
                selectedCount={selectedItems.length}
                onClick={handleCompleteAddition}
                onReset={clearItemsOnly}
                isEditingMode={!!editingReservationId}
                intent={intent || ''}
            />
        </div>
    );
}

```


## <a name="rentalappmainsrcpagesMyReservationsPagetsx"></a>`rental-app-main/src/pages/MyReservationsPage.tsx`

```tsx
// path: rental-app-main/src/pages/MyReservationsPage.tsx

// src/pages/MyReservationsPage.tsx
import { useState, useEffect, useMemo } from "react";
import { useNavigate, useLocation } from "react-router-dom";
import { Button } from "@/components/ui/button";
import { ToggleGroup, ToggleGroupItem } from "@/components/ui/toggle-group";
import MyReservationList from "../components/MyReservationList";
import { useCurrentUser } from "@/hooks/useProfile";
import UserInfoBlock from "@/components/UserInfoBlock";
import { useMyRentals } from "@/hooks/useMyRentals";
import MyRentalsList from "@/components/rental/MyRentalsList";
import { ClipboardList, Truck } from "lucide-react";
import OrderToolbar from "@/components/shared/OrderToolbar";
import { useOrderFilterStore } from "@/store/orderFilterStore";
import { useReservations } from "@/hooks/useReservations";

interface MyReservationsLocationState {
    from?: string;
    continueEditing?: number;
    highlightRentalId?: number;
    highlightReservationId?: number;
}

export default function MyReservationsPage() {
    const { data: user, isLoading } = useCurrentUser();
    const navigate = useNavigate();
    const location = useLocation();

    const [activeTab, setActiveTab] = useState<'reservations' | 'rentals'>('reservations');
    const [highlightId, setHighlightId] = useState<number | null>(null);

    const locationState = location.state as MyReservationsLocationState | null;

    const cameFrom = locationState?.from;
    const continueEditingReservationId = locationState?.continueEditing;

    // –ü–æ–ª—É—á–∞–µ–º –ø–∞—Ä–∞–º–µ—Ç—Ä—ã —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏ –∏–∑ —Å—Ç–æ—Ä–∞
    const { searchQuery, statusFilter, sortOption } = useOrderFilterStore();

    // –û–ø—Ä–µ–¥–µ–ª—è–µ–º –∫–æ–Ω—Ç–µ–∫—Å—Ç –¥–ª—è OrderToolbar
    const toolbarContext = useMemo(() => {
        return activeTab === 'reservations' ? 'user-reservations' : 'user-rentals';
    }, [activeTab]);

    // –ü–æ–¥–≥–æ—Ç–∞–≤–ª–∏–≤–∞–µ–º –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –¥–ª—è API –∑–∞–ø—Ä–æ—Å–æ–≤
    const apiParams = useMemo(() => ({
        search: searchQuery || undefined,
        status: statusFilter === 'all' ? undefined : statusFilter,
        sort: sortOption
    }), [searchQuery, statusFilter, sortOption]);

    // –ü–æ–ª—É—á–∞–µ–º –¥–∞–Ω–Ω—ã–µ —Å —Å–µ—Ä–≤–µ—Ä–Ω–æ–π —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–µ–π
    const { reservationsQuery } = useReservations(apiParams);
    const { data: rentalsData } = useMyRentals(apiParams);

    useEffect(() => {
        const { highlightRentalId, highlightReservationId } = locationState || {};
        if (highlightRentalId) {
            setActiveTab('rentals');
            setHighlightId(highlightRentalId);
        } else if (highlightReservationId) {
            setActiveTab('reservations');
            setHighlightId(highlightReservationId);
        }
    }, [locationState]);

    useEffect(() => {
        // –°–±—Ä–æ—Å –ø–æ–¥—Å–≤–µ—Ç–∫–∏ —á–µ—Ä–µ–∑ –Ω–µ–∫–æ—Ç–æ—Ä–æ–µ –≤—Ä–µ–º—è
        if (highlightId) {
            const timer = setTimeout(() => {
                setHighlightId(null);
                navigate(location.pathname, { replace: true, state: {} });
            }, 2500);
            return () => clearTimeout(timer);
        }
    }, [highlightId, navigate, location.pathname]);

    useEffect(() => {
        if (continueEditingReservationId) {
            console.log(`[MyReservationsPage] Processing return from equipment addition to reservation #${continueEditingReservationId}`);
        }
    }, [continueEditingReservationId]);

    if (isLoading) {
        return (
            <p className="text-center mt-12 text-sm text-gray-500">
                –ó–∞–≥—Ä—É–∑–∫–∞ –ø—Ä–æ—Ñ–∏–ª—è...
            </p>
        );
    }

    if (!user) {
        return (
            <div className="text-center mt-12">
                <p className="text-lg">
                    –¢–æ–ª—å–∫–æ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –º–æ–≥—É—Ç –ø—Ä–æ—Å–º–∞—Ç—Ä–∏–≤–∞—Ç—å —Å–≤–æ–∏ —Ä–µ–∑–µ—Ä–≤—ã.
                </p>
                <Button className="mt-4" onClick={() => navigate("/reserve/create")}>
                    –í–æ–π—Ç–∏ –∏ –æ—Ñ–æ—Ä–º–∏—Ç—å —Ä–µ–∑–µ—Ä–≤
                </Button>
            </div>
        );
    }

    const handleEditProfile = () => {
        navigate("/profile", { state: { from: location.pathname } });
    };

    return (
        <div className="max-w-4xl mx-auto px-4 py-6 space-y-6">
            <div className="mb-6">
                <UserInfoBlock onEditProfile={handleEditProfile} />
            </div>

            <div className="flex items-center justify-between">
                <h1 className="text-2xl font-bold">–ú–æ–∏ –∑–∞–∫–∞–∑—ã</h1>
                <div className="flex items-center gap-3">
                    <Button variant="secondary" onClick={() => navigate(cameFrom || "/")}>
                        ‚Üê –ù–∞–∑–∞–¥
                    </Button>
                    <Button variant="outline" onClick={() => navigate("/")}>
                        –ù–∞ –≥–ª–∞–≤–Ω—É—é
                    </Button>
                </div>
            </div>

            {/* –í–∫–ª–∞–¥–∫–∏ */}
            <ToggleGroup
                type="single"
                value={activeTab}
                onValueChange={(value) => { if (value) setActiveTab(value as any); }}
                className="w-full"
            >
                <ToggleGroupItem value="reservations" className="w-1/2 data-[state=on]:bg-sky-100 data-[state=on]:text-sky-800">
                    <ClipboardList className="w-4 h-4 mr-2" />
                    –†–µ–∑–µ—Ä–≤—ã
                </ToggleGroupItem>
                <ToggleGroupItem value="rentals" className="w-1/2 data-[state=on]:bg-orange-100 data-[state=on]:text-orange-800">
                    <Truck className="w-4 h-4 mr-2" />
                    –ê—Ä–µ–Ω–¥—ã
                </ToggleGroupItem>
            </ToggleGroup>

            {/* –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–∏ —Ä–µ–∑–µ—Ä–≤–∞ */}
            {continueEditingReservationId && activeTab === 'reservations' && (
                <div className="p-3 bg-sky-100 border border-sky-300 text-sky-700 rounded-md text-sm">
                    –í—ã –≤–µ—Ä–Ω—É–ª–∏—Å—å –∫ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—é —Ä–µ–∑–µ—Ä–≤–∞ #{continueEditingReservationId}. –í—ã–±—Ä–∞–Ω–Ω—ã–µ –ø–æ–∑–∏—Ü–∏–∏ –¥–æ–±–∞–≤–ª–µ–Ω—ã.
                </div>
            )}

            {/* –¢—É–ª–±–∞—Ä —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏ */}
            <OrderToolbar context={toolbarContext} showHideCompletedCheckbox={true} />

            {/* –£—Å–ª–æ–≤–Ω—ã–π —Ä–µ–Ω–¥–µ—Ä–∏–Ω–≥ —Å–ø–∏—Å–∫–æ–≤ */}
            <div>
                {activeTab === 'reservations' ? (
                    <MyReservationList
                        continueEditingReservationId={continueEditingReservationId}
                        highlightId={highlightId}
                        reservationsData={reservationsQuery.data}
                        isLoading={reservationsQuery.isLoading}
                        isError={reservationsQuery.isError}
                    />
                ) : (
                    <MyRentalsList 
                        highlightId={highlightId}
                        rentalsData={rentalsData}
                    />
                )}
            </div>
        </div>
    );
}

```


## <a name="rentalappmainsrcpagesProfilePagetsx"></a>`rental-app-main/src/pages/ProfilePage.tsx`

```tsx
// path: rental-app-main/src/pages/ProfilePage.tsx

// src/pages/ProfilePage.tsx

import { useState, useEffect } from "react"
import { Input } from "@/components/ui/input"
import { Label } from "@/components/ui/label"
import { Button } from "@/components/ui/button"
import { useNavigate, useLocation } from "react-router-dom"
import { useProfileUpdate, useCurrentUser } from "@/hooks/useProfile"
import { useAuthStore } from "@/store/authStore"
import { toast } from "sonner"
import { PhoneInput } from "@/components/ui/phone-input"
import { Alert, AlertDescription } from "@/components/ui/alert"
import { AlertCircle, CheckCircle } from "lucide-react"
// ‚úÖ 1. –ò–º–ø–æ—Ä—Ç–∏—Ä—É–µ–º –Ω–∞—à –Ω–æ–≤—ã–π –∫–æ–º–ø–æ–Ω–µ–Ω—Ç –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –∏—Å—Ç–æ—Ä–∏–∏
import BalanceHistoryTable from "@/components/profile/BalanceHistoryTable";

// –§—É–Ω–∫—Ü–∏—è –≤–∞–ª–∏–¥–∞—Ü–∏–∏ —Ç–µ–ª–µ—Ñ–æ–Ω–∞
const validatePhone = (phone: string): boolean => {
    if (!phone) return true; // –ü—É—Å—Ç–æ–π —Ç–µ–ª–µ—Ñ–æ–Ω —Ä–∞–∑—Ä–µ—à–µ–Ω
    return /^\+7 \(\d{3}\) \d{3}-\d{2}-\d{2}$/.test(phone);
};

export default function ProfilePage() {
    const navigate = useNavigate()
    const location = useLocation()
    const { logout } = useAuthStore()

    const backTo = location.state?.from || "/"

    const { data: user, isLoading } = useCurrentUser()
    const updateProfile = useProfileUpdate()

    const [fullName, setFullName] = useState("")
    const [email, setEmail] = useState("")
    const [phone, setPhone] = useState("")
    const [emailChanged, setEmailChanged] = useState(false)
    const [originalEmail, setOriginalEmail] = useState("")
    const [showEmailWarning, setShowEmailWarning] = useState(false)

    useEffect(() => {
        if (user) {
            setFullName(user.full_name)
            setEmail(user.email)
            setPhone(user.phone || "")
            setOriginalEmail(user.email)
        }
    }, [user])

    // –û—Ç—Å–ª–µ–∂–∏–≤–∞–µ–º –∏–∑–º–µ–Ω–µ–Ω–∏—è email
    useEffect(() => {
        if (originalEmail && email !== originalEmail) {
            setEmailChanged(true)
            setShowEmailWarning(true)
        } else {
            setEmailChanged(false)
            setShowEmailWarning(false)
        }
    }, [email, originalEmail])

    const handleUpdate = async (e: React.FormEvent) => {
        e.preventDefault()

        // –í–∞–ª–∏–¥–∞—Ü–∏—è —Ç–µ–ª–µ—Ñ–æ–Ω–∞
        if (!validatePhone(phone)) {
            toast.error("–ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç –Ω–æ–º–µ—Ä–∞ —Ç–µ–ª–µ—Ñ–æ–Ω–∞")
            return
        }

        try {
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –∏–∑–º–µ–Ω–∏–ª—Å—è –ª–∏ email
            const emailChanged = user && email !== user.email;

            await updateProfile.mutateAsync({ full_name: fullName, email, phone }) // <<< –ò–ó–ú–ï–ù–ï–ù–ò–ï: –ü–µ—Ä–µ–¥–∞–µ–º —Ç–µ–ª–µ—Ñ–æ–Ω
            toast.success("–ü—Ä–æ—Ñ–∏–ª—å —É—Å–ø–µ—à–Ω–æ –æ–±–Ω–æ–≤–ª—ë–Ω")

            // <<< –ò–ó–ú–ï–ù–ï–ù–ò–ï: –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ-–∑–∞–≥–ª—É—à–∫—É, –µ—Å–ª–∏ email –±—ã–ª –∏–∑–º–µ–Ω–µ–Ω
            if (emailChanged) {
                toast.info("–ù–∞ –≤–∞—à—É –Ω–æ–≤—É—é –ø–æ—á—Ç—É –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∞ —Å—Å—ã–ª–∫–∞ –¥–ª—è –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è (—Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª –≤ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ).")
                // –í –±—É–¥—É—â–µ–º –∑–¥–µ—Å—å –º–æ–∂–Ω–æ –±—É–¥–µ—Ç —Å–±—Ä–æ—Å–∏—Ç—å email –≤ —Ñ–æ—Ä–º–µ –æ–±—Ä–∞—Ç–Ω–æ –Ω–∞ —Å—Ç–∞—Ä—ã–π,
                // –ø–æ–∫–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –ø–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç –Ω–æ–≤—ã–π.
            }

        } catch (err) {
            console.error(err)
            toast.error("–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ –ø—Ä–æ—Ñ–∏–ª—è")
        }
    }

    if (isLoading) {
        return <p className="text-center mt-12 text-gray-500">–ó–∞–≥—Ä—É–∑–∫–∞...</p>
    }

    if (!user) {
        return (
            <div className="text-center mt-12">
                <p className="text-lg">–í—ã –Ω–µ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω—ã.</p>
                <Button className="mt-4" onClick={() => navigate("/")}>
                    –ù–∞ –≥–ª–∞–≤–Ω—É—é
                </Button>
            </div>
        )
    }

    return (
        // ‚úÖ 2. –£–≤–µ–ª–∏—á–∏–≤–∞–µ–º –º–∞–∫—Å–∏–º–∞–ª—å–Ω—É—é —à–∏—Ä–∏–Ω—É –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞, —á—Ç–æ–±—ã —Ç–∞–±–ª–∏—Ü–∞ –ø–æ–º–µ—Å—Ç–∏–ª–∞—Å—å
        <div className="max-w-4xl mx-auto px-4 py-8 space-y-6">
            <div className="bg-white border rounded-lg shadow-sm p-6 space-y-4">
                <h1 className="text-xl font-bold text-center">–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –ø—Ä–æ—Ñ–∏–ª—å</h1>

                <form onSubmit={handleUpdate} className="space-y-4">
                    <div>
                        <Label htmlFor="fullName">–§–ò–û</Label>
                        <Input
                            id="fullName"
                            type="text"
                            value={fullName}
                            onChange={(e) => setFullName(e.target.value)}
                            required
                        />
                    </div>

                    <div>
                        <Label htmlFor="email">Email</Label>
                        <Input
                            id="email"
                            type="email"
                            value={email}
                            onChange={(e) => setEmail(e.target.value)}
                            required
                        />
                    </div>

                    {/* +++ –ù–ê–ß–ê–õ–û: –ù–æ–≤–æ–µ –ø–æ–ª–µ –¥–ª—è —Ç–µ–ª–µ—Ñ–æ–Ω–∞ +++ */}
                    <div>
                        <Label htmlFor="phone">–¢–µ–ª–µ—Ñ–æ–Ω</Label>
                        <PhoneInput
                            id="phone"
                            value={phone}
                            onChange={(e) => setPhone(e.target.value)}
                            placeholder="+7 (___) ___-__-__"
                        />
                    </div>
                    {/* +++ –ö–û–ù–ï–¶: –ù–æ–≤–æ–µ –ø–æ–ª–µ –¥–ª—è —Ç–µ–ª–µ—Ñ–æ–Ω–∞ +++ */}

                    {showEmailWarning && (
                        <Alert>
                            <AlertCircle className="h-4 w-4" />
                            <AlertDescription>
                                –ü–æ—Å–ª–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è email –ø–æ—Ç—Ä–µ–±—É–µ—Ç—Å—è –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –Ω–æ–≤–æ–≥–æ –∞–¥—Ä–µ—Å–∞.
                                –ù–∞ —É–∫–∞–∑–∞–Ω–Ω—É—é –ø–æ—á—Ç—É –±—É–¥–µ—Ç –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∞ —Å—Å—ã–ª–∫–∞ –¥–ª—è –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è.
                            </AlertDescription>
                        </Alert>
                    )}

                    <div className="flex justify-between items-center pt-2">
                        <Button type="submit" disabled={updateProfile.isPending}>
                            {updateProfile.isPending ? "–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ..." : "–°–æ—Ö—Ä–∞–Ω–∏—Ç—å"}
                        </Button>
                        <Button type="button" variant="ghost" onClick={() => navigate(backTo)}>
                            –ù–∞–∑–∞–¥
                        </Button>
                    </div>
                </form>

                <div className="pt-4 border-t text-center space-y-2">
                    <p className="text-xs text-gray-500">
                        –î–ª—è –∏–∑–º–µ–Ω–µ–Ω–∏—è –ø–∞—Ä–æ–ª—è –æ–±—Ä–∞—Ç–∏—Ç–µ—Å—å –∫ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—É.
                    </p>
                    <Button
                        variant="link"
                        className="text-red-600"
                        onClick={() => {
                            logout()
                            navigate("/")
                        }}
                    >
                        –í—ã–π—Ç–∏ –∏–∑ –∞–∫–∫–∞—É–Ω—Ç–∞
                    </Button>
                </div>
            </div>

            {/* ‚úÖ 3. –î–æ–±–∞–≤–ª—è–µ–º –Ω–æ–≤—ã–π –±–ª–æ–∫ —Å –∏—Å—Ç–æ—Ä–∏–µ–π –±–∞–ª–∞–Ω—Å–∞ */}
            <div className="bg-white border rounded-lg shadow-sm p-6 space-y-4">
                <h2 className="text-xl font-bold">–ò—Å—Ç–æ—Ä–∏—è –±–∞–ª–∞–Ω—Å–∞</h2>
                <BalanceHistoryTable userId={user.id} />
            </div>
        </div>
    )
}

```


## <a name="rentalappmainsrcpagesReservePagetsx"></a>`rental-app-main/src/pages/ReservePage.tsx`

```tsx
// path: rental-app-main/src/pages/ReservePage.tsx

// src/pages/ReservePage.tsx
import { useNavigate, useLocation } from "react-router-dom";
import { useState, useMemo } from "react";
import AuthForm from "@/components/AuthForm";
import UserInfoBlock from "@/components/UserInfoBlock";
import CancelReservationDialog from "@/components/CancelReservationDialog";
import { Button } from "@/components/ui/button";
import { useReserveSubmission } from "@/hooks/reservation/submission/useReserveSubmission";
import { formatDate } from "@/lib/utils";
import { ShoppingCart } from "lucide-react";

import ReservationItemsList from "@/components/reservation/ReservationItemsList";
import FinancialSummaryBlock from "@/components/shared/FinancialSummaryBlock";

export default function ReservePage() {
    const navigate = useNavigate();
    const location = useLocation();

    const {
        items,
        user,
        startDate,
        endDate,
        setStartDate,
        setEndDate,
        availabilityMap,
        unavailableIdsFromAPI,
        invalidItems,
        submitMessage,
        reservationSuccess,
        clearReserveStore,
        removeItemFromStore,
        isAccessorySelected,
        toggleAccessory,
        isLoadingAvailability,
        isSubmitting,
        isApplyingPromoCode,
        priceDetails,
        accessoriesDailyTotal,
        promoCode,
        promoCodeMessage,
        applyPromoCode,
        setPromoCode,
        removePromoCode,
        handleSubmit,
        selectedAccessories,
    } = useReserveSubmission();

    const [showCancelDialog, setShowCancelDialog] = useState(false);

    const handleConfirmCancel = () => {
        clearReserveStore();
        navigate("/");
    };

    const isFormValid = useMemo(() => {
        return !!(user && invalidItems.length === 0 && unavailableIdsFromAPI.length === 0);
    }, [user, invalidItems.length, unavailableIdsFromAPI.length]);

    // ‚úÖ –î–û–ë–ê–í–õ–ï–ù–û: –†–∞—Å—á–µ—Ç –º–∏–Ω–∏–º–∞–ª—å–Ω–æ–π –¥–∞—Ç—ã –¥–ª—è –ø–æ–ª—è "–ö–æ–Ω–µ—Ü"
    const minEndDate = useMemo(() => {
        const nextDay = new Date(startDate);
        nextDay.setDate(startDate.getDate() + 1);
        return formatDate(nextDay);
    }, [startDate]);

    if (items.length === 0 && !reservationSuccess) {
        return (
            <div className="text-center mt-12 p-4">
                <ShoppingCart className="mx-auto h-16 w-16 text-gray-300" />
                <p className="mt-4 text-lg text-gray-700">–í–∞—à–∞ –∫–æ—Ä–∑–∏–Ω–∞ –ø—É—Å—Ç–∞.</p>
                <p className="mt-1 text-sm text-gray-500">–í—ã –µ—â–µ –Ω–µ –≤—ã–±—Ä–∞–ª–∏ –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏–µ –¥–ª—è —Ä–µ–∑–µ—Ä–≤–∞.</p>
                <Button
                    variant="default"
                    className="mt-6"
                    onClick={() => navigate("/", { state: { intent: "add_to_new_reservation" } })}
                >
                    –ü–µ—Ä–µ–π—Ç–∏ –∫ –≤—ã–±–æ—Ä—É –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—è
                </Button>
            </div>
        );
    }

    if (reservationSuccess) {
        return (
            <div className="text-center pt-8 space-y-4 p-6 bg-green-50 rounded-lg border border-green-200 max-w-3xl mx-auto">
                <p className="text-xl font-semibold text-green-700">‚úÖ –†–µ–∑–µ—Ä–≤ —É—Å–ø–µ—à–Ω–æ —Å–æ–∑–¥–∞–Ω!</p>
                {submitMessage && (<p className="text-sm text-green-600">{submitMessage}</p>)}
                <div className="flex gap-3 justify-center">
                    <Button variant="outline" onClick={() => navigate("/")}>–ù–∞ –≥–ª–∞–≤–Ω—É—é</Button>
                    <Button variant="default" onClick={() => navigate("/reservations/my")}>–ö –º–æ–∏–º —Ä–µ–∑–µ—Ä–≤–∞–º</Button>
                </div>
            </div>
        );
    }

    return (
        <>
            <div className="max-w-3xl mx-auto px-4 py-6 space-y-6">
                <div className="flex items-center justify-between">
                    <h1 className="text-2xl font-bold">–û—Ñ–æ—Ä–º–ª–µ–Ω–∏–µ —Ä–µ–∑–µ—Ä–≤–∞</h1>
                    <button
                        onClick={() => navigate("/", { state: { intent: "add_to_new_reservation" } })}
                        className="text-sm text-sky-600 hover:underline"
                    >
                        ‚Üê –í–µ—Ä–Ω—É—Ç—å—Å—è –∫ –≤—ã–±–æ—Ä—É
                    </button>
                </div>

                {!user ? <AuthForm /> : <UserInfoBlock onEditProfile={() => navigate("/profile", { state: { from: location.pathname } })} />}

                <div className="p-4 border rounded-md shadow-sm bg-white">
                    <h2 className="text-lg font-semibold mb-3 text-gray-700">–î–∞—Ç—ã —Ä–µ–∑–µ—Ä–≤–∞:</h2>
                    <div className="flex flex-col sm:flex-row justify-center items-center gap-4">
                        <div className="flex flex-col items-start w-full sm:w-auto">
                            <label htmlFor="start-date" className="text-sm text-gray-600 mb-1">–ù–∞—á–∞–ª–æ:</label>
                            <input id="start-date" type="date" className="border rounded px-3 py-1 text-sm shadow-sm w-full focus:ring-sky-500 focus:border-sky-500"
                                   value={formatDate(startDate)}
                                   onChange={(e) => { const d = new Date(e.target.value); if(!isNaN(d.getTime())) setStartDate(d); }}
                                   min={formatDate(new Date())} />
                        </div>
                        <div className="flex flex-col items-start w-full sm:w-auto">
                            <label htmlFor="end-date" className="text-sm text-gray-600 mb-1">–ö–æ–Ω–µ—Ü:</label>
                            <input id="end-date" type="date" className="border rounded px-3 py-1 text-sm shadow-sm w-full focus:ring-sky-500 focus:border-sky-500"
                                   value={formatDate(endDate)}
                                   onChange={(e) => { const d = new Date(e.target.value); if(!isNaN(d.getTime())) setEndDate(d); }}
                                // ‚úÖ –ò–ó–ú–ï–ù–ï–ù–ò–ï: –£—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ –º–∏–Ω–∏–º–∞–ª—å–Ω–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ –¥–ª—è –ø–æ–ª—è
                                   min={minEndDate} />
                        </div>
                    </div>
                </div>

                {isLoadingAvailability && <p className="text-center text-gray-500 py-3">–ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏...</p>}

                <ReservationItemsList
                    items={items}
                    selectedAccessories={selectedAccessories}
                    availabilityMap={availabilityMap}
                    unavailableIdsFromAPI={unavailableIdsFromAPI}
                    invalidItems={invalidItems}
                    onRemoveItem={removeItemFromStore}
                    onRemoveAccessory={toggleAccessory}
                    isAccessorySelected={isAccessorySelected}
                    onToggleAccessory={toggleAccessory}
                />

                <FinancialSummaryBlock
                    priceDetails={priceDetails}
                    accessoriesDailyTotal={accessoriesDailyTotal}
                    promoCode={promoCode}
                    setPromoCode={setPromoCode}
                    applyPromoCode={applyPromoCode}
                    removePromoCode={removePromoCode}
                    promoCodeMessage={promoCodeMessage}
                    isLoading={isLoadingAvailability}
                    isApplyingPromoCode={isApplyingPromoCode}
                    isSubmitting={isSubmitting}
                    isFormValid={isFormValid}
                    onCancel={() => setShowCancelDialog(true)}
                    onAddMore={() => navigate("/", { state: { intent: "add_to_new_reservation" } })}
                    onSubmit={handleSubmit}
                    variant="default"
                    showActions={true}
                />
            </div>

            <CancelReservationDialog
                open={showCancelDialog}
                onClose={() => setShowCancelDialog(false)}
                onConfirm={handleConfirmCancel}
            />
        </>
    );
}

```


## <a name="rentalappmainsrcpagesUserManagementPagetsx"></a>`rental-app-main/src/pages/UserManagementPage.tsx`

```tsx
// path: rental-app-main/src/pages/UserManagementPage.tsx

// src/pages/UserManagementPage.tsx

import { useMemo } from "react";
import { useCurrentUser } from "@/hooks/useProfile";
import { useAdminUsers } from "@/hooks/useAdminUsers";
import AdminNavigation from "@/components/admin/AdminNavigation";
import UserTable from "@/components/admin/UserTable";
import { Button } from "@/components/ui/button";
import { Shield, Users } from "lucide-react";
import { useNavigate } from "react-router-dom";

export default function UserManagementPage() {
    const { data: currentUser } = useCurrentUser();
    const navigate = useNavigate();
    
    // –ü–æ–ª—É—á–∞–µ–º –¥–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π —Å –ø–∞–≥–∏–Ω–∞—Ü–∏–µ–π
    const {
        data: usersData,
        isLoading,
        error,
        fetchNextPage,
        hasNextPage,
        isFetchingNextPage,
    } = useAdminUsers();

    // –û–±—ä–µ–¥–∏–Ω—è–µ–º –≤—Å–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã –≤ –æ–¥–∏–Ω –º–∞—Å—Å–∏–≤ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
    const allUsers = useMemo(() => {
        if (!usersData?.pages) return [];
        return usersData.pages.flatMap(page => page.items);
    }, [usersData]);

    const isAdmin = currentUser?.role === "admin";
    const isManager = currentUser?.role === "manager" || isAdmin;

    // –ï—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –∏–º–µ–µ—Ç –ø—Ä–∞–≤ –¥–æ—Å—Ç—É–ø–∞
    if (!isManager) {
        return (
            <div className="max-w-4xl mx-auto px-4 py-8">
                <div className="text-center">
                    <Shield className="w-16 h-16 text-gray-400 mx-auto mb-4" />
                    <h1 className="text-2xl font-bold text-gray-900 mb-2">
                        –î–æ—Å—Ç—É–ø –æ–≥—Ä–∞–Ω–∏—á–µ–Ω
                    </h1>
                    <p className="text-gray-600 mb-4">
                        –£ –≤–∞—Å –Ω–µ—Ç –ø—Ä–∞–≤ –¥–ª—è –¥–æ—Å—Ç—É–ø–∞ –∫ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—é –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º–∏.
                    </p>
                    <Button onClick={() => navigate("/")}>
                        –ù–∞ –≥–ª–∞–≤–Ω—É—é
                    </Button>
                </div>
            </div>
        );
    }

    return (
        <div className="max-w-7xl mx-auto px-4 py-6 space-y-6">
            <AdminNavigation />

            {/* –ó–∞–≥–æ–ª–æ–≤–æ–∫ —Å—Ç—Ä–∞–Ω–∏—Ü—ã */}
            <div className="flex items-center justify-between">
                <div className="flex items-center gap-3">
                    <Users className="w-8 h-8 text-blue-600" />
                    <div>
                        <h1 className="text-3xl font-bold text-gray-900">
                            –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º–∏
                        </h1>
                        <p className="text-gray-600 mt-1">
                            {isAdmin
                                ? "–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —É—á–µ—Ç–Ω—ã–º–∏ –∑–∞–ø–∏—Å—è–º–∏, —Ä–æ–ª—è–º–∏ –∏ –ø—Ä–∞–≤–∞–º–∏ –¥–æ—Å—Ç—É–ø–∞"
                                : "–ü—Ä–æ—Å–º–æ—Ç—Ä –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π —Å–∏—Å—Ç–µ–º—ã"
                            }
                        </p>
                    </div>
                </div>
            </div>

            {/* –û—Å–Ω–æ–≤–Ω–æ–π –∫–æ–Ω—Ç–µ–Ω—Ç */}
            <div className="bg-white rounded-lg border shadow-sm p-6">
                <UserTable 
                    users={allUsers}
                    isLoading={isLoading}
                    error={error}
                    onLoadMore={fetchNextPage}
                    hasNextPage={hasNextPage}
                    isFetchingNextPage={isFetchingNextPage}
                />
            </div>

            {/* –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –¥–ª—è –º–µ–Ω–µ–¥–∂–µ—Ä–æ–≤ */}
            {!isAdmin && (
                <div className="bg-amber-50 border border-amber-200 rounded-lg p-4">
                    <div className="flex items-start gap-3">
                        <Shield className="w-5 h-5 text-amber-600 mt-0.5" />
                        <div className="text-sm">
                            <p className="font-medium text-amber-800 mb-1">
                                –û–≥—Ä–∞–Ω–∏—á–µ–Ω–Ω—ã–π –¥–æ—Å—Ç—É–ø
                            </p>
                            <p className="text-amber-700">
                                –ö–∞–∫ –º–µ–Ω–µ–¥–∂–µ—Ä, –≤—ã –º–æ–∂–µ—Ç–µ –ø—Ä–æ—Å–º–∞—Ç—Ä–∏–≤–∞—Ç—å —Å–ø–∏—Å–æ–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π, –Ω–æ –Ω–µ –º–æ–∂–µ—Ç–µ:
                            </p>
                            <ul className="list-disc list-inside mt-2 text-amber-700 space-y-1">
                                <li>–ò–∑–º–µ–Ω—è—Ç—å —Ä–æ–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π</li>
                                <li>–ë–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å –∏–ª–∏ —Ä–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π</li>
                                <li>–£–¥–∞–ª—è—Ç—å —É—á–µ—Ç–Ω—ã–µ –∑–∞–ø–∏—Å–∏</li>
                            </ul>
                            <p className="text-amber-700 mt-2">
                                –î–ª—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è —ç—Ç–∏—Ö –¥–µ–π—Å—Ç–≤–∏–π –æ–±—Ä–∞—Ç–∏—Ç–µ—Å—å –∫ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—É.
                            </p>
                        </div>
                    </div>
                </div>
            )}

            {/* –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —Ä–æ–ª—è—Ö */}
            <div className="bg-gray-50 rounded-lg p-4">
                <h3 className="font-semibold text-gray-900 mb-3">–û–ø–∏—Å–∞–Ω–∏–µ —Ä–æ–ª–µ–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π</h3>
                <div className="grid grid-cols-1 md:grid-cols-3 gap-4 text-sm">
                    <div className="bg-white p-3 rounded border">
                        <div className="font-medium text-gray-900 mb-2">üë§ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å</div>
                        <ul className="text-gray-600 space-y-1">
                            <li>‚Ä¢ –ü—Ä–æ—Å–º–æ—Ç—Ä –∫–∞—Ç–∞–ª–æ–≥–∞ –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—è</li>
                            <li>‚Ä¢ –°–æ–∑–¥–∞–Ω–∏–µ –∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Å–≤–æ–∏–º–∏ —Ä–µ–∑–µ—Ä–≤–∞–º–∏</li>
                            <li>‚Ä¢ –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–æ–±—Å—Ç–≤–µ–Ω–Ω–æ–≥–æ –ø—Ä–æ—Ñ–∏–ª—è</li>
                        </ul>
                    </div>
                    <div className="bg-white p-3 rounded border">
                        <div className="font-medium text-blue-900 mb-2">üõ°Ô∏è –ú–µ–Ω–µ–¥–∂–µ—Ä</div>
                        <ul className="text-gray-600 space-y-1">
                            <li>‚Ä¢ –í—Å–µ –ø—Ä–∞–≤–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è</li>
                            <li>‚Ä¢ –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏–µ–º</li>
                            <li>‚Ä¢ –ü—Ä–æ—Å–º–æ—Ç—Ä –≤—Å–µ—Ö —Ä–µ–∑–µ—Ä–≤–æ–≤</li>
                            <li>‚Ä¢ –ü—Ä–æ—Å–º–æ—Ç—Ä —Å–ø–∏—Å–∫–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π</li>
                        </ul>
                    </div>
                    <div className="bg-white p-3 rounded border">
                        <div className="font-medium text-red-900 mb-2">üëë –ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä</div>
                        <ul className="text-gray-600 space-y-1">
                            <li>‚Ä¢ –í—Å–µ –ø—Ä–∞–≤–∞ –º–µ–Ω–µ–¥–∂–µ—Ä–∞</li>
                            <li>‚Ä¢ –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º–∏</li>
                            <li>‚Ä¢ –ò–∑–º–µ–Ω–µ–Ω–∏–µ —Ä–æ–ª–µ–π</li>
                            <li>‚Ä¢ –ë–ª–æ–∫–∏—Ä–æ–≤–∫–∞ –∏ —É–¥–∞–ª–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π</li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    );
}

```


## <a name="rentalappmainsrcpagesadminAllReservationsManagementPagetsx"></a>`rental-app-main/src/pages/admin/AllReservationsManagementPage.tsx`

```tsx
// path: rental-app-main/src/pages/admin/AllReservationsManagementPage.tsx

// src/pages/admin/AllReservationsManagementPage.tsx

import { useState, useMemo, useEffect } from "react";
import { useLocation, useNavigate } from "react-router-dom";
import AdminNavigation from "@/components/admin/AdminNavigation";
import { useAdminReservations, useBulkDeleteAdminReservations } from "@/hooks/useAdminReservations";
import { Button } from "@/components/ui/button";
import { ClipboardList, Plus, Loader2, ClipboardX } from "lucide-react";
import AllReservationsList from "@/components/admin/AllReservationsList";
import CreateReservationDialog from "@/components/admin/CreateReservationDialog";
import ConvertReservationDialog from "@/components/admin/ConvertReservationDialog";
import type { AdminReservationOut } from "@/types/reservation";
import { useAllEquipment } from "@/hooks/useAllEquipment";
import { useAdminReservationSelectionStore } from "@/store/adminReservationSelectionStore";
import { AdminReservationToolbar } from "@/components/admin/AdminReservationToolbar";
import { ConfirmationDialog } from "@/components/ui/confirmation-dialog";
import OrderToolbar from "@/components/shared/OrderToolbar";
import { useOrderFilterStore } from "@/store/orderFilterStore";

export default function AllReservationsManagementPage() {
    const location = useLocation();
    const navigate = useNavigate();
    const [localHighlightId, setLocalHighlightId] = useState<number | null>(null);

    const [isCreateDialogOpen, setCreateDialogOpen] = useState(false);
    const [conversionTarget, setConversionTarget] = useState<AdminReservationOut | null>(null);
    const [isConfirmingDelete, setConfirmingDelete] = useState(false);

    // –ü–æ–ª—É—á–∞–µ–º –ø–∞—Ä–∞–º–µ—Ç—Ä—ã —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏ –∏–∑ —Å—Ç–æ—Ä–∞
    const { searchQuery, statusFilter, setSearchQuery, setStatusFilter } = useOrderFilterStore();

    // –≠—Ç–æ—Ç useEffect –æ–±—Ä–∞–±–æ—Ç–∞–µ—Ç —Å–æ—Å—Ç–æ—è–Ω–∏–µ, –ø–µ—Ä–µ–¥–∞–Ω–Ω–æ–µ –ø—Ä–∏ –Ω–∞–≤–∏–≥–∞—Ü–∏–∏
    useEffect(() => {
        const state = location.state as { highlightId?: number; statusFilterOverride?: string } | null;
        if (state?.highlightId) {
            setLocalHighlightId(state.highlightId);
        }
        if (state?.statusFilterOverride) {
            setStatusFilter(state.statusFilterOverride);
            setSearchQuery(""); // –°–±—Ä–∞—Å—ã–≤–∞–µ–º –ø–æ–∏—Å–∫ –¥–ª—è —á–∏—Å—Ç–æ—Ç—ã
        }
    }, [location.state, setStatusFilter, setSearchQuery]);

    // –≠—Ç–æ—Ç useEffect —Å–±—Ä–æ—Å–∏—Ç –ø–æ–¥—Å–≤–µ—Ç–∫—É —á–µ—Ä–µ–∑ 3 —Å–µ–∫—É–Ω–¥—ã
    useEffect(() => {
        if (localHighlightId) {
            const timer = setTimeout(() => {
                setLocalHighlightId(null);
                // –û—á–∏—â–∞–µ–º location.state, —á—Ç–æ–±—ã –ø–æ–¥—Å–≤–µ—Ç–∫–∞ –Ω–µ "–∑–∞–ª–∏–ø–∞–ª–∞" –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
                navigate(location.pathname, { replace: true, state: {} });
            }, 3000);
            return () => clearTimeout(timer);
        }
    }, [localHighlightId, navigate, location.pathname]);

    const {
        data,
        isLoading: isLoadingReservations,
        error,
        fetchNextPage,
        hasNextPage,
        isFetchingNextPage
    } = useAdminReservations({
        search: searchQuery,
        status: statusFilter === "all" ? undefined : statusFilter,
    });

    const { data: allEquipment = [], isLoading: isLoadingEquipment } = useAllEquipment();
    const { selectedIds, clearSelection } = useAdminReservationSelectionStore();
    const bulkDeleteMutation = useBulkDeleteAdminReservations();

    useEffect(() => {
        return () => {
            clearSelection();
        };
    }, []);

    const equipmentMap = useMemo(() => {
        return new Map(allEquipment.map(e => [e.id, e]));
    }, [allEquipment]);

    const allReservations = useMemo(() => {
        const flatList = data?.pages.flatMap(page => page.items) ?? [];
        return Array.from(new Map(flatList.map(item => [item.id, item])).values());
    }, [data]);

    const visibleReservationIds = useMemo(() => allReservations.map(r => r.id), [allReservations]);

    const isLoading = isLoadingReservations || isLoadingEquipment;

    const handleBulkDelete = () => {
        if (selectedIds.length === 0) return;
        setConfirmingDelete(true);
    };

    const confirmBulkDelete = () => {
        bulkDeleteMutation.mutate(selectedIds, {
            onSuccess: () => {
                clearSelection();
                setConfirmingDelete(false);
            },
            onError: () => {
                setConfirmingDelete(false);
            }
        });
    };

    return (
        <div className="max-w-7xl mx-auto px-4 py-6 space-y-6">
            <AdminNavigation />

            <div className="flex items-center gap-3">
                <ClipboardList className="w-8 h-8 text-indigo-600" />
                <div>
                    <h1 className="text-3xl font-bold text-gray-900">
                        –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Ä–µ–∑–µ—Ä–≤–∞–º–∏
                    </h1>
                    <p className="text-gray-600 mt-1">
                        –ü—Ä–æ—Å–º–æ—Ç—Ä, —Å–æ–∑–¥–∞–Ω–∏–µ –∏ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –≤—Å–µ—Ö —Ä–µ–∑–µ—Ä–≤–æ–≤ –≤ —Å–∏—Å—Ç–µ–º–µ.
                    </p>
                </div>
            </div>

            <div className="bg-white rounded-lg border shadow-sm p-4 flex flex-col md:flex-row items-center justify-between gap-4">
                <div className="w-full">
                    <OrderToolbar context="admin-reservations" />
                </div>
                <Button onClick={() => setCreateDialogOpen(true)} className="w-full md:w-auto">
                    <Plus className="mr-2 h-4 w-4" />
                    –°–æ–∑–¥–∞—Ç—å —Ä–µ–∑–µ—Ä–≤
                </Button>
            </div>

            <AdminReservationToolbar
                visibleReservationIds={visibleReservationIds}
                onBulkDelete={handleBulkDelete}
                isDeleting={bulkDeleteMutation.isPending}
            />

            <div className="bg-white rounded-lg border shadow-sm p-4 md:p-6">
                {isLoading && <p className="text-center text-gray-500 py-4">–ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö...</p>}
                {error && <p className="text-center text-red-600 py-4">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö: {error.message}</p>}

                {!isLoading && !error && allReservations.length === 0 && (
                    <div className="flex flex-col items-center justify-center text-center p-12 space-y-4 bg-gray-50/50 rounded-lg border-2 border-dashed">
                        <ClipboardX className="w-16 h-16 text-gray-400" />
                        <h3 className="text-lg font-semibold text-gray-800">–†–µ–∑–µ—Ä–≤—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã</h3>
                        <p className="text-sm text-gray-500">–ü–æ–ø—Ä–æ–±—É–π—Ç–µ –∏–∑–º–µ–Ω–∏—Ç—å —Ñ–∏–ª—å—Ç—Ä—ã –∏–ª–∏ —Å–æ–∑–¥–∞–π—Ç–µ –Ω–æ–≤—ã–π —Ä–µ–∑–µ—Ä–≤.</p>
                    </div>
                )}

                {!isLoading && !error && allReservations.length > 0 && (
                    <AllReservationsList
                        reservations={allReservations}
                        onConvertToRental={setConversionTarget}
                        equipmentMap={equipmentMap}
                        highlightId={localHighlightId}
                    />
                )}
                {hasNextPage && (
                    <div className="flex justify-center mt-6">
                        <Button
                            variant="outline"
                            onClick={() => fetchNextPage()}
                            disabled={isFetchingNextPage}
                        >
                            {isFetchingNextPage ? (
                                <><Loader2 className="mr-2 h-4 w-4 animate-spin" /> –ó–∞–≥—Ä—É–∑–∫–∞...</>
                            ) : "–ó–∞–≥—Ä—É–∑–∏—Ç—å –µ—â–µ"}
                        </Button>
                    </div>
                )}
            </div>

            <CreateReservationDialog
                isOpen={isCreateDialogOpen}
                onClose={() => setCreateDialogOpen(false)}
            />
            <ConvertReservationDialog
                reservation={conversionTarget}
                open={!!conversionTarget}
                onClose={() => setConversionTarget(null)}
                equipmentMap={equipmentMap}
            />

            <ConfirmationDialog
                open={isConfirmingDelete}
                onOpenChange={setConfirmingDelete}
                title="–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç–µ —É–¥–∞–ª–µ–Ω–∏–µ"
                description={`–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å ${selectedIds.length} —Ä–µ–∑–µ—Ä–≤(–æ–≤)? –≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ –Ω–µ–ª—å–∑—è –æ—Ç–º–µ–Ω–∏—Ç—å.`}
                confirmText="–î–∞, —É–¥–∞–ª–∏—Ç—å"
                cancelText="–û—Ç–º–µ–Ω–∞"
                onConfirm={confirmBulkDelete}
                variant="destructive"
            />
        </div>
    );
}

```


## <a name="rentalappmainsrcpagesadminAssociationManagementPagetsx"></a>`rental-app-main/src/pages/admin/AssociationManagementPage.tsx`

```tsx
// path: rental-app-main/src/pages/admin/AssociationManagementPage.tsx

import AdminNavigation from "@/components/admin/AdminNavigation";
import AssociationTable from "@/components/admin/AssociationTable";
import { Tags } from "lucide-react";

export default function AssociationManagementPage() {
    return (
        <div className="max-w-7xl mx-auto px-4 py-6 space-y-6">
            <AdminNavigation />
            <div className="flex items-center gap-3">
                <Tags className="w-8 h-8 text-green-600" />
                <div>
                    <h1 className="text-3xl font-bold text-gray-900">
                        –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∞—Å—Å–æ—Ü–∏–∞—Ü–∏—è–º–∏
                    </h1>
                    <p className="text-gray-600 mt-1">
                        –°–æ–∑–¥–∞–≤–∞–π—Ç–µ –∏ —Ä–µ–¥–∞–∫—Ç–∏—Ä—É–π—Ç–µ –ø–æ–¥–±–æ—Ä–∫–∏ –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—è –¥–ª—è –±—ã—Å—Ç—Ä–æ–≥–æ –¥–æ—Å—Ç—É–ø–∞.
                    </p>
                </div>
            </div>
            <div className="bg-white rounded-lg border shadow-sm p-6">
                <AssociationTable />
            </div>
        </div>
    );
}



```


## <a name="rentalappmainsrcpagesadminDashboardPagetsx"></a>`rental-app-main/src/pages/admin/DashboardPage.tsx`

```tsx
// path: rental-app-main/src/pages/admin/DashboardPage.tsx

// src/pages/admin/DashboardPage.tsx

import { useCurrentUser } from "@/hooks/useProfile";
import { useDashboardData } from "@/hooks/admin/useDashboardData";
import AdminNavigation from "@/components/admin/AdminNavigation";
import TodayFocusWidget from "@/components/admin/dashboard/TodayFocusWidget";
import KpiCardsWidget from "@/components/admin/dashboard/KpiCardsWidget";
import ActivityFeedWidget from "@/components/admin/dashboard/ActivityFeedWidget";
import PopularEquipmentChart from "@/components/admin/dashboard/PopularEquipmentChart";
import { Card, CardContent } from "@/components/ui/card";
import { Alert, AlertDescription } from "@/components/ui/alert";
import { Skeleton } from "@/components/ui/skeleton";
import { AlertCircle, RefreshCw } from "lucide-react";
import { Button } from "@/components/ui/button";

export default function DashboardPage() {
    const { data: currentUser } = useCurrentUser();
    const { data: dashboardData, isLoading, isError, error, refetch } = useDashboardData();

    const isAdmin = currentUser?.role === "admin";
    const isManager = currentUser?.role === "manager" || isAdmin;

    if (!isManager) {
        return (
            <div className="max-w-7xl mx-auto px-4 py-6">
                <AdminNavigation />
                <div className="flex items-center justify-center min-h-[400px]">
                    <Alert className="max-w-md">
                        <AlertCircle className="h-4 w-4" />
                        <AlertDescription>
                            –î–æ—Å—Ç—É–ø –æ–≥—Ä–∞–Ω–∏—á–µ–Ω. –¢—Ä–µ–±—É—é—Ç—Å—è –ø—Ä–∞–≤–∞ –º–µ–Ω–µ–¥–∂–µ—Ä–∞ –∏–ª–∏ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞.
                        </AlertDescription>
                    </Alert>
                </div>
            </div>
        );
    }

    if (isError) {
        return (
            <div className="max-w-7xl mx-auto px-4 py-6 space-y-6">
                <AdminNavigation />
                <div className="flex items-center justify-center min-h-[400px]">
                    <Card className="max-w-md">
                        <CardContent className="pt-6">
                            <Alert variant="destructive">
                                <AlertCircle className="h-4 w-4" />
                                <AlertDescription className="mt-2">
                                    <div className="font-medium mb-2">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö</div>
                                    <div className="text-sm text-muted-foreground mb-4">
                                        {error?.message || "–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –¥–∞–Ω–Ω—ã–µ –¥–∞—à–±–æ—Ä–¥–∞"}
                                    </div>
                                    <Button 
                                        onClick={() => refetch()} 
                                        variant="outline" 
                                        size="sm"
                                        className="w-full"
                                    >
                                        <RefreshCw className="w-4 h-4 mr-2" />
                                        –ü–æ–ø—Ä–æ–±–æ–≤–∞—Ç—å —Å–Ω–æ–≤–∞
                                    </Button>
                                </AlertDescription>
                            </Alert>
                        </CardContent>
                    </Card>
                </div>
            </div>
        );
    }

    return (
        <div className="max-w-7xl mx-auto px-4 py-6 space-y-6">
            <AdminNavigation />

            {/* –ó–∞–≥–æ–ª–æ–≤–æ–∫ */}
            <div className="flex items-center justify-between">
                <div>
                    <h1 className="text-3xl font-bold text-gray-900">
                        –ü–∞–Ω–µ–ª—å —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è
                    </h1>
                    <p className="text-gray-600 mt-1">
                        –î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å, {currentUser?.full_name}!
                    </p>
                </div>
                <div className="flex items-center gap-2">
                    {isLoading && (
                        <div className="flex items-center gap-2 text-sm text-gray-500">
                            <RefreshCw className="w-4 h-4 animate-spin" />
                            –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ...
                        </div>
                    )}
                    <Button 
                        onClick={() => refetch()} 
                        variant="outline" 
                        size="sm"
                        disabled={isLoading}
                    >
                        <RefreshCw className={`w-4 h-4 mr-2 ${isLoading ? 'animate-spin' : ''}`} />
                        –û–±–Ω–æ–≤–∏—Ç—å
                    </Button>
                </div>
            </div>

            {/* KPI Cards */}
            {isLoading ? (
                <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                    {Array.from({ length: 8 }).map((_, index) => (
                        <Card key={index}>
                            <CardContent className="p-6">
                                <div className="space-y-2">
                                    <Skeleton className="h-4 w-20" />
                                    <Skeleton className="h-8 w-16" />
                                    <Skeleton className="h-3 w-24" />
                                </div>
                            </CardContent>
                        </Card>
                    ))}
                </div>
            ) : (
                <KpiCardsWidget 
                    data={dashboardData?.kpi || {
                        total_users: 0,
                        active_users: 0,
                        total_equipment: 0,
                        total_reservations: 0,
                        revenue_today: 0,
                        revenue_this_month: 0,
                        occupancy_rate: 0,
                        avg_rental_duration: 0
                    }} 
                    isLoading={false} 
                />
            )}

            {/* –û—Å–Ω–æ–≤–Ω–æ–π –∫–æ–Ω—Ç–µ–Ω—Ç - –∞–¥–∞–ø—Ç–∏–≤–Ω–∞—è —Å–µ—Ç–∫–∞ */}
            <div className="grid grid-cols-1 lg:grid-cols-3 gap-6">
                {/* –õ–µ–≤–∞—è –∫–æ–ª–æ–Ω–∫–∞ - –§–æ–∫—É—Å –Ω–∞ —Å–µ–≥–æ–¥–Ω—è */}
                <div className="lg:col-span-1">
                    {isLoading ? (
                        <Card>
                            <CardContent className="p-6">
                                <div className="space-y-4">
                                    <Skeleton className="h-6 w-32" />
                                    {Array.from({ length: 3 }).map((_, index) => (
                                        <div key={index} className="space-y-2">
                                            <Skeleton className="h-4 w-24" />
                                            <Skeleton className="h-16 w-full" />
                                        </div>
                                    ))}
                                </div>
                            </CardContent>
                        </Card>
                    ) : (
                        <TodayFocusWidget 
                            data={{
                                pickups_today: dashboardData?.pickups_today || [],
                                returns_today: dashboardData?.returns_today || [],
                                overdue_rentals: dashboardData?.overdue_rentals || []
                            }} 
                            isLoading={false} 
                        />
                    )}
                </div>

                {/* –ü—Ä–∞–≤–∞—è –∫–æ–ª–æ–Ω–∫–∞ - –õ–µ–Ω—Ç–∞ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ –∏ –≥—Ä–∞—Ñ–∏–∫ */}
                <div className="lg:col-span-2 space-y-6">
                    {/* –õ–µ–Ω—Ç–∞ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ */}
                    <ActivityFeedWidget 
                        data={dashboardData?.recent_activity || []} 
                        isLoading={isLoading} 
                    />

                    {/* –ì—Ä–∞—Ñ–∏–∫ –ø–æ–ø—É–ª—è—Ä–Ω–æ–≥–æ –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—è */}
                    <PopularEquipmentChart 
                        data={dashboardData?.popular_equipment || []} 
                        isLoading={isLoading} 
                    />
                </div>
            </div>

            {/* –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è */}
            {!isLoading && dashboardData && (
                <div className="text-center text-sm text-gray-500 pt-4 border-t">
                    <p>
                        –î–∞–Ω–Ω—ã–µ –æ–±–Ω–æ–≤–ª—è—é—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∫–∞–∂–¥—ã–µ 2 –º–∏–Ω—É—Ç—ã. 
                        –ü–æ—Å–ª–µ–¥–Ω–µ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ: {new Date().toLocaleTimeString('ru-RU')}
                    </p>
                </div>
            )}
        </div>
    );
}


```


## <a name="rentalappmainsrcpagesadminHolidayManagementPagetsx"></a>`rental-app-main/src/pages/admin/HolidayManagementPage.tsx`

```tsx
// path: rental-app-main/src/pages/admin/HolidayManagementPage.tsx

// src/pages/admin/HolidayManagementPage.tsx

import AdminNavigation from "@/components/admin/AdminNavigation";
import HolidayManager from "@/components/admin/HolidayManager"; // –≠—Ç–æ—Ç –∫–æ–º–ø–æ–Ω–µ–Ω—Ç –º—ã —Å–æ–∑–¥–∞–¥–∏–º –¥–∞–ª–µ–µ
import { CalendarDays } from "lucide-react";

export default function HolidayManagementPage() {
    return (
        <div className="max-w-7xl mx-auto px-4 py-6 space-y-6">
            <AdminNavigation />
            <div className="flex items-center gap-3">
                <CalendarDays className="w-8 h-8 text-cyan-600" />
                <div>
                    <h1 className="text-3xl font-bold text-gray-900">
                        –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –≤—ã—Ö–æ–¥–Ω—ã–º–∏ –¥–Ω—è–º–∏
                    </h1>
                    <p className="text-gray-600 mt-1">
                        –ù–∞–∑–Ω–∞—á—å—Ç–µ –ø—Ä–∞–∑–¥–Ω–∏—á–Ω—ã–µ –∏ –Ω–µ—Ä–∞–±–æ—á–∏–µ –¥–Ω–∏, –∫–æ—Ç–æ—Ä—ã–µ –Ω–µ –±—É–¥—É—Ç —Ç–∞—Ä–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞—Ç—å—Å—è.
                    </p>
                </div>
            </div>
            <div className="bg-white rounded-lg border shadow-sm p-6">
                <HolidayManager />
            </div>
        </div>
    );
}

```


## <a name="rentalappmainsrcpagesadminPromoCodeManagementPagetsx"></a>`rental-app-main/src/pages/admin/PromoCodeManagementPage.tsx`

```tsx
// path: rental-app-main/src/pages/admin/PromoCodeManagementPage.tsx

// src/pages/admin/PromoCodeManagementPage.tsx

import AdminNavigation from "@/components/admin/AdminNavigation";
import { TicketPercent } from "lucide-react";
import PromoCodeTable from "@/components/admin/PromoCodeTable";
import DurationDiscountManager from "@/components/admin/DurationDiscountManager";

export default function PromoCodeManagementPage() {
    return (
        <div className="max-w-7xl mx-auto px-4 py-6 space-y-6">
            <AdminNavigation />

            <div className="flex items-center gap-3">
                <TicketPercent className="w-8 h-8 text-purple-600" />
                <div>
                    <h1 className="text-3xl font-bold text-gray-900">
                        –ü—Ä–æ–º–æ–∫–æ–¥—ã –∏ —Å–∫–∏–¥–∫–∏
                    </h1>
                    <p className="text-gray-600 mt-1">
                        –°–æ–∑–¥–∞–Ω–∏–µ, —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∏ –ø—Ä–æ—Å–º–æ—Ç—Ä –ø—Ä–æ–º–æ–∫–æ–¥–æ–≤ –∏ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏—Ö —Å–∫–∏–¥–æ–∫.
                    </p>
                </div>
            </div>

            {/* –ë–ª–æ–∫ —Å –ø—Ä–æ–º–æ–∫–æ–¥–∞–º–∏ (–æ—Å—Ç–∞–µ—Ç—Å—è –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π) */}
            <div className="bg-white rounded-lg border shadow-sm p-6">
                <PromoCodeTable />
            </div>

            {/* 2. <-- –î–û–ë–ê–í–õ–Ø–ï–ú –ù–û–í–´–ô –ë–õ–û–ö –î–õ–Ø –£–ü–†–ê–í–õ–ï–ù–ò–Ø –°–ö–ò–î–ö–ê–ú–ò */}
            <div className="bg-white rounded-lg border shadow-sm p-6">
                <DurationDiscountManager />
            </div>
        </div>
    );
}

```


## <a name="rentalappmainsrcpagesadminRentalManagementPagetsx"></a>`rental-app-main/src/pages/admin/RentalManagementPage.tsx`

```tsx
// path: rental-app-main/src/pages/admin/RentalManagementPage.tsx

// src/pages/admin/RentalManagementPage.tsx

import { useState, useMemo, useEffect } from "react";
import { useLocation, useNavigate } from "react-router-dom";
import AdminNavigation from "@/components/admin/AdminNavigation";
import { Button } from "@/components/ui/button";
import { Truck, Plus, Loader2 } from "lucide-react";
import { useAdminRentals } from "@/hooks/useAdminRentals";
import AllRentalsList from "@/components/admin/AllRentalsList";
import ReturnRentalDialog from "@/components/admin/ReturnRentalDialog";
import type { AdminRentalOut } from "@/types/rental";
import OrderToolbar from "@/components/shared/OrderToolbar";
import { useOrderFilterStore } from "@/store/orderFilterStore";



export default function RentalManagementPage() {
    const location = useLocation();
    const navigate = useNavigate();
    const [localHighlightId, setLocalHighlightId] = useState<number | null>(null);
    const [returnTarget, setReturnTarget] = useState<AdminRentalOut | null>(null);

    // –ü–æ–ª—É—á–∞–µ–º –ø–∞—Ä–∞–º–µ—Ç—Ä—ã —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏ –∏–∑ —Å—Ç–æ—Ä–∞
    const { searchQuery, statusFilter, setSearchQuery, setStatusFilter } = useOrderFilterStore();

    const {
        data,
        isLoading,
        error,
        fetchNextPage,
        hasNextPage,
        isFetchingNextPage
    } = useAdminRentals({
        search: searchQuery,
        status: statusFilter === "all" ? undefined : (statusFilter as "active" | "overdue" | "completed" | null),
    });

    const allRentals = useMemo(() => data?.pages.flatMap(page => page.items) ?? [], [data]);

    // –≠—Ç–æ—Ç useEffect –æ–±—Ä–∞–±–æ—Ç–∞–µ—Ç —Å–æ—Å—Ç–æ—è–Ω–∏–µ, –ø–µ—Ä–µ–¥–∞–Ω–Ω–æ–µ –ø—Ä–∏ –Ω–∞–≤–∏–≥–∞—Ü–∏–∏
    useEffect(() => {
        const state = location.state as { highlightId?: number; statusFilterOverride?: string } | null;
        if (state?.highlightId) {
            setLocalHighlightId(state.highlightId);
        }
        if (state?.statusFilterOverride) {
            setStatusFilter(state.statusFilterOverride);
            setSearchQuery(""); // –°–±—Ä–∞—Å—ã–≤–∞–µ–º –ø–æ–∏—Å–∫ –¥–ª—è —á–∏—Å—Ç–æ—Ç—ã
        }
    }, [location.state, setStatusFilter, setSearchQuery]);

    // –≠—Ç–æ—Ç useEffect —Å–±—Ä–æ—Å–∏—Ç –ø–æ–¥—Å–≤–µ—Ç–∫—É —á–µ—Ä–µ–∑ 3 —Å–µ–∫—É–Ω–¥—ã
    useEffect(() => {
        if (localHighlightId) {
            const timer = setTimeout(() => {
                setLocalHighlightId(null);
                // –û—á–∏—â–∞–µ–º location.state, —á—Ç–æ–±—ã –ø–æ–¥—Å–≤–µ—Ç–∫–∞ –Ω–µ "–∑–∞–ª–∏–ø–∞–ª–∞" –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
                navigate(location.pathname, { replace: true, state: {} });
            }, 3000);
            return () => clearTimeout(timer);
        }
    }, [localHighlightId, navigate, location.pathname]);

    return (
        <div className="max-w-7xl mx-auto px-4 py-6 space-y-6">
            <AdminNavigation />

            <div className="flex items-center gap-3">
                <Truck className="w-8 h-8 text-orange-600" />
                <div>
                    <h1 className="text-3xl font-bold text-gray-900">
                        –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ê—Ä–µ–Ω–¥–∞–º–∏
                    </h1>
                    <p className="text-gray-600 mt-1">
                        –ü—Ä–æ—Å–º–æ—Ç—Ä, —Å–æ–∑–¥–∞–Ω–∏–µ –∏ –∑–∞–≤–µ—Ä—à–µ–Ω–∏–µ —Ñ–∏–∑–∏—á–µ—Å–∫–æ–π –≤—ã–¥–∞—á–∏ –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—è.
                    </p>
                </div>
            </div>

            <div className="bg-white rounded-lg border shadow-sm p-4 flex flex-col md:flex-row items-center justify-between gap-4">
                <div className="w-full">
                    <OrderToolbar context="admin-rentals" />
                </div>
                <Button disabled className="w-full md:w-auto">
                    <Plus className="mr-2 h-4 w-4" />
                    –°–æ–∑–¥–∞—Ç—å –∞—Ä–µ–Ω–¥—É
                </Button>
            </div>

            <div className="bg-white rounded-lg border shadow-sm p-4 md:p-6">
                {isLoading && <p className="text-center text-gray-500 py-4">–ó–∞–≥—Ä—É–∑–∫–∞ –∞—Ä–µ–Ω–¥...</p>}
                {error && <p className="text-center text-red-600 py-4">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö: {error.message}</p>}
                {!isLoading && !error && (
                    <AllRentalsList rentals={allRentals} onReturn={setReturnTarget} highlightId={localHighlightId} />
                )}
                {hasNextPage && (
                    <div className="flex justify-center mt-6">
                        <Button
                            variant="outline"
                            onClick={() => fetchNextPage()}
                            disabled={isFetchingNextPage}
                        >
                            {isFetchingNextPage ? (
                                <><Loader2 className="mr-2 h-4 w-4 animate-spin" /> –ó–∞–≥—Ä—É–∑–∫–∞...</>
                            ) : "–ó–∞–≥—Ä—É–∑–∏—Ç—å –µ—â–µ"}
                        </Button>
                    </div>
                )}
            </div>

            <ReturnRentalDialog
                rental={returnTarget}
                open={!!returnTarget}
                onClose={() => setReturnTarget(null)}
            />
        </div>
    );
}

```


## <a name="rentalappmainsrcstoreadminReservationSelectionStorets"></a>`rental-app-main/src/store/adminReservationSelectionStore.ts`

```typescript
// path: rental-app-main/src/store/adminReservationSelectionStore.ts

// src/store/adminReservationSelectionStore.ts

import { create } from 'zustand';

type SelectionState = {
    selectedIds: number[];
    toggleId: (id: number) => void;
    setSelectedIds: (ids: number[]) => void;
    clearSelection: () => void;
};

export const useAdminReservationSelectionStore = create<SelectionState>((set) => ({
    selectedIds: [],
    toggleId: (id) =>
        set((state) => ({
            selectedIds: state.selectedIds.includes(id)
                ? state.selectedIds.filter((selectedId) => selectedId !== id)
                : [...state.selectedIds, id],
        })),
    setSelectedIds: (ids) => set({ selectedIds: ids }),
    clearSelection: () => set({ selectedIds: [] }),
}));

```


## <a name="rentalappmainsrcstoreauthStorets"></a>`rental-app-main/src/store/authStore.ts`

```typescript
// path: rental-app-main/src/store/authStore.ts

// src/store/authStore.ts

import { create } from "zustand"
import { api } from "@/lib/api"
import { queryClient } from "@/lib/queryClient"

// <<< –ò–ó–ú–ï–ù–ï–ù–ò–ï: –û–±–Ω–æ–≤–ª—è–µ–º —Ç–∏–ø –¥–∞–Ω–Ω—ã—Ö –¥–ª—è —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏
type RegisterPayload = {
    full_name: string
    email: string
    password: string
    phone?: string
    privacy_policy_accepted: boolean
    terms_accepted: boolean
}

type AuthStore = {
    loading: boolean
    error: string | null
    login: (email: string, password: string) => Promise<void>
    register: (data: RegisterPayload) => Promise<void>
    logout: () => void
}

export const useAuthStore = create<AuthStore>((set) => ({
    loading: false,
    error: null,

    login: async (email, password) => {
        set({ loading: true, error: null })
        try {
            const response = await api.post(
                "/auth/token",
                new URLSearchParams({ username: email, password }),
                {
                    headers: {
                        "Content-Type": "application/x-www-form-urlencoded",
                    },
                }
            )

            const token = response.data.access_token
            localStorage.setItem("access_token", token)

            // ‚úÖ –û–±–Ω–æ–≤–ª—è–µ–º –∫—ç—à –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
            await queryClient.invalidateQueries({ queryKey: ["current_user"] })
        } catch (err: unknown) {
            const error = err as { response?: { data?: { detail?: string } } }
            set({
                error: error?.response?.data?.detail || "–û—à–∏–±–∫–∞ –≤—Ö–æ–¥–∞",
            })
        } finally {
            set({ loading: false })
        }
    },

    // <<< –ò–ó–ú–ï–ù–ï–ù–ò–ï: –û–±–Ω–æ–≤–ª—è–µ–º —Ñ—É–Ω–∫—Ü–∏—é register –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ –≤—Å–µ—Ö –ø–æ–ª–µ–π
    register: async (data) => {
        set({ loading: true, error: null })
        try {
            await api.post("/auth/register", data) // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –ø–æ–ª–Ω—ã–π –æ–±—ä–µ–∫—Ç `data`

            // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –≤—Ö–æ–¥–∏–º –ø–æ—Å–ª–µ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏
            const response = await api.post(
                "/auth/token",
                new URLSearchParams({ username: data.email, password: data.password }),
                {
                    headers: {
                        "Content-Type": "application/x-www-form-urlencoded",
                    },
                }
            )

            const token = response.data.access_token
            localStorage.setItem("access_token", token)

            // ‚úÖ –û–±–Ω–æ–≤–ª—è–µ–º –∫—ç—à –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
            await queryClient.invalidateQueries({ queryKey: ["current_user"] })
        } catch (err: unknown) {
            const error = err as { response?: { data?: { detail?: string } } }
            set({
                error: error?.response?.data?.detail || "–û—à–∏–±–∫–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏",
            })
        } finally {
            set({ loading: false })
        }
    },

    logout: () => {
        localStorage.removeItem("access_token")
        queryClient.invalidateQueries({ queryKey: ["current_user"] })
    },
}))

```


## <a name="rentalappmainsrcstorecalendarSelectionStorets"></a>`rental-app-main/src/store/calendarSelectionStore.ts`

```typescript
// path: rental-app-main/src/store/calendarSelectionStore.ts

// src/store/calendarSelectionStore.ts
import { create } from "zustand";

type CalendarSelectionState = {
    selectedGroupId: string | null;
    setSelectedGroupId: (id: string | null) => void;
};

export const useCalendarSelectionStore = create<CalendarSelectionState>((set) => ({
    selectedGroupId: null,
    setSelectedGroupId: (id) => set({ selectedGroupId: id }),
}));


```


## <a name="rentalappmainsrcstoredateStorets"></a>`rental-app-main/src/store/dateStore.ts`

```typescript
// path: rental-app-main/src/store/dateStore.ts

// src/store/dateStore.ts

import { create } from "zustand";
import { calculateDayCount } from "@/lib/utils";
import { addDays } from "date-fns";
import { DateService } from "@/core/services/DateService";

type DateState = {
    startDate: Date;
    endDate: Date;
    dayCount: number;
    // +++ –î–û–ë–ê–í–õ–ï–ù–ê –ù–û–í–ê–Ø –§–£–ù–ö–¶–ò–Ø –í –¢–ò–ü +++
    initializeDates: (holidays: Date[]) => void;
    setRange: (from: Date, to: Date, source?: 'calendar' | 'slider' | 'manual', holidays?: Date[]) => void;
    setStartDate: (date: Date, holidays?: Date[]) => void;
    setEndDate: (date: Date, holidays?: Date[]) => void;
    setDayCount: (days: number, holidays?: Date[]) => void;
    reset: (holidays?: Date[]) => void;
};

// –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏
function normalizeDate(date: Date): Date {
    const local = new Date(date);
    local.setHours(12, 0, 0, 0); // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –≤—Ä–µ–º—è –Ω–∞ –ø–æ–ª–¥–µ–Ω—å –¥–ª—è –∏–∑–±–µ–∂–∞–Ω–∏—è –ø—Ä–æ–±–ª–µ–º —Å —á–∞—Å–æ–≤—ã–º–∏ –ø–æ—è—Å–∞–º–∏
    return local;
}

function isValidDate(date: Date): boolean {
    return date instanceof Date && !isNaN(date.getTime());
}

function isValidDateRange(start: Date, end: Date): boolean {
    return isValidDate(start) && isValidDate(end) && start < end;
}

// –ù–∞—á–∞–ª—å–Ω—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
const defaultStart = normalizeDate(new Date());
const defaultEnd = normalizeDate(new Date(new Date().setDate(new Date().getDate() + 1)));

export const useDateStore = create<DateState>((set, get) => ({
    startDate: defaultStart,
    endDate: defaultEnd,
    dayCount: 1,

    // +++ –ù–ê–ß–ê–õ–û: –ù–û–í–ê–Ø –§–£–ù–ö–¶–ò–Ø –î–õ–Ø –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–ò –î–ê–¢ +++
    initializeDates: (holidays: Date[]) => {
        const today = normalizeDate(new Date());
        // –°–¥–≤–∏–≥–∞–µ–º –¥–∞—Ç—É –Ω–∞—á–∞–ª–∞, –µ—Å–ª–∏ —Å–µ–≥–æ–¥–Ω—è –≤—ã—Ö–æ–¥–Ω–æ–π
        const initialStartDate = DateService.adjustDateIfHoliday(today, holidays);
        // –ù–∞—Ö–æ–¥–∏–º —Å–ª–µ–¥—É—é—â–∏–π —Ä–∞–±–æ—á–∏–π –¥–µ–Ω—å –ø–æ—Å–ª–µ —Å–∫–æ—Ä—Ä–µ–∫—Ç–∏—Ä–æ–≤–∞–Ω–Ω–æ–π –¥–∞—Ç—ã –Ω–∞—á–∞–ª–∞
        const initialEndDate = DateService.findNextWorkingDay(initialStartDate, holidays, 1);

        // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –Ω–æ–≤—ã–π –¥–∏–∞–ø–∞–∑–æ–Ω
        get().setRange(initialStartDate, initialEndDate, 'manual', holidays);
    },
    // +++ –ö–û–ù–ï–¶: –ù–û–í–ê–Ø –§–£–ù–ö–¶–ò–Ø +++

    setRange: (from, to, source, holidays = []) => {
        const currentState = get();
        const normalizedFrom = normalizeDate(from);
        let normalizedTo = normalizeDate(to);

        if (normalizedFrom.getTime() >= normalizedTo.getTime()) {
            normalizedTo = new Date(normalizedFrom);
            normalizedTo.setDate(normalizedTo.getDate() + 1);
        }

        normalizedTo = DateService.adjustDateIfHoliday(normalizedTo, holidays);

        if (
            normalizedFrom.getTime() === currentState.startDate.getTime() &&
            normalizedTo.getTime() === currentState.endDate.getTime()
        ) {
            return;
        }

        if (!isValidDateRange(normalizedFrom, normalizedTo)) {
            console.error("[dateStore] Invalid date range:", { from, to });
            return;
        }

        const newDayCount = calculateDayCount(normalizedFrom, normalizedTo, holidays);

        set({
            startDate: normalizedFrom,
            endDate: normalizedTo,
            dayCount: newDayCount,
        });
    },

    setStartDate: (date, holidays = []) => {
        if (!isValidDate(date)) return;
        const state = get();
        const normalizedDate = normalizeDate(date);
        if (isValidDateRange(normalizedDate, state.endDate)) {
            get().setRange(normalizedDate, state.endDate, 'manual', holidays);
        } else {
            const newEndDate = new Date(normalizedDate);
            newEndDate.setDate(newEndDate.getDate() + 1);
            get().setRange(normalizedDate, newEndDate, 'manual', holidays);
        }
    },

    setEndDate: (date, holidays = []) => {
        if (!isValidDate(date)) return;
        const state = get();
        const normalizedDate = normalizeDate(date);
        if (isValidDateRange(state.startDate, normalizedDate)) {
            get().setRange(state.startDate, normalizedDate, 'manual', holidays);
        }
    },

    setDayCount: (days, holidays = []) => {
        const state = get();
        const potentialEndDate = addDays(state.startDate, days);
        get().setRange(state.startDate, potentialEndDate, 'slider', holidays);
    },

    reset: (holidays = []) => {
        const newStart = normalizeDate(new Date());
        const newEnd = normalizeDate(new Date());
        newEnd.setDate(newEnd.getDate() + 1);
        get().setRange(newStart, newEnd, 'manual', holidays);
    },
}));

```


## <a name="rentalappmainsrcstorefilterStorets"></a>`rental-app-main/src/store/filterStore.ts`

```typescript
// path: rental-app-main/src/store/filterStore.ts

// src/store/filterStore.ts
import { create } from "zustand"

type FilterState = {
  brand: string
  type: string | null
  associationId: number | null
  availableOnly: boolean
  setBrand: (brand: string) => void
  setType: (type: string | null) => void
  setAssociationId: (id: number | null) => void
  setAvailableOnly: (value: boolean) => void
  reset: () => void
}

export const useFilterStore = create<FilterState>((set) => ({
  brand: "__all__",            // –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é –ø–æ–∫–∞–∑—ã–≤–∞—Ç—å –≤—Å–µ –±—Ä–µ–Ω–¥—ã
  type: null,                  // <-- –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é –ø–æ–∫–∞–∑—ã–≤–∞—Ç—å –≤—Å–µ —Ç–∏–ø—ã
  associationId: null,
  availableOnly: false,
  setBrand: (brand) => set({ brand }),
  setType: (type) => set({ type }),
  setAssociationId: (id) => set({ associationId: id }),
  setAvailableOnly: (value) => set({ availableOnly: value }),
  reset: () => set({
    brand: "__all__",
    type: null,               // <-- –°–±—Ä–æ—Å –¥–æ–ª–∂–µ–Ω —Ç–æ–∂–µ –¥–∞–≤–∞—Ç—å null
    associationId: null,
    availableOnly: false,
  }),
}))


```


## <a name="rentalappmainsrcstoreholidayStorets"></a>`rental-app-main/src/store/holidayStore.ts`

```typescript
// path: rental-app-main/src/store/holidayStore.ts

// src/store/holidayStore.ts

import { create } from 'zustand';
import { api } from '@/lib/api';
import { formatDate } from '@/lib/utils';
import type { Holiday, HolidayListResponse } from '@/types/holiday';

type HolidayState = {
    holidays: Date[];
    isLoading: boolean;
    lastFetchedRange: { start: string; end: string } | null;
    fetchHolidays: (start: Date, end: Date) => Promise<void>;
};

export const useHolidayStore = create<HolidayState>((set, get) => ({
    holidays: [],
    isLoading: false,
    lastFetchedRange: null,

    fetchHolidays: async (start, end) => {
        const formattedStart = formatDate(start);
        const formattedEnd = formatDate(end);
        const currentRange = get().lastFetchedRange;

        if (
            get().holidays.length > 0 &&
            currentRange?.start === formattedStart &&
            currentRange?.end === formattedEnd
        ) {
            return;
        }

        set({ isLoading: true });
        try {
            const response = await api.get<HolidayListResponse>('/holidays/', {
                params: {
                    start_date: formattedStart,
                    end_date: formattedEnd,
                    // –ò–ó–ú–ï–ù–ï–ù–ò–ï: –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –ª–∏–º–∏—Ç –≤ 100, —á—Ç–æ–±—ã —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–æ–≤–∞—Ç—å –≤–∞–ª–∏–¥–∞—Ü–∏–∏ –±—ç–∫–µ–Ω–¥–∞
                    limit: 100
                },
            });

            const holidayDates = response.data.items.map((h: Holiday) => new Date(h.date));
            set({
                holidays: holidayDates,
                lastFetchedRange: { start: formattedStart, end: formattedEnd },
            });
        } catch (error) {
            console.error("Failed to fetch holidays:", error);
            set({ holidays: [], lastFetchedRange: null });
        } finally {
            set({ isLoading: false });
        }
    },
}));

```


## <a name="rentalappmainsrcstoreorderFilterStorets"></a>`rental-app-main/src/store/orderFilterStore.ts`

```typescript
// path: rental-app-main/src/store/orderFilterStore.ts

import { create } from "zustand"

export type SortOption =
    | "start_asc"
    | "start_desc"
    | "end_asc"
    | "end_desc"
    | "count_asc"
    | "count_desc"
    | "id_asc"
    | "id_desc"

export type OrderContext = 
    | "user-reservations"
    | "user-rentals"
    | "admin-reservations"
    | "admin-rentals"

type OrderFilterState = {
    searchQuery: string
    statusFilter: string | null
    sortOption: SortOption
    setSearchQuery: (query: string) => void
    setStatusFilter: (filter: string | null) => void
    setSortOption: (option: SortOption) => void
    resetFilters: () => void
}

export const useOrderFilterStore = create<OrderFilterState>()((set) => ({
    searchQuery: "",
    statusFilter: "active",
    sortOption: "id_desc",
    setSearchQuery: (query) => set({ searchQuery: query }),
    setStatusFilter: (filter) => set({ statusFilter: filter }),
    setSortOption: (option) => set({ sortOption: option }),
    resetFilters: () => set({ 
        searchQuery: "", 
        statusFilter: "active", 
        sortOption: "id_desc" 
    }),
}))


```


## <a name="rentalappmainsrcstorepromoCodeStorets"></a>`rental-app-main/src/store/promoCodeStore.ts`

```typescript
// path: rental-app-main/src/store/promoCodeStore.ts

// src/store/promoCodeStore.ts

import { create } from "zustand";
import { toast } from "sonner";

type PromoCodeState = {
    promoCode: string;
    promoCodePercentage: number;
    promoCodeMessage: string;
};

type PromoCodeActions = {
    setPromoCode: (code: string) => void;
    setPromoCodeResult: (percentage: number, message: string) => void;
    removePromoCode: () => void;
    clearPromoCode: () => void; // –î–ª—è —Å–±—Ä–æ—Å–∞ –±–µ–∑ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
};

type PromoCodeStore = PromoCodeState & PromoCodeActions;

export const usePromoCodeStore = create<PromoCodeStore>((set) => ({
    // State
    promoCode: "",
    promoCodePercentage: 0,
    promoCodeMessage: "",

    // Actions
    setPromoCode: (code) => set({ promoCode: code, promoCodeMessage: "" }), // –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –ø—Ä–∏ –Ω–æ–≤–æ–º –≤–≤–æ–¥–µ

    setPromoCodeResult: (percentage, message) => set({
        promoCodePercentage: percentage,
        promoCodeMessage: message
    }),

    removePromoCode: () => {
        set({ promoCode: "", promoCodePercentage: 0, promoCodeMessage: "" });
        toast.info("–ü—Ä–æ–º–æ–∫–æ–¥ —Å–±—Ä–æ—à–µ–Ω.");
    },

    // "–¢–∏—Ö–∏–π" —Å–±—Ä–æ—Å, –∏—Å–ø–æ–ª—å–∑—É–µ–º—ã–π –ø—Ä–æ–≥—Ä–∞–º–º–Ω–æ –ø—Ä–∏ –∑–∞–∫—Ä—ã—Ç–∏–∏ —Ñ–æ—Ä–º/–¥–∏–∞–ª–æ–≥–æ–≤
    clearPromoCode: () => set({ promoCode: "", promoCodePercentage: 0, promoCodeMessage: "" }),
}));

```


## <a name="rentalappmainsrcstorereserveStorets"></a>`rental-app-main/src/store/reserveStore.ts`

```typescript
// path: rental-app-main/src/store/reserveStore.ts

// src/store/reserveStore.ts
import { create } from "zustand";
import { subscribeWithSelector } from "zustand/middleware";
import type { Equipment } from "@/types/equipment";

type ReserveState = {
    items: Equipment[];
    reservationId: number | null;
    addToReservationMode: number | null;
    selectedAccessories: Record<number, number[]>;
};

type ReserveActions = {
    toggle: (equipment: Equipment) => void;
    add: (equipment: Equipment) => void;
    // üëá –î–û–ë–ê–í–õ–ï–ù –ù–û–í–´–ô –ú–ï–¢–û–î –í –¢–ò–ü
    addWithAccessories: (equipment: Equipment, accessoryIds: number[]) => void;
    remove: (equipmentId: number) => void;
    bulkAdd: (equipmentList: Equipment[]) => void;
    clear: () => void;
    clearItemsOnly: () => void;
    isSelected: (equipmentId: number) => boolean;
    setReservationId: (id: number | null) => void;
    setAddToReservationMode: (reservationId: number | null) => void;
    completeAddition: () => Equipment[];
    logState: () => void;
    toggleAccessory: (equipmentId: number, accessoryId: number) => void;
    isAccessorySelected: (equipmentId: number, accessoryId: number) => boolean;
    clearAccessoriesForEquipment: (equipmentId: number) => void;
};

type ReserveStore = ReserveState & ReserveActions;

const isEquipmentSelected = (items: Equipment[], equipmentId: number) =>
    items.some((item) => item.id === equipmentId);

export const useReserveStore = create<ReserveStore>()(
    subscribeWithSelector((set, get) => ({
        items: [],
        reservationId: null,
        addToReservationMode: null,
        selectedAccessories: {},

        toggle: (equipment: Equipment) => {
            const currentItems = get().items;
            const isAlreadySelected = isEquipmentSelected(currentItems, equipment.id);

            if (isAlreadySelected) {
                get().clearAccessoriesForEquipment(equipment.id);
            }

            const newItems = isAlreadySelected
                ? currentItems.filter((item) => item.id !== equipment.id)
                : [...currentItems, equipment];

            set({ items: newItems });
        },

        add: (equipment: Equipment) => {
            const currentItems = get().items;
            if (!isEquipmentSelected(currentItems, equipment.id)) {
                set({ items: [...currentItems, equipment] });
            }
        },

        // üëá –†–ï–ê–õ–ò–ó–ê–¶–ò–Ø –ù–û–í–û–ì–û –ú–ï–¢–û–î–ê
        addWithAccessories: (equipment, accessoryIds) => {
            set(state => {
                // –î–æ–±–∞–≤–ª—è–µ–º –æ—Å–Ω–æ–≤–Ω–æ–µ –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏–µ, –µ—Å–ª–∏ –µ–≥–æ –µ—â–µ –Ω–µ—Ç
                const items = state.items.some(i => i.id === equipment.id)
                    ? state.items
                    : [...state.items, equipment];

                // –î–æ–±–∞–≤–ª—è–µ–º –∏–ª–∏ –æ–±–Ω–æ–≤–ª—è–µ–º –∞–∫—Å–µ—Å—Å—É–∞—Ä—ã –¥–ª—è —ç—Ç–æ–≥–æ –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—è
                const newSelectedAccessories = { ...state.selectedAccessories };
                if (accessoryIds.length > 0) {
                    newSelectedAccessories[equipment.id] = accessoryIds;
                } else {
                    // –ï—Å–ª–∏ –ø–µ—Ä–µ–¥–∞–Ω –ø—É—Å—Ç–æ–π –º–∞—Å—Å–∏–≤, —É–¥–∞–ª—è–µ–º –∞–∫—Å–µ—Å—Å—É–∞—Ä—ã –¥–ª—è —ç—Ç–æ–≥–æ —ç–ª–µ–º–µ–Ω—Ç–∞
                    delete newSelectedAccessories[equipment.id];
                }

                return { items, selectedAccessories: newSelectedAccessories };
            });
        },

        remove: (equipmentId: number) => {
            get().clearAccessoriesForEquipment(equipmentId);
            set(state => ({
                items: state.items.filter((item) => item.id !== equipmentId)
            }));
        },

        bulkAdd: (equipmentList: Equipment[]) => {
            set(state => {
                const currentIds = new Set(state.items.map(item => item.id));
                const newEquipment = equipmentList.filter(eq => !currentIds.has(eq.id));
                return { items: [...state.items, ...newEquipment] };
            });
        },

        clear: () => {
            set({
                items: [],
                reservationId: null,
                addToReservationMode: null,
                selectedAccessories: {},
            });
        },

        clearItemsOnly: () => {
            set({ items: [], selectedAccessories: {} });
        },

        isSelected: (equipmentId: number) => isEquipmentSelected(get().items, equipmentId),

        setReservationId: (id: number | null) => set({ reservationId: id }),

        setAddToReservationMode: (reservationId: number | null) => set({ addToReservationMode: reservationId }),

        completeAddition: () => {
            const state = get();
            const addedItems = [...state.items];
            set({ items: [], addToReservationMode: null, selectedAccessories: {} });
            return addedItems;
        },

        logState: () => {
            console.log(`[ReserveStore] Current state:`, get());
        },

        toggleAccessory: (equipmentId, accessoryId) => {
            set(state => {
                const currentSelection = state.selectedAccessories[equipmentId] || [];
                const isSelected = currentSelection.includes(accessoryId);
                const newSelection = isSelected
                    ? currentSelection.filter(id => id !== accessoryId)
                    : [...currentSelection, accessoryId];

                const newSelectedAccessories = { ...state.selectedAccessories };

                if (newSelection.length > 0) {
                    newSelectedAccessories[equipmentId] = newSelection;
                } else {
                    delete newSelectedAccessories[equipmentId];
                }

                return { selectedAccessories: newSelectedAccessories };
            });
        },

        isAccessorySelected: (equipmentId, accessoryId) => {
            const selection = get().selectedAccessories[equipmentId];
            return selection ? selection.includes(accessoryId) : false;
        },

        clearAccessoriesForEquipment: (equipmentId) => {
            set(state => {
                if (!state.selectedAccessories[equipmentId]) {
                    return state;
                }
                const newSelections = { ...state.selectedAccessories };
                delete newSelections[equipmentId];
                return { selectedAccessories: newSelections };
            });
        }
    }))
);

// –ü–æ–¥–ø–∏—Å–∫–∏ –Ω–∞ –∏–∑–º–µ–Ω–µ–Ω–∏—è –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏ (–æ—Å—Ç–∞—é—Ç—Å—è –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π)
useReserveStore.subscribe(
    (state) => state.items,
    (items, previousItems) => {
        if (items.length !== previousItems.length) {
            console.log(`[ReserveStore] Items changed: ${previousItems.length} -> ${items.length}`);
        }
    }
);

useReserveStore.subscribe(
    (state) => state.reservationId,
    (reservationId, previousReservationId) => {
        if (reservationId !== previousReservationId) {
            console.log(`[ReserveStore] Reservation ID changed: ${previousReservationId} -> ${reservationId}`);
        }
    }
);

useReserveStore.subscribe(
    (state) => state.addToReservationMode,
    (addToReservationMode, previousAddToReservationMode) => {
        if (addToReservationMode !== previousAddToReservationMode) {
            console.log(`[ReserveStore] Add to reservation mode changed: ${previousAddToReservationMode} -> ${addToReservationMode}`);
        }
    }
);

```


## <a name="rentalappmainsrcstoresandboxCalculatorStorets"></a>`rental-app-main/src/store/sandboxCalculatorStore.ts`

```typescript
// path: rental-app-main/src/store/sandboxCalculatorStore.ts

// src/store/sandboxCalculatorStore.ts

import { create } from "zustand";
import { useDateStore } from "./dateStore";
import { useHolidayStore } from "./holidayStore";
import { api } from "@/lib/api";
import type { DurationDiscount, DiscountListResponse } from "@/types/discount";

type SandboxCalculatorState = {
    durationDiscountTiers: DurationDiscount[];
    durationDiscountPercentage: number;
    isLoadingTiers: boolean;
    isCalculatorVisible: boolean;
};

type SandboxCalculatorActions = {
    fetchDiscountTiers: () => Promise<void>;
    setDaysFromCalendar: (days: number) => void;
    setDaysFromSlider: (days: number) => void;
    toggleCalculator: () => void;
    _calculateDurationDiscount: (dayCount: number) => void;
    syncWithDateStore: () => void;
    refreshCalculator: () => void;
};

type SandboxCalculatorStore = SandboxCalculatorState & SandboxCalculatorActions;

export const useSandboxCalculatorStore = create<SandboxCalculatorStore>((set, get) => ({
    durationDiscountTiers: [],
    durationDiscountPercentage: 0,
    isLoadingTiers: false,
    isCalculatorVisible: false,

    _calculateDurationDiscount: (dayCount: number) => {
        const tiers = get().durationDiscountTiers;
        const applicableDiscount = tiers
            .filter(tier => dayCount >= tier.min_days)
            .sort((a, b) => b.min_days - a.min_days)[0];
        set({
            durationDiscountPercentage: applicableDiscount ? applicableDiscount.discount_percentage : 0,
        });
    },

    syncWithDateStore: () => {
        const { dayCount } = useDateStore.getState();
        const { holidays } = useHolidayStore.getState();
        const { _calculateDurationDiscount, isCalculatorVisible, fetchDiscountTiers } = get();

        if (dayCount >= 4 && !isCalculatorVisible) {
            set({ isCalculatorVisible: true });
            void fetchDiscountTiers();
        }

        if (get().durationDiscountTiers.length > 0) {
            _calculateDurationDiscount(dayCount);
        }
    },

    fetchDiscountTiers: async () => {
        if (get().durationDiscountTiers.length > 0 || get().isLoadingTiers) return;
        set({ isLoadingTiers: true });
        try {
            const response = await api.get<DiscountListResponse>("/discounts/");
            set({ durationDiscountTiers: response.data.items, isLoadingTiers: false });
            const { dayCount } = useDateStore.getState();
            get()._calculateDurationDiscount(dayCount);
        } catch (error) {
            console.error("Failed to fetch discount tiers:", error);
            set({ isLoadingTiers: false });
        }
    },

    setDaysFromCalendar: (days: number) => {
        const { isCalculatorVisible, fetchDiscountTiers, _calculateDurationDiscount } = get();

        if (!isCalculatorVisible && days >= 4) {
            void fetchDiscountTiers();
        }
        if (get().durationDiscountTiers.length > 0) {
            _calculateDurationDiscount(days);
        }
        if (days >= 4) {
            set({ isCalculatorVisible: true });
        }
    },

    setDaysFromSlider: (days: number) => {
        const dateStore = useDateStore.getState();
        const { holidays } = useHolidayStore.getState();

        // --- –ò–ó–ú–ï–ù–ï–ù–ò–ï –ó–î–ï–°–¨ ---
        // –¢–µ–ø–µ—Ä—å —ç—Ç–∞ —Ñ—É–Ω–∫—Ü–∏—è —Ç–æ–ª—å–∫–æ –ø–µ—Ä–µ–¥–∞–µ—Ç –¥–∞–Ω–Ω—ã–µ –≤ dateStore
        // –∏ –±–æ–ª—å—à–µ –Ω–µ –≤—ã–∑—ã–≤–∞–µ—Ç —Ä–∞—Å—á–µ—Ç —Å–∫–∏–¥–∫–∏ –Ω–∞–ø—Ä—è–º—É—é.
        dateStore.setDayCount(days, holidays);
        // -------------------------

        if (days >= 4) set({ isCalculatorVisible: true });
    },

    toggleCalculator: () => {
        const alreadyVisible = get().isCalculatorVisible;
        if (!alreadyVisible) void get().fetchDiscountTiers();
        set({ isCalculatorVisible: !alreadyVisible });
    },

    refreshCalculator: () => {
        const { dayCount } = useDateStore.getState();
        const { _calculateDurationDiscount } = get();

        if (get().durationDiscountTiers.length > 0 && dayCount > 0) {
            _calculateDurationDiscount(dayCount);
        }
    },
}));

```


## <a name="rentalappmainsrcstoresearchStorets"></a>`rental-app-main/src/store/searchStore.ts`

```typescript
// path: rental-app-main/src/store/searchStore.ts

import { create } from "zustand"

interface SearchState {
  query: string
  setQuery: (value: string) => void
}

export const useSearchStore = create<SearchState>((set) => ({
  query: "",
  setQuery: (value) => set({ query: value })
}))


```


## <a name="rentalappmainsrcstoreviewModeStorets"></a>`rental-app-main/src/store/viewModeStore.ts`

```typescript
// path: rental-app-main/src/store/viewModeStore.ts

// src/store/viewModeStore.ts

import { create } from "zustand";

// –ò—Å–ø–æ–ª—å–∑—É–µ–º 'default' –∏ 'compact' –¥–ª—è –µ–¥–∏–Ω–æ–æ–±—Ä–∞–∑–∏—è
export type ViewMode = 'default' | 'compact';

type ViewState = {
  viewMode: ViewMode;
  setViewMode: (mode: ViewMode) => void;
};

export const useViewModeStore = create<ViewState>((set) => ({
  viewMode: 'default', // –ò—Å—Ö–æ–¥–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ
  // –ë–æ–ª–µ–µ —è–≤–Ω—ã–π –º–µ—Ç–æ–¥ —É—Å—Ç–∞–Ω–æ–≤–∫–∏, –∫–æ—Ç–æ—Ä—ã–π –ø–æ–Ω–∞–¥–æ–±–∏—Ç—Å—è –¥–ª—è ToggleGroup
  setViewMode: (mode) => set({ viewMode: mode }),
}));

```


## <a name="rentalappmainsrctypesaccessoryts"></a>`rental-app-main/src/types/accessory.ts`

```typescript
// path: rental-app-main/src/types/accessory.ts

// src/types/accessory.ts

export interface Accessory {
    id: number;
    name: string;
    accessory_type: string;
    price: number;
    description?: string;
}

// –î–û–ë–ê–í–õ–Ø–ï–ú –≠–¢–û–¢ –ò–ù–¢–ï–†–§–ï–ô–°
export interface AccessoryListResponse {
    items: Accessory[];
    total: number;
}

```


## <a name="rentalappmainsrctypesassociationts"></a>`rental-app-main/src/types/association.ts`

```typescript
// path: rental-app-main/src/types/association.ts

// src/types/association.ts

export interface Association {
    id: number;
    name: string;
    description?: string;
    sort_order: number;
    equipment_ids: number[];
}

export type AssociationCreate = Omit<Association, 'id'>;
export type AssociationUpdate = Partial<AssociationCreate>;

// –î–û–ë–ê–í–¨–¢–ï –≠–¢–û–¢ –≠–ö–°–ü–û–†–¢
export interface AssociationListResponse {
    items: Association[];
    total: number;
}

```


## <a name="rentalappmainsrctypesavailabilityts"></a>`rental-app-main/src/types/availability.ts`

```typescript
// path: rental-app-main/src/types/availability.ts

// src/types/availability.ts

export type EquipmentStatus = "available" | "reserved" | "rented";

export interface AvailabilityInfo {
  equipment_id: number;
  status: EquipmentStatus;
  start_date?: string | null;
  end_date?: string | null;
  details: string;
}

// –î–û–ë–ê–í–¨–¢–ï –≠–¢–û–¢ –ò–ù–¢–ï–†–§–ï–ô–°
// –û–Ω –æ–ø–∏—Å—ã–≤–∞–µ—Ç —Å—Ç—Ä—É–∫—Ç—É—Ä—É –æ—Ç–≤–µ—Ç–∞ –æ—Ç /calendar/view
export interface AvailabilityListResponse {
  items: AvailabilityInfo[];
  total: number;
}


export interface ConflictDetail {
  type: 'reservation' | 'rental';
  id: number;
  user_name?: string; // –ò–º—è –∫–ª–∏–µ–Ω—Ç–∞ –≤ –∫–æ–Ω—Ñ–ª–∏–∫—Ç–µ
  start_date: string;
  end_date: string;
}

export interface EquipmentConflictInfo {
  equipment_id: number;
  conflicts: ConflictDetail[];
}

export interface DayStatus {
  status: EquipmentStatus;
  group_id: string | null;
  is_user_reservation: boolean;
}

```


## <a name="rentalappmainsrctypesbalanceHistoryts"></a>`rental-app-main/src/types/balanceHistory.ts`

```typescript
// path: rental-app-main/src/types/balanceHistory.ts

// src/types/balanceHistory.ts

export interface BalanceHistoryEntry {
    id: number;
    user_id: number;
    rental_id: number | null;
    amount: number;
    operation_type: string;
    description: string | null;
    created_at: string; // –î–∞—Ç–∞ –≤ —Ñ–æ—Ä–º–∞—Ç–µ ISO-—Å—Ç—Ä–æ–∫–∏
}

export interface BalanceHistoryListResponse {
    items: BalanceHistoryEntry[];
    total: number;
}

```


## <a name="rentalappmainsrctypesdiscountts"></a>`rental-app-main/src/types/discount.ts`

```typescript
// path: rental-app-main/src/types/discount.ts

// src/types/discount.ts

// –¢–∏–ø –¥–ª—è —Å–∫–∏–¥–∫–∏, –∫–∞–∫ –æ–Ω–∞ –ø—Ä–∏—Ö–æ–¥–∏—Ç –æ—Ç API
export interface DurationDiscount {
    id: number;
    min_days: number;
    discount_percentage: number;
}

// –¢–∏–ø –¥–ª—è –¥–∞–Ω–Ω—ã—Ö, –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º—ã—Ö –Ω–∞ API –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è —Å–∫–∏–¥–∫–∏
export type DiscountPayload = Omit<DurationDiscount, 'id'>;

// –¢–∏–ø –¥–ª—è –æ—Ç–≤–µ—Ç–∞ –æ—Ç API —Å–æ —Å–ø–∏—Å–∫–æ–º —Å–∫–∏–¥–æ–∫
export interface DiscountListResponse {
    items: DurationDiscount[];
    total: number;
}

```


## <a name="rentalappmainsrctypesequipmentts"></a>`rental-app-main/src/types/equipment.ts`

```typescript
// path: rental-app-main/src/types/equipment.ts

// src/types/equipment.ts

// ‚úÖ –î–û–ë–ê–í–õ–ï–ù –ò–ú–ü–û–†–¢
import type { Accessory } from "./accessory";

export interface Equipment {
  id: number;
  equipment_type: string;
  brand: string;
  name: string;
  serial_number?: string;
  condition: string;
  daily_rate: number;
  notes?: string;
  description?: string;
  last_maintenance?: string;
  image_url?: string;
  image_urls?: string[];
  short_description?: string;
  // ‚úÖ –î–û–ë–ê–í–õ–ï–ù–û –ü–û–õ–ï
  accessories: Accessory[];
}

```


## <a name="rentalappmainsrctypesholidayts"></a>`rental-app-main/src/types/holiday.ts`

```typescript
// path: rental-app-main/src/types/holiday.ts

// src/types/holiday.ts

// –¢–∏–ø –¥–ª—è –æ–¥–Ω–æ–≥–æ –≤—ã—Ö–æ–¥–Ω–æ–≥–æ –¥–Ω—è, –∫–∞–∫ –æ–Ω –ø—Ä–∏—Ö–æ–¥–∏—Ç –æ—Ç API
export interface Holiday {
    date: string; // –§–æ—Ä–º–∞—Ç 'YYYY-MM-DD'
    description: string | null;
    created_at: string;
    created_by_id: number;
}

// –¢–∏–ø –¥–ª—è –æ—Ç–≤–µ—Ç–∞ API —Å–æ —Å–ø–∏—Å–∫–æ–º –≤—ã—Ö–æ–¥–Ω—ã—Ö
export interface HolidayListResponse {
    items: Holiday[];
    total: number;
}

```


## <a name="rentalappmainsrctypespromocodets"></a>`rental-app-main/src/types/promo_code.ts`

```typescript
// path: rental-app-main/src/types/promo_code.ts

// src/types/promo_code.ts

// –¢–∏–ø –¥–ª—è –¥–∞–Ω–Ω—ã—Ö, –∫–æ—Ç–æ—Ä—ã–µ –º—ã –ø–æ–ª—É—á–∞–µ–º –æ—Ç API –ø—Ä–∏ –∑–∞–ø—Ä–æ—Å–µ —Å–ø–∏—Å–∫–∞ –ø—Ä–æ–º–æ–∫–æ–¥–æ–≤
export interface PromoCodeOut {
    id: number;
    code: string;
    description: string | null;
    discount_percentage: number;
    is_active: boolean;
    valid_from: string | null; // –î–∞—Ç—ã –ø—Ä–∏—Ö–æ–¥—è—Ç –∫–∞–∫ —Å—Ç—Ä–æ–∫–∏ –≤ —Ñ–æ—Ä–º–∞—Ç–µ ISO
    expires_at: string | null;
    max_uses: number | null;
    times_used: number;
    max_uses_per_user: number | null;
    min_order_amount: number | null;
    specific_to_user_id: number | null;
    applicable_to_equipment_ids: number[] | null;
    applicable_to_equipment_types: string[] | null;
    created_at: string;
    created_by_id: number;
    creator_email?: string; // –û–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ–µ –ø–æ–ª–µ –¥–ª—è —É–¥–æ–±—Å—Ç–≤–∞
}

// –¢–∏–ø –¥–ª—è –¥–∞–Ω–Ω—ã—Ö, –∫–æ—Ç–æ—Ä—ã–µ –º—ã –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º –Ω–∞ API –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –ø—Ä–æ–º–æ–∫–æ–¥–∞
// –ü–æ–ª—è, –∫–æ—Ç–æ—Ä—ã–µ –≥–µ–Ω–µ—Ä–∏—Ä—É—é—Ç—Å—è —Å–µ—Ä–≤–µ—Ä–æ–º (id, times_used, created_at –∏ —Ç.–¥.), –∑–¥–µ—Å—å –æ—Ç—Å—É—Ç—Å—Ç–≤—É—é—Ç.
export type PromoCodeCreate = Omit<PromoCodeOut, 'id' | 'times_used' | 'created_at' | 'created_by_id' | 'creator_email'>;

// –¢–∏–ø –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è. –í—Å–µ –ø–æ–ª—è –æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω—ã, —Ç–∞–∫ –∫–∞–∫ –º—ã –º–æ–∂–µ–º –æ–±–Ω–æ–≤–ª—è—Ç—å –∏—Ö –ø–æ –æ–¥–Ω–æ–º—É.
export type PromoCodeUpdate = Partial<PromoCodeCreate>;

// +++ –ù–ê–ß–ê–õ–û –ò–ó–ú–ï–ù–ï–ù–ò–ô: –î–æ–±–∞–≤—å—Ç–µ —ç—Ç–æ—Ç –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å +++
// –û–Ω –æ–ø–∏—Å—ã–≤–∞–µ—Ç —Å—Ç—Ä—É–∫—Ç—É—Ä—É –æ—Ç–≤–µ—Ç–∞ API —Å –ø–∞–≥–∏–Ω–∞—Ü–∏–µ–π
export interface PromoCodeListResponse {
    items: PromoCodeOut[];
    total: number;
}
// +++ –ö–û–ù–ï–¶ –ò–ó–ú–ï–ù–ï–ù–ò–ô +++

```


## <a name="rentalappmainsrctypesrentalts"></a>`rental-app-main/src/types/rental.ts`

```typescript
// path: rental-app-main/src/types/rental.ts

// src/types/rental.ts

import type { UserOut } from "./user";
import type { Equipment } from "./equipment";
import type { Accessory } from "./accessory";

export interface RentalAccessoryDetail {
    equipment_id: number;
    accessory: Accessory;
}

export interface RentalReturnRequest {
    actual_return_date: string; // –§–æ—Ä–º–∞—Ç 'YYYY-MM-DD'
    notes_on_return?: string;
    accessories_returned_confirmation: boolean;
}

export interface AdminRentalOut {
    id: number;
    user_id: number;
    created_by_id: number;
    reservation_id: number | null;
    start_date: string;
    end_date: string;
    actual_return_date: string | null;
    status: 'active' | 'overdue' | 'completed';
    total_cost: number;
    discount_amount: number;
    promo_code: string | null;
    final_cost: number | null;
    deposit_amount: number;
    prepayment_amount: number;
    accessories_cost: number;
    remaining_amount: number;
    notes_on_issue: string | null;
    notes_on_return: string | null;
    created_at: string;
    updated_at: string;
    user: UserOut;
    created_by: UserOut;
    equipment: Equipment[];
    // --- –ò–ó–ú–ï–ù–ï–ù–ò–ï –ó–î–ï–°–¨ ---
    accessory_links: RentalAccessoryDetail[];
    // -------------------------
    days_remaining: number | null;
    overdue_days: number | null;
    overdue_surcharge: number | null;
}

export interface AdminRentalListResponse {
    items: AdminRentalOut[];
    total: number;
}

```


## <a name="rentalappmainsrctypesreservationts"></a>`rental-app-main/src/types/reservation.ts`

```typescript
// path: rental-app-main/src/types/reservation.ts

// src/types/reservation.ts

import type { UserOut } from "./user";
import type { Accessory } from "./accessory";

export interface AccessoryLink {
    equipment_id: number;
    accessory: Accessory;
}

export interface Reservation {
    id: number;
    equipment_ids: number[];
    start_date: string;
    end_date: string;
    status: 'active' | 'fulfilled' | 'cancelled' | 'overdue';
    total_cost?: number;
    discount_amount?: number;
    promo_code?: string | null;
    selected_accessories?: Record<number, number[]>;
    accessory_links?: AccessoryLink[];
    rental_id?: number | null;
}

export interface ReservationWithNames extends Reservation {
    equipment_names: string[];
}

export interface ReservationListResponse {
    items: Reservation[];
    total: number;
}

/* // –ó–∞–∫–æ–º–º–µ–Ω—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å
export interface ReservationItem {
    id: number;
    user_id: number;
    equipment_ids: number[];
    start_date: string;
    end_date: string;
    status: 'active' | 'fulfilled' | 'cancelled' | 'overdue';
    selected_accessories?: Record<number, number[]>;
    total_cost?: number;
    discount_amount?: number;
    promo_code?: string | null;
    rental_id?: number | null;
}
*/

export interface AdminReservationOut {
    id: number;
    user_id: number;
    equipment_ids: number[];
    start_date: string;
    end_date: string;
    status: 'active' | 'fulfilled' | 'cancelled' | 'overdue';
    selected_accessories?: Record<number, number[]>;
    accessory_links?: AccessoryLink[];
    user_info: UserOut;
    total_cost?: number;
    discount_amount?: number;
    promo_code?: string | null;
    rental_id?: number | null;
}

export interface AdminReservationListResponse {
    items: AdminReservationOut[];
    total: number;
}

```


## <a name="rentalappmainsrctypesuserts"></a>`rental-app-main/src/types/user.ts`

```typescript
// path: rental-app-main/src/types/user.ts

// src/types/user.ts

import { z } from "zod";
import { USER_ROLE_VALUES, type UserRole as UserRoleType } from "@/constants/userConstants";

export type UserRole = UserRoleType;

// –°—Ö–µ–º–∞ –¥–ª—è –≤–∞–ª–∏–¥–∞—Ü–∏–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
export const userOutSchema = z.object({
    id: z.number(),
    full_name: z.string(),
    email: z.string().email(),
    role: z.enum(USER_ROLE_VALUES),
    is_active: z.boolean().nullable().transform((val) => val ?? false),
    phone: z.string().nullable().optional(),
    status: z.string().nullable().optional(),
    balance: z.number().optional(),
    notes: z.string().nullable().optional(),
    privacy_policy_accepted: z.boolean(),
    terms_accepted: z.boolean(),
    email_verified: z.boolean(),
    created_at: z.string().datetime(),
});

// –¢–∏–ø, –∫–æ—Ç–æ—Ä—ã–π –ø–æ–ª—É—á–∞–µ—Ç—Å—è –∏–∑ —Å—Ö–µ–º—ã
export type UserOut = z.infer<typeof userOutSchema>;

// +++ –î–û–ë–ê–í–¨–¢–ï –≠–¢–û–¢ –ò–ù–¢–ï–†–§–ï–ô–° +++
// –û–Ω –æ–ø–∏—Å—ã–≤–∞–µ—Ç —Å—Ç—Ä—É–∫—Ç—É—Ä—É –æ—Ç–≤–µ—Ç–∞ –æ—Ç /user/admin/users
export interface UserListResponse {
    items: UserOut[];
    total: number;
}

// +++ –ù–ê–ß–ê–õ–û: –¢–∏–ø –¥–ª—è –∑–∞–ø—Ä–æ—Å–∞ –Ω–∞ –ø–æ–ø–æ–ª–Ω–µ–Ω–∏–µ –±–∞–ª–∞–Ω—Å–∞ +++
export interface UserPaymentRequest {
    amount: number;
    payment_method: string;
    description?: string;
}
// +++ –ö–û–ù–ï–¶: –¢–∏–ø –¥–ª—è –∑–∞–ø—Ä–æ—Å–∞ +++

```


## <a name="rentalappmainsrcutilsphoneUtilsts"></a>`rental-app-main/src/utils/phoneUtils.ts`

```typescript
// path: rental-app-main/src/utils/phoneUtils.ts

// src/utils/phoneUtils.ts

/**
 * –£—Ç–∏–ª–∏—Ç—ã –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å —Ç–µ–ª–µ—Ñ–æ–Ω–Ω—ã–º–∏ –Ω–æ–º–µ—Ä–∞–º–∏
 */

// –†–µ–≥—É–ª—è—Ä–Ω—ã–µ –≤—ã—Ä–∞–∂–µ–Ω–∏—è –¥–ª—è –≤–∞–ª–∏–¥–∞—Ü–∏–∏ —Ä–∞–∑–ª–∏—á–Ω—ã—Ö —Ñ–æ—Ä–º–∞—Ç–æ–≤ —Ç–µ–ª–µ—Ñ–æ–Ω–æ–≤
export const PHONE_PATTERNS = {
    // –†–æ—Å—Å–∏–π—Å–∫–∏–π —Ñ–æ—Ä–º–∞—Ç: +7 (XXX) XXX-XX-XX
    RUSSIAN: /^\+7\s?\(?(\d{3})\)?\s?(\d{3})-?(\d{2})-?(\d{2})$/,
    // –ú–µ–∂–¥—É–Ω–∞—Ä–æ–¥–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç: +X (XXX) XXX-XXXX
    INTERNATIONAL: /^\+\d{1,3}\s?\(?(\d{3})\)?\s?(\d{3})-?(\d{4})$/,
    // –ü—Ä–æ—Å—Ç–æ–π —Ñ–æ—Ä–º–∞—Ç: —Ç–æ–ª—å–∫–æ —Ü–∏—Ñ—Ä—ã
    DIGITS_ONLY: /^\+?[\d\s\-\(\)]+$/,
} as const;

/**
 * –í–∞–ª–∏–¥–∏—Ä—É–µ—Ç —Ä–æ—Å—Å–∏–π—Å–∫–∏–π –Ω–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞
 */
export function validateRussianPhone(phone: string): boolean {
    if (!phone) return false;

    // –£–¥–∞–ª—è–µ–º –≤—Å—ë, —á—Ç–æ –Ω–µ —è–≤–ª—è–µ—Ç—Å—è —Ü–∏—Ñ—Ä–æ–π
    const cleanPhone = phone.replace(/[^\d]/g, '');

    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –Ω–æ–º–µ—Ä –Ω–∞—á–∏–Ω–∞–µ—Ç—Å—è —Å 7 –∏–ª–∏ 8 –∏ –∏–º–µ–µ—Ç 11 —Ü–∏—Ñ—Ä
    if (!/^[78]\d{10}$/.test(cleanPhone)) {
        return false;
    }

    return true;
}

/**
 * –í–∞–ª–∏–¥–∏—Ä—É–µ—Ç –º–µ–∂–¥—É–Ω–∞—Ä–æ–¥–Ω—ã–π –Ω–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞
 */
export function validateInternationalPhone(phone: string): boolean {
    if (!phone) return false;
    
    // –£–±–∏—Ä–∞–µ–º –≤—Å–µ –ø—Ä–æ–±–µ–ª—ã –∏ –¥–µ—Ñ–∏—Å—ã –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏
    const cleanPhone = phone.replace(/[\s\-\(\)]/g, '');
    
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –Ω–æ–º–µ—Ä –Ω–∞—á–∏–Ω–∞–µ—Ç—Å—è —Å + –∏ –∏–º–µ–µ—Ç –æ—Ç 7 –¥–æ 15 —Ü–∏—Ñ—Ä
    if (!/^\+\d{7,15}$/.test(cleanPhone)) {
        return false;
    }
    
    return true;
}

/**
 * –ù–æ—Ä–º–∞–ª–∏–∑—É–µ—Ç –Ω–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞ –∫ —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–æ–º—É —Ñ–æ—Ä–º–∞—Ç—É
 */
export function normalizePhone(phone: string, format: 'russian' | 'international' = 'russian'): string {
    if (!phone) return '';
    
    // –£–±–∏—Ä–∞–µ–º –≤—Å–µ —Å–∏–º–≤–æ–ª—ã –∫—Ä–æ–º–µ —Ü–∏—Ñ—Ä –∏ +
    const cleanPhone = phone.replace(/[^\d+]/g, '');
    
    if (format === 'russian') {
        // –î–ª—è —Ä–æ—Å—Å–∏–π—Å–∫–∏—Ö –Ω–æ–º–µ—Ä–æ–≤
        if (cleanPhone.startsWith('8')) {
            return cleanPhone.replace(/^8/, '+7');
        }
        if (cleanPhone.startsWith('7')) {
            return '+' + cleanPhone;
        }
        if (cleanPhone.startsWith('+7')) {
            return cleanPhone;
        }
        // –ï—Å–ª–∏ –Ω–æ–º–µ—Ä –Ω–∞—á–∏–Ω–∞–µ—Ç—Å—è —Å 9, –¥–æ–±–∞–≤–ª—è–µ–º +7
        if (cleanPhone.startsWith('9') && cleanPhone.length === 10) {
            return '+7' + cleanPhone;
        }
    }
    
    return cleanPhone;
}

/**
 * –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ—Ç –Ω–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞ –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è
 */
export function formatPhone(phone: string, format: 'russian' | 'international' = 'russian'): string {
    if (!phone) return '';
    
    const normalized = normalizePhone(phone, format);
    
    if (format === 'russian') {
        // –§–æ—Ä–º–∞—Ç: +7 (XXX) XXX-XX-XX
        const match = normalized.match(/^\+7(\d{3})(\d{3})(\d{2})(\d{2})$/);
        if (match) {
            return `+7 (${match[1]}) ${match[2]}-${match[3]}-${match[4]}`;
        }
    } else {
        // –§–æ—Ä–º–∞—Ç: +X (XXX) XXX-XXXX
        const match = normalized.match(/^\+(\d{1,3})(\d{3})(\d{3})(\d{4})$/);
        if (match) {
            return `+${match[1]} (${match[2]}) ${match[3]}-${match[4]}`;
        }
    }
    
    return normalized;
}

/**
 * –ò–∑–≤–ª–µ–∫–∞–µ—Ç —Ç–æ–ª—å–∫–æ —Ü–∏—Ñ—Ä—ã –∏–∑ –Ω–æ–º–µ—Ä–∞ —Ç–µ–ª–µ—Ñ–æ–Ω–∞
 */
export function extractDigits(phone: string): string {
    if (!phone) return '';
    return phone.replace(/\D/g, '');
}

/**
 * –ü—Ä–æ–≤–µ—Ä—è–µ—Ç, —è–≤–ª—è–µ—Ç—Å—è –ª–∏ –Ω–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞ –ø–æ–ª–Ω—ã–º
 */
export function isPhoneComplete(phone: string, format: 'russian' | 'international' = 'russian'): boolean {
    if (!phone) return false;
    
    const digits = extractDigits(phone);
    
    if (format === 'russian') {
        // –†–æ—Å—Å–∏–π—Å–∫–∏–π –Ω–æ–º–µ—Ä –¥–æ–ª–∂–µ–Ω –∏–º–µ—Ç—å 11 —Ü–∏—Ñ—Ä (—Å –∫–æ–¥–æ–º —Å—Ç—Ä–∞–Ω—ã)
        return digits.length === 11 && digits.startsWith('7');
    } else {
        // –ú–µ–∂–¥—É–Ω–∞—Ä–æ–¥–Ω—ã–π –Ω–æ–º–µ—Ä –¥–æ–ª–∂–µ–Ω –∏–º–µ—Ç—å –æ—Ç 7 –¥–æ 15 —Ü–∏—Ñ—Ä
        return digits.length >= 7 && digits.length <= 15;
    }
}

/**
 * –ü–æ–ª—É—á–∞–µ—Ç –∫–æ–¥ —Å—Ç—Ä–∞–Ω—ã –∏–∑ –Ω–æ–º–µ—Ä–∞ —Ç–µ–ª–µ—Ñ–æ–Ω–∞
 */
export function getCountryCode(phone: string): string | null {
    if (!phone) return null;
    
    const normalized = normalizePhone(phone, 'international');
    const match = normalized.match(/^\+(\d{1,3})/);
    
    return match ? match[1] : null;
}

/**
 * –ü—Ä–æ–≤–µ—Ä—è–µ—Ç, —è–≤–ª—è–µ—Ç—Å—è –ª–∏ –Ω–æ–º–µ—Ä —Ä–æ—Å—Å–∏–π—Å–∫–∏–º
 */
export function isRussianPhone(phone: string): boolean {
    if (!phone) return false;
    
    const countryCode = getCountryCode(phone);
    return countryCode === '7';
} 

```


## <a name="rentalappmainsrcviteenvdts"></a>`rental-app-main/src/vite-env.d.ts`

```typescript
// path: rental-app-main/src/vite-env.d.ts

/// <reference types="vite/client" />


```


## <a name="rentalappmaintailwindconfigjs"></a>`rental-app-main/tailwind.config.js`

```javascript
// path: rental-app-main/tailwind.config.js

/** @type {import('tailwindcss').Config} */
export default {
	darkMode: ["class"],
	content: [
		"./index.html",
		"./src/**/*.{js,ts,jsx,tsx,css}",
	],
	theme: {
		extend: {
			borderRadius: {
				lg: 'var(--radius)',
				md: 'calc(var(--radius) - 2px)',
				sm: 'calc(var(--radius) - 4px)'
			},
			colors: {
				background: 'hsl(var(--background))',
				foreground: 'hsl(var(--foreground))',
				card: {
					DEFAULT: 'hsl(var(--card))',
					foreground: 'hsl(var(--card-foreground))'
				},
				popover: {
					DEFAULT: 'hsl(var(--popover))',
					foreground: 'hsl(var(--popover-foreground))'
				},
				primary: {
					DEFAULT: 'hsl(var(--primary))',
					foreground: 'hsl(var(--primary-foreground))'
				},
				secondary: {
					DEFAULT: 'hsl(var(--secondary))',
					foreground: 'hsl(var(--secondary-foreground))'
				},
				muted: {
					DEFAULT: 'hsl(var(--muted))',
					foreground: 'hsl(var(--muted-foreground))'
				},
				accent: {
					DEFAULT: 'hsl(var(--accent))',
					foreground: 'hsl(var(--accent-foreground))'
				},
				destructive: {
					DEFAULT: 'hsl(var(--destructive))',
					foreground: 'hsl(var(--destructive-foreground))'
				},
				border: 'hsl(var(--border))',
				input: 'hsl(var(--input))',
				ring: 'hsl(var(--ring))',
				chart: {
					'1': 'hsl(var(--chart-1))',
					'2': 'hsl(var(--chart-2))',
					'3': 'hsl(var(--chart-3))',
					'4': 'hsl(var(--chart-4))',
					'5': 'hsl(var(--chart-5))'
				}
			}
		}
	},
	plugins: [
		require('tailwindcss-animate'),
		require('@tailwindcss/typography'),
	],
}

```


## <a name="rentalappmaintestslidersyncmd"></a>`rental-app-main/test_slider_sync.md`

```markdown
// path: rental-app-main/test_slider_sync.md

# –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏ –ø–æ–ª–∑—É–Ω–∫–∞ —Å –∫–∞–ª–µ–Ω–¥–∞—Ä–µ–º

## –û–ø–∏—Å–∞–Ω–∏–µ —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç–∏

–†–µ–∞–ª–∏–∑–æ–≤–∞–Ω–∞ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –º–µ–∂–¥—É —É–º–Ω—ã–º –∫–∞–ª—å–∫—É–ª—è—Ç–æ—Ä–æ–º —Å–∫–∏–¥–æ–∫ –∏ –≤–∏–¥–∂–µ—Ç–æ–º –∫–∞–ª–µ–Ω–¥–∞—Ä—è –Ω–∞ –≥–ª–∞–≤–Ω–æ–π —Å—Ç—Ä–∞–Ω–∏—Ü–µ:

### –ö–∞–∫ —ç—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç:

1. **–ò–∑–º–µ–Ω–µ–Ω–∏–µ –¥–∞—Ç –≤ –∫–∞–ª–µ–Ω–¥–∞—Ä–µ** ‚Üí –æ–±–Ω–æ–≤–ª—è–µ—Ç—Å—è –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –¥–Ω–µ–π –≤ –∫–∞–ª—å–∫—É–ª—è—Ç–æ—Ä–µ
2. **–ò–∑–º–µ–Ω–µ–Ω–∏–µ –ø–æ–ª–∑—É–Ω–∫–∞ –≤ –∫–∞–ª—å–∫—É–ª—è—Ç–æ—Ä–µ** ‚Üí –æ–±–Ω–æ–≤–ª—è–µ—Ç—Å—è –¥–∞—Ç–∞ –æ–∫–æ–Ω—á–∞–Ω–∏—è –≤ –∫–∞–ª–µ–Ω–¥–∞—Ä–µ

### –ü—Ä–∏–º–µ—Ä –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è:

1. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤—ã–±–∏—Ä–∞–µ—Ç –¥–∞—Ç—ã —Å 20.08 –ø–æ 22.08 (2 –¥–Ω—è)
2. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –¥–≤–∏–≥–∞–µ—Ç –ø–æ–ª–∑—É–Ω–æ–∫ –≤ —É–º–Ω–æ–º –∫–∞–ª—å–∫—É–ª—è—Ç–æ—Ä–µ —Å–∫–∏–¥–æ–∫ –Ω–∞ 4 –¥–Ω—è
3. –î–∞—Ç–∞ –æ–∫–æ–Ω—á–∞–Ω–∏—è –∞—Ä–µ–Ω–¥—ã –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç—Å—è –Ω–∞ 24.08

## –†–µ–∞–ª–∏–∑–æ–≤–∞–Ω–Ω—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è:

### 1. –û–±–Ω–æ–≤–ª–µ–Ω `src/store/discountStore.ts`:
- –î–æ–±–∞–≤–ª–µ–Ω –º–µ—Ç–æ–¥ `setDaysFromSlider()` –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –¥–∞—Ç –∏–∑ –ø–æ–ª–∑—É–Ω–∫–∞
- –ò–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω–∞ —Ñ—É–Ω–∫—Ü–∏—è `addDays` –∏–∑ date-fns

### 2. –û–±–Ω–æ–≤–ª–µ–Ω `src/components/DiscountCalculator.tsx`:
- –ò–∑–º–µ–Ω–µ–Ω `handleSliderChange` –¥–ª—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è `setDaysFromSlider` –≤–º–µ—Å—Ç–æ `setDays`

### 3. –û–±–Ω–æ–≤–ª–µ–Ω `src/store/dateStore.ts`:
- –î–æ–±–∞–≤–ª–µ–Ω –ø–∞—Ä–∞–º–µ—Ç—Ä `source` –≤ `setRange` –¥–ª—è –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è –∏—Å—Ç–æ—á–Ω–∏–∫–∞ –∏–∑–º–µ–Ω–µ–Ω–∏–π

### 4. –û–±–Ω–æ–≤–ª–µ–Ω `src/components/DateRangeSelector.tsx`:
- –î–æ–±–∞–≤–ª–µ–Ω–∞ –ª–æ–≥–∏–∫–∞ –¥–ª—è –∏–≥–Ω–æ—Ä–∏—Ä–æ–≤–∞–Ω–∏—è –∏–∑–º–µ–Ω–µ–Ω–∏–π –æ—Ç –ø–æ–ª–∑—É–Ω–∫–∞
- –î–æ–±–∞–≤–ª–µ–Ω `useRef` –¥–ª—è –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è –∏—Å—Ç–æ—á–Ω–∏–∫–∞ –∏–∑–º–µ–Ω–µ–Ω–∏–π

### 5. –û–±–Ω–æ–≤–ª–µ–Ω `src/hooks/useDateRange.ts`:
- –û–±–Ω–æ–≤–ª–µ–Ω –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å –¥–ª—è –ø–æ–¥–¥–µ—Ä–∂–∫–∏ –∏—Å—Ç–æ—á–Ω–∏–∫–∞ –∏–∑–º–µ–Ω–µ–Ω–∏–π

### 6. –û–±–Ω–æ–≤–ª–µ–Ω—ã —Å–≤—è–∑–∞–Ω–Ω—ã–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã:
- `EditableDateRange.tsx`
- `CalendarDateInputRange.tsx`
- `useReservationState.ts`
- `EditableReservationCard.tsx`

## –õ–æ–≥–∏–∫–∞ –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏—è —Ü–∏–∫–ª–∏—á–µ—Å–∫–∏—Ö –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π:

1. –ö–æ–≥–¥–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –¥–≤–∏–≥–∞–µ—Ç –ø–æ–ª–∑—É–Ω–æ–∫ ‚Üí –≤—ã–∑—ã–≤–∞–µ—Ç—Å—è `setDaysFromSlider` ‚Üí –æ–±–Ω–æ–≤–ª—è–µ—Ç—Å—è –¥–∞—Ç–∞ —Å –∏—Å—Ç–æ—á–Ω–∏–∫–æ–º 'slider'
2. `DateRangeSelector` –ø—Ä–æ–≤–µ—Ä—è–µ—Ç –∏—Å—Ç–æ—á–Ω–∏–∫ –∏–∑–º–µ–Ω–µ–Ω–∏–π –∏ –∏–≥–Ω–æ—Ä–∏—Ä—É–µ—Ç –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –æ—Ç 'slider'
3. –≠—Ç–æ –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ—Ç —Ü–∏–∫–ª–∏—á–µ—Å–∫–∏–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –º–µ–∂–¥—É –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–∞–º–∏

## –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ:

1. –û—Ç–∫—Ä–æ–π—Ç–µ –≥–ª–∞–≤–Ω—É—é —Å—Ç—Ä–∞–Ω–∏—Ü—É
2. –í—ã–±–µ—Ä–∏—Ç–µ –¥–∞—Ç—ã –≤ –∫–∞–ª–µ–Ω–¥–∞—Ä–µ (–Ω–∞–ø—Ä–∏–º–µ—Ä, 20.08 - 22.08)
3. –î–≤–∏–≥–∞–π—Ç–µ –ø–æ–ª–∑—É–Ω–æ–∫ –≤ –∫–∞–ª—å–∫—É–ª—è—Ç–æ—Ä–µ —Å–∫–∏–¥–æ–∫
4. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ, —á—Ç–æ –¥–∞—Ç–∞ –æ–∫–æ–Ω—á–∞–Ω–∏—è –≤ –∫–∞–ª–µ–Ω–¥–∞—Ä–µ –æ–±–Ω–æ–≤–ª—è–µ—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏
5. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ, —á—Ç–æ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –¥–Ω–µ–π –≤ –∫–∞–ª—å–∫—É–ª—è—Ç–æ—Ä–µ –æ–±–Ω–æ–≤–ª—è–µ—Ç—Å—è –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ –¥–∞—Ç –≤ –∫–∞–ª–µ–Ω–¥–∞—Ä–µ 

```


## <a name="rentalappmaintsconfigappjson"></a>`rental-app-main/tsconfig.app.json`

```json
// path: rental-app-main/tsconfig.app.json

{
  "compilerOptions": {
    "tsBuildInfoFile": "./node_modules/.tmp/tsconfig.app.tsbuildinfo",
    "target": "ES2020",
    "useDefineForClassFields": true,
    "lib": ["ES2020", "DOM", "DOM.Iterable"],
    "module": "ESNext",
    "skipLibCheck": true,

    /* Bundler mode */
    "moduleResolution": "bundler",
    "allowImportingTsExtensions": true,
    "verbatimModuleSyntax": true,
    "moduleDetection": "force",
    "noEmit": true,
    "jsx": "react-jsx",

    /* Linting */
    "strict": true,
    "noUnusedLocals": true,
    "noUnusedParameters": true,
    "erasableSyntaxOnly": true,
    "noFallthroughCasesInSwitch": true,
    "noUncheckedSideEffectImports": true,

    /* ‚úÖ –î–æ–±–∞–≤–ª—è–µ–º –¥–ª—è alias */
    "baseUrl": ".",
    "paths": {
      "@/*": ["src/*"]
    }
  },
  "include": ["src"]
}


```


## <a name="rentalappmaintsconfigjson"></a>`rental-app-main/tsconfig.json`

```json
// path: rental-app-main/tsconfig.json

{
  "compilerOptions": {
    "target": "ESNext",
    "useDefineForClassFields": true,
    "module": "ESNext",
    "moduleResolution": "bundler",
    "strict": true,
    "jsx": "react-jsx",

    // ‚úÖ –¥–æ–±–∞–≤–ª—è–µ–º
    "baseUrl": ".",
    "paths": {
      "@/*": ["src/*"]
    },
    "allowSyntheticDefaultImports": true
  },
  "include": ["src"]
}


```


## <a name="rentalappmaintsconfignodejson"></a>`rental-app-main/tsconfig.node.json`

```json
// path: rental-app-main/tsconfig.node.json

{
  "compilerOptions": {
    "tsBuildInfoFile": "./node_modules/.tmp/tsconfig.node.tsbuildinfo",
    "target": "ES2022",
    "lib": ["ES2023"],
    "module": "ESNext",
    "skipLibCheck": true,

    /* Bundler mode */
    "moduleResolution": "bundler",
    "types": ["node"],
    "allowImportingTsExtensions": true,
    "verbatimModuleSyntax": true,
    "moduleDetection": "force",
    "noEmit": true,

    /* Linting */
    "strict": true,
    "noUnusedLocals": true,
    "noUnusedParameters": true,
    "erasableSyntaxOnly": true,
    "noFallthroughCasesInSwitch": true,
    "noUncheckedSideEffectImports": true
  },
  "include": ["vite.config.ts"]
}


```


## <a name="rentalappmainviteconfigts"></a>`rental-app-main/vite.config.ts`

```typescript
// path: rental-app-main/vite.config.ts

import { defineConfig } from 'vite'
import react from '@vitejs/plugin-react'
import { fileURLToPath, URL } from 'url' // –ò–º–ø–æ—Ä—Ç–∏—Ä—É–µ–º —É—Ç–∏–ª–∏—Ç—ã –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –ø—É—Ç—è–º–∏

export default defineConfig({
  plugins: [react()],

  server: {
    port: 5173,
    strictPort: true,
  },

  resolve: {
    alias: {
      // –ò—Å–ø–æ–ª—å–∑—É–µ–º —Å–æ–≤—Ä–µ–º–µ–Ω–Ω—ã–π —Å–ø–æ—Å–æ–± –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è alias
      "@": fileURLToPath(new URL('./src', import.meta.url))
    }
  }
})

```


## üì¶ –ó–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –ø—Ä–æ–µ–∫—Ç–∞

### Frontend (package.json)

- `@fullcalendar/core`: ^6.1.17
- `@fullcalendar/daygrid`: ^6.1.17
- `@fullcalendar/interaction`: ^6.1.17
- `@fullcalendar/react`: ^6.1.17
- `@fullcalendar/resource-timeline`: ^6.1.17
- `@hookform/resolvers`: ^5.0.1
- `@radix-ui/react-checkbox`: ^1.3.1
- `@radix-ui/react-dialog`: ^1.1.14
- `@radix-ui/react-label`: ^2.1.6
- `@radix-ui/react-popover`: ^1.1.14
- `@radix-ui/react-scroll-area`: ^1.2.9
- `@radix-ui/react-select`: ^2.2.4
- `@radix-ui/react-slot`: ^1.2.2
- `@radix-ui/react-switch`: ^1.2.5
- `@radix-ui/react-toggle`: ^1.1.8
- `@radix-ui/react-toggle-group`: ^1.1.9
- `@tanstack/react-query`: ^5.76.1
- `@tanstack/react-query-devtools`: ^5.76.1
- `@types/react-input-mask`: ^3.0.6
- `@uiw/react-md-editor`: ^4.0.7
- `axios`: ^1.9.0
- `class-variance-authority`: ^0.7.1
- `clsx`: ^2.1.1
- `cmdk`: ^1.1.1
- `date-fns`: ^4.1.0
- `lucide-react`: ^0.511.0
- `react`: ^19.1.0
- `react-day-picker`: ^9.7.0
- `react-dom`: ^19.1.0
- `react-error-boundary`: ^6.0.0
- `react-hook-form`: ^7.56.4
- `react-imask`: ^7.6.1
- `react-markdown`: ^10.1.0
- `react-router-dom`: ^7.6.0
- `rehype-sanitize`: ^6.0.0
- `sonner`: ^2.0.3
- `tailwind-merge`: ^3.3.0
- `tailwindcss-animate`: ^1.0.7
- `zod`: ^3.25.28
- `zustand`: ^5.0.4

#### Dev-–∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏
- `@eslint/js`: ^9.25.0
- `@tailwindcss/typography`: ^0.5.16
- `@types/mocha`: ^10.0.10
- `@types/node`: ^24.0.10
- `@types/react`: ^19.1.2
- `@types/react-dom`: ^19.1.2
- `@vitejs/plugin-react`: ^4.4.1
- `autoprefixer`: ^10.4.15
- `eslint`: ^9.25.0
- `eslint-plugin-react-hooks`: ^5.2.0
- `eslint-plugin-react-refresh`: ^0.4.19
- `globals`: ^16.0.0
- `postcss`: ^8.4.38
- `tailwindcss`: ^3.4.1
- `typescript`: ~5.8.3
- `typescript-eslint`: ^8.30.1
- `vite`: ^6.3.5

### Backend (requirements.txt)

```txt


## –û—à–∏–±–∫–∞ —á—Ç–µ–Ω–∏—è requirements.txt: 'utf-8' codec can't decode byte 0xff in position 0: invalid start byte
