# ğŸ¤– Ğ¡Ğ¶Ğ°Ñ‚Ñ‹Ğ¹ Ğ¸ÑÑ…Ğ¾Ğ´Ğ½Ñ‹Ğ¹ ĞºĞ¾Ğ´ Ğ¿Ñ€Ğ¾ĞµĞºÑ‚Ğ° Ğ´Ğ»Ñ AI-Ğ¿Ğ¾Ğ¼Ğ¾Ñ‰Ğ½Ğ¸ĞºĞ°

## ğŸ”— Ğ‘Ñ‹ÑÑ‚Ñ€Ğ°Ñ Ğ½Ğ°Ğ²Ğ¸Ğ³Ğ°Ñ†Ğ¸Ñ Ğ¿Ğ¾ Ñ„Ğ°Ğ¹Ğ»Ğ°Ğ¼
- [RentalApp_FASTAPI/Dockerfile.backend](#RentalAppFASTAPIDockerfilebackend)
- [RentalApp_FASTAPI/api/__init__.py](#RentalAppFASTAPIapiinitpy)
- [RentalApp_FASTAPI/api/accessory_api.py](#RentalAppFASTAPIapiaccessoryapipy)
- [RentalApp_FASTAPI/api/admin_dashboard_api.py](#RentalAppFASTAPIapiadmindashboardapipy)
- [RentalApp_FASTAPI/api/admin_rental_api.py](#RentalAppFASTAPIapiadminrentalapipy)
- [RentalApp_FASTAPI/api/admin_reservation_api.py](#RentalAppFASTAPIapiadminreservationapipy)
- [RentalApp_FASTAPI/api/association_api.py](#RentalAppFASTAPIapiassociationapipy)
- [RentalApp_FASTAPI/api/auth_api.py](#RentalAppFASTAPIapiauthapipy)
- [RentalApp_FASTAPI/api/calendar_api.py](#RentalAppFASTAPIapicalendarapipy)
- [RentalApp_FASTAPI/api/database.py](#RentalAppFASTAPIapidatabasepy)
- [RentalApp_FASTAPI/api/deps.py](#RentalAppFASTAPIapidepspy)
- [RentalApp_FASTAPI/api/discount_api.py](#RentalAppFASTAPIapidiscountapipy)
- [RentalApp_FASTAPI/api/equipment_api.py](#RentalAppFASTAPIapiequipmentapipy)
- [RentalApp_FASTAPI/api/holiday_api.py](#RentalAppFASTAPIapiholidayapipy)
- [RentalApp_FASTAPI/api/init_models.py](#RentalAppFASTAPIapiinitmodelspy)
- [RentalApp_FASTAPI/api/main_api.py](#RentalAppFASTAPIapimainapipy)
- [RentalApp_FASTAPI/api/models/__init__.py](#RentalAppFASTAPIapimodelsinitpy)
- [RentalApp_FASTAPI/api/models/accessory.py](#RentalAppFASTAPIapimodelsaccessorypy)
- [RentalApp_FASTAPI/api/models/association.py](#RentalAppFASTAPIapimodelsassociationpy)
- [RentalApp_FASTAPI/api/models/balance_history.py](#RentalAppFASTAPIapimodelsbalancehistorypy)
- [RentalApp_FASTAPI/api/models/discount.py](#RentalAppFASTAPIapimodelsdiscountpy)
- [RentalApp_FASTAPI/api/models/equipment.py](#RentalAppFASTAPIapimodelsequipmentpy)
- [RentalApp_FASTAPI/api/models/holiday.py](#RentalAppFASTAPIapimodelsholidaypy)
- [RentalApp_FASTAPI/api/models/payment.py](#RentalAppFASTAPIapimodelspaymentpy)
- [RentalApp_FASTAPI/api/models/promo_code.py](#RentalAppFASTAPIapimodelspromocodepy)
- [RentalApp_FASTAPI/api/models/rental.py](#RentalAppFASTAPIapimodelsrentalpy)
- [RentalApp_FASTAPI/api/models/reservation.py](#RentalAppFASTAPIapimodelsreservationpy)
- [RentalApp_FASTAPI/api/models/user.py](#RentalAppFASTAPIapimodelsuserpy)
- [RentalApp_FASTAPI/api/permissions.py](#RentalAppFASTAPIapipermissionspy)
- [RentalApp_FASTAPI/api/promo_code_api.py](#RentalAppFASTAPIapipromocodeapipy)
- [RentalApp_FASTAPI/api/reservation_api.py](#RentalAppFASTAPIapireservationapipy)
- [RentalApp_FASTAPI/api/router.py](#RentalAppFASTAPIapirouterpy)
- [RentalApp_FASTAPI/api/services/.pytest_cache/README.md](#RentalAppFASTAPIapiservicespytestcacheREADMEmd)
- [RentalApp_FASTAPI/api/services/auth_service.py](#RentalAppFASTAPIapiservicesauthservicepy)
- [RentalApp_FASTAPI/api/services/availability/__init__.py](#RentalAppFASTAPIapiservicesavailabilityinitpy)
- [RentalApp_FASTAPI/api/services/availability/availability_service.py](#RentalAppFASTAPIapiservicesavailabilityavailabilityservicepy)
- [RentalApp_FASTAPI/api/services/availability/base.py](#RentalAppFASTAPIapiservicesavailabilitybasepy)
- [RentalApp_FASTAPI/api/services/availability/calendar.py](#RentalAppFASTAPIapiservicesavailabilitycalendarpy)
- [RentalApp_FASTAPI/api/services/availability/conflicts.py](#RentalAppFASTAPIapiservicesavailabilityconflictspy)
- [RentalApp_FASTAPI/api/services/availability/queries.py](#RentalAppFASTAPIapiservicesavailabilityqueriespy)
- [RentalApp_FASTAPI/api/services/availability/statuses.py](#RentalAppFASTAPIapiservicesavailabilitystatusespy)
- [RentalApp_FASTAPI/api/services/balance_service.py](#RentalAppFASTAPIapiservicesbalanceservicepy)
- [RentalApp_FASTAPI/api/services/dashboard/README.md](#RentalAppFASTAPIapiservicesdashboardREADMEmd)
- [RentalApp_FASTAPI/api/services/dashboard/__init__.py](#RentalAppFASTAPIapiservicesdashboardinitpy)
- [RentalApp_FASTAPI/api/services/dashboard/activity_service.py](#RentalAppFASTAPIapiservicesdashboardactivityservicepy)
- [RentalApp_FASTAPI/api/services/dashboard/base.py](#RentalAppFASTAPIapiservicesdashboardbasepy)
- [RentalApp_FASTAPI/api/services/dashboard/dashboard_service.py](#RentalAppFASTAPIapiservicesdashboarddashboardservicepy)
- [RentalApp_FASTAPI/api/services/dashboard/equipment_service.py](#RentalAppFASTAPIapiservicesdashboardequipmentservicepy)
- [RentalApp_FASTAPI/api/services/dashboard/focus_service.py](#RentalAppFASTAPIapiservicesdashboardfocusservicepy)
- [RentalApp_FASTAPI/api/services/dashboard/kpi_service.py](#RentalAppFASTAPIapiservicesdashboardkpiservicepy)
- [RentalApp_FASTAPI/api/services/dashboard_service.py](#RentalAppFASTAPIapiservicesdashboardservicepy)
- [RentalApp_FASTAPI/api/services/discount_service.py](#RentalAppFASTAPIapiservicesdiscountservicepy)
- [RentalApp_FASTAPI/api/services/equipment_query_builder.py](#RentalAppFASTAPIapiservicesequipmentquerybuilderpy)
- [RentalApp_FASTAPI/api/services/equipment_service_api.py](#RentalAppFASTAPIapiservicesequipmentserviceapipy)
- [RentalApp_FASTAPI/api/services/financial_service.py](#RentalAppFASTAPIapiservicesfinancialservicepy)
- [RentalApp_FASTAPI/api/services/order/__init__.py](#RentalAppFASTAPIapiservicesorderinitpy)
- [RentalApp_FASTAPI/api/services/order/order_lifecycle_service.py](#RentalAppFASTAPIapiservicesorderorderlifecycleservicepy)
- [RentalApp_FASTAPI/api/services/order/order_query_base.py](#RentalAppFASTAPIapiservicesorderorderquerybasepy)
- [RentalApp_FASTAPI/api/services/order/order_repository.py](#RentalAppFASTAPIapiservicesorderorderrepositorypy)
- [RentalApp_FASTAPI/api/services/order/order_validator.py](#RentalAppFASTAPIapiservicesorderordervalidatorpy)
- [RentalApp_FASTAPI/api/services/promo_code/__init__.py](#RentalAppFASTAPIapiservicespromocodeinitpy)
- [RentalApp_FASTAPI/api/services/promo_code/constants.py](#RentalAppFASTAPIapiservicespromocodeconstantspy)
- [RentalApp_FASTAPI/api/services/promo_code/exceptions.py](#RentalAppFASTAPIapiservicespromocodeexceptionspy)
- [RentalApp_FASTAPI/api/services/promo_code/factory.py](#RentalAppFASTAPIapiservicespromocodefactorypy)
- [RentalApp_FASTAPI/api/services/promo_code/interfaces.py](#RentalAppFASTAPIapiservicespromocodeinterfacespy)
- [RentalApp_FASTAPI/api/services/promo_code/promo_code_business_logic.py](#RentalAppFASTAPIapiservicespromocodepromocodebusinesslogicpy)
- [RentalApp_FASTAPI/api/services/promo_code/promo_code_manager.py](#RentalAppFASTAPIapiservicespromocodepromocodemanagerpy)
- [RentalApp_FASTAPI/api/services/promo_code/promo_code_validator.py](#RentalAppFASTAPIapiservicespromocodepromocodevalidatorpy)
- [RentalApp_FASTAPI/api/services/promo_code_service.py](#RentalAppFASTAPIapiservicespromocodeservicepy)
- [RentalApp_FASTAPI/api/services/rental/__init__.py](#RentalAppFASTAPIapiservicesrentalinitpy)
- [RentalApp_FASTAPI/api/services/rental/rental_query_service.py](#RentalAppFASTAPIapiservicesrentalrentalqueryservicepy)
- [RentalApp_FASTAPI/api/services/reservation_query_service.py](#RentalAppFASTAPIapiservicesreservationqueryservicepy)
- [RentalApp_FASTAPI/api/services/user_service.py](#RentalAppFASTAPIapiservicesuserservicepy)
- [RentalApp_FASTAPI/api/user_api.py](#RentalAppFASTAPIapiuserapipy)
- [RentalApp_FASTAPI/config/__init__.py](#RentalAppFASTAPIconfiginitpy)
- [RentalApp_FASTAPI/config/logging_config.py](#RentalAppFASTAPIconfigloggingconfigpy)
- [RentalApp_FASTAPI/config/secrets.py](#RentalAppFASTAPIconfigsecretspy)
- [RentalApp_FASTAPI/config/settings.py](#RentalAppFASTAPIconfigsettingspy)
- [RentalApp_FASTAPI/create_admin.py](#RentalAppFASTAPIcreateadminpy)
- [RentalApp_FASTAPI/db/init_db.py](#RentalAppFASTAPIdbinitdbpy)
- [RentalApp_FASTAPI/migrations/env.py](#RentalAppFASTAPImigrationsenvpy)
- [RentalApp_FASTAPI/migrations/versions/9290ae79b0d3_create_initial_tables.py](#RentalAppFASTAPImigrationsversions9290ae79b0d3createinitialtablespy)
- [RentalApp_FASTAPI/scripts/populate_associations.py](#RentalAppFASTAPIscriptspopulateassociationspy)
- [RentalApp_FASTAPI/scripts/populate_discounts.py](#RentalAppFASTAPIscriptspopulatediscountspy)
- [RentalApp_FASTAPI/scripts/recalculate_balances.py](#RentalAppFASTAPIscriptsrecalculatebalancespy)
- [RentalApp_FASTAPI/shared/schemas/accessory_schema.py](#RentalAppFASTAPIsharedschemasaccessoryschemapy)
- [RentalApp_FASTAPI/shared/schemas/association_schema.py](#RentalAppFASTAPIsharedschemasassociationschemapy)
- [RentalApp_FASTAPI/shared/schemas/balance_history_schema.py](#RentalAppFASTAPIsharedschemasbalancehistoryschemapy)
- [RentalApp_FASTAPI/shared/schemas/calendar_schema.py](#RentalAppFASTAPIsharedschemascalendarschemapy)
- [RentalApp_FASTAPI/shared/schemas/common_financials.py](#RentalAppFASTAPIsharedschemascommonfinancialspy)
- [RentalApp_FASTAPI/shared/schemas/dashboard_schema.py](#RentalAppFASTAPIsharedschemasdashboardschemapy)
- [RentalApp_FASTAPI/shared/schemas/discount_schema.py](#RentalAppFASTAPIsharedschemasdiscountschemapy)
- [RentalApp_FASTAPI/shared/schemas/equipment_schema.py](#RentalAppFASTAPIsharedschemasequipmentschemapy)
- [RentalApp_FASTAPI/shared/schemas/holiday_schema.py](#RentalAppFASTAPIsharedschemasholidayschemapy)
- [RentalApp_FASTAPI/shared/schemas/promo_code_schema.py](#RentalAppFASTAPIsharedschemaspromocodeschemapy)
- [RentalApp_FASTAPI/shared/schemas/rental_schema.py](#RentalAppFASTAPIsharedschemasrentalschemapy)
- [RentalApp_FASTAPI/shared/schemas/reservation_schema.py](#RentalAppFASTAPIsharedschemasreservationschemapy)
- [RentalApp_FASTAPI/shared/schemas/user_schema.py](#RentalAppFASTAPIsharedschemasuserschemapy)
- [RentalApp_FASTAPI/smart_python_code_FastAPI.md](#RentalAppFASTAPIsmartpythoncodeFastAPImd)
- [RentalApp_FASTAPI/split.py](#RentalAppFASTAPIsplitpy)
- [RentalApp_FASTAPI/split_api.py](#RentalAppFASTAPIsplitapipy)
- [RentalApp_FASTAPI/split_txt.py](#RentalAppFASTAPIsplittxtpy)
- [docker-compose.yml](#dockercomposeyml)
- [rental-app-main/Dockerfile.frontend](#rentalappmainDockerfilefrontend)
- [rental-app-main/README_AI.md](#rentalappmainREADMEAImd)
- [rental-app-main/components.json](#rentalappmaincomponentsjson)
- [rental-app-main/eslint.config.js](#rentalappmaineslintconfigjs)
- [rental-app-main/nginx/nginx.conf](#rentalappmainnginxnginxconf)
- [rental-app-main/package.json](#rentalappmainpackagejson)
- [rental-app-main/postcss.config.js](#rentalappmainpostcssconfigjs)
- [rental-app-main/public/favicon.svg](#rentalappmainpublicfaviconsvg)
- [rental-app-main/public/vite.svg](#rentalappmainpublicvitesvg)
- [rental-app-main/rental_app_main/README.md](#rentalappmainrentalappmainREADMEmd)
- [rental-app-main/smart_react_code_gem_v2.md](#rentalappmainsmartreactcodegemv2md)
- [rental-app-main/split.py](#rentalappmainsplitpy)
- [rental-app-main/split_optimized.py](#rentalappmainsplitoptimizedpy)
- [rental-app-main/split_optimized_gem.py](#rentalappmainsplitoptimizedgempy)
- [rental-app-main/split_optimized_gem_NEW_1.py](#rentalappmainsplitoptimizedgemNEW1py)
- [rental-app-main/split_optimized_grok.py](#rentalappmainsplitoptimizedgrokpy)
- [rental-app-main/src/app/App.tsx](#rentalappmainsrcappApptsx)
- [rental-app-main/src/assets/react.svg](#rentalappmainsrcassetsreactsvg)
- [rental-app-main/src/components/AssociationFilter.tsx](#rentalappmainsrccomponentsAssociationFiltertsx)
- [rental-app-main/src/components/AuthForm.tsx](#rentalappmainsrccomponentsAuthFormtsx)
- [rental-app-main/src/components/AuthStatus.tsx](#rentalappmainsrccomponentsAuthStatustsx)
- [rental-app-main/src/components/AvailabilityStrip.tsx](#rentalappmainsrccomponentsAvailabilityStriptsx)
- [rental-app-main/src/components/AvailableCheckbox.tsx](#rentalappmainsrccomponentsAvailableCheckboxtsx)
- [rental-app-main/src/components/BrandFilter.tsx](#rentalappmainsrccomponentsBrandFiltertsx)
- [rental-app-main/src/components/CancelReservationDialog.tsx](#rentalappmainsrccomponentsCancelReservationDialogtsx)
- [rental-app-main/src/components/CardShell.tsx](#rentalappmainsrccomponentsCardShelltsx)
- [rental-app-main/src/components/CompactEquipmentCard.tsx](#rentalappmainsrccomponentsCompactEquipmentCardtsx)
- [rental-app-main/src/components/ConfirmItemRemovalDialog.tsx](#rentalappmainsrccomponentsConfirmItemRemovalDialogtsx)
- [rental-app-main/src/components/DateRangeSelector.tsx](#rentalappmainsrccomponentsDateRangeSelectortsx)
- [rental-app-main/src/components/DateRangeSelector/calendar.css](#rentalappmainsrccomponentsDateRangeSelectorcalendarcss)
- [rental-app-main/src/components/DiscountCalculator.tsx](#rentalappmainsrccomponentsDiscountCalculatortsx)
- [rental-app-main/src/components/EquipmentGrid.tsx](#rentalappmainsrccomponentsEquipmentGridtsx)
- [rental-app-main/src/components/ErrorBoundary.tsx](#rentalappmainsrccomponentsErrorBoundarytsx)
- [rental-app-main/src/components/ErrorMessage.tsx](#rentalappmainsrccomponentsErrorMessagetsx)
- [rental-app-main/src/components/FilterPanel.tsx](#rentalappmainsrccomponentsFilterPaneltsx)
- [rental-app-main/src/components/MyReservationList.tsx](#rentalappmainsrccomponentsMyReservationListtsx)
- [rental-app-main/src/components/NetworkStatus.tsx](#rentalappmainsrccomponentsNetworkStatustsx)
- [rental-app-main/src/components/PromoCodeInput.tsx](#rentalappmainsrccomponentsPromoCodeInputtsx)
- [rental-app-main/src/components/RequireAuth.tsx](#rentalappmainsrccomponentsRequireAuthtsx)
- [rental-app-main/src/components/ReservationCard.tsx](#rentalappmainsrccomponentsReservationCardtsx)
- [rental-app-main/src/components/ReservationFooter.tsx](#rentalappmainsrccomponentsReservationFootertsx)
- [rental-app-main/src/components/ReservationList.tsx](#rentalappmainsrccomponentsReservationListtsx)
- [rental-app-main/src/components/ReserveEquipmentCard.tsx](#rentalappmainsrccomponentsReserveEquipmentCardtsx)
- [rental-app-main/src/components/SearchInput.tsx](#rentalappmainsrccomponentsSearchInputtsx)
- [rental-app-main/src/components/StatusBadge.tsx](#rentalappmainsrccomponentsStatusBadgetsx)
- [rental-app-main/src/components/TypeFilter.tsx](#rentalappmainsrccomponentsTypeFiltertsx)
- [rental-app-main/src/components/UserInfoBlock.tsx](#rentalappmainsrccomponentsUserInfoBlocktsx)
- [rental-app-main/src/components/ViewModeToggle.tsx](#rentalappmainsrccomponentsViewModeToggletsx)
- [rental-app-main/src/components/admin/AccessoryDialogs.tsx](#rentalappmainsrccomponentsadminAccessoryDialogstsx)
- [rental-app-main/src/components/admin/AccessoryTable.tsx](#rentalappmainsrccomponentsadminAccessoryTabletsx)
- [rental-app-main/src/components/admin/AdminNavigation.tsx](#rentalappmainsrccomponentsadminAdminNavigationtsx)
- [rental-app-main/src/components/admin/AdminRentalCard.tsx](#rentalappmainsrccomponentsadminAdminRentalCardtsx)
- [rental-app-main/src/components/admin/AdminReservationCard.tsx](#rentalappmainsrccomponentsadminAdminReservationCardtsx)
- [rental-app-main/src/components/admin/AdminReservationToolbar.tsx](#rentalappmainsrccomponentsadminAdminReservationToolbartsx)
- [rental-app-main/src/components/admin/AllRentalsList.tsx](#rentalappmainsrccomponentsadminAllRentalsListtsx)
- [rental-app-main/src/components/admin/AllReservationsList.tsx](#rentalappmainsrccomponentsadminAllReservationsListtsx)
- [rental-app-main/src/components/admin/AssociationTable.tsx](#rentalappmainsrccomponentsadminAssociationTabletsx)
- [rental-app-main/src/components/admin/ConvertReservationDialog.tsx](#rentalappmainsrccomponentsadminConvertReservationDialogtsx)
- [rental-app-main/src/components/admin/CreateReservationDialog.tsx](#rentalappmainsrccomponentsadminCreateReservationDialogtsx)
- [rental-app-main/src/components/admin/CreateReservationStep1Details.tsx](#rentalappmainsrccomponentsadminCreateReservationStep1Detailstsx)
- [rental-app-main/src/components/admin/CreateReservationStep2Accessories.tsx](#rentalappmainsrccomponentsadminCreateReservationStep2Accessoriestsx)
- [rental-app-main/src/components/admin/DurationDiscountManager.tsx](#rentalappmainsrccomponentsadminDurationDiscountManagertsx)
- [rental-app-main/src/components/admin/EditableRentalCard.tsx](#rentalappmainsrccomponentsadminEditableRentalCardtsx)
- [rental-app-main/src/components/admin/EquipmentCreateDialog.tsx](#rentalappmainsrccomponentsadminEquipmentCreateDialogtsx)
- [rental-app-main/src/components/admin/EquipmentEditDialog.tsx](#rentalappmainsrccomponentsadminEquipmentEditDialogtsx)
- [rental-app-main/src/components/admin/EquipmentStats.tsx](#rentalappmainsrccomponentsadminEquipmentStatstsx)
- [rental-app-main/src/components/admin/EquipmentTable.tsx](#rentalappmainsrccomponentsadminEquipmentTabletsx)
- [rental-app-main/src/components/admin/EquipmentTableRow.tsx](#rentalappmainsrccomponentsadminEquipmentTableRowtsx)
- [rental-app-main/src/components/admin/EquipmentTableToolbar.tsx](#rentalappmainsrccomponentsadminEquipmentTableToolbartsx)
- [rental-app-main/src/components/admin/HolidayManager.tsx](#rentalappmainsrccomponentsadminHolidayManagertsx)
- [rental-app-main/src/components/admin/PromoCodeDialog.tsx](#rentalappmainsrccomponentsadminPromoCodeDialogtsx)
- [rental-app-main/src/components/admin/PromoCodeTable.tsx](#rentalappmainsrccomponentsadminPromoCodeTabletsx)
- [rental-app-main/src/components/admin/RentalStatusBadge.tsx](#rentalappmainsrccomponentsadminRentalStatusBadgetsx)
- [rental-app-main/src/components/admin/ReservationFinancialSummary.tsx](#rentalappmainsrccomponentsadminReservationFinancialSummarytsx)
- [rental-app-main/src/components/admin/ReturnAccessoriesChecklist.tsx](#rentalappmainsrccomponentsadminReturnAccessoriesChecklisttsx)
- [rental-app-main/src/components/admin/ReturnFinancials.tsx](#rentalappmainsrccomponentsadminReturnFinancialstsx)
- [rental-app-main/src/components/admin/ReturnRentalDialog.tsx](#rentalappmainsrccomponentsadminReturnRentalDialogtsx)
- [rental-app-main/src/components/admin/UserCreateDialog.tsx](#rentalappmainsrccomponentsadminUserCreateDialogtsx)
- [rental-app-main/src/components/admin/UserEditDialog.tsx](#rentalappmainsrccomponentsadminUserEditDialogtsx)
- [rental-app-main/src/components/admin/UserPaymentDialog.tsx](#rentalappmainsrccomponentsadminUserPaymentDialogtsx)
- [rental-app-main/src/components/admin/UserTable.tsx](#rentalappmainsrccomponentsadminUserTabletsx)
- [rental-app-main/src/components/admin/UserTableRow.tsx](#rentalappmainsrccomponentsadminUserTableRowtsx)
- [rental-app-main/src/components/admin/UserTableToolbar.tsx](#rentalappmainsrccomponentsadminUserTableToolbartsx)
- [rental-app-main/src/components/admin/dashboard/ActivityFeedWidget.tsx](#rentalappmainsrccomponentsadmindashboardActivityFeedWidgettsx)
- [rental-app-main/src/components/admin/dashboard/KpiCardsWidget.tsx](#rentalappmainsrccomponentsadmindashboardKpiCardsWidgettsx)
- [rental-app-main/src/components/admin/dashboard/PopularEquipmentChart.tsx](#rentalappmainsrccomponentsadmindashboardPopularEquipmentCharttsx)
- [rental-app-main/src/components/admin/dashboard/TodayFocusWidget.tsx](#rentalappmainsrccomponentsadmindashboardTodayFocusWidgettsx)
- [rental-app-main/src/components/calendar/CalendarDateInputRange.tsx](#rentalappmainsrccomponentscalendarCalendarDateInputRangetsx)
- [rental-app-main/src/components/calendar/CalendarFiltersBlock.tsx](#rentalappmainsrccomponentscalendarCalendarFiltersBlocktsx)
- [rental-app-main/src/components/calendar/CalendarTable.tsx](#rentalappmainsrccomponentscalendarCalendarTabletsx)
- [rental-app-main/src/components/catalog/EquipmentCatalog.tsx](#rentalappmainsrccomponentscatalogEquipmentCatalogtsx)
- [rental-app-main/src/components/equipment-card/AccessoriesSection.tsx](#rentalappmainsrccomponentsequipmentcardAccessoriesSectiontsx)
- [rental-app-main/src/components/equipment-card/CardFooter.tsx](#rentalappmainsrccomponentsequipmentcardCardFootertsx)
- [rental-app-main/src/components/equipment-card/CardImage.tsx](#rentalappmainsrccomponentsequipmentcardCardImagetsx)
- [rental-app-main/src/components/equipment-card/DiscountInfo.tsx](#rentalappmainsrccomponentsequipmentcardDiscountInfotsx)
- [rental-app-main/src/components/equipment-card/EquipmentCard.tsx](#rentalappmainsrccomponentsequipmentcardEquipmentCardtsx)
- [rental-app-main/src/components/equipment-card/constants.ts](#rentalappmainsrccomponentsequipmentcardconstantsts)
- [rental-app-main/src/components/equipment-card/index.ts](#rentalappmainsrccomponentsequipmentcardindexts)
- [rental-app-main/src/components/equipment/EquipmentDetailsDialog.tsx](#rentalappmainsrccomponentsequipmentEquipmentDetailsDialogtsx)
- [rental-app-main/src/components/equipment/EquipmentDetailsView.tsx](#rentalappmainsrccomponentsequipmentEquipmentDetailsViewtsx)
- [rental-app-main/src/components/equipment/EquipmentEditForm.tsx](#rentalappmainsrccomponentsequipmentEquipmentEditFormtsx)
- [rental-app-main/src/components/profile/BalanceHistoryTable.tsx](#rentalappmainsrccomponentsprofileBalanceHistoryTabletsx)
- [rental-app-main/src/components/rental/MyRentalCard.tsx](#rentalappmainsrccomponentsrentalMyRentalCardtsx)
- [rental-app-main/src/components/rental/MyRentalsList.tsx](#rentalappmainsrccomponentsrentalMyRentalsListtsx)
- [rental-app-main/src/components/rental/RentalStatusBadge.tsx](#rentalappmainsrccomponentsrentalRentalStatusBadgetsx)
- [rental-app-main/src/components/reservation/AvailableAccessoriesDropdown.tsx](#rentalappmainsrccomponentsreservationAvailableAccessoriesDropdowntsx)
- [rental-app-main/src/components/reservation/EditableDateRange.tsx](#rentalappmainsrccomponentsreservationEditableDateRangetsx)
- [rental-app-main/src/components/reservation/EditableEquipmentItem.tsx](#rentalappmainsrccomponentsreservationEditableEquipmentItemtsx)
- [rental-app-main/src/components/reservation/EditableReservationCard.tsx](#rentalappmainsrccomponentsreservationEditableReservationCardtsx)
- [rental-app-main/src/components/reservation/EquipmentItemWithConflicts.tsx](#rentalappmainsrccomponentsreservationEquipmentItemWithConflictstsx)
- [rental-app-main/src/components/reservation/HolidayConfirmationDialog.tsx](#rentalappmainsrccomponentsreservationHolidayConfirmationDialogtsx)
- [rental-app-main/src/components/reservation/ReservationItemsList.tsx](#rentalappmainsrccomponentsreservationReservationItemsListtsx)
- [rental-app-main/src/components/reservation/ReservationStatusBadge.tsx](#rentalappmainsrccomponentsreservationReservationStatusBadgetsx)
- [rental-app-main/src/components/reservation/ViewReservationCard.tsx](#rentalappmainsrccomponentsreservationViewReservationCardtsx)
- [rental-app-main/src/components/session/UserSession.tsx](#rentalappmainsrccomponentssessionUserSessiontsx)
- [rental-app-main/src/components/shared/EquipmentWithAccessoriesList.tsx](#rentalappmainsrccomponentssharedEquipmentWithAccessoriesListtsx)
- [rental-app-main/src/components/shared/FinancialInfoBlock.tsx](#rentalappmainsrccomponentssharedFinancialInfoBlocktsx)
- [rental-app-main/src/components/shared/FinancialSummaryBlock.tsx](#rentalappmainsrccomponentssharedFinancialSummaryBlocktsx)
- [rental-app-main/src/components/shared/OrderToolbar.tsx](#rentalappmainsrccomponentssharedOrderToolbartsx)
- [rental-app-main/src/components/ui/AdminButton.tsx](#rentalappmainsrccomponentsuiAdminButtontsx)
- [rental-app-main/src/components/ui/CreatableSelect.tsx](#rentalappmainsrccomponentsuiCreatableSelecttsx)
- [rental-app-main/src/components/ui/alert.tsx](#rentalappmainsrccomponentsuialerttsx)
- [rental-app-main/src/components/ui/badge.tsx](#rentalappmainsrccomponentsuibadgetsx)
- [rental-app-main/src/components/ui/button.tsx](#rentalappmainsrccomponentsuibuttontsx)
- [rental-app-main/src/components/ui/card.tsx](#rentalappmainsrccomponentsuicardtsx)
- [rental-app-main/src/components/ui/checkbox.tsx](#rentalappmainsrccomponentsuicheckboxtsx)
- [rental-app-main/src/components/ui/command.tsx](#rentalappmainsrccomponentsuicommandtsx)
- [rental-app-main/src/components/ui/confirmation-dialog.tsx](#rentalappmainsrccomponentsuiconfirmationdialogtsx)
- [rental-app-main/src/components/ui/dialog.tsx](#rentalappmainsrccomponentsuidialogtsx)
- [rental-app-main/src/components/ui/filter-toggle.tsx](#rentalappmainsrccomponentsuifiltertoggletsx)
- [rental-app-main/src/components/ui/input.tsx](#rentalappmainsrccomponentsuiinputtsx)
- [rental-app-main/src/components/ui/label.tsx](#rentalappmainsrccomponentsuilabeltsx)
- [rental-app-main/src/components/ui/multi-select.tsx](#rentalappmainsrccomponentsuimultiselecttsx)
- [rental-app-main/src/components/ui/phone-input.md](#rentalappmainsrccomponentsuiphoneinputmd)
- [rental-app-main/src/components/ui/phone-input.tsx](#rentalappmainsrccomponentsuiphoneinputtsx)
- [rental-app-main/src/components/ui/popover.tsx](#rentalappmainsrccomponentsuipopovertsx)
- [rental-app-main/src/components/ui/scroll-area.tsx](#rentalappmainsrccomponentsuiscrollareatsx)
- [rental-app-main/src/components/ui/select.tsx](#rentalappmainsrccomponentsuiselecttsx)
- [rental-app-main/src/components/ui/skeleton.tsx](#rentalappmainsrccomponentsuiskeletontsx)
- [rental-app-main/src/components/ui/switch.tsx](#rentalappmainsrccomponentsuiswitchtsx)
- [rental-app-main/src/components/ui/table.tsx](#rentalappmainsrccomponentsuitabletsx)
- [rental-app-main/src/components/ui/textarea.tsx](#rentalappmainsrccomponentsuitextareatsx)
- [rental-app-main/src/components/ui/toggle-group.tsx](#rentalappmainsrccomponentsuitogglegrouptsx)
- [rental-app-main/src/components/ui/toggle.tsx](#rentalappmainsrccomponentsuitoggletsx)
- [rental-app-main/src/constants/equipmentConstants.ts](#rentalappmainsrcconstantsequipmentConstantsts)
- [rental-app-main/src/constants/paginationConstants.ts](#rentalappmainsrcconstantspaginationConstantsts)
- [rental-app-main/src/constants/statusStyles.ts](#rentalappmainsrcconstantsstatusStylests)
- [rental-app-main/src/constants/userConstants.ts](#rentalappmainsrcconstantsuserConstantsts)
- [rental-app-main/src/contexts/ReservationEditContext.tsx](#rentalappmainsrccontextsReservationEditContexttsx)
- [rental-app-main/src/core/services/AccessoryService.ts](#rentalappmainsrccoreservicesAccessoryServicets)
- [rental-app-main/src/core/services/AvailabilityService.ts](#rentalappmainsrccoreservicesAvailabilityServicets)
- [rental-app-main/src/core/services/CalendarService.ts](#rentalappmainsrccoreservicesCalendarServicets)
- [rental-app-main/src/core/services/DateService.ts](#rentalappmainsrccoreservicesDateServicets)
- [rental-app-main/src/core/services/EquipmentService.ts](#rentalappmainsrccoreservicesEquipmentServicets)
- [rental-app-main/src/core/services/PhoneService.ts](#rentalappmainsrccoreservicesPhoneServicets)
- [rental-app-main/src/core/services/PromoCodeService.ts](#rentalappmainsrccoreservicesPromoCodeServicets)
- [rental-app-main/src/core/services/ReservationService.ts](#rentalappmainsrccoreservicesReservationServicets)
- [rental-app-main/src/core/services/UserService.ts](#rentalappmainsrccoreservicesUserServicets)
- [rental-app-main/src/core/services/index.ts](#rentalappmainsrccoreservicesindexts)
- [rental-app-main/src/hooks/admin/create-reservation/useCreateReservationData.ts](#rentalappmainsrchooksadmincreatereservationuseCreateReservationDatats)
- [rental-app-main/src/hooks/admin/create-reservation/useCreateReservationDialog.ts](#rentalappmainsrchooksadmincreatereservationuseCreateReservationDialogts)
- [rental-app-main/src/hooks/admin/create-reservation/useCreateReservationForm.ts](#rentalappmainsrchooksadmincreatereservationuseCreateReservationFormts)
- [rental-app-main/src/hooks/admin/useAdminRentalEdit.ts](#rentalappmainsrchooksadminuseAdminRentalEditts)
- [rental-app-main/src/hooks/admin/useAdminReservationCalculator.ts](#rentalappmainsrchooksadminuseAdminReservationCalculatorts)
- [rental-app-main/src/hooks/admin/useDashboardData.ts](#rentalappmainsrchooksadminuseDashboardDatats)
- [rental-app-main/src/hooks/admin/useEquipmentTableLogic.ts](#rentalappmainsrchooksadminuseEquipmentTableLogicts)
- [rental-app-main/src/hooks/admin/useRentalReturnForm.ts](#rentalappmainsrchooksadminuseRentalReturnFormts)
- [rental-app-main/src/hooks/admin/useUserTableLogic.ts](#rentalappmainsrchooksadminuseUserTableLogicts)
- [rental-app-main/src/hooks/data/useEquipmentData.ts](#rentalappmainsrchooksdatauseEquipmentDatats)
- [rental-app-main/src/hooks/features/useAppFilters.ts](#rentalappmainsrchooksfeaturesuseAppFiltersts)
- [rental-app-main/src/hooks/features/useEquipmentCardViewModel.ts](#rentalappmainsrchooksfeaturesuseEquipmentCardViewModelts)
- [rental-app-main/src/hooks/reservation/submission/useReservationFormData.ts](#rentalappmainsrchooksreservationsubmissionuseReservationFormDatats)
- [rental-app-main/src/hooks/reservation/submission/useReserveSubmission.ts](#rentalappmainsrchooksreservationsubmissionuseReserveSubmissionts)
- [rental-app-main/src/hooks/reservation/usePriceCalculator.ts](#rentalappmainsrchooksreservationusePriceCalculatorts)
- [rental-app-main/src/hooks/reservation/useReservationActions.ts](#rentalappmainsrchooksreservationuseReservationActionsts)
- [rental-app-main/src/hooks/reservation/useReservationData.ts](#rentalappmainsrchooksreservationuseReservationDatats)
- [rental-app-main/src/hooks/reservation/useReservationEditState.ts](#rentalappmainsrchooksreservationuseReservationEditStatets)
- [rental-app-main/src/hooks/reservation/useReservationState.ts](#rentalappmainsrchooksreservationuseReservationStatets)
- [rental-app-main/src/hooks/useAdminAccessories.ts](#rentalappmainsrchooksuseAdminAccessoriests)
- [rental-app-main/src/hooks/useAdminAssociations.ts](#rentalappmainsrchooksuseAdminAssociationsts)
- [rental-app-main/src/hooks/useAdminDiscounts.ts](#rentalappmainsrchooksuseAdminDiscountsts)
- [rental-app-main/src/hooks/useAdminEquipment.ts](#rentalappmainsrchooksuseAdminEquipmentts)
- [rental-app-main/src/hooks/useAdminHolidayRules.ts](#rentalappmainsrchooksuseAdminHolidayRulests)
- [rental-app-main/src/hooks/useAdminHolidays.ts](#rentalappmainsrchooksuseAdminHolidaysts)
- [rental-app-main/src/hooks/useAdminPromoCodes.ts](#rentalappmainsrchooksuseAdminPromoCodests)
- [rental-app-main/src/hooks/useAdminRentals.ts](#rentalappmainsrchooksuseAdminRentalsts)
- [rental-app-main/src/hooks/useAdminReservations.ts](#rentalappmainsrchooksuseAdminReservationsts)
- [rental-app-main/src/hooks/useAdminUsers.ts](#rentalappmainsrchooksuseAdminUsersts)
- [rental-app-main/src/hooks/useAllEquipment.ts](#rentalappmainsrchooksuseAllEquipmentts)
- [rental-app-main/src/hooks/useAssociations.ts](#rentalappmainsrchooksuseAssociationsts)
- [rental-app-main/src/hooks/useAvailabilityCheck.ts](#rentalappmainsrchooksuseAvailabilityCheckts)
- [rental-app-main/src/hooks/useBalanceHistory.ts](#rentalappmainsrchooksuseBalanceHistoryts)
- [rental-app-main/src/hooks/useCalendarGrid.ts](#rentalappmainsrchooksuseCalendarGridts)
- [rental-app-main/src/hooks/useDailyAvailability.ts](#rentalappmainsrchooksuseDailyAvailabilityts)
- [rental-app-main/src/hooks/useDateRange.ts](#rentalappmainsrchooksuseDateRangets)
- [rental-app-main/src/hooks/useEditReservation.ts](#rentalappmainsrchooksuseEditReservationts)
- [rental-app-main/src/hooks/useEquipment.ts](#rentalappmainsrchooksuseEquipmentts)
- [rental-app-main/src/hooks/useEquipmentAvailability.ts](#rentalappmainsrchooksuseEquipmentAvailabilityts)
- [rental-app-main/src/hooks/useEquipmentMap.ts](#rentalappmainsrchooksuseEquipmentMapts)
- [rental-app-main/src/hooks/useErrorHandler.ts](#rentalappmainsrchooksuseErrorHandlerts)
- [rental-app-main/src/hooks/useInlineReservationEdit.tsx](#rentalappmainsrchooksuseInlineReservationEdittsx)
- [rental-app-main/src/hooks/useMyRentals.ts](#rentalappmainsrchooksuseMyRentalsts)
- [rental-app-main/src/hooks/useNetworkStatus.ts](#rentalappmainsrchooksuseNetworkStatusts)
- [rental-app-main/src/hooks/usePhoneValidation.ts](#rentalappmainsrchooksusePhoneValidationts)
- [rental-app-main/src/hooks/useProfile.ts](#rentalappmainsrchooksuseProfilets)
- [rental-app-main/src/hooks/useReservationManagement.ts](#rentalappmainsrchooksuseReservationManagementts)
- [rental-app-main/src/hooks/useReservations.ts](#rentalappmainsrchooksuseReservationsts)
- [rental-app-main/src/hooks/useUpdateEquipmentDetails.ts](#rentalappmainsrchooksuseUpdateEquipmentDetailsts)
- [rental-app-main/src/hooks/useVisibleItems.ts](#rentalappmainsrchooksuseVisibleItemsts)
- [rental-app-main/src/index.css](#rentalappmainsrcindexcss)
- [rental-app-main/src/lib/api.ts](#rentalappmainsrclibapits)
- [rental-app-main/src/lib/queryClient.ts](#rentalappmainsrclibqueryClientts)
- [rental-app-main/src/lib/queryHelpers.ts](#rentalappmainsrclibqueryHelpersts)
- [rental-app-main/src/lib/sortingUtils.ts](#rentalappmainsrclibsortingUtilsts)
- [rental-app-main/src/lib/utils.ts](#rentalappmainsrclibutilsts)
- [rental-app-main/src/lib/validationSchemas.ts](#rentalappmainsrclibvalidationSchemasts)
- [rental-app-main/src/main.tsx](#rentalappmainsrcmaintsx)
- [rental-app-main/src/pages/AccessoryManagementPage.tsx](#rentalappmainsrcpagesAccessoryManagementPagetsx)
- [rental-app-main/src/pages/CalendarPage.tsx](#rentalappmainsrcpagesCalendarPagetsx)
- [rental-app-main/src/pages/CalendarTestPage.tsx](#rentalappmainsrcpagesCalendarTestPagetsx)
- [rental-app-main/src/pages/ContactPage.tsx](#rentalappmainsrcpagesContactPagetsx)
- [rental-app-main/src/pages/EquipmentManagementPage.tsx](#rentalappmainsrcpagesEquipmentManagementPagetsx)
- [rental-app-main/src/pages/HomePage.tsx](#rentalappmainsrcpagesHomePagetsx)
- [rental-app-main/src/pages/MyReservationsPage.tsx](#rentalappmainsrcpagesMyReservationsPagetsx)
- [rental-app-main/src/pages/ProfilePage.tsx](#rentalappmainsrcpagesProfilePagetsx)
- [rental-app-main/src/pages/ReservePage.tsx](#rentalappmainsrcpagesReservePagetsx)
- [rental-app-main/src/pages/UserManagementPage.tsx](#rentalappmainsrcpagesUserManagementPagetsx)
- [rental-app-main/src/pages/admin/AllReservationsManagementPage.tsx](#rentalappmainsrcpagesadminAllReservationsManagementPagetsx)
- [rental-app-main/src/pages/admin/AssociationManagementPage.tsx](#rentalappmainsrcpagesadminAssociationManagementPagetsx)
- [rental-app-main/src/pages/admin/DashboardPage.tsx](#rentalappmainsrcpagesadminDashboardPagetsx)
- [rental-app-main/src/pages/admin/HolidayManagementPage.tsx](#rentalappmainsrcpagesadminHolidayManagementPagetsx)
- [rental-app-main/src/pages/admin/PromoCodeManagementPage.tsx](#rentalappmainsrcpagesadminPromoCodeManagementPagetsx)
- [rental-app-main/src/pages/admin/RentalManagementPage.tsx](#rentalappmainsrcpagesadminRentalManagementPagetsx)
- [rental-app-main/src/store/adminReservationSelectionStore.ts](#rentalappmainsrcstoreadminReservationSelectionStorets)
- [rental-app-main/src/store/authStore.ts](#rentalappmainsrcstoreauthStorets)
- [rental-app-main/src/store/calendarSelectionStore.ts](#rentalappmainsrcstorecalendarSelectionStorets)
- [rental-app-main/src/store/dateStore.ts](#rentalappmainsrcstoredateStorets)
- [rental-app-main/src/store/filterStore.ts](#rentalappmainsrcstorefilterStorets)
- [rental-app-main/src/store/holidayStore.ts](#rentalappmainsrcstoreholidayStorets)
- [rental-app-main/src/store/orderFilterStore.ts](#rentalappmainsrcstoreorderFilterStorets)
- [rental-app-main/src/store/promoCodeStore.ts](#rentalappmainsrcstorepromoCodeStorets)
- [rental-app-main/src/store/reserveStore.ts](#rentalappmainsrcstorereserveStorets)
- [rental-app-main/src/store/sandboxCalculatorStore.ts](#rentalappmainsrcstoresandboxCalculatorStorets)
- [rental-app-main/src/store/searchStore.ts](#rentalappmainsrcstoresearchStorets)
- [rental-app-main/src/store/viewModeStore.ts](#rentalappmainsrcstoreviewModeStorets)
- [rental-app-main/src/types/accessory.ts](#rentalappmainsrctypesaccessoryts)
- [rental-app-main/src/types/association.ts](#rentalappmainsrctypesassociationts)
- [rental-app-main/src/types/availability.ts](#rentalappmainsrctypesavailabilityts)
- [rental-app-main/src/types/balanceHistory.ts](#rentalappmainsrctypesbalanceHistoryts)
- [rental-app-main/src/types/discount.ts](#rentalappmainsrctypesdiscountts)
- [rental-app-main/src/types/equipment.ts](#rentalappmainsrctypesequipmentts)
- [rental-app-main/src/types/holiday.ts](#rentalappmainsrctypesholidayts)
- [rental-app-main/src/types/promo_code.ts](#rentalappmainsrctypespromocodets)
- [rental-app-main/src/types/rental.ts](#rentalappmainsrctypesrentalts)
- [rental-app-main/src/types/reservation.ts](#rentalappmainsrctypesreservationts)
- [rental-app-main/src/types/user.ts](#rentalappmainsrctypesuserts)
- [rental-app-main/src/utils/phoneUtils.ts](#rentalappmainsrcutilsphoneUtilsts)
- [rental-app-main/src/vite-env.d.ts](#rentalappmainsrcviteenvdts)
- [rental-app-main/tailwind.config.js](#rentalappmaintailwindconfigjs)
- [rental-app-main/test_slider_sync.md](#rentalappmaintestslidersyncmd)
- [rental-app-main/tsconfig.app.json](#rentalappmaintsconfigappjson)
- [rental-app-main/tsconfig.json](#rentalappmaintsconfigjson)
- [rental-app-main/tsconfig.node.json](#rentalappmaintsconfignodejson)
- [rental-app-main/vite.config.ts](#rentalappmainviteconfigts)

---

# ğŸ“ Ğ¡Ñ‚Ñ€ÑƒĞºÑ‚ÑƒÑ€Ğ° Ğ¿Ñ€Ğ¾ĞµĞºÑ‚Ğ° (Ğ¸ĞµÑ€Ğ°Ñ€Ñ…Ğ¸Ñ)
`S_Project_Docker/`
â”œâ”€â”€ ğŸ³ `docker-compose.yml`
â”œâ”€â”€ `RentalApp_FASTAPI/`
â”‚   â”œâ”€â”€ `api/`
â”‚   â”‚   â”œâ”€â”€ ğŸ“„ `__init__.py`
â”‚   â”‚   â”œâ”€â”€ ğŸ“„ `accessory_api.py`
â”‚   â”‚   â”œâ”€â”€ ğŸ“„ `admin_dashboard_api.py`
â”‚   â”‚   â”œâ”€â”€ ğŸ“„ `admin_rental_api.py`
â”‚   â”‚   â”œâ”€â”€ ğŸ“„ `admin_reservation_api.py`
â”‚   â”‚   â”œâ”€â”€ ğŸ“„ `association_api.py`
â”‚   â”‚   â”œâ”€â”€ ğŸ“„ `auth_api.py`
â”‚   â”‚   â”œâ”€â”€ ğŸ“„ `calendar_api.py`
â”‚   â”‚   â”œâ”€â”€ ğŸ“„ `database.py`
â”‚   â”‚   â”œâ”€â”€ ğŸ“„ `deps.py`
â”‚   â”‚   â”œâ”€â”€ ğŸ“„ `discount_api.py`
â”‚   â”‚   â”œâ”€â”€ ğŸ“„ `equipment_api.py`
â”‚   â”‚   â”œâ”€â”€ ğŸ“„ `holiday_api.py`
â”‚   â”‚   â”œâ”€â”€ ğŸ“„ `init_models.py`
â”‚   â”‚   â”œâ”€â”€ ğŸ“„ `main_api.py`
â”‚   â”‚   â”œâ”€â”€ ğŸ“„ `permissions.py`
â”‚   â”‚   â”œâ”€â”€ ğŸ“„ `promo_code_api.py`
â”‚   â”‚   â”œâ”€â”€ ğŸ“„ `reservation_api.py`
â”‚   â”‚   â”œâ”€â”€ ğŸ“„ `router.py`
â”‚   â”‚   â””â”€â”€ ğŸ“„ `user_api.py`
â”‚   â”‚   â”œâ”€â”€ `models/`
â”‚   â”‚   â”‚   â”œâ”€â”€ ğŸ“„ `__init__.py`
â”‚   â”‚   â”‚   â”œâ”€â”€ ğŸ“„ `accessory.py`
â”‚   â”‚   â”‚   â”œâ”€â”€ ğŸ“„ `association.py`
â”‚   â”‚   â”‚   â”œâ”€â”€ ğŸ“„ `balance_history.py`
â”‚   â”‚   â”‚   â”œâ”€â”€ ğŸ“„ `discount.py`
â”‚   â”‚   â”‚   â”œâ”€â”€ ğŸ“„ `equipment.py`
â”‚   â”‚   â”‚   â”œâ”€â”€ ğŸ“„ `holiday.py`
â”‚   â”‚   â”‚   â”œâ”€â”€ ğŸ“„ `payment.py`
â”‚   â”‚   â”‚   â”œâ”€â”€ ğŸ“„ `promo_code.py`
â”‚   â”‚   â”‚   â”œâ”€â”€ ğŸ“„ `rental.py`
â”‚   â”‚   â”‚   â”œâ”€â”€ ğŸ“„ `reservation.py`
â”‚   â”‚   â”‚   â””â”€â”€ ğŸ“„ `user.py`
â”‚   â”‚   â””â”€â”€ `services/`
â”‚   â”‚       â”œâ”€â”€ ğŸ“„ `auth_service.py`
â”‚   â”‚       â”œâ”€â”€ ğŸ“„ `balance_service.py`
â”‚   â”‚       â”œâ”€â”€ ğŸ“„ `dashboard_service.py`
â”‚   â”‚       â”œâ”€â”€ ğŸ“„ `discount_service.py`
â”‚   â”‚       â”œâ”€â”€ ğŸ“„ `equipment_query_builder.py`
â”‚   â”‚       â”œâ”€â”€ ğŸ“„ `equipment_service_api.py`
â”‚   â”‚       â”œâ”€â”€ ğŸ“„ `financial_service.py`
â”‚   â”‚       â”œâ”€â”€ ğŸ“„ `promo_code_service.py`
â”‚   â”‚       â”œâ”€â”€ ğŸ“„ `reservation_query_service.py`
â”‚   â”‚       â””â”€â”€ ğŸ“„ `user_service.py`
â”‚   â”‚       â”œâ”€â”€ `.pytest_cache/`
â”‚   â”‚       â”‚   â””â”€â”€ ğŸ“„ `README.md`
â”‚   â”‚       â”œâ”€â”€ `availability/`
â”‚   â”‚       â”‚   â”œâ”€â”€ ğŸ“„ `__init__.py`
â”‚   â”‚       â”‚   â”œâ”€â”€ ğŸ“„ `availability_service.py`
â”‚   â”‚       â”‚   â”œâ”€â”€ ğŸ“„ `base.py`
â”‚   â”‚       â”‚   â”œâ”€â”€ ğŸ“„ `calendar.py`
â”‚   â”‚       â”‚   â”œâ”€â”€ ğŸ“„ `conflicts.py`
â”‚   â”‚       â”‚   â”œâ”€â”€ ğŸ“„ `queries.py`
â”‚   â”‚       â”‚   â””â”€â”€ ğŸ“„ `statuses.py`
â”‚   â”‚       â”œâ”€â”€ `dashboard/`
â”‚   â”‚       â”‚   â”œâ”€â”€ ğŸ“„ `__init__.py`
â”‚   â”‚       â”‚   â”œâ”€â”€ ğŸ“„ `activity_service.py`
â”‚   â”‚       â”‚   â”œâ”€â”€ ğŸ“„ `base.py`
â”‚   â”‚       â”‚   â”œâ”€â”€ ğŸ“„ `dashboard_service.py`
â”‚   â”‚       â”‚   â”œâ”€â”€ ğŸ“„ `equipment_service.py`
â”‚   â”‚       â”‚   â”œâ”€â”€ ğŸ“„ `focus_service.py`
â”‚   â”‚       â”‚   â”œâ”€â”€ ğŸ“„ `kpi_service.py`
â”‚   â”‚       â”‚   â””â”€â”€ ğŸ“„ `README.md`
â”‚   â”‚       â”œâ”€â”€ `order/`
â”‚   â”‚       â”‚   â”œâ”€â”€ ğŸ“„ `__init__.py`
â”‚   â”‚       â”‚   â”œâ”€â”€ ğŸ“„ `order_lifecycle_service.py`
â”‚   â”‚       â”‚   â”œâ”€â”€ ğŸ“„ `order_query_base.py`
â”‚   â”‚       â”‚   â”œâ”€â”€ ğŸ“„ `order_repository.py`
â”‚   â”‚       â”‚   â””â”€â”€ ğŸ“„ `order_validator.py`
â”‚   â”‚       â”œâ”€â”€ `promo_code/`
â”‚   â”‚       â”‚   â”œâ”€â”€ ğŸ“„ `__init__.py`
â”‚   â”‚       â”‚   â”œâ”€â”€ ğŸ“„ `constants.py`
â”‚   â”‚       â”‚   â”œâ”€â”€ ğŸ“„ `exceptions.py`
â”‚   â”‚       â”‚   â”œâ”€â”€ ğŸ“„ `factory.py`
â”‚   â”‚       â”‚   â”œâ”€â”€ ğŸ“„ `interfaces.py`
â”‚   â”‚       â”‚   â”œâ”€â”€ ğŸ“„ `promo_code_business_logic.py`
â”‚   â”‚       â”‚   â”œâ”€â”€ ğŸ“„ `promo_code_manager.py`
â”‚   â”‚       â”‚   â””â”€â”€ ğŸ“„ `promo_code_validator.py`
â”‚   â”‚       â””â”€â”€ `rental/`
â”‚   â”‚           â”œâ”€â”€ ğŸ“„ `__init__.py`
â”‚   â”‚           â””â”€â”€ ğŸ“„ `rental_query_service.py`
â”‚   â”œâ”€â”€ `config/`
â”‚   â”‚   â”œâ”€â”€ ğŸ“„ `__init__.py`
â”‚   â”‚   â”œâ”€â”€ ğŸ“„ `logging_config.py`
â”‚   â”‚   â”œâ”€â”€ ğŸ“„ `secrets.py`
â”‚   â”‚   â””â”€â”€ ğŸ“„ `settings.py`
â”‚   â”œâ”€â”€ `db/`
â”‚   â”‚   â””â”€â”€ ğŸ“„ `init_db.py`
â”‚   â”œâ”€â”€ `migrations/`
â”‚   â”‚   â””â”€â”€ ğŸ“„ `env.py`
â”‚   â”‚   â””â”€â”€ `versions/`
â”‚   â”‚       â””â”€â”€ ğŸ“„ `9290ae79b0d3_create_initial_tables.py`
â”‚   â””â”€â”€ `scripts/`
â”‚       â”œâ”€â”€ ğŸ“„ `populate_associations.py`
â”‚       â”œâ”€â”€ ğŸ“„ `populate_discounts.py`
â”‚       â””â”€â”€ ğŸ“„ `recalculate_balances.py`
â”œâ”€â”€ `nginx/`
â””â”€â”€ `rental-app-main/`
    â”œâ”€â”€ `nginx/`
    â”‚   â””â”€â”€ ğŸ“„ `nginx.conf`
    â”œâ”€â”€ `public/`
    â”‚   â”œâ”€â”€ ğŸ–¼ï¸ `favicon.svg`
    â”‚   â””â”€â”€ ğŸ–¼ï¸ `vite.svg`
    â”œâ”€â”€ `rental_app_main/`
    â”‚   â””â”€â”€ ğŸ“„ `README.md`
    â””â”€â”€ `src/`
        â”œâ”€â”€ ğŸ“„ `index.css`
        â”œâ”€â”€ ğŸ“„ `main.tsx`
        â””â”€â”€ ğŸ“„ `vite-env.d.ts`
        â”œâ”€â”€ `app/`
        â”‚   â””â”€â”€ ğŸ“„ `App.tsx`
        â”œâ”€â”€ `assets/`
        â”‚   â””â”€â”€ ğŸ–¼ï¸ `react.svg`
        â”œâ”€â”€ `components/`
        â”‚   â”œâ”€â”€ ğŸ“„ `AssociationFilter.tsx`
        â”‚   â”œâ”€â”€ ğŸ“„ `AuthForm.tsx`
        â”‚   â”œâ”€â”€ ğŸ“„ `AuthStatus.tsx`
        â”‚   â”œâ”€â”€ ğŸ“„ `AvailabilityStrip.tsx`
        â”‚   â”œâ”€â”€ ğŸ“„ `AvailableCheckbox.tsx`
        â”‚   â”œâ”€â”€ ğŸ“„ `BrandFilter.tsx`
        â”‚   â”œâ”€â”€ ğŸ“„ `CancelReservationDialog.tsx`
        â”‚   â”œâ”€â”€ ğŸ“„ `CardShell.tsx`
        â”‚   â”œâ”€â”€ ğŸ“„ `CompactEquipmentCard.tsx`
        â”‚   â”œâ”€â”€ ğŸ“„ `ConfirmItemRemovalDialog.tsx`
        â”‚   â”œâ”€â”€ ğŸ“„ `DateRangeSelector.tsx`
        â”‚   â”œâ”€â”€ ğŸ“„ `DiscountCalculator.tsx`
        â”‚   â”œâ”€â”€ ğŸ“„ `EquipmentGrid.tsx`
        â”‚   â”œâ”€â”€ ğŸ“„ `ErrorBoundary.tsx`
        â”‚   â”œâ”€â”€ ğŸ“„ `ErrorMessage.tsx`
        â”‚   â”œâ”€â”€ ğŸ“„ `FilterPanel.tsx`
        â”‚   â”œâ”€â”€ ğŸ“„ `MyReservationList.tsx`
        â”‚   â”œâ”€â”€ ğŸ“„ `NetworkStatus.tsx`
        â”‚   â”œâ”€â”€ ğŸ“„ `PromoCodeInput.tsx`
        â”‚   â”œâ”€â”€ ğŸ“„ `RequireAuth.tsx`
        â”‚   â”œâ”€â”€ ğŸ“„ `ReservationCard.tsx`
        â”‚   â”œâ”€â”€ ğŸ“„ `ReservationFooter.tsx`
        â”‚   â”œâ”€â”€ ğŸ“„ `ReservationList.tsx`
        â”‚   â”œâ”€â”€ ğŸ“„ `ReserveEquipmentCard.tsx`
        â”‚   â”œâ”€â”€ ğŸ“„ `SearchInput.tsx`
        â”‚   â”œâ”€â”€ ğŸ“„ `StatusBadge.tsx`
        â”‚   â”œâ”€â”€ ğŸ“„ `TypeFilter.tsx`
        â”‚   â”œâ”€â”€ ğŸ“„ `UserInfoBlock.tsx`
        â”‚   â””â”€â”€ ğŸ“„ `ViewModeToggle.tsx`
        â”‚   â”œâ”€â”€ `DateRangeSelector/`
        â”‚   â”‚   â””â”€â”€ ğŸ“„ `calendar.css`
        â”‚   â”œâ”€â”€ `admin/`
        â”‚   â”‚   â”œâ”€â”€ ğŸ“„ `AccessoryDialogs.tsx`
        â”‚   â”‚   â”œâ”€â”€ ğŸ“„ `AccessoryTable.tsx`
        â”‚   â”‚   â”œâ”€â”€ ğŸ“„ `AdminNavigation.tsx`
        â”‚   â”‚   â”œâ”€â”€ ğŸ“„ `AdminRentalCard.tsx`
        â”‚   â”‚   â”œâ”€â”€ ğŸ“„ `AdminReservationCard.tsx`
        â”‚   â”‚   â”œâ”€â”€ ğŸ“„ `AdminReservationToolbar.tsx`
        â”‚   â”‚   â”œâ”€â”€ ğŸ“„ `AllRentalsList.tsx`
        â”‚   â”‚   â”œâ”€â”€ ğŸ“„ `AllReservationsList.tsx`
        â”‚   â”‚   â”œâ”€â”€ ğŸ“„ `AssociationTable.tsx`
        â”‚   â”‚   â”œâ”€â”€ ğŸ“„ `ConvertReservationDialog.tsx`
        â”‚   â”‚   â”œâ”€â”€ ğŸ“„ `CreateReservationDialog.tsx`
        â”‚   â”‚   â”œâ”€â”€ ğŸ“„ `CreateReservationStep1Details.tsx`
        â”‚   â”‚   â”œâ”€â”€ ğŸ“„ `CreateReservationStep2Accessories.tsx`
        â”‚   â”‚   â”œâ”€â”€ ğŸ“„ `DurationDiscountManager.tsx`
        â”‚   â”‚   â”œâ”€â”€ ğŸ“„ `EditableRentalCard.tsx`
        â”‚   â”‚   â”œâ”€â”€ ğŸ“„ `EquipmentCreateDialog.tsx`
        â”‚   â”‚   â”œâ”€â”€ ğŸ“„ `EquipmentEditDialog.tsx`
        â”‚   â”‚   â”œâ”€â”€ ğŸ“„ `EquipmentStats.tsx`
        â”‚   â”‚   â”œâ”€â”€ ğŸ“„ `EquipmentTable.tsx`
        â”‚   â”‚   â”œâ”€â”€ ğŸ“„ `EquipmentTableRow.tsx`
        â”‚   â”‚   â”œâ”€â”€ ğŸ“„ `EquipmentTableToolbar.tsx`
        â”‚   â”‚   â”œâ”€â”€ ğŸ“„ `HolidayManager.tsx`
        â”‚   â”‚   â”œâ”€â”€ ğŸ“„ `PromoCodeDialog.tsx`
        â”‚   â”‚   â”œâ”€â”€ ğŸ“„ `PromoCodeTable.tsx`
        â”‚   â”‚   â”œâ”€â”€ ğŸ“„ `RentalStatusBadge.tsx`
        â”‚   â”‚   â”œâ”€â”€ ğŸ“„ `ReservationFinancialSummary.tsx`
        â”‚   â”‚   â”œâ”€â”€ ğŸ“„ `ReturnAccessoriesChecklist.tsx`
        â”‚   â”‚   â”œâ”€â”€ ğŸ“„ `ReturnFinancials.tsx`
        â”‚   â”‚   â”œâ”€â”€ ğŸ“„ `ReturnRentalDialog.tsx`
        â”‚   â”‚   â”œâ”€â”€ ğŸ“„ `UserCreateDialog.tsx`
        â”‚   â”‚   â”œâ”€â”€ ğŸ“„ `UserEditDialog.tsx`
        â”‚   â”‚   â”œâ”€â”€ ğŸ“„ `UserPaymentDialog.tsx`
        â”‚   â”‚   â”œâ”€â”€ ğŸ“„ `UserTable.tsx`
        â”‚   â”‚   â”œâ”€â”€ ğŸ“„ `UserTableRow.tsx`
        â”‚   â”‚   â””â”€â”€ ğŸ“„ `UserTableToolbar.tsx`
        â”‚   â”‚   â””â”€â”€ `dashboard/`
        â”‚   â”‚       â”œâ”€â”€ ğŸ“„ `ActivityFeedWidget.tsx`
        â”‚   â”‚       â”œâ”€â”€ ğŸ“„ `KpiCardsWidget.tsx`
        â”‚   â”‚       â”œâ”€â”€ ğŸ“„ `PopularEquipmentChart.tsx`
        â”‚   â”‚       â””â”€â”€ ğŸ“„ `TodayFocusWidget.tsx`
        â”‚   â”œâ”€â”€ `calendar/`
        â”‚   â”‚   â”œâ”€â”€ ğŸ“„ `CalendarDateInputRange.tsx`
        â”‚   â”‚   â”œâ”€â”€ ğŸ“„ `CalendarFiltersBlock.tsx`
        â”‚   â”‚   â””â”€â”€ ğŸ“„ `CalendarTable.tsx`
        â”‚   â”œâ”€â”€ `catalog/`
        â”‚   â”‚   â””â”€â”€ ğŸ“„ `EquipmentCatalog.tsx`
        â”‚   â”œâ”€â”€ `equipment/`
        â”‚   â”‚   â”œâ”€â”€ ğŸ“„ `EquipmentDetailsDialog.tsx`
        â”‚   â”‚   â”œâ”€â”€ ğŸ“„ `EquipmentDetailsView.tsx`
        â”‚   â”‚   â””â”€â”€ ğŸ“„ `EquipmentEditForm.tsx`
        â”‚   â”œâ”€â”€ `equipment-card/`
        â”‚   â”‚   â”œâ”€â”€ ğŸ“„ `AccessoriesSection.tsx`
        â”‚   â”‚   â”œâ”€â”€ ğŸ“„ `CardFooter.tsx`
        â”‚   â”‚   â”œâ”€â”€ ğŸ“„ `CardImage.tsx`
        â”‚   â”‚   â”œâ”€â”€ ğŸ“„ `constants.ts`
        â”‚   â”‚   â”œâ”€â”€ ğŸ“„ `DiscountInfo.tsx`
        â”‚   â”‚   â”œâ”€â”€ ğŸ“„ `EquipmentCard.tsx`
        â”‚   â”‚   â””â”€â”€ ğŸ“„ `index.ts`
        â”‚   â”œâ”€â”€ `profile/`
        â”‚   â”‚   â””â”€â”€ ğŸ“„ `BalanceHistoryTable.tsx`
        â”‚   â”œâ”€â”€ `rental/`
        â”‚   â”‚   â”œâ”€â”€ ğŸ“„ `MyRentalCard.tsx`
        â”‚   â”‚   â”œâ”€â”€ ğŸ“„ `MyRentalsList.tsx`
        â”‚   â”‚   â””â”€â”€ ğŸ“„ `RentalStatusBadge.tsx`
        â”‚   â”œâ”€â”€ `reservation/`
        â”‚   â”‚   â”œâ”€â”€ ğŸ“„ `AvailableAccessoriesDropdown.tsx`
        â”‚   â”‚   â”œâ”€â”€ ğŸ“„ `EditableDateRange.tsx`
        â”‚   â”‚   â”œâ”€â”€ ğŸ“„ `EditableEquipmentItem.tsx`
        â”‚   â”‚   â”œâ”€â”€ ğŸ“„ `EditableReservationCard.tsx`
        â”‚   â”‚   â”œâ”€â”€ ğŸ“„ `EquipmentItemWithConflicts.tsx`
        â”‚   â”‚   â”œâ”€â”€ ğŸ“„ `HolidayConfirmationDialog.tsx`
        â”‚   â”‚   â”œâ”€â”€ ğŸ“„ `ReservationItemsList.tsx`
        â”‚   â”‚   â”œâ”€â”€ ğŸ“„ `ReservationStatusBadge.tsx`
        â”‚   â”‚   â””â”€â”€ ğŸ“„ `ViewReservationCard.tsx`
        â”‚   â”œâ”€â”€ `session/`
        â”‚   â”‚   â””â”€â”€ ğŸ“„ `UserSession.tsx`
        â”‚   â”œâ”€â”€ `shared/`
        â”‚   â”‚   â”œâ”€â”€ ğŸ“„ `EquipmentWithAccessoriesList.tsx`
        â”‚   â”‚   â”œâ”€â”€ ğŸ“„ `FinancialInfoBlock.tsx`
        â”‚   â”‚   â”œâ”€â”€ ğŸ“„ `FinancialSummaryBlock.tsx`
        â”‚   â”‚   â””â”€â”€ ğŸ“„ `OrderToolbar.tsx`
        â”‚   â””â”€â”€ `ui/`
        â”‚       â”œâ”€â”€ ğŸ“„ `AdminButton.tsx`
        â”‚       â”œâ”€â”€ ğŸ“„ `alert.tsx`
        â”‚       â”œâ”€â”€ ğŸ“„ `badge.tsx`
        â”‚       â”œâ”€â”€ ğŸ“„ `button.tsx`
        â”‚       â”œâ”€â”€ ğŸ“„ `card.tsx`
        â”‚       â”œâ”€â”€ ğŸ“„ `checkbox.tsx`
        â”‚       â”œâ”€â”€ ğŸ“„ `command.tsx`
        â”‚       â”œâ”€â”€ ğŸ“„ `confirmation-dialog.tsx`
        â”‚       â”œâ”€â”€ ğŸ“„ `CreatableSelect.tsx`
        â”‚       â”œâ”€â”€ ğŸ“„ `dialog.tsx`
        â”‚       â”œâ”€â”€ ğŸ“„ `filter-toggle.tsx`
        â”‚       â”œâ”€â”€ ğŸ“„ `input.tsx`
        â”‚       â”œâ”€â”€ ğŸ“„ `label.tsx`
        â”‚       â”œâ”€â”€ ğŸ“„ `multi-select.tsx`
        â”‚       â”œâ”€â”€ ğŸ“„ `phone-input.md`
        â”‚       â”œâ”€â”€ ğŸ“„ `phone-input.tsx`
        â”‚       â”œâ”€â”€ ğŸ“„ `popover.tsx`
        â”‚       â”œâ”€â”€ ğŸ“„ `scroll-area.tsx`
        â”‚       â”œâ”€â”€ ğŸ“„ `select.tsx`
        â”‚       â”œâ”€â”€ ğŸ“„ `skeleton.tsx`
        â”‚       â”œâ”€â”€ ğŸ“„ `switch.tsx`
        â”‚       â”œâ”€â”€ ğŸ“„ `table.tsx`
        â”‚       â”œâ”€â”€ ğŸ“„ `textarea.tsx`
        â”‚       â”œâ”€â”€ ğŸ“„ `toggle-group.tsx`
        â”‚       â””â”€â”€ ğŸ“„ `toggle.tsx`
        â”œâ”€â”€ `constants/`
        â”‚   â”œâ”€â”€ ğŸ“„ `equipmentConstants.ts`
        â”‚   â”œâ”€â”€ ğŸ“„ `paginationConstants.ts`
        â”‚   â”œâ”€â”€ ğŸ“„ `statusStyles.ts`
        â”‚   â””â”€â”€ ğŸ“„ `userConstants.ts`
        â”œâ”€â”€ `contexts/`
        â”‚   â””â”€â”€ ğŸ“„ `ReservationEditContext.tsx`
        â”œâ”€â”€ `hooks/`
        â”‚   â”œâ”€â”€ ğŸ“„ `useAdminAccessories.ts`
        â”‚   â”œâ”€â”€ ğŸ“„ `useAdminAssociations.ts`
        â”‚   â”œâ”€â”€ ğŸ“„ `useAdminDiscounts.ts`
        â”‚   â”œâ”€â”€ ğŸ“„ `useAdminEquipment.ts`
        â”‚   â”œâ”€â”€ ğŸ“„ `useAdminHolidayRules.ts`
        â”‚   â”œâ”€â”€ ğŸ“„ `useAdminHolidays.ts`
        â”‚   â”œâ”€â”€ ğŸ“„ `useAdminPromoCodes.ts`
        â”‚   â”œâ”€â”€ ğŸ“„ `useAdminRentals.ts`
        â”‚   â”œâ”€â”€ ğŸ“„ `useAdminReservations.ts`
        â”‚   â”œâ”€â”€ ğŸ“„ `useAdminUsers.ts`
        â”‚   â”œâ”€â”€ ğŸ“„ `useAllEquipment.ts`
        â”‚   â”œâ”€â”€ ğŸ“„ `useAssociations.ts`
        â”‚   â”œâ”€â”€ ğŸ“„ `useAvailabilityCheck.ts`
        â”‚   â”œâ”€â”€ ğŸ“„ `useBalanceHistory.ts`
        â”‚   â”œâ”€â”€ ğŸ“„ `useCalendarGrid.ts`
        â”‚   â”œâ”€â”€ ğŸ“„ `useDailyAvailability.ts`
        â”‚   â”œâ”€â”€ ğŸ“„ `useDateRange.ts`
        â”‚   â”œâ”€â”€ ğŸ“„ `useEditReservation.ts`
        â”‚   â”œâ”€â”€ ğŸ“„ `useEquipment.ts`
        â”‚   â”œâ”€â”€ ğŸ“„ `useEquipmentAvailability.ts`
        â”‚   â”œâ”€â”€ ğŸ“„ `useEquipmentMap.ts`
        â”‚   â”œâ”€â”€ ğŸ“„ `useErrorHandler.ts`
        â”‚   â”œâ”€â”€ ğŸ“„ `useInlineReservationEdit.tsx`
        â”‚   â”œâ”€â”€ ğŸ“„ `useMyRentals.ts`
        â”‚   â”œâ”€â”€ ğŸ“„ `useNetworkStatus.ts`
        â”‚   â”œâ”€â”€ ğŸ“„ `usePhoneValidation.ts`
        â”‚   â”œâ”€â”€ ğŸ“„ `useProfile.ts`
        â”‚   â”œâ”€â”€ ğŸ“„ `useReservationManagement.ts`
        â”‚   â”œâ”€â”€ ğŸ“„ `useReservations.ts`
        â”‚   â”œâ”€â”€ ğŸ“„ `useUpdateEquipmentDetails.ts`
        â”‚   â””â”€â”€ ğŸ“„ `useVisibleItems.ts`
        â”‚   â”œâ”€â”€ `admin/`
        â”‚   â”‚   â”œâ”€â”€ ğŸ“„ `useAdminRentalEdit.ts`
        â”‚   â”‚   â”œâ”€â”€ ğŸ“„ `useAdminReservationCalculator.ts`
        â”‚   â”‚   â”œâ”€â”€ ğŸ“„ `useDashboardData.ts`
        â”‚   â”‚   â”œâ”€â”€ ğŸ“„ `useEquipmentTableLogic.ts`
        â”‚   â”‚   â”œâ”€â”€ ğŸ“„ `useRentalReturnForm.ts`
        â”‚   â”‚   â””â”€â”€ ğŸ“„ `useUserTableLogic.ts`
        â”‚   â”‚   â””â”€â”€ `create-reservation/`
        â”‚   â”‚       â”œâ”€â”€ ğŸ“„ `useCreateReservationData.ts`
        â”‚   â”‚       â”œâ”€â”€ ğŸ“„ `useCreateReservationDialog.ts`
        â”‚   â”‚       â””â”€â”€ ğŸ“„ `useCreateReservationForm.ts`
        â”‚   â”œâ”€â”€ `data/`
        â”‚   â”‚   â””â”€â”€ ğŸ“„ `useEquipmentData.ts`
        â”‚   â”œâ”€â”€ `features/`
        â”‚   â”‚   â”œâ”€â”€ ğŸ“„ `useAppFilters.ts`
        â”‚   â”‚   â””â”€â”€ ğŸ“„ `useEquipmentCardViewModel.ts`
        â”‚   â””â”€â”€ `reservation/`
        â”‚       â”œâ”€â”€ ğŸ“„ `usePriceCalculator.ts`
        â”‚       â”œâ”€â”€ ğŸ“„ `useReservationActions.ts`
        â”‚       â”œâ”€â”€ ğŸ“„ `useReservationData.ts`
        â”‚       â”œâ”€â”€ ğŸ“„ `useReservationEditState.ts`
        â”‚       â””â”€â”€ ğŸ“„ `useReservationState.ts`
        â”‚       â””â”€â”€ `submission/`
        â”‚           â”œâ”€â”€ ğŸ“„ `useReservationFormData.ts`
        â”‚           â””â”€â”€ ğŸ“„ `useReserveSubmission.ts`
        â”œâ”€â”€ `lib/`
        â”‚   â”œâ”€â”€ ğŸ“„ `api.ts`
        â”‚   â”œâ”€â”€ ğŸ“„ `queryClient.ts`
        â”‚   â”œâ”€â”€ ğŸ“„ `queryHelpers.ts`
        â”‚   â”œâ”€â”€ ğŸ“„ `sortingUtils.ts`
        â”‚   â”œâ”€â”€ ğŸ“„ `utils.ts`
        â”‚   â””â”€â”€ ğŸ“„ `validationSchemas.ts`
        â”œâ”€â”€ `pages/`
        â”‚   â”œâ”€â”€ ğŸ“„ `AccessoryManagementPage.tsx`
        â”‚   â”œâ”€â”€ ğŸ“„ `CalendarPage.tsx`
        â”‚   â”œâ”€â”€ ğŸ“„ `CalendarTestPage.tsx`
        â”‚   â”œâ”€â”€ ğŸ“„ `ContactPage.tsx`
        â”‚   â”œâ”€â”€ ğŸ“„ `EquipmentManagementPage.tsx`
        â”‚   â”œâ”€â”€ ğŸ“„ `HomePage.tsx`
        â”‚   â”œâ”€â”€ ğŸ“„ `MyReservationsPage.tsx`
        â”‚   â”œâ”€â”€ ğŸ“„ `ProfilePage.tsx`
        â”‚   â”œâ”€â”€ ğŸ“„ `ReservePage.tsx`
        â”‚   â””â”€â”€ ğŸ“„ `UserManagementPage.tsx`
        â”‚   â””â”€â”€ `admin/`
        â”‚       â”œâ”€â”€ ğŸ“„ `AllReservationsManagementPage.tsx`
        â”‚       â”œâ”€â”€ ğŸ“„ `AssociationManagementPage.tsx`
        â”‚       â”œâ”€â”€ ğŸ“„ `DashboardPage.tsx`
        â”‚       â”œâ”€â”€ ğŸ“„ `HolidayManagementPage.tsx`
        â”‚       â”œâ”€â”€ ğŸ“„ `PromoCodeManagementPage.tsx`
        â”‚       â””â”€â”€ ğŸ“„ `RentalManagementPage.tsx`
        â”œâ”€â”€ `store/`
        â”‚   â”œâ”€â”€ ğŸ“„ `adminReservationSelectionStore.ts`
        â”‚   â”œâ”€â”€ ğŸ“„ `authStore.ts`
        â”‚   â”œâ”€â”€ ğŸ“„ `calendarSelectionStore.ts`
        â”‚   â”œâ”€â”€ ğŸ“„ `dateStore.ts`
        â”‚   â”œâ”€â”€ ğŸ“„ `filterStore.ts`
        â”‚   â”œâ”€â”€ ğŸ“„ `holidayStore.ts`
        â”‚   â”œâ”€â”€ ğŸ“„ `orderFilterStore.ts`
        â”‚   â”œâ”€â”€ ğŸ“„ `promoCodeStore.ts`
        â”‚   â”œâ”€â”€ ğŸ“„ `reserveStore.ts`
        â”‚   â”œâ”€â”€ ğŸ“„ `sandboxCalculatorStore.ts`
        â”‚   â”œâ”€â”€ ğŸ“„ `searchStore.ts`
        â”‚   â””â”€â”€ ğŸ“„ `viewModeStore.ts`
        â”œâ”€â”€ `types/`
        â”‚   â”œâ”€â”€ ğŸ“„ `accessory.ts`
        â”‚   â”œâ”€â”€ ğŸ“„ `association.ts`
        â”‚   â”œâ”€â”€ ğŸ“„ `availability.ts`
        â”‚   â”œâ”€â”€ ğŸ“„ `balanceHistory.ts`
        â”‚   â”œâ”€â”€ ğŸ“„ `discount.ts`
        â”‚   â”œâ”€â”€ ğŸ“„ `equipment.ts`
        â”‚   â”œâ”€â”€ ğŸ“„ `holiday.ts`
        â”‚   â”œâ”€â”€ ğŸ“„ `promo_code.ts`
        â”‚   â”œâ”€â”€ ğŸ“„ `rental.ts`
        â”‚   â”œâ”€â”€ ğŸ“„ `reservation.ts`
        â”‚   â””â”€â”€ ğŸ“„ `user.ts`
        â””â”€â”€ `utils/`
            â””â”€â”€ ğŸ“„ `phoneUtils.ts`

---


## <a name="RentalAppFASTAPIDockerfilebackend"></a>`RentalApp_FASTAPI/Dockerfile.backend`

```dockerfile
// path: RentalApp_FASTAPI/Dockerfile.backend

# RentalApp_FASTAPI/Dockerfile.backend

FROM python:3.11-slim-buster
WORKDIR /app

# ĞŸÑƒÑ‚Ğ¸ Ñ‚ĞµĞ¿ĞµÑ€ÑŒ Ğ¾Ñ‚Ğ½Ğ¾ÑĞ¸Ñ‚ĞµĞ»ÑŒĞ½Ñ‹ Ğ¿Ğ°Ğ¿ĞºĞ¸ RentalApp_FASTAPI
COPY requirements.txt requirements.txt
RUN pip install --no-cache-dir --upgrade pip -r requirements.txt

COPY ./api ./api
COPY ./shared ./shared
COPY ./config ./config
COPY ./migrations ./migrations
COPY alembic.ini alembic.ini
COPY create_admin.py create_admin.py

CMD ["uvicorn", "api.main_api:app", "--host", "0.0.0.0", "--port", "8000"]

```


## <a name="RentalAppFASTAPIapiinitpy"></a>`RentalApp_FASTAPI/api/__init__.py`

```python
// path: RentalApp_FASTAPI/api/__init__.py



```


## <a name="RentalAppFASTAPIapiaccessoryapipy"></a>`RentalApp_FASTAPI/api/accessory_api.py`

```python
// path: RentalApp_FASTAPI/api/accessory_api.py

# api/accessory_api.py

from fastapi import APIRouter, Depends, HTTPException, Query
from sqlalchemy.ext.asyncio import AsyncSession
from sqlalchemy import select, func, or_
from typing import List

from api.deps import get_db
from api.models.user import User
from api.models.accessory import Accessory
from api.models.reservation import ReservationAccessory, Reservation
from api.models.rental import RentalAccessory, Rental
from api.permissions import require_manager
from shared.schemas.accessory_schema import AccessoryCreate, AccessoryUpdate, AccessoryOut, AccessoryListResponse
from fastapi_csrf_protect import CsrfProtect

router = APIRouter(prefix="/accessories", tags=["ĞĞºÑĞµÑÑÑƒĞ°Ñ€Ñ‹"])

@router.post("/", response_model=AccessoryOut, status_code=201)
async def create_accessory(
        accessory_in: AccessoryCreate,
        db: AsyncSession = Depends(get_db),
        current_user: User = Depends(require_manager),
        csrf_protect: CsrfProtect = Depends()
):
    """Ğ¡Ğ¾Ğ·Ğ´Ğ°Ñ‚ÑŒ Ğ½Ğ¾Ğ²Ñ‹Ğ¹ Ğ°ĞºÑĞµÑÑÑƒĞ°Ñ€ (Ñ‚Ğ¾Ğ»ÑŒĞºĞ¾ Ğ´Ğ»Ñ Ğ¼ĞµĞ½ĞµĞ´Ğ¶ĞµÑ€Ğ¾Ğ²/Ğ°Ğ´Ğ¼Ğ¸Ğ½Ğ¾Ğ²)"""
    new_accessory = Accessory(**accessory_in.model_dump())
    db.add(new_accessory)
    await db.commit()
    await db.refresh(new_accessory)
    
    # Ğ’Ğ¾Ğ·Ğ²Ñ€Ğ°Ñ‰Ğ°ĞµĞ¼ ÑĞ¾Ğ·Ğ´Ğ°Ğ½Ğ½Ñ‹Ğ¹ Ğ¾Ğ±ÑŠĞµĞºÑ‚ Ñ Ğ·Ğ°Ğ³Ñ€ÑƒĞ¶ĞµĞ½Ğ½Ñ‹Ğ¼Ğ¸ Ğ´Ğ°Ğ½Ğ½Ñ‹Ğ¼Ğ¸ Ğ¸Ğ· Ğ‘Ğ”
    return new_accessory

@router.get("/", response_model=AccessoryListResponse)
async def get_all_accessories(
        db: AsyncSession = Depends(get_db),
        skip: int = Query(0, ge=0, description="Ğ¡ĞºĞ¾Ğ»ÑŒĞºĞ¾ Ğ·Ğ°Ğ¿Ğ¸ÑĞµĞ¹ Ğ¿Ñ€Ğ¾Ğ¿ÑƒÑÑ‚Ğ¸Ñ‚ÑŒ"),
        limit: int = Query(10, ge=1, le=500, description="ĞœĞ°ĞºÑĞ¸Ğ¼Ğ°Ğ»ÑŒĞ½Ğ¾Ğµ ĞºĞ¾Ğ»Ğ¸Ñ‡ĞµÑÑ‚Ğ²Ğ¾ Ğ·Ğ°Ğ¿Ğ¸ÑĞµĞ¹ Ğ½Ğ° ÑÑ‚Ñ€Ğ°Ğ½Ğ¸Ñ†Ğµ")
):
    """ĞŸĞ¾Ğ»ÑƒÑ‡Ğ¸Ñ‚ÑŒ ÑĞ¿Ğ¸ÑĞ¾Ğº Ğ²ÑĞµÑ… Ğ°ĞºÑĞµÑÑÑƒĞ°Ñ€Ğ¾Ğ² Ñ Ğ¿Ğ°Ğ³Ğ¸Ğ½Ğ°Ñ†Ğ¸ĞµĞ¹"""
    # 1. Ğ—Ğ°Ğ¿Ñ€Ğ¾Ñ Ğ´Ğ»Ñ Ğ¿Ğ¾Ğ»ÑƒÑ‡ĞµĞ½Ğ¸Ñ Ğ¾Ğ±Ñ‰ĞµĞ³Ğ¾ ĞºĞ¾Ğ»Ğ¸Ñ‡ĞµÑÑ‚Ğ²Ğ° Ğ°ĞºÑĞµÑÑÑƒĞ°Ñ€Ğ¾Ğ²
    total_result = await db.execute(select(func.count(Accessory.id)))
    total_accessories = total_result.scalar_one()

    # 2. Ğ—Ğ°Ğ¿Ñ€Ğ¾Ñ Ğ´Ğ»Ñ Ğ¿Ğ¾Ğ»ÑƒÑ‡ĞµĞ½Ğ¸Ñ "ÑÑ‚Ñ€Ğ°Ğ½Ğ¸Ñ†Ñ‹" Ğ°ĞºÑĞµÑÑÑƒĞ°Ñ€Ğ¾Ğ²
    accessories_result = await db.execute(
        select(Accessory).order_by(Accessory.name).offset(skip).limit(limit)
    )
    accessories_orm = accessories_result.scalars().all()

    # 3. Ğ¤Ğ¾Ñ€Ğ¼Ğ¸Ñ€ÑƒĞµĞ¼ Ğ¸ Ğ²Ğ¾Ğ·Ğ²Ñ€Ğ°Ñ‰Ğ°ĞµĞ¼ Ğ½Ğ¾Ğ²Ñ‹Ğ¹ Ğ¾Ğ±ÑŠĞµĞºÑ‚ Ğ¾Ñ‚Ğ²ĞµÑ‚Ğ°
    return AccessoryListResponse(
        items=accessories_orm,
        total=total_accessories
    )

@router.get("/{accessory_id}", response_model=AccessoryOut)
async def get_accessory_by_id(accessory_id: int, db: AsyncSession = Depends(get_db)):
    """ĞŸĞ¾Ğ»ÑƒÑ‡Ğ¸Ñ‚ÑŒ Ğ°ĞºÑĞµÑÑÑƒĞ°Ñ€ Ğ¿Ğ¾ ID"""
    result = await db.execute(select(Accessory).filter(Accessory.id == accessory_id))
    accessory = result.scalars().first()
    if not accessory:
        raise HTTPException(status_code=404, detail="ĞĞºÑĞµÑÑÑƒĞ°Ñ€ Ğ½Ğµ Ğ½Ğ°Ğ¹Ğ´ĞµĞ½")
    return accessory

@router.put("/{accessory_id}", response_model=AccessoryOut)
async def update_accessory(
        accessory_id: int,
        accessory_in: AccessoryUpdate,
        db: AsyncSession = Depends(get_db),
        current_user: User = Depends(require_manager),
        csrf_protect: CsrfProtect = Depends()
):
    """ĞĞ±Ğ½Ğ¾Ğ²Ğ¸Ñ‚ÑŒ Ğ°ĞºÑĞµÑÑÑƒĞ°Ñ€ (Ñ‚Ğ¾Ğ»ÑŒĞºĞ¾ Ğ´Ğ»Ñ Ğ¼ĞµĞ½ĞµĞ´Ğ¶ĞµÑ€Ğ¾Ğ²/Ğ°Ğ´Ğ¼Ğ¸Ğ½Ğ¾Ğ²)"""
    result = await db.execute(select(Accessory).filter(Accessory.id == accessory_id))
    accessory = result.scalars().first()
    if not accessory:
        raise HTTPException(status_code=404, detail="ĞĞºÑĞµÑÑÑƒĞ°Ñ€ Ğ½Ğµ Ğ½Ğ°Ğ¹Ğ´ĞµĞ½")

    update_data = accessory_in.model_dump(exclude_unset=True)
    for key, value in update_data.items():
        setattr(accessory, key, value)

    await db.commit()
    
    # Ğ’Ğ¾Ğ·Ğ²Ñ€Ğ°Ñ‰Ğ°ĞµĞ¼ Ğ¾Ğ±Ğ½Ğ¾Ğ²Ğ»ĞµĞ½Ğ½Ñ‹Ğ¹ Ğ¾Ğ±ÑŠĞµĞºÑ‚ Ğ±ĞµĞ· Ğ¿Ğ¾Ğ²Ñ‚Ğ¾Ñ€Ğ½Ğ¾Ğ³Ğ¾ Ğ·Ğ°Ğ¿Ñ€Ğ¾ÑĞ° Ğº Ğ‘Ğ”
    return accessory

@router.delete("/{accessory_id}", status_code=204)
async def delete_accessory(
        accessory_id: int,
        db: AsyncSession = Depends(get_db),
        current_user: User = Depends(require_manager),
        csrf_protect: CsrfProtect = Depends()
):
    """Ğ£Ğ´Ğ°Ğ»Ğ¸Ñ‚ÑŒ Ğ°ĞºÑĞµÑÑÑƒĞ°Ñ€ (Ñ‚Ğ¾Ğ»ÑŒĞºĞ¾ Ğ´Ğ»Ñ Ğ¼ĞµĞ½ĞµĞ´Ğ¶ĞµÑ€Ğ¾Ğ²/Ğ°Ğ´Ğ¼Ğ¸Ğ½Ğ¾Ğ²)"""
    result = await db.execute(select(Accessory).filter(Accessory.id == accessory_id))
    accessory = result.scalars().first()
    if not accessory:
        raise HTTPException(status_code=404, detail="ĞĞºÑĞµÑÑÑƒĞ°Ñ€ Ğ½Ğµ Ğ½Ğ°Ğ¹Ğ´ĞµĞ½")

    # ĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑĞµĞ¼ Ğ°ĞºÑ‚Ğ¸Ğ²Ğ½Ñ‹Ğµ Ñ€ĞµĞ·ĞµÑ€Ğ²Ñ‹
    active_reservations_query = (
        select(func.count(Reservation.id))
        .join(ReservationAccessory, Reservation.id == ReservationAccessory.reservation_id)
        .where(ReservationAccessory.accessory_id == accessory_id)
        .where(Reservation.status == 'active')
    )
    active_reservations_count = (await db.execute(active_reservations_query)).scalar_one()

    # ĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑĞµĞ¼ Ğ°ĞºÑ‚Ğ¸Ğ²Ğ½Ñ‹Ğµ Ğ°Ñ€ĞµĞ½Ğ´Ñ‹
    active_rentals_query = (
        select(func.count(Rental.id))
        .join(RentalAccessory, Rental.id == RentalAccessory.rental_id)
        .where(RentalAccessory.accessory_id == accessory_id)
        .where(or_(Rental.status == 'active', Rental.status == 'overdue'))
    )
    active_rentals_count = (await db.execute(active_rentals_query)).scalar_one()

    if active_reservations_count > 0 or active_rentals_count > 0:
        error_detail = (
            f"ĞĞµĞ²Ğ¾Ğ·Ğ¼Ğ¾Ğ¶Ğ½Ğ¾ ÑƒĞ´Ğ°Ğ»Ğ¸Ñ‚ÑŒ Ğ°ĞºÑĞµÑÑÑƒĞ°Ñ€. ĞĞ½ Ğ¸ÑĞ¿Ğ¾Ğ»ÑŒĞ·ÑƒĞµÑ‚ÑÑ Ğ² "
            f"{active_reservations_count} Ğ°ĞºÑ‚Ğ¸Ğ²Ğ½Ñ‹Ñ… Ñ€ĞµĞ·ĞµÑ€Ğ²Ğ°Ñ… Ğ¸ "
            f"{active_rentals_count} Ğ°ĞºÑ‚Ğ¸Ğ²Ğ½Ñ‹Ñ… Ğ°Ñ€ĞµĞ½Ğ´Ğ°Ñ…."
        )
        raise HTTPException(status_code=409, detail=error_detail)

    await db.delete(accessory)
    await db.commit()
    return None

```


## <a name="RentalAppFASTAPIapiadmindashboardapipy"></a>`RentalApp_FASTAPI/api/admin_dashboard_api.py`

```python
// path: RentalApp_FASTAPI/api/admin_dashboard_api.py

# api/admin_dashboard_api.py

from fastapi import APIRouter, Depends
from sqlalchemy.ext.asyncio import AsyncSession

from api.deps import get_dashboard_service
from api.permissions import require_manager
from api.models.user import User
from api.services.dashboard_service import DashboardService
from shared.schemas.dashboard_schema import DashboardSummaryResponse

router = APIRouter(prefix="/admin", tags=["admin-dashboard"])

@router.get("/dashboard-summary", response_model=DashboardSummaryResponse)
async def get_dashboard_summary(
    current_user: User = Depends(require_manager),
    dashboard_service: DashboardService = Depends(get_dashboard_service)
) -> DashboardSummaryResponse:
    """
    ĞŸĞ¾Ğ»ÑƒÑ‡Ğ°ĞµÑ‚ ÑĞ²Ğ¾Ğ´Ğ½ÑƒÑ Ğ¸Ğ½Ñ„Ğ¾Ñ€Ğ¼Ğ°Ñ†Ğ¸Ñ Ğ´Ğ»Ñ Ğ¿Ğ°Ğ½ĞµĞ»Ğ¸ ÑƒĞ¿Ñ€Ğ°Ğ²Ğ»ĞµĞ½Ğ¸Ñ Ğ°Ğ´Ğ¼Ğ¸Ğ½ĞºĞ¸.
    
    Ğ’Ğ¾Ğ·Ğ²Ñ€Ğ°Ñ‰Ğ°ĞµÑ‚ Ğ°Ğ³Ñ€ĞµĞ³Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ½Ñ‹Ğµ Ğ´Ğ°Ğ½Ğ½Ñ‹Ğµ Ğ²ĞºĞ»ÑÑ‡Ğ°Ñ:
    - Ğ—Ğ°Ğ´Ğ°Ñ‡Ğ¸ Ğ½Ğ° ÑĞµĞ³Ğ¾Ğ´Ğ½Ñ (Ğ²Ñ‹Ğ´Ğ°Ñ‡Ğ¸, Ğ²Ğ¾Ğ·Ğ²Ñ€Ğ°Ñ‚Ñ‹, Ğ¿Ñ€Ğ¾ÑÑ€Ğ¾Ñ‡ĞºĞ¸)
    - ĞšĞ»ÑÑ‡ĞµĞ²Ñ‹Ğµ Ğ¿Ğ¾ĞºĞ°Ğ·Ğ°Ñ‚ĞµĞ»Ğ¸ (Ğ´Ğ¾Ñ…Ğ¾Ğ´, Ğ½Ğ¾Ğ²Ñ‹Ğµ Ğ°Ñ€ĞµĞ½Ğ´Ñ‹, ĞºĞ¾ÑÑ„Ñ„Ğ¸Ñ†Ğ¸ĞµĞ½Ñ‚ Ğ¸ÑĞ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ, Ğ½Ğ¾Ğ²Ñ‹Ğµ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ğ¸)
    - ĞŸĞ¾ÑĞ»ĞµĞ´Ğ½Ğ¸Ğµ ÑĞ¾Ğ±Ñ‹Ñ‚Ğ¸Ñ Ğ² ÑĞ¸ÑÑ‚ĞµĞ¼Ğµ
    - ĞŸĞ¾Ğ¿ÑƒĞ»ÑÑ€Ğ½Ğ¾Ğµ Ğ¾Ğ±Ğ¾Ñ€ÑƒĞ´Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ
    """
    return await dashboard_service.get_summary()


```


## <a name="RentalAppFASTAPIapiadminrentalapipy"></a>`RentalApp_FASTAPI/api/admin_rental_api.py`

```python
// path: RentalApp_FASTAPI/api/admin_rental_api.py

# api/admin_rental_api.py

from fastapi import APIRouter, Depends, Query, Response, status

from api.deps import get_order_lifecycle_service, get_rental_query_service
from api.permissions import require_manager, require_admin
from api.models.user import User
from api.services.rental.rental_query_service import RentalQueryService
from api.services.order.order_lifecycle_service import OrderLifecycleService
from shared.schemas.rental_schema import (
    RentalOut, RentalListResponse, RentalCreateFromReservationRequest,
    RentalReturnRequest, RentalCreateFromScratchRequest,
    AdminRentalUpdate
)

router = APIRouter(prefix="/admin/rentals", tags=["ĞĞ´Ğ¼Ğ¸Ğ½Ğ¸ÑÑ‚Ñ€Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ ĞÑ€ĞµĞ½Ğ´"])


@router.get("/", response_model=RentalListResponse)
async def get_all_rentals(
        current_user: User = Depends(require_manager),
        query_service: RentalQueryService = Depends(get_rental_query_service),
        status: str = Query(None, description="Ğ¤Ğ¸Ğ»ÑŒÑ‚Ñ€ Ğ¿Ğ¾ ÑÑ‚Ğ°Ñ‚ÑƒÑÑƒ: active, overdue, completed"),
        search: str = Query(None, description="ĞŸĞ¾Ğ¸ÑĞº Ğ¿Ğ¾ Ğ¸Ğ¼ĞµĞ½Ğ¸ Ğ¸Ğ»Ğ¸ email ĞºĞ»Ğ¸ĞµĞ½Ñ‚Ğ°"),
        skip: int = Query(0, ge=0),
        limit: int = Query(10, ge=1, le=100)
):
    """ĞŸĞ¾Ğ»ÑƒÑ‡Ğ¸Ñ‚ÑŒ ÑĞ¿Ğ¸ÑĞ¾Ğº Ğ²ÑĞµÑ… Ğ°Ñ€ĞµĞ½Ğ´ Ñ Ñ„Ğ¸Ğ»ÑŒÑ‚Ñ€Ğ°Ñ†Ğ¸ĞµĞ¹ Ğ¸ Ğ¿Ğ°Ğ³Ğ¸Ğ½Ğ°Ñ†Ğ¸ĞµĞ¹."""
    rentals_out, total = await query_service.get_paginated_rentals(skip, limit, status, search)
    return RentalListResponse(
        items=rentals_out,
        total=total
    )


@router.post("/", response_model=RentalOut)
async def create_rental_from_scratch(
        request: RentalCreateFromScratchRequest,
        current_user: User = Depends(require_manager),
        service: OrderLifecycleService = Depends(get_order_lifecycle_service)
):
    """Ğ¡Ğ¾Ğ·Ğ´Ğ°Ñ‚ÑŒ Ğ½Ğ¾Ğ²ÑƒÑ Ğ°Ñ€ĞµĞ½Ğ´Ñƒ Ğ±ĞµĞ· Ğ¿Ñ€ĞµĞ´Ğ²Ğ°Ñ€Ğ¸Ñ‚ĞµĞ»ÑŒĞ½Ğ¾Ğ³Ğ¾ Ñ€ĞµĞ·ĞµÑ€Ğ²Ğ°."""
    new_rental_orm = await service.create_rental_from_scratch(request, current_user)
    return RentalOut.model_validate(new_rental_orm)


@router.put("/{rental_id}", response_model=RentalOut)
async def update_rental_details(
        rental_id: int,
        request: AdminRentalUpdate,
        current_user: User = Depends(require_manager),
        service: OrderLifecycleService = Depends(get_order_lifecycle_service)
):
    """ĞĞ±Ğ½Ğ¾Ğ²Ğ¸Ñ‚ÑŒ Ğ´ĞµÑ‚Ğ°Ğ»Ğ¸ ÑÑƒÑ‰ĞµÑÑ‚Ğ²ÑƒÑÑ‰ĞµĞ¹ Ğ°Ñ€ĞµĞ½Ğ´Ñ‹."""
    updated_rental_orm = await service.update_rental_details_by_admin(rental_id, request, current_user)
    return RentalOut.model_validate(updated_rental_orm)


@router.post("/from-reservation/{reservation_id}", response_model=RentalOut)
async def convert_reservation_to_rental(
        reservation_id: int,
        request: RentalCreateFromReservationRequest,
        current_user: User = Depends(require_manager),
        service: OrderLifecycleService = Depends(get_order_lifecycle_service)
):
    """ĞšĞ¾Ğ½Ğ²ĞµÑ€Ñ‚Ğ¸Ñ€Ğ¾Ğ²Ğ°Ñ‚ÑŒ Ñ€ĞµĞ·ĞµÑ€Ğ² Ğ² Ğ°Ñ€ĞµĞ½Ğ´Ñƒ."""
    new_rental_orm = await service.convert_reservation_to_rental(reservation_id, request, current_user)
    return RentalOut.model_validate(new_rental_orm)


@router.post("/{rental_id}/return", response_model=RentalOut)
async def return_rental(
        rental_id: int,
        request: RentalReturnRequest,
        current_user: User = Depends(require_manager),
        service: OrderLifecycleService = Depends(get_order_lifecycle_service)
):
    """ĞÑ„Ğ¾Ñ€Ğ¼Ğ¸Ñ‚ÑŒ Ğ²Ğ¾Ğ·Ğ²Ñ€Ğ°Ñ‚ Ğ°Ñ€ĞµĞ½Ğ´Ñ‹."""
    returned_rental_orm = await service.return_rental(rental_id, request, current_user)
    return RentalOut.model_validate(returned_rental_orm)


@router.post("/{rental_id}/revert-to-reservation", status_code=status.HTTP_204_NO_CONTENT)
async def revert_rental_to_reservation(
        rental_id: int,
        current_user: User = Depends(require_manager),
        service: OrderLifecycleService = Depends(get_order_lifecycle_service)
):
    """
    ĞÑ‚Ğ¼ĞµĞ½Ğ¸Ñ‚ÑŒ Ğ²Ñ‹Ğ´Ğ°Ñ‡Ñƒ Ğ°Ñ€ĞµĞ½Ğ´Ñ‹ Ğ¸ Ğ²ĞµÑ€Ğ½ÑƒÑ‚ÑŒ ĞµĞµ Ğ² ÑÑ‚Ğ°Ñ‚ÑƒÑ Ñ€ĞµĞ·ĞµÑ€Ğ²Ğ°.
    Ğ”Ğ¾ÑÑ‚ÑƒĞ¿Ğ½Ğ¾ Ñ‚Ğ¾Ğ»ÑŒĞºĞ¾ Ğ² Ğ´ĞµĞ½ÑŒ ÑĞ¾Ğ·Ğ´Ğ°Ğ½Ğ¸Ñ Ğ°Ñ€ĞµĞ½Ğ´Ñ‹.
    """
    await service.revert_rental_to_reservation(rental_id, current_user)
    return Response(status_code=status.HTTP_204_NO_CONTENT)


@router.delete("/{rental_id}", status_code=204)
async def delete_rental_by_admin(
        rental_id: int,
        current_user: User = Depends(require_admin),
        service: OrderLifecycleService = Depends(get_order_lifecycle_service)
):
    """Ğ£Ğ´Ğ°Ğ»Ğ¸Ñ‚ÑŒ Ğ°Ñ€ĞµĞ½Ğ´Ñƒ (Ñ‚Ğ¾Ğ»ÑŒĞºĞ¾ Ğ´Ğ»Ñ Ğ°Ğ´Ğ¼Ğ¸Ğ½Ğ¸ÑÑ‚Ñ€Ğ°Ñ‚Ğ¾Ñ€Ğ¾Ğ²)."""
    await service.delete_rental_by_admin(rental_id)
    return None

```


## <a name="RentalAppFASTAPIapiadminreservationapipy"></a>`RentalApp_FASTAPI/api/admin_reservation_api.py`

```python
// path: RentalApp_FASTAPI/api/admin_reservation_api.py

# api/admin_reservation_api.py

from fastapi import APIRouter, Depends, Query, HTTPException, Response, status, Body
import logging

from api.deps import get_order_lifecycle_service, get_reservation_query_service
from api.permissions import require_manager
from api.models.user import User
from api.services.order.order_lifecycle_service import OrderLifecycleService
# <-- Ğ˜Ğ—ĞœĞ•ĞĞ•ĞĞ˜Ğ• Ğ—Ğ”Ğ•Ğ¡Ğ¬: Ğ˜Ğ¼Ğ¿Ğ¾Ñ€Ñ‚Ğ¸Ñ€ÑƒĞµĞ¼ Ğ½Ğ¾Ğ²Ñ‹Ğ¹ ĞµĞ´Ğ¸Ğ½Ñ‹Ğ¹ ÑĞµÑ€Ğ²Ğ¸Ñ Ğ´Ğ»Ñ Ñ‡Ñ‚ĞµĞ½Ğ¸Ñ Ğ´Ğ°Ğ½Ğ½Ñ‹Ñ…
from api.services.reservation_query_service import ReservationQueryService
# ----------------------------------------------------------------------
from shared.schemas.reservation_schema import (
    AdminReservationCreateRequest,
    ReservationResponse,
    ReservationUpdateRequest,
    AdminReservationListResponse,
    ReservationBulkDeleteRequest
)
from fastapi_csrf_protect import CsrfProtect

router = APIRouter(prefix="/admin/reservations", tags=["ĞĞ´Ğ¼Ğ¸Ğ½Ğ¸ÑÑ‚Ñ€Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ Ğ ĞµĞ·ĞµÑ€Ğ²Ğ¾Ğ²"])
logger = logging.getLogger(__name__)


@router.post("/delete-many", status_code=status.HTTP_204_NO_CONTENT)
async def delete_multiple_reservations(
        request: ReservationBulkDeleteRequest = Body(...),
        _current_user: User = Depends(require_manager),
        _csrf_protect: CsrfProtect = Depends(),
        service: OrderLifecycleService = Depends(get_order_lifecycle_service)
):
    """ĞœĞ°ÑÑĞ¾Ğ²Ğ¾ ÑƒĞ´Ğ°Ğ»Ğ¸Ñ‚ÑŒ Ñ€ĞµĞ·ĞµÑ€Ğ²Ñ‹ Ğ¿Ğ¾ Ğ¸Ñ… ID."""
    try:
        await service.bulk_cancel_admin_reservations(request.reservation_ids)
        return Response(status_code=status.HTTP_204_NO_CONTENT)
    except Exception as e:
        logger.error(f"Error during bulk deletion service call: {e}", exc_info=True)
        raise HTTPException(
            status_code=status.HTTP_500_INTERNAL_SERVER_ERROR,
            detail="Ğ’Ğ½ÑƒÑ‚Ñ€ĞµĞ½Ğ½ÑÑ Ğ¾ÑˆĞ¸Ğ±ĞºĞ° ÑĞµÑ€Ğ²ĞµÑ€Ğ° Ğ¿Ñ€Ğ¸ ÑƒĞ´Ğ°Ğ»ĞµĞ½Ğ¸Ğ¸ Ñ€ĞµĞ·ĞµÑ€Ğ²Ğ¾Ğ²."
        )

@router.get("/", response_model=AdminReservationListResponse)
async def get_all_reservations(
        _current_user: User = Depends(require_manager),
        query_service: ReservationQueryService = Depends(get_reservation_query_service),
        status: str = Query(None, description="Ğ¤Ğ¸Ğ»ÑŒÑ‚Ñ€ Ğ¿Ğ¾ ÑÑ‚Ğ°Ñ‚ÑƒÑÑƒ Ñ€ĞµĞ·ĞµÑ€Ğ²Ğ° ('active' Ğ¸Ğ»Ğ¸ 'completed')"),
        search: str = Query(None, description="ĞŸĞ¾Ğ¸ÑĞº Ğ¿Ğ¾ Ğ¸Ğ¼ĞµĞ½Ğ¸ Ğ¸Ğ»Ğ¸ email Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ñ"),
        skip: int = Query(0, ge=0, description="Ğ¡ĞºĞ¾Ğ»ÑŒĞºĞ¾ Ğ·Ğ°Ğ¿Ğ¸ÑĞµĞ¹ Ğ¿Ñ€Ğ¾Ğ¿ÑƒÑÑ‚Ğ¸Ñ‚ÑŒ"),
        limit: int = Query(10, ge=1, le=100, description="ĞœĞ°ĞºÑĞ¸Ğ¼Ğ°Ğ»ÑŒĞ½Ğ¾Ğµ ĞºĞ¾Ğ»Ğ¸Ñ‡ĞµÑÑ‚Ğ²Ğ¾ Ğ·Ğ°Ğ¿Ğ¸ÑĞµĞ¹ Ğ½Ğ° ÑÑ‚Ñ€Ğ°Ğ½Ğ¸Ñ†Ğµ")
):
    """ĞŸĞ¾Ğ»ÑƒÑ‡Ğ¸Ñ‚ÑŒ Ğ²ÑĞµ Ñ€ĞµĞ·ĞµÑ€Ğ²Ñ‹ Ñ Ğ¸Ğ½Ñ„Ğ¾Ñ€Ğ¼Ğ°Ñ†Ğ¸ĞµĞ¹ Ğ¾ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ÑÑ… Ñ Ğ¿Ğ°Ğ³Ğ¸Ğ½Ğ°Ñ†Ğ¸ĞµĞ¹."""
    total_reservations = await query_service.get_admin_reservations_count(status=status, search_query=search)
    paginated_reservations = await query_service.get_paginated_admin_reservations(
        skip=skip,
        limit=limit,
        status=status,
        search_query=search
    )
    return AdminReservationListResponse(
        items=paginated_reservations,
        total=total_reservations
    )

@router.post("/", response_model=ReservationResponse)
async def create_reservation_for_user(
        request: AdminReservationCreateRequest,
        _current_user: User = Depends(require_manager),
        _csrf_protect: CsrfProtect = Depends(),
        service: OrderLifecycleService = Depends(get_order_lifecycle_service)
):
    """Ğ¡Ğ¾Ğ·Ğ´Ğ°Ñ‚ÑŒ Ñ€ĞµĞ·ĞµÑ€Ğ² Ğ´Ğ»Ñ ĞºĞ¾Ğ½ĞºÑ€ĞµÑ‚Ğ½Ğ¾Ğ³Ğ¾ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ñ."""
    new_reservation = await service.create_admin_reservation(request)
    return ReservationResponse(reservation_id=new_reservation.id, message="Ğ ĞµĞ·ĞµÑ€Ğ² ÑƒÑĞ¿ĞµÑˆĞ½Ğ¾ ÑĞ¾Ğ·Ğ´Ğ°Ğ½")

@router.put("/{reservation_id}", response_model=ReservationResponse)
async def update_any_reservation(
        reservation_id: int,
        data: ReservationUpdateRequest,
        _current_user: User = Depends(require_manager),
        _csrf_protect: CsrfProtect = Depends(),
        service: OrderLifecycleService = Depends(get_order_lifecycle_service)
):
    """ĞĞ±Ğ½Ğ¾Ğ²Ğ¸Ñ‚ÑŒ Ğ»ÑĞ±Ğ¾Ğ¹ Ñ€ĞµĞ·ĞµÑ€Ğ² Ğ¿Ğ¾ ĞµĞ³Ğ¾ ID."""
    updated_reservation = await service.update_admin_reservation(reservation_id, data)
    return ReservationResponse(reservation_id=updated_reservation.id, message="Ğ ĞµĞ·ĞµÑ€Ğ² ÑƒÑĞ¿ĞµÑˆĞ½Ğ¾ Ğ¾Ğ±Ğ½Ğ¾Ğ²Ğ»ĞµĞ½")

@router.delete("/{reservation_id}", status_code=204)
async def delete_any_reservation(
        reservation_id: int,
        _current_user: User = Depends(require_manager),
        _csrf_protect: CsrfProtect = Depends(),
        service: OrderLifecycleService = Depends(get_order_lifecycle_service)
):
    """Ğ£Ğ´Ğ°Ğ»Ğ¸Ñ‚ÑŒ Ğ»ÑĞ±Ğ¾Ğ¹ Ñ€ĞµĞ·ĞµÑ€Ğ² Ğ¿Ğ¾ ĞµĞ³Ğ¾ ID."""
    await service.cancel_admin_reservation(reservation_id)
    return None

```


## <a name="RentalAppFASTAPIapiassociationapipy"></a>`RentalApp_FASTAPI/api/association_api.py`

```python
// path: RentalApp_FASTAPI/api/association_api.py

# api/association_api.py

from fastapi import APIRouter, Depends, HTTPException, Query
from sqlalchemy.ext.asyncio import AsyncSession
from sqlalchemy import select, func
from sqlalchemy.orm import selectinload
from typing import List

from api.deps import get_db
from api.models.user import User
from api.models.association import Association
from api.models.equipment import Equipment
from api.permissions import require_manager
from shared.schemas.association_schema import AssociationCreate, AssociationUpdate, AssociationOut, AssociationListResponse
from fastapi_csrf_protect import CsrfProtect

router = APIRouter(prefix="/associations", tags=["ĞÑÑĞ¾Ñ†Ğ¸Ğ°Ñ†Ğ¸Ğ¸"])

@router.get("/", response_model=AssociationListResponse)
async def get_all_associations(
        db: AsyncSession = Depends(get_db),
        skip: int = Query(0, ge=0, description="Ğ¡ĞºĞ¾Ğ»ÑŒĞºĞ¾ Ğ·Ğ°Ğ¿Ğ¸ÑĞµĞ¹ Ğ¿Ñ€Ğ¾Ğ¿ÑƒÑÑ‚Ğ¸Ñ‚ÑŒ"),
        limit: int = Query(10, ge=1, le=100, description="ĞœĞ°ĞºÑĞ¸Ğ¼Ğ°Ğ»ÑŒĞ½Ğ¾Ğµ ĞºĞ¾Ğ»Ğ¸Ñ‡ĞµÑÑ‚Ğ²Ğ¾ Ğ·Ğ°Ğ¿Ğ¸ÑĞµĞ¹ Ğ½Ğ° ÑÑ‚Ñ€Ğ°Ğ½Ğ¸Ñ†Ğµ")
):
    """
    ĞŸĞ¾Ğ»ÑƒÑ‡Ğ¸Ñ‚ÑŒ ÑĞ¿Ğ¸ÑĞ¾Ğº Ğ²ÑĞµÑ… Ğ°ÑÑĞ¾Ñ†Ğ¸Ğ°Ñ†Ğ¸Ğ¹, Ğ¾Ñ‚ÑĞ¾Ñ€Ñ‚Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ½Ñ‹Ñ… Ğ¿Ğ¾ Ğ¿Ğ¾Ñ€ÑĞ´ĞºÑƒ Ñ Ğ¿Ğ°Ğ³Ğ¸Ğ½Ğ°Ñ†Ğ¸ĞµĞ¹.
    Ğ­Ñ‚Ğ¾Ñ‚ ÑĞ½Ğ´Ğ¿Ğ¾Ğ¸Ğ½Ñ‚ Ğ¿ÑƒĞ±Ğ»Ğ¸Ñ‡Ğ½Ñ‹Ğ¹ Ğ¸ Ğ¸ÑĞ¿Ğ¾Ğ»ÑŒĞ·ÑƒĞµÑ‚ÑÑ Ğ´Ğ»Ñ Ñ„Ğ¸Ğ»ÑŒÑ‚Ñ€Ğ¾Ğ² Ğ½Ğ° Ğ³Ğ»Ğ°Ğ²Ğ½Ğ¾Ğ¹ ÑÑ‚Ñ€Ğ°Ğ½Ğ¸Ñ†Ğµ.
    """
    # 1. Ğ—Ğ°Ğ¿Ñ€Ğ¾Ñ Ğ´Ğ»Ñ Ğ¿Ğ¾Ğ»ÑƒÑ‡ĞµĞ½Ğ¸Ñ Ğ¾Ğ±Ñ‰ĞµĞ³Ğ¾ ĞºĞ¾Ğ»Ğ¸Ñ‡ĞµÑÑ‚Ğ²Ğ° Ğ°ÑÑĞ¾Ñ†Ğ¸Ğ°Ñ†Ğ¸Ğ¹
    total_result = await db.execute(select(func.count(Association.id)))
    total_associations = total_result.scalar_one()

    # 2. Ğ—Ğ°Ğ¿Ñ€Ğ¾Ñ Ğ´Ğ»Ñ Ğ¿Ğ¾Ğ»ÑƒÑ‡ĞµĞ½Ğ¸Ñ "ÑÑ‚Ñ€Ğ°Ğ½Ğ¸Ñ†Ñ‹" Ğ°ÑÑĞ¾Ñ†Ğ¸Ğ°Ñ†Ğ¸Ğ¹
    associations_result = await db.execute(
        select(Association)
        .options(selectinload(Association.equipment))
        .order_by(Association.sort_order, Association.name)
        .offset(skip)
        .limit(limit)
    )
    associations_orm = associations_result.unique().scalars().all()

    # 3. Ğ¤Ğ¾Ñ€Ğ¼Ğ¸Ñ€ÑƒĞµĞ¼ Ğ¸ Ğ²Ğ¾Ğ·Ğ²Ñ€Ğ°Ñ‰Ğ°ĞµĞ¼ Ğ½Ğ¾Ğ²Ñ‹Ğ¹ Ğ¾Ğ±ÑŠĞµĞºÑ‚ Ğ¾Ñ‚Ğ²ĞµÑ‚Ğ°
    return AssociationListResponse(
        items=[AssociationOut.from_orm(assoc) for assoc in associations_orm],
        total=total_associations
    )

@router.post("/", response_model=AssociationOut, status_code=201)
async def create_association(
        assoc_in: AssociationCreate,
        db: AsyncSession = Depends(get_db),
        _current_user: User = Depends(require_manager),
        _csrf_protect: CsrfProtect = Depends()
):
    """Ğ¡Ğ¾Ğ·Ğ´Ğ°Ñ‚ÑŒ Ğ½Ğ¾Ğ²ÑƒÑ Ğ°ÑÑĞ¾Ñ†Ğ¸Ğ°Ñ†Ğ¸Ñ (ĞœĞµĞ½ĞµĞ´Ğ¶ĞµÑ€/ĞĞ´Ğ¼Ğ¸Ğ½)."""
    result = await db.execute(select(Association).filter(Association.name == assoc_in.name))
    if result.scalars().first():
        raise HTTPException(status_code=409, detail="ĞÑÑĞ¾Ñ†Ğ¸Ğ°Ñ†Ğ¸Ñ Ñ Ñ‚Ğ°ĞºĞ¸Ğ¼ Ğ½Ğ°Ğ·Ğ²Ğ°Ğ½Ğ¸ĞµĞ¼ ÑƒĞ¶Ğµ ÑÑƒÑ‰ĞµÑÑ‚Ğ²ÑƒĞµÑ‚.")

    new_assoc = Association(
        name=assoc_in.name,
        description=assoc_in.description,
        sort_order=assoc_in.sort_order
    )

    if assoc_in.equipment_ids:
        equipment_result = await db.execute(
            select(Equipment)
            .filter(Equipment.id.in_(assoc_in.equipment_ids))
            .options(
                selectinload(Equipment.accessories),
                selectinload(Equipment.associations)
            )
        )
        equipment = equipment_result.unique().scalars().all()
        if len(equipment) != len(set(assoc_in.equipment_ids)):
            raise HTTPException(status_code=404, detail="ĞĞ´Ğ½Ğ¾ Ğ¸Ğ»Ğ¸ Ğ½ĞµÑĞºĞ¾Ğ»ÑŒĞºĞ¾ Ğ¾Ğ±Ğ¾Ñ€ÑƒĞ´Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğ¹ Ğ½Ğµ Ğ½Ğ°Ğ¹Ğ´ĞµĞ½Ğ¾.")
        new_assoc.equipment = equipment

    db.add(new_assoc)
    await db.commit()
    await db.refresh(new_assoc)
    
    # Ğ’Ğ¾Ğ·Ğ²Ñ€Ğ°Ñ‰Ğ°ĞµĞ¼ ÑĞ¾Ğ·Ğ´Ğ°Ğ½Ğ½Ñ‹Ğ¹ Ğ¾Ğ±ÑŠĞµĞºÑ‚ Ñ Ğ·Ğ°Ğ³Ñ€ÑƒĞ¶ĞµĞ½Ğ½Ñ‹Ğ¼Ğ¸ Ğ´Ğ°Ğ½Ğ½Ñ‹Ğ¼Ğ¸ Ğ¸Ğ· Ğ‘Ğ”
    result = await db.execute(
        select(Association)
        .filter(Association.id == new_assoc.id)
        .options(selectinload(Association.equipment))
    )
    return result.scalars().first()

@router.put("/{assoc_id}", response_model=AssociationOut)
async def update_association(
        assoc_id: int,
        assoc_in: AssociationUpdate,
        db: AsyncSession = Depends(get_db),
        _current_user: User = Depends(require_manager),
        _csrf_protect: CsrfProtect = Depends()
):
    """ĞĞ±Ğ½Ğ¾Ğ²Ğ¸Ñ‚ÑŒ Ğ°ÑÑĞ¾Ñ†Ğ¸Ğ°Ñ†Ğ¸Ñ (ĞœĞµĞ½ĞµĞ´Ğ¶ĞµÑ€/ĞĞ´Ğ¼Ğ¸Ğ½)."""
    result = await db.execute(
        select(Association)
        .filter(Association.id == assoc_id)
        .options(selectinload(Association.equipment))
    )
    assoc = result.scalars().first()
    if not assoc:
        raise HTTPException(status_code=404, detail="ĞÑÑĞ¾Ñ†Ğ¸Ğ°Ñ†Ğ¸Ñ Ğ½Ğµ Ğ½Ğ°Ğ¹Ğ´ĞµĞ½Ğ°.")

    update_data = assoc_in.model_dump(exclude_unset=True)

    if 'equipment_ids' in update_data:
        equipment_ids = update_data.pop('equipment_ids')
        assoc.equipment.clear()
        if equipment_ids:
            equipment_result = await db.execute(
                select(Equipment)
                .filter(Equipment.id.in_(equipment_ids))
                .options(
                    selectinload(Equipment.accessories),
                    selectinload(Equipment.associations)
                )
            )
            equipment = equipment_result.unique().scalars().all()
            if len(equipment) != len(set(equipment_ids)):
                raise HTTPException(status_code=404, detail="ĞĞ´Ğ½Ğ¾ Ğ¸Ğ»Ğ¸ Ğ½ĞµÑĞºĞ¾Ğ»ÑŒĞºĞ¾ Ğ¾Ğ±Ğ¾Ñ€ÑƒĞ´Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğ¹ Ğ½Ğµ Ğ½Ğ°Ğ¹Ğ´ĞµĞ½Ğ¾.")
            assoc.equipment = equipment

    for key, value in update_data.items():
        setattr(assoc, key, value)

    await db.commit()
    
    # ĞŸĞ¾Ğ²Ñ‚Ğ¾Ñ€Ğ½Ğ¾ Ğ¿Ğ¾Ğ»ÑƒÑ‡Ğ°ĞµĞ¼ Ğ¾Ğ±ÑŠĞµĞºÑ‚ Ğ¸Ğ· Ğ‘Ğ” Ñ Ğ·Ğ°Ğ³Ñ€ÑƒĞ¶ĞµĞ½Ğ½Ñ‹Ğ¼Ğ¸ ÑĞ²ÑĞ·ÑĞ¼Ğ¸
    result = await db.execute(
        select(Association)
        .filter(Association.id == assoc_id)
        .options(selectinload(Association.equipment))
    )
    return result.scalars().first()

@router.delete("/{assoc_id}", status_code=204)
async def delete_association(
        assoc_id: int,
        db: AsyncSession = Depends(get_db),
        _current_user: User = Depends(require_manager),
        _csrf_protect: CsrfProtect = Depends()
):
    """Ğ£Ğ´Ğ°Ğ»Ğ¸Ñ‚ÑŒ Ğ°ÑÑĞ¾Ñ†Ğ¸Ğ°Ñ†Ğ¸Ñ (ĞœĞµĞ½ĞµĞ´Ğ¶ĞµÑ€/ĞĞ´Ğ¼Ğ¸Ğ½)."""
    result = await db.execute(
        select(Association)
        .filter(Association.id == assoc_id)
        .options(selectinload(Association.equipment))
    )
    assoc = result.scalars().first()
    if not assoc:
        raise HTTPException(status_code=404, detail="ĞÑÑĞ¾Ñ†Ğ¸Ğ°Ñ†Ğ¸Ñ Ğ½Ğµ Ğ½Ğ°Ğ¹Ğ´ĞµĞ½Ğ°.")

    await db.delete(assoc)
    await db.commit()
    return None

```


## <a name="RentalAppFASTAPIapiauthapipy"></a>`RentalApp_FASTAPI/api/auth_api.py`

```python
// path: RentalApp_FASTAPI/api/auth_api.py

# api/auth_api.py

from fastapi import APIRouter, Depends, HTTPException, status, Request # Request Ğ¼Ğ¾Ğ¶ĞµÑ‚ Ğ¿Ğ¾Ğ½Ğ°Ğ´Ğ¾Ğ±Ğ¸Ñ‚ÑŒÑÑ Ğ´Ğ»Ñ Ğ¾Ñ‚Ğ»Ğ°Ğ´ĞºĞ¸ CSRF
from fastapi.security import OAuth2PasswordRequestForm, OAuth2PasswordBearer
from sqlalchemy.ext.asyncio import AsyncSession
from shared.schemas.user_schema import UserCreate, Token
from api.services.auth_service import (
    create_user,
    authenticate_user,
    create_access_token,
    get_user_by_token,
)
from api.models.user import User
from api.deps import get_db
from fastapi_csrf_protect import CsrfProtect # <--- Ğ”Ğ¾Ğ±Ğ°Ğ²Ğ»ĞµĞ½ Ğ¸Ğ¼Ğ¿Ğ¾Ñ€Ñ‚

router = APIRouter(prefix="/auth", tags=["ĞÑƒÑ‚ĞµĞ½Ñ‚Ğ¸Ñ„Ğ¸ĞºĞ°Ñ†Ğ¸Ñ"])

# OAuth2PasswordBearer Ğ¾Ğ¿Ñ€ĞµĞ´ĞµĞ»ÑĞµÑ‚, Ñ‡Ñ‚Ğ¾ Ğ´Ğ»Ñ Ğ¿Ğ¾Ğ»ÑƒÑ‡ĞµĞ½Ğ¸Ñ Ñ‚Ğ¾ĞºĞµĞ½Ğ° Ğ½ÑƒĞ¶Ğ½Ğ¾ Ğ¾Ğ±Ñ€Ğ°Ñ‚Ğ¸Ñ‚ÑŒÑÑ Ğº /auth/token
# Ğ¤Ñ€Ğ¾Ğ½Ñ‚ĞµĞ½Ğ´ Ğ´Ğ¾Ğ»Ğ¶ĞµĞ½ Ğ±ÑƒĞ´ĞµÑ‚ Ñ‚Ğ°ĞºĞ¶Ğµ Ğ¾Ñ‚Ğ¿Ñ€Ğ°Ğ²Ğ¸Ñ‚ÑŒ CSRF Ñ‚Ğ¾ĞºĞµĞ½ Ğ½Ğ° ÑÑ‚Ğ¾Ñ‚ ÑĞ½Ğ´Ğ¿Ğ¾Ğ¸Ğ½Ñ‚.
oauth2_scheme = OAuth2PasswordBearer(tokenUrl="/auth/token")


@router.post("/register", status_code=status.HTTP_201_CREATED)
async def register_user(
        user_data: UserCreate,
        db: AsyncSession = Depends(get_db),
        csrf_protect: CsrfProtect = Depends() # <--- Ğ”Ğ¾Ğ±Ğ°Ğ²Ğ»ĞµĞ½Ğ° Ğ·Ğ°Ğ²Ğ¸ÑĞ¸Ğ¼Ğ¾ÑÑ‚ÑŒ CSRF
):
    # Ğ—Ğ°Ğ²Ğ¸ÑĞ¸Ğ¼Ğ¾ÑÑ‚ÑŒ Depends(CsrfProtect) Ğ°Ğ²Ñ‚Ğ¾Ğ¼Ğ°Ñ‚Ğ¸Ñ‡ĞµÑĞºĞ¸ Ğ¿Ñ€Ğ¾Ğ²ĞµÑ€Ğ¸Ñ‚ CSRF Ñ‚Ğ¾ĞºĞµĞ½ Ğ´Ğ»Ñ POST Ğ·Ğ°Ğ¿Ñ€Ğ¾ÑĞ°.
    # Ğ¤Ñ€Ğ¾Ğ½Ñ‚ĞµĞ½Ğ´ Ğ´Ğ¾Ğ»Ğ¶ĞµĞ½ Ğ¾Ñ‚Ğ¿Ñ€Ğ°Ğ²Ğ¸Ñ‚ÑŒ CSRF Ñ‚Ğ¾ĞºĞµĞ½, Ğ¿Ğ¾Ğ»ÑƒÑ‡ĞµĞ½Ğ½Ñ‹Ğ¹ Ğ¸Ğ· cookie (Ğ¾Ğ±Ñ‹Ñ‡Ğ½Ğ¾ 'fastapi-csrf-token'),
    # Ğ² Ğ·Ğ°Ğ³Ğ¾Ğ»Ğ¾Ğ²ĞºĞµ 'X-CSRF-Token'.
    user = await create_user(db, user_data)
    return {"message": "ĞŸĞ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ÑŒ ÑƒÑĞ¿ĞµÑˆĞ½Ğ¾ Ğ·Ğ°Ñ€ĞµĞ³Ğ¸ÑÑ‚Ñ€Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½", "email": user.email}


@router.post("/token", response_model=Token)
async def login(
        form_data: OAuth2PasswordRequestForm = Depends(),
        db: AsyncSession = Depends(get_db),
        csrf_protect: CsrfProtect = Depends() # <--- Ğ”Ğ¾Ğ±Ğ°Ğ²Ğ»ĞµĞ½Ğ° Ğ·Ğ°Ğ²Ğ¸ÑĞ¸Ğ¼Ğ¾ÑÑ‚ÑŒ CSRF
):
    # Ğ—Ğ°Ğ²Ğ¸ÑĞ¸Ğ¼Ğ¾ÑÑ‚ÑŒ Depends(CsrfProtect) Ñ‚Ğ°ĞºĞ¶Ğµ Ğ°Ğ²Ñ‚Ğ¾Ğ¼Ğ°Ñ‚Ğ¸Ñ‡ĞµÑĞºĞ¸ Ğ¿Ñ€Ğ¾Ğ²ĞµÑ€Ğ¸Ñ‚ CSRF Ñ‚Ğ¾ĞºĞµĞ½ Ğ·Ğ´ĞµÑÑŒ.
    user = await authenticate_user(db, form_data.username, form_data.password)
    if not user:
        raise HTTPException(
            status_code=status.HTTP_401_UNAUTHORIZED, # Ğ˜ÑĞ¿Ğ¾Ğ»ÑŒĞ·ÑƒĞµĞ¼ ĞºĞ¾Ñ€Ñ€ĞµĞºÑ‚Ğ½Ñ‹Ğ¹ ÑÑ‚Ğ°Ñ‚ÑƒÑ
            detail="ĞĞµĞ²ĞµÑ€Ğ½Ñ‹Ğµ ÑƒÑ‡ĞµÑ‚Ğ½Ñ‹Ğµ Ğ´Ğ°Ğ½Ğ½Ñ‹Ğµ",
            headers={"WWW-Authenticate": "Bearer"}, # Ğ¡Ñ‚Ğ°Ğ½Ğ´Ğ°Ñ€Ñ‚Ğ½Ñ‹Ğ¹ Ğ·Ğ°Ğ³Ğ¾Ğ»Ğ¾Ğ²Ğ¾Ğº Ğ´Ğ»Ñ 401
        )
    access_token = create_access_token({"sub": user.email})

    # fastapi-csrf-protect Ğ°Ğ²Ñ‚Ğ¾Ğ¼Ğ°Ñ‚Ğ¸Ñ‡ĞµÑĞºĞ¸ Ğ´Ğ¾Ğ»Ğ¶ĞµĞ½ ÑƒÑÑ‚Ğ°Ğ½Ğ¾Ğ²Ğ¸Ñ‚ÑŒ/Ğ¾Ğ±Ğ½Ğ¾Ğ²Ğ¸Ñ‚ÑŒ CSRF cookie Ğ² Ğ¾Ñ‚Ğ²ĞµÑ‚Ğµ,
    # ĞºĞ¾Ğ³Ğ´Ğ° Ğ¸ÑĞ¿Ğ¾Ğ»ÑŒĞ·ÑƒĞµÑ‚ÑÑ Depends(CsrfProtect) Ğ¸ Ğ¼ĞµÑ‚Ğ¾Ğ´ ÑĞ²Ğ»ÑĞµÑ‚ÑÑ state-changing.
    # Ğ•ÑĞ»Ğ¸ Ğ²Ñ‹ Ñ…Ğ¾Ñ‚Ğ¸Ñ‚Ğµ Ğ±Ñ‹Ñ‚ÑŒ ÑƒĞ²ĞµÑ€ĞµĞ½Ñ‹ Ğ¸Ğ»Ğ¸ ÑƒĞ¿Ñ€Ğ°Ğ²Ğ»ÑÑ‚ÑŒ ÑÑ‚Ğ¸Ğ¼ ÑĞ²Ğ½Ğ¾ (Ğ½Ğ°Ğ¿Ñ€Ğ¸Ğ¼ĞµÑ€, Ğ´Ğ»Ñ Ğ¾Ñ‚Ğ²ĞµÑ‚Ğ° Ğ½Ğµ Ğ¾Ñ‚ FastAPI Response):
    # from fastapi.responses import JSONResponse
    # response_content = {"access_token": access_token, "token_type": "bearer"}
    # response = JSONResponse(content=response_content)
    # csrf_protect.set_csrf_cookie(response) # Ğ£ÑÑ‚Ğ°Ğ½Ğ¾Ğ²Ğ¸Ñ‚ÑŒ/Ğ¾Ğ±Ğ½Ğ¾Ğ²Ğ¸Ñ‚ÑŒ CSRF cookie Ğ² Ğ¾Ñ‚Ğ²ĞµÑ‚Ğµ
    # return response
    # ĞĞ¾ Ğ´Ğ»Ñ ÑÑ‚Ğ°Ğ½Ğ´Ğ°Ñ€Ñ‚Ğ½Ñ‹Ñ… FastAPI Ğ¾Ñ‚Ğ²ĞµÑ‚Ğ¾Ğ² Ğ¸ Ñ Depends() ÑÑ‚Ğ¾ Ğ¾Ğ±Ñ‹Ñ‡Ğ½Ğ¾ Ğ¿Ñ€Ğ¾Ğ¸ÑÑ…Ğ¾Ğ´Ğ¸Ñ‚ Ğ°Ğ²Ñ‚Ğ¾Ğ¼Ğ°Ñ‚Ğ¸Ñ‡ĞµÑĞºĞ¸.

    return {"access_token": access_token, "token_type": "bearer"}


async def get_current_user(
        token: str = Depends(oauth2_scheme), db: AsyncSession = Depends(get_db)
) -> User:
    user = await get_user_by_token(db, token)
    if not user:
        # Ğ˜ÑĞ¿Ñ€Ğ°Ğ²Ğ»ÑĞµĞ¼ ĞºĞ¾Ğ´ ÑÑ‚Ğ°Ñ‚ÑƒÑĞ° Ğ¸ Ğ´Ğ¾Ğ±Ğ°Ğ²Ğ»ÑĞµĞ¼ Ğ·Ğ°Ğ³Ğ¾Ğ»Ğ¾Ğ²Ğ¾Ğº Ğ´Ğ»Ñ Ğ¾ÑˆĞ¸Ğ±Ğ¾Ğº Ğ°ÑƒÑ‚ĞµĞ½Ñ‚Ğ¸Ñ„Ğ¸ĞºĞ°Ñ†Ğ¸Ğ¸
        raise HTTPException(
            status_code=status.HTTP_401_UNAUTHORIZED,
            detail="ĞĞµĞ´ĞµĞ¹ÑÑ‚Ğ²Ğ¸Ñ‚ĞµĞ»ÑŒĞ½Ñ‹Ğ¹ Ğ¸Ğ»Ğ¸ Ğ¿Ñ€Ğ¾ÑÑ€Ğ¾Ñ‡ĞµĞ½Ğ½Ñ‹Ğ¹ Ñ‚Ğ¾ĞºĞµĞ½ Ğ°ÑƒÑ‚ĞµĞ½Ñ‚Ğ¸Ñ„Ğ¸ĞºĞ°Ñ†Ğ¸Ğ¸",
            headers={"WWW-Authenticate": "Bearer"},
        )
    return user

```


## <a name="RentalAppFASTAPIapicalendarapipy"></a>`RentalApp_FASTAPI/api/calendar_api.py`

```python
// path: RentalApp_FASTAPI/api/calendar_api.py

# api/calendar_api.py

from fastapi import APIRouter, Query, Depends, HTTPException
from sqlalchemy.ext.asyncio import AsyncSession
from sqlalchemy import select, func
from datetime import date, timedelta
from typing import List, Optional

from fastapi.security import OAuth2PasswordBearer

from api.deps import get_db, get_availability_service
from api.services.availability import AvailabilityService
from api.models.equipment import Equipment as ApiEquipment
from api.models.user import User as ApiUser
from api.auth_api import get_current_user

from shared.schemas.calendar_schema import (
    EquipmentStatusResponse,
    EquipmentDayStatusesResponse,
    CalendarEventResponse,
    EquipmentStatusListResponse,
    CalendarEventListResponse,
)

optional_oauth2_scheme = OAuth2PasswordBearer(tokenUrl="/auth/token", auto_error=False)

async def get_current_user_optional(token: Optional[str] = Depends(optional_oauth2_scheme), db: AsyncSession = Depends(get_db)) -> Optional[ApiUser]:
    if token is None:
        return None
    try:
        from api.services.auth_service import get_user_by_token as get_user_by_token_service
        user = await get_user_by_token_service(db, token)
        return user
    except HTTPException:
        return None

router = APIRouter(prefix="/calendar", tags=["ĞšĞ°Ğ»ĞµĞ½Ğ´Ğ°Ñ€ÑŒ"])

@router.get("/view", response_model=EquipmentStatusListResponse)
async def get_calendar_view(
        start_date: date = Query(..., alias="start"),
        end_date: date = Query(..., alias="end"),
        equipment_ids: List[int] = Query(None, alias="ids"),
        exclude_reservation_id: Optional[int] = Query(None, alias="exclude_reservation_id"),
        db: AsyncSession = Depends(get_db),
        availability_service: AvailabilityService = Depends(get_availability_service),
        skip: int = Query(0, ge=0, description="Ğ¡ĞºĞ¾Ğ»ÑŒĞºĞ¾ Ğ·Ğ°Ğ¿Ğ¸ÑĞµĞ¹ Ğ¿Ñ€Ğ¾Ğ¿ÑƒÑÑ‚Ğ¸Ñ‚ÑŒ"),
        limit: int = Query(10, ge=1, le=100, description="ĞœĞ°ĞºÑĞ¸Ğ¼Ğ°Ğ»ÑŒĞ½Ğ¾Ğµ ĞºĞ¾Ğ»Ğ¸Ñ‡ĞµÑÑ‚Ğ²Ğ¾ Ğ·Ğ°Ğ¿Ğ¸ÑĞµĞ¹ Ğ½Ğ° ÑÑ‚Ñ€Ğ°Ğ½Ğ¸Ñ†Ğµ")
):
    if start_date == end_date:
        end_date = end_date + timedelta(days=1)

    if not equipment_ids:
        result = await db.execute(select(ApiEquipment))
        all_equipment = result.scalars().all()
        equipment_ids = [eq.id for eq in all_equipment]

    if not equipment_ids:
        return EquipmentStatusListResponse(items=[], total=0)

    # Ğ˜ÑĞ¿Ğ¾Ğ»ÑŒĞ·ÑƒĞµĞ¼ Ğ½Ğ¾Ğ²Ñ‹Ğ¹ AvailabilityService
    statuses = await availability_service.get_availability_statuses(
        equipment_ids=equipment_ids,
        start_date=start_date,
        end_date=end_date,
        exclude_reservation_id=exclude_reservation_id,
    )

    equipment_result = await db.execute(select(ApiEquipment).filter(ApiEquipment.id.in_(equipment_ids)))
    equipment = equipment_result.scalars().all()
    equipment_map = {e.id: e for e in equipment}

    result = []
    for eq_id, status_info in statuses.items():
        eq = equipment_map.get(eq_id)
        result.append(
            EquipmentStatusResponse(
                equipment_id=eq_id,
                status=status_info["status"],
                details=status_info["details"],
                name=eq.name if eq else None,
                equipment_type=eq.equipment_type if eq else None,
                brand=eq.brand if eq else None,
                start_date=status_info.get("start_date"),
                end_date=status_info.get("end_date"),
            )
        )

    total_items = len(result)
    paginated_result = result[skip:skip + limit]

    return EquipmentStatusListResponse(
        items=paginated_result,
        total=total_items
    )


@router.get("/day-statuses", response_model=EquipmentDayStatusesResponse)
async def get_calendar_day_statuses(
        start_date: date = Query(..., alias="start"),
        end_date: date = Query(..., alias="end"),
        equipment_ids: List[int] = Query(None, alias="ids"),
        exclude_reservation_id: Optional[int] = Query(None, alias="exclude_reservation_id"),
        db: AsyncSession = Depends(get_db),
        availability_service: AvailabilityService = Depends(get_availability_service),
        current_user: Optional[ApiUser] = Depends(get_current_user_optional)
):
    if start_date == end_date:
        end_date = end_date + timedelta(days=1)

    if not equipment_ids:
        result = await db.execute(select(ApiEquipment))
        all_equipment = result.scalars().all()
        equipment_ids = [eq.id for eq in all_equipment]

    if not equipment_ids:
        return {"equipment_day_statuses": {}}

    current_user_id: Optional[int] = current_user.id if current_user else None

    # Ğ˜ÑĞ¿Ğ¾Ğ»ÑŒĞ·ÑƒĞµĞ¼ Ğ½Ğ¾Ğ²Ñ‹Ğ¹ AvailabilityService
    statuses = await availability_service.get_daily_statuses(
        equipment_ids=equipment_ids,
        start_date=start_date,
        end_date=end_date,
        exclude_reservation_id=exclude_reservation_id,
        current_user_id=current_user_id
    )

    return {"equipment_day_statuses": statuses}


@router.get("/events", response_model=CalendarEventListResponse)
async def get_calendar_events(
        start: date = Query(..., alias="start"),
        end: date = Query(..., alias="end"),
        equipment_ids: List[int] = Query(None, alias="ids"),
        db: AsyncSession = Depends(get_db),
        availability_service: AvailabilityService = Depends(get_availability_service),
        skip: int = Query(0, ge=0, description="Ğ¡ĞºĞ¾Ğ»ÑŒĞºĞ¾ Ğ·Ğ°Ğ¿Ğ¸ÑĞµĞ¹ Ğ¿Ñ€Ğ¾Ğ¿ÑƒÑÑ‚Ğ¸Ñ‚ÑŒ"),
        limit: int = Query(10, ge=1, le=100, description="ĞœĞ°ĞºÑĞ¸Ğ¼Ğ°Ğ»ÑŒĞ½Ğ¾Ğµ ĞºĞ¾Ğ»Ğ¸Ñ‡ĞµÑÑ‚Ğ²Ğ¾ Ğ·Ğ°Ğ¿Ğ¸ÑĞµĞ¹ Ğ½Ğ° ÑÑ‚Ñ€Ğ°Ğ½Ğ¸Ñ†Ğµ")
):
    if not equipment_ids:
        result = await db.execute(select(ApiEquipment))
        all_equipment = result.scalars().all()
        equipment_ids = [eq.id for eq in all_equipment]

    # Ğ˜ÑĞ¿Ğ¾Ğ»ÑŒĞ·ÑƒĞµĞ¼ Ğ½Ğ¾Ğ²Ñ‹Ğ¹ AvailabilityService
    events = await availability_service.get_calendar_events(
        equipment_ids=equipment_ids,
        start_date=start,
        end_date=end,
    )

    total_events = len(events)
    paginated_events = events[skip:skip + limit]

    return CalendarEventListResponse(
        items=paginated_events,
        total=total_events
    )

```


## <a name="RentalAppFASTAPIapidatabasepy"></a>`RentalApp_FASTAPI/api/database.py`

```python
// path: RentalApp_FASTAPI/api/database.py

# api/database.py

from sqlalchemy.ext.asyncio import create_async_engine, async_sessionmaker, AsyncSession
from sqlalchemy.orm import declarative_base
# Ğ£Ğ±ĞµĞ´Ğ¸Ñ‚ĞµÑÑŒ, Ñ‡Ñ‚Ğ¾ Ğ²Ğ°Ñˆ Ñ„Ğ°Ğ¹Ğ» config/secrets.py ĞºĞ¾Ñ€Ñ€ĞµĞºÑ‚Ğ½Ğ¾ Ğ·Ğ°Ğ³Ñ€ÑƒĞ¶Ğ°ĞµÑ‚ DATABASE_URL Ğ¸Ğ· .env
# ĞĞ°Ğ¿Ñ€Ğ¸Ğ¼ĞµÑ€, Ğ¸ÑĞ¿Ğ¾Ğ»ÑŒĞ·ÑƒÑ pydantic_settings Ğ¸Ğ»Ğ¸ python-dotenv
from config.secrets import DATABASE_URL

# Ğ¡Ğ¾Ğ·Ğ´Ğ°ĞµĞ¼ Ğ°ÑĞ¸Ğ½Ñ…Ñ€Ğ¾Ğ½Ğ½Ñ‹Ğ¹ Ğ´Ğ²Ğ¸Ğ¶Ğ¾Ğº, Ğ¸ÑĞ¿Ğ¾Ğ»ÑŒĞ·ÑƒÑ URL Ğ½Ğ°Ğ¿Ñ€ÑĞ¼ÑƒÑ Ğ¸Ğ· ĞºĞ¾Ğ½Ñ„Ğ¸Ğ³ÑƒÑ€Ğ°Ñ†Ğ¸Ğ¸
engine = create_async_engine(DATABASE_URL, echo=False, future=True)

# Ğ¡Ğ¾Ğ·Ğ´Ğ°ĞµĞ¼ Ñ„Ğ°Ğ±Ñ€Ğ¸ĞºÑƒ Ğ°ÑĞ¸Ğ½Ñ…Ñ€Ğ¾Ğ½Ğ½Ñ‹Ñ… ÑĞµÑÑĞ¸Ğ¹
AsyncSessionLocal = async_sessionmaker(
    bind=engine,
    class_=AsyncSession,
    expire_on_commit=False,
    autocommit=False,
    autoflush=False
)

Base = declarative_base()

# Ğ¡Ğ¾Ğ·Ğ´Ğ°ĞµĞ¼ Ğ°ÑĞ¸Ğ½Ñ…Ñ€Ğ¾Ğ½Ğ½ÑƒÑ Ğ·Ğ°Ğ²Ğ¸ÑĞ¸Ğ¼Ğ¾ÑÑ‚ÑŒ Ğ´Ğ»Ñ Ğ¿Ğ¾Ğ»ÑƒÑ‡ĞµĞ½Ğ¸Ñ ÑĞµÑÑĞ¸Ğ¸
async def get_db() -> AsyncSession:
    """ĞÑĞ¸Ğ½Ñ…Ñ€Ğ¾Ğ½Ğ½Ñ‹Ğ¹ Ğ³ĞµĞ½ĞµÑ€Ğ°Ñ‚Ğ¾Ñ€ Ğ´Ğ»Ñ Ğ¿Ğ¾Ğ»ÑƒÑ‡ĞµĞ½Ğ¸Ñ ÑĞµÑÑĞ¸Ğ¸ Ğ±Ğ°Ğ·Ñ‹ Ğ´Ğ°Ğ½Ğ½Ñ‹Ñ…."""
    async with AsyncSessionLocal() as session:
        try:
            yield session
        finally:
            await session.close()

```


## <a name="RentalAppFASTAPIapidepspy"></a>`RentalApp_FASTAPI/api/deps.py`

```python
// path: RentalApp_FASTAPI/api/deps.py

# api/deps.py

from fastapi import Depends
from sqlalchemy.ext.asyncio import AsyncSession
from fastapi.security import OAuth2PasswordBearer
from fastapi import HTTPException, status

from api.database import get_db as get_database
from api.services.auth_service import get_user_by_token
from api.models.user import User

# Ğ˜Ğ¼Ğ¿Ğ¾Ñ€Ñ‚Ñ‹ ÑĞµÑ€Ğ²Ğ¸ÑĞ¾Ğ²
from api.services.order.order_lifecycle_service import OrderLifecycleService
from api.services.rental.rental_query_service import RentalQueryService
from api.services.reservation_query_service import ReservationQueryService
from api.services.balance_service import BalanceService
from api.services.equipment_query_builder import EquipmentQueryBuilder
from api.services.financial_service import FinancialService
from api.services.availability import AvailabilityService
from api.services.dashboard_service import DashboardService

# OAuth2PasswordBearer Ğ´Ğ»Ñ Ğ¿Ğ¾Ğ»ÑƒÑ‡ĞµĞ½Ğ¸Ñ Ñ‚Ğ¾ĞºĞµĞ½Ğ° Ğ¸Ğ· Ğ·Ğ°Ğ³Ğ¾Ğ»Ğ¾Ğ²ĞºĞ° Authorization
oauth2_scheme = OAuth2PasswordBearer(tokenUrl="/auth/token")


async def get_db():
    """Ğ—Ğ°Ğ²Ğ¸ÑĞ¸Ğ¼Ğ¾ÑÑ‚ÑŒ Ğ´Ğ»Ñ Ğ¿Ğ¾Ğ»ÑƒÑ‡ĞµĞ½Ğ¸Ñ ÑĞµÑÑĞ¸Ğ¸ Ğ±Ğ°Ğ·Ñ‹ Ğ´Ğ°Ğ½Ğ½Ñ‹Ñ…."""
    async for db in get_database():
        yield db


async def get_current_user(
    token: str = Depends(oauth2_scheme), 
    db: AsyncSession = Depends(get_db)
) -> User:
    """ĞŸĞ¾Ğ»ÑƒÑ‡Ğ¸Ñ‚ÑŒ Ñ‚ĞµĞºÑƒÑ‰ĞµĞ³Ğ¾ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ñ Ğ¿Ğ¾ Ñ‚Ğ¾ĞºĞµĞ½Ñƒ."""
    user = await get_user_by_token(db, token)
    if not user:
        raise HTTPException(
            status_code=status.HTTP_401_UNAUTHORIZED,
            detail="ĞĞµĞ´ĞµĞ¹ÑÑ‚Ğ²Ğ¸Ñ‚ĞµĞ»ÑŒĞ½Ñ‹Ğ¹ Ğ¸Ğ»Ğ¸ Ğ¿Ñ€Ğ¾ÑÑ€Ğ¾Ñ‡ĞµĞ½Ğ½Ñ‹Ğ¹ Ñ‚Ğ¾ĞºĞµĞ½ Ğ°ÑƒÑ‚ĞµĞ½Ñ‚Ğ¸Ñ„Ğ¸ĞºĞ°Ñ†Ğ¸Ğ¸",
            headers={"WWW-Authenticate": "Bearer"},
        )
    return user


# === Ğ—ĞĞ’Ğ˜Ğ¡Ğ˜ĞœĞĞ¡Ğ¢Ğ˜ Ğ”Ğ›Ğ¯ Ğ¡Ğ•Ğ Ğ’Ğ˜Ğ¡ĞĞ’ ===

def get_order_lifecycle_service(db: AsyncSession = Depends(get_db)) -> OrderLifecycleService:
    """Ğ—Ğ°Ğ²Ğ¸ÑĞ¸Ğ¼Ğ¾ÑÑ‚ÑŒ Ğ´Ğ»Ñ Ğ¿Ğ¾Ğ»ÑƒÑ‡ĞµĞ½Ğ¸Ñ ÑĞµÑ€Ğ²Ğ¸ÑĞ° Ğ¶Ğ¸Ğ·Ğ½ĞµĞ½Ğ½Ğ¾Ğ³Ğ¾ Ñ†Ğ¸ĞºĞ»Ğ° Ğ·Ğ°ĞºĞ°Ğ·Ğ¾Ğ²."""
    return OrderLifecycleService(db)


def get_rental_query_service(db: AsyncSession = Depends(get_db)) -> RentalQueryService:
    """Ğ—Ğ°Ğ²Ğ¸ÑĞ¸Ğ¼Ğ¾ÑÑ‚ÑŒ Ğ´Ğ»Ñ Ğ¿Ğ¾Ğ»ÑƒÑ‡ĞµĞ½Ğ¸Ñ ÑĞµÑ€Ğ²Ğ¸ÑĞ° Ğ·Ğ°Ğ¿Ñ€Ğ¾ÑĞ¾Ğ² Ğ°Ñ€ĞµĞ½Ğ´Ñ‹."""
    return RentalQueryService(db)


def get_reservation_query_service(db: AsyncSession = Depends(get_db)) -> ReservationQueryService:
    """Ğ—Ğ°Ğ²Ğ¸ÑĞ¸Ğ¼Ğ¾ÑÑ‚ÑŒ Ğ´Ğ»Ñ Ğ¿Ğ¾Ğ»ÑƒÑ‡ĞµĞ½Ğ¸Ñ ÑĞµÑ€Ğ²Ğ¸ÑĞ° Ğ·Ğ°Ğ¿Ñ€Ğ¾ÑĞ¾Ğ² Ñ€ĞµĞ·ĞµÑ€Ğ²Ğ°Ñ†Ğ¸Ğ¹."""
    return ReservationQueryService(db)




def get_balance_service(db: AsyncSession = Depends(get_db)) -> BalanceService:
    """Ğ—Ğ°Ğ²Ğ¸ÑĞ¸Ğ¼Ğ¾ÑÑ‚ÑŒ Ğ´Ğ»Ñ Ğ¿Ğ¾Ğ»ÑƒÑ‡ĞµĞ½Ğ¸Ñ ÑĞµÑ€Ğ²Ğ¸ÑĞ° Ğ±Ğ°Ğ»Ğ°Ğ½ÑĞ°."""
    return BalanceService(db)


def get_equipment_query_builder(db: AsyncSession = Depends(get_db)) -> EquipmentQueryBuilder:
    """Ğ—Ğ°Ğ²Ğ¸ÑĞ¸Ğ¼Ğ¾ÑÑ‚ÑŒ Ğ´Ğ»Ñ Ğ¿Ğ¾Ğ»ÑƒÑ‡ĞµĞ½Ğ¸Ñ Ğ±Ğ¸Ğ»Ğ´ĞµÑ€Ğ° Ğ·Ğ°Ğ¿Ñ€Ğ¾ÑĞ¾Ğ² Ğ¾Ğ±Ğ¾Ñ€ÑƒĞ´Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ."""
    return EquipmentQueryBuilder(db)


def get_financial_service(db: AsyncSession = Depends(get_db)) -> FinancialService:
    """Ğ—Ğ°Ğ²Ğ¸ÑĞ¸Ğ¼Ğ¾ÑÑ‚ÑŒ Ğ´Ğ»Ñ Ğ¿Ğ¾Ğ»ÑƒÑ‡ĞµĞ½Ğ¸Ñ Ñ„Ğ¸Ğ½Ğ°Ğ½ÑĞ¾Ğ²Ğ¾Ğ³Ğ¾ ÑĞµÑ€Ğ²Ğ¸ÑĞ°."""
    return FinancialService(db)


def get_availability_service(db: AsyncSession = Depends(get_db)) -> AvailabilityService:
    """Ğ—Ğ°Ğ²Ğ¸ÑĞ¸Ğ¼Ğ¾ÑÑ‚ÑŒ Ğ´Ğ»Ñ Ğ¿Ğ¾Ğ»ÑƒÑ‡ĞµĞ½Ğ¸Ñ ÑĞµÑ€Ğ²Ğ¸ÑĞ° Ğ¿Ñ€Ğ¾Ğ²ĞµÑ€ĞºĞ¸ Ğ´Ğ¾ÑÑ‚ÑƒĞ¿Ğ½Ğ¾ÑÑ‚Ğ¸ Ğ¾Ğ±Ğ¾Ñ€ÑƒĞ´Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ."""
    return AvailabilityService(db)


def get_dashboard_service(db: AsyncSession = Depends(get_db)) -> DashboardService:
    """Ğ—Ğ°Ğ²Ğ¸ÑĞ¸Ğ¼Ğ¾ÑÑ‚ÑŒ Ğ´Ğ»Ñ Ğ¿Ğ¾Ğ»ÑƒÑ‡ĞµĞ½Ğ¸Ñ ÑĞµÑ€Ğ²Ğ¸ÑĞ° Ğ¿Ğ°Ğ½ĞµĞ»Ğ¸ ÑƒĞ¿Ñ€Ğ°Ğ²Ğ»ĞµĞ½Ğ¸Ñ."""
    return DashboardService(db)

```


## <a name="RentalAppFASTAPIapidiscountapipy"></a>`RentalApp_FASTAPI/api/discount_api.py`

```python
// path: RentalApp_FASTAPI/api/discount_api.py

# api/discount_api.py

from typing import List
from fastapi import APIRouter, Depends, HTTPException, Query
from sqlalchemy.ext.asyncio import AsyncSession
from sqlalchemy import select, func
from fastapi_csrf_protect import CsrfProtect

from api.deps import get_db
from api.models.user import User
from api.models.discount import DurationDiscount
from api.permissions import require_admin
from shared.schemas.discount_schema import DiscountCreate, DiscountUpdate, DiscountOut, DiscountListResponse

router = APIRouter(prefix="/discounts", tags=["Ğ¡ĞºĞ¸Ğ´ĞºĞ¸ Ğ·Ğ° Ğ´Ğ»Ğ¸Ñ‚ĞµĞ»ÑŒĞ½Ğ¾ÑÑ‚ÑŒ"])

@router.get("/", response_model=DiscountListResponse)
async def get_all_discounts(
        db: AsyncSession = Depends(get_db),
        skip: int = Query(0, ge=0, description="Ğ¡ĞºĞ¾Ğ»ÑŒĞºĞ¾ Ğ·Ğ°Ğ¿Ğ¸ÑĞµĞ¹ Ğ¿Ñ€Ğ¾Ğ¿ÑƒÑÑ‚Ğ¸Ñ‚ÑŒ"),
        limit: int = Query(10, ge=1, le=100, description="ĞœĞ°ĞºÑĞ¸Ğ¼Ğ°Ğ»ÑŒĞ½Ğ¾Ğµ ĞºĞ¾Ğ»Ğ¸Ñ‡ĞµÑÑ‚Ğ²Ğ¾ Ğ·Ğ°Ğ¿Ğ¸ÑĞµĞ¹ Ğ½Ğ° ÑÑ‚Ñ€Ğ°Ğ½Ğ¸Ñ†Ğµ")
):
    """ĞŸĞ¾Ğ»ÑƒÑ‡Ğ¸Ñ‚ÑŒ Ğ²ÑĞµ ÑƒÑ€Ğ¾Ğ²Ğ½Ğ¸ ÑĞºĞ¸Ğ´Ğ¾Ğº Ğ·Ğ° Ğ´Ğ»Ğ¸Ñ‚ĞµĞ»ÑŒĞ½Ğ¾ÑÑ‚ÑŒ Ñ Ğ¿Ğ°Ğ³Ğ¸Ğ½Ğ°Ñ†Ğ¸ĞµĞ¹."""
    # 1. Ğ—Ğ°Ğ¿Ñ€Ğ¾Ñ Ğ´Ğ»Ñ Ğ¿Ğ¾Ğ»ÑƒÑ‡ĞµĞ½Ğ¸Ñ Ğ¾Ğ±Ñ‰ĞµĞ³Ğ¾ ĞºĞ¾Ğ»Ğ¸Ñ‡ĞµÑÑ‚Ğ²Ğ° ÑĞºĞ¸Ğ´Ğ¾Ğº
    total_result = await db.execute(select(func.count(DurationDiscount.id)))
    total_discounts = total_result.scalar_one()

    # 2. Ğ—Ğ°Ğ¿Ñ€Ğ¾Ñ Ğ´Ğ»Ñ Ğ¿Ğ¾Ğ»ÑƒÑ‡ĞµĞ½Ğ¸Ñ "ÑÑ‚Ñ€Ğ°Ğ½Ğ¸Ñ†Ñ‹" ÑĞºĞ¸Ğ´Ğ¾Ğº
    discounts_result = await db.execute(
        select(DurationDiscount).order_by(DurationDiscount.min_days).offset(skip).limit(limit)
    )
    discounts_orm = discounts_result.scalars().all()

    # 3. Ğ¤Ğ¾Ñ€Ğ¼Ğ¸Ñ€ÑƒĞµĞ¼ Ğ¸ Ğ²Ğ¾Ğ·Ğ²Ñ€Ğ°Ñ‰Ğ°ĞµĞ¼ Ğ½Ğ¾Ğ²Ñ‹Ğ¹ Ğ¾Ğ±ÑŠĞµĞºÑ‚ Ğ¾Ñ‚Ğ²ĞµÑ‚Ğ°
    return DiscountListResponse(
        items=[DiscountOut.from_orm(discount) for discount in discounts_orm],
        total=total_discounts
    )

@router.post("/", response_model=DiscountOut, status_code=201)
async def create_discount(
        discount_in: DiscountCreate,
        db: AsyncSession = Depends(get_db),
        current_user: User = Depends(require_admin),
        csrf_protect: CsrfProtect = Depends()
):
    """Ğ¡Ğ¾Ğ·Ğ´Ğ°Ñ‚ÑŒ Ğ½Ğ¾Ğ²Ñ‹Ğ¹ ÑƒÑ€Ğ¾Ğ²ĞµĞ½ÑŒ ÑĞºĞ¸Ğ´ĞºĞ¸."""
    result = await db.execute(select(DurationDiscount).filter(DurationDiscount.min_days == discount_in.min_days))
    existing = result.scalars().first()
    if existing:
        raise HTTPException(status_code=409, detail=f"Ğ¡ĞºĞ¸Ğ´ĞºĞ° Ğ´Ğ»Ñ {discount_in.min_days} Ğ´Ğ½ĞµĞ¹ ÑƒĞ¶Ğµ ÑÑƒÑ‰ĞµÑÑ‚Ğ²ÑƒĞµÑ‚.")

    new_discount = DurationDiscount(**discount_in.model_dump())
    db.add(new_discount)
    await db.commit()
    await db.refresh(new_discount)
    
    # Ğ’Ğ¾Ğ·Ğ²Ñ€Ğ°Ñ‰Ğ°ĞµĞ¼ ÑĞ¾Ğ·Ğ´Ğ°Ğ½Ğ½Ñ‹Ğ¹ Ğ¾Ğ±ÑŠĞµĞºÑ‚ Ñ Ğ·Ğ°Ğ³Ñ€ÑƒĞ¶ĞµĞ½Ğ½Ñ‹Ğ¼Ğ¸ Ğ´Ğ°Ğ½Ğ½Ñ‹Ğ¼Ğ¸ Ğ¸Ğ· Ğ‘Ğ”
    return new_discount

@router.put("/{discount_id}", response_model=DiscountOut)
async def update_discount(
        discount_id: int,
        discount_in: DiscountUpdate,
        db: AsyncSession = Depends(get_db),
        current_user: User = Depends(require_admin),
        csrf_protect: CsrfProtect = Depends()
):
    """ĞĞ±Ğ½Ğ¾Ğ²Ğ¸Ñ‚ÑŒ ÑÑƒÑ‰ĞµÑÑ‚Ğ²ÑƒÑÑ‰Ğ¸Ğ¹ ÑƒÑ€Ğ¾Ğ²ĞµĞ½ÑŒ ÑĞºĞ¸Ğ´ĞºĞ¸."""
    result = await db.execute(select(DurationDiscount).filter(DurationDiscount.id == discount_id))
    discount = result.scalars().first()
    if not discount:
        raise HTTPException(status_code=404, detail="Ğ¡ĞºĞ¸Ğ´ĞºĞ° Ğ½Ğµ Ğ½Ğ°Ğ¹Ğ´ĞµĞ½Ğ°.")

    existing_result = await db.execute(
        select(DurationDiscount).filter(
            DurationDiscount.min_days == discount_in.min_days,
            DurationDiscount.id != discount_id
        )
    )
    existing = existing_result.scalars().first()
    if existing:
        raise HTTPException(status_code=409, detail=f"Ğ¡ĞºĞ¸Ğ´ĞºĞ° Ğ´Ğ»Ñ {discount_in.min_days} Ğ´Ğ½ĞµĞ¹ ÑƒĞ¶Ğµ ÑÑƒÑ‰ĞµÑÑ‚Ğ²ÑƒĞµÑ‚.")

    update_data = discount_in.model_dump()
    for key, value in update_data.items():
        setattr(discount, key, value)

    await db.commit()
    await db.refresh(discount)
    
    # Ğ’Ğ¾Ğ·Ğ²Ñ€Ğ°Ñ‰Ğ°ĞµĞ¼ Ğ¾Ğ±Ğ½Ğ¾Ğ²Ğ»ĞµĞ½Ğ½Ñ‹Ğ¹ Ğ¾Ğ±ÑŠĞµĞºÑ‚ Ñ Ğ·Ğ°Ğ³Ñ€ÑƒĞ¶ĞµĞ½Ğ½Ñ‹Ğ¼Ğ¸ Ğ´Ğ°Ğ½Ğ½Ñ‹Ğ¼Ğ¸ Ğ¸Ğ· Ğ‘Ğ”
    return discount

@router.delete("/{discount_id}", status_code=204)
async def delete_discount(
        discount_id: int,
        db: AsyncSession = Depends(get_db),
        current_user: User = Depends(require_admin),
        csrf_protect: CsrfProtect = Depends()
):
    """Ğ£Ğ´Ğ°Ğ»Ğ¸Ñ‚ÑŒ ÑƒÑ€Ğ¾Ğ²ĞµĞ½ÑŒ ÑĞºĞ¸Ğ´ĞºĞ¸."""
    result = await db.execute(select(DurationDiscount).filter(DurationDiscount.id == discount_id))
    discount = result.scalars().first()
    if not discount:
        raise HTTPException(status_code=404, detail="Ğ¡ĞºĞ¸Ğ´ĞºĞ° Ğ½Ğµ Ğ½Ğ°Ğ¹Ğ´ĞµĞ½Ğ°.")

    await db.delete(discount)
    await db.commit()
    return None

```


## <a name="RentalAppFASTAPIapiequipmentapipy"></a>`RentalApp_FASTAPI/api/equipment_api.py`

```python
// path: RentalApp_FASTAPI/api/equipment_api.py

# api/equipment_api.py

from fastapi import APIRouter, Depends, HTTPException, Query
from sqlalchemy.ext.asyncio import AsyncSession
from sqlalchemy import select, func
from sqlalchemy.orm import selectinload
from typing import List, Optional
from datetime import date, datetime
from collections import defaultdict
from fastapi_csrf_protect import CsrfProtect

from api.models.equipment import Equipment
from api.models.user import User
from api.models.rental import Rental
from api.models.reservation import Reservation
from api.deps import get_db
from api.permissions import require_manager
# --- Ğ˜Ğ—ĞœĞ•ĞĞ•ĞĞ˜Ğ•: Ğ˜Ğ¼Ğ¿Ğ¾Ñ€Ñ‚Ğ¸Ñ€ÑƒĞµĞ¼ Ğ½Ğ¾Ğ²ÑƒÑ ÑĞµÑ€Ğ²Ğ¸ÑĞ½ÑƒÑ Ñ„ÑƒĞ½ĞºÑ†Ğ¸Ñ Ğ¸ ÑÑ…ĞµĞ¼Ñƒ Ğ¾Ñ‚Ğ²ĞµÑ‚Ğ° ---
from api.services.equipment_service_api import get_paginated_equipment, update_equipment_details
from shared.schemas.equipment_schema import (
    EquipmentOut,
    EquipmentTreeItem,
    EquipmentUpdateExtended,
    EquipmentCreate,
    EquipmentAvailabilityStatus,
    EquipmentListResponse,
    EquipmentTreeListResponse
)

router = APIRouter(prefix="/equipment", tags=["ĞĞ±Ğ¾Ñ€ÑƒĞ´Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ"])


@router.get("/", response_model=EquipmentListResponse)
async def list_equipment_paginated(
        db: AsyncSession = Depends(get_db),
        skip: int = Query(0, ge=0),
        limit: int = Query(10, ge=1, le=1000),
        query: Optional[str] = Query(None),
        type: Optional[str] = Query(None),
        brand: Optional[str] = Query(None),
        association_id: Optional[int] = Query(None, alias="associationId"),
        start_date: Optional[date] = Query(None, alias="startDate"),
        end_date: Optional[date] = Query(None, alias="endDate"),
        available_only: bool = Query(False, alias="availableOnly")
):
    """Ğ’Ğ¾Ğ·Ğ²Ñ€Ğ°Ñ‰Ğ°ĞµÑ‚ Ğ¾Ñ‚Ñ„Ğ¸Ğ»ÑŒÑ‚Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ½Ñ‹Ğ¹ Ğ¸ Ğ¿Ğ°Ğ³Ğ¸Ğ½Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ½Ñ‹Ğ¹ ÑĞ¿Ğ¸ÑĞ¾Ğº Ğ¾Ğ±Ğ¾Ñ€ÑƒĞ´Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ."""
    items, total = await get_paginated_equipment(
        db, skip=skip, limit=limit, query=query, type=type, brand=brand,
        association_id=association_id, start_date=start_date, end_date=end_date,
        available_only=available_only
    )
    return EquipmentListResponse(items=items, total=total)


@router.get("/tree", response_model=EquipmentTreeListResponse)
async def get_equipment_tree(
        db: AsyncSession = Depends(get_db),
        skip: int = Query(0, ge=0),
        limit: int = Query(10, ge=1, le=100)
):
    """Ğ’Ğ¾Ğ·Ğ²Ñ€Ğ°Ñ‰Ğ°ĞµÑ‚ Ğ¾Ğ±Ğ¾Ñ€ÑƒĞ´Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ, ÑĞ³Ñ€ÑƒĞ¿Ğ¿Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ½Ğ¾Ğµ Ğ² Ğ²Ğ¸Ğ´Ğµ Ğ´ĞµÑ€ĞµĞ²Ğ° Ğ¿Ğ¾ Ñ‚Ğ¸Ğ¿Ñƒ Ğ¸ Ğ±Ñ€ĞµĞ½Ğ´Ñƒ Ñ Ğ¿Ğ°Ğ³Ğ¸Ğ½Ğ°Ñ†Ğ¸ĞµĞ¹."""
    result = await db.execute(select(Equipment))
    all_equipment = result.scalars().all()
    grouped: dict[str, dict[str, list[Equipment]]] = defaultdict(lambda: defaultdict(list))
    for eq in all_equipment:
        grouped[eq.equipment_type][eq.brand].append(eq)

    result = []
    for eq_type, brands in grouped.items():
        type_node = EquipmentTreeItem(label=eq_type, children=[])
        for brand, items in brands.items():
            brand_node = EquipmentTreeItem(label=brand, children=[
                EquipmentTreeItem(label=item.name, value=item.id) for item in items
            ])
            type_node.children.append(brand_node)
        result.append(type_node)

    total_items = len(result)
    paginated_result = result[skip:skip + limit]

    return EquipmentTreeListResponse(
        items=paginated_result,
        total=total_items
    )


@router.put("/{equipment_id}", response_model=EquipmentOut)
async def update_single_equipment_details_route(
        equipment_id: int,
        equipment_data: EquipmentUpdateExtended,
        db: AsyncSession = Depends(get_db),
        _current_user: User = Depends(require_manager),
        _csrf_protect: CsrfProtect = Depends()
):
    """ĞĞ±Ğ½Ğ¾Ğ²Ğ»ÑĞµÑ‚ Ğ´ĞµÑ‚Ğ°Ğ»Ğ¸ ÑƒĞºĞ°Ğ·Ğ°Ğ½Ğ½Ğ¾Ğ³Ğ¾ Ğ¾Ğ±Ğ¾Ñ€ÑƒĞ´Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ."""
    updated_equipment = await update_equipment_details(db, equipment_id, equipment_data)
    return updated_equipment


@router.post("/", response_model=EquipmentOut)
async def create_equipment(
        equipment_data: EquipmentCreate,
        db: AsyncSession = Depends(get_db),
        _current_user: User = Depends(require_manager),
        _csrf_protect: CsrfProtect = Depends()
):
    """Ğ¡Ğ¾Ğ·Ğ´Ğ°ĞµÑ‚ Ğ½Ğ¾Ğ²Ğ¾Ğµ Ğ¾Ğ±Ğ¾Ñ€ÑƒĞ´Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ."""
    equipment = Equipment(**equipment_data.model_dump())
    db.add(equipment)
    await db.commit()
    await db.refresh(equipment)
    
    # Ğ—Ğ°Ğ³Ñ€ÑƒĞ¶Ğ°ĞµĞ¼ ÑĞ²ÑĞ·Ğ°Ğ½Ğ½Ñ‹Ğµ Ğ¾Ğ±ÑŠĞµĞºÑ‚Ñ‹ Ğ´Ğ»Ñ ĞºĞ¾Ñ€Ñ€ĞµĞºÑ‚Ğ½Ğ¾Ğ¹ ÑĞµÑ€Ğ¸Ğ°Ğ»Ğ¸Ğ·Ğ°Ñ†Ğ¸Ğ¸
    result = await db.execute(
        select(Equipment)
        .filter(Equipment.id == equipment.id)
        .options(
            selectinload(Equipment.accessories),
            selectinload(Equipment.associations)
        )
    )
    equipment_with_relations = result.scalars().first()
    
    return equipment_with_relations


@router.delete("/{equipment_id}")
async def delete_equipment(
        equipment_id: int,
        db: AsyncSession = Depends(get_db),
        _current_user: User = Depends(require_manager),
        _csrf_protect: CsrfProtect = Depends()
):
    """Ğ£Ğ´Ğ°Ğ»ÑĞµÑ‚ Ğ¾Ğ±Ğ¾Ñ€ÑƒĞ´Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ."""
    result = await db.execute(select(Equipment).filter(Equipment.id == equipment_id))
    equipment = result.scalars().first()
    if not equipment:
        raise HTTPException(status_code=404, detail="ĞĞ±Ğ¾Ñ€ÑƒĞ´Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ Ğ½Ğµ Ğ½Ğ°Ğ¹Ğ´ĞµĞ½Ğ¾")
    await db.delete(equipment)
    await db.commit()
    return {"message": "ĞĞ±Ğ¾Ñ€ÑƒĞ´Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ ÑƒĞ´Ğ°Ğ»ĞµĞ½Ğ¾"}


@router.get("/{equipment_id}/availability", response_model=EquipmentAvailabilityStatus)
async def get_equipment_availability_status(
        equipment_id: int,
        db: AsyncSession = Depends(get_db),
        _current_user: User = Depends(require_manager)
):
    """
    ĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑĞµÑ‚, ÑƒÑ‡Ğ°ÑÑ‚Ğ²ÑƒĞµÑ‚ Ğ»Ğ¸ Ğ¾Ğ±Ğ¾Ñ€ÑƒĞ´Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ Ğ² ĞĞ•Ğ—ĞĞ’Ğ•Ğ Ğ¨Ğ•ĞĞĞ«Ğ¥ Ñ€ĞµĞ·ĞµÑ€Ğ²Ğ°Ñ… Ğ¸Ğ»Ğ¸ Ğ°Ñ€ĞµĞ½Ğ´Ğ°Ñ….
    """
    result = await db.execute(select(Equipment).filter(Equipment.id == equipment_id))
    equipment = result.scalars().first()
    if not equipment:
        raise HTTPException(status_code=404, detail="ĞĞ±Ğ¾Ñ€ÑƒĞ´Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ Ğ½Ğµ Ğ½Ğ°Ğ¹Ğ´ĞµĞ½Ğ¾")

    today_start_of_day = datetime.combine(date.today(), datetime.min.time())

    reservations_result = await db.execute(
        select(func.count(Reservation.id)).filter(
            Reservation.equipment.any(Equipment.id == equipment_id),
            Reservation.end_date >= today_start_of_day
        )
    )
    active_reservations_count = reservations_result.scalar_one()

    rentals_result = await db.execute(
        select(func.count(Rental.id)).filter(
            Rental.equipment.any(Equipment.id == equipment_id),
            Rental.end_date >= today_start_of_day
        )
    )
    active_rentals_count = rentals_result.scalar_one()

    return EquipmentAvailabilityStatus(
        has_active_reservations=active_reservations_count > 0,
        has_active_rentals=active_rentals_count > 0,
        active_reservations_count=active_reservations_count,
        active_rentals_count=active_rentals_count,
    )

```


## <a name="RentalAppFASTAPIapiholidayapipy"></a>`RentalApp_FASTAPI/api/holiday_api.py`

```python
// path: RentalApp_FASTAPI/api/holiday_api.py

# api/holiday_api.py

from fastapi import APIRouter, Depends, HTTPException, Query
from sqlalchemy.ext.asyncio import AsyncSession
from sqlalchemy import select, func
from typing import List
from datetime import date, timedelta, datetime
import holidays

from api.deps import get_db
from api.permissions import require_admin
from api.models.user import User
from api.models.holiday import Holiday, HolidayRule
from api.models.reservation import Reservation
from shared.schemas.holiday_schema import HolidayOut, HolidayCreate, RecurringHolidayRuleCreate, HolidayRuleOut, HolidayListResponse, HolidayRuleListResponse

router = APIRouter(prefix="/holidays", tags=["Ğ’Ñ‹Ñ…Ğ¾Ğ´Ğ½Ñ‹Ğµ Ğ¸ Ğ¿Ñ€Ğ°Ğ·Ğ´Ğ½Ğ¸ĞºĞ¸"])

@router.get("/", response_model=HolidayListResponse)
async def get_holidays(
        start_date: date,
        end_date: date,
        db: AsyncSession = Depends(get_db),
        skip: int = Query(0, ge=0, description="Ğ¡ĞºĞ¾Ğ»ÑŒĞºĞ¾ Ğ·Ğ°Ğ¿Ğ¸ÑĞµĞ¹ Ğ¿Ñ€Ğ¾Ğ¿ÑƒÑÑ‚Ğ¸Ñ‚ÑŒ"),
        limit: int = Query(400, ge=1, description="ĞœĞ°ĞºÑĞ¸Ğ¼Ğ°Ğ»ÑŒĞ½Ğ¾Ğµ ĞºĞ¾Ğ»Ğ¸Ñ‡ĞµÑÑ‚Ğ²Ğ¾ Ğ·Ğ°Ğ¿Ğ¸ÑĞµĞ¹ Ğ½Ğ° ÑÑ‚Ñ€Ğ°Ğ½Ğ¸Ñ†Ğµ")
):
    """ĞŸĞ¾Ğ»ÑƒÑ‡Ğ¸Ñ‚ÑŒ ÑĞ¿Ğ¸ÑĞ¾Ğº Ğ²Ñ‹Ñ…Ğ¾Ğ´Ğ½Ñ‹Ñ… Ğ² Ğ·Ğ°Ğ´Ğ°Ğ½Ğ½Ğ¾Ğ¼ Ğ´Ğ¸Ğ°Ğ¿Ğ°Ğ·Ğ¾Ğ½Ğµ Ğ´Ğ°Ñ‚ Ñ Ğ¿Ğ°Ğ³Ğ¸Ğ½Ğ°Ñ†Ğ¸ĞµĞ¹."""
    # 1. Ğ—Ğ°Ğ¿Ñ€Ğ¾Ñ Ğ´Ğ»Ñ Ğ¿Ğ¾Ğ»ÑƒÑ‡ĞµĞ½Ğ¸Ñ Ğ¾Ğ±Ñ‰ĞµĞ³Ğ¾ ĞºĞ¾Ğ»Ğ¸Ñ‡ĞµÑÑ‚Ğ²Ğ° Ğ²Ñ‹Ñ…Ğ¾Ğ´Ğ½Ñ‹Ñ… Ğ² Ğ´Ğ¸Ğ°Ğ¿Ğ°Ğ·Ğ¾Ğ½Ğµ
    total_result = await db.execute(
        select(func.count(Holiday.date)).filter(Holiday.date.between(start_date, end_date))
    )
    total_holidays = total_result.scalar_one()

    # 2. Ğ—Ğ°Ğ¿Ñ€Ğ¾Ñ Ğ´Ğ»Ñ Ğ¿Ğ¾Ğ»ÑƒÑ‡ĞµĞ½Ğ¸Ñ "ÑÑ‚Ñ€Ğ°Ğ½Ğ¸Ñ†Ñ‹" Ğ²Ñ‹Ñ…Ğ¾Ğ´Ğ½Ñ‹Ñ…
    holidays_result = await db.execute(
        select(Holiday).filter(Holiday.date.between(start_date, end_date)).offset(skip).limit(limit)
    )
    holidays_orm = holidays_result.scalars().all()

    # 3. Ğ¤Ğ¾Ñ€Ğ¼Ğ¸Ñ€ÑƒĞµĞ¼ Ğ¸ Ğ²Ğ¾Ğ·Ğ²Ñ€Ğ°Ñ‰Ğ°ĞµĞ¼ Ğ½Ğ¾Ğ²Ñ‹Ğ¹ Ğ¾Ğ±ÑŠĞµĞºÑ‚ Ğ¾Ñ‚Ğ²ĞµÑ‚Ğ°
    return HolidayListResponse(
        items=[HolidayOut.from_orm(holiday) for holiday in holidays_orm],
        total=total_holidays
    )

@router.post("/", response_model=dict)
async def create_holiday(
        holiday_in: HolidayCreate,
        db: AsyncSession = Depends(get_db),
        current_user: User = Depends(require_admin)
):
    """Ğ¡Ğ¾Ğ·Ğ´Ğ°Ñ‚ÑŒ Ğ½Ğ¾Ğ²Ñ‹Ğ¹ Ğ²Ñ‹Ñ…Ğ¾Ğ´Ğ½Ğ¾Ğ¹ Ğ´ĞµĞ½ÑŒ (Ñ€ÑƒÑ‡Ğ½Ğ¾Ğµ Ğ´Ğ¾Ğ±Ğ°Ğ²Ğ»ĞµĞ½Ğ¸Ğµ)."""
    conflicting_result = await db.execute(
        select(Reservation.id).filter(
            (Reservation.start_date == holiday_in.date) | (Reservation.end_date == holiday_in.date)
        )
    )
    conflicting_ids = [r.id for r in conflicting_result.scalars().all()]
    if conflicting_ids and not holiday_in.force:
        raise HTTPException(
            status_code=409,
            detail={
                "message": "Ğ­Ñ‚Ğ° Ğ´Ğ°Ñ‚Ğ° ÑĞ²Ğ»ÑĞµÑ‚ÑÑ Ğ½Ğ°Ñ‡Ğ°Ğ»Ğ¾Ğ¼ Ğ¸Ğ»Ğ¸ ĞºĞ¾Ğ½Ñ†Ğ¾Ğ¼ ÑÑƒÑ‰ĞµÑÑ‚Ğ²ÑƒÑÑ‰Ğ¸Ñ… Ñ€ĞµĞ·ĞµÑ€Ğ²Ğ¾Ğ². ĞŸĞ¾Ğ´Ñ‚Ğ²ĞµÑ€Ğ´Ğ¸Ñ‚Ğµ Ğ´ĞµĞ¹ÑÑ‚Ğ²Ğ¸Ğµ.",
                "conflicting_reservation_ids": conflicting_ids
            }
        )
    existing_result = await db.execute(select(Holiday).filter(Holiday.date == holiday_in.date))
    existing_holiday = existing_result.scalars().first()
    if existing_holiday:
        raise HTTPException(status_code=400, detail="Ğ­Ñ‚Ğ¾Ñ‚ Ğ´ĞµĞ½ÑŒ ÑƒĞ¶Ğµ ÑĞ²Ğ»ÑĞµÑ‚ÑÑ Ğ²Ñ‹Ñ…Ğ¾Ğ´Ğ½Ñ‹Ğ¼.")
    new_holiday = Holiday(
        **holiday_in.model_dump(exclude={"force"}),
        created_by_id=current_user.id
    )
    db.add(new_holiday)
    await db.commit()
    await db.refresh(new_holiday)
    return {"message": "Ğ’Ñ‹Ñ…Ğ¾Ğ´Ğ½Ğ¾Ğ¹ Ğ´ĞµĞ½ÑŒ ÑƒÑĞ¿ĞµÑˆĞ½Ğ¾ Ğ´Ğ¾Ğ±Ğ°Ğ²Ğ»ĞµĞ½", "date": new_holiday.date}


@router.delete("/{holiday_date}", status_code=204)
async def delete_holiday(
        holiday_date: date,
        db: AsyncSession = Depends(get_db),
        _current_user: User = Depends(require_admin)
):
    """Ğ£Ğ´Ğ°Ğ»Ğ¸Ñ‚ÑŒ Ğ²Ñ‹Ñ…Ğ¾Ğ´Ğ½Ğ¾Ğ¹ Ğ´ĞµĞ½ÑŒ."""
    result = await db.execute(select(Holiday).filter(Holiday.date == holiday_date))
    holiday = result.scalars().first()
    if not holiday:
        raise HTTPException(status_code=404, detail="Ğ’Ñ‹Ñ…Ğ¾Ğ´Ğ½Ğ¾Ğ¹ Ğ´ĞµĞ½ÑŒ Ğ½Ğµ Ğ½Ğ°Ğ¹Ğ´ĞµĞ½")
    await db.delete(holiday)
    await db.commit()
    return None

@router.post("/recurring/weekly", status_code=201, summary="Ğ¡Ğ¾Ğ·Ğ´Ğ°Ñ‚ÑŒ ĞµĞ¶ĞµĞ½ĞµĞ´ĞµĞ»ÑŒĞ½Ñ‹Ğµ Ğ²Ñ‹Ñ…Ğ¾Ğ´Ğ½Ñ‹Ğµ")
async def create_weekly_recurring_holidays(
        rule_in: RecurringHolidayRuleCreate,
        db: AsyncSession = Depends(get_db),
        current_user: User = Depends(require_admin)
):
    """Ğ¡Ğ¾Ğ·Ğ´Ğ°ĞµÑ‚ Ğ¿Ñ€Ğ°Ğ²Ğ¸Ğ»Ğ¾ Ğ¸ Ğ³ĞµĞ½ĞµÑ€Ğ¸Ñ€ÑƒĞµÑ‚ Ğ²Ñ‹Ñ…Ğ¾Ğ´Ğ½Ñ‹Ğµ Ğ´Ğ»Ñ ÑƒĞºĞ°Ğ·Ğ°Ğ½Ğ½Ğ¾Ğ³Ğ¾ Ğ´Ğ½Ñ Ğ½ĞµĞ´ĞµĞ»Ğ¸ Ğ² Ğ´Ğ¸Ğ°Ğ¿Ğ°Ğ·Ğ¾Ğ½Ğµ Ğ´Ğ°Ñ‚."""
    if rule_in.start_date >= rule_in.end_date:
        raise HTTPException(status_code=400, detail="Ğ”Ğ°Ñ‚Ğ° Ğ½Ğ°Ñ‡Ğ°Ğ»Ğ° Ğ´Ğ¾Ğ»Ğ¶Ğ½Ğ° Ğ±Ñ‹Ñ‚ÑŒ Ñ€Ğ°Ğ½ÑŒÑˆĞµ Ğ´Ğ°Ñ‚Ñ‹ Ğ¾ĞºĞ¾Ğ½Ñ‡Ğ°Ğ½Ğ¸Ñ.")
    new_rule = HolidayRule(
        rule_type="weekly",
        parameters={"day_of_week": rule_in.day_of_week},
        description=rule_in.description,
        created_by_id=current_user.id
    )
    db.add(new_rule)
    await db.flush()
    holidays_to_create = []
    current_date = rule_in.start_date
    while current_date <= rule_in.end_date:
        if current_date.weekday() == rule_in.day_of_week:
            exists_result = await db.execute(select(Holiday).filter(Holiday.date == current_date))
            exists = exists_result.scalars().first()
            if not exists:
                holidays_to_create.append(
                    Holiday(
                        date=current_date,
                        description=f"ĞĞ²Ñ‚Ğ¾ (Ğ¿Ñ€Ğ°Ğ²Ğ¸Ğ»Ğ¾ #{new_rule.id})",
                        created_by_id=current_user.id,
                        rule_id=new_rule.id
                    )
                )
        current_date += timedelta(days=1)
    if holidays_to_create:
        db.add_all(holidays_to_create)
    await db.commit()
    return {"message": f"ĞŸÑ€Ğ°Ğ²Ğ¸Ğ»Ğ¾ ÑĞ¾Ğ·Ğ´Ğ°Ğ½Ğ¾. Ğ”Ğ¾Ğ±Ğ°Ğ²Ğ»ĞµĞ½Ğ¾ {len(holidays_to_create)} Ğ½Ğ¾Ğ²Ñ‹Ñ… Ğ²Ñ‹Ñ…Ğ¾Ğ´Ğ½Ñ‹Ñ…."}


@router.post("/import/public", status_code=201, summary="Ğ˜Ğ¼Ğ¿Ğ¾Ñ€Ñ‚Ğ¸Ñ€Ğ¾Ğ²Ğ°Ñ‚ÑŒ Ğ³Ğ¾Ñ. Ğ¿Ñ€Ğ°Ğ·Ğ´Ğ½Ğ¸ĞºĞ¸")
async def import_public_holidays(
        country_code: str = Query("RU", description="ISO 3166-1 alpha-2 ĞºĞ¾Ğ´ ÑÑ‚Ñ€Ğ°Ğ½Ñ‹"),
        year: int = Query(datetime.now().year, description="Ğ“Ğ¾Ğ´ Ğ´Ğ»Ñ Ğ¸Ğ¼Ğ¿Ğ¾Ñ€Ñ‚Ğ°"),
        db: AsyncSession = Depends(get_db),
        current_user: User = Depends(require_admin)
):
    """Ğ˜Ğ¼Ğ¿Ğ¾Ñ€Ñ‚Ğ¸Ñ€ÑƒĞµÑ‚ Ğ³Ğ¾ÑÑƒĞ´Ğ°Ñ€ÑÑ‚Ğ²ĞµĞ½Ğ½Ñ‹Ğµ Ğ¿Ñ€Ğ°Ğ·Ğ´Ğ½Ğ¸ĞºĞ¸ Ğ´Ğ»Ñ ÑƒĞºĞ°Ğ·Ğ°Ğ½Ğ½Ğ¾Ğ¹ ÑÑ‚Ñ€Ğ°Ğ½Ñ‹ Ğ¸ Ğ³Ğ¾Ğ´Ğ°."""
    try:
        public_holidays = holidays.country_holidays(country_code, years=year)
        if not public_holidays:
            raise HTTPException(status_code=404, detail=f"ĞĞµ Ğ½Ğ°Ğ¹Ğ´ĞµĞ½Ñ‹ Ğ¿Ñ€Ğ°Ğ·Ğ´Ğ½Ğ¸ĞºĞ¸ Ğ´Ğ»Ñ ÑÑ‚Ñ€Ğ°Ğ½Ñ‹ '{country_code}' Ğ² {year} Ğ³Ğ¾Ğ´Ñƒ.")
    except KeyError:
        raise HTTPException(status_code=400, detail=f"ĞĞµĞ²ĞµÑ€Ğ½Ñ‹Ğ¹ ĞºĞ¾Ğ´ ÑÑ‚Ñ€Ğ°Ğ½Ñ‹: '{country_code}'")

    rule_description = f"Ğ˜Ğ¼Ğ¿Ğ¾Ñ€Ñ‚ Ğ³Ğ¾Ñ. Ğ¿Ñ€Ğ°Ğ·Ğ´Ğ½Ğ¸ĞºĞ¾Ğ² Ğ´Ğ»Ñ {country_code} Ğ½Ğ° {year} Ğ³Ğ¾Ğ´"
    new_rule = HolidayRule(
        rule_type="public_import",
        parameters={"country": country_code, "year": year},
        description=rule_description,
        created_by_id=current_user.id
    )
    db.add(new_rule)
    await db.flush()

    holidays_to_create = []
    for holiday_date, holiday_name in public_holidays.items():
        exists_result = await db.execute(select(Holiday).filter(Holiday.date == holiday_date))
        exists = exists_result.scalars().first()
        if not exists:
            holidays_to_create.append(
                Holiday(
                    date=holiday_date,
                    description=holiday_name,
                    created_by_id=current_user.id,
                    rule_id=new_rule.id
                )
            )

    if holidays_to_create:
        db.add_all(holidays_to_create)

    await db.commit()
    return {"message": f"ĞŸÑ€Ğ°Ğ²Ğ¸Ğ»Ğ¾ Ğ¸Ğ¼Ğ¿Ğ¾Ñ€Ñ‚Ğ° ÑĞ¾Ğ·Ğ´Ğ°Ğ½Ğ¾. Ğ”Ğ¾Ğ±Ğ°Ğ²Ğ»ĞµĞ½Ğ¾ {len(holidays_to_create)} Ğ¿Ñ€Ğ°Ğ·Ğ´Ğ½Ğ¸Ñ‡Ğ½Ñ‹Ñ… Ğ´Ğ½ĞµĞ¹."}

@router.get("/rules", response_model=HolidayRuleListResponse, summary="ĞŸĞ¾Ğ»ÑƒÑ‡Ğ¸Ñ‚ÑŒ ÑĞ¿Ğ¸ÑĞ¾Ğº Ğ²ÑĞµÑ… Ğ¿Ñ€Ğ°Ğ²Ğ¸Ğ»")
async def get_all_rules(
        db: AsyncSession = Depends(get_db),
        current_user: User = Depends(require_admin),
        skip: int = Query(0, ge=0, description="Ğ¡ĞºĞ¾Ğ»ÑŒĞºĞ¾ Ğ·Ğ°Ğ¿Ğ¸ÑĞµĞ¹ Ğ¿Ñ€Ğ¾Ğ¿ÑƒÑÑ‚Ğ¸Ñ‚ÑŒ"),
        limit: int = Query(10, ge=1, le=100, description="ĞœĞ°ĞºÑĞ¸Ğ¼Ğ°Ğ»ÑŒĞ½Ğ¾Ğµ ĞºĞ¾Ğ»Ğ¸Ñ‡ĞµÑÑ‚Ğ²Ğ¾ Ğ·Ğ°Ğ¿Ğ¸ÑĞµĞ¹ Ğ½Ğ° ÑÑ‚Ñ€Ğ°Ğ½Ğ¸Ñ†Ğµ")
):
    """Ğ’Ğ¾Ğ·Ğ²Ñ€Ğ°Ñ‰Ğ°ĞµÑ‚ Ğ²ÑĞµ ÑĞ¾Ğ·Ğ´Ğ°Ğ½Ğ½Ñ‹Ğµ Ğ¿Ñ€Ğ°Ğ²Ğ¸Ğ»Ğ° Ğ´Ğ»Ñ Ğ³ĞµĞ½ĞµÑ€Ğ°Ñ†Ğ¸Ğ¸ Ğ²Ñ‹Ñ…Ğ¾Ğ´Ğ½Ñ‹Ñ… Ñ Ğ¿Ğ°Ğ³Ğ¸Ğ½Ğ°Ñ†Ğ¸ĞµĞ¹."""
    # 1. Ğ—Ğ°Ğ¿Ñ€Ğ¾Ñ Ğ´Ğ»Ñ Ğ¿Ğ¾Ğ»ÑƒÑ‡ĞµĞ½Ğ¸Ñ Ğ¾Ğ±Ñ‰ĞµĞ³Ğ¾ ĞºĞ¾Ğ»Ğ¸Ñ‡ĞµÑÑ‚Ğ²Ğ° Ğ¿Ñ€Ğ°Ğ²Ğ¸Ğ»
    total_result = await db.execute(select(func.count(HolidayRule.id)))
    total_rules = total_result.scalar_one()

    # 2. Ğ—Ğ°Ğ¿Ñ€Ğ¾Ñ Ğ´Ğ»Ñ Ğ¿Ğ¾Ğ»ÑƒÑ‡ĞµĞ½Ğ¸Ñ "ÑÑ‚Ñ€Ğ°Ğ½Ğ¸Ñ†Ñ‹" Ğ¿Ñ€Ğ°Ğ²Ğ¸Ğ»
    rules_result = await db.execute(
        select(HolidayRule).order_by(HolidayRule.created_at.desc()).offset(skip).limit(limit)
    )
    rules_orm = rules_result.scalars().all()

    # 3. Ğ¤Ğ¾Ñ€Ğ¼Ğ¸Ñ€ÑƒĞµĞ¼ Ğ¸ Ğ²Ğ¾Ğ·Ğ²Ñ€Ğ°Ñ‰Ğ°ĞµĞ¼ Ğ½Ğ¾Ğ²Ñ‹Ğ¹ Ğ¾Ğ±ÑŠĞµĞºÑ‚ Ğ¾Ñ‚Ğ²ĞµÑ‚Ğ°
    return HolidayRuleListResponse(
        items=[HolidayRuleOut.from_orm(rule) for rule in rules_orm],
        total=total_rules
    )


@router.delete("/rules/{rule_id}", status_code=204, summary="Ğ£Ğ´Ğ°Ğ»Ğ¸Ñ‚ÑŒ Ğ¿Ñ€Ğ°Ğ²Ğ¸Ğ»Ğ¾ Ğ¸ ÑĞ²ÑĞ·Ğ°Ğ½Ğ½Ñ‹Ğµ Ñ Ğ½Ğ¸Ğ¼ Ğ²Ñ‹Ñ…Ğ¾Ğ´Ğ½Ñ‹Ğµ")
async def delete_rule(
        rule_id: int,
        db: AsyncSession = Depends(get_db),
        current_user: User = Depends(require_admin)
):
    """Ğ£Ğ´Ğ°Ğ»ÑĞµÑ‚ Ğ¿Ñ€Ğ°Ğ²Ğ¸Ğ»Ğ¾. Ğ‘Ğ»Ğ°Ğ³Ğ¾Ğ´Ğ°Ñ€Ñ `cascade='all, delete-orphan'`, Ğ²ÑĞµ ÑĞ¾Ğ·Ğ´Ğ°Ğ½Ğ½Ñ‹Ğµ Ğ¸Ğ¼ Ğ²Ñ‹Ñ…Ğ¾Ğ´Ğ½Ñ‹Ğµ Ğ±ÑƒĞ´ÑƒÑ‚ ÑƒĞ´Ğ°Ğ»ĞµĞ½Ñ‹ Ğ°Ğ²Ñ‚Ğ¾Ğ¼Ğ°Ñ‚Ğ¸Ñ‡ĞµÑĞºĞ¸."""
    result = await db.execute(select(HolidayRule).filter(HolidayRule.id == rule_id))
    rule = result.scalars().first()
    if not rule:
        raise HTTPException(status_code=404, detail="ĞŸÑ€Ğ°Ğ²Ğ¸Ğ»Ğ¾ Ğ½Ğµ Ğ½Ğ°Ğ¹Ğ´ĞµĞ½Ğ¾.")

    await db.delete(rule)
    await db.commit()
    return None

```


## <a name="RentalAppFASTAPIapiinitmodelspy"></a>`RentalApp_FASTAPI/api/init_models.py`

```python
// path: RentalApp_FASTAPI/api/init_models.py

# ĞŸÑ€Ğ¸Ğ¼ĞµÑ€ Ğ´Ğ»Ñ api/init_models.py
from api.database import engine, Base
# âœ… Ğ­Ñ‚Ğ¾Ñ‚ Ğ¸Ğ¼Ğ¿Ğ¾Ñ€Ñ‚ ÑƒĞ¶Ğµ Ğ²ĞºĞ»ÑÑ‡Ğ°ĞµÑ‚ Ğ½Ğ°Ñˆ Ğ½Ğ¾Ğ²Ñ‹Ğ¹ ĞºĞ»Ğ°ÑÑ PromoCodeApplicableType
from api.models import user, equipment, reservation, accessory, promo_code

if __name__ == "__main__":
    Base.metadata.create_all(bind=engine)
    print("âœ… FastAPI-Ğ¼Ğ¾Ğ´ĞµĞ»Ğ¸ ÑƒÑĞ¿ĞµÑˆĞ½Ğ¾ Ğ¸Ğ½Ğ¸Ñ†Ğ¸Ğ°Ğ»Ğ¸Ğ·Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ñ‹")

```


## <a name="RentalAppFASTAPIapimainapipy"></a>`RentalApp_FASTAPI/api/main_api.py`

```python
// path: RentalApp_FASTAPI/api/main_api.py

# api/main_api.py

import secrets
import logging # <--- Ğ”ĞĞ‘ĞĞ’Ğ¬Ğ¢Ğ• Ğ­Ğ¢ĞĞ¢ Ğ˜ĞœĞŸĞĞ Ğ¢

from fastapi import FastAPI, Request, Response, HTTPException, status, APIRouter
from fastapi.middleware.cors import CORSMiddleware
from starlette.middleware.base import BaseHTTPMiddleware
from starlette.datastructures import State

from api.router import router as all_routes

# --- CSRF Protection Imports and Setup ---
from fastapi_csrf_protect import CsrfProtect
from fastapi_csrf_protect.exceptions import CsrfProtectError
from pydantic_settings import BaseSettings, SettingsConfigDict
from pydantic import Field
from fastapi.responses import JSONResponse

# --- Rate Limiting Imports ---
from slowapi import Limiter, _rate_limit_exceeded_handler
from slowapi.util import get_remote_address
from slowapi.errors import RateLimitExceeded

# --- ĞĞĞ¡Ğ¢Ğ ĞĞ™ĞšĞ Ğ›ĞĞ“Ğ“Ğ˜Ğ ĞĞ’ĞĞĞ˜Ğ¯ ---
logging.basicConfig(level=logging.INFO)
logger = logging.getLogger(__name__)

# --- CSRF Configuration ---
class CsrfSettings(BaseSettings):
    secret_key: str = Field(..., alias="CSRF_SECRET_KEY")
    model_config = SettingsConfigDict(
        env_file=".env",
        env_file_encoding="utf-8",
        extra="ignore"
    )


@CsrfProtect.load_config
def get_csrf_config():
    try:
        settings = CsrfSettings()
        return settings
    except Exception as e:
        logger.critical(
            "ĞšĞ Ğ˜Ğ¢Ğ˜Ğ§Ğ•Ğ¡ĞšĞĞ¯ ĞĞ¨Ğ˜Ğ‘ĞšĞ: ĞĞµ ÑƒĞ´Ğ°Ğ»Ğ¾ÑÑŒ Ğ·Ğ°Ğ³Ñ€ÑƒĞ·Ğ¸Ñ‚ÑŒ ĞºĞ¾Ğ½Ñ„Ğ¸Ğ³ÑƒÑ€Ğ°Ñ†Ğ¸Ñ CSRF. "
            "Ğ£Ğ±ĞµĞ´Ğ¸Ñ‚ĞµÑÑŒ, Ñ‡Ñ‚Ğ¾ Ğ¿ĞµÑ€ĞµĞ¼ĞµĞ½Ğ½Ğ°Ñ CSRF_SECRET_KEY Ğ·Ğ°Ğ´Ğ°Ğ½Ğ° Ğ² Ğ²Ğ°ÑˆĞµĞ¼ .env Ñ„Ğ°Ğ¹Ğ»Ğµ!"
        )
        raise e

# --- Rate Limiter Configuration ---
limiter = Limiter(key_func=get_remote_address, default_limits=["200/minute"])

# --- FastAPI App Initialization ---
app = FastAPI(title="Rental System API")

# --- Rate Limiter State and Exception Handler ---
app.state.limiter = limiter
app.add_exception_handler(RateLimitExceeded, _rate_limit_exceeded_handler)

# --- CSRF Exception Handler ---
@app.exception_handler(CsrfProtectError)
def csrf_protect_exception_handler(request: Request, exc: CsrfProtectError):
    return JSONResponse(
        status_code=exc.status_code,
        content={"detail": exc.message}
    )

# --- ĞĞĞ’ĞĞ¯ MIDDLEWARE Ğ”Ğ›Ğ¯ Ğ›ĞĞ“Ğ“Ğ˜Ğ ĞĞ’ĞĞĞ˜Ğ¯ Ğ—ĞĞŸĞ ĞĞ¡ĞĞ’ ---
class LoggingMiddleware(BaseHTTPMiddleware):
    async def dispatch(self, request: Request, call_next):
        logger.info(f"Incoming request: {request.method} {request.url.path}")
        response = await call_next(request)
        return response

# --- Secure Headers Middleware ---
class SecureHeadersMiddleware(BaseHTTPMiddleware):
    async def dispatch(self, request: Request, call_next):
        response: Response = await call_next(request)
        response.headers["X-Content-Type-Options"] = "nosniff"
        response.headers["X-Frame-Options"] = "DENY"
        response.headers["Content-Security-Policy"] = (
            "default-src 'self'; "
            "script-src 'self' 'unsafe-inline'; "
            "style-src 'self' 'unsafe-inline'; "
            "object-src 'none'; "
            "frame-ancestors 'none'; "
            "img-src 'self' data:;"
        )
        response.headers["Referrer-Policy"] = "strict-origin-when-cross-origin"
        response.headers["Permissions-Policy"] = "geolocation=(), microphone=(), camera=(), payment=()"
        return response

# --- Add Middlewares ---
app.add_middleware(LoggingMiddleware) # <--- Ğ”ĞĞ‘ĞĞ’Ğ¬Ğ¢Ğ• Ğ­Ğ¢Ğ£ Ğ¡Ğ¢Ğ ĞĞšĞ£

app.add_middleware(
    CORSMiddleware,
    allow_origins=["http://localhost:5173"],
    allow_credentials=True,
    allow_methods=["*"],
    allow_headers=["*", "X-CSRF-Token"],
)
app.add_middleware(SecureHeadersMiddleware)

app.include_router(all_routes)

```


## <a name="RentalAppFASTAPIapimodelsinitpy"></a>`RentalApp_FASTAPI/api/models/__init__.py`

```python
// path: RentalApp_FASTAPI/api/models/__init__.py

# api/models/__init__.py

# Ğ­Ñ‚Ğ¾Ñ‚ Ñ„Ğ°Ğ¹Ğ» Ğ´ĞµĞ»Ğ°ĞµÑ‚ Ğ²ÑĞµ Ğ¼Ğ¾Ğ´ĞµĞ»Ğ¸ Ğ² ÑÑ‚Ğ¾Ğ¹ Ğ´Ğ¸Ñ€ĞµĞºÑ‚Ğ¾Ñ€Ğ¸Ğ¸ Ğ´Ğ¾ÑÑ‚ÑƒĞ¿Ğ½Ñ‹Ğ¼Ğ¸ ĞºĞ°Ğº Ñ‡Ğ°ÑÑ‚ÑŒ Ğ¿Ğ°ĞºĞµÑ‚Ğ° 'models'

from .user import User
from .equipment import Equipment
from .association import Association, association_equipment_association
from .accessory import Accessory, equipment_accessories_association
from .promo_code import PromoCode, PromoCodeApplicableType, promo_code_equipment_association, promo_code_usages
from .discount import DurationDiscount
from .holiday import Holiday, HolidayRule
from .reservation import Reservation, ReservationAccessory, reservation_equipment_association
from .rental import Rental, RentalAccessory, rental_equipment_association
from .payment import Payment
from .balance_history import BalanceHistory

__all__ = [
    "User",
    "Equipment",
    "Association",
    "association_equipment_association",
    "Accessory",
    "equipment_accessories_association",
    "PromoCode",
    "PromoCodeApplicableType",
    "promo_code_equipment_association",
    "promo_code_usages",
    "DurationDiscount",
    "Holiday",
    "HolidayRule",
    "Reservation",
    "ReservationAccessory",
    "reservation_equipment_association",
    "Rental",
    "RentalAccessory",
    "rental_equipment_association",
    "Payment",
    "BalanceHistory",
]

```


## <a name="RentalAppFASTAPIapimodelsaccessorypy"></a>`RentalApp_FASTAPI/api/models/accessory.py`

```python
// path: RentalApp_FASTAPI/api/models/accessory.py

# api/models/accessory.py

from sqlalchemy import Column, Integer, String, Float, Text, Table, ForeignKey
from sqlalchemy.orm import relationship
from api.database import Base

equipment_accessories_association = Table(
    'equipment_accessories', Base.metadata,
    Column('equipment_id', Integer, ForeignKey('equipment.id'), primary_key=True),
    Column('accessory_id', Integer, ForeignKey('accessories.id'), primary_key=True)
)

class Accessory(Base):
    __tablename__ = "accessories"

    id = Column(Integer, primary_key=True, index=True)
    name = Column(String, nullable=False, index=True)
    accessory_type = Column(String, default="ĞŸÑ€Ğ¾Ñ‡ĞµĞµ", index=True)
    price = Column(Float, default=0.0)
    description = Column(Text, nullable=True)

    equipment_items = relationship(
        "Equipment",
        secondary=equipment_accessories_association,
        back_populates="accessories"
    )

    # --- Ğ˜Ğ¡ĞŸĞ ĞĞ’Ğ›Ğ•ĞĞ˜Ğ• Ğ—Ğ”Ğ•Ğ¡Ğ¬ ---
    # Ğ¯Ğ²Ğ½Ğ¾ ÑƒĞºĞ°Ğ·Ñ‹Ğ²Ğ°ĞµĞ¼ SQLAlchemy, ĞºĞ°Ğº ÑÑ‚Ğ° Ğ¼Ğ¾Ğ´ĞµĞ»ÑŒ ÑĞ²ÑĞ·Ğ°Ğ½Ğ° Ñ Ñ‚Ğ°Ğ±Ğ»Ğ¸Ñ†Ğ°Ğ¼Ğ¸-Ğ¿Ğ¾ÑÑ€ĞµĞ´Ğ½Ğ¸ĞºĞ°Ğ¼Ğ¸
    reservation_links = relationship("ReservationAccessory", back_populates="accessory")
    rental_links = relationship("RentalAccessory", back_populates="accessory")
    # -------------------------

    def __repr__(self):
        return f"<Accessory(id={self.id}, name='{self.name}')>"

```


## <a name="RentalAppFASTAPIapimodelsassociationpy"></a>`RentalApp_FASTAPI/api/models/association.py`

```python
// path: RentalApp_FASTAPI/api/models/association.py

# api/models/association.py

from sqlalchemy import Column, Integer, String, Text, Table, ForeignKey
from sqlalchemy.orm import relationship
from api.database import Base

association_equipment_association = Table(
    # V-- Ğ’ĞĞ–ĞĞ: Ğ˜Ğ¼Ñ Ñ‚Ğ°Ğ±Ğ»Ğ¸Ñ†Ñ‹ Ğ² Ğ±Ğ°Ğ·Ğµ Ğ´Ğ°Ğ½Ğ½Ñ‹Ñ…. Ğ”Ğ°Ğ²Ğ°Ğ¹Ñ‚Ğµ ÑĞ´ĞµĞ»Ğ°ĞµĞ¼ ĞµĞ³Ğ¾ ĞºĞ¾Ğ½ÑĞ¸ÑÑ‚ĞµĞ½Ñ‚Ğ½Ñ‹Ğ¼.
    'association_equipment_association', Base.metadata,
    Column('association_id', Integer, ForeignKey('associations.id'), primary_key=True),
    Column('equipment_id', Integer, ForeignKey('equipment.id'), primary_key=True)
)

class Association(Base):
    __tablename__ = "associations"

    id = Column(Integer, primary_key=True, index=True)
    name = Column(String, nullable=False, unique=True, index=True)
    description = Column(Text, nullable=True)
    sort_order = Column(Integer, default=0, nullable=False)

    # Ğ¡Ğ²ÑĞ·ÑŒ "Ğ¼Ğ½Ğ¾Ğ³Ğ¸Ğµ-ĞºĞ¾-Ğ¼Ğ½Ğ¾Ğ³Ğ¸Ğ¼" Ñ Ğ¾Ğ±Ğ¾Ñ€ÑƒĞ´Ğ¾Ğ²Ğ°Ğ½Ğ¸ĞµĞ¼
    equipment = relationship(
        "Equipment",
        secondary=association_equipment_association,
        # V-- Ğ˜Ğ¡ĞŸĞ ĞĞ’Ğ›Ğ•ĞĞ˜Ğ•: Ğ´Ğ¾Ğ»Ğ¶Ğ½Ğ¾ ÑĞ¾Ğ¾Ñ‚Ğ²ĞµÑ‚ÑÑ‚Ğ²Ğ¾Ğ²Ğ°Ñ‚ÑŒ Ğ¸Ğ¼ĞµĞ½Ğ¸ Ğ² Equipment
        back_populates="associations"
    )

    @property
    def equipment_ids(self) -> list[int]:
        """Ğ’Ğ¾Ğ·Ğ²Ñ€Ğ°Ñ‰Ğ°ĞµÑ‚ ÑĞ¿Ğ¸ÑĞ¾Ğº ID ÑĞ²ÑĞ·Ğ°Ğ½Ğ½Ğ¾Ğ³Ğ¾ Ğ¾Ğ±Ğ¾Ñ€ÑƒĞ´Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ."""
        return [item.id for item in self.equipment] if self.equipment else []

    def __repr__(self):
        return f"<Association(id={self.id}, name='{self.name}')>"


```


## <a name="RentalAppFASTAPIapimodelsbalancehistorypy"></a>`RentalApp_FASTAPI/api/models/balance_history.py`

```python
// path: RentalApp_FASTAPI/api/models/balance_history.py

# api/models/balance_history.py

from sqlalchemy import Column, Integer, String, Float, DateTime, ForeignKey, Text
from sqlalchemy.orm import relationship
from api.database import Base
from datetime import datetime, timezone

class BalanceHistory(Base):
    __tablename__ = "balance_history"

    id = Column(Integer, primary_key=True)
    user_id = Column(Integer, ForeignKey("users.id"), nullable=False)
    # +++ Ğ˜Ğ—ĞœĞ•ĞĞ•ĞĞ˜Ğ•: Ğ”Ğ¾Ğ±Ğ°Ğ²Ğ»ÑĞµĞ¼ ĞºĞ°ÑĞºĞ°Ğ´Ğ½Ğ¾Ğµ ÑƒĞ´Ğ°Ğ»ĞµĞ½Ğ¸Ğµ Ğ½Ğ° ÑƒÑ€Ğ¾Ğ²Ğ½Ğµ Ğ‘Ğ” +++
    rental_id = Column(Integer, ForeignKey("rentals.id", ondelete="CASCADE"), nullable=True)

    amount = Column(Float, nullable=False, comment="Ğ¡ÑƒĞ¼Ğ¼Ğ° Ğ¾Ğ¿ĞµÑ€Ğ°Ñ†Ğ¸Ğ¸. ĞÑ‚Ñ€Ğ¸Ñ†Ğ°Ñ‚ĞµĞ»ÑŒĞ½Ğ°Ñ Ğ´Ğ»Ñ ÑĞ¿Ğ¸ÑĞ°Ğ½Ğ¸Ñ, Ğ¿Ğ¾Ğ»Ğ¾Ğ¶Ğ¸Ñ‚ĞµĞ»ÑŒĞ½Ğ°Ñ Ğ´Ğ»Ñ Ğ½Ğ°Ñ‡Ğ¸ÑĞ»ĞµĞ½Ğ¸Ñ.")
    operation_type = Column(String, nullable=False, comment="Ğ¢Ğ¸Ğ¿ Ğ¾Ğ¿ĞµÑ€Ğ°Ñ†Ğ¸Ğ¸ (e.g., rental_debit, early_return_credit)")
    description = Column(Text, nullable=True, comment="ĞĞ¿Ğ¸ÑĞ°Ğ½Ğ¸Ğµ Ğ¾Ğ¿ĞµÑ€Ğ°Ñ†Ğ¸Ğ¸")

    created_at = Column(DateTime(timezone=True), default=lambda: datetime.now(timezone.utc))

    # Ğ¡Ğ²ÑĞ·Ğ¸
    user = relationship("User", back_populates="balance_history")
    rental = relationship("Rental", back_populates="balance_history")

    def __repr__(self):
        return f"<BalanceHistory(id={self.id}, user_id={self.user_id}, amount={self.amount})>"

```


## <a name="RentalAppFASTAPIapimodelsdiscountpy"></a>`RentalApp_FASTAPI/api/models/discount.py`

```python
// path: RentalApp_FASTAPI/api/models/discount.py

# api/models/discount.py

from sqlalchemy import Column, Integer
from api.database import Base

class DurationDiscount(Base):
    """
    ĞœĞ¾Ğ´ĞµĞ»ÑŒ Ğ´Ğ»Ñ Ñ…Ñ€Ğ°Ğ½ĞµĞ½Ğ¸Ñ Ğ¿Ğ¾Ñ€Ğ¾Ğ³Ğ¾Ğ²Ñ‹Ñ… Ğ·Ğ½Ğ°Ñ‡ĞµĞ½Ğ¸Ğ¹ ÑĞºĞ¸Ğ´Ğ¾Ğº Ğ·Ğ° Ğ´Ğ»Ğ¸Ñ‚ĞµĞ»ÑŒĞ½Ğ¾ÑÑ‚ÑŒ Ğ°Ñ€ĞµĞ½Ğ´Ñ‹.
    ĞĞ°Ğ¿Ñ€Ğ¸Ğ¼ĞµÑ€: Ğ¾Ñ‚ 3 Ğ´Ğ¾ 6 Ğ´Ğ½ĞµĞ¹ - 10% ÑĞºĞ¸Ğ´ĞºĞ°.
    """
    __tablename__ = "duration_discounts"

    id = Column(Integer, primary_key=True)
    min_days = Column(Integer, unique=True, nullable=False, comment="ĞœĞ¸Ğ½Ğ¸Ğ¼Ğ°Ğ»ÑŒĞ½Ğ¾Ğµ ĞºĞ¾Ğ»Ğ¸Ñ‡ĞµÑÑ‚Ğ²Ğ¾ Ğ´Ğ½ĞµĞ¹ Ğ´Ğ»Ñ ÑĞºĞ¸Ğ´ĞºĞ¸ (Ğ²ĞºĞ»ÑÑ‡Ğ¸Ñ‚ĞµĞ»ÑŒĞ½Ğ¾)")
    discount_percentage = Column(Integer, nullable=False, comment="ĞŸÑ€Ğ¾Ñ†ĞµĞ½Ñ‚ ÑĞºĞ¸Ğ´ĞºĞ¸")

```


## <a name="RentalAppFASTAPIapimodelsequipmentpy"></a>`RentalApp_FASTAPI/api/models/equipment.py`

```python
// path: RentalApp_FASTAPI/api/models/equipment.py

# api/models/equipment.py

from sqlalchemy import Column, Integer, String, Float, Date, Text, JSON
from sqlalchemy.orm import relationship
from api.database import Base
from api.models.accessory import equipment_accessories_association
from api.models.reservation import reservation_equipment_association
from api.models.promo_code import promo_code_equipment_association
from api.models.association import association_equipment_association

class Equipment(Base):
    __tablename__ = "equipment"

    id = Column(Integer, primary_key=True)
    equipment_type = Column(String, nullable=False)
    brand = Column(String, nullable=False)
    name = Column(String, nullable=False)
    serial_number = Column(String, unique=True)
    condition = Column(String, default="Ğ’ĞµĞ»Ğ¸ĞºĞ¾Ğ»ĞµĞ¿Ğ½Ğ¾")
    daily_rate = Column(Float, default=0.0)
    notes = Column(String)

    # âœ… Ğ˜Ğ—ĞœĞ•ĞĞ•ĞĞ˜Ğ•: Ğ¢Ğ¸Ğ¿ Ğ¿Ğ¾Ğ»Ñ Ğ¸Ğ·Ğ¼ĞµĞ½ĞµĞ½ Ñ DateTime Ğ½Ğ° Date
    last_maintenance = Column(Date)

    description = Column(Text)
    image_url = Column(String, nullable=True)
    image_urls = Column(JSON, nullable=True)
    short_description = Column(String, nullable=True)

    accessories = relationship(
        "Accessory",
        secondary=equipment_accessories_association,
        back_populates="equipment_items"
    )

    reservations = relationship(
        "Reservation",
        secondary=reservation_equipment_association,
        back_populates="equipment"
    )

    applicable_promo_codes = relationship(
        "PromoCode",
        secondary=promo_code_equipment_association,
        back_populates="applicable_equipment"
    )

    # Ğ¡Ğ²ÑĞ·ÑŒ Ğ¼Ğ½Ğ¾Ğ³Ğ¸Ğµ-ĞºĞ¾-Ğ¼Ğ½Ğ¾Ğ³Ğ¸Ğ¼ Ñ Association
    associations = relationship(
        "Association",
        secondary=association_equipment_association,
        back_populates="equipment"
    )

```


## <a name="RentalAppFASTAPIapimodelsholidaypy"></a>`RentalApp_FASTAPI/api/models/holiday.py`

```python
// path: RentalApp_FASTAPI/api/models/holiday.py

# api/models/holiday.py

from sqlalchemy import Column, Integer, String, DateTime, Date, ForeignKey, JSON
from sqlalchemy.orm import relationship
from api.database import Base
from datetime import datetime, timezone

# +++ ĞĞĞ§ĞĞ›Ğ: ĞĞĞ’ĞĞ¯ ĞœĞĞ”Ğ•Ğ›Ğ¬ Ğ”Ğ›Ğ¯ ĞŸĞ ĞĞ’Ğ˜Ğ› +++
class HolidayRule(Base):
    """ĞœĞ¾Ğ´ĞµĞ»ÑŒ Ğ´Ğ»Ñ Ñ…Ñ€Ğ°Ğ½ĞµĞ½Ğ¸Ñ Ğ¿Ñ€Ğ°Ğ²Ğ¸Ğ» Ğ°Ğ²Ñ‚Ğ¾Ğ¼Ğ°Ñ‚Ğ¸Ñ‡ĞµÑĞºĞ¾Ğ³Ğ¾ ÑĞ¾Ğ·Ğ´Ğ°Ğ½Ğ¸Ñ Ğ²Ñ‹Ñ…Ğ¾Ğ´Ğ½Ñ‹Ñ…."""
    __tablename__ = "holiday_rules"

    id = Column(Integer, primary_key=True)
    rule_type = Column(String, nullable=False, comment="Ğ¢Ğ¸Ğ¿ Ğ¿Ñ€Ğ°Ğ²Ğ¸Ğ»Ğ°, Ğ½Ğ°Ğ¿Ñ€Ğ¸Ğ¼ĞµÑ€ 'weekly' Ğ¸Ğ»Ğ¸ 'public_import'")
    parameters = Column(JSON, nullable=False, comment="ĞŸĞ°Ñ€Ğ°Ğ¼ĞµÑ‚Ñ€Ñ‹ Ğ¿Ñ€Ğ°Ğ²Ğ¸Ğ»Ğ°, Ğ½Ğ°Ğ¿Ñ€Ğ¸Ğ¼ĞµÑ€ {'day_of_week': 6} Ğ´Ğ»Ñ Ğ²Ğ¾ÑĞºÑ€ĞµÑĞµĞ½ÑŒÑ")
    description = Column(String, nullable=False, comment="ĞĞ¿Ğ¸ÑĞ°Ğ½Ğ¸Ğµ Ğ¿Ñ€Ğ°Ğ²Ğ¸Ğ»Ğ° Ğ´Ğ»Ñ Ğ°Ğ´Ğ¼Ğ¸Ğ½Ğ°")
    created_at = Column(DateTime(timezone=True), default=lambda: datetime.now(timezone.utc))
    created_by_id = Column(Integer, ForeignKey("users.id"), nullable=False)

    creator = relationship("User")
    # Ğ¡Ğ²ÑĞ·ÑŒ Ğ´Ğ»Ñ ĞºĞ°ÑĞºĞ°Ğ´Ğ½Ğ¾Ğ³Ğ¾ ÑƒĞ´Ğ°Ğ»ĞµĞ½Ğ¸Ñ Ğ²ÑĞµÑ… Ğ²Ñ‹Ñ…Ğ¾Ğ´Ğ½Ñ‹Ñ…, ÑĞ¾Ğ·Ğ´Ğ°Ğ½Ğ½Ñ‹Ñ… ÑÑ‚Ğ¸Ğ¼ Ğ¿Ñ€Ğ°Ğ²Ğ¸Ğ»Ğ¾Ğ¼
    holidays = relationship("Holiday", back_populates="rule", cascade="all, delete-orphan")
# +++ ĞšĞĞĞ•Ğ¦: ĞĞĞ’ĞĞ¯ ĞœĞĞ”Ğ•Ğ›Ğ¬ Ğ”Ğ›Ğ¯ ĞŸĞ ĞĞ’Ğ˜Ğ› +++


class Holiday(Base):
    __tablename__ = "holidays"

    date = Column(Date, primary_key=True, index=True, comment="Ğ”Ğ°Ñ‚Ğ° Ğ²Ñ‹Ñ…Ğ¾Ğ´Ğ½Ğ¾Ğ³Ğ¾ Ğ´Ğ½Ñ")
    description = Column(String, nullable=True, comment="ĞĞ°Ğ·Ğ²Ğ°Ğ½Ğ¸Ğµ (Ğ½Ğ°Ğ¿Ñ€Ğ¸Ğ¼ĞµÑ€, ĞĞ¾Ğ²Ñ‹Ğ¹ Ğ³Ğ¾Ğ´)")
    created_at = Column(DateTime(timezone=True), default=lambda: datetime.now(timezone.utc))
    created_by_id = Column(Integer, ForeignKey("users.id"), nullable=False)

    # +++ ĞĞĞ§ĞĞ›Ğ: Ğ˜Ğ—ĞœĞ•ĞĞ•ĞĞ˜Ğ¯ Ğ’ ĞœĞĞ”Ğ•Ğ›Ğ˜ HOLIDAY +++
    rule_id = Column(Integer, ForeignKey("holiday_rules.id"), nullable=True, comment="ID Ğ¿Ñ€Ğ°Ğ²Ğ¸Ğ»Ğ°, ĞºĞ¾Ñ‚Ğ¾Ñ€Ñ‹Ğ¼ ÑĞ¾Ğ·Ğ´Ğ°Ğ½ ÑÑ‚Ğ¾Ñ‚ Ğ²Ñ‹Ñ…Ğ¾Ğ´Ğ½Ğ¾Ğ¹")
    rule = relationship("HolidayRule", back_populates="holidays")
    # +++ ĞšĞĞĞ•Ğ¦: Ğ˜Ğ—ĞœĞ•ĞĞ•ĞĞ˜Ğ¯ Ğ’ ĞœĞĞ”Ğ•Ğ›Ğ˜ HOLIDAY +++

    creator = relationship("User")

    def __repr__(self):
        return f"<Holiday(date='{self.date.strftime('%Y-%m-%d')}', description='{self.description}')>"

```


## <a name="RentalAppFASTAPIapimodelspaymentpy"></a>`RentalApp_FASTAPI/api/models/payment.py`

```python
// path: RentalApp_FASTAPI/api/models/payment.py

# api/models/payment.py

from sqlalchemy import (Column, Integer, String, Float, DateTime,
                        ForeignKey, Text)
from sqlalchemy.orm import relationship
from api.database import Base
from datetime import datetime, timezone

class Payment(Base):
    __tablename__ = "payments"

    id = Column(Integer, primary_key=True)
    user_id = Column(Integer, ForeignKey("users.id"), nullable=False)
    # +++ Ğ˜Ğ—ĞœĞ•ĞĞ•ĞĞ˜Ğ•: Ğ”Ğ¾Ğ±Ğ°Ğ²Ğ»ÑĞµĞ¼ ĞºĞ°ÑĞºĞ°Ğ´Ğ½Ğ¾Ğµ ÑƒĞ´Ğ°Ğ»ĞµĞ½Ğ¸Ğµ Ğ½Ğ° ÑƒÑ€Ğ¾Ğ²Ğ½Ğµ Ğ‘Ğ” +++
    rental_id = Column(Integer, ForeignKey("rentals.id", ondelete="CASCADE"), nullable=True)
    amount = Column(Float, nullable=False)

    payment_date = Column(DateTime(timezone=True), default=lambda: datetime.now(timezone.utc))

    payment_method = Column(String)
    transaction_type = Column(String, nullable=False)  # e.g., 'rental_payment', 'deposit', 'refund'
    description = Column(Text, nullable=True)

    user = relationship("User")
    rental = relationship("Rental", back_populates="payments")

```


## <a name="RentalAppFASTAPIapimodelspromocodepy"></a>`RentalApp_FASTAPI/api/models/promo_code.py`

```python
// path: RentalApp_FASTAPI/api/models/promo_code.py

# api/models/promo_code.py

from sqlalchemy import (Column, Integer, String, Float, DateTime, Boolean,
                        ForeignKey, Table, Text)
from sqlalchemy.orm import relationship
from api.database import Base
# âœ… Ğ˜Ğ¼Ğ¿Ğ¾Ñ€Ñ‚Ğ¸Ñ€ÑƒĞµĞ¼ timezone
from datetime import datetime, timezone

# ĞŸÑ€Ğ¾Ğ¼ĞµĞ¶ÑƒÑ‚Ğ¾Ñ‡Ğ½Ğ°Ñ Ñ‚Ğ°Ğ±Ğ»Ğ¸Ñ†Ğ° Ğ´Ğ»Ñ Ğ¾Ñ‚ÑĞ»ĞµĞ¶Ğ¸Ğ²Ğ°Ğ½Ğ¸Ñ Ğ¸ÑĞ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğ¹ Ğ¿Ñ€Ğ¾Ğ¼Ğ¾ĞºĞ¾Ğ´Ğ¾Ğ² Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ÑĞ¼Ğ¸
promo_code_usages = Table(
    'promo_code_usages', Base.metadata,
    Column('user_id', Integer, ForeignKey('users.id'), primary_key=True),
    Column('promo_code_id', Integer, ForeignKey('promo_codes.id'), primary_key=True),
    # âœ… Ğ˜Ğ—ĞœĞ•ĞĞ•ĞĞ˜Ğ•: Ğ”Ğ¾Ğ±Ğ°Ğ²Ğ»ÑĞµĞ¼ timezone=True
    Column('used_at', DateTime(timezone=True), default=lambda: datetime.now(timezone.utc))
)

# ĞÑÑĞ¾Ñ†Ğ¸Ğ°Ñ‚Ğ¸Ğ²Ğ½Ğ°Ñ Ñ‚Ğ°Ğ±Ğ»Ğ¸Ñ†Ğ° Ğ´Ğ»Ñ ÑĞ²ÑĞ·Ğ¸ Ğ¿Ñ€Ğ¾Ğ¼Ğ¾ĞºĞ¾Ğ´Ğ° Ñ ID Ğ¾Ğ±Ğ¾Ñ€ÑƒĞ´Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ
promo_code_equipment_association = Table(
    'promo_code_equipment', Base.metadata,
    Column('promo_code_id', Integer, ForeignKey('promo_codes.id'), primary_key=True),
    Column('equipment_id', Integer, ForeignKey('equipment.id'), primary_key=True)
)

class PromoCode(Base):
    """
    ĞœĞ¾Ğ´ĞµĞ»ÑŒ Ğ´Ğ»Ñ Ñ…Ñ€Ğ°Ğ½ĞµĞ½Ğ¸Ñ Ğ¿Ñ€Ğ¾Ğ¼Ğ¾ĞºĞ¾Ğ´Ğ¾Ğ² Ğ¸ Ğ¸Ñ… ÑƒÑĞ»Ğ¾Ğ²Ğ¸Ğ¹.
    """
    __tablename__ = "promo_codes"

    id = Column(Integer, primary_key=True, index=True)
    code = Column(String, unique=True, index=True, nullable=False)
    description = Column(Text, nullable=True, comment="ĞšÑ€Ğ°Ñ‚ĞºĞ¾Ğµ Ğ¾Ğ¿Ğ¸ÑĞ°Ğ½Ğ¸Ğµ Ğ´Ğ»Ñ Ğ¼ĞµĞ½ĞµĞ´Ğ¶ĞµÑ€Ğ¾Ğ²")
    discount_percentage = Column(Float, nullable=False)

    # --- Ğ¡Ñ‚Ğ°Ñ‚ÑƒÑÑ‹ Ğ¸ ÑÑ€Ğ¾ĞºĞ¸ ---
    is_active = Column(Boolean, default=True)
    # âœ… Ğ˜Ğ—ĞœĞ•ĞĞ•ĞĞ˜Ğ•: Ğ”Ğ¾Ğ±Ğ°Ğ²Ğ»ÑĞµĞ¼ timezone=True
    valid_from = Column(DateTime(timezone=True), nullable=True, comment="Ğ”Ğ°Ñ‚Ğ° Ğ½Ğ°Ñ‡Ğ°Ğ»Ğ° Ğ´ĞµĞ¹ÑÑ‚Ğ²Ğ¸Ñ")
    # âœ… Ğ˜Ğ—ĞœĞ•ĞĞ•ĞĞ˜Ğ•: Ğ”Ğ¾Ğ±Ğ°Ğ²Ğ»ÑĞµĞ¼ timezone=True
    expires_at = Column(DateTime(timezone=True), nullable=True, comment="Ğ”Ğ°Ñ‚Ğ° Ğ¸ÑÑ‚ĞµÑ‡ĞµĞ½Ğ¸Ñ ÑÑ€Ğ¾ĞºĞ°")

    # --- ĞĞ³Ñ€Ğ°Ğ½Ğ¸Ñ‡ĞµĞ½Ğ¸Ñ Ğ¸ÑĞ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ ---
    max_uses = Column(Integer, nullable=True, comment="ĞĞ±Ñ‰Ğ¸Ğ¹ Ğ»Ğ¸Ğ¼Ğ¸Ñ‚ Ğ¸ÑĞ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğ¹")
    times_used = Column(Integer, default=0, nullable=False)
    max_uses_per_user = Column(Integer, nullable=True, comment="Ğ›Ğ¸Ğ¼Ğ¸Ñ‚ Ğ½Ğ° Ğ¾Ğ´Ğ½Ğ¾Ğ³Ğ¾ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ñ")

    # --- Ğ£ÑĞ»Ğ¾Ğ²Ğ¸Ñ Ğ¿Ñ€Ğ¸Ğ¼ĞµĞ½ĞµĞ½Ğ¸Ñ ---
    min_order_amount = Column(Float, nullable=True, comment="ĞœĞ¸Ğ½Ğ¸Ğ¼Ğ°Ğ»ÑŒĞ½Ğ°Ñ ÑÑƒĞ¼Ğ¼Ğ° Ğ·Ğ°ĞºĞ°Ğ·Ğ° Ğ´Ğ»Ñ Ğ°ĞºÑ‚Ğ¸Ğ²Ğ°Ñ†Ğ¸Ğ¸")
    specific_to_user_id = Column(Integer, ForeignKey("users.id"), nullable=True, comment="Ğ•ÑĞ»Ğ¸ ĞºĞ¾Ğ´ Ğ¿ĞµÑ€ÑĞ¾Ğ½Ğ°Ğ»ÑŒĞ½Ñ‹Ğ¹")

    # --- ĞœĞµÑ‚Ğ°Ğ´Ğ°Ğ½Ğ½Ñ‹Ğµ ---
    # âœ… Ğ˜Ğ—ĞœĞ•ĞĞ•ĞĞ˜Ğ•: Ğ”Ğ¾Ğ±Ğ°Ğ²Ğ»ÑĞµĞ¼ timezone=True
    created_at = Column(DateTime(timezone=True), default=lambda: datetime.now(timezone.utc))
    created_by_id = Column(Integer, ForeignKey("users.id"))

    # --- Ğ¡Ğ²ÑĞ·Ğ¸ ---
    creator = relationship("User", foreign_keys=[created_by_id])
    specific_user = relationship("User", foreign_keys=[specific_to_user_id])

    used_by_users = relationship(
        "User",
        secondary=promo_code_usages,
        back_populates="used_promo_codes"
    )

    applicable_equipment = relationship(
        "Equipment",
        secondary=promo_code_equipment_association,
        back_populates="applicable_promo_codes",
        lazy="joined"
    )

    applicable_types = relationship(
        "PromoCodeApplicableType",
        back_populates="promo_code",
        cascade="all, delete-orphan",
        lazy="joined"
    )

    # --- Ğ’ÑĞ¿Ğ¾Ğ¼Ğ¾Ğ³Ğ°Ñ‚ĞµĞ»ÑŒĞ½Ñ‹Ğµ ÑĞ²Ğ¾Ğ¹ÑÑ‚Ğ²Ğ° ---
    @property
    def applicable_to_equipment_ids(self) -> list[int]:
        return [item.id for item in self.applicable_equipment] if self.applicable_equipment else []

    @property
    def applicable_to_equipment_types(self) -> list[str]:
        return [item.type_name for item in self.applicable_types] if self.applicable_types else []

    def __repr__(self):
        return f"<PromoCode(code='{self.code}', discount={self.discount_percentage}%)>"


# ĞœĞ¾Ğ´ĞµĞ»ÑŒ-Ğ¿Ğ¾ÑÑ€ĞµĞ´Ğ½Ğ¸Ğº Ğ´Ğ»Ñ Ñ…Ñ€Ğ°Ğ½ĞµĞ½Ğ¸Ñ Ñ‚Ğ¸Ğ¿Ğ¾Ğ² Ğ¾Ğ±Ğ¾Ñ€ÑƒĞ´Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ
class PromoCodeApplicableType(Base):
    __tablename__ = 'promo_code_applicable_types'
    promo_code_id = Column(Integer, ForeignKey('promo_codes.id'), primary_key=True)
    type_name = Column(String, primary_key=True)

    promo_code = relationship("PromoCode", back_populates="applicable_types")

```


## <a name="RentalAppFASTAPIapimodelsrentalpy"></a>`RentalApp_FASTAPI/api/models/rental.py`

```python
// path: RentalApp_FASTAPI/api/models/rental.py

# api/models/rental.py

from sqlalchemy import (Column, Integer, DateTime, ForeignKey, Float,
                        String, Text, Table, Boolean, Date)
from sqlalchemy.orm import relationship
from api.database import Base
from datetime import datetime, timezone

class RentalAccessory(Base):
    __tablename__ = 'rental_accessories'
    rental_id = Column(Integer, ForeignKey('rentals.id', ondelete="CASCADE"), primary_key=True)
    equipment_id = Column(Integer, ForeignKey('equipment.id'), primary_key=True)
    accessory_id = Column(Integer, ForeignKey('accessories.id'), primary_key=True)

    accessory = relationship("Accessory", back_populates="rental_links")
    rental = relationship("Rental", back_populates="accessory_links")

rental_equipment_association = Table('rental_equipment', Base.metadata,
                                     Column('rental_id', Integer, ForeignKey('rentals.id', ondelete="CASCADE"), primary_key=True),
                                     Column('equipment_id', Integer, ForeignKey('equipment.id'), primary_key=True)
                                     )

class Rental(Base):
    __tablename__ = "rentals"

    id = Column(Integer, primary_key=True)
    user_id = Column(Integer, ForeignKey("users.id"), nullable=False)
    created_by_id = Column(Integer, ForeignKey("users.id"), nullable=False)
    reservation_id = Column(Integer, ForeignKey("reservations.id"), nullable=True, unique=True)
    start_date = Column(Date, nullable=False)
    end_date = Column(Date, nullable=False)
    actual_return_date = Column(Date, nullable=True)
    status = Column(String, default="active", nullable=False, index=True)
    total_cost = Column(Float, nullable=False, default=0.0)
    discount_amount = Column(Float, nullable=False, default=0.0)
    promo_code = Column(String, nullable=True)
    final_cost = Column(Float, nullable=True)
    deposit_amount = Column(Float, default=0.0)
    prepayment_amount = Column(Float, nullable=False, default=0.0)  # Ğ¡ÑƒĞ¼Ğ¼Ğ° Ğ¿Ñ€ĞµĞ´Ğ¾Ğ¿Ğ»Ğ°Ñ‚Ñ‹, Ğ²Ğ½ĞµÑĞµĞ½Ğ½Ğ°Ñ Ğ¿Ñ€Ğ¸ ÑĞ¾Ğ·Ğ´Ğ°Ğ½Ğ¸Ğ¸ Ğ°Ñ€ĞµĞ½Ğ´Ñ‹
    notes_on_issue = Column(Text, nullable=True)
    notes_on_return = Column(Text, nullable=True)
    created_at = Column(DateTime(timezone=True), default=lambda: datetime.now(timezone.utc))
    updated_at = Column(DateTime(timezone=True), default=lambda: datetime.now(timezone.utc), onupdate=lambda: datetime.now(timezone.utc))

    def __init__(self, reservation_accessories=None, **kwargs):
        """
        ĞšĞ¾Ğ½ÑÑ‚Ñ€ÑƒĞºÑ‚Ğ¾Ñ€ Rental Ñ Ğ¿Ğ¾Ğ´Ğ´ĞµÑ€Ğ¶ĞºĞ¾Ğ¹ ĞºĞ¾Ğ¿Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ Ğ°ĞºÑĞµÑÑÑƒĞ°Ñ€Ğ¾Ğ² Ğ¸Ğ· Ñ€ĞµĞ·ĞµÑ€Ğ²Ğ°.
        
        Args:
            reservation_accessories: Ğ¡Ğ¿Ğ¸ÑĞ¾Ğº ReservationAccessory Ğ¾Ğ±ÑŠĞµĞºÑ‚Ğ¾Ğ² Ğ´Ğ»Ñ ĞºĞ¾Ğ¿Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ
            **kwargs: ĞÑÑ‚Ğ°Ğ»ÑŒĞ½Ñ‹Ğµ Ğ¿Ğ°Ñ€Ğ°Ğ¼ĞµÑ‚Ñ€Ñ‹ Ğ´Ğ»Ñ ÑĞ¾Ğ·Ğ´Ğ°Ğ½Ğ¸Ñ Rental
        """
        super().__init__(**kwargs)
        if reservation_accessories:
            self.copy_accessories_from_reservation(reservation_accessories)

    user = relationship("User", foreign_keys=[user_id], back_populates="rentals")
    created_by = relationship("User", foreign_keys=[created_by_id])

    # --- ĞĞĞ§ĞĞ›Ğ Ğ˜Ğ¡ĞŸĞ ĞĞ’Ğ›Ğ•ĞĞ˜Ğ™ ---
    # Ğ£Ğ±Ğ¸Ñ€Ğ°ĞµĞ¼ ÑƒĞ¿Ñ€Ğ°Ğ²Ğ»ÑÑÑ‰Ğ¸Ğµ Ğ¸Ğ½ÑÑ‚Ñ€ÑƒĞºÑ†Ğ¸Ğ¸ `cascade` Ğ¸ `single_parent` ÑĞ¾ ÑÑ‚Ğ¾Ñ€Ğ¾Ğ½Ñ‹ "Ğ¿Ğ¾Ñ‚Ğ¾Ğ¼ĞºĞ°".
    # Ğ¢ĞµĞ¿ĞµÑ€ÑŒ ÑÑ‚Ğ° ÑĞ²ÑĞ·ÑŒ ÑĞ²Ğ»ÑĞµÑ‚ÑÑ Ğ¿Ñ€Ğ¾ÑÑ‚Ğ¾ Ğ¾Ğ±Ñ€Ğ°Ñ‚Ğ½Ğ¾Ğ¹ ÑÑÑ‹Ğ»ĞºĞ¾Ğ¹.
    reservation = relationship("Reservation", back_populates="rental")
    # --- ĞšĞĞĞ•Ğ¦ Ğ˜Ğ¡ĞŸĞ ĞĞ’Ğ›Ğ•ĞĞ˜Ğ™ ---

    equipment = relationship("Equipment", secondary=rental_equipment_association)
    balance_history = relationship("BalanceHistory", back_populates="rental", cascade="all, delete-orphan")
    payments = relationship("Payment", back_populates="rental", cascade="all, delete-orphan")
    accessory_links = relationship(
        "RentalAccessory",
        back_populates="rental",
        cascade="all, delete-orphan",
        lazy="joined"
    )

    def copy_accessories_from_reservation(self, reservation_accessories):
        """ĞšĞ¾Ğ¿Ğ¸Ñ€ÑƒĞµÑ‚ Ğ°ĞºÑĞµÑÑÑƒĞ°Ñ€Ñ‹ Ğ¸Ğ· Ñ€ĞµĞ·ĞµÑ€Ğ²Ğ° Ğ² Ğ°Ñ€ĞµĞ½Ğ´Ñƒ"""
        if reservation_accessories:
            self.accessory_links = [
                RentalAccessory(
                    equipment_id=link.equipment_id,
                    accessory_id=link.accessory_id
                )
                for link in reservation_accessories
            ]

    def __repr__(self):
        return f"<Rental(id={self.id}, user_id={self.user_id}, status='{self.status}')>"

```


## <a name="RentalAppFASTAPIapimodelsreservationpy"></a>`RentalApp_FASTAPI/api/models/reservation.py`

```python
// path: RentalApp_FASTAPI/api/models/reservation.py

# api/models/reservation.py

from sqlalchemy import Column, Integer, DateTime, ForeignKey, Table, Float, String, Date
from sqlalchemy.orm import relationship
from api.database import Base
from typing import Optional, Dict, List
from datetime import datetime, timezone

reservation_equipment_association = Table('reservation_equipment', Base.metadata,
                                          Column('reservation_id', Integer, ForeignKey('reservations.id'), primary_key=True),
                                          Column('equipment_id', Integer, ForeignKey('equipment.id'), primary_key=True)
                                          )

class ReservationAccessory(Base):
    __tablename__ = 'reservation_accessories'
    reservation_id = Column(Integer, ForeignKey('reservations.id'), primary_key=True)
    equipment_id = Column(Integer, ForeignKey('equipment.id'), primary_key=True)
    accessory_id = Column(Integer, ForeignKey('accessories.id'), primary_key=True)

    # --- Ğ˜Ğ¡ĞŸĞ ĞĞ’Ğ›Ğ•ĞĞ˜Ğ• Ğ—Ğ”Ğ•Ğ¡Ğ¬ ---
    accessory = relationship("Accessory", back_populates="reservation_links")
    reservation = relationship("Reservation", back_populates="accessory_links")
    # -------------------------

class Reservation(Base):
    __tablename__ = "reservations"

    id = Column(Integer, primary_key=True)
    user_id = Column(Integer, ForeignKey("users.id"), nullable=False)
    start_date = Column(Date, nullable=False)
    end_date = Column(Date, nullable=False)
    status = Column(String, default='active', nullable=False, index=True)
    promo_code_id = Column(Integer, ForeignKey("promo_codes.id"), nullable=True)
    total_cost = Column(Float, nullable=False, default=0.0)
    discount_amount = Column(Float, nullable=False, default=0.0)
    created_at = Column(DateTime(timezone=True), default=lambda: datetime.now(timezone.utc))

    user = relationship("User", back_populates="reservations")
    applied_promo_code = relationship("PromoCode")
    equipment = relationship(
        "Equipment",
        secondary=reservation_equipment_association,
        back_populates="reservations",
        lazy="joined"
    )
    # --- Ğ˜Ğ¡ĞŸĞ ĞĞ’Ğ›Ğ•ĞĞ˜Ğ• Ğ—Ğ”Ğ•Ğ¡Ğ¬ ---
    accessory_links = relationship(
        "ReservationAccessory",
        back_populates="reservation",
        cascade="all, delete-orphan",
        lazy="joined"
    )
    # -------------------------
    rental = relationship("Rental", back_populates="reservation", uselist=False, cascade="all, delete-orphan", single_parent=True)

    @property
    def equipment_ids(self) -> list[int]:
        return [item.id for item in self.equipment] if self.equipment else []

    @property
    def selected_accessories(self) -> Dict[int, List[int]]:
        grouped_accessories: Dict[int, List[int]] = {}
        if not self.accessory_links:
            return {}
        for link in self.accessory_links:
            if link.equipment_id not in grouped_accessories:
                grouped_accessories[link.equipment_id] = []
            grouped_accessories[link.equipment_id].append(link.accessory_id)
        return grouped_accessories

    @property
    def promo_code(self) -> Optional[str]:
        return self.applied_promo_code.code if self.applied_promo_code else None

```


## <a name="RentalAppFASTAPIapimodelsuserpy"></a>`RentalApp_FASTAPI/api/models/user.py`

```python
// path: RentalApp_FASTAPI/api/models/user.py

# api/models/user.py

from sqlalchemy import (Column, Integer, String, Boolean, DateTime,
                        Float, Text)
from sqlalchemy.orm import relationship
from api.database import Base
from datetime import datetime, timezone

class User(Base):
    __tablename__ = "users"

    id = Column(Integer, primary_key=True)
    full_name = Column(String, nullable=False)
    email = Column(String, unique=True, index=True, nullable=False)
    hashed_password = Column(String)
    role = Column(String, default="user") # user, manager, admin

    created_at = Column(DateTime(timezone=True), default=lambda: datetime.now(timezone.utc))

    is_active = Column(Boolean, default=True)
    phone = Column(String)
    status = Column(String, default="ĞĞºÑ‚Ğ¸Ğ²Ğ½Ñ‹Ğ¹")
    balance = Column(Float, default=0.0)
    notes = Column(Text)

    privacy_policy_accepted = Column(Boolean, default=False)
    terms_accepted = Column(Boolean, default=False)
    email_verified = Column(Boolean, default=False)

    # Ğ¡ÑƒÑ‰ĞµÑÑ‚Ğ²ÑƒÑÑ‰Ğ¸Ğµ ÑĞ²ÑĞ·Ğ¸
    reservations = relationship("Reservation", back_populates="user")
    used_promo_codes = relationship(
        "PromoCode",
        secondary="promo_code_usages",
        back_populates="used_by_users"
    )

    # +++ ĞĞĞ’Ğ«Ğ• Ğ¡Ğ’Ğ¯Ğ—Ğ˜ +++
    rentals = relationship("Rental", foreign_keys="[Rental.user_id]", back_populates="user", cascade="all, delete-orphan")
    balance_history = relationship("BalanceHistory", back_populates="user", cascade="all, delete-orphan")

```


## <a name="RentalAppFASTAPIapipermissionspy"></a>`RentalApp_FASTAPI/api/permissions.py`

```python
// path: RentalApp_FASTAPI/api/permissions.py

# api/permissions.py
from fastapi import Depends, HTTPException
from api.deps import get_current_user
from api.models.user import User

# ĞŸÑ€Ğ¸Ğ¾Ñ€Ğ¸Ñ‚ĞµÑ‚ Ñ€Ğ¾Ğ»ĞµĞ¹: user < manager < admin
ROLE_PRIORITY = {"user": 0, "manager": 1, "admin": 2}

def require_user(user: User = Depends(get_current_user)):
    # Ğ›ÑĞ±Ğ¾Ğ¹ Ğ·Ğ°Ğ»Ğ¾Ğ³Ğ¸Ğ½ĞµĞ½Ğ½Ñ‹Ğ¹ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ÑŒ
    if not user.is_active:
        raise HTTPException(status_code=403, detail="ĞŸĞ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ÑŒ Ğ½ĞµĞ°ĞºÑ‚Ğ¸Ğ²ĞµĞ½")
    return user

def require_manager(user: User = Depends(get_current_user)):
    # ĞœĞµĞ½ĞµĞ´Ğ¶ĞµÑ€ Ğ¸ Ğ²Ñ‹ÑˆĞµ
    if ROLE_PRIORITY.get(user.role, 0) < ROLE_PRIORITY["manager"]:
        raise HTTPException(status_code=403, detail="ĞĞµĞ´Ğ¾ÑÑ‚Ğ°Ñ‚Ğ¾Ñ‡Ğ½Ğ¾ Ğ¿Ñ€Ğ°Ğ² (Ñ‚Ñ€ĞµĞ±ÑƒĞµÑ‚ÑÑ manager Ğ¸Ğ»Ğ¸ admin)")
    return user

def require_admin(user: User = Depends(get_current_user)):
    # Ğ¢Ğ¾Ğ»ÑŒĞºĞ¾ Ğ°Ğ´Ğ¼Ğ¸Ğ½Ğ¸ÑÑ‚Ñ€Ğ°Ñ‚Ğ¾Ñ€
    if user.role != "admin":
        raise HTTPException(status_code=403, detail="ĞĞµĞ´Ğ¾ÑÑ‚Ğ°Ñ‚Ğ¾Ñ‡Ğ½Ğ¾ Ğ¿Ñ€Ğ°Ğ² (Ñ‚Ñ€ĞµĞ±ÑƒĞµÑ‚ÑÑ admin)")
    return user


```


## <a name="RentalAppFASTAPIapipromocodeapipy"></a>`RentalApp_FASTAPI/api/promo_code_api.py`

```python
// path: RentalApp_FASTAPI/api/promo_code_api.py

# api/promo_code_api.py

from fastapi import APIRouter, Depends, HTTPException, status, Query
from sqlalchemy.ext.asyncio import AsyncSession
from sqlalchemy import select, func
from sqlalchemy.orm import selectinload
from typing import List

from api.deps import get_db
from api.permissions import require_manager
from api.services.auth_service import get_user_by_token
from api.models.user import User
from shared.schemas.promo_code_schema import (
    PromoCodeCreate, PromoCodeUpdate, PromoCodeOut,
    PromoCodeValidateRequest, PromoCodeValidateResponse,
    PromoCodeListResponse
)
from fastapi.security import OAuth2PasswordBearer
from fastapi_csrf_protect import CsrfProtect
from api.services.promo_code import PromoCodeManager, PromoCodeBusinessLogic

router = APIRouter(prefix="/promocodes", tags=["ĞŸÑ€Ğ¾Ğ¼Ğ¾ĞºĞ¾Ğ´Ñ‹"])
optional_oauth2_scheme = OAuth2PasswordBearer(tokenUrl="/auth/token", auto_error=False)


@router.post("/", response_model=PromoCodeOut, status_code=status.HTTP_201_CREATED)
async def create_promo_code(
        promo_in: PromoCodeCreate,
        db: AsyncSession = Depends(get_db),
        current_user: User = Depends(require_manager),
        _csrf_protect: CsrfProtect = Depends()
):
    """
    Ğ¡Ğ¾Ğ·Ğ´Ğ°ĞµÑ‚ Ğ½Ğ¾Ğ²Ñ‹Ğ¹ Ğ¿Ñ€Ğ¾Ğ¼Ğ¾ĞºĞ¾Ğ´. (ĞœĞµĞ½ĞµĞ´Ğ¶ĞµÑ€Ñ‹ <= 20%, ĞĞ´Ğ¼Ğ¸Ğ½Ñ‹ <= 50%)
    """
    try:
        manager = PromoCodeManager(db)
        new_promo_code = await manager.create_promo_code(promo_in, current_user)
        return PromoCodeOut.from_orm(new_promo_code)
    except HTTPException:
        raise
    except Exception as e:
        raise HTTPException(status_code=status.HTTP_500_INTERNAL_SERVER_ERROR, detail=str(e))


@router.get("/", response_model=PromoCodeListResponse)
async def get_all_promo_codes(
        db: AsyncSession = Depends(get_db),
        _current_user: User = Depends(require_manager),
        skip: int = Query(0, ge=0, description="Ğ¡ĞºĞ¾Ğ»ÑŒĞºĞ¾ Ğ·Ğ°Ğ¿Ğ¸ÑĞµĞ¹ Ğ¿Ñ€Ğ¾Ğ¿ÑƒÑÑ‚Ğ¸Ñ‚ÑŒ"),
        limit: int = Query(10, ge=1, le=100, description="ĞœĞ°ĞºÑĞ¸Ğ¼Ğ°Ğ»ÑŒĞ½Ğ¾Ğµ ĞºĞ¾Ğ»Ğ¸Ñ‡ĞµÑÑ‚Ğ²Ğ¾ Ğ·Ğ°Ğ¿Ğ¸ÑĞµĞ¹ Ğ½Ğ° ÑÑ‚Ñ€Ğ°Ğ½Ğ¸Ñ†Ğµ")
):
    """ĞŸĞ¾Ğ»ÑƒÑ‡Ğ¸Ñ‚ÑŒ ÑĞ¿Ğ¸ÑĞ¾Ğº Ğ²ÑĞµÑ… Ğ¿Ñ€Ğ¾Ğ¼Ğ¾ĞºĞ¾Ğ´Ğ¾Ğ² Ñ Ğ¿Ğ°Ğ³Ğ¸Ğ½Ğ°Ñ†Ğ¸ĞµĞ¹ (Ñ‚Ğ¾Ğ»ÑŒĞºĞ¾ Ğ´Ğ»Ñ Ğ¼ĞµĞ½ĞµĞ´Ğ¶ĞµÑ€Ğ¾Ğ²/Ğ°Ğ´Ğ¼Ğ¸Ğ½Ğ¾Ğ²)"""
    try:
        manager = PromoCodeManager(db)
        promo_codes = await manager.get_all_promo_codes()
        
        # ĞŸÑ€Ğ¸Ğ¼ĞµĞ½ÑĞµĞ¼ Ğ¿Ğ°Ğ³Ğ¸Ğ½Ğ°Ñ†Ğ¸Ñ Ğº Ñ€ĞµĞ·ÑƒĞ»ÑŒÑ‚Ğ°Ñ‚Ñƒ
        total_promo_codes = len(promo_codes)
        paginated_promo_codes = promo_codes[skip:skip + limit]
        
        return PromoCodeListResponse(
            items=[PromoCodeOut.from_orm(pc) for pc in paginated_promo_codes],
            total=total_promo_codes
        )
    except Exception as e:
        raise HTTPException(status_code=status.HTTP_500_INTERNAL_SERVER_ERROR, detail=str(e))


@router.get("/generate/new-code", response_model=dict)
async def generate_promo_code(
        db: AsyncSession = Depends(get_db),
        _current_user: User = Depends(require_manager)
):
    """Ğ“ĞµĞ½ĞµÑ€Ğ¸Ñ€ÑƒĞµÑ‚ ÑƒĞ½Ğ¸ĞºĞ°Ğ»ÑŒĞ½Ñ‹Ğ¹ ĞºĞ¾Ğ´ Ğ¿Ñ€Ğ¾Ğ¼Ğ¾ĞºĞ¾Ğ´Ğ°"""
    try:
        manager = PromoCodeManager(db)
        generated_code = await manager.generate_unique_code()
        return {"generated_code": generated_code}
    except Exception as e:
        raise HTTPException(status_code=status.HTTP_500_INTERNAL_SERVER_ERROR, detail=str(e))


@router.put("/{promo_code_id}", response_model=PromoCodeOut)
async def update_promo_code(
        promo_code_id: int,
        promo_in: PromoCodeUpdate,
        db: AsyncSession = Depends(get_db),
        _current_user: User = Depends(require_manager),
        _csrf_protect: CsrfProtect = Depends()
):
    """ĞĞ±Ğ½Ğ¾Ğ²Ğ»ÑĞµÑ‚ ÑÑƒÑ‰ĞµÑÑ‚Ğ²ÑƒÑÑ‰Ğ¸Ğ¹ Ğ¿Ñ€Ğ¾Ğ¼Ğ¾ĞºĞ¾Ğ´ (Ñ‚Ğ¾Ğ»ÑŒĞºĞ¾ Ğ´Ğ»Ñ Ğ¼ĞµĞ½ĞµĞ´Ğ¶ĞµÑ€Ğ¾Ğ²/Ğ°Ğ´Ğ¼Ğ¸Ğ½Ğ¾Ğ²)."""
    try:
        manager = PromoCodeManager(db)
        updated_promo_code = await manager.update_promo_code(promo_code_id, promo_in)
        return PromoCodeOut.from_orm(updated_promo_code)
    except HTTPException:
        raise
    except Exception as e:
        raise HTTPException(status_code=status.HTTP_500_INTERNAL_SERVER_ERROR, detail=str(e))


@router.delete("/{promo_code_id}", status_code=status.HTTP_204_NO_CONTENT)
async def delete_promo_code(
        promo_code_id: int,
        db: AsyncSession = Depends(get_db),
        _current_user: User = Depends(require_manager),
        _csrf_protect: CsrfProtect = Depends()
):
    """Ğ£Ğ´Ğ°Ğ»ÑĞµÑ‚ Ğ¿Ñ€Ğ¾Ğ¼Ğ¾ĞºĞ¾Ğ´"""
    try:
        manager = PromoCodeManager(db)
        await manager.delete_promo_code(promo_code_id)
        return None
    except HTTPException:
        raise
    except Exception as e:
        raise HTTPException(status_code=status.HTTP_500_INTERNAL_SERVER_ERROR, detail=str(e))


@router.post("/validate", response_model=PromoCodeValidateResponse)
async def validate_promo_code_endpoint(
        request: PromoCodeValidateRequest,
        db: AsyncSession = Depends(get_db),
        token: str = Depends(optional_oauth2_scheme)
):
    """
    ĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑĞµÑ‚ Ğ²Ğ°Ğ»Ğ¸Ğ´Ğ½Ğ¾ÑÑ‚ÑŒ Ğ¿Ñ€Ğ¾Ğ¼Ğ¾ĞºĞ¾Ğ´Ğ° Ñ ÑƒÑ‡ĞµÑ‚Ğ¾Ğ¼ Ğ²ÑĞµÑ… ÑƒÑĞ»Ğ¾Ğ²Ğ¸Ğ¹.
    """
    try:
        current_user = await get_user_by_token(db, token) if token else None
        business_logic = PromoCodeBusinessLogic(db)
        
        promo_code = await business_logic.validate_and_get_promo_code(
            code=request.code,
            order_amount=request.order_amount,
            equipment_ids=request.equipment_ids,
            user=current_user
        )
        
        return await business_logic.create_validation_response(promo_code)
    except HTTPException:
        raise
    except Exception as e:
        raise HTTPException(status_code=status.HTTP_500_INTERNAL_SERVER_ERROR, detail=str(e))

```


## <a name="RentalAppFASTAPIapireservationapipy"></a>`RentalApp_FASTAPI/api/reservation_api.py`

```python
// path: RentalApp_FASTAPI/api/reservation_api.py

# api/reservation_api.py

from fastapi import APIRouter, Depends, HTTPException, Query
from sqlalchemy.ext.asyncio import AsyncSession
from typing import List, Optional

from api.services.order.order_lifecycle_service import OrderLifecycleService
from api.services.reservation_query_service import ReservationQueryService
from shared.schemas.reservation_schema import (
    ReservationCreateRequest, ReservationUpdateRequest, ReservationResponse,
    ReservationItem, ReservationListResponse, PriceCalculationRequest, PriceCalculationResponse
)
from api.permissions import require_user
from api.models.user import User
from api.models.promo_code import PromoCode
from api.deps import get_db, get_order_lifecycle_service, get_reservation_query_service
from fastapi_csrf_protect import CsrfProtect

from api.services.financial_service import FinancialService
from api.services.promo_code_service import validate_promo_code_for_use
from api.services.discount_service import get_duration_discount_percentage


router = APIRouter(prefix="/reservations", tags=["Ğ ĞµĞ·ĞµÑ€Ğ²Ñ‹ (Ğ´Ğ»Ñ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ĞµĞ¹)"])

@router.post("/", response_model=ReservationResponse)
async def create_reservation(
        request: ReservationCreateRequest,
        current_user: User = Depends(require_user),
        csrf_protect: CsrfProtect = Depends(),
        service: OrderLifecycleService = Depends(get_order_lifecycle_service)
):
    """Ğ¡Ğ¾Ğ·Ğ´Ğ°Ñ‚ÑŒ Ñ€ĞµĞ·ĞµÑ€Ğ² Ğ´Ğ»Ñ Ñ‚ĞµĞºÑƒÑ‰ĞµĞ³Ğ¾ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ñ."""
    new_reservation = await service.create_user_reservation(request, current_user)
    return ReservationResponse(reservation_id=new_reservation.id, message="Ğ ĞµĞ·ĞµÑ€Ğ² ÑƒÑĞ¿ĞµÑˆĞ½Ğ¾ ÑĞ¾Ğ·Ğ´Ğ°Ğ½")

@router.get("/", response_model=ReservationListResponse)
async def get_user_reservations(
        current_user: User = Depends(require_user),
        query_service: ReservationQueryService = Depends(get_reservation_query_service),
        status: Optional[str] = Query(None, description="Ğ¤Ğ¸Ğ»ÑŒÑ‚Ñ€ Ğ¿Ğ¾ ÑÑ‚Ğ°Ñ‚ÑƒÑÑƒ: active, completed, overdue"),
        search: Optional[str] = Query(None, description="ĞŸĞ¾Ğ¸ÑĞº Ğ¿Ğ¾ Ğ½Ğ°Ğ·Ğ²Ğ°Ğ½Ğ¸Ñ, Ğ±Ñ€ĞµĞ½Ğ´Ñƒ Ğ¸Ğ»Ğ¸ Ñ‚Ğ¸Ğ¿Ñƒ Ğ¾Ğ±Ğ¾Ñ€ÑƒĞ´Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ"),
        sort: Optional[str] = Query(None, description="Ğ¡Ğ¾Ñ€Ñ‚Ğ¸Ñ€Ğ¾Ğ²ĞºĞ°: id_desc, id_asc, start_date_desc, start_date_asc, end_date_desc, end_date_asc, count_desc, count_asc"),
        skip: int = Query(0, ge=0, description="ĞšĞ¾Ğ»Ğ¸Ñ‡ĞµÑÑ‚Ğ²Ğ¾ Ğ·Ğ°Ğ¿Ğ¸ÑĞµĞ¹ Ğ´Ğ»Ñ Ğ¿Ñ€Ğ¾Ğ¿ÑƒÑĞºĞ°"),
        limit: int = Query(100, ge=1, le=100, description="ĞœĞ°ĞºÑĞ¸Ğ¼Ğ°Ğ»ÑŒĞ½Ğ¾Ğµ ĞºĞ¾Ğ»Ğ¸Ñ‡ĞµÑÑ‚Ğ²Ğ¾ Ğ·Ğ°Ğ¿Ğ¸ÑĞµĞ¹ Ğ½Ğ° ÑÑ‚Ñ€Ğ°Ğ½Ğ¸Ñ†Ğµ")
):
    """ĞŸĞ¾Ğ»ÑƒÑ‡Ğ¸Ñ‚ÑŒ Ğ¾Ñ‚Ñ„Ğ¸Ğ»ÑŒÑ‚Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ½Ñ‹Ğ¹ Ğ¸ Ğ¿Ğ°Ğ³Ğ¸Ğ½Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ½Ñ‹Ğ¹ ÑĞ¿Ğ¸ÑĞ¾Ğº ÑĞ²Ğ¾Ğ¸Ñ… Ñ€ĞµĞ·ĞµÑ€Ğ²Ğ¾Ğ²."""
    items, total = await query_service.get_my_reservations(
        current_user, status, search, sort, skip, limit
    )
    return ReservationListResponse(items=items, total=total)

@router.delete("/{reservation_id}")
async def delete_reservation(
        reservation_id: int,
        current_user: User = Depends(require_user),
        csrf_protect: CsrfProtect = Depends(),
        service: OrderLifecycleService = Depends(get_order_lifecycle_service)
):
    """Ğ£Ğ´Ğ°Ğ»Ğ¸Ñ‚ÑŒ ÑĞ²Ğ¾Ğ¹ Ñ€ĞµĞ·ĞµÑ€Ğ²."""
    await service.cancel_user_reservation(reservation_id, current_user)
    return {"message": "Ğ ĞµĞ·ĞµÑ€Ğ² ÑƒĞ´Ğ°Ğ»Ñ‘Ğ½"}

@router.put("/{reservation_id}", response_model=ReservationResponse)
async def update_reservation(
        reservation_id: int,
        data: ReservationUpdateRequest,
        current_user: User = Depends(require_user),
        csrf_protect: CsrfProtect = Depends(),
        service: OrderLifecycleService = Depends(get_order_lifecycle_service)
):
    """ĞĞ±Ğ½Ğ¾Ğ²Ğ¸Ñ‚ÑŒ ÑĞ²Ğ¾Ğ¹ Ñ€ĞµĞ·ĞµÑ€Ğ²."""
    updated_reservation = await service.update_user_reservation(reservation_id, data, current_user)
    return ReservationResponse(reservation_id=updated_reservation.id, message="Ğ ĞµĞ·ĞµÑ€Ğ² ÑƒÑĞ¿ĞµÑˆĞ½Ğ¾ Ğ¾Ğ±Ğ½Ğ¾Ğ²Ğ»Ñ‘Ğ½")

@router.post("/calculate", response_model=PriceCalculationResponse)
async def calculate_price(
        request: PriceCalculationRequest,
        db: AsyncSession = Depends(get_db)
):
    """Ğ Ğ°ÑÑÑ‡Ğ¸Ñ‚Ñ‹Ğ²Ğ°ĞµÑ‚ ÑÑ‚Ğ¾Ğ¸Ğ¼Ğ¾ÑÑ‚ÑŒ Ñ€ĞµĞ·ĞµÑ€Ğ²Ğ° Ğ±ĞµĞ· ĞµĞ³Ğ¾ ÑĞ¾Ğ·Ğ´Ğ°Ğ½Ğ¸Ñ."""
    financial_service = FinancialService(db)
    financial_service.validate_date_range(request.start_date, request.end_date)
    promo_code_obj: Optional[PromoCode] = None
    promo_message: Optional[str] = None

    preliminary_price_details = await financial_service.calculate_final_price(
        request.equipment_ids, request.selected_accessories,
        request.start_date, request.end_date, None
    )

    if request.promo_code:
        try:
            promo_code_obj = await validate_promo_code_for_use(
                db, request.promo_code, preliminary_price_details.full_total,
                request.equipment_ids, None
            )
            promo_message = "ĞŸÑ€Ğ¾Ğ¼Ğ¾ĞºĞ¾Ğ´ ÑƒÑĞ¿ĞµÑˆĞ½Ğ¾ Ğ¿Ñ€Ğ¸Ğ¼ĞµĞ½ĞµĞ½!"
        except HTTPException as e:
            promo_message = e.detail

    final_price_details = await financial_service.calculate_final_price(
        request.equipment_ids, request.selected_accessories,
        request.start_date, request.end_date, promo_code_obj
    )

    day_count = await financial_service.get_rental_days(request.start_date, request.end_date)
    promo_discount = promo_code_obj.discount_percentage if promo_code_obj else 0

    return PriceCalculationResponse(
        day_count=day_count,
        full_total=final_price_details.full_total,
        final_total=final_price_details.final_total,
        discount_amount=final_price_details.discount_amount,
        duration_discount_percentage=await get_duration_discount_percentage(db, day_count),
        promo_discount_percentage=promo_discount,
        promo_code_message=promo_message
    )

```


## <a name="RentalAppFASTAPIapirouterpy"></a>`RentalApp_FASTAPI/api/router.py`

```python
// path: RentalApp_FASTAPI/api/router.py

# api/router.py

from fastapi import APIRouter
from api.auth_api import router as auth_router
from api.equipment_api import router as equipment_router
from api.reservation_api import router as reservation_router
from api.user_api import router as user_router
from api.calendar_api import router as calendar_router
from api.accessory_api import router as accessory_router
from api.admin_reservation_api import router as admin_reservation_router
from api.promo_code_api import router as promo_code_router
from api.holiday_api import router as holiday_router
from api.discount_api import router as discount_router
from api.association_api import router as association_router
from api.admin_rental_api import router as admin_rental_router
from api.admin_dashboard_api import router as admin_dashboard_router

router = APIRouter()

router.include_router(auth_router)
router.include_router(equipment_router)
router.include_router(reservation_router)
router.include_router(user_router)
router.include_router(calendar_router)
router.include_router(accessory_router)
router.include_router(admin_reservation_router)
router.include_router(promo_code_router)
router.include_router(holiday_router)
router.include_router(discount_router)
router.include_router(association_router)
router.include_router(admin_rental_router)
router.include_router(admin_dashboard_router)

# Ğ¡Ñ‚Ğ°Ñ€Ñ‹Ğµ ÑĞµÑ€Ğ²Ğ¸ÑÑ‹ Ğ±Ñ‹Ğ»Ğ¸ ÑƒĞ´Ğ°Ğ»ĞµĞ½Ñ‹, Ğ¿Ğ¾ÑÑ‚Ğ¾Ğ¼Ñƒ Ğ½Ğ¸ĞºĞ°ĞºĞ¸Ñ… Ğ¸Ğ·Ğ¼ĞµĞ½ĞµĞ½Ğ¸Ğ¹ Ğ² Ñ€Ğ¾ÑƒÑ‚ĞµÑ€Ğµ Ğ½Ğµ Ñ‚Ñ€ĞµĞ±ÑƒĞµÑ‚ÑÑ,
# Ñ‚Ğ°Ğº ĞºĞ°Ğº Ğ¾Ğ½ Ğ¿Ğ¾Ğ´ĞºĞ»ÑÑ‡Ğ°ĞµÑ‚ Ñ‚Ğ¾Ğ»ÑŒĞºĞ¾ API-ÑĞ»Ğ¾Ğ¹ (Ğ½Ğ°Ğ¿Ñ€Ğ¸Ğ¼ĞµÑ€, admin_rental_api),
# Ğ° Ğ²Ğ½ÑƒÑ‚Ñ€ĞµĞ½Ğ½Ğ¸Ğµ Ğ·Ğ°Ğ²Ğ¸ÑĞ¸Ğ¼Ğ¾ÑÑ‚Ğ¸ ÑÑ‚Ğ¸Ñ… API ÑƒĞ¶Ğµ Ğ¸Ğ·Ğ¼ĞµĞ½ĞµĞ½Ñ‹.

```


## <a name="RentalAppFASTAPIapiservicespytestcacheREADMEmd"></a>`RentalApp_FASTAPI/api/services/.pytest_cache/README.md`

```markdown
// path: RentalApp_FASTAPI/api/services/.pytest_cache/README.md

# pytest cache directory #

This directory contains data from the pytest's cache plugin,
which provides the `--lf` and `--ff` options, as well as the `cache` fixture.

**Do not** commit this to version control.

See [the docs](https://docs.pytest.org/en/stable/how-to/cache.html) for more information.


```


## <a name="RentalAppFASTAPIapiservicesauthservicepy"></a>`RentalApp_FASTAPI/api/services/auth_service.py`

```python
// path: RentalApp_FASTAPI/api/services/auth_service.py

# api/services/auth_service.py

from api.models.user import User
from passlib.context import CryptContext
from jose import JWTError, jwt
from sqlalchemy.ext.asyncio import AsyncSession
from sqlalchemy import select
from shared.schemas.user_schema import UserCreate
from datetime import datetime, timedelta
from config.secrets import SECRET_KEY
from fastapi import HTTPException
import logging

ALGORITHM = "HS256"
ACCESS_TOKEN_EXPIRE_MINUTES = 60
pwd_context = CryptContext(schemes=["bcrypt"], deprecated="auto")


def hash_password(password: str) -> str:
    return pwd_context.hash(password)


def verify_password(plain: str, hashed: str) -> bool:
    return pwd_context.verify(plain, hashed)


async def create_user(db: AsyncSession, user_data: UserCreate) -> User:
    try:
        result = await db.execute(select(User).filter(User.email == user_data.email))
        existing = result.scalars().first()
        if existing:
            raise HTTPException(status_code=409, detail="Email ÑƒĞ¶Ğµ Ğ·Ğ°Ñ€ĞµĞ³Ğ¸ÑÑ‚Ñ€Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½")

        # <<< Ğ˜Ğ—ĞœĞ•ĞĞ•ĞĞ˜Ğ•: Ğ”Ğ¾Ğ±Ğ°Ğ²Ğ»ÑĞµĞ¼ 'phone' Ğ¿Ñ€Ğ¸ ÑĞ¾Ğ·Ğ´Ğ°Ğ½Ğ¸Ğ¸ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ñ >>>
        user = User(
            full_name=user_data.full_name,
            email=user_data.email,
            hashed_password=hash_password(user_data.password),
            phone=user_data.phone,  # <--- ĞĞ¾Ğ²Ğ¾Ğµ Ğ¿Ğ¾Ğ»Ğµ
            role="user",
            is_active=True,
            status="ĞĞºÑ‚Ğ¸Ğ²Ğ½Ñ‹Ğ¹",
            balance=0.0,
            notes="Ğ¡Ğ¾Ğ·Ğ´Ğ°Ğ½ Ğ°Ğ²Ñ‚Ğ¾Ğ¼Ğ°Ñ‚Ğ¸Ñ‡ĞµÑĞºĞ¸ Ğ¿Ñ€Ğ¸ Ñ€ĞµĞ³Ğ¸ÑÑ‚Ñ€Ğ°Ñ†Ğ¸Ğ¸",
            # +++ ĞĞĞ’Ğ«Ğ• ĞŸĞĞ›Ğ¯ +++
            privacy_policy_accepted=user_data.privacy_policy_accepted,
            terms_accepted=user_data.terms_accepted,
            email_verified=True  # ĞŸÑ€Ğ¸ Ñ€ĞµĞ³Ğ¸ÑÑ‚Ñ€Ğ°Ñ†Ğ¸Ğ¸ email ÑÑ‡Ğ¸Ñ‚Ğ°ĞµÑ‚ÑÑ Ğ¿Ğ¾Ğ´Ñ‚Ğ²ĞµÑ€Ğ¶Ğ´ĞµĞ½Ğ½Ñ‹Ğ¼
        )
        db.add(user)
        await db.commit()
        await db.refresh(user)
        
        # Ğ’Ğ¾Ğ·Ğ²Ñ€Ğ°Ñ‰Ğ°ĞµĞ¼ ÑĞ¾Ğ·Ğ´Ğ°Ğ½Ğ½Ñ‹Ğ¹ Ğ¾Ğ±ÑŠĞµĞºÑ‚ Ñ Ğ·Ğ°Ğ³Ñ€ÑƒĞ¶ĞµĞ½Ğ½Ñ‹Ğ¼Ğ¸ Ğ´Ğ°Ğ½Ğ½Ñ‹Ğ¼Ğ¸ Ğ¸Ğ· Ğ‘Ğ”
        return user
    except HTTPException as http_exc:
        db.rollback()
        raise http_exc
    except Exception as e:
        db.rollback()
        logging.exception(f"[âŒ create_user] ĞÑˆĞ¸Ğ±ĞºĞ° Ğ¿Ñ€Ğ¸ Ñ€ĞµĞ³Ğ¸ÑÑ‚Ñ€Ğ°Ñ†Ğ¸Ğ¸: {e}")
        raise HTTPException(status_code=500, detail="ĞÑˆĞ¸Ğ±ĞºĞ° ÑĞµÑ€Ğ²ĞµÑ€Ğ° Ğ¿Ñ€Ğ¸ Ñ€ĞµĞ³Ğ¸ÑÑ‚Ñ€Ğ°Ñ†Ğ¸Ğ¸")


async def authenticate_user(db: AsyncSession, email: str, password: str) -> User | None:
    result = await db.execute(select(User).filter(User.email == email))
    user = result.scalars().first()
    if user and verify_password(password, user.hashed_password):
        return user
    return None


def create_access_token(data: dict, expires_delta: timedelta = None):
    to_encode = data.copy()
    expire = datetime.utcnow() + (expires_delta or timedelta(minutes=ACCESS_TOKEN_EXPIRE_MINUTES))
    to_encode.update({"exp": expire})
    return jwt.encode(to_encode, SECRET_KEY, algorithm=ALGORITHM)


async def get_user_by_token(db: AsyncSession, token: str) -> User | None:
    try:
        payload = jwt.decode(token, SECRET_KEY, algorithms=[ALGORITHM])
        email: str = payload.get("sub")
        if email is None:
            return None
    except JWTError:
        return None
    result = await db.execute(select(User).filter(User.email == email))
    return result.scalars().first()

```


## <a name="RentalAppFASTAPIapiservicesavailabilityinitpy"></a>`RentalApp_FASTAPI/api/services/availability/__init__.py`

```python
// path: RentalApp_FASTAPI/api/services/availability/__init__.py

# api/services/availability/__init__.py

from .availability_service import AvailabilityService
from .base import AvailabilityBaseService
from .conflicts import AvailabilityConflictsService
from .statuses import AvailabilityStatusService
from .calendar import AvailabilityCalendarService
from .queries import AvailabilityQueryService

__all__ = [
    'AvailabilityService',
    'AvailabilityBaseService',
    'AvailabilityConflictsService',
    'AvailabilityStatusService',
    'AvailabilityCalendarService',
    'AvailabilityQueryService'
]


```


## <a name="RentalAppFASTAPIapiservicesavailabilityavailabilityservicepy"></a>`RentalApp_FASTAPI/api/services/availability/availability_service.py`

```python
// path: RentalApp_FASTAPI/api/services/availability/availability_service.py

# api/services/availability/availability_service.py

from sqlalchemy.ext.asyncio import AsyncSession
from datetime import date
from typing import List, Dict, Any, Optional

from .conflicts import AvailabilityConflictsService
from .statuses import AvailabilityStatusService
from .calendar import AvailabilityCalendarService
from .queries import AvailabilityQueryService


class AvailabilityService:
    """
    Ğ“Ğ»Ğ°Ğ²Ğ½Ñ‹Ğ¹ Ñ„Ğ°ÑĞ°Ğ´ Ğ´Ğ»Ñ ÑĞµÑ€Ğ²Ğ¸ÑĞ¾Ğ² Ğ¿Ñ€Ğ¾Ğ²ĞµÑ€ĞºĞ¸ Ğ´Ğ¾ÑÑ‚ÑƒĞ¿Ğ½Ğ¾ÑÑ‚Ğ¸ Ğ¾Ğ±Ğ¾Ñ€ÑƒĞ´Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ.
    ĞĞ±ÑŠĞµĞ´Ğ¸Ğ½ÑĞµÑ‚ Ğ²ÑĞµ ÑĞ¿ĞµÑ†Ğ¸Ğ°Ğ»Ğ¸Ğ·Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ½Ñ‹Ğµ ÑĞµÑ€Ğ²Ğ¸ÑÑ‹ Ğ² ĞµĞ´Ğ¸Ğ½Ñ‹Ğ¹ Ğ¸Ğ½Ñ‚ĞµÑ€Ñ„ĞµĞ¹Ñ.
    Ğ•Ğ´Ğ¸Ğ½ÑÑ‚Ğ²ĞµĞ½Ğ½Ñ‹Ğ¹ Ğ¸ÑÑ‚Ğ¾Ñ‡Ğ½Ğ¸Ğº Ğ¿Ñ€Ğ°Ğ²Ğ´Ñ‹ Ğ´Ğ»Ñ Ğ²ÑĞµÑ… Ğ¿Ñ€Ğ¾Ğ²ĞµÑ€Ğ¾Ğº Ğ´Ğ¾ÑÑ‚ÑƒĞ¿Ğ½Ğ¾ÑÑ‚Ğ¸ Ğ² ÑĞ¸ÑÑ‚ĞµĞ¼Ğµ.
    """

    def __init__(self, db: AsyncSession):
        self.db = db
        
        # Ğ˜Ğ½Ğ¸Ñ†Ğ¸Ğ°Ğ»Ğ¸Ğ·Ğ¸Ñ€ÑƒĞµĞ¼ ÑĞ¿ĞµÑ†Ğ¸Ğ°Ğ»Ğ¸Ğ·Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ½Ñ‹Ğµ ÑĞµÑ€Ğ²Ğ¸ÑÑ‹
        self._conflicts_service = AvailabilityConflictsService(db)
        self._status_service = AvailabilityStatusService(db)
        self._calendar_service = AvailabilityCalendarService(db)
        self._query_service = AvailabilityQueryService(db)

    # === ĞœĞ•Ğ¢ĞĞ”Ğ« Ğ”Ğ›Ğ¯ Ğ ĞĞ‘ĞĞ¢Ğ« Ğ¡ ĞšĞĞĞ¤Ğ›Ğ˜ĞšĞ¢ĞĞœĞ˜ ===
    
    async def get_conflicts(
        self,
        equipment_ids: List[int],
        start_date: date,
        end_date: date,
        exclude_reservation_id: Optional[int] = None,
        exclude_rental_id: Optional[int] = None
    ) -> Dict[int, List[Dict[str, Any]]]:
        """
        ĞÑĞ½Ğ¾Ğ²Ğ½Ğ¾Ğ¹ Ğ¼ĞµÑ‚Ğ¾Ğ´ Ğ´Ğ»Ñ Ğ¿Ğ¾Ğ»ÑƒÑ‡ĞµĞ½Ğ¸Ñ Ğ²ÑĞµÑ… ĞºĞ¾Ğ½Ñ„Ğ»Ğ¸ĞºÑ‚Ğ¾Ğ² Ğ´Ğ¾ÑÑ‚ÑƒĞ¿Ğ½Ğ¾ÑÑ‚Ğ¸ Ğ¾Ğ±Ğ¾Ñ€ÑƒĞ´Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ.
        
        Args:
            equipment_ids: Ğ¡Ğ¿Ğ¸ÑĞ¾Ğº ID Ğ¾Ğ±Ğ¾Ñ€ÑƒĞ´Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ Ğ´Ğ»Ñ Ğ¿Ñ€Ğ¾Ğ²ĞµÑ€ĞºĞ¸
            start_date: Ğ”Ğ°Ñ‚Ğ° Ğ½Ğ°Ñ‡Ğ°Ğ»Ğ° Ğ¿ĞµÑ€Ğ¸Ğ¾Ğ´Ğ°
            end_date: Ğ”Ğ°Ñ‚Ğ° Ğ¾ĞºĞ¾Ğ½Ñ‡Ğ°Ğ½Ğ¸Ñ Ğ¿ĞµÑ€Ğ¸Ğ¾Ğ´Ğ° (Ğ²ĞºĞ»ÑÑ‡Ğ¸Ñ‚ĞµĞ»ÑŒĞ½Ğ¾)
            exclude_reservation_id: ID Ñ€ĞµĞ·ĞµÑ€Ğ²Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ Ğ´Ğ»Ñ Ğ¸ÑĞºĞ»ÑÑ‡ĞµĞ½Ğ¸Ñ Ğ¸Ğ· Ğ¿Ñ€Ğ¾Ğ²ĞµÑ€ĞºĞ¸
            exclude_rental_id: ID Ğ°Ñ€ĞµĞ½Ğ´Ñ‹ Ğ´Ğ»Ñ Ğ¸ÑĞºĞ»ÑÑ‡ĞµĞ½Ğ¸Ñ Ğ¸Ğ· Ğ¿Ñ€Ğ¾Ğ²ĞµÑ€ĞºĞ¸
            
        Returns:
            Ğ¡Ğ»Ğ¾Ğ²Ğ°Ñ€ÑŒ, Ğ³Ğ´Ğµ ĞºĞ»ÑÑ‡ - ID Ğ¾Ğ±Ğ¾Ñ€ÑƒĞ´Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ, Ğ·Ğ½Ğ°Ñ‡ĞµĞ½Ğ¸Ğµ - ÑĞ¿Ğ¸ÑĞ¾Ğº ĞºĞ¾Ğ½Ñ„Ğ»Ğ¸ĞºÑ‚Ğ¾Ğ²
        """
        return await self._conflicts_service.get_conflicts(
            equipment_ids, start_date, end_date, exclude_reservation_id, exclude_rental_id
        )

    async def get_conflicting_equipment_ids(
        self,
        equipment_ids: List[int],
        start_date: date,
        end_date: date,
        exclude_reservation_id: Optional[int] = None,
        exclude_rental_id: Optional[int] = None
    ) -> List[int]:
        """
        Ğ’Ğ¾Ğ·Ğ²Ñ€Ğ°Ñ‰Ğ°ĞµÑ‚ ÑĞ¿Ğ¸ÑĞ¾Ğº ID Ğ¾Ğ±Ğ¾Ñ€ÑƒĞ´Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ, Ñƒ ĞºĞ¾Ñ‚Ğ¾Ñ€Ğ¾Ğ³Ğ¾ ĞµÑÑ‚ÑŒ ĞºĞ¾Ğ½Ñ„Ğ»Ğ¸ĞºÑ‚Ñ‹ Ğ´Ğ¾ÑÑ‚ÑƒĞ¿Ğ½Ğ¾ÑÑ‚Ğ¸.
        
        Args:
            equipment_ids: Ğ¡Ğ¿Ğ¸ÑĞ¾Ğº ID Ğ¾Ğ±Ğ¾Ñ€ÑƒĞ´Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ Ğ´Ğ»Ñ Ğ¿Ñ€Ğ¾Ğ²ĞµÑ€ĞºĞ¸
            start_date: Ğ”Ğ°Ñ‚Ğ° Ğ½Ğ°Ñ‡Ğ°Ğ»Ğ° Ğ¿ĞµÑ€Ğ¸Ğ¾Ğ´Ğ°
            end_date: Ğ”Ğ°Ñ‚Ğ° Ğ¾ĞºĞ¾Ğ½Ñ‡Ğ°Ğ½Ğ¸Ñ Ğ¿ĞµÑ€Ğ¸Ğ¾Ğ´Ğ°
            exclude_reservation_id: ID Ñ€ĞµĞ·ĞµÑ€Ğ²Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ Ğ´Ğ»Ñ Ğ¸ÑĞºĞ»ÑÑ‡ĞµĞ½Ğ¸Ñ
            exclude_rental_id: ID Ğ°Ñ€ĞµĞ½Ğ´Ñ‹ Ğ´Ğ»Ñ Ğ¸ÑĞºĞ»ÑÑ‡ĞµĞ½Ğ¸Ñ
            
        Returns:
            Ğ¡Ğ¿Ğ¸ÑĞ¾Ğº ID Ğ¾Ğ±Ğ¾Ñ€ÑƒĞ´Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ Ñ ĞºĞ¾Ğ½Ñ„Ğ»Ğ¸ĞºÑ‚Ğ°Ğ¼Ğ¸
        """
        return await self._conflicts_service.get_conflicting_equipment_ids(
            equipment_ids, start_date, end_date, exclude_reservation_id, exclude_rental_id
        )

    # === ĞœĞ•Ğ¢ĞĞ”Ğ« Ğ”Ğ›Ğ¯ Ğ ĞĞ‘ĞĞ¢Ğ« Ğ¡Ğ Ğ¡Ğ¢ĞĞ¢Ğ£Ğ¡ĞĞœĞ˜ ===
    
    async def get_availability_statuses(
        self,
        equipment_ids: List[int],
        start_date: date,
        end_date: date,
        exclude_reservation_id: Optional[int] = None,
        exclude_rental_id: Optional[int] = None
    ) -> Dict[int, Dict[str, Any]]:
        """
        Ğ’Ğ¾Ğ·Ğ²Ñ€Ğ°Ñ‰Ğ°ĞµÑ‚ ÑÑ‚Ğ°Ñ‚ÑƒÑÑ‹ Ğ´Ğ¾ÑÑ‚ÑƒĞ¿Ğ½Ğ¾ÑÑ‚Ğ¸ Ğ´Ğ»Ñ ÑĞ¿Ğ¸ÑĞºĞ° Ğ¾Ğ±Ğ¾Ñ€ÑƒĞ´Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ.
        
        Args:
            equipment_ids: Ğ¡Ğ¿Ğ¸ÑĞ¾Ğº ID Ğ¾Ğ±Ğ¾Ñ€ÑƒĞ´Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ Ğ´Ğ»Ñ Ğ¿Ñ€Ğ¾Ğ²ĞµÑ€ĞºĞ¸
            start_date: Ğ”Ğ°Ñ‚Ğ° Ğ½Ğ°Ñ‡Ğ°Ğ»Ğ° Ğ¿ĞµÑ€Ğ¸Ğ¾Ğ´Ğ°
            end_date: Ğ”Ğ°Ñ‚Ğ° Ğ¾ĞºĞ¾Ğ½Ñ‡Ğ°Ğ½Ğ¸Ñ Ğ¿ĞµÑ€Ğ¸Ğ¾Ğ´Ğ°
            exclude_reservation_id: ID Ñ€ĞµĞ·ĞµÑ€Ğ²Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ Ğ´Ğ»Ñ Ğ¸ÑĞºĞ»ÑÑ‡ĞµĞ½Ğ¸Ñ
            exclude_rental_id: ID Ğ°Ñ€ĞµĞ½Ğ´Ñ‹ Ğ´Ğ»Ñ Ğ¸ÑĞºĞ»ÑÑ‡ĞµĞ½Ğ¸Ñ
            
        Returns:
            Ğ¡Ğ»Ğ¾Ğ²Ğ°Ñ€ÑŒ ÑĞ¾ ÑÑ‚Ğ°Ñ‚ÑƒÑĞ°Ğ¼Ğ¸ Ğ¾Ğ±Ğ¾Ñ€ÑƒĞ´Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ
        """
        return await self._status_service.get_availability_statuses(
            equipment_ids, start_date, end_date, exclude_reservation_id, exclude_rental_id
        )

    async def get_daily_statuses(
        self,
        equipment_ids: List[int],
        start_date: date,
        end_date: date,
        exclude_reservation_id: Optional[int] = None,
        exclude_rental_id: Optional[int] = None,
        current_user_id: Optional[int] = None
    ) -> Dict[int, Dict[str, Any]]:
        """
        Ğ’Ğ¾Ğ·Ğ²Ñ€Ğ°Ñ‰Ğ°ĞµÑ‚ ÑÑ‚Ğ°Ñ‚ÑƒÑÑ‹ Ğ¾Ğ±Ğ¾Ñ€ÑƒĞ´Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ Ğ¿Ğ¾ Ğ´Ğ½ÑĞ¼ Ğ´Ğ»Ñ ĞºĞ°Ğ»ĞµĞ½Ğ´Ğ°Ñ€Ğ½Ğ¾Ğ³Ğ¾ Ğ¿Ñ€ĞµĞ´ÑÑ‚Ğ°Ğ²Ğ»ĞµĞ½Ğ¸Ñ.
        
        Args:
            equipment_ids: Ğ¡Ğ¿Ğ¸ÑĞ¾Ğº ID Ğ¾Ğ±Ğ¾Ñ€ÑƒĞ´Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ Ğ´Ğ»Ñ Ğ¿Ñ€Ğ¾Ğ²ĞµÑ€ĞºĞ¸
            start_date: Ğ”Ğ°Ñ‚Ğ° Ğ½Ğ°Ñ‡Ğ°Ğ»Ğ° Ğ¿ĞµÑ€Ğ¸Ğ¾Ğ´Ğ°
            end_date: Ğ”Ğ°Ñ‚Ğ° Ğ¾ĞºĞ¾Ğ½Ñ‡Ğ°Ğ½Ğ¸Ñ Ğ¿ĞµÑ€Ğ¸Ğ¾Ğ´Ğ°
            exclude_reservation_id: ID Ñ€ĞµĞ·ĞµÑ€Ğ²Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ Ğ´Ğ»Ñ Ğ¸ÑĞºĞ»ÑÑ‡ĞµĞ½Ğ¸Ñ
            exclude_rental_id: ID Ğ°Ñ€ĞµĞ½Ğ´Ñ‹ Ğ´Ğ»Ñ Ğ¸ÑĞºĞ»ÑÑ‡ĞµĞ½Ğ¸Ñ
            current_user_id: ID Ñ‚ĞµĞºÑƒÑ‰ĞµĞ³Ğ¾ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ñ Ğ´Ğ»Ñ Ğ²Ñ‹Ğ´ĞµĞ»ĞµĞ½Ğ¸Ñ ĞµĞ³Ğ¾ Ñ€ĞµĞ·ĞµÑ€Ğ²Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğ¹
            
        Returns:
            Ğ¡Ğ»Ğ¾Ğ²Ğ°Ñ€ÑŒ ÑĞ¾ ÑÑ‚Ğ°Ñ‚ÑƒÑĞ°Ğ¼Ğ¸ Ğ¿Ğ¾ Ğ´Ğ½ÑĞ¼
        """
        return await self._status_service.get_daily_statuses(
            equipment_ids, start_date, end_date, exclude_reservation_id, exclude_rental_id, current_user_id
        )

    # === ĞœĞ•Ğ¢ĞĞ”Ğ« Ğ”Ğ›Ğ¯ Ğ ĞĞ‘ĞĞ¢Ğ« Ğ¡ ĞšĞĞ›Ğ•ĞĞ”ĞĞ Ğ•Ğœ ===
    
    async def get_calendar_events(
        self,
        equipment_ids: List[int],
        start_date: date,
        end_date: date
    ) -> List[Dict[str, Any]]:
        """
        Ğ’Ğ¾Ğ·Ğ²Ñ€Ğ°Ñ‰Ğ°ĞµÑ‚ ÑĞ¾Ğ±Ñ‹Ñ‚Ğ¸Ñ Ğ´Ğ»Ñ ĞºĞ°Ğ»ĞµĞ½Ğ´Ğ°Ñ€Ñ Ğ² Ñ„Ğ¾Ñ€Ğ¼Ğ°Ñ‚Ğµ FullCalendar.
        
        Args:
            equipment_ids: Ğ¡Ğ¿Ğ¸ÑĞ¾Ğº ID Ğ¾Ğ±Ğ¾Ñ€ÑƒĞ´Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ
            start_date: Ğ”Ğ°Ñ‚Ğ° Ğ½Ğ°Ñ‡Ğ°Ğ»Ğ° Ğ¿ĞµÑ€Ğ¸Ğ¾Ğ´Ğ°
            end_date: Ğ”Ğ°Ñ‚Ğ° Ğ¾ĞºĞ¾Ğ½Ñ‡Ğ°Ğ½Ğ¸Ñ Ğ¿ĞµÑ€Ğ¸Ğ¾Ğ´Ğ°
            
        Returns:
            Ğ¡Ğ¿Ğ¸ÑĞ¾Ğº ÑĞ¾Ğ±Ñ‹Ñ‚Ğ¸Ğ¹ Ğ´Ğ»Ñ ĞºĞ°Ğ»ĞµĞ½Ğ´Ğ°Ñ€Ñ
        """
        return await self._calendar_service.get_calendar_events(
            equipment_ids, start_date, end_date
        )

    # === ĞœĞ•Ğ¢ĞĞ”Ğ« Ğ”Ğ›Ğ¯ Ğ ĞĞ‘ĞĞ¢Ğ« Ğ¡ SQL-Ğ—ĞĞŸĞ ĞĞ¡ĞĞœĞ˜ ===
    
    def get_sqlalchemy_filter_for_available_equipment(
        self,
        start_date: date,
        end_date: date,
        exclude_reservation_id: Optional[int] = None,
        exclude_rental_id: Optional[int] = None
    ):
        """
        Ğ’Ğ¾Ğ·Ğ²Ñ€Ğ°Ñ‰Ğ°ĞµÑ‚ SQLAlchemy Ñ„Ğ¸Ğ»ÑŒÑ‚Ñ€ Ğ´Ğ»Ñ Ğ¸ÑĞºĞ»ÑÑ‡ĞµĞ½Ğ¸Ñ Ğ½ĞµĞ´Ğ¾ÑÑ‚ÑƒĞ¿Ğ½Ğ¾Ğ³Ğ¾ Ğ¾Ğ±Ğ¾Ñ€ÑƒĞ´Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ.
        Ğ˜ÑĞ¿Ğ¾Ğ»ÑŒĞ·ÑƒĞµÑ‚ÑÑ Ğ´Ğ»Ñ Ğ¾Ğ¿Ñ‚Ğ¸Ğ¼Ğ¸Ğ·Ğ°Ñ†Ğ¸Ğ¸ Ğ·Ğ°Ğ¿Ñ€Ğ¾ÑĞ¾Ğ² Ğ² EquipmentQueryBuilder.
        
        Args:
            start_date: Ğ”Ğ°Ñ‚Ğ° Ğ½Ğ°Ñ‡Ğ°Ğ»Ğ° Ğ¿ĞµÑ€Ğ¸Ğ¾Ğ´Ğ°
            end_date: Ğ”Ğ°Ñ‚Ğ° Ğ¾ĞºĞ¾Ğ½Ñ‡Ğ°Ğ½Ğ¸Ñ Ğ¿ĞµÑ€Ğ¸Ğ¾Ğ´Ğ°
            exclude_reservation_id: ID Ñ€ĞµĞ·ĞµÑ€Ğ²Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ Ğ´Ğ»Ñ Ğ¸ÑĞºĞ»ÑÑ‡ĞµĞ½Ğ¸Ñ
            exclude_rental_id: ID Ğ°Ñ€ĞµĞ½Ğ´Ñ‹ Ğ´Ğ»Ñ Ğ¸ÑĞºĞ»ÑÑ‡ĞµĞ½Ğ¸Ñ
            
        Returns:
            SQLAlchemy BinaryExpression Ğ´Ğ»Ñ Ñ„Ğ¸Ğ»ÑŒÑ‚Ñ€Ğ°Ñ†Ğ¸Ğ¸
        """
        return self._query_service.get_sqlalchemy_filter_for_available_equipment(
            start_date, end_date, exclude_reservation_id, exclude_rental_id
        )


```


## <a name="RentalAppFASTAPIapiservicesavailabilitybasepy"></a>`RentalApp_FASTAPI/api/services/availability/base.py`

```python
// path: RentalApp_FASTAPI/api/services/availability/base.py

# api/services/availability/base.py

from sqlalchemy.ext.asyncio import AsyncSession
from sqlalchemy.orm import selectinload
from sqlalchemy import select
from datetime import date
from typing import List, Dict, Any, Optional
import logging

from api.models.reservation import Reservation
from api.models.equipment import Equipment
from api.models.rental import Rental

logger = logging.getLogger(__name__)


class AvailabilityBaseService:
    """
    Ğ‘Ğ°Ğ·Ğ¾Ğ²Ñ‹Ğ¹ ĞºĞ»Ğ°ÑÑ Ğ´Ğ»Ñ ÑĞµÑ€Ğ²Ğ¸ÑĞ¾Ğ² Ğ¿Ñ€Ğ¾Ğ²ĞµÑ€ĞºĞ¸ Ğ´Ğ¾ÑÑ‚ÑƒĞ¿Ğ½Ğ¾ÑÑ‚Ğ¸ Ğ¾Ğ±Ğ¾Ñ€ÑƒĞ´Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ.
    Ğ¡Ğ¾Ğ´ĞµÑ€Ğ¶Ğ¸Ñ‚ Ğ¾Ğ±Ñ‰ÑƒÑ Ğ»Ğ¾Ğ³Ğ¸ĞºÑƒ Ğ´Ğ»Ñ Ñ€Ğ°Ğ±Ğ¾Ñ‚Ñ‹ Ñ Ñ€ĞµĞ·ĞµÑ€Ğ²Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸ÑĞ¼Ğ¸ Ğ¸ Ğ°Ñ€ĞµĞ½Ğ´Ğ°Ğ¼Ğ¸.
    """

    def __init__(self, db: AsyncSession):
        self.db = db

    async def _get_overlapping_reservations(
        self,
        equipment_ids: List[int],
        start_date: date,
        end_date: date,
        exclude_reservation_id: Optional[int] = None
    ) -> List[Reservation]:
        """
        ĞŸĞ¾Ğ»ÑƒÑ‡Ğ°ĞµÑ‚ Ñ€ĞµĞ·ĞµÑ€Ğ²Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ, Ğ¿ĞµÑ€ĞµÑĞµĞºĞ°ÑÑ‰Ğ¸ĞµÑÑ Ñ ÑƒĞºĞ°Ğ·Ğ°Ğ½Ğ½Ñ‹Ğ¼ Ğ¿ĞµÑ€Ğ¸Ğ¾Ğ´Ğ¾Ğ¼.
        
        Args:
            equipment_ids: Ğ¡Ğ¿Ğ¸ÑĞ¾Ğº ID Ğ¾Ğ±Ğ¾Ñ€ÑƒĞ´Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ Ğ´Ğ»Ñ Ğ¿Ñ€Ğ¾Ğ²ĞµÑ€ĞºĞ¸
            start_date: Ğ”Ğ°Ñ‚Ğ° Ğ½Ğ°Ñ‡Ğ°Ğ»Ğ° Ğ¿ĞµÑ€Ğ¸Ğ¾Ğ´Ğ°
            end_date: Ğ”Ğ°Ñ‚Ğ° Ğ¾ĞºĞ¾Ğ½Ñ‡Ğ°Ğ½Ğ¸Ñ Ğ¿ĞµÑ€Ğ¸Ğ¾Ğ´Ğ°
            exclude_reservation_id: ID Ñ€ĞµĞ·ĞµÑ€Ğ²Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ Ğ´Ğ»Ñ Ğ¸ÑĞºĞ»ÑÑ‡ĞµĞ½Ğ¸Ñ
            
        Returns:
            Ğ¡Ğ¿Ğ¸ÑĞ¾Ğº Ñ€ĞµĞ·ĞµÑ€Ğ²Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğ¹, Ğ¿ĞµÑ€ĞµÑĞµĞºĞ°ÑÑ‰Ğ¸Ñ…ÑÑ Ñ Ğ¿ĞµÑ€Ğ¸Ğ¾Ğ´Ğ¾Ğ¼
        """
        query = select(Reservation).options(
            selectinload(Reservation.equipment)
        ).filter(
            Reservation.end_date > start_date,
            Reservation.start_date < end_date,
            Reservation.status == 'active'
        ).where(
            Reservation.equipment.any(Equipment.id.in_(equipment_ids))
        )
        
        if exclude_reservation_id:
            query = query.filter(Reservation.id != exclude_reservation_id)
            
        result = await self.db.execute(query)
        return result.unique().scalars().all()

    async def _get_overlapping_rentals(
        self,
        equipment_ids: List[int],
        start_date: date,
        end_date: date,
        exclude_rental_id: Optional[int] = None
    ) -> List[Rental]:
        """
        ĞŸĞ¾Ğ»ÑƒÑ‡Ğ°ĞµÑ‚ Ğ°Ñ€ĞµĞ½Ğ´Ñ‹, Ğ¿ĞµÑ€ĞµÑĞµĞºĞ°ÑÑ‰Ğ¸ĞµÑÑ Ñ ÑƒĞºĞ°Ğ·Ğ°Ğ½Ğ½Ñ‹Ğ¼ Ğ¿ĞµÑ€Ğ¸Ğ¾Ğ´Ğ¾Ğ¼.
        
        Args:
            equipment_ids: Ğ¡Ğ¿Ğ¸ÑĞ¾Ğº ID Ğ¾Ğ±Ğ¾Ñ€ÑƒĞ´Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ Ğ´Ğ»Ñ Ğ¿Ñ€Ğ¾Ğ²ĞµÑ€ĞºĞ¸
            start_date: Ğ”Ğ°Ñ‚Ğ° Ğ½Ğ°Ñ‡Ğ°Ğ»Ğ° Ğ¿ĞµÑ€Ğ¸Ğ¾Ğ´Ğ°
            end_date: Ğ”Ğ°Ñ‚Ğ° Ğ¾ĞºĞ¾Ğ½Ñ‡Ğ°Ğ½Ğ¸Ñ Ğ¿ĞµÑ€Ğ¸Ğ¾Ğ´Ğ°
            exclude_rental_id: ID Ğ°Ñ€ĞµĞ½Ğ´Ñ‹ Ğ´Ğ»Ñ Ğ¸ÑĞºĞ»ÑÑ‡ĞµĞ½Ğ¸Ñ
            
        Returns:
            Ğ¡Ğ¿Ğ¸ÑĞ¾Ğº Ğ°Ñ€ĞµĞ½Ğ´, Ğ¿ĞµÑ€ĞµÑĞµĞºĞ°ÑÑ‰Ğ¸Ñ…ÑÑ Ñ Ğ¿ĞµÑ€Ğ¸Ğ¾Ğ´Ğ¾Ğ¼
        """
        query = select(Rental).options(
            selectinload(Rental.equipment)
        ).filter(
            Rental.end_date > start_date,
            Rental.start_date < end_date,
            Rental.status.in_(['active', 'overdue'])
        ).where(
            Rental.equipment.any(Equipment.id.in_(equipment_ids))
        )
        
        if exclude_rental_id:
            query = query.filter(Rental.id != exclude_rental_id)
            
        result = await self.db.execute(query)
        return result.unique().scalars().all()

    def _filter_equipment_in_list(
        self,
        equipment_list: List[Equipment],
        equipment_ids: List[int]
    ) -> List[Equipment]:
        """
        Ğ¤Ğ¸Ğ»ÑŒÑ‚Ñ€ÑƒĞµÑ‚ Ğ¾Ğ±Ğ¾Ñ€ÑƒĞ´Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ Ğ¿Ğ¾ ÑĞ¿Ğ¸ÑĞºÑƒ ID.
        
        Args:
            equipment_list: Ğ¡Ğ¿Ğ¸ÑĞ¾Ğº Ğ¾Ğ±Ğ¾Ñ€ÑƒĞ´Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ Ğ´Ğ»Ñ Ñ„Ğ¸Ğ»ÑŒÑ‚Ñ€Ğ°Ñ†Ğ¸Ğ¸
            equipment_ids: Ğ¡Ğ¿Ğ¸ÑĞ¾Ğº ID Ğ¾Ğ±Ğ¾Ñ€ÑƒĞ´Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ Ğ´Ğ»Ñ Ğ²ĞºĞ»ÑÑ‡ĞµĞ½Ğ¸Ñ
            
        Returns:
            ĞÑ‚Ñ„Ğ¸Ğ»ÑŒÑ‚Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ½Ñ‹Ğ¹ ÑĞ¿Ğ¸ÑĞ¾Ğº Ğ¾Ğ±Ğ¾Ñ€ÑƒĞ´Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ
        """
        return [eq for eq in equipment_list if eq.id in equipment_ids]

    def _create_conflict_dict(
        self,
        conflict_type: str,
        conflict_id: int,
        start_date: date,
        end_date: date,
        user_id: int
    ) -> Dict[str, Any]:
        """
        Ğ¡Ğ¾Ğ·Ğ´Ğ°ĞµÑ‚ ÑĞ»Ğ¾Ğ²Ğ°Ñ€ÑŒ Ñ Ğ¸Ğ½Ñ„Ğ¾Ñ€Ğ¼Ğ°Ñ†Ğ¸ĞµĞ¹ Ğ¾ ĞºĞ¾Ğ½Ñ„Ğ»Ğ¸ĞºÑ‚Ğµ.
        
        Args:
            conflict_type: Ğ¢Ğ¸Ğ¿ ĞºĞ¾Ğ½Ñ„Ğ»Ğ¸ĞºÑ‚Ğ° ('reservation' Ğ¸Ğ»Ğ¸ 'rental')
            conflict_id: ID ĞºĞ¾Ğ½Ñ„Ğ»Ğ¸ĞºÑ‚Ğ°
            start_date: Ğ”Ğ°Ñ‚Ğ° Ğ½Ğ°Ñ‡Ğ°Ğ»Ğ°
            end_date: Ğ”Ğ°Ñ‚Ğ° Ğ¾ĞºĞ¾Ğ½Ñ‡Ğ°Ğ½Ğ¸Ñ
            user_id: ID Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ñ
            
        Returns:
            Ğ¡Ğ»Ğ¾Ğ²Ğ°Ñ€ÑŒ Ñ Ğ¸Ğ½Ñ„Ğ¾Ñ€Ğ¼Ğ°Ñ†Ğ¸ĞµĞ¹ Ğ¾ ĞºĞ¾Ğ½Ñ„Ğ»Ğ¸ĞºÑ‚Ğµ
        """
        return {
            'type': conflict_type,
            'id': conflict_id,
            'start_date': start_date,
            'end_date': end_date,
            'user_id': user_id
        }


```


## <a name="RentalAppFASTAPIapiservicesavailabilitycalendarpy"></a>`RentalApp_FASTAPI/api/services/availability/calendar.py`

```python
// path: RentalApp_FASTAPI/api/services/availability/calendar.py

# api/services/availability/calendar.py

from sqlalchemy.orm import selectinload, joinedload
from sqlalchemy import select
from datetime import date
from typing import List, Dict, Any

from .base import AvailabilityBaseService
from api.models.rental import Rental 
from api.models.reservation import Reservation


class AvailabilityCalendarService(AvailabilityBaseService):
    """
    Ğ¡ĞµÑ€Ğ²Ğ¸Ñ Ğ´Ğ»Ñ Ñ€Ğ°Ğ±Ğ¾Ñ‚Ñ‹ Ñ ĞºĞ°Ğ»ĞµĞ½Ğ´Ğ°Ñ€Ğ½Ñ‹Ğ¼Ğ¸ ÑĞ¾Ğ±Ñ‹Ñ‚Ğ¸ÑĞ¼Ğ¸.
    ĞÑ‚Ğ²ĞµÑ‡Ğ°ĞµÑ‚ Ğ·Ğ° Ğ³ĞµĞ½ĞµÑ€Ğ°Ñ†Ğ¸Ñ ÑĞ¾Ğ±Ñ‹Ñ‚Ğ¸Ğ¹ Ğ´Ğ»Ñ FullCalendar Ğ¸ Ğ´Ñ€ÑƒĞ³Ğ¸Ñ… ĞºĞ°Ğ»ĞµĞ½Ğ´Ğ°Ñ€Ğ½Ñ‹Ñ… Ğ¿Ñ€ĞµĞ´ÑÑ‚Ğ°Ğ²Ğ»ĞµĞ½Ğ¸Ğ¹.
    """

    async def get_calendar_events(
        self,
        equipment_ids: List[int],
        start_date: date,
        end_date: date
    ) -> List[Dict[str, Any]]:
        """
        Ğ’Ğ¾Ğ·Ğ²Ñ€Ğ°Ñ‰Ğ°ĞµÑ‚ ÑĞ¾Ğ±Ñ‹Ñ‚Ğ¸Ñ Ğ´Ğ»Ñ ĞºĞ°Ğ»ĞµĞ½Ğ´Ğ°Ñ€Ñ Ğ² Ñ„Ğ¾Ñ€Ğ¼Ğ°Ñ‚Ğµ FullCalendar.
        
        Args:
            equipment_ids: Ğ¡Ğ¿Ğ¸ÑĞ¾Ğº ID Ğ¾Ğ±Ğ¾Ñ€ÑƒĞ´Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ
            start_date: Ğ”Ğ°Ñ‚Ğ° Ğ½Ğ°Ñ‡Ğ°Ğ»Ğ° Ğ¿ĞµÑ€Ğ¸Ğ¾Ğ´Ğ°
            end_date: Ğ”Ğ°Ñ‚Ğ° Ğ¾ĞºĞ¾Ğ½Ñ‡Ğ°Ğ½Ğ¸Ñ Ğ¿ĞµÑ€Ğ¸Ğ¾Ğ´Ğ°
            
        Returns:
            Ğ¡Ğ¿Ğ¸ÑĞ¾Ğº ÑĞ¾Ğ±Ñ‹Ñ‚Ğ¸Ğ¹ Ğ´Ğ»Ñ ĞºĞ°Ğ»ĞµĞ½Ğ´Ğ°Ñ€Ñ
        """
        events = []

        # 1. Ğ˜ÑĞ¿Ğ¾Ğ»ÑŒĞ·ÑƒĞµĞ¼ Ğ¸ÑĞ¿Ñ€Ğ°Ğ²Ğ»ĞµĞ½Ğ½Ñ‹Ğ¹ Ğ¼ĞµÑ‚Ğ¾Ğ´ Ğ¸Ğ· Ğ±Ğ°Ğ·Ğ¾Ğ²Ğ¾Ğ³Ğ¾ ĞºĞ»Ğ°ÑÑĞ° Ğ´Ğ»Ñ Ğ¿Ğ¾Ğ»ÑƒÑ‡ĞµĞ½Ğ¸Ñ Ğ°Ñ€ĞµĞ½Ğ´
        rentals = await self._get_overlapping_rentals(equipment_ids, start_date, end_date)
        for rental in rentals:
            for equipment in rental.equipment:
                # ĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑĞµĞ¼, Ñ‡Ñ‚Ğ¾ Ğ¾Ğ±Ğ¾Ñ€ÑƒĞ´Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ Ğ¸Ğ· Ğ°Ñ€ĞµĞ½Ğ´Ñ‹ ĞµÑÑ‚ÑŒ Ğ² Ğ½Ğ°ÑˆĞµĞ¼ Ğ·Ğ°Ğ¿Ñ€Ğ¾ÑĞµ
                if equipment.id in equipment_ids:
                    events.append({
                        "id": f"rental-{rental.id}-{equipment.id}",
                        "title": f"ĞÑ€ĞµĞ½Ğ´Ğ°: {equipment.name}",
                        "start": rental.start_date.strftime("%Y-%m-%d"),
                        "end": rental.end_date.strftime("%Y-%m-%d"),
                        "resourceId": equipment.id,
                        "status": "rented"
                    })
        
        # 2. Ğ˜ÑĞ¿Ğ¾Ğ»ÑŒĞ·ÑƒĞµĞ¼ Ğ¸ÑĞ¿Ñ€Ğ°Ğ²Ğ»ĞµĞ½Ğ½Ñ‹Ğ¹ Ğ¼ĞµÑ‚Ğ¾Ğ´ Ğ¸Ğ· Ğ±Ğ°Ğ·Ğ¾Ğ²Ğ¾Ğ³Ğ¾ ĞºĞ»Ğ°ÑÑĞ° Ğ´Ğ»Ñ Ğ¿Ğ¾Ğ»ÑƒÑ‡ĞµĞ½Ğ¸Ñ Ñ€ĞµĞ·ĞµÑ€Ğ²Ğ¾Ğ²
        reservations = await self._get_overlapping_reservations(equipment_ids, start_date, end_date)
        for reservation in reservations:
            # Ğ”Ğ¾Ğ¿Ğ¾Ğ»Ğ½Ğ¸Ñ‚ĞµĞ»ÑŒĞ½Ğ¾ Ğ·Ğ°Ğ³Ñ€ÑƒĞ¶Ğ°ĞµĞ¼ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ñ, ĞµÑĞ»Ğ¸ ÑÑ‚Ğ¾ Ğ½ĞµĞ¾Ğ±Ñ…Ğ¾Ğ´Ğ¸Ğ¼Ğ¾
            await self.db.refresh(reservation, attribute_names=['user'])
            for equipment in reservation.equipment:
                # ĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑĞµĞ¼, Ñ‡Ñ‚Ğ¾ Ğ¾Ğ±Ğ¾Ñ€ÑƒĞ´Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ Ğ¸Ğ· Ñ€ĞµĞ·ĞµÑ€Ğ²Ğ° ĞµÑÑ‚ÑŒ Ğ² Ğ½Ğ°ÑˆĞµĞ¼ Ğ·Ğ°Ğ¿Ñ€Ğ¾ÑĞµ
                if equipment.id in equipment_ids:
                    events.append({
                        "id": f"reservation-{reservation.id}-{equipment.id}",
                        "title": f"Ğ ĞµĞ·ĞµÑ€Ğ²: {reservation.user.full_name}",
                        "start": reservation.start_date.strftime("%Y-%m-%d"),
                        "end": reservation.end_date.strftime("%Y-%m-%d"),
                        "resourceId": equipment.id,
                        "status": "reserved"
                    })
        
        return events



```


## <a name="RentalAppFASTAPIapiservicesavailabilityconflictspy"></a>`RentalApp_FASTAPI/api/services/availability/conflicts.py`

```python
// path: RentalApp_FASTAPI/api/services/availability/conflicts.py

# api/services/availability/conflicts.py

from datetime import date
from typing import List, Dict, Any, Optional

from .base import AvailabilityBaseService


class AvailabilityConflictsService(AvailabilityBaseService):
    """
    Ğ¡ĞµÑ€Ğ²Ğ¸Ñ Ğ´Ğ»Ñ Ñ€Ğ°Ğ±Ğ¾Ñ‚Ñ‹ Ñ ĞºĞ¾Ğ½Ñ„Ğ»Ğ¸ĞºÑ‚Ğ°Ğ¼Ğ¸ Ğ´Ğ¾ÑÑ‚ÑƒĞ¿Ğ½Ğ¾ÑÑ‚Ğ¸ Ğ¾Ğ±Ğ¾Ñ€ÑƒĞ´Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ.
    ĞÑ‚Ğ²ĞµÑ‡Ğ°ĞµÑ‚ Ğ·Ğ° Ğ¿Ğ¾Ğ¸ÑĞº Ğ¸ Ğ°Ğ½Ğ°Ğ»Ğ¸Ğ· ĞºĞ¾Ğ½Ñ„Ğ»Ğ¸ĞºÑ‚Ğ¾Ğ² Ğ¼ĞµĞ¶Ğ´Ñƒ Ñ€ĞµĞ·ĞµÑ€Ğ²Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸ÑĞ¼Ğ¸ Ğ¸ Ğ°Ñ€ĞµĞ½Ğ´Ğ°Ğ¼Ğ¸.
    """

    async def get_conflicts(
        self,
        equipment_ids: List[int],
        start_date: date,
        end_date: date,
        exclude_reservation_id: Optional[int] = None,
        exclude_rental_id: Optional[int] = None
    ) -> Dict[int, List[Dict[str, Any]]]:
        """
        ĞÑĞ½Ğ¾Ğ²Ğ½Ğ¾Ğ¹ Ğ¼ĞµÑ‚Ğ¾Ğ´ Ğ´Ğ»Ñ Ğ¿Ğ¾Ğ»ÑƒÑ‡ĞµĞ½Ğ¸Ñ Ğ²ÑĞµÑ… ĞºĞ¾Ğ½Ñ„Ğ»Ğ¸ĞºÑ‚Ğ¾Ğ² Ğ´Ğ¾ÑÑ‚ÑƒĞ¿Ğ½Ğ¾ÑÑ‚Ğ¸ Ğ¾Ğ±Ğ¾Ñ€ÑƒĞ´Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ.
        
        Args:
            equipment_ids: Ğ¡Ğ¿Ğ¸ÑĞ¾Ğº ID Ğ¾Ğ±Ğ¾Ñ€ÑƒĞ´Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ Ğ´Ğ»Ñ Ğ¿Ñ€Ğ¾Ğ²ĞµÑ€ĞºĞ¸
            start_date: Ğ”Ğ°Ñ‚Ğ° Ğ½Ğ°Ñ‡Ğ°Ğ»Ğ° Ğ¿ĞµÑ€Ğ¸Ğ¾Ğ´Ğ°
            end_date: Ğ”Ğ°Ñ‚Ğ° Ğ¾ĞºĞ¾Ğ½Ñ‡Ğ°Ğ½Ğ¸Ñ Ğ¿ĞµÑ€Ğ¸Ğ¾Ğ´Ğ° (Ğ²ĞºĞ»ÑÑ‡Ğ¸Ñ‚ĞµĞ»ÑŒĞ½Ğ¾)
            exclude_reservation_id: ID Ñ€ĞµĞ·ĞµÑ€Ğ²Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ Ğ´Ğ»Ñ Ğ¸ÑĞºĞ»ÑÑ‡ĞµĞ½Ğ¸Ñ Ğ¸Ğ· Ğ¿Ñ€Ğ¾Ğ²ĞµÑ€ĞºĞ¸
            exclude_rental_id: ID Ğ°Ñ€ĞµĞ½Ğ´Ñ‹ Ğ´Ğ»Ñ Ğ¸ÑĞºĞ»ÑÑ‡ĞµĞ½Ğ¸Ñ Ğ¸Ğ· Ğ¿Ñ€Ğ¾Ğ²ĞµÑ€ĞºĞ¸
            
        Returns:
            Ğ¡Ğ»Ğ¾Ğ²Ğ°Ñ€ÑŒ, Ğ³Ğ´Ğµ ĞºĞ»ÑÑ‡ - ID Ğ¾Ğ±Ğ¾Ñ€ÑƒĞ´Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ, Ğ·Ğ½Ğ°Ñ‡ĞµĞ½Ğ¸Ğµ - ÑĞ¿Ğ¸ÑĞ¾Ğº ĞºĞ¾Ğ½Ñ„Ğ»Ğ¸ĞºÑ‚Ğ¾Ğ²
        """
        conflicts: Dict[int, List[Dict[str, Any]]] = {}
        
        # ĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑĞµĞ¼, Ñ‡Ñ‚Ğ¾ ÑĞ¿Ğ¸ÑĞ¾Ğº Ğ¾Ğ±Ğ¾Ñ€ÑƒĞ´Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ Ğ½Ğµ Ğ¿ÑƒÑÑ‚Ğ¾Ğ¹
        if not equipment_ids:
            return conflicts
        
        # ĞŸĞ¾Ğ»ÑƒÑ‡Ğ°ĞµĞ¼ Ğ¿ĞµÑ€ĞµÑĞµĞºĞ°ÑÑ‰Ğ¸ĞµÑÑ Ñ€ĞµĞ·ĞµÑ€Ğ²Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ
        overlapping_reservations = await self._get_overlapping_reservations(
            equipment_ids, start_date, end_date, exclude_reservation_id
        )
        
        # ĞŸĞ¾Ğ»ÑƒÑ‡Ğ°ĞµĞ¼ Ğ¿ĞµÑ€ĞµÑĞµĞºĞ°ÑÑ‰Ğ¸ĞµÑÑ Ğ°Ñ€ĞµĞ½Ğ´Ñ‹
        overlapping_rentals = await self._get_overlapping_rentals(
            equipment_ids, start_date, end_date, exclude_rental_id
        )
        
        # ĞĞ±Ñ€Ğ°Ğ±Ğ¾Ñ‚ĞºĞ° Ñ€ĞµĞ·ĞµÑ€Ğ²Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğ¹
        for reservation in overlapping_reservations:
            for equipment in reservation.equipment:
                if equipment.id in equipment_ids:
                    if equipment.id not in conflicts:
                        conflicts[equipment.id] = []
                    
                    conflict_dict = self._create_conflict_dict(
                        'reservation',
                        reservation.id,
                        reservation.start_date,
                        reservation.end_date,
                        reservation.user_id
                    )
                    conflicts[equipment.id].append(conflict_dict)
        
        # ĞĞ±Ñ€Ğ°Ğ±Ğ¾Ñ‚ĞºĞ° Ğ°Ñ€ĞµĞ½Ğ´
        for rental in overlapping_rentals:
            for equipment in rental.equipment:
                if equipment.id in equipment_ids:
                    if equipment.id not in conflicts:
                        conflicts[equipment.id] = []
                    
                    conflict_dict = self._create_conflict_dict(
                        'rental',
                        rental.id,
                        rental.start_date,
                        rental.end_date,
                        rental.user_id
                    )
                    conflicts[equipment.id].append(conflict_dict)
        
        return conflicts

    async def get_conflicting_equipment_ids(
        self,
        equipment_ids: List[int],
        start_date: date,
        end_date: date,
        exclude_reservation_id: Optional[int] = None,
        exclude_rental_id: Optional[int] = None
    ) -> List[int]:
        """
        Ğ’Ğ¾Ğ·Ğ²Ñ€Ğ°Ñ‰Ğ°ĞµÑ‚ ÑĞ¿Ğ¸ÑĞ¾Ğº ID Ğ¾Ğ±Ğ¾Ñ€ÑƒĞ´Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ, Ñƒ ĞºĞ¾Ñ‚Ğ¾Ñ€Ğ¾Ğ³Ğ¾ ĞµÑÑ‚ÑŒ ĞºĞ¾Ğ½Ñ„Ğ»Ğ¸ĞºÑ‚Ñ‹ Ğ´Ğ¾ÑÑ‚ÑƒĞ¿Ğ½Ğ¾ÑÑ‚Ğ¸.
        
        Args:
            equipment_ids: Ğ¡Ğ¿Ğ¸ÑĞ¾Ğº ID Ğ¾Ğ±Ğ¾Ñ€ÑƒĞ´Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ Ğ´Ğ»Ñ Ğ¿Ñ€Ğ¾Ğ²ĞµÑ€ĞºĞ¸
            start_date: Ğ”Ğ°Ñ‚Ğ° Ğ½Ğ°Ñ‡Ğ°Ğ»Ğ° Ğ¿ĞµÑ€Ğ¸Ğ¾Ğ´Ğ°
            end_date: Ğ”Ğ°Ñ‚Ğ° Ğ¾ĞºĞ¾Ğ½Ñ‡Ğ°Ğ½Ğ¸Ñ Ğ¿ĞµÑ€Ğ¸Ğ¾Ğ´Ğ°
            exclude_reservation_id: ID Ñ€ĞµĞ·ĞµÑ€Ğ²Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ Ğ´Ğ»Ñ Ğ¸ÑĞºĞ»ÑÑ‡ĞµĞ½Ğ¸Ñ
            exclude_rental_id: ID Ğ°Ñ€ĞµĞ½Ğ´Ñ‹ Ğ´Ğ»Ñ Ğ¸ÑĞºĞ»ÑÑ‡ĞµĞ½Ğ¸Ñ
            
        Returns:
            Ğ¡Ğ¿Ğ¸ÑĞ¾Ğº ID Ğ¾Ğ±Ğ¾Ñ€ÑƒĞ´Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ Ñ ĞºĞ¾Ğ½Ñ„Ğ»Ğ¸ĞºÑ‚Ğ°Ğ¼Ğ¸
        """
        conflicts = await self.get_conflicts(
            equipment_ids, start_date, end_date, exclude_reservation_id, exclude_rental_id
        )
        return list(conflicts.keys())

    def _get_most_critical_conflict(
        self,
        conflict_list: List[Dict[str, Any]]
    ) -> Optional[Dict[str, Any]]:
        """
        Ğ’Ğ¾Ğ·Ğ²Ñ€Ğ°Ñ‰Ğ°ĞµÑ‚ Ğ½Ğ°Ğ¸Ğ±Ğ¾Ğ»ĞµĞµ ĞºÑ€Ğ¸Ñ‚Ğ¸Ñ‡Ğ½Ñ‹Ğ¹ ĞºĞ¾Ğ½Ñ„Ğ»Ğ¸ĞºÑ‚ Ğ¸Ğ· ÑĞ¿Ğ¸ÑĞºĞ°.
        ĞŸÑ€Ğ¸Ğ¾Ñ€Ğ¸Ñ‚ĞµÑ‚: rental > reservation.
        
        Args:
            conflict_list: Ğ¡Ğ¿Ğ¸ÑĞ¾Ğº ĞºĞ¾Ğ½Ñ„Ğ»Ğ¸ĞºÑ‚Ğ¾Ğ²
            
        Returns:
            ĞĞ°Ğ¸Ğ±Ğ¾Ğ»ĞµĞµ ĞºÑ€Ğ¸Ñ‚Ğ¸Ñ‡Ğ½Ñ‹Ğ¹ ĞºĞ¾Ğ½Ñ„Ğ»Ğ¸ĞºÑ‚ Ğ¸Ğ»Ğ¸ None
        """
        if not conflict_list:
            return None
        
        # Ğ¡Ğ¾Ñ€Ñ‚Ğ¸Ñ€ÑƒĞµĞ¼ ĞºĞ¾Ğ½Ñ„Ğ»Ğ¸ĞºÑ‚Ñ‹ Ğ¿Ğ¾ Ğ¿Ñ€Ğ¸Ğ¾Ñ€Ğ¸Ñ‚ĞµÑ‚Ñƒ: rental > reservation
        sorted_conflicts = sorted(
            conflict_list, 
            key=lambda c: (c['type'] != 'rental', c['type'] != 'reservation')
        )
        return sorted_conflicts[0]


```


## <a name="RentalAppFASTAPIapiservicesavailabilityqueriespy"></a>`RentalApp_FASTAPI/api/services/availability/queries.py`

```python
// path: RentalApp_FASTAPI/api/services/availability/queries.py

# api/services/availability/queries.py

from sqlalchemy import select, and_
from datetime import date
from typing import Optional

from .base import AvailabilityBaseService
from api.models.equipment import Equipment
from api.models.reservation import Reservation
from api.models.rental import Rental


class AvailabilityQueryService(AvailabilityBaseService):
    """
    Ğ¡ĞµÑ€Ğ²Ğ¸Ñ Ğ´Ğ»Ñ Ñ€Ğ°Ğ±Ğ¾Ñ‚Ñ‹ Ñ SQL-Ğ·Ğ°Ğ¿Ñ€Ğ¾ÑĞ°Ğ¼Ğ¸ Ğ¸ Ñ„Ğ¸Ğ»ÑŒÑ‚Ñ€Ğ°Ğ¼Ğ¸.
    ĞÑ‚Ğ²ĞµÑ‡Ğ°ĞµÑ‚ Ğ·Ğ° ÑĞ¾Ğ·Ğ´Ğ°Ğ½Ğ¸Ğµ Ğ¾Ğ¿Ñ‚Ğ¸Ğ¼Ğ¸Ğ·Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ½Ñ‹Ñ… SQL-Ğ·Ğ°Ğ¿Ñ€Ğ¾ÑĞ¾Ğ² Ğ´Ğ»Ñ Ğ¿Ñ€Ğ¾Ğ²ĞµÑ€ĞºĞ¸ Ğ´Ğ¾ÑÑ‚ÑƒĞ¿Ğ½Ğ¾ÑÑ‚Ğ¸.
    """

    def get_sqlalchemy_filter_for_available_equipment(
        self,
        start_date: date,
        end_date: date,
        exclude_reservation_id: Optional[int] = None,
        exclude_rental_id: Optional[int] = None
    ):
        """
        Ğ’Ğ¾Ğ·Ğ²Ñ€Ğ°Ñ‰Ğ°ĞµÑ‚ SQLAlchemy Ñ„Ğ¸Ğ»ÑŒÑ‚Ñ€ Ğ´Ğ»Ñ Ğ¸ÑĞºĞ»ÑÑ‡ĞµĞ½Ğ¸Ñ Ğ½ĞµĞ´Ğ¾ÑÑ‚ÑƒĞ¿Ğ½Ğ¾Ğ³Ğ¾ Ğ¾Ğ±Ğ¾Ñ€ÑƒĞ´Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ.
        Ğ˜ÑĞ¿Ğ¾Ğ»ÑŒĞ·ÑƒĞµÑ‚ÑÑ Ğ´Ğ»Ñ Ğ¾Ğ¿Ñ‚Ğ¸Ğ¼Ğ¸Ğ·Ğ°Ñ†Ğ¸Ğ¸ Ğ·Ğ°Ğ¿Ñ€Ğ¾ÑĞ¾Ğ² Ğ² EquipmentQueryBuilder.
        
        Args:
            start_date: Ğ”Ğ°Ñ‚Ğ° Ğ½Ğ°Ñ‡Ğ°Ğ»Ğ° Ğ¿ĞµÑ€Ğ¸Ğ¾Ğ´Ğ°
            end_date: Ğ”Ğ°Ñ‚Ğ° Ğ¾ĞºĞ¾Ğ½Ñ‡Ğ°Ğ½Ğ¸Ñ Ğ¿ĞµÑ€Ğ¸Ğ¾Ğ´Ğ°
            exclude_reservation_id: ID Ñ€ĞµĞ·ĞµÑ€Ğ²Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ Ğ´Ğ»Ñ Ğ¸ÑĞºĞ»ÑÑ‡ĞµĞ½Ğ¸Ñ
            exclude_rental_id: ID Ğ°Ñ€ĞµĞ½Ğ´Ñ‹ Ğ´Ğ»Ñ Ğ¸ÑĞºĞ»ÑÑ‡ĞµĞ½Ğ¸Ñ
            
        Returns:
            SQLAlchemy BinaryExpression Ğ´Ğ»Ñ Ñ„Ğ¸Ğ»ÑŒÑ‚Ñ€Ğ°Ñ†Ğ¸Ğ¸
        """
        from api.models.reservation import reservation_equipment_association
        from api.models.rental import rental_equipment_association
        
        # ĞŸĞ¾Ğ´Ğ·Ğ°Ğ¿Ñ€Ğ¾Ñ Ğ´Ğ»Ñ ID Ğ¾Ğ±Ğ¾Ñ€ÑƒĞ´Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ, Ğ·Ğ°Ğ½ÑÑ‚Ğ¾Ğ³Ğ¾ Ğ² Ğ°ĞºÑ‚Ğ¸Ğ²Ğ½Ñ‹Ñ… Ñ€ĞµĞ·ĞµÑ€Ğ²Ğ°Ñ…
        booked_in_reservations_subquery = self._create_reservations_subquery(
            start_date, end_date, exclude_reservation_id
        )
        
        # ĞŸĞ¾Ğ´Ğ·Ğ°Ğ¿Ñ€Ğ¾Ñ Ğ´Ğ»Ñ ID Ğ¾Ğ±Ğ¾Ñ€ÑƒĞ´Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ, Ğ·Ğ°Ğ½ÑÑ‚Ğ¾Ğ³Ğ¾ Ğ² Ğ°ĞºÑ‚Ğ¸Ğ²Ğ½Ñ‹Ñ…/Ğ¿Ñ€Ğ¾ÑÑ€Ğ¾Ñ‡ĞµĞ½Ğ½Ñ‹Ñ… Ğ°Ñ€ĞµĞ½Ğ´Ğ°Ñ…
        booked_in_rentals_subquery = self._create_rentals_subquery(
            start_date, end_date, exclude_rental_id
        )
        
        # Ğ’Ğ¾Ğ·Ğ²Ñ€Ğ°Ñ‰Ğ°ĞµĞ¼ ÑƒÑĞ»Ğ¾Ğ²Ğ¸Ğµ Ğ´Ğ»Ñ Ğ¸ÑĞºĞ»ÑÑ‡ĞµĞ½Ğ¸Ñ Ğ½ĞµĞ´Ğ¾ÑÑ‚ÑƒĞ¿Ğ½Ğ¾Ğ³Ğ¾ Ğ¾Ğ±Ğ¾Ñ€ÑƒĞ´Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ
        return and_(
            Equipment.id.notin_(booked_in_reservations_subquery),
            Equipment.id.notin_(booked_in_rentals_subquery)
        )

    def _create_reservations_subquery(
        self,
        start_date: date,
        end_date: date,
        exclude_reservation_id: Optional[int] = None
    ):
        """
        Ğ¡Ğ¾Ğ·Ğ´Ğ°ĞµÑ‚ Ğ¿Ğ¾Ğ´Ğ·Ğ°Ğ¿Ñ€Ğ¾Ñ Ğ´Ğ»Ñ Ñ€ĞµĞ·ĞµÑ€Ğ²Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğ¹.
        
        Args:
            start_date: Ğ”Ğ°Ñ‚Ğ° Ğ½Ğ°Ñ‡Ğ°Ğ»Ğ° Ğ¿ĞµÑ€Ğ¸Ğ¾Ğ´Ğ°
            end_date: Ğ”Ğ°Ñ‚Ğ° Ğ¾ĞºĞ¾Ğ½Ñ‡Ğ°Ğ½Ğ¸Ñ Ğ¿ĞµÑ€Ğ¸Ğ¾Ğ´Ğ°
            exclude_reservation_id: ID Ñ€ĞµĞ·ĞµÑ€Ğ²Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ Ğ´Ğ»Ñ Ğ¸ÑĞºĞ»ÑÑ‡ĞµĞ½Ğ¸Ñ
            
        Returns:
            ĞŸĞ¾Ğ´Ğ·Ğ°Ğ¿Ñ€Ğ¾Ñ Ğ´Ğ»Ñ Ñ€ĞµĞ·ĞµÑ€Ğ²Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğ¹
        """
        from api.models.reservation import reservation_equipment_association
        
        subquery = (
            select(reservation_equipment_association.c.equipment_id)
            .join(Reservation, reservation_equipment_association.c.reservation_id == Reservation.id)
            .filter(
                Reservation.end_date > start_date,
                Reservation.start_date < end_date,
                Reservation.status == 'active'
            )
        )
        
        if exclude_reservation_id:
            subquery = subquery.filter(Reservation.id != exclude_reservation_id)
        
        return subquery.distinct()

    def _create_rentals_subquery(
        self,
        start_date: date,
        end_date: date,
        exclude_rental_id: Optional[int] = None
    ):
        """
        Ğ¡Ğ¾Ğ·Ğ´Ğ°ĞµÑ‚ Ğ¿Ğ¾Ğ´Ğ·Ğ°Ğ¿Ñ€Ğ¾Ñ Ğ´Ğ»Ñ Ğ°Ñ€ĞµĞ½Ğ´.
        
        Args:
            start_date: Ğ”Ğ°Ñ‚Ğ° Ğ½Ğ°Ñ‡Ğ°Ğ»Ğ° Ğ¿ĞµÑ€Ğ¸Ğ¾Ğ´Ğ°
            end_date: Ğ”Ğ°Ñ‚Ğ° Ğ¾ĞºĞ¾Ğ½Ñ‡Ğ°Ğ½Ğ¸Ñ Ğ¿ĞµÑ€Ğ¸Ğ¾Ğ´Ğ°
            exclude_rental_id: ID Ğ°Ñ€ĞµĞ½Ğ´Ñ‹ Ğ´Ğ»Ñ Ğ¸ÑĞºĞ»ÑÑ‡ĞµĞ½Ğ¸Ñ
            
        Returns:
            ĞŸĞ¾Ğ´Ğ·Ğ°Ğ¿Ñ€Ğ¾Ñ Ğ´Ğ»Ñ Ğ°Ñ€ĞµĞ½Ğ´
        """
        from api.models.rental import rental_equipment_association
        
        subquery = (
            select(rental_equipment_association.c.equipment_id)
            .join(Rental, rental_equipment_association.c.rental_id == Rental.id)
            .filter(
                Rental.end_date > start_date,
                Rental.start_date < end_date,
                Rental.status.in_(['active', 'overdue'])
            )
        )
        
        if exclude_rental_id:
            subquery = subquery.filter(Rental.id != exclude_rental_id)
        
        return subquery.distinct()


```


## <a name="RentalAppFASTAPIapiservicesavailabilitystatusespy"></a>`RentalApp_FASTAPI/api/services/availability/statuses.py`

```python
// path: RentalApp_FASTAPI/api/services/availability/statuses.py

# api/services/availability/statuses.py

from datetime import date, timedelta
from typing import List, Dict, Any, Optional

from .conflicts import AvailabilityConflictsService
from shared.schemas.calendar_schema import DayStatusItem


class AvailabilityStatusService(AvailabilityConflictsService):
    """
    Ğ¡ĞµÑ€Ğ²Ğ¸Ñ Ğ´Ğ»Ñ Ñ€Ğ°Ğ±Ğ¾Ñ‚Ñ‹ ÑĞ¾ ÑÑ‚Ğ°Ñ‚ÑƒÑĞ°Ğ¼Ğ¸ Ğ´Ğ¾ÑÑ‚ÑƒĞ¿Ğ½Ğ¾ÑÑ‚Ğ¸ Ğ¾Ğ±Ğ¾Ñ€ÑƒĞ´Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ.
    ĞÑ‚Ğ²ĞµÑ‡Ğ°ĞµÑ‚ Ğ·Ğ° Ğ¾Ğ¿Ñ€ĞµĞ´ĞµĞ»ĞµĞ½Ğ¸Ğµ Ğ¸ Ñ„Ğ¾Ñ€Ğ¼Ğ°Ñ‚Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ ÑÑ‚Ğ°Ñ‚ÑƒÑĞ¾Ğ² Ğ¾Ğ±Ğ¾Ñ€ÑƒĞ´Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ.
    """

    async def get_availability_statuses(
        self,
        equipment_ids: List[int],
        start_date: date,
        end_date: date,
        exclude_reservation_id: Optional[int] = None,
        exclude_rental_id: Optional[int] = None
    ) -> Dict[int, Dict[str, Any]]:
        """
        Ğ’Ğ¾Ğ·Ğ²Ñ€Ğ°Ñ‰Ğ°ĞµÑ‚ ÑÑ‚Ğ°Ñ‚ÑƒÑÑ‹ Ğ´Ğ¾ÑÑ‚ÑƒĞ¿Ğ½Ğ¾ÑÑ‚Ğ¸ Ğ´Ğ»Ñ ÑĞ¿Ğ¸ÑĞºĞ° Ğ¾Ğ±Ğ¾Ñ€ÑƒĞ´Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ.
        
        Args:
            equipment_ids: Ğ¡Ğ¿Ğ¸ÑĞ¾Ğº ID Ğ¾Ğ±Ğ¾Ñ€ÑƒĞ´Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ Ğ´Ğ»Ñ Ğ¿Ñ€Ğ¾Ğ²ĞµÑ€ĞºĞ¸
            start_date: Ğ”Ğ°Ñ‚Ğ° Ğ½Ğ°Ñ‡Ğ°Ğ»Ğ° Ğ¿ĞµÑ€Ğ¸Ğ¾Ğ´Ğ°
            end_date: Ğ”Ğ°Ñ‚Ğ° Ğ¾ĞºĞ¾Ğ½Ñ‡Ğ°Ğ½Ğ¸Ñ Ğ¿ĞµÑ€Ğ¸Ğ¾Ğ´Ğ°
            exclude_reservation_id: ID Ñ€ĞµĞ·ĞµÑ€Ğ²Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ Ğ´Ğ»Ñ Ğ¸ÑĞºĞ»ÑÑ‡ĞµĞ½Ğ¸Ñ
            exclude_rental_id: ID Ğ°Ñ€ĞµĞ½Ğ´Ñ‹ Ğ´Ğ»Ñ Ğ¸ÑĞºĞ»ÑÑ‡ĞµĞ½Ğ¸Ñ
            
        Returns:
            Ğ¡Ğ»Ğ¾Ğ²Ğ°Ñ€ÑŒ ÑĞ¾ ÑÑ‚Ğ°Ñ‚ÑƒÑĞ°Ğ¼Ğ¸ Ğ¾Ğ±Ğ¾Ñ€ÑƒĞ´Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ
        """
        statuses: Dict[int, Dict[str, Any]] = {
            eq_id: {"status": "available", "details": "Ğ”Ğ¾ÑÑ‚ÑƒĞ¿Ğ½Ğ¾"}
            for eq_id in equipment_ids
        }
        
        conflicts = await self.get_conflicts(
            equipment_ids, start_date, end_date, exclude_reservation_id, exclude_rental_id
        )
        
        for eq_id, conflict_list in conflicts.items():
            if not conflict_list:
                continue
            
            most_critical = self._get_most_critical_conflict(conflict_list)
            if most_critical:
                statuses[eq_id] = self._format_status_from_conflict(most_critical)
        
        return statuses

    async def get_daily_statuses(
        self,
        equipment_ids: List[int],
        start_date: date,
        end_date: date,
        exclude_reservation_id: Optional[int] = None,
        exclude_rental_id: Optional[int] = None,
        current_user_id: Optional[int] = None
    ) -> Dict[int, Dict[str, DayStatusItem]]:
        """
        Ğ’Ğ¾Ğ·Ğ²Ñ€Ğ°Ñ‰Ğ°ĞµÑ‚ ÑÑ‚Ğ°Ñ‚ÑƒÑÑ‹ Ğ¾Ğ±Ğ¾Ñ€ÑƒĞ´Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ Ğ¿Ğ¾ Ğ´Ğ½ÑĞ¼ Ğ´Ğ»Ñ ĞºĞ°Ğ»ĞµĞ½Ğ´Ğ°Ñ€Ğ½Ğ¾Ğ³Ğ¾ Ğ¿Ñ€ĞµĞ´ÑÑ‚Ğ°Ğ²Ğ»ĞµĞ½Ğ¸Ñ.
        
        Args:
            equipment_ids: Ğ¡Ğ¿Ğ¸ÑĞ¾Ğº ID Ğ¾Ğ±Ğ¾Ñ€ÑƒĞ´Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ Ğ´Ğ»Ñ Ğ¿Ñ€Ğ¾Ğ²ĞµÑ€ĞºĞ¸
            start_date: Ğ”Ğ°Ñ‚Ğ° Ğ½Ğ°Ñ‡Ğ°Ğ»Ğ° Ğ¿ĞµÑ€Ğ¸Ğ¾Ğ´Ğ°
            end_date: Ğ”Ğ°Ñ‚Ğ° Ğ¾ĞºĞ¾Ğ½Ñ‡Ğ°Ğ½Ğ¸Ñ Ğ¿ĞµÑ€Ğ¸Ğ¾Ğ´Ğ°
            exclude_reservation_id: ID Ñ€ĞµĞ·ĞµÑ€Ğ²Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ Ğ´Ğ»Ñ Ğ¸ÑĞºĞ»ÑÑ‡ĞµĞ½Ğ¸Ñ
            exclude_rental_id: ID Ğ°Ñ€ĞµĞ½Ğ´Ñ‹ Ğ´Ğ»Ñ Ğ¸ÑĞºĞ»ÑÑ‡ĞµĞ½Ğ¸Ñ
            current_user_id: ID Ñ‚ĞµĞºÑƒÑ‰ĞµĞ³Ğ¾ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ñ Ğ´Ğ»Ñ Ğ²Ñ‹Ğ´ĞµĞ»ĞµĞ½Ğ¸Ñ ĞµĞ³Ğ¾ Ñ€ĞµĞ·ĞµÑ€Ğ²Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğ¹
            
        Returns:
            Ğ¡Ğ»Ğ¾Ğ²Ğ°Ñ€ÑŒ ÑĞ¾ ÑÑ‚Ğ°Ñ‚ÑƒÑĞ°Ğ¼Ğ¸ Ğ¿Ğ¾ Ğ´Ğ½ÑĞ¼
        """
        num_days = (end_date - start_date).days + 1
        all_dates = [start_date + timedelta(days=i) for i in range(num_days)]
        
        result: Dict[int, Dict[str, DayStatusItem]] = {
            eq_id: {
                day.strftime('%d.%m.%Y'): DayStatusItem(status="available")
                for day in all_dates
            }
            for eq_id in equipment_ids
        }
        
        conflicts = await self.get_conflicts(
            equipment_ids, start_date, end_date, exclude_reservation_id, exclude_rental_id
        )
        
        for eq_id, conflict_list in conflicts.items():
            if eq_id not in result:
                continue
                
            for conflict in conflict_list:
                self._apply_conflict_to_daily_statuses(
                    result[eq_id], conflict, start_date, end_date, current_user_id
                )
        
        return result

    def _format_status_from_conflict(self, conflict: Dict[str, Any]) -> Dict[str, Any]:
        """
        Ğ¤Ğ¾Ñ€Ğ¼Ğ°Ñ‚Ğ¸Ñ€ÑƒĞµÑ‚ ÑÑ‚Ğ°Ñ‚ÑƒÑ Ğ½Ğ° Ğ¾ÑĞ½Ğ¾Ğ²Ğµ ĞºĞ¾Ğ½Ñ„Ğ»Ğ¸ĞºÑ‚Ğ°.
        
        Args:
            conflict: Ğ¡Ğ»Ğ¾Ğ²Ğ°Ñ€ÑŒ Ñ Ğ¸Ğ½Ñ„Ğ¾Ñ€Ğ¼Ğ°Ñ†Ğ¸ĞµĞ¹ Ğ¾ ĞºĞ¾Ğ½Ñ„Ğ»Ğ¸ĞºÑ‚Ğµ
            
        Returns:
            ĞÑ‚Ñ„Ğ¾Ñ€Ğ¼Ğ°Ñ‚Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ½Ñ‹Ğ¹ ÑÑ‚Ğ°Ñ‚ÑƒÑ
        """
        if conflict['type'] == 'rental':
            return {
                "status": "rented",
                "details": f"Ğ’ Ğ°Ñ€ĞµĞ½Ğ´Ğµ Ğ´Ğ¾ {conflict['end_date'].strftime('%d.%m.%Y')}",
                "start_date": conflict['start_date'],
                "end_date": conflict['end_date']
            }
        elif conflict['type'] == 'reservation':
            return {
                "status": "reserved",
                "details": f"Ğ—Ğ°Ñ€ĞµĞ·ĞµÑ€Ğ²Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¾ Ğ´Ğ¾ {conflict['end_date'].strftime('%d.%m.%Y')}",
                "start_date": conflict['start_date'],
                "end_date": conflict['end_date']
            }
        
        return {"status": "available", "details": "Ğ”Ğ¾ÑÑ‚ÑƒĞ¿Ğ½Ğ¾"}

    def _apply_conflict_to_daily_statuses(
        self,
        daily_statuses: Dict[str, DayStatusItem],
        conflict: Dict[str, Any],
        start_date: date,
        end_date: date,
        current_user_id: Optional[int]
    ) -> None:
        """
        ĞŸÑ€Ğ¸Ğ¼ĞµĞ½ÑĞµÑ‚ ĞºĞ¾Ğ½Ñ„Ğ»Ğ¸ĞºÑ‚ Ğº ÑÑ‚Ğ°Ñ‚ÑƒÑĞ°Ğ¼ Ğ¿Ğ¾ Ğ´Ğ½ÑĞ¼.
        
        Args:
            daily_statuses: Ğ¡Ğ»Ğ¾Ğ²Ğ°Ñ€ÑŒ ÑĞ¾ ÑÑ‚Ğ°Ñ‚ÑƒÑĞ°Ğ¼Ğ¸ Ğ¿Ğ¾ Ğ´Ğ½ÑĞ¼
            conflict: Ğ˜Ğ½Ñ„Ğ¾Ñ€Ğ¼Ğ°Ñ†Ğ¸Ñ Ğ¾ ĞºĞ¾Ğ½Ñ„Ğ»Ğ¸ĞºÑ‚Ğµ
            start_date: ĞĞ°Ñ‡Ğ°Ğ»ÑŒĞ½Ğ°Ñ Ğ´Ğ°Ñ‚Ğ° Ğ¿ĞµÑ€Ğ¸Ğ¾Ğ´Ğ°
            end_date: ĞšĞ¾Ğ½ĞµÑ‡Ğ½Ğ°Ñ Ğ´Ğ°Ñ‚Ğ° Ğ¿ĞµÑ€Ğ¸Ğ¾Ğ´Ğ°
            current_user_id: ID Ñ‚ĞµĞºÑƒÑ‰ĞµĞ³Ğ¾ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ñ
        """
        current_day = conflict['start_date']
        while current_day < conflict['end_date']:
            if start_date <= current_day <= end_date:
                day_str = current_day.strftime('%d.%m.%Y')
                if daily_statuses[day_str].status != 'rented':
                    is_user_event = (
                        current_user_id is not None and 
                        conflict.get('user_id') == current_user_id and
                        conflict['type'] == 'reservation'
                    )
                    
                    # Ğ¡Ğ¾Ğ·Ğ´Ğ°ĞµĞ¼ Ğ¼Ğ°Ğ¿Ğ¿Ğ¸Ğ½Ğ³ Ğ´Ğ»Ñ ĞºĞ¾Ñ€Ñ€ĞµĞºÑ‚Ğ½Ğ¾Ğ³Ğ¾ Ğ¿Ñ€ĞµĞ¾Ğ±Ñ€Ğ°Ğ·Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ ÑÑ‚Ğ°Ñ‚ÑƒÑĞ¾Ğ²
                    status_map = {
                        "reservation": "reserved",
                        "rental": "rented"
                    }
                    correct_status = status_map.get(conflict['type'], "available")
                    
                    daily_statuses[day_str] = DayStatusItem(
                        status=correct_status,
                        group_id=f"{conflict['type']}-{conflict['id']}",
                        is_user_reservation=is_user_event
                    )
            current_day += timedelta(days=1)


```


## <a name="RentalAppFASTAPIapiservicesbalanceservicepy"></a>`RentalApp_FASTAPI/api/services/balance_service.py`

```python
// path: RentalApp_FASTAPI/api/services/balance_service.py

# api/services/balance_service.py

from sqlalchemy.ext.asyncio import AsyncSession
from sqlalchemy import select
from fastapi import HTTPException, status
import logging

from api.models.user import User
from api.models.balance_history import BalanceHistory
from api.models.rental import Rental

logger = logging.getLogger(__name__)

class BalanceService:
    def __init__(self, db: AsyncSession):
        self.db = db

    async def add_transaction(
            self,
            user_id: int,
            amount: float,
            operation_type: str,
            description: str,
            rental_id: int | None = None
    ) -> BalanceHistory:
        """
        Ğ”Ğ¾Ğ±Ğ°Ğ²Ğ»ÑĞµÑ‚ Ñ‚Ñ€Ğ°Ğ½Ğ·Ğ°ĞºÑ†Ğ¸Ñ Ğ² ÑĞµÑÑĞ¸Ñ, ÑĞ¾Ğ·Ğ´Ğ°Ğ²Ğ°Ñ Ğ·Ğ°Ğ¿Ğ¸ÑÑŒ Ğ² Ğ¸ÑÑ‚Ğ¾Ñ€Ğ¸Ğ¸ Ğ¸ Ğ¾Ğ±Ğ½Ğ¾Ğ²Ğ»ÑÑ Ğ±Ğ°Ğ»Ğ°Ğ½Ñ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ñ.
        Amount: Ğ¿Ğ¾Ğ»Ğ¾Ğ¶Ğ¸Ñ‚ĞµĞ»ÑŒĞ½Ğ¾Ğµ Ñ‡Ğ¸ÑĞ»Ğ¾ Ğ´Ğ»Ñ Ğ½Ğ°Ñ‡Ğ¸ÑĞ»ĞµĞ½Ğ¸Ñ, Ğ¾Ñ‚Ñ€Ğ¸Ñ†Ğ°Ñ‚ĞµĞ»ÑŒĞ½Ğ¾Ğµ Ğ´Ğ»Ñ ÑĞ¿Ğ¸ÑĞ°Ğ½Ğ¸Ñ.
        Ğ£Ğ¿Ñ€Ğ°Ğ²Ğ»ĞµĞ½Ğ¸Ğµ Ñ‚Ñ€Ğ°Ğ½Ğ·Ğ°ĞºÑ†Ğ¸ĞµĞ¹ (commit/rollback) Ğ¾ÑÑ‚Ğ°ĞµÑ‚ÑÑ Ğ·Ğ° Ğ²Ñ‹Ğ·Ñ‹Ğ²Ğ°ÑÑ‰Ğ¸Ğ¼ ÑĞµÑ€Ğ²Ğ¸ÑĞ¾Ğ¼.
        """
        # Ğ˜ÑĞ¿Ğ¾Ğ»ÑŒĞ·ÑƒĞµĞ¼ with_for_update() Ğ´Ğ»Ñ Ğ±Ğ»Ğ¾ĞºĞ¸Ñ€Ğ¾Ğ²ĞºĞ¸ ÑÑ‚Ñ€Ğ¾ĞºĞ¸ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ñ Ğ½Ğ° Ğ²Ñ€ĞµĞ¼Ñ Ñ‚Ñ€Ğ°Ğ½Ğ·Ğ°ĞºÑ†Ğ¸Ğ¸,
        # Ñ‡Ñ‚Ğ¾Ğ±Ñ‹ Ğ¸Ğ·Ğ±ĞµĞ¶Ğ°Ñ‚ÑŒ race conditions Ğ¿Ñ€Ğ¸ Ğ¾Ğ´Ğ½Ğ¾Ğ²Ñ€ĞµĞ¼ĞµĞ½Ğ½Ñ‹Ñ… Ğ¾Ğ¿ĞµÑ€Ğ°Ñ†Ğ¸ÑÑ….
        result = await self.db.execute(select(User).filter(User.id == user_id).with_for_update())
        user = result.scalars().first()
        if not user:
            logger.error(f"ĞŸĞ¾Ğ¿Ñ‹Ñ‚ĞºĞ° Ğ¿Ñ€Ğ¾Ğ²ĞµÑÑ‚Ğ¸ Ñ‚Ñ€Ğ°Ğ½Ğ·Ğ°ĞºÑ†Ğ¸Ñ Ğ´Ğ»Ñ Ğ½ĞµÑÑƒÑ‰ĞµÑÑ‚Ğ²ÑƒÑÑ‰ĞµĞ³Ğ¾ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ñ ID={user_id}")
            raise HTTPException(status_code=status.HTTP_404_NOT_FOUND, detail="ĞŸĞ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ÑŒ Ğ½Ğµ Ğ½Ğ°Ğ¹Ğ´ĞµĞ½.")

        # 1. Ğ¡Ğ¾Ğ·Ğ´Ğ°ĞµĞ¼ Ğ·Ğ°Ğ¿Ğ¸ÑÑŒ Ğ² Ğ¸ÑÑ‚Ğ¾Ñ€Ğ¸Ğ¸
        new_history_entry = BalanceHistory(
            user_id=user_id,
            amount=amount,
            operation_type=operation_type,
            description=description,
            rental_id=rental_id
        )
        self.db.add(new_history_entry)

        # 2. ĞÑ‚Ğ¾Ğ¼Ğ°Ñ€Ğ½Ğ¾ Ğ¾Ğ±Ğ½Ğ¾Ğ²Ğ»ÑĞµĞ¼ ĞºÑÑˆĞ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ½Ğ¾Ğµ Ğ·Ğ½Ğ°Ñ‡ĞµĞ½Ğ¸Ğµ Ğ±Ğ°Ğ»Ğ°Ğ½ÑĞ°
        user.balance += amount

        logger.info(f"Ğ¢Ñ€Ğ°Ğ½Ğ·Ğ°ĞºÑ†Ğ¸Ñ Ğ´Ğ»Ñ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ñ ID={user_id} Ğ½Ğ° ÑÑƒĞ¼Ğ¼Ñƒ {amount} ({operation_type}) Ğ´Ğ¾Ğ±Ğ°Ğ²Ğ»ĞµĞ½Ğ° Ğ² ÑĞµÑÑĞ¸Ñ. ĞĞ¾Ğ²Ñ‹Ğ¹ Ğ±Ğ°Ğ»Ğ°Ğ½Ñ: {user.balance}")
        return new_history_entry

    async def get_balance_for_user(self, user_id: int) -> float:
        """Ğ’Ğ¾Ğ·Ğ²Ñ€Ğ°Ñ‰Ğ°ĞµÑ‚ Ñ‚ĞµĞºÑƒÑ‰Ğ¸Ğ¹ Ğ±Ğ°Ğ»Ğ°Ğ½Ñ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ñ."""
        result = await self.db.execute(select(User).filter(User.id == user_id))
        user = result.scalars().first()
        if not user:
            raise HTTPException(status_code=status.HTTP_404_NOT_FOUND, detail="ĞŸĞ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ÑŒ Ğ½Ğµ Ğ½Ğ°Ğ¹Ğ´ĞµĞ½.")
        return user.balance

```


## <a name="RentalAppFASTAPIapiservicesdashboardREADMEmd"></a>`RentalApp_FASTAPI/api/services/dashboard/README.md`

```markdown
// path: RentalApp_FASTAPI/api/services/dashboard/README.md

# Dashboard Services - Ğ ĞµÑ„Ğ°ĞºÑ‚Ğ¾Ñ€Ğ¸Ğ½Ğ³

## ĞĞ±Ğ·Ğ¾Ñ€

Ğ¤Ğ°Ğ¹Ğ» `dashboard_service.py` Ğ±Ñ‹Ğ» Ñ€Ğ°Ğ·Ğ´ĞµĞ»ĞµĞ½ Ğ½Ğ° Ğ»Ğ¾Ğ³Ğ¸Ñ‡ĞµÑĞºĞ¸ ÑĞ²ÑĞ·Ğ°Ğ½Ğ½Ñ‹Ğµ Ğ¼Ğ¾Ğ´ÑƒĞ»Ğ¸ ÑĞ¾Ğ³Ğ»Ğ°ÑĞ½Ğ¾ Ğ¿Ñ€Ğ¸Ğ½Ñ†Ğ¸Ğ¿Ğ°Ğ¼ SOLID Ğ¸ DRY.

## Ğ¡Ñ‚Ñ€ÑƒĞºÑ‚ÑƒÑ€Ğ°

```
api/services/dashboard/
â”œâ”€â”€ __init__.py              # Ğ­ĞºÑĞ¿Ğ¾Ñ€Ñ‚ Ğ²ÑĞµÑ… ÑĞµÑ€Ğ²Ğ¸ÑĞ¾Ğ²
â”œâ”€â”€ base.py                  # Ğ‘Ğ°Ğ·Ğ¾Ğ²Ñ‹Ğ¹ ĞºĞ»Ğ°ÑÑ Ñ Ğ¾Ğ±Ñ‰Ğ¸Ğ¼Ğ¸ Ğ¼ĞµÑ‚Ğ¾Ğ´Ğ°Ğ¼Ğ¸
â”œâ”€â”€ dashboard_service.py     # ĞÑĞ½Ğ¾Ğ²Ğ½Ğ¾Ğ¹ ÑĞµÑ€Ğ²Ğ¸Ñ-ĞºĞ¾Ğ¾Ñ€Ğ´Ğ¸Ğ½Ğ°Ñ‚Ğ¾Ñ€
â”œâ”€â”€ focus_service.py         # Ğ’Ğ¸Ğ´Ğ¶ĞµÑ‚ "Ğ¡ĞµĞ³Ğ¾Ğ´Ğ½Ñ Ğ² Ñ„Ğ¾ĞºÑƒÑĞµ"
â”œâ”€â”€ kpi_service.py          # KPI Ğ¼ĞµÑ‚Ñ€Ğ¸ĞºĞ¸
â”œâ”€â”€ activity_service.py     # Ğ›ĞµĞ½Ñ‚Ğ° Ğ°ĞºÑ‚Ğ¸Ğ²Ğ½Ğ¾ÑÑ‚Ğ¸
â”œâ”€â”€ equipment_service.py    # ĞŸĞ¾Ğ¿ÑƒĞ»ÑÑ€Ğ½Ğ¾Ğµ Ğ¾Ğ±Ğ¾Ñ€ÑƒĞ´Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ
â””â”€â”€ README.md              # Ğ­Ñ‚Ğ° Ğ´Ğ¾ĞºÑƒĞ¼ĞµĞ½Ñ‚Ğ°Ñ†Ğ¸Ñ
```

## ĞŸÑ€Ğ¸Ğ½Ñ†Ğ¸Ğ¿Ñ‹ SOLID

### Single Responsibility Principle (SRP)
- **FocusService**: ĞÑ‚Ğ²ĞµÑ‡Ğ°ĞµÑ‚ Ñ‚Ğ¾Ğ»ÑŒĞºĞ¾ Ğ·Ğ° Ğ²Ğ¸Ğ´Ğ¶ĞµÑ‚ "Ğ¡ĞµĞ³Ğ¾Ğ´Ğ½Ñ Ğ² Ñ„Ğ¾ĞºÑƒÑĞµ"
- **KpiService**: ĞÑ‚Ğ²ĞµÑ‡Ğ°ĞµÑ‚ Ñ‚Ğ¾Ğ»ÑŒĞºĞ¾ Ğ·Ğ° Ñ€Ğ°ÑÑ‡ĞµÑ‚ KPI Ğ¼ĞµÑ‚Ñ€Ğ¸Ğº
- **ActivityService**: ĞÑ‚Ğ²ĞµÑ‡Ğ°ĞµÑ‚ Ñ‚Ğ¾Ğ»ÑŒĞºĞ¾ Ğ·Ğ° Ğ»ĞµĞ½Ñ‚Ñƒ Ğ°ĞºÑ‚Ğ¸Ğ²Ğ½Ğ¾ÑÑ‚Ğ¸
- **EquipmentService**: ĞÑ‚Ğ²ĞµÑ‡Ğ°ĞµÑ‚ Ñ‚Ğ¾Ğ»ÑŒĞºĞ¾ Ğ·Ğ° Ğ¿Ğ¾Ğ¿ÑƒĞ»ÑÑ€Ğ½Ğ¾Ğµ Ğ¾Ğ±Ğ¾Ñ€ÑƒĞ´Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ
- **DashboardService**: ĞšĞ¾Ğ¾Ñ€Ğ´Ğ¸Ğ½Ğ¸Ñ€ÑƒĞµÑ‚ Ñ€Ğ°Ğ±Ğ¾Ñ‚Ñƒ Ğ²ÑĞµÑ… ÑĞµÑ€Ğ²Ğ¸ÑĞ¾Ğ²

### Open/Closed Principle (OCP)
- ĞšĞ°Ğ¶Ğ´Ñ‹Ğ¹ ÑĞµÑ€Ğ²Ğ¸Ñ Ğ»ĞµĞ³ĞºĞ¾ Ñ€Ğ°ÑÑˆĞ¸Ñ€ÑĞµÑ‚ÑÑ Ğ½Ğ¾Ğ²Ñ‹Ğ¼Ğ¸ Ğ¼ĞµÑ‚Ğ¾Ğ´Ğ°Ğ¼Ğ¸
- Ğ‘Ğ°Ğ·Ğ¾Ğ²Ñ‹Ğ¹ ĞºĞ»Ğ°ÑÑ Ğ¿Ñ€ĞµĞ´Ğ¾ÑÑ‚Ğ°Ğ²Ğ»ÑĞµÑ‚ Ğ¾Ğ±Ñ‰Ğ¸Ğµ Ğ¼ĞµÑ‚Ğ¾Ğ´Ñ‹ Ğ´Ğ»Ñ Ğ¿ĞµÑ€ĞµĞ¸ÑĞ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ

### Dependency Inversion Principle (DIP)
- Ğ’ÑĞµ ÑĞµÑ€Ğ²Ğ¸ÑÑ‹ Ğ·Ğ°Ğ²Ğ¸ÑÑÑ‚ Ğ¾Ñ‚ Ğ°Ğ±ÑÑ‚Ñ€Ğ°ĞºÑ†Ğ¸Ğ¸ (AsyncSession)
- ĞÑĞ½Ğ¾Ğ²Ğ½Ğ¾Ğ¹ ÑĞµÑ€Ğ²Ğ¸Ñ Ğ¸ÑĞ¿Ğ¾Ğ»ÑŒĞ·ÑƒĞµÑ‚ ĞºĞ¾Ğ¼Ğ¿Ğ¾Ğ·Ğ¸Ñ†Ğ¸Ñ Ğ²Ğ¼ĞµÑÑ‚Ğ¾ Ğ½Ğ°ÑĞ»ĞµĞ´Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ

## ĞŸÑ€Ğ¸Ğ½Ñ†Ğ¸Ğ¿ DRY

### ĞŸĞµÑ€ĞµĞ¸ÑĞ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ ĞºĞ¾Ğ´Ğ°
- **BaseDashboardService**: Ğ¡Ğ¾Ğ´ĞµÑ€Ğ¶Ğ¸Ñ‚ Ğ¾Ğ±Ñ‰Ğ¸Ğµ Ğ¼ĞµÑ‚Ğ¾Ğ´Ñ‹ ÑĞ¾Ğ·Ğ´Ğ°Ğ½Ğ¸Ñ `TodayFocusItem`
- **ĞĞ±Ñ‰Ğ¸Ğµ Ğ¸Ğ¼Ğ¿Ğ¾Ñ€Ñ‚Ñ‹**: Ğ’Ñ‹Ğ½ĞµÑĞµĞ½Ñ‹ Ğ² Ğ±Ğ°Ğ·Ğ¾Ğ²Ñ‹Ğ¹ ĞºĞ»Ğ°ÑÑ
- **ĞĞ±Ñ‰Ğ°Ñ Ğ»Ğ¾Ğ³Ğ¸ĞºĞ°**: ĞŸĞ°Ñ€Ğ°Ğ»Ğ»ĞµĞ»ÑŒĞ½Ğ¾Ğµ Ğ²Ñ‹Ğ¿Ğ¾Ğ»Ğ½ĞµĞ½Ğ¸Ğµ Ğ·Ğ°Ğ´Ğ°Ñ‡ Ğ² Ğ¾ÑĞ½Ğ¾Ğ²Ğ½Ğ¾Ğ¼ ÑĞµÑ€Ğ²Ğ¸ÑĞµ

## Ğ˜ÑĞ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ

### Ğ˜Ğ¼Ğ¿Ğ¾Ñ€Ñ‚
```python
from api.services.dashboard import DashboardService
```

### API Ğ¾ÑÑ‚Ğ°ĞµÑ‚ÑÑ Ğ½ĞµĞ¸Ğ·Ğ¼ĞµĞ½Ğ½Ñ‹Ğ¼
```python
dashboard_service = DashboardService(db)
summary = await dashboard_service.get_summary()
```

## ĞŸÑ€ĞµĞ¸Ğ¼ÑƒÑ‰ĞµÑÑ‚Ğ²Ğ° Ñ€ĞµÑ„Ğ°ĞºÑ‚Ğ¾Ñ€Ğ¸Ğ½Ğ³Ğ°

1. **Ğ§Ğ¸Ñ‚Ğ°ĞµĞ¼Ğ¾ÑÑ‚ÑŒ**: ĞšĞ°Ğ¶Ğ´Ñ‹Ğ¹ Ñ„Ğ°Ğ¹Ğ» Ğ¾Ñ‚Ğ²ĞµÑ‡Ğ°ĞµÑ‚ Ğ·Ğ° ĞºĞ¾Ğ½ĞºÑ€ĞµÑ‚Ğ½ÑƒÑ Ğ¾Ğ±Ğ»Ğ°ÑÑ‚ÑŒ
2. **Ğ¢ĞµÑÑ‚Ğ¸Ñ€ÑƒĞµĞ¼Ğ¾ÑÑ‚ÑŒ**: Ğ›ĞµĞ³ĞºĞ¾ Ñ‚ĞµÑÑ‚Ğ¸Ñ€Ğ¾Ğ²Ğ°Ñ‚ÑŒ Ğ¾Ñ‚Ğ´ĞµĞ»ÑŒĞ½Ñ‹Ğµ ĞºĞ¾Ğ¼Ğ¿Ğ¾Ğ½ĞµĞ½Ñ‚Ñ‹
3. **Ğ Ğ°ÑÑˆĞ¸Ñ€ÑĞµĞ¼Ğ¾ÑÑ‚ÑŒ**: ĞŸÑ€Ğ¾ÑÑ‚Ğ¾Ğµ Ğ´Ğ¾Ğ±Ğ°Ğ²Ğ»ĞµĞ½Ğ¸Ğµ Ğ½Ğ¾Ğ²Ñ‹Ñ… Ğ¼ĞµÑ‚Ñ€Ğ¸Ğº Ğ¸Ğ»Ğ¸ Ğ²Ğ¸Ğ´Ğ¶ĞµÑ‚Ğ¾Ğ²
4. **ĞŸĞ¾Ğ´Ğ´ĞµÑ€Ğ¶ĞºĞ°**: Ğ›ĞµĞ³Ñ‡Ğµ Ğ½Ğ°Ñ…Ğ¾Ğ´Ğ¸Ñ‚ÑŒ Ğ¸ Ğ¸ÑĞ¿Ñ€Ğ°Ğ²Ğ»ÑÑ‚ÑŒ Ğ¾ÑˆĞ¸Ğ±ĞºĞ¸
5. **ĞŸĞµÑ€ĞµĞ¸ÑĞ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ**: Ğ‘Ğ°Ğ·Ğ¾Ğ²Ñ‹Ğ¹ ĞºĞ»Ğ°ÑÑ Ğ¼Ğ¾Ğ¶Ğ½Ğ¾ Ğ¸ÑĞ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ÑŒ Ğ² Ğ´Ñ€ÑƒĞ³Ğ¸Ñ… ÑĞµÑ€Ğ²Ğ¸ÑĞ°Ñ…

## ĞĞ±Ñ€Ğ°Ñ‚Ğ½Ğ°Ñ ÑĞ¾Ğ²Ğ¼ĞµÑÑ‚Ğ¸Ğ¼Ğ¾ÑÑ‚ÑŒ

- API ÑĞ½Ğ´Ğ¿Ğ¾Ğ¸Ğ½Ñ‚ `/admin/dashboard-summary` Ñ€Ğ°Ğ±Ğ¾Ñ‚Ğ°ĞµÑ‚ Ğ±ĞµĞ· Ğ¸Ğ·Ğ¼ĞµĞ½ĞµĞ½Ğ¸Ğ¹
- Ğ’ÑĞµ Ğ¸Ğ¼Ğ¿Ğ¾Ñ€Ñ‚Ñ‹ Ğ² ÑÑƒÑ‰ĞµÑÑ‚Ğ²ÑƒÑÑ‰ĞµĞ¼ ĞºĞ¾Ğ´Ğµ Ğ¾ÑÑ‚Ğ°ÑÑ‚ÑÑ Ñ€Ğ°Ğ±Ğ¾Ñ‡Ğ¸Ğ¼Ğ¸
- Ğ¤ÑƒĞ½ĞºÑ†Ğ¸Ğ¾Ğ½Ğ°Ğ»ÑŒĞ½Ğ¾ÑÑ‚ÑŒ Ğ¿Ğ¾Ğ»Ğ½Ğ¾ÑÑ‚ÑŒÑ ÑĞ¾Ñ…Ñ€Ğ°Ğ½ĞµĞ½Ğ°


```


## <a name="RentalAppFASTAPIapiservicesdashboardinitpy"></a>`RentalApp_FASTAPI/api/services/dashboard/__init__.py`

```python
// path: RentalApp_FASTAPI/api/services/dashboard/__init__.py

# api/services/dashboard/__init__.py

from .base import BaseDashboardService
from .focus_service import FocusService
from .kpi_service import KpiService
from .activity_service import ActivityService
from .equipment_service import EquipmentService
from .dashboard_service import DashboardService

__all__ = [
    'BaseDashboardService',
    'FocusService', 
    'KpiService',
    'ActivityService',
    'EquipmentService',
    'DashboardService'
]


```


## <a name="RentalAppFASTAPIapiservicesdashboardactivityservicepy"></a>`RentalApp_FASTAPI/api/services/dashboard/activity_service.py`

```python
// path: RentalApp_FASTAPI/api/services/dashboard/activity_service.py

# api/services/dashboard/activity_service.py

from sqlalchemy.ext.asyncio import AsyncSession
from sqlalchemy import select, func, desc, literal_column, union_all
from datetime import datetime, timedelta
from typing import List

from api.models.rental import Rental
from api.models.user import User
from api.models.equipment import Equipment
from shared.schemas.dashboard_schema import ActivityFeedItem
from .base import BaseDashboardService


class ActivityService(BaseDashboardService):
    """Ğ¡ĞµÑ€Ğ²Ğ¸Ñ Ğ´Ğ»Ñ Ğ»ĞµĞ½Ñ‚Ñ‹ Ğ°ĞºÑ‚Ğ¸Ğ²Ğ½Ğ¾ÑÑ‚Ğ¸ Ğ¿Ğ°Ğ½ĞµĞ»Ğ¸ ÑƒĞ¿Ñ€Ğ°Ğ²Ğ»ĞµĞ½Ğ¸Ñ."""
    
    async def get_recent_activity(self) -> List[ActivityFeedItem]:
        """ĞŸĞ¾Ğ»ÑƒÑ‡Ğ°ĞµÑ‚ Ğ¿Ğ¾ÑĞ»ĞµĞ´Ğ½Ğ¸Ğµ ÑĞ¾Ğ±Ñ‹Ñ‚Ğ¸Ñ Ğ² ÑĞ¸ÑÑ‚ĞµĞ¼Ğµ."""
        seven_days_ago = datetime.now() - timedelta(days=7)

        # Ğ—Ğ°Ğ¿Ñ€Ğ¾Ñ 1: ĞĞ¾Ğ²Ñ‹Ğµ Ğ°Ñ€ĞµĞ½Ğ´Ñ‹
        new_rentals_q = (
            select(
                Rental.id,
                Rental.created_at.label("timestamp"),
                literal_column("'rental_started'").label("activity_type"),
                User.full_name.label("user_name"),
                func.string_agg(Equipment.name, ', ').label("equipment_name")
            )
            .join(User, Rental.user_id == User.id)
            .join(Rental.equipment)
            .where(Rental.created_at >= seven_days_ago)
            .group_by(Rental.id, User.full_name, Rental.created_at)
        )
        
        # Ğ—Ğ°Ğ¿Ñ€Ğ¾Ñ 2: ĞĞ¾Ğ²Ñ‹Ğµ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ğ¸
        new_users_q = (
            select(
                User.id,
                User.created_at.label("timestamp"),
                literal_column("'user_registered'").label("activity_type"),
                User.full_name.label("user_name"),
                literal_column("NULL").label("equipment_name")
            )
            .where(User.created_at >= seven_days_ago)
        )

        # ĞĞ±ÑŠĞµĞ´Ğ¸Ğ½ÑĞµĞ¼ Ğ·Ğ°Ğ¿Ñ€Ğ¾ÑÑ‹
        combined_query = union_all(new_rentals_q, new_users_q).order_by(desc("timestamp")).limit(10)
        
        result = await self.db.execute(combined_query)
        
        activities = []
        for row in result.mappings().all():
            description = ""
            if row.activity_type == 'rental_started':
                description = f"ĞĞ¾Ğ²Ğ°Ñ Ğ°Ñ€ĞµĞ½Ğ´Ğ° Ğ´Ğ»Ñ {row.user_name}"
            elif row.activity_type == 'user_registered':
                description = f"ĞĞ¾Ğ²Ñ‹Ğ¹ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ÑŒ: {row.user_name}"
            
            activities.append(ActivityFeedItem(
                id=row.id, 
                timestamp=row.timestamp, 
                activity_type=row.activity_type,
                description=description, 
                user_name=row.user_name, 
                equipment_name=row.equipment_name
            ))
        return activities


```


## <a name="RentalAppFASTAPIapiservicesdashboardbasepy"></a>`RentalApp_FASTAPI/api/services/dashboard/base.py`

```python
// path: RentalApp_FASTAPI/api/services/dashboard/base.py

# api/services/dashboard/base.py

from sqlalchemy.ext.asyncio import AsyncSession
from datetime import datetime, date
from typing import List

from api.models.rental import Rental
from api.models.reservation import Reservation
from shared.schemas.dashboard_schema import TodayFocusItem


class BaseDashboardService:
    """Ğ‘Ğ°Ğ·Ğ¾Ğ²Ñ‹Ğ¹ ĞºĞ»Ğ°ÑÑ Ğ´Ğ»Ñ ÑĞµÑ€Ğ²Ğ¸ÑĞ¾Ğ² Ğ¿Ğ°Ğ½ĞµĞ»Ğ¸ ÑƒĞ¿Ñ€Ğ°Ğ²Ğ»ĞµĞ½Ğ¸Ñ Ñ Ğ¾Ğ±Ñ‰Ğ¸Ğ¼Ğ¸ Ğ¼ĞµÑ‚Ğ¾Ğ´Ğ°Ğ¼Ğ¸."""
    
    def __init__(self, db: AsyncSession):
        self.db = db

    def _create_today_focus_item_from_reservation(self, reservation: Reservation, start_date: date = None) -> TodayFocusItem:
        """Ğ¡Ğ¾Ğ·Ğ´Ğ°ĞµÑ‚ TodayFocusItem Ğ¸Ğ· Ñ€ĞµĞ·ĞµÑ€Ğ²Ğ°Ñ†Ğ¸Ğ¸."""
        return TodayFocusItem(
            id=reservation.id,
            user_name=reservation.user.full_name,
            details=f"{len(reservation.equipment)} Ğ¿Ğ¾Ğ·Ğ¸Ñ†Ğ¸Ğ¹",
            user_id=reservation.user_id,
            order_type='reservation',
            scheduled_time=datetime.combine(reservation.start_date, datetime.min.time()),
            start_date=start_date or reservation.start_date
        )

    def _create_today_focus_item_from_rental(
        self, 
        rental: Rental, 
        details: str, 
        due_date: date = None, 
        days_overdue: int = None
    ) -> TodayFocusItem:
        """Ğ¡Ğ¾Ğ·Ğ´Ğ°ĞµÑ‚ TodayFocusItem Ğ¸Ğ· Ğ°Ñ€ĞµĞ½Ğ´Ñ‹."""
        return TodayFocusItem(
            id=rental.id,
            user_name=rental.user.full_name,
            details=details,
            user_id=rental.user_id,
            order_type='rental',
            scheduled_time=datetime.combine(rental.end_date, datetime.min.time()),
            due_date=due_date,
            days_overdue=days_overdue
        )


```


## <a name="RentalAppFASTAPIapiservicesdashboarddashboardservicepy"></a>`RentalApp_FASTAPI/api/services/dashboard/dashboard_service.py`

```python
// path: RentalApp_FASTAPI/api/services/dashboard/dashboard_service.py

# api/services/dashboard/dashboard_service.py

from sqlalchemy.ext.asyncio import AsyncSession
import asyncio
import logging

from shared.schemas.dashboard_schema import DashboardSummaryResponse
from .focus_service import FocusService
from .kpi_service import KpiService
from .activity_service import ActivityService
from .equipment_service import EquipmentService

logger = logging.getLogger(__name__)


class DashboardService:
    """ĞÑĞ½Ğ¾Ğ²Ğ½Ğ¾Ğ¹ ÑĞµÑ€Ğ²Ğ¸Ñ Ğ´Ğ»Ñ ÑĞ±Ğ¾Ñ€Ğ° Ğ°Ğ³Ñ€ĞµĞ³Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ½Ñ‹Ñ… Ğ´Ğ°Ğ½Ğ½Ñ‹Ñ… Ğ´Ğ»Ñ Ğ¿Ğ°Ğ½ĞµĞ»Ğ¸ ÑƒĞ¿Ñ€Ğ°Ğ²Ğ»ĞµĞ½Ğ¸Ñ Ğ°Ğ´Ğ¼Ğ¸Ğ½ĞºĞ¸."""

    def __init__(self, db: AsyncSession):
        self.db = db
        # Ğ˜Ğ½Ğ¸Ñ†Ğ¸Ğ°Ğ»Ğ¸Ğ·Ğ¸Ñ€ÑƒĞµĞ¼ ÑĞ¿ĞµÑ†Ğ¸Ğ°Ğ»Ğ¸Ğ·Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ½Ñ‹Ğµ ÑĞµÑ€Ğ²Ğ¸ÑÑ‹
        self.focus_service = FocusService(db)
        self.kpi_service = KpiService(db)
        self.activity_service = ActivityService(db)
        self.equipment_service = EquipmentService(db)

    async def get_summary(self) -> DashboardSummaryResponse:
        """ĞŸĞ¾Ğ»ÑƒÑ‡Ğ°ĞµÑ‚ ÑĞ²Ğ¾Ğ´Ğ½ÑƒÑ Ğ¸Ğ½Ñ„Ğ¾Ñ€Ğ¼Ğ°Ñ†Ğ¸Ñ Ğ´Ğ»Ñ Ğ¿Ğ°Ğ½ĞµĞ»Ğ¸ ÑƒĞ¿Ñ€Ğ°Ğ²Ğ»ĞµĞ½Ğ¸Ñ."""
        try:
            # Ğ¡Ğ¾Ğ±Ğ¸Ñ€Ğ°ĞµĞ¼ Ğ²ÑĞµ Ğ´Ğ°Ğ½Ğ½Ñ‹Ğµ Ğ¿Ğ°Ñ€Ğ°Ğ»Ğ»ĞµĞ»ÑŒĞ½Ğ¾ Ğ´Ğ»Ñ Ğ¾Ğ¿Ñ‚Ğ¸Ğ¼Ğ¸Ğ·Ğ°Ñ†Ğ¸Ğ¸
            # Ğ“Ñ€ÑƒĞ¿Ğ¿Ğ¸Ñ€ÑƒĞµĞ¼ Ğ·Ğ°Ğ´Ğ°Ñ‡Ğ¸ Ğ¿Ğ¾ Ñ‚Ğ¸Ğ¿Ğ°Ğ¼ Ğ´Ğ»Ñ Ğ»ÑƒÑ‡ÑˆĞµĞ¹ Ğ¾Ñ€Ğ³Ğ°Ğ½Ğ¸Ğ·Ğ°Ñ†Ğ¸Ğ¸
            focus_tasks = [
                self.focus_service.get_pickups_today(),
                self.focus_service.get_returns_today(),
                self.focus_service.get_overdue_rentals()
            ]
            
            other_tasks = [
                self.activity_service.get_recent_activity(),
                self.equipment_service.get_popular_equipment()
            ]
            
            # Ğ’Ñ‹Ğ¿Ğ¾Ğ»Ğ½ÑĞµĞ¼ Ğ·Ğ°Ğ´Ğ°Ñ‡Ğ¸ Ğ¿Ğ°Ñ€Ğ°Ğ»Ğ»ĞµĞ»ÑŒĞ½Ğ¾
            focus_results = await asyncio.gather(*focus_tasks)
            kpi_data = await self.kpi_service.get_kpi_data()
            other_results = await asyncio.gather(*other_tasks)

            return DashboardSummaryResponse(
                pickups_today=focus_results[0],
                returns_today=focus_results[1],
                overdue_rentals=focus_results[2],
                kpi=kpi_data,
                recent_activity=other_results[0],
                popular_equipment=other_results[1]
            )
        except Exception as e:
            logger.error(f"ĞÑˆĞ¸Ğ±ĞºĞ° Ğ¿Ñ€Ğ¸ Ğ¿Ğ¾Ğ»ÑƒÑ‡ĞµĞ½Ğ¸Ğ¸ ÑĞ²Ğ¾Ğ´Ğ½Ğ¾Ğ¹ Ğ¸Ğ½Ñ„Ğ¾Ñ€Ğ¼Ğ°Ñ†Ğ¸Ğ¸: {e}", exc_info=True)
            raise


```


## <a name="RentalAppFASTAPIapiservicesdashboardequipmentservicepy"></a>`RentalApp_FASTAPI/api/services/dashboard/equipment_service.py`

```python
// path: RentalApp_FASTAPI/api/services/dashboard/equipment_service.py

# api/services/dashboard/equipment_service.py

from sqlalchemy.ext.asyncio import AsyncSession
from sqlalchemy import select, func, desc
from datetime import date, timedelta
from typing import List
import logging

from api.models.rental import Rental
from api.models.equipment import Equipment
from shared.schemas.dashboard_schema import PopularEquipmentItem
from .base import BaseDashboardService

logger = logging.getLogger(__name__)


class EquipmentService(BaseDashboardService):
    """Ğ¡ĞµÑ€Ğ²Ğ¸Ñ Ğ´Ğ»Ñ Ñ€Ğ°Ğ±Ğ¾Ñ‚Ñ‹ Ñ Ğ¿Ğ¾Ğ¿ÑƒĞ»ÑÑ€Ğ½Ñ‹Ğ¼ Ğ¾Ğ±Ğ¾Ñ€ÑƒĞ´Ğ¾Ğ²Ğ°Ğ½Ğ¸ĞµĞ¼ Ğ¿Ğ°Ğ½ĞµĞ»Ğ¸ ÑƒĞ¿Ñ€Ğ°Ğ²Ğ»ĞµĞ½Ğ¸Ñ."""
    
    async def get_popular_equipment(self) -> List[PopularEquipmentItem]:
        """ĞŸĞ¾Ğ»ÑƒÑ‡Ğ°ĞµÑ‚ Ñ‚Ğ¾Ğ¿-10 ÑĞ°Ğ¼Ğ¾Ğ³Ğ¾ Ğ¿Ğ¾Ğ¿ÑƒĞ»ÑÑ€Ğ½Ğ¾Ğ³Ğ¾ Ğ¾Ğ±Ğ¾Ñ€ÑƒĞ´Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ Ñ Ğ²Ñ‹Ñ€ÑƒÑ‡ĞºĞ¾Ğ¹."""
        try:
            thirty_days_ago = date.today() - timedelta(days=30)
            query = (
                select(
                    Equipment.id.label("equipment_id"),
                    Equipment.name.label("equipment_name"),
                    func.count(Rental.id).label("rental_count"),
                    func.sum(Rental.total_cost).label("revenue")
                )
                .join(Rental.equipment)
                .where(Rental.created_at >= thirty_days_ago)
                .group_by(Equipment.id, Equipment.name)
                .order_by(desc("rental_count"))
                .limit(10)
            )
            result = await self.db.execute(query)
            return [PopularEquipmentItem.model_validate(row) for row in result.mappings().all()]
            
        except Exception as e:
            logger.error(f"ĞÑˆĞ¸Ğ±ĞºĞ° Ğ¿Ñ€Ğ¸ Ğ¿Ğ¾Ğ»ÑƒÑ‡ĞµĞ½Ğ¸Ğ¸ Ğ¿Ğ¾Ğ¿ÑƒĞ»ÑÑ€Ğ½Ğ¾Ğ³Ğ¾ Ğ¾Ğ±Ğ¾Ñ€ÑƒĞ´Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ: {e}", exc_info=True)
            # Ğ’Ğ¾Ğ·Ğ²Ñ€Ğ°Ñ‰Ğ°ĞµĞ¼ Ğ¿ÑƒÑÑ‚Ğ¾Ğ¹ ÑĞ¿Ğ¸ÑĞ¾Ğº Ğ² ÑĞ»ÑƒÑ‡Ğ°Ğµ Ğ¾ÑˆĞ¸Ğ±ĞºĞ¸
            return []


```


## <a name="RentalAppFASTAPIapiservicesdashboardfocusservicepy"></a>`RentalApp_FASTAPI/api/services/dashboard/focus_service.py`

```python
// path: RentalApp_FASTAPI/api/services/dashboard/focus_service.py


# api/services/dashboard/focus_service.py

from sqlalchemy.ext.asyncio import AsyncSession
from sqlalchemy.orm import joinedload, selectinload
from sqlalchemy import select, and_
from datetime import date
from typing import List

from api.models.rental import Rental
from api.models.reservation import Reservation
from shared.schemas.dashboard_schema import TodayFocusItem
from .base import BaseDashboardService


class FocusService(BaseDashboardService):
    """Ğ¡ĞµÑ€Ğ²Ğ¸Ñ Ğ´Ğ»Ñ Ğ²Ğ¸Ğ´Ğ¶ĞµÑ‚Ğ° 'Ğ¡ĞµĞ³Ğ¾Ğ´Ğ½Ñ Ğ² Ñ„Ğ¾ĞºÑƒÑĞµ' - Ğ²Ñ‹Ğ´Ğ°Ñ‡Ğ¸, Ğ²Ğ¾Ğ·Ğ²Ñ€Ğ°Ñ‚Ñ‹, Ğ¿Ñ€Ğ¾ÑÑ€Ğ¾Ñ‡ĞºĞ¸."""
    
    async def get_pickups_today(self) -> List[TodayFocusItem]:
        """ĞŸĞ¾Ğ»ÑƒÑ‡Ğ°ĞµÑ‚ Ğ°ĞºÑ‚Ğ¸Ğ²Ğ½Ñ‹Ğµ Ñ€ĞµĞ·ĞµÑ€Ğ²Ğ°Ñ†Ğ¸Ğ¸ Ğ´Ğ»Ñ Ğ²Ñ‹Ğ´Ğ°Ñ‡Ğ¸ (Ğ½Ğµ Ğ¿Ñ€Ğ¾ÑÑ€Ğ¾Ñ‡ĞµĞ½Ğ½Ñ‹Ğµ Ğ¸ Ğ½Ğµ Ğ²Ñ‹Ğ´Ğ°Ğ½Ğ½Ñ‹Ğµ)."""
        today = date.today()
        
        query = select(Reservation).options(
            joinedload(Reservation.user),
            selectinload(Reservation.equipment)
        ).filter(
            and_(
                Reservation.start_date <= today,
                Reservation.end_date >= today,
                Reservation.status == 'active'
            )
        )

        result = await self.db.execute(query)
        reservations = result.unique().scalars().all()

        return [self._create_today_focus_item_from_reservation(reservation, reservation.start_date) for reservation in reservations]

    async def get_returns_today(self) -> List[TodayFocusItem]:
        """ĞŸĞ¾Ğ»ÑƒÑ‡Ğ°ĞµÑ‚ Ğ°Ñ€ĞµĞ½Ğ´Ñ‹ Ğ½Ğ° ÑĞµĞ³Ğ¾Ğ´Ğ½Ñ Ğ´Ğ»Ñ Ğ²Ğ¾Ğ·Ğ²Ñ€Ğ°Ñ‚Ğ°."""
        today = date.today()
        
        query = select(Rental).options(
            joinedload(Rental.user),
            selectinload(Rental.equipment)
        ).filter(
            and_(
                Rental.end_date == today,
                Rental.status == 'active'
            )
        )

        result = await self.db.execute(query)
        rentals = result.unique().scalars().all()

        return [
            self._create_today_focus_item_from_rental(
                rental, 
                f"ĞÑÑ‚Ğ°Ñ‚Ğ¾Ğº: {rental.total_cost - rental.prepayment_amount:.0f} â‚½"
            ) 
            for rental in rentals
        ]

    async def get_overdue_rentals(self) -> List[TodayFocusItem]:
        """ĞŸĞ¾Ğ»ÑƒÑ‡Ğ°ĞµÑ‚ Ğ¿Ñ€Ğ¾ÑÑ€Ğ¾Ñ‡ĞµĞ½Ğ½Ñ‹Ğµ Ğ°Ñ€ĞµĞ½Ğ´Ñ‹."""
        today = date.today()
        
        query = select(Rental).options(
            joinedload(Rental.user),
            selectinload(Rental.equipment)
        ).filter(
            and_(
                Rental.end_date < today,
                Rental.status == 'active'
            )
        )

        result = await self.db.execute(query)
        rentals = result.unique().scalars().all()

        result_items = []
        for rental in rentals:
            days_overdue = (today - rental.end_date).days
            remaining_amount = rental.total_cost - rental.prepayment_amount
            
            item = self._create_today_focus_item_from_rental(
                rental,
                f"{len(rental.equipment)} Ğ¿Ğ¾Ğ·., Ğ¾ÑÑ‚Ğ°Ñ‚Ğ¾Ğº: {remaining_amount:.0f} â‚½",
                due_date=rental.end_date,
                days_overdue=days_overdue
            )
            result_items.append(item)
        
        return result_items


```


## <a name="RentalAppFASTAPIapiservicesdashboardkpiservicepy"></a>`RentalApp_FASTAPI/api/services/dashboard/kpi_service.py`

```python
// path: RentalApp_FASTAPI/api/services/dashboard/kpi_service.py

# api/services/dashboard/kpi_service.py

from sqlalchemy.ext.asyncio import AsyncSession
from sqlalchemy.orm import joinedload, selectinload
from sqlalchemy import select, func, and_
from datetime import date, timedelta
import asyncio

from api.models.rental import Rental, rental_equipment_association
from api.models.reservation import Reservation, reservation_equipment_association
from api.models.user import User
from api.models.equipment import Equipment
from shared.schemas.dashboard_schema import KpiData
from .base import BaseDashboardService


class KpiService(BaseDashboardService):
    """Ğ¡ĞµÑ€Ğ²Ğ¸Ñ Ğ´Ğ»Ñ Ñ€Ğ°ÑÑ‡ĞµÑ‚Ğ° KPI Ğ¼ĞµÑ‚Ñ€Ğ¸Ğº Ğ¿Ğ°Ğ½ĞµĞ»Ğ¸ ÑƒĞ¿Ñ€Ğ°Ğ²Ğ»ĞµĞ½Ğ¸Ñ."""
    
    async def get_total_users(self) -> int:
        """ĞŸĞ¾Ğ»ÑƒÑ‡Ğ°ĞµÑ‚ Ğ¾Ğ±Ñ‰ĞµĞµ ĞºĞ¾Ğ»Ğ¸Ñ‡ĞµÑÑ‚Ğ²Ğ¾ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ĞµĞ¹."""
        query = select(func.count(User.id))
        result = await self.db.execute(query)
        return int(result.scalar_one())

    async def get_active_users(self) -> int:
        """ĞŸĞ¾Ğ»ÑƒÑ‡Ğ°ĞµÑ‚ ĞºĞ¾Ğ»Ğ¸Ñ‡ĞµÑÑ‚Ğ²Ğ¾ Ğ°ĞºÑ‚Ğ¸Ğ²Ğ½Ñ‹Ñ… Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ĞµĞ¹ (Ñ Ñ€ĞµĞ·ĞµÑ€Ğ²Ğ°Ñ†Ğ¸ÑĞ¼Ğ¸ Ğ¸Ğ»Ğ¸ Ğ°Ñ€ĞµĞ½Ğ´Ğ°Ğ¼Ğ¸ Ğ·Ğ° Ğ¿Ğ¾ÑĞ»ĞµĞ´Ğ½Ğ¸Ğµ 30 Ğ´Ğ½ĞµĞ¹)."""
        thirty_days_ago = date.today() - timedelta(days=30)
        
        # ĞŸĞ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ğ¸ Ñ Ğ°ĞºÑ‚Ğ¸Ğ²Ğ½Ñ‹Ğ¼Ğ¸ Ñ€ĞµĞ·ĞµÑ€Ğ²Ğ°Ñ†Ğ¸ÑĞ¼Ğ¸
        active_reservations_query = select(User.id).join(
            Reservation, User.id == Reservation.user_id
        ).filter(
            and_(
                Reservation.created_at >= thirty_days_ago,
                Reservation.status.in_(['active', 'completed'])
            )
        )
        
        # ĞŸĞ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ğ¸ Ñ Ğ°ĞºÑ‚Ğ¸Ğ²Ğ½Ñ‹Ğ¼Ğ¸ Ğ°Ñ€ĞµĞ½Ğ´Ğ°Ğ¼Ğ¸
        active_rentals_query = select(User.id).join(
            Rental, User.id == Rental.user_id
        ).filter(
            and_(
                Rental.created_at >= thirty_days_ago,
                Rental.status.in_(['active', 'completed'])
            )
        )
        
        # ĞĞ±ÑŠĞµĞ´Ğ¸Ğ½ÑĞµĞ¼ Ñ€ĞµĞ·ÑƒĞ»ÑŒÑ‚Ğ°Ñ‚Ñ‹
        reservations_result = await self.db.execute(active_reservations_query)
        rentals_result = await self.db.execute(active_rentals_query)
        
        active_user_ids = set()
        for row in reservations_result:
            active_user_ids.add(row.id)
        for row in rentals_result:
            active_user_ids.add(row.id)
            
        return len(active_user_ids)

    async def get_total_equipment(self) -> int:
        """ĞŸĞ¾Ğ»ÑƒÑ‡Ğ°ĞµÑ‚ Ğ¾Ğ±Ñ‰ĞµĞµ ĞºĞ¾Ğ»Ğ¸Ñ‡ĞµÑÑ‚Ğ²Ğ¾ Ğ¾Ğ±Ğ¾Ñ€ÑƒĞ´Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ."""
        query = select(func.count(Equipment.id))
        result = await self.db.execute(query)
        return int(result.scalar_one())

    async def get_total_reservations(self) -> int:
        """ĞŸĞ¾Ğ»ÑƒÑ‡Ğ°ĞµÑ‚ Ğ¾Ğ±Ñ‰ĞµĞµ ĞºĞ¾Ğ»Ğ¸Ñ‡ĞµÑÑ‚Ğ²Ğ¾ Ñ€ĞµĞ·ĞµÑ€Ğ²Ğ°Ñ†Ğ¸Ğ¹."""
        query = select(func.count(Reservation.id))
        result = await self.db.execute(query)
        return int(result.scalar_one())

    async def get_revenue_today(self) -> float:
        """ĞŸĞ¾Ğ»ÑƒÑ‡Ğ°ĞµÑ‚ Ğ´Ğ¾Ñ…Ğ¾Ğ´ Ğ·Ğ° ÑĞµĞ³Ğ¾Ğ´Ğ½Ñ."""
        today = date.today()
        
        query = select(func.coalesce(func.sum(Rental.final_cost), 0)).filter(
            and_(
                Rental.status == 'completed',
                func.date(Rental.actual_return_date) == today
            )
        )

        result = await self.db.execute(query)
        return float(result.scalar_one())

    async def get_revenue_this_month(self) -> float:
        """ĞŸĞ¾Ğ»ÑƒÑ‡Ğ°ĞµÑ‚ Ğ´Ğ¾Ñ…Ğ¾Ğ´ Ğ·Ğ° Ñ‚ĞµĞºÑƒÑ‰Ğ¸Ğ¹ Ğ¼ĞµÑÑÑ†."""
        today = date.today()
        first_day_of_month = today.replace(day=1)
        
        query = select(func.coalesce(func.sum(Rental.final_cost), 0)).filter(
            and_(
                Rental.status == 'completed',
                Rental.actual_return_date >= first_day_of_month,
                Rental.actual_return_date <= today
            )
        )

        result = await self.db.execute(query)
        return float(result.scalar_one())

    async def get_occupancy_rate(self) -> float:
        """Ğ Ğ°ÑÑÑ‡Ğ¸Ñ‚Ñ‹Ğ²Ğ°ĞµÑ‚ ĞºĞ¾ÑÑ„Ñ„Ğ¸Ñ†Ğ¸ĞµĞ½Ñ‚ Ğ·Ğ°Ğ³Ñ€ÑƒĞ¶ĞµĞ½Ğ½Ğ¾ÑÑ‚Ğ¸ Ğ¾Ğ±Ğ¾Ñ€ÑƒĞ´Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ."""
        today = date.today()
        
        # ĞŸĞ¾Ğ»ÑƒÑ‡Ğ°ĞµĞ¼ Ğ¾Ğ±Ñ‰ĞµĞµ ĞºĞ¾Ğ»Ğ¸Ñ‡ĞµÑÑ‚Ğ²Ğ¾ Ğ¾Ğ±Ğ¾Ñ€ÑƒĞ´Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ
        total_equipment_query = select(func.count(Equipment.id))
        total_result = await self.db.execute(total_equipment_query)
        total_equipment = total_result.scalar_one()

        if total_equipment == 0:
            return 0.0

        # ĞŸĞ¾Ğ»ÑƒÑ‡Ğ°ĞµĞ¼ ÑƒĞ½Ğ¸ĞºĞ°Ğ»ÑŒĞ½Ğ¾Ğµ Ğ¾Ğ±Ğ¾Ñ€ÑƒĞ´Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ Ğ¸Ğ· Ğ°ĞºÑ‚Ğ¸Ğ²Ğ½Ñ‹Ñ… Ñ€ĞµĞ·ĞµÑ€Ğ²Ğ°Ñ†Ğ¸Ğ¹
        active_reservations_query = select(reservation_equipment_association.c.equipment_id).join(
            Reservation, 
            reservation_equipment_association.c.reservation_id == Reservation.id
        ).filter(
            and_(
                Reservation.start_date <= today,
                Reservation.end_date >= today,
                Reservation.status == 'active'
            )
        )
        
        reservations_result = await self.db.execute(active_reservations_query)
        reservation_equipment_ids = set(row.equipment_id for row in reservations_result)
        
        # ĞŸĞ¾Ğ»ÑƒÑ‡Ğ°ĞµĞ¼ ÑƒĞ½Ğ¸ĞºĞ°Ğ»ÑŒĞ½Ğ¾Ğµ Ğ¾Ğ±Ğ¾Ñ€ÑƒĞ´Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ Ğ¸Ğ· Ğ°ĞºÑ‚Ğ¸Ğ²Ğ½Ñ‹Ñ… Ğ°Ñ€ĞµĞ½Ğ´
        active_rentals_query = select(rental_equipment_association.c.equipment_id).join(
            Rental,
            rental_equipment_association.c.rental_id == Rental.id
        ).filter(
            and_(
                Rental.start_date <= today,
                Rental.end_date >= today,
                Rental.status == 'active'
            )
        )
        
        rentals_result = await self.db.execute(active_rentals_query)
        rental_equipment_ids = set(row.equipment_id for row in rentals_result)
        
        # ĞĞ±ÑŠĞµĞ´Ğ¸Ğ½ÑĞµĞ¼ Ğ¸ ÑÑ‡Ğ¸Ñ‚Ğ°ĞµĞ¼ ÑƒĞ½Ğ¸ĞºĞ°Ğ»ÑŒĞ½Ğ¾Ğµ Ğ¾Ğ±Ğ¾Ñ€ÑƒĞ´Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ
        unique_equipment_ids = reservation_equipment_ids.union(rental_equipment_ids)
        unique_equipment = len(unique_equipment_ids)

        return (unique_equipment / total_equipment) * 100

    async def get_avg_rental_duration(self) -> float:
        """Ğ Ğ°ÑÑÑ‡Ğ¸Ñ‚Ñ‹Ğ²Ğ°ĞµÑ‚ ÑÑ€ĞµĞ´Ğ½ÑÑ Ğ¿Ñ€Ğ¾Ğ´Ğ¾Ğ»Ğ¶Ğ¸Ñ‚ĞµĞ»ÑŒĞ½Ğ¾ÑÑ‚ÑŒ Ğ°Ñ€ĞµĞ½Ğ´Ñ‹ Ğ² Ğ´Ğ½ÑÑ…."""
        # Ğ”Ğ»Ñ PostgreSQL Ğ¸ÑĞ¿Ğ¾Ğ»ÑŒĞ·ÑƒĞµĞ¼ Ğ¿Ñ€Ğ¾ÑÑ‚Ğ¾Ğµ Ğ²Ñ‹Ñ‡Ğ¸Ñ‚Ğ°Ğ½Ğ¸Ğµ Ğ´Ğ°Ñ‚ Ñ‚Ğ¸Ğ¿Ğ° DATE
        # Ğ­Ñ‚Ğ¾ Ğ°Ğ²Ñ‚Ğ¾Ğ¼Ğ°Ñ‚Ğ¸Ñ‡ĞµÑĞºĞ¸ Ğ²Ğ¾Ğ·Ğ²Ñ€Ğ°Ñ‰Ğ°ĞµÑ‚ ĞºĞ¾Ğ»Ğ¸Ñ‡ĞµÑÑ‚Ğ²Ğ¾ Ğ´Ğ½ĞµĞ¹ ĞºĞ°Ğº integer
        query = select(func.avg(
            Rental.actual_return_date - Rental.start_date
        )).filter(
            and_(
                Rental.status == 'completed',
                Rental.actual_return_date.isnot(None)
            )
        )

        result = await self.db.execute(query)
        avg_duration = result.scalar_one()
        return float(avg_duration) if avg_duration is not None else 0.0

    async def get_kpi_data(self) -> KpiData:
        """ĞŸĞ¾Ğ»ÑƒÑ‡Ğ°ĞµÑ‚ Ğ²ÑĞµ KPI Ğ´Ğ°Ğ½Ğ½Ñ‹Ğµ Ğ¿Ğ°Ñ€Ğ°Ğ»Ğ»ĞµĞ»ÑŒĞ½Ğ¾."""
        # Ğ’Ñ‹Ğ¿Ğ¾Ğ»Ğ½ÑĞµĞ¼ Ğ²ÑĞµ KPI Ğ·Ğ°Ğ¿Ñ€Ğ¾ÑÑ‹ Ğ¿Ğ°Ñ€Ğ°Ğ»Ğ»ĞµĞ»ÑŒĞ½Ğ¾
        results = await asyncio.gather(
            self.get_total_users(),
            self.get_active_users(),
            self.get_total_equipment(),
            self.get_total_reservations(),
            self.get_revenue_today(),
            self.get_revenue_this_month(),
            self.get_occupancy_rate(),
            self.get_avg_rental_duration()
        )
        
        return KpiData(
            total_users=results[0],
            active_users=results[1],
            total_equipment=results[2],
            total_reservations=results[3],
            revenue_today=results[4],
            revenue_this_month=results[5],
            occupancy_rate=results[6],
            avg_rental_duration=results[7]
        )


```


## <a name="RentalAppFASTAPIapiservicesdashboardservicepy"></a>`RentalApp_FASTAPI/api/services/dashboard_service.py`

```python
// path: RentalApp_FASTAPI/api/services/dashboard_service.py

# api/services/dashboard_service.py

# Ğ˜Ğ¼Ğ¿Ğ¾Ñ€Ñ‚Ğ¸Ñ€ÑƒĞµĞ¼ Ğ½Ğ¾Ğ²Ñ‹Ğ¹ Ñ€ĞµÑ„Ğ°ĞºÑ‚Ğ¾Ñ€ĞµĞ½Ğ½Ñ‹Ğ¹ ÑĞµÑ€Ğ²Ğ¸Ñ
from .dashboard.dashboard_service import DashboardService


```


## <a name="RentalAppFASTAPIapiservicesdiscountservicepy"></a>`RentalApp_FASTAPI/api/services/discount_service.py`

```python
// path: RentalApp_FASTAPI/api/services/discount_service.py

# api/services/discount_service.py

from sqlalchemy.ext.asyncio import AsyncSession
from sqlalchemy import desc, select
from api.models.discount import DurationDiscount

async def get_duration_discount_percentage(db: AsyncSession, days: int) -> int:
    """
    ĞŸĞ¾Ğ»ÑƒÑ‡Ğ°ĞµÑ‚ Ğ¿Ñ€Ğ¾Ñ†ĞµĞ½Ñ‚ ÑĞºĞ¸Ğ´ĞºĞ¸ Ğ·Ğ° Ğ´Ğ»Ğ¸Ñ‚ĞµĞ»ÑŒĞ½Ğ¾ÑÑ‚ÑŒ Ğ°Ñ€ĞµĞ½Ğ´Ñ‹ Ğ¸Ğ· Ğ±Ğ°Ğ·Ñ‹ Ğ´Ğ°Ğ½Ğ½Ñ‹Ñ….
    ĞĞ°Ñ…Ğ¾Ğ´Ğ¸Ñ‚ Ğ½Ğ°Ğ¸Ğ±Ğ¾Ğ»ĞµĞµ Ğ¿Ğ¾Ğ´Ñ…Ğ¾Ğ´ÑÑ‰ÑƒÑ ÑĞºĞ¸Ğ´ĞºÑƒ Ğ´Ğ»Ñ Ğ·Ğ°Ğ´Ğ°Ğ½Ğ½Ğ¾Ğ³Ğ¾ ĞºĞ¾Ğ»Ğ¸Ñ‡ĞµÑÑ‚Ğ²Ğ° Ğ´Ğ½ĞµĞ¹.
    """
    if days <= 0:
        return 0

    # Ğ˜Ñ‰ĞµĞ¼ Ğ½Ğ°Ğ¸Ğ±Ğ¾Ğ»ĞµĞµ Ğ¿Ğ¾Ğ´Ñ…Ğ¾Ğ´ÑÑ‰ÑƒÑ Ğ·Ğ°Ğ¿Ğ¸ÑÑŒ Ğ¾ ÑĞºĞ¸Ğ´ĞºĞµ,
    # Ğ³Ğ´Ğµ min_days Ğ½Ğµ Ğ¿Ñ€ĞµĞ²Ñ‹ÑˆĞ°ĞµÑ‚ ĞºĞ¾Ğ»Ğ¸Ñ‡ĞµÑÑ‚Ğ²Ğ¾ Ğ´Ğ½ĞµĞ¹ Ğ°Ñ€ĞµĞ½Ğ´Ñ‹.
    # Ğ¡Ğ¾Ñ€Ñ‚Ğ¸Ñ€ÑƒĞµĞ¼ Ğ¿Ğ¾ ÑƒĞ±Ñ‹Ğ²Ğ°Ğ½Ğ¸Ñ, Ñ‡Ñ‚Ğ¾Ğ±Ñ‹ Ğ¿ĞµÑ€Ğ²Ğ¾Ğ¹ Ğ½Ğ°Ğ¹Ñ‚Ğ¸ ÑĞ°Ğ¼ÑƒÑ Ğ±Ğ¾Ğ»ÑŒÑˆÑƒÑ Ğ¿Ğ¾Ğ´Ñ…Ğ¾Ğ´ÑÑ‰ÑƒÑ ÑĞºĞ¸Ğ´ĞºÑƒ.
    result = await db.execute(
        select(DurationDiscount)
        .filter(DurationDiscount.min_days <= days)
        .order_by(desc(DurationDiscount.min_days))
    )
    discount = result.scalars().first()

    if discount:
        return discount.discount_percentage

    return 0

```


## <a name="RentalAppFASTAPIapiservicesequipmentquerybuilderpy"></a>`RentalApp_FASTAPI/api/services/equipment_query_builder.py`

```python
// path: RentalApp_FASTAPI/api/services/equipment_query_builder.py

# api/services/equipment_query_builder.py

from typing import Optional, List
from sqlalchemy.ext.asyncio import AsyncSession
from sqlalchemy.orm import selectinload
from sqlalchemy import or_, and_, select, func
from datetime import date

from api.models.equipment import Equipment
from api.models.association import Association


class EquipmentQueryBuilder:
    """
    ĞšĞ»Ğ°ÑÑ Ğ´Ğ»Ñ Ğ¿Ğ¾ÑÑ‚Ñ€Ğ¾ĞµĞ½Ğ¸Ñ Ğ·Ğ°Ğ¿Ñ€Ğ¾ÑĞ¾Ğ² Ğº Ğ¾Ğ±Ğ¾Ñ€ÑƒĞ´Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ Ñ Ğ¿Ğ¾Ğ´Ğ´ĞµÑ€Ğ¶ĞºĞ¾Ğ¹ Ñ€Ğ°Ğ·Ğ»Ğ¸Ñ‡Ğ½Ñ‹Ñ… Ñ„Ğ¸Ğ»ÑŒÑ‚Ñ€Ğ¾Ğ².
    Ğ ĞµĞ°Ğ»Ğ¸Ğ·ÑƒĞµÑ‚ Ğ¿Ğ°Ñ‚Ñ‚ĞµÑ€Ğ½ Builder Ğ´Ğ»Ñ ÑĞ¾Ğ·Ğ´Ğ°Ğ½Ğ¸Ñ ÑĞ»Ğ¾Ğ¶Ğ½Ñ‹Ñ… SQL-Ğ·Ğ°Ğ¿Ñ€Ğ¾ÑĞ¾Ğ².
    """

    def __init__(self, db_session: AsyncSession):
        """
        Ğ˜Ğ½Ğ¸Ñ†Ğ¸Ğ°Ğ»Ğ¸Ğ·Ğ°Ñ†Ğ¸Ñ Ğ±Ğ¸Ğ»Ğ´ĞµÑ€Ğ° Ğ·Ğ°Ğ¿Ñ€Ğ¾ÑĞ¾Ğ².

        Args:
            db_session: Ğ¡ĞµÑÑĞ¸Ñ SQLAlchemy Ğ´Ğ»Ñ Ğ²Ñ‹Ğ¿Ğ¾Ğ»Ğ½ĞµĞ½Ğ¸Ñ Ğ·Ğ°Ğ¿Ñ€Ğ¾ÑĞ¾Ğ²
        """
        self.db_session = db_session
        # Ğ¡Ğ¾Ğ·Ğ´Ğ°ĞµĞ¼ Ğ±Ğ°Ğ·Ğ¾Ğ²Ñ‹Ğ¹ Ğ·Ğ°Ğ¿Ñ€Ğ¾Ñ Ğ¾Ğ´Ğ¸Ğ½ Ñ€Ğ°Ğ· Ğ¿Ñ€Ğ¸ Ğ¸Ğ½Ğ¸Ñ†Ğ¸Ğ°Ğ»Ğ¸Ğ·Ğ°Ñ†Ğ¸Ğ¸
        self.query = self._get_base_query()

    def _get_base_query(self):
        """
        Ğ’Ğ¾Ğ·Ğ²Ñ€Ğ°Ñ‰Ğ°ĞµÑ‚ Ğ±Ğ°Ğ·Ğ¾Ğ²Ñ‹Ğ¹ Ğ·Ğ°Ğ¿Ñ€Ğ¾Ñ Ñ Ğ½ĞµĞ¾Ğ±Ñ…Ğ¾Ğ´Ğ¸Ğ¼Ñ‹Ğ¼Ğ¸ options Ğ´Ğ»Ñ Ğ·Ğ°Ğ³Ñ€ÑƒĞ·ĞºĞ¸ ÑĞ²ÑĞ·Ğ°Ğ½Ğ½Ñ‹Ñ… Ğ´Ğ°Ğ½Ğ½Ñ‹Ñ….

        Returns:
            Ğ‘Ğ°Ğ·Ğ¾Ğ²Ñ‹Ğ¹ select Ğ·Ğ°Ğ¿Ñ€Ğ¾Ñ Ğ´Ğ»Ñ Equipment
        """
        return select(Equipment).options(
            selectinload(Equipment.accessories),
            selectinload(Equipment.associations)
        )

    def apply_search(self, query_str: str):
        """
        ĞŸÑ€Ğ¸Ğ¼ĞµĞ½ÑĞµÑ‚ Ñ‚ĞµĞºÑÑ‚Ğ¾Ğ²Ñ‹Ğ¹ Ğ¿Ğ¾Ğ¸ÑĞº Ğ¿Ğ¾ Ğ½Ğ°Ğ·Ğ²Ğ°Ğ½Ğ¸Ñ, Ğ±Ñ€ĞµĞ½Ğ´Ñƒ Ğ¸ Ñ‚Ğ¸Ğ¿Ñƒ Ğ¾Ğ±Ğ¾Ñ€ÑƒĞ´Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ.

        Args:
            query_str: Ğ¡Ñ‚Ñ€Ğ¾ĞºĞ° Ğ¿Ğ¾Ğ¸ÑĞºĞ°

        Returns:
            self Ğ´Ğ»Ñ Ğ¿Ğ¾Ğ´Ğ´ĞµÑ€Ğ¶ĞºĞ¸ Ñ†ĞµĞ¿Ğ¾Ñ‡ĞºĞ¸ Ğ²Ñ‹Ğ·Ğ¾Ğ²Ğ¾Ğ²
        """
        if query_str:
            search_term = f"%{query_str.lower()}%"
            self.query = self.query.filter(
                or_(
                    Equipment.name.ilike(search_term),
                    Equipment.brand.ilike(search_term),
                    Equipment.equipment_type.ilike(search_term)
                )
            )
        return self

    def apply_type(self, equipment_type: str):
        """
        ĞŸÑ€Ğ¸Ğ¼ĞµĞ½ÑĞµÑ‚ Ñ„Ğ¸Ğ»ÑŒÑ‚Ñ€ Ğ¿Ğ¾ Ñ‚Ğ¸Ğ¿Ñƒ Ğ¾Ğ±Ğ¾Ñ€ÑƒĞ´Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ.

        Args:
            equipment_type: Ğ¢Ğ¸Ğ¿ Ğ¾Ğ±Ğ¾Ñ€ÑƒĞ´Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ Ğ´Ğ»Ñ Ñ„Ğ¸Ğ»ÑŒÑ‚Ñ€Ğ°Ñ†Ğ¸Ğ¸

        Returns:
            self Ğ´Ğ»Ñ Ğ¿Ğ¾Ğ´Ğ´ĞµÑ€Ğ¶ĞºĞ¸ Ñ†ĞµĞ¿Ğ¾Ñ‡ĞºĞ¸ Ğ²Ñ‹Ğ·Ğ¾Ğ²Ğ¾Ğ²
        """
        if equipment_type:
            self.query = self.query.filter(Equipment.equipment_type == equipment_type)
        return self

    def apply_brand(self, brand: str):
        """
        ĞŸÑ€Ğ¸Ğ¼ĞµĞ½ÑĞµÑ‚ Ñ„Ğ¸Ğ»ÑŒÑ‚Ñ€ Ğ¿Ğ¾ Ğ±Ñ€ĞµĞ½Ğ´Ñƒ Ğ¾Ğ±Ğ¾Ñ€ÑƒĞ´Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ.

        Args:
            brand: Ğ‘Ñ€ĞµĞ½Ğ´ Ğ¾Ğ±Ğ¾Ñ€ÑƒĞ´Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ Ğ´Ğ»Ñ Ñ„Ğ¸Ğ»ÑŒÑ‚Ñ€Ğ°Ñ†Ğ¸Ğ¸

        Returns:
            self Ğ´Ğ»Ñ Ğ¿Ğ¾Ğ´Ğ´ĞµÑ€Ğ¶ĞºĞ¸ Ñ†ĞµĞ¿Ğ¾Ñ‡ĞºĞ¸ Ğ²Ñ‹Ğ·Ğ¾Ğ²Ğ¾Ğ²
        """
        if brand and brand != "__all__":
            self.query = self.query.filter(Equipment.brand == brand)
        return self

    def apply_association(self, association_id: int):
        """
        ĞŸÑ€Ğ¸Ğ¼ĞµĞ½ÑĞµÑ‚ Ñ„Ğ¸Ğ»ÑŒÑ‚Ñ€ Ğ¿Ğ¾ Ğ°ÑÑĞ¾Ñ†Ğ¸Ğ°Ñ†Ğ¸Ğ¸.

        Args:
            association_id: ID Ğ°ÑÑĞ¾Ñ†Ğ¸Ğ°Ñ†Ğ¸Ğ¸ Ğ´Ğ»Ñ Ñ„Ğ¸Ğ»ÑŒÑ‚Ñ€Ğ°Ñ†Ğ¸Ğ¸

        Returns:
            self Ğ´Ğ»Ñ Ğ¿Ğ¾Ğ´Ğ´ĞµÑ€Ğ¶ĞºĞ¸ Ñ†ĞµĞ¿Ğ¾Ñ‡ĞºĞ¸ Ğ²Ñ‹Ğ·Ğ¾Ğ²Ğ¾Ğ²
        """
        if association_id:
            self.query = self.query.join(Equipment.associations).filter(Association.id == association_id)
        return self

    def apply_availability(self, start_date: date, end_date: date, exclude_reservation_id: int | None = None, exclude_rental_id: int | None = None):
        """
        ĞŸÑ€Ğ¸Ğ¼ĞµĞ½ÑĞµÑ‚ Ñ„Ğ¸Ğ»ÑŒÑ‚Ñ€ Ğ¿Ğ¾ Ğ´Ğ¾ÑÑ‚ÑƒĞ¿Ğ½Ğ¾ÑÑ‚Ğ¸ Ğ¾Ğ±Ğ¾Ñ€ÑƒĞ´Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ Ğ² ÑƒĞºĞ°Ğ·Ğ°Ğ½Ğ½Ñ‹Ğ¹ Ğ¿ĞµÑ€Ğ¸Ğ¾Ğ´.
        Ğ˜ÑĞ¿Ğ¾Ğ»ÑŒĞ·ÑƒĞµÑ‚ AvailabilityService Ğ´Ğ»Ñ Ğ¿Ğ¾Ğ»ÑƒÑ‡ĞµĞ½Ğ¸Ñ SQLAlchemy Ñ„Ğ¸Ğ»ÑŒÑ‚Ñ€Ğ°.

        Args:
            start_date: Ğ”Ğ°Ñ‚Ğ° Ğ½Ğ°Ñ‡Ğ°Ğ»Ğ° Ğ¿ĞµÑ€Ğ¸Ğ¾Ğ´Ğ°
            end_date: Ğ”Ğ°Ñ‚Ğ° Ğ¾ĞºĞ¾Ğ½Ñ‡Ğ°Ğ½Ğ¸Ñ Ğ¿ĞµÑ€Ğ¸Ğ¾Ğ´Ğ°
            exclude_reservation_id: ID Ñ€ĞµĞ·ĞµÑ€Ğ²Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ Ğ´Ğ»Ñ Ğ¸ÑĞºĞ»ÑÑ‡ĞµĞ½Ğ¸Ñ
            exclude_rental_id: ID Ğ°Ñ€ĞµĞ½Ğ´Ñ‹ Ğ´Ğ»Ñ Ğ¸ÑĞºĞ»ÑÑ‡ĞµĞ½Ğ¸Ñ

        Returns:
            self Ğ´Ğ»Ñ Ğ¿Ğ¾Ğ´Ğ´ĞµÑ€Ğ¶ĞºĞ¸ Ñ†ĞµĞ¿Ğ¾Ñ‡ĞºĞ¸ Ğ²Ñ‹Ğ·Ğ¾Ğ²Ğ¾Ğ²
        """
        if not start_date or not end_date:
            return self

        # Ğ˜ÑĞ¿Ğ¾Ğ»ÑŒĞ·ÑƒĞµĞ¼ AvailabilityService Ğ´Ğ»Ñ Ğ¿Ğ¾Ğ»ÑƒÑ‡ĞµĞ½Ğ¸Ñ Ñ„Ğ¸Ğ»ÑŒÑ‚Ñ€Ğ°
        from api.services.availability import AvailabilityService
        availability_service = AvailabilityService(self.db_session)
        
        availability_filter = availability_service.get_sqlalchemy_filter_for_available_equipment(
            start_date, end_date, exclude_reservation_id, exclude_rental_id
        )
        
        self.query = self.query.filter(availability_filter)
        return self

    async def count(self) -> int:
        """
        Ğ’Ñ‹Ğ¿Ğ¾Ğ»Ğ½ÑĞµÑ‚ Ğ¿Ğ¾Ğ´ÑÑ‡ĞµÑ‚ Ğ¾Ğ±Ñ‰ĞµĞ³Ğ¾ ĞºĞ¾Ğ»Ğ¸Ñ‡ĞµÑÑ‚Ğ²Ğ° Ğ·Ğ°Ğ¿Ğ¸ÑĞµĞ¹ Ğ¿Ğ¾ Ğ¿Ğ¾ÑÑ‚Ñ€Ğ¾ĞµĞ½Ğ½Ğ¾Ğ¼Ñƒ Ğ·Ğ°Ğ¿Ñ€Ğ¾ÑÑƒ.

        Returns:
            ĞĞ±Ñ‰ĞµĞµ ĞºĞ¾Ğ»Ğ¸Ñ‡ĞµÑÑ‚Ğ²Ğ¾ Ğ·Ğ°Ğ¿Ğ¸ÑĞµĞ¹
        """
        count_query = select(func.count()).select_from(self.query.subquery())
        result = await self.db_session.execute(count_query)
        return result.scalar_one()

    async def paginate(self, skip: int, limit: int) -> List[Equipment]:
        """
        Ğ’Ñ‹Ğ¿Ğ¾Ğ»Ğ½ÑĞµÑ‚ Ğ¿Ğ°Ğ³Ğ¸Ğ½Ğ°Ñ†Ğ¸Ñ Ğ·Ğ°Ğ¿Ñ€Ğ¾ÑĞ° Ğ¸ Ğ²Ğ¾Ğ·Ğ²Ñ€Ğ°Ñ‰Ğ°ĞµÑ‚ ÑĞ¿Ğ¸ÑĞ¾Ğº Ğ¾Ğ±Ğ¾Ñ€ÑƒĞ´Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ.

        Args:
            skip: ĞšĞ¾Ğ»Ğ¸Ñ‡ĞµÑÑ‚Ğ²Ğ¾ Ğ·Ğ°Ğ¿Ğ¸ÑĞµĞ¹ Ğ´Ğ»Ñ Ğ¿Ñ€Ğ¾Ğ¿ÑƒÑĞºĞ°
            limit: ĞœĞ°ĞºÑĞ¸Ğ¼Ğ°Ğ»ÑŒĞ½Ğ¾Ğµ ĞºĞ¾Ğ»Ğ¸Ñ‡ĞµÑÑ‚Ğ²Ğ¾ Ğ·Ğ°Ğ¿Ğ¸ÑĞµĞ¹ Ğ´Ğ»Ñ Ğ²Ğ¾Ğ·Ğ²Ñ€Ğ°Ñ‚Ğ°

        Returns:
            Ğ¡Ğ¿Ğ¸ÑĞ¾Ğº Ğ¾Ğ±ÑŠĞµĞºÑ‚Ğ¾Ğ² Equipment
        """
        paginated_query = self.query.order_by(Equipment.name).offset(skip).limit(limit)
        result = await self.db_session.execute(paginated_query)
        return result.unique().scalars().all()

```


## <a name="RentalAppFASTAPIapiservicesequipmentserviceapipy"></a>`RentalApp_FASTAPI/api/services/equipment_service_api.py`

```python
// path: RentalApp_FASTAPI/api/services/equipment_service_api.py

# api/services/equipment_service_api.py

from typing import List, Type, Optional
from sqlalchemy.ext.asyncio import AsyncSession
from sqlalchemy.orm import joinedload, selectinload
from sqlalchemy import or_, and_, select, func
from fastapi import HTTPException
from datetime import date

from api.models.equipment import Equipment
from api.models.accessory import Accessory
from api.models.association import Association
from api.models.reservation import Reservation
from api.models.rental import Rental
from shared.schemas.equipment_schema import EquipmentUpdateExtended
from api.services.equipment_query_builder import EquipmentQueryBuilder

async def get_all_equipment(db: AsyncSession) -> list[Type[Equipment]]:
    """Ğ’Ğ¾Ğ·Ğ²Ñ€Ğ°Ñ‰Ğ°ĞµÑ‚ QuerySet Ğ²ÑĞµĞ³Ğ¾ Ğ¾Ğ±Ğ¾Ñ€ÑƒĞ´Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ Ñ Ğ¿Ğ¾Ğ´Ğ³Ñ€ÑƒĞ·ĞºĞ¾Ğ¹ ÑĞ²ÑĞ·ĞµĞ¹."""
    result = await db.execute(
        select(Equipment).options(
            joinedload(Equipment.accessories),
            joinedload(Equipment.associations)
        )
    )
    equipment_list = result.unique().scalars().all()
    
    # Ğ”Ğ¾Ğ¿Ğ¾Ğ»Ğ½Ğ¸Ñ‚ĞµĞ»ÑŒĞ½Ğ°Ñ Ğ·Ğ°Ñ‰Ğ¸Ñ‚Ğ°: ÑƒĞ±ĞµĞ¶Ğ´Ğ°ĞµĞ¼ÑÑ, Ñ‡Ñ‚Ğ¾ Ğ²ÑĞµ Ğ¿Ğ¾Ğ»Ñ ĞºĞ¾Ñ€Ñ€ĞµĞºÑ‚Ğ½Ñ‹
    for equipment in equipment_list:
        if equipment.name is None:
            equipment.name = "ĞĞµĞ¸Ğ·Ğ²ĞµÑÑ‚Ğ½Ğ¾Ğµ Ğ¾Ğ±Ğ¾Ñ€ÑƒĞ´Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ"
        if equipment.daily_rate is None:
            equipment.daily_rate = 0.0
        if equipment.condition is None:
            equipment.condition = "Ğ’ĞµĞ»Ğ¸ĞºĞ¾Ğ»ĞµĞ¿Ğ½Ğ¾"
    
    return equipment_list


async def get_paginated_equipment(
        db: AsyncSession,
        skip: int,
        limit: int,
        query: Optional[str] = None,
        type: Optional[str] = None,
        brand: Optional[str] = None,
        association_id: Optional[int] = None,
        start_date: Optional[date] = None,
        end_date: Optional[date] = None,
        available_only: bool = False
) -> (List[Equipment], int):
    """
    Ğ’Ğ¾Ğ·Ğ²Ñ€Ğ°Ñ‰Ğ°ĞµÑ‚ Ğ¾Ñ‚Ñ„Ğ¸Ğ»ÑŒÑ‚Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ½Ñ‹Ğ¹ Ğ¸ Ğ¿Ğ°Ğ³Ğ¸Ğ½Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ½Ñ‹Ğ¹ ÑĞ¿Ğ¸ÑĞ¾Ğº Ğ¾Ğ±Ğ¾Ñ€ÑƒĞ´Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ Ğ¸ Ğ¸Ñ… Ğ¾Ğ±Ñ‰ĞµĞµ ĞºĞ¾Ğ»Ğ¸Ñ‡ĞµÑÑ‚Ğ²Ğ¾.
    Ğ˜ÑĞ¿Ğ¾Ğ»ÑŒĞ·ÑƒĞµÑ‚ EquipmentQueryBuilder Ğ´Ğ»Ñ Ğ¿Ğ¾ÑÑ‚Ñ€Ğ¾ĞµĞ½Ğ¸Ñ Ğ·Ğ°Ğ¿Ñ€Ğ¾ÑĞ¾Ğ² Ñ Ñ€Ğ°Ğ·Ğ»Ğ¸Ñ‡Ğ½Ñ‹Ğ¼Ğ¸ Ñ„Ğ¸Ğ»ÑŒÑ‚Ñ€Ğ°Ğ¼Ğ¸.
    """
    # Ğ’Ğ°Ğ»Ğ¸Ğ´Ğ°Ñ†Ğ¸Ñ Ğ´Ğ°Ñ‚ Ğ½Ğ° ÑƒÑ€Ğ¾Ğ²Ğ½Ğµ ÑĞµÑ€Ğ²Ğ¸ÑĞ°
    if available_only and start_date and end_date:
        if start_date >= end_date:
            raise HTTPException(
                status_code=400, 
                detail="Ğ”Ğ°Ñ‚Ğ° Ğ½Ğ°Ñ‡Ğ°Ğ»Ğ° Ğ´Ğ¾Ğ»Ğ¶Ğ½Ğ° Ğ±Ñ‹Ñ‚ÑŒ Ñ€Ğ°Ğ½ÑŒÑˆĞµ Ğ´Ğ°Ñ‚Ñ‹ Ğ¾ĞºĞ¾Ğ½Ñ‡Ğ°Ğ½Ğ¸Ñ."
            )
    
    # Ğ¡Ğ¾Ğ·Ğ´Ğ°ĞµĞ¼ ÑĞºĞ·ĞµĞ¼Ğ¿Ğ»ÑÑ€ Ğ±Ğ¸Ğ»Ğ´ĞµÑ€Ğ° Ğ·Ğ°Ğ¿Ñ€Ğ¾ÑĞ¾Ğ²
    query_builder = EquipmentQueryBuilder(db)
    
    # ĞŸÑ€Ğ¸Ğ¼ĞµĞ½ÑĞµĞ¼ Ñ„Ğ¸Ğ»ÑŒÑ‚Ñ€Ñ‹ Ñ Ğ¸ÑĞ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ğ½Ğ¸ĞµĞ¼ Ñ†ĞµĞ¿Ğ¾Ñ‡ĞºĞ¸ Ğ²Ñ‹Ğ·Ğ¾Ğ²Ğ¾Ğ² (Builder Pattern)
    query_builder.apply_search(query)\
                 .apply_type(type)\
                 .apply_brand(brand)\
                 .apply_association(association_id)
    
    # ĞŸÑ€Ğ¸Ğ¼ĞµĞ½ÑĞµĞ¼ Ñ„Ğ¸Ğ»ÑŒÑ‚Ñ€ Ğ´Ğ¾ÑÑ‚ÑƒĞ¿Ğ½Ğ¾ÑÑ‚Ğ¸, ĞµÑĞ»Ğ¸ Ğ½ĞµĞ¾Ğ±Ñ…Ğ¾Ğ´Ğ¸Ğ¼Ğ¾
    if available_only and start_date and end_date:
        query_builder.apply_availability(start_date, end_date)
    
    # ĞŸĞ¾Ğ»ÑƒÑ‡Ğ°ĞµĞ¼ Ğ¾Ğ±Ñ‰ĞµĞµ ĞºĞ¾Ğ»Ğ¸Ñ‡ĞµÑÑ‚Ğ²Ğ¾ Ğ¸ Ğ¿Ğ°Ğ³Ğ¸Ğ½Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ½Ñ‹Ğµ Ñ€ĞµĞ·ÑƒĞ»ÑŒÑ‚Ğ°Ñ‚Ñ‹
    total = await query_builder.count()
    items = await query_builder.paginate(skip, limit)
    
    # Ğ”Ğ¾Ğ¿Ğ¾Ğ»Ğ½Ğ¸Ñ‚ĞµĞ»ÑŒĞ½Ğ°Ñ Ğ·Ğ°Ñ‰Ğ¸Ñ‚Ğ°: ÑƒĞ±ĞµĞ¶Ğ´Ğ°ĞµĞ¼ÑÑ, Ñ‡Ñ‚Ğ¾ Ğ²ÑĞµ Ğ¿Ğ¾Ğ»Ñ ĞºĞ¾Ñ€Ñ€ĞµĞºÑ‚Ğ½Ñ‹
    for equipment in items:
        if equipment.name is None:
            equipment.name = "ĞĞµĞ¸Ğ·Ğ²ĞµÑÑ‚Ğ½Ğ¾Ğµ Ğ¾Ğ±Ğ¾Ñ€ÑƒĞ´Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ"
        if equipment.daily_rate is None:
            equipment.daily_rate = 0.0
        if equipment.condition is None:
            equipment.condition = "Ğ’ĞµĞ»Ğ¸ĞºĞ¾Ğ»ĞµĞ¿Ğ½Ğ¾"
    
    return items, total


async def update_equipment_details(db: AsyncSession, equipment_id: int, equipment_data: EquipmentUpdateExtended) -> Equipment:
    result = await db.execute(
        select(Equipment)
        .filter(Equipment.id == equipment_id)
        .options(
            selectinload(Equipment.accessories),
            selectinload(Equipment.associations)
        )
    )
    db_equipment = result.scalars().first()
    if not db_equipment:
        raise HTTPException(status_code=404, detail="ĞĞ±Ğ¾Ñ€ÑƒĞ´Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ Ğ½Ğµ Ğ½Ğ°Ğ¹Ğ´ĞµĞ½Ğ¾")

    update_data = equipment_data.model_dump(exclude_unset=True)

    if "accessory_ids" in update_data:
        accessory_ids = update_data.pop("accessory_ids")
        db_equipment.accessories.clear()
        await db.flush()
        if accessory_ids:
            accessories_result = await db.execute(select(Accessory).filter(Accessory.id.in_(accessory_ids)))
            found_accessories = accessories_result.unique().scalars().all()
            if len(found_accessories) != len(accessory_ids):
                raise HTTPException(status_code=404, detail="ĞĞ´Ğ¸Ğ½ Ğ¸Ğ»Ğ¸ Ğ½ĞµÑĞºĞ¾Ğ»ÑŒĞºĞ¾ Ğ°ĞºÑĞµÑÑÑƒĞ°Ñ€Ğ¾Ğ² Ñ ÑƒĞºĞ°Ğ·Ğ°Ğ½Ğ½Ñ‹Ğ¼Ğ¸ ID Ğ½Ğµ Ğ½Ğ°Ğ¹Ğ´ĞµĞ½Ñ‹")
            db_equipment.accessories.extend(found_accessories)

    if "association_ids" in update_data:
        association_ids = update_data.pop("association_ids")
        db_equipment.associations.clear()
        await db.flush()
        if association_ids:
            associations_result = await db.execute(select(Association).filter(Association.id.in_(association_ids)))
            found_associations = associations_result.unique().scalars().all()
            if len(found_associations) != len(association_ids):
                raise HTTPException(status_code=404, detail="ĞĞ´Ğ½Ğ° Ğ¸Ğ»Ğ¸ Ğ½ĞµÑĞºĞ¾Ğ»ÑŒĞºĞ¾ Ğ°ÑÑĞ¾Ñ†Ğ¸Ğ°Ñ†Ğ¸Ğ¹ Ñ ÑƒĞºĞ°Ğ·Ğ°Ğ½Ğ½Ñ‹Ğ¼Ğ¸ ID Ğ½Ğµ Ğ½Ğ°Ğ¹Ğ´ĞµĞ½Ñ‹")
            db_equipment.associations.extend(found_associations)

    for key, value in update_data.items():
        setattr(db_equipment, key, value)

    db.add(db_equipment)
    await db.commit()
    await db.refresh(db_equipment)
    
    # Ğ’Ğ¾Ğ·Ğ²Ñ€Ğ°Ñ‰Ğ°ĞµĞ¼ Ğ¾Ğ±Ğ½Ğ¾Ğ²Ğ»ĞµĞ½Ğ½Ñ‹Ğ¹ Ğ¾Ğ±ÑŠĞµĞºÑ‚ Ñ Ğ·Ğ°Ğ³Ñ€ÑƒĞ¶ĞµĞ½Ğ½Ñ‹Ğ¼Ğ¸ Ğ´Ğ°Ğ½Ğ½Ñ‹Ğ¼Ğ¸ Ğ¸Ğ· Ğ‘Ğ”
    result = await db.execute(
        select(Equipment)
        .filter(Equipment.id == equipment_id)
        .options(
            selectinload(Equipment.accessories),
            selectinload(Equipment.associations)
        )
    )
    return result.scalars().first()

```


## <a name="RentalAppFASTAPIapiservicesfinancialservicepy"></a>`RentalApp_FASTAPI/api/services/financial_service.py`

```python
// path: RentalApp_FASTAPI/api/services/financial_service.py

# api/services/financial_service.py

from sqlalchemy.ext.asyncio import AsyncSession
from sqlalchemy import select, func
from sqlalchemy.orm import selectinload
from datetime import date, timedelta
from typing import List, Dict, Optional, NamedTuple, Union
from fastapi import HTTPException
import logging

from api.models.equipment import Equipment
from api.models.promo_code import PromoCode
from api.models.accessory import Accessory
from api.models.holiday import Holiday
from api.models.rental import Rental
from api.models.reservation import Reservation
from .discount_service import get_duration_discount_percentage
from .promo_code import PromoCodeBusinessLogic
from shared.schemas.rental_schema import RentalOut
from shared.schemas.reservation_schema import AdminReservationOut, ReservationItem

logger = logging.getLogger(__name__)


class PriceDetails(NamedTuple):
    """Ğ¡Ñ‚Ñ€ÑƒĞºÑ‚ÑƒÑ€Ğ° Ğ´Ğ»Ñ Ğ²Ğ¾Ğ·Ğ²Ñ€Ğ°Ñ‚Ğ° Ğ´ĞµÑ‚Ğ°Ğ»Ğ¸Ğ·Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ½Ğ¾Ğ¹ Ğ¸Ğ½Ñ„Ğ¾Ñ€Ğ¼Ğ°Ñ†Ğ¸Ğ¸ Ğ¾ Ñ†ĞµĞ½Ğµ."""
    full_total: float
    discount_amount: float
    final_total: float


class FinancialService:
    """
    Ğ•Ğ´Ğ¸Ğ½Ñ‹Ğ¹ ÑĞµÑ€Ğ²Ğ¸Ñ Ğ´Ğ»Ñ Ğ²ÑĞµÑ… Ñ„Ğ¸Ğ½Ğ°Ğ½ÑĞ¾Ğ²Ñ‹Ñ… Ñ€Ğ°ÑÑ‡ĞµÑ‚Ğ¾Ğ² Ğ¸ Ğ¾Ğ±Ğ¾Ğ³Ğ°Ñ‰ĞµĞ½Ğ¸Ñ Ğ´Ğ°Ğ½Ğ½Ñ‹Ñ….
    ĞĞ±ÑŠĞµĞ´Ğ¸Ğ½ÑĞµÑ‚ Ğ»Ğ¾Ğ³Ğ¸ĞºÑƒ Ğ¸Ğ· price_calculation_service Ğ¸ rental_calculation_service.
    """

    def __init__(self, db: AsyncSession):
        self.db = db

    # --- ĞœĞµÑ‚Ğ¾Ğ´Ñ‹ Ñ€Ğ°ÑÑ‡ĞµÑ‚Ğ° ÑÑ‚Ğ¾Ğ¸Ğ¼Ğ¾ÑÑ‚Ğ¸ (Ğ¸Ğ· price_calculation_service) ---

    async def find_next_working_day(self, start_date: date) -> date:
        """ĞĞ°Ñ…Ğ¾Ğ´Ğ¸Ñ‚ Ğ±Ğ»Ğ¸Ğ¶Ğ°Ğ¹ÑˆÑƒÑ ÑĞ»ĞµĞ´ÑƒÑÑ‰ÑƒÑ Ğ´Ğ°Ñ‚Ñƒ, ĞºĞ¾Ñ‚Ğ¾Ñ€Ğ°Ñ Ğ½Ğµ ÑĞ²Ğ»ÑĞµÑ‚ÑÑ Ğ²Ñ‹Ñ…Ğ¾Ğ´Ğ½Ñ‹Ğ¼."""
        next_day = start_date
        while True:
            result = await self.db.execute(select(Holiday).filter(Holiday.date == next_day))
            if not result.scalars().first():
                break
            next_day += timedelta(days=1)
        return next_day

    def validate_date_range(self, start_date: date, end_date: date):
        """ĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑĞµÑ‚, Ñ‡Ñ‚Ğ¾ ĞºĞ¾Ğ½ĞµÑ‡Ğ½Ğ°Ñ Ğ´Ğ°Ñ‚Ğ° ÑÑ‚Ñ€Ğ¾Ğ³Ğ¾ Ğ±Ğ¾Ğ»ÑŒÑˆĞµ Ğ½Ğ°Ñ‡Ğ°Ğ»ÑŒĞ½Ğ¾Ğ¹."""
        if start_date >= end_date:
            raise HTTPException(
                status_code=400,
                detail="Ğ”Ğ°Ñ‚Ğ° Ğ¾ĞºĞ¾Ğ½Ñ‡Ğ°Ğ½Ğ¸Ñ Ğ´Ğ¾Ğ»Ğ¶Ğ½Ğ° Ğ±Ñ‹Ñ‚ÑŒ Ğ¿Ğ¾Ğ·Ğ¶Ğµ Ğ´Ğ°Ñ‚Ñ‹ Ğ½Ğ°Ñ‡Ğ°Ğ»Ğ°."
            )

    async def validate_holidays(self, start_date: date, end_date: date):
        """ĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑĞµÑ‚, Ñ‡Ñ‚Ğ¾ Ğ´Ğ°Ñ‚Ğ° Ğ½Ğ°Ñ‡Ğ°Ğ»Ğ° Ğ¸Ğ»Ğ¸ Ğ¾ĞºĞ¾Ğ½Ñ‡Ğ°Ğ½Ğ¸Ñ Ñ€ĞµĞ·ĞµÑ€Ğ²Ğ° Ğ½Ğµ Ğ²Ñ‹Ğ¿Ğ°Ğ´Ğ°ĞµÑ‚ Ğ½Ğ° Ğ²Ñ‹Ñ…Ğ¾Ğ´Ğ½Ğ¾Ğ¹."""
        start_result = await self.db.execute(select(Holiday).filter(Holiday.date == start_date))
        is_start_holiday = start_result.scalars().first()
        
        end_result = await self.db.execute(select(Holiday).filter(Holiday.date == end_date))
        is_end_holiday = end_result.scalars().first()
        
        if is_start_holiday or is_end_holiday:
            raise HTTPException(
                status_code=400,
                detail="ĞĞµĞ»ÑŒĞ·Ñ Ğ½Ğ°Ñ‡Ğ°Ñ‚ÑŒ Ğ¸Ğ»Ğ¸ Ğ·Ğ°ĞºĞ¾Ğ½Ñ‡Ğ¸Ñ‚ÑŒ Ñ€ĞµĞ·ĞµÑ€Ğ² Ğ² Ğ²Ñ‹Ñ…Ğ¾Ğ´Ğ½Ğ¾Ğ¹ Ğ´ĞµĞ½ÑŒ."
            )

    async def get_rental_days(self, start_date: date, end_date: date) -> int:
        """Ğ Ğ°ÑÑÑ‡Ğ¸Ñ‚Ñ‹Ğ²Ğ°ĞµÑ‚ ĞºĞ¾Ğ»Ğ¸Ñ‡ĞµÑÑ‚Ğ²Ğ¾ Ñ‚Ğ°Ñ€Ğ¸Ñ„Ğ¸Ñ†Ğ¸Ñ€ÑƒĞµĞ¼Ñ‹Ñ… ÑÑƒÑ‚Ğ¾Ğº, Ğ¸ÑĞºĞ»ÑÑ‡Ğ°Ñ Ğ²Ñ‹Ñ…Ğ¾Ğ´Ğ½Ñ‹Ğµ Ğ´Ğ½Ğ¸."""
        if start_date >= end_date:
            return 0
        total_days = (end_date - start_date).days
        holidays_result = await self.db.execute(
            select(func.count(Holiday.date)).filter(
                Holiday.date > start_date,
                Holiday.date < end_date
            )
        )
        holidays_count = holidays_result.scalar_one()
        return total_days - holidays_count

    async def calculate_final_price(
            self,
            equipment_ids: List[int],
            selected_accessories: Optional[Dict[int, List[int]]],
            start_date: date,
            end_date: date,
            promo_code: Optional[PromoCode]
    ) -> PriceDetails:
        """Ğ Ğ°ÑÑÑ‡Ğ¸Ñ‚Ñ‹Ğ²Ğ°ĞµÑ‚ Ğ¿Ğ¾Ğ»Ğ½ÑƒÑ, Ñ„Ğ¸Ğ½Ğ°Ğ»ÑŒĞ½ÑƒÑ ÑÑ‚Ğ¾Ğ¸Ğ¼Ğ¾ÑÑ‚ÑŒ Ğ·Ğ°ĞºĞ°Ğ·Ğ°, Ğ²ĞºĞ»ÑÑ‡Ğ°Ñ Ğ²ÑĞµ ÑĞºĞ¸Ğ´ĞºĞ¸."""
        if not equipment_ids:
            return PriceDetails(full_total=0.0, discount_amount=0.0, final_total=0.0)

        rental_days = await self.get_rental_days(start_date, end_date)
        if rental_days <= 0:
            return PriceDetails(full_total=0.0, discount_amount=0.0, final_total=0.0)

        equipment_result = await self.db.execute(
            select(Equipment)
            .filter(Equipment.id.in_(equipment_ids))
            .options(
                selectinload(Equipment.accessories),
                selectinload(Equipment.associations)
            )
        )
        selected_equipment = equipment_result.unique().scalars().all()
        base_equipment_cost = sum(item.daily_rate for item in selected_equipment)

        accessories_cost = 0.0
        if selected_accessories:
            all_accessory_ids = [acc_id for equip_accs in selected_accessories.values() for acc_id in equip_accs]
            if all_accessory_ids:
                accessories_result = await self.db.execute(select(Accessory).filter(Accessory.id.in_(all_accessory_ids)))
                found_accessories = accessories_result.unique().scalars().all()
                accessories_cost = sum(acc.price for acc in found_accessories)

        full_total = (base_equipment_cost + accessories_cost) * rental_days
        duration_discount = await get_duration_discount_percentage(self.db, rental_days)
        
        # Ğ˜ÑĞ¿Ğ¾Ğ»ÑŒĞ·ÑƒĞµĞ¼ Ğ½Ğ¾Ğ²ÑƒÑ Ğ°Ñ€Ñ…Ğ¸Ñ‚ĞµĞºÑ‚ÑƒÑ€Ñƒ Ğ¿Ñ€Ğ¾Ğ¼Ğ¾ĞºĞ¾Ğ´Ğ¾Ğ² Ğ´Ğ»Ñ Ñ€Ğ°ÑÑ‡ĞµÑ‚Ğ° ÑĞºĞ¸Ğ´ĞºĞ¸
        promo_discount = 0
        if promo_code:
            business_logic = PromoCodeBusinessLogic(self.db)
            promo_discount = promo_code.discount_percentage
            # Ğ˜ÑĞ¿Ğ¾Ğ»ÑŒĞ·ÑƒĞµĞ¼ Ğ¼ĞµÑ‚Ğ¾Ğ´ Ğ²Ğ°Ğ»Ğ¸Ğ´Ğ°Ñ†Ğ¸Ğ¸ ĞºĞ¾Ğ¼Ğ±Ğ¸Ğ½Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ½Ğ¾Ğ¹ ÑĞºĞ¸Ğ´ĞºĞ¸
            total_discount_percentage = business_logic.validate_combined_discount(
                duration_discount, promo_discount
            )
        else:
            total_discount_percentage = duration_discount

        discount_amount = full_total * (total_discount_percentage / 100)
        final_total = full_total - discount_amount

        return PriceDetails(
            full_total=round(full_total, 2),
            discount_amount=round(discount_amount, 2),
            final_total=round(final_total, 2)
        )

    # --- ĞœĞµÑ‚Ğ¾Ğ´Ñ‹ Ñ€Ğ°ÑÑ‡ĞµÑ‚Ğ° Ğ°Ñ€ĞµĞ½Ğ´Ñ‹ (Ğ¸Ğ· rental_calculation_service) ---

    async def calculate_daily_rate(self, rental: Rental) -> float:
        """
        Ğ Ğ°ÑÑÑ‡Ğ¸Ñ‚Ñ‹Ğ²Ğ°ĞµÑ‚ Ğ´Ğ½ĞµĞ²Ğ½ÑƒÑ ÑÑ‚Ğ°Ğ²ĞºÑƒ Ğ°Ñ€ĞµĞ½Ğ´Ñ‹ Ğ½Ğ° Ğ¾ÑĞ½Ğ¾Ğ²Ğµ Ğ¾Ğ±Ñ‰ĞµĞ¹ ÑÑ‚Ğ¾Ğ¸Ğ¼Ğ¾ÑÑ‚Ğ¸ Ğ¸ Ğ¿Ğ»Ğ°Ğ½Ğ¾Ğ²Ğ¾Ğ³Ğ¾ ĞºĞ¾Ğ»Ğ¸Ñ‡ĞµÑÑ‚Ğ²Ğ° Ğ´Ğ½ĞµĞ¹.
        """
        if rental.total_cost <= 0:
            return 0.0
            
        planned_days = await self.get_rental_days(rental.start_date, rental.end_date)
        if planned_days <= 0:
            return 0.0
            
        return rental.total_cost / planned_days
    
    def calculate_overdue_days(self, rental: Rental, actual_return_date: date) -> int:
        """
        Ğ Ğ°ÑÑÑ‡Ğ¸Ñ‚Ñ‹Ğ²Ğ°ĞµÑ‚ ĞºĞ¾Ğ»Ğ¸Ñ‡ĞµÑÑ‚Ğ²Ğ¾ Ğ¿Ñ€Ğ¾ÑÑ€Ğ¾Ñ‡ĞµĞ½Ğ½Ñ‹Ñ… Ğ´Ğ½ĞµĞ¹.
        """
        if actual_return_date <= rental.end_date:
            return 0
            
        return (actual_return_date - rental.end_date).days
    
    async def calculate_overdue_surcharge(self, rental: Rental, actual_return_date: date) -> float:
        """
        Ğ Ğ°ÑÑÑ‡Ğ¸Ñ‚Ñ‹Ğ²Ğ°ĞµÑ‚ ÑˆÑ‚Ñ€Ğ°Ñ„ Ğ·Ğ° Ğ¿Ñ€Ğ¾ÑÑ€Ğ¾Ñ‡ĞµĞ½Ğ½Ñ‹Ğµ Ğ´Ğ½Ğ¸ Ğ°Ñ€ĞµĞ½Ğ´Ñ‹.
        """
        overdue_days = self.calculate_overdue_days(rental, actual_return_date)
        if overdue_days <= 0:
            return 0.0
            
        daily_rate = await self.calculate_daily_rate(rental)
        if daily_rate <= 0:
            return 0.0
            
        surcharge_amount = daily_rate * overdue_days
        return round(surcharge_amount, 2)
    
    async def calculate_early_return_credit(self, rental: Rental, actual_return_date: date, planned_days: int) -> float:
        """
        Ğ Ğ°ÑÑÑ‡Ğ¸Ñ‚Ñ‹Ğ²Ğ°ĞµÑ‚ ĞºÑ€ĞµĞ´Ğ¸Ñ‚ Ğ·Ğ° Ğ´Ğ¾ÑÑ€Ğ¾Ñ‡Ğ½Ñ‹Ğ¹ Ğ²Ğ¾Ğ·Ğ²Ñ€Ğ°Ñ‚ Ğ°Ñ€ĞµĞ½Ğ´Ñ‹.
        """
        if actual_return_date >= rental.end_date or planned_days <= 0:
            return 0.0

        daily_rate = await self.calculate_daily_rate(rental)
        if daily_rate <= 0:
            return 0.0
            
        # Ğ Ğ°ÑÑÑ‡Ğ¸Ñ‚Ñ‹Ğ²Ğ°ĞµĞ¼ Ğ¸Ğ¼ĞµĞ½Ğ½Ğ¾ Ñ‚Ğ°Ñ€Ğ¸Ñ„Ğ¸Ñ†Ğ¸Ñ€ÑƒĞµĞ¼Ñ‹Ğµ Ğ´Ğ½Ğ¸ Ğ² Ğ¾ÑÑ‚Ğ°Ğ²ÑˆĞµĞ¼ÑÑ Ğ¿ĞµÑ€Ğ¸Ğ¾Ğ´Ğµ
        unused_billable_days = await self.get_rental_days(actual_return_date, rental.end_date)
        if unused_billable_days <= 0:
            return 0.0
            
        credit_amount = unused_billable_days * daily_rate
        return round(credit_amount, 2)
    
    async def get_rental_calculation_summary(self, rental: Rental, actual_return_date: date, planned_days: int) -> dict:
        """
        Ğ’Ğ¾Ğ·Ğ²Ñ€Ğ°Ñ‰Ğ°ĞµÑ‚ Ğ¿Ğ¾Ğ»Ğ½ÑƒÑ ÑĞ²Ğ¾Ğ´ĞºÑƒ Ñ€Ğ°ÑÑ‡ĞµÑ‚Ğ¾Ğ² Ğ´Ğ»Ñ Ğ°Ñ€ĞµĞ½Ğ´Ñ‹.
        """
        daily_rate = await self.calculate_daily_rate(rental)
        overdue_days = self.calculate_overdue_days(rental, actual_return_date)
        surcharge_amount = await self.calculate_overdue_surcharge(rental, actual_return_date)
        credit_amount = await self.calculate_early_return_credit(rental, actual_return_date, planned_days)
        
        return {
            'daily_rate': daily_rate,
            'overdue_days': overdue_days,
            'surcharge_amount': surcharge_amount,
            'credit_amount': credit_amount,
            'is_overdue': overdue_days > 0,
            'is_early_return': actual_return_date < rental.end_date and credit_amount > 0
        }

    # --- Ğ£Ğ½Ğ¸Ğ²ĞµÑ€ÑĞ°Ğ»ÑŒĞ½Ñ‹Ğ¹ Ğ¼ĞµÑ‚Ğ¾Ğ´ Ğ¾Ğ±Ğ¾Ğ³Ğ°Ñ‰ĞµĞ½Ğ¸Ñ Ğ´Ğ°Ğ½Ğ½Ñ‹Ñ… ---

    async def enrich_order_with_financials(self, order: Union[Rental, Reservation]) -> Union[RentalOut, AdminReservationOut, ReservationItem]:
        """
        Ğ£Ğ½Ğ¸Ğ²ĞµÑ€ÑĞ°Ğ»ÑŒĞ½Ñ‹Ğ¹ Ğ¼ĞµÑ‚Ğ¾Ğ´ Ğ´Ğ»Ñ Ğ¾Ğ±Ğ¾Ğ³Ğ°Ñ‰ĞµĞ½Ğ¸Ñ Ğ·Ğ°ĞºĞ°Ğ·Ğ° (Ğ°Ñ€ĞµĞ½Ğ´Ñ‹ Ğ¸Ğ»Ğ¸ Ñ€ĞµĞ·ĞµÑ€Ğ²Ğ°) Ñ„Ğ¸Ğ½Ğ°Ğ½ÑĞ¾Ğ²Ñ‹Ğ¼Ğ¸ Ğ´Ğ°Ğ½Ğ½Ñ‹Ğ¼Ğ¸.
        
        Args:
            order: ORM-Ğ¾Ğ±ÑŠĞµĞºÑ‚ Ğ°Ñ€ĞµĞ½Ğ´Ñ‹ Ğ¸Ğ»Ğ¸ Ñ€ĞµĞ·ĞµÑ€Ğ²Ğ°
            
        Returns:
            Pydantic-ÑÑ…ĞµĞ¼Ğ° Ñ Ğ¿Ğ¾Ğ»Ğ½Ğ¾ÑÑ‚ÑŒÑ Ğ·Ğ°Ğ¿Ğ¾Ğ»Ğ½ĞµĞ½Ğ½Ñ‹Ğ¼Ğ¸ Ñ„Ğ¸Ğ½Ğ°Ğ½ÑĞ¾Ğ²Ñ‹Ğ¼Ğ¸ Ğ´Ğ°Ğ½Ğ½Ñ‹Ğ¼Ğ¸
        """
        if isinstance(order, Rental):
            return await self._enrich_rental_with_financials(order)
        elif isinstance(order, Reservation):
            return await self._enrich_reservation_with_financials(order)
        else:
            raise ValueError(f"Unsupported order type: {type(order)}")

    async def _enrich_rental_with_financials(self, rental: Rental) -> RentalOut:
        """ĞĞ±Ğ¾Ğ³Ğ°Ñ‰Ğ°ĞµÑ‚ Ğ¾Ğ±ÑŠĞµĞºÑ‚ Ğ°Ñ€ĞµĞ½Ğ´Ñ‹ Ñ„Ğ¸Ğ½Ğ°Ğ½ÑĞ¾Ğ²Ñ‹Ğ¼Ğ¸ Ğ´Ğ°Ğ½Ğ½Ñ‹Ğ¼Ğ¸."""
        rental_out = RentalOut.model_validate(rental)
        today = date.today()

        # Ğ”Ğ¸Ğ½Ğ°Ğ¼Ğ¸Ñ‡ĞµÑĞºĞ¸Ğ¹ ÑÑ‚Ğ°Ñ‚ÑƒÑ overdue
        if rental.status == 'active' and rental.end_date < today:
            rental_out.status = 'overdue'

        # Ğ Ğ°ÑÑ‡ĞµÑ‚ Ğ¿Ñ€Ğ¾ÑÑ€Ğ¾Ñ‡ĞºĞ¸ Ğ¸Ğ»Ğ¸ Ğ¾ÑÑ‚Ğ°Ğ²ÑˆĞ¸Ñ…ÑÑ Ğ´Ğ½ĞµĞ¹
        if rental_out.status == 'overdue':
            rental_out.overdue_days = self.calculate_overdue_days(rental, today)
            rental_out.overdue_surcharge = await self.calculate_overdue_surcharge(rental, today)
        elif rental.status == 'active':
            rental_out.days_remaining = (rental.end_date - today).days

        # Ğ Ğ°ÑÑ‡ĞµÑ‚ ÑÑ‚Ğ¾Ğ¸Ğ¼Ğ¾ÑÑ‚Ğ¸ Ğ°ĞºÑĞµÑÑÑƒĞ°Ñ€Ğ¾Ğ²
        accessories_cost = 0.0
        for accessory_link in rental.accessory_links:
            if accessory_link.accessory and accessory_link.accessory.price:
                accessories_cost += accessory_link.accessory.price
        rental_out.accessories_cost = accessories_cost

        # Ğ Ğ°ÑÑ‡ĞµÑ‚ Ğ¾ÑÑ‚Ğ°Ñ‚ĞºĞ° Ğº Ğ¾Ğ¿Ğ»Ğ°Ñ‚Ğµ
        rental_out.remaining_amount = rental.total_cost - rental.prepayment_amount

        return rental_out

    async def _enrich_reservation_with_financials(self, reservation: Reservation) -> ReservationItem:
        """ĞĞ±Ğ¾Ğ³Ğ°Ñ‰Ğ°ĞµÑ‚ Ğ¾Ğ±ÑŠĞµĞºÑ‚ Ñ€ĞµĞ·ĞµÑ€Ğ²Ğ° Ñ„Ğ¸Ğ½Ğ°Ğ½ÑĞ¾Ğ²Ñ‹Ğ¼Ğ¸ Ğ´Ğ°Ğ½Ğ½Ñ‹Ğ¼Ğ¸."""
        reservation_out = ReservationItem.model_validate(reservation)
        today = date.today()

        # Ğ”Ğ¸Ğ½Ğ°Ğ¼Ğ¸Ñ‡ĞµÑĞºĞ¸Ğ¹ ÑÑ‚Ğ°Ñ‚ÑƒÑ overdue
        if reservation.status == 'active' and reservation.end_date < today:
            reservation_out.status = 'overdue'

        # Ğ£ÑÑ‚Ğ°Ğ½Ğ°Ğ²Ğ»Ğ¸Ğ²Ğ°ĞµĞ¼ rental_id ĞµÑĞ»Ğ¸ ĞµÑÑ‚ÑŒ ÑĞ²ÑĞ·Ğ°Ğ½Ğ½Ğ°Ñ Ğ°Ñ€ĞµĞ½Ğ´Ğ°
        if reservation.rental:
            reservation_out.rental_id = reservation.rental.id

        return reservation_out

    async def _enrich_admin_reservation_with_financials(self, reservation: Reservation) -> AdminReservationOut:
        """ĞĞ±Ğ¾Ğ³Ğ°Ñ‰Ğ°ĞµÑ‚ Ğ¾Ğ±ÑŠĞµĞºÑ‚ Ñ€ĞµĞ·ĞµÑ€Ğ²Ğ° Ğ´Ğ»Ñ Ğ°Ğ´Ğ¼Ğ¸Ğ½-Ğ¿Ğ°Ğ½ĞµĞ»Ğ¸ Ñ„Ğ¸Ğ½Ğ°Ğ½ÑĞ¾Ğ²Ñ‹Ğ¼Ğ¸ Ğ´Ğ°Ğ½Ğ½Ñ‹Ğ¼Ğ¸."""
        if not reservation.user:
            raise ValueError("Reservation must have user for admin view")

        reservation_base = await self._enrich_reservation_with_financials(reservation)
        user_info = reservation.user

        return AdminReservationOut(
            **reservation_base.model_dump(),
            user_info=user_info
        )


```


## <a name="RentalAppFASTAPIapiservicesorderinitpy"></a>`RentalApp_FASTAPI/api/services/order/__init__.py`

```python
// path: RentalApp_FASTAPI/api/services/order/__init__.py



```


## <a name="RentalAppFASTAPIapiservicesorderorderlifecycleservicepy"></a>`RentalApp_FASTAPI/api/services/order/order_lifecycle_service.py`

```python
// path: RentalApp_FASTAPI/api/services/order/order_lifecycle_service.py

# api/services/order/order_lifecycle_service.py

from sqlalchemy.ext.asyncio import AsyncSession
from sqlalchemy import select
from datetime import date
import logging

from api.models.user import User
from api.models.rental import Rental, RentalAccessory
from api.models.reservation import Reservation
from api.services.order.order_repository import OrderRepository
from api.services.order.order_validator import OrderValidator
from api.services.balance_service import BalanceService
from api.services.financial_service import FinancialService
from api.services.promo_code_service import validate_promo_code_for_use

from shared.schemas.reservation_schema import ReservationCreateRequest, ReservationUpdateRequest, AdminReservationCreateRequest
from shared.schemas.rental_schema import RentalCreateFromReservationRequest, RentalReturnRequest, RentalCreateFromScratchRequest, AdminRentalUpdate

logger = logging.getLogger(__name__)

class OrderLifecycleService:
    """
    Ğ•Ğ´Ğ¸Ğ½Ñ‹Ğ¹ ÑĞµÑ€Ğ²Ğ¸Ñ Ğ´Ğ»Ñ ÑƒĞ¿Ñ€Ğ°Ğ²Ğ»ĞµĞ½Ğ¸Ñ Ğ¿Ğ¾Ğ»Ğ½Ñ‹Ğ¼ Ğ¶Ğ¸Ğ·Ğ½ĞµĞ½Ğ½Ñ‹Ğ¼ Ñ†Ğ¸ĞºĞ»Ğ¾Ğ¼ Ğ·Ğ°ĞºĞ°Ğ·Ğ°:
    Ğ¾Ñ‚ ÑĞ¾Ğ·Ğ´Ğ°Ğ½Ğ¸Ñ Ñ€ĞµĞ·ĞµÑ€Ğ²Ğ° Ğ´Ğ¾ Ğ²Ğ¾Ğ·Ğ²Ñ€Ğ°Ñ‚Ğ° Ğ°Ñ€ĞµĞ½Ğ´Ñ‹.
    """
    def __init__(self, db: AsyncSession):
        self.db = db
        self.repo = OrderRepository(db)
        self.validator = OrderValidator(db)
        self.balance_service = BalanceService(db)
        self.financial_service = FinancialService(db)

    # --- ĞœĞµÑ‚Ğ¾Ğ´Ñ‹ Ğ´Ğ»Ñ Ğ ĞµĞ·ĞµÑ€Ğ²Ğ¾Ğ² (ĞŸĞ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ÑŒ) ---

    async def create_user_reservation(self, request: ReservationCreateRequest, user: User) -> Reservation:
        try:
            await self.validator.validate_dates_and_holidays(request.start_date, request.end_date)
            equipment = await self.repo.get_equipment_by_ids_or_fail(request.equipment_ids)
            self.validator.validate_accessories_for_equipment(request.selected_accessories, request.equipment_ids)
            await self.validator.validate_equipment_availability(request.equipment_ids, request.start_date, request.end_date)

            promo_code_obj = await self.repo.get_promo_code_by_name(request.promo_code) if request.promo_code else None
            price_details = await self.financial_service.calculate_final_price(request.equipment_ids, request.selected_accessories, request.start_date, request.end_date, promo_code_obj)

            reservation = self.repo.create_reservation_instance(
                user_id=user.id,
                start_date=request.start_date,
                end_date=request.end_date,
                equipment=equipment,
                price_details=price_details,
                promo_code_id=promo_code_obj.id if promo_code_obj else None
            )
            self.repo.add_accessories_to_reservation(reservation, request.selected_accessories)
            await self.repo.save(reservation)
            
            await self.db.commit()
            logger.info(f"User {user.id} created reservation #{reservation.id}")
            return await self.repo.get_reservation_by_id_or_fail(reservation.id)
            
        except Exception as e:
            await self.db.rollback()
            logger.error(f"ĞÑˆĞ¸Ğ±ĞºĞ° Ğ¿Ñ€Ğ¸ ÑĞ¾Ğ·Ğ´Ğ°Ğ½Ğ¸Ğ¸ Ñ€ĞµĞ·ĞµÑ€Ğ²Ğ° Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ĞµĞ¼ {user.id}: {e}", exc_info=True)
            raise

    async def update_user_reservation(self, reservation_id: int, request: ReservationUpdateRequest, user: User) -> Reservation:
        try:
            reservation = await self.repo.get_reservation_by_id_or_fail(reservation_id, user_id=user.id)
            await self.validator.validate_dates_and_holidays(request.start_date, request.end_date)
            equipment = await self.repo.get_equipment_by_ids_or_fail(request.equipment_ids)
            self.validator.validate_accessories_for_equipment(request.selected_accessories, request.equipment_ids)
            await self.validator.validate_equipment_availability(request.equipment_ids, request.start_date, request.end_date, exclude_reservation_id=reservation_id)

            promo_code_obj = await self.repo.get_promo_code_by_name(request.promo_code) if request.promo_code else None
            price_details = await self.financial_service.calculate_final_price(request.equipment_ids, request.selected_accessories, request.start_date, request.end_date, promo_code_obj)

            self.repo.update_reservation_instance(
                reservation=reservation,
                start_date=request.start_date,
                end_date=request.end_date,
                equipment=equipment,
                price_details=price_details,
                promo_code_id=promo_code_obj.id if promo_code_obj else None
            )
            await self.repo.update_accessories_for_reservation(reservation, request.selected_accessories)
            await self.repo.save(reservation)
            
            await self.db.commit()
            logger.info(f"User {user.id} updated reservation #{reservation.id}")
            return await self.repo.get_reservation_by_id_or_fail(reservation.id)
            
        except Exception as e:
            await self.db.rollback()
            logger.error(f"ĞÑˆĞ¸Ğ±ĞºĞ° Ğ¿Ñ€Ğ¸ Ğ¾Ğ±Ğ½Ğ¾Ğ²Ğ»ĞµĞ½Ğ¸Ğ¸ Ñ€ĞµĞ·ĞµÑ€Ğ²Ğ° #{reservation_id} Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ĞµĞ¼ {user.id}: {e}", exc_info=True)
            raise

    async def cancel_user_reservation(self, reservation_id: int, user: User):
        try:
            reservation = await self.repo.get_reservation_by_id_or_fail(reservation_id, user_id=user.id)
            self.validator.validate_reservation_is_cancellable(reservation)
            await self.repo.delete(reservation)
            
            await self.db.commit()
            logger.info(f"User {user.id} cancelled reservation #{reservation_id}")
            
        except Exception as e:
            await self.db.rollback()
            logger.error(f"ĞÑˆĞ¸Ğ±ĞºĞ° Ğ¿Ñ€Ğ¸ Ğ¾Ñ‚Ğ¼ĞµĞ½Ğµ Ñ€ĞµĞ·ĞµÑ€Ğ²Ğ° #{reservation_id} Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ĞµĞ¼ {user.id}: {e}", exc_info=True)
            raise

    # --- ĞœĞµÑ‚Ğ¾Ğ´Ñ‹ Ğ´Ğ»Ñ Ğ ĞµĞ·ĞµÑ€Ğ²Ğ¾Ğ² (ĞĞ´Ğ¼Ğ¸Ğ½Ğ¸ÑÑ‚Ñ€Ğ°Ñ‚Ğ¾Ñ€) ---

    async def create_admin_reservation(self, request: AdminReservationCreateRequest) -> Reservation:
        user = await self.repo.get_user_by_id_or_fail(request.user_id)
        # Ğ”Ğ»Ñ Ğ°Ğ´Ğ¼Ğ¸Ğ½Ğ° Ğ¼Ñ‹ Ğ¼Ğ¾Ğ¶ĞµĞ¼ Ğ¿Ğ¾Ğ²Ñ‚Ğ¾Ñ€Ğ½Ğ¾ Ğ¸ÑĞ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ÑŒ Ğ»Ğ¾Ğ³Ğ¸ĞºÑƒ ÑĞ¾Ğ·Ğ´Ğ°Ğ½Ğ¸Ñ Ğ¾Ğ±Ñ‹Ñ‡Ğ½Ğ¾Ğ³Ğ¾ Ñ€ĞµĞ·ĞµÑ€Ğ²Ğ°
        return await self.create_user_reservation(request, user)

    async def update_admin_reservation(self, reservation_id: int, request: ReservationUpdateRequest) -> Reservation:
        reservation = await self.repo.get_reservation_by_id_or_fail(reservation_id)
        user = await self.repo.get_user_by_id_or_fail(reservation.user_id)
        # ĞĞ½Ğ°Ğ»Ğ¾Ğ³Ğ¸Ñ‡Ğ½Ğ¾, Ğ¸ÑĞ¿Ğ¾Ğ»ÑŒĞ·ÑƒĞµĞ¼ Ğ¾Ğ±Ñ‰ÑƒÑ Ğ»Ğ¾Ğ³Ğ¸ĞºÑƒ Ğ¾Ğ±Ğ½Ğ¾Ğ²Ğ»ĞµĞ½Ğ¸Ñ
        return await self.update_user_reservation(reservation_id, request, user)

    async def cancel_admin_reservation(self, reservation_id: int):
        reservation = await self.repo.get_reservation_by_id_or_fail(reservation_id)
        self.validator.validate_reservation_is_cancellable(reservation)
        await self.repo.delete(reservation)
        logger.warning(f"Admin cancelled reservation #{reservation_id}")

    async def bulk_cancel_admin_reservations(self, reservation_ids: list[int]):
        reservations = await self.repo.get_reservations_by_ids(reservation_ids)
        cancellable, not_cancellable = self.validator.filter_cancellable_reservations(reservations)

        if not_cancellable:
            logger.warning(f"Cannot bulk delete reservations already converted to rental: {[r.id for r in not_cancellable]}")

        for reservation in cancellable:
            await self.repo.delete(reservation)

        logger.warning(f"Admin bulk cancelled reservations: {[r.id for r in cancellable]}")

    # --- ĞœĞµÑ‚Ğ¾Ğ´Ñ‹ Ğ´Ğ»Ñ ĞÑ€ĞµĞ½Ğ´ (ĞĞ´Ğ¼Ğ¸Ğ½Ğ¸ÑÑ‚Ñ€Ğ°Ñ‚Ğ¾Ñ€) ---

    async def convert_reservation_to_rental(self, reservation_id: int, request: RentalCreateFromReservationRequest, manager: User) -> Rental:
        try:
            reservation = await self.repo.get_reservation_by_id_or_fail(reservation_id)
            self.validator.validate_reservation_for_conversion(reservation)
            
            # Ğ¡Ğ¾Ğ·Ğ´Ğ°ĞµĞ¼ Ğ¿ĞµÑ€ĞµĞ¼ĞµĞ½Ğ½ÑƒÑ new_start_date
            new_start_date = date.today()
            
            # Ğ—Ğ°Ğ¼ĞµĞ½ÑĞµĞ¼ Ğ¿Ñ€Ğ¾Ğ²ĞµÑ€ĞºÑƒ Ğ½Ğ° Ğ²Ñ‹Ñ…Ğ¾Ğ´Ğ½Ğ¾Ğ¹ Ğ´ĞµĞ½ÑŒ Ğ½Ğ° Ğ²Ğ°Ğ»Ğ¸Ğ´Ğ°Ñ†Ğ¸Ñ Ğ²ÑĞµĞ³Ğ¾ Ğ¿ĞµÑ€Ğ¸Ğ¾Ğ´Ğ°
            await self.validator.validate_dates_and_holidays(new_start_date, reservation.end_date, request.force_issue_on_holiday)

            # --- ĞĞĞ§ĞĞ›Ğ Ğ˜Ğ—ĞœĞ•ĞĞ•ĞĞ˜Ğ™ ---
            # 1. ĞŸĞ•Ğ Ğ•Ğ¡Ğ§Ğ˜Ğ¢Ğ«Ğ’ĞĞ•Ğœ Ğ¡Ğ¢ĞĞ˜ĞœĞĞ¡Ğ¢Ğ¬ ĞŸĞ•Ğ Ğ•Ğ” ĞšĞĞĞ’Ğ•Ğ Ğ¢ĞĞ¦Ğ˜Ğ•Ğ™
            # ĞŸĞ¾Ğ»ÑƒÑ‡Ğ°ĞµĞ¼ Ğ¿Ñ€Ğ¾Ğ¼Ğ¾-ĞºĞ¾Ğ´ Ğ½Ğ°Ğ¿Ñ€ÑĞ¼ÑƒÑ Ğ¸Ğ· Ğ‘Ğ”, ĞµÑĞ»Ğ¸ ĞµÑÑ‚ÑŒ promo_code_id
            promo_code_obj = None
            if reservation.promo_code_id:
                # ĞŸĞ¾Ğ»ÑƒÑ‡Ğ°ĞµĞ¼ Ğ¿Ñ€Ğ¾Ğ¼Ğ¾-ĞºĞ¾Ğ´ Ğ¿Ğ¾ ID, Ğ° Ğ½Ğµ Ğ¿Ğ¾ Ğ¸Ğ¼ĞµĞ½Ğ¸, Ñ‡Ñ‚Ğ¾Ğ±Ñ‹ Ğ¸Ğ·Ğ±ĞµĞ¶Ğ°Ñ‚ÑŒ lazy loading
                from api.models.promo_code import PromoCode
                promo_code_result = await self.db.execute(
                    select(PromoCode).filter(PromoCode.id == reservation.promo_code_id)
                )
                promo_code_obj = promo_code_result.unique().scalar_one_or_none()
            
            # Ğ‘ĞµĞ·Ğ¾Ğ¿Ğ°ÑĞ½Ğ¾ Ğ¿Ğ¾Ğ»ÑƒÑ‡Ğ°ĞµĞ¼ Ğ´Ğ°Ğ½Ğ½Ñ‹Ğµ Ñ€ĞµĞ·ĞµÑ€Ğ²Ğ°
            equipment_ids = []
            selected_accessories = {}
            
            # ĞŸĞ¾Ğ»ÑƒÑ‡Ğ°ĞµĞ¼ ID Ğ¾Ğ±Ğ¾Ñ€ÑƒĞ´Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ
            for eq in reservation.equipment:
                equipment_ids.append(eq.id)
            
            # ĞŸÑ€ĞµĞ¾Ğ±Ñ€Ğ°Ğ·ÑƒĞµĞ¼ Ğ°ĞºÑĞµÑÑÑƒĞ°Ñ€Ñ‹ Ğ² Ğ½ÑƒĞ¶Ğ½Ñ‹Ğ¹ Ñ„Ğ¾Ñ€Ğ¼Ğ°Ñ‚
            for link in reservation.accessory_links:
                if link.equipment_id not in selected_accessories:
                    selected_accessories[link.equipment_id] = []
                selected_accessories[link.equipment_id].append(link.accessory_id)
            
            price_details = await self.financial_service.calculate_final_price(
                equipment_ids,
                selected_accessories,
                new_start_date, # Ğ˜ÑĞ¿Ğ¾Ğ»ÑŒĞ·ÑƒĞµĞ¼ new_start_date Ğ´Ğ»Ñ Ğ¿ĞµÑ€ĞµÑÑ‡ĞµÑ‚Ğ° ÑÑ‚Ğ¾Ğ¸Ğ¼Ğ¾ÑÑ‚Ğ¸
                reservation.end_date,
                promo_code_obj
            )

            # 2. ĞŸĞµÑ€ĞµĞ´Ğ°ĞµĞ¼ Ğ¿ĞµÑ€ĞµÑÑ‡Ğ¸Ñ‚Ğ°Ğ½Ğ½Ñ‹Ğµ Ğ´Ğ°Ğ½Ğ½Ñ‹Ğµ Ğ² Ñ€ĞµĞ¿Ğ¾Ğ·Ğ¸Ñ‚Ğ¾Ñ€Ğ¸Ğ¹
            rental = self.repo.create_rental_from_reservation(
                reservation, 
                manager, 
                request.deposit_amount, 
                request.notes_on_issue,
                # ĞŸĞµÑ€ĞµĞ´Ğ°ĞµĞ¼ Ğ½Ğ¾Ğ²Ñ‹Ğµ Ğ´Ğ°Ğ½Ğ½Ñ‹Ğµ Ğ¾ Ñ†ĞµĞ½Ğµ
                recalculated_cost=price_details.final_total,
                recalculated_discount=price_details.discount_amount,
                new_start_date=new_start_date, # ĞŸĞµÑ€ĞµĞ´Ğ°ĞµĞ¼ Ğ´Ğ°Ñ‚Ñƒ Ğ½Ğ°Ñ‡Ğ°Ğ»Ğ° Ğ°Ñ€ĞµĞ½Ğ´Ñ‹
                prepayment_amount=request.prepayment_amount
            )
            # --- ĞšĞĞĞ•Ğ¦ Ğ˜Ğ—ĞœĞ•ĞĞ•ĞĞ˜Ğ™ ---

            # ĞĞ°Ñ‡Ğ¸ÑĞ»ÑĞµĞ¼ Ğ¿Ñ€ĞµĞ´Ğ¾Ğ¿Ğ»Ğ°Ñ‚Ñƒ Ğ½Ğ° Ğ±Ğ°Ğ»Ğ°Ğ½Ñ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ñ (ĞµÑĞ»Ğ¸ ĞµÑÑ‚ÑŒ)
            if request.prepayment_amount > 0:
                await self.balance_service.add_transaction(
                    user_id=rental.user_id,
                    amount=request.prepayment_amount,
                    operation_type="prepayment",
                    description=f"ĞŸÑ€ĞµĞ´Ğ¾Ğ¿Ğ»Ğ°Ñ‚Ğ° Ğ·Ğ° Ğ°Ñ€ĞµĞ½Ğ´Ñƒ #{rental.id} (Ğ¸Ğ· Ñ€ĞµĞ·ĞµÑ€Ğ²Ğ° #{reservation.id})",
                    rental_id=rental.id
                )

            await self.balance_service.add_transaction(
                user_id=rental.user_id,
                amount=-rental.total_cost,
                operation_type="rental_debit",
                description=f"Ğ¡Ğ¿Ğ¸ÑĞ°Ğ½Ğ¸Ğµ Ğ·Ğ° Ğ°Ñ€ĞµĞ½Ğ´Ñƒ (Ğ¸Ğ· Ñ€ĞµĞ·ĞµÑ€Ğ²Ğ° #{reservation.id}) Ğ½Ğ° ÑÑƒĞ¼Ğ¼Ñƒ {rental.total_cost} Ñ€ÑƒĞ±.",
                rental_id=rental.id
            )
            await self.repo.save(rental)
            
            # Ğ•Ğ´Ğ¸Ğ½Ñ‹Ğ¹ ĞºĞ¾Ğ¼Ğ¼Ğ¸Ñ‚ Ğ´Ğ»Ñ Ğ²ÑĞµĞ¹ Ğ¾Ğ¿ĞµÑ€Ğ°Ñ†Ğ¸Ğ¸
            await self.db.commit()
            logger.info(f"Manager {manager.id} converted reservation #{reservation_id} to rental #{rental.id}")
            return await self.repo.get_rental_by_id_or_fail(rental.id) # Ğ’Ğ¾Ğ·Ğ²Ñ€Ğ°Ñ‰Ğ°ĞµĞ¼ Ñ Ğ¿Ğ¾Ğ´Ğ³Ñ€ÑƒĞ¶ĞµĞ½Ğ½Ñ‹Ğ¼Ğ¸ ÑĞ²ÑĞ·ÑĞ¼Ğ¸
            
        except Exception as e:
            await self.db.rollback()
            logger.error(f"ĞÑˆĞ¸Ğ±ĞºĞ° Ğ¿Ñ€Ğ¸ ĞºĞ¾Ğ½Ğ²ĞµÑ€Ñ‚Ğ°Ñ†Ğ¸Ğ¸ Ñ€ĞµĞ·ĞµÑ€Ğ²Ğ° #{reservation_id} Ğ² Ğ°Ñ€ĞµĞ½Ğ´Ñƒ: {e}", exc_info=True)
            raise

    async def create_rental_from_scratch(self, request: RentalCreateFromScratchRequest, manager: User) -> Rental:
        # Ğ¡Ğ¾Ñ…Ñ€Ğ°Ğ½ÑĞµĞ¼ ID Ğ¼ĞµĞ½ĞµĞ´Ğ¶ĞµÑ€Ğ° Ğ´Ğ¾ Ğ²Ñ‹Ğ¿Ğ¾Ğ»Ğ½ĞµĞ½Ğ¸Ñ Ğ¾Ğ¿ĞµÑ€Ğ°Ñ†Ğ¸Ğ¹ Ñ Ğ‘Ğ”
        manager_id = manager.id
        try:
            user = await self.repo.get_user_by_id_or_fail(request.user_id)
            await self.validator.validate_equipment_availability(request.equipment_ids, request.start_date, request.end_date)
            equipment = await self.repo.get_equipment_by_ids_or_fail(request.equipment_ids)
            price_details = await self.financial_service.calculate_final_price(request.equipment_ids, None, request.start_date, request.end_date, None)

            rental = self.repo.create_rental_instance(
                user=user,
                manager=manager,
                start_date=request.start_date,
                end_date=request.end_date,
                equipment=equipment,
                total_cost=price_details.final_total,
                deposit_amount=request.deposit_amount,
                notes_on_issue=request.notes_on_issue
            )

            await self.balance_service.add_transaction(
                user_id=user.id,
                amount=-rental.total_cost,
                operation_type="rental_debit",
                description=f"Ğ¡Ğ¿Ğ¸ÑĞ°Ğ½Ğ¸Ğµ Ğ·Ğ° Ğ½Ğ¾Ğ²ÑƒÑ Ğ°Ñ€ĞµĞ½Ğ´Ñƒ #{rental.id} Ğ½Ğ° ÑÑƒĞ¼Ğ¼Ñƒ {rental.total_cost} Ñ€ÑƒĞ±.",
                rental_id=rental.id
            )
            await self.repo.save(rental)
            
            await self.db.commit()
            logger.info(f"Manager {manager.id} created rental from scratch #{rental.id} for user {user.id}")
            return await self.repo.get_rental_by_id_or_fail(rental.id)
            
        except Exception as e:
            await self.db.rollback()
            logger.error(f"ĞÑˆĞ¸Ğ±ĞºĞ° Ğ¿Ñ€Ğ¸ ÑĞ¾Ğ·Ğ´Ğ°Ğ½Ğ¸Ğ¸ Ğ°Ñ€ĞµĞ½Ğ´Ñ‹ Ñ Ğ½ÑƒĞ»Ñ Ğ¼ĞµĞ½ĞµĞ´Ğ¶ĞµÑ€Ğ¾Ğ¼ {manager_id}: {e}", exc_info=True)
            raise

    async def return_rental(self, rental_id: int, request: RentalReturnRequest, manager: User) -> Rental:
        # Ğ¡Ğ¾Ñ…Ñ€Ğ°Ğ½ÑĞµĞ¼ ID Ğ¼ĞµĞ½ĞµĞ´Ğ¶ĞµÑ€Ğ° Ğ´Ğ¾ Ğ²Ñ‹Ğ¿Ğ¾Ğ»Ğ½ĞµĞ½Ğ¸Ñ Ğ¾Ğ¿ĞµÑ€Ğ°Ñ†Ğ¸Ğ¹ Ñ Ğ‘Ğ”
        manager_id = manager.id
        try:
            rental = await self.repo.get_rental_by_id_or_fail(rental_id)
            self.validator.validate_accessories_returned(rental, request.accessories_returned_confirmation)

            # Ğ˜Ğ½Ğ¸Ñ†Ğ¸Ğ°Ğ»Ğ¸Ğ·Ğ¸Ñ€ÑƒĞµĞ¼ Ğ¿ĞµÑ€ĞµĞ¼ĞµĞ½Ğ½Ñ‹Ğµ Ğ´Ğ»Ñ Ñ€Ğ°ÑÑ‡ĞµÑ‚Ğ° ĞºÑ€ĞµĞ´Ğ¸Ñ‚Ğ° Ğ¸ ÑˆÑ‚Ñ€Ğ°Ñ„Ğ°
            credit_amount = 0.0
            surcharge_amount = 0.0

            # ĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑĞµĞ¼, ÑĞ²Ğ»ÑĞµÑ‚ÑÑ Ğ»Ğ¸ Ğ²Ğ¾Ğ·Ğ²Ñ€Ğ°Ñ‚ Ğ¿Ñ€Ğ¾ÑÑ€Ğ¾Ñ‡ĞµĞ½Ğ½Ñ‹Ğ¼
            if request.actual_return_date > rental.end_date:
                # ĞŸÑ€Ğ¾ÑÑ€Ğ¾Ñ‡ĞµĞ½Ğ½Ñ‹Ğ¹ Ğ²Ğ¾Ğ·Ğ²Ñ€Ğ°Ñ‚ - Ñ€Ğ°ÑÑÑ‡Ğ¸Ñ‚Ñ‹Ğ²Ğ°ĞµĞ¼ ÑˆÑ‚Ñ€Ğ°Ñ„
                surcharge_amount = await self.financial_service.calculate_overdue_surcharge(rental, request.actual_return_date)
                
                if surcharge_amount > 0:
                    # Ğ¡Ğ¾Ğ·Ğ´Ğ°ĞµĞ¼ Ğ´ĞµĞ±ĞµÑ‚Ğ¾Ğ²ÑƒÑ Ñ‚Ñ€Ğ°Ğ½Ğ·Ğ°ĞºÑ†Ğ¸Ñ Ğ´Ğ»Ñ ÑĞ¿Ğ¸ÑĞ°Ğ½Ğ¸Ñ ÑˆÑ‚Ñ€Ğ°Ñ„Ğ°
                    await self.balance_service.add_transaction(
                        user_id=rental.user_id,
                        amount=-surcharge_amount,  # ĞÑ‚Ñ€Ğ¸Ñ†Ğ°Ñ‚ĞµĞ»ÑŒĞ½Ğ°Ñ ÑÑƒĞ¼Ğ¼Ğ° Ğ´Ğ»Ñ ÑĞ¿Ğ¸ÑĞ°Ğ½Ğ¸Ñ
                        operation_type="overdue_surcharge_debit",
                        description=f"Ğ¡Ğ¿Ğ¸ÑĞ°Ğ½Ğ¸Ğµ Ğ·Ğ° Ğ¿Ñ€Ğ¾ÑÑ€Ğ¾Ñ‡ĞºÑƒ Ğ°Ñ€ĞµĞ½Ğ´Ñ‹ #{rental.id} Ğ½Ğ° {surcharge_amount} Ñ€ÑƒĞ±.",
                        rental_id=rental.id
                    )
                    logger.info(f"Applied overdue surcharge of {surcharge_amount} rub. for rental #{rental.id}")
            else:
                # Ğ’Ğ¾Ğ·Ğ²Ñ€Ğ°Ñ‚ Ğ²Ğ¾Ğ²Ñ€ĞµĞ¼Ñ Ğ¸Ğ»Ğ¸ Ğ´Ğ¾ÑÑ€Ğ¾Ñ‡Ğ½Ğ¾ - Ñ€Ğ°ÑÑÑ‡Ğ¸Ñ‚Ñ‹Ğ²Ğ°ĞµĞ¼ ĞºÑ€ĞµĞ´Ğ¸Ñ‚ Ğ·Ğ° Ğ´Ğ¾ÑÑ€Ğ¾Ñ‡Ğ½Ñ‹Ğ¹ Ğ²Ğ¾Ğ·Ğ²Ñ€Ğ°Ñ‚
                planned_days = await self.repo.get_rental_days_count(rental.start_date, rental.end_date)
                credit_amount = await self.financial_service.calculate_early_return_credit(rental, request.actual_return_date, planned_days)
                
                if credit_amount > 0:
                    # Ğ¡Ğ¾Ğ·Ğ´Ğ°ĞµĞ¼ ĞºÑ€ĞµĞ´Ğ¸Ñ‚Ğ¾Ğ²ÑƒÑ Ñ‚Ñ€Ğ°Ğ½Ğ·Ğ°ĞºÑ†Ğ¸Ñ Ğ´Ğ»Ñ Ğ²Ğ¾Ğ·Ğ²Ñ€Ğ°Ñ‚Ğ° ÑÑ€ĞµĞ´ÑÑ‚Ğ²
                    await self.balance_service.add_transaction(
                        user_id=rental.user_id,
                        amount=credit_amount,
                        operation_type="early_return_credit",
                        description=f"Ğ’Ğ¾Ğ·Ğ²Ñ€Ğ°Ñ‚ Ğ·Ğ° Ğ´Ğ¾ÑÑ€Ğ¾Ñ‡Ğ½Ğ¾Ğµ Ğ·Ğ°Ğ²ĞµÑ€ÑˆĞµĞ½Ğ¸Ğµ Ğ°Ñ€ĞµĞ½Ğ´Ñ‹ #{rental.id} Ğ½Ğ° ÑÑƒĞ¼Ğ¼Ñƒ {credit_amount} Ñ€ÑƒĞ±.",
                        rental_id=rental.id
                    )
                    logger.info(f"Applied early return credit of {credit_amount} rub. for rental #{rental.id}")

            # ĞŸĞ»Ğ°Ñ‚ĞµĞ¶ Ñ‚ĞµĞ¿ĞµÑ€ÑŒ Ğ¾Ğ±Ñ€Ğ°Ğ±Ğ°Ñ‚Ñ‹Ğ²Ğ°ĞµÑ‚ÑÑ Ğ¾Ñ‚Ğ´ĞµĞ»ÑŒĞ½Ñ‹Ğ¼ ÑĞ½Ğ´Ğ¿Ğ¾Ğ¸Ğ½Ñ‚Ğ¾Ğ¼ Ğ¸ Ğ½Ğµ ÑĞ²Ğ»ÑĞµÑ‚ÑÑ Ñ‡Ğ°ÑÑ‚ÑŒÑ Ğ¿Ñ€Ğ¾Ñ†ĞµÑÑĞ° Ğ²Ğ¾Ğ·Ğ²Ñ€Ğ°Ñ‚Ğ°.

            # Ğ¤Ğ¸Ğ½Ğ°Ğ»Ğ¸Ğ·Ğ¸Ñ€ÑƒĞµĞ¼ Ğ²Ğ¾Ğ·Ğ²Ñ€Ğ°Ñ‚ Ñ ÑƒÑ‡ĞµÑ‚Ğ¾Ğ¼ Ğ¸ ĞºÑ€ĞµĞ´Ğ¸Ñ‚Ğ°, Ğ¸ ÑˆÑ‚Ñ€Ğ°Ñ„Ğ°
            self.repo.finalize_rental_return(rental, request.actual_return_date, request.notes_on_return, credit_amount, surcharge_amount)
            await self.repo.save(rental)
            
            await self.db.commit()
            logger.info(f"Manager {manager.id} processed return for rental #{rental_id} - credit: {credit_amount}, surcharge: {surcharge_amount}")
            return await self.repo.get_rental_by_id_or_fail(rental.id)
            
        except Exception as e:
            await self.db.rollback()
            logger.error(f"ĞÑˆĞ¸Ğ±ĞºĞ° Ğ¿Ñ€Ğ¸ Ğ²Ğ¾Ğ·Ğ²Ñ€Ğ°Ñ‚Ğµ Ğ°Ñ€ĞµĞ½Ğ´Ñ‹ #{rental_id} Ğ¼ĞµĞ½ĞµĞ´Ğ¶ĞµÑ€Ğ¾Ğ¼ {manager_id}: {e}", exc_info=True)
            raise

    async def update_rental_details_by_admin(self, rental_id: int, request: AdminRentalUpdate, manager: User) -> Rental:
        # Ğ¡Ğ¾Ñ…Ñ€Ğ°Ğ½ÑĞµĞ¼ ID Ğ¼ĞµĞ½ĞµĞ´Ğ¶ĞµÑ€Ğ° Ğ´Ğ¾ Ğ²Ñ‹Ğ¿Ğ¾Ğ»Ğ½ĞµĞ½Ğ¸Ñ Ğ¾Ğ¿ĞµÑ€Ğ°Ñ†Ğ¸Ğ¹ Ñ Ğ‘Ğ”
        manager_id = manager.id
        try:
            rental = await self.repo.get_rental_by_id_or_fail(rental_id)
            update_data = request.model_dump(exclude_unset=True)
            self.repo.update_rental_instance(rental, update_data)
            await self.repo.save(rental)
            
            await self.db.commit()
            logger.info(f"Manager {manager.id} updated details for rental #{rental_id}")
            return await self.repo.get_rental_by_id_or_fail(rental.id)
            
        except Exception as e:
            await self.db.rollback()
            logger.error(f"ĞÑˆĞ¸Ğ±ĞºĞ° Ğ¿Ñ€Ğ¸ Ğ¾Ğ±Ğ½Ğ¾Ğ²Ğ»ĞµĞ½Ğ¸Ğ¸ Ğ´ĞµÑ‚Ğ°Ğ»ĞµĞ¹ Ğ°Ñ€ĞµĞ½Ğ´Ñ‹ #{rental_id} Ğ¼ĞµĞ½ĞµĞ´Ğ¶ĞµÑ€Ğ¾Ğ¼ {manager_id}: {e}", exc_info=True)
            raise

    async def revert_rental_to_reservation(self, rental_id: int, manager: User):
        # Ğ¡Ğ¾Ñ…Ñ€Ğ°Ğ½ÑĞµĞ¼ ID Ğ¼ĞµĞ½ĞµĞ´Ğ¶ĞµÑ€Ğ° Ğ´Ğ¾ Ğ²Ñ‹Ğ¿Ğ¾Ğ»Ğ½ĞµĞ½Ğ¸Ñ Ğ¾Ğ¿ĞµÑ€Ğ°Ñ†Ğ¸Ğ¹ Ñ Ğ‘Ğ”
        manager_id = manager.id
        try:
            rental = await self.repo.get_rental_by_id_or_fail(rental_id)
            self.validator.validate_rental_for_revert(rental)

            reservation = self.repo.revert_rental_status_to_active(rental)

            await self.balance_service.add_transaction(
                user_id=rental.user_id,
                amount=rental.total_cost, # Ğ’Ğ¾Ğ·Ğ²Ñ€Ğ°Ñ‰Ğ°ĞµĞ¼ Ğ¿Ğ¾Ğ»Ğ½ÑƒÑ ÑÑ‚Ğ¾Ğ¸Ğ¼Ğ¾ÑÑ‚ÑŒ
                operation_type="rental_revert_credit",
                description=f"Ğ’Ğ¾Ğ·Ğ²Ñ€Ğ°Ñ‚ ÑÑ€ĞµĞ´ÑÑ‚Ğ² Ğ·Ğ° Ğ¾Ñ‚Ğ¼ĞµĞ½Ñƒ Ğ²Ñ‹Ğ´Ğ°Ñ‡Ğ¸ Ğ°Ñ€ĞµĞ½Ğ´Ñ‹ #{rental.id}",
                rental_id=rental.id
            )

            await self.repo.delete(rental)
            
            await self.db.commit()
            logger.info(f"Manager {manager_id} reverted rental #{rental_id} to reservation #{reservation.id}")
            
        except Exception as e:
            await self.db.rollback()
            logger.error(f"ĞÑˆĞ¸Ğ±ĞºĞ° Ğ¿Ñ€Ğ¸ Ğ¾Ñ‚Ğ¼ĞµĞ½Ğµ Ğ°Ñ€ĞµĞ½Ğ´Ñ‹ #{rental_id} Ğ¼ĞµĞ½ĞµĞ´Ğ¶ĞµÑ€Ğ¾Ğ¼ {manager_id}: {e}", exc_info=True)
            raise

    async def delete_rental_by_admin(self, rental_id: int):
        try:
            rental = await self.repo.get_rental_by_id_or_fail(rental_id)
            await self.repo.delete(rental)
            
            await self.db.commit()
            logger.warning(f"Admin deleted rental #{rental_id}")
            
        except Exception as e:
            await self.db.rollback()
            logger.error(f"ĞÑˆĞ¸Ğ±ĞºĞ° Ğ¿Ñ€Ğ¸ ÑƒĞ´Ğ°Ğ»ĞµĞ½Ğ¸Ğ¸ Ğ°Ñ€ĞµĞ½Ğ´Ñ‹ #{rental_id}: {e}", exc_info=True)
            raise

```


## <a name="RentalAppFASTAPIapiservicesorderorderquerybasepy"></a>`RentalApp_FASTAPI/api/services/order/order_query_base.py`

```python
// path: RentalApp_FASTAPI/api/services/order/order_query_base.py

# api/services/order/order_query_base.py

from sqlalchemy.ext.asyncio import AsyncSession
from sqlalchemy.orm import joinedload, selectinload
from sqlalchemy import or_, select, func, desc, asc
from typing import Optional, List, Tuple, TypeVar, Generic
from datetime import date
import logging

from api.models.user import User
from api.models.equipment import Equipment

logger = logging.getLogger(__name__)

T = TypeVar('T')  # Ğ¢Ğ¸Ğ¿ Ğ¼Ğ¾Ğ´ĞµĞ»Ğ¸ (Reservation Ğ¸Ğ»Ğ¸ Rental)

class OrderQueryBase(Generic[T]):
    """
    Ğ‘Ğ°Ğ·Ğ¾Ğ²Ñ‹Ğ¹ ĞºĞ»Ğ°ÑÑ Ğ´Ğ»Ñ Ğ¾Ğ±Ñ‰Ğ¸Ñ… Ğ¾Ğ¿ĞµÑ€Ğ°Ñ†Ğ¸Ğ¹ Ñ„Ğ¸Ğ»ÑŒÑ‚Ñ€Ğ°Ñ†Ğ¸Ğ¸, Ğ¿Ğ¾Ğ¸ÑĞºĞ° Ğ¸ ÑĞ¾Ñ€Ñ‚Ğ¸Ñ€Ğ¾Ğ²ĞºĞ¸ Ğ·Ğ°ĞºĞ°Ğ·Ğ¾Ğ².
    Ğ¡Ğ¾Ğ´ĞµÑ€Ğ¶Ğ¸Ñ‚ Ğ¾Ğ±Ñ‰ÑƒÑ Ğ»Ğ¾Ğ³Ğ¸ĞºÑƒ Ğ´Ğ»Ñ Ñ€ĞµĞ·ĞµÑ€Ğ²Ğ¾Ğ² Ğ¸ Ğ°Ñ€ĞµĞ½Ğ´.
    """

    def __init__(self, db: AsyncSession):
        self.db = db

    def _apply_user_search(self, query, search_term: str, model_class):
        """
        ĞŸÑ€Ğ¸Ğ¼ĞµĞ½ÑĞµÑ‚ Ğ¿Ğ¾Ğ¸ÑĞº Ğ¿Ğ¾ Ğ¸Ğ¼ĞµĞ½Ğ¸ Ğ¸Ğ»Ğ¸ email Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ñ.
        """
        search_pattern = f"%{search_term.lower()}%"
        # Ğ£Ğ±ĞµĞ¶Ğ´Ğ°ĞµĞ¼ÑÑ, Ñ‡Ñ‚Ğ¾ JOIN Ğº Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ñ ÑƒĞ¶Ğµ ĞµÑÑ‚ÑŒ Ğ¸Ğ»Ğ¸ Ğ´Ğ¾Ğ±Ğ°Ğ²Ğ»ÑĞµĞ¼ ĞµĞ³Ğ¾
        # Ğ’ Ğ½Ğ°ÑˆĞ¸Ñ… ÑĞ»ÑƒÑ‡Ğ°ÑÑ… Ğ¾Ğ½ Ğ²ÑĞµĞ³Ğ´Ğ° Ğ±ÑƒĞ´ĞµÑ‚, Ñ‚Ğ°Ğº ĞºĞ°Ğº Ğ¼Ñ‹ ĞµĞ³Ğ¾ Ğ´Ğ¾Ğ±Ğ°Ğ²Ğ»ÑĞµĞ¼ Ğ² Ğ±Ğ°Ğ·Ğ¾Ğ²Ñ‹Ñ… Ğ·Ğ°Ğ¿Ñ€Ğ¾ÑĞ°Ñ…
        query = query.join(model_class.user).filter(
            or_(
                User.full_name.ilike(search_pattern),
                User.email.ilike(search_pattern)
            )
        )
        return query

    def _apply_equipment_search(self, query, search_term: str, model_class):
        """
        ĞŸÑ€Ğ¸Ğ¼ĞµĞ½ÑĞµÑ‚ Ğ¿Ğ¾Ğ»Ğ½Ğ¾Ñ‚ĞµĞºÑÑ‚Ğ¾Ğ²Ñ‹Ğ¹ Ğ¿Ğ¾Ğ¸ÑĞº Ğ¿Ğ¾ ÑĞ²ÑĞ·Ğ°Ğ½Ğ½Ğ¾Ğ¼Ñƒ Ğ¾Ğ±Ğ¾Ñ€ÑƒĞ´Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ.
        Ğ˜Ñ‰ĞµÑ‚ Ğ¿Ğ¾ Ğ¿Ğ¾Ğ»ÑĞ¼ name, brand, equipment_type.
        """
        search_pattern = f"%{search_term.lower()}%"
        
        # ĞŸÑ€Ğ¸Ğ¼ĞµĞ½ÑĞµĞ¼ Ñ„Ğ¸Ğ»ÑŒÑ‚Ñ€ Ğ¿Ğ¾Ğ¸ÑĞºĞ° Ñ‡ĞµÑ€ĞµĞ· EXISTS Ğ¿Ğ¾Ğ´Ğ·Ğ°Ğ¿Ñ€Ğ¾Ñ
        # Ğ­Ñ‚Ğ¾ Ğ±Ğ¾Ğ»ĞµĞµ Ğ±ĞµĞ·Ğ¾Ğ¿Ğ°ÑĞ½Ñ‹Ğ¹ ÑĞ¿Ğ¾ÑĞ¾Ğ± Ğ´Ğ»Ñ ÑĞ²ÑĞ·Ğ°Ğ½Ğ½Ñ‹Ñ… Ñ‚Ğ°Ğ±Ğ»Ğ¸Ñ†
        equipment_subquery = select(Equipment.id).where(
            or_(
                Equipment.name.ilike(search_pattern),
                Equipment.brand.ilike(search_pattern),
                Equipment.equipment_type.ilike(search_pattern)
            )
        )
        
        # Ğ”Ğ¾Ğ±Ğ°Ğ²Ğ»ÑĞµĞ¼ Ñ„Ğ¸Ğ»ÑŒÑ‚Ñ€ Ñ‡ĞµÑ€ĞµĞ· EXISTS Ğ´Ğ»Ñ ÑĞ²ÑĞ·Ğ°Ğ½Ğ½Ğ¾Ğ³Ğ¾ Ğ¾Ğ±Ğ¾Ñ€ÑƒĞ´Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ
        query = query.filter(
            model_class.equipment.any(
                Equipment.id.in_(equipment_subquery)
            )
        )
        
        return query

    def _apply_status_filter(self, query, status_filter: Optional[str], model_class):
        """
        ĞŸÑ€Ğ¸Ğ¼ĞµĞ½ÑĞµÑ‚ Ñ„Ğ¸Ğ»ÑŒÑ‚Ñ€Ğ°Ñ†Ğ¸Ñ Ğ¿Ğ¾ ÑÑ‚Ğ°Ñ‚ÑƒÑÑƒ.
        """
        if not status_filter:
            return query
            
        today = date.today()
        
        if status_filter == "active":
            query = query.filter(model_class.status == 'active')
        elif status_filter == "completed":
            # Ğ”Ğ»Ñ Ñ€ĞµĞ·ĞµÑ€Ğ²Ğ¾Ğ²: fulfilled, cancelled, overdue
            # Ğ”Ğ»Ñ Ğ°Ñ€ĞµĞ½Ğ´: completed
            if hasattr(model_class, 'status') and 'fulfilled' in str(model_class.status):
                # Ğ­Ñ‚Ğ¾ Ñ€ĞµĞ·ĞµÑ€Ğ²
                query = query.filter(model_class.status.in_(['fulfilled', 'cancelled', 'overdue']))
            else:
                # Ğ­Ñ‚Ğ¾ Ğ°Ñ€ĞµĞ½Ğ´Ğ°
                query = query.filter(model_class.status == 'completed')
        elif status_filter == "overdue":
            query = query.filter(
                model_class.status == 'active',
                model_class.end_date < today
            )
            
        return query

    def _apply_sorting(self, query, sort_option: Optional[str], model_class):
        """
        ĞŸÑ€Ğ¸Ğ¼ĞµĞ½ÑĞµÑ‚ ÑĞ¾Ñ€Ñ‚Ğ¸Ñ€Ğ¾Ğ²ĞºÑƒ Ğ¿Ğ¾ Ñ€Ğ°Ğ·Ğ»Ğ¸Ñ‡Ğ½Ñ‹Ğ¼ Ğ¿Ğ¾Ğ»ÑĞ¼.
        ĞŸĞ¾Ğ´Ğ´ĞµÑ€Ğ¶Ğ¸Ğ²Ğ°ĞµĞ¼Ñ‹Ğµ Ğ¾Ğ¿Ñ†Ğ¸Ğ¸: id, start_date, end_date, count
        """
        if not sort_option:
            # Ğ¡Ğ¾Ñ€Ñ‚Ğ¸Ñ€Ğ¾Ğ²ĞºĞ° Ğ¿Ğ¾ ÑƒĞ¼Ğ¾Ğ»Ñ‡Ğ°Ğ½Ğ¸Ñ
            return query.order_by(model_class.id.desc())
        
        sort_parts = sort_option.split('_')
        field = sort_parts[0]
        direction = sort_parts[1] if len(sort_parts) > 1 else 'desc'
        
        # ĞĞ¿Ñ€ĞµĞ´ĞµĞ»ÑĞµĞ¼ Ğ½Ğ°Ğ¿Ñ€Ğ°Ğ²Ğ»ĞµĞ½Ğ¸Ğµ ÑĞ¾Ñ€Ñ‚Ğ¸Ñ€Ğ¾Ğ²ĞºĞ¸
        sort_func = desc if direction == 'desc' else asc
        
        if field == "id":
            query = query.order_by(sort_func(model_class.id))
        elif field == "start_date":
            query = query.order_by(sort_func(model_class.start_date))
        elif field == "end_date":
            query = query.order_by(sort_func(model_class.end_date))
        elif field == "count":
            # Ğ¡Ğ¾Ñ€Ñ‚Ğ¸Ñ€Ğ¾Ğ²ĞºĞ° Ğ¿Ğ¾ ĞºĞ¾Ğ»Ğ¸Ñ‡ĞµÑÑ‚Ğ²Ñƒ Ğ¾Ğ±Ğ¾Ñ€ÑƒĞ´Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ
            # Ğ”Ğ»Ñ ÑÑ‚Ğ¾Ğ³Ğ¾ Ğ½ÑƒĞ¶Ğ½Ğ¾ Ğ¿Ğ¾Ğ´ÑÑ‡Ğ¸Ñ‚Ğ°Ñ‚ÑŒ ĞºĞ¾Ğ»Ğ¸Ñ‡ĞµÑÑ‚Ğ²Ğ¾ ÑĞ²ÑĞ·Ğ°Ğ½Ğ½Ğ¾Ğ³Ğ¾ Ğ¾Ğ±Ğ¾Ñ€ÑƒĞ´Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ
            equipment_count = select(func.count()).select_from(
                model_class.equipment.property.mapper.class_.__table__
            ).where(
                model_class.equipment.property.mapper.class_.id.in_(
                    select(model_class.equipment.property.mapper.class_.id)
                    .where(model_class.id == model_class.id)
                )
            ).scalar_subquery()
            
            query = query.order_by(sort_func(equipment_count))
        else:
            # ĞĞµĞ¸Ğ·Ğ²ĞµÑÑ‚Ğ½Ğ¾Ğµ Ğ¿Ğ¾Ğ»Ğµ - Ğ¸ÑĞ¿Ğ¾Ğ»ÑŒĞ·ÑƒĞµĞ¼ ÑĞ¾Ñ€Ñ‚Ğ¸Ñ€Ğ¾Ğ²ĞºÑƒ Ğ¿Ğ¾ ÑƒĞ¼Ğ¾Ğ»Ñ‡Ğ°Ğ½Ğ¸Ñ
            query = query.order_by(model_class.id.desc())
            
        return query

    def _apply_pagination(self, query, skip: int, limit: int):
        """
        ĞŸÑ€Ğ¸Ğ¼ĞµĞ½ÑĞµÑ‚ Ğ¿Ğ°Ğ³Ğ¸Ğ½Ğ°Ñ†Ğ¸Ñ Ğº Ğ·Ğ°Ğ¿Ñ€Ğ¾ÑÑƒ.
        """
        return query.offset(skip).limit(limit)

    async def _get_total_count(self, base_query) -> int:
        """
        ĞŸĞ¾Ğ»ÑƒÑ‡Ğ°ĞµÑ‚ Ğ¾Ğ±Ñ‰ĞµĞµ ĞºĞ¾Ğ»Ğ¸Ñ‡ĞµÑÑ‚Ğ²Ğ¾ Ğ·Ğ°Ğ¿Ğ¸ÑĞµĞ¹ Ğ´Ğ»Ñ Ğ±Ğ°Ğ·Ğ¾Ğ²Ğ¾Ğ³Ğ¾ Ğ·Ğ°Ğ¿Ñ€Ğ¾ÑĞ°.
        """
        count_query = select(func.count()).select_from(base_query.subquery())
        result = await self.db.execute(count_query)
        return result.scalar_one()

    def _get_equipment_joins(self):
        """
        Ğ’Ğ¾Ğ·Ğ²Ñ€Ğ°Ñ‰Ğ°ĞµÑ‚ ÑÑ‚Ğ°Ğ½Ğ´Ğ°Ñ€Ñ‚Ğ½Ñ‹Ğµ JOIN'Ñ‹ Ğ´Ğ»Ñ Ğ¾Ğ±Ğ¾Ñ€ÑƒĞ´Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ.
        ĞŸĞµÑ€ĞµĞ¾Ğ¿Ñ€ĞµĞ´ĞµĞ»ÑĞµÑ‚ÑÑ Ğ² Ğ½Ğ°ÑĞ»ĞµĞ´Ğ½Ğ¸ĞºĞ°Ñ… Ğ´Ğ»Ñ ÑĞ¿ĞµÑ†Ğ¸Ñ„Ğ¸Ñ‡Ğ½Ñ‹Ñ… Ğ¼Ğ¾Ğ´ĞµĞ»ĞµĞ¹.
        """
        return [
            selectinload(Equipment.accessories),
            selectinload(Equipment.associations)
        ]


```


## <a name="RentalAppFASTAPIapiservicesorderorderrepositorypy"></a>`RentalApp_FASTAPI/api/services/order/order_repository.py`

```python
// path: RentalApp_FASTAPI/api/services/order/order_repository.py

# api/services/order/order_repository.py

from sqlalchemy.ext.asyncio import AsyncSession
from sqlalchemy.orm import joinedload, selectinload
from sqlalchemy import select
from datetime import date
from typing import Optional, List, Dict
import logging

from fastapi import HTTPException, status
from api.models.user import User
from api.models.equipment import Equipment
from api.models.promo_code import PromoCode
from api.models.holiday import Holiday
from api.models.reservation import Reservation, ReservationAccessory
from api.models.rental import Rental, RentalAccessory
from api.services.financial_service import FinancialService, PriceDetails

logger = logging.getLogger(__name__)

class OrderRepository:
    """
    Ğ¡Ğ»Ğ¾Ğ¹ Ğ´Ğ¾ÑÑ‚ÑƒĞ¿Ğ° Ğº Ğ´Ğ°Ğ½Ğ½Ñ‹Ğ¼ Ğ´Ğ»Ñ ÑÑƒÑ‰Ğ½Ğ¾ÑÑ‚ĞµĞ¹, ÑĞ²ÑĞ·Ğ°Ğ½Ğ½Ñ‹Ñ… Ñ Ğ·Ğ°ĞºĞ°Ğ·Ğ°Ğ¼Ğ¸ (Ğ ĞµĞ·ĞµÑ€Ğ²Ñ‹ Ğ¸ ĞÑ€ĞµĞ½Ğ´Ñ‹).
    Ğ˜Ğ½ĞºĞ°Ğ¿ÑÑƒĞ»Ğ¸Ñ€ÑƒĞµÑ‚ Ğ²ÑĞµ Ğ¿Ñ€ÑĞ¼Ñ‹Ğµ Ğ·Ğ°Ğ¿Ñ€Ğ¾ÑÑ‹ Ğº Ğ±Ğ°Ğ·Ğµ Ğ´Ğ°Ğ½Ğ½Ñ‹Ñ….
    """
    def __init__(self, db: AsyncSession):
        self.db = db
        self.financial_service = FinancialService(db)

    async def get_user_by_id_or_fail(self, user_id: int) -> User:
        user = await self.db.get(User, user_id)
        if not user:
            raise HTTPException(status_code=status.HTTP_404_NOT_FOUND, detail=f"User with ID {user_id} not found.")
        return user

    async def get_equipment_by_ids_or_fail(self, equipment_ids: List[int]) -> List[Equipment]:
        result = await self.db.execute(
            select(Equipment)
            .filter(Equipment.id.in_(equipment_ids))
            .options(
                selectinload(Equipment.accessories),
                selectinload(Equipment.associations)
            )
        )
        equipment = result.unique().scalars().all()
        if len(equipment) != len(set(equipment_ids)):
            found_ids = {eq.id for eq in equipment}
            missing_ids = set(equipment_ids) - found_ids
            raise HTTPException(status_code=status.HTTP_404_NOT_FOUND, detail=f"Equipment with IDs {list(missing_ids)} not found.")
        return equipment

    async def get_promo_code_by_name(self, code: str) -> Optional[PromoCode]:
        result = await self.db.execute(select(PromoCode).filter(PromoCode.code == code))
        return result.unique().scalar_one_or_none()

    async def get_reservation_by_id_or_fail(self, reservation_id: int, user_id: Optional[int] = None) -> Reservation:
        # Ğ˜ÑĞ¿Ğ¾Ğ»ÑŒĞ·ÑƒĞµĞ¼ Ğ¾Ğ±Ñ‹Ñ‡Ğ½Ñ‹Ğ¹ Ğ·Ğ°Ğ¿Ñ€Ğ¾Ñ Ğ´Ğ»Ñ Ğ¸Ğ·Ğ±ĞµĞ¶Ğ°Ğ½Ğ¸Ñ Ğ¿Ñ€Ğ¾Ğ±Ğ»ĞµĞ¼ Ñ greenlet
        query = select(Reservation).options(
            joinedload(Reservation.user),
            selectinload(Reservation.equipment).options(
                selectinload(Equipment.accessories),
                selectinload(Equipment.associations)
            ),
            joinedload(Reservation.accessory_links).joinedload(ReservationAccessory.accessory),
            joinedload(Reservation.rental)
        ).filter(Reservation.id == reservation_id)
        
        result = await self.db.execute(query)
        reservation = result.unique().scalar_one_or_none()

        if not reservation:
            raise HTTPException(status_code=status.HTTP_404_NOT_FOUND, detail=f"Reservation with ID {reservation_id} not found")

        if user_id and reservation.user_id != user_id:
            raise HTTPException(status_code=status.HTTP_404_NOT_FOUND, detail="Reservation not found or you do not have permission to access it.")

        return reservation

    async def get_reservations_by_ids(self, ids: List[int]) -> List[Reservation]:
        result = await self.db.execute(select(Reservation).filter(Reservation.id.in_(ids)).options(joinedload(Reservation.rental)))
        return result.unique().scalars().all()

    async def get_rental_by_id_or_fail(self, rental_id: int) -> Rental:
        query = select(Rental).options(
            joinedload(Rental.user),
            selectinload(Rental.equipment).options(
                selectinload(Equipment.accessories),
                selectinload(Equipment.associations)
            ),
            joinedload(Rental.reservation),
            joinedload(Rental.accessory_links).joinedload(RentalAccessory.accessory)
        ).filter(Rental.id == rental_id)

        result = await self.db.execute(query)
        rental = result.unique().scalar_one_or_none()

        if not rental:
            raise HTTPException(status_code=status.HTTP_404_NOT_FOUND, detail=f"Rental with ID {rental_id} not found.")
        return rental

    async def is_holiday(self, check_date: date) -> bool:
        result = await self.db.execute(select(Holiday).filter(Holiday.date == check_date))
        return result.scalar_one_or_none() is not None

    async def get_rental_days_count(self, start_date: date, end_date: date) -> int:
        return await self.financial_service.get_rental_days(start_date, end_date)

    def create_reservation_instance(self, user_id: int, start_date: date, end_date: date, equipment: List[Equipment], price_details: PriceDetails, promo_code_id: Optional[int]) -> Reservation:
        return Reservation(
            user_id=user_id,
            start_date=start_date,
            end_date=end_date,
            equipment=equipment,
            total_cost=price_details.final_total,
            discount_amount=price_details.discount_amount,
            promo_code_id=promo_code_id
        )

    def update_reservation_instance(self, reservation: Reservation, start_date: date, end_date: date, equipment: List[Equipment], price_details: PriceDetails, promo_code_id: Optional[int]):
        reservation.start_date = start_date
        reservation.end_date = end_date
        reservation.equipment = equipment
        reservation.total_cost = price_details.final_total
        reservation.discount_amount = price_details.discount_amount
        reservation.promo_code_id = promo_code_id

    def add_accessories_to_reservation(self, reservation: Reservation, selected_accessories: Optional[Dict[int, List[int]]]):
        if not selected_accessories:
            return
        links = []
        for eq_id, acc_ids in selected_accessories.items():
            for acc_id in acc_ids:
                links.append(ReservationAccessory(equipment_id=eq_id, accessory_id=acc_id))
        reservation.accessory_links = links

    async def update_accessories_for_reservation(self, reservation: Reservation, selected_accessories: Optional[Dict[int, List[int]]]):
        reservation.accessory_links.clear()
        await self.db.flush()
        self.add_accessories_to_reservation(reservation, selected_accessories)

    def create_rental_from_reservation(self, reservation: Reservation, manager: User, deposit: float, notes: Optional[str], recalculated_cost: float, recalculated_discount: float, new_start_date: date, prepayment_amount: float = 0.0) -> Rental:
        reservation.status = 'fulfilled'
        
        # Ğ›Ğ¾Ğ³Ğ¸Ñ€ÑƒĞµĞ¼ Ğ°ĞºÑĞµÑÑÑƒĞ°Ñ€Ñ‹ Ñ€ĞµĞ·ĞµÑ€Ğ²Ğ° Ğ´Ğ»Ñ Ğ¾Ñ‚Ğ»Ğ°Ğ´ĞºĞ¸
        if reservation.accessory_links:
            accessory_ids = [link.accessory_id for link in reservation.accessory_links]
            logger.info(f"Ğ¢ĞĞ§ĞšĞ 1 (ĞšĞĞŸĞ˜Ğ ĞĞ’ĞĞĞ˜Ğ•): Ğ ĞµĞ·ĞµÑ€Ğ² #{reservation.id} Ğ¸Ğ¼ĞµĞµÑ‚ Ğ°ĞºÑĞµÑÑÑƒĞ°Ñ€Ñ‹ Ñ ID: {accessory_ids}")
        else:
            logger.warning(f"Ğ¢ĞĞ§ĞšĞ 1 (ĞšĞĞŸĞ˜Ğ ĞĞ’ĞĞĞ˜Ğ•): Ğ’ Ğ¸ÑÑ…Ğ¾Ğ´Ğ½Ğ¾Ğ¼ Ñ€ĞµĞ·ĞµÑ€Ğ²Ğµ #{reservation.id} Ğ°ĞºÑĞµÑÑÑƒĞ°Ñ€Ñ‹ Ğ½Ğµ Ğ½Ğ°Ğ¹Ğ´ĞµĞ½Ñ‹.")
        
        # Ğ¡Ğ¾Ğ·Ğ´Ğ°ĞµĞ¼ Ğ°Ñ€ĞµĞ½Ğ´Ñƒ Ñ ĞºĞ¾Ğ¿Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸ĞµĞ¼ Ğ°ĞºÑĞµÑÑÑƒĞ°Ñ€Ğ¾Ğ² Ğ² ĞºĞ¾Ğ½ÑÑ‚Ñ€ÑƒĞºÑ‚Ğ¾Ñ€Ğµ
        rental = Rental(
            user_id=reservation.user_id,
            created_by_id=manager.id,
            reservation_id=reservation.id,
            equipment=reservation.equipment,
            start_date=new_start_date,
            end_date=reservation.end_date,
            # Ğ˜ÑĞ¿Ğ¾Ğ»ÑŒĞ·ÑƒĞµĞ¼ Ğ½Ğ¾Ğ²Ñ‹Ğµ, Ğ¿ĞµÑ€ĞµÑÑ‡Ğ¸Ñ‚Ğ°Ğ½Ğ½Ñ‹Ğµ Ğ·Ğ½Ğ°Ñ‡ĞµĞ½Ğ¸Ñ
            total_cost=recalculated_cost,
            discount_amount=recalculated_discount,
            promo_code=reservation.promo_code,
            deposit_amount=deposit,
            prepayment_amount=prepayment_amount,
            notes_on_issue=notes,
            # ĞŸĞµÑ€ĞµĞ´Ğ°ĞµĞ¼ Ğ°ĞºÑĞµÑÑÑƒĞ°Ñ€Ñ‹ Ğ´Ğ»Ñ ĞºĞ¾Ğ¿Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ Ğ² ĞºĞ¾Ğ½ÑÑ‚Ñ€ÑƒĞºÑ‚Ğ¾Ñ€
            reservation_accessories=reservation.accessory_links
        )

        # Ğ›Ğ¾Ğ³Ğ¸Ñ€ÑƒĞµĞ¼ Ñ€ĞµĞ·ÑƒĞ»ÑŒÑ‚Ğ°Ñ‚ ĞºĞ¾Ğ¿Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ
        if rental.accessory_links:
            copied_ids = [link.accessory_id for link in rental.accessory_links]
            logger.info(f"Ğ¢ĞĞ§ĞšĞ 1 (ĞšĞĞŸĞ˜Ğ ĞĞ’ĞĞĞ˜Ğ•): Ğ’ Ğ¾Ğ±ÑŠĞµĞºÑ‚ Ğ°Ñ€ĞµĞ½Ğ´Ñ‹ (Ğ² Ğ¿Ğ°Ğ¼ÑÑ‚Ğ¸) ÑĞºĞ¾Ğ¿Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ñ‹ Ğ°ĞºÑĞµÑÑÑƒĞ°Ñ€Ñ‹ Ñ ID: {copied_ids}")

        return rental

    def create_rental_instance(self, user: User, manager: User, start_date: date, end_date: date, equipment: List[Equipment], total_cost: float, deposit_amount: float, notes_on_issue: Optional[str]) -> Rental:
        return Rental(
            user_id=user.id,
            created_by_id=manager.id,
            equipment=equipment,
            start_date=start_date,
            end_date=end_date,
            total_cost=total_cost,
            deposit_amount=deposit_amount,
            notes_on_issue=notes_on_issue
        )

    async def calculate_early_return_credit(self, rental: Rental, actual_return_date: date, planned_days: int) -> float:
        """
        Ğ Ğ°ÑÑÑ‡Ğ¸Ñ‚Ñ‹Ğ²Ğ°ĞµÑ‚ ĞºÑ€ĞµĞ´Ğ¸Ñ‚ Ğ·Ğ° Ğ´Ğ¾ÑÑ€Ğ¾Ñ‡Ğ½Ñ‹Ğ¹ Ğ²Ğ¾Ğ·Ğ²Ñ€Ğ°Ñ‚ Ğ°Ñ€ĞµĞ½Ğ´Ñ‹.
        Ğ”ĞµĞ»ĞµĞ³Ğ¸Ñ€ÑƒĞµÑ‚ Ñ€Ğ°ÑÑ‡ĞµÑ‚ Ğ² FinancialService Ğ´Ğ»Ñ ÑĞ¾Ğ±Ğ»ÑĞ´ĞµĞ½Ğ¸Ñ Ğ¿Ñ€Ğ¸Ğ½Ñ†Ğ¸Ğ¿Ğ° DRY.
        """
        return await self.financial_service.calculate_early_return_credit(rental, actual_return_date, planned_days)

    async def calculate_overdue_surcharge(self, rental: Rental, actual_return_date: date) -> float:
        """
        Ğ Ğ°ÑÑÑ‡Ğ¸Ñ‚Ñ‹Ğ²Ğ°ĞµÑ‚ ÑˆÑ‚Ñ€Ğ°Ñ„ Ğ·Ğ° Ğ¿Ñ€Ğ¾ÑÑ€Ğ¾Ñ‡ĞµĞ½Ğ½Ñ‹Ğµ Ğ´Ğ½Ğ¸ Ğ°Ñ€ĞµĞ½Ğ´Ñ‹.
        Ğ”ĞµĞ»ĞµĞ³Ğ¸Ñ€ÑƒĞµÑ‚ Ñ€Ğ°ÑÑ‡ĞµÑ‚ Ğ² FinancialService Ğ´Ğ»Ñ ÑĞ¾Ğ±Ğ»ÑĞ´ĞµĞ½Ğ¸Ñ Ğ¿Ñ€Ğ¸Ğ½Ñ†Ğ¸Ğ¿Ğ° DRY.
        """
        return await self.financial_service.calculate_overdue_surcharge(rental, actual_return_date)

    def finalize_rental_return(self, rental: Rental, return_date: date, notes: Optional[str], credit: float, surcharge: float = 0.0):
        rental.status = 'completed'
        rental.actual_return_date = return_date
        rental.notes_on_return = notes
        rental.final_cost = rental.total_cost - credit + surcharge

    def update_rental_instance(self, rental: Rental, update_data: dict):
        for key, value in update_data.items():
            setattr(rental, key, value)

    def revert_rental_status_to_active(self, rental: Rental) -> Reservation:
        reservation = rental.reservation
        reservation.status = 'active'
        return reservation

    async def save(self, instance: object):
        if isinstance(instance, Rental) and instance.accessory_links:
            accessory_ids = [link.accessory_id for link in instance.accessory_links]
            logger.info(f"Ğ¢ĞĞ§ĞšĞ 2 (Ğ¡ĞĞ¥Ğ ĞĞĞ•ĞĞ˜Ğ•): ĞŸĞµÑ€ĞµĞ´ Ğ´Ğ¾Ğ±Ğ°Ğ²Ğ»ĞµĞ½Ğ¸ĞµĞ¼ Ğ² ÑĞµÑÑĞ¸Ñ Ğ°Ñ€ĞµĞ½Ğ´Ğ° #{instance.id} Ğ¸Ğ¼ĞµĞµÑ‚ Ğ°ĞºÑĞµÑÑÑƒĞ°Ñ€Ñ‹ Ñ ID: {accessory_ids}")
        self.db.add(instance)
        await self.db.flush()  # ĞŸÑ€Ğ¸Ğ½ÑƒĞ´Ğ¸Ñ‚ĞµĞ»ÑŒĞ½Ğ¾ Ğ²Ñ‹Ğ¿Ğ¾Ğ»Ğ½ÑĞµĞ¼ SQL Ğ±ĞµĞ· ĞºĞ¾Ğ¼Ğ¼Ğ¸Ñ‚Ğ°

    async def delete(self, instance: object):
        await self.db.delete(instance)
        await self.db.flush()  # ĞŸÑ€Ğ¸Ğ½ÑƒĞ´Ğ¸Ñ‚ĞµĞ»ÑŒĞ½Ğ¾ Ğ²Ñ‹Ğ¿Ğ¾Ğ»Ğ½ÑĞµĞ¼ SQL Ğ±ĞµĞ· ĞºĞ¾Ğ¼Ğ¼Ğ¸Ñ‚Ğ°

```


## <a name="RentalAppFASTAPIapiservicesorderordervalidatorpy"></a>`RentalApp_FASTAPI/api/services/order/order_validator.py`

```python
// path: RentalApp_FASTAPI/api/services/order/order_validator.py

#RentalApp_FASTAPI/api/services/order/order_validator.py

from sqlalchemy.ext.asyncio import AsyncSession
from sqlalchemy import select
from datetime import date, datetime, timezone
from typing import List, Optional, Dict, Tuple

from fastapi import HTTPException, status
from api.models.reservation import Reservation
from api.models.rental import Rental
from api.models.holiday import Holiday
from api.services.availability import AvailabilityService
from api.services.financial_service import FinancialService

class OrderValidator:
    """
    Ğ¡Ğ»Ğ¾Ğ¹ Ğ´Ğ»Ñ Ğ²Ğ°Ğ»Ğ¸Ğ´Ğ°Ñ†Ğ¸Ğ¸ Ğ±Ğ¸Ğ·Ğ½ĞµÑ-Ğ¿Ñ€Ğ°Ğ²Ğ¸Ğ», ÑĞ²ÑĞ·Ğ°Ğ½Ğ½Ñ‹Ñ… Ñ Ğ ĞµĞ·ĞµÑ€Ğ²Ğ°Ğ¼Ğ¸ Ğ¸ ĞÑ€ĞµĞ½Ğ´Ğ°Ğ¼Ğ¸.
    """
    def __init__(self, db: AsyncSession):
        self.db = db
        self.financial_service = FinancialService(db)
        self.availability_service = AvailabilityService(db)

    async def validate_dates_and_holidays(self, start_date: date, end_date: date, force_issue_on_holiday: bool = False):
        """
        ĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑĞµÑ‚ ĞºĞ¾Ñ€Ñ€ĞµĞºÑ‚Ğ½Ğ¾ÑÑ‚ÑŒ Ğ´Ğ¸Ğ°Ğ¿Ğ°Ğ·Ğ¾Ğ½Ğ° Ğ´Ğ°Ñ‚ Ğ¸ Ñ‚Ğ¾, Ñ‡Ñ‚Ğ¾ Ğ¾Ğ½ Ğ½Ğµ Ğ¿Ğ¾Ğ¿Ğ°Ğ´Ğ°ĞµÑ‚ Ğ½Ğ° Ğ²Ñ‹Ñ…Ğ¾Ğ´Ğ½Ñ‹Ğµ.
        Ğ˜ÑĞ¿Ğ¾Ğ»ÑŒĞ·ÑƒĞµÑ‚ÑÑ Ğ¿Ñ€Ğ¸ ÑĞ¾Ğ·Ğ´Ğ°Ğ½Ğ¸Ğ¸/Ñ€ĞµĞ´Ğ°ĞºÑ‚Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğ¸ Ñ€ĞµĞ·ĞµÑ€Ğ²Ğ¾Ğ² Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ÑĞ¼Ğ¸.
        """
        self.financial_service.validate_date_range(start_date, end_date)
        
        # ĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑĞµĞ¼ Ğ²Ñ‹Ñ…Ğ¾Ğ´Ğ½Ñ‹Ğµ Ğ´Ğ½Ğ¸ Ğ´Ğ»Ñ Ğ°Ñ€ĞµĞ½Ğ´ (Ğ²Ğ¾Ğ·Ğ²Ñ€Ğ°Ñ‰Ğ°ĞµĞ¼ 409 Ñ Ñ‚Ğ¸Ğ¿Ğ¾Ğ¼ ISSUE_ON_HOLIDAY)
        start_result = await self.db.execute(select(Holiday).filter(Holiday.date == start_date))
        is_start_holiday = start_result.scalar_one_or_none()

        end_result = await self.db.execute(select(Holiday).filter(Holiday.date == end_date))
        is_end_holiday = end_result.scalar_one_or_none()

        if is_start_holiday and not force_issue_on_holiday:
            raise HTTPException(
                status_code=status.HTTP_409_CONFLICT,
                detail={
                    "error_type": "ISSUE_ON_HOLIDAY",
                    "message": f"Ğ”Ğ°Ñ‚Ğ° Ğ²Ñ‹Ğ´Ğ°Ñ‡Ğ¸ ({start_date.strftime('%d.%m.%Y')}) ÑĞ²Ğ»ÑĞµÑ‚ÑÑ Ğ²Ñ‹Ñ…Ğ¾Ğ´Ğ½Ñ‹Ğ¼ Ğ´Ğ½ĞµĞ¼."
                }
            )
        
        if is_end_holiday and not force_issue_on_holiday:
            raise HTTPException(
                status_code=status.HTTP_409_CONFLICT,
                detail={
                    "error_type": "ISSUE_ON_HOLIDAY",
                    "message": f"Ğ”Ğ°Ñ‚Ğ° Ğ¾ĞºĞ¾Ğ½Ñ‡Ğ°Ğ½Ğ¸Ñ ({end_date.strftime('%d.%m.%Y')}) ÑĞ²Ğ»ÑĞµÑ‚ÑÑ Ğ²Ñ‹Ñ…Ğ¾Ğ´Ğ½Ñ‹Ğ¼ Ğ´Ğ½ĞµĞ¼."
                }
            )

    async def validate_issue_on_holiday(self, issue_date: date, force: bool):
        """
        ĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑĞµÑ‚, ÑĞ²Ğ»ÑĞµÑ‚ÑÑ Ğ»Ğ¸ Ğ´Ğ°Ñ‚Ğ° Ğ²Ñ‹Ğ´Ğ°Ñ‡Ğ¸ Ğ²Ñ‹Ñ…Ğ¾Ğ´Ğ½Ñ‹Ğ¼ Ğ´Ğ½ĞµĞ¼.
        Ğ’Ğ¾Ğ·Ğ²Ñ€Ğ°Ñ‰Ğ°ĞµÑ‚ Ğ¾ÑˆĞ¸Ğ±ĞºÑƒ 409 Conflict, ĞµÑĞ»Ğ¸ ÑÑ‚Ğ¾ Ñ‚Ğ°Ğº Ğ¸ Ğ½Ğµ ÑƒÑÑ‚Ğ°Ğ½Ğ¾Ğ²Ğ»ĞµĞ½ Ñ„Ğ»Ğ°Ğ³ force.
        Ğ˜ÑĞ¿Ğ¾Ğ»ÑŒĞ·ÑƒĞµÑ‚ÑÑ Ğ² Ğ°Ğ´Ğ¼Ğ¸Ğ½-Ğ¿Ğ°Ğ½ĞµĞ»Ğ¸ Ğ¿Ñ€Ğ¸ ĞºĞ¾Ğ½Ğ²ĞµÑ€Ñ‚Ğ°Ñ†Ğ¸Ğ¸ Ñ€ĞµĞ·ĞµÑ€Ğ²Ğ° Ğ² Ğ°Ñ€ĞµĞ½Ğ´Ñƒ.
        """
        is_holiday_result = await self.db.execute(select(Holiday).filter(Holiday.date == issue_date))
        is_holiday = is_holiday_result.scalar_one_or_none()
        
        if is_holiday and not force:
            raise HTTPException(
                status_code=status.HTTP_409_CONFLICT,
                detail={
                    "error_type": "ISSUE_ON_HOLIDAY",
                    "message": f"Ğ”Ğ°Ñ‚Ğ° Ğ²Ñ‹Ğ´Ğ°Ñ‡Ğ¸ ({issue_date.strftime('%d.%m.%Y')}) ÑĞ²Ğ»ÑĞµÑ‚ÑÑ Ğ²Ñ‹Ñ…Ğ¾Ğ´Ğ½Ñ‹Ğ¼ Ğ´Ğ½ĞµĞ¼. ĞŸĞ¾Ğ´Ñ‚Ğ²ĞµÑ€Ğ´Ğ¸Ñ‚Ğµ Ğ´ĞµĞ¹ÑÑ‚Ğ²Ğ¸Ğµ Ğ´Ğ»Ñ Ğ¿Ñ€Ğ¾Ğ´Ğ¾Ğ»Ğ¶ĞµĞ½Ğ¸Ñ."
                }
            )

    async def validate_equipment_availability(self, equipment_ids: list[int], start_date: date, end_date: date, exclude_reservation_id: Optional[int] = None):
        conflicting_ids = await self.availability_service.get_conflicting_equipment_ids(
            equipment_ids, start_date, end_date, exclude_reservation_id
        )
        if conflicting_ids:
            raise HTTPException(
                status_code=status.HTTP_409_CONFLICT,
                detail=f"ĞĞ±Ğ¾Ñ€ÑƒĞ´Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ Ñ ID {conflicting_ids} Ğ½ĞµĞ´Ğ¾ÑÑ‚ÑƒĞ¿Ğ½Ğ¾ Ğ² Ğ²Ñ‹Ğ±Ñ€Ğ°Ğ½Ğ½Ñ‹Ğ¹ Ğ¿ĞµÑ€Ğ¸Ğ¾Ğ´."
            )

    def validate_accessories_for_equipment(self, selected_accessories: Optional[Dict[int, List[int]]], equipment_ids: List[int]):
        if not selected_accessories:
            return

        accessory_eq_ids = set(selected_accessories.keys())
        if not accessory_eq_ids.issubset(set(equipment_ids)):
            missing_eq_ids = accessory_eq_ids - set(equipment_ids)
            raise HTTPException(status_code=status.HTTP_400_BAD_REQUEST, detail=f"ĞĞºÑĞµÑÑÑƒĞ°Ñ€Ñ‹ Ğ½Ğµ Ğ¼Ğ¾Ğ³ÑƒÑ‚ Ğ±Ñ‹Ñ‚ÑŒ Ğ²Ñ‹Ğ±Ñ€Ğ°Ğ½Ñ‹ Ğ´Ğ»Ñ Ğ¾Ğ±Ğ¾Ñ€ÑƒĞ´Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ, Ğ¾Ñ‚ÑÑƒÑ‚ÑÑ‚Ğ²ÑƒÑÑ‰ĞµĞ³Ğ¾ Ğ² Ñ€ĞµĞ·ĞµÑ€Ğ²Ğµ. ĞĞµĞ²ĞµÑ€Ğ½Ñ‹Ğµ ID Ğ¾Ğ±Ğ¾Ñ€ÑƒĞ´Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ: {list(missing_eq_ids)}")

    def validate_reservation_is_cancellable(self, reservation: Reservation):
        if reservation.rental:
            raise HTTPException(status_code=status.HTTP_409_CONFLICT, detail=f"ĞĞµĞ»ÑŒĞ·Ñ Ğ¾Ñ‚Ğ¼ĞµĞ½Ğ¸Ñ‚ÑŒ Ñ€ĞµĞ·ĞµÑ€Ğ², Ñ‚Ğ°Ğº ĞºĞ°Ğº Ğ¾Ğ½ Ğ±Ñ‹Ğ» Ğ¿Ñ€ĞµĞ¾Ğ±Ñ€Ğ°Ğ·Ğ¾Ğ²Ğ°Ğ½ Ğ² Ğ°Ñ€ĞµĞ½Ğ´Ñƒ #{reservation.rental.id}.")

    def filter_cancellable_reservations(self, reservations: List[Reservation]) -> Tuple[List[Reservation], List[Reservation]]:
        cancellable = [r for r in reservations if not r.rental]
        not_cancellable = [r for r in reservations if r.rental]
        return cancellable, not_cancellable

    def validate_reservation_for_conversion(self, reservation: Reservation):
        if reservation.status != 'active':
            raise HTTPException(status_code=status.HTTP_409_CONFLICT, detail="Ğ ĞµĞ·ĞµÑ€Ğ² ÑƒĞ¶Ğµ Ğ²Ñ‹Ğ¿Ğ¾Ğ»Ğ½ĞµĞ½ Ğ¸Ğ»Ğ¸ Ğ¾Ñ‚Ğ¼ĞµĞ½ĞµĞ½.")
        if reservation.rental:
            raise HTTPException(status_code=status.HTTP_409_CONFLICT, detail=f"Ğ ĞµĞ·ĞµÑ€Ğ² ÑƒĞ¶Ğµ Ğ±Ñ‹Ğ» Ğ¿Ñ€ĞµĞ¾Ğ±Ñ€Ğ°Ğ·Ğ¾Ğ²Ğ°Ğ½ Ğ² Ğ°Ñ€ĞµĞ½Ğ´Ñƒ #{reservation.rental.id}.")

    def validate_accessories_returned(self, rental: Rental, confirmation: bool):
        if rental.accessory_links and not confirmation:
            raise HTTPException(status_code=status.HTTP_400_BAD_REQUEST, detail="Ğ¢Ñ€ĞµĞ±ÑƒĞµÑ‚ÑÑ Ğ¿Ğ¾Ğ´Ñ‚Ğ²ĞµÑ€Ğ¶Ğ´ĞµĞ½Ğ¸Ğµ Ğ²Ğ¾Ğ·Ğ²Ñ€Ğ°Ñ‚Ğ° Ğ²ÑĞµÑ… Ğ°ĞºÑĞµÑÑÑƒĞ°Ñ€Ğ¾Ğ².")

    def validate_rental_for_revert(self, rental: Rental):
        if not rental.reservation_id:
            raise HTTPException(status_code=status.HTTP_400_BAD_REQUEST, detail="ĞĞµĞ»ÑŒĞ·Ñ Ğ¾Ñ‚Ğ¼ĞµĞ½Ğ¸Ñ‚ÑŒ Ğ°Ñ€ĞµĞ½Ğ´Ñƒ, ÑĞ¾Ğ·Ğ´Ğ°Ğ½Ğ½ÑƒÑ Ğ±ĞµĞ· Ñ€ĞµĞ·ĞµÑ€Ğ²Ğ°.")
        
        # ĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑĞµĞ¼, Ñ‡Ñ‚Ğ¾ Ğ°Ñ€ĞµĞ½Ğ´Ğ° Ğ½Ğµ Ğ·Ğ°Ğ²ĞµÑ€ÑˆĞµĞ½Ğ°
        if rental.status == 'completed':
            raise HTTPException(status_code=status.HTTP_409_CONFLICT, detail="ĞĞµĞ»ÑŒĞ·Ñ Ğ¾Ñ‚Ğ¼ĞµĞ½Ğ¸Ñ‚ÑŒ Ğ²Ñ‹Ğ´Ğ°Ñ‡Ñƒ Ğ´Ğ»Ñ ÑƒĞ¶Ğµ Ğ·Ğ°Ğ²ĞµÑ€ÑˆĞµĞ½Ğ½Ğ¾Ğ¹ Ğ°Ñ€ĞµĞ½Ğ´Ñ‹.")
        
        # Ğ¡Ñ€Ğ°Ğ²Ğ½Ğ¸Ğ²Ğ°ĞµĞ¼ Ğ´Ğ°Ñ‚Ñƒ ÑĞ¾Ğ·Ğ´Ğ°Ğ½Ğ¸Ñ Ğ°Ñ€ĞµĞ½Ğ´Ñ‹ (Ğ² UTC) Ñ Ñ‚ĞµĞºÑƒÑ‰ĞµĞ¹ Ğ´Ğ°Ñ‚Ğ¾Ğ¹ (Ğ² UTC),
        # Ñ‡Ñ‚Ğ¾Ğ±Ñ‹ Ğ¸Ğ·Ğ±ĞµĞ¶Ğ°Ñ‚ÑŒ Ğ¿Ñ€Ğ¾Ğ±Ğ»ĞµĞ¼ Ñ Ñ‡Ğ°ÑĞ¾Ğ²Ñ‹Ğ¼Ğ¸ Ğ¿Ğ¾ÑÑĞ°Ğ¼Ğ¸ Ğ½Ğ° Ğ³Ñ€Ğ°Ğ½Ğ¸Ñ†Ğµ ÑÑƒÑ‚Ğ¾Ğº.
        if rental.created_at.date() != datetime.now(timezone.utc).date():
            raise HTTPException(status_code=status.HTTP_403_FORBIDDEN, detail="ĞÑ‚Ğ¼ĞµĞ½Ğ° Ğ²Ñ‹Ğ´Ğ°Ñ‡Ğ¸ Ğ²Ğ¾Ğ·Ğ¼Ğ¾Ğ¶Ğ½Ğ° Ñ‚Ğ¾Ğ»ÑŒĞºĞ¾ Ğ² Ğ´ĞµĞ½ÑŒ ÑĞ¾Ğ·Ğ´Ğ°Ğ½Ğ¸Ñ Ğ°Ñ€ĞµĞ½Ğ´Ñ‹.")

```


## <a name="RentalAppFASTAPIapiservicespromocodeinitpy"></a>`RentalApp_FASTAPI/api/services/promo_code/__init__.py`

```python
// path: RentalApp_FASTAPI/api/services/promo_code/__init__.py

# api/services/promo_code/__init__.py

from .promo_code_validator import PromoCodeValidator
from .promo_code_manager import PromoCodeManager
from .promo_code_business_logic import PromoCodeBusinessLogic
from .factory import PromoCodeServiceFactory
from .interfaces import IPromoCodeValidator, IPromoCodeManager, IPromoCodeBusinessLogic

__all__ = [
    'PromoCodeValidator',
    'PromoCodeManager', 
    'PromoCodeBusinessLogic',
    'PromoCodeServiceFactory',
    'IPromoCodeValidator',
    'IPromoCodeManager',
    'IPromoCodeBusinessLogic'
] 

```


## <a name="RentalAppFASTAPIapiservicespromocodeconstantspy"></a>`RentalApp_FASTAPI/api/services/promo_code/constants.py`

```python
// path: RentalApp_FASTAPI/api/services/promo_code/constants.py

# api/services/promo_code/constants.py

from fastapi import status

# Ğ¡Ğ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ñ Ğ¾Ğ± Ğ¾ÑˆĞ¸Ğ±ĞºĞ°Ñ…
ERROR_MESSAGES = {
    'NOT_FOUND': 'ĞŸÑ€Ğ¾Ğ¼Ğ¾ĞºĞ¾Ğ´ Ğ½Ğµ Ğ½Ğ°Ğ¹Ğ´ĞµĞ½',
    'INACTIVE': 'ĞŸÑ€Ğ¾Ğ¼Ğ¾ĞºĞ¾Ğ´ Ğ½ĞµĞ°ĞºÑ‚Ğ¸Ğ²ĞµĞ½',
    'NOT_STARTED': 'ĞŸÑ€Ğ¾Ğ¼Ğ¾ĞºĞ¾Ğ´ ĞµÑ‰Ğµ Ğ½Ğµ Ğ½Ğ°Ñ‡Ğ°Ğ» Ğ´ĞµĞ¹ÑÑ‚Ğ²Ğ¾Ğ²Ğ°Ñ‚ÑŒ',
    'EXPIRED': 'Ğ¡Ñ€Ğ¾Ğº Ğ´ĞµĞ¹ÑÑ‚Ğ²Ğ¸Ñ Ğ¿Ñ€Ğ¾Ğ¼Ğ¾ĞºĞ¾Ğ´Ğ° Ğ¸ÑÑ‚ĞµĞº',
    'USAGE_LIMIT_EXCEEDED': 'Ğ›Ğ¸Ğ¼Ğ¸Ñ‚ Ğ¸ÑĞ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğ¹ ÑÑ‚Ğ¾Ğ³Ğ¾ Ğ¿Ñ€Ğ¾Ğ¼Ğ¾ĞºĞ¾Ğ´Ğ° Ğ¸ÑÑ‡ĞµÑ€Ğ¿Ğ°Ğ½',
    'MIN_ORDER_AMOUNT': 'ĞœĞ¸Ğ½Ğ¸Ğ¼Ğ°Ğ»ÑŒĞ½Ğ°Ñ ÑÑƒĞ¼Ğ¼Ğ° Ğ·Ğ°ĞºĞ°Ğ·Ğ° Ğ´Ğ»Ñ ÑÑ‚Ğ¾Ğ³Ğ¾ ĞºĞ¾Ğ´Ğ°: {amount} â‚½',
    'INVALID_EQUIPMENT': 'ĞŸÑ€Ğ¾Ğ¼Ğ¾ĞºĞ¾Ğ´ Ğ½Ğµ Ğ´ĞµĞ¹ÑÑ‚Ğ²ÑƒĞµÑ‚ Ğ½Ğ° Ğ²Ñ‹Ğ±Ñ€Ğ°Ğ½Ğ½Ñ‹Ğµ Ñ‚Ğ¾Ğ²Ğ°Ñ€Ñ‹',
    'INVALID_EQUIPMENT_TYPE': 'ĞŸÑ€Ğ¾Ğ¼Ğ¾ĞºĞ¾Ğ´ Ğ½Ğµ Ğ´ĞµĞ¹ÑÑ‚Ğ²ÑƒĞµÑ‚ Ğ½Ğ° Ğ²Ñ‹Ğ±Ñ€Ğ°Ğ½Ğ½Ñ‹Ğµ ĞºĞ°Ñ‚ĞµĞ³Ğ¾Ñ€Ğ¸Ğ¸ Ñ‚Ğ¾Ğ²Ğ°Ñ€Ğ¾Ğ²',
    'PERSONAL_CODE_FORBIDDEN': 'Ğ­Ñ‚Ğ¾ Ğ¿ĞµÑ€ÑĞ¾Ğ½Ğ°Ğ»ÑŒĞ½Ñ‹Ğ¹ Ğ¿Ñ€Ğ¾Ğ¼Ğ¾ĞºĞ¾Ğ´ Ğ´Ğ»Ñ Ğ´Ñ€ÑƒĞ³Ğ¾Ğ³Ğ¾ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ñ',
    'USER_USAGE_LIMIT': 'Ğ’Ñ‹ ÑƒĞ¶Ğµ Ğ¸ÑĞ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ğ»Ğ¸ ÑÑ‚Ğ¾Ñ‚ Ğ¿Ñ€Ğ¾Ğ¼Ğ¾ĞºĞ¾Ğ´ Ğ¼Ğ°ĞºÑĞ¸Ğ¼Ğ°Ğ»ÑŒĞ½Ğ¾Ğµ ĞºĞ¾Ğ»Ğ¸Ñ‡ĞµÑÑ‚Ğ²Ğ¾ Ñ€Ğ°Ğ·',
    'CODE_EXISTS': 'ĞŸÑ€Ğ¾Ğ¼Ğ¾ĞºĞ¾Ğ´ Ñ Ñ‚Ğ°ĞºĞ¸Ğ¼ ĞºĞ¾Ğ´Ğ¾Ğ¼ ÑƒĞ¶Ğµ ÑÑƒÑ‰ĞµÑÑ‚Ğ²ÑƒĞµÑ‚',
    'EQUIPMENT_NOT_FOUND': 'ĞĞ´Ğ½Ğ¾ Ğ¸Ğ»Ğ¸ Ğ½ĞµÑĞºĞ¾Ğ»ÑŒĞºĞ¾ Ğ¾Ğ±Ğ¾Ñ€ÑƒĞ´Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğ¹ Ğ´Ğ»Ñ Ğ¿Ñ€Ğ¾Ğ¼Ğ¾ĞºĞ¾Ğ´Ğ° Ğ½Ğµ Ğ½Ğ°Ğ¹Ğ´ĞµĞ½Ñ‹.',
    'MANAGER_DISCOUNT_LIMIT': 'ĞœĞµĞ½ĞµĞ´Ğ¶ĞµÑ€Ñ‹ Ğ½Ğµ Ğ¼Ğ¾Ğ³ÑƒÑ‚ ÑĞ¾Ğ·Ğ´Ğ°Ğ²Ğ°Ñ‚ÑŒ ÑĞºĞ¸Ğ´ĞºÑƒ Ğ±Ğ¾Ğ»ĞµĞµ 20%',
    'ADMIN_DISCOUNT_LIMIT': 'ĞĞ´Ğ¼Ğ¸Ğ½Ğ¸ÑÑ‚Ñ€Ğ°Ñ‚Ğ¾Ñ€Ñ‹ Ğ½Ğµ Ğ¼Ğ¾Ğ³ÑƒÑ‚ ÑĞ¾Ğ·Ğ´Ğ°Ğ²Ğ°Ñ‚ÑŒ ÑĞºĞ¸Ğ´ĞºÑƒ Ğ±Ğ¾Ğ»ĞµĞµ 50%'
}

# ĞšĞ¾Ğ´Ñ‹ ÑÑ‚Ğ°Ñ‚ÑƒÑĞ¾Ğ² HTTP
HTTP_STATUS_CODES = {
    'NOT_FOUND': status.HTTP_404_NOT_FOUND,
    'BAD_REQUEST': status.HTTP_400_BAD_REQUEST,
    'FORBIDDEN': status.HTTP_403_FORBIDDEN,
    'CONFLICT': status.HTTP_409_CONFLICT
}

# Ğ›Ğ¸Ğ¼Ğ¸Ñ‚Ñ‹ ÑĞºĞ¸Ğ´Ğ¾Ğº Ğ¿Ğ¾ Ñ€Ğ¾Ğ»ÑĞ¼
DISCOUNT_LIMITS = {
    'manager': 20,
    'admin': 50
}

# ĞœĞ°ĞºÑĞ¸Ğ¼Ğ°Ğ»ÑŒĞ½Ñ‹Ğ¹ ĞºĞ¾Ğ¼Ğ±Ğ¸Ğ½Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ½Ñ‹Ğ¹ Ğ¿Ñ€Ğ¾Ñ†ĞµĞ½Ñ‚ ÑĞºĞ¸Ğ´ĞºĞ¸
MAX_COMBINED_DISCOUNT = 75 

```


## <a name="RentalAppFASTAPIapiservicespromocodeexceptionspy"></a>`RentalApp_FASTAPI/api/services/promo_code/exceptions.py`

```python
// path: RentalApp_FASTAPI/api/services/promo_code/exceptions.py

# api/services/promo_code/exceptions.py

from fastapi import HTTPException
from .constants import ERROR_MESSAGES, HTTP_STATUS_CODES


class PromoCodeException(HTTPException):
    """Ğ‘Ğ°Ğ·Ğ¾Ğ²Ğ¾Ğµ Ğ¸ÑĞºĞ»ÑÑ‡ĞµĞ½Ğ¸Ğµ Ğ´Ğ»Ñ Ğ¿Ñ€Ğ¾Ğ¼Ğ¾ĞºĞ¾Ğ´Ğ¾Ğ²"""
    pass


class PromoCodeNotFoundError(PromoCodeException):
    def __init__(self):
        super().__init__(
            status_code=HTTP_STATUS_CODES['NOT_FOUND'],
            detail=ERROR_MESSAGES['NOT_FOUND']
        )


class PromoCodeInactiveError(PromoCodeException):
    def __init__(self):
        super().__init__(
            status_code=HTTP_STATUS_CODES['BAD_REQUEST'],
            detail=ERROR_MESSAGES['INACTIVE']
        )


class PromoCodeNotStartedError(PromoCodeException):
    def __init__(self):
        super().__init__(
            status_code=HTTP_STATUS_CODES['BAD_REQUEST'],
            detail=ERROR_MESSAGES['NOT_STARTED']
        )


class PromoCodeExpiredError(PromoCodeException):
    def __init__(self):
        super().__init__(
            status_code=HTTP_STATUS_CODES['BAD_REQUEST'],
            detail=ERROR_MESSAGES['EXPIRED']
        )


class PromoCodeUsageLimitExceededError(PromoCodeException):
    def __init__(self):
        super().__init__(
            status_code=HTTP_STATUS_CODES['BAD_REQUEST'],
            detail=ERROR_MESSAGES['USAGE_LIMIT_EXCEEDED']
        )


class PromoCodeMinOrderAmountError(PromoCodeException):
    def __init__(self, min_amount: float):
        super().__init__(
            status_code=HTTP_STATUS_CODES['BAD_REQUEST'],
            detail=ERROR_MESSAGES['MIN_ORDER_AMOUNT'].format(amount=min_amount)
        )


class PromoCodeInvalidEquipmentError(PromoCodeException):
    def __init__(self):
        super().__init__(
            status_code=HTTP_STATUS_CODES['BAD_REQUEST'],
            detail=ERROR_MESSAGES['INVALID_EQUIPMENT']
        )


class PromoCodeInvalidEquipmentTypeError(PromoCodeException):
    def __init__(self):
        super().__init__(
            status_code=HTTP_STATUS_CODES['BAD_REQUEST'],
            detail=ERROR_MESSAGES['INVALID_EQUIPMENT_TYPE']
        )


class PromoCodePersonalCodeForbiddenError(PromoCodeException):
    def __init__(self):
        super().__init__(
            status_code=HTTP_STATUS_CODES['FORBIDDEN'],
            detail=ERROR_MESSAGES['PERSONAL_CODE_FORBIDDEN']
        )


class PromoCodeUserUsageLimitError(PromoCodeException):
    def __init__(self):
        super().__init__(
            status_code=HTTP_STATUS_CODES['BAD_REQUEST'],
            detail=ERROR_MESSAGES['USER_USAGE_LIMIT']
        )


class PromoCodeExistsError(PromoCodeException):
    def __init__(self):
        super().__init__(
            status_code=HTTP_STATUS_CODES['CONFLICT'],
            detail=ERROR_MESSAGES['CODE_EXISTS']
        )


class PromoCodeEquipmentNotFoundError(PromoCodeException):
    def __init__(self):
        super().__init__(
            status_code=HTTP_STATUS_CODES['NOT_FOUND'],
            detail=ERROR_MESSAGES['EQUIPMENT_NOT_FOUND']
        )


class PromoCodeDiscountLimitError(PromoCodeException):
    def __init__(self, role: str):
        message_key = f'{role.upper()}_DISCOUNT_LIMIT'
        super().__init__(
            status_code=HTTP_STATUS_CODES['FORBIDDEN'],
            detail=ERROR_MESSAGES[message_key]
        ) 

```


## <a name="RentalAppFASTAPIapiservicespromocodefactorypy"></a>`RentalApp_FASTAPI/api/services/promo_code/factory.py`

```python
// path: RentalApp_FASTAPI/api/services/promo_code/factory.py

# api/services/promo_code/factory.py

from sqlalchemy.ext.asyncio import AsyncSession
from .promo_code_validator import PromoCodeValidator
from .promo_code_manager import PromoCodeManager
from .promo_code_business_logic import PromoCodeBusinessLogic


class PromoCodeServiceFactory:
    """Ğ¤Ğ°Ğ±Ñ€Ğ¸ĞºĞ° Ğ´Ğ»Ñ ÑĞ¾Ğ·Ğ´Ğ°Ğ½Ğ¸Ñ ÑĞµÑ€Ğ²Ğ¸ÑĞ¾Ğ² Ğ¿Ñ€Ğ¾Ğ¼Ğ¾ĞºĞ¾Ğ´Ğ¾Ğ²"""
    
    @staticmethod
    def create_validator(db: AsyncSession) -> PromoCodeValidator:
        """Ğ¡Ğ¾Ğ·Ğ´Ğ°ĞµÑ‚ Ğ²Ğ°Ğ»Ğ¸Ğ´Ğ°Ñ‚Ğ¾Ñ€ Ğ¿Ñ€Ğ¾Ğ¼Ğ¾ĞºĞ¾Ğ´Ğ¾Ğ²"""
        return PromoCodeValidator(db)
    
    @staticmethod
    def create_manager(db: AsyncSession) -> PromoCodeManager:
        """Ğ¡Ğ¾Ğ·Ğ´Ğ°ĞµÑ‚ Ğ¼ĞµĞ½ĞµĞ´Ğ¶ĞµÑ€ Ğ¿Ñ€Ğ¾Ğ¼Ğ¾ĞºĞ¾Ğ´Ğ¾Ğ²"""
        return PromoCodeManager(db)
    
    @staticmethod
    def create_business_logic(db: AsyncSession) -> PromoCodeBusinessLogic:
        """Ğ¡Ğ¾Ğ·Ğ´Ğ°ĞµÑ‚ Ğ±Ğ¸Ğ·Ğ½ĞµÑ-Ğ»Ğ¾Ğ³Ğ¸ĞºÑƒ Ğ¿Ñ€Ğ¾Ğ¼Ğ¾ĞºĞ¾Ğ´Ğ¾Ğ²"""
        return PromoCodeBusinessLogic(db)
    
    @staticmethod
    def create_all_services(db: AsyncSession) -> tuple[PromoCodeValidator, PromoCodeManager, PromoCodeBusinessLogic]:
        """Ğ¡Ğ¾Ğ·Ğ´Ğ°ĞµÑ‚ Ğ²ÑĞµ ÑĞµÑ€Ğ²Ğ¸ÑÑ‹ Ğ¿Ñ€Ğ¾Ğ¼Ğ¾ĞºĞ¾Ğ´Ğ¾Ğ²"""
        validator = PromoCodeValidator(db)
        manager = PromoCodeManager(db)
        business_logic = PromoCodeBusinessLogic(db)
        
        return validator, manager, business_logic 

```


## <a name="RentalAppFASTAPIapiservicespromocodeinterfacespy"></a>`RentalApp_FASTAPI/api/services/promo_code/interfaces.py`

```python
// path: RentalApp_FASTAPI/api/services/promo_code/interfaces.py

# api/services/promo_code/interfaces.py

from abc import ABC, abstractmethod
from typing import Optional, List
from sqlalchemy.orm import Session

from api.models.promo_code import PromoCode
from api.models.user import User
from shared.schemas.promo_code_schema import PromoCodeCreate, PromoCodeUpdate, PromoCodeValidateResponse


class IPromoCodeValidator(ABC):
    """Ğ˜Ğ½Ñ‚ĞµÑ€Ñ„ĞµĞ¹Ñ Ğ´Ğ»Ñ Ğ²Ğ°Ğ»Ğ¸Ğ´Ğ°Ñ‚Ğ¾Ñ€Ğ° Ğ¿Ñ€Ğ¾Ğ¼Ğ¾ĞºĞ¾Ğ´Ğ¾Ğ²"""
    
    @abstractmethod
    def validate_complete(self, code: str, order_amount: float, equipment_ids: List[int], user: Optional[User]) -> PromoCode:
        """Ğ’Ñ‹Ğ¿Ğ¾Ğ»Ğ½ÑĞµÑ‚ Ğ¿Ğ¾Ğ»Ğ½ÑƒÑ Ğ²Ğ°Ğ»Ğ¸Ğ´Ğ°Ñ†Ğ¸Ñ Ğ¿Ñ€Ğ¾Ğ¼Ğ¾ĞºĞ¾Ğ´Ğ°"""
        pass


class IPromoCodeManager(ABC):
    """Ğ˜Ğ½Ñ‚ĞµÑ€Ñ„ĞµĞ¹Ñ Ğ´Ğ»Ñ Ğ¼ĞµĞ½ĞµĞ´Ğ¶ĞµÑ€Ğ° Ğ¿Ñ€Ğ¾Ğ¼Ğ¾ĞºĞ¾Ğ´Ğ¾Ğ²"""
    
    @abstractmethod
    def create_promo_code(self, promo_data: PromoCodeCreate, creator: User) -> PromoCode:
        """Ğ¡Ğ¾Ğ·Ğ´Ğ°ĞµÑ‚ Ğ½Ğ¾Ğ²Ñ‹Ğ¹ Ğ¿Ñ€Ğ¾Ğ¼Ğ¾ĞºĞ¾Ğ´"""
        pass
    
    @abstractmethod
    def get_all_promo_codes(self) -> List[PromoCode]:
        """ĞŸĞ¾Ğ»ÑƒÑ‡Ğ°ĞµÑ‚ Ğ²ÑĞµ Ğ¿Ñ€Ğ¾Ğ¼Ğ¾ĞºĞ¾Ğ´Ñ‹"""
        pass
    
    @abstractmethod
    def get_promo_code_by_id(self, promo_code_id: int) -> Optional[PromoCode]:
        """ĞŸĞ¾Ğ»ÑƒÑ‡Ğ°ĞµÑ‚ Ğ¿Ñ€Ğ¾Ğ¼Ğ¾ĞºĞ¾Ğ´ Ğ¿Ğ¾ ID"""
        pass
    
    @abstractmethod
    def update_promo_code(self, promo_code_id: int, update_data: PromoCodeUpdate) -> PromoCode:
        """ĞĞ±Ğ½Ğ¾Ğ²Ğ»ÑĞµÑ‚ Ğ¿Ñ€Ğ¾Ğ¼Ğ¾ĞºĞ¾Ğ´"""
        pass
    
    @abstractmethod
    def delete_promo_code(self, promo_code_id: int) -> None:
        """Ğ£Ğ´Ğ°Ğ»ÑĞµÑ‚ Ğ¿Ñ€Ğ¾Ğ¼Ğ¾ĞºĞ¾Ğ´"""
        pass
    
    @abstractmethod
    def generate_unique_code(self) -> str:
        """Ğ“ĞµĞ½ĞµÑ€Ğ¸Ñ€ÑƒĞµÑ‚ ÑƒĞ½Ğ¸ĞºĞ°Ğ»ÑŒĞ½Ñ‹Ğ¹ ĞºĞ¾Ğ´"""
        pass


class IPromoCodeBusinessLogic(ABC):
    """Ğ˜Ğ½Ñ‚ĞµÑ€Ñ„ĞµĞ¹Ñ Ğ´Ğ»Ñ Ğ±Ğ¸Ğ·Ğ½ĞµÑ-Ğ»Ğ¾Ğ³Ğ¸ĞºĞ¸ Ğ¿Ñ€Ğ¾Ğ¼Ğ¾ĞºĞ¾Ğ´Ğ¾Ğ²"""
    
    @abstractmethod
    def validate_and_get_promo_code(self, code: str, order_amount: float, equipment_ids: List[int], user: Optional[User]) -> PromoCode:
        """Ğ’Ğ°Ğ»Ğ¸Ğ´Ğ¸Ñ€ÑƒĞµÑ‚ Ğ¿Ñ€Ğ¾Ğ¼Ğ¾ĞºĞ¾Ğ´ Ğ¸ Ğ²Ğ¾Ğ·Ğ²Ñ€Ğ°Ñ‰Ğ°ĞµÑ‚ ĞµĞ³Ğ¾"""
        pass
    
    @abstractmethod
    def create_validation_response(self, promo_code: PromoCode) -> PromoCodeValidateResponse:
        """Ğ¡Ğ¾Ğ·Ğ´Ğ°ĞµÑ‚ Ğ¾Ñ‚Ğ²ĞµÑ‚ Ğ´Ğ»Ñ Ğ²Ğ°Ğ»Ğ¸Ğ´Ğ°Ñ†Ğ¸Ğ¸"""
        pass
    
    @abstractmethod
    def record_promo_code_usage(self, promo_code: PromoCode, user: Optional[User]) -> None:
        """Ğ—Ğ°Ğ¿Ğ¸ÑÑ‹Ğ²Ğ°ĞµÑ‚ Ğ¸ÑĞ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ Ğ¿Ñ€Ğ¾Ğ¼Ğ¾ĞºĞ¾Ğ´Ğ°"""
        pass
    
    @abstractmethod
    def calculate_discount_amount(self, base_amount: float, promo_code: PromoCode) -> float:
        """Ğ Ğ°ÑÑÑ‡Ğ¸Ñ‚Ñ‹Ğ²Ğ°ĞµÑ‚ ÑÑƒĞ¼Ğ¼Ñƒ ÑĞºĞ¸Ğ´ĞºĞ¸"""
        pass
    
    @abstractmethod
    def validate_combined_discount(self, duration_discount: float, promo_discount: float) -> float:
        """Ğ’Ğ°Ğ»Ğ¸Ğ´Ğ¸Ñ€ÑƒĞµÑ‚ ĞºĞ¾Ğ¼Ğ±Ğ¸Ğ½Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ½ÑƒÑ ÑĞºĞ¸Ğ´ĞºÑƒ"""
        pass 

```


## <a name="RentalAppFASTAPIapiservicespromocodepromocodebusinesslogicpy"></a>`RentalApp_FASTAPI/api/services/promo_code/promo_code_business_logic.py`

```python
// path: RentalApp_FASTAPI/api/services/promo_code/promo_code_business_logic.py

# api/services/promo_code/promo_code_business_logic.py

from sqlalchemy.ext.asyncio import AsyncSession
from sqlalchemy import select
from typing import Optional, List
from datetime import datetime, timezone

from api.models.promo_code import PromoCode, promo_code_usages
from api.models.user import User
from shared.schemas.promo_code_schema import PromoCodeValidateResponse
from .promo_code_validator import PromoCodeValidator
from .constants import MAX_COMBINED_DISCOUNT
from .interfaces import IPromoCodeBusinessLogic


class PromoCodeBusinessLogic(IPromoCodeBusinessLogic):
    """Ğ‘Ğ¸Ğ·Ğ½ĞµÑ-Ğ»Ğ¾Ğ³Ğ¸ĞºĞ° Ğ´Ğ»Ñ Ñ€Ğ°Ğ±Ğ¾Ñ‚Ñ‹ Ñ Ğ¿Ñ€Ğ¾Ğ¼Ğ¾ĞºĞ¾Ğ´Ğ°Ğ¼Ğ¸"""
    
    def __init__(self, db: AsyncSession):
        self.db = db
        self.validator = PromoCodeValidator(db)
    
    async def validate_and_get_promo_code(
        self, 
        code: str, 
        order_amount: float, 
        equipment_ids: List[int], 
        user: Optional[User]
    ) -> PromoCode:
        """
        Ğ’Ğ°Ğ»Ğ¸Ğ´Ğ¸Ñ€ÑƒĞµÑ‚ Ğ¿Ñ€Ğ¾Ğ¼Ğ¾ĞºĞ¾Ğ´ Ğ¸ Ğ²Ğ¾Ğ·Ğ²Ñ€Ğ°Ñ‰Ğ°ĞµÑ‚ ĞµĞ³Ğ¾ Ğ¾Ğ±ÑŠĞµĞºÑ‚.
        ĞÑĞ½Ğ¾Ğ²Ğ½Ğ¾Ğ¹ Ğ¼ĞµÑ‚Ğ¾Ğ´ Ğ´Ğ»Ñ Ğ²Ğ°Ğ»Ğ¸Ğ´Ğ°Ñ†Ğ¸Ğ¸ Ğ¿Ñ€Ğ¾Ğ¼Ğ¾ĞºĞ¾Ğ´Ğ¾Ğ².
        """
        return await self.validator.validate_complete(code, order_amount, equipment_ids, user)
    
    def create_validation_response(self, promo_code: PromoCode) -> PromoCodeValidateResponse:
        """Ğ¡Ğ¾Ğ·Ğ´Ğ°ĞµÑ‚ Ğ¾Ñ‚Ğ²ĞµÑ‚ Ğ´Ğ»Ñ Ğ²Ğ°Ğ»Ğ¸Ğ´Ğ°Ñ†Ğ¸Ğ¸ Ğ¿Ñ€Ğ¾Ğ¼Ğ¾ĞºĞ¾Ğ´Ğ°"""
        return PromoCodeValidateResponse(
            code=promo_code.code,
            discount_percentage=promo_code.discount_percentage,
            message="ĞŸÑ€Ğ¾Ğ¼Ğ¾ĞºĞ¾Ğ´ ÑƒÑĞ¿ĞµÑˆĞ½Ğ¾ Ğ¿Ñ€Ğ¸Ğ¼ĞµĞ½ĞµĞ½!"
        )
    
    async def record_promo_code_usage(self, promo_code: PromoCode, user: Optional[User]) -> None:
        """
        Ğ—Ğ°Ğ¿Ğ¸ÑÑ‹Ğ²Ğ°ĞµÑ‚ Ğ¸ÑĞ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ Ğ¿Ñ€Ğ¾Ğ¼Ğ¾ĞºĞ¾Ğ´Ğ° Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ĞµĞ¼.
        Ğ£Ğ²ĞµĞ»Ğ¸Ñ‡Ğ¸Ğ²Ğ°ĞµÑ‚ ÑÑ‡ĞµÑ‚Ñ‡Ğ¸Ğº Ğ¸ÑĞ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğ¹.
        """
        # Ğ£Ğ²ĞµĞ»Ğ¸Ñ‡Ğ¸Ğ²Ğ°ĞµĞ¼ Ğ¾Ğ±Ñ‰Ğ¸Ğ¹ ÑÑ‡ĞµÑ‚Ñ‡Ğ¸Ğº Ğ¸ÑĞ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğ¹
        promo_code.times_used += 1
        
        # Ğ—Ğ°Ğ¿Ğ¸ÑÑ‹Ğ²Ğ°ĞµĞ¼ Ğ¸ÑĞ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ĞµĞ¼, ĞµÑĞ»Ğ¸ Ğ¾Ğ½ Ğ°Ğ²Ñ‚Ğ¾Ñ€Ğ¸Ğ·Ğ¾Ğ²Ğ°Ğ½
        if user:
            # ĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑĞµĞ¼, Ğ½Ğµ Ğ·Ğ°Ğ¿Ğ¸ÑĞ°Ğ½Ğ¾ Ğ»Ğ¸ ÑƒĞ¶Ğµ Ğ¸ÑĞ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ
            result = await self.db.execute(select(promo_code_usages).filter_by(
                user_id=user.id,
                promo_code_id=promo_code.id
            ))
            existing_usage = result.first()
            
            if not existing_usage:
                # Ğ”Ğ¾Ğ±Ğ°Ğ²Ğ»ÑĞµĞ¼ Ğ·Ğ°Ğ¿Ğ¸ÑÑŒ Ğ¾Ğ± Ğ¸ÑĞ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğ¸
                await self.db.execute(
                    promo_code_usages.insert().values(
                        user_id=user.id,
                        promo_code_id=promo_code.id,
                        used_at=datetime.now(timezone.utc)
                    )
                )
        
        await self.db.commit()
    
    def calculate_discount_amount(self, base_amount: float, promo_code: PromoCode) -> float:
        """Ğ Ğ°ÑÑÑ‡Ğ¸Ñ‚Ñ‹Ğ²Ğ°ĞµÑ‚ ÑÑƒĞ¼Ğ¼Ñƒ ÑĞºĞ¸Ğ´ĞºĞ¸ Ğ¿Ğ¾ Ğ¿Ñ€Ğ¾Ğ¼Ğ¾ĞºĞ¾Ğ´Ñƒ"""
        return base_amount * (promo_code.discount_percentage / 100)
    
    def calculate_final_amount_with_promo(self, base_amount: float, promo_code: PromoCode) -> float:
        """Ğ Ğ°ÑÑÑ‡Ğ¸Ñ‚Ñ‹Ğ²Ğ°ĞµÑ‚ Ñ„Ğ¸Ğ½Ğ°Ğ»ÑŒĞ½ÑƒÑ ÑÑƒĞ¼Ğ¼Ñƒ Ñ ÑƒÑ‡ĞµÑ‚Ğ¾Ğ¼ ÑĞºĞ¸Ğ´ĞºĞ¸ Ğ¿Ğ¾ Ğ¿Ñ€Ğ¾Ğ¼Ğ¾ĞºĞ¾Ğ´Ñƒ"""
        discount_amount = self.calculate_discount_amount(base_amount, promo_code)
        return base_amount - discount_amount
    
    def validate_combined_discount(self, duration_discount: float, promo_discount: float) -> float:
        """
        ĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑĞµÑ‚ Ğ¸ ĞºĞ¾Ñ€Ñ€ĞµĞºÑ‚Ğ¸Ñ€ÑƒĞµÑ‚ ĞºĞ¾Ğ¼Ğ±Ğ¸Ğ½Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ½ÑƒÑ ÑĞºĞ¸Ğ´ĞºÑƒ.
        Ğ’Ğ¾Ğ·Ğ²Ñ€Ğ°Ñ‰Ğ°ĞµÑ‚ Ğ¸Ñ‚Ğ¾Ğ³Ğ¾Ğ²Ñ‹Ğ¹ Ğ¿Ñ€Ğ¾Ñ†ĞµĞ½Ñ‚ ÑĞºĞ¸Ğ´ĞºĞ¸.
        """
        total_discount = duration_discount + promo_discount
        if total_discount > MAX_COMBINED_DISCOUNT:
            return MAX_COMBINED_DISCOUNT
        return total_discount
    
    def get_promo_code_statistics(self, promo_code: PromoCode) -> dict:
        """ĞŸĞ¾Ğ»ÑƒÑ‡Ğ°ĞµÑ‚ ÑÑ‚Ğ°Ñ‚Ğ¸ÑÑ‚Ğ¸ĞºÑƒ Ğ¸ÑĞ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ Ğ¿Ñ€Ğ¾Ğ¼Ğ¾ĞºĞ¾Ğ´Ğ°"""
        total_uses = promo_code.times_used
        max_uses = promo_code.max_uses
        usage_percentage = (total_uses / max_uses * 100) if max_uses else None
        
        return {
            'total_uses': total_uses,
            'max_uses': max_uses,
            'usage_percentage': usage_percentage,
            'is_fully_used': max_uses and total_uses >= max_uses,
            'remaining_uses': max_uses - total_uses if max_uses else None
        }
    
    def is_promo_code_expired(self, promo_code: PromoCode) -> bool:
        """ĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑĞµÑ‚, Ğ¸ÑÑ‚ĞµĞº Ğ»Ğ¸ ÑÑ€Ğ¾Ğº Ğ´ĞµĞ¹ÑÑ‚Ğ²Ğ¸Ñ Ğ¿Ñ€Ğ¾Ğ¼Ğ¾ĞºĞ¾Ğ´Ğ°"""
        if not promo_code.expires_at:
            return False
        
        now_utc = datetime.now(timezone.utc)
        return promo_code.expires_at < now_utc
    
    def is_promo_code_active(self, promo_code: PromoCode) -> bool:
        """ĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑĞµÑ‚, Ğ°ĞºÑ‚Ğ¸Ğ²ĞµĞ½ Ğ»Ğ¸ Ğ¿Ñ€Ğ¾Ğ¼Ğ¾ĞºĞ¾Ğ´ (Ğ²ĞºĞ»ÑÑ‡Ğ°Ñ ÑÑ€Ğ¾ĞºĞ¸ Ğ´ĞµĞ¹ÑÑ‚Ğ²Ğ¸Ñ)"""
        if not promo_code.is_active:
            return False
        
        now_utc = datetime.now(timezone.utc)
        
        # ĞŸÑ€Ğ¾Ğ²ĞµÑ€ĞºĞ° Ğ´Ğ°Ñ‚Ñ‹ Ğ½Ğ°Ñ‡Ğ°Ğ»Ğ° Ğ´ĞµĞ¹ÑÑ‚Ğ²Ğ¸Ñ
        if promo_code.valid_from and promo_code.valid_from > now_utc:
            return False
        
        # ĞŸÑ€Ğ¾Ğ²ĞµÑ€ĞºĞ° Ğ´Ğ°Ñ‚Ñ‹ Ğ¾ĞºĞ¾Ğ½Ñ‡Ğ°Ğ½Ğ¸Ñ Ğ´ĞµĞ¹ÑÑ‚Ğ²Ğ¸Ñ
        if promo_code.expires_at and promo_code.expires_at < now_utc:
            return False
        
        return True 

```


## <a name="RentalAppFASTAPIapiservicespromocodepromocodemanagerpy"></a>`RentalApp_FASTAPI/api/services/promo_code/promo_code_manager.py`

```python
// path: RentalApp_FASTAPI/api/services/promo_code/promo_code_manager.py

# api/services/promo_code/promo_code_manager.py

from sqlalchemy.ext.asyncio import AsyncSession
from sqlalchemy.orm import joinedload
from sqlalchemy import select
from typing import List, Optional
import secrets

from api.models.promo_code import PromoCode, PromoCodeApplicableType
from api.models.equipment import Equipment
from api.models.user import User
from shared.schemas.promo_code_schema import PromoCodeCreate, PromoCodeUpdate
from .exceptions import (
    PromoCodeExistsError, PromoCodeEquipmentNotFoundError, 
    PromoCodeNotFoundError, PromoCodeDiscountLimitError
)
from .constants import DISCOUNT_LIMITS
from .interfaces import IPromoCodeManager


class PromoCodeManager(IPromoCodeManager):
    """ĞœĞµĞ½ĞµĞ´Ğ¶ĞµÑ€ Ğ´Ğ»Ñ CRUD Ğ¾Ğ¿ĞµÑ€Ğ°Ñ†Ğ¸Ğ¹ Ñ Ğ¿Ñ€Ğ¾Ğ¼Ğ¾ĞºĞ¾Ğ´Ğ°Ğ¼Ğ¸"""
    
    def __init__(self, db: AsyncSession):
        self.db = db
    
    async def create_promo_code(self, promo_data: PromoCodeCreate, creator: User) -> PromoCode:
        """Ğ¡Ğ¾Ğ·Ğ´Ğ°ĞµÑ‚ Ğ½Ğ¾Ğ²Ñ‹Ğ¹ Ğ¿Ñ€Ğ¾Ğ¼Ğ¾ĞºĞ¾Ğ´"""
        # ĞŸÑ€Ğ¾Ğ²ĞµÑ€ĞºĞ° Ğ»Ğ¸Ğ¼Ğ¸Ñ‚Ğ¾Ğ² ÑĞºĞ¸Ğ´ĞºĞ¸ Ğ¿Ğ¾ Ñ€Ğ¾Ğ»Ğ¸
        self._validate_discount_limit(creator.role, promo_data.discount_percentage)
        
        # ĞŸÑ€Ğ¾Ğ²ĞµÑ€ĞºĞ° ÑƒĞ½Ğ¸ĞºĞ°Ğ»ÑŒĞ½Ğ¾ÑÑ‚Ğ¸ ĞºĞ¾Ğ´Ğ°
        result = await self.db.execute(select(PromoCode).filter(PromoCode.code == promo_data.code))
        if result.scalar_one_or_none():
            raise PromoCodeExistsError()
        
        # Ğ¡Ğ¾Ğ·Ğ´Ğ°Ğ½Ğ¸Ğµ Ğ¾ÑĞ½Ğ¾Ğ²Ğ½Ğ¾Ğ³Ğ¾ Ğ¾Ğ±ÑŠĞµĞºÑ‚Ğ°
        promo_dict = promo_data.model_dump(exclude={'applicable_to_equipment_ids', 'applicable_to_equipment_types'})
        new_promo_code = PromoCode(**promo_dict, created_by_id=creator.id)
        
        # ĞĞ±Ñ€Ğ°Ğ±Ğ¾Ñ‚ĞºĞ° ÑĞ²ÑĞ·ĞµĞ¹ Ñ Ğ¾Ğ±Ğ¾Ñ€ÑƒĞ´Ğ¾Ğ²Ğ°Ğ½Ğ¸ĞµĞ¼
        await self._set_equipment_relations(new_promo_code, promo_data.applicable_to_equipment_ids)
        
        # ĞĞ±Ñ€Ğ°Ğ±Ğ¾Ñ‚ĞºĞ° ÑĞ²ÑĞ·ĞµĞ¹ Ñ Ñ‚Ğ¸Ğ¿Ğ°Ğ¼Ğ¸ Ğ¾Ğ±Ğ¾Ñ€ÑƒĞ´Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ
        self._set_equipment_type_relations(new_promo_code, promo_data.applicable_to_equipment_types)
        
        self.db.add(new_promo_code)
        await self.db.commit()
        await self.db.refresh(new_promo_code)
        
        # Ğ’Ğ¾Ğ·Ğ²Ñ€Ğ°Ñ‰Ğ°ĞµĞ¼ ÑĞ¾Ğ·Ğ´Ğ°Ğ½Ğ½Ñ‹Ğ¹ Ğ¾Ğ±ÑŠĞµĞºÑ‚ Ñ Ğ·Ğ°Ğ³Ñ€ÑƒĞ¶ĞµĞ½Ğ½Ñ‹Ğ¼Ğ¸ Ğ´Ğ°Ğ½Ğ½Ñ‹Ğ¼Ğ¸ Ğ¸Ğ· Ğ‘Ğ”
        result = await self.db.execute(
            select(PromoCode)
            .filter(PromoCode.id == new_promo_code.id)
            .options(joinedload(PromoCode.creator))
        )
        return result.unique().scalars().first()
    
    async def get_all_promo_codes(self) -> List[PromoCode]:
        """ĞŸĞ¾Ğ»ÑƒÑ‡Ğ°ĞµÑ‚ Ğ²ÑĞµ Ğ¿Ñ€Ğ¾Ğ¼Ğ¾ĞºĞ¾Ğ´Ñ‹ Ñ Ğ·Ğ°Ğ³Ñ€ÑƒĞ·ĞºĞ¾Ğ¹ ÑĞ²ÑĞ·Ğ°Ğ½Ğ½Ñ‹Ñ… Ğ´Ğ°Ğ½Ğ½Ñ‹Ñ…"""
        result = await self.db.execute(select(PromoCode).options(
            joinedload(PromoCode.creator)
        ).order_by(PromoCode.created_at.desc()))
        return result.unique().scalars().all()
    
    async def get_promo_code_by_id(self, promo_code_id: int) -> Optional[PromoCode]:
        """ĞŸĞ¾Ğ»ÑƒÑ‡Ğ°ĞµÑ‚ Ğ¿Ñ€Ğ¾Ğ¼Ğ¾ĞºĞ¾Ğ´ Ğ¿Ğ¾ ID"""
        result = await self.db.execute(select(PromoCode).filter(PromoCode.id == promo_code_id))
        return result.scalar_one_or_none()
    
    async def update_promo_code(self, promo_code_id: int, update_data: PromoCodeUpdate) -> PromoCode:
        """ĞĞ±Ğ½Ğ¾Ğ²Ğ»ÑĞµÑ‚ ÑÑƒÑ‰ĞµÑÑ‚Ğ²ÑƒÑÑ‰Ğ¸Ğ¹ Ğ¿Ñ€Ğ¾Ğ¼Ğ¾ĞºĞ¾Ğ´"""
        promo_code = await self.get_promo_code_by_id(promo_code_id)
        if not promo_code:
            raise PromoCodeNotFoundError()
        
        update_dict = update_data.model_dump(exclude_unset=True)
        
        # ĞĞ±Ñ€Ğ°Ğ±Ğ¾Ñ‚ĞºĞ° Ğ¾Ğ±Ğ½Ğ¾Ğ²Ğ»ĞµĞ½Ğ¸Ñ ÑĞ²ÑĞ·ĞµĞ¹ Ñ Ğ¾Ğ±Ğ¾Ñ€ÑƒĞ´Ğ¾Ğ²Ğ°Ğ½Ğ¸ĞµĞ¼
        if 'applicable_to_equipment_ids' in update_dict:
            equipment_ids = update_dict.pop('applicable_to_equipment_ids')
            await self._set_equipment_relations(promo_code, equipment_ids)
        
        # ĞĞ±Ñ€Ğ°Ğ±Ğ¾Ñ‚ĞºĞ° Ğ¾Ğ±Ğ½Ğ¾Ğ²Ğ»ĞµĞ½Ğ¸Ñ ÑĞ²ÑĞ·ĞµĞ¹ Ñ Ñ‚Ğ¸Ğ¿Ğ°Ğ¼Ğ¸ Ğ¾Ğ±Ğ¾Ñ€ÑƒĞ´Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ
        if 'applicable_to_equipment_types' in update_dict:
            equipment_types = update_dict.pop('applicable_to_equipment_types')
            self._set_equipment_type_relations(promo_code, equipment_types)
        
        # ĞĞ±Ğ½Ğ¾Ğ²Ğ»ĞµĞ½Ğ¸Ğµ Ğ¾ÑÑ‚Ğ°Ğ»ÑŒĞ½Ñ‹Ñ… Ğ¿Ğ¾Ğ»ĞµĞ¹
        for key, value in update_dict.items():
            setattr(promo_code, key, value)
        
        self.db.add(promo_code)
        await self.db.commit()
        
        # ĞŸĞ¾Ğ²Ñ‚Ğ¾Ñ€Ğ½Ğ¾ Ğ¿Ğ¾Ğ»ÑƒÑ‡Ğ°ĞµĞ¼ Ğ¾Ğ±ÑŠĞµĞºÑ‚ Ğ¸Ğ· Ğ‘Ğ” Ñ Ğ·Ğ°Ğ³Ñ€ÑƒĞ¶ĞµĞ½Ğ½Ñ‹Ğ¼Ğ¸ ÑĞ²ÑĞ·ÑĞ¼Ğ¸
        result = await self.db.execute(
            select(PromoCode)
            .filter(PromoCode.id == promo_code_id)
            .options(joinedload(PromoCode.creator))
        )
        return result.unique().scalars().first()
    
    async def delete_promo_code(self, promo_code_id: int) -> None:
        """Ğ£Ğ´Ğ°Ğ»ÑĞµÑ‚ Ğ¿Ñ€Ğ¾Ğ¼Ğ¾ĞºĞ¾Ğ´"""
        promo_code = await self.get_promo_code_by_id(promo_code_id)
        if not promo_code:
            raise PromoCodeNotFoundError()
        
        await self.db.delete(promo_code)
        await self.db.commit()
    
    async def generate_unique_code(self) -> str:
        """Ğ“ĞµĞ½ĞµÑ€Ğ¸Ñ€ÑƒĞµÑ‚ ÑƒĞ½Ğ¸ĞºĞ°Ğ»ÑŒĞ½Ñ‹Ğ¹ ĞºĞ¾Ğ´ Ğ¿Ñ€Ğ¾Ğ¼Ğ¾ĞºĞ¾Ğ´Ğ°"""
        while True:
            code = f"SALE-{secrets.token_hex(3).upper()}"
            result = await self.db.execute(select(PromoCode).filter(PromoCode.code == code))
            existing_code = result.scalar_one_or_none()
            if not existing_code:
                return code
    
    def _validate_discount_limit(self, role: str, discount_percentage: float) -> None:
        """ĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑĞµÑ‚ Ğ»Ğ¸Ğ¼Ğ¸Ñ‚ ÑĞºĞ¸Ğ´ĞºĞ¸ Ğ´Ğ»Ñ Ñ€Ğ¾Ğ»Ğ¸ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ñ"""
        if role in DISCOUNT_LIMITS and discount_percentage > DISCOUNT_LIMITS[role]:
            raise PromoCodeDiscountLimitError(role)
    
    async def _set_equipment_relations(self, promo_code: PromoCode, equipment_ids: Optional[List[int]]) -> None:
        """Ğ£ÑÑ‚Ğ°Ğ½Ğ°Ğ²Ğ»Ğ¸Ğ²Ğ°ĞµÑ‚ ÑĞ²ÑĞ·Ğ¸ Ñ Ğ¾Ğ±Ğ¾Ñ€ÑƒĞ´Ğ¾Ğ²Ğ°Ğ½Ğ¸ĞµĞ¼"""
        promo_code.applicable_equipment.clear()
        if equipment_ids:
            result = await self.db.execute(select(Equipment).filter(Equipment.id.in_(equipment_ids)))
            equipment = result.unique().scalars().all()
            if len(equipment) != len(equipment_ids):
                raise PromoCodeEquipmentNotFoundError()
            promo_code.applicable_equipment = equipment
    
    def _set_equipment_type_relations(self, promo_code: PromoCode, equipment_types: Optional[List[str]]) -> None:
        """Ğ£ÑÑ‚Ğ°Ğ½Ğ°Ğ²Ğ»Ğ¸Ğ²Ğ°ĞµÑ‚ ÑĞ²ÑĞ·Ğ¸ Ñ Ñ‚Ğ¸Ğ¿Ğ°Ğ¼Ğ¸ Ğ¾Ğ±Ğ¾Ñ€ÑƒĞ´Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ"""
        promo_code.applicable_types.clear()
        if equipment_types:
            promo_code.applicable_types = [
                PromoCodeApplicableType(type_name=t) for t in equipment_types
            ] 

```


## <a name="RentalAppFASTAPIapiservicespromocodepromocodevalidatorpy"></a>`RentalApp_FASTAPI/api/services/promo_code/promo_code_validator.py`

```python
// path: RentalApp_FASTAPI/api/services/promo_code/promo_code_validator.py

# api/services/promo_code/promo_code_validator.py

from sqlalchemy.ext.asyncio import AsyncSession
from sqlalchemy import select
from typing import Optional, List
from datetime import datetime, timezone

from api.models.promo_code import PromoCode, promo_code_usages
from api.models.user import User
from api.models.equipment import Equipment
from .exceptions import (
    PromoCodeNotFoundError, PromoCodeInactiveError, PromoCodeNotStartedError,
    PromoCodeExpiredError, PromoCodeUsageLimitExceededError, PromoCodeMinOrderAmountError,
    PromoCodeInvalidEquipmentError, PromoCodeInvalidEquipmentTypeError,
    PromoCodePersonalCodeForbiddenError, PromoCodeUserUsageLimitError
)
from .interfaces import IPromoCodeValidator


class PromoCodeValidator(IPromoCodeValidator):
    """Ğ’Ğ°Ğ»Ğ¸Ğ´Ğ°Ñ‚Ğ¾Ñ€ Ğ¿Ñ€Ğ¾Ğ¼Ğ¾ĞºĞ¾Ğ´Ğ¾Ğ² Ñ Ñ€Ğ°Ğ·Ğ´ĞµĞ»ĞµĞ½Ğ¸ĞµĞ¼ Ğ¾Ñ‚Ğ²ĞµÑ‚ÑÑ‚Ğ²ĞµĞ½Ğ½Ğ¾ÑÑ‚Ğ¸ Ğ¿Ğ¾ Ñ‚Ğ¸Ğ¿Ğ°Ğ¼ Ğ¿Ñ€Ğ¾Ğ²ĞµÑ€Ğ¾Ğº"""
    
    def __init__(self, db: AsyncSession):
        self.db = db
    
    async def validate_basic_existence(self, code: str) -> PromoCode:
        """ĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑĞµÑ‚ ÑÑƒÑ‰ĞµÑÑ‚Ğ²Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ Ğ¿Ñ€Ğ¾Ğ¼Ğ¾ĞºĞ¾Ğ´Ğ°"""
        result = await self.db.execute(select(PromoCode).filter(PromoCode.code == code))
        promo_code = result.unique().scalar_one_or_none()
        if not promo_code:
            raise PromoCodeNotFoundError()
        return promo_code
    
    def validate_status_and_dates(self, promo_code: PromoCode) -> None:
        """ĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑĞµÑ‚ Ğ°ĞºÑ‚Ğ¸Ğ²Ğ½Ğ¾ÑÑ‚ÑŒ Ğ¸ ÑÑ€Ğ¾ĞºĞ¸ Ğ´ĞµĞ¹ÑÑ‚Ğ²Ğ¸Ñ Ğ¿Ñ€Ğ¾Ğ¼Ğ¾ĞºĞ¾Ğ´Ğ°"""
        if not promo_code.is_active:
            raise PromoCodeInactiveError()
        
        now_utc = datetime.now(timezone.utc)
        
        if promo_code.valid_from and promo_code.valid_from > now_utc:
            raise PromoCodeNotStartedError()
        
        if promo_code.expires_at and promo_code.expires_at < now_utc:
            raise PromoCodeExpiredError()
    
    def validate_usage_limits(self, promo_code: PromoCode) -> None:
        """ĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑĞµÑ‚ Ğ»Ğ¸Ğ¼Ğ¸Ñ‚Ñ‹ Ğ¸ÑĞ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ Ğ¿Ñ€Ğ¾Ğ¼Ğ¾ĞºĞ¾Ğ´Ğ°"""
        if promo_code.max_uses is not None and promo_code.times_used >= promo_code.max_uses:
            raise PromoCodeUsageLimitExceededError()
    
    def validate_order_amount(self, promo_code: PromoCode, order_amount: float) -> None:
        """ĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑĞµÑ‚ Ğ¼Ğ¸Ğ½Ğ¸Ğ¼Ğ°Ğ»ÑŒĞ½ÑƒÑ ÑÑƒĞ¼Ğ¼Ñƒ Ğ·Ğ°ĞºĞ°Ğ·Ğ°"""
        if promo_code.min_order_amount is not None and order_amount < promo_code.min_order_amount:
            raise PromoCodeMinOrderAmountError(promo_code.min_order_amount)
    
    async def validate_equipment_applicability(self, promo_code: PromoCode, equipment_ids: List[int]) -> None:
        """ĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑĞµÑ‚ Ğ¿Ñ€Ğ¸Ğ¼ĞµĞ½Ğ¸Ğ¼Ğ¾ÑÑ‚ÑŒ Ğº Ğ¾Ğ±Ğ¾Ñ€ÑƒĞ´Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ"""
        # ĞŸÑ€Ğ¾Ğ²ĞµÑ€ĞºĞ° Ğ¿Ğ¾ ID Ğ¾Ğ±Ğ¾Ñ€ÑƒĞ´Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ
        if promo_code.applicable_to_equipment_ids and not any(eid in equipment_ids for eid in promo_code.applicable_to_equipment_ids):
            raise PromoCodeInvalidEquipmentError()
        
        # ĞŸÑ€Ğ¾Ğ²ĞµÑ€ĞºĞ° Ğ¿Ğ¾ Ñ‚Ğ¸Ğ¿Ğ°Ğ¼ Ğ¾Ğ±Ğ¾Ñ€ÑƒĞ´Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ
        if promo_code.applicable_to_equipment_types:
            result = await self.db.execute(select(Equipment).filter(Equipment.id.in_(equipment_ids)))
            equipment_in_cart = result.unique().scalars().all()
            equipment_types_in_cart = {eq.equipment_type for eq in equipment_in_cart}
            if not any(eq_type in equipment_types_in_cart for eq_type in promo_code.applicable_to_equipment_types):
                raise PromoCodeInvalidEquipmentTypeError()
    
    async def validate_user_permissions(self, promo_code: PromoCode, user: Optional[User]) -> None:
        """ĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑĞµÑ‚ Ğ¿Ñ€Ğ°Ğ²Ğ° Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ñ Ğ½Ğ° Ğ¸ÑĞ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ Ğ¿Ñ€Ğ¾Ğ¼Ğ¾ĞºĞ¾Ğ´Ğ°"""
        # ĞŸÑ€Ğ¾Ğ²ĞµÑ€ĞºĞ° Ğ¿ĞµÑ€ÑĞ¾Ğ½Ğ°Ğ»ÑŒĞ½Ğ¾Ğ³Ğ¾ Ğ¿Ñ€Ğ¾Ğ¼Ğ¾ĞºĞ¾Ğ´Ğ°
        if promo_code.specific_to_user_id:
            if not user or user.id != promo_code.specific_to_user_id:
                raise PromoCodePersonalCodeForbiddenError()
        
        # ĞŸÑ€Ğ¾Ğ²ĞµÑ€ĞºĞ° Ğ»Ğ¸Ğ¼Ğ¸Ñ‚Ğ° Ğ¸ÑĞ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğ¹ Ğ½Ğ° Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ñ
        if promo_code.max_uses_per_user and user:
            result = await self.db.execute(select(promo_code_usages).filter_by(
                user_id=user.id, 
                promo_code_id=promo_code.id
            ))
            user_uses_count = len(result.all())
            if user_uses_count >= promo_code.max_uses_per_user:
                raise PromoCodeUserUsageLimitError()
    
    async def validate_complete(self, code: str, order_amount: float, equipment_ids: List[int], user: Optional[User]) -> PromoCode:
        """Ğ’Ñ‹Ğ¿Ğ¾Ğ»Ğ½ÑĞµÑ‚ Ğ¿Ğ¾Ğ»Ğ½ÑƒÑ Ğ²Ğ°Ğ»Ğ¸Ğ´Ğ°Ñ†Ğ¸Ñ Ğ¿Ñ€Ğ¾Ğ¼Ğ¾ĞºĞ¾Ğ´Ğ°"""
        promo_code = await self.validate_basic_existence(code)
        self.validate_status_and_dates(promo_code)
        self.validate_usage_limits(promo_code)
        self.validate_order_amount(promo_code, order_amount)
        await self.validate_equipment_applicability(promo_code, equipment_ids)
        await self.validate_user_permissions(promo_code, user)
        
        return promo_code 

```


## <a name="RentalAppFASTAPIapiservicespromocodeservicepy"></a>`RentalApp_FASTAPI/api/services/promo_code_service.py`

```python
// path: RentalApp_FASTAPI/api/services/promo_code_service.py

# api/services/promo_code_service.py

from sqlalchemy.ext.asyncio import AsyncSession
from typing import Optional, List

from api.models.promo_code import PromoCode
from api.models.user import User
from .promo_code import PromoCodeBusinessLogic


async def validate_promo_code_for_use(
        db: AsyncSession,
        code: str,
        order_amount: float,
        equipment_ids: List[int],
        user: Optional[User]
) -> PromoCode:
    """
    Ğ¦ĞµĞ½Ñ‚Ñ€Ğ°Ğ»Ğ¸Ğ·Ğ¾Ğ²Ğ°Ğ½Ğ½Ğ°Ñ Ñ„ÑƒĞ½ĞºÑ†Ğ¸Ñ Ğ´Ğ»Ñ Ğ¿Ğ¾Ğ»Ğ½Ğ¾Ğ¹ ÑĞµÑ€Ğ²ĞµÑ€Ğ½Ğ¾Ğ¹ Ğ²Ğ°Ğ»Ğ¸Ğ´Ğ°Ñ†Ğ¸Ğ¸ Ğ¿Ñ€Ğ¾Ğ¼Ğ¾ĞºĞ¾Ğ´Ğ°.
    Ğ’Ğ¾Ğ·Ğ²Ñ€Ğ°Ñ‰Ğ°ĞµÑ‚ Ğ¾Ğ±ÑŠĞµĞºÑ‚ PromoCode Ğ² ÑĞ»ÑƒÑ‡Ğ°Ğµ ÑƒÑĞ¿ĞµÑ…Ğ° Ğ¸Ğ»Ğ¸ Ğ²Ñ‹Ğ±Ñ€Ğ°ÑÑ‹Ğ²Ğ°ĞµÑ‚ HTTPException.
    
    Ğ­Ñ‚Ğ° Ñ„ÑƒĞ½ĞºÑ†Ğ¸Ñ ÑĞ²Ğ»ÑĞµÑ‚ÑÑ Ñ„Ğ°ÑĞ°Ğ´Ğ¾Ğ¼ Ğ´Ğ»Ñ Ğ½Ğ¾Ğ²Ğ¾Ğ¹ Ğ°Ñ€Ñ…Ğ¸Ñ‚ĞµĞºÑ‚ÑƒÑ€Ñ‹ Ğ¿Ñ€Ğ¾Ğ¼Ğ¾ĞºĞ¾Ğ´Ğ¾Ğ².
    """
    business_logic = PromoCodeBusinessLogic(db)
    return await business_logic.validate_and_get_promo_code(code, order_amount, equipment_ids, user)

```


## <a name="RentalAppFASTAPIapiservicesrentalinitpy"></a>`RentalApp_FASTAPI/api/services/rental/__init__.py`

```python
// path: RentalApp_FASTAPI/api/services/rental/__init__.py

# Ğ­Ñ‚Ğ¾Ñ‚ Ñ„Ğ°Ğ¹Ğ» Ğ¼Ğ¾Ğ¶ĞµÑ‚ Ğ±Ñ‹Ñ‚ÑŒ Ğ¿ÑƒÑÑ‚Ñ‹Ğ¼.
# Ğ•Ğ³Ğ¾ Ğ½Ğ°Ğ»Ğ¸Ñ‡Ğ¸Ğµ Ğ¿Ñ€ĞµĞ²Ñ€Ğ°Ñ‰Ğ°ĞµÑ‚ Ğ´Ğ¸Ñ€ĞµĞºÑ‚Ğ¾Ñ€Ğ¸Ñ 'rental' Ğ² Ğ¿Ğ°ĞºĞµÑ‚ Python.

```


## <a name="RentalAppFASTAPIapiservicesrentalrentalqueryservicepy"></a>`RentalApp_FASTAPI/api/services/rental/rental_query_service.py`

```python
// path: RentalApp_FASTAPI/api/services/rental/rental_query_service.py

# api/services/rental/rental_query_service.py

from sqlalchemy.ext.asyncio import AsyncSession
from sqlalchemy.orm import joinedload, selectinload
from sqlalchemy import or_, select, func, case, and_
from datetime import date
from typing import Optional, List, Tuple
import logging

from api.models.rental import Rental, RentalAccessory
from api.models.user import User
from api.models.equipment import Equipment
from shared.schemas.rental_schema import RentalOut
from api.services.financial_service import FinancialService
from api.services.order.order_query_base import OrderQueryBase

logger = logging.getLogger(__name__)

class RentalQueryService(OrderQueryBase[Rental]):
    """Ğ¡ĞµÑ€Ğ²Ğ¸Ñ Ğ´Ğ»Ñ Ğ²Ñ‹Ğ¿Ğ¾Ğ»Ğ½ĞµĞ½Ğ¸Ñ Ğ¾Ğ¿ĞµÑ€Ğ°Ñ†Ğ¸Ğ¹ Ñ‡Ñ‚ĞµĞ½Ğ¸Ñ (Query) Ğ´Ğ°Ğ½Ğ½Ñ‹Ñ… Ğ¾Ğ± Ğ°Ñ€ĞµĞ½Ğ´Ğ°Ñ…."""

    def __init__(self, db: AsyncSession):
        super().__init__(db)
        self.financial_service = FinancialService(db)

    def _get_base_query(self):
        """Ğ¡Ğ¾Ğ·Ğ´Ğ°ĞµÑ‚ Ğ±Ğ°Ğ·Ğ¾Ğ²Ñ‹Ğ¹ Ğ·Ğ°Ğ¿Ñ€Ğ¾Ñ Ñ Ğ½ĞµĞ¾Ğ±Ñ…Ğ¾Ğ´Ğ¸Ğ¼Ñ‹Ğ¼Ğ¸ join'Ğ°Ğ¼Ğ¸ Ğ¸ ĞºĞ°ÑÑ‚Ğ¾Ğ¼Ğ½Ğ¾Ğ¹ ÑĞ¾Ñ€Ñ‚Ğ¸Ñ€Ğ¾Ğ²ĞºĞ¾Ğ¹."""
        overdue_case = case(
            (and_(Rental.status == 'active', Rental.end_date < date.today()), 0),
            else_=1
        ).asc()

        return select(Rental).options(
            joinedload(Rental.user),
            joinedload(Rental.created_by),
            selectinload(Rental.equipment).options(
                selectinload(Equipment.accessories),
                selectinload(Equipment.associations)
            ),
            joinedload(Rental.accessory_links).joinedload(RentalAccessory.accessory)
        ).order_by(overdue_case, Rental.id.desc())

    # --- Ğ˜Ğ—ĞœĞ•ĞĞ•ĞĞ˜Ğ• 1: Ğ¡Ğ¾Ğ·Ğ´Ğ°ĞµĞ¼ ĞµĞ´Ğ¸Ğ½Ñ‹Ğ¹ Ğ¼ĞµÑ‚Ğ¾Ğ´ Ğ´Ğ»Ñ Ğ¿Ğ¾ÑÑ‚Ñ€Ğ¾ĞµĞ½Ğ¸Ñ Ğ·Ğ°Ğ¿Ñ€Ğ¾ÑĞ° Ñ Ñ„Ğ¸Ğ»ÑŒÑ‚Ñ€Ğ°Ğ¼Ğ¸ ---
    def _get_filtered_query(self, status_filter: Optional[str], search: Optional[str]):
        """
        Ğ¡Ğ¾Ğ·Ğ´Ğ°ĞµÑ‚ Ğ¸ Ğ²Ğ¾Ğ·Ğ²Ñ€Ğ°Ñ‰Ğ°ĞµÑ‚ Ğ¾Ñ‚Ñ„Ğ¸Ğ»ÑŒÑ‚Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ½Ñ‹Ğ¹ Ğ·Ğ°Ğ¿Ñ€Ğ¾Ñ Ğ½Ğ° Ğ¾ÑĞ½Ğ¾Ğ²Ğµ ÑÑ‚Ğ°Ñ‚ÑƒÑĞ° Ğ¸ Ğ¿Ğ¾Ğ¸ÑĞºĞ°.
        Ğ­Ñ‚Ğ¾ Ñ†ĞµĞ½Ñ‚Ñ€Ğ°Ğ»Ğ¸Ğ·ÑƒĞµÑ‚ Ğ»Ğ¾Ğ³Ğ¸ĞºÑƒ Ñ„Ğ¸Ğ»ÑŒÑ‚Ñ€Ğ°Ñ†Ğ¸Ğ¸.
        """
        query = self._get_base_query()

        # ĞŸÑ€Ğ¸Ğ¼ĞµĞ½ÑĞµĞ¼ Ñ„Ğ¸Ğ»ÑŒÑ‚Ñ€ Ğ¿Ğ¾ ÑÑ‚Ğ°Ñ‚ÑƒÑÑƒ, ĞµÑĞ»Ğ¸ Ğ¾Ğ½ ĞµÑÑ‚ÑŒ
        if status_filter:
            today = date.today()
            if status_filter == 'active':
                # ĞĞºÑ‚Ğ¸Ğ²Ğ½Ñ‹Ğµ Ğ°Ñ€ĞµĞ½Ğ´Ñ‹ - Ğ²ÑĞµ Ğ°Ñ€ĞµĞ½Ğ´Ñ‹ ÑĞ¾ ÑÑ‚Ğ°Ñ‚ÑƒÑĞ¾Ğ¼ 'active' (Ğ²ĞºĞ»ÑÑ‡Ğ°Ñ Ğ¿Ñ€Ğ¾ÑÑ€Ğ¾Ñ‡ĞµĞ½Ğ½Ñ‹Ğµ)
                query = query.filter(Rental.status == 'active')
            elif status_filter == 'overdue':
                # ĞŸÑ€Ğ¾ÑÑ€Ğ¾Ñ‡ĞµĞ½Ğ½Ñ‹Ğµ Ğ°Ñ€ĞµĞ½Ğ´Ñ‹ - Ğ°ĞºÑ‚Ğ¸Ğ²Ğ½Ñ‹Ğµ Ğ°Ñ€ĞµĞ½Ğ´Ñ‹ Ñ Ğ¸ÑÑ‚ĞµĞºÑˆĞ¸Ğ¼ ÑÑ€Ğ¾ĞºĞ¾Ğ¼
                query = query.filter(Rental.status == 'active', Rental.end_date < today)
            elif status_filter == 'completed':
                query = query.filter(Rental.status == 'completed')

        # ĞŸÑ€Ğ¸Ğ¼ĞµĞ½ÑĞµĞ¼ Ğ¿Ğ¾Ğ¸ÑĞº Ğ¿Ğ¾ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ñ, ĞµÑĞ»Ğ¸ Ğ¾Ğ½ ĞµÑÑ‚ÑŒ
        if search:
            query = self._apply_user_search(query, search, Rental)

        return query

    async def _enrich_rental_with_dynamic_fields(self, rental: Rental) -> RentalOut:
        """ĞĞ±Ğ¾Ğ³Ğ°Ñ‰Ğ°ĞµÑ‚ Ğ¾Ğ±ÑŠĞµĞºÑ‚ Ğ°Ñ€ĞµĞ½Ğ´Ñ‹ Ğ´Ğ¸Ğ½Ğ°Ğ¼Ğ¸Ñ‡ĞµÑĞºĞ¸Ğ¼Ğ¸ Ğ¿Ğ¾Ğ»ÑĞ¼Ğ¸ Ñ‡ĞµÑ€ĞµĞ· FinancialService."""
        rental_out = RentalOut.model_validate(rental)
        today = date.today()

        if rental.status == 'active' and rental.end_date < today:
            rental_out.status = 'overdue'

        if rental_out.status == 'overdue':
            rental_out.overdue_days = self.financial_service.calculate_overdue_days(rental, today)
            rental_out.overdue_surcharge = await self.financial_service.calculate_overdue_surcharge(rental, today)
        elif rental.status == 'active':
            rental_out.days_remaining = (rental.end_date - today).days

        accessories_cost = sum(
            link.accessory.price for link in rental.accessory_links if link.accessory and link.accessory.price
        )
        rental_out.accessories_cost = accessories_cost
        rental_out.remaining_amount = rental.total_cost - rental.prepayment_amount

        return rental_out

    async def get_rentals_for_user(
        self, 
        user: User, 
        skip: int, 
        limit: int,
        status: Optional[str] = None,
        search: Optional[str] = None,
        sort: Optional[str] = None
    ) -> Tuple[List[RentalOut], int]:
        """ĞŸĞ¾Ğ»ÑƒÑ‡Ğ°ĞµÑ‚ Ğ¾Ñ‚Ñ„Ğ¸Ğ»ÑŒÑ‚Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ½Ñ‹Ğ¹ Ğ¸ Ğ¿Ğ°Ğ³Ğ¸Ğ½Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ½Ñ‹Ğ¹ ÑĞ¿Ğ¸ÑĞ¾Ğº Ğ°Ñ€ĞµĞ½Ğ´ Ğ´Ğ»Ñ ĞºĞ¾Ğ½ĞºÑ€ĞµÑ‚Ğ½Ğ¾Ğ³Ğ¾ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ñ."""
        
        # Ğ¡Ğ¾Ğ·Ğ´Ğ°ĞµĞ¼ Ğ±Ğ°Ğ·Ğ¾Ğ²Ñ‹Ğ¹ Ğ·Ğ°Ğ¿Ñ€Ğ¾Ñ
        base_query = self._get_base_query().filter(Rental.user_id == user.id)
        
        # ĞŸÑ€Ğ¸Ğ¼ĞµĞ½ÑĞµĞ¼ Ñ„Ğ¸Ğ»ÑŒÑ‚Ñ€Ğ°Ñ†Ğ¸Ñ Ğ¿Ğ¾ ÑÑ‚Ğ°Ñ‚ÑƒÑÑƒ
        base_query = self._apply_status_filter(base_query, status, Rental)
        
        # ĞŸÑ€Ğ¸Ğ¼ĞµĞ½ÑĞµĞ¼ Ğ¿Ğ¾Ğ¸ÑĞº Ğ¿Ğ¾ Ğ¾Ğ±Ğ¾Ñ€ÑƒĞ´Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ
        if search:
            base_query = self._apply_equipment_search(base_query, search, Rental)
        
        # ĞŸÑ€Ğ¸Ğ¼ĞµĞ½ÑĞµĞ¼ ÑĞ¾Ñ€Ñ‚Ğ¸Ñ€Ğ¾Ğ²ĞºÑƒ (ĞµÑĞ»Ğ¸ Ğ½Ğµ ÑƒĞºĞ°Ğ·Ğ°Ğ½Ğ°, Ğ¸ÑĞ¿Ğ¾Ğ»ÑŒĞ·ÑƒĞµĞ¼ ĞºĞ°ÑÑ‚Ğ¾Ğ¼Ğ½ÑƒÑ ÑĞ¾Ñ€Ñ‚Ğ¸Ñ€Ğ¾Ğ²ĞºÑƒ Ğ¸Ğ· _get_base_query)
        if sort:
            # Ğ£Ğ±Ğ¸Ñ€Ğ°ĞµĞ¼ ĞºĞ°ÑÑ‚Ğ¾Ğ¼Ğ½ÑƒÑ ÑĞ¾Ñ€Ñ‚Ğ¸Ñ€Ğ¾Ğ²ĞºÑƒ Ğ¸Ğ· Ğ±Ğ°Ğ·Ğ¾Ğ²Ğ¾Ğ³Ğ¾ Ğ·Ğ°Ğ¿Ñ€Ğ¾ÑĞ° Ğ¸ Ğ¿Ñ€Ğ¸Ğ¼ĞµĞ½ÑĞµĞ¼ Ğ½Ğ¾Ğ²ÑƒÑ
            base_query = base_query.order_by(None)  # Ğ£Ğ±Ğ¸Ñ€Ğ°ĞµĞ¼ ÑÑƒÑ‰ĞµÑÑ‚Ğ²ÑƒÑÑ‰ÑƒÑ ÑĞ¾Ñ€Ñ‚Ğ¸Ñ€Ğ¾Ğ²ĞºÑƒ
            base_query = self._apply_sorting(base_query, sort, Rental)
        
        # ĞŸĞ¾Ğ»ÑƒÑ‡Ğ°ĞµĞ¼ Ğ¾Ğ±Ñ‰ĞµĞµ ĞºĞ¾Ğ»Ğ¸Ñ‡ĞµÑÑ‚Ğ²Ğ¾
        total = await self._get_total_count(base_query)
        
        # ĞŸÑ€Ğ¸Ğ¼ĞµĞ½ÑĞµĞ¼ Ğ¿Ğ°Ğ³Ğ¸Ğ½Ğ°Ñ†Ğ¸Ñ
        base_query = self._apply_pagination(base_query, skip, limit)
        
        # ĞŸĞ¾Ğ»ÑƒÑ‡Ğ°ĞµĞ¼ Ğ´Ğ°Ğ½Ğ½Ñ‹Ğµ
        rentals_result = await self.db.execute(base_query)
        rentals_orm = rentals_result.unique().scalars().all()
        
        # ĞĞ±Ğ¾Ğ³Ğ°Ñ‰Ğ°ĞµĞ¼ Ğ´Ğ°Ğ½Ğ½Ñ‹Ğµ Ñ‡ĞµÑ€ĞµĞ· FinancialService
        try:
            enriched_rentals = [await self._enrich_rental_with_dynamic_fields(r) for r in rentals_orm]
            return enriched_rentals, total
        except Exception as e:
            logger.error(f"ĞÑˆĞ¸Ğ±ĞºĞ° Ğ² _enrich_rental_with_dynamic_fields: {e}", exc_info=True)
            # Fallback: Ğ²Ğ¾Ğ·Ğ²Ñ€Ğ°Ñ‰Ğ°ĞµĞ¼ Ğ¿Ñ€Ğ¾ÑÑ‚Ñ‹Ğµ Ğ¾Ğ±ÑŠĞµĞºÑ‚Ñ‹
            simple_rentals = [RentalOut.model_validate(r) for r in rentals_orm]
            return simple_rentals, total

    async def get_paginated_rentals(self, skip: int, limit: int, status_filter: Optional[str], search: Optional[str]) -> Tuple[List[RentalOut], int]:
        """ĞŸĞ¾Ğ»ÑƒÑ‡Ğ°ĞµÑ‚ Ğ¾Ñ‚Ñ„Ğ¸Ğ»ÑŒÑ‚Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ½Ñ‹Ğ¹ Ğ¸ Ğ¿Ğ°Ğ³Ğ¸Ğ½Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ½Ñ‹Ğ¹ ÑĞ¿Ğ¸ÑĞ¾Ğº Ğ²ÑĞµÑ… Ğ°Ñ€ĞµĞ½Ğ´."""
        # --- Ğ˜Ğ—ĞœĞ•ĞĞ•ĞĞ˜Ğ• 2: Ğ˜ÑĞ¿Ğ¾Ğ»ÑŒĞ·ÑƒĞµĞ¼ Ğ½Ğ¾Ğ²Ñ‹Ğ¹ Ğ¼ĞµÑ‚Ğ¾Ğ´ Ğ´Ğ»Ñ Ğ¿Ğ¾Ğ»ÑƒÑ‡ĞµĞ½Ğ¸Ñ Ğ·Ğ°Ğ¿Ñ€Ğ¾ÑĞ° ---
        # Ğ¢ĞµĞ¿ĞµÑ€ÑŒ Ğ¸ Ğ¿Ğ¾Ğ´ÑÑ‡ĞµÑ‚, Ğ¸ Ğ²Ñ‹Ğ±Ğ¾Ñ€ĞºĞ° Ğ´ĞµĞ»Ğ°ÑÑ‚ÑÑ Ğ½Ğ° Ğ¾ÑĞ½Ğ¾Ğ²Ğµ Ğ¾Ğ´Ğ½Ğ¾Ğ³Ğ¾ Ğ¸ Ñ‚Ğ¾Ğ³Ğ¾ Ğ¶Ğµ Ğ¾Ñ‚Ñ„Ğ¸Ğ»ÑŒÑ‚Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ½Ğ¾Ğ³Ğ¾ Ğ·Ğ°Ğ¿Ñ€Ğ¾ÑĞ°.
        filtered_query = self._get_filtered_query(status_filter, search)

        # ĞŸĞ¾Ğ»ÑƒÑ‡Ğ°ĞµĞ¼ Ğ¾Ğ±Ñ‰ĞµĞµ ĞºĞ¾Ğ»Ğ¸Ñ‡ĞµÑÑ‚Ğ²Ğ¾ Ğ½Ğ° Ğ¾ÑĞ½Ğ¾Ğ²Ğµ Ğ¾Ñ‚Ñ„Ğ¸Ğ»ÑŒÑ‚Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ½Ğ¾Ğ³Ğ¾ Ğ·Ğ°Ğ¿Ñ€Ğ¾ÑĞ°
        count_query = select(func.count()).select_from(filtered_query.subquery())
        count_result = await self.db.execute(count_query)
        total = count_result.scalar_one()

        # ĞŸĞ¾Ğ»ÑƒÑ‡Ğ°ĞµĞ¼ Ğ´Ğ°Ğ½Ğ½Ñ‹Ğµ Ñ Ğ¿Ğ°Ğ³Ğ¸Ğ½Ğ°Ñ†Ğ¸ĞµĞ¹ Ğ¸Ğ· Ñ‚Ğ¾Ğ³Ğ¾ Ğ¶Ğµ Ğ¾Ñ‚Ñ„Ğ¸Ğ»ÑŒÑ‚Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ½Ğ¾Ğ³Ğ¾ Ğ·Ğ°Ğ¿Ñ€Ğ¾ÑĞ°
        paginated_query = filtered_query.offset(skip).limit(limit)
        rentals_result = await self.db.execute(paginated_query)
        rentals_orm = rentals_result.unique().scalars().all()

        try:
            enriched_rentals = [await self._enrich_rental_with_dynamic_fields(r) for r in rentals_orm]
            return enriched_rentals, total
        except Exception as e:
            logger.error(f"ĞÑˆĞ¸Ğ±ĞºĞ° Ğ² _enrich_rental_with_dynamic_fields: {e}", exc_info=True)
            simple_rentals = [RentalOut.model_validate(r) for r in rentals_orm]
            return simple_rentals, total

```


## <a name="RentalAppFASTAPIapiservicesreservationqueryservicepy"></a>`RentalApp_FASTAPI/api/services/reservation_query_service.py`

```python
// path: RentalApp_FASTAPI/api/services/reservation_query_service.py

# api/services/reservation_query_service.py

from sqlalchemy.ext.asyncio import AsyncSession
from sqlalchemy.orm import joinedload, selectinload
from sqlalchemy import or_, select, func
from typing import List, Optional, Tuple
from datetime import date
import logging

from api.models.user import User
from api.models.reservation import Reservation, ReservationAccessory
from api.models.equipment import Equipment
from shared.schemas.reservation_schema import AdminReservationOut, ReservationItem
from shared.schemas.user_schema import UserOut
from api.services.financial_service import FinancialService
from api.services.order.order_query_base import OrderQueryBase

logger = logging.getLogger(__name__)

class ReservationQueryService(OrderQueryBase[Reservation]):
    """
    Ğ•Ğ´Ğ¸Ğ½Ñ‹Ğ¹ ÑĞµÑ€Ğ²Ğ¸Ñ Ğ´Ğ»Ñ Ğ²Ñ‹Ğ¿Ğ¾Ğ»Ğ½ĞµĞ½Ğ¸Ñ Ğ¾Ğ¿ĞµÑ€Ğ°Ñ†Ğ¸Ğ¹ Ñ‡Ñ‚ĞµĞ½Ğ¸Ñ (Query) Ğ´Ğ°Ğ½Ğ½Ñ‹Ñ… Ğ¾ Ñ€ĞµĞ·ĞµÑ€Ğ²Ğ°Ñ….
    """

    def __init__(self, db: AsyncSession):
        super().__init__(db)
        self.financial_service = FinancialService(db)

    async def get_my_reservations(
        self, 
        user: User, 
        status: Optional[str] = None,
        search: Optional[str] = None,
        sort: Optional[str] = None,
        skip: int = 0,
        limit: int = 100
    ) -> Tuple[List[ReservationItem], int]:
        """ĞŸĞ¾Ğ»ÑƒÑ‡Ğ°ĞµÑ‚ Ğ¾Ñ‚Ñ„Ğ¸Ğ»ÑŒÑ‚Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ½Ñ‹Ğ¹ Ğ¸ Ğ¿Ğ°Ğ³Ğ¸Ğ½Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ½Ñ‹Ğ¹ ÑĞ¿Ğ¸ÑĞ¾Ğº Ñ€ĞµĞ·ĞµÑ€Ğ²Ğ¾Ğ² Ğ´Ğ»Ñ Ñ‚ĞµĞºÑƒÑ‰ĞµĞ³Ğ¾ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ñ."""
        
        # Ğ¡Ğ¾Ğ·Ğ´Ğ°ĞµĞ¼ Ğ±Ğ°Ğ·Ğ¾Ğ²Ñ‹Ğ¹ Ğ·Ğ°Ğ¿Ñ€Ğ¾Ñ
        query = select(Reservation).filter(Reservation.user_id == user.id)
        
        # ĞŸÑ€Ğ¸Ğ¼ĞµĞ½ÑĞµĞ¼ Ñ„Ğ¸Ğ»ÑŒÑ‚Ñ€Ğ°Ñ†Ğ¸Ñ Ğ¿Ğ¾ ÑÑ‚Ğ°Ñ‚ÑƒÑÑƒ
        query = self._apply_status_filter(query, status, Reservation)
        
        # ĞŸÑ€Ğ¸Ğ¼ĞµĞ½ÑĞµĞ¼ Ğ¿Ğ¾Ğ¸ÑĞº Ğ¿Ğ¾ Ğ¾Ğ±Ğ¾Ñ€ÑƒĞ´Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ
        if search:
            query = self._apply_equipment_search(query, search, Reservation)
        
        # Ğ”Ğ¾Ğ±Ğ°Ğ²Ğ»ÑĞµĞ¼ Ğ½ĞµĞ¾Ğ±Ñ…Ğ¾Ğ´Ğ¸Ğ¼Ñ‹Ğµ JOIN'Ñ‹
        query = query.options(
            joinedload(Reservation.applied_promo_code),
            joinedload(Reservation.accessory_links).joinedload(ReservationAccessory.accessory),
            selectinload(Reservation.equipment).options(
                selectinload(Equipment.accessories),
                selectinload(Equipment.associations)
            ),
            joinedload(Reservation.rental)
        )
        
        # ĞŸÑ€Ğ¸Ğ¼ĞµĞ½ÑĞµĞ¼ ÑĞ¾Ñ€Ñ‚Ğ¸Ñ€Ğ¾Ğ²ĞºÑƒ
        query = self._apply_sorting(query, sort, Reservation)
        
        # ĞŸĞ¾Ğ»ÑƒÑ‡Ğ°ĞµĞ¼ Ğ¾Ğ±Ñ‰ĞµĞµ ĞºĞ¾Ğ»Ğ¸Ñ‡ĞµÑÑ‚Ğ²Ğ¾
        total = await self._get_total_count(query)
        
        # ĞŸÑ€Ğ¸Ğ¼ĞµĞ½ÑĞµĞ¼ Ğ¿Ğ°Ğ³Ğ¸Ğ½Ğ°Ñ†Ğ¸Ñ
        query = self._apply_pagination(query, skip, limit)
        
        # Ğ’Ñ‹Ğ¿Ğ¾Ğ»Ğ½ÑĞµĞ¼ Ğ·Ğ°Ğ¿Ñ€Ğ¾Ñ
        result = await self.db.execute(query)
        reservations_orm = result.unique().scalars().all()
        
        # ĞĞ±Ñ€Ğ°Ğ±Ğ°Ñ‚Ñ‹Ğ²Ğ°ĞµĞ¼ ÑÑ‚Ğ°Ñ‚ÑƒÑÑ‹ Ğ¸ Ğ¿Ñ€ĞµĞ¾Ğ±Ñ€Ğ°Ğ·ÑƒĞµĞ¼ Ğ² DTO Ñ‡ĞµÑ€ĞµĞ· FinancialService
        items_dto = []
        for r_orm in reservations_orm:
            try:
                item_dto = await self.financial_service.enrich_order_with_financials(r_orm)
                items_dto.append(item_dto)
            except Exception as e:
                logger.error(f"ĞÑˆĞ¸Ğ±ĞºĞ° Ğ¾Ğ±Ğ¾Ğ³Ğ°Ñ‰ĞµĞ½Ğ¸Ñ Ñ€ĞµĞ·ĞµÑ€Ğ²Ğ° ID {r_orm.id}: {e}")
                # Fallback: Ğ¿Ñ€Ğ¾ÑÑ‚Ğ°Ñ Ğ²Ğ°Ğ»Ğ¸Ğ´Ğ°Ñ†Ğ¸Ñ
                item_dto = ReservationItem.model_validate(r_orm)
                items_dto.append(item_dto)
        
        return items_dto, total

    def _get_admin_base_query(self, status_filter: Optional[str] = None, search_query: Optional[str] = None):
        """Ğ’ÑĞ¿Ğ¾Ğ¼Ğ¾Ğ³Ğ°Ñ‚ĞµĞ»ÑŒĞ½Ñ‹Ğ¹ Ğ¼ĞµÑ‚Ğ¾Ğ´ Ğ´Ğ»Ñ ÑĞ¾Ğ·Ğ´Ğ°Ğ½Ğ¸Ñ Ğ±Ğ°Ğ·Ğ¾Ğ²Ğ¾Ğ³Ğ¾ Ğ·Ğ°Ğ¿Ñ€Ğ¾ÑĞ° Ñ Ñ„Ğ¸Ğ»ÑŒÑ‚Ñ€Ğ°Ğ¼Ğ¸ Ğ´Ğ»Ñ Ğ°Ğ´Ğ¼Ğ¸Ğ½-Ğ¿Ğ°Ğ½ĞµĞ»Ğ¸."""
        query = select(Reservation).options(
            joinedload(Reservation.user),
            joinedload(Reservation.applied_promo_code),
            joinedload(Reservation.accessory_links).joinedload(ReservationAccessory.accessory),
            selectinload(Reservation.equipment).options(
                selectinload(Equipment.accessories),
                selectinload(Equipment.associations)
            ),
            joinedload(Reservation.rental)
        )
        if search_query:
            query = self._apply_user_search(query, search_query, Reservation)

        if status_filter == "active":
            query = query.filter(Reservation.status == 'active')
        elif status_filter == "completed":
            query = query.filter(Reservation.status.in_(['fulfilled', 'cancelled', 'overdue']))

        return query

    async def get_admin_reservations_count(self, status: Optional[str] = None, search_query: Optional[str] = None) -> int:
        """ĞŸĞ¾Ğ»ÑƒÑ‡Ğ°ĞµÑ‚ Ğ¾Ğ±Ñ‰ĞµĞµ ĞºĞ¾Ğ»Ğ¸Ñ‡ĞµÑÑ‚Ğ²Ğ¾ Ñ€ĞµĞ·ĞµÑ€Ğ²Ğ¾Ğ² Ñ ÑƒÑ‡ĞµÑ‚Ğ¾Ğ¼ Ñ„Ğ¸Ğ»ÑŒÑ‚Ñ€Ğ¾Ğ² Ğ´Ğ»Ñ Ğ°Ğ´Ğ¼Ğ¸Ğ½-Ğ¿Ğ°Ğ½ĞµĞ»Ğ¸."""
        query = self._get_admin_base_query(status, search_query)
        result = await self.db.execute(select(func.count()).select_from(query.subquery()))
        return result.scalar_one()

    async def get_paginated_admin_reservations(self, skip: int, limit: int, status: Optional[str] = None, search_query: Optional[str] = None) -> List[AdminReservationOut]:
        """ĞŸĞ¾Ğ»ÑƒÑ‡Ğ°ĞµÑ‚ ÑÑ‚Ñ€Ğ°Ğ½Ğ¸Ñ†Ñƒ Ñ€ĞµĞ·ĞµÑ€Ğ²Ğ¾Ğ² Ñ Ğ¿Ğ°Ğ³Ğ¸Ğ½Ğ°Ñ†Ğ¸ĞµĞ¹ Ğ´Ğ»Ñ Ğ°Ğ´Ğ¼Ğ¸Ğ½-Ğ¿Ğ°Ğ½ĞµĞ»Ğ¸."""
        query = self._get_admin_base_query(status, search_query)
        result = await self.db.execute(query.order_by(Reservation.id.desc()).offset(skip).limit(limit))
        reservations_orm = result.unique().scalars().all()

        result = []
        for r_orm in reservations_orm:
            if not r_orm.user:
                continue
            try:
                # Ğ˜ÑĞ¿Ğ¾Ğ»ÑŒĞ·ÑƒĞµĞ¼ FinancialService Ğ´Ğ»Ñ Ğ¾Ğ±Ğ¾Ğ³Ğ°Ñ‰ĞµĞ½Ğ¸Ñ Ğ°Ğ´Ğ¼Ğ¸Ğ½-Ñ€ĞµĞ·ĞµÑ€Ğ²Ğ°
                final_output = await self.financial_service._enrich_admin_reservation_with_financials(r_orm)
                result.append(final_output)
            except Exception as e:
                logger.error(f"ĞÑˆĞ¸Ğ±ĞºĞ° Ğ²Ğ°Ğ»Ğ¸Ğ´Ğ°Ñ†Ğ¸Ğ¸ Ğ°Ğ´Ğ¼Ğ¸Ğ½-Ñ€ĞµĞ·ĞµÑ€Ğ²Ğ° ID {r_orm.id}: {e}", exc_info=True)
                continue
        return result

```


## <a name="RentalAppFASTAPIapiservicesuserservicepy"></a>`RentalApp_FASTAPI/api/services/user_service.py`

```python
// path: RentalApp_FASTAPI/api/services/user_service.py

# src/api/services/user_service.py

from sqlalchemy.ext.asyncio import AsyncSession
from sqlalchemy.orm import joinedload
from sqlalchemy import select, func
from api.models.user import User
from api.models.payment import Payment
# +++ Ğ”ĞĞ‘ĞĞ’Ğ¬Ğ¢Ğ• Ğ­Ğ¢ĞĞ¢ Ğ˜ĞœĞŸĞĞ Ğ¢ +++
from api.models.balance_history import BalanceHistory
from api.services.balance_service import BalanceService
from shared.schemas.user_schema import UserUpdate, UserOut, AdminUserCreate, AdminUserUpdate, UserPaymentRequest
from api.services import auth_service
from fastapi import HTTPException
import logging
from datetime import datetime
from typing import List, Tuple


async def create_admin_user(db: AsyncSession, user_data: AdminUserCreate) -> User:
    """Ğ¡Ğ¾Ğ·Ğ´Ğ°ĞµÑ‚ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ñ (Ğ´Ğ»Ñ Ğ°Ğ´Ğ¼Ğ¸Ğ½Ğ¾Ğ²)."""
    result = await db.execute(select(User).filter(User.email == user_data.email))
    existing_user = result.scalars().first()
    if existing_user:
        raise HTTPException(status_code=409, detail="ĞŸĞ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ÑŒ Ñ Ñ‚Ğ°ĞºĞ¸Ğ¼ email ÑƒĞ¶Ğµ ÑÑƒÑ‰ĞµÑÑ‚Ğ²ÑƒĞµÑ‚.")

    try:
        new_user = User(
            full_name=user_data.full_name,
            email=user_data.email,
            hashed_password=auth_service.hash_password(user_data.password),
            phone=user_data.phone,
            role=user_data.role,
            is_active=True,
            status="ĞĞºÑ‚Ğ¸Ğ²Ğ½Ñ‹Ğ¹",
            balance=0.0,
            notes=f"Ğ¡Ğ¾Ğ·Ğ´Ğ°Ğ½ Ğ°Ğ´Ğ¼Ğ¸Ğ½Ğ¸ÑÑ‚Ñ€Ğ°Ñ‚Ğ¾Ñ€Ğ¾Ğ¼ {datetime.now().strftime('%d-%m-%Y')}",
            privacy_policy_accepted=user_data.privacy_policy_accepted,
            terms_accepted=user_data.terms_accepted,
            email_verified=True
        )
        db.add(new_user)
        await db.commit()
        await db.refresh(new_user)
        
        # Ğ’Ğ¾Ğ·Ğ²Ñ€Ğ°Ñ‰Ğ°ĞµĞ¼ ÑĞ¾Ğ·Ğ´Ğ°Ğ½Ğ½Ñ‹Ğ¹ Ğ¾Ğ±ÑŠĞµĞºÑ‚ Ñ Ğ·Ğ°Ğ³Ñ€ÑƒĞ¶ĞµĞ½Ğ½Ñ‹Ğ¼Ğ¸ Ğ´Ğ°Ğ½Ğ½Ñ‹Ğ¼Ğ¸ Ğ¸Ğ· Ğ‘Ğ”
        return new_user
    except Exception as e:
        await db.rollback()
        logging.error(f"ĞÑˆĞ¸Ğ±ĞºĞ° Ğ¿Ñ€Ğ¸ ÑĞ¾Ğ·Ğ´Ğ°Ğ½Ğ¸Ğ¸ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ñ Ğ°Ğ´Ğ¼Ğ¸Ğ½Ğ¸ÑÑ‚Ñ€Ğ°Ñ‚Ğ¾Ñ€Ğ¾Ğ¼: {e}")
        raise HTTPException(status_code=500, detail="Ğ’Ğ½ÑƒÑ‚Ñ€ĞµĞ½Ğ½ÑÑ Ğ¾ÑˆĞ¸Ğ±ĞºĞ° ÑĞµÑ€Ğ²ĞµÑ€Ğ°.")

def get_current_user_info(user: User) -> UserOut:
    return UserOut.from_orm(user)

async def update_user(db: AsyncSession, user: User, data: UserUpdate) -> UserOut:
    """ĞĞ±Ğ½Ğ¾Ğ²Ğ»ÑĞµÑ‚ Ğ¿Ñ€Ğ¾Ñ„Ğ¸Ğ»ÑŒ Ñ‚ĞµĞºÑƒÑ‰ĞµĞ³Ğ¾ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ñ."""
    update_data = data.model_dump(exclude_unset=True)

    if 'email' in update_data and update_data['email'] != user.email:
        logging.info(f"ĞŸĞ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ÑŒ {user.id} Ğ·Ğ°Ğ¿Ñ€Ğ¾ÑĞ¸Ğ» ÑĞ¼ĞµĞ½Ñƒ email Ğ½Ğ° {update_data['email']}. Ğ¢Ñ€ĞµĞ±ÑƒĞµÑ‚ÑÑ Ğ¿Ğ¾Ğ´Ñ‚Ğ²ĞµÑ€Ğ¶Ğ´ĞµĞ½Ğ¸Ğµ.")
        del update_data['email']

    for key, value in update_data.items():
        setattr(user, key, value)

    db.add(user)
    await db.commit()
    
    # Ğ’Ğ¾Ğ·Ğ²Ñ€Ğ°Ñ‰Ğ°ĞµĞ¼ Ğ¾Ğ±Ğ½Ğ¾Ğ²Ğ»ĞµĞ½Ğ½Ñ‹Ğ¹ Ğ¾Ğ±ÑŠĞµĞºÑ‚ Ğ±ĞµĞ· Ğ¿Ğ¾Ğ²Ñ‚Ğ¾Ñ€Ğ½Ğ¾Ğ³Ğ¾ Ğ·Ğ°Ğ¿Ñ€Ğ¾ÑĞ° Ğº Ğ‘Ğ”
    return UserOut.from_orm(user)

async def update_user_by_admin(db: AsyncSession, user_id: int, data: AdminUserUpdate, current_user: User) -> UserOut:
    """ĞĞ±Ğ½Ğ¾Ğ²Ğ»ÑĞµÑ‚ Ğ´Ğ°Ğ½Ğ½Ñ‹Ğµ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ñ. Ğ¢Ğ¾Ğ»ÑŒĞºĞ¾ Ğ°Ğ´Ğ¼Ğ¸Ğ½ Ğ¼Ğ¾Ğ¶ĞµÑ‚ Ğ¼ĞµĞ½ÑÑ‚ÑŒ Ñ€Ğ¾Ğ»ÑŒ."""
    result = await db.execute(select(User).filter(User.id == user_id))
    user_to_update = result.scalars().first()
    if not user_to_update:
        raise HTTPException(status_code=404, detail="ĞŸĞ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ÑŒ Ğ½Ğµ Ğ½Ğ°Ğ¹Ğ´ĞµĞ½")

    update_data = data.model_dump(exclude_unset=True)

    if 'role' in update_data and current_user.role != 'admin':
        raise HTTPException(status_code=403, detail="Ğ¢Ğ¾Ğ»ÑŒĞºĞ¾ Ğ°Ğ´Ğ¼Ğ¸Ğ½Ğ¸ÑÑ‚Ñ€Ğ°Ñ‚Ğ¾Ñ€ Ğ¼Ğ¾Ğ¶ĞµÑ‚ Ğ¸Ğ·Ğ¼ĞµĞ½ÑÑ‚ÑŒ Ñ€Ğ¾Ğ»ÑŒ.")

    for key, value in update_data.items():
        setattr(user_to_update, key, value)

    db.add(user_to_update)
    await db.commit()
    
    # Ğ’Ğ¾Ğ·Ğ²Ñ€Ğ°Ñ‰Ğ°ĞµĞ¼ Ğ¾Ğ±Ğ½Ğ¾Ğ²Ğ»ĞµĞ½Ğ½Ñ‹Ğ¹ Ğ¾Ğ±ÑŠĞµĞºÑ‚ Ğ±ĞµĞ· Ğ¿Ğ¾Ğ²Ñ‚Ğ¾Ñ€Ğ½Ğ¾Ğ³Ğ¾ Ğ·Ğ°Ğ¿Ñ€Ğ¾ÑĞ° Ğº Ğ‘Ğ”
    return UserOut.from_orm(user_to_update)

async def process_user_payment(db: AsyncSession, user_id: int, payment_data: UserPaymentRequest, manager: User) -> UserOut:
    """ĞĞ±Ñ€Ğ°Ğ±Ğ°Ñ‚Ñ‹Ğ²Ğ°ĞµÑ‚ Ñ€ĞµĞ°Ğ»ÑŒĞ½Ñ‹Ğ¹ Ğ¿Ğ»Ğ°Ñ‚ĞµĞ¶ Ğ¸ Ğ¿Ğ¾Ğ¿Ğ¾Ğ»Ğ½ÑĞµÑ‚ Ğ²Ğ½ÑƒÑ‚Ñ€ĞµĞ½Ğ½Ğ¸Ğ¹ Ğ±Ğ°Ğ»Ğ°Ğ½Ñ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ñ."""
    result = await db.execute(select(User).filter(User.id == user_id))
    user_to_update = result.scalars().first()
    if not user_to_update:
        raise HTTPException(status_code=404, detail="ĞŸĞ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ÑŒ Ğ½Ğµ Ğ½Ğ°Ğ¹Ğ´ĞµĞ½")

    try:
        new_payment = Payment(
            user_id=user_id,
            amount=payment_data.amount,
            payment_method=payment_data.payment_method,
            description=payment_data.description or f"ĞŸĞ»Ğ°Ñ‚ĞµĞ¶ Ğ¿Ñ€Ğ¸Ğ½ÑÑ‚ {manager.full_name}",
            transaction_type="balance_top_up"
        )
        db.add(new_payment)

        balance_service = BalanceService(db)
        await balance_service.add_transaction(
            user_id=user_id,
            amount=payment_data.amount,
            operation_type="balance_top_up",
            description=f"ĞŸĞ¾Ğ¿Ğ¾Ğ»Ğ½ĞµĞ½Ğ¸Ğµ Ğ±Ğ°Ğ»Ğ°Ğ½ÑĞ°. ĞœĞµÑ‚Ğ¾Ğ´: {payment_data.payment_method}."
        )

        await db.commit()
        
        # Ğ’Ğ¾Ğ·Ğ²Ñ€Ğ°Ñ‰Ğ°ĞµĞ¼ Ğ¾Ğ±Ğ½Ğ¾Ğ²Ğ»ĞµĞ½Ğ½Ñ‹Ğ¹ Ğ¾Ğ±ÑŠĞµĞºÑ‚ Ğ±ĞµĞ· Ğ¿Ğ¾Ğ²Ñ‚Ğ¾Ñ€Ğ½Ğ¾Ğ³Ğ¾ Ğ·Ğ°Ğ¿Ñ€Ğ¾ÑĞ° Ğº Ğ‘Ğ”
        return UserOut.from_orm(user_to_update)

    except HTTPException:
        await db.rollback()
        raise
    except Exception as e:
        await db.rollback()
        logging.error(f"ĞÑˆĞ¸Ğ±ĞºĞ° Ğ¿Ñ€Ğ¸ Ğ¾Ğ±Ñ€Ğ°Ğ±Ğ¾Ñ‚ĞºĞµ Ğ¿Ğ»Ğ°Ñ‚ĞµĞ¶Ğ° Ğ´Ğ»Ñ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ñ ID={user_id}: {e}", exc_info=True)
        raise HTTPException(status_code=500, detail="Ğ’Ğ½ÑƒÑ‚Ñ€ĞµĞ½Ğ½ÑÑ Ğ¾ÑˆĞ¸Ğ±ĞºĞ° Ğ¿Ñ€Ğ¸ Ğ¾Ğ±Ñ€Ğ°Ğ±Ğ¾Ñ‚ĞºĞµ Ğ¿Ğ»Ğ°Ñ‚ĞµĞ¶Ğ°.")

# +++ ĞĞĞ§ĞĞ›Ğ: ĞĞ¾Ğ²Ğ°Ñ Ñ„ÑƒĞ½ĞºÑ†Ğ¸Ñ +++
async def get_balance_history_for_user(db: AsyncSession, user_id: int, skip: int, limit: int) -> Tuple[List[BalanceHistory], int]:
    """ĞŸĞ¾Ğ»ÑƒÑ‡Ğ°ĞµÑ‚ Ğ¿Ğ°Ğ³Ğ¸Ğ½Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ½ÑƒÑ Ğ¸ÑÑ‚Ğ¾Ñ€Ğ¸Ñ Ğ±Ğ°Ğ»Ğ°Ğ½ÑĞ° Ğ´Ğ»Ñ ÑƒĞºĞ°Ğ·Ğ°Ğ½Ğ½Ğ¾Ğ³Ğ¾ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ñ."""

    total_result = await db.execute(
        select(func.count(BalanceHistory.id)).filter(BalanceHistory.user_id == user_id)
    )
    total = total_result.scalar_one()

    history_result = await db.execute(
        select(BalanceHistory)
        .filter(BalanceHistory.user_id == user_id)
        .order_by(BalanceHistory.created_at.desc())
        .offset(skip)
        .limit(limit)
    )
    history_items = history_result.scalars().all()

    return history_items, total
# +++ ĞšĞĞĞ•Ğ¦: ĞĞ¾Ğ²Ğ°Ñ Ñ„ÑƒĞ½ĞºÑ†Ğ¸Ñ +++

```


## <a name="RentalAppFASTAPIapiuserapipy"></a>`RentalApp_FASTAPI/api/user_api.py`

```python
// path: RentalApp_FASTAPI/api/user_api.py

# api/user_api.py

from fastapi import APIRouter, Depends, HTTPException, Query
from sqlalchemy.ext.asyncio import AsyncSession
from sqlalchemy import select, func
from typing import List, Optional

from api.models.user import User as OrmUser
from api.deps import get_db, get_rental_query_service
from api.permissions import require_user, require_manager, require_admin
from api.models.user import User as PermissionUser
from api.services import user_service
# <-- Ğ˜Ğ—ĞœĞ•ĞĞ•ĞĞ˜Ğ• Ğ—Ğ”Ğ•Ğ¡Ğ¬: ĞĞ±Ğ½Ğ¾Ğ²Ğ»ÑĞµĞ¼ Ğ¿ÑƒÑ‚ÑŒ Ğ¸Ğ¼Ğ¿Ğ¾Ñ€Ñ‚Ğ°
from api.services.rental.rental_query_service import RentalQueryService
# ---------------------------------------------------
from shared.schemas.rental_schema import RentalListResponse, RentalOut
from shared.schemas.user_schema import UserUpdate, UserOut, AdminUserCreate, AdminUserUpdate, UserListResponse, UserPaymentRequest
from shared.schemas.balance_history_schema import BalanceHistoryOut, BalanceHistoryListResponse
from fastapi_csrf_protect import CsrfProtect

router = APIRouter(prefix="/user", tags=["ĞŸÑ€Ğ¾Ñ„Ğ¸Ğ»ÑŒ Ğ¸ ĞŸĞ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ğ¸"])


@router.get("/", response_model=UserOut)
def get_my_profile(current_user: PermissionUser = Depends(require_user)):
    """
    Ğ’Ğ¾Ğ·Ğ²Ñ€Ğ°Ñ‰Ğ°ĞµÑ‚ Ğ¿Ñ€Ğ¾Ñ„Ğ¸Ğ»ÑŒ Ñ‚ĞµĞºÑƒÑ‰ĞµĞ³Ğ¾ Ğ°Ğ²Ñ‚Ğ¾Ñ€Ğ¸Ğ·Ğ¾Ğ²Ğ°Ğ½Ğ½Ğ¾Ğ³Ğ¾ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ñ.
    """
    return user_service.get_current_user_info(current_user)


@router.get("/rentals", response_model=RentalListResponse)
async def get_my_rentals(
        current_user: PermissionUser = Depends(require_user),
        service: RentalQueryService = Depends(get_rental_query_service),
        status: Optional[str] = Query(None, description="Ğ¤Ğ¸Ğ»ÑŒÑ‚Ñ€ Ğ¿Ğ¾ ÑÑ‚Ğ°Ñ‚ÑƒÑÑƒ: active, completed, overdue"),
        search: Optional[str] = Query(None, description="ĞŸĞ¾Ğ¸ÑĞº Ğ¿Ğ¾ Ğ½Ğ°Ğ·Ğ²Ğ°Ğ½Ğ¸Ñ, Ğ±Ñ€ĞµĞ½Ğ´Ñƒ Ğ¸Ğ»Ğ¸ Ñ‚Ğ¸Ğ¿Ñƒ Ğ¾Ğ±Ğ¾Ñ€ÑƒĞ´Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ"),
        sort: Optional[str] = Query(None, description="Ğ¡Ğ¾Ñ€Ñ‚Ğ¸Ñ€Ğ¾Ğ²ĞºĞ°: id_desc, id_asc, start_date_desc, start_date_asc, end_date_desc, end_date_asc, count_desc, count_asc"),
        skip: int = Query(0, ge=0, description="ĞšĞ¾Ğ»Ğ¸Ñ‡ĞµÑÑ‚Ğ²Ğ¾ Ğ·Ğ°Ğ¿Ğ¸ÑĞµĞ¹ Ğ´Ğ»Ñ Ğ¿Ñ€Ğ¾Ğ¿ÑƒÑĞºĞ°"),
        limit: int = Query(10, ge=1, le=100, description="ĞœĞ°ĞºÑĞ¸Ğ¼Ğ°Ğ»ÑŒĞ½Ğ¾Ğµ ĞºĞ¾Ğ»Ğ¸Ñ‡ĞµÑÑ‚Ğ²Ğ¾ Ğ·Ğ°Ğ¿Ğ¸ÑĞµĞ¹ Ğ½Ğ° ÑÑ‚Ñ€Ğ°Ğ½Ğ¸Ñ†Ğµ")
):
    """
    Ğ’Ğ¾Ğ·Ğ²Ñ€Ğ°Ñ‰Ğ°ĞµÑ‚ Ğ¾Ñ‚Ñ„Ğ¸Ğ»ÑŒÑ‚Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ½Ñ‹Ğ¹ Ğ¸ Ğ¿Ğ°Ğ³Ğ¸Ğ½Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ½Ñ‹Ğ¹ ÑĞ¿Ğ¸ÑĞ¾Ğº Ğ°Ñ€ĞµĞ½Ğ´ Ğ´Ğ»Ñ Ñ‚ĞµĞºÑƒÑ‰ĞµĞ³Ğ¾ Ğ°Ğ²Ñ‚Ğ¾Ñ€Ğ¸Ğ·Ğ¾Ğ²Ğ°Ğ½Ğ½Ğ¾Ğ³Ğ¾ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ñ.
    """
    rentals_out, total = await service.get_rentals_for_user(
        current_user, skip, limit, status, search, sort
    )
    return RentalListResponse(
        items=rentals_out,
        total=total
    )


@router.get("/balance-history", response_model=BalanceHistoryListResponse)
async def get_my_balance_history(
        db: AsyncSession = Depends(get_db),
        current_user: PermissionUser = Depends(require_user),
        skip: int = Query(0, ge=0),
        limit: int = Query(15, ge=1, le=100)
):
    """
    Ğ’Ğ¾Ğ·Ğ²Ñ€Ğ°Ñ‰Ğ°ĞµÑ‚ Ğ¸ÑÑ‚Ğ¾Ñ€Ğ¸Ñ Ñ‚Ñ€Ğ°Ğ½Ğ·Ğ°ĞºÑ†Ğ¸Ğ¹ Ğ¿Ğ¾ Ğ±Ğ°Ğ»Ğ°Ğ½ÑÑƒ Ğ´Ğ»Ñ Ñ‚ĞµĞºÑƒÑ‰ĞµĞ³Ğ¾ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ñ.
    """
    history_orm, total = await user_service.get_balance_history_for_user(db, current_user.id, skip, limit)
    return BalanceHistoryListResponse(
        items=[BalanceHistoryOut.from_orm(h) for h in history_orm],
        total=total
    )


@router.put("/", response_model=UserOut)
async def update_my_profile(
        data: UserUpdate,
        db: AsyncSession = Depends(get_db),
        current_user: PermissionUser = Depends(require_user),
        csrf_protect: CsrfProtect = Depends()
):
    """
    ĞĞ±Ğ½Ğ¾Ğ²Ğ»ÑĞµÑ‚ Ğ¿Ñ€Ğ¾Ñ„Ğ¸Ğ»ÑŒ (Ğ¤Ğ˜Ğ, email, Ñ‚ĞµĞ»ĞµÑ„Ğ¾Ğ½) Ñ‚ĞµĞºÑƒÑ‰ĞµĞ³Ğ¾ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ñ.
    Ğ—ĞĞ“Ğ›Ğ£Ğ¨ĞšĞ: Ğ¡Ğ¼ĞµĞ½Ğ° email Ğ² Ğ±ÑƒĞ´ÑƒÑ‰ĞµĞ¼ Ğ¿Ğ¾Ñ‚Ñ€ĞµĞ±ÑƒĞµÑ‚ Ğ¿Ğ¾Ğ´Ñ‚Ğ²ĞµÑ€Ğ¶Ğ´ĞµĞ½Ğ¸Ñ Ğ¿Ğ¾ Ğ¿Ğ¾Ñ‡Ñ‚Ğµ.
    """
    return await user_service.update_user(db, current_user, data)


@router.post("/confirm-email-change", summary="ĞŸĞ¾Ğ´Ñ‚Ğ²ĞµÑ€Ğ´Ğ¸Ñ‚ÑŒ ÑĞ¼ĞµĞ½Ñƒ email (Ğ·Ğ°Ğ³Ğ»ÑƒÑˆĞºĞ°)")
async def confirm_email_change(
        token: str,
        db: AsyncSession = Depends(get_db),
        current_user: PermissionUser = Depends(require_user),
        csrf_protect: CsrfProtect = Depends()
):
    """
    Ğ—ĞĞ“Ğ›Ğ£Ğ¨ĞšĞ: Ğ’ Ğ±ÑƒĞ´ÑƒÑ‰ĞµĞ¼ Ğ·Ğ´ĞµÑÑŒ Ğ±ÑƒĞ´ĞµÑ‚ Ğ»Ğ¾Ğ³Ğ¸ĞºĞ° Ğ¿Ğ¾Ğ´Ñ‚Ğ²ĞµÑ€Ğ¶Ğ´ĞµĞ½Ğ¸Ñ ÑĞ¼ĞµĞ½Ñ‹ email Ğ¿Ğ¾ Ñ‚Ğ¾ĞºĞµĞ½Ñƒ.
    Ğ¡ĞµĞ¹Ñ‡Ğ°Ñ Ğ¿Ñ€Ğ¾ÑÑ‚Ğ¾ Ğ²Ğ¾Ğ·Ğ²Ñ€Ğ°Ñ‰Ğ°ĞµÑ‚ ÑĞ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ğµ Ğ¾ Ñ‚Ğ¾Ğ¼, Ñ‡Ñ‚Ğ¾ Ñ„ÑƒĞ½ĞºÑ†Ğ¸Ğ¾Ğ½Ğ°Ğ» Ğ² Ñ€Ğ°Ğ·Ñ€Ğ°Ğ±Ğ¾Ñ‚ĞºĞµ.
    """
    return {
        "message": "Ğ¤ÑƒĞ½ĞºÑ†Ğ¸Ğ¾Ğ½Ğ°Ğ» Ğ¿Ğ¾Ğ´Ñ‚Ğ²ĞµÑ€Ğ¶Ğ´ĞµĞ½Ğ¸Ñ ÑĞ¼ĞµĞ½Ñ‹ email Ğ½Ğ°Ñ…Ğ¾Ğ´Ğ¸Ñ‚ÑÑ Ğ² Ñ€Ğ°Ğ·Ñ€Ğ°Ğ±Ğ¾Ñ‚ĞºĞµ",
        "status": "not_implemented"
    }


# --- Ğ­Ğ½Ğ´Ğ¿Ğ¾Ğ¸Ğ½Ñ‚Ñ‹ Ğ´Ğ»Ñ Ğ°Ğ´Ğ¼Ğ¸Ğ½Ğ¸ÑÑ‚Ñ€Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ ---

@router.post("/admin/users", response_model=UserOut, status_code=201, summary="Ğ¡Ğ¾Ğ·Ğ´Ğ°Ñ‚ÑŒ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ñ (ĞĞ´Ğ¼Ğ¸Ğ½)")
async def create_user_by_admin(
        user_data: AdminUserCreate,
        db: AsyncSession = Depends(get_db),
        current_user: PermissionUser = Depends(require_admin),
        csrf_protect: CsrfProtect = Depends()
):
    """
    Ğ¡Ğ¾Ğ·Ğ´Ğ°ĞµÑ‚ Ğ½Ğ¾Ğ²Ğ¾Ğ³Ğ¾ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ñ Ñ ÑƒĞºĞ°Ğ·Ğ°Ğ½Ğ½Ğ¾Ğ¹ Ñ€Ğ¾Ğ»ÑŒÑ.
    Ğ”Ğ¾ÑÑ‚ÑƒĞ¿Ğ½Ğ¾ Ñ‚Ğ¾Ğ»ÑŒĞºĞ¾ Ğ´Ğ»Ñ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ĞµĞ¹ Ñ Ñ€Ğ¾Ğ»ÑŒÑ 'admin'.
    """
    new_user = await user_service.create_admin_user(db, user_data)
    return new_user


@router.get("/admin/users", response_model=UserListResponse, summary="ĞŸĞ¾Ğ»ÑƒÑ‡Ğ¸Ñ‚ÑŒ Ğ²ÑĞµÑ… Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ĞµĞ¹ (ĞœĞµĞ½ĞµĞ´Ğ¶ĞµÑ€)")
async def get_all_users(
        db: AsyncSession = Depends(get_db),
        current_user: PermissionUser = Depends(require_manager),
        skip: int = Query(0, ge=0, description="Ğ¡ĞºĞ¾Ğ»ÑŒĞºĞ¾ Ğ·Ğ°Ğ¿Ğ¸ÑĞµĞ¹ Ğ¿Ñ€Ğ¾Ğ¿ÑƒÑÑ‚Ğ¸Ñ‚ÑŒ"),
        limit: int = Query(10, ge=1, le=100, description="ĞœĞ°ĞºÑĞ¸Ğ¼Ğ°Ğ»ÑŒĞ½Ğ¾Ğµ ĞºĞ¾Ğ»Ğ¸Ñ‡ĞµÑÑ‚Ğ²Ğ¾ Ğ·Ğ°Ğ¿Ğ¸ÑĞµĞ¹ Ğ½Ğ° ÑÑ‚Ñ€Ğ°Ğ½Ğ¸Ñ†Ğµ")
):
    """
    ĞŸĞ¾Ğ»ÑƒÑ‡Ğ°ĞµÑ‚ ÑĞ¿Ğ¸ÑĞ¾Ğº Ğ²ÑĞµÑ… Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ĞµĞ¹ Ğ² ÑĞ¸ÑÑ‚ĞµĞ¼Ğµ Ñ Ğ¿Ğ°Ğ³Ğ¸Ğ½Ğ°Ñ†Ğ¸ĞµĞ¹.
    Ğ”Ğ¾ÑÑ‚ÑƒĞ¿Ğ½Ğ¾ Ğ´Ğ»Ñ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ĞµĞ¹ Ñ Ñ€Ğ¾Ğ»ÑŒÑ 'manager' Ğ¸ 'admin'.
    """
    total_result = await db.execute(select(func.count(OrmUser.id)))
    total_users = total_result.scalar_one()
    users_result = await db.execute(select(OrmUser).offset(skip).limit(limit))
    users_orm = users_result.scalars().all()

    return UserListResponse(
        items=[UserOut.from_orm(user) for user in users_orm],
        total=total_users
    )


@router.get("/admin/users/{user_id}/balance-history", response_model=BalanceHistoryListResponse, summary="ĞŸĞ¾Ğ»ÑƒÑ‡Ğ¸Ñ‚ÑŒ Ğ¸ÑÑ‚Ğ¾Ñ€Ğ¸Ñ Ğ±Ğ°Ğ»Ğ°Ğ½ÑĞ° Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ñ (ĞœĞµĞ½ĞµĞ´Ğ¶ĞµÑ€)")
async def get_user_balance_history_by_admin(
        user_id: int,
        db: AsyncSession = Depends(get_db),
        current_user: PermissionUser = Depends(require_manager),
        skip: int = Query(0, ge=0),
        limit: int = Query(15, ge=1, le=100)
):
    """
    Ğ’Ğ¾Ğ·Ğ²Ñ€Ğ°Ñ‰Ğ°ĞµÑ‚ Ğ¸ÑÑ‚Ğ¾Ñ€Ğ¸Ñ Ñ‚Ñ€Ğ°Ğ½Ğ·Ğ°ĞºÑ†Ğ¸Ğ¹ Ğ¿Ğ¾ Ğ±Ğ°Ğ»Ğ°Ğ½ÑÑƒ Ğ´Ğ»Ñ ÑƒĞºĞ°Ğ·Ğ°Ğ½Ğ½Ğ¾Ğ³Ğ¾ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ñ.
    """
    history_orm, total = await user_service.get_balance_history_for_user(db, user_id, skip, limit)
    return BalanceHistoryListResponse(
        items=[BalanceHistoryOut.from_orm(h) for h in history_orm],
        total=total
    )


@router.post("/admin/users/{user_id}/add-payment", response_model=UserOut, summary="Ğ”Ğ¾Ğ±Ğ°Ğ²Ğ¸Ñ‚ÑŒ Ğ¿Ğ»Ğ°Ñ‚ĞµĞ¶ Ğ¸ Ğ¿Ğ¾Ğ¿Ğ¾Ğ»Ğ½Ğ¸Ñ‚ÑŒ Ğ±Ğ°Ğ»Ğ°Ğ½Ñ (ĞœĞµĞ½ĞµĞ´Ğ¶ĞµÑ€)")
async def add_payment_to_user(
        user_id: int,
        payment_data: UserPaymentRequest,
        db: AsyncSession = Depends(get_db),
        current_user: PermissionUser = Depends(require_manager),
        csrf_protect: CsrfProtect = Depends()
):
    """
    Ğ ĞµĞ³Ğ¸ÑÑ‚Ñ€Ğ¸Ñ€ÑƒĞµÑ‚ Ñ€ĞµĞ°Ğ»ÑŒĞ½Ñ‹Ğ¹ Ğ¿Ğ»Ğ°Ñ‚ĞµĞ¶ Ğ¾Ñ‚ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ñ Ğ¸ Ğ¿Ğ¾Ğ¿Ğ¾Ğ»Ğ½ÑĞµÑ‚ ĞµĞ³Ğ¾ Ğ²Ğ½ÑƒÑ‚Ñ€ĞµĞ½Ğ½Ğ¸Ğ¹ Ğ±Ğ°Ğ»Ğ°Ğ½Ñ.
    """
    return await user_service.process_user_payment(db, user_id, payment_data, current_user)


@router.put("/admin/users/{user_id}", response_model=UserOut, summary="ĞĞ±Ğ½Ğ¾Ğ²Ğ¸Ñ‚ÑŒ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ñ (ĞœĞµĞ½ĞµĞ´Ğ¶ĞµÑ€/ĞĞ´Ğ¼Ğ¸Ğ½)")
async def update_user_by_admin_or_manager(
        user_id: int,
        data: AdminUserUpdate,
        db: AsyncSession = Depends(get_db),
        current_user: PermissionUser = Depends(require_manager),
        csrf_protect: CsrfProtect = Depends()
):
    """
    ĞĞ±Ğ½Ğ¾Ğ²Ğ»ÑĞµÑ‚ Ğ´Ğ°Ğ½Ğ½Ñ‹Ğµ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ñ. ĞœĞµĞ½ĞµĞ´Ğ¶ĞµÑ€Ñ‹ Ğ¼Ğ¾Ğ³ÑƒÑ‚ Ğ¾Ğ±Ğ½Ğ¾Ğ²Ğ»ÑÑ‚ÑŒ Ğ²ÑĞµ, ĞºÑ€Ğ¾Ğ¼Ğµ Ñ€Ğ¾Ğ»Ğ¸.
    ĞĞ´Ğ¼Ğ¸Ğ½Ğ¸ÑÑ‚Ñ€Ğ°Ñ‚Ğ¾Ñ€Ñ‹ Ğ¼Ğ¾Ğ³ÑƒÑ‚ Ğ¾Ğ±Ğ½Ğ¾Ğ²Ğ»ÑÑ‚ÑŒ Ğ²ÑĞµ, Ğ²ĞºĞ»ÑÑ‡Ğ°Ñ Ñ€Ğ¾Ğ»ÑŒ. Email Ğ½Ğµ Ğ¼ĞµĞ½ÑĞµÑ‚ÑÑ.
    """
    return await user_service.update_user_by_admin(db, user_id, data, current_user)


@router.put("/admin/users/{user_id}/role", summary="Ğ˜Ğ·Ğ¼ĞµĞ½Ğ¸Ñ‚ÑŒ Ñ€Ğ¾Ğ»ÑŒ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ñ (ĞĞ´Ğ¼Ğ¸Ğ½)")
async def update_user_role(
        user_id: int,
        new_role: str,
        db: AsyncSession = Depends(get_db),
        current_user: PermissionUser = Depends(require_admin),
        csrf_protect: CsrfProtect = Depends()
):
    """
    ĞĞ±Ğ½Ğ¾Ğ²Ğ»ÑĞµÑ‚ Ñ€Ğ¾Ğ»ÑŒ ÑƒĞºĞ°Ğ·Ğ°Ğ½Ğ½Ğ¾Ğ³Ğ¾ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ñ.
    Ğ”Ğ¾ÑÑ‚ÑƒĞ¿Ğ½Ğ¾ Ñ‚Ğ¾Ğ»ÑŒĞºĞ¾ Ğ´Ğ»Ñ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ĞµĞ¹ Ñ Ñ€Ğ¾Ğ»ÑŒÑ 'admin'.
    """
    if user_id == current_user.id:
        raise HTTPException(status_code=400, detail="ĞĞµĞ»ÑŒĞ·Ñ Ğ¸Ğ·Ğ¼ĞµĞ½Ğ¸Ñ‚ÑŒ ÑĞ¾Ğ±ÑÑ‚Ğ²ĞµĞ½Ğ½ÑƒÑ Ñ€Ğ¾Ğ»ÑŒ.")

    result = await db.execute(select(OrmUser).filter(OrmUser.id == user_id))
    user_orm = result.scalars().first()
    if not user_orm:
        raise HTTPException(status_code=404, detail="ĞŸĞ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ÑŒ Ğ½Ğµ Ğ½Ğ°Ğ¹Ğ´ĞµĞ½")

    if new_role not in ["user", "manager", "admin"]:
        raise HTTPException(status_code=400, detail="ĞĞµĞ´Ğ¾Ğ¿ÑƒÑÑ‚Ğ¸Ğ¼Ğ¾Ğµ Ğ·Ğ½Ğ°Ñ‡ĞµĞ½Ğ¸Ğµ Ñ€Ğ¾Ğ»Ğ¸.")

    user_orm.role = new_role
    await db.commit()
    return {"message": f"Ğ Ğ¾Ğ»ÑŒ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ñ {user_orm.email} Ğ¾Ğ±Ğ½Ğ¾Ğ²Ğ»ĞµĞ½Ğ° Ğ½Ğ° '{new_role}'"}


@router.put("/admin/users/{user_id}/block", summary="Ğ—Ğ°Ğ±Ğ»Ğ¾ĞºĞ¸Ñ€Ğ¾Ğ²Ğ°Ñ‚ÑŒ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ñ (ĞĞ´Ğ¼Ğ¸Ğ½)")
async def block_user(
        user_id: int,
        db: AsyncSession = Depends(get_db),
        current_user: PermissionUser = Depends(require_admin),
        csrf_protect: CsrfProtect = Depends()
):
    """
    Ğ”ĞµĞ°ĞºÑ‚Ğ¸Ğ²Ğ¸Ñ€ÑƒĞµÑ‚ (Ğ±Ğ»Ğ¾ĞºĞ¸Ñ€ÑƒĞµÑ‚) Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ñ.
    Ğ”Ğ¾ÑÑ‚ÑƒĞ¿Ğ½Ğ¾ Ñ‚Ğ¾Ğ»ÑŒĞºĞ¾ Ğ´Ğ»Ñ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ĞµĞ¹ Ñ Ñ€Ğ¾Ğ»ÑŒÑ 'admin'.
    """
    if user_id == current_user.id:
        raise HTTPException(status_code=400, detail="ĞĞµĞ»ÑŒĞ·Ñ Ğ·Ğ°Ğ±Ğ»Ğ¾ĞºĞ¸Ñ€Ğ¾Ğ²Ğ°Ñ‚ÑŒ ÑĞ°Ğ¼Ğ¾Ğ³Ğ¾ ÑĞµĞ±Ñ.")

    result = await db.execute(select(OrmUser).filter(OrmUser.id == user_id))
    user_orm = result.scalars().first()
    if not user_orm:
        raise HTTPException(status_code=404, detail="ĞŸĞ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ÑŒ Ğ½Ğµ Ğ½Ğ°Ğ¹Ğ´ĞµĞ½")

    user_orm.is_active = False
    await db.commit()
    return {"message": f"ĞŸĞ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ÑŒ {user_orm.email} Ğ·Ğ°Ğ±Ğ»Ğ¾ĞºĞ¸Ñ€Ğ¾Ğ²Ğ°Ğ½"}


@router.put("/admin/users/{user_id}/unblock", summary="Ğ Ğ°Ğ·Ğ±Ğ»Ğ¾ĞºĞ¸Ñ€Ğ¾Ğ²Ğ°Ñ‚ÑŒ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ñ (ĞĞ´Ğ¼Ğ¸Ğ½)")
async def unblock_user(
        user_id: int,
        db: AsyncSession = Depends(get_db),
        current_user: PermissionUser = Depends(require_admin),
        csrf_protect: CsrfProtect = Depends()
):
    """
    ĞĞºÑ‚Ğ¸Ğ²Ğ¸Ñ€ÑƒĞµÑ‚ (Ñ€Ğ°Ğ·Ğ±Ğ»Ğ¾ĞºĞ¸Ñ€ÑƒĞµÑ‚) Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ñ.
    Ğ”Ğ¾ÑÑ‚ÑƒĞ¿Ğ½Ğ¾ Ñ‚Ğ¾Ğ»ÑŒĞºĞ¾ Ğ´Ğ»Ñ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ĞµĞ¹ Ñ Ñ€Ğ¾Ğ»ÑŒÑ 'admin'.
    """
    result = await db.execute(select(OrmUser).filter(OrmUser.id == user_id))
    user_orm = result.scalars().first()
    if not user_orm:
        raise HTTPException(status_code=404, detail="ĞŸĞ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ÑŒ Ğ½Ğµ Ğ½Ğ°Ğ¹Ğ´ĞµĞ½")

    user_orm.is_active = True
    await db.commit()
    return {"message": f"ĞŸĞ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ÑŒ {user_orm.email} Ñ€Ğ°Ğ·Ğ±Ğ»Ğ¾ĞºĞ¸Ñ€Ğ¾Ğ²Ğ°Ğ½"}


@router.delete("/admin/users/{user_id}", summary="Ğ£Ğ´Ğ°Ğ»Ğ¸Ñ‚ÑŒ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ñ (ĞĞ´Ğ¼Ğ¸Ğ½)")
async def delete_user(
        user_id: int,
        db: AsyncSession = Depends(get_db),
        current_user: PermissionUser = Depends(require_admin),
        csrf_protect: CsrfProtect = Depends()
):
    """
    ĞŸĞ¾Ğ»Ğ½Ğ¾ÑÑ‚ÑŒÑ ÑƒĞ´Ğ°Ğ»ÑĞµÑ‚ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ñ Ğ¸Ğ· Ğ±Ğ°Ğ·Ñ‹ Ğ´Ğ°Ğ½Ğ½Ñ‹Ñ….
    Ğ­Ñ‚Ğ¾ Ğ½ĞµĞ¾Ğ±Ñ€Ğ°Ñ‚Ğ¸Ğ¼Ğ¾Ğµ Ğ´ĞµĞ¹ÑÑ‚Ğ²Ğ¸Ğµ!
    Ğ”Ğ¾ÑÑ‚ÑƒĞ¿Ğ½Ğ¾ Ñ‚Ğ¾Ğ»ÑŒĞºĞ¾ Ğ´Ğ»Ñ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ĞµĞ¹ Ñ Ñ€Ğ¾Ğ»ÑŒÑ 'admin'.
    """
    if user_id == current_user.id:
        raise HTTPException(status_code=400, detail="ĞĞµĞ»ÑŒĞ·Ñ ÑƒĞ´Ğ°Ğ»Ğ¸Ñ‚ÑŒ ÑĞ°Ğ¼Ğ¾Ğ³Ğ¾ ÑĞµĞ±Ñ.")

    result = await db.execute(select(OrmUser).filter(OrmUser.id == user_id))
    user_orm = result.scalars().first()
    if not user_orm:
        raise HTTPException(status_code=404, detail="ĞŸĞ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ÑŒ Ğ½Ğµ Ğ½Ğ°Ğ¹Ğ´ĞµĞ½")

    await db.delete(user_orm)
    await db.commit()
    return {"message": f"ĞŸĞ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ÑŒ {user_orm.email} Ğ¿Ğ¾Ğ»Ğ½Ğ¾ÑÑ‚ÑŒÑ ÑƒĞ´Ğ°Ğ»ĞµĞ½ Ğ¸Ğ· ÑĞ¸ÑÑ‚ĞµĞ¼Ñ‹"}

```


## <a name="RentalAppFASTAPIconfiginitpy"></a>`RentalApp_FASTAPI/config/__init__.py`

```python
// path: RentalApp_FASTAPI/config/__init__.py

# config/__init__.py

"""
ĞŸĞ°ĞºĞµÑ‚ ĞºĞ¾Ğ½Ñ„Ğ¸Ğ³ÑƒÑ€Ğ°Ñ†Ğ¸Ğ¸ Ğ¿Ñ€Ğ¾ĞµĞºÑ‚Ğ° Ğ°Ñ€ĞµĞ½Ğ´Ñ‹ Ñ„Ğ¾Ñ‚Ğ¾Ñ‚ĞµÑ…Ğ½Ğ¸ĞºĞ¸.
Ğ˜Ğ¼Ğ¿Ğ¾Ñ€Ñ‚Ğ¸Ñ€ÑƒĞµÑ‚ Ğ±Ğ°Ğ·Ğ¾Ğ²Ñ‹Ğµ Ğ½Ğ°ÑÑ‚Ñ€Ğ¾Ğ¹ĞºĞ¸ Ğ¸ ĞºĞ¾Ğ½Ñ„Ğ¸Ğ³ÑƒÑ€Ğ°Ñ†Ğ¸Ñ Ğ»Ğ¾Ğ³Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ.
"""

# Ğ˜Ğ½Ğ¸Ñ†Ğ¸Ğ°Ğ»Ğ¸Ğ·Ğ°Ñ†Ğ¸Ñ Ğ»Ğ¾Ğ³Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ ÑÑ€Ğ°Ğ·Ñƒ Ğ¿Ñ€Ğ¸ Ğ¸Ğ¼Ğ¿Ğ¾Ñ€Ñ‚Ğµ config
from config import logging_config

```


## <a name="RentalAppFASTAPIconfigloggingconfigpy"></a>`RentalApp_FASTAPI/config/logging_config.py`

```python
// path: RentalApp_FASTAPI/config/logging_config.py

# config/logging_config.py

"""
ĞšĞ¾Ğ½Ñ„Ğ¸Ğ³ÑƒÑ€Ğ°Ñ†Ğ¸Ñ Ğ»Ğ¾Ğ³Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ Ğ´Ğ»Ñ Ğ¿Ñ€Ğ¾ĞµĞºÑ‚Ğ° Ğ°Ñ€ĞµĞ½Ğ´Ñ‹ Ñ„Ğ¾Ñ‚Ğ¾Ñ‚ĞµÑ…Ğ½Ğ¸ĞºĞ¸.
"""

import logging
from config.settings import LOG_FILE, DEBUG

# Ğ‘Ğ°Ğ·Ğ¾Ğ²Ğ°Ñ Ğ½Ğ°ÑÑ‚Ñ€Ğ¾Ğ¹ĞºĞ° Ğ»Ğ¾Ğ³Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ
logging.basicConfig(
    level=logging.DEBUG if DEBUG else logging.WARNING,
    format="%(asctime)s [%(levelname)s] [%(name)s] %(message)s",
    handlers=[
        logging.FileHandler(LOG_FILE, encoding="utf-8"),
        logging.StreamHandler()
    ]
)

# ĞÑ‚ĞºĞ»ÑÑ‡ĞµĞ½Ğ¸Ğµ Ğ½ĞµĞ½ÑƒĞ¶Ğ½Ñ‹Ñ… Ğ»Ğ¾Ğ³Ğ¾Ğ²
logging.getLogger("httpcore").setLevel(logging.WARNING)
logging.getLogger("httpx").setLevel(logging.WARNING)
logging.getLogger("TelegramService").setLevel(logging.DEBUG)

# Ğ’ĞºĞ»ÑÑ‡ĞµĞ½Ğ¸Ğµ Ğ»Ğ¾Ğ³Ğ¾Ğ² Ğ´Ğ»Ñ SQLAlchemy (SQL-Ğ·Ğ°Ğ¿Ñ€Ğ¾ÑÑ‹) Ğ¸ EquipmentService
logging.getLogger("sqlalchemy.engine").setLevel(logging.WARNING)
logging.getLogger("EquipmentService").setLevel(logging.WARNING)
logging.getLogger("BaseManager").setLevel(logging.WARNING)
logging.getLogger("EquipmentManager").setLevel(logging.WARNING)
logging.getLogger("AvailabilityChecker").setLevel(logging.DEBUG)
logging.getLogger("matplotlib").setLevel(logging.WARNING)
# Ğ£Ñ€Ğ¾Ğ²ĞµĞ½ÑŒ Ğ»Ğ¾Ğ³Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ Ğ´Ğ»Ñ Ğ¾Ñ‚Ğ´ĞµĞ»ÑŒĞ½Ñ‹Ñ… Ğ¼Ğ¾Ğ´ÑƒĞ»ĞµĞ¹ Ğ¼Ğ¾Ğ¶Ğ½Ğ¾ Ğ½Ğ°ÑÑ‚Ñ€Ğ¾Ğ¸Ñ‚ÑŒ Ñ‚Ğ°Ğº:
# logging.getLogger('sqlalchemy.engine').setLevel(logging.WARNING)




```


## <a name="RentalAppFASTAPIconfigsecretspy"></a>`RentalApp_FASTAPI/config/secrets.py`

```python
// path: RentalApp_FASTAPI/config/secrets.py

"""
Ğ—Ğ°Ğ³Ñ€ÑƒĞ·ĞºĞ° ĞºĞ¾Ğ½Ñ„Ğ¸Ğ´ĞµĞ½Ñ†Ğ¸Ğ°Ğ»ÑŒĞ½Ñ‹Ñ… Ğ½Ğ°ÑÑ‚Ñ€Ğ¾ĞµĞº Ğ¸Ğ· Ğ¿ĞµÑ€ĞµĞ¼ĞµĞ½Ğ½Ñ‹Ñ… Ğ¾ĞºÑ€ÑƒĞ¶ĞµĞ½Ğ¸Ñ.
"""

import os
from pathlib import Path
from dotenv import load_dotenv

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ Ğ—Ğ°Ğ³Ñ€ÑƒĞ·ĞºĞ° .env â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
load_dotenv()

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ ĞšĞ¾Ñ€ĞµĞ½ÑŒ Ğ¿Ñ€Ğ¾ĞµĞºÑ‚Ğ° â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
BASE_DIR = Path(__file__).resolve().parent.parent

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ Ğ¡ĞµĞºÑ€ĞµÑ‚Ñ‹ Ğ¸ Ñ‚Ğ¾ĞºĞµĞ½Ñ‹ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
TELEGRAM_TOKEN = os.getenv("TELEGRAM_TOKEN", "default_token_for_dev")
DEFAULT_TELEGRAM_CHAT_ID = os.getenv("DEFAULT_TELEGRAM_CHAT_ID", "")
YANDEX_EMAIL_SENDER = os.getenv("YANDEX_EMAIL_SENDER")
YANDEX_SMTP_PASSWORD = os.getenv("YANDEX_SMTP_PASSWORD")

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ URL Ğ±Ğ°Ğ·Ñ‹ Ğ´Ğ°Ğ½Ğ½Ñ‹Ñ… â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# Ğ˜ÑĞ¿Ğ¾Ğ»ÑŒĞ·ÑƒĞµĞ¼ Ñ‚Ğ¾Ğ»ÑŒĞºĞ¾ PostgreSQL
DATABASE_URL = os.getenv("DATABASE_URL", "postgresql+asyncpg://myuser:supersecretpassword@db:5432/rental_db")
print("ğŸ§© Ğ˜ÑĞ¿Ğ¾Ğ»ÑŒĞ·ÑƒĞµÑ‚ÑÑ PostgreSQL")

# DEBUG Ğ¼Ğ¾Ğ¶ĞµÑ‚ Ğ¾ÑÑ‚Ğ°Ñ‚ÑŒÑÑ Ğ·Ğ´ĞµÑÑŒ (ĞµÑĞ»Ğ¸ Ğ¸ÑĞ¿Ğ¾Ğ»ÑŒĞ·ÑƒĞµÑ‚ÑÑ)
DEBUG = os.getenv("DEBUG", "True").lower() == "true"

SECRET_KEY = os.getenv("SECRET_KEY", "super-secret-key-dev")


```


## <a name="RentalAppFASTAPIconfigsettingspy"></a>`RentalApp_FASTAPI/config/settings.py`

```python
// path: RentalApp_FASTAPI/config/settings.py

"""
ĞĞ°ÑÑ‚Ñ€Ğ¾Ğ¹ĞºĞ¸ Ğ¿Ñ€Ğ¾ĞµĞºÑ‚Ğ° ĞÑ€ĞµĞ½Ğ´Ñ‹ Ñ„Ğ¾Ñ‚Ğ¾Ñ‚ĞµÑ…Ğ½Ğ¸ĞºĞ¸ (Ğ½Ğµ Ğ²ĞºĞ»ÑÑ‡Ğ°Ñ ÑĞµĞºÑ€ĞµÑ‚Ñ‹ Ğ¸ Ğ‘Ğ”).
"""

import os
from pathlib import Path
from dotenv import load_dotenv

# Ğ—Ğ°Ğ³Ñ€ÑƒĞ·ĞºĞ° .env
load_dotenv()

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ ĞĞ±Ñ‰Ğ¸Ğµ Ğ½Ğ°ÑÑ‚Ñ€Ğ¾Ğ¹ĞºĞ¸ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
BASE_DIR = Path(__file__).resolve().parent.parent
APP_NAME = "ĞÑ€ĞµĞ½Ğ´Ğ° Ñ„Ğ¾Ñ‚Ğ¾Ñ‚ĞµÑ…Ğ½Ğ¸ĞºĞ¸"

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ ĞŸÑƒÑ‚Ğ¸ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
LOG_FILE = BASE_DIR / "app.log"
EXPORT_FOLDER = BASE_DIR / "exports"
EXPORT_FOLDER.mkdir(exist_ok=True)
CONTRACT_TEMPLATE = BASE_DIR / "ui" / "pdf" / "contract_template.html"

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ Ğ˜Ğ½Ñ‚ĞµÑ€Ñ„ĞµĞ¹Ñ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
DEFAULT_WINDOW_WIDTH = 1400
DEFAULT_WINDOW_HEIGHT = 900

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ ĞÑ‚Ğ»Ğ°Ğ´ĞºĞ° â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
DEBUG = os.getenv("DEBUG", "True").lower() == "true"


PASSWORD_MIN_LENGTH = 8
PASSWORD_REQUIRE_UPPERCASE = True
PASSWORD_REQUIRE_LOWERCASE = True
PASSWORD_REQUIRE_DIGITS = True


```


## <a name="RentalAppFASTAPIcreateadminpy"></a>`RentalApp_FASTAPI/create_admin.py`

```python
// path: RentalApp_FASTAPI/create_admin.py

# RentalApp_FASTAPI/scripts/create_admin.py

import asyncio
import sys
import os
from sqlalchemy import select

# Ğ”Ğ¾Ğ±Ğ°Ğ²Ğ»ÑĞµĞ¼ ĞºĞ¾Ñ€Ğ½ĞµĞ²ÑƒÑ Ğ´Ğ¸Ñ€ĞµĞºÑ‚Ğ¾Ñ€Ğ¸Ñ Ğ¿Ñ€Ğ¾ĞµĞºÑ‚Ğ° Ğ² Ğ¿ÑƒÑ‚ÑŒ, Ñ‡Ñ‚Ğ¾Ğ±Ñ‹ Ñ€Ğ°Ğ±Ğ¾Ñ‚Ğ°Ğ»Ğ¸ Ğ¸Ğ¼Ğ¿Ğ¾Ñ€Ñ‚Ñ‹
sys.path.append(os.path.dirname(os.path.dirname(os.path.abspath(__file__))))

from api.database import AsyncSessionLocal
from api.models.user import User
from api.services.auth_service import hash_password

# --- Ğ”Ğ°Ğ½Ğ½Ñ‹Ğµ Ğ´Ğ»Ñ Ğ²Ñ…Ğ¾Ğ´Ğ° Ğ°Ğ´Ğ¼Ğ¸Ğ½Ğ¸ÑÑ‚Ñ€Ğ°Ñ‚Ğ¾Ñ€Ğ° ---
ADMIN_EMAIL = "admin@rentalapp.com"
ADMIN_PASSWORD = "AdminRental2024!" # Ğ‘ĞµĞ·Ğ¾Ğ¿Ğ°ÑĞ½Ñ‹Ğ¹ Ğ¿Ğ°Ñ€Ğ¾Ğ»ÑŒ
ADMIN_FULL_NAME = "Ğ“Ğ»Ğ°Ğ²Ğ½Ñ‹Ğ¹ ĞĞ´Ğ¼Ğ¸Ğ½Ğ¸ÑÑ‚Ñ€Ğ°Ñ‚Ğ¾Ñ€"
ADMIN_PHONE = "+7 (999) 000-00-00"
# ------------------------------------

async def create_admin_user():
    """
    Ğ¡Ğ¾Ğ·Ğ´Ğ°ĞµÑ‚ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ñ Ñ Ğ¿Ñ€Ğ°Ğ²Ğ°Ğ¼Ğ¸ Ğ°Ğ´Ğ¼Ğ¸Ğ½Ğ¸ÑÑ‚Ñ€Ğ°Ñ‚Ğ¾Ñ€Ğ° Ğ² Ğ±Ğ°Ğ·Ğµ Ğ´Ğ°Ğ½Ğ½Ñ‹Ñ….
    """
    print("ğŸš€ Ğ—Ğ°Ğ¿ÑƒÑĞº ÑĞºÑ€Ğ¸Ğ¿Ñ‚Ğ° ÑĞ¾Ğ·Ğ´Ğ°Ğ½Ğ¸Ñ Ğ°Ğ´Ğ¼Ğ¸Ğ½Ğ¸ÑÑ‚Ñ€Ğ°Ñ‚Ğ¾Ñ€Ğ°...")
    db_session = AsyncSessionLocal()
    try:
        # ĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑĞµĞ¼, ÑÑƒÑ‰ĞµÑÑ‚Ğ²ÑƒĞµÑ‚ Ğ»Ğ¸ ÑƒĞ¶Ğµ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ÑŒ Ñ Ñ‚Ğ°ĞºĞ¸Ğ¼ email
        result = await db_session.execute(select(User).filter(User.email == ADMIN_EMAIL))
        existing_user = result.scalars().first()

        if existing_user:
            print(f"âœ… ĞŸĞ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ÑŒ Ñ email '{ADMIN_EMAIL}' ÑƒĞ¶Ğµ ÑÑƒÑ‰ĞµÑÑ‚Ğ²ÑƒĞµÑ‚. ĞŸÑ€Ğ¾Ğ¿ÑƒÑĞºĞ°ĞµĞ¼ ÑĞ¾Ğ·Ğ´Ğ°Ğ½Ğ¸Ğµ.")
            return

        # Ğ¡Ğ¾Ğ·Ğ´Ğ°ĞµĞ¼ Ğ½Ğ¾Ğ²Ğ¾Ğ³Ğ¾ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ñ
        new_admin = User(
            full_name=ADMIN_FULL_NAME,
            email=ADMIN_EMAIL,
            hashed_password=hash_password(ADMIN_PASSWORD),
            phone=ADMIN_PHONE,
            role="admin",
            is_active=True,
            status="ĞĞºÑ‚Ğ¸Ğ²Ğ½Ñ‹Ğ¹",
            balance=0.0,
            notes="Ğ¡Ğ¾Ğ·Ğ´Ğ°Ğ½ Ğ°Ğ²Ñ‚Ğ¾Ğ¼Ğ°Ñ‚Ğ¸Ñ‡ĞµÑĞºĞ¸ Ğ¿Ñ€Ğ¸ Ğ¸Ğ½Ğ¸Ñ†Ğ¸Ğ°Ğ»Ğ¸Ğ·Ğ°Ñ†Ğ¸Ğ¸",
            privacy_policy_accepted=True,
            terms_accepted=True,
            email_verified=True
        )
        db_session.add(new_admin)
        await db_session.commit()
        print("âœ… Ğ£Ñ‡ĞµÑ‚Ğ½Ğ°Ñ Ğ·Ğ°Ğ¿Ğ¸ÑÑŒ Ğ°Ğ´Ğ¼Ğ¸Ğ½Ğ¸ÑÑ‚Ñ€Ğ°Ñ‚Ğ¾Ñ€Ğ° ÑƒÑĞ¿ĞµÑˆĞ½Ğ¾ ÑĞ¾Ğ·Ğ´Ğ°Ğ½Ğ°!")
        print("---")
        print(f"  ğŸ“§ Email: {ADMIN_EMAIL}")
        print(f"  ğŸ”‘ ĞŸĞ°Ñ€Ğ¾Ğ»ÑŒ: {ADMIN_PASSWORD}")
        print("---")

    except Exception as e:
        await db_session.rollback()
        print(f"âŒ ĞŸÑ€Ğ¾Ğ¸Ğ·Ğ¾ÑˆĞ»Ğ° Ğ¾ÑˆĞ¸Ğ±ĞºĞ°: {e}")
    finally:
        await db_session.close()
        print("ğŸ Ğ¡ĞºÑ€Ğ¸Ğ¿Ñ‚ Ğ·Ğ°Ğ²ĞµÑ€ÑˆĞ¸Ğ» Ñ€Ğ°Ğ±Ğ¾Ñ‚Ñƒ.")

if __name__ == "__main__":
    asyncio.run(create_admin_user())

```


## <a name="RentalAppFASTAPIdbinitdbpy"></a>`RentalApp_FASTAPI/db/init_db.py`

```python
// path: RentalApp_FASTAPI/db/init_db.py

# db/init_db.py
from db.orm import init_db

if __name__ == "__main__":
    init_db()
    print("Ğ‘Ğ°Ğ·Ğ° Ğ´Ğ°Ğ½Ğ½Ñ‹Ñ… ÑƒÑĞ¿ĞµÑˆĞ½Ğ¾ ÑĞ¾Ğ·Ğ´Ğ°Ğ½Ğ°!")

```


## <a name="RentalAppFASTAPImigrationsenvpy"></a>`RentalApp_FASTAPI/migrations/env.py`

```python
// path: RentalApp_FASTAPI/migrations/env.py

# migrations/env.py

import sys
import os
from logging.config import fileConfig
import asyncio

from sqlalchemy import engine_from_config, pool
from sqlalchemy.ext.asyncio import create_async_engine

from alembic import context

# 1. Ğ”Ğ¾Ğ±Ğ°Ğ²Ğ»ÑĞµĞ¼ Ğ¿ÑƒÑ‚ÑŒ Ğº ĞºĞ¾Ñ€Ğ½ĞµĞ²Ğ¾Ğ¹ Ğ¿Ğ°Ğ¿ĞºĞµ Ğ¿Ñ€Ğ¾ĞµĞºÑ‚Ğ°
sys.path.insert(0, os.path.abspath(os.path.join(os.path.dirname(__file__), '..')))

# 2. Ğ£ĞºĞ°Ğ·Ñ‹Ğ²Ğ°ĞµĞ¼ Alembic Ğ½Ğ° Ğ±Ğ°Ğ·Ğ¾Ğ²Ñ‹Ğ¹ ĞºĞ»Ğ°ÑÑ Ğ¼Ğ¾Ğ´ĞµĞ»ĞµĞ¹
from api.database import Base

# 3. Ğ˜Ğ¼Ğ¿Ğ¾Ñ€Ñ‚Ğ¸Ñ€ÑƒĞµĞ¼ Ğ’Ğ¡Ğ• ĞĞšĞ¢Ğ£ĞĞ›Ğ¬ĞĞ«Ğ• Ğ¼Ğ¾Ğ´ĞµĞ»Ğ¸
# +++ Ğ”ĞĞ‘ĞĞ’Ğ¬Ğ¢Ğ• balance_history Ğ’ Ğ­Ğ¢ĞĞ¢ Ğ¡ĞŸĞ˜Ğ¡ĞĞš +++
from api.models import user, equipment, reservation, rental, accessory, payment, promo_code, holiday, discount, association, balance_history

# 4. ĞŸĞµÑ€ĞµĞ´Ğ°ĞµĞ¼ Ğ¼ĞµÑ‚Ğ°Ğ´Ğ°Ğ½Ğ½Ñ‹Ğµ Ğ²Ğ°ÑˆĞ¸Ñ… Ğ¼Ğ¾Ğ´ĞµĞ»ĞµĞ¹ Ğ² Alembic
target_metadata = Base.metadata

# This is the Alembic Config object...
config = context.config

# Interpret the config file for Python logging.
if config.config_file_name is not None:
    fileConfig(config.config_file_name)


def run_migrations_offline() -> None:
    """Run migrations in 'offline' mode."""
    url = config.get_main_option("sqlalchemy.url")
    # ĞšĞ¾Ğ½Ğ²ĞµÑ€Ñ‚Ğ¸Ñ€ÑƒĞµĞ¼ Ğ°ÑĞ¸Ğ½Ñ…Ñ€Ğ¾Ğ½Ğ½Ñ‹Ğ¹ URL Ğ² ÑĞ¸Ğ½Ñ…Ñ€Ğ¾Ğ½Ğ½Ñ‹Ğ¹ Ğ´Ğ»Ñ offline Ñ€ĞµĞ¶Ğ¸Ğ¼Ğ°
    if url and "postgresql+asyncpg://" in url:
        url = url.replace("postgresql+asyncpg://", "postgresql://")
    
    context.configure(
        url=url,
        target_metadata=target_metadata,
        literal_binds=True,
        dialect_opts={"paramstyle": "named"},
    )
    with context.begin_transaction():
        context.run_migrations()


def do_run_migrations(connection):
    """Ğ’Ñ‹Ğ¿Ğ¾Ğ»Ğ½ÑĞµÑ‚ Ğ¼Ğ¸Ğ³Ñ€Ğ°Ñ†Ğ¸Ğ¸ Ñ Ğ¿ĞµÑ€ĞµĞ´Ğ°Ğ½Ğ½Ñ‹Ğ¼ ÑĞ¾ĞµĞ´Ğ¸Ğ½ĞµĞ½Ğ¸ĞµĞ¼."""
    context.configure(connection=connection, target_metadata=target_metadata)
    with context.begin_transaction():
        context.run_migrations()


async def run_async_migrations():
    """Ğ’Ñ‹Ğ¿Ğ¾Ğ»Ğ½ÑĞµÑ‚ Ğ¼Ğ¸Ğ³Ñ€Ğ°Ñ†Ğ¸Ğ¸ Ğ² Ğ°ÑĞ¸Ğ½Ñ…Ñ€Ğ¾Ğ½Ğ½Ğ¾Ğ¼ Ñ€ĞµĞ¶Ğ¸Ğ¼Ğµ."""
    url = config.get_main_option("sqlalchemy.url")
    if url and "postgresql+asyncpg://" in url:
        # Ğ˜ÑĞ¿Ğ¾Ğ»ÑŒĞ·ÑƒĞµĞ¼ Ğ°ÑĞ¸Ğ½Ñ…Ñ€Ğ¾Ğ½Ğ½Ñ‹Ğ¹ Ğ´Ğ²Ğ¸Ğ¶Ğ¾Ğº
        connectable = create_async_engine(url)
        async with connectable.connect() as connection:
            await connection.run_sync(do_run_migrations)
    else:
        # Fallback Ğº ÑĞ¸Ğ½Ñ…Ñ€Ğ¾Ğ½Ğ½Ğ¾Ğ¼Ñƒ Ñ€ĞµĞ¶Ğ¸Ğ¼Ñƒ
        connectable = engine_from_config(
            config.get_section(config.config_ini_section, {}),
            prefix="sqlalchemy.",
            poolclass=pool.NullPool,
        )
        with connectable.connect() as connection:
            do_run_migrations(connection)


def run_migrations_online() -> None:
    """Run migrations in 'online' mode."""
    url = config.get_main_option("sqlalchemy.url")
    if url and "postgresql+asyncpg://" in url:
        # Ğ—Ğ°Ğ¿ÑƒÑĞºĞ°ĞµĞ¼ Ğ°ÑĞ¸Ğ½Ñ…Ñ€Ğ¾Ğ½Ğ½Ñ‹Ğµ Ğ¼Ğ¸Ğ³Ñ€Ğ°Ñ†Ğ¸Ğ¸
        asyncio.run(run_async_migrations())
    else:
        # Fallback Ğº ÑĞ¸Ğ½Ñ…Ñ€Ğ¾Ğ½Ğ½Ğ¾Ğ¼Ñƒ Ñ€ĞµĞ¶Ğ¸Ğ¼Ñƒ
        connectable = engine_from_config(
            config.get_section(config.config_ini_section, {}),
            prefix="sqlalchemy.",
            poolclass=pool.NullPool,
        )
        with connectable.connect() as connection:
            do_run_migrations(connection)


if context.is_offline_mode():
    run_migrations_offline()
else:
    run_migrations_online()

```


## <a name="RentalAppFASTAPImigrationsversions9290ae79b0d3createinitialtablespy"></a>`RentalApp_FASTAPI/migrations/versions/9290ae79b0d3_create_initial_tables.py`

```python
// path: RentalApp_FASTAPI/migrations/versions/9290ae79b0d3_create_initial_tables.py

"""Create initial tables

Revision ID: 9290ae79b0d3
Revises: 
Create Date: 2025-09-13 15:05:27.964374

"""
from typing import Sequence, Union

from alembic import op
import sqlalchemy as sa


# revision identifiers, used by Alembic.
revision: str = '9290ae79b0d3'
down_revision: Union[str, None] = None
branch_labels: Union[str, Sequence[str], None] = None
depends_on: Union[str, Sequence[str], None] = None


def upgrade() -> None:
    """Upgrade schema."""
    # ### commands auto generated by Alembic - please adjust! ###
    op.create_table('accessories',
    sa.Column('id', sa.Integer(), nullable=False),
    sa.Column('name', sa.String(), nullable=False),
    sa.Column('accessory_type', sa.String(), nullable=True),
    sa.Column('price', sa.Float(), nullable=True),
    sa.Column('description', sa.Text(), nullable=True),
    sa.PrimaryKeyConstraint('id')
    )
    op.create_index(op.f('ix_accessories_accessory_type'), 'accessories', ['accessory_type'], unique=False)
    op.create_index(op.f('ix_accessories_id'), 'accessories', ['id'], unique=False)
    op.create_index(op.f('ix_accessories_name'), 'accessories', ['name'], unique=False)
    op.create_table('associations',
    sa.Column('id', sa.Integer(), nullable=False),
    sa.Column('name', sa.String(), nullable=False),
    sa.Column('description', sa.Text(), nullable=True),
    sa.Column('sort_order', sa.Integer(), nullable=False),
    sa.PrimaryKeyConstraint('id')
    )
    op.create_index(op.f('ix_associations_id'), 'associations', ['id'], unique=False)
    op.create_index(op.f('ix_associations_name'), 'associations', ['name'], unique=True)
    op.create_table('duration_discounts',
    sa.Column('id', sa.Integer(), nullable=False),
    sa.Column('min_days', sa.Integer(), nullable=False, comment='ĞœĞ¸Ğ½Ğ¸Ğ¼Ğ°Ğ»ÑŒĞ½Ğ¾Ğµ ĞºĞ¾Ğ»Ğ¸Ñ‡ĞµÑÑ‚Ğ²Ğ¾ Ğ´Ğ½ĞµĞ¹ Ğ´Ğ»Ñ ÑĞºĞ¸Ğ´ĞºĞ¸ (Ğ²ĞºĞ»ÑÑ‡Ğ¸Ñ‚ĞµĞ»ÑŒĞ½Ğ¾)'),
    sa.Column('discount_percentage', sa.Integer(), nullable=False, comment='ĞŸÑ€Ğ¾Ñ†ĞµĞ½Ñ‚ ÑĞºĞ¸Ğ´ĞºĞ¸'),
    sa.PrimaryKeyConstraint('id'),
    sa.UniqueConstraint('min_days')
    )
    op.create_table('equipment',
    sa.Column('id', sa.Integer(), nullable=False),
    sa.Column('equipment_type', sa.String(), nullable=False),
    sa.Column('brand', sa.String(), nullable=False),
    sa.Column('name', sa.String(), nullable=False),
    sa.Column('serial_number', sa.String(), nullable=True),
    sa.Column('condition', sa.String(), nullable=True),
    sa.Column('daily_rate', sa.Float(), nullable=True),
    sa.Column('notes', sa.String(), nullable=True),
    sa.Column('last_maintenance', sa.Date(), nullable=True),
    sa.Column('description', sa.Text(), nullable=True),
    sa.Column('image_url', sa.String(), nullable=True),
    sa.Column('image_urls', sa.JSON(), nullable=True),
    sa.Column('short_description', sa.String(), nullable=True),
    sa.PrimaryKeyConstraint('id'),
    sa.UniqueConstraint('serial_number')
    )
    op.create_table('users',
    sa.Column('id', sa.Integer(), nullable=False),
    sa.Column('full_name', sa.String(), nullable=False),
    sa.Column('email', sa.String(), nullable=False),
    sa.Column('hashed_password', sa.String(), nullable=True),
    sa.Column('role', sa.String(), nullable=True),
    sa.Column('created_at', sa.DateTime(timezone=True), nullable=True),
    sa.Column('is_active', sa.Boolean(), nullable=True),
    sa.Column('phone', sa.String(), nullable=True),
    sa.Column('status', sa.String(), nullable=True),
    sa.Column('balance', sa.Float(), nullable=True),
    sa.Column('notes', sa.Text(), nullable=True),
    sa.Column('privacy_policy_accepted', sa.Boolean(), nullable=True),
    sa.Column('terms_accepted', sa.Boolean(), nullable=True),
    sa.Column('email_verified', sa.Boolean(), nullable=True),
    sa.PrimaryKeyConstraint('id')
    )
    op.create_index(op.f('ix_users_email'), 'users', ['email'], unique=True)
    op.create_table('association_equipment_association',
    sa.Column('association_id', sa.Integer(), nullable=False),
    sa.Column('equipment_id', sa.Integer(), nullable=False),
    sa.ForeignKeyConstraint(['association_id'], ['associations.id'], ),
    sa.ForeignKeyConstraint(['equipment_id'], ['equipment.id'], ),
    sa.PrimaryKeyConstraint('association_id', 'equipment_id')
    )
    op.create_table('equipment_accessories',
    sa.Column('equipment_id', sa.Integer(), nullable=False),
    sa.Column('accessory_id', sa.Integer(), nullable=False),
    sa.ForeignKeyConstraint(['accessory_id'], ['accessories.id'], ),
    sa.ForeignKeyConstraint(['equipment_id'], ['equipment.id'], ),
    sa.PrimaryKeyConstraint('equipment_id', 'accessory_id')
    )
    op.create_table('holiday_rules',
    sa.Column('id', sa.Integer(), nullable=False),
    sa.Column('rule_type', sa.String(), nullable=False, comment="Ğ¢Ğ¸Ğ¿ Ğ¿Ñ€Ğ°Ğ²Ğ¸Ğ»Ğ°, Ğ½Ğ°Ğ¿Ñ€Ğ¸Ğ¼ĞµÑ€ 'weekly' Ğ¸Ğ»Ğ¸ 'public_import'"),
    sa.Column('parameters', sa.JSON(), nullable=False, comment="ĞŸĞ°Ñ€Ğ°Ğ¼ĞµÑ‚Ñ€Ñ‹ Ğ¿Ñ€Ğ°Ğ²Ğ¸Ğ»Ğ°, Ğ½Ğ°Ğ¿Ñ€Ğ¸Ğ¼ĞµÑ€ {'day_of_week': 6} Ğ´Ğ»Ñ Ğ²Ğ¾ÑĞºÑ€ĞµÑĞµĞ½ÑŒÑ"),
    sa.Column('description', sa.String(), nullable=False, comment='ĞĞ¿Ğ¸ÑĞ°Ğ½Ğ¸Ğµ Ğ¿Ñ€Ğ°Ğ²Ğ¸Ğ»Ğ° Ğ´Ğ»Ñ Ğ°Ğ´Ğ¼Ğ¸Ğ½Ğ°'),
    sa.Column('created_at', sa.DateTime(timezone=True), nullable=True),
    sa.Column('created_by_id', sa.Integer(), nullable=False),
    sa.ForeignKeyConstraint(['created_by_id'], ['users.id'], ),
    sa.PrimaryKeyConstraint('id')
    )
    op.create_table('promo_codes',
    sa.Column('id', sa.Integer(), nullable=False),
    sa.Column('code', sa.String(), nullable=False),
    sa.Column('description', sa.Text(), nullable=True, comment='ĞšÑ€Ğ°Ñ‚ĞºĞ¾Ğµ Ğ¾Ğ¿Ğ¸ÑĞ°Ğ½Ğ¸Ğµ Ğ´Ğ»Ñ Ğ¼ĞµĞ½ĞµĞ´Ğ¶ĞµÑ€Ğ¾Ğ²'),
    sa.Column('discount_percentage', sa.Float(), nullable=False),
    sa.Column('is_active', sa.Boolean(), nullable=True),
    sa.Column('valid_from', sa.DateTime(timezone=True), nullable=True, comment='Ğ”Ğ°Ñ‚Ğ° Ğ½Ğ°Ñ‡Ğ°Ğ»Ğ° Ğ´ĞµĞ¹ÑÑ‚Ğ²Ğ¸Ñ'),
    sa.Column('expires_at', sa.DateTime(timezone=True), nullable=True, comment='Ğ”Ğ°Ñ‚Ğ° Ğ¸ÑÑ‚ĞµÑ‡ĞµĞ½Ğ¸Ñ ÑÑ€Ğ¾ĞºĞ°'),
    sa.Column('max_uses', sa.Integer(), nullable=True, comment='ĞĞ±Ñ‰Ğ¸Ğ¹ Ğ»Ğ¸Ğ¼Ğ¸Ñ‚ Ğ¸ÑĞ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğ¹'),
    sa.Column('times_used', sa.Integer(), nullable=False),
    sa.Column('max_uses_per_user', sa.Integer(), nullable=True, comment='Ğ›Ğ¸Ğ¼Ğ¸Ñ‚ Ğ½Ğ° Ğ¾Ğ´Ğ½Ğ¾Ğ³Ğ¾ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ñ'),
    sa.Column('min_order_amount', sa.Float(), nullable=True, comment='ĞœĞ¸Ğ½Ğ¸Ğ¼Ğ°Ğ»ÑŒĞ½Ğ°Ñ ÑÑƒĞ¼Ğ¼Ğ° Ğ·Ğ°ĞºĞ°Ğ·Ğ° Ğ´Ğ»Ñ Ğ°ĞºÑ‚Ğ¸Ğ²Ğ°Ñ†Ğ¸Ğ¸'),
    sa.Column('specific_to_user_id', sa.Integer(), nullable=True, comment='Ğ•ÑĞ»Ğ¸ ĞºĞ¾Ğ´ Ğ¿ĞµÑ€ÑĞ¾Ğ½Ğ°Ğ»ÑŒĞ½Ñ‹Ğ¹'),
    sa.Column('created_at', sa.DateTime(timezone=True), nullable=True),
    sa.Column('created_by_id', sa.Integer(), nullable=True),
    sa.ForeignKeyConstraint(['created_by_id'], ['users.id'], ),
    sa.ForeignKeyConstraint(['specific_to_user_id'], ['users.id'], ),
    sa.PrimaryKeyConstraint('id')
    )
    op.create_index(op.f('ix_promo_codes_code'), 'promo_codes', ['code'], unique=True)
    op.create_index(op.f('ix_promo_codes_id'), 'promo_codes', ['id'], unique=False)
    op.create_table('holidays',
    sa.Column('date', sa.Date(), nullable=False, comment='Ğ”Ğ°Ñ‚Ğ° Ğ²Ñ‹Ñ…Ğ¾Ğ´Ğ½Ğ¾Ğ³Ğ¾ Ğ´Ğ½Ñ'),
    sa.Column('description', sa.String(), nullable=True, comment='ĞĞ°Ğ·Ğ²Ğ°Ğ½Ğ¸Ğµ (Ğ½Ğ°Ğ¿Ñ€Ğ¸Ğ¼ĞµÑ€, ĞĞ¾Ğ²Ñ‹Ğ¹ Ğ³Ğ¾Ğ´)'),
    sa.Column('created_at', sa.DateTime(timezone=True), nullable=True),
    sa.Column('created_by_id', sa.Integer(), nullable=False),
    sa.Column('rule_id', sa.Integer(), nullable=True, comment='ID Ğ¿Ñ€Ğ°Ğ²Ğ¸Ğ»Ğ°, ĞºĞ¾Ñ‚Ğ¾Ñ€Ñ‹Ğ¼ ÑĞ¾Ğ·Ğ´Ğ°Ğ½ ÑÑ‚Ğ¾Ñ‚ Ğ²Ñ‹Ñ…Ğ¾Ğ´Ğ½Ğ¾Ğ¹'),
    sa.ForeignKeyConstraint(['created_by_id'], ['users.id'], ),
    sa.ForeignKeyConstraint(['rule_id'], ['holiday_rules.id'], ),
    sa.PrimaryKeyConstraint('date')
    )
    op.create_index(op.f('ix_holidays_date'), 'holidays', ['date'], unique=False)
    op.create_table('promo_code_applicable_types',
    sa.Column('promo_code_id', sa.Integer(), nullable=False),
    sa.Column('type_name', sa.String(), nullable=False),
    sa.ForeignKeyConstraint(['promo_code_id'], ['promo_codes.id'], ),
    sa.PrimaryKeyConstraint('promo_code_id', 'type_name')
    )
    op.create_table('promo_code_equipment',
    sa.Column('promo_code_id', sa.Integer(), nullable=False),
    sa.Column('equipment_id', sa.Integer(), nullable=False),
    sa.ForeignKeyConstraint(['equipment_id'], ['equipment.id'], ),
    sa.ForeignKeyConstraint(['promo_code_id'], ['promo_codes.id'], ),
    sa.PrimaryKeyConstraint('promo_code_id', 'equipment_id')
    )
    op.create_table('promo_code_usages',
    sa.Column('user_id', sa.Integer(), nullable=False),
    sa.Column('promo_code_id', sa.Integer(), nullable=False),
    sa.Column('used_at', sa.DateTime(timezone=True), nullable=True),
    sa.ForeignKeyConstraint(['promo_code_id'], ['promo_codes.id'], ),
    sa.ForeignKeyConstraint(['user_id'], ['users.id'], ),
    sa.PrimaryKeyConstraint('user_id', 'promo_code_id')
    )
    op.create_table('reservations',
    sa.Column('id', sa.Integer(), nullable=False),
    sa.Column('user_id', sa.Integer(), nullable=False),
    sa.Column('start_date', sa.Date(), nullable=False),
    sa.Column('end_date', sa.Date(), nullable=False),
    sa.Column('status', sa.String(), nullable=False),
    sa.Column('promo_code_id', sa.Integer(), nullable=True),
    sa.Column('total_cost', sa.Float(), nullable=False),
    sa.Column('discount_amount', sa.Float(), nullable=False),
    sa.Column('created_at', sa.DateTime(timezone=True), nullable=True),
    sa.ForeignKeyConstraint(['promo_code_id'], ['promo_codes.id'], ),
    sa.ForeignKeyConstraint(['user_id'], ['users.id'], ),
    sa.PrimaryKeyConstraint('id')
    )
    op.create_index(op.f('ix_reservations_status'), 'reservations', ['status'], unique=False)
    op.create_table('rentals',
    sa.Column('id', sa.Integer(), nullable=False),
    sa.Column('user_id', sa.Integer(), nullable=False),
    sa.Column('created_by_id', sa.Integer(), nullable=False),
    sa.Column('reservation_id', sa.Integer(), nullable=True),
    sa.Column('start_date', sa.Date(), nullable=False),
    sa.Column('end_date', sa.Date(), nullable=False),
    sa.Column('actual_return_date', sa.Date(), nullable=True),
    sa.Column('status', sa.String(), nullable=False),
    sa.Column('total_cost', sa.Float(), nullable=False),
    sa.Column('discount_amount', sa.Float(), nullable=False),
    sa.Column('promo_code', sa.String(), nullable=True),
    sa.Column('final_cost', sa.Float(), nullable=True),
    sa.Column('deposit_amount', sa.Float(), nullable=True),
    sa.Column('prepayment_amount', sa.Float(), nullable=False),
    sa.Column('notes_on_issue', sa.Text(), nullable=True),
    sa.Column('notes_on_return', sa.Text(), nullable=True),
    sa.Column('created_at', sa.DateTime(timezone=True), nullable=True),
    sa.Column('updated_at', sa.DateTime(timezone=True), nullable=True),
    sa.ForeignKeyConstraint(['created_by_id'], ['users.id'], ),
    sa.ForeignKeyConstraint(['reservation_id'], ['reservations.id'], ),
    sa.ForeignKeyConstraint(['user_id'], ['users.id'], ),
    sa.PrimaryKeyConstraint('id'),
    sa.UniqueConstraint('reservation_id')
    )
    op.create_index(op.f('ix_rentals_status'), 'rentals', ['status'], unique=False)
    op.create_table('reservation_accessories',
    sa.Column('reservation_id', sa.Integer(), nullable=False),
    sa.Column('equipment_id', sa.Integer(), nullable=False),
    sa.Column('accessory_id', sa.Integer(), nullable=False),
    sa.ForeignKeyConstraint(['accessory_id'], ['accessories.id'], ),
    sa.ForeignKeyConstraint(['equipment_id'], ['equipment.id'], ),
    sa.ForeignKeyConstraint(['reservation_id'], ['reservations.id'], ),
    sa.PrimaryKeyConstraint('reservation_id', 'equipment_id', 'accessory_id')
    )
    op.create_table('reservation_equipment',
    sa.Column('reservation_id', sa.Integer(), nullable=False),
    sa.Column('equipment_id', sa.Integer(), nullable=False),
    sa.ForeignKeyConstraint(['equipment_id'], ['equipment.id'], ),
    sa.ForeignKeyConstraint(['reservation_id'], ['reservations.id'], ),
    sa.PrimaryKeyConstraint('reservation_id', 'equipment_id')
    )
    op.create_table('balance_history',
    sa.Column('id', sa.Integer(), nullable=False),
    sa.Column('user_id', sa.Integer(), nullable=False),
    sa.Column('rental_id', sa.Integer(), nullable=True),
    sa.Column('amount', sa.Float(), nullable=False, comment='Ğ¡ÑƒĞ¼Ğ¼Ğ° Ğ¾Ğ¿ĞµÑ€Ğ°Ñ†Ğ¸Ğ¸. ĞÑ‚Ñ€Ğ¸Ñ†Ğ°Ñ‚ĞµĞ»ÑŒĞ½Ğ°Ñ Ğ´Ğ»Ñ ÑĞ¿Ğ¸ÑĞ°Ğ½Ğ¸Ñ, Ğ¿Ğ¾Ğ»Ğ¾Ğ¶Ğ¸Ñ‚ĞµĞ»ÑŒĞ½Ğ°Ñ Ğ´Ğ»Ñ Ğ½Ğ°Ñ‡Ğ¸ÑĞ»ĞµĞ½Ğ¸Ñ.'),
    sa.Column('operation_type', sa.String(), nullable=False, comment='Ğ¢Ğ¸Ğ¿ Ğ¾Ğ¿ĞµÑ€Ğ°Ñ†Ğ¸Ğ¸ (e.g., rental_debit, early_return_credit)'),
    sa.Column('description', sa.Text(), nullable=True, comment='ĞĞ¿Ğ¸ÑĞ°Ğ½Ğ¸Ğµ Ğ¾Ğ¿ĞµÑ€Ğ°Ñ†Ğ¸Ğ¸'),
    sa.Column('created_at', sa.DateTime(timezone=True), nullable=True),
    sa.ForeignKeyConstraint(['rental_id'], ['rentals.id'], ondelete='CASCADE'),
    sa.ForeignKeyConstraint(['user_id'], ['users.id'], ),
    sa.PrimaryKeyConstraint('id')
    )
    op.create_table('payments',
    sa.Column('id', sa.Integer(), nullable=False),
    sa.Column('user_id', sa.Integer(), nullable=False),
    sa.Column('rental_id', sa.Integer(), nullable=True),
    sa.Column('amount', sa.Float(), nullable=False),
    sa.Column('payment_date', sa.DateTime(timezone=True), nullable=True),
    sa.Column('payment_method', sa.String(), nullable=True),
    sa.Column('transaction_type', sa.String(), nullable=False),
    sa.Column('description', sa.Text(), nullable=True),
    sa.ForeignKeyConstraint(['rental_id'], ['rentals.id'], ondelete='CASCADE'),
    sa.ForeignKeyConstraint(['user_id'], ['users.id'], ),
    sa.PrimaryKeyConstraint('id')
    )
    op.create_table('rental_accessories',
    sa.Column('rental_id', sa.Integer(), nullable=False),
    sa.Column('equipment_id', sa.Integer(), nullable=False),
    sa.Column('accessory_id', sa.Integer(), nullable=False),
    sa.ForeignKeyConstraint(['accessory_id'], ['accessories.id'], ),
    sa.ForeignKeyConstraint(['equipment_id'], ['equipment.id'], ),
    sa.ForeignKeyConstraint(['rental_id'], ['rentals.id'], ondelete='CASCADE'),
    sa.PrimaryKeyConstraint('rental_id', 'equipment_id', 'accessory_id')
    )
    op.create_table('rental_equipment',
    sa.Column('rental_id', sa.Integer(), nullable=False),
    sa.Column('equipment_id', sa.Integer(), nullable=False),
    sa.ForeignKeyConstraint(['equipment_id'], ['equipment.id'], ),
    sa.ForeignKeyConstraint(['rental_id'], ['rentals.id'], ondelete='CASCADE'),
    sa.PrimaryKeyConstraint('rental_id', 'equipment_id')
    )
    # ### end Alembic commands ###


def downgrade() -> None:
    """Downgrade schema."""
    # ### commands auto generated by Alembic - please adjust! ###
    op.drop_table('rental_equipment')
    op.drop_table('rental_accessories')
    op.drop_table('payments')
    op.drop_table('balance_history')
    op.drop_table('reservation_equipment')
    op.drop_table('reservation_accessories')
    op.drop_index(op.f('ix_rentals_status'), table_name='rentals')
    op.drop_table('rentals')
    op.drop_index(op.f('ix_reservations_status'), table_name='reservations')
    op.drop_table('reservations')
    op.drop_table('promo_code_usages')
    op.drop_table('promo_code_equipment')
    op.drop_table('promo_code_applicable_types')
    op.drop_index(op.f('ix_holidays_date'), table_name='holidays')
    op.drop_table('holidays')
    op.drop_index(op.f('ix_promo_codes_id'), table_name='promo_codes')
    op.drop_index(op.f('ix_promo_codes_code'), table_name='promo_codes')
    op.drop_table('promo_codes')
    op.drop_table('holiday_rules')
    op.drop_table('equipment_accessories')
    op.drop_table('association_equipment_association')
    op.drop_index(op.f('ix_users_email'), table_name='users')
    op.drop_table('users')
    op.drop_table('equipment')
    op.drop_table('duration_discounts')
    op.drop_index(op.f('ix_associations_name'), table_name='associations')
    op.drop_index(op.f('ix_associations_id'), table_name='associations')
    op.drop_table('associations')
    op.drop_index(op.f('ix_accessories_name'), table_name='accessories')
    op.drop_index(op.f('ix_accessories_id'), table_name='accessories')
    op.drop_index(op.f('ix_accessories_accessory_type'), table_name='accessories')
    op.drop_table('accessories')
    # ### end Alembic commands ###


```


## <a name="RentalAppFASTAPIscriptspopulateassociationspy"></a>`RentalApp_FASTAPI/scripts/populate_associations.py`

```python
// path: RentalApp_FASTAPI/scripts/populate_associations.py

#!/usr/bin/env python3
# -*- coding: utf-8 -*-
"""
Ğ¡ĞºÑ€Ğ¸Ğ¿Ñ‚ Ğ´Ğ»Ñ Ğ´Ğ¾Ğ±Ğ°Ğ²Ğ»ĞµĞ½Ğ¸Ñ Ğ½Ğ°Ñ‡Ğ°Ğ»ÑŒĞ½Ñ‹Ñ… Ğ°ÑÑĞ¾Ñ†Ğ¸Ğ°Ñ†Ğ¸Ğ¹ Ğ² Ğ±Ğ°Ğ·Ñƒ Ğ´Ğ°Ğ½Ğ½Ñ‹Ñ….
Ğ—Ğ°Ğ¿ÑƒÑĞºĞ°Ñ‚ÑŒ Ğ¿Ğ¾ÑĞ»Ğµ Ğ¿Ñ€Ğ¸Ğ¼ĞµĞ½ĞµĞ½Ğ¸Ñ Ğ¼Ğ¸Ğ³Ñ€Ğ°Ñ†Ğ¸Ğ¹.
"""

import sys
import os

# Ğ”Ğ¾Ğ±Ğ°Ğ²Ğ»ÑĞµĞ¼ ĞºĞ¾Ñ€Ğ½ĞµĞ²ÑƒÑ Ğ´Ğ¸Ñ€ĞµĞºÑ‚Ğ¾Ñ€Ğ¸Ñ Ğ¿Ñ€Ğ¾ĞµĞºÑ‚Ğ° Ğ² Ğ¿ÑƒÑ‚ÑŒ
sys.path.append(os.path.dirname(os.path.dirname(os.path.abspath(__file__))))

from sqlalchemy.orm import Session
from api.deps import get_db
from api.models.association import Association
from api.models.equipment import Equipment

def populate_associations():
    """Ğ”Ğ¾Ğ±Ğ°Ğ²Ğ»ÑĞµÑ‚ Ğ½Ğ°Ñ‡Ğ°Ğ»ÑŒĞ½Ñ‹Ğµ Ğ°ÑÑĞ¾Ñ†Ğ¸Ğ°Ñ†Ğ¸Ğ¸ Ğ² Ğ±Ğ°Ğ·Ñƒ Ğ´Ğ°Ğ½Ğ½Ñ‹Ñ…."""
    
    # ĞŸĞ¾Ğ»ÑƒÑ‡Ğ°ĞµĞ¼ ÑĞµÑÑĞ¸Ñ Ğ±Ğ°Ğ·Ñ‹ Ğ´Ğ°Ğ½Ğ½Ñ‹Ñ…
    db: Session = next(get_db())
    
    try:
        # ĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑĞµĞ¼, ĞµÑÑ‚ÑŒ Ğ»Ğ¸ ÑƒĞ¶Ğµ Ğ°ÑÑĞ¾Ñ†Ğ¸Ğ°Ñ†Ğ¸Ğ¸
        existing_associations = db.query(Association).count()
        if existing_associations > 0:
            print("ĞÑÑĞ¾Ñ†Ğ¸Ğ°Ñ†Ğ¸Ğ¸ ÑƒĞ¶Ğµ ÑÑƒÑ‰ĞµÑÑ‚Ğ²ÑƒÑÑ‚ Ğ² Ğ±Ğ°Ğ·Ğµ Ğ´Ğ°Ğ½Ğ½Ñ‹Ñ…. ĞŸÑ€Ğ¾Ğ¿ÑƒÑĞºĞ°ĞµĞ¼ ÑĞ¾Ğ·Ğ´Ğ°Ğ½Ğ¸Ğµ.")
            return
        
        # Ğ¡Ğ¾Ğ·Ğ´Ğ°ĞµĞ¼ Ğ½Ğ°Ñ‡Ğ°Ğ»ÑŒĞ½Ñ‹Ğµ Ğ°ÑÑĞ¾Ñ†Ğ¸Ğ°Ñ†Ğ¸Ğ¸
        associations_data = [
            {
                "name": "Ğ’ÑĞµ Ğ´Ğ»Ñ Sony",
                "description": "ĞĞ±Ğ¾Ñ€ÑƒĞ´Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ Ğ¸ Ğ°ĞºÑĞµÑÑÑƒĞ°Ñ€Ñ‹ Ğ´Ğ»Ñ ĞºĞ°Ğ¼ĞµÑ€ Sony",
                "order_index": 1
            },
            {
                "name": "Ğ’ÑĞµ Ğ´Ğ»Ñ Fujifilm", 
                "description": "ĞĞ±Ğ¾Ñ€ÑƒĞ´Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ Ğ¸ Ğ°ĞºÑĞµÑÑÑƒĞ°Ñ€Ñ‹ Ğ´Ğ»Ñ ĞºĞ°Ğ¼ĞµÑ€ Fujifilm",
                "order_index": 2
            },
            {
                "name": "Ğ”Ğ»Ñ ÑÑŠĞµĞ¼ĞºĞ¸ Ğ²Ğ¸Ğ´ĞµĞ¾",
                "description": "ĞĞ±Ğ¾Ñ€ÑƒĞ´Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ Ğ´Ğ»Ñ Ğ²Ğ¸Ğ´ĞµĞ¾ÑÑŠĞµĞ¼ĞºĞ¸",
                "order_index": 3
            },
            {
                "name": "Ğ”Ğ»Ñ Ñ„Ğ¾Ñ‚Ğ¾Ğ³Ñ€Ğ°Ñ„Ğ¸Ğ¸",
                "description": "ĞĞ±Ğ¾Ñ€ÑƒĞ´Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ Ğ´Ğ»Ñ Ñ„Ğ¾Ñ‚Ğ¾ÑÑŠĞµĞ¼ĞºĞ¸",
                "order_index": 4
            },
            {
                "name": "Ğ¡Ñ‚ÑƒĞ´Ğ¸Ğ¹Ğ½Ğ¾Ğµ Ğ¾Ğ±Ğ¾Ñ€ÑƒĞ´Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ",
                "description": "ĞĞ±Ğ¾Ñ€ÑƒĞ´Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ Ğ´Ğ»Ñ ÑÑ‚ÑƒĞ´Ğ¸Ğ¹Ğ½Ğ¾Ğ¹ ÑÑŠĞµĞ¼ĞºĞ¸",
                "order_index": 5
            },
            {
                "name": "ĞŸĞ¾Ñ€Ñ‚Ğ°Ñ‚Ğ¸Ğ²Ğ½Ğ¾Ğµ Ğ¾Ğ±Ğ¾Ñ€ÑƒĞ´Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ",
                "description": "Ğ›ĞµĞ³ĞºĞ¾Ğµ Ğ¸ Ğ¿Ğ¾Ñ€Ñ‚Ğ°Ñ‚Ğ¸Ğ²Ğ½Ğ¾Ğµ Ğ¾Ğ±Ğ¾Ñ€ÑƒĞ´Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ",
                "order_index": 6
            }
        ]
        
        # Ğ¡Ğ¾Ğ·Ğ´Ğ°ĞµĞ¼ Ğ°ÑÑĞ¾Ñ†Ğ¸Ğ°Ñ†Ğ¸Ğ¸
        for assoc_data in associations_data:
            association = Association(**assoc_data)
            db.add(association)
        
        # Ğ¡Ğ¾Ñ…Ñ€Ğ°Ğ½ÑĞµĞ¼ Ğ¸Ğ·Ğ¼ĞµĞ½ĞµĞ½Ğ¸Ñ
        db.commit()
        
        print(f"Ğ£ÑĞ¿ĞµÑˆĞ½Ğ¾ ÑĞ¾Ğ·Ğ´Ğ°Ğ½Ğ¾ {len(associations_data)} Ğ°ÑÑĞ¾Ñ†Ğ¸Ğ°Ñ†Ğ¸Ğ¹:")
        for assoc_data in associations_data:
            print(f"  - {assoc_data['name']}")
        
        # ĞŸĞ¾ĞºĞ°Ğ·Ñ‹Ğ²Ğ°ĞµĞ¼ ÑĞ¾Ğ·Ğ´Ğ°Ğ½Ğ½Ñ‹Ğµ Ğ°ÑÑĞ¾Ñ†Ğ¸Ğ°Ñ†Ğ¸Ğ¸
        print("\nĞ¡Ğ¾Ğ·Ğ´Ğ°Ğ½Ğ½Ñ‹Ğµ Ğ°ÑÑĞ¾Ñ†Ğ¸Ğ°Ñ†Ğ¸Ğ¸:")
        associations = db.query(Association).order_by(Association.order_index).all()
        for assoc in associations:
            print(f"  ID: {assoc.id}, ĞĞ°Ğ·Ğ²Ğ°Ğ½Ğ¸Ğµ: {assoc.name}, ĞŸĞ¾Ñ€ÑĞ´Ğ¾Ğº: {assoc.order_index}")
            
    except Exception as e:
        print(f"ĞÑˆĞ¸Ğ±ĞºĞ° Ğ¿Ñ€Ğ¸ ÑĞ¾Ğ·Ğ´Ğ°Ğ½Ğ¸Ğ¸ Ğ°ÑÑĞ¾Ñ†Ğ¸Ğ°Ñ†Ğ¸Ğ¹: {e}")
        db.rollback()
        raise
    finally:
        db.close()

def link_equipment_to_associations():
    """Ğ¡Ğ²ÑĞ·Ñ‹Ğ²Ğ°ĞµÑ‚ ÑÑƒÑ‰ĞµÑÑ‚Ğ²ÑƒÑÑ‰ĞµĞµ Ğ¾Ğ±Ğ¾Ñ€ÑƒĞ´Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ Ñ Ğ°ÑÑĞ¾Ñ†Ğ¸Ğ°Ñ†Ğ¸ÑĞ¼Ğ¸ Ğ¿Ğ¾ Ğ±Ñ€ĞµĞ½Ğ´Ñƒ."""
    
    db: Session = next(get_db())
    
    try:
        # ĞŸĞ¾Ğ»ÑƒÑ‡Ğ°ĞµĞ¼ Ğ²ÑĞµ Ğ°ÑÑĞ¾Ñ†Ğ¸Ğ°Ñ†Ğ¸Ğ¸
        associations = db.query(Association).all()
        associations_dict = {assoc.name: assoc for assoc in associations}
        
        # ĞŸĞ¾Ğ»ÑƒÑ‡Ğ°ĞµĞ¼ Ğ²ÑĞµ Ğ¾Ğ±Ğ¾Ñ€ÑƒĞ´Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ
        equipment = db.query(Equipment).all()
        
        linked_count = 0
        
        for eq in equipment:
            # Ğ¡Ğ²ÑĞ·Ñ‹Ğ²Ğ°ĞµĞ¼ Ğ¾Ğ±Ğ¾Ñ€ÑƒĞ´Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ Ñ Ğ°ÑÑĞ¾Ñ†Ğ¸Ğ°Ñ†Ğ¸ÑĞ¼Ğ¸ Ğ¿Ğ¾ Ğ±Ñ€ĞµĞ½Ğ´Ñƒ
            if eq.brand.lower() == "sony" and "Ğ’ÑĞµ Ğ´Ğ»Ñ Sony" in associations_dict:
                associations_dict["Ğ’ÑĞµ Ğ´Ğ»Ñ Sony"].equipment_items.append(eq)
                linked_count += 1
            elif eq.brand.lower() == "fujifilm" and "Ğ’ÑĞµ Ğ´Ğ»Ñ Fujifilm" in associations_dict:
                associations_dict["Ğ’ÑĞµ Ğ´Ğ»Ñ Fujifilm"].equipment_items.append(eq)
                linked_count += 1
            
            # Ğ¡Ğ²ÑĞ·Ñ‹Ğ²Ğ°ĞµĞ¼ Ğ¿Ğ¾ Ñ‚Ğ¸Ğ¿Ñƒ Ğ¾Ğ±Ğ¾Ñ€ÑƒĞ´Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ
            if "Ğ²Ğ¸Ğ´ĞµĞ¾" in eq.equipment_type.lower() or "Ğ²Ğ¸Ğ´ĞµĞ¾" in eq.name.lower():
                if "Ğ”Ğ»Ñ ÑÑŠĞµĞ¼ĞºĞ¸ Ğ²Ğ¸Ğ´ĞµĞ¾" in associations_dict:
                    associations_dict["Ğ”Ğ»Ñ ÑÑŠĞµĞ¼ĞºĞ¸ Ğ²Ğ¸Ğ´ĞµĞ¾"].equipment_items.append(eq)
                    linked_count += 1
            
            if "Ñ„Ğ¾Ñ‚Ğ¾" in eq.equipment_type.lower() or "Ñ„Ğ¾Ñ‚Ğ¾" in eq.name.lower():
                if "Ğ”Ğ»Ñ Ñ„Ğ¾Ñ‚Ğ¾Ğ³Ñ€Ğ°Ñ„Ğ¸Ğ¸" in associations_dict:
                    associations_dict["Ğ”Ğ»Ñ Ñ„Ğ¾Ñ‚Ğ¾Ğ³Ñ€Ğ°Ñ„Ğ¸Ğ¸"].equipment_items.append(eq)
                    linked_count += 1
        
        db.commit()
        print(f"Ğ¡Ğ²ÑĞ·Ğ°Ğ½Ğ¾ {linked_count} ĞµĞ´Ğ¸Ğ½Ğ¸Ñ† Ğ¾Ğ±Ğ¾Ñ€ÑƒĞ´Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ Ñ Ğ°ÑÑĞ¾Ñ†Ğ¸Ğ°Ñ†Ğ¸ÑĞ¼Ğ¸")
        
    except Exception as e:
        print(f"ĞÑˆĞ¸Ğ±ĞºĞ° Ğ¿Ñ€Ğ¸ ÑĞ²ÑĞ·Ñ‹Ğ²Ğ°Ğ½Ğ¸Ğ¸ Ğ¾Ğ±Ğ¾Ñ€ÑƒĞ´Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ: {e}")
        db.rollback()
        raise
    finally:
        db.close()

if __name__ == "__main__":
    print("Ğ¡Ğ¾Ğ·Ğ´Ğ°Ğ½Ğ¸Ğµ Ğ½Ğ°Ñ‡Ğ°Ğ»ÑŒĞ½Ñ‹Ñ… Ğ°ÑÑĞ¾Ñ†Ğ¸Ğ°Ñ†Ğ¸Ğ¹...")
    populate_associations()
    
    print("\nĞ¡Ğ²ÑĞ·Ñ‹Ğ²Ğ°Ğ½Ğ¸Ğµ Ğ¾Ğ±Ğ¾Ñ€ÑƒĞ´Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ Ñ Ğ°ÑÑĞ¾Ñ†Ğ¸Ğ°Ñ†Ğ¸ÑĞ¼Ğ¸...")
    link_equipment_to_associations()
    
    print("\nĞ“Ğ¾Ñ‚Ğ¾Ğ²Ğ¾!")


```


## <a name="RentalAppFASTAPIscriptspopulatediscountspy"></a>`RentalApp_FASTAPI/scripts/populate_discounts.py`

```python
// path: RentalApp_FASTAPI/scripts/populate_discounts.py

# scripts/populate_discounts.py

import sys
import os
from sqlalchemy import create_engine
from sqlalchemy.orm import sessionmaker

# Ğ”Ğ¾Ğ±Ğ°Ğ²Ğ»ÑĞµĞ¼ ĞºĞ¾Ñ€Ğ½ĞµĞ²ÑƒÑ Ğ´Ğ¸Ñ€ĞµĞºÑ‚Ğ¾Ñ€Ğ¸Ñ Ğ¿Ñ€Ğ¾ĞµĞºÑ‚Ğ° Ğ² sys.path, Ñ‡Ñ‚Ğ¾Ğ±Ñ‹ Ğ½Ğ°Ğ¹Ñ‚Ğ¸ Ğ´Ñ€ÑƒĞ³Ğ¸Ğµ Ğ¼Ğ¾Ğ´ÑƒĞ»Ğ¸
sys.path.append(os.path.abspath(os.path.join(os.path.dirname(__file__), '..')))

# âœ¨ Ğ˜Ğ¡ĞŸĞ ĞĞ’Ğ›Ğ•ĞĞ˜Ğ•: Ğ˜Ğ¼Ğ¿Ğ¾Ñ€Ñ‚Ğ¸Ñ€ÑƒĞµĞ¼ DATABASE_URL Ğ¸Ğ· Ğ¿Ñ€Ğ°Ğ²Ğ¸Ğ»ÑŒĞ½Ğ¾Ğ³Ğ¾ Ğ¼ĞµÑÑ‚Ğ°
from config.secrets import DATABASE_URL
from api.models.discount import DurationDiscount

# ĞŸĞ¾Ğ´ĞºĞ»ÑÑ‡ĞµĞ½Ğ¸Ğµ Ğº Ğ‘Ğ”, Ğ¸ÑĞ¿Ğ¾Ğ»ÑŒĞ·ÑƒÑ Ğ¸Ğ¼Ğ¿Ğ¾Ñ€Ñ‚Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ½ÑƒÑ ÑÑ‚Ñ€Ğ¾ĞºÑƒ
engine = create_engine(DATABASE_URL)
SessionLocal = sessionmaker(autocommit=False, autoflush=False, bind=engine)

def populate_duration_discounts():
    db = SessionLocal()
    try:
        # ĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑĞµĞ¼, ĞµÑÑ‚ÑŒ Ğ»Ğ¸ ÑƒĞ¶Ğµ Ğ·Ğ°Ğ¿Ğ¸ÑĞ¸
        if db.query(DurationDiscount).count() > 0:
            print("Ğ¢Ğ°Ğ±Ğ»Ğ¸Ñ†Ğ° 'duration_discounts' ÑƒĞ¶Ğµ Ğ·Ğ°Ğ¿Ğ¾Ğ»Ğ½ĞµĞ½Ğ°. ĞŸÑ€Ğ¾Ğ¿ÑƒÑĞºĞ°ĞµĞ¼.")
            return

        discounts = [
            {'min_days': 4, 'discount_percentage': 10},  # ĞÑ‚ 4 Ğ´Ğ¾ 6 Ğ´Ğ½ĞµĞ¹
            {'min_days': 7, 'discount_percentage': 15},  # ĞÑ‚ 7 Ğ´Ğ¾ 9 Ğ´Ğ½ĞµĞ¹
            {'min_days': 10, 'discount_percentage': 20}, # ĞÑ‚ 10 Ğ´Ğ¾ 13 Ğ´Ğ½ĞµĞ¹
            {'min_days': 14, 'discount_percentage': 25}  # ĞÑ‚ 14 Ğ´Ğ½ĞµĞ¹ Ğ¸ Ğ±Ğ¾Ğ»ĞµĞµ
        ]

        for discount_data in discounts:
            db_discount = DurationDiscount(**discount_data)
            db.add(db_discount)

        db.commit()
        print("âœ… Ğ¢Ğ°Ğ±Ğ»Ğ¸Ñ†Ğ° 'duration_discounts' ÑƒÑĞ¿ĞµÑˆĞ½Ğ¾ Ğ·Ğ°Ğ¿Ğ¾Ğ»Ğ½ĞµĞ½Ğ°.")

    except Exception as e:
        print(f"âŒ ĞŸÑ€Ğ¾Ğ¸Ğ·Ğ¾ÑˆĞ»Ğ° Ğ¾ÑˆĞ¸Ğ±ĞºĞ°: {e}")
        db.rollback()
    finally:
        db.close()

if __name__ == "__main__":
    populate_duration_discounts()

```


## <a name="RentalAppFASTAPIscriptsrecalculatebalancespy"></a>`RentalApp_FASTAPI/scripts/recalculate_balances.py`

```python
// path: RentalApp_FASTAPI/scripts/recalculate_balances.py

# scripts/recalculate_balances.py

import sys
import os
from sqlalchemy import func
from sqlalchemy.orm import Session

# Ğ”Ğ¾Ğ±Ğ°Ğ²Ğ»ÑĞµĞ¼ ĞºĞ¾Ñ€Ğ½ĞµĞ²ÑƒÑ Ğ´Ğ¸Ñ€ĞµĞºÑ‚Ğ¾Ñ€Ğ¸Ñ Ğ¿Ñ€Ğ¾ĞµĞºÑ‚Ğ° Ğ² sys.path,
# Ñ‡Ñ‚Ğ¾Ğ±Ñ‹ Ğ¼Ğ¾Ğ¶Ğ½Ğ¾ Ğ±Ñ‹Ğ»Ğ¾ Ğ¸Ğ¼Ğ¿Ğ¾Ñ€Ñ‚Ğ¸Ñ€Ğ¾Ğ²Ğ°Ñ‚ÑŒ Ğ¼Ğ¾Ğ´ÑƒĞ»Ğ¸ Ğ¸Ğ· `api`
sys.path.insert(0, os.path.abspath(os.path.join(os.path.dirname(__file__), '..')))

from api.database import SessionLocal
from api.models.user import User
from api.models.balance_history import BalanceHistory

def recalculate_all_balances():
    """
    ĞŸĞµÑ€ĞµÑÑ‡Ğ¸Ñ‚Ñ‹Ğ²Ğ°ĞµÑ‚ Ğ¸ Ğ¾Ğ±Ğ½Ğ¾Ğ²Ğ»ÑĞµÑ‚ Ğ±Ğ°Ğ»Ğ°Ğ½Ñ Ğ´Ğ»Ñ Ğ²ÑĞµÑ… Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ĞµĞ¹ Ğ½Ğ° Ğ¾ÑĞ½Ğ¾Ğ²Ğµ Ğ¸Ñ… Ğ¸ÑÑ‚Ğ¾Ñ€Ğ¸Ğ¸ Ñ‚Ñ€Ğ°Ğ½Ğ·Ğ°ĞºÑ†Ğ¸Ğ¹.
    """
    print("ğŸš€ Ğ—Ğ°Ğ¿ÑƒÑĞº ÑĞºÑ€Ğ¸Ğ¿Ñ‚Ğ° Ğ´Ğ»Ñ Ğ¿ĞµÑ€ĞµÑÑ‡ĞµÑ‚Ğ° Ğ±Ğ°Ğ»Ğ°Ğ½ÑĞ¾Ğ²...")
    db: Session = SessionLocal()
    try:
        users = db.query(User).all()
        if not users:
            print("Ğ’ Ğ±Ğ°Ğ·Ğµ Ğ´Ğ°Ğ½Ğ½Ñ‹Ñ… Ğ½ĞµÑ‚ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ĞµĞ¹. Ğ—Ğ°Ğ²ĞµÑ€ÑˆĞµĞ½Ğ¸Ğµ.")
            return

        updated_count = 0
        print(f"ĞĞ°Ğ¹Ğ´ĞµĞ½Ğ¾ {len(users)} Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ĞµĞ¹ Ğ´Ğ»Ñ Ğ¿Ñ€Ğ¾Ğ²ĞµÑ€ĞºĞ¸.")

        for user in users:
            # Ğ¡ÑƒĞ¼Ğ¼Ğ¸Ñ€ÑƒĞµĞ¼ Ğ²ÑĞµ Ñ‚Ñ€Ğ°Ğ½Ğ·Ğ°ĞºÑ†Ğ¸Ğ¸ Ğ´Ğ»Ñ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ñ Ğ¸Ğ· Ñ‚Ğ°Ğ±Ğ»Ğ¸Ñ†Ñ‹ balance_history
            correct_balance_query = db.query(func.sum(BalanceHistory.amount)).filter(BalanceHistory.user_id == user.id)
            correct_balance = correct_balance_query.scalar() or 0.0
            correct_balance = round(correct_balance, 2)

            # Ğ¡Ñ€Ğ°Ğ²Ğ½Ğ¸Ğ²Ğ°ĞµĞ¼ Ñ‚ĞµĞºÑƒÑ‰Ğ¸Ğ¹ (Ğ²Ğ¾Ğ·Ğ¼Ğ¾Ğ¶Ğ½Ğ¾, Ğ½ĞµĞºĞ¾Ñ€Ñ€ĞµĞºÑ‚Ğ½Ñ‹Ğ¹) Ğ±Ğ°Ğ»Ğ°Ğ½Ñ Ñ Ğ¿Ñ€Ğ°Ğ²Ğ¸Ğ»ÑŒĞ½Ñ‹Ğ¼
            if user.balance != correct_balance:
                print(f"  - ĞŸĞ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ÑŒ ID {user.id} ({user.email}):")
                print(f"    ĞĞµĞºĞ¾Ñ€Ñ€ĞµĞºÑ‚Ğ½Ñ‹Ğ¹ Ğ±Ğ°Ğ»Ğ°Ğ½Ñ: {user.balance:.2f} â‚½")
                print(f"    ĞŸÑ€Ğ°Ğ²Ğ¸Ğ»ÑŒĞ½Ñ‹Ğ¹ Ğ±Ğ°Ğ»Ğ°Ğ½Ñ:   {correct_balance:.2f} â‚½. ĞĞ±Ğ½Ğ¾Ğ²Ğ»ÑĞµĞ¼...")
                user.balance = correct_balance
                updated_count += 1

        if updated_count > 0:
            print(f"\nĞ¡Ğ¾Ñ…Ñ€Ğ°Ğ½ĞµĞ½Ğ¸Ğµ Ğ¸Ğ·Ğ¼ĞµĞ½ĞµĞ½Ğ¸Ğ¹ Ğ´Ğ»Ñ {updated_count} Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ĞµĞ¹...")
            db.commit()
            print("âœ… Ğ˜Ğ·Ğ¼ĞµĞ½ĞµĞ½Ğ¸Ñ ÑƒÑĞ¿ĞµÑˆĞ½Ğ¾ ÑĞ¾Ñ…Ñ€Ğ°Ğ½ĞµĞ½Ñ‹.")
        else:
            print("\nĞ’ÑĞµ Ğ±Ğ°Ğ»Ğ°Ğ½ÑÑ‹ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ĞµĞ¹ ÑƒĞ¶Ğµ Ğ±Ñ‹Ğ»Ğ¸ Ğ² Ğ°ĞºÑ‚ÑƒĞ°Ğ»ÑŒĞ½Ğ¾Ğ¼ ÑĞ¾ÑÑ‚Ğ¾ÑĞ½Ğ¸Ğ¸. ĞĞ±Ğ½Ğ¾Ğ²Ğ»ĞµĞ½Ğ¸Ğµ Ğ½Ğµ Ñ‚Ñ€ĞµĞ±ÑƒĞµÑ‚ÑÑ.")

    except Exception as e:
        db.rollback()
        print(f"\nâŒ ĞŸÑ€Ğ¾Ğ¸Ğ·Ğ¾ÑˆĞ»Ğ° Ğ¾ÑˆĞ¸Ğ±ĞºĞ°: {e}")
        print("Ğ’ÑĞµ Ğ¸Ğ·Ğ¼ĞµĞ½ĞµĞ½Ğ¸Ñ Ğ±Ñ‹Ğ»Ğ¸ Ğ¾Ñ‚Ğ¼ĞµĞ½ĞµĞ½Ñ‹.")
    finally:
        db.close()
        print("\nğŸ Ğ¡ĞºÑ€Ğ¸Ğ¿Ñ‚ Ğ·Ğ°Ğ²ĞµÑ€ÑˆĞ¸Ğ» Ñ€Ğ°Ğ±Ğ¾Ñ‚Ñƒ.")

if __name__ == "__main__":
    # Ğ­Ñ‚Ğ¾Ñ‚ Ğ±Ğ»Ğ¾Ğº Ğ¿Ğ¾Ğ·Ğ²Ğ¾Ğ»ÑĞµÑ‚ Ğ·Ğ°Ğ¿ÑƒÑĞºĞ°Ñ‚ÑŒ ÑĞºÑ€Ğ¸Ğ¿Ñ‚ Ğ½Ğ°Ğ¿Ñ€ÑĞ¼ÑƒÑ Ğ¸Ğ· ĞºĞ¾Ğ¼Ğ°Ğ½Ğ´Ğ½Ğ¾Ğ¹ ÑÑ‚Ñ€Ğ¾ĞºĞ¸
    recalculate_all_balances()

```


## <a name="RentalAppFASTAPIsharedschemasaccessoryschemapy"></a>`RentalApp_FASTAPI/shared/schemas/accessory_schema.py`

```python
// path: RentalApp_FASTAPI/shared/schemas/accessory_schema.py

# shared/schemas/accessory_schema.py

from pydantic import BaseModel, ConfigDict
from typing import Optional, List

class AccessoryBase(BaseModel):
    name: str
    accessory_type: Optional[str] = "ĞŸÑ€Ğ¾Ñ‡ĞµĞµ"
    price: Optional[float] = 0.0
    description: Optional[str] = None

class AccessoryCreate(AccessoryBase):
    pass

class AccessoryUpdate(AccessoryBase):
    pass

class AccessoryOut(AccessoryBase):
    id: int
    model_config = ConfigDict(from_attributes=True)


class AccessoryListResponse(BaseModel):
    items: List[AccessoryOut]
    total: int

```


## <a name="RentalAppFASTAPIsharedschemasassociationschemapy"></a>`RentalApp_FASTAPI/shared/schemas/association_schema.py`

```python
// path: RentalApp_FASTAPI/shared/schemas/association_schema.py

# shared/schemas/association_schema.py

from pydantic import BaseModel, ConfigDict, Field
from typing import Optional, List

# Ğ‘Ğ°Ğ·Ğ¾Ğ²Ğ°Ñ ÑÑ…ĞµĞ¼Ğ° Ñ Ğ¾Ğ±Ñ‰Ğ¸Ğ¼Ğ¸ Ğ¿Ğ¾Ğ»ÑĞ¼Ğ¸
class AssociationBase(BaseModel):
    name: str = Field(..., min_length=3, max_length=100, description="ĞĞ°Ğ·Ğ²Ğ°Ğ½Ğ¸Ğµ Ğ°ÑÑĞ¾Ñ†Ğ¸Ğ°Ñ†Ğ¸Ğ¸")
    description: Optional[str] = Field(None, description="Ğ’Ğ½ÑƒÑ‚Ñ€ĞµĞ½Ğ½ĞµĞµ Ğ¾Ğ¿Ğ¸ÑĞ°Ğ½Ğ¸Ğµ")
    sort_order: int = Field(0, description="Ğ˜Ğ½Ğ´ĞµĞºÑ Ğ´Ğ»Ñ ÑĞ¾Ñ€Ñ‚Ğ¸Ñ€Ğ¾Ğ²ĞºĞ¸")

# Ğ¡Ñ…ĞµĞ¼Ğ° Ğ´Ğ»Ñ ÑĞ¾Ğ·Ğ´Ğ°Ğ½Ğ¸Ñ Ğ½Ğ¾Ğ²Ğ¾Ğ¹ Ğ°ÑÑĞ¾Ñ†Ğ¸Ğ°Ñ†Ğ¸Ğ¸
class AssociationCreate(AssociationBase):
    equipment_ids: List[int] = Field([], description="Ğ¡Ğ¿Ğ¸ÑĞ¾Ğº ID ÑĞ²ÑĞ·Ğ°Ğ½Ğ½Ğ¾Ğ³Ğ¾ Ğ¾Ğ±Ğ¾Ñ€ÑƒĞ´Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ")

# Ğ¡Ñ…ĞµĞ¼Ğ° Ğ´Ğ»Ñ Ğ¾Ğ±Ğ½Ğ¾Ğ²Ğ»ĞµĞ½Ğ¸Ñ ÑÑƒÑ‰ĞµÑÑ‚Ğ²ÑƒÑÑ‰ĞµĞ¹ Ğ°ÑÑĞ¾Ñ†Ğ¸Ğ°Ñ†Ğ¸Ğ¸
class AssociationUpdate(BaseModel):
    name: Optional[str] = Field(None, min_length=3, max_length=100)
    description: Optional[str] = None
    sort_order: Optional[int] = None
    equipment_ids: Optional[List[int]] = None

# Ğ¡Ñ…ĞµĞ¼Ğ° Ğ´Ğ»Ñ Ğ²Ñ‹Ğ²Ğ¾Ğ´Ğ° Ğ´Ğ°Ğ½Ğ½Ñ‹Ñ… Ğ¸Ğ· API.
# Ğ¡Ğ°Ğ¼Ğ¾Ğµ Ğ²Ğ°Ğ¶Ğ½Ğ¾Ğµ: Ğ¾Ğ½Ğ° Ğ²ĞºĞ»ÑÑ‡Ğ°ĞµÑ‚ `equipment_ids` Ğ´Ğ»Ñ Ñ€Ğ°Ğ±Ğ¾Ñ‚Ñ‹ Ñ„Ğ¸Ğ»ÑŒÑ‚Ñ€Ğ° Ğ½Ğ° Ñ„Ñ€Ğ¾Ğ½Ñ‚ĞµĞ½Ğ´Ğµ.
class AssociationOut(AssociationBase):
    id: int
    equipment_ids: List[int]

    model_config = ConfigDict(from_attributes=True)

# +++ Ğ’ĞĞ¡Ğ¡Ğ¢ĞĞĞĞ’Ğ˜Ğ¢Ğ¬ Ğ­Ğ¢ĞĞ¢ ĞšĞ›ĞĞ¡Ğ¡ +++
# Ğ­Ñ‚Ğ° ÑÑ…ĞµĞ¼Ğ° Ğ½ÑƒĞ¶Ğ½Ğ° Ğ´Ğ»Ñ Ğ¾Ñ‚Ğ¾Ğ±Ñ€Ğ°Ğ¶ĞµĞ½Ğ¸Ñ Ğ¸Ğ½Ñ„Ğ¾Ñ€Ğ¼Ğ°Ñ†Ğ¸Ğ¸ Ğ¾Ğ± Ğ°ÑÑĞ¾Ñ†Ğ¸Ğ°Ñ†Ğ¸Ğ¸ Ğ²Ğ½ÑƒÑ‚Ñ€Ğ¸ ÑÑ…ĞµĞ¼Ñ‹ Ğ¾Ğ±Ğ¾Ñ€ÑƒĞ´Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ.
class AssociationSimple(BaseModel):
    id: int
    name: str

    model_config = ConfigDict(from_attributes=True)


class AssociationListResponse(BaseModel):
    items: List[AssociationOut]
    total: int


```


## <a name="RentalAppFASTAPIsharedschemasbalancehistoryschemapy"></a>`RentalApp_FASTAPI/shared/schemas/balance_history_schema.py`

```python
// path: RentalApp_FASTAPI/shared/schemas/balance_history_schema.py

# src/shared/schemas/balance_history_schema.py (ĞĞĞ’Ğ«Ğ™ Ğ¤ĞĞ™Ğ›)

from pydantic import BaseModel, ConfigDict
from datetime import datetime
from typing import List, Optional

class BalanceHistoryBase(BaseModel):
    amount: float
    operation_type: str
    description: Optional[str] = None
    created_at: datetime
    rental_id: Optional[int] = None

class BalanceHistoryOut(BalanceHistoryBase):
    id: int
    user_id: int

    model_config = ConfigDict(from_attributes=True)

class BalanceHistoryListResponse(BaseModel):
    items: List[BalanceHistoryOut]
    total: int

```


## <a name="RentalAppFASTAPIsharedschemascalendarschemapy"></a>`RentalApp_FASTAPI/shared/schemas/calendar_schema.py`

```python
// path: RentalApp_FASTAPI/shared/schemas/calendar_schema.py

# shared/schemas/calendar_schema.py

from datetime import date
from typing import Optional, Dict, Union, List
from pydantic import BaseModel, ConfigDict # â—ï¸ Ğ˜Ğ¼Ğ¿Ğ¾Ñ€Ñ‚Ğ¸Ñ€ÑƒĞµĞ¼ ConfigDict


class EquipmentStatusResponse(BaseModel):
    equipment_id: int
    status: str
    details: str
    name: str | None = None
    equipment_type: str | None = None
    brand: str | None = None
    start_date: Optional[date] = None
    end_date: Optional[date] = None

    # â—ï¸ Ğ˜Ğ—ĞœĞ•ĞĞ•ĞĞ˜Ğ•: Config Ğ·Ğ°Ğ¼ĞµĞ½ĞµĞ½ Ğ½Ğ° model_config, orm_mode Ğ½Ğ° from_attributes
    model_config = ConfigDict(from_attributes=True)


class DayStatusItem(BaseModel):
    status: str
    group_id: Optional[str] = None
    is_user_reservation: bool = False


class EquipmentDayStatusesResponse(BaseModel):
    equipment_day_statuses: Dict[int, Dict[str, Union[str, DayStatusItem]]]


class CalendarEventResponse(BaseModel):
    id: str
    title: str
    start: str
    end: str
    resourceId: int
    status: str


class EquipmentStatusListResponse(BaseModel):
    items: List[EquipmentStatusResponse]
    total: int


class CalendarEventListResponse(BaseModel):
    items: List[CalendarEventResponse]
    total: int

```


## <a name="RentalAppFASTAPIsharedschemascommonfinancialspy"></a>`RentalApp_FASTAPI/shared/schemas/common_financials.py`

```python
// path: RentalApp_FASTAPI/shared/schemas/common_financials.py

# shared/schemas/common_financials.py

from pydantic import BaseModel
from typing import Optional


class FinancialsBase(BaseModel):
    """
    Ğ‘Ğ°Ğ·Ğ¾Ğ²Ğ°Ñ ÑÑ…ĞµĞ¼Ğ° Ğ´Ğ»Ñ Ñ„Ğ¸Ğ½Ğ°Ğ½ÑĞ¾Ğ²Ñ‹Ñ… Ğ´Ğ°Ğ½Ğ½Ñ‹Ñ…, Ğ¾Ğ±Ñ‰Ğ¸Ñ… Ğ´Ğ»Ñ Ğ°Ñ€ĞµĞ½Ğ´ Ğ¸ Ñ€ĞµĞ·ĞµÑ€Ğ²Ğ¾Ğ².
    Ğ¡Ğ¾Ğ´ĞµÑ€Ğ¶Ğ¸Ñ‚ ÑÑ‚Ğ°Ğ½Ğ´Ğ°Ñ€Ñ‚Ğ½Ñ‹Ğµ Ğ¿Ğ¾Ğ»Ñ Ğ´Ğ»Ñ ÑÑ‚Ğ¾Ğ¸Ğ¼Ğ¾ÑÑ‚Ğ¸, ÑĞºĞ¸Ğ´Ğ¾Ğº Ğ¸ Ğ¿Ñ€Ğ¾Ğ¼Ğ¾ĞºĞ¾Ğ´Ğ¾Ğ².
    """
    total_cost: float
    discount_amount: float = 0.0
    promo_code: Optional[str] = None
    final_cost: Optional[float] = None
    accessories_cost: float = 0.0
    remaining_amount: float = 0.0


```


## <a name="RentalAppFASTAPIsharedschemasdashboardschemapy"></a>`RentalApp_FASTAPI/shared/schemas/dashboard_schema.py`

```python
// path: RentalApp_FASTAPI/shared/schemas/dashboard_schema.py

# shared/schemas/dashboard_schema.py
from pydantic import BaseModel, ConfigDict, field_validator
from datetime import datetime, date
from typing import List, Optional

# Ğ­Ğ»ĞµĞ¼ĞµĞ½Ñ‚ Ğ´Ğ»Ñ Ğ²Ğ¸Ğ´Ğ¶ĞµÑ‚Ğ° "Ğ¡ĞµĞ³Ğ¾Ğ´Ğ½Ñ Ğ² Ñ„Ğ¾ĞºÑƒÑĞµ"
class TodayFocusItem(BaseModel):
    id: int  # Ğ˜Ğ·Ğ¼ĞµĞ½ĞµĞ½Ğ¾ Ñ order_id Ğ´Ğ»Ñ ĞºĞ¾Ğ½ÑĞ¸ÑÑ‚ĞµĞ½Ñ‚Ğ½Ğ¾ÑÑ‚Ğ¸ Ñ Ñ„Ñ€Ğ¾Ğ½Ñ‚ĞµĞ½Ğ´Ğ¾Ğ¼
    user_name: str
    details: str  # ĞĞ°Ğ¿Ñ€Ğ¸Ğ¼ĞµÑ€, "3 Ğ¿Ğ¾Ğ·Ğ¸Ñ†Ğ¸Ğ¸" Ğ¸Ğ»Ğ¸ "ĞÑÑ‚Ğ°Ñ‚Ğ¾Ğº: 1500 â‚½"
    user_id: int
    order_type: str # 'reservation' Ğ¸Ğ»Ğ¸ 'rental'
    scheduled_time: datetime  # Ğ’Ñ€ĞµĞ¼Ñ Ğ²Ñ‹Ğ´Ğ°Ñ‡Ğ¸ Ğ¸Ğ»Ğ¸ Ğ²Ğ¾Ğ·Ğ²Ñ€Ğ°Ñ‚Ğ°
    start_date: Optional[date] = None  # Ğ”Ğ°Ñ‚Ğ° Ğ½Ğ°Ñ‡Ğ°Ğ»Ğ° Ñ€ĞµĞ·ĞµÑ€Ğ²Ğ°
    # ĞŸĞ¾Ğ»Ñ Ğ´Ğ»Ñ Ğ¿Ñ€Ğ¾ÑÑ€Ğ¾Ñ‡ĞµĞ½Ğ½Ñ‹Ñ… Ğ°Ñ€ĞµĞ½Ğ´
    due_date: Optional[date] = None  # Ğ”Ğ°Ñ‚Ğ° Ğ¾ĞºĞ¾Ğ½Ñ‡Ğ°Ğ½Ğ¸Ñ Ğ°Ñ€ĞµĞ½Ğ´Ñ‹
    days_overdue: Optional[int] = None  # ĞšĞ¾Ğ»Ğ¸Ñ‡ĞµÑÑ‚Ğ²Ğ¾ Ğ´Ğ½ĞµĞ¹ Ğ¿Ñ€Ğ¾ÑÑ€Ğ¾Ñ‡ĞºĞ¸

# Ğ­Ğ»ĞµĞ¼ĞµĞ½Ñ‚ Ğ´Ğ»Ñ Ğ²Ğ¸Ğ´Ğ¶ĞµÑ‚Ğ° "ĞŸĞ¾ÑĞ»ĞµĞ´Ğ½Ğ¸Ğµ ÑĞ¾Ğ±Ñ‹Ñ‚Ğ¸Ñ"
class ActivityFeedItem(BaseModel):
    id: int  # Ğ”Ğ¾Ğ±Ğ°Ğ²Ğ»ĞµĞ½Ğ¾ Ğ´Ğ»Ñ ĞºĞ¾Ğ½ÑĞ¸ÑÑ‚ĞµĞ½Ñ‚Ğ½Ğ¾ÑÑ‚Ğ¸ Ñ Ñ„Ñ€Ğ¾Ğ½Ñ‚ĞµĞ½Ğ´Ğ¾Ğ¼
    timestamp: datetime
    activity_type: str  # "new_reservation", "new_user", "rental_return"
    description: str
    user_name: Optional[str] = None  # Ğ˜Ğ¼Ñ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ñ Ğ´Ğ»Ñ Ğ¾Ğ±Ğ¾Ğ³Ğ°Ñ‰ĞµĞ½Ğ¸Ñ Ğ»ĞµĞ½Ñ‚Ñ‹ ÑĞ¾Ğ±Ñ‹Ñ‚Ğ¸Ğ¹
    equipment_name: Optional[str] = None  # ĞĞ°Ğ·Ğ²Ğ°Ğ½Ğ¸Ğµ Ğ¾Ğ±Ğ¾Ñ€ÑƒĞ´Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ Ğ´Ğ»Ñ Ğ¾Ğ±Ğ¾Ğ³Ğ°Ñ‰ĞµĞ½Ğ¸Ñ Ğ»ĞµĞ½Ñ‚Ñ‹ ÑĞ¾Ğ±Ñ‹Ñ‚Ğ¸Ğ¹

# Ğ­Ğ»ĞµĞ¼ĞµĞ½Ñ‚ Ğ´Ğ»Ñ Ğ³Ñ€Ğ°Ñ„Ğ¸ĞºĞ° "ĞŸĞ¾Ğ¿ÑƒĞ»ÑÑ€Ğ½Ğ¾Ğµ Ğ¾Ğ±Ğ¾Ñ€ÑƒĞ´Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ"
class PopularEquipmentItem(BaseModel):
    equipment_id: int  # ID Ğ¾Ğ±Ğ¾Ñ€ÑƒĞ´Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ Ğ´Ğ»Ñ Ğ¸ÑĞ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ Ğ² ĞºĞ°Ñ‡ĞµÑÑ‚Ğ²Ğµ key Ğ½Ğ° Ñ„Ñ€Ğ¾Ğ½Ñ‚ĞµĞ½Ğ´Ğµ
    equipment_name: str
    rental_count: int  # ĞšĞ¾Ğ»Ğ¸Ñ‡ĞµÑÑ‚Ğ²Ğ¾ Ğ°Ñ€ĞµĞ½Ğ´
    revenue: float  # Ğ’Ñ‹Ñ€ÑƒÑ‡ĞºĞ° Ğ¾Ñ‚ Ğ°Ñ€ĞµĞ½Ğ´Ñ‹ Ğ´Ğ°Ğ½Ğ½Ğ¾Ğ³Ğ¾ Ğ¾Ğ±Ğ¾Ñ€ÑƒĞ´Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ

# Ğ’Ğ»Ğ¾Ğ¶ĞµĞ½Ğ½Ğ°Ñ Ğ¼Ğ¾Ğ´ĞµĞ»ÑŒ Ğ´Ğ»Ñ Ğ²ÑĞµÑ… KPI Ğ¿Ğ¾ĞºĞ°Ğ·Ğ°Ñ‚ĞµĞ»ĞµĞ¹
class KpiData(BaseModel):
    total_users: int  # ĞĞ±Ñ‰ĞµĞµ ĞºĞ¾Ğ»Ğ¸Ñ‡ĞµÑÑ‚Ğ²Ğ¾ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ĞµĞ¹
    active_users: int  # ĞĞºÑ‚Ğ¸Ğ²Ğ½Ñ‹Ğµ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ğ¸
    total_equipment: int  # ĞĞ±Ñ‰ĞµĞµ ĞºĞ¾Ğ»Ğ¸Ñ‡ĞµÑÑ‚Ğ²Ğ¾ Ğ¾Ğ±Ğ¾Ñ€ÑƒĞ´Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ
    total_reservations: int  # ĞĞ±Ñ‰ĞµĞµ ĞºĞ¾Ğ»Ğ¸Ñ‡ĞµÑÑ‚Ğ²Ğ¾ Ñ€ĞµĞ·ĞµÑ€Ğ²Ğ°Ñ†Ğ¸Ğ¹
    revenue_today: float  # Ğ”Ğ¾Ñ…Ğ¾Ğ´ Ğ·Ğ° ÑĞµĞ³Ğ¾Ğ´Ğ½Ñ
    revenue_this_month: float  # Ğ”Ğ¾Ñ…Ğ¾Ğ´ Ğ·Ğ° Ñ‚ĞµĞºÑƒÑ‰Ğ¸Ğ¹ Ğ¼ĞµÑÑÑ†
    occupancy_rate: float  # ĞšĞ¾ÑÑ„Ñ„Ğ¸Ñ†Ğ¸ĞµĞ½Ñ‚ Ğ·Ğ°Ğ³Ñ€ÑƒĞ¶ĞµĞ½Ğ½Ğ¾ÑÑ‚Ğ¸
    avg_rental_duration: float  # Ğ¡Ñ€ĞµĞ´Ğ½ÑÑ Ğ¿Ñ€Ğ¾Ğ´Ğ¾Ğ»Ğ¶Ğ¸Ñ‚ĞµĞ»ÑŒĞ½Ğ¾ÑÑ‚ÑŒ Ğ°Ñ€ĞµĞ½Ğ´Ñ‹

# ĞÑĞ½Ğ¾Ğ²Ğ½Ğ°Ñ ÑÑ…ĞµĞ¼Ğ° Ğ¾Ñ‚Ğ²ĞµÑ‚Ğ°
class DashboardSummaryResponse(BaseModel):
    # Ğ’Ğ¸Ğ´Ğ¶ĞµÑ‚ "Ğ¡ĞµĞ³Ğ¾Ğ´Ğ½Ñ Ğ² Ñ„Ğ¾ĞºÑƒÑĞµ"
    pickups_today: List[TodayFocusItem]
    returns_today: List[TodayFocusItem]
    overdue_rentals: List[TodayFocusItem]

    # Ğ’Ğ¸Ğ´Ğ¶ĞµÑ‚ "ĞšĞ»ÑÑ‡ĞµĞ²Ñ‹Ğµ Ğ¿Ğ¾ĞºĞ°Ğ·Ğ°Ñ‚ĞµĞ»Ğ¸" - Ñ‚ĞµĞ¿ĞµÑ€ÑŒ Ğ²Ğ»Ğ¾Ğ¶ĞµĞ½Ğ½Ğ°Ñ ÑÑ‚Ñ€ÑƒĞºÑ‚ÑƒÑ€Ğ°
    kpi: KpiData

    # Ğ’Ğ¸Ğ´Ğ¶ĞµÑ‚ "ĞŸĞ¾ÑĞ»ĞµĞ´Ğ½Ğ¸Ğµ ÑĞ¾Ğ±Ñ‹Ñ‚Ğ¸Ñ"
    recent_activity: List[ActivityFeedItem]

    # Ğ’Ğ¸Ğ´Ğ¶ĞµÑ‚ "ĞŸĞ¾Ğ¿ÑƒĞ»ÑÑ€Ğ½Ğ¾Ğµ Ğ¾Ğ±Ğ¾Ñ€ÑƒĞ´Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ"
    popular_equipment: List[PopularEquipmentItem]

    model_config = ConfigDict(from_attributes=True)


```


## <a name="RentalAppFASTAPIsharedschemasdiscountschemapy"></a>`RentalApp_FASTAPI/shared/schemas/discount_schema.py`

```python
// path: RentalApp_FASTAPI/shared/schemas/discount_schema.py

# shared/schemas/discount_schema.py

from pydantic import BaseModel, ConfigDict, Field
from typing import List

class DiscountBase(BaseModel):
    min_days: int = Field(..., gt=0, description="ĞœĞ¸Ğ½Ğ¸Ğ¼Ğ°Ğ»ÑŒĞ½Ğ¾Ğµ ĞºĞ¾Ğ»Ğ¸Ñ‡ĞµÑÑ‚Ğ²Ğ¾ Ğ´Ğ½ĞµĞ¹ Ğ´Ğ»Ñ Ğ¿Ñ€Ğ¸Ğ¼ĞµĞ½ĞµĞ½Ğ¸Ñ ÑĞºĞ¸Ğ´ĞºĞ¸")
    discount_percentage: int = Field(..., gt=0, le=100, description="ĞŸÑ€Ğ¾Ñ†ĞµĞ½Ñ‚ ÑĞºĞ¸Ğ´ĞºĞ¸")

class DiscountCreate(DiscountBase):
    pass

class DiscountUpdate(DiscountBase):
    pass

class DiscountOut(DiscountBase):
    id: int

    model_config = ConfigDict(from_attributes=True)


class DiscountListResponse(BaseModel):
    items: List[DiscountOut]
    total: int

```


## <a name="RentalAppFASTAPIsharedschemasequipmentschemapy"></a>`RentalApp_FASTAPI/shared/schemas/equipment_schema.py`

```python
// path: RentalApp_FASTAPI/shared/schemas/equipment_schema.py

# shared/schemas/equipment_schema.py

from __future__ import annotations
from pydantic import BaseModel, ConfigDict, field_validator
from typing import Optional, List
from datetime import date, datetime # âœ… Ğ˜Ğ—ĞœĞ•ĞĞ•ĞĞ˜Ğ•: Ğ¸Ğ¼Ğ¿Ğ¾Ñ€Ñ‚Ğ¸Ñ€ÑƒĞµĞ¼ date Ğ²Ğ¼ĞµÑÑ‚Ğ¾ datetime
# âœ… Ğ”ĞĞ‘ĞĞ’Ğ›Ğ•Ğ Ğ˜ĞœĞŸĞĞ Ğ¢
from .accessory_schema import AccessoryOut
from .association_schema import AssociationSimple


class EquipmentCreate(BaseModel):
    equipment_type: str
    brand: str
    name: str
    serial_number: Optional[str] = None
    condition: Optional[str] = "Ğ’ĞµĞ»Ğ¸ĞºĞ¾Ğ»ĞµĞ¿Ğ½Ğ¾"
    daily_rate: Optional[float] = 0.0
    notes: Optional[str] = None
    description: Optional[str] = None
    # âœ… Ğ˜Ğ—ĞœĞ•ĞĞ•ĞĞ˜Ğ•: Ğ¢Ğ¸Ğ¿ Ğ¿Ğ¾Ğ»Ñ Ğ¸Ğ·Ğ¼ĞµĞ½ĞµĞ½ Ñ datetime Ğ½Ğ° date
    last_maintenance: Optional[date] = None
    image_url: Optional[str] = None
    image_urls: Optional[List[str]] = None
    short_description: Optional[str] = None


class EquipmentOut(BaseModel):
    id: int
    equipment_type: str
    brand: str
    name: str
    serial_number: Optional[str] = None
    condition: str
    daily_rate: float
    notes: Optional[str] = None
    description: Optional[str] = None
    # âœ… Ğ˜Ğ—ĞœĞ•ĞĞ•ĞĞ˜Ğ•: Ğ¢Ğ¸Ğ¿ Ğ¿Ğ¾Ğ»Ñ Ğ¸Ğ·Ğ¼ĞµĞ½ĞµĞ½ Ñ datetime Ğ½Ğ° date
    last_maintenance: Optional[date] = None
    image_url: Optional[str] = None
    image_urls: Optional[List[str]] = None
    short_description: Optional[str] = None
    # âœ… Ğ”ĞĞ‘ĞĞ’Ğ›Ğ•ĞĞ ĞŸĞĞ›Ğ• Ğ”Ğ›Ğ¯ ĞĞ¢ĞĞ‘Ğ ĞĞ–Ğ•ĞĞ˜Ğ¯ ĞŸĞ Ğ˜Ğ’Ğ¯Ğ—ĞĞĞĞ«Ğ¥ ĞĞšĞ¡Ğ•Ğ¡Ğ¡Ğ£ĞĞ ĞĞ’
    accessories: List[AccessoryOut] = []
    # âœ… Ğ”ĞĞ‘ĞĞ’Ğ›Ğ•ĞĞ ĞŸĞĞ›Ğ• Ğ”Ğ›Ğ¯ ĞĞ¢ĞĞ‘Ğ ĞĞ–Ğ•ĞĞ˜Ğ¯ ĞŸĞ Ğ˜Ğ’Ğ¯Ğ—ĞĞĞĞ«Ğ¥ ĞĞ¡Ğ¡ĞĞ¦Ğ˜ĞĞ¦Ğ˜Ğ™
    associations: List[AssociationSimple] = []

    @field_validator('last_maintenance', mode='before')
    @classmethod
    def validate_last_maintenance(cls, v):
        """Ğ’Ğ°Ğ»Ğ¸Ğ´Ğ°Ñ‚Ğ¾Ñ€ Ğ´Ğ»Ñ Ğ¿Ğ¾Ğ»Ñ last_maintenance - Ğ¾Ğ±ĞµÑĞ¿ĞµÑ‡Ğ¸Ğ²Ğ°ĞµÑ‚ ĞºĞ¾Ñ€Ñ€ĞµĞºÑ‚Ğ½Ñ‹Ğ¹ Ñ„Ğ¾Ñ€Ğ¼Ğ°Ñ‚ Ğ´Ğ°Ñ‚Ñ‹."""
        if v is None:
            return None
        if isinstance(v, str):
            try:
                # ĞŸÑ‹Ñ‚Ğ°ĞµĞ¼ÑÑ Ğ¿Ñ€ĞµĞ¾Ğ±Ñ€Ğ°Ğ·Ğ¾Ğ²Ğ°Ñ‚ÑŒ ÑÑ‚Ñ€Ğ¾ĞºÑƒ Ğ² Ğ´Ğ°Ñ‚Ñƒ
                return datetime.fromisoformat(v.replace('Z', '+00:00')).date()
            except (ValueError, AttributeError):
                # Ğ•ÑĞ»Ğ¸ Ğ½Ğµ ÑƒĞ´Ğ°ĞµÑ‚ÑÑ Ğ¿Ñ€ĞµĞ¾Ğ±Ñ€Ğ°Ğ·Ğ¾Ğ²Ğ°Ñ‚ÑŒ, Ğ²Ğ¾Ğ·Ğ²Ñ€Ğ°Ñ‰Ğ°ĞµĞ¼ None
                return None
        if isinstance(v, datetime):
            return v.date()
        return v

    model_config = ConfigDict(from_attributes=True)


class EquipmentUpdateExtended(BaseModel):
    equipment_type: Optional[str] = None
    brand: Optional[str] = None
    name: Optional[str] = None
    serial_number: Optional[str] = None
    condition: Optional[str] = None
    daily_rate: Optional[float] = None
    notes: Optional[str] = None
    description: Optional[str] = None
    # âœ… Ğ­Ñ‚Ğ¾ Ğ¿Ğ¾Ğ»Ğµ ÑƒĞ¶Ğµ Ğ±Ñ‹Ğ»Ğ¾ Ğ¿Ñ€Ğ°Ğ²Ğ¸Ğ»ÑŒĞ½Ñ‹Ğ¼ (date), Ğ¾ÑÑ‚Ğ°Ğ²Ğ»ÑĞµĞ¼ ĞºĞ°Ğº ĞµÑÑ‚ÑŒ
    last_maintenance: Optional[date] = None
    image_url: Optional[str] = None
    image_urls: Optional[List[str]] = None
    short_description: Optional[str] = None
    # âœ… Ğ”ĞĞ‘ĞĞ’Ğ›Ğ•ĞĞ ĞŸĞĞ›Ğ• Ğ”Ğ›Ğ¯ ĞŸĞ•Ğ Ğ•Ğ”ĞĞ§Ğ˜ ID ĞĞšĞ¡Ğ•Ğ¡Ğ¡Ğ£ĞĞ ĞĞ’ ĞŸĞ Ğ˜ ĞĞ‘ĞĞĞ’Ğ›Ğ•ĞĞ˜Ğ˜
    accessory_ids: Optional[List[int]] = None
    # âœ… Ğ”ĞĞ‘ĞĞ’Ğ›Ğ•ĞĞ ĞŸĞĞ›Ğ• Ğ”Ğ›Ğ¯ ĞŸĞ•Ğ Ğ•Ğ”ĞĞ§Ğ˜ ID ĞĞ¡Ğ¡ĞĞ¦Ğ˜ĞĞ¦Ğ˜Ğ™ ĞŸĞ Ğ˜ ĞĞ‘ĞĞĞ’Ğ›Ğ•ĞĞ˜Ğ˜
    association_ids: Optional[List[int]] = None

    model_config = ConfigDict(from_attributes=True)


class EquipmentTreeItem(BaseModel):
    label: str
    value: Optional[int] = None
    children: List[EquipmentTreeItem] = []
    model_config = ConfigDict(from_attributes=True)


class EquipmentAvailabilityStatus(BaseModel):
    has_active_reservations: bool
    has_active_rentals: bool
    active_reservations_count: int
    active_rentals_count: int
    model_config = ConfigDict(from_attributes=True)


class EquipmentListResponse(BaseModel):
    items: List[EquipmentOut]
    total: int


class EquipmentTreeListResponse(BaseModel):
    items: List[EquipmentTreeItem]
    total: int

```


## <a name="RentalAppFASTAPIsharedschemasholidayschemapy"></a>`RentalApp_FASTAPI/shared/schemas/holiday_schema.py`

```python
// path: RentalApp_FASTAPI/shared/schemas/holiday_schema.py

# shared/schemas/holiday_schema.py

from pydantic import BaseModel, ConfigDict, Field
from datetime import date, datetime
from typing import Literal, List

class HolidayBase(BaseModel):
    """Ğ‘Ğ°Ğ·Ğ¾Ğ²Ğ°Ñ ÑÑ…ĞµĞ¼Ğ° Ğ´Ğ»Ñ Ğ²Ñ‹Ñ…Ğ¾Ğ´Ğ½Ğ¾Ğ³Ğ¾ Ğ´Ğ½Ñ."""
    date: date
    description: str | None = None

class HolidayCreate(HolidayBase):
    """Ğ¡Ñ…ĞµĞ¼Ğ° Ğ´Ğ»Ñ ÑĞ¾Ğ·Ğ´Ğ°Ğ½Ğ¸Ñ Ğ½Ğ¾Ğ²Ğ¾Ğ³Ğ¾ Ğ²Ñ‹Ñ…Ğ¾Ğ´Ğ½Ğ¾Ğ³Ğ¾ Ğ´Ğ½Ñ."""
    force: bool = False

class HolidayOut(HolidayBase):
    """Ğ¡Ñ…ĞµĞ¼Ğ° Ğ´Ğ»Ñ Ğ¾Ñ‚Ğ¾Ğ±Ñ€Ğ°Ğ¶ĞµĞ½Ğ¸Ñ Ğ´Ğ°Ğ½Ğ½Ñ‹Ñ… Ğ¾ Ğ²Ñ‹Ñ…Ğ¾Ğ´Ğ½Ğ¾Ğ¼ Ğ´Ğ½Ğµ Ğ¸Ğ· Ğ‘Ğ”."""
    created_at: datetime
    created_by_id: int

    model_config = ConfigDict(from_attributes=True)

# +++ ĞĞĞ§ĞĞ›Ğ: ĞĞĞ’Ğ«Ğ• Ğ¡Ğ¥Ğ•ĞœĞ« +++
class RecurringHolidayRuleCreate(BaseModel):
    """Ğ¡Ñ…ĞµĞ¼Ğ° Ğ´Ğ»Ñ ÑĞ¾Ğ·Ğ´Ğ°Ğ½Ğ¸Ñ Ğ¿Ñ€Ğ°Ğ²Ğ¸Ğ»Ğ° ĞµĞ¶ĞµĞ½ĞµĞ´ĞµĞ»ÑŒĞ½Ñ‹Ñ… Ğ²Ñ‹Ñ…Ğ¾Ğ´Ğ½Ñ‹Ñ…."""
    day_of_week: int = Field(..., ge=0, le=6, description="Ğ”ĞµĞ½ÑŒ Ğ½ĞµĞ´ĞµĞ»Ğ¸ (0=ĞŸĞ¾Ğ½ĞµĞ´ĞµĞ»ÑŒĞ½Ğ¸Ğº, 6=Ğ’Ğ¾ÑĞºÑ€ĞµÑĞµĞ½ÑŒĞµ)")
    start_date: date
    end_date: date
    description: str

class HolidayRuleOut(BaseModel):
    """Ğ¡Ñ…ĞµĞ¼Ğ° Ğ´Ğ»Ñ Ğ¾Ñ‚Ğ¾Ğ±Ñ€Ğ°Ğ¶ĞµĞ½Ğ¸Ñ Ğ¿Ñ€Ğ°Ğ²Ğ¸Ğ» Ğ² Ğ°Ğ´Ğ¼Ğ¸Ğ½ĞºĞµ."""
    id: int
    rule_type: str
    description: str
    created_at: datetime

    model_config = ConfigDict(from_attributes=True)


class HolidayListResponse(BaseModel):
    items: List[HolidayOut]
    total: int


class HolidayRuleListResponse(BaseModel):
    items: List[HolidayRuleOut]
    total: int
# +++ ĞšĞĞĞ•Ğ¦: ĞĞĞ’Ğ«Ğ• Ğ¡Ğ¥Ğ•ĞœĞ« +++

```


## <a name="RentalAppFASTAPIsharedschemaspromocodeschemapy"></a>`RentalApp_FASTAPI/shared/schemas/promo_code_schema.py`

```python
// path: RentalApp_FASTAPI/shared/schemas/promo_code_schema.py

# shared/schemas/promo_code_schema.py
from pydantic import BaseModel, ConfigDict, Field, EmailStr
from typing import Optional, List
from datetime import datetime

# --- Ğ¡Ñ…ĞµĞ¼Ñ‹ Ğ´Ğ»Ñ Ğ°Ğ´Ğ¼Ğ¸Ğ½Ğ¸ÑÑ‚Ñ€Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ ---

class PromoCodeBase(BaseModel):
    code: str = Field(..., description="Ğ£Ğ½Ğ¸ĞºĞ°Ğ»ÑŒĞ½Ñ‹Ğ¹ ĞºĞ¾Ğ´, Ğ½Ğ°Ğ¿Ñ€Ğ¸Ğ¼ĞµÑ€, 'SUMMER20'", max_length=50)
    description: Optional[str] = Field(None, description="ĞĞ¿Ğ¸ÑĞ°Ğ½Ğ¸Ğµ Ğ´Ğ»Ñ Ğ²Ğ½ÑƒÑ‚Ñ€ĞµĞ½Ğ½ĞµĞ³Ğ¾ Ğ¸ÑĞ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ")
    discount_percentage: float = Field(..., gt=0, le=50, description="ĞŸÑ€Ğ¾Ñ†ĞµĞ½Ñ‚ ÑĞºĞ¸Ğ´ĞºĞ¸ (1-50)")
    is_active: bool = True
    valid_from: Optional[datetime] = None
    expires_at: Optional[datetime] = None
    max_uses: Optional[int] = Field(None, gt=0, description="ĞĞ±Ñ‰Ğ¸Ğ¹ Ğ»Ğ¸Ğ¼Ğ¸Ñ‚ Ğ¸ÑĞ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğ¹")
    max_uses_per_user: Optional[int] = Field(None, gt=0, description="Ğ›Ğ¸Ğ¼Ğ¸Ñ‚ Ğ½Ğ° Ğ¾Ğ´Ğ½Ğ¾Ğ³Ğ¾ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ñ")
    min_order_amount: Optional[float] = Field(None, gt=0, description="ĞœĞ¸Ğ½Ğ¸Ğ¼Ğ°Ğ»ÑŒĞ½Ğ°Ñ ÑÑƒĞ¼Ğ¼Ğ° Ğ·Ğ°ĞºĞ°Ğ·Ğ°")
    specific_to_user_id: Optional[int] = None
    applicable_to_equipment_ids: Optional[List[int]] = None
    applicable_to_equipment_types: Optional[List[str]] = None

class PromoCodeCreate(PromoCodeBase):
    pass

class PromoCodeUpdate(BaseModel):
    code: Optional[str] = Field(None, max_length=50)
    description: Optional[str] = None
    discount_percentage: Optional[float] = Field(None, gt=0, le=50)
    is_active: Optional[bool] = None
    valid_from: Optional[datetime] = None
    expires_at: Optional[datetime] = None
    max_uses: Optional[int] = Field(None, gt=0)
    max_uses_per_user: Optional[int] = Field(None, gt=0)
    min_order_amount: Optional[float] = Field(None, gt=0)
    specific_to_user_id: Optional[int] = None
    applicable_to_equipment_ids: Optional[List[int]] = None
    applicable_to_equipment_types: Optional[List[str]] = None

class PromoCodeOut(PromoCodeBase):
    id: int
    times_used: int
    created_at: datetime
    created_by_id: int
    creator_email: Optional[EmailStr] = None # Ğ”Ğ»Ñ ÑƒĞ´Ğ¾Ğ±ÑÑ‚Ğ²Ğ° Ğ¾Ñ‚Ğ¾Ğ±Ñ€Ğ°Ğ¶ĞµĞ½Ğ¸Ñ Ğ² Ğ°Ğ´Ğ¼Ğ¸Ğ½ĞºĞµ

    model_config = ConfigDict(from_attributes=True)

    @classmethod
    def from_orm(cls, obj):
        # Ğ”Ğ¾Ğ±Ğ°Ğ²Ğ»ÑĞµĞ¼ email ÑĞ¾Ğ·Ğ´Ğ°Ñ‚ĞµĞ»Ñ Ğ´Ğ»Ñ Ğ²Ñ‹Ğ²Ğ¾Ğ´Ğ°
        instance = super().from_orm(obj)
        if obj.creator:
            instance.creator_email = obj.creator.email
        return instance

# --- Ğ¡Ñ…ĞµĞ¼Ñ‹ Ğ´Ğ»Ñ Ğ¿ÑƒĞ±Ğ»Ğ¸Ñ‡Ğ½Ğ¾Ğ¹ Ğ²Ğ°Ğ»Ğ¸Ğ´Ğ°Ñ†Ğ¸Ğ¸ ---

class PromoCodeValidateRequest(BaseModel):
    code: str
    # Ğ­Ñ‚Ğ¸ Ğ¿Ğ¾Ğ»Ñ Ğ½ÑƒĞ¶Ğ½Ñ‹ Ğ´Ğ»Ñ Ğ¿Ñ€Ğ¾Ğ²ĞµÑ€ĞºĞ¸ ÑƒÑĞ»Ğ¾Ğ²Ğ¸Ğ¹ Ğ¿Ñ€Ğ¾Ğ¼Ğ¾ĞºĞ¾Ğ´Ğ°
    order_amount: float
    equipment_ids: List[int]

class PromoCodeValidateResponse(BaseModel):
    code: str
    discount_percentage: float
    message: str


class PromoCodeListResponse(BaseModel):
    items: List[PromoCodeOut]
    total: int

```


## <a name="RentalAppFASTAPIsharedschemasrentalschemapy"></a>`RentalApp_FASTAPI/shared/schemas/rental_schema.py`

```python
// path: RentalApp_FASTAPI/shared/schemas/rental_schema.py

# shared/schemas/rental_schema.py

from pydantic import BaseModel, ConfigDict, Field, field_validator
from datetime import date, datetime
from typing import List, Optional

from .user_schema import UserOut
from .equipment_schema import EquipmentOut
from .accessory_schema import AccessoryOut
from .common_financials import FinancialsBase

class RentalBase(BaseModel):
    start_date: date
    end_date: date
    deposit_amount: float = 0.0
    notes_on_issue: Optional[str] = None
    status: str

class RentalAccessoryDetail(BaseModel):
    equipment_id: int
    accessory: AccessoryOut
    model_config = ConfigDict(from_attributes=True)

class RentalOut(RentalBase, FinancialsBase):
    id: int
    user_id: int
    created_by_id: int
    reservation_id: Optional[int] = None
    actual_return_date: Optional[date] = None
    prepayment_amount: float = 0.0
    notes_on_return: Optional[str] = None
    created_at: datetime
    updated_at: datetime
    user: UserOut
    created_by: UserOut
    equipment: List[EquipmentOut]

    # Ğ˜ÑĞ¿Ğ¾Ğ»ÑŒĞ·ÑƒĞµĞ¼ Ğ¸Ğ¼Ñ Ğ¿Ğ¾Ğ»Ñ 'accessory_links' ĞºĞ°Ğº Ğ² Ğ¼Ğ¾Ğ´ĞµĞ»Ğ¸ SQLAlchemy
    # Ñ‡Ñ‚Ğ¾Ğ±Ñ‹ Ğ¸Ğ·Ğ±ĞµĞ¶Ğ°Ñ‚ÑŒ Ğ½ĞµÑĞ¾Ğ¾Ñ‚Ğ²ĞµÑ‚ÑÑ‚Ğ²Ğ¸Ğ¹ Ğ¿Ñ€Ğ¸ Ğ¿ĞµÑ€ĞµĞ´Ğ°Ñ‡Ğµ Ğ´Ğ°Ğ½Ğ½Ñ‹Ñ….
    accessory_links: List[RentalAccessoryDetail] = []

    # Ğ”Ğ¸Ğ½Ğ°Ğ¼Ğ¸Ñ‡ĞµÑĞºĞ¸ Ğ²Ñ‹Ñ‡Ğ¸ÑĞ»ÑĞµĞ¼Ñ‹Ğµ Ğ¿Ğ¾Ğ»Ñ
    days_remaining: Optional[int] = None
    overdue_days: Optional[int] = None
    overdue_surcharge: Optional[float] = None

    # Ğ£Ğ±Ğ¸Ñ€Ğ°ĞµĞ¼ populate_by_name, Ñ‚Ğ°Ğº ĞºĞ°Ğº alias Ğ±Ğ¾Ğ»ÑŒÑˆĞµ Ğ½Ğµ Ğ¸ÑĞ¿Ğ¾Ğ»ÑŒĞ·ÑƒĞµÑ‚ÑÑ
    model_config = ConfigDict(from_attributes=True)

    @field_validator('start_date', 'end_date', 'actual_return_date', mode='before')
    @classmethod
    def convert_datetime_to_date(cls, v):
        if isinstance(v, datetime):
            return v.date()
        return v

class RentalListResponse(BaseModel):
    items: List[RentalOut]
    total: int

# --- Ğ¡Ñ…ĞµĞ¼Ñ‹ Ğ´Ğ»Ñ Ğ·Ğ°Ğ¿Ñ€Ğ¾ÑĞ¾Ğ² ---

class RentalCreateFromReservationRequest(BaseModel):
    """Ğ¡Ñ…ĞµĞ¼Ğ° Ğ´Ğ»Ñ ÑĞ¾Ğ·Ğ´Ğ°Ğ½Ğ¸Ñ Ğ°Ñ€ĞµĞ½Ğ´Ñ‹ Ğ¸Ğ· Ñ€ĞµĞ·ĞµÑ€Ğ²Ğ°."""
    notes_on_issue: Optional[str] = None
    deposit_amount: float = Field(0.0, ge=0)
    prepayment_amount: float = Field(0.0, ge=0)
    force_issue_on_holiday: bool = Field(False, description="ĞŸĞ¾Ğ´Ñ‚Ğ²ĞµÑ€Ğ¶Ğ´ĞµĞ½Ğ¸Ğµ Ğ²Ñ‹Ğ´Ğ°Ñ‡Ğ¸ Ğ² Ğ²Ñ‹Ñ…Ğ¾Ğ´Ğ½Ğ¾Ğ¹ Ğ´ĞµĞ½ÑŒ")

class RentalCreateFromScratchRequest(BaseModel):
    """Ğ¡Ñ…ĞµĞ¼Ğ° Ğ´Ğ»Ñ ÑĞ¾Ğ·Ğ´Ğ°Ğ½Ğ¸Ñ Ğ°Ñ€ĞµĞ½Ğ´Ñ‹ "Ñ Ğ½ÑƒĞ»Ñ"."""
    user_id: int
    equipment_ids: List[int] = Field(..., min_length=1)
    start_date: date
    end_date: date
    notes_on_issue: Optional[str] = None
    deposit_amount: float = Field(0.0, ge=0)

class AdminRentalUpdate(BaseModel):
    """Ğ¡Ñ…ĞµĞ¼Ğ° Ğ´Ğ»Ñ Ğ¾Ğ±Ğ½Ğ¾Ğ²Ğ»ĞµĞ½Ğ¸Ñ Ğ°Ñ€ĞµĞ½Ğ´Ñ‹ Ğ°Ğ´Ğ¼Ğ¸Ğ½Ğ¸ÑÑ‚Ñ€Ğ°Ñ‚Ğ¾Ñ€Ğ¾Ğ¼."""
    end_date: Optional[date] = None
    actual_return_date: Optional[date] = None
    status: Optional[str] = None
    final_cost: Optional[float] = Field(None, ge=0)
    deposit_amount: Optional[float] = Field(None, ge=0)
    notes_on_issue: Optional[str] = None
    notes_on_return: Optional[str] = None

class RentalReturnRequest(BaseModel):
    """Ğ¡Ñ…ĞµĞ¼Ğ° Ğ´Ğ»Ñ Ğ¾Ñ„Ğ¾Ñ€Ğ¼Ğ»ĞµĞ½Ğ¸Ñ Ğ²Ğ¾Ğ·Ğ²Ñ€Ğ°Ñ‚Ğ°."""
    actual_return_date: date
    notes_on_return: Optional[str] = None
    accessories_returned_confirmation: bool = Field(..., description="ĞŸĞ¾Ğ´Ñ‚Ğ²ĞµÑ€Ğ¶Ğ´ĞµĞ½Ğ¸Ğµ, Ñ‡Ñ‚Ğ¾ Ğ²ÑĞµ Ğ°ĞºÑĞµÑÑÑƒĞ°Ñ€Ñ‹ Ğ²Ğ¾Ğ·Ğ²Ñ€Ğ°Ñ‰ĞµĞ½Ñ‹")
    # Ğ£Ğ´Ğ°Ğ»ÑĞµĞ¼ Ğ¿Ğ¾Ğ»Ñ payment_amount Ğ¸ payment_description, Ñ‚Ğ°Ğº ĞºĞ°Ğº Ğ¿Ğ»Ğ°Ñ‚ĞµĞ¶ Ğ¾Ğ±Ñ€Ğ°Ğ±Ğ°Ñ‚Ñ‹Ğ²Ğ°ĞµÑ‚ÑÑ Ğ¾Ñ‚Ğ´ĞµĞ»ÑŒĞ½Ğ¾

    @classmethod
    def today(cls):
        return cls(actual_return_date=date.today())

```


## <a name="RentalAppFASTAPIsharedschemasreservationschemapy"></a>`RentalApp_FASTAPI/shared/schemas/reservation_schema.py`

```python
// path: RentalApp_FASTAPI/shared/schemas/reservation_schema.py

# shared/schemas/reservation_schema.py

from pydantic import BaseModel, ConfigDict, Field
from datetime import date
from typing import List, Optional, Dict, Literal

from .user_schema import UserOut
from .accessory_schema import AccessoryOut
from .common_financials import FinancialsBase


class ReservationAccessoryDetail(BaseModel):
    equipment_id: int
    accessory: AccessoryOut
    model_config = ConfigDict(from_attributes=True)


class ReservationCreateRequest(BaseModel):
    equipment_ids: List[int]
    start_date: date
    end_date: date
    selected_accessories: Optional[Dict[int, List[int]]] = None
    promo_code: Optional[str] = None

class ReservationUpdateRequest(BaseModel):
    equipment_ids: List[int]
    start_date: date
    end_date: date
    selected_accessories: Optional[Dict[int, List[int]]] = None
    promo_code: Optional[str] = None
    confirm_date_adjustment: bool = False

class ReservationResponse(BaseModel):
    reservation_id: int
    message: str
    model_config = ConfigDict(from_attributes=True)

class ReservationItem(FinancialsBase):
    id: int
    user_id: int
    equipment_ids: List[int]
    start_date: date
    end_date: date
    status: Literal['active', 'fulfilled', 'cancelled', 'overdue']
    accessory_links: List[ReservationAccessoryDetail] = []
    rental_id: Optional[int] = Field(None, validation_alias='rental.id')

    model_config = ConfigDict(from_attributes=True)


class AdminReservationOut(ReservationItem):
    user_info: UserOut
    model_config = ConfigDict(from_attributes=True)

class AdminReservationCreateRequest(ReservationCreateRequest):
    user_id: int

class AdminReservationListResponse(BaseModel):
    items: List[AdminReservationOut]
    total: int

class ReservationListResponse(BaseModel):
    items: List[ReservationItem]
    total: int

class PriceCalculationRequest(BaseModel):
    equipment_ids: List[int]
    start_date: date
    end_date: date
    selected_accessories: Optional[Dict[int, List[int]]] = None
    promo_code: Optional[str] = None

class PriceCalculationResponse(BaseModel):
    day_count: int
    full_total: float
    final_total: float
    discount_amount: float
    duration_discount_percentage: int
    promo_discount_percentage: float
    promo_code_message: Optional[str] = None

class ReservationBulkDeleteRequest(BaseModel):
    """Ğ¡Ñ…ĞµĞ¼Ğ° Ğ´Ğ»Ñ Ğ·Ğ°Ğ¿Ñ€Ğ¾ÑĞ° Ğ½Ğ° Ğ¼Ğ°ÑÑĞ¾Ğ²Ğ¾Ğµ ÑƒĞ´Ğ°Ğ»ĞµĞ½Ğ¸Ğµ Ñ€ĞµĞ·ĞµÑ€Ğ²Ğ¾Ğ²."""
    reservation_ids: List[int]

```


## <a name="RentalAppFASTAPIsharedschemasuserschemapy"></a>`RentalApp_FASTAPI/shared/schemas/user_schema.py`

```python
// path: RentalApp_FASTAPI/shared/schemas/user_schema.py

# shared/schemas/user_schema.py

from pydantic import BaseModel, EmailStr, ConfigDict, validator, field_validator, Field
from typing import Optional, List, Annotated
import re
from datetime import datetime

# Ğ’ÑĞ¿Ğ¾Ğ¼Ğ¾Ğ³Ğ°Ñ‚ĞµĞ»ÑŒĞ½Ğ°Ñ Ñ„ÑƒĞ½ĞºÑ†Ğ¸Ñ Ğ²Ğ°Ğ»Ğ¸Ğ´Ğ°Ñ†Ğ¸Ğ¸, Ğ¾ÑÑ‚Ğ°ĞµÑ‚ÑÑ Ğ±ĞµĞ· Ğ¸Ğ·Ğ¼ĞµĞ½ĞµĞ½Ğ¸Ğ¹
def validate_phone_number(v: Optional[str]) -> Optional[str]:
    """Ğ’Ğ°Ğ»Ğ¸Ğ´Ğ°Ñ†Ğ¸Ñ Ğ½Ğ¾Ğ¼ĞµÑ€Ğ° Ñ‚ĞµĞ»ĞµÑ„Ğ¾Ğ½Ğ°"""
    if v is None:
        return v
    if not isinstance(v, str):
        raise ValueError('Ğ¢ĞµĞ»ĞµÑ„Ğ¾Ğ½ Ğ´Ğ¾Ğ»Ğ¶ĞµĞ½ Ğ±Ñ‹Ñ‚ÑŒ ÑÑ‚Ñ€Ğ¾ĞºĞ¾Ğ¹')

    phone_clean = re.sub(r'[^\d]', '', v)
    if len(phone_clean) < 10 or len(phone_clean) > 15:
        raise ValueError('ĞĞµĞºĞ¾Ñ€Ñ€ĞµĞºÑ‚Ğ½Ñ‹Ğ¹ Ñ„Ğ¾Ñ€Ğ¼Ğ°Ñ‚ Ñ‚ĞµĞ»ĞµÑ„Ğ¾Ğ½Ğ°')

    return v

# --- Ğ¡ÑƒÑ‰ĞµÑÑ‚Ğ²ÑƒÑÑ‰Ğ¸Ğµ ÑÑ…ĞµĞ¼Ñ‹ ---

class UserCreate(BaseModel):
    full_name: str
    email: EmailStr
    password: str
    phone: Optional[str] = None
    privacy_policy_accepted: bool = False
    terms_accepted: bool = False

    @field_validator('phone')
    @classmethod
    def validate_phone(cls, v):
        return validate_phone_number(v)

    @validator('privacy_policy_accepted')
    def validate_privacy_policy(cls, v):
        if not v:
            raise ValueError('ĞĞµĞ¾Ğ±Ñ…Ğ¾Ğ´Ğ¸Ğ¼Ğ¾ ÑĞ¾Ğ³Ğ»Ğ°ÑĞ¸Ğµ Ñ Ğ¿Ğ¾Ğ»Ğ¸Ñ‚Ğ¸ĞºĞ¾Ğ¹ Ğ¾Ğ±Ñ€Ğ°Ğ±Ğ¾Ñ‚ĞºĞ¸ Ğ¿ĞµÑ€ÑĞ¾Ğ½Ğ°Ğ»ÑŒĞ½Ñ‹Ñ… Ğ´Ğ°Ğ½Ğ½Ñ‹Ñ…')
        return v

    @validator('terms_accepted')
    def validate_terms(cls, v):
        if not v:
            raise ValueError('ĞĞµĞ¾Ğ±Ñ…Ğ¾Ğ´Ğ¸Ğ¼Ğ¾ ÑĞ¾Ğ³Ğ»Ğ°ÑĞ¸Ğµ Ñ ÑƒÑĞ»Ğ¾Ğ²Ğ¸ÑĞ¼Ğ¸ Ğ¸ÑĞ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ')
        return v

class AdminUserCreate(UserCreate):
    role: str = "user"

class AdminUserUpdate(BaseModel):
    full_name: Optional[str] = None
    phone: Optional[str] = None
    status: Optional[str] = None
    balance: Optional[float] = None
    notes: Optional[str] = None
    role: Optional[str] = None
    privacy_policy_accepted: Optional[bool] = None
    terms_accepted: Optional[bool] = None
    email_verified: Optional[bool] = None

    @field_validator('phone')
    @classmethod
    def validate_phone(cls, v):
        return validate_phone_number(v)

class UserUpdate(BaseModel):
    full_name: Optional[str] = None
    email: Optional[EmailStr] = None
    phone: Optional[str] = None

    @field_validator('phone')
    @classmethod
    def validate_phone(cls, v):
        return validate_phone_number(v)


class UserOut(BaseModel):
    id: int
    full_name: str
    email: EmailStr
    role: str
    is_active: bool
    phone: Optional[str] = None
    status: Optional[str] = None
    balance: float
    notes: Optional[str] = None
    privacy_policy_accepted: bool
    terms_accepted: bool
    email_verified: bool
    created_at: datetime

    model_config = ConfigDict(from_attributes=True)


class Token(BaseModel):
    access_token: str
    token_type: str


class UserListResponse(BaseModel):
    items: List[UserOut]
    total: int

# +++ ĞĞĞ§ĞĞ›Ğ: ĞĞĞ’ĞĞ¯ Ğ¡Ğ¥Ğ•ĞœĞ Ğ”Ğ›Ğ¯ ĞŸĞ Ğ˜Ğ•ĞœĞ ĞŸĞ›ĞĞ¢Ğ•Ğ–Ğ +++
class UserPaymentRequest(BaseModel):
    amount: float = Field(..., gt=0, description="Ğ¡ÑƒĞ¼Ğ¼Ğ° Ğ¿Ğ»Ğ°Ñ‚ĞµĞ¶Ğ°")
    payment_method: str = Field(..., description="ĞœĞµÑ‚Ğ¾Ğ´ Ğ¾Ğ¿Ğ»Ğ°Ñ‚Ñ‹ (Ğ½Ğ°Ğ»Ğ¸Ñ‡Ğ½Ñ‹Ğµ, ĞºĞ°Ñ€Ñ‚Ğ° Ğ¸ Ñ‚.Ğ´.)")
    description: Optional[str] = None
# +++ ĞšĞĞĞ•Ğ¦: ĞĞĞ’ĞĞ¯ Ğ¡Ğ¥Ğ•ĞœĞ Ğ”Ğ›Ğ¯ ĞŸĞ Ğ˜Ğ•ĞœĞ ĞŸĞ›ĞĞ¢Ğ•Ğ–Ğ +++

```


## <a name="RentalAppFASTAPIsmartpythoncodeFastAPImd"></a>`RentalApp_FASTAPI/smart_python_code_FastAPI.md`

```markdown
// path: RentalApp_FASTAPI/smart_python_code_FastAPI.md

# Ğ¡Ğ¶Ğ°Ñ‚Ñ‹Ğ¹ Ğ¸ÑÑ…Ğ¾Ğ´Ğ½Ñ‹Ğ¹ ĞºĞ¾Ğ´ Ğ¿Ñ€Ğ¾ĞµĞºÑ‚Ğ° Ğ´Ğ»Ñ AI-Ğ¿Ğ¾Ğ¼Ğ¾Ñ‰Ğ½Ğ¸ĞºĞ°

# Ğ¡Ñ‚Ñ€ÑƒĞºÑ‚ÑƒÑ€Ğ° Ğ¿Ñ€Ğ¾ĞµĞºÑ‚Ğ°

- âœ… `api\accessory_api.py`
- âœ… `api\admin_dashboard_api.py`
- âœ… `api\admin_rental_api.py`
- âœ… `api\admin_reservation_api.py`
- âœ… `api\association_api.py`
- âœ… `api\auth_api.py`
- âœ… `api\calendar_api.py`
- âœ… `api\database.py`
- âœ… `api\deps.py`
- âœ… `api\discount_api.py`
- âœ… `api\equipment_api.py`
- âœ… `api\holiday_api.py`
- âœ… `api\init_models.py`
- âœ… `api\main_api.py`
- âœ… `api\models\accessory.py`
- âœ… `api\models\association.py`
- âœ… `api\models\balance_history.py`
- âœ… `api\models\discount.py`
- âœ… `api\models\equipment.py`
- âœ… `api\models\holiday.py`
- âœ… `api\models\payment.py`
- âœ… `api\models\promo_code.py`
- âœ… `api\models\rental.py`
- âœ… `api\models\reservation.py`
- âœ… `api\models\user.py`
- âœ… `api\permissions.py`
- âœ… `api\promo_code_api.py`
- âœ… `api\reservation_api.py`
- âœ… `api\router.py`
- âœ… `api\services\auth_service.py`
- âœ… `api\services\availability\availability_service.py`
- âœ… `api\services\availability\base.py`
- âœ… `api\services\availability\calendar.py`
- âœ… `api\services\availability\conflicts.py`
- âœ… `api\services\availability\queries.py`
- âœ… `api\services\availability\statuses.py`
- âœ… `api\services\balance_service.py`
- âœ… `api\services\dashboard\activity_service.py`
- âœ… `api\services\dashboard\base.py`
- âœ… `api\services\dashboard\dashboard_service.py`
- âœ… `api\services\dashboard\equipment_service.py`
- âœ… `api\services\dashboard\focus_service.py`
- âœ… `api\services\dashboard\kpi_service.py`
- âœ… `api\services\dashboard_service.py`
- âœ… `api\services\discount_service.py`
- âœ… `api\services\equipment_query_builder.py`
- âœ… `api\services\equipment_service_api.py`
- âœ… `api\services\financial_service.py`
- âœ… `api\services\order\order_lifecycle_service.py`
- âœ… `api\services\order\order_query_base.py`
- âœ… `api\services\order\order_repository.py`
- âœ… `api\services\order\order_validator.py`
- âœ… `api\services\promo_code\constants.py`
- âœ… `api\services\promo_code\exceptions.py`
- âœ… `api\services\promo_code\factory.py`
- âœ… `api\services\promo_code\interfaces.py`
- âœ… `api\services\promo_code\promo_code_business_logic.py`
- âœ… `api\services\promo_code\promo_code_manager.py`
- âœ… `api\services\promo_code\promo_code_validator.py`
- âœ… `api\services\promo_code_service.py`
- âœ… `api\services\rental\rental_query_service.py`
- âœ… `api\services\reservation_query_service.py`
- âœ… `api\services\user_service.py`
- âœ… `api\user_api.py`
- âœ… `db\init_db.py`
- âœ… `requirements.txt`
- âœ… `shared\schemas\accessory_schema.py`
- âœ… `shared\schemas\association_schema.py`
- âœ… `shared\schemas\balance_history_schema.py`
- âœ… `shared\schemas\calendar_schema.py`
- âœ… `shared\schemas\common_financials.py`
- âœ… `shared\schemas\dashboard_schema.py`
- âœ… `shared\schemas\discount_schema.py`
- âœ… `shared\schemas\equipment_schema.py`
- âœ… `shared\schemas\holiday_schema.py`
- âœ… `shared\schemas\promo_code_schema.py`
- âœ… `shared\schemas\rental_schema.py`
- âœ… `shared\schemas\reservation_schema.py`
- âœ… `shared\schemas\user_schema.py`

---


## `api\accessory_api.py`


```python

# api/accessory_api.py

from fastapi import APIRouter, Depends, HTTPException, Query
from sqlalchemy.ext.asyncio import AsyncSession
from sqlalchemy import select, func, or_
from typing import List

from api.deps import get_db
from api.models.user import User
from api.models.accessory import Accessory
from api.models.reservation import ReservationAccessory, Reservation
from api.models.rental import RentalAccessory, Rental
from api.permissions import require_manager
from shared.schemas.accessory_schema import AccessoryCreate, AccessoryUpdate, AccessoryOut, AccessoryListResponse
from fastapi_csrf_protect import CsrfProtect

router = APIRouter(prefix="/accessories", tags=["ĞĞºÑĞµÑÑÑƒĞ°Ñ€Ñ‹"])

@router.post("/", response_model=AccessoryOut, status_code=201)
async def create_accessory(
        accessory_in: AccessoryCreate,
        db: AsyncSession = Depends(get_db),
        current_user: User = Depends(require_manager),
        csrf_protect: CsrfProtect = Depends()
):
    """Ğ¡Ğ¾Ğ·Ğ´Ğ°Ñ‚ÑŒ Ğ½Ğ¾Ğ²Ñ‹Ğ¹ Ğ°ĞºÑĞµÑÑÑƒĞ°Ñ€ (Ñ‚Ğ¾Ğ»ÑŒĞºĞ¾ Ğ´Ğ»Ñ Ğ¼ĞµĞ½ĞµĞ´Ğ¶ĞµÑ€Ğ¾Ğ²/Ğ°Ğ´Ğ¼Ğ¸Ğ½Ğ¾Ğ²)"""
    new_accessory = Accessory(**accessory_in.model_dump())
    db.add(new_accessory)
    await db.commit()
    
    # Ğ’Ğ¾Ğ·Ğ²Ñ€Ğ°Ñ‰Ğ°ĞµĞ¼ ÑĞ¾Ğ·Ğ´Ğ°Ğ½Ğ½Ñ‹Ğ¹ Ğ¾Ğ±ÑŠĞµĞºÑ‚ Ğ±ĞµĞ· Ğ¿Ğ¾Ğ²Ñ‚Ğ¾Ñ€Ğ½Ğ¾Ğ³Ğ¾ Ğ·Ğ°Ğ¿Ñ€Ğ¾ÑĞ° Ğº Ğ‘Ğ”
    return new_accessory

@router.get("/", response_model=AccessoryListResponse)
async def get_all_accessories(
        db: AsyncSession = Depends(get_db),
        skip: int = Query(0, ge=0, description="Ğ¡ĞºĞ¾Ğ»ÑŒĞºĞ¾ Ğ·Ğ°Ğ¿Ğ¸ÑĞµĞ¹ Ğ¿Ñ€Ğ¾Ğ¿ÑƒÑÑ‚Ğ¸Ñ‚ÑŒ"),
        limit: int = Query(10, ge=1, le=500, description="ĞœĞ°ĞºÑĞ¸Ğ¼Ğ°Ğ»ÑŒĞ½Ğ¾Ğµ ĞºĞ¾Ğ»Ğ¸Ñ‡ĞµÑÑ‚Ğ²Ğ¾ Ğ·Ğ°Ğ¿Ğ¸ÑĞµĞ¹ Ğ½Ğ° ÑÑ‚Ñ€Ğ°Ğ½Ğ¸Ñ†Ğµ")
):
    """ĞŸĞ¾Ğ»ÑƒÑ‡Ğ¸Ñ‚ÑŒ ÑĞ¿Ğ¸ÑĞ¾Ğº Ğ²ÑĞµÑ… Ğ°ĞºÑĞµÑÑÑƒĞ°Ñ€Ğ¾Ğ² Ñ Ğ¿Ğ°Ğ³Ğ¸Ğ½Ğ°Ñ†Ğ¸ĞµĞ¹"""
    # 1. Ğ—Ğ°Ğ¿Ñ€Ğ¾Ñ Ğ´Ğ»Ñ Ğ¿Ğ¾Ğ»ÑƒÑ‡ĞµĞ½Ğ¸Ñ Ğ¾Ğ±Ñ‰ĞµĞ³Ğ¾ ĞºĞ¾Ğ»Ğ¸Ñ‡ĞµÑÑ‚Ğ²Ğ° Ğ°ĞºÑĞµÑÑÑƒĞ°Ñ€Ğ¾Ğ²
    total_result = await db.execute(select(func.count(Accessory.id)))
    total_accessories = total_result.scalar_one()

    # 2. Ğ—Ğ°Ğ¿Ñ€Ğ¾Ñ Ğ´Ğ»Ñ Ğ¿Ğ¾Ğ»ÑƒÑ‡ĞµĞ½Ğ¸Ñ "ÑÑ‚Ñ€Ğ°Ğ½Ğ¸Ñ†Ñ‹" Ğ°ĞºÑĞµÑÑÑƒĞ°Ñ€Ğ¾Ğ²
    accessories_result = await db.execute(
        select(Accessory).order_by(Accessory.name).offset(skip).limit(limit)
    )
    accessories_orm = accessories_result.scalars().all()

    # 3. Ğ¤Ğ¾Ñ€Ğ¼Ğ¸Ñ€ÑƒĞµĞ¼ Ğ¸ Ğ²Ğ¾Ğ·Ğ²Ñ€Ğ°Ñ‰Ğ°ĞµĞ¼ Ğ½Ğ¾Ğ²Ñ‹Ğ¹ Ğ¾Ğ±ÑŠĞµĞºÑ‚ Ğ¾Ñ‚Ğ²ĞµÑ‚Ğ°
    return AccessoryListResponse(
        items=[AccessoryOut.from_orm(accessory) for accessory in accessories_orm],
        total=total_accessories
    )

@router.get("/{accessory_id}", response_model=AccessoryOut)
async def get_accessory_by_id(accessory_id: int, db: AsyncSession = Depends(get_db)):
    """ĞŸĞ¾Ğ»ÑƒÑ‡Ğ¸Ñ‚ÑŒ Ğ°ĞºÑĞµÑÑÑƒĞ°Ñ€ Ğ¿Ğ¾ ID"""
    result = await db.execute(select(Accessory).filter(Accessory.id == accessory_id))
    accessory = result.scalars().first()
    if not accessory:
        raise HTTPException(status_code=404, detail="ĞĞºÑĞµÑÑÑƒĞ°Ñ€ Ğ½Ğµ Ğ½Ğ°Ğ¹Ğ´ĞµĞ½")
    return accessory

@router.put("/{accessory_id}", response_model=AccessoryOut)
async def update_accessory(
        accessory_id: int,
        accessory_in: AccessoryUpdate,
        db: AsyncSession = Depends(get_db),
        current_user: User = Depends(require_manager),
        csrf_protect: CsrfProtect = Depends()
):
    """ĞĞ±Ğ½Ğ¾Ğ²Ğ¸Ñ‚ÑŒ Ğ°ĞºÑĞµÑÑÑƒĞ°Ñ€ (Ñ‚Ğ¾Ğ»ÑŒĞºĞ¾ Ğ´Ğ»Ñ Ğ¼ĞµĞ½ĞµĞ´Ğ¶ĞµÑ€Ğ¾Ğ²/Ğ°Ğ´Ğ¼Ğ¸Ğ½Ğ¾Ğ²)"""
    result = await db.execute(select(Accessory).filter(Accessory.id == accessory_id))
    accessory = result.scalars().first()
    if not accessory:
        raise HTTPException(status_code=404, detail="ĞĞºÑĞµÑÑÑƒĞ°Ñ€ Ğ½Ğµ Ğ½Ğ°Ğ¹Ğ´ĞµĞ½")

    update_data = accessory_in.model_dump(exclude_unset=True)
    for key, value in update_data.items():
        setattr(accessory, key, value)

    await db.commit()
    
    # Ğ’Ğ¾Ğ·Ğ²Ñ€Ğ°Ñ‰Ğ°ĞµĞ¼ Ğ¾Ğ±Ğ½Ğ¾Ğ²Ğ»ĞµĞ½Ğ½Ñ‹Ğ¹ Ğ¾Ğ±ÑŠĞµĞºÑ‚ Ğ±ĞµĞ· Ğ¿Ğ¾Ğ²Ñ‚Ğ¾Ñ€Ğ½Ğ¾Ğ³Ğ¾ Ğ·Ğ°Ğ¿Ñ€Ğ¾ÑĞ° Ğº Ğ‘Ğ”
    return accessory

@router.delete("/{accessory_id}", status_code=204)
async def delete_accessory(
        accessory_id: int,
        db: AsyncSession = Depends(get_db),
        current_user: User = Depends(require_manager),
        csrf_protect: CsrfProtect = Depends()
):
    """Ğ£Ğ´Ğ°Ğ»Ğ¸Ñ‚ÑŒ Ğ°ĞºÑĞµÑÑÑƒĞ°Ñ€ (Ñ‚Ğ¾Ğ»ÑŒĞºĞ¾ Ğ´Ğ»Ñ Ğ¼ĞµĞ½ĞµĞ´Ğ¶ĞµÑ€Ğ¾Ğ²/Ğ°Ğ´Ğ¼Ğ¸Ğ½Ğ¾Ğ²)"""
    result = await db.execute(select(Accessory).filter(Accessory.id == accessory_id))
    accessory = result.scalars().first()
    if not accessory:
        raise HTTPException(status_code=404, detail="ĞĞºÑĞµÑÑÑƒĞ°Ñ€ Ğ½Ğµ Ğ½Ğ°Ğ¹Ğ´ĞµĞ½")

    # ĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑĞµĞ¼ Ğ°ĞºÑ‚Ğ¸Ğ²Ğ½Ñ‹Ğµ Ñ€ĞµĞ·ĞµÑ€Ğ²Ñ‹
    active_reservations_query = (
        select(func.count(Reservation.id))
        .join(ReservationAccessory, Reservation.id == ReservationAccessory.reservation_id)
        .where(ReservationAccessory.accessory_id == accessory_id)
        .where(Reservation.status == 'active')
    )
    active_reservations_count = (await db.execute(active_reservations_query)).scalar_one()

    # ĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑĞµĞ¼ Ğ°ĞºÑ‚Ğ¸Ğ²Ğ½Ñ‹Ğµ Ğ°Ñ€ĞµĞ½Ğ´Ñ‹
    active_rentals_query = (
        select(func.count(Rental.id))
        .join(RentalAccessory, Rental.id == RentalAccessory.rental_id)
        .where(RentalAccessory.accessory_id == accessory_id)
        .where(or_(Rental.status == 'active', Rental.status == 'overdue'))
    )
    active_rentals_count = (await db.execute(active_rentals_query)).scalar_one()

    if active_reservations_count > 0 or active_rentals_count > 0:
        error_detail = (
            f"ĞĞµĞ²Ğ¾Ğ·Ğ¼Ğ¾Ğ¶Ğ½Ğ¾ ÑƒĞ´Ğ°Ğ»Ğ¸Ñ‚ÑŒ Ğ°ĞºÑĞµÑÑÑƒĞ°Ñ€. ĞĞ½ Ğ¸ÑĞ¿Ğ¾Ğ»ÑŒĞ·ÑƒĞµÑ‚ÑÑ Ğ² "
            f"{active_reservations_count} Ğ°ĞºÑ‚Ğ¸Ğ²Ğ½Ñ‹Ñ… Ñ€ĞµĞ·ĞµÑ€Ğ²Ğ°Ñ… Ğ¸ "
            f"{active_rentals_count} Ğ°ĞºÑ‚Ğ¸Ğ²Ğ½Ñ‹Ñ… Ğ°Ñ€ĞµĞ½Ğ´Ğ°Ñ…."
        )
        raise HTTPException(status_code=409, detail=error_detail)

    await db.delete(accessory)
    await db.commit()
    return None

```



## `api\admin_dashboard_api.py`


```python

# api/admin_dashboard_api.py

from fastapi import APIRouter, Depends
from sqlalchemy.ext.asyncio import AsyncSession

from api.deps import get_dashboard_service
from api.permissions import require_manager
from api.models.user import User
from api.services.dashboard_service import DashboardService
from shared.schemas.dashboard_schema import DashboardSummaryResponse

router = APIRouter(prefix="/admin", tags=["admin-dashboard"])

@router.get("/dashboard-summary", response_model=DashboardSummaryResponse)
async def get_dashboard_summary(
    current_user: User = Depends(require_manager),
    dashboard_service: DashboardService = Depends(get_dashboard_service)
) -> DashboardSummaryResponse:
    """
    ĞŸĞ¾Ğ»ÑƒÑ‡Ğ°ĞµÑ‚ ÑĞ²Ğ¾Ğ´Ğ½ÑƒÑ Ğ¸Ğ½Ñ„Ğ¾Ñ€Ğ¼Ğ°Ñ†Ğ¸Ñ Ğ´Ğ»Ñ Ğ¿Ğ°Ğ½ĞµĞ»Ğ¸ ÑƒĞ¿Ñ€Ğ°Ğ²Ğ»ĞµĞ½Ğ¸Ñ Ğ°Ğ´Ğ¼Ğ¸Ğ½ĞºĞ¸.
    
    Ğ’Ğ¾Ğ·Ğ²Ñ€Ğ°Ñ‰Ğ°ĞµÑ‚ Ğ°Ğ³Ñ€ĞµĞ³Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ½Ñ‹Ğµ Ğ´Ğ°Ğ½Ğ½Ñ‹Ğµ Ğ²ĞºĞ»ÑÑ‡Ğ°Ñ:
    - Ğ—Ğ°Ğ´Ğ°Ñ‡Ğ¸ Ğ½Ğ° ÑĞµĞ³Ğ¾Ğ´Ğ½Ñ (Ğ²Ñ‹Ğ´Ğ°Ñ‡Ğ¸, Ğ²Ğ¾Ğ·Ğ²Ñ€Ğ°Ñ‚Ñ‹, Ğ¿Ñ€Ğ¾ÑÑ€Ğ¾Ñ‡ĞºĞ¸)
    - ĞšĞ»ÑÑ‡ĞµĞ²Ñ‹Ğµ Ğ¿Ğ¾ĞºĞ°Ğ·Ğ°Ñ‚ĞµĞ»Ğ¸ (Ğ´Ğ¾Ñ…Ğ¾Ğ´, Ğ½Ğ¾Ğ²Ñ‹Ğµ Ğ°Ñ€ĞµĞ½Ğ´Ñ‹, ĞºĞ¾ÑÑ„Ñ„Ğ¸Ñ†Ğ¸ĞµĞ½Ñ‚ Ğ¸ÑĞ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ, Ğ½Ğ¾Ğ²Ñ‹Ğµ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ğ¸)
    - ĞŸĞ¾ÑĞ»ĞµĞ´Ğ½Ğ¸Ğµ ÑĞ¾Ğ±Ñ‹Ñ‚Ğ¸Ñ Ğ² ÑĞ¸ÑÑ‚ĞµĞ¼Ğµ
    - ĞŸĞ¾Ğ¿ÑƒĞ»ÑÑ€Ğ½Ğ¾Ğµ Ğ¾Ğ±Ğ¾Ñ€ÑƒĞ´Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ
    """
    return await dashboard_service.get_summary()

```



## `api\admin_rental_api.py`


```python

# api/admin_rental_api.py

from fastapi import APIRouter, Depends, Query, Response, status

from api.deps import get_order_lifecycle_service, get_rental_query_service
from api.permissions import require_manager, require_admin
from api.models.user import User
from api.services.rental.rental_query_service import RentalQueryService
from api.services.order.order_lifecycle_service import OrderLifecycleService
from shared.schemas.rental_schema import (
    RentalOut, RentalListResponse, RentalCreateFromReservationRequest,
    RentalReturnRequest, RentalCreateFromScratchRequest,
    AdminRentalUpdate
)

router = APIRouter(prefix="/admin/rentals", tags=["ĞĞ´Ğ¼Ğ¸Ğ½Ğ¸ÑÑ‚Ñ€Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ ĞÑ€ĞµĞ½Ğ´"])


@router.get("/", response_model=RentalListResponse)
async def get_all_rentals(
        current_user: User = Depends(require_manager),
        query_service: RentalQueryService = Depends(get_rental_query_service),
        status: str = Query(None, description="Ğ¤Ğ¸Ğ»ÑŒÑ‚Ñ€ Ğ¿Ğ¾ ÑÑ‚Ğ°Ñ‚ÑƒÑÑƒ: active, overdue, completed"),
        search: str = Query(None, description="ĞŸĞ¾Ğ¸ÑĞº Ğ¿Ğ¾ Ğ¸Ğ¼ĞµĞ½Ğ¸ Ğ¸Ğ»Ğ¸ email ĞºĞ»Ğ¸ĞµĞ½Ñ‚Ğ°"),
        skip: int = Query(0, ge=0),
        limit: int = Query(10, ge=1, le=100)
):
    """ĞŸĞ¾Ğ»ÑƒÑ‡Ğ¸Ñ‚ÑŒ ÑĞ¿Ğ¸ÑĞ¾Ğº Ğ²ÑĞµÑ… Ğ°Ñ€ĞµĞ½Ğ´ Ñ Ñ„Ğ¸Ğ»ÑŒÑ‚Ñ€Ğ°Ñ†Ğ¸ĞµĞ¹ Ğ¸ Ğ¿Ğ°Ğ³Ğ¸Ğ½Ğ°Ñ†Ğ¸ĞµĞ¹."""
    rentals_out, total = await query_service.get_paginated_rentals(skip, limit, status, search)
    return RentalListResponse(
        items=rentals_out,
        total=total
    )


@router.post("/", response_model=RentalOut)
async def create_rental_from_scratch(
        request: RentalCreateFromScratchRequest,
        current_user: User = Depends(require_manager),
        service: OrderLifecycleService = Depends(get_order_lifecycle_service)
):
    """Ğ¡Ğ¾Ğ·Ğ´Ğ°Ñ‚ÑŒ Ğ½Ğ¾Ğ²ÑƒÑ Ğ°Ñ€ĞµĞ½Ğ´Ñƒ Ğ±ĞµĞ· Ğ¿Ñ€ĞµĞ´Ğ²Ğ°Ñ€Ğ¸Ñ‚ĞµĞ»ÑŒĞ½Ğ¾Ğ³Ğ¾ Ñ€ĞµĞ·ĞµÑ€Ğ²Ğ°."""
    new_rental_orm = await service.create_rental_from_scratch(request, current_user)
    return RentalOut.model_validate(new_rental_orm)


@router.put("/{rental_id}", response_model=RentalOut)
async def update_rental_details(
        rental_id: int,
        request: AdminRentalUpdate,
        current_user: User = Depends(require_manager),
        service: OrderLifecycleService = Depends(get_order_lifecycle_service)
):
    """ĞĞ±Ğ½Ğ¾Ğ²Ğ¸Ñ‚ÑŒ Ğ´ĞµÑ‚Ğ°Ğ»Ğ¸ ÑÑƒÑ‰ĞµÑÑ‚Ğ²ÑƒÑÑ‰ĞµĞ¹ Ğ°Ñ€ĞµĞ½Ğ´Ñ‹."""
    updated_rental_orm = await service.update_rental_details_by_admin(rental_id, request, current_user)
    return RentalOut.model_validate(updated_rental_orm)


@router.post("/from-reservation/{reservation_id}", response_model=RentalOut)
async def convert_reservation_to_rental(
        reservation_id: int,
        request: RentalCreateFromReservationRequest,
        current_user: User = Depends(require_manager),
        service: OrderLifecycleService = Depends(get_order_lifecycle_service)
):
    """ĞšĞ¾Ğ½Ğ²ĞµÑ€Ñ‚Ğ¸Ñ€Ğ¾Ğ²Ğ°Ñ‚ÑŒ Ñ€ĞµĞ·ĞµÑ€Ğ² Ğ² Ğ°Ñ€ĞµĞ½Ğ´Ñƒ."""
    new_rental_orm = await service.convert_reservation_to_rental(reservation_id, request, current_user)
    return RentalOut.model_validate(new_rental_orm)


@router.post("/{rental_id}/return", response_model=RentalOut)
async def return_rental(
        rental_id: int,
        request: RentalReturnRequest,
        current_user: User = Depends(require_manager),
        service: OrderLifecycleService = Depends(get_order_lifecycle_service)
):
    """ĞÑ„Ğ¾Ñ€Ğ¼Ğ¸Ñ‚ÑŒ Ğ²Ğ¾Ğ·Ğ²Ñ€Ğ°Ñ‚ Ğ°Ñ€ĞµĞ½Ğ´Ñ‹."""
    returned_rental_orm = await service.return_rental(rental_id, request, current_user)
    return RentalOut.model_validate(returned_rental_orm)


@router.post("/{rental_id}/revert-to-reservation", status_code=status.HTTP_204_NO_CONTENT)
async def revert_rental_to_reservation(
        rental_id: int,
        current_user: User = Depends(require_manager),
        service: OrderLifecycleService = Depends(get_order_lifecycle_service)
):
    """
    ĞÑ‚Ğ¼ĞµĞ½Ğ¸Ñ‚ÑŒ Ğ²Ñ‹Ğ´Ğ°Ñ‡Ñƒ Ğ°Ñ€ĞµĞ½Ğ´Ñ‹ Ğ¸ Ğ²ĞµÑ€Ğ½ÑƒÑ‚ÑŒ ĞµĞµ Ğ² ÑÑ‚Ğ°Ñ‚ÑƒÑ Ñ€ĞµĞ·ĞµÑ€Ğ²Ğ°.
    Ğ”Ğ¾ÑÑ‚ÑƒĞ¿Ğ½Ğ¾ Ñ‚Ğ¾Ğ»ÑŒĞºĞ¾ Ğ² Ğ´ĞµĞ½ÑŒ ÑĞ¾Ğ·Ğ´Ğ°Ğ½Ğ¸Ñ Ğ°Ñ€ĞµĞ½Ğ´Ñ‹.
    """
    await service.revert_rental_to_reservation(rental_id, current_user)
    return Response(status_code=status.HTTP_204_NO_CONTENT)


@router.delete("/{rental_id}", status_code=204)
async def delete_rental_by_admin(
        rental_id: int,
        current_user: User = Depends(require_admin),
        service: OrderLifecycleService = Depends(get_order_lifecycle_service)
):
    """Ğ£Ğ´Ğ°Ğ»Ğ¸Ñ‚ÑŒ Ğ°Ñ€ĞµĞ½Ğ´Ñƒ (Ñ‚Ğ¾Ğ»ÑŒĞºĞ¾ Ğ´Ğ»Ñ Ğ°Ğ´Ğ¼Ğ¸Ğ½Ğ¸ÑÑ‚Ñ€Ğ°Ñ‚Ğ¾Ñ€Ğ¾Ğ²)."""
    await service.delete_rental_by_admin(rental_id)
    return None

```



## `api\admin_reservation_api.py`


```python

# api/admin_reservation_api.py

from fastapi import APIRouter, Depends, Query, HTTPException, Response, status, Body
import logging

from api.deps import get_order_lifecycle_service, get_reservation_query_service
from api.permissions import require_manager
from api.models.user import User
from api.services.order.order_lifecycle_service import OrderLifecycleService
# <-- Ğ˜Ğ—ĞœĞ•ĞĞ•ĞĞ˜Ğ• Ğ—Ğ”Ğ•Ğ¡Ğ¬: Ğ˜Ğ¼Ğ¿Ğ¾Ñ€Ñ‚Ğ¸Ñ€ÑƒĞµĞ¼ Ğ½Ğ¾Ğ²Ñ‹Ğ¹ ĞµĞ´Ğ¸Ğ½Ñ‹Ğ¹ ÑĞµÑ€Ğ²Ğ¸Ñ Ğ´Ğ»Ñ Ñ‡Ñ‚ĞµĞ½Ğ¸Ñ Ğ´Ğ°Ğ½Ğ½Ñ‹Ñ…
from api.services.reservation_query_service import ReservationQueryService
# ----------------------------------------------------------------------
from shared.schemas.reservation_schema import (
    AdminReservationCreateRequest,
    ReservationResponse,
    ReservationUpdateRequest,
    AdminReservationListResponse,
    ReservationBulkDeleteRequest
)
from fastapi_csrf_protect import CsrfProtect

router = APIRouter(prefix="/admin/reservations", tags=["ĞĞ´Ğ¼Ğ¸Ğ½Ğ¸ÑÑ‚Ñ€Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ Ğ ĞµĞ·ĞµÑ€Ğ²Ğ¾Ğ²"])
logger = logging.getLogger(__name__)


@router.post("/delete-many", status_code=status.HTTP_204_NO_CONTENT)
async def delete_multiple_reservations(
        request: ReservationBulkDeleteRequest = Body(...),
        _current_user: User = Depends(require_manager),
        _csrf_protect: CsrfProtect = Depends(),
        service: OrderLifecycleService = Depends(get_order_lifecycle_service)
):
    """ĞœĞ°ÑÑĞ¾Ğ²Ğ¾ ÑƒĞ´Ğ°Ğ»Ğ¸Ñ‚ÑŒ Ñ€ĞµĞ·ĞµÑ€Ğ²Ñ‹ Ğ¿Ğ¾ Ğ¸Ñ… ID."""
    try:
        await service.bulk_cancel_admin_reservations(request.reservation_ids)
        return Response(status_code=status.HTTP_204_NO_CONTENT)
    except Exception as e:
        logger.error(f"Error during bulk deletion service call: {e}", exc_info=True)
        raise HTTPException(
            status_code=status.HTTP_500_INTERNAL_SERVER_ERROR,
            detail="Ğ’Ğ½ÑƒÑ‚Ñ€ĞµĞ½Ğ½ÑÑ Ğ¾ÑˆĞ¸Ğ±ĞºĞ° ÑĞµÑ€Ğ²ĞµÑ€Ğ° Ğ¿Ñ€Ğ¸ ÑƒĞ´Ğ°Ğ»ĞµĞ½Ğ¸Ğ¸ Ñ€ĞµĞ·ĞµÑ€Ğ²Ğ¾Ğ²."
        )

@router.get("/", response_model=AdminReservationListResponse)
async def get_all_reservations(
        _current_user: User = Depends(require_manager),
        query_service: ReservationQueryService = Depends(get_reservation_query_service),
        status: str = Query(None, description="Ğ¤Ğ¸Ğ»ÑŒÑ‚Ñ€ Ğ¿Ğ¾ ÑÑ‚Ğ°Ñ‚ÑƒÑÑƒ Ñ€ĞµĞ·ĞµÑ€Ğ²Ğ° ('active' Ğ¸Ğ»Ğ¸ 'completed')"),
        search: str = Query(None, description="ĞŸĞ¾Ğ¸ÑĞº Ğ¿Ğ¾ Ğ¸Ğ¼ĞµĞ½Ğ¸ Ğ¸Ğ»Ğ¸ email Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ñ"),
        skip: int = Query(0, ge=0, description="Ğ¡ĞºĞ¾Ğ»ÑŒĞºĞ¾ Ğ·Ğ°Ğ¿Ğ¸ÑĞµĞ¹ Ğ¿Ñ€Ğ¾Ğ¿ÑƒÑÑ‚Ğ¸Ñ‚ÑŒ"),
        limit: int = Query(10, ge=1, le=100, description="ĞœĞ°ĞºÑĞ¸Ğ¼Ğ°Ğ»ÑŒĞ½Ğ¾Ğµ ĞºĞ¾Ğ»Ğ¸Ñ‡ĞµÑÑ‚Ğ²Ğ¾ Ğ·Ğ°Ğ¿Ğ¸ÑĞµĞ¹ Ğ½Ğ° ÑÑ‚Ñ€Ğ°Ğ½Ğ¸Ñ†Ğµ")
):
    """ĞŸĞ¾Ğ»ÑƒÑ‡Ğ¸Ñ‚ÑŒ Ğ²ÑĞµ Ñ€ĞµĞ·ĞµÑ€Ğ²Ñ‹ Ñ Ğ¸Ğ½Ñ„Ğ¾Ñ€Ğ¼Ğ°Ñ†Ğ¸ĞµĞ¹ Ğ¾ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ÑÑ… Ñ Ğ¿Ğ°Ğ³Ğ¸Ğ½Ğ°Ñ†Ğ¸ĞµĞ¹."""
    total_reservations = await query_service.get_admin_reservations_count(status=status, search_query=search)
    paginated_reservations = await query_service.get_paginated_admin_reservations(
        skip=skip,
        limit=limit,
        status=status,
        search_query=search
    )
    return AdminReservationListResponse(
        items=paginated_reservations,
        total=total_reservations
    )

@router.post("/", response_model=ReservationResponse)
async def create_reservation_for_user(
        request: AdminReservationCreateRequest,
        _current_user: User = Depends(require_manager),
        _csrf_protect: CsrfProtect = Depends(),
        service: OrderLifecycleService = Depends(get_order_lifecycle_service)
):
    """Ğ¡Ğ¾Ğ·Ğ´Ğ°Ñ‚ÑŒ Ñ€ĞµĞ·ĞµÑ€Ğ² Ğ´Ğ»Ñ ĞºĞ¾Ğ½ĞºÑ€ĞµÑ‚Ğ½Ğ¾Ğ³Ğ¾ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ñ."""
    new_reservation = await service.create_admin_reservation(request)
    return ReservationResponse(reservation_id=new_reservation.id, message="Ğ ĞµĞ·ĞµÑ€Ğ² ÑƒÑĞ¿ĞµÑˆĞ½Ğ¾ ÑĞ¾Ğ·Ğ´Ğ°Ğ½")

@router.put("/{reservation_id}", response_model=ReservationResponse)
async def update_any_reservation(
        reservation_id: int,
        data: ReservationUpdateRequest,
        _current_user: User = Depends(require_manager),
        _csrf_protect: CsrfProtect = Depends(),
        service: OrderLifecycleService = Depends(get_order_lifecycle_service)
):
    """ĞĞ±Ğ½Ğ¾Ğ²Ğ¸Ñ‚ÑŒ Ğ»ÑĞ±Ğ¾Ğ¹ Ñ€ĞµĞ·ĞµÑ€Ğ² Ğ¿Ğ¾ ĞµĞ³Ğ¾ ID."""
    updated_reservation = await service.update_admin_reservation(reservation_id, data)
    return ReservationResponse(reservation_id=updated_reservation.id, message="Ğ ĞµĞ·ĞµÑ€Ğ² ÑƒÑĞ¿ĞµÑˆĞ½Ğ¾ Ğ¾Ğ±Ğ½Ğ¾Ğ²Ğ»ĞµĞ½")

@router.delete("/{reservation_id}", status_code=204)
async def delete_any_reservation(
        reservation_id: int,
        _current_user: User = Depends(require_manager),
        _csrf_protect: CsrfProtect = Depends(),
        service: OrderLifecycleService = Depends(get_order_lifecycle_service)
):
    """Ğ£Ğ´Ğ°Ğ»Ğ¸Ñ‚ÑŒ Ğ»ÑĞ±Ğ¾Ğ¹ Ñ€ĞµĞ·ĞµÑ€Ğ² Ğ¿Ğ¾ ĞµĞ³Ğ¾ ID."""
    await service.cancel_admin_reservation(reservation_id)
    return None

```



## `api\association_api.py`


```python

# api/association_api.py

from fastapi import APIRouter, Depends, HTTPException, Query
from sqlalchemy.ext.asyncio import AsyncSession
from sqlalchemy import select, func
from sqlalchemy.orm import selectinload
from typing import List

from api.deps import get_db
from api.models.user import User
from api.models.association import Association
from api.models.equipment import Equipment
from api.permissions import require_manager
from shared.schemas.association_schema import AssociationCreate, AssociationUpdate, AssociationOut, AssociationListResponse
from fastapi_csrf_protect import CsrfProtect

router = APIRouter(prefix="/associations", tags=["ĞÑÑĞ¾Ñ†Ğ¸Ğ°Ñ†Ğ¸Ğ¸"])

@router.get("/", response_model=AssociationListResponse)
async def get_all_associations(
        db: AsyncSession = Depends(get_db),
        skip: int = Query(0, ge=0, description="Ğ¡ĞºĞ¾Ğ»ÑŒĞºĞ¾ Ğ·Ğ°Ğ¿Ğ¸ÑĞµĞ¹ Ğ¿Ñ€Ğ¾Ğ¿ÑƒÑÑ‚Ğ¸Ñ‚ÑŒ"),
        limit: int = Query(10, ge=1, le=100, description="ĞœĞ°ĞºÑĞ¸Ğ¼Ğ°Ğ»ÑŒĞ½Ğ¾Ğµ ĞºĞ¾Ğ»Ğ¸Ñ‡ĞµÑÑ‚Ğ²Ğ¾ Ğ·Ğ°Ğ¿Ğ¸ÑĞµĞ¹ Ğ½Ğ° ÑÑ‚Ñ€Ğ°Ğ½Ğ¸Ñ†Ğµ")
):
    """
    ĞŸĞ¾Ğ»ÑƒÑ‡Ğ¸Ñ‚ÑŒ ÑĞ¿Ğ¸ÑĞ¾Ğº Ğ²ÑĞµÑ… Ğ°ÑÑĞ¾Ñ†Ğ¸Ğ°Ñ†Ğ¸Ğ¹, Ğ¾Ñ‚ÑĞ¾Ñ€Ñ‚Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ½Ñ‹Ñ… Ğ¿Ğ¾ Ğ¿Ğ¾Ñ€ÑĞ´ĞºÑƒ Ñ Ğ¿Ğ°Ğ³Ğ¸Ğ½Ğ°Ñ†Ğ¸ĞµĞ¹.
    Ğ­Ñ‚Ğ¾Ñ‚ ÑĞ½Ğ´Ğ¿Ğ¾Ğ¸Ğ½Ñ‚ Ğ¿ÑƒĞ±Ğ»Ğ¸Ñ‡Ğ½Ñ‹Ğ¹ Ğ¸ Ğ¸ÑĞ¿Ğ¾Ğ»ÑŒĞ·ÑƒĞµÑ‚ÑÑ Ğ´Ğ»Ñ Ñ„Ğ¸Ğ»ÑŒÑ‚Ñ€Ğ¾Ğ² Ğ½Ğ° Ğ³Ğ»Ğ°Ğ²Ğ½Ğ¾Ğ¹ ÑÑ‚Ñ€Ğ°Ğ½Ğ¸Ñ†Ğµ.
    """
    # 1. Ğ—Ğ°Ğ¿Ñ€Ğ¾Ñ Ğ´Ğ»Ñ Ğ¿Ğ¾Ğ»ÑƒÑ‡ĞµĞ½Ğ¸Ñ Ğ¾Ğ±Ñ‰ĞµĞ³Ğ¾ ĞºĞ¾Ğ»Ğ¸Ñ‡ĞµÑÑ‚Ğ²Ğ° Ğ°ÑÑĞ¾Ñ†Ğ¸Ğ°Ñ†Ğ¸Ğ¹
    total_result = await db.execute(select(func.count(Association.id)))
    total_associations = total_result.scalar_one()

    # 2. Ğ—Ğ°Ğ¿Ñ€Ğ¾Ñ Ğ´Ğ»Ñ Ğ¿Ğ¾Ğ»ÑƒÑ‡ĞµĞ½Ğ¸Ñ "ÑÑ‚Ñ€Ğ°Ğ½Ğ¸Ñ†Ñ‹" Ğ°ÑÑĞ¾Ñ†Ğ¸Ğ°Ñ†Ğ¸Ğ¹
    associations_result = await db.execute(
        select(Association)
        .options(selectinload(Association.equipment))
        .order_by(Association.sort_order, Association.name)
        .offset(skip)
        .limit(limit)
    )
    associations_orm = associations_result.unique().scalars().all()

    # 3. Ğ¤Ğ¾Ñ€Ğ¼Ğ¸Ñ€ÑƒĞµĞ¼ Ğ¸ Ğ²Ğ¾Ğ·Ğ²Ñ€Ğ°Ñ‰Ğ°ĞµĞ¼ Ğ½Ğ¾Ğ²Ñ‹Ğ¹ Ğ¾Ğ±ÑŠĞµĞºÑ‚ Ğ¾Ñ‚Ğ²ĞµÑ‚Ğ°
    return AssociationListResponse(
        items=[AssociationOut.from_orm(assoc) for assoc in associations_orm],
        total=total_associations
    )

@router.post("/", response_model=AssociationOut, status_code=201)
async def create_association(
        assoc_in: AssociationCreate,
        db: AsyncSession = Depends(get_db),
        _current_user: User = Depends(require_manager),
        _csrf_protect: CsrfProtect = Depends()
):
    """Ğ¡Ğ¾Ğ·Ğ´Ğ°Ñ‚ÑŒ Ğ½Ğ¾Ğ²ÑƒÑ Ğ°ÑÑĞ¾Ñ†Ğ¸Ğ°Ñ†Ğ¸Ñ (ĞœĞµĞ½ĞµĞ´Ğ¶ĞµÑ€/ĞĞ´Ğ¼Ğ¸Ğ½)."""
    result = await db.execute(select(Association).filter(Association.name == assoc_in.name))
    if result.scalars().first():
        raise HTTPException(status_code=409, detail="ĞÑÑĞ¾Ñ†Ğ¸Ğ°Ñ†Ğ¸Ñ Ñ Ñ‚Ğ°ĞºĞ¸Ğ¼ Ğ½Ğ°Ğ·Ğ²Ğ°Ğ½Ğ¸ĞµĞ¼ ÑƒĞ¶Ğµ ÑÑƒÑ‰ĞµÑÑ‚Ğ²ÑƒĞµÑ‚.")

    new_assoc = Association(
        name=assoc_in.name,
        description=assoc_in.description,
        sort_order=assoc_in.sort_order
    )

    if assoc_in.equipment_ids:
        equipment_result = await db.execute(
            select(Equipment)
            .filter(Equipment.id.in_(assoc_in.equipment_ids))
            .options(
                selectinload(Equipment.accessories),
                selectinload(Equipment.associations)
            )
        )
        equipment = equipment_result.unique().scalars().all()
        if len(equipment) != len(set(assoc_in.equipment_ids)):
            raise HTTPException(status_code=404, detail="ĞĞ´Ğ½Ğ¾ Ğ¸Ğ»Ğ¸ Ğ½ĞµÑĞºĞ¾Ğ»ÑŒĞºĞ¾ Ğ¾Ğ±Ğ¾Ñ€ÑƒĞ´Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğ¹ Ğ½Ğµ Ğ½Ğ°Ğ¹Ğ´ĞµĞ½Ğ¾.")
        new_assoc.equipment = equipment

    db.add(new_assoc)
    await db.commit()
    
    # ĞŸĞ¾Ğ²Ñ‚Ğ¾Ñ€Ğ½Ğ¾ Ğ¿Ğ¾Ğ»ÑƒÑ‡Ğ°ĞµĞ¼ Ğ¾Ğ±ÑŠĞµĞºÑ‚ Ğ¸Ğ· Ğ‘Ğ” Ñ Ğ·Ğ°Ğ³Ñ€ÑƒĞ¶ĞµĞ½Ğ½Ñ‹Ğ¼Ğ¸ ÑĞ²ÑĞ·ÑĞ¼Ğ¸
    result = await db.execute(
        select(Association)
        .filter(Association.id == new_assoc.id)
        .options(selectinload(Association.equipment))
    )
    return result.scalars().first()

@router.put("/{assoc_id}", response_model=AssociationOut)
async def update_association(
        assoc_id: int,
        assoc_in: AssociationUpdate,
        db: AsyncSession = Depends(get_db),
        _current_user: User = Depends(require_manager),
        _csrf_protect: CsrfProtect = Depends()
):
    """ĞĞ±Ğ½Ğ¾Ğ²Ğ¸Ñ‚ÑŒ Ğ°ÑÑĞ¾Ñ†Ğ¸Ğ°Ñ†Ğ¸Ñ (ĞœĞµĞ½ĞµĞ´Ğ¶ĞµÑ€/ĞĞ´Ğ¼Ğ¸Ğ½)."""
    result = await db.execute(
        select(Association)
        .filter(Association.id == assoc_id)
        .options(selectinload(Association.equipment))
    )
    assoc = result.scalars().first()
    if not assoc:
        raise HTTPException(status_code=404, detail="ĞÑÑĞ¾Ñ†Ğ¸Ğ°Ñ†Ğ¸Ñ Ğ½Ğµ Ğ½Ğ°Ğ¹Ğ´ĞµĞ½Ğ°.")

    update_data = assoc_in.model_dump(exclude_unset=True)

    if 'equipment_ids' in update_data:
        equipment_ids = update_data.pop('equipment_ids')
        assoc.equipment.clear()
        if equipment_ids:
            equipment_result = await db.execute(
                select(Equipment)
                .filter(Equipment.id.in_(equipment_ids))
                .options(
                    selectinload(Equipment.accessories),
                    selectinload(Equipment.associations)
                )
            )
            equipment = equipment_result.unique().scalars().all()
            if len(equipment) != len(set(equipment_ids)):
                raise HTTPException(status_code=404, detail="ĞĞ´Ğ½Ğ¾ Ğ¸Ğ»Ğ¸ Ğ½ĞµÑĞºĞ¾Ğ»ÑŒĞºĞ¾ Ğ¾Ğ±Ğ¾Ñ€ÑƒĞ´Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğ¹ Ğ½Ğµ Ğ½Ğ°Ğ¹Ğ´ĞµĞ½Ğ¾.")
            assoc.equipment = equipment

    for key, value in update_data.items():
        setattr(assoc, key, value)

    await db.commit()
    
    # ĞŸĞ¾Ğ²Ñ‚Ğ¾Ñ€Ğ½Ğ¾ Ğ¿Ğ¾Ğ»ÑƒÑ‡Ğ°ĞµĞ¼ Ğ¾Ğ±ÑŠĞµĞºÑ‚ Ğ¸Ğ· Ğ‘Ğ” Ñ Ğ·Ğ°Ğ³Ñ€ÑƒĞ¶ĞµĞ½Ğ½Ñ‹Ğ¼Ğ¸ ÑĞ²ÑĞ·ÑĞ¼Ğ¸
    result = await db.execute(
        select(Association)
        .filter(Association.id == assoc_id)
        .options(selectinload(Association.equipment))
    )
    return result.scalars().first()

@router.delete("/{assoc_id}", status_code=204)
async def delete_association(
        assoc_id: int,
        db: AsyncSession = Depends(get_db),
        _current_user: User = Depends(require_manager),
        _csrf_protect: CsrfProtect = Depends()
):
    """Ğ£Ğ´Ğ°Ğ»Ğ¸Ñ‚ÑŒ Ğ°ÑÑĞ¾Ñ†Ğ¸Ğ°Ñ†Ğ¸Ñ (ĞœĞµĞ½ĞµĞ´Ğ¶ĞµÑ€/ĞĞ´Ğ¼Ğ¸Ğ½)."""
    result = await db.execute(
        select(Association)
        .filter(Association.id == assoc_id)
        .options(selectinload(Association.equipment))
    )
    assoc = result.scalars().first()
    if not assoc:
        raise HTTPException(status_code=404, detail="ĞÑÑĞ¾Ñ†Ğ¸Ğ°Ñ†Ğ¸Ñ Ğ½Ğµ Ğ½Ğ°Ğ¹Ğ´ĞµĞ½Ğ°.")

    await db.delete(assoc)
    await db.commit()
    return None

```



## `api\auth_api.py`


```python

# api/auth_api.py

from fastapi import APIRouter, Depends, HTTPException, status, Request # Request Ğ¼Ğ¾Ğ¶ĞµÑ‚ Ğ¿Ğ¾Ğ½Ğ°Ğ´Ğ¾Ğ±Ğ¸Ñ‚ÑŒÑÑ Ğ´Ğ»Ñ Ğ¾Ñ‚Ğ»Ğ°Ğ´ĞºĞ¸ CSRF
from fastapi.security import OAuth2PasswordRequestForm, OAuth2PasswordBearer
from sqlalchemy.ext.asyncio import AsyncSession
from shared.schemas.user_schema import UserCreate, Token
from api.services.auth_service import (
    create_user,
    authenticate_user,
    create_access_token,
    get_user_by_token,
)
from api.models.user import User
from api.deps import get_db
from fastapi_csrf_protect import CsrfProtect # <--- Ğ”Ğ¾Ğ±Ğ°Ğ²Ğ»ĞµĞ½ Ğ¸Ğ¼Ğ¿Ğ¾Ñ€Ñ‚

router = APIRouter(prefix="/auth", tags=["ĞÑƒÑ‚ĞµĞ½Ñ‚Ğ¸Ñ„Ğ¸ĞºĞ°Ñ†Ğ¸Ñ"])

# OAuth2PasswordBearer Ğ¾Ğ¿Ñ€ĞµĞ´ĞµĞ»ÑĞµÑ‚, Ñ‡Ñ‚Ğ¾ Ğ´Ğ»Ñ Ğ¿Ğ¾Ğ»ÑƒÑ‡ĞµĞ½Ğ¸Ñ Ñ‚Ğ¾ĞºĞµĞ½Ğ° Ğ½ÑƒĞ¶Ğ½Ğ¾ Ğ¾Ğ±Ñ€Ğ°Ñ‚Ğ¸Ñ‚ÑŒÑÑ Ğº /auth/token
# Ğ¤Ñ€Ğ¾Ğ½Ñ‚ĞµĞ½Ğ´ Ğ´Ğ¾Ğ»Ğ¶ĞµĞ½ Ğ±ÑƒĞ´ĞµÑ‚ Ñ‚Ğ°ĞºĞ¶Ğµ Ğ¾Ñ‚Ğ¿Ñ€Ğ°Ğ²Ğ¸Ñ‚ÑŒ CSRF Ñ‚Ğ¾ĞºĞµĞ½ Ğ½Ğ° ÑÑ‚Ğ¾Ñ‚ ÑĞ½Ğ´Ğ¿Ğ¾Ğ¸Ğ½Ñ‚.
oauth2_scheme = OAuth2PasswordBearer(tokenUrl="/auth/token")


@router.post("/register", status_code=status.HTTP_201_CREATED)
async def register_user(
        user_data: UserCreate,
        db: AsyncSession = Depends(get_db),
        csrf_protect: CsrfProtect = Depends() # <--- Ğ”Ğ¾Ğ±Ğ°Ğ²Ğ»ĞµĞ½Ğ° Ğ·Ğ°Ğ²Ğ¸ÑĞ¸Ğ¼Ğ¾ÑÑ‚ÑŒ CSRF
):
    # Ğ—Ğ°Ğ²Ğ¸ÑĞ¸Ğ¼Ğ¾ÑÑ‚ÑŒ Depends(CsrfProtect) Ğ°Ğ²Ñ‚Ğ¾Ğ¼Ğ°Ñ‚Ğ¸Ñ‡ĞµÑĞºĞ¸ Ğ¿Ñ€Ğ¾Ğ²ĞµÑ€Ğ¸Ñ‚ CSRF Ñ‚Ğ¾ĞºĞµĞ½ Ğ´Ğ»Ñ POST Ğ·Ğ°Ğ¿Ñ€Ğ¾ÑĞ°.
    # Ğ¤Ñ€Ğ¾Ğ½Ñ‚ĞµĞ½Ğ´ Ğ´Ğ¾Ğ»Ğ¶ĞµĞ½ Ğ¾Ñ‚Ğ¿Ñ€Ğ°Ğ²Ğ¸Ñ‚ÑŒ CSRF Ñ‚Ğ¾ĞºĞµĞ½, Ğ¿Ğ¾Ğ»ÑƒÑ‡ĞµĞ½Ğ½Ñ‹Ğ¹ Ğ¸Ğ· cookie (Ğ¾Ğ±Ñ‹Ñ‡Ğ½Ğ¾ 'fastapi-csrf-token'),
    # Ğ² Ğ·Ğ°Ğ³Ğ¾Ğ»Ğ¾Ğ²ĞºĞµ 'X-CSRF-Token'.
    user = await create_user(db, user_data)
    return {"message": "ĞŸĞ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ÑŒ ÑƒÑĞ¿ĞµÑˆĞ½Ğ¾ Ğ·Ğ°Ñ€ĞµĞ³Ğ¸ÑÑ‚Ñ€Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½", "email": user.email}


@router.post("/token", response_model=Token)
async def login(
        form_data: OAuth2PasswordRequestForm = Depends(),
        db: AsyncSession = Depends(get_db),
        csrf_protect: CsrfProtect = Depends() # <--- Ğ”Ğ¾Ğ±Ğ°Ğ²Ğ»ĞµĞ½Ğ° Ğ·Ğ°Ğ²Ğ¸ÑĞ¸Ğ¼Ğ¾ÑÑ‚ÑŒ CSRF
):
    # Ğ—Ğ°Ğ²Ğ¸ÑĞ¸Ğ¼Ğ¾ÑÑ‚ÑŒ Depends(CsrfProtect) Ñ‚Ğ°ĞºĞ¶Ğµ Ğ°Ğ²Ñ‚Ğ¾Ğ¼Ğ°Ñ‚Ğ¸Ñ‡ĞµÑĞºĞ¸ Ğ¿Ñ€Ğ¾Ğ²ĞµÑ€Ğ¸Ñ‚ CSRF Ñ‚Ğ¾ĞºĞµĞ½ Ğ·Ğ´ĞµÑÑŒ.
    user = await authenticate_user(db, form_data.username, form_data.password)
    if not user:
        raise HTTPException(
            status_code=status.HTTP_401_UNAUTHORIZED, # Ğ˜ÑĞ¿Ğ¾Ğ»ÑŒĞ·ÑƒĞµĞ¼ ĞºĞ¾Ñ€Ñ€ĞµĞºÑ‚Ğ½Ñ‹Ğ¹ ÑÑ‚Ğ°Ñ‚ÑƒÑ
            detail="ĞĞµĞ²ĞµÑ€Ğ½Ñ‹Ğµ ÑƒÑ‡ĞµÑ‚Ğ½Ñ‹Ğµ Ğ´Ğ°Ğ½Ğ½Ñ‹Ğµ",
            headers={"WWW-Authenticate": "Bearer"}, # Ğ¡Ñ‚Ğ°Ğ½Ğ´Ğ°Ñ€Ñ‚Ğ½Ñ‹Ğ¹ Ğ·Ğ°Ğ³Ğ¾Ğ»Ğ¾Ğ²Ğ¾Ğº Ğ´Ğ»Ñ 401
        )
    access_token = create_access_token({"sub": user.email})

    # fastapi-csrf-protect Ğ°Ğ²Ñ‚Ğ¾Ğ¼Ğ°Ñ‚Ğ¸Ñ‡ĞµÑĞºĞ¸ Ğ´Ğ¾Ğ»Ğ¶ĞµĞ½ ÑƒÑÑ‚Ğ°Ğ½Ğ¾Ğ²Ğ¸Ñ‚ÑŒ/Ğ¾Ğ±Ğ½Ğ¾Ğ²Ğ¸Ñ‚ÑŒ CSRF cookie Ğ² Ğ¾Ñ‚Ğ²ĞµÑ‚Ğµ,
    # ĞºĞ¾Ğ³Ğ´Ğ° Ğ¸ÑĞ¿Ğ¾Ğ»ÑŒĞ·ÑƒĞµÑ‚ÑÑ Depends(CsrfProtect) Ğ¸ Ğ¼ĞµÑ‚Ğ¾Ğ´ ÑĞ²Ğ»ÑĞµÑ‚ÑÑ state-changing.
    # Ğ•ÑĞ»Ğ¸ Ğ²Ñ‹ Ñ…Ğ¾Ñ‚Ğ¸Ñ‚Ğµ Ğ±Ñ‹Ñ‚ÑŒ ÑƒĞ²ĞµÑ€ĞµĞ½Ñ‹ Ğ¸Ğ»Ğ¸ ÑƒĞ¿Ñ€Ğ°Ğ²Ğ»ÑÑ‚ÑŒ ÑÑ‚Ğ¸Ğ¼ ÑĞ²Ğ½Ğ¾ (Ğ½Ğ°Ğ¿Ñ€Ğ¸Ğ¼ĞµÑ€, Ğ´Ğ»Ñ Ğ¾Ñ‚Ğ²ĞµÑ‚Ğ° Ğ½Ğµ Ğ¾Ñ‚ FastAPI Response):
    # from fastapi.responses import JSONResponse
    # response_content = {"access_token": access_token, "token_type": "bearer"}
    # response = JSONResponse(content=response_content)
    # csrf_protect.set_csrf_cookie(response) # Ğ£ÑÑ‚Ğ°Ğ½Ğ¾Ğ²Ğ¸Ñ‚ÑŒ/Ğ¾Ğ±Ğ½Ğ¾Ğ²Ğ¸Ñ‚ÑŒ CSRF cookie Ğ² Ğ¾Ñ‚Ğ²ĞµÑ‚Ğµ
    # return response
    # ĞĞ¾ Ğ´Ğ»Ñ ÑÑ‚Ğ°Ğ½Ğ´Ğ°Ñ€Ñ‚Ğ½Ñ‹Ñ… FastAPI Ğ¾Ñ‚Ğ²ĞµÑ‚Ğ¾Ğ² Ğ¸ Ñ Depends() ÑÑ‚Ğ¾ Ğ¾Ğ±Ñ‹Ñ‡Ğ½Ğ¾ Ğ¿Ñ€Ğ¾Ğ¸ÑÑ…Ğ¾Ğ´Ğ¸Ñ‚ Ğ°Ğ²Ñ‚Ğ¾Ğ¼Ğ°Ñ‚Ğ¸Ñ‡ĞµÑĞºĞ¸.

    return {"access_token": access_token, "token_type": "bearer"}


async def get_current_user(
        token: str = Depends(oauth2_scheme), db: AsyncSession = Depends(get_db)
) -> User:
    user = await get_user_by_token(db, token)
    if not user:
        # Ğ˜ÑĞ¿Ñ€Ğ°Ğ²Ğ»ÑĞµĞ¼ ĞºĞ¾Ğ´ ÑÑ‚Ğ°Ñ‚ÑƒÑĞ° Ğ¸ Ğ´Ğ¾Ğ±Ğ°Ğ²Ğ»ÑĞµĞ¼ Ğ·Ğ°Ğ³Ğ¾Ğ»Ğ¾Ğ²Ğ¾Ğº Ğ´Ğ»Ñ Ğ¾ÑˆĞ¸Ğ±Ğ¾Ğº Ğ°ÑƒÑ‚ĞµĞ½Ñ‚Ğ¸Ñ„Ğ¸ĞºĞ°Ñ†Ğ¸Ğ¸
        raise HTTPException(
            status_code=status.HTTP_401_UNAUTHORIZED,
            detail="ĞĞµĞ´ĞµĞ¹ÑÑ‚Ğ²Ğ¸Ñ‚ĞµĞ»ÑŒĞ½Ñ‹Ğ¹ Ğ¸Ğ»Ğ¸ Ğ¿Ñ€Ğ¾ÑÑ€Ğ¾Ñ‡ĞµĞ½Ğ½Ñ‹Ğ¹ Ñ‚Ğ¾ĞºĞµĞ½ Ğ°ÑƒÑ‚ĞµĞ½Ñ‚Ğ¸Ñ„Ğ¸ĞºĞ°Ñ†Ğ¸Ğ¸",
            headers={"WWW-Authenticate": "Bearer"},
        )
    return user

```



## `api\calendar_api.py`


```python

# api/calendar_api.py

from fastapi import APIRouter, Query, Depends, HTTPException
from sqlalchemy.ext.asyncio import AsyncSession
from sqlalchemy import select, func
from datetime import date, timedelta
from typing import List, Optional

from fastapi.security import OAuth2PasswordBearer

from api.deps import get_db, get_availability_service
from api.services.availability import AvailabilityService
from api.models.equipment import Equipment as ApiEquipment
from api.models.user import User as ApiUser
from api.auth_api import get_current_user

from shared.schemas.calendar_schema import (
    EquipmentStatusResponse,
    EquipmentDayStatusesResponse,
    CalendarEventResponse,
    EquipmentStatusListResponse,
    CalendarEventListResponse,
)

optional_oauth2_scheme = OAuth2PasswordBearer(tokenUrl="/auth/token", auto_error=False)

async def get_current_user_optional(token: Optional[str] = Depends(optional_oauth2_scheme), db: AsyncSession = Depends(get_db)) -> Optional[ApiUser]:
    if token is None:
        return None
    try:
        from api.services.auth_service import get_user_by_token as get_user_by_token_service
        user = await get_user_by_token_service(db, token)
        return user
    except HTTPException:
        return None

router = APIRouter(prefix="/calendar", tags=["ĞšĞ°Ğ»ĞµĞ½Ğ´Ğ°Ñ€ÑŒ"])

@router.get("/view", response_model=EquipmentStatusListResponse)
async def get_calendar_view(
        start_date: date = Query(..., alias="start"),
        end_date: date = Query(..., alias="end"),
        equipment_ids: List[int] = Query(None, alias="ids"),
        exclude_reservation_id: Optional[int] = Query(None, alias="exclude_reservation_id"),
        db: AsyncSession = Depends(get_db),
        availability_service: AvailabilityService = Depends(get_availability_service),
        skip: int = Query(0, ge=0, description="Ğ¡ĞºĞ¾Ğ»ÑŒĞºĞ¾ Ğ·Ğ°Ğ¿Ğ¸ÑĞµĞ¹ Ğ¿Ñ€Ğ¾Ğ¿ÑƒÑÑ‚Ğ¸Ñ‚ÑŒ"),
        limit: int = Query(10, ge=1, le=100, description="ĞœĞ°ĞºÑĞ¸Ğ¼Ğ°Ğ»ÑŒĞ½Ğ¾Ğµ ĞºĞ¾Ğ»Ğ¸Ñ‡ĞµÑÑ‚Ğ²Ğ¾ Ğ·Ğ°Ğ¿Ğ¸ÑĞµĞ¹ Ğ½Ğ° ÑÑ‚Ñ€Ğ°Ğ½Ğ¸Ñ†Ğµ")
):
    if start_date == end_date:
        end_date = end_date + timedelta(days=1)

    if not equipment_ids:
        result = await db.execute(select(ApiEquipment))
        all_equipment = result.scalars().all()
        equipment_ids = [eq.id for eq in all_equipment]

    if not equipment_ids:
        return EquipmentStatusListResponse(items=[], total=0)

    # Ğ˜ÑĞ¿Ğ¾Ğ»ÑŒĞ·ÑƒĞµĞ¼ Ğ½Ğ¾Ğ²Ñ‹Ğ¹ AvailabilityService
    statuses = await availability_service.get_availability_statuses(
        equipment_ids=equipment_ids,
        start_date=start_date,
        end_date=end_date,
        exclude_reservation_id=exclude_reservation_id,
    )

    equipment_result = await db.execute(select(ApiEquipment).filter(ApiEquipment.id.in_(equipment_ids)))
    equipment = equipment_result.scalars().all()
    equipment_map = {e.id: e for e in equipment}

    result = []
    for eq_id, status_info in statuses.items():
        eq = equipment_map.get(eq_id)
        result.append(
            EquipmentStatusResponse(
                equipment_id=eq_id,
                status=status_info["status"],
                details=status_info["details"],
                name=eq.name if eq else None,
                equipment_type=eq.equipment_type if eq else None,
                brand=eq.brand if eq else None,
                start_date=status_info.get("start_date"),
                end_date=status_info.get("end_date"),
            )
        )

    total_items = len(result)
    paginated_result = result[skip:skip + limit]

    return EquipmentStatusListResponse(
        items=paginated_result,
        total=total_items
    )


@router.get("/day-statuses", response_model=EquipmentDayStatusesResponse)
async def get_calendar_day_statuses(
        start_date: date = Query(..., alias="start"),
        end_date: date = Query(..., alias="end"),
        equipment_ids: List[int] = Query(None, alias="ids"),
        exclude_reservation_id: Optional[int] = Query(None, alias="exclude_reservation_id"),
        db: AsyncSession = Depends(get_db),
        availability_service: AvailabilityService = Depends(get_availability_service),
        current_user: Optional[ApiUser] = Depends(get_current_user_optional)
):
    if start_date == end_date:
        end_date = end_date + timedelta(days=1)

    if not equipment_ids:
        result = await db.execute(select(ApiEquipment))
        all_equipment = result.scalars().all()
        equipment_ids = [eq.id for eq in all_equipment]

    if not equipment_ids:
        return {"equipment_day_statuses": {}}

    current_user_id: Optional[int] = current_user.id if current_user else None

    # Ğ˜ÑĞ¿Ğ¾Ğ»ÑŒĞ·ÑƒĞµĞ¼ Ğ½Ğ¾Ğ²Ñ‹Ğ¹ AvailabilityService
    statuses = await availability_service.get_daily_statuses(
        equipment_ids=equipment_ids,
        start_date=start_date,
        end_date=end_date,
        exclude_reservation_id=exclude_reservation_id,
        current_user_id=current_user_id
    )

    return {"equipment_day_statuses": statuses}


@router.get("/events", response_model=CalendarEventListResponse)
async def get_calendar_events(
        start: date = Query(..., alias="start"),
        end: date = Query(..., alias="end"),
        equipment_ids: List[int] = Query(None, alias="ids"),
        db: AsyncSession = Depends(get_db),
        availability_service: AvailabilityService = Depends(get_availability_service),
        skip: int = Query(0, ge=0, description="Ğ¡ĞºĞ¾Ğ»ÑŒĞºĞ¾ Ğ·Ğ°Ğ¿Ğ¸ÑĞµĞ¹ Ğ¿Ñ€Ğ¾Ğ¿ÑƒÑÑ‚Ğ¸Ñ‚ÑŒ"),
        limit: int = Query(10, ge=1, le=100, description="ĞœĞ°ĞºÑĞ¸Ğ¼Ğ°Ğ»ÑŒĞ½Ğ¾Ğµ ĞºĞ¾Ğ»Ğ¸Ñ‡ĞµÑÑ‚Ğ²Ğ¾ Ğ·Ğ°Ğ¿Ğ¸ÑĞµĞ¹ Ğ½Ğ° ÑÑ‚Ñ€Ğ°Ğ½Ğ¸Ñ†Ğµ")
):
    if not equipment_ids:
        result = await db.execute(select(ApiEquipment))
        all_equipment = result.scalars().all()
        equipment_ids = [eq.id for eq in all_equipment]

    # Ğ˜ÑĞ¿Ğ¾Ğ»ÑŒĞ·ÑƒĞµĞ¼ Ğ½Ğ¾Ğ²Ñ‹Ğ¹ AvailabilityService
    events = await availability_service.get_calendar_events(
        equipment_ids=equipment_ids,
        start_date=start,
        end_date=end,
    )

    total_events = len(events)
    paginated_events = events[skip:skip + limit]

    return CalendarEventListResponse(
        items=paginated_events,
        total=total_events
    )

```



## `api\database.py`


```python

# api/database.py

from sqlalchemy.ext.asyncio import create_async_engine, async_sessionmaker, AsyncSession
from sqlalchemy.orm import declarative_base
# Ğ£Ğ±ĞµĞ´Ğ¸Ñ‚ĞµÑÑŒ, Ñ‡Ñ‚Ğ¾ Ğ²Ğ°Ñˆ Ñ„Ğ°Ğ¹Ğ» config/secrets.py ĞºĞ¾Ñ€Ñ€ĞµĞºÑ‚Ğ½Ğ¾ Ğ·Ğ°Ğ³Ñ€ÑƒĞ¶Ğ°ĞµÑ‚ DATABASE_URL Ğ¸Ğ· .env
# ĞĞ°Ğ¿Ñ€Ğ¸Ğ¼ĞµÑ€, Ğ¸ÑĞ¿Ğ¾Ğ»ÑŒĞ·ÑƒÑ pydantic_settings Ğ¸Ğ»Ğ¸ python-dotenv
from config.secrets import DATABASE_URL

# Ğ¡Ğ¾Ğ·Ğ´Ğ°ĞµĞ¼ Ğ°ÑĞ¸Ğ½Ñ…Ñ€Ğ¾Ğ½Ğ½Ñ‹Ğ¹ Ğ´Ğ²Ğ¸Ğ¶Ğ¾Ğº, Ğ¸ÑĞ¿Ğ¾Ğ»ÑŒĞ·ÑƒÑ URL Ğ½Ğ°Ğ¿Ñ€ÑĞ¼ÑƒÑ Ğ¸Ğ· ĞºĞ¾Ğ½Ñ„Ğ¸Ğ³ÑƒÑ€Ğ°Ñ†Ğ¸Ğ¸
engine = create_async_engine(DATABASE_URL, echo=False, future=True)

# Ğ¡Ğ¾Ğ·Ğ´Ğ°ĞµĞ¼ Ñ„Ğ°Ğ±Ñ€Ğ¸ĞºÑƒ Ğ°ÑĞ¸Ğ½Ñ…Ñ€Ğ¾Ğ½Ğ½Ñ‹Ñ… ÑĞµÑÑĞ¸Ğ¹
AsyncSessionLocal = async_sessionmaker(
    bind=engine,
    class_=AsyncSession,
    expire_on_commit=False,
    autocommit=False,
    autoflush=False
)

Base = declarative_base()

# Ğ¡Ğ¾Ğ·Ğ´Ğ°ĞµĞ¼ Ğ°ÑĞ¸Ğ½Ñ…Ñ€Ğ¾Ğ½Ğ½ÑƒÑ Ğ·Ğ°Ğ²Ğ¸ÑĞ¸Ğ¼Ğ¾ÑÑ‚ÑŒ Ğ´Ğ»Ñ Ğ¿Ğ¾Ğ»ÑƒÑ‡ĞµĞ½Ğ¸Ñ ÑĞµÑÑĞ¸Ğ¸
async def get_db() -> AsyncSession:
    """ĞÑĞ¸Ğ½Ñ…Ñ€Ğ¾Ğ½Ğ½Ñ‹Ğ¹ Ğ³ĞµĞ½ĞµÑ€Ğ°Ñ‚Ğ¾Ñ€ Ğ´Ğ»Ñ Ğ¿Ğ¾Ğ»ÑƒÑ‡ĞµĞ½Ğ¸Ñ ÑĞµÑÑĞ¸Ğ¸ Ğ±Ğ°Ğ·Ñ‹ Ğ´Ğ°Ğ½Ğ½Ñ‹Ñ…."""
    async with AsyncSessionLocal() as session:
        try:
            yield session
        finally:
            await session.close()

```



## `api\deps.py`


```python

# api/deps.py

from fastapi import Depends
from sqlalchemy.ext.asyncio import AsyncSession
from fastapi.security import OAuth2PasswordBearer
from fastapi import HTTPException, status

from api.database import get_db as get_database
from api.services.auth_service import get_user_by_token
from api.models.user import User

# Ğ˜Ğ¼Ğ¿Ğ¾Ñ€Ñ‚Ñ‹ ÑĞµÑ€Ğ²Ğ¸ÑĞ¾Ğ²
from api.services.order.order_lifecycle_service import OrderLifecycleService
from api.services.rental.rental_query_service import RentalQueryService
from api.services.reservation_query_service import ReservationQueryService
from api.services.balance_service import BalanceService
from api.services.equipment_query_builder import EquipmentQueryBuilder
from api.services.financial_service import FinancialService
from api.services.availability import AvailabilityService
from api.services.dashboard_service import DashboardService

# OAuth2PasswordBearer Ğ´Ğ»Ñ Ğ¿Ğ¾Ğ»ÑƒÑ‡ĞµĞ½Ğ¸Ñ Ñ‚Ğ¾ĞºĞµĞ½Ğ° Ğ¸Ğ· Ğ·Ğ°Ğ³Ğ¾Ğ»Ğ¾Ğ²ĞºĞ° Authorization
oauth2_scheme = OAuth2PasswordBearer(tokenUrl="/auth/token")


async def get_db():
    """Ğ—Ğ°Ğ²Ğ¸ÑĞ¸Ğ¼Ğ¾ÑÑ‚ÑŒ Ğ´Ğ»Ñ Ğ¿Ğ¾Ğ»ÑƒÑ‡ĞµĞ½Ğ¸Ñ ÑĞµÑÑĞ¸Ğ¸ Ğ±Ğ°Ğ·Ñ‹ Ğ´Ğ°Ğ½Ğ½Ñ‹Ñ…."""
    async for db in get_database():
        yield db


async def get_current_user(
    token: str = Depends(oauth2_scheme), 
    db: AsyncSession = Depends(get_db)
) -> User:
    """ĞŸĞ¾Ğ»ÑƒÑ‡Ğ¸Ñ‚ÑŒ Ñ‚ĞµĞºÑƒÑ‰ĞµĞ³Ğ¾ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ñ Ğ¿Ğ¾ Ñ‚Ğ¾ĞºĞµĞ½Ñƒ."""
    user = await get_user_by_token(db, token)
    if not user:
        raise HTTPException(
            status_code=status.HTTP_401_UNAUTHORIZED,
            detail="ĞĞµĞ´ĞµĞ¹ÑÑ‚Ğ²Ğ¸Ñ‚ĞµĞ»ÑŒĞ½Ñ‹Ğ¹ Ğ¸Ğ»Ğ¸ Ğ¿Ñ€Ğ¾ÑÑ€Ğ¾Ñ‡ĞµĞ½Ğ½Ñ‹Ğ¹ Ñ‚Ğ¾ĞºĞµĞ½ Ğ°ÑƒÑ‚ĞµĞ½Ñ‚Ğ¸Ñ„Ğ¸ĞºĞ°Ñ†Ğ¸Ğ¸",
            headers={"WWW-Authenticate": "Bearer"},
        )
    return user


# === Ğ—ĞĞ’Ğ˜Ğ¡Ğ˜ĞœĞĞ¡Ğ¢Ğ˜ Ğ”Ğ›Ğ¯ Ğ¡Ğ•Ğ Ğ’Ğ˜Ğ¡ĞĞ’ ===

def get_order_lifecycle_service(db: AsyncSession = Depends(get_db)) -> OrderLifecycleService:
    """Ğ—Ğ°Ğ²Ğ¸ÑĞ¸Ğ¼Ğ¾ÑÑ‚ÑŒ Ğ´Ğ»Ñ Ğ¿Ğ¾Ğ»ÑƒÑ‡ĞµĞ½Ğ¸Ñ ÑĞµÑ€Ğ²Ğ¸ÑĞ° Ğ¶Ğ¸Ğ·Ğ½ĞµĞ½Ğ½Ğ¾Ğ³Ğ¾ Ñ†Ğ¸ĞºĞ»Ğ° Ğ·Ğ°ĞºĞ°Ğ·Ğ¾Ğ²."""
    return OrderLifecycleService(db)


def get_rental_query_service(db: AsyncSession = Depends(get_db)) -> RentalQueryService:
    """Ğ—Ğ°Ğ²Ğ¸ÑĞ¸Ğ¼Ğ¾ÑÑ‚ÑŒ Ğ´Ğ»Ñ Ğ¿Ğ¾Ğ»ÑƒÑ‡ĞµĞ½Ğ¸Ñ ÑĞµÑ€Ğ²Ğ¸ÑĞ° Ğ·Ğ°Ğ¿Ñ€Ğ¾ÑĞ¾Ğ² Ğ°Ñ€ĞµĞ½Ğ´Ñ‹."""
    return RentalQueryService(db)


def get_reservation_query_service(db: AsyncSession = Depends(get_db)) -> ReservationQueryService:
    """Ğ—Ğ°Ğ²Ğ¸ÑĞ¸Ğ¼Ğ¾ÑÑ‚ÑŒ Ğ´Ğ»Ñ Ğ¿Ğ¾Ğ»ÑƒÑ‡ĞµĞ½Ğ¸Ñ ÑĞµÑ€Ğ²Ğ¸ÑĞ° Ğ·Ğ°Ğ¿Ñ€Ğ¾ÑĞ¾Ğ² Ñ€ĞµĞ·ĞµÑ€Ğ²Ğ°Ñ†Ğ¸Ğ¹."""
    return ReservationQueryService(db)




def get_balance_service(db: AsyncSession = Depends(get_db)) -> BalanceService:
    """Ğ—Ğ°Ğ²Ğ¸ÑĞ¸Ğ¼Ğ¾ÑÑ‚ÑŒ Ğ´Ğ»Ñ Ğ¿Ğ¾Ğ»ÑƒÑ‡ĞµĞ½Ğ¸Ñ ÑĞµÑ€Ğ²Ğ¸ÑĞ° Ğ±Ğ°Ğ»Ğ°Ğ½ÑĞ°."""
    return BalanceService(db)


def get_equipment_query_builder(db: AsyncSession = Depends(get_db)) -> EquipmentQueryBuilder:
    """Ğ—Ğ°Ğ²Ğ¸ÑĞ¸Ğ¼Ğ¾ÑÑ‚ÑŒ Ğ´Ğ»Ñ Ğ¿Ğ¾Ğ»ÑƒÑ‡ĞµĞ½Ğ¸Ñ Ğ±Ğ¸Ğ»Ğ´ĞµÑ€Ğ° Ğ·Ğ°Ğ¿Ñ€Ğ¾ÑĞ¾Ğ² Ğ¾Ğ±Ğ¾Ñ€ÑƒĞ´Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ."""
    return EquipmentQueryBuilder(db)


def get_financial_service(db: AsyncSession = Depends(get_db)) -> FinancialService:
    """Ğ—Ğ°Ğ²Ğ¸ÑĞ¸Ğ¼Ğ¾ÑÑ‚ÑŒ Ğ´Ğ»Ñ Ğ¿Ğ¾Ğ»ÑƒÑ‡ĞµĞ½Ğ¸Ñ Ñ„Ğ¸Ğ½Ğ°Ğ½ÑĞ¾Ğ²Ğ¾Ğ³Ğ¾ ÑĞµÑ€Ğ²Ğ¸ÑĞ°."""
    return FinancialService(db)


def get_availability_service(db: AsyncSession = Depends(get_db)) -> AvailabilityService:
    """Ğ—Ğ°Ğ²Ğ¸ÑĞ¸Ğ¼Ğ¾ÑÑ‚ÑŒ Ğ´Ğ»Ñ Ğ¿Ğ¾Ğ»ÑƒÑ‡ĞµĞ½Ğ¸Ñ ÑĞµÑ€Ğ²Ğ¸ÑĞ° Ğ¿Ñ€Ğ¾Ğ²ĞµÑ€ĞºĞ¸ Ğ´Ğ¾ÑÑ‚ÑƒĞ¿Ğ½Ğ¾ÑÑ‚Ğ¸ Ğ¾Ğ±Ğ¾Ñ€ÑƒĞ´Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ."""
    return AvailabilityService(db)


def get_dashboard_service(db: AsyncSession = Depends(get_db)) -> DashboardService:
    """Ğ—Ğ°Ğ²Ğ¸ÑĞ¸Ğ¼Ğ¾ÑÑ‚ÑŒ Ğ´Ğ»Ñ Ğ¿Ğ¾Ğ»ÑƒÑ‡ĞµĞ½Ğ¸Ñ ÑĞµÑ€Ğ²Ğ¸ÑĞ° Ğ¿Ğ°Ğ½ĞµĞ»Ğ¸ ÑƒĞ¿Ñ€Ğ°Ğ²Ğ»ĞµĞ½Ğ¸Ñ."""
    return DashboardService(db)

```



## `api\discount_api.py`


```python

# api/discount_api.py

from typing import List
from fastapi import APIRouter, Depends, HTTPException, Query
from sqlalchemy.ext.asyncio import AsyncSession
from sqlalchemy import select, func
from fastapi_csrf_protect import CsrfProtect

from api.deps import get_db
from api.models.user import User
from api.models.discount import DurationDiscount
from api.permissions import require_admin
from shared.schemas.discount_schema import DiscountCreate, DiscountUpdate, DiscountOut, DiscountListResponse

router = APIRouter(prefix="/discounts", tags=["Ğ¡ĞºĞ¸Ğ´ĞºĞ¸ Ğ·Ğ° Ğ´Ğ»Ğ¸Ñ‚ĞµĞ»ÑŒĞ½Ğ¾ÑÑ‚ÑŒ"])

@router.get("/", response_model=DiscountListResponse)
async def get_all_discounts(
        db: AsyncSession = Depends(get_db),
        skip: int = Query(0, ge=0, description="Ğ¡ĞºĞ¾Ğ»ÑŒĞºĞ¾ Ğ·Ğ°Ğ¿Ğ¸ÑĞµĞ¹ Ğ¿Ñ€Ğ¾Ğ¿ÑƒÑÑ‚Ğ¸Ñ‚ÑŒ"),
        limit: int = Query(10, ge=1, le=100, description="ĞœĞ°ĞºÑĞ¸Ğ¼Ğ°Ğ»ÑŒĞ½Ğ¾Ğµ ĞºĞ¾Ğ»Ğ¸Ñ‡ĞµÑÑ‚Ğ²Ğ¾ Ğ·Ğ°Ğ¿Ğ¸ÑĞµĞ¹ Ğ½Ğ° ÑÑ‚Ñ€Ğ°Ğ½Ğ¸Ñ†Ğµ")
):
    """ĞŸĞ¾Ğ»ÑƒÑ‡Ğ¸Ñ‚ÑŒ Ğ²ÑĞµ ÑƒÑ€Ğ¾Ğ²Ğ½Ğ¸ ÑĞºĞ¸Ğ´Ğ¾Ğº Ğ·Ğ° Ğ´Ğ»Ğ¸Ñ‚ĞµĞ»ÑŒĞ½Ğ¾ÑÑ‚ÑŒ Ñ Ğ¿Ğ°Ğ³Ğ¸Ğ½Ğ°Ñ†Ğ¸ĞµĞ¹."""
    # 1. Ğ—Ğ°Ğ¿Ñ€Ğ¾Ñ Ğ´Ğ»Ñ Ğ¿Ğ¾Ğ»ÑƒÑ‡ĞµĞ½Ğ¸Ñ Ğ¾Ğ±Ñ‰ĞµĞ³Ğ¾ ĞºĞ¾Ğ»Ğ¸Ñ‡ĞµÑÑ‚Ğ²Ğ° ÑĞºĞ¸Ğ´Ğ¾Ğº
    total_result = await db.execute(select(func.count(DurationDiscount.id)))
    total_discounts = total_result.scalar_one()

    # 2. Ğ—Ğ°Ğ¿Ñ€Ğ¾Ñ Ğ´Ğ»Ñ Ğ¿Ğ¾Ğ»ÑƒÑ‡ĞµĞ½Ğ¸Ñ "ÑÑ‚Ñ€Ğ°Ğ½Ğ¸Ñ†Ñ‹" ÑĞºĞ¸Ğ´Ğ¾Ğº
    discounts_result = await db.execute(
        select(DurationDiscount).order_by(DurationDiscount.min_days).offset(skip).limit(limit)
    )
    discounts_orm = discounts_result.scalars().all()

    # 3. Ğ¤Ğ¾Ñ€Ğ¼Ğ¸Ñ€ÑƒĞµĞ¼ Ğ¸ Ğ²Ğ¾Ğ·Ğ²Ñ€Ğ°Ñ‰Ğ°ĞµĞ¼ Ğ½Ğ¾Ğ²Ñ‹Ğ¹ Ğ¾Ğ±ÑŠĞµĞºÑ‚ Ğ¾Ñ‚Ğ²ĞµÑ‚Ğ°
    return DiscountListResponse(
        items=[DiscountOut.from_orm(discount) for discount in discounts_orm],
        total=total_discounts
    )

@router.post("/", response_model=DiscountOut, status_code=201)
async def create_discount(
        discount_in: DiscountCreate,
        db: AsyncSession = Depends(get_db),
        current_user: User = Depends(require_admin),
        csrf_protect: CsrfProtect = Depends()
):
    """Ğ¡Ğ¾Ğ·Ğ´Ğ°Ñ‚ÑŒ Ğ½Ğ¾Ğ²Ñ‹Ğ¹ ÑƒÑ€Ğ¾Ğ²ĞµĞ½ÑŒ ÑĞºĞ¸Ğ´ĞºĞ¸."""
    result = await db.execute(select(DurationDiscount).filter(DurationDiscount.min_days == discount_in.min_days))
    existing = result.scalars().first()
    if existing:
        raise HTTPException(status_code=409, detail=f"Ğ¡ĞºĞ¸Ğ´ĞºĞ° Ğ´Ğ»Ñ {discount_in.min_days} Ğ´Ğ½ĞµĞ¹ ÑƒĞ¶Ğµ ÑÑƒÑ‰ĞµÑÑ‚Ğ²ÑƒĞµÑ‚.")

    new_discount = DurationDiscount(**discount_in.model_dump())
    db.add(new_discount)
    await db.commit()
    
    # ĞŸĞ¾Ğ²Ñ‚Ğ¾Ñ€Ğ½Ğ¾ Ğ¿Ğ¾Ğ»ÑƒÑ‡Ğ°ĞµĞ¼ Ğ¾Ğ±ÑŠĞµĞºÑ‚ Ğ¸Ğ· Ğ‘Ğ”
    result = await db.execute(select(DurationDiscount).filter(DurationDiscount.id == new_discount.id))
    return result.scalars().first()

@router.put("/{discount_id}", response_model=DiscountOut)
async def update_discount(
        discount_id: int,
        discount_in: DiscountUpdate,
        db: AsyncSession = Depends(get_db),
        current_user: User = Depends(require_admin),
        csrf_protect: CsrfProtect = Depends()
):
    """ĞĞ±Ğ½Ğ¾Ğ²Ğ¸Ñ‚ÑŒ ÑÑƒÑ‰ĞµÑÑ‚Ğ²ÑƒÑÑ‰Ğ¸Ğ¹ ÑƒÑ€Ğ¾Ğ²ĞµĞ½ÑŒ ÑĞºĞ¸Ğ´ĞºĞ¸."""
    result = await db.execute(select(DurationDiscount).filter(DurationDiscount.id == discount_id))
    discount = result.scalars().first()
    if not discount:
        raise HTTPException(status_code=404, detail="Ğ¡ĞºĞ¸Ğ´ĞºĞ° Ğ½Ğµ Ğ½Ğ°Ğ¹Ğ´ĞµĞ½Ğ°.")

    existing_result = await db.execute(
        select(DurationDiscount).filter(
            DurationDiscount.min_days == discount_in.min_days,
            DurationDiscount.id != discount_id
        )
    )
    existing = existing_result.scalars().first()
    if existing:
        raise HTTPException(status_code=409, detail=f"Ğ¡ĞºĞ¸Ğ´ĞºĞ° Ğ´Ğ»Ñ {discount_in.min_days} Ğ´Ğ½ĞµĞ¹ ÑƒĞ¶Ğµ ÑÑƒÑ‰ĞµÑÑ‚Ğ²ÑƒĞµÑ‚.")

    update_data = discount_in.model_dump()
    for key, value in update_data.items():
        setattr(discount, key, value)

    await db.commit()
    
    # ĞŸĞ¾Ğ²Ñ‚Ğ¾Ñ€Ğ½Ğ¾ Ğ¿Ğ¾Ğ»ÑƒÑ‡Ğ°ĞµĞ¼ Ğ¾Ğ±ÑŠĞµĞºÑ‚ Ğ¸Ğ· Ğ‘Ğ”
    result = await db.execute(select(DurationDiscount).filter(DurationDiscount.id == discount_id))
    return result.scalars().first()

@router.delete("/{discount_id}", status_code=204)
async def delete_discount(
        discount_id: int,
        db: AsyncSession = Depends(get_db),
        current_user: User = Depends(require_admin),
        csrf_protect: CsrfProtect = Depends()
):
    """Ğ£Ğ´Ğ°Ğ»Ğ¸Ñ‚ÑŒ ÑƒÑ€Ğ¾Ğ²ĞµĞ½ÑŒ ÑĞºĞ¸Ğ´ĞºĞ¸."""
    result = await db.execute(select(DurationDiscount).filter(DurationDiscount.id == discount_id))
    discount = result.scalars().first()
    if not discount:
        raise HTTPException(status_code=404, detail="Ğ¡ĞºĞ¸Ğ´ĞºĞ° Ğ½Ğµ Ğ½Ğ°Ğ¹Ğ´ĞµĞ½Ğ°.")

    await db.delete(discount)
    await db.commit()
    return None

```



## `api\equipment_api.py`


```python

# api/equipment_api.py

from fastapi import APIRouter, Depends, HTTPException, Query
from sqlalchemy.ext.asyncio import AsyncSession
from sqlalchemy import select, func
from sqlalchemy.orm import selectinload
from typing import List, Optional
from datetime import date, datetime
from collections import defaultdict
from fastapi_csrf_protect import CsrfProtect

from api.models.equipment import Equipment
from api.models.user import User
from api.models.rental import Rental
from api.models.reservation import Reservation
from api.deps import get_db
from api.permissions import require_manager
# --- Ğ˜Ğ—ĞœĞ•ĞĞ•ĞĞ˜Ğ•: Ğ˜Ğ¼Ğ¿Ğ¾Ñ€Ñ‚Ğ¸Ñ€ÑƒĞµĞ¼ Ğ½Ğ¾Ğ²ÑƒÑ ÑĞµÑ€Ğ²Ğ¸ÑĞ½ÑƒÑ Ñ„ÑƒĞ½ĞºÑ†Ğ¸Ñ Ğ¸ ÑÑ…ĞµĞ¼Ñƒ Ğ¾Ñ‚Ğ²ĞµÑ‚Ğ° ---
from api.services.equipment_service_api import get_paginated_equipment, update_equipment_details
from shared.schemas.equipment_schema import (
    EquipmentOut,
    EquipmentTreeItem,
    EquipmentUpdateExtended,
    EquipmentCreate,
    EquipmentAvailabilityStatus,
    EquipmentListResponse,
    EquipmentTreeListResponse
)

router = APIRouter(prefix="/equipment", tags=["ĞĞ±Ğ¾Ñ€ÑƒĞ´Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ"])


@router.get("/", response_model=EquipmentListResponse)
async def list_equipment_paginated(
        db: AsyncSession = Depends(get_db),
        skip: int = Query(0, ge=0),
        limit: int = Query(10, ge=1, le=1000),
        query: Optional[str] = Query(None),
        type: Optional[str] = Query(None),
        brand: Optional[str] = Query(None),
        association_id: Optional[int] = Query(None, alias="associationId"),
        start_date: Optional[date] = Query(None, alias="startDate"),
        end_date: Optional[date] = Query(None, alias="endDate"),
        available_only: bool = Query(False, alias="availableOnly")
):
    """Ğ’Ğ¾Ğ·Ğ²Ñ€Ğ°Ñ‰Ğ°ĞµÑ‚ Ğ¾Ñ‚Ñ„Ğ¸Ğ»ÑŒÑ‚Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ½Ñ‹Ğ¹ Ğ¸ Ğ¿Ğ°Ğ³Ğ¸Ğ½Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ½Ñ‹Ğ¹ ÑĞ¿Ğ¸ÑĞ¾Ğº Ğ¾Ğ±Ğ¾Ñ€ÑƒĞ´Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ."""
    items, total = await get_paginated_equipment(
        db, skip=skip, limit=limit, query=query, type=type, brand=brand,
        association_id=association_id, start_date=start_date, end_date=end_date,
        available_only=available_only
    )
    return EquipmentListResponse(items=items, total=total)


@router.get("/tree", response_model=EquipmentTreeListResponse)
async def get_equipment_tree(
        db: AsyncSession = Depends(get_db),
        skip: int = Query(0, ge=0),
        limit: int = Query(10, ge=1, le=100)
):
    """Ğ’Ğ¾Ğ·Ğ²Ñ€Ğ°Ñ‰Ğ°ĞµÑ‚ Ğ¾Ğ±Ğ¾Ñ€ÑƒĞ´Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ, ÑĞ³Ñ€ÑƒĞ¿Ğ¿Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ½Ğ¾Ğµ Ğ² Ğ²Ğ¸Ğ´Ğµ Ğ´ĞµÑ€ĞµĞ²Ğ° Ğ¿Ğ¾ Ñ‚Ğ¸Ğ¿Ñƒ Ğ¸ Ğ±Ñ€ĞµĞ½Ğ´Ñƒ Ñ Ğ¿Ğ°Ğ³Ğ¸Ğ½Ğ°Ñ†Ğ¸ĞµĞ¹."""
    result = await db.execute(select(Equipment))
    all_equipment = result.scalars().all()
    grouped: dict[str, dict[str, list[Equipment]]] = defaultdict(lambda: defaultdict(list))
    for eq in all_equipment:
        grouped[eq.equipment_type][eq.brand].append(eq)

    result = []
    for eq_type, brands in grouped.items():
        type_node = EquipmentTreeItem(label=eq_type, children=[])
        for brand, items in brands.items():
            brand_node = EquipmentTreeItem(label=brand, children=[
                EquipmentTreeItem(label=item.name, value=item.id) for item in items
            ])
            type_node.children.append(brand_node)
        result.append(type_node)

    total_items = len(result)
    paginated_result = result[skip:skip + limit]

    return EquipmentTreeListResponse(
        items=paginated_result,
        total=total_items
    )


@router.put("/{equipment_id}", response_model=EquipmentOut)
async def update_single_equipment_details_route(
        equipment_id: int,
        equipment_data: EquipmentUpdateExtended,
        db: AsyncSession = Depends(get_db),
        _current_user: User = Depends(require_manager),
        _csrf_protect: CsrfProtect = Depends()
):
    """ĞĞ±Ğ½Ğ¾Ğ²Ğ»ÑĞµÑ‚ Ğ´ĞµÑ‚Ğ°Ğ»Ğ¸ ÑƒĞºĞ°Ğ·Ğ°Ğ½Ğ½Ğ¾Ğ³Ğ¾ Ğ¾Ğ±Ğ¾Ñ€ÑƒĞ´Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ."""
    updated_equipment = await update_equipment_details(db, equipment_id, equipment_data)
    return updated_equipment


@router.post("/", response_model=EquipmentOut)
async def create_equipment(
        equipment_data: EquipmentCreate,
        db: AsyncSession = Depends(get_db),
        _current_user: User = Depends(require_manager),
        _csrf_protect: CsrfProtect = Depends()
):
    """Ğ¡Ğ¾Ğ·Ğ´Ğ°ĞµÑ‚ Ğ½Ğ¾Ğ²Ğ¾Ğµ Ğ¾Ğ±Ğ¾Ñ€ÑƒĞ´Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ."""
    equipment = Equipment(**equipment_data.model_dump())
    db.add(equipment)
    await db.commit()
    
    # Ğ’Ğ¾Ğ·Ğ²Ñ€Ğ°Ñ‰Ğ°ĞµĞ¼ ÑĞ¾Ğ·Ğ´Ğ°Ğ½Ğ½Ñ‹Ğ¹ Ğ¾Ğ±ÑŠĞµĞºÑ‚ Ğ±ĞµĞ· Ğ¿Ğ¾Ğ²Ñ‚Ğ¾Ñ€Ğ½Ğ¾Ğ³Ğ¾ Ğ·Ğ°Ğ¿Ñ€Ğ¾ÑĞ° Ğº Ğ‘Ğ”
    return equipment


@router.delete("/{equipment_id}")
async def delete_equipment(
        equipment_id: int,
        db: AsyncSession = Depends(get_db),
        _current_user: User = Depends(require_manager),
        _csrf_protect: CsrfProtect = Depends()
):
    """Ğ£Ğ´Ğ°Ğ»ÑĞµÑ‚ Ğ¾Ğ±Ğ¾Ñ€ÑƒĞ´Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ."""
    result = await db.execute(select(Equipment).filter(Equipment.id == equipment_id))
    equipment = result.scalars().first()
    if not equipment:
        raise HTTPException(status_code=404, detail="ĞĞ±Ğ¾Ñ€ÑƒĞ´Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ Ğ½Ğµ Ğ½Ğ°Ğ¹Ğ´ĞµĞ½Ğ¾")
    await db.delete(equipment)
    await db.commit()
    return {"message": "ĞĞ±Ğ¾Ñ€ÑƒĞ´Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ ÑƒĞ´Ğ°Ğ»ĞµĞ½Ğ¾"}


@router.get("/{equipment_id}/availability", response_model=EquipmentAvailabilityStatus)
async def get_equipment_availability_status(
        equipment_id: int,
        db: AsyncSession = Depends(get_db),
        _current_user: User = Depends(require_manager)
):
    """
    ĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑĞµÑ‚, ÑƒÑ‡Ğ°ÑÑ‚Ğ²ÑƒĞµÑ‚ Ğ»Ğ¸ Ğ¾Ğ±Ğ¾Ñ€ÑƒĞ´Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ Ğ² ĞĞ•Ğ—ĞĞ’Ğ•Ğ Ğ¨Ğ•ĞĞĞ«Ğ¥ Ñ€ĞµĞ·ĞµÑ€Ğ²Ğ°Ñ… Ğ¸Ğ»Ğ¸ Ğ°Ñ€ĞµĞ½Ğ´Ğ°Ñ….
    """
    result = await db.execute(select(Equipment).filter(Equipment.id == equipment_id))
    equipment = result.scalars().first()
    if not equipment:
        raise HTTPException(status_code=404, detail="ĞĞ±Ğ¾Ñ€ÑƒĞ´Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ Ğ½Ğµ Ğ½Ğ°Ğ¹Ğ´ĞµĞ½Ğ¾")

    today_start_of_day = datetime.combine(date.today(), datetime.min.time())

    reservations_result = await db.execute(
        select(func.count(Reservation.id)).filter(
            Reservation.equipment.any(Equipment.id == equipment_id),
            Reservation.end_date >= today_start_of_day
        )
    )
    active_reservations_count = reservations_result.scalar_one()

    rentals_result = await db.execute(
        select(func.count(Rental.id)).filter(
            Rental.equipment.any(Equipment.id == equipment_id),
            Rental.end_date >= today_start_of_day
        )
    )
    active_rentals_count = rentals_result.scalar_one()

    return EquipmentAvailabilityStatus(
        has_active_reservations=active_reservations_count > 0,
        has_active_rentals=active_rentals_count > 0,
        active_reservations_count=active_reservations_count,
        active_rentals_count=active_rentals_count,
    )

```



## `api\holiday_api.py`


```python

# api/holiday_api.py

from fastapi import APIRouter, Depends, HTTPException, Query
from sqlalchemy.ext.asyncio import AsyncSession
from sqlalchemy import select, func
from typing import List
from datetime import date, timedelta, datetime
import holidays

from api.deps import get_db
from api.permissions import require_admin
from api.models.user import User
from api.models.holiday import Holiday, HolidayRule
from api.models.reservation import Reservation
from shared.schemas.holiday_schema import HolidayOut, HolidayCreate, RecurringHolidayRuleCreate, HolidayRuleOut, HolidayListResponse, HolidayRuleListResponse

router = APIRouter(prefix="/holidays", tags=["Ğ’Ñ‹Ñ…Ğ¾Ğ´Ğ½Ñ‹Ğµ Ğ¸ Ğ¿Ñ€Ğ°Ğ·Ğ´Ğ½Ğ¸ĞºĞ¸"])

@router.get("/", response_model=HolidayListResponse)
async def get_holidays(
        start_date: date,
        end_date: date,
        db: AsyncSession = Depends(get_db),
        skip: int = Query(0, ge=0, description="Ğ¡ĞºĞ¾Ğ»ÑŒĞºĞ¾ Ğ·Ğ°Ğ¿Ğ¸ÑĞµĞ¹ Ğ¿Ñ€Ğ¾Ğ¿ÑƒÑÑ‚Ğ¸Ñ‚ÑŒ"),
        limit: int = Query(400, ge=1, description="ĞœĞ°ĞºÑĞ¸Ğ¼Ğ°Ğ»ÑŒĞ½Ğ¾Ğµ ĞºĞ¾Ğ»Ğ¸Ñ‡ĞµÑÑ‚Ğ²Ğ¾ Ğ·Ğ°Ğ¿Ğ¸ÑĞµĞ¹ Ğ½Ğ° ÑÑ‚Ñ€Ğ°Ğ½Ğ¸Ñ†Ğµ")
):
    """ĞŸĞ¾Ğ»ÑƒÑ‡Ğ¸Ñ‚ÑŒ ÑĞ¿Ğ¸ÑĞ¾Ğº Ğ²Ñ‹Ñ…Ğ¾Ğ´Ğ½Ñ‹Ñ… Ğ² Ğ·Ğ°Ğ´Ğ°Ğ½Ğ½Ğ¾Ğ¼ Ğ´Ğ¸Ğ°Ğ¿Ğ°Ğ·Ğ¾Ğ½Ğµ Ğ´Ğ°Ñ‚ Ñ Ğ¿Ğ°Ğ³Ğ¸Ğ½Ğ°Ñ†Ğ¸ĞµĞ¹."""
    # 1. Ğ—Ğ°Ğ¿Ñ€Ğ¾Ñ Ğ´Ğ»Ñ Ğ¿Ğ¾Ğ»ÑƒÑ‡ĞµĞ½Ğ¸Ñ Ğ¾Ğ±Ñ‰ĞµĞ³Ğ¾ ĞºĞ¾Ğ»Ğ¸Ñ‡ĞµÑÑ‚Ğ²Ğ° Ğ²Ñ‹Ñ…Ğ¾Ğ´Ğ½Ñ‹Ñ… Ğ² Ğ´Ğ¸Ğ°Ğ¿Ğ°Ğ·Ğ¾Ğ½Ğµ
    total_result = await db.execute(
        select(func.count(Holiday.date)).filter(Holiday.date.between(start_date, end_date))
    )
    total_holidays = total_result.scalar_one()

    # 2. Ğ—Ğ°Ğ¿Ñ€Ğ¾Ñ Ğ´Ğ»Ñ Ğ¿Ğ¾Ğ»ÑƒÑ‡ĞµĞ½Ğ¸Ñ "ÑÑ‚Ñ€Ğ°Ğ½Ğ¸Ñ†Ñ‹" Ğ²Ñ‹Ñ…Ğ¾Ğ´Ğ½Ñ‹Ñ…
    holidays_result = await db.execute(
        select(Holiday).filter(Holiday.date.between(start_date, end_date)).offset(skip).limit(limit)
    )
    holidays_orm = holidays_result.scalars().all()

    # 3. Ğ¤Ğ¾Ñ€Ğ¼Ğ¸Ñ€ÑƒĞµĞ¼ Ğ¸ Ğ²Ğ¾Ğ·Ğ²Ñ€Ğ°Ñ‰Ğ°ĞµĞ¼ Ğ½Ğ¾Ğ²Ñ‹Ğ¹ Ğ¾Ğ±ÑŠĞµĞºÑ‚ Ğ¾Ñ‚Ğ²ĞµÑ‚Ğ°
    return HolidayListResponse(
        items=[HolidayOut.from_orm(holiday) for holiday in holidays_orm],
        total=total_holidays
    )

@router.post("/", response_model=dict)
async def create_holiday(
        holiday_in: HolidayCreate,
        db: AsyncSession = Depends(get_db),
        current_user: User = Depends(require_admin)
):
    """Ğ¡Ğ¾Ğ·Ğ´Ğ°Ñ‚ÑŒ Ğ½Ğ¾Ğ²Ñ‹Ğ¹ Ğ²Ñ‹Ñ…Ğ¾Ğ´Ğ½Ğ¾Ğ¹ Ğ´ĞµĞ½ÑŒ (Ñ€ÑƒÑ‡Ğ½Ğ¾Ğµ Ğ´Ğ¾Ğ±Ğ°Ğ²Ğ»ĞµĞ½Ğ¸Ğµ)."""
    conflicting_result = await db.execute(
        select(Reservation.id).filter(
            (Reservation.start_date == holiday_in.date) | (Reservation.end_date == holiday_in.date)
        )
    )
    conflicting_ids = [r.id for r in conflicting_result.scalars().all()]
    if conflicting_ids and not holiday_in.force:
        raise HTTPException(
            status_code=409,
            detail={
                "message": "Ğ­Ñ‚Ğ° Ğ´Ğ°Ñ‚Ğ° ÑĞ²Ğ»ÑĞµÑ‚ÑÑ Ğ½Ğ°Ñ‡Ğ°Ğ»Ğ¾Ğ¼ Ğ¸Ğ»Ğ¸ ĞºĞ¾Ğ½Ñ†Ğ¾Ğ¼ ÑÑƒÑ‰ĞµÑÑ‚Ğ²ÑƒÑÑ‰Ğ¸Ñ… Ñ€ĞµĞ·ĞµÑ€Ğ²Ğ¾Ğ². ĞŸĞ¾Ğ´Ñ‚Ğ²ĞµÑ€Ğ´Ğ¸Ñ‚Ğµ Ğ´ĞµĞ¹ÑÑ‚Ğ²Ğ¸Ğµ.",
                "conflicting_reservation_ids": conflicting_ids
            }
        )
    existing_result = await db.execute(select(Holiday).filter(Holiday.date == holiday_in.date))
    existing_holiday = existing_result.scalars().first()
    if existing_holiday:
        raise HTTPException(status_code=400, detail="Ğ­Ñ‚Ğ¾Ñ‚ Ğ´ĞµĞ½ÑŒ ÑƒĞ¶Ğµ ÑĞ²Ğ»ÑĞµÑ‚ÑÑ Ğ²Ñ‹Ñ…Ğ¾Ğ´Ğ½Ñ‹Ğ¼.")
    new_holiday = Holiday(
        **holiday_in.model_dump(exclude={"force"}),
        created_by_id=current_user.id
    )
    db.add(new_holiday)
    await db.commit()
    return {"message": "Ğ’Ñ‹Ñ…Ğ¾Ğ´Ğ½Ğ¾Ğ¹ Ğ´ĞµĞ½ÑŒ ÑƒÑĞ¿ĞµÑˆĞ½Ğ¾ Ğ´Ğ¾Ğ±Ğ°Ğ²Ğ»ĞµĞ½", "date": new_holiday.date}


@router.delete("/{holiday_date}", status_code=204)
async def delete_holiday(
        holiday_date: date,
        db: AsyncSession = Depends(get_db),
        _current_user: User = Depends(require_admin)
):
    """Ğ£Ğ´Ğ°Ğ»Ğ¸Ñ‚ÑŒ Ğ²Ñ‹Ñ…Ğ¾Ğ´Ğ½Ğ¾Ğ¹ Ğ´ĞµĞ½ÑŒ."""
    result = await db.execute(select(Holiday).filter(Holiday.date == holiday_date))
    holiday = result.scalars().first()
    if not holiday:
        raise HTTPException(status_code=404, detail="Ğ’Ñ‹Ñ…Ğ¾Ğ´Ğ½Ğ¾Ğ¹ Ğ´ĞµĞ½ÑŒ Ğ½Ğµ Ğ½Ğ°Ğ¹Ğ´ĞµĞ½")
    await db.delete(holiday)
    await db.commit()
    return None

@router.post("/recurring/weekly", status_code=201, summary="Ğ¡Ğ¾Ğ·Ğ´Ğ°Ñ‚ÑŒ ĞµĞ¶ĞµĞ½ĞµĞ´ĞµĞ»ÑŒĞ½Ñ‹Ğµ Ğ²Ñ‹Ñ…Ğ¾Ğ´Ğ½Ñ‹Ğµ")
async def create_weekly_recurring_holidays(
        rule_in: RecurringHolidayRuleCreate,
        db: AsyncSession = Depends(get_db),
        current_user: User = Depends(require_admin)
):
    """Ğ¡Ğ¾Ğ·Ğ´Ğ°ĞµÑ‚ Ğ¿Ñ€Ğ°Ğ²Ğ¸Ğ»Ğ¾ Ğ¸ Ğ³ĞµĞ½ĞµÑ€Ğ¸Ñ€ÑƒĞµÑ‚ Ğ²Ñ‹Ñ…Ğ¾Ğ´Ğ½Ñ‹Ğµ Ğ´Ğ»Ñ ÑƒĞºĞ°Ğ·Ğ°Ğ½Ğ½Ğ¾Ğ³Ğ¾ Ğ´Ğ½Ñ Ğ½ĞµĞ´ĞµĞ»Ğ¸ Ğ² Ğ´Ğ¸Ğ°Ğ¿Ğ°Ğ·Ğ¾Ğ½Ğµ Ğ´Ğ°Ñ‚."""
    if rule_in.start_date >= rule_in.end_date:
        raise HTTPException(status_code=400, detail="Ğ”Ğ°Ñ‚Ğ° Ğ½Ğ°Ñ‡Ğ°Ğ»Ğ° Ğ´Ğ¾Ğ»Ğ¶Ğ½Ğ° Ğ±Ñ‹Ñ‚ÑŒ Ñ€Ğ°Ğ½ÑŒÑˆĞµ Ğ´Ğ°Ñ‚Ñ‹ Ğ¾ĞºĞ¾Ğ½Ñ‡Ğ°Ğ½Ğ¸Ñ.")
    new_rule = HolidayRule(
        rule_type="weekly",
        parameters={"day_of_week": rule_in.day_of_week},
        description=rule_in.description,
        created_by_id=current_user.id
    )
    db.add(new_rule)
    await db.flush()
    holidays_to_create = []
    current_date = rule_in.start_date
    while current_date <= rule_in.end_date:
        if current_date.weekday() == rule_in.day_of_week:
            exists_result = await db.execute(select(Holiday).filter(Holiday.date == current_date))
            exists = exists_result.scalars().first()
            if not exists:
                holidays_to_create.append(
                    Holiday(
                        date=current_date,
                        description=f"ĞĞ²Ñ‚Ğ¾ (Ğ¿Ñ€Ğ°Ğ²Ğ¸Ğ»Ğ¾ #{new_rule.id})",
                        created_by_id=current_user.id,
                        rule_id=new_rule.id
                    )
                )
        current_date += timedelta(days=1)
    if holidays_to_create:
        db.add_all(holidays_to_create)
    await db.commit()
    return {"message": f"ĞŸÑ€Ğ°Ğ²Ğ¸Ğ»Ğ¾ ÑĞ¾Ğ·Ğ´Ğ°Ğ½Ğ¾. Ğ”Ğ¾Ğ±Ğ°Ğ²Ğ»ĞµĞ½Ğ¾ {len(holidays_to_create)} Ğ½Ğ¾Ğ²Ñ‹Ñ… Ğ²Ñ‹Ñ…Ğ¾Ğ´Ğ½Ñ‹Ñ…."}


@router.post("/import/public", status_code=201, summary="Ğ˜Ğ¼Ğ¿Ğ¾Ñ€Ñ‚Ğ¸Ñ€Ğ¾Ğ²Ğ°Ñ‚ÑŒ Ğ³Ğ¾Ñ. Ğ¿Ñ€Ğ°Ğ·Ğ´Ğ½Ğ¸ĞºĞ¸")
async def import_public_holidays(
        country_code: str = Query("RU", description="ISO 3166-1 alpha-2 ĞºĞ¾Ğ´ ÑÑ‚Ñ€Ğ°Ğ½Ñ‹"),
        year: int = Query(datetime.now().year, description="Ğ“Ğ¾Ğ´ Ğ´Ğ»Ñ Ğ¸Ğ¼Ğ¿Ğ¾Ñ€Ñ‚Ğ°"),
        db: AsyncSession = Depends(get_db),
        current_user: User = Depends(require_admin)
):
    """Ğ˜Ğ¼Ğ¿Ğ¾Ñ€Ñ‚Ğ¸Ñ€ÑƒĞµÑ‚ Ğ³Ğ¾ÑÑƒĞ´Ğ°Ñ€ÑÑ‚Ğ²ĞµĞ½Ğ½Ñ‹Ğµ Ğ¿Ñ€Ğ°Ğ·Ğ´Ğ½Ğ¸ĞºĞ¸ Ğ´Ğ»Ñ ÑƒĞºĞ°Ğ·Ğ°Ğ½Ğ½Ğ¾Ğ¹ ÑÑ‚Ñ€Ğ°Ğ½Ñ‹ Ğ¸ Ğ³Ğ¾Ğ´Ğ°."""
    try:
        public_holidays = holidays.country_holidays(country_code, years=year)
        if not public_holidays:
            raise HTTPException(status_code=404, detail=f"ĞĞµ Ğ½Ğ°Ğ¹Ğ´ĞµĞ½Ñ‹ Ğ¿Ñ€Ğ°Ğ·Ğ´Ğ½Ğ¸ĞºĞ¸ Ğ´Ğ»Ñ ÑÑ‚Ñ€Ğ°Ğ½Ñ‹ '{country_code}' Ğ² {year} Ğ³Ğ¾Ğ´Ñƒ.")
    except KeyError:
        raise HTTPException(status_code=400, detail=f"ĞĞµĞ²ĞµÑ€Ğ½Ñ‹Ğ¹ ĞºĞ¾Ğ´ ÑÑ‚Ñ€Ğ°Ğ½Ñ‹: '{country_code}'")

    rule_description = f"Ğ˜Ğ¼Ğ¿Ğ¾Ñ€Ñ‚ Ğ³Ğ¾Ñ. Ğ¿Ñ€Ğ°Ğ·Ğ´Ğ½Ğ¸ĞºĞ¾Ğ² Ğ´Ğ»Ñ {country_code} Ğ½Ğ° {year} Ğ³Ğ¾Ğ´"
    new_rule = HolidayRule(
        rule_type="public_import",
        parameters={"country": country_code, "year": year},
        description=rule_description,
        created_by_id=current_user.id
    )
    db.add(new_rule)
    await db.flush()

    holidays_to_create = []
    for holiday_date, holiday_name in public_holidays.items():
        exists_result = await db.execute(select(Holiday).filter(Holiday.date == holiday_date))
        exists = exists_result.scalars().first()
        if not exists:
            holidays_to_create.append(
                Holiday(
                    date=holiday_date,
                    description=holiday_name,
                    created_by_id=current_user.id,
                    rule_id=new_rule.id
                )
            )

    if holidays_to_create:
        db.add_all(holidays_to_create)

    await db.commit()
    return {"message": f"ĞŸÑ€Ğ°Ğ²Ğ¸Ğ»Ğ¾ Ğ¸Ğ¼Ğ¿Ğ¾Ñ€Ñ‚Ğ° ÑĞ¾Ğ·Ğ´Ğ°Ğ½Ğ¾. Ğ”Ğ¾Ğ±Ğ°Ğ²Ğ»ĞµĞ½Ğ¾ {len(holidays_to_create)} Ğ¿Ñ€Ğ°Ğ·Ğ´Ğ½Ğ¸Ñ‡Ğ½Ñ‹Ñ… Ğ´Ğ½ĞµĞ¹."}

@router.get("/rules", response_model=HolidayRuleListResponse, summary="ĞŸĞ¾Ğ»ÑƒÑ‡Ğ¸Ñ‚ÑŒ ÑĞ¿Ğ¸ÑĞ¾Ğº Ğ²ÑĞµÑ… Ğ¿Ñ€Ğ°Ğ²Ğ¸Ğ»")
async def get_all_rules(
        db: AsyncSession = Depends(get_db),
        current_user: User = Depends(require_admin),
        skip: int = Query(0, ge=0, description="Ğ¡ĞºĞ¾Ğ»ÑŒĞºĞ¾ Ğ·Ğ°Ğ¿Ğ¸ÑĞµĞ¹ Ğ¿Ñ€Ğ¾Ğ¿ÑƒÑÑ‚Ğ¸Ñ‚ÑŒ"),
        limit: int = Query(10, ge=1, le=100, description="ĞœĞ°ĞºÑĞ¸Ğ¼Ğ°Ğ»ÑŒĞ½Ğ¾Ğµ ĞºĞ¾Ğ»Ğ¸Ñ‡ĞµÑÑ‚Ğ²Ğ¾ Ğ·Ğ°Ğ¿Ğ¸ÑĞµĞ¹ Ğ½Ğ° ÑÑ‚Ñ€Ğ°Ğ½Ğ¸Ñ†Ğµ")
):
    """Ğ’Ğ¾Ğ·Ğ²Ñ€Ğ°Ñ‰Ğ°ĞµÑ‚ Ğ²ÑĞµ ÑĞ¾Ğ·Ğ´Ğ°Ğ½Ğ½Ñ‹Ğµ Ğ¿Ñ€Ğ°Ğ²Ğ¸Ğ»Ğ° Ğ´Ğ»Ñ Ğ³ĞµĞ½ĞµÑ€Ğ°Ñ†Ğ¸Ğ¸ Ğ²Ñ‹Ñ…Ğ¾Ğ´Ğ½Ñ‹Ñ… Ñ Ğ¿Ğ°Ğ³Ğ¸Ğ½Ğ°Ñ†Ğ¸ĞµĞ¹."""
    # 1. Ğ—Ğ°Ğ¿Ñ€Ğ¾Ñ Ğ´Ğ»Ñ Ğ¿Ğ¾Ğ»ÑƒÑ‡ĞµĞ½Ğ¸Ñ Ğ¾Ğ±Ñ‰ĞµĞ³Ğ¾ ĞºĞ¾Ğ»Ğ¸Ñ‡ĞµÑÑ‚Ğ²Ğ° Ğ¿Ñ€Ğ°Ğ²Ğ¸Ğ»
    total_result = await db.execute(select(func.count(HolidayRule.id)))
    total_rules = total_result.scalar_one()

    # 2. Ğ—Ğ°Ğ¿Ñ€Ğ¾Ñ Ğ´Ğ»Ñ Ğ¿Ğ¾Ğ»ÑƒÑ‡ĞµĞ½Ğ¸Ñ "ÑÑ‚Ñ€Ğ°Ğ½Ğ¸Ñ†Ñ‹" Ğ¿Ñ€Ğ°Ğ²Ğ¸Ğ»
    rules_result = await db.execute(
        select(HolidayRule).order_by(HolidayRule.created_at.desc()).offset(skip).limit(limit)
    )
    rules_orm = rules_result.scalars().all()

    # 3. Ğ¤Ğ¾Ñ€Ğ¼Ğ¸Ñ€ÑƒĞµĞ¼ Ğ¸ Ğ²Ğ¾Ğ·Ğ²Ñ€Ğ°Ñ‰Ğ°ĞµĞ¼ Ğ½Ğ¾Ğ²Ñ‹Ğ¹ Ğ¾Ğ±ÑŠĞµĞºÑ‚ Ğ¾Ñ‚Ğ²ĞµÑ‚Ğ°
    return HolidayRuleListResponse(
        items=[HolidayRuleOut.from_orm(rule) for rule in rules_orm],
        total=total_rules
    )


@router.delete("/rules/{rule_id}", status_code=204, summary="Ğ£Ğ´Ğ°Ğ»Ğ¸Ñ‚ÑŒ Ğ¿Ñ€Ğ°Ğ²Ğ¸Ğ»Ğ¾ Ğ¸ ÑĞ²ÑĞ·Ğ°Ğ½Ğ½Ñ‹Ğµ Ñ Ğ½Ğ¸Ğ¼ Ğ²Ñ‹Ñ…Ğ¾Ğ´Ğ½Ñ‹Ğµ")
async def delete_rule(
        rule_id: int,
        db: AsyncSession = Depends(get_db),
        current_user: User = Depends(require_admin)
):
    """Ğ£Ğ´Ğ°Ğ»ÑĞµÑ‚ Ğ¿Ñ€Ğ°Ğ²Ğ¸Ğ»Ğ¾. Ğ‘Ğ»Ğ°Ğ³Ğ¾Ğ´Ğ°Ñ€Ñ `cascade='all, delete-orphan'`, Ğ²ÑĞµ ÑĞ¾Ğ·Ğ´Ğ°Ğ½Ğ½Ñ‹Ğµ Ğ¸Ğ¼ Ğ²Ñ‹Ñ…Ğ¾Ğ´Ğ½Ñ‹Ğµ Ğ±ÑƒĞ´ÑƒÑ‚ ÑƒĞ´Ğ°Ğ»ĞµĞ½Ñ‹ Ğ°Ğ²Ñ‚Ğ¾Ğ¼Ğ°Ñ‚Ğ¸Ñ‡ĞµÑĞºĞ¸."""
    result = await db.execute(select(HolidayRule).filter(HolidayRule.id == rule_id))
    rule = result.scalars().first()
    if not rule:
        raise HTTPException(status_code=404, detail="ĞŸÑ€Ğ°Ğ²Ğ¸Ğ»Ğ¾ Ğ½Ğµ Ğ½Ğ°Ğ¹Ğ´ĞµĞ½Ğ¾.")

    await db.delete(rule)
    await db.commit()
    return None

```



## `api\init_models.py`


```python

# ĞŸÑ€Ğ¸Ğ¼ĞµÑ€ Ğ´Ğ»Ñ api/init_models.py
from api.database import engine, Base
# âœ… Ğ­Ñ‚Ğ¾Ñ‚ Ğ¸Ğ¼Ğ¿Ğ¾Ñ€Ñ‚ ÑƒĞ¶Ğµ Ğ²ĞºĞ»ÑÑ‡Ğ°ĞµÑ‚ Ğ½Ğ°Ñˆ Ğ½Ğ¾Ğ²Ñ‹Ğ¹ ĞºĞ»Ğ°ÑÑ PromoCodeApplicableType
from api.models import user, equipment, reservation, accessory, promo_code

if __name__ == "__main__":
    Base.metadata.create_all(bind=engine)
    print("âœ… FastAPI-Ğ¼Ğ¾Ğ´ĞµĞ»Ğ¸ ÑƒÑĞ¿ĞµÑˆĞ½Ğ¾ Ğ¸Ğ½Ğ¸Ñ†Ğ¸Ğ°Ğ»Ğ¸Ğ·Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ñ‹")

```



## `api\main_api.py`


```python

# api/main_api.py

import secrets
import logging # <--- Ğ”ĞĞ‘ĞĞ’Ğ¬Ğ¢Ğ• Ğ­Ğ¢ĞĞ¢ Ğ˜ĞœĞŸĞĞ Ğ¢

from fastapi import FastAPI, Request, Response, HTTPException, status
from fastapi.middleware.cors import CORSMiddleware
from starlette.middleware.base import BaseHTTPMiddleware
from starlette.datastructures import State

from api.router import router as all_routes

# --- CSRF Protection Imports and Setup ---
from fastapi_csrf_protect import CsrfProtect
from fastapi_csrf_protect.exceptions import CsrfProtectError
from pydantic_settings import BaseSettings, SettingsConfigDict
from pydantic import Field
from fastapi.responses import JSONResponse

# --- Rate Limiting Imports ---
from slowapi import Limiter, _rate_limit_exceeded_handler
from slowapi.util import get_remote_address
from slowapi.errors import RateLimitExceeded

# --- ĞĞĞ¡Ğ¢Ğ ĞĞ™ĞšĞ Ğ›ĞĞ“Ğ“Ğ˜Ğ ĞĞ’ĞĞĞ˜Ğ¯ ---
logging.basicConfig(level=logging.INFO)
logger = logging.getLogger(__name__)

# --- CSRF Configuration ---
class CsrfSettings(BaseSettings):
    secret_key: str = Field(..., alias="CSRF_SECRET_KEY")
    model_config = SettingsConfigDict(
        env_file=".env",
        env_file_encoding="utf-8",
        extra="ignore"
    )


@CsrfProtect.load_config
def get_csrf_config():
    try:
        settings = CsrfSettings()
        return settings
    except Exception as e:
        logger.critical(
            "ĞšĞ Ğ˜Ğ¢Ğ˜Ğ§Ğ•Ğ¡ĞšĞĞ¯ ĞĞ¨Ğ˜Ğ‘ĞšĞ: ĞĞµ ÑƒĞ´Ğ°Ğ»Ğ¾ÑÑŒ Ğ·Ğ°Ğ³Ñ€ÑƒĞ·Ğ¸Ñ‚ÑŒ ĞºĞ¾Ğ½Ñ„Ğ¸Ğ³ÑƒÑ€Ğ°Ñ†Ğ¸Ñ CSRF. "
            "Ğ£Ğ±ĞµĞ´Ğ¸Ñ‚ĞµÑÑŒ, Ñ‡Ñ‚Ğ¾ Ğ¿ĞµÑ€ĞµĞ¼ĞµĞ½Ğ½Ğ°Ñ CSRF_SECRET_KEY Ğ·Ğ°Ğ´Ğ°Ğ½Ğ° Ğ² Ğ²Ğ°ÑˆĞµĞ¼ .env Ñ„Ğ°Ğ¹Ğ»Ğµ!"
        )
        raise e

# --- Rate Limiter Configuration ---
limiter = Limiter(key_func=get_remote_address, default_limits=["200/minute"])

# --- FastAPI App Initialization ---
app = FastAPI(title="Rental System API")

# --- Rate Limiter State and Exception Handler ---
app.state.limiter = limiter
app.add_exception_handler(RateLimitExceeded, _rate_limit_exceeded_handler)

# --- CSRF Exception Handler ---
@app.exception_handler(CsrfProtectError)
def csrf_protect_exception_handler(request: Request, exc: CsrfProtectError):
    return JSONResponse(
        status_code=exc.status_code,
        content={"detail": exc.message}
    )

# --- ĞĞĞ’ĞĞ¯ MIDDLEWARE Ğ”Ğ›Ğ¯ Ğ›ĞĞ“Ğ“Ğ˜Ğ ĞĞ’ĞĞĞ˜Ğ¯ Ğ—ĞĞŸĞ ĞĞ¡ĞĞ’ ---
class LoggingMiddleware(BaseHTTPMiddleware):
    async def dispatch(self, request: Request, call_next):
        logger.info(f"Incoming request: {request.method} {request.url.path}")
        response = await call_next(request)
        return response

# --- Secure Headers Middleware ---
class SecureHeadersMiddleware(BaseHTTPMiddleware):
    async def dispatch(self, request: Request, call_next):
        response: Response = await call_next(request)
        response.headers["X-Content-Type-Options"] = "nosniff"
        response.headers["X-Frame-Options"] = "DENY"
        response.headers["Content-Security-Policy"] = (
            "default-src 'self'; "
            "script-src 'self' 'unsafe-inline'; "
            "style-src 'self' 'unsafe-inline'; "
            "object-src 'none'; "
            "frame-ancestors 'none'; "
            "img-src 'self' data:;"
        )
        response.headers["Referrer-Policy"] = "strict-origin-when-cross-origin"
        response.headers["Permissions-Policy"] = "geolocation=(), microphone=(), camera=(), payment=()"
        return response

# --- Add Middlewares ---
app.add_middleware(LoggingMiddleware) # <--- Ğ”ĞĞ‘ĞĞ’Ğ¬Ğ¢Ğ• Ğ­Ğ¢Ğ£ Ğ¡Ğ¢Ğ ĞĞšĞ£

app.add_middleware(
    CORSMiddleware,
    allow_origins=["http://localhost:5173"],
    allow_credentials=True,
    allow_methods=["*"],
    allow_headers=["*", "X-CSRF-Token"],
)
app.add_middleware(SecureHeadersMiddleware)

app.include_router(all_routes)

```



## `api\models\accessory.py`


```python

# api/models/accessory.py

from sqlalchemy import Column, Integer, String, Float, Text, Table, ForeignKey
from sqlalchemy.orm import relationship
from api.database import Base

equipment_accessories_association = Table(
    'equipment_accessories', Base.metadata,
    Column('equipment_id', Integer, ForeignKey('equipment.id'), primary_key=True),
    Column('accessory_id', Integer, ForeignKey('accessories.id'), primary_key=True)
)

class Accessory(Base):
    __tablename__ = "accessories"

    id = Column(Integer, primary_key=True, index=True)
    name = Column(String, nullable=False, index=True)
    accessory_type = Column(String, default="ĞŸÑ€Ğ¾Ñ‡ĞµĞµ", index=True)
    price = Column(Float, default=0.0)
    description = Column(Text, nullable=True)

    equipment_items = relationship(
        "Equipment",
        secondary=equipment_accessories_association,
        back_populates="accessories"
    )

    # --- Ğ˜Ğ¡ĞŸĞ ĞĞ’Ğ›Ğ•ĞĞ˜Ğ• Ğ—Ğ”Ğ•Ğ¡Ğ¬ ---
    # Ğ¯Ğ²Ğ½Ğ¾ ÑƒĞºĞ°Ğ·Ñ‹Ğ²Ğ°ĞµĞ¼ SQLAlchemy, ĞºĞ°Ğº ÑÑ‚Ğ° Ğ¼Ğ¾Ğ´ĞµĞ»ÑŒ ÑĞ²ÑĞ·Ğ°Ğ½Ğ° Ñ Ñ‚Ğ°Ğ±Ğ»Ğ¸Ñ†Ğ°Ğ¼Ğ¸-Ğ¿Ğ¾ÑÑ€ĞµĞ´Ğ½Ğ¸ĞºĞ°Ğ¼Ğ¸
    reservation_links = relationship("ReservationAccessory", back_populates="accessory")
    rental_links = relationship("RentalAccessory", back_populates="accessory")
    # -------------------------

    def __repr__(self):
        return f"<Accessory(id={self.id}, name='{self.name}')>"

```



## `api\models\association.py`


```python

# api/models/association.py

from sqlalchemy import Column, Integer, String, Text, Table, ForeignKey
from sqlalchemy.orm import relationship
from api.database import Base

association_equipment_association = Table(
    # V-- Ğ’ĞĞ–ĞĞ: Ğ˜Ğ¼Ñ Ñ‚Ğ°Ğ±Ğ»Ğ¸Ñ†Ñ‹ Ğ² Ğ±Ğ°Ğ·Ğµ Ğ´Ğ°Ğ½Ğ½Ñ‹Ñ…. Ğ”Ğ°Ğ²Ğ°Ğ¹Ñ‚Ğµ ÑĞ´ĞµĞ»Ğ°ĞµĞ¼ ĞµĞ³Ğ¾ ĞºĞ¾Ğ½ÑĞ¸ÑÑ‚ĞµĞ½Ñ‚Ğ½Ñ‹Ğ¼.
    'association_equipment_association', Base.metadata,
    Column('association_id', Integer, ForeignKey('associations.id'), primary_key=True),
    Column('equipment_id', Integer, ForeignKey('equipment.id'), primary_key=True)
)

class Association(Base):
    __tablename__ = "associations"

    id = Column(Integer, primary_key=True, index=True)
    name = Column(String, nullable=False, unique=True, index=True)
    description = Column(Text, nullable=True)
    sort_order = Column(Integer, default=0, nullable=False)

    # Ğ¡Ğ²ÑĞ·ÑŒ "Ğ¼Ğ½Ğ¾Ğ³Ğ¸Ğµ-ĞºĞ¾-Ğ¼Ğ½Ğ¾Ğ³Ğ¸Ğ¼" Ñ Ğ¾Ğ±Ğ¾Ñ€ÑƒĞ´Ğ¾Ğ²Ğ°Ğ½Ğ¸ĞµĞ¼
    equipment = relationship(
        "Equipment",
        secondary=association_equipment_association,
        # V-- Ğ˜Ğ¡ĞŸĞ ĞĞ’Ğ›Ğ•ĞĞ˜Ğ•: Ğ´Ğ¾Ğ»Ğ¶Ğ½Ğ¾ ÑĞ¾Ğ¾Ñ‚Ğ²ĞµÑ‚ÑÑ‚Ğ²Ğ¾Ğ²Ğ°Ñ‚ÑŒ Ğ¸Ğ¼ĞµĞ½Ğ¸ Ğ² Equipment
        back_populates="associations"
    )

    @property
    def equipment_ids(self) -> list[int]:
        """Ğ’Ğ¾Ğ·Ğ²Ñ€Ğ°Ñ‰Ğ°ĞµÑ‚ ÑĞ¿Ğ¸ÑĞ¾Ğº ID ÑĞ²ÑĞ·Ğ°Ğ½Ğ½Ğ¾Ğ³Ğ¾ Ğ¾Ğ±Ğ¾Ñ€ÑƒĞ´Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ."""
        return [item.id for item in self.equipment] if self.equipment else []

    def __repr__(self):
        return f"<Association(id={self.id}, name='{self.name}')>"

```



## `api\models\balance_history.py`


```python

# api/models/balance_history.py

from sqlalchemy import Column, Integer, String, Float, DateTime, ForeignKey, Text
from sqlalchemy.orm import relationship
from api.database import Base
from datetime import datetime, timezone

class BalanceHistory(Base):
    __tablename__ = "balance_history"

    id = Column(Integer, primary_key=True)
    user_id = Column(Integer, ForeignKey("users.id"), nullable=False)
    # +++ Ğ˜Ğ—ĞœĞ•ĞĞ•ĞĞ˜Ğ•: Ğ”Ğ¾Ğ±Ğ°Ğ²Ğ»ÑĞµĞ¼ ĞºĞ°ÑĞºĞ°Ğ´Ğ½Ğ¾Ğµ ÑƒĞ´Ğ°Ğ»ĞµĞ½Ğ¸Ğµ Ğ½Ğ° ÑƒÑ€Ğ¾Ğ²Ğ½Ğµ Ğ‘Ğ” +++
    rental_id = Column(Integer, ForeignKey("rentals.id", ondelete="CASCADE"), nullable=True)

    amount = Column(Float, nullable=False, comment="Ğ¡ÑƒĞ¼Ğ¼Ğ° Ğ¾Ğ¿ĞµÑ€Ğ°Ñ†Ğ¸Ğ¸. ĞÑ‚Ñ€Ğ¸Ñ†Ğ°Ñ‚ĞµĞ»ÑŒĞ½Ğ°Ñ Ğ´Ğ»Ñ ÑĞ¿Ğ¸ÑĞ°Ğ½Ğ¸Ñ, Ğ¿Ğ¾Ğ»Ğ¾Ğ¶Ğ¸Ñ‚ĞµĞ»ÑŒĞ½Ğ°Ñ Ğ´Ğ»Ñ Ğ½Ğ°Ñ‡Ğ¸ÑĞ»ĞµĞ½Ğ¸Ñ.")
    operation_type = Column(String, nullable=False, comment="Ğ¢Ğ¸Ğ¿ Ğ¾Ğ¿ĞµÑ€Ğ°Ñ†Ğ¸Ğ¸ (e.g., rental_debit, early_return_credit)")
    description = Column(Text, nullable=True, comment="ĞĞ¿Ğ¸ÑĞ°Ğ½Ğ¸Ğµ Ğ¾Ğ¿ĞµÑ€Ğ°Ñ†Ğ¸Ğ¸")

    created_at = Column(DateTime(timezone=True), default=lambda: datetime.now(timezone.utc))

    # Ğ¡Ğ²ÑĞ·Ğ¸
    user = relationship("User", back_populates="balance_history")
    rental = relationship("Rental", back_populates="balance_history")

    def __repr__(self):
        return f"<BalanceHistory(id={self.id}, user_id={self.user_id}, amount={self.amount})>"

```



## `api\models\discount.py`


```python

# api/models/discount.py

from sqlalchemy import Column, Integer
from api.database import Base

class DurationDiscount(Base):
    """
    ĞœĞ¾Ğ´ĞµĞ»ÑŒ Ğ´Ğ»Ñ Ñ…Ñ€Ğ°Ğ½ĞµĞ½Ğ¸Ñ Ğ¿Ğ¾Ñ€Ğ¾Ğ³Ğ¾Ğ²Ñ‹Ñ… Ğ·Ğ½Ğ°Ñ‡ĞµĞ½Ğ¸Ğ¹ ÑĞºĞ¸Ğ´Ğ¾Ğº Ğ·Ğ° Ğ´Ğ»Ğ¸Ñ‚ĞµĞ»ÑŒĞ½Ğ¾ÑÑ‚ÑŒ Ğ°Ñ€ĞµĞ½Ğ´Ñ‹.
    ĞĞ°Ğ¿Ñ€Ğ¸Ğ¼ĞµÑ€: Ğ¾Ñ‚ 3 Ğ´Ğ¾ 6 Ğ´Ğ½ĞµĞ¹ - 10% ÑĞºĞ¸Ğ´ĞºĞ°.
    """
    __tablename__ = "duration_discounts"

    id = Column(Integer, primary_key=True)
    min_days = Column(Integer, unique=True, nullable=False, comment="ĞœĞ¸Ğ½Ğ¸Ğ¼Ğ°Ğ»ÑŒĞ½Ğ¾Ğµ ĞºĞ¾Ğ»Ğ¸Ñ‡ĞµÑÑ‚Ğ²Ğ¾ Ğ´Ğ½ĞµĞ¹ Ğ´Ğ»Ñ ÑĞºĞ¸Ğ´ĞºĞ¸ (Ğ²ĞºĞ»ÑÑ‡Ğ¸Ñ‚ĞµĞ»ÑŒĞ½Ğ¾)")
    discount_percentage = Column(Integer, nullable=False, comment="ĞŸÑ€Ğ¾Ñ†ĞµĞ½Ñ‚ ÑĞºĞ¸Ğ´ĞºĞ¸")

```



## `api\models\equipment.py`


```python

# api/models/equipment.py

from sqlalchemy import Column, Integer, String, Float, Date, Text, JSON
from sqlalchemy.orm import relationship
from api.database import Base
from api.models.accessory import equipment_accessories_association
from api.models.reservation import reservation_equipment_association
from api.models.promo_code import promo_code_equipment_association
from api.models.association import association_equipment_association

class Equipment(Base):
    __tablename__ = "equipment"

    id = Column(Integer, primary_key=True)
    equipment_type = Column(String, nullable=False)
    brand = Column(String, nullable=False)
    name = Column(String, nullable=False)
    serial_number = Column(String, unique=True)
    condition = Column(String, default="Ğ’ĞµĞ»Ğ¸ĞºĞ¾Ğ»ĞµĞ¿Ğ½Ğ¾")
    daily_rate = Column(Float, default=0.0)
    notes = Column(String)

    # âœ… Ğ˜Ğ—ĞœĞ•ĞĞ•ĞĞ˜Ğ•: Ğ¢Ğ¸Ğ¿ Ğ¿Ğ¾Ğ»Ñ Ğ¸Ğ·Ğ¼ĞµĞ½ĞµĞ½ Ñ DateTime Ğ½Ğ° Date
    last_maintenance = Column(Date)

    description = Column(Text)
    image_url = Column(String, nullable=True)
    image_urls = Column(JSON, nullable=True)
    short_description = Column(String, nullable=True)

    accessories = relationship(
        "Accessory",
        secondary=equipment_accessories_association,
        back_populates="equipment_items"
    )

    reservations = relationship(
        "Reservation",
        secondary=reservation_equipment_association,
        back_populates="equipment"
    )

    applicable_promo_codes = relationship(
        "PromoCode",
        secondary=promo_code_equipment_association,
        back_populates="applicable_equipment"
    )

    # Ğ¡Ğ²ÑĞ·ÑŒ Ğ¼Ğ½Ğ¾Ğ³Ğ¸Ğµ-ĞºĞ¾-Ğ¼Ğ½Ğ¾Ğ³Ğ¸Ğ¼ Ñ Association
    associations = relationship(
        "Association",
        secondary=association_equipment_association,
        back_populates="equipment"
    )

```



## `api\models\holiday.py`


```python

# api/models/holiday.py

from sqlalchemy import Column, Integer, String, DateTime, Date, ForeignKey, JSON
from sqlalchemy.orm import relationship
from api.database import Base
from datetime import datetime, timezone

# +++ ĞĞĞ§ĞĞ›Ğ: ĞĞĞ’ĞĞ¯ ĞœĞĞ”Ğ•Ğ›Ğ¬ Ğ”Ğ›Ğ¯ ĞŸĞ ĞĞ’Ğ˜Ğ› +++
class HolidayRule(Base):
    """ĞœĞ¾Ğ´ĞµĞ»ÑŒ Ğ´Ğ»Ñ Ñ…Ñ€Ğ°Ğ½ĞµĞ½Ğ¸Ñ Ğ¿Ñ€Ğ°Ğ²Ğ¸Ğ» Ğ°Ğ²Ñ‚Ğ¾Ğ¼Ğ°Ñ‚Ğ¸Ñ‡ĞµÑĞºĞ¾Ğ³Ğ¾ ÑĞ¾Ğ·Ğ´Ğ°Ğ½Ğ¸Ñ Ğ²Ñ‹Ñ…Ğ¾Ğ´Ğ½Ñ‹Ñ…."""
    __tablename__ = "holiday_rules"

    id = Column(Integer, primary_key=True)
    rule_type = Column(String, nullable=False, comment="Ğ¢Ğ¸Ğ¿ Ğ¿Ñ€Ğ°Ğ²Ğ¸Ğ»Ğ°, Ğ½Ğ°Ğ¿Ñ€Ğ¸Ğ¼ĞµÑ€ 'weekly' Ğ¸Ğ»Ğ¸ 'public_import'")
    parameters = Column(JSON, nullable=False, comment="ĞŸĞ°Ñ€Ğ°Ğ¼ĞµÑ‚Ñ€Ñ‹ Ğ¿Ñ€Ğ°Ğ²Ğ¸Ğ»Ğ°, Ğ½Ğ°Ğ¿Ñ€Ğ¸Ğ¼ĞµÑ€ {'day_of_week': 6} Ğ´Ğ»Ñ Ğ²Ğ¾ÑĞºÑ€ĞµÑĞµĞ½ÑŒÑ")
    description = Column(String, nullable=False, comment="ĞĞ¿Ğ¸ÑĞ°Ğ½Ğ¸Ğµ Ğ¿Ñ€Ğ°Ğ²Ğ¸Ğ»Ğ° Ğ´Ğ»Ñ Ğ°Ğ´Ğ¼Ğ¸Ğ½Ğ°")
    created_at = Column(DateTime(timezone=True), default=lambda: datetime.now(timezone.utc))
    created_by_id = Column(Integer, ForeignKey("users.id"), nullable=False)

    creator = relationship("User")
    # Ğ¡Ğ²ÑĞ·ÑŒ Ğ´Ğ»Ñ ĞºĞ°ÑĞºĞ°Ğ´Ğ½Ğ¾Ğ³Ğ¾ ÑƒĞ´Ğ°Ğ»ĞµĞ½Ğ¸Ñ Ğ²ÑĞµÑ… Ğ²Ñ‹Ñ…Ğ¾Ğ´Ğ½Ñ‹Ñ…, ÑĞ¾Ğ·Ğ´Ğ°Ğ½Ğ½Ñ‹Ñ… ÑÑ‚Ğ¸Ğ¼ Ğ¿Ñ€Ğ°Ğ²Ğ¸Ğ»Ğ¾Ğ¼
    holidays = relationship("Holiday", back_populates="rule", cascade="all, delete-orphan")
# +++ ĞšĞĞĞ•Ğ¦: ĞĞĞ’ĞĞ¯ ĞœĞĞ”Ğ•Ğ›Ğ¬ Ğ”Ğ›Ğ¯ ĞŸĞ ĞĞ’Ğ˜Ğ› +++


class Holiday(Base):
    __tablename__ = "holidays"

    date = Column(Date, primary_key=True, index=True, comment="Ğ”Ğ°Ñ‚Ğ° Ğ²Ñ‹Ñ…Ğ¾Ğ´Ğ½Ğ¾Ğ³Ğ¾ Ğ´Ğ½Ñ")
    description = Column(String, nullable=True, comment="ĞĞ°Ğ·Ğ²Ğ°Ğ½Ğ¸Ğµ (Ğ½Ğ°Ğ¿Ñ€Ğ¸Ğ¼ĞµÑ€, ĞĞ¾Ğ²Ñ‹Ğ¹ Ğ³Ğ¾Ğ´)")
    created_at = Column(DateTime(timezone=True), default=lambda: datetime.now(timezone.utc))
    created_by_id = Column(Integer, ForeignKey("users.id"), nullable=False)

    # +++ ĞĞĞ§ĞĞ›Ğ: Ğ˜Ğ—ĞœĞ•ĞĞ•ĞĞ˜Ğ¯ Ğ’ ĞœĞĞ”Ğ•Ğ›Ğ˜ HOLIDAY +++
    rule_id = Column(Integer, ForeignKey("holiday_rules.id"), nullable=True, comment="ID Ğ¿Ñ€Ğ°Ğ²Ğ¸Ğ»Ğ°, ĞºĞ¾Ñ‚Ğ¾Ñ€Ñ‹Ğ¼ ÑĞ¾Ğ·Ğ´Ğ°Ğ½ ÑÑ‚Ğ¾Ñ‚ Ğ²Ñ‹Ñ…Ğ¾Ğ´Ğ½Ğ¾Ğ¹")
    rule = relationship("HolidayRule", back_populates="holidays")
    # +++ ĞšĞĞĞ•Ğ¦: Ğ˜Ğ—ĞœĞ•ĞĞ•ĞĞ˜Ğ¯ Ğ’ ĞœĞĞ”Ğ•Ğ›Ğ˜ HOLIDAY +++

    creator = relationship("User")

    def __repr__(self):
        return f"<Holiday(date='{self.date.strftime('%Y-%m-%d')}', description='{self.description}')>"

```



## `api\models\payment.py`


```python

# api/models/payment.py

from sqlalchemy import (Column, Integer, String, Float, DateTime,
                        ForeignKey, Text)
from sqlalchemy.orm import relationship
from api.database import Base
from datetime import datetime, timezone

class Payment(Base):
    __tablename__ = "payments"

    id = Column(Integer, primary_key=True)
    user_id = Column(Integer, ForeignKey("users.id"), nullable=False)
    # +++ Ğ˜Ğ—ĞœĞ•ĞĞ•ĞĞ˜Ğ•: Ğ”Ğ¾Ğ±Ğ°Ğ²Ğ»ÑĞµĞ¼ ĞºĞ°ÑĞºĞ°Ğ´Ğ½Ğ¾Ğµ ÑƒĞ´Ğ°Ğ»ĞµĞ½Ğ¸Ğµ Ğ½Ğ° ÑƒÑ€Ğ¾Ğ²Ğ½Ğµ Ğ‘Ğ” +++
    rental_id = Column(Integer, ForeignKey("rentals.id", ondelete="CASCADE"), nullable=True)
    amount = Column(Float, nullable=False)

    payment_date = Column(DateTime(timezone=True), default=lambda: datetime.now(timezone.utc))

    payment_method = Column(String)
    transaction_type = Column(String, nullable=False)  # e.g., 'rental_payment', 'deposit', 'refund'
    description = Column(Text, nullable=True)

    user = relationship("User")
    rental = relationship("Rental", back_populates="payments")

```



## `api\models\promo_code.py`


```python

# api/models/promo_code.py

from sqlalchemy import (Column, Integer, String, Float, DateTime, Boolean,
                        ForeignKey, Table, Text)
from sqlalchemy.orm import relationship
from api.database import Base
# âœ… Ğ˜Ğ¼Ğ¿Ğ¾Ñ€Ñ‚Ğ¸Ñ€ÑƒĞµĞ¼ timezone
from datetime import datetime, timezone

# ĞŸÑ€Ğ¾Ğ¼ĞµĞ¶ÑƒÑ‚Ğ¾Ñ‡Ğ½Ğ°Ñ Ñ‚Ğ°Ğ±Ğ»Ğ¸Ñ†Ğ° Ğ´Ğ»Ñ Ğ¾Ñ‚ÑĞ»ĞµĞ¶Ğ¸Ğ²Ğ°Ğ½Ğ¸Ñ Ğ¸ÑĞ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğ¹ Ğ¿Ñ€Ğ¾Ğ¼Ğ¾ĞºĞ¾Ğ´Ğ¾Ğ² Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ÑĞ¼Ğ¸
promo_code_usages = Table(
    'promo_code_usages', Base.metadata,
    Column('user_id', Integer, ForeignKey('users.id'), primary_key=True),
    Column('promo_code_id', Integer, ForeignKey('promo_codes.id'), primary_key=True),
    # âœ… Ğ˜Ğ—ĞœĞ•ĞĞ•ĞĞ˜Ğ•: Ğ”Ğ¾Ğ±Ğ°Ğ²Ğ»ÑĞµĞ¼ timezone=True
    Column('used_at', DateTime(timezone=True), default=lambda: datetime.now(timezone.utc))
)

# ĞÑÑĞ¾Ñ†Ğ¸Ğ°Ñ‚Ğ¸Ğ²Ğ½Ğ°Ñ Ñ‚Ğ°Ğ±Ğ»Ğ¸Ñ†Ğ° Ğ´Ğ»Ñ ÑĞ²ÑĞ·Ğ¸ Ğ¿Ñ€Ğ¾Ğ¼Ğ¾ĞºĞ¾Ğ´Ğ° Ñ ID Ğ¾Ğ±Ğ¾Ñ€ÑƒĞ´Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ
promo_code_equipment_association = Table(
    'promo_code_equipment', Base.metadata,
    Column('promo_code_id', Integer, ForeignKey('promo_codes.id'), primary_key=True),
    Column('equipment_id', Integer, ForeignKey('equipment.id'), primary_key=True)
)

class PromoCode(Base):
    """
    ĞœĞ¾Ğ´ĞµĞ»ÑŒ Ğ´Ğ»Ñ Ñ…Ñ€Ğ°Ğ½ĞµĞ½Ğ¸Ñ Ğ¿Ñ€Ğ¾Ğ¼Ğ¾ĞºĞ¾Ğ´Ğ¾Ğ² Ğ¸ Ğ¸Ñ… ÑƒÑĞ»Ğ¾Ğ²Ğ¸Ğ¹.
    """
    __tablename__ = "promo_codes"

    id = Column(Integer, primary_key=True, index=True)
    code = Column(String, unique=True, index=True, nullable=False)
    description = Column(Text, nullable=True, comment="ĞšÑ€Ğ°Ñ‚ĞºĞ¾Ğµ Ğ¾Ğ¿Ğ¸ÑĞ°Ğ½Ğ¸Ğµ Ğ´Ğ»Ñ Ğ¼ĞµĞ½ĞµĞ´Ğ¶ĞµÑ€Ğ¾Ğ²")
    discount_percentage = Column(Float, nullable=False)

    # --- Ğ¡Ñ‚Ğ°Ñ‚ÑƒÑÑ‹ Ğ¸ ÑÑ€Ğ¾ĞºĞ¸ ---
    is_active = Column(Boolean, default=True)
    # âœ… Ğ˜Ğ—ĞœĞ•ĞĞ•ĞĞ˜Ğ•: Ğ”Ğ¾Ğ±Ğ°Ğ²Ğ»ÑĞµĞ¼ timezone=True
    valid_from = Column(DateTime(timezone=True), nullable=True, comment="Ğ”Ğ°Ñ‚Ğ° Ğ½Ğ°Ñ‡Ğ°Ğ»Ğ° Ğ´ĞµĞ¹ÑÑ‚Ğ²Ğ¸Ñ")
    # âœ… Ğ˜Ğ—ĞœĞ•ĞĞ•ĞĞ˜Ğ•: Ğ”Ğ¾Ğ±Ğ°Ğ²Ğ»ÑĞµĞ¼ timezone=True
    expires_at = Column(DateTime(timezone=True), nullable=True, comment="Ğ”Ğ°Ñ‚Ğ° Ğ¸ÑÑ‚ĞµÑ‡ĞµĞ½Ğ¸Ñ ÑÑ€Ğ¾ĞºĞ°")

    # --- ĞĞ³Ñ€Ğ°Ğ½Ğ¸Ñ‡ĞµĞ½Ğ¸Ñ Ğ¸ÑĞ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ ---
    max_uses = Column(Integer, nullable=True, comment="ĞĞ±Ñ‰Ğ¸Ğ¹ Ğ»Ğ¸Ğ¼Ğ¸Ñ‚ Ğ¸ÑĞ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğ¹")
    times_used = Column(Integer, default=0, nullable=False)
    max_uses_per_user = Column(Integer, nullable=True, comment="Ğ›Ğ¸Ğ¼Ğ¸Ñ‚ Ğ½Ğ° Ğ¾Ğ´Ğ½Ğ¾Ğ³Ğ¾ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ñ")

    # --- Ğ£ÑĞ»Ğ¾Ğ²Ğ¸Ñ Ğ¿Ñ€Ğ¸Ğ¼ĞµĞ½ĞµĞ½Ğ¸Ñ ---
    min_order_amount = Column(Float, nullable=True, comment="ĞœĞ¸Ğ½Ğ¸Ğ¼Ğ°Ğ»ÑŒĞ½Ğ°Ñ ÑÑƒĞ¼Ğ¼Ğ° Ğ·Ğ°ĞºĞ°Ğ·Ğ° Ğ´Ğ»Ñ Ğ°ĞºÑ‚Ğ¸Ğ²Ğ°Ñ†Ğ¸Ğ¸")
    specific_to_user_id = Column(Integer, ForeignKey("users.id"), nullable=True, comment="Ğ•ÑĞ»Ğ¸ ĞºĞ¾Ğ´ Ğ¿ĞµÑ€ÑĞ¾Ğ½Ğ°Ğ»ÑŒĞ½Ñ‹Ğ¹")

    # --- ĞœĞµÑ‚Ğ°Ğ´Ğ°Ğ½Ğ½Ñ‹Ğµ ---
    # âœ… Ğ˜Ğ—ĞœĞ•ĞĞ•ĞĞ˜Ğ•: Ğ”Ğ¾Ğ±Ğ°Ğ²Ğ»ÑĞµĞ¼ timezone=True
    created_at = Column(DateTime(timezone=True), default=lambda: datetime.now(timezone.utc))
    created_by_id = Column(Integer, ForeignKey("users.id"))

    # --- Ğ¡Ğ²ÑĞ·Ğ¸ ---
    creator = relationship("User", foreign_keys=[created_by_id])
    specific_user = relationship("User", foreign_keys=[specific_to_user_id])

    used_by_users = relationship(
        "User",
        secondary=promo_code_usages,
        back_populates="used_promo_codes"
    )

    applicable_equipment = relationship(
        "Equipment",
        secondary=promo_code_equipment_association,
        back_populates="applicable_promo_codes",
        lazy="joined"
    )

    applicable_types = relationship(
        "PromoCodeApplicableType",
        back_populates="promo_code",
        cascade="all, delete-orphan",
        lazy="joined"
    )

    # --- Ğ’ÑĞ¿Ğ¾Ğ¼Ğ¾Ğ³Ğ°Ñ‚ĞµĞ»ÑŒĞ½Ñ‹Ğµ ÑĞ²Ğ¾Ğ¹ÑÑ‚Ğ²Ğ° ---
    @property
    def applicable_to_equipment_ids(self) -> list[int]:
        return [item.id for item in self.applicable_equipment] if self.applicable_equipment else []

    @property
    def applicable_to_equipment_types(self) -> list[str]:
        return [item.type_name for item in self.applicable_types] if self.applicable_types else []

    def __repr__(self):
        return f"<PromoCode(code='{self.code}', discount={self.discount_percentage}%)>"


# ĞœĞ¾Ğ´ĞµĞ»ÑŒ-Ğ¿Ğ¾ÑÑ€ĞµĞ´Ğ½Ğ¸Ğº Ğ´Ğ»Ñ Ñ…Ñ€Ğ°Ğ½ĞµĞ½Ğ¸Ñ Ñ‚Ğ¸Ğ¿Ğ¾Ğ² Ğ¾Ğ±Ğ¾Ñ€ÑƒĞ´Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ
class PromoCodeApplicableType(Base):
    __tablename__ = 'promo_code_applicable_types'
    promo_code_id = Column(Integer, ForeignKey('promo_codes.id'), primary_key=True)
    type_name = Column(String, primary_key=True)

    promo_code = relationship("PromoCode", back_populates="applicable_types")

```



## `api\models\rental.py`


```python

# api/models/rental.py

from sqlalchemy import (Column, Integer, DateTime, ForeignKey, Float,
                        String, Text, Table, Boolean, Date)
from sqlalchemy.orm import relationship
from api.database import Base
from datetime import datetime, timezone

class RentalAccessory(Base):
    __tablename__ = 'rental_accessories'
    rental_id = Column(Integer, ForeignKey('rentals.id', ondelete="CASCADE"), primary_key=True)
    equipment_id = Column(Integer, ForeignKey('equipment.id'), primary_key=True)
    accessory_id = Column(Integer, ForeignKey('accessories.id'), primary_key=True)

    accessory = relationship("Accessory", back_populates="rental_links")
    rental = relationship("Rental", back_populates="accessory_links")

rental_equipment_association = Table('rental_equipment', Base.metadata,
                                     Column('rental_id', Integer, ForeignKey('rentals.id', ondelete="CASCADE"), primary_key=True),
                                     Column('equipment_id', Integer, ForeignKey('equipment.id'), primary_key=True)
                                     )

class Rental(Base):
    __tablename__ = "rentals"

    id = Column(Integer, primary_key=True)
    user_id = Column(Integer, ForeignKey("users.id"), nullable=False)
    created_by_id = Column(Integer, ForeignKey("users.id"), nullable=False)
    reservation_id = Column(Integer, ForeignKey("reservations.id"), nullable=True, unique=True)
    start_date = Column(Date, nullable=False)
    end_date = Column(Date, nullable=False)
    actual_return_date = Column(Date, nullable=True)
    status = Column(String, default="active", nullable=False, index=True)
    total_cost = Column(Float, nullable=False, default=0.0)
    discount_amount = Column(Float, nullable=False, default=0.0)
    promo_code = Column(String, nullable=True)
    final_cost = Column(Float, nullable=True)
    deposit_amount = Column(Float, default=0.0)
    prepayment_amount = Column(Float, nullable=False, default=0.0)  # Ğ¡ÑƒĞ¼Ğ¼Ğ° Ğ¿Ñ€ĞµĞ´Ğ¾Ğ¿Ğ»Ğ°Ñ‚Ñ‹, Ğ²Ğ½ĞµÑĞµĞ½Ğ½Ğ°Ñ Ğ¿Ñ€Ğ¸ ÑĞ¾Ğ·Ğ´Ğ°Ğ½Ğ¸Ğ¸ Ğ°Ñ€ĞµĞ½Ğ´Ñ‹
    notes_on_issue = Column(Text, nullable=True)
    notes_on_return = Column(Text, nullable=True)
    created_at = Column(DateTime(timezone=True), default=lambda: datetime.now(timezone.utc))
    updated_at = Column(DateTime(timezone=True), default=lambda: datetime.now(timezone.utc), onupdate=lambda: datetime.now(timezone.utc))

    user = relationship("User", foreign_keys=[user_id], back_populates="rentals")
    created_by = relationship("User", foreign_keys=[created_by_id])

    # --- ĞĞĞ§ĞĞ›Ğ Ğ˜Ğ¡ĞŸĞ ĞĞ’Ğ›Ğ•ĞĞ˜Ğ™ ---
    # Ğ£Ğ±Ğ¸Ñ€Ğ°ĞµĞ¼ ÑƒĞ¿Ñ€Ğ°Ğ²Ğ»ÑÑÑ‰Ğ¸Ğµ Ğ¸Ğ½ÑÑ‚Ñ€ÑƒĞºÑ†Ğ¸Ğ¸ `cascade` Ğ¸ `single_parent` ÑĞ¾ ÑÑ‚Ğ¾Ñ€Ğ¾Ğ½Ñ‹ "Ğ¿Ğ¾Ñ‚Ğ¾Ğ¼ĞºĞ°".
    # Ğ¢ĞµĞ¿ĞµÑ€ÑŒ ÑÑ‚Ğ° ÑĞ²ÑĞ·ÑŒ ÑĞ²Ğ»ÑĞµÑ‚ÑÑ Ğ¿Ñ€Ğ¾ÑÑ‚Ğ¾ Ğ¾Ğ±Ñ€Ğ°Ñ‚Ğ½Ğ¾Ğ¹ ÑÑÑ‹Ğ»ĞºĞ¾Ğ¹.
    reservation = relationship("Reservation", back_populates="rental")
    # --- ĞšĞĞĞ•Ğ¦ Ğ˜Ğ¡ĞŸĞ ĞĞ’Ğ›Ğ•ĞĞ˜Ğ™ ---

    equipment = relationship("Equipment", secondary=rental_equipment_association)
    balance_history = relationship("BalanceHistory", back_populates="rental", cascade="all, delete-orphan")
    payments = relationship("Payment", back_populates="rental", cascade="all, delete-orphan")
    accessory_links = relationship(
        "RentalAccessory",
        back_populates="rental",
        cascade="all, delete-orphan",
        lazy="joined"
    )

    def __repr__(self):
        return f"<Rental(id={self.id}, user_id={self.user_id}, status='{self.status}')>"

```



## `api\models\reservation.py`


```python

# api/models/reservation.py

from sqlalchemy import Column, Integer, DateTime, ForeignKey, Table, Float, String, Date
from sqlalchemy.orm import relationship
from api.database import Base
from typing import Optional, Dict, List
from datetime import datetime, timezone

reservation_equipment_association = Table('reservation_equipment', Base.metadata,
                                          Column('reservation_id', Integer, ForeignKey('reservations.id'), primary_key=True),
                                          Column('equipment_id', Integer, ForeignKey('equipment.id'), primary_key=True)
                                          )

class ReservationAccessory(Base):
    __tablename__ = 'reservation_accessories'
    reservation_id = Column(Integer, ForeignKey('reservations.id'), primary_key=True)
    equipment_id = Column(Integer, ForeignKey('equipment.id'), primary_key=True)
    accessory_id = Column(Integer, ForeignKey('accessories.id'), primary_key=True)

    # --- Ğ˜Ğ¡ĞŸĞ ĞĞ’Ğ›Ğ•ĞĞ˜Ğ• Ğ—Ğ”Ğ•Ğ¡Ğ¬ ---
    accessory = relationship("Accessory", back_populates="reservation_links")
    reservation = relationship("Reservation", back_populates="accessory_links")
    # -------------------------

class Reservation(Base):
    __tablename__ = "reservations"

    id = Column(Integer, primary_key=True)
    user_id = Column(Integer, ForeignKey("users.id"), nullable=False)
    start_date = Column(Date, nullable=False)
    end_date = Column(Date, nullable=False)
    status = Column(String, default='active', nullable=False, index=True)
    promo_code_id = Column(Integer, ForeignKey("promo_codes.id"), nullable=True)
    total_cost = Column(Float, nullable=False, default=0.0)
    discount_amount = Column(Float, nullable=False, default=0.0)
    created_at = Column(DateTime(timezone=True), default=lambda: datetime.now(timezone.utc))

    user = relationship("User", back_populates="reservations")
    applied_promo_code = relationship("PromoCode")
    equipment = relationship(
        "Equipment",
        secondary=reservation_equipment_association,
        back_populates="reservations",
        lazy="joined"
    )
    # --- Ğ˜Ğ¡ĞŸĞ ĞĞ’Ğ›Ğ•ĞĞ˜Ğ• Ğ—Ğ”Ğ•Ğ¡Ğ¬ ---
    accessory_links = relationship(
        "ReservationAccessory",
        back_populates="reservation",
        cascade="all, delete-orphan",
        lazy="joined"
    )
    # -------------------------
    rental = relationship("Rental", back_populates="reservation", uselist=False, cascade="all, delete-orphan", single_parent=True)

    @property
    def equipment_ids(self) -> list[int]:
        return [item.id for item in self.equipment] if self.equipment else []

    @property
    def selected_accessories(self) -> Dict[int, List[int]]:
        grouped_accessories: Dict[int, List[int]] = {}
        if not self.accessory_links:
            return {}
        for link in self.accessory_links:
            if link.equipment_id not in grouped_accessories:
                grouped_accessories[link.equipment_id] = []
            grouped_accessories[link.equipment_id].append(link.accessory_id)
        return grouped_accessories

    @property
    def promo_code(self) -> Optional[str]:
        return self.applied_promo_code.code if self.applied_promo_code else None

```



## `api\models\user.py`


```python

# api/models/user.py

from sqlalchemy import (Column, Integer, String, Boolean, DateTime,
                        Float, Text)
from sqlalchemy.orm import relationship
from api.database import Base
from datetime import datetime, timezone

class User(Base):
    __tablename__ = "users"

    id = Column(Integer, primary_key=True)
    full_name = Column(String, nullable=False)
    email = Column(String, unique=True, index=True, nullable=False)
    hashed_password = Column(String)
    role = Column(String, default="user") # user, manager, admin

    created_at = Column(DateTime(timezone=True), default=lambda: datetime.now(timezone.utc))

    is_active = Column(Boolean, default=True)
    phone = Column(String)
    status = Column(String, default="ĞĞºÑ‚Ğ¸Ğ²Ğ½Ñ‹Ğ¹")
    balance = Column(Float, default=0.0)
    notes = Column(Text)

    privacy_policy_accepted = Column(Boolean, default=False)
    terms_accepted = Column(Boolean, default=False)
    email_verified = Column(Boolean, default=False)

    # Ğ¡ÑƒÑ‰ĞµÑÑ‚Ğ²ÑƒÑÑ‰Ğ¸Ğµ ÑĞ²ÑĞ·Ğ¸
    reservations = relationship("Reservation", back_populates="user")
    used_promo_codes = relationship(
        "PromoCode",
        secondary="promo_code_usages",
        back_populates="used_by_users"
    )

    # +++ ĞĞĞ’Ğ«Ğ• Ğ¡Ğ’Ğ¯Ğ—Ğ˜ +++
    rentals = relationship("Rental", foreign_keys="[Rental.user_id]", back_populates="user", cascade="all, delete-orphan")
    balance_history = relationship("BalanceHistory", back_populates="user", cascade="all, delete-orphan")

```



## `api\permissions.py`


```python

# api/permissions.py
from fastapi import Depends, HTTPException
from api.deps import get_current_user
from api.models.user import User

# ĞŸÑ€Ğ¸Ğ¾Ñ€Ğ¸Ñ‚ĞµÑ‚ Ñ€Ğ¾Ğ»ĞµĞ¹: user < manager < admin
ROLE_PRIORITY = {"user": 0, "manager": 1, "admin": 2}

def require_user(user: User = Depends(get_current_user)):
    # Ğ›ÑĞ±Ğ¾Ğ¹ Ğ·Ğ°Ğ»Ğ¾Ğ³Ğ¸Ğ½ĞµĞ½Ğ½Ñ‹Ğ¹ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ÑŒ
    if not user.is_active:
        raise HTTPException(status_code=403, detail="ĞŸĞ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ÑŒ Ğ½ĞµĞ°ĞºÑ‚Ğ¸Ğ²ĞµĞ½")
    return user

def require_manager(user: User = Depends(get_current_user)):
    # ĞœĞµĞ½ĞµĞ´Ğ¶ĞµÑ€ Ğ¸ Ğ²Ñ‹ÑˆĞµ
    if ROLE_PRIORITY.get(user.role, 0) < ROLE_PRIORITY["manager"]:
        raise HTTPException(status_code=403, detail="ĞĞµĞ´Ğ¾ÑÑ‚Ğ°Ñ‚Ğ¾Ñ‡Ğ½Ğ¾ Ğ¿Ñ€Ğ°Ğ² (Ñ‚Ñ€ĞµĞ±ÑƒĞµÑ‚ÑÑ manager Ğ¸Ğ»Ğ¸ admin)")
    return user

def require_admin(user: User = Depends(get_current_user)):
    # Ğ¢Ğ¾Ğ»ÑŒĞºĞ¾ Ğ°Ğ´Ğ¼Ğ¸Ğ½Ğ¸ÑÑ‚Ñ€Ğ°Ñ‚Ğ¾Ñ€
    if user.role != "admin":
        raise HTTPException(status_code=403, detail="ĞĞµĞ´Ğ¾ÑÑ‚Ğ°Ñ‚Ğ¾Ñ‡Ğ½Ğ¾ Ğ¿Ñ€Ğ°Ğ² (Ñ‚Ñ€ĞµĞ±ÑƒĞµÑ‚ÑÑ admin)")
    return user

```



## `api\promo_code_api.py`


```python

# api/promo_code_api.py

from fastapi import APIRouter, Depends, HTTPException, status, Query
from sqlalchemy.ext.asyncio import AsyncSession
from sqlalchemy import select, func
from sqlalchemy.orm import selectinload
from typing import List

from api.deps import get_db
from api.permissions import require_manager
from api.services.auth_service import get_user_by_token
from api.models.user import User
from shared.schemas.promo_code_schema import (
    PromoCodeCreate, PromoCodeUpdate, PromoCodeOut,
    PromoCodeValidateRequest, PromoCodeValidateResponse,
    PromoCodeListResponse
)
from fastapi.security import OAuth2PasswordBearer
from fastapi_csrf_protect import CsrfProtect
from api.services.promo_code import PromoCodeManager, PromoCodeBusinessLogic

router = APIRouter(prefix="/promocodes", tags=["ĞŸÑ€Ğ¾Ğ¼Ğ¾ĞºĞ¾Ğ´Ñ‹"])
optional_oauth2_scheme = OAuth2PasswordBearer(tokenUrl="/auth/token", auto_error=False)


@router.post("/", response_model=PromoCodeOut, status_code=status.HTTP_201_CREATED)
async def create_promo_code(
        promo_in: PromoCodeCreate,
        db: AsyncSession = Depends(get_db),
        current_user: User = Depends(require_manager),
        _csrf_protect: CsrfProtect = Depends()
):
    """
    Ğ¡Ğ¾Ğ·Ğ´Ğ°ĞµÑ‚ Ğ½Ğ¾Ğ²Ñ‹Ğ¹ Ğ¿Ñ€Ğ¾Ğ¼Ğ¾ĞºĞ¾Ğ´. (ĞœĞµĞ½ĞµĞ´Ğ¶ĞµÑ€Ñ‹ <= 20%, ĞĞ´Ğ¼Ğ¸Ğ½Ñ‹ <= 50%)
    """
    try:
        manager = PromoCodeManager(db)
        new_promo_code = await manager.create_promo_code(promo_in, current_user)
        return PromoCodeOut.from_orm(new_promo_code)
    except HTTPException:
        raise
    except Exception as e:
        raise HTTPException(status_code=status.HTTP_500_INTERNAL_SERVER_ERROR, detail=str(e))


@router.get("/", response_model=PromoCodeListResponse)
async def get_all_promo_codes(
        db: AsyncSession = Depends(get_db),
        _current_user: User = Depends(require_manager),
        skip: int = Query(0, ge=0, description="Ğ¡ĞºĞ¾Ğ»ÑŒĞºĞ¾ Ğ·Ğ°Ğ¿Ğ¸ÑĞµĞ¹ Ğ¿Ñ€Ğ¾Ğ¿ÑƒÑÑ‚Ğ¸Ñ‚ÑŒ"),
        limit: int = Query(10, ge=1, le=100, description="ĞœĞ°ĞºÑĞ¸Ğ¼Ğ°Ğ»ÑŒĞ½Ğ¾Ğµ ĞºĞ¾Ğ»Ğ¸Ñ‡ĞµÑÑ‚Ğ²Ğ¾ Ğ·Ğ°Ğ¿Ğ¸ÑĞµĞ¹ Ğ½Ğ° ÑÑ‚Ñ€Ğ°Ğ½Ğ¸Ñ†Ğµ")
):
    """ĞŸĞ¾Ğ»ÑƒÑ‡Ğ¸Ñ‚ÑŒ ÑĞ¿Ğ¸ÑĞ¾Ğº Ğ²ÑĞµÑ… Ğ¿Ñ€Ğ¾Ğ¼Ğ¾ĞºĞ¾Ğ´Ğ¾Ğ² Ñ Ğ¿Ğ°Ğ³Ğ¸Ğ½Ğ°Ñ†Ğ¸ĞµĞ¹ (Ñ‚Ğ¾Ğ»ÑŒĞºĞ¾ Ğ´Ğ»Ñ Ğ¼ĞµĞ½ĞµĞ´Ğ¶ĞµÑ€Ğ¾Ğ²/Ğ°Ğ´Ğ¼Ğ¸Ğ½Ğ¾Ğ²)"""
    try:
        manager = PromoCodeManager(db)
        promo_codes = await manager.get_all_promo_codes()
        
        # ĞŸÑ€Ğ¸Ğ¼ĞµĞ½ÑĞµĞ¼ Ğ¿Ğ°Ğ³Ğ¸Ğ½Ğ°Ñ†Ğ¸Ñ Ğº Ñ€ĞµĞ·ÑƒĞ»ÑŒÑ‚Ğ°Ñ‚Ñƒ
        total_promo_codes = len(promo_codes)
        paginated_promo_codes = promo_codes[skip:skip + limit]
        
        return PromoCodeListResponse(
            items=[PromoCodeOut.from_orm(pc) for pc in paginated_promo_codes],
            total=total_promo_codes
        )
    except Exception as e:
        raise HTTPException(status_code=status.HTTP_500_INTERNAL_SERVER_ERROR, detail=str(e))


@router.get("/generate/new-code", response_model=dict)
async def generate_promo_code(
        db: AsyncSession = Depends(get_db),
        _current_user: User = Depends(require_manager)
):
    """Ğ“ĞµĞ½ĞµÑ€Ğ¸Ñ€ÑƒĞµÑ‚ ÑƒĞ½Ğ¸ĞºĞ°Ğ»ÑŒĞ½Ñ‹Ğ¹ ĞºĞ¾Ğ´ Ğ¿Ñ€Ğ¾Ğ¼Ğ¾ĞºĞ¾Ğ´Ğ°"""
    try:
        manager = PromoCodeManager(db)
        generated_code = await manager.generate_unique_code()
        return {"generated_code": generated_code}
    except Exception as e:
        raise HTTPException(status_code=status.HTTP_500_INTERNAL_SERVER_ERROR, detail=str(e))


@router.put("/{promo_code_id}", response_model=PromoCodeOut)
async def update_promo_code(
        promo_code_id: int,
        promo_in: PromoCodeUpdate,
        db: AsyncSession = Depends(get_db),
        _current_user: User = Depends(require_manager),
        _csrf_protect: CsrfProtect = Depends()
):
    """ĞĞ±Ğ½Ğ¾Ğ²Ğ»ÑĞµÑ‚ ÑÑƒÑ‰ĞµÑÑ‚Ğ²ÑƒÑÑ‰Ğ¸Ğ¹ Ğ¿Ñ€Ğ¾Ğ¼Ğ¾ĞºĞ¾Ğ´ (Ñ‚Ğ¾Ğ»ÑŒĞºĞ¾ Ğ´Ğ»Ñ Ğ¼ĞµĞ½ĞµĞ´Ğ¶ĞµÑ€Ğ¾Ğ²/Ğ°Ğ´Ğ¼Ğ¸Ğ½Ğ¾Ğ²)."""
    try:
        manager = PromoCodeManager(db)
        updated_promo_code = await manager.update_promo_code(promo_code_id, promo_in)
        return PromoCodeOut.from_orm(updated_promo_code)
    except HTTPException:
        raise
    except Exception as e:
        raise HTTPException(status_code=status.HTTP_500_INTERNAL_SERVER_ERROR, detail=str(e))


@router.delete("/{promo_code_id}", status_code=status.HTTP_204_NO_CONTENT)
async def delete_promo_code(
        promo_code_id: int,
        db: AsyncSession = Depends(get_db),
        _current_user: User = Depends(require_manager),
        _csrf_protect: CsrfProtect = Depends()
):
    """Ğ£Ğ´Ğ°Ğ»ÑĞµÑ‚ Ğ¿Ñ€Ğ¾Ğ¼Ğ¾ĞºĞ¾Ğ´"""
    try:
        manager = PromoCodeManager(db)
        await manager.delete_promo_code(promo_code_id)
        return None
    except HTTPException:
        raise
    except Exception as e:
        raise HTTPException(status_code=status.HTTP_500_INTERNAL_SERVER_ERROR, detail=str(e))


@router.post("/validate", response_model=PromoCodeValidateResponse)
async def validate_promo_code_endpoint(
        request: PromoCodeValidateRequest,
        db: AsyncSession = Depends(get_db),
        token: str = Depends(optional_oauth2_scheme)
):
    """
    ĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑĞµÑ‚ Ğ²Ğ°Ğ»Ğ¸Ğ´Ğ½Ğ¾ÑÑ‚ÑŒ Ğ¿Ñ€Ğ¾Ğ¼Ğ¾ĞºĞ¾Ğ´Ğ° Ñ ÑƒÑ‡ĞµÑ‚Ğ¾Ğ¼ Ğ²ÑĞµÑ… ÑƒÑĞ»Ğ¾Ğ²Ğ¸Ğ¹.
    """
    try:
        current_user = await get_user_by_token(db, token) if token else None
        business_logic = PromoCodeBusinessLogic(db)
        
        promo_code = await business_logic.validate_and_get_promo_code(
            code=request.code,
            order_amount=request.order_amount,
            equipment_ids=request.equipment_ids,
            user=current_user
        )
        
        return await business_logic.create_validation_response(promo_code)
    except HTTPException:
        raise
    except Exception as e:
        raise HTTPException(status_code=status.HTTP_500_INTERNAL_SERVER_ERROR, detail=str(e))

```



## `api\reservation_api.py`


```python

# api/reservation_api.py

from fastapi import APIRouter, Depends, HTTPException, Query
from sqlalchemy.ext.asyncio import AsyncSession
from typing import List, Optional

from api.services.order.order_lifecycle_service import OrderLifecycleService
from api.services.reservation_query_service import ReservationQueryService
from shared.schemas.reservation_schema import (
    ReservationCreateRequest, ReservationUpdateRequest, ReservationResponse,
    ReservationItem, ReservationListResponse, PriceCalculationRequest, PriceCalculationResponse
)
from api.permissions import require_user
from api.models.user import User
from api.models.promo_code import PromoCode
from api.deps import get_db, get_order_lifecycle_service, get_reservation_query_service
from fastapi_csrf_protect import CsrfProtect

from api.services.financial_service import FinancialService
from api.services.promo_code_service import validate_promo_code_for_use
from api.services.discount_service import get_duration_discount_percentage


router = APIRouter(prefix="/reservations", tags=["Ğ ĞµĞ·ĞµÑ€Ğ²Ñ‹ (Ğ´Ğ»Ñ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ĞµĞ¹)"])

@router.post("/", response_model=ReservationResponse)
async def create_reservation(
        request: ReservationCreateRequest,
        current_user: User = Depends(require_user),
        csrf_protect: CsrfProtect = Depends(),
        service: OrderLifecycleService = Depends(get_order_lifecycle_service)
):
    """Ğ¡Ğ¾Ğ·Ğ´Ğ°Ñ‚ÑŒ Ñ€ĞµĞ·ĞµÑ€Ğ² Ğ´Ğ»Ñ Ñ‚ĞµĞºÑƒÑ‰ĞµĞ³Ğ¾ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ñ."""
    new_reservation = await service.create_user_reservation(request, current_user)
    return ReservationResponse(reservation_id=new_reservation.id, message="Ğ ĞµĞ·ĞµÑ€Ğ² ÑƒÑĞ¿ĞµÑˆĞ½Ğ¾ ÑĞ¾Ğ·Ğ´Ğ°Ğ½")

@router.get("/", response_model=ReservationListResponse)
async def get_user_reservations(
        current_user: User = Depends(require_user),
        query_service: ReservationQueryService = Depends(get_reservation_query_service),
        status: Optional[str] = Query(None, description="Ğ¤Ğ¸Ğ»ÑŒÑ‚Ñ€ Ğ¿Ğ¾ ÑÑ‚Ğ°Ñ‚ÑƒÑÑƒ: active, completed, overdue"),
        search: Optional[str] = Query(None, description="ĞŸĞ¾Ğ¸ÑĞº Ğ¿Ğ¾ Ğ½Ğ°Ğ·Ğ²Ğ°Ğ½Ğ¸Ñ, Ğ±Ñ€ĞµĞ½Ğ´Ñƒ Ğ¸Ğ»Ğ¸ Ñ‚Ğ¸Ğ¿Ñƒ Ğ¾Ğ±Ğ¾Ñ€ÑƒĞ´Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ"),
        sort: Optional[str] = Query(None, description="Ğ¡Ğ¾Ñ€Ñ‚Ğ¸Ñ€Ğ¾Ğ²ĞºĞ°: id_desc, id_asc, start_date_desc, start_date_asc, end_date_desc, end_date_asc, count_desc, count_asc"),
        skip: int = Query(0, ge=0, description="ĞšĞ¾Ğ»Ğ¸Ñ‡ĞµÑÑ‚Ğ²Ğ¾ Ğ·Ğ°Ğ¿Ğ¸ÑĞµĞ¹ Ğ´Ğ»Ñ Ğ¿Ñ€Ğ¾Ğ¿ÑƒÑĞºĞ°"),
        limit: int = Query(100, ge=1, le=100, description="ĞœĞ°ĞºÑĞ¸Ğ¼Ğ°Ğ»ÑŒĞ½Ğ¾Ğµ ĞºĞ¾Ğ»Ğ¸Ñ‡ĞµÑÑ‚Ğ²Ğ¾ Ğ·Ğ°Ğ¿Ğ¸ÑĞµĞ¹ Ğ½Ğ° ÑÑ‚Ñ€Ğ°Ğ½Ğ¸Ñ†Ğµ")
):
    """ĞŸĞ¾Ğ»ÑƒÑ‡Ğ¸Ñ‚ÑŒ Ğ¾Ñ‚Ñ„Ğ¸Ğ»ÑŒÑ‚Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ½Ñ‹Ğ¹ Ğ¸ Ğ¿Ğ°Ğ³Ğ¸Ğ½Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ½Ñ‹Ğ¹ ÑĞ¿Ğ¸ÑĞ¾Ğº ÑĞ²Ğ¾Ğ¸Ñ… Ñ€ĞµĞ·ĞµÑ€Ğ²Ğ¾Ğ²."""
    items, total = await query_service.get_my_reservations(
        current_user, status, search, sort, skip, limit
    )
    return ReservationListResponse(items=items, total=total)

@router.delete("/{reservation_id}")
async def delete_reservation(
        reservation_id: int,
        current_user: User = Depends(require_user),
        csrf_protect: CsrfProtect = Depends(),
        service: OrderLifecycleService = Depends(get_order_lifecycle_service)
):
    """Ğ£Ğ´Ğ°Ğ»Ğ¸Ñ‚ÑŒ ÑĞ²Ğ¾Ğ¹ Ñ€ĞµĞ·ĞµÑ€Ğ²."""
    await service.cancel_user_reservation(reservation_id, current_user)
    return {"message": "Ğ ĞµĞ·ĞµÑ€Ğ² ÑƒĞ´Ğ°Ğ»Ñ‘Ğ½"}

@router.put("/{reservation_id}", response_model=ReservationResponse)
async def update_reservation(
        reservation_id: int,
        data: ReservationUpdateRequest,
        current_user: User = Depends(require_user),
        csrf_protect: CsrfProtect = Depends(),
        service: OrderLifecycleService = Depends(get_order_lifecycle_service)
):
    """ĞĞ±Ğ½Ğ¾Ğ²Ğ¸Ñ‚ÑŒ ÑĞ²Ğ¾Ğ¹ Ñ€ĞµĞ·ĞµÑ€Ğ²."""
    updated_reservation = await service.update_user_reservation(reservation_id, data, current_user)
    return ReservationResponse(reservation_id=updated_reservation.id, message="Ğ ĞµĞ·ĞµÑ€Ğ² ÑƒÑĞ¿ĞµÑˆĞ½Ğ¾ Ğ¾Ğ±Ğ½Ğ¾Ğ²Ğ»Ñ‘Ğ½")

@router.post("/calculate", response_model=PriceCalculationResponse)
async def calculate_price(
        request: PriceCalculationRequest,
        db: AsyncSession = Depends(get_db)
):
    """Ğ Ğ°ÑÑÑ‡Ğ¸Ñ‚Ñ‹Ğ²Ğ°ĞµÑ‚ ÑÑ‚Ğ¾Ğ¸Ğ¼Ğ¾ÑÑ‚ÑŒ Ñ€ĞµĞ·ĞµÑ€Ğ²Ğ° Ğ±ĞµĞ· ĞµĞ³Ğ¾ ÑĞ¾Ğ·Ğ´Ğ°Ğ½Ğ¸Ñ."""
    financial_service = FinancialService(db)
    financial_service.validate_date_range(request.start_date, request.end_date)
    promo_code_obj: Optional[PromoCode] = None
    promo_message: Optional[str] = None

    preliminary_price_details = await financial_service.calculate_final_price(
        request.equipment_ids, request.selected_accessories,
        request.start_date, request.end_date, None
    )

    if request.promo_code:
        try:
            promo_code_obj = await validate_promo_code_for_use(
                db, request.promo_code, preliminary_price_details.full_total,
                request.equipment_ids, None
            )
            promo_message = "ĞŸÑ€Ğ¾Ğ¼Ğ¾ĞºĞ¾Ğ´ ÑƒÑĞ¿ĞµÑˆĞ½Ğ¾ Ğ¿Ñ€Ğ¸Ğ¼ĞµĞ½ĞµĞ½!"
        except HTTPException as e:
            promo_message = e.detail

    final_price_details = await financial_service.calculate_final_price(
        request.equipment_ids, request.selected_accessories,
        request.start_date, request.end_date, promo_code_obj
    )

    day_count = await financial_service.get_rental_days(request.start_date, request.end_date)
    promo_discount = promo_code_obj.discount_percentage if promo_code_obj else 0

    return PriceCalculationResponse(
        day_count=day_count,
        full_total=final_price_details.full_total,
        final_total=final_price_details.final_total,
        discount_amount=final_price_details.discount_amount,
        duration_discount_percentage=await get_duration_discount_percentage(db, day_count),
        promo_discount_percentage=promo_discount,
        promo_code_message=promo_message
    )

```



## `api\router.py`


```python

# api/router.py

from fastapi import APIRouter
from api.auth_api import router as auth_router
from api.equipment_api import router as equipment_router
from api.reservation_api import router as reservation_router
from api.user_api import router as user_router
from api.calendar_api import router as calendar_router
from api.accessory_api import router as accessory_router
from api.admin_reservation_api import router as admin_reservation_router
from api.promo_code_api import router as promo_code_router
from api.holiday_api import router as holiday_router
from api.discount_api import router as discount_router
from api.association_api import router as association_router
from api.admin_rental_api import router as admin_rental_router
from api.admin_dashboard_api import router as admin_dashboard_router

router = APIRouter()

router.include_router(auth_router)
router.include_router(equipment_router)
router.include_router(reservation_router)
router.include_router(user_router)
router.include_router(calendar_router)
router.include_router(accessory_router)
router.include_router(admin_reservation_router)
router.include_router(promo_code_router)
router.include_router(holiday_router)
router.include_router(discount_router)
router.include_router(association_router)
router.include_router(admin_rental_router)
router.include_router(admin_dashboard_router)

# Ğ¡Ñ‚Ğ°Ñ€Ñ‹Ğµ ÑĞµÑ€Ğ²Ğ¸ÑÑ‹ Ğ±Ñ‹Ğ»Ğ¸ ÑƒĞ´Ğ°Ğ»ĞµĞ½Ñ‹, Ğ¿Ğ¾ÑÑ‚Ğ¾Ğ¼Ñƒ Ğ½Ğ¸ĞºĞ°ĞºĞ¸Ñ… Ğ¸Ğ·Ğ¼ĞµĞ½ĞµĞ½Ğ¸Ğ¹ Ğ² Ñ€Ğ¾ÑƒÑ‚ĞµÑ€Ğµ Ğ½Ğµ Ñ‚Ñ€ĞµĞ±ÑƒĞµÑ‚ÑÑ,
# Ñ‚Ğ°Ğº ĞºĞ°Ğº Ğ¾Ğ½ Ğ¿Ğ¾Ğ´ĞºĞ»ÑÑ‡Ğ°ĞµÑ‚ Ñ‚Ğ¾Ğ»ÑŒĞºĞ¾ API-ÑĞ»Ğ¾Ğ¹ (Ğ½Ğ°Ğ¿Ñ€Ğ¸Ğ¼ĞµÑ€, admin_rental_api),
# Ğ° Ğ²Ğ½ÑƒÑ‚Ñ€ĞµĞ½Ğ½Ğ¸Ğµ Ğ·Ğ°Ğ²Ğ¸ÑĞ¸Ğ¼Ğ¾ÑÑ‚Ğ¸ ÑÑ‚Ğ¸Ñ… API ÑƒĞ¶Ğµ Ğ¸Ğ·Ğ¼ĞµĞ½ĞµĞ½Ñ‹.

```



## `api\services\auth_service.py`


```python

# api/services/auth_service.py

from api.models.user import User
from passlib.context import CryptContext
from jose import JWTError, jwt
from sqlalchemy.ext.asyncio import AsyncSession
from sqlalchemy import select
from shared.schemas.user_schema import UserCreate
from datetime import datetime, timedelta
from config.secrets import SECRET_KEY
from fastapi import HTTPException
import logging

ALGORITHM = "HS256"
ACCESS_TOKEN_EXPIRE_MINUTES = 60
pwd_context = CryptContext(schemes=["bcrypt"], deprecated="auto")


def hash_password(password: str) -> str:
    return pwd_context.hash(password)


def verify_password(plain: str, hashed: str) -> bool:
    return pwd_context.verify(plain, hashed)


async def create_user(db: AsyncSession, user_data: UserCreate) -> User:
    try:
        result = await db.execute(select(User).filter(User.email == user_data.email))
        existing = result.scalars().first()
        if existing:
            raise HTTPException(status_code=409, detail="Email ÑƒĞ¶Ğµ Ğ·Ğ°Ñ€ĞµĞ³Ğ¸ÑÑ‚Ñ€Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½")

        # <<< Ğ˜Ğ—ĞœĞ•ĞĞ•ĞĞ˜Ğ•: Ğ”Ğ¾Ğ±Ğ°Ğ²Ğ»ÑĞµĞ¼ 'phone' Ğ¿Ñ€Ğ¸ ÑĞ¾Ğ·Ğ´Ğ°Ğ½Ğ¸Ğ¸ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ñ >>>
        user = User(
            full_name=user_data.full_name,
            email=user_data.email,
            hashed_password=hash_password(user_data.password),
            phone=user_data.phone,  # <--- ĞĞ¾Ğ²Ğ¾Ğµ Ğ¿Ğ¾Ğ»Ğµ
            role="user",
            is_active=True,
            status="ĞĞºÑ‚Ğ¸Ğ²Ğ½Ñ‹Ğ¹",
            balance=0.0,
            notes="Ğ¡Ğ¾Ğ·Ğ´Ğ°Ğ½ Ğ°Ğ²Ñ‚Ğ¾Ğ¼Ğ°Ñ‚Ğ¸Ñ‡ĞµÑĞºĞ¸ Ğ¿Ñ€Ğ¸ Ñ€ĞµĞ³Ğ¸ÑÑ‚Ñ€Ğ°Ñ†Ğ¸Ğ¸",
            # +++ ĞĞĞ’Ğ«Ğ• ĞŸĞĞ›Ğ¯ +++
            privacy_policy_accepted=user_data.privacy_policy_accepted,
            terms_accepted=user_data.terms_accepted,
            email_verified=True  # ĞŸÑ€Ğ¸ Ñ€ĞµĞ³Ğ¸ÑÑ‚Ñ€Ğ°Ñ†Ğ¸Ğ¸ email ÑÑ‡Ğ¸Ñ‚Ğ°ĞµÑ‚ÑÑ Ğ¿Ğ¾Ğ´Ñ‚Ğ²ĞµÑ€Ğ¶Ğ´ĞµĞ½Ğ½Ñ‹Ğ¼
        )
        db.add(user)
        await db.commit()
        
        # ĞŸĞ¾Ğ²Ñ‚Ğ¾Ñ€Ğ½Ğ¾ Ğ¿Ğ¾Ğ»ÑƒÑ‡Ğ°ĞµĞ¼ Ğ¾Ğ±ÑŠĞµĞºÑ‚ Ğ¸Ğ· Ğ‘Ğ”
        result = await db.execute(select(User).filter(User.id == user.id))
        return result.scalars().first()
    except HTTPException as http_exc:
        db.rollback()
        raise http_exc
    except Exception as e:
        db.rollback()
        logging.exception(f"[âŒ create_user] ĞÑˆĞ¸Ğ±ĞºĞ° Ğ¿Ñ€Ğ¸ Ñ€ĞµĞ³Ğ¸ÑÑ‚Ñ€Ğ°Ñ†Ğ¸Ğ¸: {e}")
        raise HTTPException(status_code=500, detail="ĞÑˆĞ¸Ğ±ĞºĞ° ÑĞµÑ€Ğ²ĞµÑ€Ğ° Ğ¿Ñ€Ğ¸ Ñ€ĞµĞ³Ğ¸ÑÑ‚Ñ€Ğ°Ñ†Ğ¸Ğ¸")


async def authenticate_user(db: AsyncSession, email: str, password: str) -> User | None:
    result = await db.execute(select(User).filter(User.email == email))
    user = result.scalars().first()
    if user and verify_password(password, user.hashed_password):
        return user
    return None


def create_access_token(data: dict, expires_delta: timedelta = None):
    to_encode = data.copy()
    expire = datetime.utcnow() + (expires_delta or timedelta(minutes=ACCESS_TOKEN_EXPIRE_MINUTES))
    to_encode.update({"exp": expire})
    return jwt.encode(to_encode, SECRET_KEY, algorithm=ALGORITHM)


async def get_user_by_token(db: AsyncSession, token: str) -> User | None:
    try:
        payload = jwt.decode(token, SECRET_KEY, algorithms=[ALGORITHM])
        email: str = payload.get("sub")
        if email is None:
            return None
    except JWTError:
        return None
    result = await db.execute(select(User).filter(User.email == email))
    return result.scalars().first()

```



## `api\services\availability\availability_service.py`


```python

# api/services/availability/availability_service.py

from sqlalchemy.ext.asyncio import AsyncSession
from datetime import date
from typing import List, Dict, Any, Optional

from .conflicts import AvailabilityConflictsService
from .statuses import AvailabilityStatusService
from .calendar import AvailabilityCalendarService
from .queries import AvailabilityQueryService


class AvailabilityService:
    """
    Ğ“Ğ»Ğ°Ğ²Ğ½Ñ‹Ğ¹ Ñ„Ğ°ÑĞ°Ğ´ Ğ´Ğ»Ñ ÑĞµÑ€Ğ²Ğ¸ÑĞ¾Ğ² Ğ¿Ñ€Ğ¾Ğ²ĞµÑ€ĞºĞ¸ Ğ´Ğ¾ÑÑ‚ÑƒĞ¿Ğ½Ğ¾ÑÑ‚Ğ¸ Ğ¾Ğ±Ğ¾Ñ€ÑƒĞ´Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ.
    ĞĞ±ÑŠĞµĞ´Ğ¸Ğ½ÑĞµÑ‚ Ğ²ÑĞµ ÑĞ¿ĞµÑ†Ğ¸Ğ°Ğ»Ğ¸Ğ·Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ½Ñ‹Ğµ ÑĞµÑ€Ğ²Ğ¸ÑÑ‹ Ğ² ĞµĞ´Ğ¸Ğ½Ñ‹Ğ¹ Ğ¸Ğ½Ñ‚ĞµÑ€Ñ„ĞµĞ¹Ñ.
    Ğ•Ğ´Ğ¸Ğ½ÑÑ‚Ğ²ĞµĞ½Ğ½Ñ‹Ğ¹ Ğ¸ÑÑ‚Ğ¾Ñ‡Ğ½Ğ¸Ğº Ğ¿Ñ€Ğ°Ğ²Ğ´Ñ‹ Ğ´Ğ»Ñ Ğ²ÑĞµÑ… Ğ¿Ñ€Ğ¾Ğ²ĞµÑ€Ğ¾Ğº Ğ´Ğ¾ÑÑ‚ÑƒĞ¿Ğ½Ğ¾ÑÑ‚Ğ¸ Ğ² ÑĞ¸ÑÑ‚ĞµĞ¼Ğµ.
    """

    def __init__(self, db: AsyncSession):
        self.db = db
        
        # Ğ˜Ğ½Ğ¸Ñ†Ğ¸Ğ°Ğ»Ğ¸Ğ·Ğ¸Ñ€ÑƒĞµĞ¼ ÑĞ¿ĞµÑ†Ğ¸Ğ°Ğ»Ğ¸Ğ·Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ½Ñ‹Ğµ ÑĞµÑ€Ğ²Ğ¸ÑÑ‹
        self._conflicts_service = AvailabilityConflictsService(db)
        self._status_service = AvailabilityStatusService(db)
        self._calendar_service = AvailabilityCalendarService(db)
        self._query_service = AvailabilityQueryService(db)

    # === ĞœĞ•Ğ¢ĞĞ”Ğ« Ğ”Ğ›Ğ¯ Ğ ĞĞ‘ĞĞ¢Ğ« Ğ¡ ĞšĞĞĞ¤Ğ›Ğ˜ĞšĞ¢ĞĞœĞ˜ ===
    
    async def get_conflicts(
        self,
        equipment_ids: List[int],
        start_date: date,
        end_date: date,
        exclude_reservation_id: Optional[int] = None,
        exclude_rental_id: Optional[int] = None
    ) -> Dict[int, List[Dict[str, Any]]]:
        """
        ĞÑĞ½Ğ¾Ğ²Ğ½Ğ¾Ğ¹ Ğ¼ĞµÑ‚Ğ¾Ğ´ Ğ´Ğ»Ñ Ğ¿Ğ¾Ğ»ÑƒÑ‡ĞµĞ½Ğ¸Ñ Ğ²ÑĞµÑ… ĞºĞ¾Ğ½Ñ„Ğ»Ğ¸ĞºÑ‚Ğ¾Ğ² Ğ´Ğ¾ÑÑ‚ÑƒĞ¿Ğ½Ğ¾ÑÑ‚Ğ¸ Ğ¾Ğ±Ğ¾Ñ€ÑƒĞ´Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ.
        
        Args:
            equipment_ids: Ğ¡Ğ¿Ğ¸ÑĞ¾Ğº ID Ğ¾Ğ±Ğ¾Ñ€ÑƒĞ´Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ Ğ´Ğ»Ñ Ğ¿Ñ€Ğ¾Ğ²ĞµÑ€ĞºĞ¸
            start_date: Ğ”Ğ°Ñ‚Ğ° Ğ½Ğ°Ñ‡Ğ°Ğ»Ğ° Ğ¿ĞµÑ€Ğ¸Ğ¾Ğ´Ğ°
            end_date: Ğ”Ğ°Ñ‚Ğ° Ğ¾ĞºĞ¾Ğ½Ñ‡Ğ°Ğ½Ğ¸Ñ Ğ¿ĞµÑ€Ğ¸Ğ¾Ğ´Ğ° (Ğ²ĞºĞ»ÑÑ‡Ğ¸Ñ‚ĞµĞ»ÑŒĞ½Ğ¾)
            exclude_reservation_id: ID Ñ€ĞµĞ·ĞµÑ€Ğ²Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ Ğ´Ğ»Ñ Ğ¸ÑĞºĞ»ÑÑ‡ĞµĞ½Ğ¸Ñ Ğ¸Ğ· Ğ¿Ñ€Ğ¾Ğ²ĞµÑ€ĞºĞ¸
            exclude_rental_id: ID Ğ°Ñ€ĞµĞ½Ğ´Ñ‹ Ğ´Ğ»Ñ Ğ¸ÑĞºĞ»ÑÑ‡ĞµĞ½Ğ¸Ñ Ğ¸Ğ· Ğ¿Ñ€Ğ¾Ğ²ĞµÑ€ĞºĞ¸
            
        Returns:
            Ğ¡Ğ»Ğ¾Ğ²Ğ°Ñ€ÑŒ, Ğ³Ğ´Ğµ ĞºĞ»ÑÑ‡ - ID Ğ¾Ğ±Ğ¾Ñ€ÑƒĞ´Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ, Ğ·Ğ½Ğ°Ñ‡ĞµĞ½Ğ¸Ğµ - ÑĞ¿Ğ¸ÑĞ¾Ğº ĞºĞ¾Ğ½Ñ„Ğ»Ğ¸ĞºÑ‚Ğ¾Ğ²
        """
        return await self._conflicts_service.get_conflicts(
            equipment_ids, start_date, end_date, exclude_reservation_id, exclude_rental_id
        )

    async def get_conflicting_equipment_ids(
        self,
        equipment_ids: List[int],
        start_date: date,
        end_date: date,
        exclude_reservation_id: Optional[int] = None,
        exclude_rental_id: Optional[int] = None
    ) -> List[int]:
        """
        Ğ’Ğ¾Ğ·Ğ²Ñ€Ğ°Ñ‰Ğ°ĞµÑ‚ ÑĞ¿Ğ¸ÑĞ¾Ğº ID Ğ¾Ğ±Ğ¾Ñ€ÑƒĞ´Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ, Ñƒ ĞºĞ¾Ñ‚Ğ¾Ñ€Ğ¾Ğ³Ğ¾ ĞµÑÑ‚ÑŒ ĞºĞ¾Ğ½Ñ„Ğ»Ğ¸ĞºÑ‚Ñ‹ Ğ´Ğ¾ÑÑ‚ÑƒĞ¿Ğ½Ğ¾ÑÑ‚Ğ¸.
        
        Args:
            equipment_ids: Ğ¡Ğ¿Ğ¸ÑĞ¾Ğº ID Ğ¾Ğ±Ğ¾Ñ€ÑƒĞ´Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ Ğ´Ğ»Ñ Ğ¿Ñ€Ğ¾Ğ²ĞµÑ€ĞºĞ¸
            start_date: Ğ”Ğ°Ñ‚Ğ° Ğ½Ğ°Ñ‡Ğ°Ğ»Ğ° Ğ¿ĞµÑ€Ğ¸Ğ¾Ğ´Ğ°
            end_date: Ğ”Ğ°Ñ‚Ğ° Ğ¾ĞºĞ¾Ğ½Ñ‡Ğ°Ğ½Ğ¸Ñ Ğ¿ĞµÑ€Ğ¸Ğ¾Ğ´Ğ°
            exclude_reservation_id: ID Ñ€ĞµĞ·ĞµÑ€Ğ²Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ Ğ´Ğ»Ñ Ğ¸ÑĞºĞ»ÑÑ‡ĞµĞ½Ğ¸Ñ
            exclude_rental_id: ID Ğ°Ñ€ĞµĞ½Ğ´Ñ‹ Ğ´Ğ»Ñ Ğ¸ÑĞºĞ»ÑÑ‡ĞµĞ½Ğ¸Ñ
            
        Returns:
            Ğ¡Ğ¿Ğ¸ÑĞ¾Ğº ID Ğ¾Ğ±Ğ¾Ñ€ÑƒĞ´Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ Ñ ĞºĞ¾Ğ½Ñ„Ğ»Ğ¸ĞºÑ‚Ğ°Ğ¼Ğ¸
        """
        return await self._conflicts_service.get_conflicting_equipment_ids(
            equipment_ids, start_date, end_date, exclude_reservation_id, exclude_rental_id
        )

    # === ĞœĞ•Ğ¢ĞĞ”Ğ« Ğ”Ğ›Ğ¯ Ğ ĞĞ‘ĞĞ¢Ğ« Ğ¡Ğ Ğ¡Ğ¢ĞĞ¢Ğ£Ğ¡ĞĞœĞ˜ ===
    
    async def get_availability_statuses(
        self,
        equipment_ids: List[int],
        start_date: date,
        end_date: date,
        exclude_reservation_id: Optional[int] = None,
        exclude_rental_id: Optional[int] = None
    ) -> Dict[int, Dict[str, Any]]:
        """
        Ğ’Ğ¾Ğ·Ğ²Ñ€Ğ°Ñ‰Ğ°ĞµÑ‚ ÑÑ‚Ğ°Ñ‚ÑƒÑÑ‹ Ğ´Ğ¾ÑÑ‚ÑƒĞ¿Ğ½Ğ¾ÑÑ‚Ğ¸ Ğ´Ğ»Ñ ÑĞ¿Ğ¸ÑĞºĞ° Ğ¾Ğ±Ğ¾Ñ€ÑƒĞ´Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ.
        
        Args:
            equipment_ids: Ğ¡Ğ¿Ğ¸ÑĞ¾Ğº ID Ğ¾Ğ±Ğ¾Ñ€ÑƒĞ´Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ Ğ´Ğ»Ñ Ğ¿Ñ€Ğ¾Ğ²ĞµÑ€ĞºĞ¸
            start_date: Ğ”Ğ°Ñ‚Ğ° Ğ½Ğ°Ñ‡Ğ°Ğ»Ğ° Ğ¿ĞµÑ€Ğ¸Ğ¾Ğ´Ğ°
            end_date: Ğ”Ğ°Ñ‚Ğ° Ğ¾ĞºĞ¾Ğ½Ñ‡Ğ°Ğ½Ğ¸Ñ Ğ¿ĞµÑ€Ğ¸Ğ¾Ğ´Ğ°
            exclude_reservation_id: ID Ñ€ĞµĞ·ĞµÑ€Ğ²Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ Ğ´Ğ»Ñ Ğ¸ÑĞºĞ»ÑÑ‡ĞµĞ½Ğ¸Ñ
            exclude_rental_id: ID Ğ°Ñ€ĞµĞ½Ğ´Ñ‹ Ğ´Ğ»Ñ Ğ¸ÑĞºĞ»ÑÑ‡ĞµĞ½Ğ¸Ñ
            
        Returns:
            Ğ¡Ğ»Ğ¾Ğ²Ğ°Ñ€ÑŒ ÑĞ¾ ÑÑ‚Ğ°Ñ‚ÑƒÑĞ°Ğ¼Ğ¸ Ğ¾Ğ±Ğ¾Ñ€ÑƒĞ´Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ
        """
        return await self._status_service.get_availability_statuses(
            equipment_ids, start_date, end_date, exclude_reservation_id, exclude_rental_id
        )

    async def get_daily_statuses(
        self,
        equipment_ids: List[int],
        start_date: date,
        end_date: date,
        exclude_reservation_id: Optional[int] = None,
        exclude_rental_id: Optional[int] = None,
        current_user_id: Optional[int] = None
    ) -> Dict[int, Dict[str, Any]]:
        """
        Ğ’Ğ¾Ğ·Ğ²Ñ€Ğ°Ñ‰Ğ°ĞµÑ‚ ÑÑ‚Ğ°Ñ‚ÑƒÑÑ‹ Ğ¾Ğ±Ğ¾Ñ€ÑƒĞ´Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ Ğ¿Ğ¾ Ğ´Ğ½ÑĞ¼ Ğ´Ğ»Ñ ĞºĞ°Ğ»ĞµĞ½Ğ´Ğ°Ñ€Ğ½Ğ¾Ğ³Ğ¾ Ğ¿Ñ€ĞµĞ´ÑÑ‚Ğ°Ğ²Ğ»ĞµĞ½Ğ¸Ñ.
        
        Args:
            equipment_ids: Ğ¡Ğ¿Ğ¸ÑĞ¾Ğº ID Ğ¾Ğ±Ğ¾Ñ€ÑƒĞ´Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ Ğ´Ğ»Ñ Ğ¿Ñ€Ğ¾Ğ²ĞµÑ€ĞºĞ¸
            start_date: Ğ”Ğ°Ñ‚Ğ° Ğ½Ğ°Ñ‡Ğ°Ğ»Ğ° Ğ¿ĞµÑ€Ğ¸Ğ¾Ğ´Ğ°
            end_date: Ğ”Ğ°Ñ‚Ğ° Ğ¾ĞºĞ¾Ğ½Ñ‡Ğ°Ğ½Ğ¸Ñ Ğ¿ĞµÑ€Ğ¸Ğ¾Ğ´Ğ°
            exclude_reservation_id: ID Ñ€ĞµĞ·ĞµÑ€Ğ²Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ Ğ´Ğ»Ñ Ğ¸ÑĞºĞ»ÑÑ‡ĞµĞ½Ğ¸Ñ
            exclude_rental_id: ID Ğ°Ñ€ĞµĞ½Ğ´Ñ‹ Ğ´Ğ»Ñ Ğ¸ÑĞºĞ»ÑÑ‡ĞµĞ½Ğ¸Ñ
            current_user_id: ID Ñ‚ĞµĞºÑƒÑ‰ĞµĞ³Ğ¾ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ñ Ğ´Ğ»Ñ Ğ²Ñ‹Ğ´ĞµĞ»ĞµĞ½Ğ¸Ñ ĞµĞ³Ğ¾ Ñ€ĞµĞ·ĞµÑ€Ğ²Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğ¹
            
        Returns:
            Ğ¡Ğ»Ğ¾Ğ²Ğ°Ñ€ÑŒ ÑĞ¾ ÑÑ‚Ğ°Ñ‚ÑƒÑĞ°Ğ¼Ğ¸ Ğ¿Ğ¾ Ğ´Ğ½ÑĞ¼
        """
        return await self._status_service.get_daily_statuses(
            equipment_ids, start_date, end_date, exclude_reservation_id, exclude_rental_id, current_user_id
        )

    # === ĞœĞ•Ğ¢ĞĞ”Ğ« Ğ”Ğ›Ğ¯ Ğ ĞĞ‘ĞĞ¢Ğ« Ğ¡ ĞšĞĞ›Ğ•ĞĞ”ĞĞ Ğ•Ğœ ===
    
    async def get_calendar_events(
        self,
        equipment_ids: List[int],
        start_date: date,
        end_date: date
    ) -> List[Dict[str, Any]]:
        """
        Ğ’Ğ¾Ğ·Ğ²Ñ€Ğ°Ñ‰Ğ°ĞµÑ‚ ÑĞ¾Ğ±Ñ‹Ñ‚Ğ¸Ñ Ğ´Ğ»Ñ ĞºĞ°Ğ»ĞµĞ½Ğ´Ğ°Ñ€Ñ Ğ² Ñ„Ğ¾Ñ€Ğ¼Ğ°Ñ‚Ğµ FullCalendar.
        
        Args:
            equipment_ids: Ğ¡Ğ¿Ğ¸ÑĞ¾Ğº ID Ğ¾Ğ±Ğ¾Ñ€ÑƒĞ´Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ
            start_date: Ğ”Ğ°Ñ‚Ğ° Ğ½Ğ°Ñ‡Ğ°Ğ»Ğ° Ğ¿ĞµÑ€Ğ¸Ğ¾Ğ´Ğ°
            end_date: Ğ”Ğ°Ñ‚Ğ° Ğ¾ĞºĞ¾Ğ½Ñ‡Ğ°Ğ½Ğ¸Ñ Ğ¿ĞµÑ€Ğ¸Ğ¾Ğ´Ğ°
            
        Returns:
            Ğ¡Ğ¿Ğ¸ÑĞ¾Ğº ÑĞ¾Ğ±Ñ‹Ñ‚Ğ¸Ğ¹ Ğ´Ğ»Ñ ĞºĞ°Ğ»ĞµĞ½Ğ´Ğ°Ñ€Ñ
        """
        return await self._calendar_service.get_calendar_events(
            equipment_ids, start_date, end_date
        )

    # === ĞœĞ•Ğ¢ĞĞ”Ğ« Ğ”Ğ›Ğ¯ Ğ ĞĞ‘ĞĞ¢Ğ« Ğ¡ SQL-Ğ—ĞĞŸĞ ĞĞ¡ĞĞœĞ˜ ===
    
    def get_sqlalchemy_filter_for_available_equipment(
        self,
        start_date: date,
        end_date: date,
        exclude_reservation_id: Optional[int] = None,
        exclude_rental_id: Optional[int] = None
    ):
        """
        Ğ’Ğ¾Ğ·Ğ²Ñ€Ğ°Ñ‰Ğ°ĞµÑ‚ SQLAlchemy Ñ„Ğ¸Ğ»ÑŒÑ‚Ñ€ Ğ´Ğ»Ñ Ğ¸ÑĞºĞ»ÑÑ‡ĞµĞ½Ğ¸Ñ Ğ½ĞµĞ´Ğ¾ÑÑ‚ÑƒĞ¿Ğ½Ğ¾Ğ³Ğ¾ Ğ¾Ğ±Ğ¾Ñ€ÑƒĞ´Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ.
        Ğ˜ÑĞ¿Ğ¾Ğ»ÑŒĞ·ÑƒĞµÑ‚ÑÑ Ğ´Ğ»Ñ Ğ¾Ğ¿Ñ‚Ğ¸Ğ¼Ğ¸Ğ·Ğ°Ñ†Ğ¸Ğ¸ Ğ·Ğ°Ğ¿Ñ€Ğ¾ÑĞ¾Ğ² Ğ² EquipmentQueryBuilder.
        
        Args:
            start_date: Ğ”Ğ°Ñ‚Ğ° Ğ½Ğ°Ñ‡Ğ°Ğ»Ğ° Ğ¿ĞµÑ€Ğ¸Ğ¾Ğ´Ğ°
            end_date: Ğ”Ğ°Ñ‚Ğ° Ğ¾ĞºĞ¾Ğ½Ñ‡Ğ°Ğ½Ğ¸Ñ Ğ¿ĞµÑ€Ğ¸Ğ¾Ğ´Ğ°
            exclude_reservation_id: ID Ñ€ĞµĞ·ĞµÑ€Ğ²Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ Ğ´Ğ»Ñ Ğ¸ÑĞºĞ»ÑÑ‡ĞµĞ½Ğ¸Ñ
            exclude_rental_id: ID Ğ°Ñ€ĞµĞ½Ğ´Ñ‹ Ğ´Ğ»Ñ Ğ¸ÑĞºĞ»ÑÑ‡ĞµĞ½Ğ¸Ñ
            
        Returns:
            SQLAlchemy BinaryExpression Ğ´Ğ»Ñ Ñ„Ğ¸Ğ»ÑŒÑ‚Ñ€Ğ°Ñ†Ğ¸Ğ¸
        """
        return self._query_service.get_sqlalchemy_filter_for_available_equipment(
            start_date, end_date, exclude_reservation_id, exclude_rental_id
        )

```



## `api\services\availability\base.py`


```python

# api/services/availability/base.py

from sqlalchemy.ext.asyncio import AsyncSession
from sqlalchemy.orm import selectinload
from sqlalchemy import select
from datetime import date
from typing import List, Dict, Any, Optional
import logging

from api.models.reservation import Reservation
from api.models.equipment import Equipment
from api.models.rental import Rental

logger = logging.getLogger(__name__)


class AvailabilityBaseService:
    """
    Ğ‘Ğ°Ğ·Ğ¾Ğ²Ñ‹Ğ¹ ĞºĞ»Ğ°ÑÑ Ğ´Ğ»Ñ ÑĞµÑ€Ğ²Ğ¸ÑĞ¾Ğ² Ğ¿Ñ€Ğ¾Ğ²ĞµÑ€ĞºĞ¸ Ğ´Ğ¾ÑÑ‚ÑƒĞ¿Ğ½Ğ¾ÑÑ‚Ğ¸ Ğ¾Ğ±Ğ¾Ñ€ÑƒĞ´Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ.
    Ğ¡Ğ¾Ğ´ĞµÑ€Ğ¶Ğ¸Ñ‚ Ğ¾Ğ±Ñ‰ÑƒÑ Ğ»Ğ¾Ğ³Ğ¸ĞºÑƒ Ğ´Ğ»Ñ Ñ€Ğ°Ğ±Ğ¾Ñ‚Ñ‹ Ñ Ñ€ĞµĞ·ĞµÑ€Ğ²Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸ÑĞ¼Ğ¸ Ğ¸ Ğ°Ñ€ĞµĞ½Ğ´Ğ°Ğ¼Ğ¸.
    """

    def __init__(self, db: AsyncSession):
        self.db = db

    async def _get_overlapping_reservations(
        self,
        equipment_ids: List[int],
        start_date: date,
        end_date: date,
        exclude_reservation_id: Optional[int] = None
    ) -> List[Reservation]:
        """
        ĞŸĞ¾Ğ»ÑƒÑ‡Ğ°ĞµÑ‚ Ñ€ĞµĞ·ĞµÑ€Ğ²Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ, Ğ¿ĞµÑ€ĞµÑĞµĞºĞ°ÑÑ‰Ğ¸ĞµÑÑ Ñ ÑƒĞºĞ°Ğ·Ğ°Ğ½Ğ½Ñ‹Ğ¼ Ğ¿ĞµÑ€Ğ¸Ğ¾Ğ´Ğ¾Ğ¼.
        
        Args:
            equipment_ids: Ğ¡Ğ¿Ğ¸ÑĞ¾Ğº ID Ğ¾Ğ±Ğ¾Ñ€ÑƒĞ´Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ Ğ´Ğ»Ñ Ğ¿Ñ€Ğ¾Ğ²ĞµÑ€ĞºĞ¸
            start_date: Ğ”Ğ°Ñ‚Ğ° Ğ½Ğ°Ñ‡Ğ°Ğ»Ğ° Ğ¿ĞµÑ€Ğ¸Ğ¾Ğ´Ğ°
            end_date: Ğ”Ğ°Ñ‚Ğ° Ğ¾ĞºĞ¾Ğ½Ñ‡Ğ°Ğ½Ğ¸Ñ Ğ¿ĞµÑ€Ğ¸Ğ¾Ğ´Ğ°
            exclude_reservation_id: ID Ñ€ĞµĞ·ĞµÑ€Ğ²Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ Ğ´Ğ»Ñ Ğ¸ÑĞºĞ»ÑÑ‡ĞµĞ½Ğ¸Ñ
            
        Returns:
            Ğ¡Ğ¿Ğ¸ÑĞ¾Ğº Ñ€ĞµĞ·ĞµÑ€Ğ²Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğ¹, Ğ¿ĞµÑ€ĞµÑĞµĞºĞ°ÑÑ‰Ğ¸Ñ…ÑÑ Ñ Ğ¿ĞµÑ€Ğ¸Ğ¾Ğ´Ğ¾Ğ¼
        """
        query = select(Reservation).options(
            selectinload(Reservation.equipment)
        ).filter(
            Reservation.end_date > start_date,
            Reservation.start_date < end_date,
            Reservation.status == 'active'
        ).where(
            Reservation.equipment.any(Equipment.id.in_(equipment_ids))
        )
        
        if exclude_reservation_id:
            query = query.filter(Reservation.id != exclude_reservation_id)
            
        result = await self.db.execute(query)
        return result.unique().scalars().all()

    async def _get_overlapping_rentals(
        self,
        equipment_ids: List[int],
        start_date: date,
        end_date: date,
        exclude_rental_id: Optional[int] = None
    ) -> List[Rental]:
        """
        ĞŸĞ¾Ğ»ÑƒÑ‡Ğ°ĞµÑ‚ Ğ°Ñ€ĞµĞ½Ğ´Ñ‹, Ğ¿ĞµÑ€ĞµÑĞµĞºĞ°ÑÑ‰Ğ¸ĞµÑÑ Ñ ÑƒĞºĞ°Ğ·Ğ°Ğ½Ğ½Ñ‹Ğ¼ Ğ¿ĞµÑ€Ğ¸Ğ¾Ğ´Ğ¾Ğ¼.
        
        Args:
            equipment_ids: Ğ¡Ğ¿Ğ¸ÑĞ¾Ğº ID Ğ¾Ğ±Ğ¾Ñ€ÑƒĞ´Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ Ğ´Ğ»Ñ Ğ¿Ñ€Ğ¾Ğ²ĞµÑ€ĞºĞ¸
            start_date: Ğ”Ğ°Ñ‚Ğ° Ğ½Ğ°Ñ‡Ğ°Ğ»Ğ° Ğ¿ĞµÑ€Ğ¸Ğ¾Ğ´Ğ°
            end_date: Ğ”Ğ°Ñ‚Ğ° Ğ¾ĞºĞ¾Ğ½Ñ‡Ğ°Ğ½Ğ¸Ñ Ğ¿ĞµÑ€Ğ¸Ğ¾Ğ´Ğ°
            exclude_rental_id: ID Ğ°Ñ€ĞµĞ½Ğ´Ñ‹ Ğ´Ğ»Ñ Ğ¸ÑĞºĞ»ÑÑ‡ĞµĞ½Ğ¸Ñ
            
        Returns:
            Ğ¡Ğ¿Ğ¸ÑĞ¾Ğº Ğ°Ñ€ĞµĞ½Ğ´, Ğ¿ĞµÑ€ĞµÑĞµĞºĞ°ÑÑ‰Ğ¸Ñ…ÑÑ Ñ Ğ¿ĞµÑ€Ğ¸Ğ¾Ğ´Ğ¾Ğ¼
        """
        query = select(Rental).options(
            selectinload(Rental.equipment)
        ).filter(
            Rental.end_date > start_date,
            Rental.start_date < end_date,
            Rental.status.in_(['active', 'overdue'])
        ).where(
            Rental.equipment.any(Equipment.id.in_(equipment_ids))
        )
        
        if exclude_rental_id:
            query = query.filter(Rental.id != exclude_rental_id)
            
        result = await self.db.execute(query)
        return result.unique().scalars().all()

    def _filter_equipment_in_list(
        self,
        equipment_list: List[Equipment],
        equipment_ids: List[int]
    ) -> List[Equipment]:
        """
        Ğ¤Ğ¸Ğ»ÑŒÑ‚Ñ€ÑƒĞµÑ‚ Ğ¾Ğ±Ğ¾Ñ€ÑƒĞ´Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ Ğ¿Ğ¾ ÑĞ¿Ğ¸ÑĞºÑƒ ID.
        
        Args:
            equipment_list: Ğ¡Ğ¿Ğ¸ÑĞ¾Ğº Ğ¾Ğ±Ğ¾Ñ€ÑƒĞ´Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ Ğ´Ğ»Ñ Ñ„Ğ¸Ğ»ÑŒÑ‚Ñ€Ğ°Ñ†Ğ¸Ğ¸
            equipment_ids: Ğ¡Ğ¿Ğ¸ÑĞ¾Ğº ID Ğ¾Ğ±Ğ¾Ñ€ÑƒĞ´Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ Ğ´Ğ»Ñ Ğ²ĞºĞ»ÑÑ‡ĞµĞ½Ğ¸Ñ
            
        Returns:
            ĞÑ‚Ñ„Ğ¸Ğ»ÑŒÑ‚Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ½Ñ‹Ğ¹ ÑĞ¿Ğ¸ÑĞ¾Ğº Ğ¾Ğ±Ğ¾Ñ€ÑƒĞ´Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ
        """
        return [eq for eq in equipment_list if eq.id in equipment_ids]

    def _create_conflict_dict(
        self,
        conflict_type: str,
        conflict_id: int,
        start_date: date,
        end_date: date,
        user_id: int
    ) -> Dict[str, Any]:
        """
        Ğ¡Ğ¾Ğ·Ğ´Ğ°ĞµÑ‚ ÑĞ»Ğ¾Ğ²Ğ°Ñ€ÑŒ Ñ Ğ¸Ğ½Ñ„Ğ¾Ñ€Ğ¼Ğ°Ñ†Ğ¸ĞµĞ¹ Ğ¾ ĞºĞ¾Ğ½Ñ„Ğ»Ğ¸ĞºÑ‚Ğµ.
        
        Args:
            conflict_type: Ğ¢Ğ¸Ğ¿ ĞºĞ¾Ğ½Ñ„Ğ»Ğ¸ĞºÑ‚Ğ° ('reservation' Ğ¸Ğ»Ğ¸ 'rental')
            conflict_id: ID ĞºĞ¾Ğ½Ñ„Ğ»Ğ¸ĞºÑ‚Ğ°
            start_date: Ğ”Ğ°Ñ‚Ğ° Ğ½Ğ°Ñ‡Ğ°Ğ»Ğ°
            end_date: Ğ”Ğ°Ñ‚Ğ° Ğ¾ĞºĞ¾Ğ½Ñ‡Ğ°Ğ½Ğ¸Ñ
            user_id: ID Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ñ
            
        Returns:
            Ğ¡Ğ»Ğ¾Ğ²Ğ°Ñ€ÑŒ Ñ Ğ¸Ğ½Ñ„Ğ¾Ñ€Ğ¼Ğ°Ñ†Ğ¸ĞµĞ¹ Ğ¾ ĞºĞ¾Ğ½Ñ„Ğ»Ğ¸ĞºÑ‚Ğµ
        """
        return {
            'type': conflict_type,
            'id': conflict_id,
            'start_date': start_date,
            'end_date': end_date,
            'user_id': user_id
        }

```



## `api\services\availability\calendar.py`


```python

# api/services/availability/calendar.py

from sqlalchemy.orm import selectinload, joinedload
from sqlalchemy import select
from datetime import date
from typing import List, Dict, Any

from .base import AvailabilityBaseService
from api.models.rental import Rental 
from api.models.reservation import Reservation


class AvailabilityCalendarService(AvailabilityBaseService):
    """
    Ğ¡ĞµÑ€Ğ²Ğ¸Ñ Ğ´Ğ»Ñ Ñ€Ğ°Ğ±Ğ¾Ñ‚Ñ‹ Ñ ĞºĞ°Ğ»ĞµĞ½Ğ´Ğ°Ñ€Ğ½Ñ‹Ğ¼Ğ¸ ÑĞ¾Ğ±Ñ‹Ñ‚Ğ¸ÑĞ¼Ğ¸.
    ĞÑ‚Ğ²ĞµÑ‡Ğ°ĞµÑ‚ Ğ·Ğ° Ğ³ĞµĞ½ĞµÑ€Ğ°Ñ†Ğ¸Ñ ÑĞ¾Ğ±Ñ‹Ñ‚Ğ¸Ğ¹ Ğ´Ğ»Ñ FullCalendar Ğ¸ Ğ´Ñ€ÑƒĞ³Ğ¸Ñ… ĞºĞ°Ğ»ĞµĞ½Ğ´Ğ°Ñ€Ğ½Ñ‹Ñ… Ğ¿Ñ€ĞµĞ´ÑÑ‚Ğ°Ğ²Ğ»ĞµĞ½Ğ¸Ğ¹.
    """

    async def get_calendar_events(
        self,
        equipment_ids: List[int],
        start_date: date,
        end_date: date
    ) -> List[Dict[str, Any]]:
        """
        Ğ’Ğ¾Ğ·Ğ²Ñ€Ğ°Ñ‰Ğ°ĞµÑ‚ ÑĞ¾Ğ±Ñ‹Ñ‚Ğ¸Ñ Ğ´Ğ»Ñ ĞºĞ°Ğ»ĞµĞ½Ğ´Ğ°Ñ€Ñ Ğ² Ñ„Ğ¾Ñ€Ğ¼Ğ°Ñ‚Ğµ FullCalendar.
        
        Args:
            equipment_ids: Ğ¡Ğ¿Ğ¸ÑĞ¾Ğº ID Ğ¾Ğ±Ğ¾Ñ€ÑƒĞ´Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ
            start_date: Ğ”Ğ°Ñ‚Ğ° Ğ½Ğ°Ñ‡Ğ°Ğ»Ğ° Ğ¿ĞµÑ€Ğ¸Ğ¾Ğ´Ğ°
            end_date: Ğ”Ğ°Ñ‚Ğ° Ğ¾ĞºĞ¾Ğ½Ñ‡Ğ°Ğ½Ğ¸Ñ Ğ¿ĞµÑ€Ğ¸Ğ¾Ğ´Ğ°
            
        Returns:
            Ğ¡Ğ¿Ğ¸ÑĞ¾Ğº ÑĞ¾Ğ±Ñ‹Ñ‚Ğ¸Ğ¹ Ğ´Ğ»Ñ ĞºĞ°Ğ»ĞµĞ½Ğ´Ğ°Ñ€Ñ
        """
        events = []

        # 1. Ğ˜ÑĞ¿Ğ¾Ğ»ÑŒĞ·ÑƒĞµĞ¼ Ğ¸ÑĞ¿Ñ€Ğ°Ğ²Ğ»ĞµĞ½Ğ½Ñ‹Ğ¹ Ğ¼ĞµÑ‚Ğ¾Ğ´ Ğ¸Ğ· Ğ±Ğ°Ğ·Ğ¾Ğ²Ğ¾Ğ³Ğ¾ ĞºĞ»Ğ°ÑÑĞ° Ğ´Ğ»Ñ Ğ¿Ğ¾Ğ»ÑƒÑ‡ĞµĞ½Ğ¸Ñ Ğ°Ñ€ĞµĞ½Ğ´
        rentals = await self._get_overlapping_rentals(equipment_ids, start_date, end_date)
        for rental in rentals:
            for equipment in rental.equipment:
                # ĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑĞµĞ¼, Ñ‡Ñ‚Ğ¾ Ğ¾Ğ±Ğ¾Ñ€ÑƒĞ´Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ Ğ¸Ğ· Ğ°Ñ€ĞµĞ½Ğ´Ñ‹ ĞµÑÑ‚ÑŒ Ğ² Ğ½Ğ°ÑˆĞµĞ¼ Ğ·Ğ°Ğ¿Ñ€Ğ¾ÑĞµ
                if equipment.id in equipment_ids:
                    events.append({
                        "id": f"rental-{rental.id}-{equipment.id}",
                        "title": f"ĞÑ€ĞµĞ½Ğ´Ğ°: {equipment.name}",
                        "start": rental.start_date.strftime("%Y-%m-%d"),
                        "end": rental.end_date.strftime("%Y-%m-%d"),
                        "resourceId": equipment.id,
                        "status": "rented"
                    })
        
        # 2. Ğ˜ÑĞ¿Ğ¾Ğ»ÑŒĞ·ÑƒĞµĞ¼ Ğ¸ÑĞ¿Ñ€Ğ°Ğ²Ğ»ĞµĞ½Ğ½Ñ‹Ğ¹ Ğ¼ĞµÑ‚Ğ¾Ğ´ Ğ¸Ğ· Ğ±Ğ°Ğ·Ğ¾Ğ²Ğ¾Ğ³Ğ¾ ĞºĞ»Ğ°ÑÑĞ° Ğ´Ğ»Ñ Ğ¿Ğ¾Ğ»ÑƒÑ‡ĞµĞ½Ğ¸Ñ Ñ€ĞµĞ·ĞµÑ€Ğ²Ğ¾Ğ²
        reservations = await self._get_overlapping_reservations(equipment_ids, start_date, end_date)
        for reservation in reservations:
            # Ğ”Ğ¾Ğ¿Ğ¾Ğ»Ğ½Ğ¸Ñ‚ĞµĞ»ÑŒĞ½Ğ¾ Ğ·Ğ°Ğ³Ñ€ÑƒĞ¶Ğ°ĞµĞ¼ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ñ, ĞµÑĞ»Ğ¸ ÑÑ‚Ğ¾ Ğ½ĞµĞ¾Ğ±Ñ…Ğ¾Ğ´Ğ¸Ğ¼Ğ¾
            await self.db.refresh(reservation, attribute_names=['user'])
            for equipment in reservation.equipment:
                # ĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑĞµĞ¼, Ñ‡Ñ‚Ğ¾ Ğ¾Ğ±Ğ¾Ñ€ÑƒĞ´Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ Ğ¸Ğ· Ñ€ĞµĞ·ĞµÑ€Ğ²Ğ° ĞµÑÑ‚ÑŒ Ğ² Ğ½Ğ°ÑˆĞµĞ¼ Ğ·Ğ°Ğ¿Ñ€Ğ¾ÑĞµ
                if equipment.id in equipment_ids:
                    events.append({
                        "id": f"reservation-{reservation.id}-{equipment.id}",
                        "title": f"Ğ ĞµĞ·ĞµÑ€Ğ²: {reservation.user.full_name}",
                        "start": reservation.start_date.strftime("%Y-%m-%d"),
                        "end": reservation.end_date.strftime("%Y-%m-%d"),
                        "resourceId": equipment.id,
                        "status": "reserved"
                    })
        
        return events


```



## `api\services\availability\conflicts.py`


```python

# api/services/availability/conflicts.py

from datetime import date
from typing import List, Dict, Any, Optional

from .base import AvailabilityBaseService


class AvailabilityConflictsService(AvailabilityBaseService):
    """
    Ğ¡ĞµÑ€Ğ²Ğ¸Ñ Ğ´Ğ»Ñ Ñ€Ğ°Ğ±Ğ¾Ñ‚Ñ‹ Ñ ĞºĞ¾Ğ½Ñ„Ğ»Ğ¸ĞºÑ‚Ğ°Ğ¼Ğ¸ Ğ´Ğ¾ÑÑ‚ÑƒĞ¿Ğ½Ğ¾ÑÑ‚Ğ¸ Ğ¾Ğ±Ğ¾Ñ€ÑƒĞ´Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ.
    ĞÑ‚Ğ²ĞµÑ‡Ğ°ĞµÑ‚ Ğ·Ğ° Ğ¿Ğ¾Ğ¸ÑĞº Ğ¸ Ğ°Ğ½Ğ°Ğ»Ğ¸Ğ· ĞºĞ¾Ğ½Ñ„Ğ»Ğ¸ĞºÑ‚Ğ¾Ğ² Ğ¼ĞµĞ¶Ğ´Ñƒ Ñ€ĞµĞ·ĞµÑ€Ğ²Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸ÑĞ¼Ğ¸ Ğ¸ Ğ°Ñ€ĞµĞ½Ğ´Ğ°Ğ¼Ğ¸.
    """

    async def get_conflicts(
        self,
        equipment_ids: List[int],
        start_date: date,
        end_date: date,
        exclude_reservation_id: Optional[int] = None,
        exclude_rental_id: Optional[int] = None
    ) -> Dict[int, List[Dict[str, Any]]]:
        """
        ĞÑĞ½Ğ¾Ğ²Ğ½Ğ¾Ğ¹ Ğ¼ĞµÑ‚Ğ¾Ğ´ Ğ´Ğ»Ñ Ğ¿Ğ¾Ğ»ÑƒÑ‡ĞµĞ½Ğ¸Ñ Ğ²ÑĞµÑ… ĞºĞ¾Ğ½Ñ„Ğ»Ğ¸ĞºÑ‚Ğ¾Ğ² Ğ´Ğ¾ÑÑ‚ÑƒĞ¿Ğ½Ğ¾ÑÑ‚Ğ¸ Ğ¾Ğ±Ğ¾Ñ€ÑƒĞ´Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ.
        
        Args:
            equipment_ids: Ğ¡Ğ¿Ğ¸ÑĞ¾Ğº ID Ğ¾Ğ±Ğ¾Ñ€ÑƒĞ´Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ Ğ´Ğ»Ñ Ğ¿Ñ€Ğ¾Ğ²ĞµÑ€ĞºĞ¸
            start_date: Ğ”Ğ°Ñ‚Ğ° Ğ½Ğ°Ñ‡Ğ°Ğ»Ğ° Ğ¿ĞµÑ€Ğ¸Ğ¾Ğ´Ğ°
            end_date: Ğ”Ğ°Ñ‚Ğ° Ğ¾ĞºĞ¾Ğ½Ñ‡Ğ°Ğ½Ğ¸Ñ Ğ¿ĞµÑ€Ğ¸Ğ¾Ğ´Ğ° (Ğ²ĞºĞ»ÑÑ‡Ğ¸Ñ‚ĞµĞ»ÑŒĞ½Ğ¾)
            exclude_reservation_id: ID Ñ€ĞµĞ·ĞµÑ€Ğ²Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ Ğ´Ğ»Ñ Ğ¸ÑĞºĞ»ÑÑ‡ĞµĞ½Ğ¸Ñ Ğ¸Ğ· Ğ¿Ñ€Ğ¾Ğ²ĞµÑ€ĞºĞ¸
            exclude_rental_id: ID Ğ°Ñ€ĞµĞ½Ğ´Ñ‹ Ğ´Ğ»Ñ Ğ¸ÑĞºĞ»ÑÑ‡ĞµĞ½Ğ¸Ñ Ğ¸Ğ· Ğ¿Ñ€Ğ¾Ğ²ĞµÑ€ĞºĞ¸
            
        Returns:
            Ğ¡Ğ»Ğ¾Ğ²Ğ°Ñ€ÑŒ, Ğ³Ğ´Ğµ ĞºĞ»ÑÑ‡ - ID Ğ¾Ğ±Ğ¾Ñ€ÑƒĞ´Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ, Ğ·Ğ½Ğ°Ñ‡ĞµĞ½Ğ¸Ğµ - ÑĞ¿Ğ¸ÑĞ¾Ğº ĞºĞ¾Ğ½Ñ„Ğ»Ğ¸ĞºÑ‚Ğ¾Ğ²
        """
        conflicts: Dict[int, List[Dict[str, Any]]] = {}
        
        # ĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑĞµĞ¼, Ñ‡Ñ‚Ğ¾ ÑĞ¿Ğ¸ÑĞ¾Ğº Ğ¾Ğ±Ğ¾Ñ€ÑƒĞ´Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ Ğ½Ğµ Ğ¿ÑƒÑÑ‚Ğ¾Ğ¹
        if not equipment_ids:
            return conflicts
        
        # ĞŸĞ¾Ğ»ÑƒÑ‡Ğ°ĞµĞ¼ Ğ¿ĞµÑ€ĞµÑĞµĞºĞ°ÑÑ‰Ğ¸ĞµÑÑ Ñ€ĞµĞ·ĞµÑ€Ğ²Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ
        overlapping_reservations = await self._get_overlapping_reservations(
            equipment_ids, start_date, end_date, exclude_reservation_id
        )
        
        # ĞŸĞ¾Ğ»ÑƒÑ‡Ğ°ĞµĞ¼ Ğ¿ĞµÑ€ĞµÑĞµĞºĞ°ÑÑ‰Ğ¸ĞµÑÑ Ğ°Ñ€ĞµĞ½Ğ´Ñ‹
        overlapping_rentals = await self._get_overlapping_rentals(
            equipment_ids, start_date, end_date, exclude_rental_id
        )
        
        # ĞĞ±Ñ€Ğ°Ğ±Ğ¾Ñ‚ĞºĞ° Ñ€ĞµĞ·ĞµÑ€Ğ²Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğ¹
        for reservation in overlapping_reservations:
            for equipment in reservation.equipment:
                if equipment.id in equipment_ids:
                    if equipment.id not in conflicts:
                        conflicts[equipment.id] = []
                    
                    conflict_dict = self._create_conflict_dict(
                        'reservation',
                        reservation.id,
                        reservation.start_date,
                        reservation.end_date,
                        reservation.user_id
                    )
                    conflicts[equipment.id].append(conflict_dict)
        
        # ĞĞ±Ñ€Ğ°Ğ±Ğ¾Ñ‚ĞºĞ° Ğ°Ñ€ĞµĞ½Ğ´
        for rental in overlapping_rentals:
            for equipment in rental.equipment:
                if equipment.id in equipment_ids:
                    if equipment.id not in conflicts:
                        conflicts[equipment.id] = []
                    
                    conflict_dict = self._create_conflict_dict(
                        'rental',
                        rental.id,
                        rental.start_date,
                        rental.end_date,
                        rental.user_id
                    )
                    conflicts[equipment.id].append(conflict_dict)
        
        return conflicts

    async def get_conflicting_equipment_ids(
        self,
        equipment_ids: List[int],
        start_date: date,
        end_date: date,
        exclude_reservation_id: Optional[int] = None,
        exclude_rental_id: Optional[int] = None
    ) -> List[int]:
        """
        Ğ’Ğ¾Ğ·Ğ²Ñ€Ğ°Ñ‰Ğ°ĞµÑ‚ ÑĞ¿Ğ¸ÑĞ¾Ğº ID Ğ¾Ğ±Ğ¾Ñ€ÑƒĞ´Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ, Ñƒ ĞºĞ¾Ñ‚Ğ¾Ñ€Ğ¾Ğ³Ğ¾ ĞµÑÑ‚ÑŒ ĞºĞ¾Ğ½Ñ„Ğ»Ğ¸ĞºÑ‚Ñ‹ Ğ´Ğ¾ÑÑ‚ÑƒĞ¿Ğ½Ğ¾ÑÑ‚Ğ¸.
        
        Args:
            equipment_ids: Ğ¡Ğ¿Ğ¸ÑĞ¾Ğº ID Ğ¾Ğ±Ğ¾Ñ€ÑƒĞ´Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ Ğ´Ğ»Ñ Ğ¿Ñ€Ğ¾Ğ²ĞµÑ€ĞºĞ¸
            start_date: Ğ”Ğ°Ñ‚Ğ° Ğ½Ğ°Ñ‡Ğ°Ğ»Ğ° Ğ¿ĞµÑ€Ğ¸Ğ¾Ğ´Ğ°
            end_date: Ğ”Ğ°Ñ‚Ğ° Ğ¾ĞºĞ¾Ğ½Ñ‡Ğ°Ğ½Ğ¸Ñ Ğ¿ĞµÑ€Ğ¸Ğ¾Ğ´Ğ°
            exclude_reservation_id: ID Ñ€ĞµĞ·ĞµÑ€Ğ²Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ Ğ´Ğ»Ñ Ğ¸ÑĞºĞ»ÑÑ‡ĞµĞ½Ğ¸Ñ
            exclude_rental_id: ID Ğ°Ñ€ĞµĞ½Ğ´Ñ‹ Ğ´Ğ»Ñ Ğ¸ÑĞºĞ»ÑÑ‡ĞµĞ½Ğ¸Ñ
            
        Returns:
            Ğ¡Ğ¿Ğ¸ÑĞ¾Ğº ID Ğ¾Ğ±Ğ¾Ñ€ÑƒĞ´Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ Ñ ĞºĞ¾Ğ½Ñ„Ğ»Ğ¸ĞºÑ‚Ğ°Ğ¼Ğ¸
        """
        conflicts = await self.get_conflicts(
            equipment_ids, start_date, end_date, exclude_reservation_id, exclude_rental_id
        )
        return list(conflicts.keys())

    def _get_most_critical_conflict(
        self,
        conflict_list: List[Dict[str, Any]]
    ) -> Optional[Dict[str, Any]]:
        """
        Ğ’Ğ¾Ğ·Ğ²Ñ€Ğ°Ñ‰Ğ°ĞµÑ‚ Ğ½Ğ°Ğ¸Ğ±Ğ¾Ğ»ĞµĞµ ĞºÑ€Ğ¸Ñ‚Ğ¸Ñ‡Ğ½Ñ‹Ğ¹ ĞºĞ¾Ğ½Ñ„Ğ»Ğ¸ĞºÑ‚ Ğ¸Ğ· ÑĞ¿Ğ¸ÑĞºĞ°.
        ĞŸÑ€Ğ¸Ğ¾Ñ€Ğ¸Ñ‚ĞµÑ‚: rental > reservation.
        
        Args:
            conflict_list: Ğ¡Ğ¿Ğ¸ÑĞ¾Ğº ĞºĞ¾Ğ½Ñ„Ğ»Ğ¸ĞºÑ‚Ğ¾Ğ²
            
        Returns:
            ĞĞ°Ğ¸Ğ±Ğ¾Ğ»ĞµĞµ ĞºÑ€Ğ¸Ñ‚Ğ¸Ñ‡Ğ½Ñ‹Ğ¹ ĞºĞ¾Ğ½Ñ„Ğ»Ğ¸ĞºÑ‚ Ğ¸Ğ»Ğ¸ None
        """
        if not conflict_list:
            return None
        
        # Ğ¡Ğ¾Ñ€Ñ‚Ğ¸Ñ€ÑƒĞµĞ¼ ĞºĞ¾Ğ½Ñ„Ğ»Ğ¸ĞºÑ‚Ñ‹ Ğ¿Ğ¾ Ğ¿Ñ€Ğ¸Ğ¾Ñ€Ğ¸Ñ‚ĞµÑ‚Ñƒ: rental > reservation
        sorted_conflicts = sorted(
            conflict_list, 
            key=lambda c: (c['type'] != 'rental', c['type'] != 'reservation')
        )
        return sorted_conflicts[0]

```



## `api\services\availability\queries.py`


```python

# api/services/availability/queries.py

from sqlalchemy import select, and_
from datetime import date
from typing import Optional

from .base import AvailabilityBaseService
from api.models.equipment import Equipment
from api.models.reservation import Reservation
from api.models.rental import Rental


class AvailabilityQueryService(AvailabilityBaseService):
    """
    Ğ¡ĞµÑ€Ğ²Ğ¸Ñ Ğ´Ğ»Ñ Ñ€Ğ°Ğ±Ğ¾Ñ‚Ñ‹ Ñ SQL-Ğ·Ğ°Ğ¿Ñ€Ğ¾ÑĞ°Ğ¼Ğ¸ Ğ¸ Ñ„Ğ¸Ğ»ÑŒÑ‚Ñ€Ğ°Ğ¼Ğ¸.
    ĞÑ‚Ğ²ĞµÑ‡Ğ°ĞµÑ‚ Ğ·Ğ° ÑĞ¾Ğ·Ğ´Ğ°Ğ½Ğ¸Ğµ Ğ¾Ğ¿Ñ‚Ğ¸Ğ¼Ğ¸Ğ·Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ½Ñ‹Ñ… SQL-Ğ·Ğ°Ğ¿Ñ€Ğ¾ÑĞ¾Ğ² Ğ´Ğ»Ñ Ğ¿Ñ€Ğ¾Ğ²ĞµÑ€ĞºĞ¸ Ğ´Ğ¾ÑÑ‚ÑƒĞ¿Ğ½Ğ¾ÑÑ‚Ğ¸.
    """

    def get_sqlalchemy_filter_for_available_equipment(
        self,
        start_date: date,
        end_date: date,
        exclude_reservation_id: Optional[int] = None,
        exclude_rental_id: Optional[int] = None
    ):
        """
        Ğ’Ğ¾Ğ·Ğ²Ñ€Ğ°Ñ‰Ğ°ĞµÑ‚ SQLAlchemy Ñ„Ğ¸Ğ»ÑŒÑ‚Ñ€ Ğ´Ğ»Ñ Ğ¸ÑĞºĞ»ÑÑ‡ĞµĞ½Ğ¸Ñ Ğ½ĞµĞ´Ğ¾ÑÑ‚ÑƒĞ¿Ğ½Ğ¾Ğ³Ğ¾ Ğ¾Ğ±Ğ¾Ñ€ÑƒĞ´Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ.
        Ğ˜ÑĞ¿Ğ¾Ğ»ÑŒĞ·ÑƒĞµÑ‚ÑÑ Ğ´Ğ»Ñ Ğ¾Ğ¿Ñ‚Ğ¸Ğ¼Ğ¸Ğ·Ğ°Ñ†Ğ¸Ğ¸ Ğ·Ğ°Ğ¿Ñ€Ğ¾ÑĞ¾Ğ² Ğ² EquipmentQueryBuilder.
        
        Args:
            start_date: Ğ”Ğ°Ñ‚Ğ° Ğ½Ğ°Ñ‡Ğ°Ğ»Ğ° Ğ¿ĞµÑ€Ğ¸Ğ¾Ğ´Ğ°
            end_date: Ğ”Ğ°Ñ‚Ğ° Ğ¾ĞºĞ¾Ğ½Ñ‡Ğ°Ğ½Ğ¸Ñ Ğ¿ĞµÑ€Ğ¸Ğ¾Ğ´Ğ°
            exclude_reservation_id: ID Ñ€ĞµĞ·ĞµÑ€Ğ²Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ Ğ´Ğ»Ñ Ğ¸ÑĞºĞ»ÑÑ‡ĞµĞ½Ğ¸Ñ
            exclude_rental_id: ID Ğ°Ñ€ĞµĞ½Ğ´Ñ‹ Ğ´Ğ»Ñ Ğ¸ÑĞºĞ»ÑÑ‡ĞµĞ½Ğ¸Ñ
            
        Returns:
            SQLAlchemy BinaryExpression Ğ´Ğ»Ñ Ñ„Ğ¸Ğ»ÑŒÑ‚Ñ€Ğ°Ñ†Ğ¸Ğ¸
        """
        from api.models.reservation import reservation_equipment_association
        from api.models.rental import rental_equipment_association
        
        # ĞŸĞ¾Ğ´Ğ·Ğ°Ğ¿Ñ€Ğ¾Ñ Ğ´Ğ»Ñ ID Ğ¾Ğ±Ğ¾Ñ€ÑƒĞ´Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ, Ğ·Ğ°Ğ½ÑÑ‚Ğ¾Ğ³Ğ¾ Ğ² Ğ°ĞºÑ‚Ğ¸Ğ²Ğ½Ñ‹Ñ… Ñ€ĞµĞ·ĞµÑ€Ğ²Ğ°Ñ…
        booked_in_reservations_subquery = self._create_reservations_subquery(
            start_date, end_date, exclude_reservation_id
        )
        
        # ĞŸĞ¾Ğ´Ğ·Ğ°Ğ¿Ñ€Ğ¾Ñ Ğ´Ğ»Ñ ID Ğ¾Ğ±Ğ¾Ñ€ÑƒĞ´Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ, Ğ·Ğ°Ğ½ÑÑ‚Ğ¾Ğ³Ğ¾ Ğ² Ğ°ĞºÑ‚Ğ¸Ğ²Ğ½Ñ‹Ñ…/Ğ¿Ñ€Ğ¾ÑÑ€Ğ¾Ñ‡ĞµĞ½Ğ½Ñ‹Ñ… Ğ°Ñ€ĞµĞ½Ğ´Ğ°Ñ…
        booked_in_rentals_subquery = self._create_rentals_subquery(
            start_date, end_date, exclude_rental_id
        )
        
        # Ğ’Ğ¾Ğ·Ğ²Ñ€Ğ°Ñ‰Ğ°ĞµĞ¼ ÑƒÑĞ»Ğ¾Ğ²Ğ¸Ğµ Ğ´Ğ»Ñ Ğ¸ÑĞºĞ»ÑÑ‡ĞµĞ½Ğ¸Ñ Ğ½ĞµĞ´Ğ¾ÑÑ‚ÑƒĞ¿Ğ½Ğ¾Ğ³Ğ¾ Ğ¾Ğ±Ğ¾Ñ€ÑƒĞ´Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ
        return and_(
            Equipment.id.notin_(booked_in_reservations_subquery),
            Equipment.id.notin_(booked_in_rentals_subquery)
        )

    def _create_reservations_subquery(
        self,
        start_date: date,
        end_date: date,
        exclude_reservation_id: Optional[int] = None
    ):
        """
        Ğ¡Ğ¾Ğ·Ğ´Ğ°ĞµÑ‚ Ğ¿Ğ¾Ğ´Ğ·Ğ°Ğ¿Ñ€Ğ¾Ñ Ğ´Ğ»Ñ Ñ€ĞµĞ·ĞµÑ€Ğ²Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğ¹.
        
        Args:
            start_date: Ğ”Ğ°Ñ‚Ğ° Ğ½Ğ°Ñ‡Ğ°Ğ»Ğ° Ğ¿ĞµÑ€Ğ¸Ğ¾Ğ´Ğ°
            end_date: Ğ”Ğ°Ñ‚Ğ° Ğ¾ĞºĞ¾Ğ½Ñ‡Ğ°Ğ½Ğ¸Ñ Ğ¿ĞµÑ€Ğ¸Ğ¾Ğ´Ğ°
            exclude_reservation_id: ID Ñ€ĞµĞ·ĞµÑ€Ğ²Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ Ğ´Ğ»Ñ Ğ¸ÑĞºĞ»ÑÑ‡ĞµĞ½Ğ¸Ñ
            
        Returns:
            ĞŸĞ¾Ğ´Ğ·Ğ°Ğ¿Ñ€Ğ¾Ñ Ğ´Ğ»Ñ Ñ€ĞµĞ·ĞµÑ€Ğ²Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğ¹
        """
        from api.models.reservation import reservation_equipment_association
        
        subquery = (
            select(reservation_equipment_association.c.equipment_id)
            .join(Reservation, reservation_equipment_association.c.reservation_id == Reservation.id)
            .filter(
                Reservation.end_date > start_date,
                Reservation.start_date < end_date,
                Reservation.status == 'active'
            )
        )
        
        if exclude_reservation_id:
            subquery = subquery.filter(Reservation.id != exclude_reservation_id)
        
        return subquery.distinct()

    def _create_rentals_subquery(
        self,
        start_date: date,
        end_date: date,
        exclude_rental_id: Optional[int] = None
    ):
        """
        Ğ¡Ğ¾Ğ·Ğ´Ğ°ĞµÑ‚ Ğ¿Ğ¾Ğ´Ğ·Ğ°Ğ¿Ñ€Ğ¾Ñ Ğ´Ğ»Ñ Ğ°Ñ€ĞµĞ½Ğ´.
        
        Args:
            start_date: Ğ”Ğ°Ñ‚Ğ° Ğ½Ğ°Ñ‡Ğ°Ğ»Ğ° Ğ¿ĞµÑ€Ğ¸Ğ¾Ğ´Ğ°
            end_date: Ğ”Ğ°Ñ‚Ğ° Ğ¾ĞºĞ¾Ğ½Ñ‡Ğ°Ğ½Ğ¸Ñ Ğ¿ĞµÑ€Ğ¸Ğ¾Ğ´Ğ°
            exclude_rental_id: ID Ğ°Ñ€ĞµĞ½Ğ´Ñ‹ Ğ´Ğ»Ñ Ğ¸ÑĞºĞ»ÑÑ‡ĞµĞ½Ğ¸Ñ
            
        Returns:
            ĞŸĞ¾Ğ´Ğ·Ğ°Ğ¿Ñ€Ğ¾Ñ Ğ´Ğ»Ñ Ğ°Ñ€ĞµĞ½Ğ´
        """
        from api.models.rental import rental_equipment_association
        
        subquery = (
            select(rental_equipment_association.c.equipment_id)
            .join(Rental, rental_equipment_association.c.rental_id == Rental.id)
            .filter(
                Rental.end_date > start_date,
                Rental.start_date < end_date,
                Rental.status.in_(['active', 'overdue'])
            )
        )
        
        if exclude_rental_id:
            subquery = subquery.filter(Rental.id != exclude_rental_id)
        
        return subquery.distinct()

```



## `api\services\availability\statuses.py`


```python

# api/services/availability/statuses.py

from datetime import date, timedelta
from typing import List, Dict, Any, Optional

from .conflicts import AvailabilityConflictsService
from shared.schemas.calendar_schema import DayStatusItem


class AvailabilityStatusService(AvailabilityConflictsService):
    """
    Ğ¡ĞµÑ€Ğ²Ğ¸Ñ Ğ´Ğ»Ñ Ñ€Ğ°Ğ±Ğ¾Ñ‚Ñ‹ ÑĞ¾ ÑÑ‚Ğ°Ñ‚ÑƒÑĞ°Ğ¼Ğ¸ Ğ´Ğ¾ÑÑ‚ÑƒĞ¿Ğ½Ğ¾ÑÑ‚Ğ¸ Ğ¾Ğ±Ğ¾Ñ€ÑƒĞ´Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ.
    ĞÑ‚Ğ²ĞµÑ‡Ğ°ĞµÑ‚ Ğ·Ğ° Ğ¾Ğ¿Ñ€ĞµĞ´ĞµĞ»ĞµĞ½Ğ¸Ğµ Ğ¸ Ñ„Ğ¾Ñ€Ğ¼Ğ°Ñ‚Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ ÑÑ‚Ğ°Ñ‚ÑƒÑĞ¾Ğ² Ğ¾Ğ±Ğ¾Ñ€ÑƒĞ´Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ.
    """

    async def get_availability_statuses(
        self,
        equipment_ids: List[int],
        start_date: date,
        end_date: date,
        exclude_reservation_id: Optional[int] = None,
        exclude_rental_id: Optional[int] = None
    ) -> Dict[int, Dict[str, Any]]:
        """
        Ğ’Ğ¾Ğ·Ğ²Ñ€Ğ°Ñ‰Ğ°ĞµÑ‚ ÑÑ‚Ğ°Ñ‚ÑƒÑÑ‹ Ğ´Ğ¾ÑÑ‚ÑƒĞ¿Ğ½Ğ¾ÑÑ‚Ğ¸ Ğ´Ğ»Ñ ÑĞ¿Ğ¸ÑĞºĞ° Ğ¾Ğ±Ğ¾Ñ€ÑƒĞ´Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ.
        
        Args:
            equipment_ids: Ğ¡Ğ¿Ğ¸ÑĞ¾Ğº ID Ğ¾Ğ±Ğ¾Ñ€ÑƒĞ´Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ Ğ´Ğ»Ñ Ğ¿Ñ€Ğ¾Ğ²ĞµÑ€ĞºĞ¸
            start_date: Ğ”Ğ°Ñ‚Ğ° Ğ½Ğ°Ñ‡Ğ°Ğ»Ğ° Ğ¿ĞµÑ€Ğ¸Ğ¾Ğ´Ğ°
            end_date: Ğ”Ğ°Ñ‚Ğ° Ğ¾ĞºĞ¾Ğ½Ñ‡Ğ°Ğ½Ğ¸Ñ Ğ¿ĞµÑ€Ğ¸Ğ¾Ğ´Ğ°
            exclude_reservation_id: ID Ñ€ĞµĞ·ĞµÑ€Ğ²Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ Ğ´Ğ»Ñ Ğ¸ÑĞºĞ»ÑÑ‡ĞµĞ½Ğ¸Ñ
            exclude_rental_id: ID Ğ°Ñ€ĞµĞ½Ğ´Ñ‹ Ğ´Ğ»Ñ Ğ¸ÑĞºĞ»ÑÑ‡ĞµĞ½Ğ¸Ñ
            
        Returns:
            Ğ¡Ğ»Ğ¾Ğ²Ğ°Ñ€ÑŒ ÑĞ¾ ÑÑ‚Ğ°Ñ‚ÑƒÑĞ°Ğ¼Ğ¸ Ğ¾Ğ±Ğ¾Ñ€ÑƒĞ´Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ
        """
        statuses: Dict[int, Dict[str, Any]] = {
            eq_id: {"status": "available", "details": "Ğ”Ğ¾ÑÑ‚ÑƒĞ¿Ğ½Ğ¾"}
            for eq_id in equipment_ids
        }
        
        conflicts = await self.get_conflicts(
            equipment_ids, start_date, end_date, exclude_reservation_id, exclude_rental_id
        )
        
        for eq_id, conflict_list in conflicts.items():
            if not conflict_list:
                continue
            
            most_critical = self._get_most_critical_conflict(conflict_list)
            if most_critical:
                statuses[eq_id] = self._format_status_from_conflict(most_critical)
        
        return statuses

    async def get_daily_statuses(
        self,
        equipment_ids: List[int],
        start_date: date,
        end_date: date,
        exclude_reservation_id: Optional[int] = None,
        exclude_rental_id: Optional[int] = None,
        current_user_id: Optional[int] = None
    ) -> Dict[int, Dict[str, DayStatusItem]]:
        """
        Ğ’Ğ¾Ğ·Ğ²Ñ€Ğ°Ñ‰Ğ°ĞµÑ‚ ÑÑ‚Ğ°Ñ‚ÑƒÑÑ‹ Ğ¾Ğ±Ğ¾Ñ€ÑƒĞ´Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ Ğ¿Ğ¾ Ğ´Ğ½ÑĞ¼ Ğ´Ğ»Ñ ĞºĞ°Ğ»ĞµĞ½Ğ´Ğ°Ñ€Ğ½Ğ¾Ğ³Ğ¾ Ğ¿Ñ€ĞµĞ´ÑÑ‚Ğ°Ğ²Ğ»ĞµĞ½Ğ¸Ñ.
        
        Args:
            equipment_ids: Ğ¡Ğ¿Ğ¸ÑĞ¾Ğº ID Ğ¾Ğ±Ğ¾Ñ€ÑƒĞ´Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ Ğ´Ğ»Ñ Ğ¿Ñ€Ğ¾Ğ²ĞµÑ€ĞºĞ¸
            start_date: Ğ”Ğ°Ñ‚Ğ° Ğ½Ğ°Ñ‡Ğ°Ğ»Ğ° Ğ¿ĞµÑ€Ğ¸Ğ¾Ğ´Ğ°
            end_date: Ğ”Ğ°Ñ‚Ğ° Ğ¾ĞºĞ¾Ğ½Ñ‡Ğ°Ğ½Ğ¸Ñ Ğ¿ĞµÑ€Ğ¸Ğ¾Ğ´Ğ°
            exclude_reservation_id: ID Ñ€ĞµĞ·ĞµÑ€Ğ²Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ Ğ´Ğ»Ñ Ğ¸ÑĞºĞ»ÑÑ‡ĞµĞ½Ğ¸Ñ
            exclude_rental_id: ID Ğ°Ñ€ĞµĞ½Ğ´Ñ‹ Ğ´Ğ»Ñ Ğ¸ÑĞºĞ»ÑÑ‡ĞµĞ½Ğ¸Ñ
            current_user_id: ID Ñ‚ĞµĞºÑƒÑ‰ĞµĞ³Ğ¾ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ñ Ğ´Ğ»Ñ Ğ²Ñ‹Ğ´ĞµĞ»ĞµĞ½Ğ¸Ñ ĞµĞ³Ğ¾ Ñ€ĞµĞ·ĞµÑ€Ğ²Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğ¹
            
        Returns:
            Ğ¡Ğ»Ğ¾Ğ²Ğ°Ñ€ÑŒ ÑĞ¾ ÑÑ‚Ğ°Ñ‚ÑƒÑĞ°Ğ¼Ğ¸ Ğ¿Ğ¾ Ğ´Ğ½ÑĞ¼
        """
        num_days = (end_date - start_date).days + 1
        all_dates = [start_date + timedelta(days=i) for i in range(num_days)]
        
        result: Dict[int, Dict[str, DayStatusItem]] = {
            eq_id: {
                day.strftime('%d.%m.%Y'): DayStatusItem(status="available")
                for day in all_dates
            }
            for eq_id in equipment_ids
        }
        
        conflicts = await self.get_conflicts(
            equipment_ids, start_date, end_date, exclude_reservation_id, exclude_rental_id
        )
        
        for eq_id, conflict_list in conflicts.items():
            if eq_id not in result:
                continue
                
            for conflict in conflict_list:
                self._apply_conflict_to_daily_statuses(
                    result[eq_id], conflict, start_date, end_date, current_user_id
                )
        
        return result

    def _format_status_from_conflict(self, conflict: Dict[str, Any]) -> Dict[str, Any]:
        """
        Ğ¤Ğ¾Ñ€Ğ¼Ğ°Ñ‚Ğ¸Ñ€ÑƒĞµÑ‚ ÑÑ‚Ğ°Ñ‚ÑƒÑ Ğ½Ğ° Ğ¾ÑĞ½Ğ¾Ğ²Ğµ ĞºĞ¾Ğ½Ñ„Ğ»Ğ¸ĞºÑ‚Ğ°.
        
        Args:
            conflict: Ğ¡Ğ»Ğ¾Ğ²Ğ°Ñ€ÑŒ Ñ Ğ¸Ğ½Ñ„Ğ¾Ñ€Ğ¼Ğ°Ñ†Ğ¸ĞµĞ¹ Ğ¾ ĞºĞ¾Ğ½Ñ„Ğ»Ğ¸ĞºÑ‚Ğµ
            
        Returns:
            ĞÑ‚Ñ„Ğ¾Ñ€Ğ¼Ğ°Ñ‚Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ½Ñ‹Ğ¹ ÑÑ‚Ğ°Ñ‚ÑƒÑ
        """
        if conflict['type'] == 'rental':
            return {
                "status": "rented",
                "details": f"Ğ’ Ğ°Ñ€ĞµĞ½Ğ´Ğµ Ğ´Ğ¾ {conflict['end_date'].strftime('%d.%m.%Y')}",
                "start_date": conflict['start_date'],
                "end_date": conflict['end_date']
            }
        elif conflict['type'] == 'reservation':
            return {
                "status": "reserved",
                "details": f"Ğ—Ğ°Ñ€ĞµĞ·ĞµÑ€Ğ²Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¾ Ğ´Ğ¾ {conflict['end_date'].strftime('%d.%m.%Y')}",
                "start_date": conflict['start_date'],
                "end_date": conflict['end_date']
            }
        
        return {"status": "available", "details": "Ğ”Ğ¾ÑÑ‚ÑƒĞ¿Ğ½Ğ¾"}

    def _apply_conflict_to_daily_statuses(
        self,
        daily_statuses: Dict[str, DayStatusItem],
        conflict: Dict[str, Any],
        start_date: date,
        end_date: date,
        current_user_id: Optional[int]
    ) -> None:
        """
        ĞŸÑ€Ğ¸Ğ¼ĞµĞ½ÑĞµÑ‚ ĞºĞ¾Ğ½Ñ„Ğ»Ğ¸ĞºÑ‚ Ğº ÑÑ‚Ğ°Ñ‚ÑƒÑĞ°Ğ¼ Ğ¿Ğ¾ Ğ´Ğ½ÑĞ¼.
        
        Args:
            daily_statuses: Ğ¡Ğ»Ğ¾Ğ²Ğ°Ñ€ÑŒ ÑĞ¾ ÑÑ‚Ğ°Ñ‚ÑƒÑĞ°Ğ¼Ğ¸ Ğ¿Ğ¾ Ğ´Ğ½ÑĞ¼
            conflict: Ğ˜Ğ½Ñ„Ğ¾Ñ€Ğ¼Ğ°Ñ†Ğ¸Ñ Ğ¾ ĞºĞ¾Ğ½Ñ„Ğ»Ğ¸ĞºÑ‚Ğµ
            start_date: ĞĞ°Ñ‡Ğ°Ğ»ÑŒĞ½Ğ°Ñ Ğ´Ğ°Ñ‚Ğ° Ğ¿ĞµÑ€Ğ¸Ğ¾Ğ´Ğ°
            end_date: ĞšĞ¾Ğ½ĞµÑ‡Ğ½Ğ°Ñ Ğ´Ğ°Ñ‚Ğ° Ğ¿ĞµÑ€Ğ¸Ğ¾Ğ´Ğ°
            current_user_id: ID Ñ‚ĞµĞºÑƒÑ‰ĞµĞ³Ğ¾ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ñ
        """
        current_day = conflict['start_date']
        while current_day < conflict['end_date']:
            if start_date <= current_day <= end_date:
                day_str = current_day.strftime('%d.%m.%Y')
                if daily_statuses[day_str].status != 'rented':
                    is_user_event = (
                        current_user_id is not None and 
                        conflict.get('user_id') == current_user_id and
                        conflict['type'] == 'reservation'
                    )
                    
                    # Ğ¡Ğ¾Ğ·Ğ´Ğ°ĞµĞ¼ Ğ¼Ğ°Ğ¿Ğ¿Ğ¸Ğ½Ğ³ Ğ´Ğ»Ñ ĞºĞ¾Ñ€Ñ€ĞµĞºÑ‚Ğ½Ğ¾Ğ³Ğ¾ Ğ¿Ñ€ĞµĞ¾Ğ±Ñ€Ğ°Ğ·Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ ÑÑ‚Ğ°Ñ‚ÑƒÑĞ¾Ğ²
                    status_map = {
                        "reservation": "reserved",
                        "rental": "rented"
                    }
                    correct_status = status_map.get(conflict['type'], "available")
                    
                    daily_statuses[day_str] = DayStatusItem(
                        status=correct_status,
                        group_id=f"{conflict['type']}-{conflict['id']}",
                        is_user_reservation=is_user_event
                    )
            current_day += timedelta(days=1)

```



## `api\services\balance_service.py`


```python

# api/services/balance_service.py

from sqlalchemy.ext.asyncio import AsyncSession
from sqlalchemy import select
from fastapi import HTTPException, status
import logging

from api.models.user import User
from api.models.balance_history import BalanceHistory
from api.models.rental import Rental

logger = logging.getLogger(__name__)

class BalanceService:
    def __init__(self, db: AsyncSession):
        self.db = db

    async def add_transaction(
            self,
            user_id: int,
            amount: float,
            operation_type: str,
            description: str,
            rental_id: int | None = None
    ) -> BalanceHistory:
        """
        ĞŸÑ€Ğ¾Ğ²Ğ¾Ğ´Ğ¸Ñ‚ Ñ‚Ñ€Ğ°Ğ½Ğ·Ğ°ĞºÑ†Ğ¸Ñ, ÑĞ¾Ğ·Ğ´Ğ°Ğ²Ğ°Ñ Ğ·Ğ°Ğ¿Ğ¸ÑÑŒ Ğ² Ğ¸ÑÑ‚Ğ¾Ñ€Ğ¸Ğ¸ Ğ¸ Ğ°Ñ‚Ğ¾Ğ¼Ğ°Ñ€Ğ½Ğ¾ Ğ¾Ğ±Ğ½Ğ¾Ğ²Ğ»ÑÑ Ğ±Ğ°Ğ»Ğ°Ğ½Ñ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ñ.
        Amount: Ğ¿Ğ¾Ğ»Ğ¾Ğ¶Ğ¸Ñ‚ĞµĞ»ÑŒĞ½Ğ¾Ğµ Ñ‡Ğ¸ÑĞ»Ğ¾ Ğ´Ğ»Ñ Ğ½Ğ°Ñ‡Ğ¸ÑĞ»ĞµĞ½Ğ¸Ñ, Ğ¾Ñ‚Ñ€Ğ¸Ñ†Ğ°Ñ‚ĞµĞ»ÑŒĞ½Ğ¾Ğµ Ğ´Ğ»Ñ ÑĞ¿Ğ¸ÑĞ°Ğ½Ğ¸Ñ.
        """
        # Ğ˜ÑĞ¿Ğ¾Ğ»ÑŒĞ·ÑƒĞµĞ¼ with_for_update() Ğ´Ğ»Ñ Ğ±Ğ»Ğ¾ĞºĞ¸Ñ€Ğ¾Ğ²ĞºĞ¸ ÑÑ‚Ñ€Ğ¾ĞºĞ¸ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ñ Ğ½Ğ° Ğ²Ñ€ĞµĞ¼Ñ Ñ‚Ñ€Ğ°Ğ½Ğ·Ğ°ĞºÑ†Ğ¸Ğ¸,
        # Ñ‡Ñ‚Ğ¾Ğ±Ñ‹ Ğ¸Ğ·Ğ±ĞµĞ¶Ğ°Ñ‚ÑŒ race conditions Ğ¿Ñ€Ğ¸ Ğ¾Ğ´Ğ½Ğ¾Ğ²Ñ€ĞµĞ¼ĞµĞ½Ğ½Ñ‹Ñ… Ğ¾Ğ¿ĞµÑ€Ğ°Ñ†Ğ¸ÑÑ….
        result = await self.db.execute(select(User).filter(User.id == user_id).with_for_update())
        user = result.scalars().first()
        if not user:
            logger.error(f"ĞŸĞ¾Ğ¿Ñ‹Ñ‚ĞºĞ° Ğ¿Ñ€Ğ¾Ğ²ĞµÑÑ‚Ğ¸ Ñ‚Ñ€Ğ°Ğ½Ğ·Ğ°ĞºÑ†Ğ¸Ñ Ğ´Ğ»Ñ Ğ½ĞµÑÑƒÑ‰ĞµÑÑ‚Ğ²ÑƒÑÑ‰ĞµĞ³Ğ¾ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ñ ID={user_id}")
            # ĞÑ‚ĞºĞ°Ñ‚Ñ‹Ğ²Ğ°ĞµĞ¼ Ñ‚Ñ€Ğ°Ğ½Ğ·Ğ°ĞºÑ†Ğ¸Ñ, ĞµÑĞ»Ğ¸ Ğ¾Ğ½Ğ° Ğ±Ñ‹Ğ»Ğ° Ğ½Ğ°Ñ‡Ğ°Ñ‚Ğ°
            await self.db.rollback()
            raise HTTPException(status_code=status.HTTP_404_NOT_FOUND, detail="ĞŸĞ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ÑŒ Ğ½Ğµ Ğ½Ğ°Ğ¹Ğ´ĞµĞ½.")

        try:
            # 1. Ğ¡Ğ¾Ğ·Ğ´Ğ°ĞµĞ¼ Ğ·Ğ°Ğ¿Ğ¸ÑÑŒ Ğ² Ğ¸ÑÑ‚Ğ¾Ñ€Ğ¸Ğ¸
            new_history_entry = BalanceHistory(
                user_id=user_id,
                amount=amount,
                operation_type=operation_type,
                description=description,
                rental_id=rental_id
            )
            self.db.add(new_history_entry)

            # 2. ĞÑ‚Ğ¾Ğ¼Ğ°Ñ€Ğ½Ğ¾ Ğ¾Ğ±Ğ½Ğ¾Ğ²Ğ»ÑĞµĞ¼ ĞºÑÑˆĞ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ½Ğ¾Ğµ Ğ·Ğ½Ğ°Ñ‡ĞµĞ½Ğ¸Ğµ Ğ±Ğ°Ğ»Ğ°Ğ½ÑĞ°
            user.balance += amount

            await self.db.commit()
            await self.db.refresh(new_history_entry)
            logger.info(f"Ğ¢Ñ€Ğ°Ğ½Ğ·Ğ°ĞºÑ†Ğ¸Ñ Ğ´Ğ»Ñ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ñ ID={user_id} Ğ½Ğ° ÑÑƒĞ¼Ğ¼Ñƒ {amount} ({operation_type}) ÑƒÑĞ¿ĞµÑˆĞ½Ğ¾ Ğ¿Ñ€Ğ¾Ğ²ĞµĞ´ĞµĞ½Ğ°. ĞĞ¾Ğ²Ñ‹Ğ¹ Ğ±Ğ°Ğ»Ğ°Ğ½Ñ: {user.balance}")
            return new_history_entry

        except Exception as e:
            await self.db.rollback()
            logger.error(f"ĞÑˆĞ¸Ğ±ĞºĞ° Ñ‚Ñ€Ğ°Ğ½Ğ·Ğ°ĞºÑ†Ğ¸Ğ¸ Ğ´Ğ»Ñ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ñ ID={user_id}: {e}", exc_info=True)
            raise HTTPException(
                status_code=status.HTTP_500_INTERNAL_SERVER_ERROR,
                detail="Ğ’Ğ½ÑƒÑ‚Ñ€ĞµĞ½Ğ½ÑÑ Ğ¾ÑˆĞ¸Ğ±ĞºĞ° Ğ¿Ñ€Ğ¸ Ğ¿Ñ€Ğ¾Ğ²ĞµĞ´ĞµĞ½Ğ¸Ğ¸ Ñ„Ğ¸Ğ½Ğ°Ğ½ÑĞ¾Ğ²Ğ¾Ğ¹ Ğ¾Ğ¿ĞµÑ€Ğ°Ñ†Ğ¸Ğ¸."
            )

    async def get_balance_for_user(self, user_id: int) -> float:
        """Ğ’Ğ¾Ğ·Ğ²Ñ€Ğ°Ñ‰Ğ°ĞµÑ‚ Ñ‚ĞµĞºÑƒÑ‰Ğ¸Ğ¹ Ğ±Ğ°Ğ»Ğ°Ğ½Ñ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ñ."""
        result = await self.db.execute(select(User).filter(User.id == user_id))
        user = result.scalars().first()
        if not user:
            raise HTTPException(status_code=status.HTTP_404_NOT_FOUND, detail="ĞŸĞ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ÑŒ Ğ½Ğµ Ğ½Ğ°Ğ¹Ğ´ĞµĞ½.")
        return user.balance

```



## `api\services\dashboard\activity_service.py`


```python

# api/services/dashboard/activity_service.py

from sqlalchemy.ext.asyncio import AsyncSession
from sqlalchemy import select, func, desc, literal_column, union_all
from datetime import datetime, timedelta
from typing import List

from api.models.rental import Rental
from api.models.user import User
from api.models.equipment import Equipment
from shared.schemas.dashboard_schema import ActivityFeedItem
from .base import BaseDashboardService


class ActivityService(BaseDashboardService):
    """Ğ¡ĞµÑ€Ğ²Ğ¸Ñ Ğ´Ğ»Ñ Ğ»ĞµĞ½Ñ‚Ñ‹ Ğ°ĞºÑ‚Ğ¸Ğ²Ğ½Ğ¾ÑÑ‚Ğ¸ Ğ¿Ğ°Ğ½ĞµĞ»Ğ¸ ÑƒĞ¿Ñ€Ğ°Ğ²Ğ»ĞµĞ½Ğ¸Ñ."""
    
    async def get_recent_activity(self) -> List[ActivityFeedItem]:
        """ĞŸĞ¾Ğ»ÑƒÑ‡Ğ°ĞµÑ‚ Ğ¿Ğ¾ÑĞ»ĞµĞ´Ğ½Ğ¸Ğµ ÑĞ¾Ğ±Ñ‹Ñ‚Ğ¸Ñ Ğ² ÑĞ¸ÑÑ‚ĞµĞ¼Ğµ."""
        seven_days_ago = datetime.now() - timedelta(days=7)

        # Ğ—Ğ°Ğ¿Ñ€Ğ¾Ñ 1: ĞĞ¾Ğ²Ñ‹Ğµ Ğ°Ñ€ĞµĞ½Ğ´Ñ‹
        new_rentals_q = (
            select(
                Rental.id,
                Rental.created_at.label("timestamp"),
                literal_column("'rental_started'").label("activity_type"),
                User.full_name.label("user_name"),
                func.string_agg(Equipment.name, ', ').label("equipment_name")
            )
            .join(User, Rental.user_id == User.id)
            .join(Rental.equipment)
            .where(Rental.created_at >= seven_days_ago)
            .group_by(Rental.id, User.full_name, Rental.created_at)
        )
        
        # Ğ—Ğ°Ğ¿Ñ€Ğ¾Ñ 2: ĞĞ¾Ğ²Ñ‹Ğµ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ğ¸
        new_users_q = (
            select(
                User.id,
                User.created_at.label("timestamp"),
                literal_column("'user_registered'").label("activity_type"),
                User.full_name.label("user_name"),
                literal_column("NULL").label("equipment_name")
            )
            .where(User.created_at >= seven_days_ago)
        )

        # ĞĞ±ÑŠĞµĞ´Ğ¸Ğ½ÑĞµĞ¼ Ğ·Ğ°Ğ¿Ñ€Ğ¾ÑÑ‹
        combined_query = union_all(new_rentals_q, new_users_q).order_by(desc("timestamp")).limit(10)
        
        result = await self.db.execute(combined_query)
        
        activities = []
        for row in result.mappings().all():
            description = ""
            if row.activity_type == 'rental_started':
                description = f"ĞĞ¾Ğ²Ğ°Ñ Ğ°Ñ€ĞµĞ½Ğ´Ğ° Ğ´Ğ»Ñ {row.user_name}"
            elif row.activity_type == 'user_registered':
                description = f"ĞĞ¾Ğ²Ñ‹Ğ¹ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ÑŒ: {row.user_name}"
            
            activities.append(ActivityFeedItem(
                id=row.id, 
                timestamp=row.timestamp, 
                activity_type=row.activity_type,
                description=description, 
                user_name=row.user_name, 
                equipment_name=row.equipment_name
            ))
        return activities

```



## `api\services\dashboard\base.py`


```python

# api/services/dashboard/base.py

from sqlalchemy.ext.asyncio import AsyncSession
from datetime import datetime, date
from typing import List

from api.models.rental import Rental
from api.models.reservation import Reservation
from shared.schemas.dashboard_schema import TodayFocusItem


class BaseDashboardService:
    """Ğ‘Ğ°Ğ·Ğ¾Ğ²Ñ‹Ğ¹ ĞºĞ»Ğ°ÑÑ Ğ´Ğ»Ñ ÑĞµÑ€Ğ²Ğ¸ÑĞ¾Ğ² Ğ¿Ğ°Ğ½ĞµĞ»Ğ¸ ÑƒĞ¿Ñ€Ğ°Ğ²Ğ»ĞµĞ½Ğ¸Ñ Ñ Ğ¾Ğ±Ñ‰Ğ¸Ğ¼Ğ¸ Ğ¼ĞµÑ‚Ğ¾Ğ´Ğ°Ğ¼Ğ¸."""
    
    def __init__(self, db: AsyncSession):
        self.db = db

    def _create_today_focus_item_from_reservation(self, reservation: Reservation, start_date: date = None) -> TodayFocusItem:
        """Ğ¡Ğ¾Ğ·Ğ´Ğ°ĞµÑ‚ TodayFocusItem Ğ¸Ğ· Ñ€ĞµĞ·ĞµÑ€Ğ²Ğ°Ñ†Ğ¸Ğ¸."""
        return TodayFocusItem(
            id=reservation.id,
            user_name=reservation.user.full_name,
            details=f"{len(reservation.equipment)} Ğ¿Ğ¾Ğ·Ğ¸Ñ†Ğ¸Ğ¹",
            user_id=reservation.user_id,
            order_type='reservation',
            scheduled_time=datetime.combine(reservation.start_date, datetime.min.time()),
            start_date=start_date or reservation.start_date
        )

    def _create_today_focus_item_from_rental(
        self, 
        rental: Rental, 
        details: str, 
        due_date: date = None, 
        days_overdue: int = None
    ) -> TodayFocusItem:
        """Ğ¡Ğ¾Ğ·Ğ´Ğ°ĞµÑ‚ TodayFocusItem Ğ¸Ğ· Ğ°Ñ€ĞµĞ½Ğ´Ñ‹."""
        return TodayFocusItem(
            id=rental.id,
            user_name=rental.user.full_name,
            details=details,
            user_id=rental.user_id,
            order_type='rental',
            scheduled_time=datetime.combine(rental.end_date, datetime.min.time()),
            due_date=due_date,
            days_overdue=days_overdue
        )

```



## `api\services\dashboard\dashboard_service.py`


```python

# api/services/dashboard/dashboard_service.py

from sqlalchemy.ext.asyncio import AsyncSession
import asyncio
import logging

from shared.schemas.dashboard_schema import DashboardSummaryResponse
from .focus_service import FocusService
from .kpi_service import KpiService
from .activity_service import ActivityService
from .equipment_service import EquipmentService

logger = logging.getLogger(__name__)


class DashboardService:
    """ĞÑĞ½Ğ¾Ğ²Ğ½Ğ¾Ğ¹ ÑĞµÑ€Ğ²Ğ¸Ñ Ğ´Ğ»Ñ ÑĞ±Ğ¾Ñ€Ğ° Ğ°Ğ³Ñ€ĞµĞ³Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ½Ñ‹Ñ… Ğ´Ğ°Ğ½Ğ½Ñ‹Ñ… Ğ´Ğ»Ñ Ğ¿Ğ°Ğ½ĞµĞ»Ğ¸ ÑƒĞ¿Ñ€Ğ°Ğ²Ğ»ĞµĞ½Ğ¸Ñ Ğ°Ğ´Ğ¼Ğ¸Ğ½ĞºĞ¸."""

    def __init__(self, db: AsyncSession):
        self.db = db
        # Ğ˜Ğ½Ğ¸Ñ†Ğ¸Ğ°Ğ»Ğ¸Ğ·Ğ¸Ñ€ÑƒĞµĞ¼ ÑĞ¿ĞµÑ†Ğ¸Ğ°Ğ»Ğ¸Ğ·Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ½Ñ‹Ğµ ÑĞµÑ€Ğ²Ğ¸ÑÑ‹
        self.focus_service = FocusService(db)
        self.kpi_service = KpiService(db)
        self.activity_service = ActivityService(db)
        self.equipment_service = EquipmentService(db)

    async def get_summary(self) -> DashboardSummaryResponse:
        """ĞŸĞ¾Ğ»ÑƒÑ‡Ğ°ĞµÑ‚ ÑĞ²Ğ¾Ğ´Ğ½ÑƒÑ Ğ¸Ğ½Ñ„Ğ¾Ñ€Ğ¼Ğ°Ñ†Ğ¸Ñ Ğ´Ğ»Ñ Ğ¿Ğ°Ğ½ĞµĞ»Ğ¸ ÑƒĞ¿Ñ€Ğ°Ğ²Ğ»ĞµĞ½Ğ¸Ñ."""
        try:
            # Ğ¡Ğ¾Ğ±Ğ¸Ñ€Ğ°ĞµĞ¼ Ğ²ÑĞµ Ğ´Ğ°Ğ½Ğ½Ñ‹Ğµ Ğ¿Ğ°Ñ€Ğ°Ğ»Ğ»ĞµĞ»ÑŒĞ½Ğ¾ Ğ´Ğ»Ñ Ğ¾Ğ¿Ñ‚Ğ¸Ğ¼Ğ¸Ğ·Ğ°Ñ†Ğ¸Ğ¸
            # Ğ“Ñ€ÑƒĞ¿Ğ¿Ğ¸Ñ€ÑƒĞµĞ¼ Ğ·Ğ°Ğ´Ğ°Ñ‡Ğ¸ Ğ¿Ğ¾ Ñ‚Ğ¸Ğ¿Ğ°Ğ¼ Ğ´Ğ»Ñ Ğ»ÑƒÑ‡ÑˆĞµĞ¹ Ğ¾Ñ€Ğ³Ğ°Ğ½Ğ¸Ğ·Ğ°Ñ†Ğ¸Ğ¸
            focus_tasks = [
                self.focus_service.get_pickups_today(),
                self.focus_service.get_returns_today(),
                self.focus_service.get_overdue_rentals()
            ]
            
            other_tasks = [
                self.activity_service.get_recent_activity(),
                self.equipment_service.get_popular_equipment()
            ]
            
            # Ğ’Ñ‹Ğ¿Ğ¾Ğ»Ğ½ÑĞµĞ¼ Ğ·Ğ°Ğ´Ğ°Ñ‡Ğ¸ Ğ¿Ğ°Ñ€Ğ°Ğ»Ğ»ĞµĞ»ÑŒĞ½Ğ¾
            focus_results = await asyncio.gather(*focus_tasks)
            kpi_data = await self.kpi_service.get_kpi_data()
            other_results = await asyncio.gather(*other_tasks)

            return DashboardSummaryResponse(
                pickups_today=focus_results[0],
                returns_today=focus_results[1],
                overdue_rentals=focus_results[2],
                kpi=kpi_data,
                recent_activity=other_results[0],
                popular_equipment=other_results[1]
            )
        except Exception as e:
            logger.error(f"ĞÑˆĞ¸Ğ±ĞºĞ° Ğ¿Ñ€Ğ¸ Ğ¿Ğ¾Ğ»ÑƒÑ‡ĞµĞ½Ğ¸Ğ¸ ÑĞ²Ğ¾Ğ´Ğ½Ğ¾Ğ¹ Ğ¸Ğ½Ñ„Ğ¾Ñ€Ğ¼Ğ°Ñ†Ğ¸Ğ¸: {e}", exc_info=True)
            raise

```



## `api\services\dashboard\equipment_service.py`


```python

# api/services/dashboard/equipment_service.py

from sqlalchemy.ext.asyncio import AsyncSession
from sqlalchemy import select, func, desc
from datetime import date, timedelta
from typing import List
import logging

from api.models.rental import Rental
from api.models.equipment import Equipment
from shared.schemas.dashboard_schema import PopularEquipmentItem
from .base import BaseDashboardService

logger = logging.getLogger(__name__)


class EquipmentService(BaseDashboardService):
    """Ğ¡ĞµÑ€Ğ²Ğ¸Ñ Ğ´Ğ»Ñ Ñ€Ğ°Ğ±Ğ¾Ñ‚Ñ‹ Ñ Ğ¿Ğ¾Ğ¿ÑƒĞ»ÑÑ€Ğ½Ñ‹Ğ¼ Ğ¾Ğ±Ğ¾Ñ€ÑƒĞ´Ğ¾Ğ²Ğ°Ğ½Ğ¸ĞµĞ¼ Ğ¿Ğ°Ğ½ĞµĞ»Ğ¸ ÑƒĞ¿Ñ€Ğ°Ğ²Ğ»ĞµĞ½Ğ¸Ñ."""
    
    async def get_popular_equipment(self) -> List[PopularEquipmentItem]:
        """ĞŸĞ¾Ğ»ÑƒÑ‡Ğ°ĞµÑ‚ Ñ‚Ğ¾Ğ¿-10 ÑĞ°Ğ¼Ğ¾Ğ³Ğ¾ Ğ¿Ğ¾Ğ¿ÑƒĞ»ÑÑ€Ğ½Ğ¾Ğ³Ğ¾ Ğ¾Ğ±Ğ¾Ñ€ÑƒĞ´Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ Ñ Ğ²Ñ‹Ñ€ÑƒÑ‡ĞºĞ¾Ğ¹."""
        try:
            thirty_days_ago = date.today() - timedelta(days=30)
            query = (
                select(
                    Equipment.id.label("equipment_id"),
                    Equipment.name.label("equipment_name"),
                    func.count(Rental.id).label("rental_count"),
                    func.sum(Rental.total_cost).label("revenue")
                )
                .join(Rental.equipment)
                .where(Rental.created_at >= thirty_days_ago)
                .group_by(Equipment.id, Equipment.name)
                .order_by(desc("rental_count"))
                .limit(10)
            )
            result = await self.db.execute(query)
            return [PopularEquipmentItem.model_validate(row) for row in result.mappings().all()]
            
        except Exception as e:
            logger.error(f"ĞÑˆĞ¸Ğ±ĞºĞ° Ğ¿Ñ€Ğ¸ Ğ¿Ğ¾Ğ»ÑƒÑ‡ĞµĞ½Ğ¸Ğ¸ Ğ¿Ğ¾Ğ¿ÑƒĞ»ÑÑ€Ğ½Ğ¾Ğ³Ğ¾ Ğ¾Ğ±Ğ¾Ñ€ÑƒĞ´Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ: {e}", exc_info=True)
            # Ğ’Ğ¾Ğ·Ğ²Ñ€Ğ°Ñ‰Ğ°ĞµĞ¼ Ğ¿ÑƒÑÑ‚Ğ¾Ğ¹ ÑĞ¿Ğ¸ÑĞ¾Ğº Ğ² ÑĞ»ÑƒÑ‡Ğ°Ğµ Ğ¾ÑˆĞ¸Ğ±ĞºĞ¸
            return []

```



## `api\services\dashboard\focus_service.py`


```python


# api/services/dashboard/focus_service.py

from sqlalchemy.ext.asyncio import AsyncSession
from sqlalchemy.orm import joinedload, selectinload
from sqlalchemy import select, and_
from datetime import date
from typing import List

from api.models.rental import Rental
from api.models.reservation import Reservation
from shared.schemas.dashboard_schema import TodayFocusItem
from .base import BaseDashboardService


class FocusService(BaseDashboardService):
    """Ğ¡ĞµÑ€Ğ²Ğ¸Ñ Ğ´Ğ»Ñ Ğ²Ğ¸Ğ´Ğ¶ĞµÑ‚Ğ° 'Ğ¡ĞµĞ³Ğ¾Ğ´Ğ½Ñ Ğ² Ñ„Ğ¾ĞºÑƒÑĞµ' - Ğ²Ñ‹Ğ´Ğ°Ñ‡Ğ¸, Ğ²Ğ¾Ğ·Ğ²Ñ€Ğ°Ñ‚Ñ‹, Ğ¿Ñ€Ğ¾ÑÑ€Ğ¾Ñ‡ĞºĞ¸."""
    
    async def get_pickups_today(self) -> List[TodayFocusItem]:
        """ĞŸĞ¾Ğ»ÑƒÑ‡Ğ°ĞµÑ‚ Ğ°ĞºÑ‚Ğ¸Ğ²Ğ½Ñ‹Ğµ Ñ€ĞµĞ·ĞµÑ€Ğ²Ğ°Ñ†Ğ¸Ğ¸ Ğ´Ğ»Ñ Ğ²Ñ‹Ğ´Ğ°Ñ‡Ğ¸ (Ğ½Ğµ Ğ¿Ñ€Ğ¾ÑÑ€Ğ¾Ñ‡ĞµĞ½Ğ½Ñ‹Ğµ Ğ¸ Ğ½Ğµ Ğ²Ñ‹Ğ´Ğ°Ğ½Ğ½Ñ‹Ğµ)."""
        today = date.today()
        
        query = select(Reservation).options(
            joinedload(Reservation.user),
            selectinload(Reservation.equipment)
        ).filter(
            and_(
                Reservation.start_date <= today,
                Reservation.end_date >= today,
                Reservation.status == 'active'
            )
        )

        result = await self.db.execute(query)
        reservations = result.unique().scalars().all()

        return [self._create_today_focus_item_from_reservation(reservation, reservation.start_date) for reservation in reservations]

    async def get_returns_today(self) -> List[TodayFocusItem]:
        """ĞŸĞ¾Ğ»ÑƒÑ‡Ğ°ĞµÑ‚ Ğ°Ñ€ĞµĞ½Ğ´Ñ‹ Ğ½Ğ° ÑĞµĞ³Ğ¾Ğ´Ğ½Ñ Ğ´Ğ»Ñ Ğ²Ğ¾Ğ·Ğ²Ñ€Ğ°Ñ‚Ğ°."""
        today = date.today()
        
        query = select(Rental).options(
            joinedload(Rental.user),
            selectinload(Rental.equipment)
        ).filter(
            and_(
                Rental.end_date == today,
                Rental.status == 'active'
            )
        )

        result = await self.db.execute(query)
        rentals = result.unique().scalars().all()

        return [
            self._create_today_focus_item_from_rental(
                rental, 
                f"ĞÑÑ‚Ğ°Ñ‚Ğ¾Ğº: {rental.total_cost - rental.prepayment_amount:.0f} â‚½"
            ) 
            for rental in rentals
        ]

    async def get_overdue_rentals(self) -> List[TodayFocusItem]:
        """ĞŸĞ¾Ğ»ÑƒÑ‡Ğ°ĞµÑ‚ Ğ¿Ñ€Ğ¾ÑÑ€Ğ¾Ñ‡ĞµĞ½Ğ½Ñ‹Ğµ Ğ°Ñ€ĞµĞ½Ğ´Ñ‹."""
        today = date.today()
        
        query = select(Rental).options(
            joinedload(Rental.user),
            selectinload(Rental.equipment)
        ).filter(
            and_(
                Rental.end_date < today,
                Rental.status == 'active'
            )
        )

        result = await self.db.execute(query)
        rentals = result.unique().scalars().all()

        result_items = []
        for rental in rentals:
            days_overdue = (today - rental.end_date).days
            remaining_amount = rental.total_cost - rental.prepayment_amount
            
            item = self._create_today_focus_item_from_rental(
                rental,
                f"{len(rental.equipment)} Ğ¿Ğ¾Ğ·., Ğ¾ÑÑ‚Ğ°Ñ‚Ğ¾Ğº: {remaining_amount:.0f} â‚½",
                due_date=rental.end_date,
                days_overdue=days_overdue
            )
            result_items.append(item)
        
        return result_items

```



## `api\services\dashboard\kpi_service.py`


```python

# api/services/dashboard/kpi_service.py

from sqlalchemy.ext.asyncio import AsyncSession
from sqlalchemy.orm import joinedload, selectinload
from sqlalchemy import select, func, and_
from datetime import date, timedelta
import asyncio

from api.models.rental import Rental, rental_equipment_association
from api.models.reservation import Reservation, reservation_equipment_association
from api.models.user import User
from api.models.equipment import Equipment
from shared.schemas.dashboard_schema import KpiData
from .base import BaseDashboardService


class KpiService(BaseDashboardService):
    """Ğ¡ĞµÑ€Ğ²Ğ¸Ñ Ğ´Ğ»Ñ Ñ€Ğ°ÑÑ‡ĞµÑ‚Ğ° KPI Ğ¼ĞµÑ‚Ñ€Ğ¸Ğº Ğ¿Ğ°Ğ½ĞµĞ»Ğ¸ ÑƒĞ¿Ñ€Ğ°Ğ²Ğ»ĞµĞ½Ğ¸Ñ."""
    
    async def get_total_users(self) -> int:
        """ĞŸĞ¾Ğ»ÑƒÑ‡Ğ°ĞµÑ‚ Ğ¾Ğ±Ñ‰ĞµĞµ ĞºĞ¾Ğ»Ğ¸Ñ‡ĞµÑÑ‚Ğ²Ğ¾ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ĞµĞ¹."""
        query = select(func.count(User.id))
        result = await self.db.execute(query)
        return int(result.scalar_one())

    async def get_active_users(self) -> int:
        """ĞŸĞ¾Ğ»ÑƒÑ‡Ğ°ĞµÑ‚ ĞºĞ¾Ğ»Ğ¸Ñ‡ĞµÑÑ‚Ğ²Ğ¾ Ğ°ĞºÑ‚Ğ¸Ğ²Ğ½Ñ‹Ñ… Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ĞµĞ¹ (Ñ Ñ€ĞµĞ·ĞµÑ€Ğ²Ğ°Ñ†Ğ¸ÑĞ¼Ğ¸ Ğ¸Ğ»Ğ¸ Ğ°Ñ€ĞµĞ½Ğ´Ğ°Ğ¼Ğ¸ Ğ·Ğ° Ğ¿Ğ¾ÑĞ»ĞµĞ´Ğ½Ğ¸Ğµ 30 Ğ´Ğ½ĞµĞ¹)."""
        thirty_days_ago = date.today() - timedelta(days=30)
        
        # ĞŸĞ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ğ¸ Ñ Ğ°ĞºÑ‚Ğ¸Ğ²Ğ½Ñ‹Ğ¼Ğ¸ Ñ€ĞµĞ·ĞµÑ€Ğ²Ğ°Ñ†Ğ¸ÑĞ¼Ğ¸
        active_reservations_query = select(User.id).join(
            Reservation, User.id == Reservation.user_id
        ).filter(
            and_(
                Reservation.created_at >= thirty_days_ago,
                Reservation.status.in_(['active', 'completed'])
            )
        )
        
        # ĞŸĞ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ğ¸ Ñ Ğ°ĞºÑ‚Ğ¸Ğ²Ğ½Ñ‹Ğ¼Ğ¸ Ğ°Ñ€ĞµĞ½Ğ´Ğ°Ğ¼Ğ¸
        active_rentals_query = select(User.id).join(
            Rental, User.id == Rental.user_id
        ).filter(
            and_(
                Rental.created_at >= thirty_days_ago,
                Rental.status.in_(['active', 'completed'])
            )
        )
        
        # ĞĞ±ÑŠĞµĞ´Ğ¸Ğ½ÑĞµĞ¼ Ñ€ĞµĞ·ÑƒĞ»ÑŒÑ‚Ğ°Ñ‚Ñ‹
        reservations_result = await self.db.execute(active_reservations_query)
        rentals_result = await self.db.execute(active_rentals_query)
        
        active_user_ids = set()
        for row in reservations_result:
            active_user_ids.add(row.id)
        for row in rentals_result:
            active_user_ids.add(row.id)
            
        return len(active_user_ids)

    async def get_total_equipment(self) -> int:
        """ĞŸĞ¾Ğ»ÑƒÑ‡Ğ°ĞµÑ‚ Ğ¾Ğ±Ñ‰ĞµĞµ ĞºĞ¾Ğ»Ğ¸Ñ‡ĞµÑÑ‚Ğ²Ğ¾ Ğ¾Ğ±Ğ¾Ñ€ÑƒĞ´Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ."""
        query = select(func.count(Equipment.id))
        result = await self.db.execute(query)
        return int(result.scalar_one())

    async def get_total_reservations(self) -> int:
        """ĞŸĞ¾Ğ»ÑƒÑ‡Ğ°ĞµÑ‚ Ğ¾Ğ±Ñ‰ĞµĞµ ĞºĞ¾Ğ»Ğ¸Ñ‡ĞµÑÑ‚Ğ²Ğ¾ Ñ€ĞµĞ·ĞµÑ€Ğ²Ğ°Ñ†Ğ¸Ğ¹."""
        query = select(func.count(Reservation.id))
        result = await self.db.execute(query)
        return int(result.scalar_one())

    async def get_revenue_today(self) -> float:
        """ĞŸĞ¾Ğ»ÑƒÑ‡Ğ°ĞµÑ‚ Ğ´Ğ¾Ñ…Ğ¾Ğ´ Ğ·Ğ° ÑĞµĞ³Ğ¾Ğ´Ğ½Ñ."""
        today = date.today()
        
        query = select(func.coalesce(func.sum(Rental.final_cost), 0)).filter(
            and_(
                Rental.status == 'completed',
                func.date(Rental.actual_return_date) == today
            )
        )

        result = await self.db.execute(query)
        return float(result.scalar_one())

    async def get_revenue_this_month(self) -> float:
        """ĞŸĞ¾Ğ»ÑƒÑ‡Ğ°ĞµÑ‚ Ğ´Ğ¾Ñ…Ğ¾Ğ´ Ğ·Ğ° Ñ‚ĞµĞºÑƒÑ‰Ğ¸Ğ¹ Ğ¼ĞµÑÑÑ†."""
        today = date.today()
        first_day_of_month = today.replace(day=1)
        
        query = select(func.coalesce(func.sum(Rental.final_cost), 0)).filter(
            and_(
                Rental.status == 'completed',
                Rental.actual_return_date >= first_day_of_month,
                Rental.actual_return_date <= today
            )
        )

        result = await self.db.execute(query)
        return float(result.scalar_one())

    async def get_occupancy_rate(self) -> float:
        """Ğ Ğ°ÑÑÑ‡Ğ¸Ñ‚Ñ‹Ğ²Ğ°ĞµÑ‚ ĞºĞ¾ÑÑ„Ñ„Ğ¸Ñ†Ğ¸ĞµĞ½Ñ‚ Ğ·Ğ°Ğ³Ñ€ÑƒĞ¶ĞµĞ½Ğ½Ğ¾ÑÑ‚Ğ¸ Ğ¾Ğ±Ğ¾Ñ€ÑƒĞ´Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ."""
        today = date.today()
        
        # ĞŸĞ¾Ğ»ÑƒÑ‡Ğ°ĞµĞ¼ Ğ¾Ğ±Ñ‰ĞµĞµ ĞºĞ¾Ğ»Ğ¸Ñ‡ĞµÑÑ‚Ğ²Ğ¾ Ğ¾Ğ±Ğ¾Ñ€ÑƒĞ´Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ
        total_equipment_query = select(func.count(Equipment.id))
        total_result = await self.db.execute(total_equipment_query)
        total_equipment = total_result.scalar_one()

        if total_equipment == 0:
            return 0.0

        # ĞŸĞ¾Ğ»ÑƒÑ‡Ğ°ĞµĞ¼ ÑƒĞ½Ğ¸ĞºĞ°Ğ»ÑŒĞ½Ğ¾Ğµ Ğ¾Ğ±Ğ¾Ñ€ÑƒĞ´Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ Ğ¸Ğ· Ğ°ĞºÑ‚Ğ¸Ğ²Ğ½Ñ‹Ñ… Ñ€ĞµĞ·ĞµÑ€Ğ²Ğ°Ñ†Ğ¸Ğ¹
        active_reservations_query = select(reservation_equipment_association.c.equipment_id).join(
            Reservation, 
            reservation_equipment_association.c.reservation_id == Reservation.id
        ).filter(
            and_(
                Reservation.start_date <= today,
                Reservation.end_date >= today,
                Reservation.status == 'active'
            )
        )
        
        reservations_result = await self.db.execute(active_reservations_query)
        reservation_equipment_ids = set(row.equipment_id for row in reservations_result)
        
        # ĞŸĞ¾Ğ»ÑƒÑ‡Ğ°ĞµĞ¼ ÑƒĞ½Ğ¸ĞºĞ°Ğ»ÑŒĞ½Ğ¾Ğµ Ğ¾Ğ±Ğ¾Ñ€ÑƒĞ´Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ Ğ¸Ğ· Ğ°ĞºÑ‚Ğ¸Ğ²Ğ½Ñ‹Ñ… Ğ°Ñ€ĞµĞ½Ğ´
        active_rentals_query = select(rental_equipment_association.c.equipment_id).join(
            Rental,
            rental_equipment_association.c.rental_id == Rental.id
        ).filter(
            and_(
                Rental.start_date <= today,
                Rental.end_date >= today,
                Rental.status == 'active'
            )
        )
        
        rentals_result = await self.db.execute(active_rentals_query)
        rental_equipment_ids = set(row.equipment_id for row in rentals_result)
        
        # ĞĞ±ÑŠĞµĞ´Ğ¸Ğ½ÑĞµĞ¼ Ğ¸ ÑÑ‡Ğ¸Ñ‚Ğ°ĞµĞ¼ ÑƒĞ½Ğ¸ĞºĞ°Ğ»ÑŒĞ½Ğ¾Ğµ Ğ¾Ğ±Ğ¾Ñ€ÑƒĞ´Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ
        unique_equipment_ids = reservation_equipment_ids.union(rental_equipment_ids)
        unique_equipment = len(unique_equipment_ids)

        return (unique_equipment / total_equipment) * 100

    async def get_avg_rental_duration(self) -> float:
        """Ğ Ğ°ÑÑÑ‡Ğ¸Ñ‚Ñ‹Ğ²Ğ°ĞµÑ‚ ÑÑ€ĞµĞ´Ğ½ÑÑ Ğ¿Ñ€Ğ¾Ğ´Ğ¾Ğ»Ğ¶Ğ¸Ñ‚ĞµĞ»ÑŒĞ½Ğ¾ÑÑ‚ÑŒ Ğ°Ñ€ĞµĞ½Ğ´Ñ‹ Ğ² Ğ´Ğ½ÑÑ…."""
        # Ğ”Ğ»Ñ PostgreSQL Ğ¸ÑĞ¿Ğ¾Ğ»ÑŒĞ·ÑƒĞµĞ¼ Ğ¿Ñ€Ğ¾ÑÑ‚Ğ¾Ğµ Ğ²Ñ‹Ñ‡Ğ¸Ñ‚Ğ°Ğ½Ğ¸Ğµ Ğ´Ğ°Ñ‚ Ñ‚Ğ¸Ğ¿Ğ° DATE
        # Ğ­Ñ‚Ğ¾ Ğ°Ğ²Ñ‚Ğ¾Ğ¼Ğ°Ñ‚Ğ¸Ñ‡ĞµÑĞºĞ¸ Ğ²Ğ¾Ğ·Ğ²Ñ€Ğ°Ñ‰Ğ°ĞµÑ‚ ĞºĞ¾Ğ»Ğ¸Ñ‡ĞµÑÑ‚Ğ²Ğ¾ Ğ´Ğ½ĞµĞ¹ ĞºĞ°Ğº integer
        query = select(func.avg(
            Rental.actual_return_date - Rental.start_date
        )).filter(
            and_(
                Rental.status == 'completed',
                Rental.actual_return_date.isnot(None)
            )
        )

        result = await self.db.execute(query)
        avg_duration = result.scalar_one()
        return float(avg_duration) if avg_duration is not None else 0.0

    async def get_kpi_data(self) -> KpiData:
        """ĞŸĞ¾Ğ»ÑƒÑ‡Ğ°ĞµÑ‚ Ğ²ÑĞµ KPI Ğ´Ğ°Ğ½Ğ½Ñ‹Ğµ Ğ¿Ğ°Ñ€Ğ°Ğ»Ğ»ĞµĞ»ÑŒĞ½Ğ¾."""
        # Ğ’Ñ‹Ğ¿Ğ¾Ğ»Ğ½ÑĞµĞ¼ Ğ²ÑĞµ KPI Ğ·Ğ°Ğ¿Ñ€Ğ¾ÑÑ‹ Ğ¿Ğ°Ñ€Ğ°Ğ»Ğ»ĞµĞ»ÑŒĞ½Ğ¾
        results = await asyncio.gather(
            self.get_total_users(),
            self.get_active_users(),
            self.get_total_equipment(),
            self.get_total_reservations(),
            self.get_revenue_today(),
            self.get_revenue_this_month(),
            self.get_occupancy_rate(),
            self.get_avg_rental_duration()
        )
        
        return KpiData(
            total_users=results[0],
            active_users=results[1],
            total_equipment=results[2],
            total_reservations=results[3],
            revenue_today=results[4],
            revenue_this_month=results[5],
            occupancy_rate=results[6],
            avg_rental_duration=results[7]
        )

```



## `api\services\dashboard_service.py`


```python

# api/services/dashboard_service.py

# Ğ˜Ğ¼Ğ¿Ğ¾Ñ€Ñ‚Ğ¸Ñ€ÑƒĞµĞ¼ Ğ½Ğ¾Ğ²Ñ‹Ğ¹ Ñ€ĞµÑ„Ğ°ĞºÑ‚Ğ¾Ñ€ĞµĞ½Ğ½Ñ‹Ğ¹ ÑĞµÑ€Ğ²Ğ¸Ñ
from .dashboard.dashboard_service import DashboardService

```



## `api\services\discount_service.py`


```python

# api/services/discount_service.py

from sqlalchemy.ext.asyncio import AsyncSession
from sqlalchemy import desc, select
from api.models.discount import DurationDiscount

async def get_duration_discount_percentage(db: AsyncSession, days: int) -> int:
    """
    ĞŸĞ¾Ğ»ÑƒÑ‡Ğ°ĞµÑ‚ Ğ¿Ñ€Ğ¾Ñ†ĞµĞ½Ñ‚ ÑĞºĞ¸Ğ´ĞºĞ¸ Ğ·Ğ° Ğ´Ğ»Ğ¸Ñ‚ĞµĞ»ÑŒĞ½Ğ¾ÑÑ‚ÑŒ Ğ°Ñ€ĞµĞ½Ğ´Ñ‹ Ğ¸Ğ· Ğ±Ğ°Ğ·Ñ‹ Ğ´Ğ°Ğ½Ğ½Ñ‹Ñ….
    ĞĞ°Ñ…Ğ¾Ğ´Ğ¸Ñ‚ Ğ½Ğ°Ğ¸Ğ±Ğ¾Ğ»ĞµĞµ Ğ¿Ğ¾Ğ´Ñ…Ğ¾Ğ´ÑÑ‰ÑƒÑ ÑĞºĞ¸Ğ´ĞºÑƒ Ğ´Ğ»Ñ Ğ·Ğ°Ğ´Ğ°Ğ½Ğ½Ğ¾Ğ³Ğ¾ ĞºĞ¾Ğ»Ğ¸Ñ‡ĞµÑÑ‚Ğ²Ğ° Ğ´Ğ½ĞµĞ¹.
    """
    if days <= 0:
        return 0

    # Ğ˜Ñ‰ĞµĞ¼ Ğ½Ğ°Ğ¸Ğ±Ğ¾Ğ»ĞµĞµ Ğ¿Ğ¾Ğ´Ñ…Ğ¾Ğ´ÑÑ‰ÑƒÑ Ğ·Ğ°Ğ¿Ğ¸ÑÑŒ Ğ¾ ÑĞºĞ¸Ğ´ĞºĞµ,
    # Ğ³Ğ´Ğµ min_days Ğ½Ğµ Ğ¿Ñ€ĞµĞ²Ñ‹ÑˆĞ°ĞµÑ‚ ĞºĞ¾Ğ»Ğ¸Ñ‡ĞµÑÑ‚Ğ²Ğ¾ Ğ´Ğ½ĞµĞ¹ Ğ°Ñ€ĞµĞ½Ğ´Ñ‹.
    # Ğ¡Ğ¾Ñ€Ñ‚Ğ¸Ñ€ÑƒĞµĞ¼ Ğ¿Ğ¾ ÑƒĞ±Ñ‹Ğ²Ğ°Ğ½Ğ¸Ñ, Ñ‡Ñ‚Ğ¾Ğ±Ñ‹ Ğ¿ĞµÑ€Ğ²Ğ¾Ğ¹ Ğ½Ğ°Ğ¹Ñ‚Ğ¸ ÑĞ°Ğ¼ÑƒÑ Ğ±Ğ¾Ğ»ÑŒÑˆÑƒÑ Ğ¿Ğ¾Ğ´Ñ…Ğ¾Ğ´ÑÑ‰ÑƒÑ ÑĞºĞ¸Ğ´ĞºÑƒ.
    result = await db.execute(
        select(DurationDiscount)
        .filter(DurationDiscount.min_days <= days)
        .order_by(desc(DurationDiscount.min_days))
    )
    discount = result.scalars().first()

    if discount:
        return discount.discount_percentage

    return 0

```



## `api\services\equipment_query_builder.py`


```python

# api/services/equipment_query_builder.py

from typing import Optional, List
from sqlalchemy.ext.asyncio import AsyncSession
from sqlalchemy.orm import selectinload
from sqlalchemy import or_, and_, select, func
from datetime import date

from api.models.equipment import Equipment
from api.models.association import Association


class EquipmentQueryBuilder:
    """
    ĞšĞ»Ğ°ÑÑ Ğ´Ğ»Ñ Ğ¿Ğ¾ÑÑ‚Ñ€Ğ¾ĞµĞ½Ğ¸Ñ Ğ·Ğ°Ğ¿Ñ€Ğ¾ÑĞ¾Ğ² Ğº Ğ¾Ğ±Ğ¾Ñ€ÑƒĞ´Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ Ñ Ğ¿Ğ¾Ğ´Ğ´ĞµÑ€Ğ¶ĞºĞ¾Ğ¹ Ñ€Ğ°Ğ·Ğ»Ğ¸Ñ‡Ğ½Ñ‹Ñ… Ñ„Ğ¸Ğ»ÑŒÑ‚Ñ€Ğ¾Ğ².
    Ğ ĞµĞ°Ğ»Ğ¸Ğ·ÑƒĞµÑ‚ Ğ¿Ğ°Ñ‚Ñ‚ĞµÑ€Ğ½ Builder Ğ´Ğ»Ñ ÑĞ¾Ğ·Ğ´Ğ°Ğ½Ğ¸Ñ ÑĞ»Ğ¾Ğ¶Ğ½Ñ‹Ñ… SQL-Ğ·Ğ°Ğ¿Ñ€Ğ¾ÑĞ¾Ğ².
    """

    def __init__(self, db_session: AsyncSession):
        """
        Ğ˜Ğ½Ğ¸Ñ†Ğ¸Ğ°Ğ»Ğ¸Ğ·Ğ°Ñ†Ğ¸Ñ Ğ±Ğ¸Ğ»Ğ´ĞµÑ€Ğ° Ğ·Ğ°Ğ¿Ñ€Ğ¾ÑĞ¾Ğ².

        Args:
            db_session: Ğ¡ĞµÑÑĞ¸Ñ SQLAlchemy Ğ´Ğ»Ñ Ğ²Ñ‹Ğ¿Ğ¾Ğ»Ğ½ĞµĞ½Ğ¸Ñ Ğ·Ğ°Ğ¿Ñ€Ğ¾ÑĞ¾Ğ²
        """
        self.db_session = db_session
        # Ğ¡Ğ¾Ğ·Ğ´Ğ°ĞµĞ¼ Ğ±Ğ°Ğ·Ğ¾Ğ²Ñ‹Ğ¹ Ğ·Ğ°Ğ¿Ñ€Ğ¾Ñ Ğ¾Ğ´Ğ¸Ğ½ Ñ€Ğ°Ğ· Ğ¿Ñ€Ğ¸ Ğ¸Ğ½Ğ¸Ñ†Ğ¸Ğ°Ğ»Ğ¸Ğ·Ğ°Ñ†Ğ¸Ğ¸
        self.query = self._get_base_query()

    def _get_base_query(self):
        """
        Ğ’Ğ¾Ğ·Ğ²Ñ€Ğ°Ñ‰Ğ°ĞµÑ‚ Ğ±Ğ°Ğ·Ğ¾Ğ²Ñ‹Ğ¹ Ğ·Ğ°Ğ¿Ñ€Ğ¾Ñ Ñ Ğ½ĞµĞ¾Ğ±Ñ…Ğ¾Ğ´Ğ¸Ğ¼Ñ‹Ğ¼Ğ¸ options Ğ´Ğ»Ñ Ğ·Ğ°Ğ³Ñ€ÑƒĞ·ĞºĞ¸ ÑĞ²ÑĞ·Ğ°Ğ½Ğ½Ñ‹Ñ… Ğ´Ğ°Ğ½Ğ½Ñ‹Ñ….

        Returns:
            Ğ‘Ğ°Ğ·Ğ¾Ğ²Ñ‹Ğ¹ select Ğ·Ğ°Ğ¿Ñ€Ğ¾Ñ Ğ´Ğ»Ñ Equipment
        """
        return select(Equipment).options(
            selectinload(Equipment.accessories),
            selectinload(Equipment.associations)
        )

    def apply_search(self, query_str: str):
        """
        ĞŸÑ€Ğ¸Ğ¼ĞµĞ½ÑĞµÑ‚ Ñ‚ĞµĞºÑÑ‚Ğ¾Ğ²Ñ‹Ğ¹ Ğ¿Ğ¾Ğ¸ÑĞº Ğ¿Ğ¾ Ğ½Ğ°Ğ·Ğ²Ğ°Ğ½Ğ¸Ñ, Ğ±Ñ€ĞµĞ½Ğ´Ñƒ Ğ¸ Ñ‚Ğ¸Ğ¿Ñƒ Ğ¾Ğ±Ğ¾Ñ€ÑƒĞ´Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ.

        Args:
            query_str: Ğ¡Ñ‚Ñ€Ğ¾ĞºĞ° Ğ¿Ğ¾Ğ¸ÑĞºĞ°

        Returns:
            self Ğ´Ğ»Ñ Ğ¿Ğ¾Ğ´Ğ´ĞµÑ€Ğ¶ĞºĞ¸ Ñ†ĞµĞ¿Ğ¾Ñ‡ĞºĞ¸ Ğ²Ñ‹Ğ·Ğ¾Ğ²Ğ¾Ğ²
        """
        if query_str:
            search_term = f"%{query_str.lower()}%"
            self.query = self.query.filter(
                or_(
                    Equipment.name.ilike(search_term),
                    Equipment.brand.ilike(search_term),
                    Equipment.equipment_type.ilike(search_term)
                )
            )
        return self

    def apply_type(self, equipment_type: str):
        """
        ĞŸÑ€Ğ¸Ğ¼ĞµĞ½ÑĞµÑ‚ Ñ„Ğ¸Ğ»ÑŒÑ‚Ñ€ Ğ¿Ğ¾ Ñ‚Ğ¸Ğ¿Ñƒ Ğ¾Ğ±Ğ¾Ñ€ÑƒĞ´Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ.

        Args:
            equipment_type: Ğ¢Ğ¸Ğ¿ Ğ¾Ğ±Ğ¾Ñ€ÑƒĞ´Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ Ğ´Ğ»Ñ Ñ„Ğ¸Ğ»ÑŒÑ‚Ñ€Ğ°Ñ†Ğ¸Ğ¸

        Returns:
            self Ğ´Ğ»Ñ Ğ¿Ğ¾Ğ´Ğ´ĞµÑ€Ğ¶ĞºĞ¸ Ñ†ĞµĞ¿Ğ¾Ñ‡ĞºĞ¸ Ğ²Ñ‹Ğ·Ğ¾Ğ²Ğ¾Ğ²
        """
        if equipment_type:
            self.query = self.query.filter(Equipment.equipment_type == equipment_type)
        return self

    def apply_brand(self, brand: str):
        """
        ĞŸÑ€Ğ¸Ğ¼ĞµĞ½ÑĞµÑ‚ Ñ„Ğ¸Ğ»ÑŒÑ‚Ñ€ Ğ¿Ğ¾ Ğ±Ñ€ĞµĞ½Ğ´Ñƒ Ğ¾Ğ±Ğ¾Ñ€ÑƒĞ´Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ.

        Args:
            brand: Ğ‘Ñ€ĞµĞ½Ğ´ Ğ¾Ğ±Ğ¾Ñ€ÑƒĞ´Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ Ğ´Ğ»Ñ Ñ„Ğ¸Ğ»ÑŒÑ‚Ñ€Ğ°Ñ†Ğ¸Ğ¸

        Returns:
            self Ğ´Ğ»Ñ Ğ¿Ğ¾Ğ´Ğ´ĞµÑ€Ğ¶ĞºĞ¸ Ñ†ĞµĞ¿Ğ¾Ñ‡ĞºĞ¸ Ğ²Ñ‹Ğ·Ğ¾Ğ²Ğ¾Ğ²
        """
        if brand and brand != "__all__":
            self.query = self.query.filter(Equipment.brand == brand)
        return self

    def apply_association(self, association_id: int):
        """
        ĞŸÑ€Ğ¸Ğ¼ĞµĞ½ÑĞµÑ‚ Ñ„Ğ¸Ğ»ÑŒÑ‚Ñ€ Ğ¿Ğ¾ Ğ°ÑÑĞ¾Ñ†Ğ¸Ğ°Ñ†Ğ¸Ğ¸.

        Args:
            association_id: ID Ğ°ÑÑĞ¾Ñ†Ğ¸Ğ°Ñ†Ğ¸Ğ¸ Ğ´Ğ»Ñ Ñ„Ğ¸Ğ»ÑŒÑ‚Ñ€Ğ°Ñ†Ğ¸Ğ¸

        Returns:
            self Ğ´Ğ»Ñ Ğ¿Ğ¾Ğ´Ğ´ĞµÑ€Ğ¶ĞºĞ¸ Ñ†ĞµĞ¿Ğ¾Ñ‡ĞºĞ¸ Ğ²Ñ‹Ğ·Ğ¾Ğ²Ğ¾Ğ²
        """
        if association_id:
            self.query = self.query.join(Equipment.associations).filter(Association.id == association_id)
        return self

    def apply_availability(self, start_date: date, end_date: date, exclude_reservation_id: int | None = None, exclude_rental_id: int | None = None):
        """
        ĞŸÑ€Ğ¸Ğ¼ĞµĞ½ÑĞµÑ‚ Ñ„Ğ¸Ğ»ÑŒÑ‚Ñ€ Ğ¿Ğ¾ Ğ´Ğ¾ÑÑ‚ÑƒĞ¿Ğ½Ğ¾ÑÑ‚Ğ¸ Ğ¾Ğ±Ğ¾Ñ€ÑƒĞ´Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ Ğ² ÑƒĞºĞ°Ğ·Ğ°Ğ½Ğ½Ñ‹Ğ¹ Ğ¿ĞµÑ€Ğ¸Ğ¾Ğ´.
        Ğ˜ÑĞ¿Ğ¾Ğ»ÑŒĞ·ÑƒĞµÑ‚ AvailabilityService Ğ´Ğ»Ñ Ğ¿Ğ¾Ğ»ÑƒÑ‡ĞµĞ½Ğ¸Ñ SQLAlchemy Ñ„Ğ¸Ğ»ÑŒÑ‚Ñ€Ğ°.

        Args:
            start_date: Ğ”Ğ°Ñ‚Ğ° Ğ½Ğ°Ñ‡Ğ°Ğ»Ğ° Ğ¿ĞµÑ€Ğ¸Ğ¾Ğ´Ğ°
            end_date: Ğ”Ğ°Ñ‚Ğ° Ğ¾ĞºĞ¾Ğ½Ñ‡Ğ°Ğ½Ğ¸Ñ Ğ¿ĞµÑ€Ğ¸Ğ¾Ğ´Ğ°
            exclude_reservation_id: ID Ñ€ĞµĞ·ĞµÑ€Ğ²Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ Ğ´Ğ»Ñ Ğ¸ÑĞºĞ»ÑÑ‡ĞµĞ½Ğ¸Ñ
            exclude_rental_id: ID Ğ°Ñ€ĞµĞ½Ğ´Ñ‹ Ğ´Ğ»Ñ Ğ¸ÑĞºĞ»ÑÑ‡ĞµĞ½Ğ¸Ñ

        Returns:
            self Ğ´Ğ»Ñ Ğ¿Ğ¾Ğ´Ğ´ĞµÑ€Ğ¶ĞºĞ¸ Ñ†ĞµĞ¿Ğ¾Ñ‡ĞºĞ¸ Ğ²Ñ‹Ğ·Ğ¾Ğ²Ğ¾Ğ²
        """
        if not start_date or not end_date:
            return self

        # Ğ˜ÑĞ¿Ğ¾Ğ»ÑŒĞ·ÑƒĞµĞ¼ AvailabilityService Ğ´Ğ»Ñ Ğ¿Ğ¾Ğ»ÑƒÑ‡ĞµĞ½Ğ¸Ñ Ñ„Ğ¸Ğ»ÑŒÑ‚Ñ€Ğ°
        from api.services.availability import AvailabilityService
        availability_service = AvailabilityService(self.db_session)
        
        availability_filter = availability_service.get_sqlalchemy_filter_for_available_equipment(
            start_date, end_date, exclude_reservation_id, exclude_rental_id
        )
        
        self.query = self.query.filter(availability_filter)
        return self

    async def count(self) -> int:
        """
        Ğ’Ñ‹Ğ¿Ğ¾Ğ»Ğ½ÑĞµÑ‚ Ğ¿Ğ¾Ğ´ÑÑ‡ĞµÑ‚ Ğ¾Ğ±Ñ‰ĞµĞ³Ğ¾ ĞºĞ¾Ğ»Ğ¸Ñ‡ĞµÑÑ‚Ğ²Ğ° Ğ·Ğ°Ğ¿Ğ¸ÑĞµĞ¹ Ğ¿Ğ¾ Ğ¿Ğ¾ÑÑ‚Ñ€Ğ¾ĞµĞ½Ğ½Ğ¾Ğ¼Ñƒ Ğ·Ğ°Ğ¿Ñ€Ğ¾ÑÑƒ.

        Returns:
            ĞĞ±Ñ‰ĞµĞµ ĞºĞ¾Ğ»Ğ¸Ñ‡ĞµÑÑ‚Ğ²Ğ¾ Ğ·Ğ°Ğ¿Ğ¸ÑĞµĞ¹
        """
        count_query = select(func.count()).select_from(self.query.subquery())
        result = await self.db_session.execute(count_query)
        return result.scalar_one()

    async def paginate(self, skip: int, limit: int) -> List[Equipment]:
        """
        Ğ’Ñ‹Ğ¿Ğ¾Ğ»Ğ½ÑĞµÑ‚ Ğ¿Ğ°Ğ³Ğ¸Ğ½Ğ°Ñ†Ğ¸Ñ Ğ·Ğ°Ğ¿Ñ€Ğ¾ÑĞ° Ğ¸ Ğ²Ğ¾Ğ·Ğ²Ñ€Ğ°Ñ‰Ğ°ĞµÑ‚ ÑĞ¿Ğ¸ÑĞ¾Ğº Ğ¾Ğ±Ğ¾Ñ€ÑƒĞ´Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ.

        Args:
            skip: ĞšĞ¾Ğ»Ğ¸Ñ‡ĞµÑÑ‚Ğ²Ğ¾ Ğ·Ğ°Ğ¿Ğ¸ÑĞµĞ¹ Ğ´Ğ»Ñ Ğ¿Ñ€Ğ¾Ğ¿ÑƒÑĞºĞ°
            limit: ĞœĞ°ĞºÑĞ¸Ğ¼Ğ°Ğ»ÑŒĞ½Ğ¾Ğµ ĞºĞ¾Ğ»Ğ¸Ñ‡ĞµÑÑ‚Ğ²Ğ¾ Ğ·Ğ°Ğ¿Ğ¸ÑĞµĞ¹ Ğ´Ğ»Ñ Ğ²Ğ¾Ğ·Ğ²Ñ€Ğ°Ñ‚Ğ°

        Returns:
            Ğ¡Ğ¿Ğ¸ÑĞ¾Ğº Ğ¾Ğ±ÑŠĞµĞºÑ‚Ğ¾Ğ² Equipment
        """
        paginated_query = self.query.order_by(Equipment.name).offset(skip).limit(limit)
        result = await self.db_session.execute(paginated_query)
        return result.unique().scalars().all()

```



## `api\services\equipment_service_api.py`


```python

# api/services/equipment_service_api.py

from typing import List, Type, Optional
from sqlalchemy.ext.asyncio import AsyncSession
from sqlalchemy.orm import joinedload, selectinload
from sqlalchemy import or_, and_, select, func
from fastapi import HTTPException
from datetime import date

from api.models.equipment import Equipment
from api.models.accessory import Accessory
from api.models.association import Association
from api.models.reservation import Reservation
from api.models.rental import Rental
from shared.schemas.equipment_schema import EquipmentUpdateExtended
from api.services.equipment_query_builder import EquipmentQueryBuilder

async def get_all_equipment(db: AsyncSession) -> list[Type[Equipment]]:
    """Ğ’Ğ¾Ğ·Ğ²Ñ€Ğ°Ñ‰Ğ°ĞµÑ‚ QuerySet Ğ²ÑĞµĞ³Ğ¾ Ğ¾Ğ±Ğ¾Ñ€ÑƒĞ´Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ Ñ Ğ¿Ğ¾Ğ´Ğ³Ñ€ÑƒĞ·ĞºĞ¾Ğ¹ ÑĞ²ÑĞ·ĞµĞ¹."""
    result = await db.execute(
        select(Equipment).options(
            joinedload(Equipment.accessories),
            joinedload(Equipment.associations)
        )
    )
    equipment_list = result.unique().scalars().all()
    
    # Ğ”Ğ¾Ğ¿Ğ¾Ğ»Ğ½Ğ¸Ñ‚ĞµĞ»ÑŒĞ½Ğ°Ñ Ğ·Ğ°Ñ‰Ğ¸Ñ‚Ğ°: ÑƒĞ±ĞµĞ¶Ğ´Ğ°ĞµĞ¼ÑÑ, Ñ‡Ñ‚Ğ¾ Ğ²ÑĞµ Ğ¿Ğ¾Ğ»Ñ ĞºĞ¾Ñ€Ñ€ĞµĞºÑ‚Ğ½Ñ‹
    for equipment in equipment_list:
        if equipment.name is None:
            equipment.name = "ĞĞµĞ¸Ğ·Ğ²ĞµÑÑ‚Ğ½Ğ¾Ğµ Ğ¾Ğ±Ğ¾Ñ€ÑƒĞ´Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ"
        if equipment.daily_rate is None:
            equipment.daily_rate = 0.0
        if equipment.condition is None:
            equipment.condition = "Ğ’ĞµĞ»Ğ¸ĞºĞ¾Ğ»ĞµĞ¿Ğ½Ğ¾"
    
    return equipment_list


async def get_paginated_equipment(
        db: AsyncSession,
        skip: int,
        limit: int,
        query: Optional[str] = None,
        type: Optional[str] = None,
        brand: Optional[str] = None,
        association_id: Optional[int] = None,
        start_date: Optional[date] = None,
        end_date: Optional[date] = None,
        available_only: bool = False
) -> (List[Equipment], int):
    """
    Ğ’Ğ¾Ğ·Ğ²Ñ€Ğ°Ñ‰Ğ°ĞµÑ‚ Ğ¾Ñ‚Ñ„Ğ¸Ğ»ÑŒÑ‚Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ½Ñ‹Ğ¹ Ğ¸ Ğ¿Ğ°Ğ³Ğ¸Ğ½Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ½Ñ‹Ğ¹ ÑĞ¿Ğ¸ÑĞ¾Ğº Ğ¾Ğ±Ğ¾Ñ€ÑƒĞ´Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ Ğ¸ Ğ¸Ñ… Ğ¾Ğ±Ñ‰ĞµĞµ ĞºĞ¾Ğ»Ğ¸Ñ‡ĞµÑÑ‚Ğ²Ğ¾.
    Ğ˜ÑĞ¿Ğ¾Ğ»ÑŒĞ·ÑƒĞµÑ‚ EquipmentQueryBuilder Ğ´Ğ»Ñ Ğ¿Ğ¾ÑÑ‚Ñ€Ğ¾ĞµĞ½Ğ¸Ñ Ğ·Ğ°Ğ¿Ñ€Ğ¾ÑĞ¾Ğ² Ñ Ñ€Ğ°Ğ·Ğ»Ğ¸Ñ‡Ğ½Ñ‹Ğ¼Ğ¸ Ñ„Ğ¸Ğ»ÑŒÑ‚Ñ€Ğ°Ğ¼Ğ¸.
    """
    # Ğ’Ğ°Ğ»Ğ¸Ğ´Ğ°Ñ†Ğ¸Ñ Ğ´Ğ°Ñ‚ Ğ½Ğ° ÑƒÑ€Ğ¾Ğ²Ğ½Ğµ ÑĞµÑ€Ğ²Ğ¸ÑĞ°
    if available_only and start_date and end_date:
        if start_date >= end_date:
            raise HTTPException(
                status_code=400, 
                detail="Ğ”Ğ°Ñ‚Ğ° Ğ½Ğ°Ñ‡Ğ°Ğ»Ğ° Ğ´Ğ¾Ğ»Ğ¶Ğ½Ğ° Ğ±Ñ‹Ñ‚ÑŒ Ñ€Ğ°Ğ½ÑŒÑˆĞµ Ğ´Ğ°Ñ‚Ñ‹ Ğ¾ĞºĞ¾Ğ½Ñ‡Ğ°Ğ½Ğ¸Ñ."
            )
    
    # Ğ¡Ğ¾Ğ·Ğ´Ğ°ĞµĞ¼ ÑĞºĞ·ĞµĞ¼Ğ¿Ğ»ÑÑ€ Ğ±Ğ¸Ğ»Ğ´ĞµÑ€Ğ° Ğ·Ğ°Ğ¿Ñ€Ğ¾ÑĞ¾Ğ²
    query_builder = EquipmentQueryBuilder(db)
    
    # ĞŸÑ€Ğ¸Ğ¼ĞµĞ½ÑĞµĞ¼ Ñ„Ğ¸Ğ»ÑŒÑ‚Ñ€Ñ‹ Ñ Ğ¸ÑĞ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ğ½Ğ¸ĞµĞ¼ Ñ†ĞµĞ¿Ğ¾Ñ‡ĞºĞ¸ Ğ²Ñ‹Ğ·Ğ¾Ğ²Ğ¾Ğ² (Builder Pattern)
    query_builder.apply_search(query)\
                 .apply_type(type)\
                 .apply_brand(brand)\
                 .apply_association(association_id)
    
    # ĞŸÑ€Ğ¸Ğ¼ĞµĞ½ÑĞµĞ¼ Ñ„Ğ¸Ğ»ÑŒÑ‚Ñ€ Ğ´Ğ¾ÑÑ‚ÑƒĞ¿Ğ½Ğ¾ÑÑ‚Ğ¸, ĞµÑĞ»Ğ¸ Ğ½ĞµĞ¾Ğ±Ñ…Ğ¾Ğ´Ğ¸Ğ¼Ğ¾
    if available_only and start_date and end_date:
        query_builder.apply_availability(start_date, end_date)
    
    # ĞŸĞ¾Ğ»ÑƒÑ‡Ğ°ĞµĞ¼ Ğ¾Ğ±Ñ‰ĞµĞµ ĞºĞ¾Ğ»Ğ¸Ñ‡ĞµÑÑ‚Ğ²Ğ¾ Ğ¸ Ğ¿Ğ°Ğ³Ğ¸Ğ½Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ½Ñ‹Ğµ Ñ€ĞµĞ·ÑƒĞ»ÑŒÑ‚Ğ°Ñ‚Ñ‹
    total = await query_builder.count()
    items = await query_builder.paginate(skip, limit)
    
    # Ğ”Ğ¾Ğ¿Ğ¾Ğ»Ğ½Ğ¸Ñ‚ĞµĞ»ÑŒĞ½Ğ°Ñ Ğ·Ğ°Ñ‰Ğ¸Ñ‚Ğ°: ÑƒĞ±ĞµĞ¶Ğ´Ğ°ĞµĞ¼ÑÑ, Ñ‡Ñ‚Ğ¾ Ğ²ÑĞµ Ğ¿Ğ¾Ğ»Ñ ĞºĞ¾Ñ€Ñ€ĞµĞºÑ‚Ğ½Ñ‹
    for equipment in items:
        if equipment.name is None:
            equipment.name = "ĞĞµĞ¸Ğ·Ğ²ĞµÑÑ‚Ğ½Ğ¾Ğµ Ğ¾Ğ±Ğ¾Ñ€ÑƒĞ´Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ"
        if equipment.daily_rate is None:
            equipment.daily_rate = 0.0
        if equipment.condition is None:
            equipment.condition = "Ğ’ĞµĞ»Ğ¸ĞºĞ¾Ğ»ĞµĞ¿Ğ½Ğ¾"
    
    return items, total


async def update_equipment_details(db: AsyncSession, equipment_id: int, equipment_data: EquipmentUpdateExtended) -> Equipment:
    result = await db.execute(
        select(Equipment)
        .filter(Equipment.id == equipment_id)
        .options(
            selectinload(Equipment.accessories),
            selectinload(Equipment.associations)
        )
    )
    db_equipment = result.scalars().first()
    if not db_equipment:
        raise HTTPException(status_code=404, detail="ĞĞ±Ğ¾Ñ€ÑƒĞ´Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ Ğ½Ğµ Ğ½Ğ°Ğ¹Ğ´ĞµĞ½Ğ¾")

    update_data = equipment_data.model_dump(exclude_unset=True)

    if "accessory_ids" in update_data:
        accessory_ids = update_data.pop("accessory_ids")
        db_equipment.accessories.clear()
        await db.flush()
        if accessory_ids:
            accessories_result = await db.execute(select(Accessory).filter(Accessory.id.in_(accessory_ids)))
            found_accessories = accessories_result.unique().scalars().all()
            if len(found_accessories) != len(accessory_ids):
                raise HTTPException(status_code=404, detail="ĞĞ´Ğ¸Ğ½ Ğ¸Ğ»Ğ¸ Ğ½ĞµÑĞºĞ¾Ğ»ÑŒĞºĞ¾ Ğ°ĞºÑĞµÑÑÑƒĞ°Ñ€Ğ¾Ğ² Ñ ÑƒĞºĞ°Ğ·Ğ°Ğ½Ğ½Ñ‹Ğ¼Ğ¸ ID Ğ½Ğµ Ğ½Ğ°Ğ¹Ğ´ĞµĞ½Ñ‹")
            db_equipment.accessories.extend(found_accessories)

    if "association_ids" in update_data:
        association_ids = update_data.pop("association_ids")
        db_equipment.associations.clear()
        await db.flush()
        if association_ids:
            associations_result = await db.execute(select(Association).filter(Association.id.in_(association_ids)))
            found_associations = associations_result.unique().scalars().all()
            if len(found_associations) != len(association_ids):
                raise HTTPException(status_code=404, detail="ĞĞ´Ğ½Ğ° Ğ¸Ğ»Ğ¸ Ğ½ĞµÑĞºĞ¾Ğ»ÑŒĞºĞ¾ Ğ°ÑÑĞ¾Ñ†Ğ¸Ğ°Ñ†Ğ¸Ğ¹ Ñ ÑƒĞºĞ°Ğ·Ğ°Ğ½Ğ½Ñ‹Ğ¼Ğ¸ ID Ğ½Ğµ Ğ½Ğ°Ğ¹Ğ´ĞµĞ½Ñ‹")
            db_equipment.associations.extend(found_associations)

    for key, value in update_data.items():
        setattr(db_equipment, key, value)

    db.add(db_equipment)
    await db.commit()
    
    # ĞŸĞ¾Ğ²Ñ‚Ğ¾Ñ€Ğ½Ğ¾ Ğ¿Ğ¾Ğ»ÑƒÑ‡Ğ°ĞµĞ¼ Ğ¾Ğ±ÑŠĞµĞºÑ‚ Ğ¸Ğ· Ğ‘Ğ” Ñ Ğ·Ğ°Ğ³Ñ€ÑƒĞ¶ĞµĞ½Ğ½Ñ‹Ğ¼Ğ¸ ÑĞ²ÑĞ·ÑĞ¼Ğ¸
    result = await db.execute(
        select(Equipment)
        .filter(Equipment.id == equipment_id)
        .options(
            selectinload(Equipment.accessories),
            selectinload(Equipment.associations)
        )
    )
    return result.scalars().first()

```



## `api\services\financial_service.py`


```python

# api/services/financial_service.py

from sqlalchemy.ext.asyncio import AsyncSession
from sqlalchemy import select, func
from sqlalchemy.orm import selectinload
from datetime import date, timedelta
from typing import List, Dict, Optional, NamedTuple, Union
from fastapi import HTTPException
import logging

from api.models.equipment import Equipment
from api.models.promo_code import PromoCode
from api.models.accessory import Accessory
from api.models.holiday import Holiday
from api.models.rental import Rental
from api.models.reservation import Reservation
from .discount_service import get_duration_discount_percentage
from .promo_code import PromoCodeBusinessLogic
from shared.schemas.rental_schema import RentalOut
from shared.schemas.reservation_schema import AdminReservationOut, ReservationItem

logger = logging.getLogger(__name__)


class PriceDetails(NamedTuple):
    """Ğ¡Ñ‚Ñ€ÑƒĞºÑ‚ÑƒÑ€Ğ° Ğ´Ğ»Ñ Ğ²Ğ¾Ğ·Ğ²Ñ€Ğ°Ñ‚Ğ° Ğ´ĞµÑ‚Ğ°Ğ»Ğ¸Ğ·Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ½Ğ¾Ğ¹ Ğ¸Ğ½Ñ„Ğ¾Ñ€Ğ¼Ğ°Ñ†Ğ¸Ğ¸ Ğ¾ Ñ†ĞµĞ½Ğµ."""
    full_total: float
    discount_amount: float
    final_total: float


class FinancialService:
    """
    Ğ•Ğ´Ğ¸Ğ½Ñ‹Ğ¹ ÑĞµÑ€Ğ²Ğ¸Ñ Ğ´Ğ»Ñ Ğ²ÑĞµÑ… Ñ„Ğ¸Ğ½Ğ°Ğ½ÑĞ¾Ğ²Ñ‹Ñ… Ñ€Ğ°ÑÑ‡ĞµÑ‚Ğ¾Ğ² Ğ¸ Ğ¾Ğ±Ğ¾Ğ³Ğ°Ñ‰ĞµĞ½Ğ¸Ñ Ğ´Ğ°Ğ½Ğ½Ñ‹Ñ….
    ĞĞ±ÑŠĞµĞ´Ğ¸Ğ½ÑĞµÑ‚ Ğ»Ğ¾Ğ³Ğ¸ĞºÑƒ Ğ¸Ğ· price_calculation_service Ğ¸ rental_calculation_service.
    """

    def __init__(self, db: AsyncSession):
        self.db = db

    # --- ĞœĞµÑ‚Ğ¾Ğ´Ñ‹ Ñ€Ğ°ÑÑ‡ĞµÑ‚Ğ° ÑÑ‚Ğ¾Ğ¸Ğ¼Ğ¾ÑÑ‚Ğ¸ (Ğ¸Ğ· price_calculation_service) ---

    async def find_next_working_day(self, start_date: date) -> date:
        """ĞĞ°Ñ…Ğ¾Ğ´Ğ¸Ñ‚ Ğ±Ğ»Ğ¸Ğ¶Ğ°Ğ¹ÑˆÑƒÑ ÑĞ»ĞµĞ´ÑƒÑÑ‰ÑƒÑ Ğ´Ğ°Ñ‚Ñƒ, ĞºĞ¾Ñ‚Ğ¾Ñ€Ğ°Ñ Ğ½Ğµ ÑĞ²Ğ»ÑĞµÑ‚ÑÑ Ğ²Ñ‹Ñ…Ğ¾Ğ´Ğ½Ñ‹Ğ¼."""
        next_day = start_date
        while True:
            result = await self.db.execute(select(Holiday).filter(Holiday.date == next_day))
            if not result.scalars().first():
                break
            next_day += timedelta(days=1)
        return next_day

    def validate_date_range(self, start_date: date, end_date: date):
        """ĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑĞµÑ‚, Ñ‡Ñ‚Ğ¾ ĞºĞ¾Ğ½ĞµÑ‡Ğ½Ğ°Ñ Ğ´Ğ°Ñ‚Ğ° ÑÑ‚Ñ€Ğ¾Ğ³Ğ¾ Ğ±Ğ¾Ğ»ÑŒÑˆĞµ Ğ½Ğ°Ñ‡Ğ°Ğ»ÑŒĞ½Ğ¾Ğ¹."""
        if start_date >= end_date:
            raise HTTPException(
                status_code=400,
                detail="Ğ”Ğ°Ñ‚Ğ° Ğ¾ĞºĞ¾Ğ½Ñ‡Ğ°Ğ½Ğ¸Ñ Ğ´Ğ¾Ğ»Ğ¶Ğ½Ğ° Ğ±Ñ‹Ñ‚ÑŒ Ğ¿Ğ¾Ğ·Ğ¶Ğµ Ğ´Ğ°Ñ‚Ñ‹ Ğ½Ğ°Ñ‡Ğ°Ğ»Ğ°."
            )

    async def validate_holidays(self, start_date: date, end_date: date):
        """ĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑĞµÑ‚, Ñ‡Ñ‚Ğ¾ Ğ´Ğ°Ñ‚Ğ° Ğ½Ğ°Ñ‡Ğ°Ğ»Ğ° Ğ¸Ğ»Ğ¸ Ğ¾ĞºĞ¾Ğ½Ñ‡Ğ°Ğ½Ğ¸Ñ Ñ€ĞµĞ·ĞµÑ€Ğ²Ğ° Ğ½Ğµ Ğ²Ñ‹Ğ¿Ğ°Ğ´Ğ°ĞµÑ‚ Ğ½Ğ° Ğ²Ñ‹Ñ…Ğ¾Ğ´Ğ½Ğ¾Ğ¹."""
        start_result = await self.db.execute(select(Holiday).filter(Holiday.date == start_date))
        is_start_holiday = start_result.scalars().first()
        
        end_result = await self.db.execute(select(Holiday).filter(Holiday.date == end_date))
        is_end_holiday = end_result.scalars().first()
        
        if is_start_holiday or is_end_holiday:
            raise HTTPException(
                status_code=400,
                detail="ĞĞµĞ»ÑŒĞ·Ñ Ğ½Ğ°Ñ‡Ğ°Ñ‚ÑŒ Ğ¸Ğ»Ğ¸ Ğ·Ğ°ĞºĞ¾Ğ½Ñ‡Ğ¸Ñ‚ÑŒ Ñ€ĞµĞ·ĞµÑ€Ğ² Ğ² Ğ²Ñ‹Ñ…Ğ¾Ğ´Ğ½Ğ¾Ğ¹ Ğ´ĞµĞ½ÑŒ."
            )

    async def get_rental_days(self, start_date: date, end_date: date) -> int:
        """Ğ Ğ°ÑÑÑ‡Ğ¸Ñ‚Ñ‹Ğ²Ğ°ĞµÑ‚ ĞºĞ¾Ğ»Ğ¸Ñ‡ĞµÑÑ‚Ğ²Ğ¾ Ñ‚Ğ°Ñ€Ğ¸Ñ„Ğ¸Ñ†Ğ¸Ñ€ÑƒĞµĞ¼Ñ‹Ñ… ÑÑƒÑ‚Ğ¾Ğº, Ğ¸ÑĞºĞ»ÑÑ‡Ğ°Ñ Ğ²Ñ‹Ñ…Ğ¾Ğ´Ğ½Ñ‹Ğµ Ğ´Ğ½Ğ¸."""
        if start_date >= end_date:
            return 0
        total_days = (end_date - start_date).days
        holidays_result = await self.db.execute(
            select(func.count(Holiday.date)).filter(
                Holiday.date > start_date,
                Holiday.date < end_date
            )
        )
        holidays_count = holidays_result.scalar_one()
        return total_days - holidays_count

    async def calculate_final_price(
            self,
            equipment_ids: List[int],
            selected_accessories: Optional[Dict[int, List[int]]],
            start_date: date,
            end_date: date,
            promo_code: Optional[PromoCode]
    ) -> PriceDetails:
        """Ğ Ğ°ÑÑÑ‡Ğ¸Ñ‚Ñ‹Ğ²Ğ°ĞµÑ‚ Ğ¿Ğ¾Ğ»Ğ½ÑƒÑ, Ñ„Ğ¸Ğ½Ğ°Ğ»ÑŒĞ½ÑƒÑ ÑÑ‚Ğ¾Ğ¸Ğ¼Ğ¾ÑÑ‚ÑŒ Ğ·Ğ°ĞºĞ°Ğ·Ğ°, Ğ²ĞºĞ»ÑÑ‡Ğ°Ñ Ğ²ÑĞµ ÑĞºĞ¸Ğ´ĞºĞ¸."""
        if not equipment_ids:
            return PriceDetails(full_total=0.0, discount_amount=0.0, final_total=0.0)

        rental_days = await self.get_rental_days(start_date, end_date)
        if rental_days <= 0:
            return PriceDetails(full_total=0.0, discount_amount=0.0, final_total=0.0)

        equipment_result = await self.db.execute(
            select(Equipment)
            .filter(Equipment.id.in_(equipment_ids))
            .options(
                selectinload(Equipment.accessories),
                selectinload(Equipment.associations)
            )
        )
        selected_equipment = equipment_result.unique().scalars().all()
        base_equipment_cost = sum(item.daily_rate for item in selected_equipment)

        accessories_cost = 0.0
        if selected_accessories:
            all_accessory_ids = [acc_id for equip_accs in selected_accessories.values() for acc_id in equip_accs]
            if all_accessory_ids:
                accessories_result = await self.db.execute(select(Accessory).filter(Accessory.id.in_(all_accessory_ids)))
                found_accessories = accessories_result.unique().scalars().all()
                accessories_cost = sum(acc.price for acc in found_accessories)

        full_total = (base_equipment_cost + accessories_cost) * rental_days
        duration_discount = await get_duration_discount_percentage(self.db, rental_days)
        
        # Ğ˜ÑĞ¿Ğ¾Ğ»ÑŒĞ·ÑƒĞµĞ¼ Ğ½Ğ¾Ğ²ÑƒÑ Ğ°Ñ€Ñ…Ğ¸Ñ‚ĞµĞºÑ‚ÑƒÑ€Ñƒ Ğ¿Ñ€Ğ¾Ğ¼Ğ¾ĞºĞ¾Ğ´Ğ¾Ğ² Ğ´Ğ»Ñ Ñ€Ğ°ÑÑ‡ĞµÑ‚Ğ° ÑĞºĞ¸Ğ´ĞºĞ¸
        promo_discount = 0
        if promo_code:
            business_logic = PromoCodeBusinessLogic(self.db)
            promo_discount = promo_code.discount_percentage
            # Ğ˜ÑĞ¿Ğ¾Ğ»ÑŒĞ·ÑƒĞµĞ¼ Ğ¼ĞµÑ‚Ğ¾Ğ´ Ğ²Ğ°Ğ»Ğ¸Ğ´Ğ°Ñ†Ğ¸Ğ¸ ĞºĞ¾Ğ¼Ğ±Ğ¸Ğ½Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ½Ğ¾Ğ¹ ÑĞºĞ¸Ğ´ĞºĞ¸
            total_discount_percentage = business_logic.validate_combined_discount(
                duration_discount, promo_discount
            )
        else:
            total_discount_percentage = duration_discount

        discount_amount = full_total * (total_discount_percentage / 100)
        final_total = full_total - discount_amount

        return PriceDetails(
            full_total=round(full_total, 2),
            discount_amount=round(discount_amount, 2),
            final_total=round(final_total, 2)
        )

    # --- ĞœĞµÑ‚Ğ¾Ğ´Ñ‹ Ñ€Ğ°ÑÑ‡ĞµÑ‚Ğ° Ğ°Ñ€ĞµĞ½Ğ´Ñ‹ (Ğ¸Ğ· rental_calculation_service) ---

    async def calculate_daily_rate(self, rental: Rental) -> float:
        """
        Ğ Ğ°ÑÑÑ‡Ğ¸Ñ‚Ñ‹Ğ²Ğ°ĞµÑ‚ Ğ´Ğ½ĞµĞ²Ğ½ÑƒÑ ÑÑ‚Ğ°Ğ²ĞºÑƒ Ğ°Ñ€ĞµĞ½Ğ´Ñ‹ Ğ½Ğ° Ğ¾ÑĞ½Ğ¾Ğ²Ğµ Ğ¾Ğ±Ñ‰ĞµĞ¹ ÑÑ‚Ğ¾Ğ¸Ğ¼Ğ¾ÑÑ‚Ğ¸ Ğ¸ Ğ¿Ğ»Ğ°Ğ½Ğ¾Ğ²Ğ¾Ğ³Ğ¾ ĞºĞ¾Ğ»Ğ¸Ñ‡ĞµÑÑ‚Ğ²Ğ° Ğ´Ğ½ĞµĞ¹.
        """
        if rental.total_cost <= 0:
            return 0.0
            
        planned_days = await self.get_rental_days(rental.start_date, rental.end_date)
        if planned_days <= 0:
            return 0.0
            
        return rental.total_cost / planned_days
    
    def calculate_overdue_days(self, rental: Rental, actual_return_date: date) -> int:
        """
        Ğ Ğ°ÑÑÑ‡Ğ¸Ñ‚Ñ‹Ğ²Ğ°ĞµÑ‚ ĞºĞ¾Ğ»Ğ¸Ñ‡ĞµÑÑ‚Ğ²Ğ¾ Ğ¿Ñ€Ğ¾ÑÑ€Ğ¾Ñ‡ĞµĞ½Ğ½Ñ‹Ñ… Ğ´Ğ½ĞµĞ¹.
        """
        if actual_return_date <= rental.end_date:
            return 0
            
        return (actual_return_date - rental.end_date).days
    
    async def calculate_overdue_surcharge(self, rental: Rental, actual_return_date: date) -> float:
        """
        Ğ Ğ°ÑÑÑ‡Ğ¸Ñ‚Ñ‹Ğ²Ğ°ĞµÑ‚ ÑˆÑ‚Ñ€Ğ°Ñ„ Ğ·Ğ° Ğ¿Ñ€Ğ¾ÑÑ€Ğ¾Ñ‡ĞµĞ½Ğ½Ñ‹Ğµ Ğ´Ğ½Ğ¸ Ğ°Ñ€ĞµĞ½Ğ´Ñ‹.
        """
        overdue_days = self.calculate_overdue_days(rental, actual_return_date)
        if overdue_days <= 0:
            return 0.0
            
        daily_rate = await self.calculate_daily_rate(rental)
        if daily_rate <= 0:
            return 0.0
            
        surcharge_amount = daily_rate * overdue_days
        return round(surcharge_amount, 2)
    
    async def calculate_early_return_credit(self, rental: Rental, actual_return_date: date, planned_days: int) -> float:
        """
        Ğ Ğ°ÑÑÑ‡Ğ¸Ñ‚Ñ‹Ğ²Ğ°ĞµÑ‚ ĞºÑ€ĞµĞ´Ğ¸Ñ‚ Ğ·Ğ° Ğ´Ğ¾ÑÑ€Ğ¾Ñ‡Ğ½Ñ‹Ğ¹ Ğ²Ğ¾Ğ·Ğ²Ñ€Ğ°Ñ‚ Ğ°Ñ€ĞµĞ½Ğ´Ñ‹.
        """
        if actual_return_date >= rental.end_date or planned_days <= 0:
            return 0.0

        daily_rate = await self.calculate_daily_rate(rental)
        if daily_rate <= 0:
            return 0.0
            
        # Ğ Ğ°ÑÑÑ‡Ğ¸Ñ‚Ñ‹Ğ²Ğ°ĞµĞ¼ Ğ¸Ğ¼ĞµĞ½Ğ½Ğ¾ Ñ‚Ğ°Ñ€Ğ¸Ñ„Ğ¸Ñ†Ğ¸Ñ€ÑƒĞµĞ¼Ñ‹Ğµ Ğ´Ğ½Ğ¸ Ğ² Ğ¾ÑÑ‚Ğ°Ğ²ÑˆĞµĞ¼ÑÑ Ğ¿ĞµÑ€Ğ¸Ğ¾Ğ´Ğµ
        unused_billable_days = await self.get_rental_days(actual_return_date, rental.end_date)
        if unused_billable_days <= 0:
            return 0.0
            
        credit_amount = unused_billable_days * daily_rate
        return round(credit_amount, 2)
    
    async def get_rental_calculation_summary(self, rental: Rental, actual_return_date: date, planned_days: int) -> dict:
        """
        Ğ’Ğ¾Ğ·Ğ²Ñ€Ğ°Ñ‰Ğ°ĞµÑ‚ Ğ¿Ğ¾Ğ»Ğ½ÑƒÑ ÑĞ²Ğ¾Ğ´ĞºÑƒ Ñ€Ğ°ÑÑ‡ĞµÑ‚Ğ¾Ğ² Ğ´Ğ»Ñ Ğ°Ñ€ĞµĞ½Ğ´Ñ‹.
        """
        daily_rate = await self.calculate_daily_rate(rental)
        overdue_days = self.calculate_overdue_days(rental, actual_return_date)
        surcharge_amount = await self.calculate_overdue_surcharge(rental, actual_return_date)
        credit_amount = await self.calculate_early_return_credit(rental, actual_return_date, planned_days)
        
        return {
            'daily_rate': daily_rate,
            'overdue_days': overdue_days,
            'surcharge_amount': surcharge_amount,
            'credit_amount': credit_amount,
            'is_overdue': overdue_days > 0,
            'is_early_return': actual_return_date < rental.end_date and credit_amount > 0
        }

    # --- Ğ£Ğ½Ğ¸Ğ²ĞµÑ€ÑĞ°Ğ»ÑŒĞ½Ñ‹Ğ¹ Ğ¼ĞµÑ‚Ğ¾Ğ´ Ğ¾Ğ±Ğ¾Ğ³Ğ°Ñ‰ĞµĞ½Ğ¸Ñ Ğ´Ğ°Ğ½Ğ½Ñ‹Ñ… ---

    async def enrich_order_with_financials(self, order: Union[Rental, Reservation]) -> Union[RentalOut, AdminReservationOut, ReservationItem]:
        """
        Ğ£Ğ½Ğ¸Ğ²ĞµÑ€ÑĞ°Ğ»ÑŒĞ½Ñ‹Ğ¹ Ğ¼ĞµÑ‚Ğ¾Ğ´ Ğ´Ğ»Ñ Ğ¾Ğ±Ğ¾Ğ³Ğ°Ñ‰ĞµĞ½Ğ¸Ñ Ğ·Ğ°ĞºĞ°Ğ·Ğ° (Ğ°Ñ€ĞµĞ½Ğ´Ñ‹ Ğ¸Ğ»Ğ¸ Ñ€ĞµĞ·ĞµÑ€Ğ²Ğ°) Ñ„Ğ¸Ğ½Ğ°Ğ½ÑĞ¾Ğ²Ñ‹Ğ¼Ğ¸ Ğ´Ğ°Ğ½Ğ½Ñ‹Ğ¼Ğ¸.
        
        Args:
            order: ORM-Ğ¾Ğ±ÑŠĞµĞºÑ‚ Ğ°Ñ€ĞµĞ½Ğ´Ñ‹ Ğ¸Ğ»Ğ¸ Ñ€ĞµĞ·ĞµÑ€Ğ²Ğ°
            
        Returns:
            Pydantic-ÑÑ…ĞµĞ¼Ğ° Ñ Ğ¿Ğ¾Ğ»Ğ½Ğ¾ÑÑ‚ÑŒÑ Ğ·Ğ°Ğ¿Ğ¾Ğ»Ğ½ĞµĞ½Ğ½Ñ‹Ğ¼Ğ¸ Ñ„Ğ¸Ğ½Ğ°Ğ½ÑĞ¾Ğ²Ñ‹Ğ¼Ğ¸ Ğ´Ğ°Ğ½Ğ½Ñ‹Ğ¼Ğ¸
        """
        if isinstance(order, Rental):
            return await self._enrich_rental_with_financials(order)
        elif isinstance(order, Reservation):
            return await self._enrich_reservation_with_financials(order)
        else:
            raise ValueError(f"Unsupported order type: {type(order)}")

    async def _enrich_rental_with_financials(self, rental: Rental) -> RentalOut:
        """ĞĞ±Ğ¾Ğ³Ğ°Ñ‰Ğ°ĞµÑ‚ Ğ¾Ğ±ÑŠĞµĞºÑ‚ Ğ°Ñ€ĞµĞ½Ğ´Ñ‹ Ñ„Ğ¸Ğ½Ğ°Ğ½ÑĞ¾Ğ²Ñ‹Ğ¼Ğ¸ Ğ´Ğ°Ğ½Ğ½Ñ‹Ğ¼Ğ¸."""
        rental_out = RentalOut.model_validate(rental)
        today = date.today()

        # Ğ”Ğ¸Ğ½Ğ°Ğ¼Ğ¸Ñ‡ĞµÑĞºĞ¸Ğ¹ ÑÑ‚Ğ°Ñ‚ÑƒÑ overdue
        if rental.status == 'active' and rental.end_date < today:
            rental_out.status = 'overdue'

        # Ğ Ğ°ÑÑ‡ĞµÑ‚ Ğ¿Ñ€Ğ¾ÑÑ€Ğ¾Ñ‡ĞºĞ¸ Ğ¸Ğ»Ğ¸ Ğ¾ÑÑ‚Ğ°Ğ²ÑˆĞ¸Ñ…ÑÑ Ğ´Ğ½ĞµĞ¹
        if rental_out.status == 'overdue':
            rental_out.overdue_days = self.calculate_overdue_days(rental, today)
            rental_out.overdue_surcharge = await self.calculate_overdue_surcharge(rental, today)
        elif rental.status == 'active':
            rental_out.days_remaining = (rental.end_date - today).days

        # Ğ Ğ°ÑÑ‡ĞµÑ‚ ÑÑ‚Ğ¾Ğ¸Ğ¼Ğ¾ÑÑ‚Ğ¸ Ğ°ĞºÑĞµÑÑÑƒĞ°Ñ€Ğ¾Ğ²
        accessories_cost = 0.0
        for accessory_link in rental.accessory_links:
            if accessory_link.accessory and accessory_link.accessory.price:
                accessories_cost += accessory_link.accessory.price
        rental_out.accessories_cost = accessories_cost

        # Ğ Ğ°ÑÑ‡ĞµÑ‚ Ğ¾ÑÑ‚Ğ°Ñ‚ĞºĞ° Ğº Ğ¾Ğ¿Ğ»Ğ°Ñ‚Ğµ
        rental_out.remaining_amount = rental.total_cost - rental.prepayment_amount

        return rental_out

    async def _enrich_reservation_with_financials(self, reservation: Reservation) -> ReservationItem:
        """ĞĞ±Ğ¾Ğ³Ğ°Ñ‰Ğ°ĞµÑ‚ Ğ¾Ğ±ÑŠĞµĞºÑ‚ Ñ€ĞµĞ·ĞµÑ€Ğ²Ğ° Ñ„Ğ¸Ğ½Ğ°Ğ½ÑĞ¾Ğ²Ñ‹Ğ¼Ğ¸ Ğ´Ğ°Ğ½Ğ½Ñ‹Ğ¼Ğ¸."""
        reservation_out = ReservationItem.model_validate(reservation)
        today = date.today()

        # Ğ”Ğ¸Ğ½Ğ°Ğ¼Ğ¸Ñ‡ĞµÑĞºĞ¸Ğ¹ ÑÑ‚Ğ°Ñ‚ÑƒÑ overdue
        if reservation.status == 'active' and reservation.end_date < today:
            reservation_out.status = 'overdue'

        # Ğ£ÑÑ‚Ğ°Ğ½Ğ°Ğ²Ğ»Ğ¸Ğ²Ğ°ĞµĞ¼ rental_id ĞµÑĞ»Ğ¸ ĞµÑÑ‚ÑŒ ÑĞ²ÑĞ·Ğ°Ğ½Ğ½Ğ°Ñ Ğ°Ñ€ĞµĞ½Ğ´Ğ°
        if reservation.rental:
            reservation_out.rental_id = reservation.rental.id

        return reservation_out

    async def _enrich_admin_reservation_with_financials(self, reservation: Reservation) -> AdminReservationOut:
        """ĞĞ±Ğ¾Ğ³Ğ°Ñ‰Ğ°ĞµÑ‚ Ğ¾Ğ±ÑŠĞµĞºÑ‚ Ñ€ĞµĞ·ĞµÑ€Ğ²Ğ° Ğ´Ğ»Ñ Ğ°Ğ´Ğ¼Ğ¸Ğ½-Ğ¿Ğ°Ğ½ĞµĞ»Ğ¸ Ñ„Ğ¸Ğ½Ğ°Ğ½ÑĞ¾Ğ²Ñ‹Ğ¼Ğ¸ Ğ´Ğ°Ğ½Ğ½Ñ‹Ğ¼Ğ¸."""
        if not reservation.user:
            raise ValueError("Reservation must have user for admin view")

        reservation_base = await self._enrich_reservation_with_financials(reservation)
        user_info = reservation.user

        return AdminReservationOut(
            **reservation_base.model_dump(),
            user_info=user_info
        )

```



## `api\services\order\order_lifecycle_service.py`


```python

# api/services/order/order_lifecycle_service.py

from sqlalchemy.ext.asyncio import AsyncSession
from datetime import date
import logging

from api.models.user import User
from api.models.rental import Rental, RentalAccessory
from api.models.reservation import Reservation
from api.services.order.order_repository import OrderRepository
from api.services.order.order_validator import OrderValidator
from api.services.balance_service import BalanceService
from api.services.financial_service import FinancialService
from api.services.promo_code_service import validate_promo_code_for_use

from shared.schemas.reservation_schema import ReservationCreateRequest, ReservationUpdateRequest, AdminReservationCreateRequest
from shared.schemas.rental_schema import RentalCreateFromReservationRequest, RentalReturnRequest, RentalCreateFromScratchRequest, AdminRentalUpdate

logger = logging.getLogger(__name__)

class OrderLifecycleService:
    """
    Ğ•Ğ´Ğ¸Ğ½Ñ‹Ğ¹ ÑĞµÑ€Ğ²Ğ¸Ñ Ğ´Ğ»Ñ ÑƒĞ¿Ñ€Ğ°Ğ²Ğ»ĞµĞ½Ğ¸Ñ Ğ¿Ğ¾Ğ»Ğ½Ñ‹Ğ¼ Ğ¶Ğ¸Ğ·Ğ½ĞµĞ½Ğ½Ñ‹Ğ¼ Ñ†Ğ¸ĞºĞ»Ğ¾Ğ¼ Ğ·Ğ°ĞºĞ°Ğ·Ğ°:
    Ğ¾Ñ‚ ÑĞ¾Ğ·Ğ´Ğ°Ğ½Ğ¸Ñ Ñ€ĞµĞ·ĞµÑ€Ğ²Ğ° Ğ´Ğ¾ Ğ²Ğ¾Ğ·Ğ²Ñ€Ğ°Ñ‚Ğ° Ğ°Ñ€ĞµĞ½Ğ´Ñ‹.
    """
    def __init__(self, db: AsyncSession):
        self.db = db
        self.repo = OrderRepository(db)
        self.validator = OrderValidator(db)
        self.balance_service = BalanceService(db)
        self.financial_service = FinancialService(db)

    # --- ĞœĞµÑ‚Ğ¾Ğ´Ñ‹ Ğ´Ğ»Ñ Ğ ĞµĞ·ĞµÑ€Ğ²Ğ¾Ğ² (ĞŸĞ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ÑŒ) ---

    async def create_user_reservation(self, request: ReservationCreateRequest, user: User) -> Reservation:
        await self.validator.validate_dates_and_holidays(request.start_date, request.end_date)
        equipment = await self.repo.get_equipment_by_ids_or_fail(request.equipment_ids)
        self.validator.validate_accessories_for_equipment(request.selected_accessories, request.equipment_ids)
        await self.validator.validate_equipment_availability(request.equipment_ids, request.start_date, request.end_date)

        promo_code_obj = await self.repo.get_promo_code_by_name(request.promo_code) if request.promo_code else None
        price_details = await self.financial_service.calculate_final_price(request.equipment_ids, request.selected_accessories, request.start_date, request.end_date, promo_code_obj)

        reservation = self.repo.create_reservation_instance(
            user_id=user.id,
            start_date=request.start_date,
            end_date=request.end_date,
            equipment=equipment,
            price_details=price_details,
            promo_code_id=promo_code_obj.id if promo_code_obj else None
        )
        self.repo.add_accessories_to_reservation(reservation, request.selected_accessories)
        await self.repo.save(reservation)
        logger.info(f"User {user.id} created reservation #{reservation.id}")
        return await self.repo.get_reservation_by_id_or_fail(reservation.id)

    async def update_user_reservation(self, reservation_id: int, request: ReservationUpdateRequest, user: User) -> Reservation:
        reservation = await self.repo.get_reservation_by_id_or_fail(reservation_id, user_id=user.id)
        await self.validator.validate_dates_and_holidays(request.start_date, request.end_date)
        equipment = await self.repo.get_equipment_by_ids_or_fail(request.equipment_ids)
        self.validator.validate_accessories_for_equipment(request.selected_accessories, request.equipment_ids)
        await self.validator.validate_equipment_availability(request.equipment_ids, request.start_date, request.end_date, exclude_reservation_id=reservation_id)

        promo_code_obj = await self.repo.get_promo_code_by_name(request.promo_code) if request.promo_code else None
        price_details = await self.financial_service.calculate_final_price(request.equipment_ids, request.selected_accessories, request.start_date, request.end_date, promo_code_obj)

        self.repo.update_reservation_instance(
            reservation=reservation,
            start_date=request.start_date,
            end_date=request.end_date,
            equipment=equipment,
            price_details=price_details,
            promo_code_id=promo_code_obj.id if promo_code_obj else None
        )
        await self.repo.update_accessories_for_reservation(reservation, request.selected_accessories)
        await self.repo.save(reservation)
        logger.info(f"User {user.id} updated reservation #{reservation.id}")
        return await self.repo.get_reservation_by_id_or_fail(reservation.id)

    async def cancel_user_reservation(self, reservation_id: int, user: User):
        reservation = await self.repo.get_reservation_by_id_or_fail(reservation_id, user_id=user.id)
        self.validator.validate_reservation_is_cancellable(reservation)
        await self.repo.delete(reservation)
        logger.info(f"User {user.id} cancelled reservation #{reservation_id}")

    # --- ĞœĞµÑ‚Ğ¾Ğ´Ñ‹ Ğ´Ğ»Ñ Ğ ĞµĞ·ĞµÑ€Ğ²Ğ¾Ğ² (ĞĞ´Ğ¼Ğ¸Ğ½Ğ¸ÑÑ‚Ñ€Ğ°Ñ‚Ğ¾Ñ€) ---

    async def create_admin_reservation(self, request: AdminReservationCreateRequest) -> Reservation:
        user = await self.repo.get_user_by_id_or_fail(request.user_id)
        # Ğ”Ğ»Ñ Ğ°Ğ´Ğ¼Ğ¸Ğ½Ğ° Ğ¼Ñ‹ Ğ¼Ğ¾Ğ¶ĞµĞ¼ Ğ¿Ğ¾Ğ²Ñ‚Ğ¾Ñ€Ğ½Ğ¾ Ğ¸ÑĞ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ÑŒ Ğ»Ğ¾Ğ³Ğ¸ĞºÑƒ ÑĞ¾Ğ·Ğ´Ğ°Ğ½Ğ¸Ñ Ğ¾Ğ±Ñ‹Ñ‡Ğ½Ğ¾Ğ³Ğ¾ Ñ€ĞµĞ·ĞµÑ€Ğ²Ğ°
        return await self.create_user_reservation(request, user)

    async def update_admin_reservation(self, reservation_id: int, request: ReservationUpdateRequest) -> Reservation:
        reservation = await self.repo.get_reservation_by_id_or_fail(reservation_id)
        user = await self.repo.get_user_by_id_or_fail(reservation.user_id)
        # ĞĞ½Ğ°Ğ»Ğ¾Ğ³Ğ¸Ñ‡Ğ½Ğ¾, Ğ¸ÑĞ¿Ğ¾Ğ»ÑŒĞ·ÑƒĞµĞ¼ Ğ¾Ğ±Ñ‰ÑƒÑ Ğ»Ğ¾Ğ³Ğ¸ĞºÑƒ Ğ¾Ğ±Ğ½Ğ¾Ğ²Ğ»ĞµĞ½Ğ¸Ñ
        return await self.update_user_reservation(reservation_id, request, user)

    async def cancel_admin_reservation(self, reservation_id: int):
        reservation = await self.repo.get_reservation_by_id_or_fail(reservation_id)
        self.validator.validate_reservation_is_cancellable(reservation)
        await self.repo.delete(reservation)
        logger.warning(f"Admin cancelled reservation #{reservation_id}")

    async def bulk_cancel_admin_reservations(self, reservation_ids: list[int]):
        reservations = await self.repo.get_reservations_by_ids(reservation_ids)
        cancellable, not_cancellable = self.validator.filter_cancellable_reservations(reservations)

        if not_cancellable:
            logger.warning(f"Cannot bulk delete reservations already converted to rental: {[r.id for r in not_cancellable]}")

        for reservation in cancellable:
            await self.repo.delete(reservation)

        logger.warning(f"Admin bulk cancelled reservations: {[r.id for r in cancellable]}")

    # --- ĞœĞµÑ‚Ğ¾Ğ´Ñ‹ Ğ´Ğ»Ñ ĞÑ€ĞµĞ½Ğ´ (ĞĞ´Ğ¼Ğ¸Ğ½Ğ¸ÑÑ‚Ñ€Ğ°Ñ‚Ğ¾Ñ€) ---

    async def convert_reservation_to_rental(self, reservation_id: int, request: RentalCreateFromReservationRequest, manager: User) -> Rental:
        reservation = await self.repo.get_reservation_by_id_or_fail(reservation_id)
        self.validator.validate_reservation_for_conversion(reservation)
        await self.validator.validate_issue_on_holiday(date.today(), request.force_issue_on_holiday)

        # --- ĞĞĞ§ĞĞ›Ğ Ğ˜Ğ—ĞœĞ•ĞĞ•ĞĞ˜Ğ™ ---
        # 1. ĞŸĞ•Ğ Ğ•Ğ¡Ğ§Ğ˜Ğ¢Ğ«Ğ’ĞĞ•Ğœ Ğ¡Ğ¢ĞĞ˜ĞœĞĞ¡Ğ¢Ğ¬ ĞŸĞ•Ğ Ğ•Ğ” ĞšĞĞĞ’Ğ•Ğ Ğ¢ĞĞ¦Ğ˜Ğ•Ğ™
        price_details = await self.financial_service.calculate_final_price(
            reservation.equipment_ids,
            reservation.selected_accessories, # Ğ˜ÑĞ¿Ğ¾Ğ»ÑŒĞ·ÑƒĞµĞ¼ ÑĞ²Ğ¾Ğ¹ÑÑ‚Ğ²Ğ¾ Ğ¼Ğ¾Ğ´ĞµĞ»Ğ¸ Ğ´Ğ»Ñ Ğ¿Ğ¾Ğ»ÑƒÑ‡ĞµĞ½Ğ¸Ñ Ğ°ĞºÑĞµÑÑÑƒĞ°Ñ€Ğ¾Ğ²
            date.today(), # ĞÑ€ĞµĞ½Ğ´Ğ° Ğ²ÑĞµĞ³Ğ´Ğ° Ğ½Ğ°Ñ‡Ğ¸Ğ½Ğ°ĞµÑ‚ÑÑ Ğ² Ğ´ĞµĞ½ÑŒ Ğ²Ñ‹Ğ´Ğ°Ñ‡Ğ¸
            reservation.end_date,
            reservation.applied_promo_code
        )

        # 2. ĞŸĞµÑ€ĞµĞ´Ğ°ĞµĞ¼ Ğ¿ĞµÑ€ĞµÑÑ‡Ğ¸Ñ‚Ğ°Ğ½Ğ½Ñ‹Ğµ Ğ´Ğ°Ğ½Ğ½Ñ‹Ğµ Ğ² Ñ€ĞµĞ¿Ğ¾Ğ·Ğ¸Ñ‚Ğ¾Ñ€Ğ¸Ğ¹
        rental = self.repo.create_rental_from_reservation(
            reservation, 
            manager, 
            request.deposit_amount, 
            request.notes_on_issue,
            # ĞŸĞµÑ€ĞµĞ´Ğ°ĞµĞ¼ Ğ½Ğ¾Ğ²Ñ‹Ğµ Ğ´Ğ°Ğ½Ğ½Ñ‹Ğµ Ğ¾ Ñ†ĞµĞ½Ğµ
            recalculated_cost=price_details.final_total,
            recalculated_discount=price_details.discount_amount,
            prepayment_amount=request.prepayment_amount
        )
        # --- ĞšĞĞĞ•Ğ¦ Ğ˜Ğ—ĞœĞ•ĞĞ•ĞĞ˜Ğ™ ---

        # ĞĞ°Ñ‡Ğ¸ÑĞ»ÑĞµĞ¼ Ğ¿Ñ€ĞµĞ´Ğ¾Ğ¿Ğ»Ğ°Ñ‚Ñƒ Ğ½Ğ° Ğ±Ğ°Ğ»Ğ°Ğ½Ñ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ñ (ĞµÑĞ»Ğ¸ ĞµÑÑ‚ÑŒ)
        if request.prepayment_amount > 0:
            await self.balance_service.add_transaction(
                user_id=rental.user_id,
                amount=request.prepayment_amount,
                operation_type="prepayment",
                description=f"ĞŸÑ€ĞµĞ´Ğ¾Ğ¿Ğ»Ğ°Ñ‚Ğ° Ğ·Ğ° Ğ°Ñ€ĞµĞ½Ğ´Ñƒ #{rental.id} (Ğ¸Ğ· Ñ€ĞµĞ·ĞµÑ€Ğ²Ğ° #{reservation.id})",
                rental_id=rental.id
            )

        await self.balance_service.add_transaction(
            user_id=rental.user_id,
            amount=-rental.total_cost,
            operation_type="rental_debit",
            description=f"Ğ¡Ğ¿Ğ¸ÑĞ°Ğ½Ğ¸Ğµ Ğ·Ğ° Ğ°Ñ€ĞµĞ½Ğ´Ñƒ (Ğ¸Ğ· Ñ€ĞµĞ·ĞµÑ€Ğ²Ğ° #{reservation.id}) Ğ½Ğ° ÑÑƒĞ¼Ğ¼Ñƒ {rental.total_cost} Ñ€ÑƒĞ±.",
            rental_id=rental.id
        )
        await self.repo.save(rental)
        logger.info(f"Manager {manager.id} converted reservation #{reservation_id} to rental #{rental.id}")
        return await self.repo.get_rental_by_id_or_fail(rental.id) # Ğ’Ğ¾Ğ·Ğ²Ñ€Ğ°Ñ‰Ğ°ĞµĞ¼ Ñ Ğ¿Ğ¾Ğ´Ğ³Ñ€ÑƒĞ¶ĞµĞ½Ğ½Ñ‹Ğ¼Ğ¸ ÑĞ²ÑĞ·ÑĞ¼Ğ¸

    async def create_rental_from_scratch(self, request: RentalCreateFromScratchRequest, manager: User) -> Rental:
        user = await self.repo.get_user_by_id_or_fail(request.user_id)
        await self.validator.validate_equipment_availability(request.equipment_ids, request.start_date, request.end_date)
        equipment = await self.repo.get_equipment_by_ids_or_fail(request.equipment_ids)
        price_details = await self.financial_service.calculate_final_price(request.equipment_ids, None, request.start_date, request.end_date, None)

        rental = self.repo.create_rental_instance(
            user=user,
            manager=manager,
            start_date=request.start_date,
            end_date=request.end_date,
            equipment=equipment,
            total_cost=price_details.final_total,
            deposit_amount=request.deposit_amount,
            notes_on_issue=request.notes_on_issue
        )

        await self.balance_service.add_transaction(
            user_id=user.id,
            amount=-rental.total_cost,
            operation_type="rental_debit",
            description=f"Ğ¡Ğ¿Ğ¸ÑĞ°Ğ½Ğ¸Ğµ Ğ·Ğ° Ğ½Ğ¾Ğ²ÑƒÑ Ğ°Ñ€ĞµĞ½Ğ´Ñƒ #{rental.id} Ğ½Ğ° ÑÑƒĞ¼Ğ¼Ñƒ {rental.total_cost} Ñ€ÑƒĞ±.",
            rental_id=rental.id
        )
        await self.repo.save(rental)
        logger.info(f"Manager {manager.id} created rental from scratch #{rental.id} for user {user.id}")
        return await self.repo.get_rental_by_id_or_fail(rental.id)

    async def return_rental(self, rental_id: int, request: RentalReturnRequest, manager: User) -> Rental:
        rental = await self.repo.get_rental_by_id_or_fail(rental_id)
        self.validator.validate_accessories_returned(rental, request.accessories_returned_confirmation)

        # Ğ˜Ğ½Ğ¸Ñ†Ğ¸Ğ°Ğ»Ğ¸Ğ·Ğ¸Ñ€ÑƒĞµĞ¼ Ğ¿ĞµÑ€ĞµĞ¼ĞµĞ½Ğ½Ñ‹Ğµ Ğ´Ğ»Ñ Ñ€Ğ°ÑÑ‡ĞµÑ‚Ğ° ĞºÑ€ĞµĞ´Ğ¸Ñ‚Ğ° Ğ¸ ÑˆÑ‚Ñ€Ğ°Ñ„Ğ°
        credit_amount = 0.0
        surcharge_amount = 0.0

        # ĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑĞµĞ¼, ÑĞ²Ğ»ÑĞµÑ‚ÑÑ Ğ»Ğ¸ Ğ²Ğ¾Ğ·Ğ²Ñ€Ğ°Ñ‚ Ğ¿Ñ€Ğ¾ÑÑ€Ğ¾Ñ‡ĞµĞ½Ğ½Ñ‹Ğ¼
        if request.actual_return_date > rental.end_date:
            # ĞŸÑ€Ğ¾ÑÑ€Ğ¾Ñ‡ĞµĞ½Ğ½Ñ‹Ğ¹ Ğ²Ğ¾Ğ·Ğ²Ñ€Ğ°Ñ‚ - Ñ€Ğ°ÑÑÑ‡Ğ¸Ñ‚Ñ‹Ğ²Ğ°ĞµĞ¼ ÑˆÑ‚Ñ€Ğ°Ñ„
            surcharge_amount = await self.financial_service.calculate_overdue_surcharge(rental, request.actual_return_date)
            
            if surcharge_amount > 0:
                # Ğ¡Ğ¾Ğ·Ğ´Ğ°ĞµĞ¼ Ğ´ĞµĞ±ĞµÑ‚Ğ¾Ğ²ÑƒÑ Ñ‚Ñ€Ğ°Ğ½Ğ·Ğ°ĞºÑ†Ğ¸Ñ Ğ´Ğ»Ñ ÑĞ¿Ğ¸ÑĞ°Ğ½Ğ¸Ñ ÑˆÑ‚Ñ€Ğ°Ñ„Ğ°
                await self.balance_service.add_transaction(
                    user_id=rental.user_id,
                    amount=-surcharge_amount,  # ĞÑ‚Ñ€Ğ¸Ñ†Ğ°Ñ‚ĞµĞ»ÑŒĞ½Ğ°Ñ ÑÑƒĞ¼Ğ¼Ğ° Ğ´Ğ»Ñ ÑĞ¿Ğ¸ÑĞ°Ğ½Ğ¸Ñ
                    operation_type="overdue_surcharge_debit",
                    description=f"Ğ¡Ğ¿Ğ¸ÑĞ°Ğ½Ğ¸Ğµ Ğ·Ğ° Ğ¿Ñ€Ğ¾ÑÑ€Ğ¾Ñ‡ĞºÑƒ Ğ°Ñ€ĞµĞ½Ğ´Ñ‹ #{rental.id} Ğ½Ğ° {surcharge_amount} Ñ€ÑƒĞ±.",
                    rental_id=rental.id
                )
                logger.info(f"Applied overdue surcharge of {surcharge_amount} rub. for rental #{rental.id}")
        else:
            # Ğ’Ğ¾Ğ·Ğ²Ñ€Ğ°Ñ‚ Ğ²Ğ¾Ğ²Ñ€ĞµĞ¼Ñ Ğ¸Ğ»Ğ¸ Ğ´Ğ¾ÑÑ€Ğ¾Ñ‡Ğ½Ğ¾ - Ñ€Ğ°ÑÑÑ‡Ğ¸Ñ‚Ñ‹Ğ²Ğ°ĞµĞ¼ ĞºÑ€ĞµĞ´Ğ¸Ñ‚ Ğ·Ğ° Ğ´Ğ¾ÑÑ€Ğ¾Ñ‡Ğ½Ñ‹Ğ¹ Ğ²Ğ¾Ğ·Ğ²Ñ€Ğ°Ñ‚
            planned_days = await self.repo.get_rental_days_count(rental.start_date, rental.end_date)
            credit_amount = await self.financial_service.calculate_early_return_credit(rental, request.actual_return_date, planned_days)
            
            if credit_amount > 0:
                # Ğ¡Ğ¾Ğ·Ğ´Ğ°ĞµĞ¼ ĞºÑ€ĞµĞ´Ğ¸Ñ‚Ğ¾Ğ²ÑƒÑ Ñ‚Ñ€Ğ°Ğ½Ğ·Ğ°ĞºÑ†Ğ¸Ñ Ğ´Ğ»Ñ Ğ²Ğ¾Ğ·Ğ²Ñ€Ğ°Ñ‚Ğ° ÑÑ€ĞµĞ´ÑÑ‚Ğ²
                await self.balance_service.add_transaction(
                    user_id=rental.user_id,
                    amount=credit_amount,
                    operation_type="early_return_credit",
                    description=f"Ğ’Ğ¾Ğ·Ğ²Ñ€Ğ°Ñ‚ Ğ·Ğ° Ğ´Ğ¾ÑÑ€Ğ¾Ñ‡Ğ½Ğ¾Ğµ Ğ·Ğ°Ğ²ĞµÑ€ÑˆĞµĞ½Ğ¸Ğµ Ğ°Ñ€ĞµĞ½Ğ´Ñ‹ #{rental.id} Ğ½Ğ° ÑÑƒĞ¼Ğ¼Ñƒ {credit_amount} Ñ€ÑƒĞ±.",
                    rental_id=rental.id
                )
                logger.info(f"Applied early return credit of {credit_amount} rub. for rental #{rental.id}")

        # ĞŸĞ»Ğ°Ñ‚ĞµĞ¶ Ñ‚ĞµĞ¿ĞµÑ€ÑŒ Ğ¾Ğ±Ñ€Ğ°Ğ±Ğ°Ñ‚Ñ‹Ğ²Ğ°ĞµÑ‚ÑÑ Ğ¾Ñ‚Ğ´ĞµĞ»ÑŒĞ½Ñ‹Ğ¼ ÑĞ½Ğ´Ğ¿Ğ¾Ğ¸Ğ½Ñ‚Ğ¾Ğ¼ Ğ¸ Ğ½Ğµ ÑĞ²Ğ»ÑĞµÑ‚ÑÑ Ñ‡Ğ°ÑÑ‚ÑŒÑ Ğ¿Ñ€Ğ¾Ñ†ĞµÑÑĞ° Ğ²Ğ¾Ğ·Ğ²Ñ€Ğ°Ñ‚Ğ°.

        # Ğ¤Ğ¸Ğ½Ğ°Ğ»Ğ¸Ğ·Ğ¸Ñ€ÑƒĞµĞ¼ Ğ²Ğ¾Ğ·Ğ²Ñ€Ğ°Ñ‚ Ñ ÑƒÑ‡ĞµÑ‚Ğ¾Ğ¼ Ğ¸ ĞºÑ€ĞµĞ´Ğ¸Ñ‚Ğ°, Ğ¸ ÑˆÑ‚Ñ€Ğ°Ñ„Ğ°
        self.repo.finalize_rental_return(rental, request.actual_return_date, request.notes_on_return, credit_amount, surcharge_amount)
        await self.repo.save(rental)
        logger.info(f"Manager {manager.id} processed return for rental #{rental_id} - credit: {credit_amount}, surcharge: {surcharge_amount}")
        return await self.repo.get_rental_by_id_or_fail(rental.id)

    async def update_rental_details_by_admin(self, rental_id: int, request: AdminRentalUpdate, manager: User) -> Rental:
        rental = await self.repo.get_rental_by_id_or_fail(rental_id)
        update_data = request.model_dump(exclude_unset=True)
        self.repo.update_rental_instance(rental, update_data)
        await self.repo.save(rental)
        logger.info(f"Manager {manager.id} updated details for rental #{rental_id}")
        return await self.repo.get_rental_by_id_or_fail(rental.id)

    async def revert_rental_to_reservation(self, rental_id: int, manager: User):
        rental = await self.repo.get_rental_by_id_or_fail(rental_id)
        self.validator.validate_rental_for_revert(rental)

        reservation = self.repo.revert_rental_status_to_active(rental)

        await self.balance_service.add_transaction(
            user_id=rental.user_id,
            amount=rental.total_cost, # Ğ’Ğ¾Ğ·Ğ²Ñ€Ğ°Ñ‰Ğ°ĞµĞ¼ Ğ¿Ğ¾Ğ»Ğ½ÑƒÑ ÑÑ‚Ğ¾Ğ¸Ğ¼Ğ¾ÑÑ‚ÑŒ
            operation_type="rental_revert_credit",
            description=f"Ğ’Ğ¾Ğ·Ğ²Ñ€Ğ°Ñ‚ ÑÑ€ĞµĞ´ÑÑ‚Ğ² Ğ·Ğ° Ğ¾Ñ‚Ğ¼ĞµĞ½Ñƒ Ğ²Ñ‹Ğ´Ğ°Ñ‡Ğ¸ Ğ°Ñ€ĞµĞ½Ğ´Ñ‹ #{rental.id}",
            rental_id=rental.id
        )

        await self.repo.delete(rental)
        logger.info(f"Manager {manager.id} reverted rental #{rental_id} to reservation #{reservation.id}")

    async def delete_rental_by_admin(self, rental_id: int):
        rental = await self.repo.get_rental_by_id_or_fail(rental_id)
        await self.repo.delete(rental)
        logger.warning(f"Admin deleted rental #{rental_id}")

```



## `api\services\order\order_query_base.py`


```python

# api/services/order/order_query_base.py

from sqlalchemy.ext.asyncio import AsyncSession
from sqlalchemy.orm import joinedload, selectinload
from sqlalchemy import or_, select, func, desc, asc
from typing import Optional, List, Tuple, TypeVar, Generic
from datetime import date
import logging

from api.models.user import User
from api.models.equipment import Equipment

logger = logging.getLogger(__name__)

T = TypeVar('T')  # Ğ¢Ğ¸Ğ¿ Ğ¼Ğ¾Ğ´ĞµĞ»Ğ¸ (Reservation Ğ¸Ğ»Ğ¸ Rental)

class OrderQueryBase(Generic[T]):
    """
    Ğ‘Ğ°Ğ·Ğ¾Ğ²Ñ‹Ğ¹ ĞºĞ»Ğ°ÑÑ Ğ´Ğ»Ñ Ğ¾Ğ±Ñ‰Ğ¸Ñ… Ğ¾Ğ¿ĞµÑ€Ğ°Ñ†Ğ¸Ğ¹ Ñ„Ğ¸Ğ»ÑŒÑ‚Ñ€Ğ°Ñ†Ğ¸Ğ¸, Ğ¿Ğ¾Ğ¸ÑĞºĞ° Ğ¸ ÑĞ¾Ñ€Ñ‚Ğ¸Ñ€Ğ¾Ğ²ĞºĞ¸ Ğ·Ğ°ĞºĞ°Ğ·Ğ¾Ğ².
    Ğ¡Ğ¾Ğ´ĞµÑ€Ğ¶Ğ¸Ñ‚ Ğ¾Ğ±Ñ‰ÑƒÑ Ğ»Ğ¾Ğ³Ğ¸ĞºÑƒ Ğ´Ğ»Ñ Ñ€ĞµĞ·ĞµÑ€Ğ²Ğ¾Ğ² Ğ¸ Ğ°Ñ€ĞµĞ½Ğ´.
    """

    def __init__(self, db: AsyncSession):
        self.db = db

    def _apply_user_search(self, query, search_term: str, model_class):
        """
        ĞŸÑ€Ğ¸Ğ¼ĞµĞ½ÑĞµÑ‚ Ğ¿Ğ¾Ğ¸ÑĞº Ğ¿Ğ¾ Ğ¸Ğ¼ĞµĞ½Ğ¸ Ğ¸Ğ»Ğ¸ email Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ñ.
        """
        search_pattern = f"%{search_term.lower()}%"
        # Ğ£Ğ±ĞµĞ¶Ğ´Ğ°ĞµĞ¼ÑÑ, Ñ‡Ñ‚Ğ¾ JOIN Ğº Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ñ ÑƒĞ¶Ğµ ĞµÑÑ‚ÑŒ Ğ¸Ğ»Ğ¸ Ğ´Ğ¾Ğ±Ğ°Ğ²Ğ»ÑĞµĞ¼ ĞµĞ³Ğ¾
        # Ğ’ Ğ½Ğ°ÑˆĞ¸Ñ… ÑĞ»ÑƒÑ‡Ğ°ÑÑ… Ğ¾Ğ½ Ğ²ÑĞµĞ³Ğ´Ğ° Ğ±ÑƒĞ´ĞµÑ‚, Ñ‚Ğ°Ğº ĞºĞ°Ğº Ğ¼Ñ‹ ĞµĞ³Ğ¾ Ğ´Ğ¾Ğ±Ğ°Ğ²Ğ»ÑĞµĞ¼ Ğ² Ğ±Ğ°Ğ·Ğ¾Ğ²Ñ‹Ñ… Ğ·Ğ°Ğ¿Ñ€Ğ¾ÑĞ°Ñ…
        query = query.join(model_class.user).filter(
            or_(
                User.full_name.ilike(search_pattern),
                User.email.ilike(search_pattern)
            )
        )
        return query

    def _apply_equipment_search(self, query, search_term: str, model_class):
        """
        ĞŸÑ€Ğ¸Ğ¼ĞµĞ½ÑĞµÑ‚ Ğ¿Ğ¾Ğ»Ğ½Ğ¾Ñ‚ĞµĞºÑÑ‚Ğ¾Ğ²Ñ‹Ğ¹ Ğ¿Ğ¾Ğ¸ÑĞº Ğ¿Ğ¾ ÑĞ²ÑĞ·Ğ°Ğ½Ğ½Ğ¾Ğ¼Ñƒ Ğ¾Ğ±Ğ¾Ñ€ÑƒĞ´Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ.
        Ğ˜Ñ‰ĞµÑ‚ Ğ¿Ğ¾ Ğ¿Ğ¾Ğ»ÑĞ¼ name, brand, equipment_type.
        """
        search_pattern = f"%{search_term.lower()}%"
        
        # ĞŸÑ€Ğ¸Ğ¼ĞµĞ½ÑĞµĞ¼ Ñ„Ğ¸Ğ»ÑŒÑ‚Ñ€ Ğ¿Ğ¾Ğ¸ÑĞºĞ° Ñ‡ĞµÑ€ĞµĞ· EXISTS Ğ¿Ğ¾Ğ´Ğ·Ğ°Ğ¿Ñ€Ğ¾Ñ
        # Ğ­Ñ‚Ğ¾ Ğ±Ğ¾Ğ»ĞµĞµ Ğ±ĞµĞ·Ğ¾Ğ¿Ğ°ÑĞ½Ñ‹Ğ¹ ÑĞ¿Ğ¾ÑĞ¾Ğ± Ğ´Ğ»Ñ ÑĞ²ÑĞ·Ğ°Ğ½Ğ½Ñ‹Ñ… Ñ‚Ğ°Ğ±Ğ»Ğ¸Ñ†
        equipment_subquery = select(Equipment.id).where(
            or_(
                Equipment.name.ilike(search_pattern),
                Equipment.brand.ilike(search_pattern),
                Equipment.equipment_type.ilike(search_pattern)
            )
        )
        
        # Ğ”Ğ¾Ğ±Ğ°Ğ²Ğ»ÑĞµĞ¼ Ñ„Ğ¸Ğ»ÑŒÑ‚Ñ€ Ñ‡ĞµÑ€ĞµĞ· EXISTS Ğ´Ğ»Ñ ÑĞ²ÑĞ·Ğ°Ğ½Ğ½Ğ¾Ğ³Ğ¾ Ğ¾Ğ±Ğ¾Ñ€ÑƒĞ´Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ
        query = query.filter(
            model_class.equipment.any(
                Equipment.id.in_(equipment_subquery)
            )
        )
        
        return query

    def _apply_status_filter(self, query, status_filter: Optional[str], model_class):
        """
        ĞŸÑ€Ğ¸Ğ¼ĞµĞ½ÑĞµÑ‚ Ñ„Ğ¸Ğ»ÑŒÑ‚Ñ€Ğ°Ñ†Ğ¸Ñ Ğ¿Ğ¾ ÑÑ‚Ğ°Ñ‚ÑƒÑÑƒ.
        """
        if not status_filter:
            return query
            
        today = date.today()
        
        if status_filter == "active":
            query = query.filter(model_class.status == 'active')
        elif status_filter == "completed":
            # Ğ”Ğ»Ñ Ñ€ĞµĞ·ĞµÑ€Ğ²Ğ¾Ğ²: fulfilled, cancelled, overdue
            # Ğ”Ğ»Ñ Ğ°Ñ€ĞµĞ½Ğ´: completed
            if hasattr(model_class, 'status') and 'fulfilled' in str(model_class.status):
                # Ğ­Ñ‚Ğ¾ Ñ€ĞµĞ·ĞµÑ€Ğ²
                query = query.filter(model_class.status.in_(['fulfilled', 'cancelled', 'overdue']))
            else:
                # Ğ­Ñ‚Ğ¾ Ğ°Ñ€ĞµĞ½Ğ´Ğ°
                query = query.filter(model_class.status == 'completed')
        elif status_filter == "overdue":
            query = query.filter(
                model_class.status == 'active',
                model_class.end_date < today
            )
            
        return query

    def _apply_sorting(self, query, sort_option: Optional[str], model_class):
        """
        ĞŸÑ€Ğ¸Ğ¼ĞµĞ½ÑĞµÑ‚ ÑĞ¾Ñ€Ñ‚Ğ¸Ñ€Ğ¾Ğ²ĞºÑƒ Ğ¿Ğ¾ Ñ€Ğ°Ğ·Ğ»Ğ¸Ñ‡Ğ½Ñ‹Ğ¼ Ğ¿Ğ¾Ğ»ÑĞ¼.
        ĞŸĞ¾Ğ´Ğ´ĞµÑ€Ğ¶Ğ¸Ğ²Ğ°ĞµĞ¼Ñ‹Ğµ Ğ¾Ğ¿Ñ†Ğ¸Ğ¸: id, start_date, end_date, count
        """
        if not sort_option:
            # Ğ¡Ğ¾Ñ€Ñ‚Ğ¸Ñ€Ğ¾Ğ²ĞºĞ° Ğ¿Ğ¾ ÑƒĞ¼Ğ¾Ğ»Ñ‡Ğ°Ğ½Ğ¸Ñ
            return query.order_by(model_class.id.desc())
        
        sort_parts = sort_option.split('_')
        field = sort_parts[0]
        direction = sort_parts[1] if len(sort_parts) > 1 else 'desc'
        
        # ĞĞ¿Ñ€ĞµĞ´ĞµĞ»ÑĞµĞ¼ Ğ½Ğ°Ğ¿Ñ€Ğ°Ğ²Ğ»ĞµĞ½Ğ¸Ğµ ÑĞ¾Ñ€Ñ‚Ğ¸Ñ€Ğ¾Ğ²ĞºĞ¸
        sort_func = desc if direction == 'desc' else asc
        
        if field == "id":
            query = query.order_by(sort_func(model_class.id))
        elif field == "start_date":
            query = query.order_by(sort_func(model_class.start_date))
        elif field == "end_date":
            query = query.order_by(sort_func(model_class.end_date))
        elif field == "count":
            # Ğ¡Ğ¾Ñ€Ñ‚Ğ¸Ñ€Ğ¾Ğ²ĞºĞ° Ğ¿Ğ¾ ĞºĞ¾Ğ»Ğ¸Ñ‡ĞµÑÑ‚Ğ²Ñƒ Ğ¾Ğ±Ğ¾Ñ€ÑƒĞ´Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ
            # Ğ”Ğ»Ñ ÑÑ‚Ğ¾Ğ³Ğ¾ Ğ½ÑƒĞ¶Ğ½Ğ¾ Ğ¿Ğ¾Ğ´ÑÑ‡Ğ¸Ñ‚Ğ°Ñ‚ÑŒ ĞºĞ¾Ğ»Ğ¸Ñ‡ĞµÑÑ‚Ğ²Ğ¾ ÑĞ²ÑĞ·Ğ°Ğ½Ğ½Ğ¾Ğ³Ğ¾ Ğ¾Ğ±Ğ¾Ñ€ÑƒĞ´Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ
            equipment_count = select(func.count()).select_from(
                model_class.equipment.property.mapper.class_.__table__
            ).where(
                model_class.equipment.property.mapper.class_.id.in_(
                    select(model_class.equipment.property.mapper.class_.id)
                    .where(model_class.id == model_class.id)
                )
            ).scalar_subquery()
            
            query = query.order_by(sort_func(equipment_count))
        else:
            # ĞĞµĞ¸Ğ·Ğ²ĞµÑÑ‚Ğ½Ğ¾Ğµ Ğ¿Ğ¾Ğ»Ğµ - Ğ¸ÑĞ¿Ğ¾Ğ»ÑŒĞ·ÑƒĞµĞ¼ ÑĞ¾Ñ€Ñ‚Ğ¸Ñ€Ğ¾Ğ²ĞºÑƒ Ğ¿Ğ¾ ÑƒĞ¼Ğ¾Ğ»Ñ‡Ğ°Ğ½Ğ¸Ñ
            query = query.order_by(model_class.id.desc())
            
        return query

    def _apply_pagination(self, query, skip: int, limit: int):
        """
        ĞŸÑ€Ğ¸Ğ¼ĞµĞ½ÑĞµÑ‚ Ğ¿Ğ°Ğ³Ğ¸Ğ½Ğ°Ñ†Ğ¸Ñ Ğº Ğ·Ğ°Ğ¿Ñ€Ğ¾ÑÑƒ.
        """
        return query.offset(skip).limit(limit)

    async def _get_total_count(self, base_query) -> int:
        """
        ĞŸĞ¾Ğ»ÑƒÑ‡Ğ°ĞµÑ‚ Ğ¾Ğ±Ñ‰ĞµĞµ ĞºĞ¾Ğ»Ğ¸Ñ‡ĞµÑÑ‚Ğ²Ğ¾ Ğ·Ğ°Ğ¿Ğ¸ÑĞµĞ¹ Ğ´Ğ»Ñ Ğ±Ğ°Ğ·Ğ¾Ğ²Ğ¾Ğ³Ğ¾ Ğ·Ğ°Ğ¿Ñ€Ğ¾ÑĞ°.
        """
        count_query = select(func.count()).select_from(base_query.subquery())
        result = await self.db.execute(count_query)
        return result.scalar_one()

    def _get_equipment_joins(self):
        """
        Ğ’Ğ¾Ğ·Ğ²Ñ€Ğ°Ñ‰Ğ°ĞµÑ‚ ÑÑ‚Ğ°Ğ½Ğ´Ğ°Ñ€Ñ‚Ğ½Ñ‹Ğµ JOIN'Ñ‹ Ğ´Ğ»Ñ Ğ¾Ğ±Ğ¾Ñ€ÑƒĞ´Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ.
        ĞŸĞµÑ€ĞµĞ¾Ğ¿Ñ€ĞµĞ´ĞµĞ»ÑĞµÑ‚ÑÑ Ğ² Ğ½Ğ°ÑĞ»ĞµĞ´Ğ½Ğ¸ĞºĞ°Ñ… Ğ´Ğ»Ñ ÑĞ¿ĞµÑ†Ğ¸Ñ„Ğ¸Ñ‡Ğ½Ñ‹Ñ… Ğ¼Ğ¾Ğ´ĞµĞ»ĞµĞ¹.
        """
        return [
            selectinload(Equipment.accessories),
            selectinload(Equipment.associations)
        ]

```



## `api\services\order\order_repository.py`


```python

# api/services/order/order_repository.py

from sqlalchemy.ext.asyncio import AsyncSession
from sqlalchemy.orm import joinedload, selectinload
from sqlalchemy import select
from datetime import date
from typing import Optional, List, Dict
import logging

from fastapi import HTTPException, status
from api.models.user import User
from api.models.equipment import Equipment
from api.models.promo_code import PromoCode
from api.models.holiday import Holiday
from api.models.reservation import Reservation, ReservationAccessory
from api.models.rental import Rental, RentalAccessory
from api.services.financial_service import FinancialService, PriceDetails

logger = logging.getLogger(__name__)

class OrderRepository:
    """
    Ğ¡Ğ»Ğ¾Ğ¹ Ğ´Ğ¾ÑÑ‚ÑƒĞ¿Ğ° Ğº Ğ´Ğ°Ğ½Ğ½Ñ‹Ğ¼ Ğ´Ğ»Ñ ÑÑƒÑ‰Ğ½Ğ¾ÑÑ‚ĞµĞ¹, ÑĞ²ÑĞ·Ğ°Ğ½Ğ½Ñ‹Ñ… Ñ Ğ·Ğ°ĞºĞ°Ğ·Ğ°Ğ¼Ğ¸ (Ğ ĞµĞ·ĞµÑ€Ğ²Ñ‹ Ğ¸ ĞÑ€ĞµĞ½Ğ´Ñ‹).
    Ğ˜Ğ½ĞºĞ°Ğ¿ÑÑƒĞ»Ğ¸Ñ€ÑƒĞµÑ‚ Ğ²ÑĞµ Ğ¿Ñ€ÑĞ¼Ñ‹Ğµ Ğ·Ğ°Ğ¿Ñ€Ğ¾ÑÑ‹ Ğº Ğ±Ğ°Ğ·Ğµ Ğ´Ğ°Ğ½Ğ½Ñ‹Ñ….
    """
    def __init__(self, db: AsyncSession):
        self.db = db
        self.financial_service = FinancialService(db)

    async def get_user_by_id_or_fail(self, user_id: int) -> User:
        user = await self.db.get(User, user_id)
        if not user:
            raise HTTPException(status_code=status.HTTP_404_NOT_FOUND, detail=f"User with ID {user_id} not found.")
        return user

    async def get_equipment_by_ids_or_fail(self, equipment_ids: List[int]) -> List[Equipment]:
        result = await self.db.execute(
            select(Equipment)
            .filter(Equipment.id.in_(equipment_ids))
            .options(
                selectinload(Equipment.accessories),
                selectinload(Equipment.associations)
            )
        )
        equipment = result.unique().scalars().all()
        if len(equipment) != len(set(equipment_ids)):
            found_ids = {eq.id for eq in equipment}
            missing_ids = set(equipment_ids) - found_ids
            raise HTTPException(status_code=status.HTTP_404_NOT_FOUND, detail=f"Equipment with IDs {list(missing_ids)} not found.")
        return equipment

    async def get_promo_code_by_name(self, code: str) -> Optional[PromoCode]:
        result = await self.db.execute(select(PromoCode).filter(PromoCode.code == code))
        return result.unique().scalar_one_or_none()

    async def get_reservation_by_id_or_fail(self, reservation_id: int, user_id: Optional[int] = None) -> Reservation:
        # Ğ˜ÑĞ¿Ğ¾Ğ»ÑŒĞ·ÑƒĞµĞ¼ db.get Ğ´Ğ»Ñ Ğ¿Ñ€Ğ¾ÑÑ‚Ğ¾Ğ³Ğ¾ Ğ¸ ÑÑ„Ñ„ĞµĞºÑ‚Ğ¸Ğ²Ğ½Ğ¾Ğ³Ğ¾ Ğ¿Ğ¾Ğ»ÑƒÑ‡ĞµĞ½Ğ¸Ñ Ğ¿Ğ¾ PK
        reservation = await self.db.get(Reservation, reservation_id, options=[
            joinedload(Reservation.user),
            selectinload(Reservation.equipment).options(
                selectinload(Equipment.accessories),
                selectinload(Equipment.associations)
            ),
            joinedload(Reservation.accessory_links).joinedload(ReservationAccessory.accessory),
            joinedload(Reservation.rental)
        ])

        if not reservation:
            raise HTTPException(status_code=status.HTTP_404_NOT_FOUND, detail=f"Reservation with ID {reservation_id} not found")

        if user_id and reservation.user_id != user_id:
            raise HTTPException(status_code=status.HTTP_404_NOT_FOUND, detail="Reservation not found or you do not have permission to access it.")

        return reservation

    async def get_reservations_by_ids(self, ids: List[int]) -> List[Reservation]:
        result = await self.db.execute(select(Reservation).filter(Reservation.id.in_(ids)).options(joinedload(Reservation.rental)))
        return result.unique().scalars().all()

    async def get_rental_by_id_or_fail(self, rental_id: int) -> Rental:
        query = select(Rental).options(
            joinedload(Rental.user),
            selectinload(Rental.equipment).options(
                selectinload(Equipment.accessories),
                selectinload(Equipment.associations)
            ),
            joinedload(Rental.reservation),
            joinedload(Rental.accessory_links).joinedload(RentalAccessory.accessory)
        ).filter(Rental.id == rental_id)

        result = await self.db.execute(query)
        rental = result.unique().scalar_one_or_none()

        if not rental:
            raise HTTPException(status_code=status.HTTP_404_NOT_FOUND, detail=f"Rental with ID {rental_id} not found.")
        return rental

    async def is_holiday(self, check_date: date) -> bool:
        result = await self.db.execute(select(Holiday).filter(Holiday.date == check_date))
        return result.scalar_one_or_none() is not None

    async def get_rental_days_count(self, start_date: date, end_date: date) -> int:
        return await self.financial_service.get_rental_days(start_date, end_date)

    def create_reservation_instance(self, user_id: int, start_date: date, end_date: date, equipment: List[Equipment], price_details: PriceDetails, promo_code_id: Optional[int]) -> Reservation:
        return Reservation(
            user_id=user_id,
            start_date=start_date,
            end_date=end_date,
            equipment=equipment,
            total_cost=price_details.final_total,
            discount_amount=price_details.discount_amount,
            promo_code_id=promo_code_id
        )

    def update_reservation_instance(self, reservation: Reservation, start_date: date, end_date: date, equipment: List[Equipment], price_details: PriceDetails, promo_code_id: Optional[int]):
        reservation.start_date = start_date
        reservation.end_date = end_date
        reservation.equipment = equipment
        reservation.total_cost = price_details.final_total
        reservation.discount_amount = price_details.discount_amount
        reservation.promo_code_id = promo_code_id

    def add_accessories_to_reservation(self, reservation: Reservation, selected_accessories: Optional[Dict[int, List[int]]]):
        if not selected_accessories:
            return
        links = []
        for eq_id, acc_ids in selected_accessories.items():
            for acc_id in acc_ids:
                links.append(ReservationAccessory(equipment_id=eq_id, accessory_id=acc_id))
        reservation.accessory_links = links

    async def update_accessories_for_reservation(self, reservation: Reservation, selected_accessories: Optional[Dict[int, List[int]]]):
        reservation.accessory_links.clear()
        await self.db.flush()
        self.add_accessories_to_reservation(reservation, selected_accessories)

    def create_rental_from_reservation(self, reservation: Reservation, manager: User, deposit: float, notes: Optional[str], recalculated_cost: float, recalculated_discount: float, prepayment_amount: float = 0.0) -> Rental:
        reservation.status = 'fulfilled'
        rental = Rental(
            user_id=reservation.user_id,
            created_by_id=manager.id,
            reservation_id=reservation.id,
            equipment=reservation.equipment,
            start_date=date.today(),
            end_date=reservation.end_date,
            # Ğ˜ÑĞ¿Ğ¾Ğ»ÑŒĞ·ÑƒĞµĞ¼ Ğ½Ğ¾Ğ²Ñ‹Ğµ, Ğ¿ĞµÑ€ĞµÑÑ‡Ğ¸Ñ‚Ğ°Ğ½Ğ½Ñ‹Ğµ Ğ·Ğ½Ğ°Ñ‡ĞµĞ½Ğ¸Ñ
            total_cost=recalculated_cost,
            discount_amount=recalculated_discount,
            promo_code=reservation.promo_code,
            deposit_amount=deposit,
            prepayment_amount=prepayment_amount,
            notes_on_issue=notes
        )

        if reservation.accessory_links:
            accessory_ids = [link.accessory_id for link in reservation.accessory_links]
            logger.info(f"Ğ¢ĞĞ§ĞšĞ 1 (ĞšĞĞŸĞ˜Ğ ĞĞ’ĞĞĞ˜Ğ•): Ğ ĞµĞ·ĞµÑ€Ğ² #{reservation.id} Ğ¸Ğ¼ĞµĞµÑ‚ Ğ°ĞºÑĞµÑÑÑƒĞ°Ñ€Ñ‹ Ñ ID: {accessory_ids}")
            for link in reservation.accessory_links:
                rental.accessory_links.append(
                    RentalAccessory(equipment_id=link.equipment_id, accessory_id=link.accessory_id)
                )
            copied_ids = [link.accessory_id for link in rental.accessory_links]
            logger.info(f"Ğ¢ĞĞ§ĞšĞ 1 (ĞšĞĞŸĞ˜Ğ ĞĞ’ĞĞĞ˜Ğ•): Ğ’ Ğ¾Ğ±ÑŠĞµĞºÑ‚ Ğ°Ñ€ĞµĞ½Ğ´Ñ‹ (Ğ² Ğ¿Ğ°Ğ¼ÑÑ‚Ğ¸) ÑĞºĞ¾Ğ¿Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ñ‹ Ğ°ĞºÑĞµÑÑÑƒĞ°Ñ€Ñ‹ Ñ ID: {copied_ids}")
        else:
            logger.warning(f"Ğ¢ĞĞ§ĞšĞ 1 (ĞšĞĞŸĞ˜Ğ ĞĞ’ĞĞĞ˜Ğ•): Ğ’ Ğ¸ÑÑ…Ğ¾Ğ´Ğ½Ğ¾Ğ¼ Ñ€ĞµĞ·ĞµÑ€Ğ²Ğµ #{reservation.id} Ğ°ĞºÑĞµÑÑÑƒĞ°Ñ€Ñ‹ Ğ½Ğµ Ğ½Ğ°Ğ¹Ğ´ĞµĞ½Ñ‹.")

        return rental

    def create_rental_instance(self, user: User, manager: User, start_date: date, end_date: date, equipment: List[Equipment], total_cost: float, deposit_amount: float, notes_on_issue: Optional[str]) -> Rental:
        return Rental(
            user_id=user.id,
            created_by_id=manager.id,
            equipment=equipment,
            start_date=start_date,
            end_date=end_date,
            total_cost=total_cost,
            deposit_amount=deposit_amount,
            notes_on_issue=notes_on_issue
        )

    async def calculate_early_return_credit(self, rental: Rental, actual_return_date: date, planned_days: int) -> float:
        """
        Ğ Ğ°ÑÑÑ‡Ğ¸Ñ‚Ñ‹Ğ²Ğ°ĞµÑ‚ ĞºÑ€ĞµĞ´Ğ¸Ñ‚ Ğ·Ğ° Ğ´Ğ¾ÑÑ€Ğ¾Ñ‡Ğ½Ñ‹Ğ¹ Ğ²Ğ¾Ğ·Ğ²Ñ€Ğ°Ñ‚ Ğ°Ñ€ĞµĞ½Ğ´Ñ‹.
        Ğ”ĞµĞ»ĞµĞ³Ğ¸Ñ€ÑƒĞµÑ‚ Ñ€Ğ°ÑÑ‡ĞµÑ‚ Ğ² FinancialService Ğ´Ğ»Ñ ÑĞ¾Ğ±Ğ»ÑĞ´ĞµĞ½Ğ¸Ñ Ğ¿Ñ€Ğ¸Ğ½Ñ†Ğ¸Ğ¿Ğ° DRY.
        """
        return await self.financial_service.calculate_early_return_credit(rental, actual_return_date, planned_days)

    async def calculate_overdue_surcharge(self, rental: Rental, actual_return_date: date) -> float:
        """
        Ğ Ğ°ÑÑÑ‡Ğ¸Ñ‚Ñ‹Ğ²Ğ°ĞµÑ‚ ÑˆÑ‚Ñ€Ğ°Ñ„ Ğ·Ğ° Ğ¿Ñ€Ğ¾ÑÑ€Ğ¾Ñ‡ĞµĞ½Ğ½Ñ‹Ğµ Ğ´Ğ½Ğ¸ Ğ°Ñ€ĞµĞ½Ğ´Ñ‹.
        Ğ”ĞµĞ»ĞµĞ³Ğ¸Ñ€ÑƒĞµÑ‚ Ñ€Ğ°ÑÑ‡ĞµÑ‚ Ğ² FinancialService Ğ´Ğ»Ñ ÑĞ¾Ğ±Ğ»ÑĞ´ĞµĞ½Ğ¸Ñ Ğ¿Ñ€Ğ¸Ğ½Ñ†Ğ¸Ğ¿Ğ° DRY.
        """
        return await self.financial_service.calculate_overdue_surcharge(rental, actual_return_date)

    def finalize_rental_return(self, rental: Rental, return_date: date, notes: Optional[str], credit: float, surcharge: float = 0.0):
        rental.status = 'completed'
        rental.actual_return_date = return_date
        rental.notes_on_return = notes
        rental.final_cost = rental.total_cost - credit + surcharge

    def update_rental_instance(self, rental: Rental, update_data: dict):
        for key, value in update_data.items():
            setattr(rental, key, value)

    def revert_rental_status_to_active(self, rental: Rental) -> Reservation:
        reservation = rental.reservation
        reservation.status = 'active'
        return reservation

    async def save(self, instance: object):
        if isinstance(instance, Rental) and instance.accessory_links:
            accessory_ids = [link.accessory_id for link in instance.accessory_links]
            logger.info(f"Ğ¢ĞĞ§ĞšĞ 2 (Ğ¡ĞĞ¥Ğ ĞĞĞ•ĞĞ˜Ğ•): ĞŸĞµÑ€ĞµĞ´ ĞºĞ¾Ğ¼Ğ¼Ğ¸Ñ‚Ğ¾Ğ¼ Ğ°Ñ€ĞµĞ½Ğ´Ğ° #{instance.id} Ğ¸Ğ¼ĞµĞµÑ‚ Ğ°ĞºÑĞµÑÑÑƒĞ°Ñ€Ñ‹ Ñ ID: {accessory_ids}")
        try:
            self.db.add(instance)
            await self.db.commit()
            await self.db.refresh(instance)
        except Exception as e:
            await self.db.rollback()
            raise HTTPException(status_code=status.HTTP_500_INTERNAL_SERVER_ERROR, detail=f"Database error: {e}")

    async def delete(self, instance: object):
        try:
            await self.db.delete(instance)
            await self.db.commit()
        except Exception as e:
            await self.db.rollback()
            raise HTTPException(status_code=status.HTTP_500_INTERNAL_SERVER_ERROR, detail=f"Database error on delete: {e}")

```



## `api\services\order\order_validator.py`


```python

# api/services/order/order_validator.py

from sqlalchemy.ext.asyncio import AsyncSession
from sqlalchemy import select
from datetime import date
from typing import List, Optional, Dict, Tuple

from fastapi import HTTPException, status
from api.models.reservation import Reservation
from api.models.rental import Rental
# +++ 1. Ğ”ĞĞ‘ĞĞ’Ğ¬Ğ¢Ğ• Ğ­Ğ¢ĞĞ¢ Ğ˜ĞœĞŸĞĞ Ğ¢ +++
from api.models.holiday import Holiday
# ---------------------------------
from api.services.availability import AvailabilityService
from api.services.financial_service import FinancialService

class OrderValidator:
    """
    Ğ¡Ğ»Ğ¾Ğ¹ Ğ´Ğ»Ñ Ğ²Ğ°Ğ»Ğ¸Ğ´Ğ°Ñ†Ğ¸Ğ¸ Ğ±Ğ¸Ğ·Ğ½ĞµÑ-Ğ¿Ñ€Ğ°Ğ²Ğ¸Ğ», ÑĞ²ÑĞ·Ğ°Ğ½Ğ½Ñ‹Ñ… Ñ Ğ ĞµĞ·ĞµÑ€Ğ²Ğ°Ğ¼Ğ¸ Ğ¸ ĞÑ€ĞµĞ½Ğ´Ğ°Ğ¼Ğ¸.
    """
    def __init__(self, db: AsyncSession):
        self.db = db
        self.financial_service = FinancialService(db)
        self.availability_service = AvailabilityService(db)

    async def validate_dates_and_holidays(self, start_date: date, end_date: date):
        self.financial_service.validate_date_range(start_date, end_date)
        await self.financial_service.validate_holidays(start_date, end_date)

    async def validate_equipment_availability(self, equipment_ids: list[int], start_date: date, end_date: date, exclude_reservation_id: Optional[int] = None):
        conflicting_ids = await self.availability_service.get_conflicting_equipment_ids(
            equipment_ids, start_date, end_date, exclude_reservation_id
        )
        if conflicting_ids:
            raise HTTPException(
                status_code=status.HTTP_409_CONFLICT,
                detail=f"Equipment with IDs {conflicting_ids} is unavailable for the selected period."
            )

    def validate_accessories_for_equipment(self, selected_accessories: Optional[Dict[int, List[int]]], equipment_ids: List[int]):
        if not selected_accessories:
            return

        accessory_eq_ids = set(selected_accessories.keys())
        if not accessory_eq_ids.issubset(set(equipment_ids)):
            missing_eq_ids = accessory_eq_ids - set(equipment_ids)
            raise HTTPException(status_code=status.HTTP_400_BAD_REQUEST, detail=f"Accessories cannot be selected for equipment not in the reservation. Invalid equipment IDs: {list(missing_eq_ids)}")

    def validate_reservation_is_cancellable(self, reservation: Reservation):
        if reservation.rental:
            raise HTTPException(status_code=status.HTTP_409_CONFLICT, detail=f"Cannot cancel reservation as it has been converted to rental #{reservation.rental.id}.")

    def filter_cancellable_reservations(self, reservations: List[Reservation]) -> Tuple[List[Reservation], List[Reservation]]:
        cancellable = [r for r in reservations if not r.rental]
        not_cancellable = [r for r in reservations if r.rental]
        return cancellable, not_cancellable

    def validate_reservation_for_conversion(self, reservation: Reservation):
        if reservation.status != 'active':
            raise HTTPException(status_code=status.HTTP_409_CONFLICT, detail="Reservation is already fulfilled or cancelled.")
        if reservation.rental:
            raise HTTPException(status_code=status.HTTP_409_CONFLICT, detail=f"Reservation has already been converted to rental #{reservation.rental.id}.")

    async def validate_issue_on_holiday(self, issue_date: date, force: bool):
        # +++ 2. Ğ˜Ğ¡ĞŸĞ ĞĞ’Ğ¬Ğ¢Ğ• Ğ­Ğ¢Ğ£ Ğ¡Ğ¢Ğ ĞĞšĞ£ +++
        result = await self.db.execute(select(Holiday).filter(Holiday.date == issue_date))
        is_holiday = result.scalar_one_or_none()
        # --------------------------------
        if is_holiday and not force:
            raise HTTPException(
                status_code=status.HTTP_409_CONFLICT,
                detail={
                    "error_type": "ISSUE_ON_HOLIDAY",
                    "message": f"Issue date ({issue_date.strftime('%d.%m.%Y')}) is a holiday. Confirm action."
                }
            )

    def validate_accessories_returned(self, rental: Rental, confirmation: bool):
        if rental.accessory_links and not confirmation:
            raise HTTPException(status_code=status.HTTP_400_BAD_REQUEST, detail="Confirmation of all accessories return is required.")

    def validate_rental_for_revert(self, rental: Rental):
        if not rental.reservation_id:
            raise HTTPException(status_code=status.HTTP_400_BAD_REQUEST, detail="Cannot revert a rental created without a reservation.")
        if rental.created_at.date() != date.today():
            raise HTTPException(status_code=status.HTTP_403_FORBIDDEN, detail="Reverting is only possible on the day of creation.")

```



## `api\services\promo_code\constants.py`


```python

# api/services/promo_code/constants.py

from fastapi import status

# Ğ¡Ğ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ñ Ğ¾Ğ± Ğ¾ÑˆĞ¸Ğ±ĞºĞ°Ñ…
ERROR_MESSAGES = {
    'NOT_FOUND': 'ĞŸÑ€Ğ¾Ğ¼Ğ¾ĞºĞ¾Ğ´ Ğ½Ğµ Ğ½Ğ°Ğ¹Ğ´ĞµĞ½',
    'INACTIVE': 'ĞŸÑ€Ğ¾Ğ¼Ğ¾ĞºĞ¾Ğ´ Ğ½ĞµĞ°ĞºÑ‚Ğ¸Ğ²ĞµĞ½',
    'NOT_STARTED': 'ĞŸÑ€Ğ¾Ğ¼Ğ¾ĞºĞ¾Ğ´ ĞµÑ‰Ğµ Ğ½Ğµ Ğ½Ğ°Ñ‡Ğ°Ğ» Ğ´ĞµĞ¹ÑÑ‚Ğ²Ğ¾Ğ²Ğ°Ñ‚ÑŒ',
    'EXPIRED': 'Ğ¡Ñ€Ğ¾Ğº Ğ´ĞµĞ¹ÑÑ‚Ğ²Ğ¸Ñ Ğ¿Ñ€Ğ¾Ğ¼Ğ¾ĞºĞ¾Ğ´Ğ° Ğ¸ÑÑ‚ĞµĞº',
    'USAGE_LIMIT_EXCEEDED': 'Ğ›Ğ¸Ğ¼Ğ¸Ñ‚ Ğ¸ÑĞ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğ¹ ÑÑ‚Ğ¾Ğ³Ğ¾ Ğ¿Ñ€Ğ¾Ğ¼Ğ¾ĞºĞ¾Ğ´Ğ° Ğ¸ÑÑ‡ĞµÑ€Ğ¿Ğ°Ğ½',
    'MIN_ORDER_AMOUNT': 'ĞœĞ¸Ğ½Ğ¸Ğ¼Ğ°Ğ»ÑŒĞ½Ğ°Ñ ÑÑƒĞ¼Ğ¼Ğ° Ğ·Ğ°ĞºĞ°Ğ·Ğ° Ğ´Ğ»Ñ ÑÑ‚Ğ¾Ğ³Ğ¾ ĞºĞ¾Ğ´Ğ°: {amount} â‚½',
    'INVALID_EQUIPMENT': 'ĞŸÑ€Ğ¾Ğ¼Ğ¾ĞºĞ¾Ğ´ Ğ½Ğµ Ğ´ĞµĞ¹ÑÑ‚Ğ²ÑƒĞµÑ‚ Ğ½Ğ° Ğ²Ñ‹Ğ±Ñ€Ğ°Ğ½Ğ½Ñ‹Ğµ Ñ‚Ğ¾Ğ²Ğ°Ñ€Ñ‹',
    'INVALID_EQUIPMENT_TYPE': 'ĞŸÑ€Ğ¾Ğ¼Ğ¾ĞºĞ¾Ğ´ Ğ½Ğµ Ğ´ĞµĞ¹ÑÑ‚Ğ²ÑƒĞµÑ‚ Ğ½Ğ° Ğ²Ñ‹Ğ±Ñ€Ğ°Ğ½Ğ½Ñ‹Ğµ ĞºĞ°Ñ‚ĞµĞ³Ğ¾Ñ€Ğ¸Ğ¸ Ñ‚Ğ¾Ğ²Ğ°Ñ€Ğ¾Ğ²',
    'PERSONAL_CODE_FORBIDDEN': 'Ğ­Ñ‚Ğ¾ Ğ¿ĞµÑ€ÑĞ¾Ğ½Ğ°Ğ»ÑŒĞ½Ñ‹Ğ¹ Ğ¿Ñ€Ğ¾Ğ¼Ğ¾ĞºĞ¾Ğ´ Ğ´Ğ»Ñ Ğ´Ñ€ÑƒĞ³Ğ¾Ğ³Ğ¾ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ñ',
    'USER_USAGE_LIMIT': 'Ğ’Ñ‹ ÑƒĞ¶Ğµ Ğ¸ÑĞ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ğ»Ğ¸ ÑÑ‚Ğ¾Ñ‚ Ğ¿Ñ€Ğ¾Ğ¼Ğ¾ĞºĞ¾Ğ´ Ğ¼Ğ°ĞºÑĞ¸Ğ¼Ğ°Ğ»ÑŒĞ½Ğ¾Ğµ ĞºĞ¾Ğ»Ğ¸Ñ‡ĞµÑÑ‚Ğ²Ğ¾ Ñ€Ğ°Ğ·',
    'CODE_EXISTS': 'ĞŸÑ€Ğ¾Ğ¼Ğ¾ĞºĞ¾Ğ´ Ñ Ñ‚Ğ°ĞºĞ¸Ğ¼ ĞºĞ¾Ğ´Ğ¾Ğ¼ ÑƒĞ¶Ğµ ÑÑƒÑ‰ĞµÑÑ‚Ğ²ÑƒĞµÑ‚',
    'EQUIPMENT_NOT_FOUND': 'ĞĞ´Ğ½Ğ¾ Ğ¸Ğ»Ğ¸ Ğ½ĞµÑĞºĞ¾Ğ»ÑŒĞºĞ¾ Ğ¾Ğ±Ğ¾Ñ€ÑƒĞ´Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğ¹ Ğ´Ğ»Ñ Ğ¿Ñ€Ğ¾Ğ¼Ğ¾ĞºĞ¾Ğ´Ğ° Ğ½Ğµ Ğ½Ğ°Ğ¹Ğ´ĞµĞ½Ñ‹.',
    'MANAGER_DISCOUNT_LIMIT': 'ĞœĞµĞ½ĞµĞ´Ğ¶ĞµÑ€Ñ‹ Ğ½Ğµ Ğ¼Ğ¾Ğ³ÑƒÑ‚ ÑĞ¾Ğ·Ğ´Ğ°Ğ²Ğ°Ñ‚ÑŒ ÑĞºĞ¸Ğ´ĞºÑƒ Ğ±Ğ¾Ğ»ĞµĞµ 20%',
    'ADMIN_DISCOUNT_LIMIT': 'ĞĞ´Ğ¼Ğ¸Ğ½Ğ¸ÑÑ‚Ñ€Ğ°Ñ‚Ğ¾Ñ€Ñ‹ Ğ½Ğµ Ğ¼Ğ¾Ğ³ÑƒÑ‚ ÑĞ¾Ğ·Ğ´Ğ°Ğ²Ğ°Ñ‚ÑŒ ÑĞºĞ¸Ğ´ĞºÑƒ Ğ±Ğ¾Ğ»ĞµĞµ 50%'
}

# ĞšĞ¾Ğ´Ñ‹ ÑÑ‚Ğ°Ñ‚ÑƒÑĞ¾Ğ² HTTP
HTTP_STATUS_CODES = {
    'NOT_FOUND': status.HTTP_404_NOT_FOUND,
    'BAD_REQUEST': status.HTTP_400_BAD_REQUEST,
    'FORBIDDEN': status.HTTP_403_FORBIDDEN,
    'CONFLICT': status.HTTP_409_CONFLICT
}

# Ğ›Ğ¸Ğ¼Ğ¸Ñ‚Ñ‹ ÑĞºĞ¸Ğ´Ğ¾Ğº Ğ¿Ğ¾ Ñ€Ğ¾Ğ»ÑĞ¼
DISCOUNT_LIMITS = {
    'manager': 20,
    'admin': 50
}

# ĞœĞ°ĞºÑĞ¸Ğ¼Ğ°Ğ»ÑŒĞ½Ñ‹Ğ¹ ĞºĞ¾Ğ¼Ğ±Ğ¸Ğ½Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ½Ñ‹Ğ¹ Ğ¿Ñ€Ğ¾Ñ†ĞµĞ½Ñ‚ ÑĞºĞ¸Ğ´ĞºĞ¸
MAX_COMBINED_DISCOUNT = 75 

```



## `api\services\promo_code\exceptions.py`


```python

# api/services/promo_code/exceptions.py

from fastapi import HTTPException
from .constants import ERROR_MESSAGES, HTTP_STATUS_CODES


class PromoCodeException(HTTPException):
    """Ğ‘Ğ°Ğ·Ğ¾Ğ²Ğ¾Ğµ Ğ¸ÑĞºĞ»ÑÑ‡ĞµĞ½Ğ¸Ğµ Ğ´Ğ»Ñ Ğ¿Ñ€Ğ¾Ğ¼Ğ¾ĞºĞ¾Ğ´Ğ¾Ğ²"""
    pass


class PromoCodeNotFoundError(PromoCodeException):
    def __init__(self):
        super().__init__(
            status_code=HTTP_STATUS_CODES['NOT_FOUND'],
            detail=ERROR_MESSAGES['NOT_FOUND']
        )


class PromoCodeInactiveError(PromoCodeException):
    def __init__(self):
        super().__init__(
            status_code=HTTP_STATUS_CODES['BAD_REQUEST'],
            detail=ERROR_MESSAGES['INACTIVE']
        )


class PromoCodeNotStartedError(PromoCodeException):
    def __init__(self):
        super().__init__(
            status_code=HTTP_STATUS_CODES['BAD_REQUEST'],
            detail=ERROR_MESSAGES['NOT_STARTED']
        )


class PromoCodeExpiredError(PromoCodeException):
    def __init__(self):
        super().__init__(
            status_code=HTTP_STATUS_CODES['BAD_REQUEST'],
            detail=ERROR_MESSAGES['EXPIRED']
        )


class PromoCodeUsageLimitExceededError(PromoCodeException):
    def __init__(self):
        super().__init__(
            status_code=HTTP_STATUS_CODES['BAD_REQUEST'],
            detail=ERROR_MESSAGES['USAGE_LIMIT_EXCEEDED']
        )


class PromoCodeMinOrderAmountError(PromoCodeException):
    def __init__(self, min_amount: float):
        super().__init__(
            status_code=HTTP_STATUS_CODES['BAD_REQUEST'],
            detail=ERROR_MESSAGES['MIN_ORDER_AMOUNT'].format(amount=min_amount)
        )


class PromoCodeInvalidEquipmentError(PromoCodeException):
    def __init__(self):
        super().__init__(
            status_code=HTTP_STATUS_CODES['BAD_REQUEST'],
            detail=ERROR_MESSAGES['INVALID_EQUIPMENT']
        )


class PromoCodeInvalidEquipmentTypeError(PromoCodeException):
    def __init__(self):
        super().__init__(
            status_code=HTTP_STATUS_CODES['BAD_REQUEST'],
            detail=ERROR_MESSAGES['INVALID_EQUIPMENT_TYPE']
        )


class PromoCodePersonalCodeForbiddenError(PromoCodeException):
    def __init__(self):
        super().__init__(
            status_code=HTTP_STATUS_CODES['FORBIDDEN'],
            detail=ERROR_MESSAGES['PERSONAL_CODE_FORBIDDEN']
        )


class PromoCodeUserUsageLimitError(PromoCodeException):
    def __init__(self):
        super().__init__(
            status_code=HTTP_STATUS_CODES['BAD_REQUEST'],
            detail=ERROR_MESSAGES['USER_USAGE_LIMIT']
        )


class PromoCodeExistsError(PromoCodeException):
    def __init__(self):
        super().__init__(
            status_code=HTTP_STATUS_CODES['CONFLICT'],
            detail=ERROR_MESSAGES['CODE_EXISTS']
        )


class PromoCodeEquipmentNotFoundError(PromoCodeException):
    def __init__(self):
        super().__init__(
            status_code=HTTP_STATUS_CODES['NOT_FOUND'],
            detail=ERROR_MESSAGES['EQUIPMENT_NOT_FOUND']
        )


class PromoCodeDiscountLimitError(PromoCodeException):
    def __init__(self, role: str):
        message_key = f'{role.upper()}_DISCOUNT_LIMIT'
        super().__init__(
            status_code=HTTP_STATUS_CODES['FORBIDDEN'],
            detail=ERROR_MESSAGES[message_key]
        ) 

```



## `api\services\promo_code\factory.py`


```python

# api/services/promo_code/factory.py

from sqlalchemy.ext.asyncio import AsyncSession
from .promo_code_validator import PromoCodeValidator
from .promo_code_manager import PromoCodeManager
from .promo_code_business_logic import PromoCodeBusinessLogic


class PromoCodeServiceFactory:
    """Ğ¤Ğ°Ğ±Ñ€Ğ¸ĞºĞ° Ğ´Ğ»Ñ ÑĞ¾Ğ·Ğ´Ğ°Ğ½Ğ¸Ñ ÑĞµÑ€Ğ²Ğ¸ÑĞ¾Ğ² Ğ¿Ñ€Ğ¾Ğ¼Ğ¾ĞºĞ¾Ğ´Ğ¾Ğ²"""
    
    @staticmethod
    def create_validator(db: AsyncSession) -> PromoCodeValidator:
        """Ğ¡Ğ¾Ğ·Ğ´Ğ°ĞµÑ‚ Ğ²Ğ°Ğ»Ğ¸Ğ´Ğ°Ñ‚Ğ¾Ñ€ Ğ¿Ñ€Ğ¾Ğ¼Ğ¾ĞºĞ¾Ğ´Ğ¾Ğ²"""
        return PromoCodeValidator(db)
    
    @staticmethod
    def create_manager(db: AsyncSession) -> PromoCodeManager:
        """Ğ¡Ğ¾Ğ·Ğ´Ğ°ĞµÑ‚ Ğ¼ĞµĞ½ĞµĞ´Ğ¶ĞµÑ€ Ğ¿Ñ€Ğ¾Ğ¼Ğ¾ĞºĞ¾Ğ´Ğ¾Ğ²"""
        return PromoCodeManager(db)
    
    @staticmethod
    def create_business_logic(db: AsyncSession) -> PromoCodeBusinessLogic:
        """Ğ¡Ğ¾Ğ·Ğ´Ğ°ĞµÑ‚ Ğ±Ğ¸Ğ·Ğ½ĞµÑ-Ğ»Ğ¾Ğ³Ğ¸ĞºÑƒ Ğ¿Ñ€Ğ¾Ğ¼Ğ¾ĞºĞ¾Ğ´Ğ¾Ğ²"""
        return PromoCodeBusinessLogic(db)
    
    @staticmethod
    def create_all_services(db: AsyncSession) -> tuple[PromoCodeValidator, PromoCodeManager, PromoCodeBusinessLogic]:
        """Ğ¡Ğ¾Ğ·Ğ´Ğ°ĞµÑ‚ Ğ²ÑĞµ ÑĞµÑ€Ğ²Ğ¸ÑÑ‹ Ğ¿Ñ€Ğ¾Ğ¼Ğ¾ĞºĞ¾Ğ´Ğ¾Ğ²"""
        validator = PromoCodeValidator(db)
        manager = PromoCodeManager(db)
        business_logic = PromoCodeBusinessLogic(db)
        
        return validator, manager, business_logic 

```



## `api\services\promo_code\interfaces.py`


```python

# api/services/promo_code/interfaces.py

from abc import ABC, abstractmethod
from typing import Optional, List
from sqlalchemy.orm import Session

from api.models.promo_code import PromoCode
from api.models.user import User
from shared.schemas.promo_code_schema import PromoCodeCreate, PromoCodeUpdate, PromoCodeValidateResponse


class IPromoCodeValidator(ABC):
    """Ğ˜Ğ½Ñ‚ĞµÑ€Ñ„ĞµĞ¹Ñ Ğ´Ğ»Ñ Ğ²Ğ°Ğ»Ğ¸Ğ´Ğ°Ñ‚Ğ¾Ñ€Ğ° Ğ¿Ñ€Ğ¾Ğ¼Ğ¾ĞºĞ¾Ğ´Ğ¾Ğ²"""
    
    @abstractmethod
    def validate_complete(self, code: str, order_amount: float, equipment_ids: List[int], user: Optional[User]) -> PromoCode:
        """Ğ’Ñ‹Ğ¿Ğ¾Ğ»Ğ½ÑĞµÑ‚ Ğ¿Ğ¾Ğ»Ğ½ÑƒÑ Ğ²Ğ°Ğ»Ğ¸Ğ´Ğ°Ñ†Ğ¸Ñ Ğ¿Ñ€Ğ¾Ğ¼Ğ¾ĞºĞ¾Ğ´Ğ°"""
        pass


class IPromoCodeManager(ABC):
    """Ğ˜Ğ½Ñ‚ĞµÑ€Ñ„ĞµĞ¹Ñ Ğ´Ğ»Ñ Ğ¼ĞµĞ½ĞµĞ´Ğ¶ĞµÑ€Ğ° Ğ¿Ñ€Ğ¾Ğ¼Ğ¾ĞºĞ¾Ğ´Ğ¾Ğ²"""
    
    @abstractmethod
    def create_promo_code(self, promo_data: PromoCodeCreate, creator: User) -> PromoCode:
        """Ğ¡Ğ¾Ğ·Ğ´Ğ°ĞµÑ‚ Ğ½Ğ¾Ğ²Ñ‹Ğ¹ Ğ¿Ñ€Ğ¾Ğ¼Ğ¾ĞºĞ¾Ğ´"""
        pass
    
    @abstractmethod
    def get_all_promo_codes(self) -> List[PromoCode]:
        """ĞŸĞ¾Ğ»ÑƒÑ‡Ğ°ĞµÑ‚ Ğ²ÑĞµ Ğ¿Ñ€Ğ¾Ğ¼Ğ¾ĞºĞ¾Ğ´Ñ‹"""
        pass
    
    @abstractmethod
    def get_promo_code_by_id(self, promo_code_id: int) -> Optional[PromoCode]:
        """ĞŸĞ¾Ğ»ÑƒÑ‡Ğ°ĞµÑ‚ Ğ¿Ñ€Ğ¾Ğ¼Ğ¾ĞºĞ¾Ğ´ Ğ¿Ğ¾ ID"""
        pass
    
    @abstractmethod
    def update_promo_code(self, promo_code_id: int, update_data: PromoCodeUpdate) -> PromoCode:
        """ĞĞ±Ğ½Ğ¾Ğ²Ğ»ÑĞµÑ‚ Ğ¿Ñ€Ğ¾Ğ¼Ğ¾ĞºĞ¾Ğ´"""
        pass
    
    @abstractmethod
    def delete_promo_code(self, promo_code_id: int) -> None:
        """Ğ£Ğ´Ğ°Ğ»ÑĞµÑ‚ Ğ¿Ñ€Ğ¾Ğ¼Ğ¾ĞºĞ¾Ğ´"""
        pass
    
    @abstractmethod
    def generate_unique_code(self) -> str:
        """Ğ“ĞµĞ½ĞµÑ€Ğ¸Ñ€ÑƒĞµÑ‚ ÑƒĞ½Ğ¸ĞºĞ°Ğ»ÑŒĞ½Ñ‹Ğ¹ ĞºĞ¾Ğ´"""
        pass


class IPromoCodeBusinessLogic(ABC):
    """Ğ˜Ğ½Ñ‚ĞµÑ€Ñ„ĞµĞ¹Ñ Ğ´Ğ»Ñ Ğ±Ğ¸Ğ·Ğ½ĞµÑ-Ğ»Ğ¾Ğ³Ğ¸ĞºĞ¸ Ğ¿Ñ€Ğ¾Ğ¼Ğ¾ĞºĞ¾Ğ´Ğ¾Ğ²"""
    
    @abstractmethod
    def validate_and_get_promo_code(self, code: str, order_amount: float, equipment_ids: List[int], user: Optional[User]) -> PromoCode:
        """Ğ’Ğ°Ğ»Ğ¸Ğ´Ğ¸Ñ€ÑƒĞµÑ‚ Ğ¿Ñ€Ğ¾Ğ¼Ğ¾ĞºĞ¾Ğ´ Ğ¸ Ğ²Ğ¾Ğ·Ğ²Ñ€Ğ°Ñ‰Ğ°ĞµÑ‚ ĞµĞ³Ğ¾"""
        pass
    
    @abstractmethod
    def create_validation_response(self, promo_code: PromoCode) -> PromoCodeValidateResponse:
        """Ğ¡Ğ¾Ğ·Ğ´Ğ°ĞµÑ‚ Ğ¾Ñ‚Ğ²ĞµÑ‚ Ğ´Ğ»Ñ Ğ²Ğ°Ğ»Ğ¸Ğ´Ğ°Ñ†Ğ¸Ğ¸"""
        pass
    
    @abstractmethod
    def record_promo_code_usage(self, promo_code: PromoCode, user: Optional[User]) -> None:
        """Ğ—Ğ°Ğ¿Ğ¸ÑÑ‹Ğ²Ğ°ĞµÑ‚ Ğ¸ÑĞ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ Ğ¿Ñ€Ğ¾Ğ¼Ğ¾ĞºĞ¾Ğ´Ğ°"""
        pass
    
    @abstractmethod
    def calculate_discount_amount(self, base_amount: float, promo_code: PromoCode) -> float:
        """Ğ Ğ°ÑÑÑ‡Ğ¸Ñ‚Ñ‹Ğ²Ğ°ĞµÑ‚ ÑÑƒĞ¼Ğ¼Ñƒ ÑĞºĞ¸Ğ´ĞºĞ¸"""
        pass
    
    @abstractmethod
    def validate_combined_discount(self, duration_discount: float, promo_discount: float) -> float:
        """Ğ’Ğ°Ğ»Ğ¸Ğ´Ğ¸Ñ€ÑƒĞµÑ‚ ĞºĞ¾Ğ¼Ğ±Ğ¸Ğ½Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ½ÑƒÑ ÑĞºĞ¸Ğ´ĞºÑƒ"""
        pass 

```



## `api\services\promo_code\promo_code_business_logic.py`


```python

# api/services/promo_code/promo_code_business_logic.py

from sqlalchemy.ext.asyncio import AsyncSession
from sqlalchemy import select
from typing import Optional, List
from datetime import datetime, timezone

from api.models.promo_code import PromoCode, promo_code_usages
from api.models.user import User
from shared.schemas.promo_code_schema import PromoCodeValidateResponse
from .promo_code_validator import PromoCodeValidator
from .constants import MAX_COMBINED_DISCOUNT
from .interfaces import IPromoCodeBusinessLogic


class PromoCodeBusinessLogic(IPromoCodeBusinessLogic):
    """Ğ‘Ğ¸Ğ·Ğ½ĞµÑ-Ğ»Ğ¾Ğ³Ğ¸ĞºĞ° Ğ´Ğ»Ñ Ñ€Ğ°Ğ±Ğ¾Ñ‚Ñ‹ Ñ Ğ¿Ñ€Ğ¾Ğ¼Ğ¾ĞºĞ¾Ğ´Ğ°Ğ¼Ğ¸"""
    
    def __init__(self, db: AsyncSession):
        self.db = db
        self.validator = PromoCodeValidator(db)
    
    async def validate_and_get_promo_code(
        self, 
        code: str, 
        order_amount: float, 
        equipment_ids: List[int], 
        user: Optional[User]
    ) -> PromoCode:
        """
        Ğ’Ğ°Ğ»Ğ¸Ğ´Ğ¸Ñ€ÑƒĞµÑ‚ Ğ¿Ñ€Ğ¾Ğ¼Ğ¾ĞºĞ¾Ğ´ Ğ¸ Ğ²Ğ¾Ğ·Ğ²Ñ€Ğ°Ñ‰Ğ°ĞµÑ‚ ĞµĞ³Ğ¾ Ğ¾Ğ±ÑŠĞµĞºÑ‚.
        ĞÑĞ½Ğ¾Ğ²Ğ½Ğ¾Ğ¹ Ğ¼ĞµÑ‚Ğ¾Ğ´ Ğ´Ğ»Ñ Ğ²Ğ°Ğ»Ğ¸Ğ´Ğ°Ñ†Ğ¸Ğ¸ Ğ¿Ñ€Ğ¾Ğ¼Ğ¾ĞºĞ¾Ğ´Ğ¾Ğ².
        """
        return await self.validator.validate_complete(code, order_amount, equipment_ids, user)
    
    def create_validation_response(self, promo_code: PromoCode) -> PromoCodeValidateResponse:
        """Ğ¡Ğ¾Ğ·Ğ´Ğ°ĞµÑ‚ Ğ¾Ñ‚Ğ²ĞµÑ‚ Ğ´Ğ»Ñ Ğ²Ğ°Ğ»Ğ¸Ğ´Ğ°Ñ†Ğ¸Ğ¸ Ğ¿Ñ€Ğ¾Ğ¼Ğ¾ĞºĞ¾Ğ´Ğ°"""
        return PromoCodeValidateResponse(
            code=promo_code.code,
            discount_percentage=promo_code.discount_percentage,
            message="ĞŸÑ€Ğ¾Ğ¼Ğ¾ĞºĞ¾Ğ´ ÑƒÑĞ¿ĞµÑˆĞ½Ğ¾ Ğ¿Ñ€Ğ¸Ğ¼ĞµĞ½ĞµĞ½!"
        )
    
    async def record_promo_code_usage(self, promo_code: PromoCode, user: Optional[User]) -> None:
        """
        Ğ—Ğ°Ğ¿Ğ¸ÑÑ‹Ğ²Ğ°ĞµÑ‚ Ğ¸ÑĞ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ Ğ¿Ñ€Ğ¾Ğ¼Ğ¾ĞºĞ¾Ğ´Ğ° Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ĞµĞ¼.
        Ğ£Ğ²ĞµĞ»Ğ¸Ñ‡Ğ¸Ğ²Ğ°ĞµÑ‚ ÑÑ‡ĞµÑ‚Ñ‡Ğ¸Ğº Ğ¸ÑĞ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğ¹.
        """
        # Ğ£Ğ²ĞµĞ»Ğ¸Ñ‡Ğ¸Ğ²Ğ°ĞµĞ¼ Ğ¾Ğ±Ñ‰Ğ¸Ğ¹ ÑÑ‡ĞµÑ‚Ñ‡Ğ¸Ğº Ğ¸ÑĞ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğ¹
        promo_code.times_used += 1
        
        # Ğ—Ğ°Ğ¿Ğ¸ÑÑ‹Ğ²Ğ°ĞµĞ¼ Ğ¸ÑĞ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ĞµĞ¼, ĞµÑĞ»Ğ¸ Ğ¾Ğ½ Ğ°Ğ²Ñ‚Ğ¾Ñ€Ğ¸Ğ·Ğ¾Ğ²Ğ°Ğ½
        if user:
            # ĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑĞµĞ¼, Ğ½Ğµ Ğ·Ğ°Ğ¿Ğ¸ÑĞ°Ğ½Ğ¾ Ğ»Ğ¸ ÑƒĞ¶Ğµ Ğ¸ÑĞ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ
            result = await self.db.execute(select(promo_code_usages).filter_by(
                user_id=user.id,
                promo_code_id=promo_code.id
            ))
            existing_usage = result.first()
            
            if not existing_usage:
                # Ğ”Ğ¾Ğ±Ğ°Ğ²Ğ»ÑĞµĞ¼ Ğ·Ğ°Ğ¿Ğ¸ÑÑŒ Ğ¾Ğ± Ğ¸ÑĞ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğ¸
                await self.db.execute(
                    promo_code_usages.insert().values(
                        user_id=user.id,
                        promo_code_id=promo_code.id,
                        used_at=datetime.now(timezone.utc)
                    )
                )
        
        await self.db.commit()
    
    def calculate_discount_amount(self, base_amount: float, promo_code: PromoCode) -> float:
        """Ğ Ğ°ÑÑÑ‡Ğ¸Ñ‚Ñ‹Ğ²Ğ°ĞµÑ‚ ÑÑƒĞ¼Ğ¼Ñƒ ÑĞºĞ¸Ğ´ĞºĞ¸ Ğ¿Ğ¾ Ğ¿Ñ€Ğ¾Ğ¼Ğ¾ĞºĞ¾Ğ´Ñƒ"""
        return base_amount * (promo_code.discount_percentage / 100)
    
    def calculate_final_amount_with_promo(self, base_amount: float, promo_code: PromoCode) -> float:
        """Ğ Ğ°ÑÑÑ‡Ğ¸Ñ‚Ñ‹Ğ²Ğ°ĞµÑ‚ Ñ„Ğ¸Ğ½Ğ°Ğ»ÑŒĞ½ÑƒÑ ÑÑƒĞ¼Ğ¼Ñƒ Ñ ÑƒÑ‡ĞµÑ‚Ğ¾Ğ¼ ÑĞºĞ¸Ğ´ĞºĞ¸ Ğ¿Ğ¾ Ğ¿Ñ€Ğ¾Ğ¼Ğ¾ĞºĞ¾Ğ´Ñƒ"""
        discount_amount = self.calculate_discount_amount(base_amount, promo_code)
        return base_amount - discount_amount
    
    def validate_combined_discount(self, duration_discount: float, promo_discount: float) -> float:
        """
        ĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑĞµÑ‚ Ğ¸ ĞºĞ¾Ñ€Ñ€ĞµĞºÑ‚Ğ¸Ñ€ÑƒĞµÑ‚ ĞºĞ¾Ğ¼Ğ±Ğ¸Ğ½Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ½ÑƒÑ ÑĞºĞ¸Ğ´ĞºÑƒ.
        Ğ’Ğ¾Ğ·Ğ²Ñ€Ğ°Ñ‰Ğ°ĞµÑ‚ Ğ¸Ñ‚Ğ¾Ğ³Ğ¾Ğ²Ñ‹Ğ¹ Ğ¿Ñ€Ğ¾Ñ†ĞµĞ½Ñ‚ ÑĞºĞ¸Ğ´ĞºĞ¸.
        """
        total_discount = duration_discount + promo_discount
        if total_discount > MAX_COMBINED_DISCOUNT:
            return MAX_COMBINED_DISCOUNT
        return total_discount
    
    def get_promo_code_statistics(self, promo_code: PromoCode) -> dict:
        """ĞŸĞ¾Ğ»ÑƒÑ‡Ğ°ĞµÑ‚ ÑÑ‚Ğ°Ñ‚Ğ¸ÑÑ‚Ğ¸ĞºÑƒ Ğ¸ÑĞ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ Ğ¿Ñ€Ğ¾Ğ¼Ğ¾ĞºĞ¾Ğ´Ğ°"""
        total_uses = promo_code.times_used
        max_uses = promo_code.max_uses
        usage_percentage = (total_uses / max_uses * 100) if max_uses else None
        
        return {
            'total_uses': total_uses,
            'max_uses': max_uses,
            'usage_percentage': usage_percentage,
            'is_fully_used': max_uses and total_uses >= max_uses,
            'remaining_uses': max_uses - total_uses if max_uses else None
        }
    
    def is_promo_code_expired(self, promo_code: PromoCode) -> bool:
        """ĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑĞµÑ‚, Ğ¸ÑÑ‚ĞµĞº Ğ»Ğ¸ ÑÑ€Ğ¾Ğº Ğ´ĞµĞ¹ÑÑ‚Ğ²Ğ¸Ñ Ğ¿Ñ€Ğ¾Ğ¼Ğ¾ĞºĞ¾Ğ´Ğ°"""
        if not promo_code.expires_at:
            return False
        
        now_utc = datetime.now(timezone.utc)
        return promo_code.expires_at < now_utc
    
    def is_promo_code_active(self, promo_code: PromoCode) -> bool:
        """ĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑĞµÑ‚, Ğ°ĞºÑ‚Ğ¸Ğ²ĞµĞ½ Ğ»Ğ¸ Ğ¿Ñ€Ğ¾Ğ¼Ğ¾ĞºĞ¾Ğ´ (Ğ²ĞºĞ»ÑÑ‡Ğ°Ñ ÑÑ€Ğ¾ĞºĞ¸ Ğ´ĞµĞ¹ÑÑ‚Ğ²Ğ¸Ñ)"""
        if not promo_code.is_active:
            return False
        
        now_utc = datetime.now(timezone.utc)
        
        # ĞŸÑ€Ğ¾Ğ²ĞµÑ€ĞºĞ° Ğ´Ğ°Ñ‚Ñ‹ Ğ½Ğ°Ñ‡Ğ°Ğ»Ğ° Ğ´ĞµĞ¹ÑÑ‚Ğ²Ğ¸Ñ
        if promo_code.valid_from and promo_code.valid_from > now_utc:
            return False
        
        # ĞŸÑ€Ğ¾Ğ²ĞµÑ€ĞºĞ° Ğ´Ğ°Ñ‚Ñ‹ Ğ¾ĞºĞ¾Ğ½Ñ‡Ğ°Ğ½Ğ¸Ñ Ğ´ĞµĞ¹ÑÑ‚Ğ²Ğ¸Ñ
        if promo_code.expires_at and promo_code.expires_at < now_utc:
            return False
        
        return True 

```



## `api\services\promo_code\promo_code_manager.py`


```python

# api/services/promo_code/promo_code_manager.py

from sqlalchemy.ext.asyncio import AsyncSession
from sqlalchemy.orm import joinedload
from sqlalchemy import select
from typing import List, Optional
import secrets

from api.models.promo_code import PromoCode, PromoCodeApplicableType
from api.models.equipment import Equipment
from api.models.user import User
from shared.schemas.promo_code_schema import PromoCodeCreate, PromoCodeUpdate
from .exceptions import (
    PromoCodeExistsError, PromoCodeEquipmentNotFoundError, 
    PromoCodeNotFoundError, PromoCodeDiscountLimitError
)
from .constants import DISCOUNT_LIMITS
from .interfaces import IPromoCodeManager


class PromoCodeManager(IPromoCodeManager):
    """ĞœĞµĞ½ĞµĞ´Ğ¶ĞµÑ€ Ğ´Ğ»Ñ CRUD Ğ¾Ğ¿ĞµÑ€Ğ°Ñ†Ğ¸Ğ¹ Ñ Ğ¿Ñ€Ğ¾Ğ¼Ğ¾ĞºĞ¾Ğ´Ğ°Ğ¼Ğ¸"""
    
    def __init__(self, db: AsyncSession):
        self.db = db
    
    async def create_promo_code(self, promo_data: PromoCodeCreate, creator: User) -> PromoCode:
        """Ğ¡Ğ¾Ğ·Ğ´Ğ°ĞµÑ‚ Ğ½Ğ¾Ğ²Ñ‹Ğ¹ Ğ¿Ñ€Ğ¾Ğ¼Ğ¾ĞºĞ¾Ğ´"""
        # ĞŸÑ€Ğ¾Ğ²ĞµÑ€ĞºĞ° Ğ»Ğ¸Ğ¼Ğ¸Ñ‚Ğ¾Ğ² ÑĞºĞ¸Ğ´ĞºĞ¸ Ğ¿Ğ¾ Ñ€Ğ¾Ğ»Ğ¸
        self._validate_discount_limit(creator.role, promo_data.discount_percentage)
        
        # ĞŸÑ€Ğ¾Ğ²ĞµÑ€ĞºĞ° ÑƒĞ½Ğ¸ĞºĞ°Ğ»ÑŒĞ½Ğ¾ÑÑ‚Ğ¸ ĞºĞ¾Ğ´Ğ°
        result = await self.db.execute(select(PromoCode).filter(PromoCode.code == promo_data.code))
        if result.scalar_one_or_none():
            raise PromoCodeExistsError()
        
        # Ğ¡Ğ¾Ğ·Ğ´Ğ°Ğ½Ğ¸Ğµ Ğ¾ÑĞ½Ğ¾Ğ²Ğ½Ğ¾Ğ³Ğ¾ Ğ¾Ğ±ÑŠĞµĞºÑ‚Ğ°
        promo_dict = promo_data.model_dump(exclude={'applicable_to_equipment_ids', 'applicable_to_equipment_types'})
        new_promo_code = PromoCode(**promo_dict, created_by_id=creator.id)
        
        # ĞĞ±Ñ€Ğ°Ğ±Ğ¾Ñ‚ĞºĞ° ÑĞ²ÑĞ·ĞµĞ¹ Ñ Ğ¾Ğ±Ğ¾Ñ€ÑƒĞ´Ğ¾Ğ²Ğ°Ğ½Ğ¸ĞµĞ¼
        await self._set_equipment_relations(new_promo_code, promo_data.applicable_to_equipment_ids)
        
        # ĞĞ±Ñ€Ğ°Ğ±Ğ¾Ñ‚ĞºĞ° ÑĞ²ÑĞ·ĞµĞ¹ Ñ Ñ‚Ğ¸Ğ¿Ğ°Ğ¼Ğ¸ Ğ¾Ğ±Ğ¾Ñ€ÑƒĞ´Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ
        self._set_equipment_type_relations(new_promo_code, promo_data.applicable_to_equipment_types)
        
        self.db.add(new_promo_code)
        await self.db.commit()
        
        # ĞŸĞ¾Ğ²Ñ‚Ğ¾Ñ€Ğ½Ğ¾ Ğ¿Ğ¾Ğ»ÑƒÑ‡Ğ°ĞµĞ¼ Ğ¾Ğ±ÑŠĞµĞºÑ‚ Ğ¸Ğ· Ğ‘Ğ” Ñ Ğ·Ğ°Ğ³Ñ€ÑƒĞ¶ĞµĞ½Ğ½Ñ‹Ğ¼Ğ¸ ÑĞ²ÑĞ·ÑĞ¼Ğ¸
        result = await self.db.execute(
            select(PromoCode)
            .filter(PromoCode.id == new_promo_code.id)
            .options(joinedload(PromoCode.creator))
        )
        return result.unique().scalars().first()
    
    async def get_all_promo_codes(self) -> List[PromoCode]:
        """ĞŸĞ¾Ğ»ÑƒÑ‡Ğ°ĞµÑ‚ Ğ²ÑĞµ Ğ¿Ñ€Ğ¾Ğ¼Ğ¾ĞºĞ¾Ğ´Ñ‹ Ñ Ğ·Ğ°Ğ³Ñ€ÑƒĞ·ĞºĞ¾Ğ¹ ÑĞ²ÑĞ·Ğ°Ğ½Ğ½Ñ‹Ñ… Ğ´Ğ°Ğ½Ğ½Ñ‹Ñ…"""
        result = await self.db.execute(select(PromoCode).options(
            joinedload(PromoCode.creator)
        ).order_by(PromoCode.created_at.desc()))
        return result.unique().scalars().all()
    
    async def get_promo_code_by_id(self, promo_code_id: int) -> Optional[PromoCode]:
        """ĞŸĞ¾Ğ»ÑƒÑ‡Ğ°ĞµÑ‚ Ğ¿Ñ€Ğ¾Ğ¼Ğ¾ĞºĞ¾Ğ´ Ğ¿Ğ¾ ID"""
        result = await self.db.execute(select(PromoCode).filter(PromoCode.id == promo_code_id))
        return result.scalar_one_or_none()
    
    async def update_promo_code(self, promo_code_id: int, update_data: PromoCodeUpdate) -> PromoCode:
        """ĞĞ±Ğ½Ğ¾Ğ²Ğ»ÑĞµÑ‚ ÑÑƒÑ‰ĞµÑÑ‚Ğ²ÑƒÑÑ‰Ğ¸Ğ¹ Ğ¿Ñ€Ğ¾Ğ¼Ğ¾ĞºĞ¾Ğ´"""
        promo_code = await self.get_promo_code_by_id(promo_code_id)
        if not promo_code:
            raise PromoCodeNotFoundError()
        
        update_dict = update_data.model_dump(exclude_unset=True)
        
        # ĞĞ±Ñ€Ğ°Ğ±Ğ¾Ñ‚ĞºĞ° Ğ¾Ğ±Ğ½Ğ¾Ğ²Ğ»ĞµĞ½Ğ¸Ñ ÑĞ²ÑĞ·ĞµĞ¹ Ñ Ğ¾Ğ±Ğ¾Ñ€ÑƒĞ´Ğ¾Ğ²Ğ°Ğ½Ğ¸ĞµĞ¼
        if 'applicable_to_equipment_ids' in update_dict:
            equipment_ids = update_dict.pop('applicable_to_equipment_ids')
            await self._set_equipment_relations(promo_code, equipment_ids)
        
        # ĞĞ±Ñ€Ğ°Ğ±Ğ¾Ñ‚ĞºĞ° Ğ¾Ğ±Ğ½Ğ¾Ğ²Ğ»ĞµĞ½Ğ¸Ñ ÑĞ²ÑĞ·ĞµĞ¹ Ñ Ñ‚Ğ¸Ğ¿Ğ°Ğ¼Ğ¸ Ğ¾Ğ±Ğ¾Ñ€ÑƒĞ´Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ
        if 'applicable_to_equipment_types' in update_dict:
            equipment_types = update_dict.pop('applicable_to_equipment_types')
            self._set_equipment_type_relations(promo_code, equipment_types)
        
        # ĞĞ±Ğ½Ğ¾Ğ²Ğ»ĞµĞ½Ğ¸Ğµ Ğ¾ÑÑ‚Ğ°Ğ»ÑŒĞ½Ñ‹Ñ… Ğ¿Ğ¾Ğ»ĞµĞ¹
        for key, value in update_dict.items():
            setattr(promo_code, key, value)
        
        self.db.add(promo_code)
        await self.db.commit()
        
        # ĞŸĞ¾Ğ²Ñ‚Ğ¾Ñ€Ğ½Ğ¾ Ğ¿Ğ¾Ğ»ÑƒÑ‡Ğ°ĞµĞ¼ Ğ¾Ğ±ÑŠĞµĞºÑ‚ Ğ¸Ğ· Ğ‘Ğ” Ñ Ğ·Ğ°Ğ³Ñ€ÑƒĞ¶ĞµĞ½Ğ½Ñ‹Ğ¼Ğ¸ ÑĞ²ÑĞ·ÑĞ¼Ğ¸
        result = await self.db.execute(
            select(PromoCode)
            .filter(PromoCode.id == promo_code_id)
            .options(joinedload(PromoCode.creator))
        )
        return result.unique().scalars().first()
    
    async def delete_promo_code(self, promo_code_id: int) -> None:
        """Ğ£Ğ´Ğ°Ğ»ÑĞµÑ‚ Ğ¿Ñ€Ğ¾Ğ¼Ğ¾ĞºĞ¾Ğ´"""
        promo_code = await self.get_promo_code_by_id(promo_code_id)
        if not promo_code:
            raise PromoCodeNotFoundError()
        
        await self.db.delete(promo_code)
        await self.db.commit()
    
    async def generate_unique_code(self) -> str:
        """Ğ“ĞµĞ½ĞµÑ€Ğ¸Ñ€ÑƒĞµÑ‚ ÑƒĞ½Ğ¸ĞºĞ°Ğ»ÑŒĞ½Ñ‹Ğ¹ ĞºĞ¾Ğ´ Ğ¿Ñ€Ğ¾Ğ¼Ğ¾ĞºĞ¾Ğ´Ğ°"""
        while True:
            code = f"SALE-{secrets.token_hex(3).upper()}"
            result = await self.db.execute(select(PromoCode).filter(PromoCode.code == code))
            existing_code = result.scalar_one_or_none()
            if not existing_code:
                return code
    
    def _validate_discount_limit(self, role: str, discount_percentage: float) -> None:
        """ĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑĞµÑ‚ Ğ»Ğ¸Ğ¼Ğ¸Ñ‚ ÑĞºĞ¸Ğ´ĞºĞ¸ Ğ´Ğ»Ñ Ñ€Ğ¾Ğ»Ğ¸ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ñ"""
        if role in DISCOUNT_LIMITS and discount_percentage > DISCOUNT_LIMITS[role]:
            raise PromoCodeDiscountLimitError(role)
    
    async def _set_equipment_relations(self, promo_code: PromoCode, equipment_ids: Optional[List[int]]) -> None:
        """Ğ£ÑÑ‚Ğ°Ğ½Ğ°Ğ²Ğ»Ğ¸Ğ²Ğ°ĞµÑ‚ ÑĞ²ÑĞ·Ğ¸ Ñ Ğ¾Ğ±Ğ¾Ñ€ÑƒĞ´Ğ¾Ğ²Ğ°Ğ½Ğ¸ĞµĞ¼"""
        promo_code.applicable_equipment.clear()
        if equipment_ids:
            result = await self.db.execute(select(Equipment).filter(Equipment.id.in_(equipment_ids)))
            equipment = result.unique().scalars().all()
            if len(equipment) != len(equipment_ids):
                raise PromoCodeEquipmentNotFoundError()
            promo_code.applicable_equipment = equipment
    
    def _set_equipment_type_relations(self, promo_code: PromoCode, equipment_types: Optional[List[str]]) -> None:
        """Ğ£ÑÑ‚Ğ°Ğ½Ğ°Ğ²Ğ»Ğ¸Ğ²Ğ°ĞµÑ‚ ÑĞ²ÑĞ·Ğ¸ Ñ Ñ‚Ğ¸Ğ¿Ğ°Ğ¼Ğ¸ Ğ¾Ğ±Ğ¾Ñ€ÑƒĞ´Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ"""
        promo_code.applicable_types.clear()
        if equipment_types:
            promo_code.applicable_types = [
                PromoCodeApplicableType(type_name=t) for t in equipment_types
            ] 

```



## `api\services\promo_code\promo_code_validator.py`


```python

# api/services/promo_code/promo_code_validator.py

from sqlalchemy.ext.asyncio import AsyncSession
from sqlalchemy import select
from typing import Optional, List
from datetime import datetime, timezone

from api.models.promo_code import PromoCode, promo_code_usages
from api.models.user import User
from api.models.equipment import Equipment
from .exceptions import (
    PromoCodeNotFoundError, PromoCodeInactiveError, PromoCodeNotStartedError,
    PromoCodeExpiredError, PromoCodeUsageLimitExceededError, PromoCodeMinOrderAmountError,
    PromoCodeInvalidEquipmentError, PromoCodeInvalidEquipmentTypeError,
    PromoCodePersonalCodeForbiddenError, PromoCodeUserUsageLimitError
)
from .interfaces import IPromoCodeValidator


class PromoCodeValidator(IPromoCodeValidator):
    """Ğ’Ğ°Ğ»Ğ¸Ğ´Ğ°Ñ‚Ğ¾Ñ€ Ğ¿Ñ€Ğ¾Ğ¼Ğ¾ĞºĞ¾Ğ´Ğ¾Ğ² Ñ Ñ€Ğ°Ğ·Ğ´ĞµĞ»ĞµĞ½Ğ¸ĞµĞ¼ Ğ¾Ñ‚Ğ²ĞµÑ‚ÑÑ‚Ğ²ĞµĞ½Ğ½Ğ¾ÑÑ‚Ğ¸ Ğ¿Ğ¾ Ñ‚Ğ¸Ğ¿Ğ°Ğ¼ Ğ¿Ñ€Ğ¾Ğ²ĞµÑ€Ğ¾Ğº"""
    
    def __init__(self, db: AsyncSession):
        self.db = db
    
    async def validate_basic_existence(self, code: str) -> PromoCode:
        """ĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑĞµÑ‚ ÑÑƒÑ‰ĞµÑÑ‚Ğ²Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ Ğ¿Ñ€Ğ¾Ğ¼Ğ¾ĞºĞ¾Ğ´Ğ°"""
        result = await self.db.execute(select(PromoCode).filter(PromoCode.code == code))
        promo_code = result.unique().scalar_one_or_none()
        if not promo_code:
            raise PromoCodeNotFoundError()
        return promo_code
    
    def validate_status_and_dates(self, promo_code: PromoCode) -> None:
        """ĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑĞµÑ‚ Ğ°ĞºÑ‚Ğ¸Ğ²Ğ½Ğ¾ÑÑ‚ÑŒ Ğ¸ ÑÑ€Ğ¾ĞºĞ¸ Ğ´ĞµĞ¹ÑÑ‚Ğ²Ğ¸Ñ Ğ¿Ñ€Ğ¾Ğ¼Ğ¾ĞºĞ¾Ğ´Ğ°"""
        if not promo_code.is_active:
            raise PromoCodeInactiveError()
        
        now_utc = datetime.now(timezone.utc)
        
        if promo_code.valid_from and promo_code.valid_from > now_utc:
            raise PromoCodeNotStartedError()
        
        if promo_code.expires_at and promo_code.expires_at < now_utc:
            raise PromoCodeExpiredError()
    
    def validate_usage_limits(self, promo_code: PromoCode) -> None:
        """ĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑĞµÑ‚ Ğ»Ğ¸Ğ¼Ğ¸Ñ‚Ñ‹ Ğ¸ÑĞ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ Ğ¿Ñ€Ğ¾Ğ¼Ğ¾ĞºĞ¾Ğ´Ğ°"""
        if promo_code.max_uses is not None and promo_code.times_used >= promo_code.max_uses:
            raise PromoCodeUsageLimitExceededError()
    
    def validate_order_amount(self, promo_code: PromoCode, order_amount: float) -> None:
        """ĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑĞµÑ‚ Ğ¼Ğ¸Ğ½Ğ¸Ğ¼Ğ°Ğ»ÑŒĞ½ÑƒÑ ÑÑƒĞ¼Ğ¼Ñƒ Ğ·Ğ°ĞºĞ°Ğ·Ğ°"""
        if promo_code.min_order_amount is not None and order_amount < promo_code.min_order_amount:
            raise PromoCodeMinOrderAmountError(promo_code.min_order_amount)
    
    async def validate_equipment_applicability(self, promo_code: PromoCode, equipment_ids: List[int]) -> None:
        """ĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑĞµÑ‚ Ğ¿Ñ€Ğ¸Ğ¼ĞµĞ½Ğ¸Ğ¼Ğ¾ÑÑ‚ÑŒ Ğº Ğ¾Ğ±Ğ¾Ñ€ÑƒĞ´Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ"""
        # ĞŸÑ€Ğ¾Ğ²ĞµÑ€ĞºĞ° Ğ¿Ğ¾ ID Ğ¾Ğ±Ğ¾Ñ€ÑƒĞ´Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ
        if promo_code.applicable_to_equipment_ids and not any(eid in equipment_ids for eid in promo_code.applicable_to_equipment_ids):
            raise PromoCodeInvalidEquipmentError()
        
        # ĞŸÑ€Ğ¾Ğ²ĞµÑ€ĞºĞ° Ğ¿Ğ¾ Ñ‚Ğ¸Ğ¿Ğ°Ğ¼ Ğ¾Ğ±Ğ¾Ñ€ÑƒĞ´Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ
        if promo_code.applicable_to_equipment_types:
            result = await self.db.execute(select(Equipment).filter(Equipment.id.in_(equipment_ids)))
            equipment_in_cart = result.unique().scalars().all()
            equipment_types_in_cart = {eq.equipment_type for eq in equipment_in_cart}
            if not any(eq_type in equipment_types_in_cart for eq_type in promo_code.applicable_to_equipment_types):
                raise PromoCodeInvalidEquipmentTypeError()
    
    async def validate_user_permissions(self, promo_code: PromoCode, user: Optional[User]) -> None:
        """ĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑĞµÑ‚ Ğ¿Ñ€Ğ°Ğ²Ğ° Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ñ Ğ½Ğ° Ğ¸ÑĞ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ Ğ¿Ñ€Ğ¾Ğ¼Ğ¾ĞºĞ¾Ğ´Ğ°"""
        # ĞŸÑ€Ğ¾Ğ²ĞµÑ€ĞºĞ° Ğ¿ĞµÑ€ÑĞ¾Ğ½Ğ°Ğ»ÑŒĞ½Ğ¾Ğ³Ğ¾ Ğ¿Ñ€Ğ¾Ğ¼Ğ¾ĞºĞ¾Ğ´Ğ°
        if promo_code.specific_to_user_id:
            if not user or user.id != promo_code.specific_to_user_id:
                raise PromoCodePersonalCodeForbiddenError()
        
        # ĞŸÑ€Ğ¾Ğ²ĞµÑ€ĞºĞ° Ğ»Ğ¸Ğ¼Ğ¸Ñ‚Ğ° Ğ¸ÑĞ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğ¹ Ğ½Ğ° Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ñ
        if promo_code.max_uses_per_user and user:
            result = await self.db.execute(select(promo_code_usages).filter_by(
                user_id=user.id, 
                promo_code_id=promo_code.id
            ))
            user_uses_count = len(result.all())
            if user_uses_count >= promo_code.max_uses_per_user:
                raise PromoCodeUserUsageLimitError()
    
    async def validate_complete(self, code: str, order_amount: float, equipment_ids: List[int], user: Optional[User]) -> PromoCode:
        """Ğ’Ñ‹Ğ¿Ğ¾Ğ»Ğ½ÑĞµÑ‚ Ğ¿Ğ¾Ğ»Ğ½ÑƒÑ Ğ²Ğ°Ğ»Ğ¸Ğ´Ğ°Ñ†Ğ¸Ñ Ğ¿Ñ€Ğ¾Ğ¼Ğ¾ĞºĞ¾Ğ´Ğ°"""
        promo_code = await self.validate_basic_existence(code)
        self.validate_status_and_dates(promo_code)
        self.validate_usage_limits(promo_code)
        self.validate_order_amount(promo_code, order_amount)
        await self.validate_equipment_applicability(promo_code, equipment_ids)
        await self.validate_user_permissions(promo_code, user)
        
        return promo_code 

```



## `api\services\promo_code_service.py`


```python

# api/services/promo_code_service.py

from sqlalchemy.ext.asyncio import AsyncSession
from typing import Optional, List

from api.models.promo_code import PromoCode
from api.models.user import User
from .promo_code import PromoCodeBusinessLogic


async def validate_promo_code_for_use(
        db: AsyncSession,
        code: str,
        order_amount: float,
        equipment_ids: List[int],
        user: Optional[User]
) -> PromoCode:
    """
    Ğ¦ĞµĞ½Ñ‚Ñ€Ğ°Ğ»Ğ¸Ğ·Ğ¾Ğ²Ğ°Ğ½Ğ½Ğ°Ñ Ñ„ÑƒĞ½ĞºÑ†Ğ¸Ñ Ğ´Ğ»Ñ Ğ¿Ğ¾Ğ»Ğ½Ğ¾Ğ¹ ÑĞµÑ€Ğ²ĞµÑ€Ğ½Ğ¾Ğ¹ Ğ²Ğ°Ğ»Ğ¸Ğ´Ğ°Ñ†Ğ¸Ğ¸ Ğ¿Ñ€Ğ¾Ğ¼Ğ¾ĞºĞ¾Ğ´Ğ°.
    Ğ’Ğ¾Ğ·Ğ²Ñ€Ğ°Ñ‰Ğ°ĞµÑ‚ Ğ¾Ğ±ÑŠĞµĞºÑ‚ PromoCode Ğ² ÑĞ»ÑƒÑ‡Ğ°Ğµ ÑƒÑĞ¿ĞµÑ…Ğ° Ğ¸Ğ»Ğ¸ Ğ²Ñ‹Ğ±Ñ€Ğ°ÑÑ‹Ğ²Ğ°ĞµÑ‚ HTTPException.
    
    Ğ­Ñ‚Ğ° Ñ„ÑƒĞ½ĞºÑ†Ğ¸Ñ ÑĞ²Ğ»ÑĞµÑ‚ÑÑ Ñ„Ğ°ÑĞ°Ğ´Ğ¾Ğ¼ Ğ´Ğ»Ñ Ğ½Ğ¾Ğ²Ğ¾Ğ¹ Ğ°Ñ€Ñ…Ğ¸Ñ‚ĞµĞºÑ‚ÑƒÑ€Ñ‹ Ğ¿Ñ€Ğ¾Ğ¼Ğ¾ĞºĞ¾Ğ´Ğ¾Ğ².
    """
    business_logic = PromoCodeBusinessLogic(db)
    return await business_logic.validate_and_get_promo_code(code, order_amount, equipment_ids, user)

```



## `api\services\rental\rental_query_service.py`


```python

# api/services/rental/rental_query_service.py

from sqlalchemy.ext.asyncio import AsyncSession
from sqlalchemy.orm import joinedload, selectinload
from sqlalchemy import or_, select, func, case, and_
from datetime import date
from typing import Optional, List, Tuple
import logging

from api.models.rental import Rental, RentalAccessory
from api.models.user import User
from api.models.equipment import Equipment
from shared.schemas.rental_schema import RentalOut
from api.services.financial_service import FinancialService
from api.services.order.order_query_base import OrderQueryBase

logger = logging.getLogger(__name__)

class RentalQueryService(OrderQueryBase[Rental]):
    """Ğ¡ĞµÑ€Ğ²Ğ¸Ñ Ğ´Ğ»Ñ Ğ²Ñ‹Ğ¿Ğ¾Ğ»Ğ½ĞµĞ½Ğ¸Ñ Ğ¾Ğ¿ĞµÑ€Ğ°Ñ†Ğ¸Ğ¹ Ñ‡Ñ‚ĞµĞ½Ğ¸Ñ (Query) Ğ´Ğ°Ğ½Ğ½Ñ‹Ñ… Ğ¾Ğ± Ğ°Ñ€ĞµĞ½Ğ´Ğ°Ñ…."""

    def __init__(self, db: AsyncSession):
        super().__init__(db)
        self.financial_service = FinancialService(db)

    def _get_base_query(self):
        """Ğ¡Ğ¾Ğ·Ğ´Ğ°ĞµÑ‚ Ğ±Ğ°Ğ·Ğ¾Ğ²Ñ‹Ğ¹ Ğ·Ğ°Ğ¿Ñ€Ğ¾Ñ Ñ Ğ½ĞµĞ¾Ğ±Ñ…Ğ¾Ğ´Ğ¸Ğ¼Ñ‹Ğ¼Ğ¸ join'Ğ°Ğ¼Ğ¸ Ğ¸ ĞºĞ°ÑÑ‚Ğ¾Ğ¼Ğ½Ğ¾Ğ¹ ÑĞ¾Ñ€Ñ‚Ğ¸Ñ€Ğ¾Ğ²ĞºĞ¾Ğ¹."""
        overdue_case = case(
            (and_(Rental.status == 'active', Rental.end_date < date.today()), 0),
            else_=1
        ).asc()

        return select(Rental).options(
            joinedload(Rental.user),
            joinedload(Rental.created_by),
            selectinload(Rental.equipment).options(
                selectinload(Equipment.accessories),
                selectinload(Equipment.associations)
            ),
            joinedload(Rental.accessory_links).joinedload(RentalAccessory.accessory)
        ).order_by(overdue_case, Rental.id.desc())

    # --- Ğ˜Ğ—ĞœĞ•ĞĞ•ĞĞ˜Ğ• 1: Ğ¡Ğ¾Ğ·Ğ´Ğ°ĞµĞ¼ ĞµĞ´Ğ¸Ğ½Ñ‹Ğ¹ Ğ¼ĞµÑ‚Ğ¾Ğ´ Ğ´Ğ»Ñ Ğ¿Ğ¾ÑÑ‚Ñ€Ğ¾ĞµĞ½Ğ¸Ñ Ğ·Ğ°Ğ¿Ñ€Ğ¾ÑĞ° Ñ Ñ„Ğ¸Ğ»ÑŒÑ‚Ñ€Ğ°Ğ¼Ğ¸ ---
    def _get_filtered_query(self, status_filter: Optional[str], search: Optional[str]):
        """
        Ğ¡Ğ¾Ğ·Ğ´Ğ°ĞµÑ‚ Ğ¸ Ğ²Ğ¾Ğ·Ğ²Ñ€Ğ°Ñ‰Ğ°ĞµÑ‚ Ğ¾Ñ‚Ñ„Ğ¸Ğ»ÑŒÑ‚Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ½Ñ‹Ğ¹ Ğ·Ğ°Ğ¿Ñ€Ğ¾Ñ Ğ½Ğ° Ğ¾ÑĞ½Ğ¾Ğ²Ğµ ÑÑ‚Ğ°Ñ‚ÑƒÑĞ° Ğ¸ Ğ¿Ğ¾Ğ¸ÑĞºĞ°.
        Ğ­Ñ‚Ğ¾ Ñ†ĞµĞ½Ñ‚Ñ€Ğ°Ğ»Ğ¸Ğ·ÑƒĞµÑ‚ Ğ»Ğ¾Ğ³Ğ¸ĞºÑƒ Ñ„Ğ¸Ğ»ÑŒÑ‚Ñ€Ğ°Ñ†Ğ¸Ğ¸.
        """
        query = self._get_base_query()

        # ĞŸÑ€Ğ¸Ğ¼ĞµĞ½ÑĞµĞ¼ Ñ„Ğ¸Ğ»ÑŒÑ‚Ñ€ Ğ¿Ğ¾ ÑÑ‚Ğ°Ñ‚ÑƒÑÑƒ, ĞµÑĞ»Ğ¸ Ğ¾Ğ½ ĞµÑÑ‚ÑŒ
        if status_filter:
            today = date.today()
            if status_filter == 'active':
                # ĞĞºÑ‚Ğ¸Ğ²Ğ½Ñ‹Ğµ Ğ°Ñ€ĞµĞ½Ğ´Ñ‹ - Ğ²ÑĞµ Ğ°Ñ€ĞµĞ½Ğ´Ñ‹ ÑĞ¾ ÑÑ‚Ğ°Ñ‚ÑƒÑĞ¾Ğ¼ 'active' (Ğ²ĞºĞ»ÑÑ‡Ğ°Ñ Ğ¿Ñ€Ğ¾ÑÑ€Ğ¾Ñ‡ĞµĞ½Ğ½Ñ‹Ğµ)
                query = query.filter(Rental.status == 'active')
            elif status_filter == 'overdue':
                # ĞŸÑ€Ğ¾ÑÑ€Ğ¾Ñ‡ĞµĞ½Ğ½Ñ‹Ğµ Ğ°Ñ€ĞµĞ½Ğ´Ñ‹ - Ğ°ĞºÑ‚Ğ¸Ğ²Ğ½Ñ‹Ğµ Ğ°Ñ€ĞµĞ½Ğ´Ñ‹ Ñ Ğ¸ÑÑ‚ĞµĞºÑˆĞ¸Ğ¼ ÑÑ€Ğ¾ĞºĞ¾Ğ¼
                query = query.filter(Rental.status == 'active', Rental.end_date < today)
            elif status_filter == 'completed':
                query = query.filter(Rental.status == 'completed')

        # ĞŸÑ€Ğ¸Ğ¼ĞµĞ½ÑĞµĞ¼ Ğ¿Ğ¾Ğ¸ÑĞº Ğ¿Ğ¾ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ñ, ĞµÑĞ»Ğ¸ Ğ¾Ğ½ ĞµÑÑ‚ÑŒ
        if search:
            query = self._apply_user_search(query, search, Rental)

        return query

    async def _enrich_rental_with_dynamic_fields(self, rental: Rental) -> RentalOut:
        """ĞĞ±Ğ¾Ğ³Ğ°Ñ‰Ğ°ĞµÑ‚ Ğ¾Ğ±ÑŠĞµĞºÑ‚ Ğ°Ñ€ĞµĞ½Ğ´Ñ‹ Ğ´Ğ¸Ğ½Ğ°Ğ¼Ğ¸Ñ‡ĞµÑĞºĞ¸Ğ¼Ğ¸ Ğ¿Ğ¾Ğ»ÑĞ¼Ğ¸ Ñ‡ĞµÑ€ĞµĞ· FinancialService."""
        rental_out = RentalOut.model_validate(rental)
        today = date.today()

        if rental.status == 'active' and rental.end_date < today:
            rental_out.status = 'overdue'

        if rental_out.status == 'overdue':
            rental_out.overdue_days = self.financial_service.calculate_overdue_days(rental, today)
            rental_out.overdue_surcharge = await self.financial_service.calculate_overdue_surcharge(rental, today)
        elif rental.status == 'active':
            rental_out.days_remaining = (rental.end_date - today).days

        accessories_cost = sum(
            link.accessory.price for link in rental.accessory_links if link.accessory and link.accessory.price
        )
        rental_out.accessories_cost = accessories_cost
        rental_out.remaining_amount = rental.total_cost - rental.prepayment_amount

        return rental_out

    async def get_rentals_for_user(
        self, 
        user: User, 
        skip: int, 
        limit: int,
        status: Optional[str] = None,
        search: Optional[str] = None,
        sort: Optional[str] = None
    ) -> Tuple[List[RentalOut], int]:
        """ĞŸĞ¾Ğ»ÑƒÑ‡Ğ°ĞµÑ‚ Ğ¾Ñ‚Ñ„Ğ¸Ğ»ÑŒÑ‚Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ½Ñ‹Ğ¹ Ğ¸ Ğ¿Ğ°Ğ³Ğ¸Ğ½Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ½Ñ‹Ğ¹ ÑĞ¿Ğ¸ÑĞ¾Ğº Ğ°Ñ€ĞµĞ½Ğ´ Ğ´Ğ»Ñ ĞºĞ¾Ğ½ĞºÑ€ĞµÑ‚Ğ½Ğ¾Ğ³Ğ¾ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ñ."""
        
        # Ğ¡Ğ¾Ğ·Ğ´Ğ°ĞµĞ¼ Ğ±Ğ°Ğ·Ğ¾Ğ²Ñ‹Ğ¹ Ğ·Ğ°Ğ¿Ñ€Ğ¾Ñ
        base_query = self._get_base_query().filter(Rental.user_id == user.id)
        
        # ĞŸÑ€Ğ¸Ğ¼ĞµĞ½ÑĞµĞ¼ Ñ„Ğ¸Ğ»ÑŒÑ‚Ñ€Ğ°Ñ†Ğ¸Ñ Ğ¿Ğ¾ ÑÑ‚Ğ°Ñ‚ÑƒÑÑƒ
        base_query = self._apply_status_filter(base_query, status, Rental)
        
        # ĞŸÑ€Ğ¸Ğ¼ĞµĞ½ÑĞµĞ¼ Ğ¿Ğ¾Ğ¸ÑĞº Ğ¿Ğ¾ Ğ¾Ğ±Ğ¾Ñ€ÑƒĞ´Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ
        if search:
            base_query = self._apply_equipment_search(base_query, search, Rental)
        
        # ĞŸÑ€Ğ¸Ğ¼ĞµĞ½ÑĞµĞ¼ ÑĞ¾Ñ€Ñ‚Ğ¸Ñ€Ğ¾Ğ²ĞºÑƒ (ĞµÑĞ»Ğ¸ Ğ½Ğµ ÑƒĞºĞ°Ğ·Ğ°Ğ½Ğ°, Ğ¸ÑĞ¿Ğ¾Ğ»ÑŒĞ·ÑƒĞµĞ¼ ĞºĞ°ÑÑ‚Ğ¾Ğ¼Ğ½ÑƒÑ ÑĞ¾Ñ€Ñ‚Ğ¸Ñ€Ğ¾Ğ²ĞºÑƒ Ğ¸Ğ· _get_base_query)
        if sort:
            # Ğ£Ğ±Ğ¸Ñ€Ğ°ĞµĞ¼ ĞºĞ°ÑÑ‚Ğ¾Ğ¼Ğ½ÑƒÑ ÑĞ¾Ñ€Ñ‚Ğ¸Ñ€Ğ¾Ğ²ĞºÑƒ Ğ¸Ğ· Ğ±Ğ°Ğ·Ğ¾Ğ²Ğ¾Ğ³Ğ¾ Ğ·Ğ°Ğ¿Ñ€Ğ¾ÑĞ° Ğ¸ Ğ¿Ñ€Ğ¸Ğ¼ĞµĞ½ÑĞµĞ¼ Ğ½Ğ¾Ğ²ÑƒÑ
            base_query = base_query.order_by(None)  # Ğ£Ğ±Ğ¸Ñ€Ğ°ĞµĞ¼ ÑÑƒÑ‰ĞµÑÑ‚Ğ²ÑƒÑÑ‰ÑƒÑ ÑĞ¾Ñ€Ñ‚Ğ¸Ñ€Ğ¾Ğ²ĞºÑƒ
            base_query = self._apply_sorting(base_query, sort, Rental)
        
        # ĞŸĞ¾Ğ»ÑƒÑ‡Ğ°ĞµĞ¼ Ğ¾Ğ±Ñ‰ĞµĞµ ĞºĞ¾Ğ»Ğ¸Ñ‡ĞµÑÑ‚Ğ²Ğ¾
        total = await self._get_total_count(base_query)
        
        # ĞŸÑ€Ğ¸Ğ¼ĞµĞ½ÑĞµĞ¼ Ğ¿Ğ°Ğ³Ğ¸Ğ½Ğ°Ñ†Ğ¸Ñ
        base_query = self._apply_pagination(base_query, skip, limit)
        
        # ĞŸĞ¾Ğ»ÑƒÑ‡Ğ°ĞµĞ¼ Ğ´Ğ°Ğ½Ğ½Ñ‹Ğµ
        rentals_result = await self.db.execute(base_query)
        rentals_orm = rentals_result.unique().scalars().all()
        
        # ĞĞ±Ğ¾Ğ³Ğ°Ñ‰Ğ°ĞµĞ¼ Ğ´Ğ°Ğ½Ğ½Ñ‹Ğµ Ñ‡ĞµÑ€ĞµĞ· FinancialService
        try:
            enriched_rentals = [await self._enrich_rental_with_dynamic_fields(r) for r in rentals_orm]
            return enriched_rentals, total
        except Exception as e:
            logger.error(f"ĞÑˆĞ¸Ğ±ĞºĞ° Ğ² _enrich_rental_with_dynamic_fields: {e}", exc_info=True)
            # Fallback: Ğ²Ğ¾Ğ·Ğ²Ñ€Ğ°Ñ‰Ğ°ĞµĞ¼ Ğ¿Ñ€Ğ¾ÑÑ‚Ñ‹Ğµ Ğ¾Ğ±ÑŠĞµĞºÑ‚Ñ‹
            simple_rentals = [RentalOut.model_validate(r) for r in rentals_orm]
            return simple_rentals, total

    async def get_paginated_rentals(self, skip: int, limit: int, status_filter: Optional[str], search: Optional[str]) -> Tuple[List[RentalOut], int]:
        """ĞŸĞ¾Ğ»ÑƒÑ‡Ğ°ĞµÑ‚ Ğ¾Ñ‚Ñ„Ğ¸Ğ»ÑŒÑ‚Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ½Ñ‹Ğ¹ Ğ¸ Ğ¿Ğ°Ğ³Ğ¸Ğ½Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ½Ñ‹Ğ¹ ÑĞ¿Ğ¸ÑĞ¾Ğº Ğ²ÑĞµÑ… Ğ°Ñ€ĞµĞ½Ğ´."""
        # --- Ğ˜Ğ—ĞœĞ•ĞĞ•ĞĞ˜Ğ• 2: Ğ˜ÑĞ¿Ğ¾Ğ»ÑŒĞ·ÑƒĞµĞ¼ Ğ½Ğ¾Ğ²Ñ‹Ğ¹ Ğ¼ĞµÑ‚Ğ¾Ğ´ Ğ´Ğ»Ñ Ğ¿Ğ¾Ğ»ÑƒÑ‡ĞµĞ½Ğ¸Ñ Ğ·Ğ°Ğ¿Ñ€Ğ¾ÑĞ° ---
        # Ğ¢ĞµĞ¿ĞµÑ€ÑŒ Ğ¸ Ğ¿Ğ¾Ğ´ÑÑ‡ĞµÑ‚, Ğ¸ Ğ²Ñ‹Ğ±Ğ¾Ñ€ĞºĞ° Ğ´ĞµĞ»Ğ°ÑÑ‚ÑÑ Ğ½Ğ° Ğ¾ÑĞ½Ğ¾Ğ²Ğµ Ğ¾Ğ´Ğ½Ğ¾Ğ³Ğ¾ Ğ¸ Ñ‚Ğ¾Ğ³Ğ¾ Ğ¶Ğµ Ğ¾Ñ‚Ñ„Ğ¸Ğ»ÑŒÑ‚Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ½Ğ¾Ğ³Ğ¾ Ğ·Ğ°Ğ¿Ñ€Ğ¾ÑĞ°.
        filtered_query = self._get_filtered_query(status_filter, search)

        # ĞŸĞ¾Ğ»ÑƒÑ‡Ğ°ĞµĞ¼ Ğ¾Ğ±Ñ‰ĞµĞµ ĞºĞ¾Ğ»Ğ¸Ñ‡ĞµÑÑ‚Ğ²Ğ¾ Ğ½Ğ° Ğ¾ÑĞ½Ğ¾Ğ²Ğµ Ğ¾Ñ‚Ñ„Ğ¸Ğ»ÑŒÑ‚Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ½Ğ¾Ğ³Ğ¾ Ğ·Ğ°Ğ¿Ñ€Ğ¾ÑĞ°
        count_query = select(func.count()).select_from(filtered_query.subquery())
        count_result = await self.db.execute(count_query)
        total = count_result.scalar_one()

        # ĞŸĞ¾Ğ»ÑƒÑ‡Ğ°ĞµĞ¼ Ğ´Ğ°Ğ½Ğ½Ñ‹Ğµ Ñ Ğ¿Ğ°Ğ³Ğ¸Ğ½Ğ°Ñ†Ğ¸ĞµĞ¹ Ğ¸Ğ· Ñ‚Ğ¾Ğ³Ğ¾ Ğ¶Ğµ Ğ¾Ñ‚Ñ„Ğ¸Ğ»ÑŒÑ‚Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ½Ğ¾Ğ³Ğ¾ Ğ·Ğ°Ğ¿Ñ€Ğ¾ÑĞ°
        paginated_query = filtered_query.offset(skip).limit(limit)
        rentals_result = await self.db.execute(paginated_query)
        rentals_orm = rentals_result.unique().scalars().all()

        try:
            enriched_rentals = [await self._enrich_rental_with_dynamic_fields(r) for r in rentals_orm]
            return enriched_rentals, total
        except Exception as e:
            logger.error(f"ĞÑˆĞ¸Ğ±ĞºĞ° Ğ² _enrich_rental_with_dynamic_fields: {e}", exc_info=True)
            simple_rentals = [RentalOut.model_validate(r) for r in rentals_orm]
            return simple_rentals, total

```



## `api\services\reservation_query_service.py`


```python

# api/services/reservation_query_service.py

from sqlalchemy.ext.asyncio import AsyncSession
from sqlalchemy.orm import joinedload, selectinload
from sqlalchemy import or_, select, func
from typing import List, Optional, Tuple
from datetime import date
import logging

from api.models.user import User
from api.models.reservation import Reservation, ReservationAccessory
from api.models.equipment import Equipment
from shared.schemas.reservation_schema import AdminReservationOut, ReservationItem
from shared.schemas.user_schema import UserOut
from api.services.financial_service import FinancialService
from api.services.order.order_query_base import OrderQueryBase

logger = logging.getLogger(__name__)

class ReservationQueryService(OrderQueryBase[Reservation]):
    """
    Ğ•Ğ´Ğ¸Ğ½Ñ‹Ğ¹ ÑĞµÑ€Ğ²Ğ¸Ñ Ğ´Ğ»Ñ Ğ²Ñ‹Ğ¿Ğ¾Ğ»Ğ½ĞµĞ½Ğ¸Ñ Ğ¾Ğ¿ĞµÑ€Ğ°Ñ†Ğ¸Ğ¹ Ñ‡Ñ‚ĞµĞ½Ğ¸Ñ (Query) Ğ´Ğ°Ğ½Ğ½Ñ‹Ñ… Ğ¾ Ñ€ĞµĞ·ĞµÑ€Ğ²Ğ°Ñ….
    """

    def __init__(self, db: AsyncSession):
        super().__init__(db)
        self.financial_service = FinancialService(db)

    async def get_my_reservations(
        self, 
        user: User, 
        status: Optional[str] = None,
        search: Optional[str] = None,
        sort: Optional[str] = None,
        skip: int = 0,
        limit: int = 100
    ) -> Tuple[List[ReservationItem], int]:
        """ĞŸĞ¾Ğ»ÑƒÑ‡Ğ°ĞµÑ‚ Ğ¾Ñ‚Ñ„Ğ¸Ğ»ÑŒÑ‚Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ½Ñ‹Ğ¹ Ğ¸ Ğ¿Ğ°Ğ³Ğ¸Ğ½Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ½Ñ‹Ğ¹ ÑĞ¿Ğ¸ÑĞ¾Ğº Ñ€ĞµĞ·ĞµÑ€Ğ²Ğ¾Ğ² Ğ´Ğ»Ñ Ñ‚ĞµĞºÑƒÑ‰ĞµĞ³Ğ¾ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ñ."""
        
        # Ğ¡Ğ¾Ğ·Ğ´Ğ°ĞµĞ¼ Ğ±Ğ°Ğ·Ğ¾Ğ²Ñ‹Ğ¹ Ğ·Ğ°Ğ¿Ñ€Ğ¾Ñ
        query = select(Reservation).filter(Reservation.user_id == user.id)
        
        # ĞŸÑ€Ğ¸Ğ¼ĞµĞ½ÑĞµĞ¼ Ñ„Ğ¸Ğ»ÑŒÑ‚Ñ€Ğ°Ñ†Ğ¸Ñ Ğ¿Ğ¾ ÑÑ‚Ğ°Ñ‚ÑƒÑÑƒ
        query = self._apply_status_filter(query, status, Reservation)
        
        # ĞŸÑ€Ğ¸Ğ¼ĞµĞ½ÑĞµĞ¼ Ğ¿Ğ¾Ğ¸ÑĞº Ğ¿Ğ¾ Ğ¾Ğ±Ğ¾Ñ€ÑƒĞ´Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ
        if search:
            query = self._apply_equipment_search(query, search, Reservation)
        
        # Ğ”Ğ¾Ğ±Ğ°Ğ²Ğ»ÑĞµĞ¼ Ğ½ĞµĞ¾Ğ±Ñ…Ğ¾Ğ´Ğ¸Ğ¼Ñ‹Ğµ JOIN'Ñ‹
        query = query.options(
            joinedload(Reservation.applied_promo_code),
            joinedload(Reservation.accessory_links).joinedload(ReservationAccessory.accessory),
            selectinload(Reservation.equipment).options(
                selectinload(Equipment.accessories),
                selectinload(Equipment.associations)
            ),
            joinedload(Reservation.rental)
        )
        
        # ĞŸÑ€Ğ¸Ğ¼ĞµĞ½ÑĞµĞ¼ ÑĞ¾Ñ€Ñ‚Ğ¸Ñ€Ğ¾Ğ²ĞºÑƒ
        query = self._apply_sorting(query, sort, Reservation)
        
        # ĞŸĞ¾Ğ»ÑƒÑ‡Ğ°ĞµĞ¼ Ğ¾Ğ±Ñ‰ĞµĞµ ĞºĞ¾Ğ»Ğ¸Ñ‡ĞµÑÑ‚Ğ²Ğ¾
        total = await self._get_total_count(query)
        
        # ĞŸÑ€Ğ¸Ğ¼ĞµĞ½ÑĞµĞ¼ Ğ¿Ğ°Ğ³Ğ¸Ğ½Ğ°Ñ†Ğ¸Ñ
        query = self._apply_pagination(query, skip, limit)
        
        # Ğ’Ñ‹Ğ¿Ğ¾Ğ»Ğ½ÑĞµĞ¼ Ğ·Ğ°Ğ¿Ñ€Ğ¾Ñ
        result = await self.db.execute(query)
        reservations_orm = result.unique().scalars().all()
        
        # ĞĞ±Ñ€Ğ°Ğ±Ğ°Ñ‚Ñ‹Ğ²Ğ°ĞµĞ¼ ÑÑ‚Ğ°Ñ‚ÑƒÑÑ‹ Ğ¸ Ğ¿Ñ€ĞµĞ¾Ğ±Ñ€Ğ°Ğ·ÑƒĞµĞ¼ Ğ² DTO Ñ‡ĞµÑ€ĞµĞ· FinancialService
        items_dto = []
        for r_orm in reservations_orm:
            try:
                item_dto = await self.financial_service.enrich_order_with_financials(r_orm)
                items_dto.append(item_dto)
            except Exception as e:
                logger.error(f"ĞÑˆĞ¸Ğ±ĞºĞ° Ğ¾Ğ±Ğ¾Ğ³Ğ°Ñ‰ĞµĞ½Ğ¸Ñ Ñ€ĞµĞ·ĞµÑ€Ğ²Ğ° ID {r_orm.id}: {e}")
                # Fallback: Ğ¿Ñ€Ğ¾ÑÑ‚Ğ°Ñ Ğ²Ğ°Ğ»Ğ¸Ğ´Ğ°Ñ†Ğ¸Ñ
                item_dto = ReservationItem.model_validate(r_orm)
                items_dto.append(item_dto)
        
        return items_dto, total

    def _get_admin_base_query(self, status_filter: Optional[str] = None, search_query: Optional[str] = None):
        """Ğ’ÑĞ¿Ğ¾Ğ¼Ğ¾Ğ³Ğ°Ñ‚ĞµĞ»ÑŒĞ½Ñ‹Ğ¹ Ğ¼ĞµÑ‚Ğ¾Ğ´ Ğ´Ğ»Ñ ÑĞ¾Ğ·Ğ´Ğ°Ğ½Ğ¸Ñ Ğ±Ğ°Ğ·Ğ¾Ğ²Ğ¾Ğ³Ğ¾ Ğ·Ğ°Ğ¿Ñ€Ğ¾ÑĞ° Ñ Ñ„Ğ¸Ğ»ÑŒÑ‚Ñ€Ğ°Ğ¼Ğ¸ Ğ´Ğ»Ñ Ğ°Ğ´Ğ¼Ğ¸Ğ½-Ğ¿Ğ°Ğ½ĞµĞ»Ğ¸."""
        query = select(Reservation).options(
            joinedload(Reservation.user),
            joinedload(Reservation.applied_promo_code),
            joinedload(Reservation.accessory_links).joinedload(ReservationAccessory.accessory),
            selectinload(Reservation.equipment).options(
                selectinload(Equipment.accessories),
                selectinload(Equipment.associations)
            ),
            joinedload(Reservation.rental)
        )
        if search_query:
            query = self._apply_user_search(query, search_query, Reservation)

        if status_filter == "active":
            query = query.filter(Reservation.status == 'active')
        elif status_filter == "completed":
            query = query.filter(Reservation.status.in_(['fulfilled', 'cancelled', 'overdue']))

        return query

    async def get_admin_reservations_count(self, status: Optional[str] = None, search_query: Optional[str] = None) -> int:
        """ĞŸĞ¾Ğ»ÑƒÑ‡Ğ°ĞµÑ‚ Ğ¾Ğ±Ñ‰ĞµĞµ ĞºĞ¾Ğ»Ğ¸Ñ‡ĞµÑÑ‚Ğ²Ğ¾ Ñ€ĞµĞ·ĞµÑ€Ğ²Ğ¾Ğ² Ñ ÑƒÑ‡ĞµÑ‚Ğ¾Ğ¼ Ñ„Ğ¸Ğ»ÑŒÑ‚Ñ€Ğ¾Ğ² Ğ´Ğ»Ñ Ğ°Ğ´Ğ¼Ğ¸Ğ½-Ğ¿Ğ°Ğ½ĞµĞ»Ğ¸."""
        query = self._get_admin_base_query(status, search_query)
        result = await self.db.execute(select(func.count()).select_from(query.subquery()))
        return result.scalar_one()

    async def get_paginated_admin_reservations(self, skip: int, limit: int, status: Optional[str] = None, search_query: Optional[str] = None) -> List[AdminReservationOut]:
        """ĞŸĞ¾Ğ»ÑƒÑ‡Ğ°ĞµÑ‚ ÑÑ‚Ñ€Ğ°Ğ½Ğ¸Ñ†Ñƒ Ñ€ĞµĞ·ĞµÑ€Ğ²Ğ¾Ğ² Ñ Ğ¿Ğ°Ğ³Ğ¸Ğ½Ğ°Ñ†Ğ¸ĞµĞ¹ Ğ´Ğ»Ñ Ğ°Ğ´Ğ¼Ğ¸Ğ½-Ğ¿Ğ°Ğ½ĞµĞ»Ğ¸."""
        query = self._get_admin_base_query(status, search_query)
        result = await self.db.execute(query.order_by(Reservation.id.desc()).offset(skip).limit(limit))
        reservations_orm = result.unique().scalars().all()

        result = []
        for r_orm in reservations_orm:
            if not r_orm.user:
                continue
            try:
                # Ğ˜ÑĞ¿Ğ¾Ğ»ÑŒĞ·ÑƒĞµĞ¼ FinancialService Ğ´Ğ»Ñ Ğ¾Ğ±Ğ¾Ğ³Ğ°Ñ‰ĞµĞ½Ğ¸Ñ Ğ°Ğ´Ğ¼Ğ¸Ğ½-Ñ€ĞµĞ·ĞµÑ€Ğ²Ğ°
                final_output = await self.financial_service._enrich_admin_reservation_with_financials(r_orm)
                result.append(final_output)
            except Exception as e:
                logger.error(f"ĞÑˆĞ¸Ğ±ĞºĞ° Ğ²Ğ°Ğ»Ğ¸Ğ´Ğ°Ñ†Ğ¸Ğ¸ Ğ°Ğ´Ğ¼Ğ¸Ğ½-Ñ€ĞµĞ·ĞµÑ€Ğ²Ğ° ID {r_orm.id}: {e}", exc_info=True)
                continue
        return result

```



## `api\services\user_service.py`


```python

# src/api/services/user_service.py

from sqlalchemy.ext.asyncio import AsyncSession
from sqlalchemy.orm import joinedload
from sqlalchemy import select, func
from api.models.user import User
from api.models.payment import Payment
# +++ Ğ”ĞĞ‘ĞĞ’Ğ¬Ğ¢Ğ• Ğ­Ğ¢ĞĞ¢ Ğ˜ĞœĞŸĞĞ Ğ¢ +++
from api.models.balance_history import BalanceHistory
from api.services.balance_service import BalanceService
from shared.schemas.user_schema import UserUpdate, UserOut, AdminUserCreate, AdminUserUpdate, UserPaymentRequest
from api.services import auth_service
from fastapi import HTTPException
import logging
from datetime import datetime
from typing import List, Tuple


async def create_admin_user(db: AsyncSession, user_data: AdminUserCreate) -> User:
    """Ğ¡Ğ¾Ğ·Ğ´Ğ°ĞµÑ‚ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ñ (Ğ´Ğ»Ñ Ğ°Ğ´Ğ¼Ğ¸Ğ½Ğ¾Ğ²)."""
    result = await db.execute(select(User).filter(User.email == user_data.email))
    existing_user = result.scalars().first()
    if existing_user:
        raise HTTPException(status_code=409, detail="ĞŸĞ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ÑŒ Ñ Ñ‚Ğ°ĞºĞ¸Ğ¼ email ÑƒĞ¶Ğµ ÑÑƒÑ‰ĞµÑÑ‚Ğ²ÑƒĞµÑ‚.")

    try:
        new_user = User(
            full_name=user_data.full_name,
            email=user_data.email,
            hashed_password=auth_service.hash_password(user_data.password),
            phone=user_data.phone,
            role=user_data.role,
            is_active=True,
            status="ĞĞºÑ‚Ğ¸Ğ²Ğ½Ñ‹Ğ¹",
            balance=0.0,
            notes=f"Ğ¡Ğ¾Ğ·Ğ´Ğ°Ğ½ Ğ°Ğ´Ğ¼Ğ¸Ğ½Ğ¸ÑÑ‚Ñ€Ğ°Ñ‚Ğ¾Ñ€Ğ¾Ğ¼ {datetime.now().strftime('%d-%m-%Y')}",
            privacy_policy_accepted=user_data.privacy_policy_accepted,
            terms_accepted=user_data.terms_accepted,
            email_verified=True
        )
        db.add(new_user)
        await db.commit()
        
        # Ğ’Ğ¾Ğ·Ğ²Ñ€Ğ°Ñ‰Ğ°ĞµĞ¼ ÑĞ¾Ğ·Ğ´Ğ°Ğ½Ğ½Ñ‹Ğ¹ Ğ¾Ğ±ÑŠĞµĞºÑ‚ Ğ±ĞµĞ· Ğ¿Ğ¾Ğ²Ñ‚Ğ¾Ñ€Ğ½Ğ¾Ğ³Ğ¾ Ğ·Ğ°Ğ¿Ñ€Ğ¾ÑĞ° Ğº Ğ‘Ğ”
        return new_user
    except Exception as e:
        await db.rollback()
        logging.error(f"ĞÑˆĞ¸Ğ±ĞºĞ° Ğ¿Ñ€Ğ¸ ÑĞ¾Ğ·Ğ´Ğ°Ğ½Ğ¸Ğ¸ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ñ Ğ°Ğ´Ğ¼Ğ¸Ğ½Ğ¸ÑÑ‚Ñ€Ğ°Ñ‚Ğ¾Ñ€Ğ¾Ğ¼: {e}")
        raise HTTPException(status_code=500, detail="Ğ’Ğ½ÑƒÑ‚Ñ€ĞµĞ½Ğ½ÑÑ Ğ¾ÑˆĞ¸Ğ±ĞºĞ° ÑĞµÑ€Ğ²ĞµÑ€Ğ°.")

def get_current_user_info(user: User) -> UserOut:
    return UserOut.from_orm(user)

async def update_user(db: AsyncSession, user: User, data: UserUpdate) -> UserOut:
    """ĞĞ±Ğ½Ğ¾Ğ²Ğ»ÑĞµÑ‚ Ğ¿Ñ€Ğ¾Ñ„Ğ¸Ğ»ÑŒ Ñ‚ĞµĞºÑƒÑ‰ĞµĞ³Ğ¾ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ñ."""
    update_data = data.model_dump(exclude_unset=True)

    if 'email' in update_data and update_data['email'] != user.email:
        logging.info(f"ĞŸĞ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ÑŒ {user.id} Ğ·Ğ°Ğ¿Ñ€Ğ¾ÑĞ¸Ğ» ÑĞ¼ĞµĞ½Ñƒ email Ğ½Ğ° {update_data['email']}. Ğ¢Ñ€ĞµĞ±ÑƒĞµÑ‚ÑÑ Ğ¿Ğ¾Ğ´Ñ‚Ğ²ĞµÑ€Ğ¶Ğ´ĞµĞ½Ğ¸Ğµ.")
        del update_data['email']

    for key, value in update_data.items():
        setattr(user, key, value)

    db.add(user)
    await db.commit()
    
    # Ğ’Ğ¾Ğ·Ğ²Ñ€Ğ°Ñ‰Ğ°ĞµĞ¼ Ğ¾Ğ±Ğ½Ğ¾Ğ²Ğ»ĞµĞ½Ğ½Ñ‹Ğ¹ Ğ¾Ğ±ÑŠĞµĞºÑ‚ Ğ±ĞµĞ· Ğ¿Ğ¾Ğ²Ñ‚Ğ¾Ñ€Ğ½Ğ¾Ğ³Ğ¾ Ğ·Ğ°Ğ¿Ñ€Ğ¾ÑĞ° Ğº Ğ‘Ğ”
    return UserOut.from_orm(user)

async def update_user_by_admin(db: AsyncSession, user_id: int, data: AdminUserUpdate, current_user: User) -> UserOut:
    """ĞĞ±Ğ½Ğ¾Ğ²Ğ»ÑĞµÑ‚ Ğ´Ğ°Ğ½Ğ½Ñ‹Ğµ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ñ. Ğ¢Ğ¾Ğ»ÑŒĞºĞ¾ Ğ°Ğ´Ğ¼Ğ¸Ğ½ Ğ¼Ğ¾Ğ¶ĞµÑ‚ Ğ¼ĞµĞ½ÑÑ‚ÑŒ Ñ€Ğ¾Ğ»ÑŒ."""
    result = await db.execute(select(User).filter(User.id == user_id))
    user_to_update = result.scalars().first()
    if not user_to_update:
        raise HTTPException(status_code=404, detail="ĞŸĞ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ÑŒ Ğ½Ğµ Ğ½Ğ°Ğ¹Ğ´ĞµĞ½")

    update_data = data.model_dump(exclude_unset=True)

    if 'role' in update_data and current_user.role != 'admin':
        raise HTTPException(status_code=403, detail="Ğ¢Ğ¾Ğ»ÑŒĞºĞ¾ Ğ°Ğ´Ğ¼Ğ¸Ğ½Ğ¸ÑÑ‚Ñ€Ğ°Ñ‚Ğ¾Ñ€ Ğ¼Ğ¾Ğ¶ĞµÑ‚ Ğ¸Ğ·Ğ¼ĞµĞ½ÑÑ‚ÑŒ Ñ€Ğ¾Ğ»ÑŒ.")

    for key, value in update_data.items():
        setattr(user_to_update, key, value)

    db.add(user_to_update)
    await db.commit()
    
    # Ğ’Ğ¾Ğ·Ğ²Ñ€Ğ°Ñ‰Ğ°ĞµĞ¼ Ğ¾Ğ±Ğ½Ğ¾Ğ²Ğ»ĞµĞ½Ğ½Ñ‹Ğ¹ Ğ¾Ğ±ÑŠĞµĞºÑ‚ Ğ±ĞµĞ· Ğ¿Ğ¾Ğ²Ñ‚Ğ¾Ñ€Ğ½Ğ¾Ğ³Ğ¾ Ğ·Ğ°Ğ¿Ñ€Ğ¾ÑĞ° Ğº Ğ‘Ğ”
    return UserOut.from_orm(user_to_update)

async def process_user_payment(db: AsyncSession, user_id: int, payment_data: UserPaymentRequest, manager: User) -> UserOut:
    """ĞĞ±Ñ€Ğ°Ğ±Ğ°Ñ‚Ñ‹Ğ²Ğ°ĞµÑ‚ Ñ€ĞµĞ°Ğ»ÑŒĞ½Ñ‹Ğ¹ Ğ¿Ğ»Ğ°Ñ‚ĞµĞ¶ Ğ¸ Ğ¿Ğ¾Ğ¿Ğ¾Ğ»Ğ½ÑĞµÑ‚ Ğ²Ğ½ÑƒÑ‚Ñ€ĞµĞ½Ğ½Ğ¸Ğ¹ Ğ±Ğ°Ğ»Ğ°Ğ½Ñ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ñ."""
    result = await db.execute(select(User).filter(User.id == user_id))
    user_to_update = result.scalars().first()
    if not user_to_update:
        raise HTTPException(status_code=404, detail="ĞŸĞ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ÑŒ Ğ½Ğµ Ğ½Ğ°Ğ¹Ğ´ĞµĞ½")

    try:
        new_payment = Payment(
            user_id=user_id,
            amount=payment_data.amount,
            payment_method=payment_data.payment_method,
            description=payment_data.description or f"ĞŸĞ»Ğ°Ñ‚ĞµĞ¶ Ğ¿Ñ€Ğ¸Ğ½ÑÑ‚ {manager.full_name}",
            transaction_type="balance_top_up"
        )
        db.add(new_payment)

        balance_service = BalanceService(db)
        await balance_service.add_transaction(
            user_id=user_id,
            amount=payment_data.amount,
            operation_type="balance_top_up",
            description=f"ĞŸĞ¾Ğ¿Ğ¾Ğ»Ğ½ĞµĞ½Ğ¸Ğµ Ğ±Ğ°Ğ»Ğ°Ğ½ÑĞ°. ĞœĞµÑ‚Ğ¾Ğ´: {payment_data.payment_method}."
        )

        await db.commit()
        
        # Ğ’Ğ¾Ğ·Ğ²Ñ€Ğ°Ñ‰Ğ°ĞµĞ¼ Ğ¾Ğ±Ğ½Ğ¾Ğ²Ğ»ĞµĞ½Ğ½Ñ‹Ğ¹ Ğ¾Ğ±ÑŠĞµĞºÑ‚ Ğ±ĞµĞ· Ğ¿Ğ¾Ğ²Ñ‚Ğ¾Ñ€Ğ½Ğ¾Ğ³Ğ¾ Ğ·Ğ°Ğ¿Ñ€Ğ¾ÑĞ° Ğº Ğ‘Ğ”
        return UserOut.from_orm(user_to_update)

    except HTTPException:
        await db.rollback()
        raise
    except Exception as e:
        await db.rollback()
        logging.error(f"ĞÑˆĞ¸Ğ±ĞºĞ° Ğ¿Ñ€Ğ¸ Ğ¾Ğ±Ñ€Ğ°Ğ±Ğ¾Ñ‚ĞºĞµ Ğ¿Ğ»Ğ°Ñ‚ĞµĞ¶Ğ° Ğ´Ğ»Ñ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ñ ID={user_id}: {e}", exc_info=True)
        raise HTTPException(status_code=500, detail="Ğ’Ğ½ÑƒÑ‚Ñ€ĞµĞ½Ğ½ÑÑ Ğ¾ÑˆĞ¸Ğ±ĞºĞ° Ğ¿Ñ€Ğ¸ Ğ¾Ğ±Ñ€Ğ°Ğ±Ğ¾Ñ‚ĞºĞµ Ğ¿Ğ»Ğ°Ñ‚ĞµĞ¶Ğ°.")

# +++ ĞĞĞ§ĞĞ›Ğ: ĞĞ¾Ğ²Ğ°Ñ Ñ„ÑƒĞ½ĞºÑ†Ğ¸Ñ +++
async def get_balance_history_for_user(db: AsyncSession, user_id: int, skip: int, limit: int) -> Tuple[List[BalanceHistory], int]:
    """ĞŸĞ¾Ğ»ÑƒÑ‡Ğ°ĞµÑ‚ Ğ¿Ğ°Ğ³Ğ¸Ğ½Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ½ÑƒÑ Ğ¸ÑÑ‚Ğ¾Ñ€Ğ¸Ñ Ğ±Ğ°Ğ»Ğ°Ğ½ÑĞ° Ğ´Ğ»Ñ ÑƒĞºĞ°Ğ·Ğ°Ğ½Ğ½Ğ¾Ğ³Ğ¾ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ñ."""

    total_result = await db.execute(
        select(func.count(BalanceHistory.id)).filter(BalanceHistory.user_id == user_id)
    )
    total = total_result.scalar_one()

    history_result = await db.execute(
        select(BalanceHistory)
        .filter(BalanceHistory.user_id == user_id)
        .order_by(BalanceHistory.created_at.desc())
        .offset(skip)
        .limit(limit)
    )
    history_items = history_result.scalars().all()

    return history_items, total
# +++ ĞšĞĞĞ•Ğ¦: ĞĞ¾Ğ²Ğ°Ñ Ñ„ÑƒĞ½ĞºÑ†Ğ¸Ñ +++

```



## `api\user_api.py`


```python

# api/user_api.py

from fastapi import APIRouter, Depends, HTTPException, Query
from sqlalchemy.ext.asyncio import AsyncSession
from sqlalchemy import select, func
from typing import List, Optional

from api.models.user import User as OrmUser
from api.deps import get_db, get_rental_query_service
from api.permissions import require_user, require_manager, require_admin
from api.models.user import User as PermissionUser
from api.services import user_service
# <-- Ğ˜Ğ—ĞœĞ•ĞĞ•ĞĞ˜Ğ• Ğ—Ğ”Ğ•Ğ¡Ğ¬: ĞĞ±Ğ½Ğ¾Ğ²Ğ»ÑĞµĞ¼ Ğ¿ÑƒÑ‚ÑŒ Ğ¸Ğ¼Ğ¿Ğ¾Ñ€Ñ‚Ğ°
from api.services.rental.rental_query_service import RentalQueryService
# ---------------------------------------------------
from shared.schemas.rental_schema import RentalListResponse, RentalOut
from shared.schemas.user_schema import UserUpdate, UserOut, AdminUserCreate, AdminUserUpdate, UserListResponse, UserPaymentRequest
from shared.schemas.balance_history_schema import BalanceHistoryOut, BalanceHistoryListResponse
from fastapi_csrf_protect import CsrfProtect

router = APIRouter(prefix="/user", tags=["ĞŸÑ€Ğ¾Ñ„Ğ¸Ğ»ÑŒ Ğ¸ ĞŸĞ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ğ¸"])


@router.get("/", response_model=UserOut)
def get_my_profile(current_user: PermissionUser = Depends(require_user)):
    """
    Ğ’Ğ¾Ğ·Ğ²Ñ€Ğ°Ñ‰Ğ°ĞµÑ‚ Ğ¿Ñ€Ğ¾Ñ„Ğ¸Ğ»ÑŒ Ñ‚ĞµĞºÑƒÑ‰ĞµĞ³Ğ¾ Ğ°Ğ²Ñ‚Ğ¾Ñ€Ğ¸Ğ·Ğ¾Ğ²Ğ°Ğ½Ğ½Ğ¾Ğ³Ğ¾ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ñ.
    """
    return user_service.get_current_user_info(current_user)


@router.get("/rentals", response_model=RentalListResponse)
async def get_my_rentals(
        current_user: PermissionUser = Depends(require_user),
        service: RentalQueryService = Depends(get_rental_query_service),
        status: Optional[str] = Query(None, description="Ğ¤Ğ¸Ğ»ÑŒÑ‚Ñ€ Ğ¿Ğ¾ ÑÑ‚Ğ°Ñ‚ÑƒÑÑƒ: active, completed, overdue"),
        search: Optional[str] = Query(None, description="ĞŸĞ¾Ğ¸ÑĞº Ğ¿Ğ¾ Ğ½Ğ°Ğ·Ğ²Ğ°Ğ½Ğ¸Ñ, Ğ±Ñ€ĞµĞ½Ğ´Ñƒ Ğ¸Ğ»Ğ¸ Ñ‚Ğ¸Ğ¿Ñƒ Ğ¾Ğ±Ğ¾Ñ€ÑƒĞ´Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ"),
        sort: Optional[str] = Query(None, description="Ğ¡Ğ¾Ñ€Ñ‚Ğ¸Ñ€Ğ¾Ğ²ĞºĞ°: id_desc, id_asc, start_date_desc, start_date_asc, end_date_desc, end_date_asc, count_desc, count_asc"),
        skip: int = Query(0, ge=0, description="ĞšĞ¾Ğ»Ğ¸Ñ‡ĞµÑÑ‚Ğ²Ğ¾ Ğ·Ğ°Ğ¿Ğ¸ÑĞµĞ¹ Ğ´Ğ»Ñ Ğ¿Ñ€Ğ¾Ğ¿ÑƒÑĞºĞ°"),
        limit: int = Query(10, ge=1, le=100, description="ĞœĞ°ĞºÑĞ¸Ğ¼Ğ°Ğ»ÑŒĞ½Ğ¾Ğµ ĞºĞ¾Ğ»Ğ¸Ñ‡ĞµÑÑ‚Ğ²Ğ¾ Ğ·Ğ°Ğ¿Ğ¸ÑĞµĞ¹ Ğ½Ğ° ÑÑ‚Ñ€Ğ°Ğ½Ğ¸Ñ†Ğµ")
):
    """
    Ğ’Ğ¾Ğ·Ğ²Ñ€Ğ°Ñ‰Ğ°ĞµÑ‚ Ğ¾Ñ‚Ñ„Ğ¸Ğ»ÑŒÑ‚Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ½Ñ‹Ğ¹ Ğ¸ Ğ¿Ğ°Ğ³Ğ¸Ğ½Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ½Ñ‹Ğ¹ ÑĞ¿Ğ¸ÑĞ¾Ğº Ğ°Ñ€ĞµĞ½Ğ´ Ğ´Ğ»Ñ Ñ‚ĞµĞºÑƒÑ‰ĞµĞ³Ğ¾ Ğ°Ğ²Ñ‚Ğ¾Ñ€Ğ¸Ğ·Ğ¾Ğ²Ğ°Ğ½Ğ½Ğ¾Ğ³Ğ¾ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ñ.
    """
    rentals_out, total = await service.get_rentals_for_user(
        current_user, skip, limit, status, search, sort
    )
    return RentalListResponse(
        items=rentals_out,
        total=total
    )


@router.get("/balance-history", response_model=BalanceHistoryListResponse)
async def get_my_balance_history(
        db: AsyncSession = Depends(get_db),
        current_user: PermissionUser = Depends(require_user),
        skip: int = Query(0, ge=0),
        limit: int = Query(15, ge=1, le=100)
):
    """
    Ğ’Ğ¾Ğ·Ğ²Ñ€Ğ°Ñ‰Ğ°ĞµÑ‚ Ğ¸ÑÑ‚Ğ¾Ñ€Ğ¸Ñ Ñ‚Ñ€Ğ°Ğ½Ğ·Ğ°ĞºÑ†Ğ¸Ğ¹ Ğ¿Ğ¾ Ğ±Ğ°Ğ»Ğ°Ğ½ÑÑƒ Ğ´Ğ»Ñ Ñ‚ĞµĞºÑƒÑ‰ĞµĞ³Ğ¾ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ñ.
    """
    history_orm, total = await user_service.get_balance_history_for_user(db, current_user.id, skip, limit)
    return BalanceHistoryListResponse(
        items=[BalanceHistoryOut.from_orm(h) for h in history_orm],
        total=total
    )


@router.put("/", response_model=UserOut)
async def update_my_profile(
        data: UserUpdate,
        db: AsyncSession = Depends(get_db),
        current_user: PermissionUser = Depends(require_user),
        csrf_protect: CsrfProtect = Depends()
):
    """
    ĞĞ±Ğ½Ğ¾Ğ²Ğ»ÑĞµÑ‚ Ğ¿Ñ€Ğ¾Ñ„Ğ¸Ğ»ÑŒ (Ğ¤Ğ˜Ğ, email, Ñ‚ĞµĞ»ĞµÑ„Ğ¾Ğ½) Ñ‚ĞµĞºÑƒÑ‰ĞµĞ³Ğ¾ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ñ.
    Ğ—ĞĞ“Ğ›Ğ£Ğ¨ĞšĞ: Ğ¡Ğ¼ĞµĞ½Ğ° email Ğ² Ğ±ÑƒĞ´ÑƒÑ‰ĞµĞ¼ Ğ¿Ğ¾Ñ‚Ñ€ĞµĞ±ÑƒĞµÑ‚ Ğ¿Ğ¾Ğ´Ñ‚Ğ²ĞµÑ€Ğ¶Ğ´ĞµĞ½Ğ¸Ñ Ğ¿Ğ¾ Ğ¿Ğ¾Ñ‡Ñ‚Ğµ.
    """
    return await user_service.update_user(db, current_user, data)


@router.post("/confirm-email-change", summary="ĞŸĞ¾Ğ´Ñ‚Ğ²ĞµÑ€Ğ´Ğ¸Ñ‚ÑŒ ÑĞ¼ĞµĞ½Ñƒ email (Ğ·Ğ°Ğ³Ğ»ÑƒÑˆĞºĞ°)")
async def confirm_email_change(
        token: str,
        db: AsyncSession = Depends(get_db),
        current_user: PermissionUser = Depends(require_user),
        csrf_protect: CsrfProtect = Depends()
):
    """
    Ğ—ĞĞ“Ğ›Ğ£Ğ¨ĞšĞ: Ğ’ Ğ±ÑƒĞ´ÑƒÑ‰ĞµĞ¼ Ğ·Ğ´ĞµÑÑŒ Ğ±ÑƒĞ´ĞµÑ‚ Ğ»Ğ¾Ğ³Ğ¸ĞºĞ° Ğ¿Ğ¾Ğ´Ñ‚Ğ²ĞµÑ€Ğ¶Ğ´ĞµĞ½Ğ¸Ñ ÑĞ¼ĞµĞ½Ñ‹ email Ğ¿Ğ¾ Ñ‚Ğ¾ĞºĞµĞ½Ñƒ.
    Ğ¡ĞµĞ¹Ñ‡Ğ°Ñ Ğ¿Ñ€Ğ¾ÑÑ‚Ğ¾ Ğ²Ğ¾Ğ·Ğ²Ñ€Ğ°Ñ‰Ğ°ĞµÑ‚ ÑĞ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ğµ Ğ¾ Ñ‚Ğ¾Ğ¼, Ñ‡Ñ‚Ğ¾ Ñ„ÑƒĞ½ĞºÑ†Ğ¸Ğ¾Ğ½Ğ°Ğ» Ğ² Ñ€Ğ°Ğ·Ñ€Ğ°Ğ±Ğ¾Ñ‚ĞºĞµ.
    """
    return {
        "message": "Ğ¤ÑƒĞ½ĞºÑ†Ğ¸Ğ¾Ğ½Ğ°Ğ» Ğ¿Ğ¾Ğ´Ñ‚Ğ²ĞµÑ€Ğ¶Ğ´ĞµĞ½Ğ¸Ñ ÑĞ¼ĞµĞ½Ñ‹ email Ğ½Ğ°Ñ…Ğ¾Ğ´Ğ¸Ñ‚ÑÑ Ğ² Ñ€Ğ°Ğ·Ñ€Ğ°Ğ±Ğ¾Ñ‚ĞºĞµ",
        "status": "not_implemented"
    }


# --- Ğ­Ğ½Ğ´Ğ¿Ğ¾Ğ¸Ğ½Ñ‚Ñ‹ Ğ´Ğ»Ñ Ğ°Ğ´Ğ¼Ğ¸Ğ½Ğ¸ÑÑ‚Ñ€Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ ---

@router.post("/admin/users", response_model=UserOut, status_code=201, summary="Ğ¡Ğ¾Ğ·Ğ´Ğ°Ñ‚ÑŒ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ñ (ĞĞ´Ğ¼Ğ¸Ğ½)")
async def create_user_by_admin(
        user_data: AdminUserCreate,
        db: AsyncSession = Depends(get_db),
        current_user: PermissionUser = Depends(require_admin),
        csrf_protect: CsrfProtect = Depends()
):
    """
    Ğ¡Ğ¾Ğ·Ğ´Ğ°ĞµÑ‚ Ğ½Ğ¾Ğ²Ğ¾Ğ³Ğ¾ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ñ Ñ ÑƒĞºĞ°Ğ·Ğ°Ğ½Ğ½Ğ¾Ğ¹ Ñ€Ğ¾Ğ»ÑŒÑ.
    Ğ”Ğ¾ÑÑ‚ÑƒĞ¿Ğ½Ğ¾ Ñ‚Ğ¾Ğ»ÑŒĞºĞ¾ Ğ´Ğ»Ñ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ĞµĞ¹ Ñ Ñ€Ğ¾Ğ»ÑŒÑ 'admin'.
    """
    new_user = await user_service.create_admin_user(db, user_data)
    return new_user


@router.get("/admin/users", response_model=UserListResponse, summary="ĞŸĞ¾Ğ»ÑƒÑ‡Ğ¸Ñ‚ÑŒ Ğ²ÑĞµÑ… Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ĞµĞ¹ (ĞœĞµĞ½ĞµĞ´Ğ¶ĞµÑ€)")
async def get_all_users(
        db: AsyncSession = Depends(get_db),
        current_user: PermissionUser = Depends(require_manager),
        skip: int = Query(0, ge=0, description="Ğ¡ĞºĞ¾Ğ»ÑŒĞºĞ¾ Ğ·Ğ°Ğ¿Ğ¸ÑĞµĞ¹ Ğ¿Ñ€Ğ¾Ğ¿ÑƒÑÑ‚Ğ¸Ñ‚ÑŒ"),
        limit: int = Query(10, ge=1, le=100, description="ĞœĞ°ĞºÑĞ¸Ğ¼Ğ°Ğ»ÑŒĞ½Ğ¾Ğµ ĞºĞ¾Ğ»Ğ¸Ñ‡ĞµÑÑ‚Ğ²Ğ¾ Ğ·Ğ°Ğ¿Ğ¸ÑĞµĞ¹ Ğ½Ğ° ÑÑ‚Ñ€Ğ°Ğ½Ğ¸Ñ†Ğµ")
):
    """
    ĞŸĞ¾Ğ»ÑƒÑ‡Ğ°ĞµÑ‚ ÑĞ¿Ğ¸ÑĞ¾Ğº Ğ²ÑĞµÑ… Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ĞµĞ¹ Ğ² ÑĞ¸ÑÑ‚ĞµĞ¼Ğµ Ñ Ğ¿Ğ°Ğ³Ğ¸Ğ½Ğ°Ñ†Ğ¸ĞµĞ¹.
    Ğ”Ğ¾ÑÑ‚ÑƒĞ¿Ğ½Ğ¾ Ğ´Ğ»Ñ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ĞµĞ¹ Ñ Ñ€Ğ¾Ğ»ÑŒÑ 'manager' Ğ¸ 'admin'.
    """
    total_result = await db.execute(select(func.count(OrmUser.id)))
    total_users = total_result.scalar_one()
    users_result = await db.execute(select(OrmUser).offset(skip).limit(limit))
    users_orm = users_result.scalars().all()

    return UserListResponse(
        items=[UserOut.from_orm(user) for user in users_orm],
        total=total_users
    )


@router.get("/admin/users/{user_id}/balance-history", response_model=BalanceHistoryListResponse, summary="ĞŸĞ¾Ğ»ÑƒÑ‡Ğ¸Ñ‚ÑŒ Ğ¸ÑÑ‚Ğ¾Ñ€Ğ¸Ñ Ğ±Ğ°Ğ»Ğ°Ğ½ÑĞ° Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ñ (ĞœĞµĞ½ĞµĞ´Ğ¶ĞµÑ€)")
async def get_user_balance_history_by_admin(
        user_id: int,
        db: AsyncSession = Depends(get_db),
        current_user: PermissionUser = Depends(require_manager),
        skip: int = Query(0, ge=0),
        limit: int = Query(15, ge=1, le=100)
):
    """
    Ğ’Ğ¾Ğ·Ğ²Ñ€Ğ°Ñ‰Ğ°ĞµÑ‚ Ğ¸ÑÑ‚Ğ¾Ñ€Ğ¸Ñ Ñ‚Ñ€Ğ°Ğ½Ğ·Ğ°ĞºÑ†Ğ¸Ğ¹ Ğ¿Ğ¾ Ğ±Ğ°Ğ»Ğ°Ğ½ÑÑƒ Ğ´Ğ»Ñ ÑƒĞºĞ°Ğ·Ğ°Ğ½Ğ½Ğ¾Ğ³Ğ¾ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ñ.
    """
    history_orm, total = await user_service.get_balance_history_for_user(db, user_id, skip, limit)
    return BalanceHistoryListResponse(
        items=[BalanceHistoryOut.from_orm(h) for h in history_orm],
        total=total
    )


@router.post("/admin/users/{user_id}/add-payment", response_model=UserOut, summary="Ğ”Ğ¾Ğ±Ğ°Ğ²Ğ¸Ñ‚ÑŒ Ğ¿Ğ»Ğ°Ñ‚ĞµĞ¶ Ğ¸ Ğ¿Ğ¾Ğ¿Ğ¾Ğ»Ğ½Ğ¸Ñ‚ÑŒ Ğ±Ğ°Ğ»Ğ°Ğ½Ñ (ĞœĞµĞ½ĞµĞ´Ğ¶ĞµÑ€)")
async def add_payment_to_user(
        user_id: int,
        payment_data: UserPaymentRequest,
        db: AsyncSession = Depends(get_db),
        current_user: PermissionUser = Depends(require_manager),
        csrf_protect: CsrfProtect = Depends()
):
    """
    Ğ ĞµĞ³Ğ¸ÑÑ‚Ñ€Ğ¸Ñ€ÑƒĞµÑ‚ Ñ€ĞµĞ°Ğ»ÑŒĞ½Ñ‹Ğ¹ Ğ¿Ğ»Ğ°Ñ‚ĞµĞ¶ Ğ¾Ñ‚ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ñ Ğ¸ Ğ¿Ğ¾Ğ¿Ğ¾Ğ»Ğ½ÑĞµÑ‚ ĞµĞ³Ğ¾ Ğ²Ğ½ÑƒÑ‚Ñ€ĞµĞ½Ğ½Ğ¸Ğ¹ Ğ±Ğ°Ğ»Ğ°Ğ½Ñ.
    """
    return await user_service.process_user_payment(db, user_id, payment_data, current_user)


@router.put("/admin/users/{user_id}", response_model=UserOut, summary="ĞĞ±Ğ½Ğ¾Ğ²Ğ¸Ñ‚ÑŒ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ñ (ĞœĞµĞ½ĞµĞ´Ğ¶ĞµÑ€/ĞĞ´Ğ¼Ğ¸Ğ½)")
async def update_user_by_admin_or_manager(
        user_id: int,
        data: AdminUserUpdate,
        db: AsyncSession = Depends(get_db),
        current_user: PermissionUser = Depends(require_manager),
        csrf_protect: CsrfProtect = Depends()
):
    """
    ĞĞ±Ğ½Ğ¾Ğ²Ğ»ÑĞµÑ‚ Ğ´Ğ°Ğ½Ğ½Ñ‹Ğµ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ñ. ĞœĞµĞ½ĞµĞ´Ğ¶ĞµÑ€Ñ‹ Ğ¼Ğ¾Ğ³ÑƒÑ‚ Ğ¾Ğ±Ğ½Ğ¾Ğ²Ğ»ÑÑ‚ÑŒ Ğ²ÑĞµ, ĞºÑ€Ğ¾Ğ¼Ğµ Ñ€Ğ¾Ğ»Ğ¸.
    ĞĞ´Ğ¼Ğ¸Ğ½Ğ¸ÑÑ‚Ñ€Ğ°Ñ‚Ğ¾Ñ€Ñ‹ Ğ¼Ğ¾Ğ³ÑƒÑ‚ Ğ¾Ğ±Ğ½Ğ¾Ğ²Ğ»ÑÑ‚ÑŒ Ğ²ÑĞµ, Ğ²ĞºĞ»ÑÑ‡Ğ°Ñ Ñ€Ğ¾Ğ»ÑŒ. Email Ğ½Ğµ Ğ¼ĞµĞ½ÑĞµÑ‚ÑÑ.
    """
    return await user_service.update_user_by_admin(db, user_id, data, current_user)


@router.put("/admin/users/{user_id}/role", summary="Ğ˜Ğ·Ğ¼ĞµĞ½Ğ¸Ñ‚ÑŒ Ñ€Ğ¾Ğ»ÑŒ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ñ (ĞĞ´Ğ¼Ğ¸Ğ½)")
async def update_user_role(
        user_id: int,
        new_role: str,
        db: AsyncSession = Depends(get_db),
        current_user: PermissionUser = Depends(require_admin),
        csrf_protect: CsrfProtect = Depends()
):
    """
    ĞĞ±Ğ½Ğ¾Ğ²Ğ»ÑĞµÑ‚ Ñ€Ğ¾Ğ»ÑŒ ÑƒĞºĞ°Ğ·Ğ°Ğ½Ğ½Ğ¾Ğ³Ğ¾ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ñ.
    Ğ”Ğ¾ÑÑ‚ÑƒĞ¿Ğ½Ğ¾ Ñ‚Ğ¾Ğ»ÑŒĞºĞ¾ Ğ´Ğ»Ñ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ĞµĞ¹ Ñ Ñ€Ğ¾Ğ»ÑŒÑ 'admin'.
    """
    if user_id == current_user.id:
        raise HTTPException(status_code=400, detail="ĞĞµĞ»ÑŒĞ·Ñ Ğ¸Ğ·Ğ¼ĞµĞ½Ğ¸Ñ‚ÑŒ ÑĞ¾Ğ±ÑÑ‚Ğ²ĞµĞ½Ğ½ÑƒÑ Ñ€Ğ¾Ğ»ÑŒ.")

    result = await db.execute(select(OrmUser).filter(OrmUser.id == user_id))
    user_orm = result.scalars().first()
    if not user_orm:
        raise HTTPException(status_code=404, detail="ĞŸĞ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ÑŒ Ğ½Ğµ Ğ½Ğ°Ğ¹Ğ´ĞµĞ½")

    if new_role not in ["user", "manager", "admin"]:
        raise HTTPException(status_code=400, detail="ĞĞµĞ´Ğ¾Ğ¿ÑƒÑÑ‚Ğ¸Ğ¼Ğ¾Ğµ Ğ·Ğ½Ğ°Ñ‡ĞµĞ½Ğ¸Ğµ Ñ€Ğ¾Ğ»Ğ¸.")

    user_orm.role = new_role
    await db.commit()
    return {"message": f"Ğ Ğ¾Ğ»ÑŒ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ñ {user_orm.email} Ğ¾Ğ±Ğ½Ğ¾Ğ²Ğ»ĞµĞ½Ğ° Ğ½Ğ° '{new_role}'"}


@router.put("/admin/users/{user_id}/block", summary="Ğ—Ğ°Ğ±Ğ»Ğ¾ĞºĞ¸Ñ€Ğ¾Ğ²Ğ°Ñ‚ÑŒ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ñ (ĞĞ´Ğ¼Ğ¸Ğ½)")
async def block_user(
        user_id: int,
        db: AsyncSession = Depends(get_db),
        current_user: PermissionUser = Depends(require_admin),
        csrf_protect: CsrfProtect = Depends()
):
    """
    Ğ”ĞµĞ°ĞºÑ‚Ğ¸Ğ²Ğ¸Ñ€ÑƒĞµÑ‚ (Ğ±Ğ»Ğ¾ĞºĞ¸Ñ€ÑƒĞµÑ‚) Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ñ.
    Ğ”Ğ¾ÑÑ‚ÑƒĞ¿Ğ½Ğ¾ Ñ‚Ğ¾Ğ»ÑŒĞºĞ¾ Ğ´Ğ»Ñ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ĞµĞ¹ Ñ Ñ€Ğ¾Ğ»ÑŒÑ 'admin'.
    """
    if user_id == current_user.id:
        raise HTTPException(status_code=400, detail="ĞĞµĞ»ÑŒĞ·Ñ Ğ·Ğ°Ğ±Ğ»Ğ¾ĞºĞ¸Ñ€Ğ¾Ğ²Ğ°Ñ‚ÑŒ ÑĞ°Ğ¼Ğ¾Ğ³Ğ¾ ÑĞµĞ±Ñ.")

    result = await db.execute(select(OrmUser).filter(OrmUser.id == user_id))
    user_orm = result.scalars().first()
    if not user_orm:
        raise HTTPException(status_code=404, detail="ĞŸĞ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ÑŒ Ğ½Ğµ Ğ½Ğ°Ğ¹Ğ´ĞµĞ½")

    user_orm.is_active = False
    await db.commit()
    return {"message": f"ĞŸĞ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ÑŒ {user_orm.email} Ğ·Ğ°Ğ±Ğ»Ğ¾ĞºĞ¸Ñ€Ğ¾Ğ²Ğ°Ğ½"}


@router.put("/admin/users/{user_id}/unblock", summary="Ğ Ğ°Ğ·Ğ±Ğ»Ğ¾ĞºĞ¸Ñ€Ğ¾Ğ²Ğ°Ñ‚ÑŒ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ñ (ĞĞ´Ğ¼Ğ¸Ğ½)")
async def unblock_user(
        user_id: int,
        db: AsyncSession = Depends(get_db),
        current_user: PermissionUser = Depends(require_admin),
        csrf_protect: CsrfProtect = Depends()
):
    """
    ĞĞºÑ‚Ğ¸Ğ²Ğ¸Ñ€ÑƒĞµÑ‚ (Ñ€Ğ°Ğ·Ğ±Ğ»Ğ¾ĞºĞ¸Ñ€ÑƒĞµÑ‚) Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ñ.
    Ğ”Ğ¾ÑÑ‚ÑƒĞ¿Ğ½Ğ¾ Ñ‚Ğ¾Ğ»ÑŒĞºĞ¾ Ğ´Ğ»Ñ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ĞµĞ¹ Ñ Ñ€Ğ¾Ğ»ÑŒÑ 'admin'.
    """
    result = await db.execute(select(OrmUser).filter(OrmUser.id == user_id))
    user_orm = result.scalars().first()
    if not user_orm:
        raise HTTPException(status_code=404, detail="ĞŸĞ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ÑŒ Ğ½Ğµ Ğ½Ğ°Ğ¹Ğ´ĞµĞ½")

    user_orm.is_active = True
    await db.commit()
    return {"message": f"ĞŸĞ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ÑŒ {user_orm.email} Ñ€Ğ°Ğ·Ğ±Ğ»Ğ¾ĞºĞ¸Ñ€Ğ¾Ğ²Ğ°Ğ½"}


@router.delete("/admin/users/{user_id}", summary="Ğ£Ğ´Ğ°Ğ»Ğ¸Ñ‚ÑŒ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ñ (ĞĞ´Ğ¼Ğ¸Ğ½)")
async def delete_user(
        user_id: int,
        db: AsyncSession = Depends(get_db),
        current_user: PermissionUser = Depends(require_admin),
        csrf_protect: CsrfProtect = Depends()
):
    """
    ĞŸĞ¾Ğ»Ğ½Ğ¾ÑÑ‚ÑŒÑ ÑƒĞ´Ğ°Ğ»ÑĞµÑ‚ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ñ Ğ¸Ğ· Ğ±Ğ°Ğ·Ñ‹ Ğ´Ğ°Ğ½Ğ½Ñ‹Ñ….
    Ğ­Ñ‚Ğ¾ Ğ½ĞµĞ¾Ğ±Ñ€Ğ°Ñ‚Ğ¸Ğ¼Ğ¾Ğµ Ğ´ĞµĞ¹ÑÑ‚Ğ²Ğ¸Ğµ!
    Ğ”Ğ¾ÑÑ‚ÑƒĞ¿Ğ½Ğ¾ Ñ‚Ğ¾Ğ»ÑŒĞºĞ¾ Ğ´Ğ»Ñ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ĞµĞ¹ Ñ Ñ€Ğ¾Ğ»ÑŒÑ 'admin'.
    """
    if user_id == current_user.id:
        raise HTTPException(status_code=400, detail="ĞĞµĞ»ÑŒĞ·Ñ ÑƒĞ´Ğ°Ğ»Ğ¸Ñ‚ÑŒ ÑĞ°Ğ¼Ğ¾Ğ³Ğ¾ ÑĞµĞ±Ñ.")

    result = await db.execute(select(OrmUser).filter(OrmUser.id == user_id))
    user_orm = result.scalars().first()
    if not user_orm:
        raise HTTPException(status_code=404, detail="ĞŸĞ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ÑŒ Ğ½Ğµ Ğ½Ğ°Ğ¹Ğ´ĞµĞ½")

    await db.delete(user_orm)
    await db.commit()
    return {"message": f"ĞŸĞ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ÑŒ {user_orm.email} Ğ¿Ğ¾Ğ»Ğ½Ğ¾ÑÑ‚ÑŒÑ ÑƒĞ´Ğ°Ğ»ĞµĞ½ Ğ¸Ğ· ÑĞ¸ÑÑ‚ĞµĞ¼Ñ‹"}

```



## `db\init_db.py`


```python

# db/init_db.py
from db.orm import init_db

if __name__ == "__main__":
    init_db()
    print("Ğ‘Ğ°Ğ·Ğ° Ğ´Ğ°Ğ½Ğ½Ñ‹Ñ… ÑƒÑĞ¿ĞµÑˆĞ½Ğ¾ ÑĞ¾Ğ·Ğ´Ğ°Ğ½Ğ°!")

```



## `requirements.txt`


```html

# ĞÑˆĞ¸Ğ±ĞºĞ° Ñ‡Ñ‚ĞµĞ½Ğ¸Ñ Ñ„Ğ°Ğ¹Ğ»Ğ°: 'utf-8' codec can't decode byte 0xff in position 0: invalid start byte

```



## `shared\schemas\accessory_schema.py`


```python

# shared/schemas/accessory_schema.py

from pydantic import BaseModel, ConfigDict
from typing import Optional, List

class AccessoryBase(BaseModel):
    name: str
    accessory_type: Optional[str] = "ĞŸÑ€Ğ¾Ñ‡ĞµĞµ"
    price: Optional[float] = 0.0
    description: Optional[str] = None

class AccessoryCreate(AccessoryBase):
    pass

class AccessoryUpdate(AccessoryBase):
    pass

class AccessoryOut(AccessoryBase):
    id: int
    model_config = ConfigDict(from_attributes=True)


class AccessoryListResponse(BaseModel):
    items: List[AccessoryOut]
    total: int

```



## `shared\schemas\association_schema.py`


```python

# shared/schemas/association_schema.py

from pydantic import BaseModel, ConfigDict, Field
from typing import Optional, List

# Ğ‘Ğ°Ğ·Ğ¾Ğ²Ğ°Ñ ÑÑ…ĞµĞ¼Ğ° Ñ Ğ¾Ğ±Ñ‰Ğ¸Ğ¼Ğ¸ Ğ¿Ğ¾Ğ»ÑĞ¼Ğ¸
class AssociationBase(BaseModel):
    name: str = Field(..., min_length=3, max_length=100, description="ĞĞ°Ğ·Ğ²Ğ°Ğ½Ğ¸Ğµ Ğ°ÑÑĞ¾Ñ†Ğ¸Ğ°Ñ†Ğ¸Ğ¸")
    description: Optional[str] = Field(None, description="Ğ’Ğ½ÑƒÑ‚Ñ€ĞµĞ½Ğ½ĞµĞµ Ğ¾Ğ¿Ğ¸ÑĞ°Ğ½Ğ¸Ğµ")
    sort_order: int = Field(0, description="Ğ˜Ğ½Ğ´ĞµĞºÑ Ğ´Ğ»Ñ ÑĞ¾Ñ€Ñ‚Ğ¸Ñ€Ğ¾Ğ²ĞºĞ¸")

# Ğ¡Ñ…ĞµĞ¼Ğ° Ğ´Ğ»Ñ ÑĞ¾Ğ·Ğ´Ğ°Ğ½Ğ¸Ñ Ğ½Ğ¾Ğ²Ğ¾Ğ¹ Ğ°ÑÑĞ¾Ñ†Ğ¸Ğ°Ñ†Ğ¸Ğ¸
class AssociationCreate(AssociationBase):
    equipment_ids: List[int] = Field([], description="Ğ¡Ğ¿Ğ¸ÑĞ¾Ğº ID ÑĞ²ÑĞ·Ğ°Ğ½Ğ½Ğ¾Ğ³Ğ¾ Ğ¾Ğ±Ğ¾Ñ€ÑƒĞ´Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ")

# Ğ¡Ñ…ĞµĞ¼Ğ° Ğ´Ğ»Ñ Ğ¾Ğ±Ğ½Ğ¾Ğ²Ğ»ĞµĞ½Ğ¸Ñ ÑÑƒÑ‰ĞµÑÑ‚Ğ²ÑƒÑÑ‰ĞµĞ¹ Ğ°ÑÑĞ¾Ñ†Ğ¸Ğ°Ñ†Ğ¸Ğ¸
class AssociationUpdate(BaseModel):
    name: Optional[str] = Field(None, min_length=3, max_length=100)
    description: Optional[str] = None
    sort_order: Optional[int] = None
    equipment_ids: Optional[List[int]] = None

# Ğ¡Ñ…ĞµĞ¼Ğ° Ğ´Ğ»Ñ Ğ²Ñ‹Ğ²Ğ¾Ğ´Ğ° Ğ´Ğ°Ğ½Ğ½Ñ‹Ñ… Ğ¸Ğ· API.
# Ğ¡Ğ°Ğ¼Ğ¾Ğµ Ğ²Ğ°Ğ¶Ğ½Ğ¾Ğµ: Ğ¾Ğ½Ğ° Ğ²ĞºĞ»ÑÑ‡Ğ°ĞµÑ‚ `equipment_ids` Ğ´Ğ»Ñ Ñ€Ğ°Ğ±Ğ¾Ñ‚Ñ‹ Ñ„Ğ¸Ğ»ÑŒÑ‚Ñ€Ğ° Ğ½Ğ° Ñ„Ñ€Ğ¾Ğ½Ñ‚ĞµĞ½Ğ´Ğµ.
class AssociationOut(AssociationBase):
    id: int
    equipment_ids: List[int]

    model_config = ConfigDict(from_attributes=True)

# +++ Ğ’ĞĞ¡Ğ¡Ğ¢ĞĞĞĞ’Ğ˜Ğ¢Ğ¬ Ğ­Ğ¢ĞĞ¢ ĞšĞ›ĞĞ¡Ğ¡ +++
# Ğ­Ñ‚Ğ° ÑÑ…ĞµĞ¼Ğ° Ğ½ÑƒĞ¶Ğ½Ğ° Ğ´Ğ»Ñ Ğ¾Ñ‚Ğ¾Ğ±Ñ€Ğ°Ğ¶ĞµĞ½Ğ¸Ñ Ğ¸Ğ½Ñ„Ğ¾Ñ€Ğ¼Ğ°Ñ†Ğ¸Ğ¸ Ğ¾Ğ± Ğ°ÑÑĞ¾Ñ†Ğ¸Ğ°Ñ†Ğ¸Ğ¸ Ğ²Ğ½ÑƒÑ‚Ñ€Ğ¸ ÑÑ…ĞµĞ¼Ñ‹ Ğ¾Ğ±Ğ¾Ñ€ÑƒĞ´Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ.
class AssociationSimple(BaseModel):
    id: int
    name: str

    model_config = ConfigDict(from_attributes=True)


class AssociationListResponse(BaseModel):
    items: List[AssociationOut]
    total: int

```



## `shared\schemas\balance_history_schema.py`


```python

# src/shared/schemas/balance_history_schema.py (ĞĞĞ’Ğ«Ğ™ Ğ¤ĞĞ™Ğ›)

from pydantic import BaseModel, ConfigDict
from datetime import datetime
from typing import List, Optional

class BalanceHistoryBase(BaseModel):
    amount: float
    operation_type: str
    description: Optional[str] = None
    created_at: datetime
    rental_id: Optional[int] = None

class BalanceHistoryOut(BalanceHistoryBase):
    id: int
    user_id: int

    model_config = ConfigDict(from_attributes=True)

class BalanceHistoryListResponse(BaseModel):
    items: List[BalanceHistoryOut]
    total: int

```



## `shared\schemas\calendar_schema.py`


```python

# shared/schemas/calendar_schema.py

from datetime import date
from typing import Optional, Dict, Union, List
from pydantic import BaseModel, ConfigDict # â—ï¸ Ğ˜Ğ¼Ğ¿Ğ¾Ñ€Ñ‚Ğ¸Ñ€ÑƒĞµĞ¼ ConfigDict


class EquipmentStatusResponse(BaseModel):
    equipment_id: int
    status: str
    details: str
    name: str | None = None
    equipment_type: str | None = None
    brand: str | None = None
    start_date: Optional[date] = None
    end_date: Optional[date] = None

    # â—ï¸ Ğ˜Ğ—ĞœĞ•ĞĞ•ĞĞ˜Ğ•: Config Ğ·Ğ°Ğ¼ĞµĞ½ĞµĞ½ Ğ½Ğ° model_config, orm_mode Ğ½Ğ° from_attributes
    model_config = ConfigDict(from_attributes=True)


class DayStatusItem(BaseModel):
    status: str
    group_id: Optional[str] = None
    is_user_reservation: bool = False


class EquipmentDayStatusesResponse(BaseModel):
    equipment_day_statuses: Dict[int, Dict[str, Union[str, DayStatusItem]]]


class CalendarEventResponse(BaseModel):
    id: str
    title: str
    start: str
    end: str
    resourceId: int
    status: str


class EquipmentStatusListResponse(BaseModel):
    items: List[EquipmentStatusResponse]
    total: int


class CalendarEventListResponse(BaseModel):
    items: List[CalendarEventResponse]
    total: int

```



## `shared\schemas\common_financials.py`


```python

# shared/schemas/common_financials.py

from pydantic import BaseModel
from typing import Optional


class FinancialsBase(BaseModel):
    """
    Ğ‘Ğ°Ğ·Ğ¾Ğ²Ğ°Ñ ÑÑ…ĞµĞ¼Ğ° Ğ´Ğ»Ñ Ñ„Ğ¸Ğ½Ğ°Ğ½ÑĞ¾Ğ²Ñ‹Ñ… Ğ´Ğ°Ğ½Ğ½Ñ‹Ñ…, Ğ¾Ğ±Ñ‰Ğ¸Ñ… Ğ´Ğ»Ñ Ğ°Ñ€ĞµĞ½Ğ´ Ğ¸ Ñ€ĞµĞ·ĞµÑ€Ğ²Ğ¾Ğ².
    Ğ¡Ğ¾Ğ´ĞµÑ€Ğ¶Ğ¸Ñ‚ ÑÑ‚Ğ°Ğ½Ğ´Ğ°Ñ€Ñ‚Ğ½Ñ‹Ğµ Ğ¿Ğ¾Ğ»Ñ Ğ´Ğ»Ñ ÑÑ‚Ğ¾Ğ¸Ğ¼Ğ¾ÑÑ‚Ğ¸, ÑĞºĞ¸Ğ´Ğ¾Ğº Ğ¸ Ğ¿Ñ€Ğ¾Ğ¼Ğ¾ĞºĞ¾Ğ´Ğ¾Ğ².
    """
    total_cost: float
    discount_amount: float = 0.0
    promo_code: Optional[str] = None
    final_cost: Optional[float] = None
    accessories_cost: float = 0.0
    remaining_amount: float = 0.0

```



## `shared\schemas\dashboard_schema.py`


```python

# shared/schemas/dashboard_schema.py
from pydantic import BaseModel, ConfigDict, field_validator
from datetime import datetime, date
from typing import List, Optional

# Ğ­Ğ»ĞµĞ¼ĞµĞ½Ñ‚ Ğ´Ğ»Ñ Ğ²Ğ¸Ğ´Ğ¶ĞµÑ‚Ğ° "Ğ¡ĞµĞ³Ğ¾Ğ´Ğ½Ñ Ğ² Ñ„Ğ¾ĞºÑƒÑĞµ"
class TodayFocusItem(BaseModel):
    id: int  # Ğ˜Ğ·Ğ¼ĞµĞ½ĞµĞ½Ğ¾ Ñ order_id Ğ´Ğ»Ñ ĞºĞ¾Ğ½ÑĞ¸ÑÑ‚ĞµĞ½Ñ‚Ğ½Ğ¾ÑÑ‚Ğ¸ Ñ Ñ„Ñ€Ğ¾Ğ½Ñ‚ĞµĞ½Ğ´Ğ¾Ğ¼
    user_name: str
    details: str  # ĞĞ°Ğ¿Ñ€Ğ¸Ğ¼ĞµÑ€, "3 Ğ¿Ğ¾Ğ·Ğ¸Ñ†Ğ¸Ğ¸" Ğ¸Ğ»Ğ¸ "ĞÑÑ‚Ğ°Ñ‚Ğ¾Ğº: 1500 â‚½"
    user_id: int
    order_type: str # 'reservation' Ğ¸Ğ»Ğ¸ 'rental'
    scheduled_time: datetime  # Ğ’Ñ€ĞµĞ¼Ñ Ğ²Ñ‹Ğ´Ğ°Ñ‡Ğ¸ Ğ¸Ğ»Ğ¸ Ğ²Ğ¾Ğ·Ğ²Ñ€Ğ°Ñ‚Ğ°
    start_date: Optional[date] = None  # Ğ”Ğ°Ñ‚Ğ° Ğ½Ğ°Ñ‡Ğ°Ğ»Ğ° Ñ€ĞµĞ·ĞµÑ€Ğ²Ğ°
    # ĞŸĞ¾Ğ»Ñ Ğ´Ğ»Ñ Ğ¿Ñ€Ğ¾ÑÑ€Ğ¾Ñ‡ĞµĞ½Ğ½Ñ‹Ñ… Ğ°Ñ€ĞµĞ½Ğ´
    due_date: Optional[date] = None  # Ğ”Ğ°Ñ‚Ğ° Ğ¾ĞºĞ¾Ğ½Ñ‡Ğ°Ğ½Ğ¸Ñ Ğ°Ñ€ĞµĞ½Ğ´Ñ‹
    days_overdue: Optional[int] = None  # ĞšĞ¾Ğ»Ğ¸Ñ‡ĞµÑÑ‚Ğ²Ğ¾ Ğ´Ğ½ĞµĞ¹ Ğ¿Ñ€Ğ¾ÑÑ€Ğ¾Ñ‡ĞºĞ¸

# Ğ­Ğ»ĞµĞ¼ĞµĞ½Ñ‚ Ğ´Ğ»Ñ Ğ²Ğ¸Ğ´Ğ¶ĞµÑ‚Ğ° "ĞŸĞ¾ÑĞ»ĞµĞ´Ğ½Ğ¸Ğµ ÑĞ¾Ğ±Ñ‹Ñ‚Ğ¸Ñ"
class ActivityFeedItem(BaseModel):
    id: int  # Ğ”Ğ¾Ğ±Ğ°Ğ²Ğ»ĞµĞ½Ğ¾ Ğ´Ğ»Ñ ĞºĞ¾Ğ½ÑĞ¸ÑÑ‚ĞµĞ½Ñ‚Ğ½Ğ¾ÑÑ‚Ğ¸ Ñ Ñ„Ñ€Ğ¾Ğ½Ñ‚ĞµĞ½Ğ´Ğ¾Ğ¼
    timestamp: datetime
    activity_type: str  # "new_reservation", "new_user", "rental_return"
    description: str
    user_name: Optional[str] = None  # Ğ˜Ğ¼Ñ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ñ Ğ´Ğ»Ñ Ğ¾Ğ±Ğ¾Ğ³Ğ°Ñ‰ĞµĞ½Ğ¸Ñ Ğ»ĞµĞ½Ñ‚Ñ‹ ÑĞ¾Ğ±Ñ‹Ñ‚Ğ¸Ğ¹
    equipment_name: Optional[str] = None  # ĞĞ°Ğ·Ğ²Ğ°Ğ½Ğ¸Ğµ Ğ¾Ğ±Ğ¾Ñ€ÑƒĞ´Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ Ğ´Ğ»Ñ Ğ¾Ğ±Ğ¾Ğ³Ğ°Ñ‰ĞµĞ½Ğ¸Ñ Ğ»ĞµĞ½Ñ‚Ñ‹ ÑĞ¾Ğ±Ñ‹Ñ‚Ğ¸Ğ¹

# Ğ­Ğ»ĞµĞ¼ĞµĞ½Ñ‚ Ğ´Ğ»Ñ Ğ³Ñ€Ğ°Ñ„Ğ¸ĞºĞ° "ĞŸĞ¾Ğ¿ÑƒĞ»ÑÑ€Ğ½Ğ¾Ğµ Ğ¾Ğ±Ğ¾Ñ€ÑƒĞ´Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ"
class PopularEquipmentItem(BaseModel):
    equipment_id: int  # ID Ğ¾Ğ±Ğ¾Ñ€ÑƒĞ´Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ Ğ´Ğ»Ñ Ğ¸ÑĞ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ Ğ² ĞºĞ°Ñ‡ĞµÑÑ‚Ğ²Ğµ key Ğ½Ğ° Ñ„Ñ€Ğ¾Ğ½Ñ‚ĞµĞ½Ğ´Ğµ
    equipment_name: str
    rental_count: int  # ĞšĞ¾Ğ»Ğ¸Ñ‡ĞµÑÑ‚Ğ²Ğ¾ Ğ°Ñ€ĞµĞ½Ğ´
    revenue: float  # Ğ’Ñ‹Ñ€ÑƒÑ‡ĞºĞ° Ğ¾Ñ‚ Ğ°Ñ€ĞµĞ½Ğ´Ñ‹ Ğ´Ğ°Ğ½Ğ½Ğ¾Ğ³Ğ¾ Ğ¾Ğ±Ğ¾Ñ€ÑƒĞ´Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ

# Ğ’Ğ»Ğ¾Ğ¶ĞµĞ½Ğ½Ğ°Ñ Ğ¼Ğ¾Ğ´ĞµĞ»ÑŒ Ğ´Ğ»Ñ Ğ²ÑĞµÑ… KPI Ğ¿Ğ¾ĞºĞ°Ğ·Ğ°Ñ‚ĞµĞ»ĞµĞ¹
class KpiData(BaseModel):
    total_users: int  # ĞĞ±Ñ‰ĞµĞµ ĞºĞ¾Ğ»Ğ¸Ñ‡ĞµÑÑ‚Ğ²Ğ¾ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ĞµĞ¹
    active_users: int  # ĞĞºÑ‚Ğ¸Ğ²Ğ½Ñ‹Ğµ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ğ¸
    total_equipment: int  # ĞĞ±Ñ‰ĞµĞµ ĞºĞ¾Ğ»Ğ¸Ñ‡ĞµÑÑ‚Ğ²Ğ¾ Ğ¾Ğ±Ğ¾Ñ€ÑƒĞ´Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ
    total_reservations: int  # ĞĞ±Ñ‰ĞµĞµ ĞºĞ¾Ğ»Ğ¸Ñ‡ĞµÑÑ‚Ğ²Ğ¾ Ñ€ĞµĞ·ĞµÑ€Ğ²Ğ°Ñ†Ğ¸Ğ¹
    revenue_today: float  # Ğ”Ğ¾Ñ…Ğ¾Ğ´ Ğ·Ğ° ÑĞµĞ³Ğ¾Ğ´Ğ½Ñ
    revenue_this_month: float  # Ğ”Ğ¾Ñ…Ğ¾Ğ´ Ğ·Ğ° Ñ‚ĞµĞºÑƒÑ‰Ğ¸Ğ¹ Ğ¼ĞµÑÑÑ†
    occupancy_rate: float  # ĞšĞ¾ÑÑ„Ñ„Ğ¸Ñ†Ğ¸ĞµĞ½Ñ‚ Ğ·Ğ°Ğ³Ñ€ÑƒĞ¶ĞµĞ½Ğ½Ğ¾ÑÑ‚Ğ¸
    avg_rental_duration: float  # Ğ¡Ñ€ĞµĞ´Ğ½ÑÑ Ğ¿Ñ€Ğ¾Ğ´Ğ¾Ğ»Ğ¶Ğ¸Ñ‚ĞµĞ»ÑŒĞ½Ğ¾ÑÑ‚ÑŒ Ğ°Ñ€ĞµĞ½Ğ´Ñ‹

# ĞÑĞ½Ğ¾Ğ²Ğ½Ğ°Ñ ÑÑ…ĞµĞ¼Ğ° Ğ¾Ñ‚Ğ²ĞµÑ‚Ğ°
class DashboardSummaryResponse(BaseModel):
    # Ğ’Ğ¸Ğ´Ğ¶ĞµÑ‚ "Ğ¡ĞµĞ³Ğ¾Ğ´Ğ½Ñ Ğ² Ñ„Ğ¾ĞºÑƒÑĞµ"
    pickups_today: List[TodayFocusItem]
    returns_today: List[TodayFocusItem]
    overdue_rentals: List[TodayFocusItem]

    # Ğ’Ğ¸Ğ´Ğ¶ĞµÑ‚ "ĞšĞ»ÑÑ‡ĞµĞ²Ñ‹Ğµ Ğ¿Ğ¾ĞºĞ°Ğ·Ğ°Ñ‚ĞµĞ»Ğ¸" - Ñ‚ĞµĞ¿ĞµÑ€ÑŒ Ğ²Ğ»Ğ¾Ğ¶ĞµĞ½Ğ½Ğ°Ñ ÑÑ‚Ñ€ÑƒĞºÑ‚ÑƒÑ€Ğ°
    kpi: KpiData

    # Ğ’Ğ¸Ğ´Ğ¶ĞµÑ‚ "ĞŸĞ¾ÑĞ»ĞµĞ´Ğ½Ğ¸Ğµ ÑĞ¾Ğ±Ñ‹Ñ‚Ğ¸Ñ"
    recent_activity: List[ActivityFeedItem]

    # Ğ’Ğ¸Ğ´Ğ¶ĞµÑ‚ "ĞŸĞ¾Ğ¿ÑƒĞ»ÑÑ€Ğ½Ğ¾Ğµ Ğ¾Ğ±Ğ¾Ñ€ÑƒĞ´Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ"
    popular_equipment: List[PopularEquipmentItem]

    model_config = ConfigDict(from_attributes=True)

```



## `shared\schemas\discount_schema.py`


```python

# shared/schemas/discount_schema.py

from pydantic import BaseModel, ConfigDict, Field
from typing import List

class DiscountBase(BaseModel):
    min_days: int = Field(..., gt=0, description="ĞœĞ¸Ğ½Ğ¸Ğ¼Ğ°Ğ»ÑŒĞ½Ğ¾Ğµ ĞºĞ¾Ğ»Ğ¸Ñ‡ĞµÑÑ‚Ğ²Ğ¾ Ğ´Ğ½ĞµĞ¹ Ğ´Ğ»Ñ Ğ¿Ñ€Ğ¸Ğ¼ĞµĞ½ĞµĞ½Ğ¸Ñ ÑĞºĞ¸Ğ´ĞºĞ¸")
    discount_percentage: int = Field(..., gt=0, le=100, description="ĞŸÑ€Ğ¾Ñ†ĞµĞ½Ñ‚ ÑĞºĞ¸Ğ´ĞºĞ¸")

class DiscountCreate(DiscountBase):
    pass

class DiscountUpdate(DiscountBase):
    pass

class DiscountOut(DiscountBase):
    id: int

    model_config = ConfigDict(from_attributes=True)


class DiscountListResponse(BaseModel):
    items: List[DiscountOut]
    total: int

```



## `shared\schemas\equipment_schema.py`


```python

# shared/schemas/equipment_schema.py

from __future__ import annotations
from pydantic import BaseModel, ConfigDict, field_validator
from typing import Optional, List
from datetime import date, datetime # âœ… Ğ˜Ğ—ĞœĞ•ĞĞ•ĞĞ˜Ğ•: Ğ¸Ğ¼Ğ¿Ğ¾Ñ€Ñ‚Ğ¸Ñ€ÑƒĞµĞ¼ date Ğ²Ğ¼ĞµÑÑ‚Ğ¾ datetime
# âœ… Ğ”ĞĞ‘ĞĞ’Ğ›Ğ•Ğ Ğ˜ĞœĞŸĞĞ Ğ¢
from .accessory_schema import AccessoryOut
from .association_schema import AssociationSimple


class EquipmentCreate(BaseModel):
    equipment_type: str
    brand: str
    name: str
    serial_number: Optional[str] = None
    condition: Optional[str] = "Ğ’ĞµĞ»Ğ¸ĞºĞ¾Ğ»ĞµĞ¿Ğ½Ğ¾"
    daily_rate: Optional[float] = 0.0
    notes: Optional[str] = None
    description: Optional[str] = None
    # âœ… Ğ˜Ğ—ĞœĞ•ĞĞ•ĞĞ˜Ğ•: Ğ¢Ğ¸Ğ¿ Ğ¿Ğ¾Ğ»Ñ Ğ¸Ğ·Ğ¼ĞµĞ½ĞµĞ½ Ñ datetime Ğ½Ğ° date
    last_maintenance: Optional[date] = None
    image_url: Optional[str] = None
    image_urls: Optional[List[str]] = None
    short_description: Optional[str] = None


class EquipmentOut(BaseModel):
    id: int
    equipment_type: str
    brand: str
    name: str
    serial_number: Optional[str] = None
    condition: str
    daily_rate: float
    notes: Optional[str] = None
    description: Optional[str] = None
    # âœ… Ğ˜Ğ—ĞœĞ•ĞĞ•ĞĞ˜Ğ•: Ğ¢Ğ¸Ğ¿ Ğ¿Ğ¾Ğ»Ñ Ğ¸Ğ·Ğ¼ĞµĞ½ĞµĞ½ Ñ datetime Ğ½Ğ° date
    last_maintenance: Optional[date] = None
    image_url: Optional[str] = None
    image_urls: Optional[List[str]] = None
    short_description: Optional[str] = None
    # âœ… Ğ”ĞĞ‘ĞĞ’Ğ›Ğ•ĞĞ ĞŸĞĞ›Ğ• Ğ”Ğ›Ğ¯ ĞĞ¢ĞĞ‘Ğ ĞĞ–Ğ•ĞĞ˜Ğ¯ ĞŸĞ Ğ˜Ğ’Ğ¯Ğ—ĞĞĞĞ«Ğ¥ ĞĞšĞ¡Ğ•Ğ¡Ğ¡Ğ£ĞĞ ĞĞ’
    accessories: List[AccessoryOut] = []
    # âœ… Ğ”ĞĞ‘ĞĞ’Ğ›Ğ•ĞĞ ĞŸĞĞ›Ğ• Ğ”Ğ›Ğ¯ ĞĞ¢ĞĞ‘Ğ ĞĞ–Ğ•ĞĞ˜Ğ¯ ĞŸĞ Ğ˜Ğ’Ğ¯Ğ—ĞĞĞĞ«Ğ¥ ĞĞ¡Ğ¡ĞĞ¦Ğ˜ĞĞ¦Ğ˜Ğ™
    associations: List[AssociationSimple] = []

    @field_validator('last_maintenance', mode='before')
    @classmethod
    def validate_last_maintenance(cls, v):
        """Ğ’Ğ°Ğ»Ğ¸Ğ´Ğ°Ñ‚Ğ¾Ñ€ Ğ´Ğ»Ñ Ğ¿Ğ¾Ğ»Ñ last_maintenance - Ğ¾Ğ±ĞµÑĞ¿ĞµÑ‡Ğ¸Ğ²Ğ°ĞµÑ‚ ĞºĞ¾Ñ€Ñ€ĞµĞºÑ‚Ğ½Ñ‹Ğ¹ Ñ„Ğ¾Ñ€Ğ¼Ğ°Ñ‚ Ğ´Ğ°Ñ‚Ñ‹."""
        if v is None:
            return None
        if isinstance(v, str):
            try:
                # ĞŸÑ‹Ñ‚Ğ°ĞµĞ¼ÑÑ Ğ¿Ñ€ĞµĞ¾Ğ±Ñ€Ğ°Ğ·Ğ¾Ğ²Ğ°Ñ‚ÑŒ ÑÑ‚Ñ€Ğ¾ĞºÑƒ Ğ² Ğ´Ğ°Ñ‚Ñƒ
                return datetime.fromisoformat(v.replace('Z', '+00:00')).date()
            except (ValueError, AttributeError):
                # Ğ•ÑĞ»Ğ¸ Ğ½Ğµ ÑƒĞ´Ğ°ĞµÑ‚ÑÑ Ğ¿Ñ€ĞµĞ¾Ğ±Ñ€Ğ°Ğ·Ğ¾Ğ²Ğ°Ñ‚ÑŒ, Ğ²Ğ¾Ğ·Ğ²Ñ€Ğ°Ñ‰Ğ°ĞµĞ¼ None
                return None
        if isinstance(v, datetime):
            return v.date()
        return v

    model_config = ConfigDict(from_attributes=True)


class EquipmentUpdateExtended(BaseModel):
    equipment_type: Optional[str] = None
    brand: Optional[str] = None
    name: Optional[str] = None
    serial_number: Optional[str] = None
    condition: Optional[str] = None
    daily_rate: Optional[float] = None
    notes: Optional[str] = None
    description: Optional[str] = None
    # âœ… Ğ­Ñ‚Ğ¾ Ğ¿Ğ¾Ğ»Ğµ ÑƒĞ¶Ğµ Ğ±Ñ‹Ğ»Ğ¾ Ğ¿Ñ€Ğ°Ğ²Ğ¸Ğ»ÑŒĞ½Ñ‹Ğ¼ (date), Ğ¾ÑÑ‚Ğ°Ğ²Ğ»ÑĞµĞ¼ ĞºĞ°Ğº ĞµÑÑ‚ÑŒ
    last_maintenance: Optional[date] = None
    image_url: Optional[str] = None
    image_urls: Optional[List[str]] = None
    short_description: Optional[str] = None
    # âœ… Ğ”ĞĞ‘ĞĞ’Ğ›Ğ•ĞĞ ĞŸĞĞ›Ğ• Ğ”Ğ›Ğ¯ ĞŸĞ•Ğ Ğ•Ğ”ĞĞ§Ğ˜ ID ĞĞšĞ¡Ğ•Ğ¡Ğ¡Ğ£ĞĞ ĞĞ’ ĞŸĞ Ğ˜ ĞĞ‘ĞĞĞ’Ğ›Ğ•ĞĞ˜Ğ˜
    accessory_ids: Optional[List[int]] = None
    # âœ… Ğ”ĞĞ‘ĞĞ’Ğ›Ğ•ĞĞ ĞŸĞĞ›Ğ• Ğ”Ğ›Ğ¯ ĞŸĞ•Ğ Ğ•Ğ”ĞĞ§Ğ˜ ID ĞĞ¡Ğ¡ĞĞ¦Ğ˜ĞĞ¦Ğ˜Ğ™ ĞŸĞ Ğ˜ ĞĞ‘ĞĞĞ’Ğ›Ğ•ĞĞ˜Ğ˜
    association_ids: Optional[List[int]] = None

    model_config = ConfigDict(from_attributes=True)


class EquipmentTreeItem(BaseModel):
    label: str
    value: Optional[int] = None
    children: List[EquipmentTreeItem] = []
    model_config = ConfigDict(from_attributes=True)


class EquipmentAvailabilityStatus(BaseModel):
    has_active_reservations: bool
    has_active_rentals: bool
    active_reservations_count: int
    active_rentals_count: int
    model_config = ConfigDict(from_attributes=True)


class EquipmentListResponse(BaseModel):
    items: List[EquipmentOut]
    total: int


class EquipmentTreeListResponse(BaseModel):
    items: List[EquipmentTreeItem]
    total: int

```



## `shared\schemas\holiday_schema.py`


```python

# shared/schemas/holiday_schema.py

from pydantic import BaseModel, ConfigDict, Field
from datetime import date, datetime
from typing import Literal, List

class HolidayBase(BaseModel):
    """Ğ‘Ğ°Ğ·Ğ¾Ğ²Ğ°Ñ ÑÑ…ĞµĞ¼Ğ° Ğ´Ğ»Ñ Ğ²Ñ‹Ñ…Ğ¾Ğ´Ğ½Ğ¾Ğ³Ğ¾ Ğ´Ğ½Ñ."""
    date: date
    description: str | None = None

class HolidayCreate(HolidayBase):
    """Ğ¡Ñ…ĞµĞ¼Ğ° Ğ´Ğ»Ñ ÑĞ¾Ğ·Ğ´Ğ°Ğ½Ğ¸Ñ Ğ½Ğ¾Ğ²Ğ¾Ğ³Ğ¾ Ğ²Ñ‹Ñ…Ğ¾Ğ´Ğ½Ğ¾Ğ³Ğ¾ Ğ´Ğ½Ñ."""
    force: bool = False

class HolidayOut(HolidayBase):
    """Ğ¡Ñ…ĞµĞ¼Ğ° Ğ´Ğ»Ñ Ğ¾Ñ‚Ğ¾Ğ±Ñ€Ğ°Ğ¶ĞµĞ½Ğ¸Ñ Ğ´Ğ°Ğ½Ğ½Ñ‹Ñ… Ğ¾ Ğ²Ñ‹Ñ…Ğ¾Ğ´Ğ½Ğ¾Ğ¼ Ğ´Ğ½Ğµ Ğ¸Ğ· Ğ‘Ğ”."""
    created_at: datetime
    created_by_id: int

    model_config = ConfigDict(from_attributes=True)

# +++ ĞĞĞ§ĞĞ›Ğ: ĞĞĞ’Ğ«Ğ• Ğ¡Ğ¥Ğ•ĞœĞ« +++
class RecurringHolidayRuleCreate(BaseModel):
    """Ğ¡Ñ…ĞµĞ¼Ğ° Ğ´Ğ»Ñ ÑĞ¾Ğ·Ğ´Ğ°Ğ½Ğ¸Ñ Ğ¿Ñ€Ğ°Ğ²Ğ¸Ğ»Ğ° ĞµĞ¶ĞµĞ½ĞµĞ´ĞµĞ»ÑŒĞ½Ñ‹Ñ… Ğ²Ñ‹Ñ…Ğ¾Ğ´Ğ½Ñ‹Ñ…."""
    day_of_week: int = Field(..., ge=0, le=6, description="Ğ”ĞµĞ½ÑŒ Ğ½ĞµĞ´ĞµĞ»Ğ¸ (0=ĞŸĞ¾Ğ½ĞµĞ´ĞµĞ»ÑŒĞ½Ğ¸Ğº, 6=Ğ’Ğ¾ÑĞºÑ€ĞµÑĞµĞ½ÑŒĞµ)")
    start_date: date
    end_date: date
    description: str

class HolidayRuleOut(BaseModel):
    """Ğ¡Ñ…ĞµĞ¼Ğ° Ğ´Ğ»Ñ Ğ¾Ñ‚Ğ¾Ğ±Ñ€Ğ°Ğ¶ĞµĞ½Ğ¸Ñ Ğ¿Ñ€Ğ°Ğ²Ğ¸Ğ» Ğ² Ğ°Ğ´Ğ¼Ğ¸Ğ½ĞºĞµ."""
    id: int
    rule_type: str
    description: str
    created_at: datetime

    model_config = ConfigDict(from_attributes=True)


class HolidayListResponse(BaseModel):
    items: List[HolidayOut]
    total: int


class HolidayRuleListResponse(BaseModel):
    items: List[HolidayRuleOut]
    total: int
# +++ ĞšĞĞĞ•Ğ¦: ĞĞĞ’Ğ«Ğ• Ğ¡Ğ¥Ğ•ĞœĞ« +++

```



## `shared\schemas\promo_code_schema.py`


```python

# shared/schemas/promo_code_schema.py
from pydantic import BaseModel, ConfigDict, Field, EmailStr
from typing import Optional, List
from datetime import datetime

# --- Ğ¡Ñ…ĞµĞ¼Ñ‹ Ğ´Ğ»Ñ Ğ°Ğ´Ğ¼Ğ¸Ğ½Ğ¸ÑÑ‚Ñ€Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ ---

class PromoCodeBase(BaseModel):
    code: str = Field(..., description="Ğ£Ğ½Ğ¸ĞºĞ°Ğ»ÑŒĞ½Ñ‹Ğ¹ ĞºĞ¾Ğ´, Ğ½Ğ°Ğ¿Ñ€Ğ¸Ğ¼ĞµÑ€, 'SUMMER20'", max_length=50)
    description: Optional[str] = Field(None, description="ĞĞ¿Ğ¸ÑĞ°Ğ½Ğ¸Ğµ Ğ´Ğ»Ñ Ğ²Ğ½ÑƒÑ‚Ñ€ĞµĞ½Ğ½ĞµĞ³Ğ¾ Ğ¸ÑĞ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ")
    discount_percentage: float = Field(..., gt=0, le=50, description="ĞŸÑ€Ğ¾Ñ†ĞµĞ½Ñ‚ ÑĞºĞ¸Ğ´ĞºĞ¸ (1-50)")
    is_active: bool = True
    valid_from: Optional[datetime] = None
    expires_at: Optional[datetime] = None
    max_uses: Optional[int] = Field(None, gt=0, description="ĞĞ±Ñ‰Ğ¸Ğ¹ Ğ»Ğ¸Ğ¼Ğ¸Ñ‚ Ğ¸ÑĞ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğ¹")
    max_uses_per_user: Optional[int] = Field(None, gt=0, description="Ğ›Ğ¸Ğ¼Ğ¸Ñ‚ Ğ½Ğ° Ğ¾Ğ´Ğ½Ğ¾Ğ³Ğ¾ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ñ")
    min_order_amount: Optional[float] = Field(None, gt=0, description="ĞœĞ¸Ğ½Ğ¸Ğ¼Ğ°Ğ»ÑŒĞ½Ğ°Ñ ÑÑƒĞ¼Ğ¼Ğ° Ğ·Ğ°ĞºĞ°Ğ·Ğ°")
    specific_to_user_id: Optional[int] = None
    applicable_to_equipment_ids: Optional[List[int]] = None
    applicable_to_equipment_types: Optional[List[str]] = None

class PromoCodeCreate(PromoCodeBase):
    pass

class PromoCodeUpdate(BaseModel):
    code: Optional[str] = Field(None, max_length=50)
    description: Optional[str] = None
    discount_percentage: Optional[float] = Field(None, gt=0, le=50)
    is_active: Optional[bool] = None
    valid_from: Optional[datetime] = None
    expires_at: Optional[datetime] = None
    max_uses: Optional[int] = Field(None, gt=0)
    max_uses_per_user: Optional[int] = Field(None, gt=0)
    min_order_amount: Optional[float] = Field(None, gt=0)
    specific_to_user_id: Optional[int] = None
    applicable_to_equipment_ids: Optional[List[int]] = None
    applicable_to_equipment_types: Optional[List[str]] = None

class PromoCodeOut(PromoCodeBase):
    id: int
    times_used: int
    created_at: datetime
    created_by_id: int
    creator_email: Optional[EmailStr] = None # Ğ”Ğ»Ñ ÑƒĞ´Ğ¾Ğ±ÑÑ‚Ğ²Ğ° Ğ¾Ñ‚Ğ¾Ğ±Ñ€Ğ°Ğ¶ĞµĞ½Ğ¸Ñ Ğ² Ğ°Ğ´Ğ¼Ğ¸Ğ½ĞºĞµ

    model_config = ConfigDict(from_attributes=True)

    @classmethod
    def from_orm(cls, obj):
        # Ğ”Ğ¾Ğ±Ğ°Ğ²Ğ»ÑĞµĞ¼ email ÑĞ¾Ğ·Ğ´Ğ°Ñ‚ĞµĞ»Ñ Ğ´Ğ»Ñ Ğ²Ñ‹Ğ²Ğ¾Ğ´Ğ°
        instance = super().from_orm(obj)
        if obj.creator:
            instance.creator_email = obj.creator.email
        return instance

# --- Ğ¡Ñ…ĞµĞ¼Ñ‹ Ğ´Ğ»Ñ Ğ¿ÑƒĞ±Ğ»Ğ¸Ñ‡Ğ½Ğ¾Ğ¹ Ğ²Ğ°Ğ»Ğ¸Ğ´Ğ°Ñ†Ğ¸Ğ¸ ---

class PromoCodeValidateRequest(BaseModel):
    code: str
    # Ğ­Ñ‚Ğ¸ Ğ¿Ğ¾Ğ»Ñ Ğ½ÑƒĞ¶Ğ½Ñ‹ Ğ´Ğ»Ñ Ğ¿Ñ€Ğ¾Ğ²ĞµÑ€ĞºĞ¸ ÑƒÑĞ»Ğ¾Ğ²Ğ¸Ğ¹ Ğ¿Ñ€Ğ¾Ğ¼Ğ¾ĞºĞ¾Ğ´Ğ°
    order_amount: float
    equipment_ids: List[int]

class PromoCodeValidateResponse(BaseModel):
    code: str
    discount_percentage: float
    message: str


class PromoCodeListResponse(BaseModel):
    items: List[PromoCodeOut]
    total: int

```



## `shared\schemas\rental_schema.py`


```python

# shared/schemas/rental_schema.py

from pydantic import BaseModel, ConfigDict, Field, field_validator
from datetime import date, datetime
from typing import List, Optional

from .user_schema import UserOut
from .equipment_schema import EquipmentOut
from .accessory_schema import AccessoryOut
from .common_financials import FinancialsBase

class RentalBase(BaseModel):
    start_date: date
    end_date: date
    deposit_amount: float = 0.0
    notes_on_issue: Optional[str] = None
    status: str

class RentalAccessoryDetail(BaseModel):
    equipment_id: int
    accessory: AccessoryOut
    model_config = ConfigDict(from_attributes=True)

class RentalOut(RentalBase, FinancialsBase):
    id: int
    user_id: int
    created_by_id: int
    reservation_id: Optional[int] = None
    actual_return_date: Optional[date] = None
    prepayment_amount: float = 0.0
    notes_on_return: Optional[str] = None
    created_at: datetime
    updated_at: datetime
    user: UserOut
    created_by: UserOut
    equipment: List[EquipmentOut]

    # Ğ˜ÑĞ¿Ğ¾Ğ»ÑŒĞ·ÑƒĞµĞ¼ Ğ¸Ğ¼Ñ Ğ¿Ğ¾Ğ»Ñ 'accessory_links' ĞºĞ°Ğº Ğ² Ğ¼Ğ¾Ğ´ĞµĞ»Ğ¸ SQLAlchemy
    # Ñ‡Ñ‚Ğ¾Ğ±Ñ‹ Ğ¸Ğ·Ğ±ĞµĞ¶Ğ°Ñ‚ÑŒ Ğ½ĞµÑĞ¾Ğ¾Ñ‚Ğ²ĞµÑ‚ÑÑ‚Ğ²Ğ¸Ğ¹ Ğ¿Ñ€Ğ¸ Ğ¿ĞµÑ€ĞµĞ´Ğ°Ñ‡Ğµ Ğ´Ğ°Ğ½Ğ½Ñ‹Ñ….
    accessory_links: List[RentalAccessoryDetail] = []

    # Ğ”Ğ¸Ğ½Ğ°Ğ¼Ğ¸Ñ‡ĞµÑĞºĞ¸ Ğ²Ñ‹Ñ‡Ğ¸ÑĞ»ÑĞµĞ¼Ñ‹Ğµ Ğ¿Ğ¾Ğ»Ñ
    days_remaining: Optional[int] = None
    overdue_days: Optional[int] = None
    overdue_surcharge: Optional[float] = None

    # Ğ£Ğ±Ğ¸Ñ€Ğ°ĞµĞ¼ populate_by_name, Ñ‚Ğ°Ğº ĞºĞ°Ğº alias Ğ±Ğ¾Ğ»ÑŒÑˆĞµ Ğ½Ğµ Ğ¸ÑĞ¿Ğ¾Ğ»ÑŒĞ·ÑƒĞµÑ‚ÑÑ
    model_config = ConfigDict(from_attributes=True)

    @field_validator('start_date', 'end_date', 'actual_return_date', mode='before')
    @classmethod
    def convert_datetime_to_date(cls, v):
        if isinstance(v, datetime):
            return v.date()
        return v

class RentalListResponse(BaseModel):
    items: List[RentalOut]
    total: int

# --- Ğ¡Ñ…ĞµĞ¼Ñ‹ Ğ´Ğ»Ñ Ğ·Ğ°Ğ¿Ñ€Ğ¾ÑĞ¾Ğ² ---

class RentalCreateFromReservationRequest(BaseModel):
    """Ğ¡Ñ…ĞµĞ¼Ğ° Ğ´Ğ»Ñ ÑĞ¾Ğ·Ğ´Ğ°Ğ½Ğ¸Ñ Ğ°Ñ€ĞµĞ½Ğ´Ñ‹ Ğ¸Ğ· Ñ€ĞµĞ·ĞµÑ€Ğ²Ğ°."""
    notes_on_issue: Optional[str] = None
    deposit_amount: float = Field(0.0, ge=0)
    prepayment_amount: float = Field(0.0, ge=0)
    force_issue_on_holiday: bool = Field(False, description="ĞŸĞ¾Ğ´Ñ‚Ğ²ĞµÑ€Ğ¶Ğ´ĞµĞ½Ğ¸Ğµ Ğ²Ñ‹Ğ´Ğ°Ñ‡Ğ¸ Ğ² Ğ²Ñ‹Ñ…Ğ¾Ğ´Ğ½Ğ¾Ğ¹ Ğ´ĞµĞ½ÑŒ")

class RentalCreateFromScratchRequest(BaseModel):
    """Ğ¡Ñ…ĞµĞ¼Ğ° Ğ´Ğ»Ñ ÑĞ¾Ğ·Ğ´Ğ°Ğ½Ğ¸Ñ Ğ°Ñ€ĞµĞ½Ğ´Ñ‹ "Ñ Ğ½ÑƒĞ»Ñ"."""
    user_id: int
    equipment_ids: List[int] = Field(..., min_length=1)
    start_date: date
    end_date: date
    notes_on_issue: Optional[str] = None
    deposit_amount: float = Field(0.0, ge=0)

class AdminRentalUpdate(BaseModel):
    """Ğ¡Ñ…ĞµĞ¼Ğ° Ğ´Ğ»Ñ Ğ¾Ğ±Ğ½Ğ¾Ğ²Ğ»ĞµĞ½Ğ¸Ñ Ğ°Ñ€ĞµĞ½Ğ´Ñ‹ Ğ°Ğ´Ğ¼Ğ¸Ğ½Ğ¸ÑÑ‚Ñ€Ğ°Ñ‚Ğ¾Ñ€Ğ¾Ğ¼."""
    end_date: Optional[date] = None
    actual_return_date: Optional[date] = None
    status: Optional[str] = None
    final_cost: Optional[float] = Field(None, ge=0)
    deposit_amount: Optional[float] = Field(None, ge=0)
    notes_on_issue: Optional[str] = None
    notes_on_return: Optional[str] = None

class RentalReturnRequest(BaseModel):
    """Ğ¡Ñ…ĞµĞ¼Ğ° Ğ´Ğ»Ñ Ğ¾Ñ„Ğ¾Ñ€Ğ¼Ğ»ĞµĞ½Ğ¸Ñ Ğ²Ğ¾Ğ·Ğ²Ñ€Ğ°Ñ‚Ğ°."""
    actual_return_date: date
    notes_on_return: Optional[str] = None
    accessories_returned_confirmation: bool = Field(..., description="ĞŸĞ¾Ğ´Ñ‚Ğ²ĞµÑ€Ğ¶Ğ´ĞµĞ½Ğ¸Ğµ, Ñ‡Ñ‚Ğ¾ Ğ²ÑĞµ Ğ°ĞºÑĞµÑÑÑƒĞ°Ñ€Ñ‹ Ğ²Ğ¾Ğ·Ğ²Ñ€Ğ°Ñ‰ĞµĞ½Ñ‹")
    # Ğ£Ğ´Ğ°Ğ»ÑĞµĞ¼ Ğ¿Ğ¾Ğ»Ñ payment_amount Ğ¸ payment_description, Ñ‚Ğ°Ğº ĞºĞ°Ğº Ğ¿Ğ»Ğ°Ñ‚ĞµĞ¶ Ğ¾Ğ±Ñ€Ğ°Ğ±Ğ°Ñ‚Ñ‹Ğ²Ğ°ĞµÑ‚ÑÑ Ğ¾Ñ‚Ğ´ĞµĞ»ÑŒĞ½Ğ¾

    @classmethod
    def today(cls):
        return cls(actual_return_date=date.today())

```



## `shared\schemas\reservation_schema.py`


```python

# shared/schemas/reservation_schema.py

from pydantic import BaseModel, ConfigDict, Field
from datetime import date
from typing import List, Optional, Dict, Literal

from .user_schema import UserOut
from .accessory_schema import AccessoryOut
from .common_financials import FinancialsBase


class ReservationAccessoryDetail(BaseModel):
    equipment_id: int
    accessory: AccessoryOut
    model_config = ConfigDict(from_attributes=True)


class ReservationCreateRequest(BaseModel):
    equipment_ids: List[int]
    start_date: date
    end_date: date
    selected_accessories: Optional[Dict[int, List[int]]] = None
    promo_code: Optional[str] = None

class ReservationUpdateRequest(BaseModel):
    equipment_ids: List[int]
    start_date: date
    end_date: date
    selected_accessories: Optional[Dict[int, List[int]]] = None
    promo_code: Optional[str] = None
    confirm_date_adjustment: bool = False

class ReservationResponse(BaseModel):
    reservation_id: int
    message: str
    model_config = ConfigDict(from_attributes=True)

class ReservationItem(FinancialsBase):
    id: int
    user_id: int
    equipment_ids: List[int]
    start_date: date
    end_date: date
    status: Literal['active', 'fulfilled', 'cancelled', 'overdue']
    accessory_links: List[ReservationAccessoryDetail] = []
    rental_id: Optional[int] = Field(None, validation_alias='rental.id')

    model_config = ConfigDict(from_attributes=True)


class AdminReservationOut(ReservationItem):
    user_info: UserOut
    model_config = ConfigDict(from_attributes=True)

class AdminReservationCreateRequest(ReservationCreateRequest):
    user_id: int

class AdminReservationListResponse(BaseModel):
    items: List[AdminReservationOut]
    total: int

class ReservationListResponse(BaseModel):
    items: List[ReservationItem]
    total: int

class PriceCalculationRequest(BaseModel):
    equipment_ids: List[int]
    start_date: date
    end_date: date
    selected_accessories: Optional[Dict[int, List[int]]] = None
    promo_code: Optional[str] = None

class PriceCalculationResponse(BaseModel):
    day_count: int
    full_total: float
    final_total: float
    discount_amount: float
    duration_discount_percentage: int
    promo_discount_percentage: float
    promo_code_message: Optional[str] = None

class ReservationBulkDeleteRequest(BaseModel):
    """Ğ¡Ñ…ĞµĞ¼Ğ° Ğ´Ğ»Ñ Ğ·Ğ°Ğ¿Ñ€Ğ¾ÑĞ° Ğ½Ğ° Ğ¼Ğ°ÑÑĞ¾Ğ²Ğ¾Ğµ ÑƒĞ´Ğ°Ğ»ĞµĞ½Ğ¸Ğµ Ñ€ĞµĞ·ĞµÑ€Ğ²Ğ¾Ğ²."""
    reservation_ids: List[int]

```



## `shared\schemas\user_schema.py`


```python

# shared/schemas/user_schema.py

from pydantic import BaseModel, EmailStr, ConfigDict, validator, field_validator, Field
from typing import Optional, List, Annotated
import re
from datetime import datetime

# Ğ’ÑĞ¿Ğ¾Ğ¼Ğ¾Ğ³Ğ°Ñ‚ĞµĞ»ÑŒĞ½Ğ°Ñ Ñ„ÑƒĞ½ĞºÑ†Ğ¸Ñ Ğ²Ğ°Ğ»Ğ¸Ğ´Ğ°Ñ†Ğ¸Ğ¸, Ğ¾ÑÑ‚Ğ°ĞµÑ‚ÑÑ Ğ±ĞµĞ· Ğ¸Ğ·Ğ¼ĞµĞ½ĞµĞ½Ğ¸Ğ¹
def validate_phone_number(v: Optional[str]) -> Optional[str]:
    """Ğ’Ğ°Ğ»Ğ¸Ğ´Ğ°Ñ†Ğ¸Ñ Ğ½Ğ¾Ğ¼ĞµÑ€Ğ° Ñ‚ĞµĞ»ĞµÑ„Ğ¾Ğ½Ğ°"""
    if v is None:
        return v
    if not isinstance(v, str):
        raise ValueError('Ğ¢ĞµĞ»ĞµÑ„Ğ¾Ğ½ Ğ´Ğ¾Ğ»Ğ¶ĞµĞ½ Ğ±Ñ‹Ñ‚ÑŒ ÑÑ‚Ñ€Ğ¾ĞºĞ¾Ğ¹')

    phone_clean = re.sub(r'[^\d]', '', v)
    if len(phone_clean) < 10 or len(phone_clean) > 15:
        raise ValueError('ĞĞµĞºĞ¾Ñ€Ñ€ĞµĞºÑ‚Ğ½Ñ‹Ğ¹ Ñ„Ğ¾Ñ€Ğ¼Ğ°Ñ‚ Ñ‚ĞµĞ»ĞµÑ„Ğ¾Ğ½Ğ°')

    return v

# --- Ğ¡ÑƒÑ‰ĞµÑÑ‚Ğ²ÑƒÑÑ‰Ğ¸Ğµ ÑÑ…ĞµĞ¼Ñ‹ ---

class UserCreate(BaseModel):
    full_name: str
    email: EmailStr
    password: str
    phone: Optional[str] = None
    privacy_policy_accepted: bool = False
    terms_accepted: bool = False

    @field_validator('phone')
    @classmethod
    def validate_phone(cls, v):
        return validate_phone_number(v)

    @validator('privacy_policy_accepted')
    def validate_privacy_policy(cls, v):
        if not v:
            raise ValueError('ĞĞµĞ¾Ğ±Ñ…Ğ¾Ğ´Ğ¸Ğ¼Ğ¾ ÑĞ¾Ğ³Ğ»Ğ°ÑĞ¸Ğµ Ñ Ğ¿Ğ¾Ğ»Ğ¸Ñ‚Ğ¸ĞºĞ¾Ğ¹ Ğ¾Ğ±Ñ€Ğ°Ğ±Ğ¾Ñ‚ĞºĞ¸ Ğ¿ĞµÑ€ÑĞ¾Ğ½Ğ°Ğ»ÑŒĞ½Ñ‹Ñ… Ğ´Ğ°Ğ½Ğ½Ñ‹Ñ…')
        return v

    @validator('terms_accepted')
    def validate_terms(cls, v):
        if not v:
            raise ValueError('ĞĞµĞ¾Ğ±Ñ…Ğ¾Ğ´Ğ¸Ğ¼Ğ¾ ÑĞ¾Ğ³Ğ»Ğ°ÑĞ¸Ğµ Ñ ÑƒÑĞ»Ğ¾Ğ²Ğ¸ÑĞ¼Ğ¸ Ğ¸ÑĞ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ')
        return v

class AdminUserCreate(UserCreate):
    role: str = "user"

class AdminUserUpdate(BaseModel):
    full_name: Optional[str] = None
    phone: Optional[str] = None
    status: Optional[str] = None
    balance: Optional[float] = None
    notes: Optional[str] = None
    role: Optional[str] = None
    privacy_policy_accepted: Optional[bool] = None
    terms_accepted: Optional[bool] = None
    email_verified: Optional[bool] = None

    @field_validator('phone')
    @classmethod
    def validate_phone(cls, v):
        return validate_phone_number(v)

class UserUpdate(BaseModel):
    full_name: Optional[str] = None
    email: Optional[EmailStr] = None
    phone: Optional[str] = None

    @field_validator('phone')
    @classmethod
    def validate_phone(cls, v):
        return validate_phone_number(v)


class UserOut(BaseModel):
    id: int
    full_name: str
    email: EmailStr
    role: str
    is_active: bool
    phone: Optional[str] = None
    status: Optional[str] = None
    balance: float
    notes: Optional[str] = None
    privacy_policy_accepted: bool
    terms_accepted: bool
    email_verified: bool
    created_at: datetime

    model_config = ConfigDict(from_attributes=True)


class Token(BaseModel):
    access_token: str
    token_type: str


class UserListResponse(BaseModel):
    items: List[UserOut]
    total: int

# +++ ĞĞĞ§ĞĞ›Ğ: ĞĞĞ’ĞĞ¯ Ğ¡Ğ¥Ğ•ĞœĞ Ğ”Ğ›Ğ¯ ĞŸĞ Ğ˜Ğ•ĞœĞ ĞŸĞ›ĞĞ¢Ğ•Ğ–Ğ +++
class UserPaymentRequest(BaseModel):
    amount: float = Field(..., gt=0, description="Ğ¡ÑƒĞ¼Ğ¼Ğ° Ğ¿Ğ»Ğ°Ñ‚ĞµĞ¶Ğ°")
    payment_method: str = Field(..., description="ĞœĞµÑ‚Ğ¾Ğ´ Ğ¾Ğ¿Ğ»Ğ°Ñ‚Ñ‹ (Ğ½Ğ°Ğ»Ğ¸Ñ‡Ğ½Ñ‹Ğµ, ĞºĞ°Ñ€Ñ‚Ğ° Ğ¸ Ñ‚.Ğ´.)")
    description: Optional[str] = None
# +++ ĞšĞĞĞ•Ğ¦: ĞĞĞ’ĞĞ¯ Ğ¡Ğ¥Ğ•ĞœĞ Ğ”Ğ›Ğ¯ ĞŸĞ Ğ˜Ğ•ĞœĞ ĞŸĞ›ĞĞ¢Ğ•Ğ–Ğ +++

```


```


## <a name="RentalAppFASTAPIsplitpy"></a>`RentalApp_FASTAPI/split.py`

```python
// path: RentalApp_FASTAPI/split.py

import os
from pathlib import Path
import fnmatch

# ĞŸĞ°Ğ¿ĞºĞ° Ğ¿Ñ€Ğ¾ĞµĞºÑ‚Ğ°
project_root = Path(__file__).resolve().parent
output_filename = project_root / "smart_python_code_RentalApp.md"

# Ğ§Ñ‚Ğ¾ Ğ²ĞºĞ»ÑÑ‡Ğ°ĞµĞ¼
INCLUDE_DIRS = {"logic", "services", "db", "config", "ui", "config", "notifications", 'migrations', 'exports', 'api','schemas'}
INCLUDE_FILES = {"contract_template.html", 'requirements.txt'}
INCLUDE_EXTENSIONS = {".py", ".html"}

# Ğ§Ñ‚Ğ¾ Ğ¿Ğ¾Ğ»Ğ½Ğ¾ÑÑ‚ÑŒÑ Ğ¸ÑĞºĞ»ÑÑ‡Ğ°ĞµĞ¼ (Ğ¸ Ğ½Ğµ Ğ¾Ñ‚Ğ¾Ğ±Ñ€Ğ°Ğ¶Ğ°ĞµĞ¼ Ğ² ÑÑ‚Ñ€ÑƒĞºÑ‚ÑƒÑ€Ğµ)
EXCLUDE_DIRS = {'.git', '.venv', '__pycache__', 'tests', '.vscode', '.idea', '.gigaide', 'api'}
EXCLUDE_FILES = {'*.pyc', '*.pyo', '*.db', '__init__.py'}

# ĞŸĞ¾Ñ€Ğ¾Ğ³ ÑƒÑĞµÑ‡ĞµĞ½Ğ¸Ñ
MAX_LINES = 450
TRUNCATE_LINES = 50

def is_excluded(file_path: Path) -> bool:
    return any(fnmatch.fnmatch(file_path.name, pattern) for pattern in EXCLUDE_FILES)

def is_included(file_path: Path) -> bool:
    parts = file_path.relative_to(project_root).parts
    return (
            file_path.name in INCLUDE_FILES or
            (parts and parts[0] in INCLUDE_DIRS and file_path.suffix in INCLUDE_EXTENSIONS)
    )

def collect_files():
    included = []
    for root, dirs, files in os.walk(project_root):
        # ÑƒĞ´Ğ°Ğ»ÑĞµĞ¼ ÑĞ¸ÑÑ‚ĞµĞ¼Ğ½Ñ‹Ğµ Ğ¿Ğ°Ğ¿ĞºĞ¸ Ğ½Ğ° Ğ¼ĞµÑÑ‚Ğµ â€” Ğ½Ğµ Ğ¿Ğ¾Ğ¿Ğ°Ğ´ÑƒÑ‚ Ğ´Ğ°Ğ¶Ğµ Ğ² Ğ¾Ğ±Ñ…Ğ¾Ğ´
        dirs[:] = [d for d in dirs if d not in EXCLUDE_DIRS]
        for file in files:
            path = Path(root) / file
            rel_path = path.relative_to(project_root)
            if any(part in EXCLUDE_DIRS for part in rel_path.parts):
                continue
            if is_excluded(path):
                continue
            if is_included(path):
                included.append(path)
    return included

def summarize_structure(included, truncation_map):
    lines = ["# Ğ¡Ñ‚Ñ€ÑƒĞºÑ‚ÑƒÑ€Ğ° Ğ¿Ñ€Ğ¾ĞµĞºÑ‚Ğ°\n"]
    for file in sorted(included, key=lambda x: str(x)):
        rel = file.relative_to(project_root)
        if truncation_map.get(str(rel)):
            lines.append(f"- âš ï¸ `{rel}` (ÑƒÑĞµÑ‡Ñ‘Ğ½)")
        else:
            lines.append(f"- âœ… `{rel}`")
    return "\n".join(lines)

def write_output(included):
    truncation_map = {}
    with open(output_filename, "w", encoding="utf-8") as out:
        out.write("# Ğ¡Ğ¶Ğ°Ñ‚Ñ‹Ğ¹ Ğ¸ÑÑ…Ğ¾Ğ´Ğ½Ñ‹Ğ¹ ĞºĞ¾Ğ´ Ğ¿Ñ€Ğ¾ĞµĞºÑ‚Ğ° Ğ´Ğ»Ñ AI-Ğ¿Ğ¾Ğ¼Ğ¾Ñ‰Ğ½Ğ¸ĞºĞ°\n\n")

        code_blocks = []
        for path in sorted(included, key=lambda p: str(p.relative_to(project_root))):
            rel_path = path.relative_to(project_root)
            ext = path.suffix
            block = [f"\n\n## `{rel_path}`\n\n"]
            block.append("```python\n" if ext == ".py" else "```html\n")

            try:
                lines = path.read_text(encoding="utf-8").splitlines()
                if len(lines) > MAX_LINES:
                    truncation_map[str(rel_path)] = True
                    block.extend(lines[:TRUNCATE_LINES])
                    block.append(f"# ... truncated ({len(lines)} lines total)")
                    block.append("# âš ï¸ ĞŸĞ¾Ğ»Ğ½Ñ‹Ğ¹ ĞºĞ¾Ğ´ Ğ´Ğ¾ÑÑ‚ÑƒĞ¿ĞµĞ½ Ğ² Ğ¾Ñ€Ğ¸Ğ³Ğ¸Ğ½Ğ°Ğ»ÑŒĞ½Ğ¾Ğ¼ Ñ„Ğ°Ğ¹Ğ»Ğµ")
                else:
                    block.extend(lines)
            except Exception as e:
                block.append(f"# ĞÑˆĞ¸Ğ±ĞºĞ° Ñ‡Ñ‚ĞµĞ½Ğ¸Ñ Ñ„Ğ°Ğ¹Ğ»Ğ°: {e}")
            block.append("\n```\n")
            code_blocks.append("\n".join(block))

        structure = summarize_structure(included, truncation_map)
        out.write(structure)
        out.write("\n\n---\n")
        out.write("\n".join(code_blocks))

def main():
    included_files = collect_files()
    write_output(included_files)
    print(f"âœ… Ğ¤Ğ°Ğ¹Ğ» '{output_filename.name}' ÑƒÑĞ¿ĞµÑˆĞ½Ğ¾ ÑĞ¾Ğ·Ğ´Ğ°Ğ½.")

if __name__ == "__main__":
    main()


```


## <a name="RentalAppFASTAPIsplitapipy"></a>`RentalApp_FASTAPI/split_api.py`

```python
// path: RentalApp_FASTAPI/split_api.py

import os
from pathlib import Path
import fnmatch

# ĞŸĞ°Ğ¿ĞºĞ° Ğ¿Ñ€Ğ¾ĞµĞºÑ‚Ğ°
project_root = Path(__file__).resolve().parent
output_filename = project_root / "smart_python_code_FastAPI.md"

# Ğ§Ñ‚Ğ¾ Ğ²ĞºĞ»ÑÑ‡Ğ°ĞµĞ¼
INCLUDE_DIRS = {"api", "shared", "db"}
INCLUDE_FILES = {"contract_template.html", 'requirements.txt'}
INCLUDE_EXTENSIONS = {".py", ".html", ".env"}

# Ğ§Ñ‚Ğ¾ Ğ¿Ğ¾Ğ»Ğ½Ğ¾ÑÑ‚ÑŒÑ Ğ¸ÑĞºĞ»ÑÑ‡Ğ°ĞµĞ¼ (Ğ¸ Ğ½Ğµ Ğ¾Ñ‚Ğ¾Ğ±Ñ€Ğ°Ğ¶Ğ°ĞµĞ¼ Ğ² ÑÑ‚Ñ€ÑƒĞºÑ‚ÑƒÑ€Ğµ)
EXCLUDE_DIRS = {'.git', '.venv', '__pycache__', 'tests', '.vscode', '.idea', '.gigaide'}
EXCLUDE_FILES = {'*.pyc', '*.pyo', '*.db', '__init__.py'}

# ĞŸĞ¾Ñ€Ğ¾Ğ³ ÑƒÑĞµÑ‡ĞµĞ½Ğ¸Ñ
MAX_LINES = 350
TRUNCATE_LINES = 50

def is_excluded(file_path: Path) -> bool:
    return any(fnmatch.fnmatch(file_path.name, pattern) for pattern in EXCLUDE_FILES)

def is_included(file_path: Path) -> bool:
    parts = file_path.relative_to(project_root).parts
    return (
            file_path.name in INCLUDE_FILES or
            (parts and parts[0] in INCLUDE_DIRS and file_path.suffix in INCLUDE_EXTENSIONS)
    )

def collect_files():
    included = []
    for root, dirs, files in os.walk(project_root):
        # ÑƒĞ´Ğ°Ğ»ÑĞµĞ¼ ÑĞ¸ÑÑ‚ĞµĞ¼Ğ½Ñ‹Ğµ Ğ¿Ğ°Ğ¿ĞºĞ¸ Ğ½Ğ° Ğ¼ĞµÑÑ‚Ğµ â€” Ğ½Ğµ Ğ¿Ğ¾Ğ¿Ğ°Ğ´ÑƒÑ‚ Ğ´Ğ°Ğ¶Ğµ Ğ² Ğ¾Ğ±Ñ…Ğ¾Ğ´
        dirs[:] = [d for d in dirs if d not in EXCLUDE_DIRS]
        for file in files:
            path = Path(root) / file
            rel_path = path.relative_to(project_root)
            if any(part in EXCLUDE_DIRS for part in rel_path.parts):
                continue
            if is_excluded(path):
                continue
            if is_included(path):
                included.append(path)
    return included

def summarize_structure(included, truncation_map):
    lines = ["# Ğ¡Ñ‚Ñ€ÑƒĞºÑ‚ÑƒÑ€Ğ° Ğ¿Ñ€Ğ¾ĞµĞºÑ‚Ğ°\n"]
    for file in sorted(included, key=lambda x: str(x)):
        rel = file.relative_to(project_root)
        if truncation_map.get(str(rel)):
            lines.append(f"- âš ï¸ `{rel}` (ÑƒÑĞµÑ‡Ñ‘Ğ½)")
        else:
            lines.append(f"- âœ… `{rel}`")
    return "\n".join(lines)

def write_output(included):
    truncation_map = {}
    with open(output_filename, "w", encoding="utf-8") as out:
        out.write("# Ğ¡Ğ¶Ğ°Ñ‚Ñ‹Ğ¹ Ğ¸ÑÑ…Ğ¾Ğ´Ğ½Ñ‹Ğ¹ ĞºĞ¾Ğ´ Ğ¿Ñ€Ğ¾ĞµĞºÑ‚Ğ° Ğ´Ğ»Ñ AI-Ğ¿Ğ¾Ğ¼Ğ¾Ñ‰Ğ½Ğ¸ĞºĞ°\n\n")

        code_blocks = []
        for path in sorted(included, key=lambda p: str(p.relative_to(project_root))):
            rel_path = path.relative_to(project_root)
            ext = path.suffix
            block = [f"\n\n## `{rel_path}`\n\n"]
            block.append("```python\n" if ext == ".py" else "```html\n")

            try:
                lines = path.read_text(encoding="utf-8").splitlines()
                if len(lines) > MAX_LINES:
                    truncation_map[str(rel_path)] = True
                    block.extend(lines[:TRUNCATE_LINES])
                    block.append(f"# ... truncated ({len(lines)} lines total)")
                    block.append("# âš ï¸ ĞŸĞ¾Ğ»Ğ½Ñ‹Ğ¹ ĞºĞ¾Ğ´ Ğ´Ğ¾ÑÑ‚ÑƒĞ¿ĞµĞ½ Ğ² Ğ¾Ñ€Ğ¸Ğ³Ğ¸Ğ½Ğ°Ğ»ÑŒĞ½Ğ¾Ğ¼ Ñ„Ğ°Ğ¹Ğ»Ğµ")
                else:
                    block.extend(lines)
            except Exception as e:
                block.append(f"# ĞÑˆĞ¸Ğ±ĞºĞ° Ñ‡Ñ‚ĞµĞ½Ğ¸Ñ Ñ„Ğ°Ğ¹Ğ»Ğ°: {e}")
            block.append("\n```\n")
            code_blocks.append("\n".join(block))

        structure = summarize_structure(included, truncation_map)
        out.write(structure)
        out.write("\n\n---\n")
        out.write("\n".join(code_blocks))

def main():
    included_files = collect_files()
    write_output(included_files)
    print(f"âœ… Ğ¤Ğ°Ğ¹Ğ» '{output_filename.name}' ÑƒÑĞ¿ĞµÑˆĞ½Ğ¾ ÑĞ¾Ğ·Ğ´Ğ°Ğ½.")

if __name__ == "__main__":
    main()


```


## <a name="RentalAppFASTAPIsplittxtpy"></a>`RentalApp_FASTAPI/split_txt.py`

```python
// path: RentalApp_FASTAPI/split_txt.py

import os

# ĞŸÑƒÑ‚ÑŒ Ğº ĞºĞ¾Ñ€Ğ½Ñ Ğ¿Ñ€Ğ¾ĞµĞºÑ‚Ğ°
project_root = os.path.dirname(os.path.abspath(__file__))

# Ğ˜Ğ¼Ñ Ğ¸Ñ‚Ğ¾Ğ³Ğ¾Ğ²Ğ¾Ğ³Ğ¾ Ñ„Ğ°Ğ¹Ğ»Ğ°
output_filename = os.path.join(project_root, "all_python_code.txt")

# ĞŸĞ¾Ğ»ÑƒÑ‡Ğ°ĞµĞ¼ Ğ°Ğ±ÑĞ¾Ğ»ÑÑ‚Ğ½Ñ‹Ğ¹ Ğ¿ÑƒÑ‚ÑŒ Ğº ÑÑ‚Ğ¾Ğ¼Ñƒ Ñ„Ğ°Ğ¹Ğ»Ñƒ, Ñ‡Ñ‚Ğ¾Ğ±Ñ‹ Ğ¸ÑĞºĞ»ÑÑ‡Ğ¸Ñ‚ÑŒ ĞµĞ³Ğ¾
this_script = os.path.abspath(__file__)

with open(output_filename, "w", encoding="utf-8") as output_file:
    for root, dirs, files in os.walk(project_root):
        # Ğ˜ÑĞºĞ»ÑÑ‡Ğ°ĞµĞ¼ venv Ğ¸ ÑĞºÑ€Ñ‹Ñ‚Ñ‹Ğµ Ğ´Ğ¸Ñ€ĞµĞºÑ‚Ğ¾Ñ€Ğ¸Ğ¸
        dirs[:] = [d for d in dirs if not d.startswith('.') and d != 'venv' and d != '__pycache__']

        for file in files:
            file_path = os.path.join(root, file)

            # ĞŸÑ€Ğ¾Ğ¿ÑƒÑĞºĞ°ĞµĞ¼ ÑĞ°Ğ¼ ÑĞºÑ€Ğ¸Ğ¿Ñ‚, Ğ‘Ğ”-Ñ„Ğ°Ğ¹Ğ»Ñ‹ Ğ¸ Ğ½Ğµ .py Ñ„Ğ°Ğ¹Ğ»Ñ‹
            if (
                    file_path == this_script or
                    not file.endswith(".py") or
                    file.endswith(".pyc") or
                    file.endswith(".pyo") or
                    file.endswith(".db")
            ):
                continue

            output_file.write(f"\n\n# === {os.path.relpath(file_path, project_root)} ===\n\n")
            with open(file_path, "r", encoding="utf-8") as f:
                output_file.write(f.read())

```


## <a name="dockercomposeyml"></a>`docker-compose.yml`

```yaml
// path: docker-compose.yml

# S_PROJECT_DOCKER/docker-compose.yml

services:
  db:
    image: postgres:15-alpine
    volumes:
      - postgres_data:/var/lib/postgresql/data/
    environment:
      - POSTGRES_USER=${POSTGRES_USER}
      - POSTGRES_PASSWORD=${POSTGRES_PASSWORD}
      - POSTGRES_DB=${POSTGRES_DB}
    ports:
      - "5433:5432"
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${POSTGRES_USER} -d ${POSTGRES_DB}"]
      interval: 10s
      timeout: 5s
      retries: 5

# docker-compose.yml (Ğ·Ğ°Ğ¼ĞµĞ½Ğ¸Ñ‚Ğµ Ñ‚Ğ¾Ğ»ÑŒĞºĞ¾ ÑÑ‚Ğ¾Ñ‚ ÑĞµÑ€Ğ²Ğ¸Ñ)

  backend:
    build:
      context: ./RentalApp_FASTAPI
      dockerfile: Dockerfile.backend
    volumes:
      - ./RentalApp_FASTAPI/api:/app/api
      - ./RentalApp_FASTAPI/shared:/app/shared
      - ./RentalApp_FASTAPI/config:/app/config
      - ./RentalApp_FASTAPI/migrations:/app/migrations
      - ./RentalApp_FASTAPI/alembic.ini:/app/alembic.ini
    ports:
      - "8000:8000"
    # Ğ˜Ğ—ĞœĞ•ĞĞ•ĞĞ˜Ğ• Ğ—Ğ”Ğ•Ğ¡Ğ¬: Ğ”Ğ¾Ğ±Ğ°Ğ²Ğ»ÑĞµĞ¼ Ğ²ÑĞµ Ğ¾ÑÑ‚Ğ°Ğ»ÑŒĞ½Ñ‹Ğµ Ğ¿ĞµÑ€ĞµĞ¼ĞµĞ½Ğ½Ñ‹Ğµ
    environment:
      - DATABASE_URL=postgresql+asyncpg://${POSTGRES_USER}:${POSTGRES_PASSWORD}@db:5432/${POSTGRES_DB}
      - CSRF_SECRET_KEY=${CSRF_SECRET_KEY}
      - TELEGRAM_TOKEN=${TELEGRAM_TOKEN}
      - DEFAULT_TELEGRAM_CHAT_ID=${DEFAULT_TELEGRAM_CHAT_ID}
      - DEBUG=${DEBUG}
      - YANDEX_EMAIL_SENDER=${YANDEX_EMAIL_SENDER}
      - YANDEX_SMTP_PASSWORD=${YANDEX_SMTP_PASSWORD}
      - DB_TYPE=${DB_TYPE}
      - SECRET_KEY=${SECRET_KEY}
      - TZ=Europe/Astrakhan
    depends_on:
      db:
        condition: service_healthy
        
  frontend:
    build:
      context: ./rental-app-main
      dockerfile: Dockerfile.frontend
    ports:
      - "5173:80"
    volumes:
      - ./rental-app-main/nginx/nginx.conf:/etc/nginx/conf.d/default.conf
    depends_on:
      - backend

volumes:
  postgres_data:

```


## <a name="rentalappmainDockerfilefrontend"></a>`rental-app-main/Dockerfile.frontend`

```dockerfile
// path: rental-app-main/Dockerfile.frontend

# rental-app-main/Dockerfile.frontend

# --- Ğ­Ğ¢ĞĞŸ 1: Ğ¡Ğ±Ğ¾Ñ€ĞºĞ° ---
FROM node:20-alpine as build
WORKDIR /app

# ĞŸÑƒÑ‚Ğ¸ Ñ‚ĞµĞ¿ĞµÑ€ÑŒ Ğ¾Ñ‚Ğ½Ğ¾ÑĞ¸Ñ‚ĞµĞ»ÑŒĞ½Ñ‹ Ğ¿Ğ°Ğ¿ĞºĞ¸ rental-app-main
COPY package*.json ./
RUN npm install

COPY . .
RUN npm run build

# --- Ğ­Ğ¢ĞĞŸ 2: ĞŸĞ¾Ğ´Ğ°Ñ‡Ğ° ---
FROM nginx:stable-alpine
COPY --from=build /app/dist /usr/share/nginx/html

# Ğ¡Ñ‚Ñ€Ğ¾ĞºĞ° `COPY nginx.conf` ÑƒĞ´Ğ°Ğ»ĞµĞ½Ğ°, Ñ‚Ğ°Ğº ĞºĞ°Ğº ÑÑ‚Ğ¸Ğ¼ Ñ‚ĞµĞ¿ĞµÑ€ÑŒ ÑƒĞ¿Ñ€Ğ°Ğ²Ğ»ÑĞµÑ‚ docker-compose.yml
EXPOSE 80
CMD ["nginx", "-g", "daemon off;"]

```


## <a name="rentalappmainREADMEAImd"></a>`rental-app-main/README_AI.md`

```markdown
// path: rental-app-main/README_AI.md

# ğŸ“˜ Ğ˜Ğ½ÑÑ‚Ñ€ÑƒĞºÑ†Ğ¸Ñ Ğ´Ğ»Ñ AI-Ğ¿Ğ¾Ğ¼Ğ¾Ñ‰Ğ½Ğ¸ĞºĞ°

Ğ­Ñ‚Ğ¾Ñ‚ Ğ¿Ñ€Ğ¾ĞµĞºÑ‚ ÑĞ¾Ğ±Ñ€Ğ°Ğ½ ÑĞºÑ€Ğ¸Ğ¿Ñ‚Ğ¾Ğ¼ `split_optimized.py` Ğ´Ğ»Ñ Ğ°Ğ½Ğ°Ğ»Ğ¸Ğ·Ğ° Ğ˜Ğ˜.

## ğŸ“‚ Ğ¡Ğ¾Ğ´ĞµÑ€Ğ¶Ğ¸Ğ¼Ğ¾Ğµ
- `smart_react_code.md` â€” Ğ¾ÑĞ½Ğ¾Ğ²Ğ½Ğ¾Ğ¹ Ñ„Ğ°Ğ¹Ğ» Ñ ĞºĞ¾Ğ´Ğ¾Ğ¼
- `README_AI.md` â€” ÑÑ‚Ğ° Ğ¸Ğ½ÑÑ‚Ñ€ÑƒĞºÑ†Ğ¸Ñ

## ğŸš€ ĞšĞ°Ğº Ğ¸ÑĞ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ÑŒ
ĞŸĞµÑ€ĞµĞ´Ğ°Ğ¹ `smart_react_code.md` Ğ² AI-Ğ¿Ğ¾Ğ¼Ğ¾Ñ‰Ğ½Ğ¸Ğº. ĞĞ½ ÑĞ¾Ğ´ĞµÑ€Ğ¶Ğ¸Ñ‚ ÑÑ‚Ñ€ÑƒĞºÑ‚ÑƒÑ€Ñƒ, Ğ¾Ğ³Ğ»Ğ°Ğ²Ğ»ĞµĞ½Ğ¸Ğµ, ĞºĞ»ÑÑ‡ĞµĞ²Ñ‹Ğµ ÑƒÑ‡Ğ°ÑÑ‚ĞºĞ¸ ĞºĞ¾Ğ´Ğ°.
ĞŸĞ¾ ÑƒĞ¼Ğ¾Ğ»Ñ‡Ğ°Ğ½Ğ¸Ñ UI-ĞºĞ¾Ğ¼Ğ¿Ğ¾Ğ½ĞµĞ½Ñ‚Ñ‹ (`src/components/ui`) Ğ¸ÑĞºĞ»ÑÑ‡ĞµĞ½Ñ‹, Ğ²ĞºĞ»ÑÑ‡Ğ¸ Ğ¸Ñ… Ñ„Ğ»Ğ°Ğ³Ğ¾Ğ¼ `--include-ui` Ğ¿Ñ€Ğ¸ Ğ½ĞµĞ¾Ğ±Ñ…Ğ¾Ğ´Ğ¸Ğ¼Ğ¾ÑÑ‚Ğ¸.


```


## <a name="rentalappmaincomponentsjson"></a>`rental-app-main/components.json`

```json
// path: rental-app-main/components.json

{
  "$schema": "https://ui.shadcn.com/schema.json",
  "style": "new-york",
  "rsc": false,
  "tsx": true,
  "tailwind": {
    "config": "tailwind.config.js",
    "css": "src/index.css",
    "baseColor": "neutral",
    "cssVariables": true,
    "prefix": ""
  },
  "aliases": {
    "components": "@/components",
    "utils": "@/lib/utils",
    "ui": "@/components/ui",
    "lib": "@/lib",
    "hooks": "@/hooks"
  },
  "iconLibrary": "lucide"
}

```


## <a name="rentalappmaineslintconfigjs"></a>`rental-app-main/eslint.config.js`

```javascript
// path: rental-app-main/eslint.config.js

import js from '@eslint/js'
import globals from 'globals'
import reactHooks from 'eslint-plugin-react-hooks'
import reactRefresh from 'eslint-plugin-react-refresh'
import tseslint from 'typescript-eslint'

export default tseslint.config(
  { ignores: ['dist'] },
  {
    extends: [js.configs.recommended, ...tseslint.configs.recommended],
    files: ['**/*.{ts,tsx}'],
    languageOptions: {
      ecmaVersion: 2020,
      globals: globals.browser,
    },
    plugins: {
      'react-hooks': reactHooks,
      'react-refresh': reactRefresh,
    },
    rules: {
      ...reactHooks.configs.recommended.rules,
      'react-refresh/only-export-components': [
        'warn',
        { allowConstantExport: true },
      ],
    },
  },
)


```


## <a name="rentalappmainnginxnginxconf"></a>`rental-app-main/nginx/nginx.conf`

```nginx
// path: rental-app-main/nginx/nginx.conf

# nginx/nginx.conf

server {
    # Nginx Ğ±ÑƒĞ´ĞµÑ‚ ÑĞ»ÑƒÑˆĞ°Ñ‚ÑŒ Ğ¿Ğ¾Ñ€Ñ‚ 80 Ğ²Ğ½ÑƒÑ‚Ñ€Ğ¸ ĞºĞ¾Ğ½Ñ‚ĞµĞ¹Ğ½ĞµÑ€Ğ°.
    listen 80;

    # ĞšĞ¾Ñ€Ğ½ĞµĞ²Ğ°Ñ Ğ¿Ğ°Ğ¿ĞºĞ°, ĞºÑƒĞ´Ğ° Ğ¼Ñ‹ ÑĞºĞ¾Ğ¿Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ»Ğ¸ ÑĞ¾Ğ±Ñ€Ğ°Ğ½Ğ½Ñ‹Ğ¹ React-Ğ¿Ñ€Ğ¾ĞµĞºÑ‚.
    root   /usr/share/nginx/html;
    index  index.html;

    # Ğ‘Ğ»Ğ¾Ğº Ğ´Ğ»Ñ Ğ¿ĞµÑ€ĞµĞ½Ğ°Ğ¿Ñ€Ğ°Ğ²Ğ»ĞµĞ½Ğ¸Ñ API-Ğ·Ğ°Ğ¿Ñ€Ğ¾ÑĞ¾Ğ² Ñ Ğ¿Ñ€ĞµÑ„Ğ¸ĞºÑĞ¾Ğ¼ /api/
    # Ğ’ÑĞµ Ğ·Ğ°Ğ¿Ñ€Ğ¾ÑÑ‹, Ğ½Ğ°Ñ‡Ğ¸Ğ½Ğ°ÑÑ‰Ğ¸ĞµÑÑ Ñ /api/, Ğ±ÑƒĞ´ÑƒÑ‚ Ğ¿ĞµÑ€ĞµĞ½Ğ°Ğ¿Ñ€Ğ°Ğ²Ğ»ĞµĞ½Ñ‹ Ğ½Ğ° backend-ÑĞµÑ€Ğ²Ğ¸Ñ
    # Ñ ÑƒĞ´Ğ°Ğ»ĞµĞ½Ğ¸ĞµĞ¼ Ğ¿Ñ€ĞµÑ„Ğ¸ĞºÑĞ° /api/ Ğ¿ĞµÑ€ĞµĞ´ Ğ¾Ñ‚Ğ¿Ñ€Ğ°Ğ²ĞºĞ¾Ğ¹
    location /api/ {
        rewrite /api/(.*) /$1 break;
        proxy_pass http://backend:8000;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    # Ğ‘Ğ»Ğ¾Ğº Ğ´Ğ»Ñ Ğ¾Ğ±Ñ€Ğ°Ğ±Ğ¾Ñ‚ĞºĞ¸ Ğ²ÑĞµÑ… Ğ¾ÑÑ‚Ğ°Ğ»ÑŒĞ½Ñ‹Ñ… Ğ·Ğ°Ğ¿Ñ€Ğ¾ÑĞ¾Ğ² (SPA Ñ€Ğ¾ÑƒÑ‚Ğ¸Ğ½Ğ³).
    # Ğ­Ñ‚Ğ° Ğ²Ğ°Ğ¶Ğ½Ğ°Ñ ÑÑ‚Ñ€Ğ¾ĞºĞ° Ğ½ÑƒĞ¶Ğ½Ğ° Ğ´Ğ»Ñ React Router. Ğ•ÑĞ»Ğ¸ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ÑŒ Ğ¾Ğ±Ğ½Ğ¾Ğ²Ğ¸Ñ‚ ÑÑ‚Ñ€Ğ°Ğ½Ğ¸Ñ†Ñƒ
    # Ğ¿Ğ¾ Ğ°Ğ´Ñ€ĞµÑÑƒ /profile, Nginx ÑĞ½Ğ°Ñ‡Ğ°Ğ»Ğ° Ğ¿Ğ¾Ğ¿Ñ‹Ñ‚Ğ°ĞµÑ‚ÑÑ Ğ½Ğ°Ğ¹Ñ‚Ğ¸ Ñ„Ğ°Ğ¹Ğ» /profile.
    # ĞĞµ Ğ½Ğ°Ğ¹Ğ´Ñ ĞµĞ³Ğ¾, Ğ¾Ğ½ Ğ¾Ñ‚Ğ´Ğ°ÑÑ‚ /index.html, Ğ° React Router ÑƒĞ¶Ğµ ÑĞ°Ğ¼ Ñ€Ğ°Ğ·Ğ±ĞµÑ€ĞµÑ‚ÑÑ Ñ Ğ¼Ğ°Ñ€ÑˆÑ€ÑƒÑ‚Ğ¾Ğ¼.
    location / {
        try_files $uri $uri/ /index.html;
    }
}

```


## <a name="rentalappmainpackagejson"></a>`rental-app-main/package.json`

```json
// path: rental-app-main/package.json

{
  "name": "rental-app-main",
  "private": true,
  "version": "0.0.0",
  "type": "module",
  "scripts": {
    "dev": "vite",
    "build": "vite build",
    "lint": "eslint .",
    "preview": "vite preview"
  },
  "dependencies": {
    "@fullcalendar/core": "^6.1.17",
    "@fullcalendar/daygrid": "^6.1.17",
    "@fullcalendar/interaction": "^6.1.17",
    "@fullcalendar/react": "^6.1.17",
    "@fullcalendar/resource-timeline": "^6.1.17",
    "@hookform/resolvers": "^5.0.1",
    "@radix-ui/react-checkbox": "^1.3.1",
    "@radix-ui/react-dialog": "^1.1.14",
    "@radix-ui/react-label": "^2.1.6",
    "@radix-ui/react-popover": "^1.1.14",
    "@radix-ui/react-scroll-area": "^1.2.9",
    "@radix-ui/react-select": "^2.2.4",
    "@radix-ui/react-slot": "^1.2.2",
    "@radix-ui/react-switch": "^1.2.5",
    "@radix-ui/react-toggle": "^1.1.8",
    "@radix-ui/react-toggle-group": "^1.1.9",
    "@tanstack/react-query": "^5.76.1",
    "@tanstack/react-query-devtools": "^5.76.1",
    "@types/react-input-mask": "^3.0.6",
    "@uiw/react-md-editor": "^4.0.7",
    "axios": "^1.9.0",
    "class-variance-authority": "^0.7.1",
    "clsx": "^2.1.1",
    "cmdk": "^1.1.1",
    "date-fns": "^4.1.0",
    "lucide-react": "^0.511.0",
    "react": "^19.1.0",
    "react-day-picker": "^9.7.0",
    "react-dom": "^19.1.0",
    "react-error-boundary": "^6.0.0",
    "react-hook-form": "^7.56.4",
    "react-imask": "^7.6.1",
    "react-markdown": "^10.1.0",
    "react-router-dom": "^7.6.0",
    "rehype-sanitize": "^6.0.0",
    "sonner": "^2.0.3",
    "tailwind-merge": "^3.3.0",
    "tailwindcss-animate": "^1.0.7",
    "zod": "^3.25.28",
    "zustand": "^5.0.4"
  },
  "devDependencies": {
    "@eslint/js": "^9.25.0",
    "@tailwindcss/typography": "^0.5.16",
    "@types/mocha": "^10.0.10",
    "@types/node": "^24.0.10",
    "@types/react": "^19.1.2",
    "@types/react-dom": "^19.1.2",
    "@vitejs/plugin-react": "^4.4.1",
    "autoprefixer": "^10.4.15",
    "eslint": "^9.25.0",
    "eslint-plugin-react-hooks": "^5.2.0",
    "eslint-plugin-react-refresh": "^0.4.19",
    "globals": "^16.0.0",
    "postcss": "^8.4.38",
    "tailwindcss": "^3.4.1",
    "typescript": "~5.8.3",
    "typescript-eslint": "^8.30.1",
    "vite": "^6.3.5"
  }
}


```


## <a name="rentalappmainpostcssconfigjs"></a>`rental-app-main/postcss.config.js`

```javascript
// path: rental-app-main/postcss.config.js

// postcss.config.js

export default {
    plugins: {
        tailwindcss: {},
        autoprefixer: {},
    },
}

```


## <a name="rentalappmainpublicfaviconsvg"></a>`rental-app-main/public/favicon.svg`

```
[Ğ¡Ğ¾Ğ´ĞµÑ€Ğ¶Ğ¸Ğ¼Ğ¾Ğµ SVG Ñ„Ğ°Ğ¹Ğ»Ğ° 'favicon.svg' Ğ½Ğµ Ğ²ĞºĞ»ÑÑ‡ĞµĞ½Ğ¾ Ğ´Ğ»Ñ ÑĞºĞ¾Ğ½Ğ¾Ğ¼Ğ¸Ğ¸ Ğ¼ĞµÑÑ‚Ğ°]
```


## <a name="rentalappmainpublicvitesvg"></a>`rental-app-main/public/vite.svg`

```
[Ğ¡Ğ¾Ğ´ĞµÑ€Ğ¶Ğ¸Ğ¼Ğ¾Ğµ SVG Ñ„Ğ°Ğ¹Ğ»Ğ° 'vite.svg' Ğ½Ğµ Ğ²ĞºĞ»ÑÑ‡ĞµĞ½Ğ¾ Ğ´Ğ»Ñ ÑĞºĞ¾Ğ½Ğ¾Ğ¼Ğ¸Ğ¸ Ğ¼ĞµÑÑ‚Ğ°]
```


## <a name="rentalappmainrentalappmainREADMEmd"></a>`rental-app-main/rental_app_main/README.md`

```markdown
// path: rental-app-main/rental_app_main/README.md

# rental_app_main



```


## <a name="rentalappmainsmartreactcodegemv2md"></a>`rental-app-main/smart_react_code_gem_v2.md`

```markdown
// path: rental-app-main/smart_react_code_gem_v2.md

# ğŸ¤– Ğ¡Ğ¶Ğ°Ñ‚Ñ‹Ğ¹ Ğ¸ÑÑ…Ğ¾Ğ´Ğ½Ñ‹Ğ¹ ĞºĞ¾Ğ´ Ñ„Ñ€Ğ¾Ğ½Ñ‚ĞµĞ½Ğ´Ğ° Ğ´Ğ»Ñ AI-Ğ¿Ğ¾Ğ¼Ğ¾Ñ‰Ğ½Ğ¸ĞºĞ°

## ğŸ”— Ğ‘Ñ‹ÑÑ‚Ñ€Ğ°Ñ Ğ½Ğ°Ğ²Ğ¸Ğ³Ğ°Ñ†Ğ¸Ñ Ğ¿Ğ¾ Ñ„Ğ°Ğ¹Ğ»Ğ°Ğ¼
- [package.json](#packagejson)
- [postcss.config.js](#postcssconfigjs)
- [public/favicon.svg](#publicfaviconsvg)
- [public/vite.svg](#publicvitesvg)
- [src/app/App.tsx](#srcappApptsx)
- [src/assets/react.svg](#srcassetsreactsvg)
- [src/components/AssociationFilter.tsx](#srccomponentsAssociationFiltertsx)
- [src/components/AuthForm.tsx](#srccomponentsAuthFormtsx)
- [src/components/AuthStatus.tsx](#srccomponentsAuthStatustsx)
- [src/components/AvailabilityStrip.tsx](#srccomponentsAvailabilityStriptsx)
- [src/components/AvailableCheckbox.tsx](#srccomponentsAvailableCheckboxtsx)
- [src/components/BrandFilter.tsx](#srccomponentsBrandFiltertsx)
- [src/components/CancelReservationDialog.tsx](#srccomponentsCancelReservationDialogtsx)
- [src/components/CardShell.tsx](#srccomponentsCardShelltsx)
- [src/components/CompactEquipmentCard.tsx](#srccomponentsCompactEquipmentCardtsx)
- [src/components/ConfirmItemRemovalDialog.tsx](#srccomponentsConfirmItemRemovalDialogtsx)
- [src/components/DateRangeSelector.tsx](#srccomponentsDateRangeSelectortsx)
- [src/components/DateRangeSelector/calendar.css](#srccomponentsDateRangeSelectorcalendarcss)
- [src/components/DiscountCalculator.tsx](#srccomponentsDiscountCalculatortsx)
- [src/components/EquipmentGrid.tsx](#srccomponentsEquipmentGridtsx)
- [src/components/ErrorBoundary.tsx](#srccomponentsErrorBoundarytsx)
- [src/components/ErrorMessage.tsx](#srccomponentsErrorMessagetsx)
- [src/components/FilterPanel.tsx](#srccomponentsFilterPaneltsx)
- [src/components/MyReservationList.tsx](#srccomponentsMyReservationListtsx)
- [src/components/NetworkStatus.tsx](#srccomponentsNetworkStatustsx)
- [src/components/PromoCodeInput.tsx](#srccomponentsPromoCodeInputtsx)
- [src/components/RequireAuth.tsx](#srccomponentsRequireAuthtsx)
- [src/components/ReservationCard.tsx](#srccomponentsReservationCardtsx)
- [src/components/ReservationFooter.tsx](#srccomponentsReservationFootertsx)
- [src/components/ReservationList.tsx](#srccomponentsReservationListtsx)
- [src/components/ReserveEquipmentCard.tsx](#srccomponentsReserveEquipmentCardtsx)
- [src/components/SearchInput.tsx](#srccomponentsSearchInputtsx)
- [src/components/StatusBadge.tsx](#srccomponentsStatusBadgetsx)
- [src/components/TypeFilter.tsx](#srccomponentsTypeFiltertsx)
- [src/components/UserInfoBlock.tsx](#srccomponentsUserInfoBlocktsx)
- [src/components/ViewModeToggle.tsx](#srccomponentsViewModeToggletsx)
- [src/components/admin/AccessoryDialogs.tsx](#srccomponentsadminAccessoryDialogstsx)
- [src/components/admin/AccessoryTable.tsx](#srccomponentsadminAccessoryTabletsx)
- [src/components/admin/AdminNavigation.tsx](#srccomponentsadminAdminNavigationtsx)
- [src/components/admin/AdminRentalCard.tsx](#srccomponentsadminAdminRentalCardtsx)
- [src/components/admin/AdminReservationCard.tsx](#srccomponentsadminAdminReservationCardtsx)
- [src/components/admin/AdminReservationToolbar.tsx](#srccomponentsadminAdminReservationToolbartsx)
- [src/components/admin/AllRentalsList.tsx](#srccomponentsadminAllRentalsListtsx)
- [src/components/admin/AllReservationsList.tsx](#srccomponentsadminAllReservationsListtsx)
- [src/components/admin/AssociationTable.tsx](#srccomponentsadminAssociationTabletsx)
- [src/components/admin/ConvertReservationDialog.tsx](#srccomponentsadminConvertReservationDialogtsx)
- [src/components/admin/CreateReservationDialog.tsx](#srccomponentsadminCreateReservationDialogtsx)
- [src/components/admin/CreateReservationStep1Details.tsx](#srccomponentsadminCreateReservationStep1Detailstsx)
- [src/components/admin/CreateReservationStep2Accessories.tsx](#srccomponentsadminCreateReservationStep2Accessoriestsx)
- [src/components/admin/DurationDiscountManager.tsx](#srccomponentsadminDurationDiscountManagertsx)
- [src/components/admin/EditableRentalCard.tsx](#srccomponentsadminEditableRentalCardtsx)
- [src/components/admin/EquipmentCreateDialog.tsx](#srccomponentsadminEquipmentCreateDialogtsx)
- [src/components/admin/EquipmentEditDialog.tsx](#srccomponentsadminEquipmentEditDialogtsx)
- [src/components/admin/EquipmentStats.tsx](#srccomponentsadminEquipmentStatstsx)
- [src/components/admin/EquipmentTable.tsx](#srccomponentsadminEquipmentTabletsx)
- [src/components/admin/EquipmentTableRow.tsx](#srccomponentsadminEquipmentTableRowtsx)
- [src/components/admin/EquipmentTableToolbar.tsx](#srccomponentsadminEquipmentTableToolbartsx)
- [src/components/admin/HolidayManager.tsx](#srccomponentsadminHolidayManagertsx)
- [src/components/admin/PromoCodeDialog.tsx](#srccomponentsadminPromoCodeDialogtsx)
- [src/components/admin/PromoCodeTable.tsx](#srccomponentsadminPromoCodeTabletsx)
- [src/components/admin/RentalStatusBadge.tsx](#srccomponentsadminRentalStatusBadgetsx)
- [src/components/admin/ReservationFinancialSummary.tsx](#srccomponentsadminReservationFinancialSummarytsx)
- [src/components/admin/ReturnAccessoriesChecklist.tsx](#srccomponentsadminReturnAccessoriesChecklisttsx)
- [src/components/admin/ReturnFinancials.tsx](#srccomponentsadminReturnFinancialstsx)
- [src/components/admin/ReturnRentalDialog.tsx](#srccomponentsadminReturnRentalDialogtsx)
- [src/components/admin/UserCreateDialog.tsx](#srccomponentsadminUserCreateDialogtsx)
- [src/components/admin/UserEditDialog.tsx](#srccomponentsadminUserEditDialogtsx)
- [src/components/admin/UserPaymentDialog.tsx](#srccomponentsadminUserPaymentDialogtsx)
- [src/components/admin/UserTable.tsx](#srccomponentsadminUserTabletsx)
- [src/components/admin/UserTableRow.tsx](#srccomponentsadminUserTableRowtsx)
- [src/components/admin/UserTableToolbar.tsx](#srccomponentsadminUserTableToolbartsx)
- [src/components/admin/dashboard/ActivityFeedWidget.tsx](#srccomponentsadmindashboardActivityFeedWidgettsx)
- [src/components/admin/dashboard/KpiCardsWidget.tsx](#srccomponentsadmindashboardKpiCardsWidgettsx)
- [src/components/admin/dashboard/PopularEquipmentChart.tsx](#srccomponentsadmindashboardPopularEquipmentCharttsx)
- [src/components/admin/dashboard/TodayFocusWidget.tsx](#srccomponentsadmindashboardTodayFocusWidgettsx)
- [src/components/calendar/CalendarDateInputRange.tsx](#srccomponentscalendarCalendarDateInputRangetsx)
- [src/components/calendar/CalendarFiltersBlock.tsx](#srccomponentscalendarCalendarFiltersBlocktsx)
- [src/components/calendar/CalendarTable.tsx](#srccomponentscalendarCalendarTabletsx)
- [src/components/catalog/EquipmentCatalog.tsx](#srccomponentscatalogEquipmentCatalogtsx)
- [src/components/equipment-card/AccessoriesSection.tsx](#srccomponentsequipment-cardAccessoriesSectiontsx)
- [src/components/equipment-card/CardFooter.tsx](#srccomponentsequipment-cardCardFootertsx)
- [src/components/equipment-card/CardImage.tsx](#srccomponentsequipment-cardCardImagetsx)
- [src/components/equipment-card/DiscountInfo.tsx](#srccomponentsequipment-cardDiscountInfotsx)
- [src/components/equipment-card/EquipmentCard.tsx](#srccomponentsequipment-cardEquipmentCardtsx)
- [src/components/equipment-card/constants.ts](#srccomponentsequipment-cardconstantsts)
- [src/components/equipment-card/index.ts](#srccomponentsequipment-cardindexts)
- [src/components/equipment/EquipmentDetailsDialog.tsx](#srccomponentsequipmentEquipmentDetailsDialogtsx)
- [src/components/equipment/EquipmentDetailsView.tsx](#srccomponentsequipmentEquipmentDetailsViewtsx)
- [src/components/equipment/EquipmentEditForm.tsx](#srccomponentsequipmentEquipmentEditFormtsx)
- [src/components/profile/BalanceHistoryTable.tsx](#srccomponentsprofileBalanceHistoryTabletsx)
- [src/components/rental/MyRentalCard.tsx](#srccomponentsrentalMyRentalCardtsx)
- [src/components/rental/MyRentalsList.tsx](#srccomponentsrentalMyRentalsListtsx)
- [src/components/rental/RentalStatusBadge.tsx](#srccomponentsrentalRentalStatusBadgetsx)
- [src/components/reservation/AvailableAccessoriesDropdown.tsx](#srccomponentsreservationAvailableAccessoriesDropdowntsx)
- [src/components/reservation/EditableDateRange.tsx](#srccomponentsreservationEditableDateRangetsx)
- [src/components/reservation/EditableEquipmentItem.tsx](#srccomponentsreservationEditableEquipmentItemtsx)
- [src/components/reservation/EditableReservationCard.tsx](#srccomponentsreservationEditableReservationCardtsx)
- [src/components/reservation/EquipmentItemWithConflicts.tsx](#srccomponentsreservationEquipmentItemWithConflictstsx)
- [src/components/reservation/HolidayConfirmationDialog.tsx](#srccomponentsreservationHolidayConfirmationDialogtsx)
- [src/components/reservation/ReservationItemsList.tsx](#srccomponentsreservationReservationItemsListtsx)
- [src/components/reservation/ReservationStatusBadge.tsx](#srccomponentsreservationReservationStatusBadgetsx)
- [src/components/reservation/ViewReservationCard.tsx](#srccomponentsreservationViewReservationCardtsx)
- [src/components/session/UserSession.tsx](#srccomponentssessionUserSessiontsx)
- [src/components/shared/EquipmentWithAccessoriesList.tsx](#srccomponentssharedEquipmentWithAccessoriesListtsx)
- [src/components/shared/FinancialInfoBlock.tsx](#srccomponentssharedFinancialInfoBlocktsx)
- [src/components/shared/FinancialSummaryBlock.tsx](#srccomponentssharedFinancialSummaryBlocktsx)
- [src/components/shared/OrderToolbar.tsx](#srccomponentssharedOrderToolbartsx)
- [src/constants/equipmentConstants.ts](#srcconstantsequipmentConstantsts)
- [src/constants/paginationConstants.ts](#srcconstantspaginationConstantsts)
- [src/constants/statusStyles.ts](#srcconstantsstatusStylests)
- [src/constants/userConstants.ts](#srcconstantsuserConstantsts)
- [src/contexts/ReservationEditContext.tsx](#srccontextsReservationEditContexttsx)
- [src/core/services/AccessoryService.ts](#srccoreservicesAccessoryServicets)
- [src/core/services/AvailabilityService.ts](#srccoreservicesAvailabilityServicets)
- [src/core/services/CalendarService.ts](#srccoreservicesCalendarServicets)
- [src/core/services/DateService.ts](#srccoreservicesDateServicets)
- [src/core/services/EquipmentService.ts](#srccoreservicesEquipmentServicets)
- [src/core/services/PhoneService.ts](#srccoreservicesPhoneServicets)
- [src/core/services/PromoCodeService.ts](#srccoreservicesPromoCodeServicets)
- [src/core/services/ReservationService.ts](#srccoreservicesReservationServicets)
- [src/core/services/UserService.ts](#srccoreservicesUserServicets)
- [src/core/services/index.ts](#srccoreservicesindexts)
- [src/hooks/admin/create-reservation/useCreateReservationData.ts](#srchooksadmincreate-reservationuseCreateReservationDatats)
- [src/hooks/admin/create-reservation/useCreateReservationDialog.ts](#srchooksadmincreate-reservationuseCreateReservationDialogts)
- [src/hooks/admin/create-reservation/useCreateReservationForm.ts](#srchooksadmincreate-reservationuseCreateReservationFormts)
- [src/hooks/admin/useAdminRentalEdit.ts](#srchooksadminuseAdminRentalEditts)
- [src/hooks/admin/useAdminReservationCalculator.ts](#srchooksadminuseAdminReservationCalculatorts)
- [src/hooks/admin/useDashboardData.ts](#srchooksadminuseDashboardDatats)
- [src/hooks/admin/useEquipmentTableLogic.ts](#srchooksadminuseEquipmentTableLogicts)
- [src/hooks/admin/useRentalReturnForm.ts](#srchooksadminuseRentalReturnFormts)
- [src/hooks/admin/useUserTableLogic.ts](#srchooksadminuseUserTableLogicts)
- [src/hooks/data/useEquipmentData.ts](#srchooksdatauseEquipmentDatats)
- [src/hooks/features/useAppFilters.ts](#srchooksfeaturesuseAppFiltersts)
- [src/hooks/features/useEquipmentCardViewModel.ts](#srchooksfeaturesuseEquipmentCardViewModelts)
- [src/hooks/reservation/submission/useReservationFormData.ts](#srchooksreservationsubmissionuseReservationFormDatats)
- [src/hooks/reservation/submission/useReserveSubmission.ts](#srchooksreservationsubmissionuseReserveSubmissionts)
- [src/hooks/reservation/usePriceCalculator.ts](#srchooksreservationusePriceCalculatorts)
- [src/hooks/reservation/useReservationActions.ts](#srchooksreservationuseReservationActionsts)
- [src/hooks/reservation/useReservationData.ts](#srchooksreservationuseReservationDatats)
- [src/hooks/reservation/useReservationEditState.ts](#srchooksreservationuseReservationEditStatets)
- [src/hooks/reservation/useReservationState.ts](#srchooksreservationuseReservationStatets)
- [src/hooks/useAdminAccessories.ts](#srchooksuseAdminAccessoriests)
- [src/hooks/useAdminAssociations.ts](#srchooksuseAdminAssociationsts)
- [src/hooks/useAdminDiscounts.ts](#srchooksuseAdminDiscountsts)
- [src/hooks/useAdminEquipment.ts](#srchooksuseAdminEquipmentts)
- [src/hooks/useAdminHolidayRules.ts](#srchooksuseAdminHolidayRulests)
- [src/hooks/useAdminHolidays.ts](#srchooksuseAdminHolidaysts)
- [src/hooks/useAdminPromoCodes.ts](#srchooksuseAdminPromoCodests)
- [src/hooks/useAdminRentals.ts](#srchooksuseAdminRentalsts)
- [src/hooks/useAdminReservations.ts](#srchooksuseAdminReservationsts)
- [src/hooks/useAdminUsers.ts](#srchooksuseAdminUsersts)
- [src/hooks/useAllEquipment.ts](#srchooksuseAllEquipmentts)
- [src/hooks/useAssociations.ts](#srchooksuseAssociationsts)
- [src/hooks/useAvailabilityCheck.ts](#srchooksuseAvailabilityCheckts)
- [src/hooks/useBalanceHistory.ts](#srchooksuseBalanceHistoryts)
- [src/hooks/useCalendarGrid.ts](#srchooksuseCalendarGridts)
- [src/hooks/useDailyAvailability.ts](#srchooksuseDailyAvailabilityts)
- [src/hooks/useDateRange.ts](#srchooksuseDateRangets)
- [src/hooks/useEditReservation.ts](#srchooksuseEditReservationts)
- [src/hooks/useEquipment.ts](#srchooksuseEquipmentts)
- [src/hooks/useEquipmentAvailability.ts](#srchooksuseEquipmentAvailabilityts)
- [src/hooks/useEquipmentMap.ts](#srchooksuseEquipmentMapts)
- [src/hooks/useErrorHandler.ts](#srchooksuseErrorHandlerts)
- [src/hooks/useInlineReservationEdit.tsx](#srchooksuseInlineReservationEdittsx)
- [src/hooks/useMyRentals.ts](#srchooksuseMyRentalsts)
- [src/hooks/useNetworkStatus.ts](#srchooksuseNetworkStatusts)
- [src/hooks/usePhoneValidation.ts](#srchooksusePhoneValidationts)
- [src/hooks/useProfile.ts](#srchooksuseProfilets)
- [src/hooks/useReservationManagement.ts](#srchooksuseReservationManagementts)
- [src/hooks/useReservations.ts](#srchooksuseReservationsts)
- [src/hooks/useUpdateEquipmentDetails.ts](#srchooksuseUpdateEquipmentDetailsts)
- [src/hooks/useVisibleItems.ts](#srchooksuseVisibleItemsts)
- [src/index.css](#srcindexcss)
- [src/lib/api.ts](#srclibapits)
- [src/lib/queryClient.ts](#srclibqueryClientts)
- [src/lib/queryHelpers.ts](#srclibqueryHelpersts)
- [src/lib/sortingUtils.ts](#srclibsortingUtilsts)
- [src/lib/utils.ts](#srclibutilsts)
- [src/lib/validationSchemas.ts](#srclibvalidationSchemasts)
- [src/main.tsx](#srcmaintsx)
- [src/pages/AccessoryManagementPage.tsx](#srcpagesAccessoryManagementPagetsx)
- [src/pages/CalendarPage.tsx](#srcpagesCalendarPagetsx)
- [src/pages/CalendarTestPage.tsx](#srcpagesCalendarTestPagetsx)
- [src/pages/ContactPage.tsx](#srcpagesContactPagetsx)
- [src/pages/EquipmentManagementPage.tsx](#srcpagesEquipmentManagementPagetsx)
- [src/pages/HomePage.tsx](#srcpagesHomePagetsx)
- [src/pages/MyReservationsPage.tsx](#srcpagesMyReservationsPagetsx)
- [src/pages/ProfilePage.tsx](#srcpagesProfilePagetsx)
- [src/pages/ReservePage.tsx](#srcpagesReservePagetsx)
- [src/pages/UserManagementPage.tsx](#srcpagesUserManagementPagetsx)
- [src/pages/admin/AllReservationsManagementPage.tsx](#srcpagesadminAllReservationsManagementPagetsx)
- [src/pages/admin/AssociationManagementPage.tsx](#srcpagesadminAssociationManagementPagetsx)
- [src/pages/admin/DashboardPage.tsx](#srcpagesadminDashboardPagetsx)
- [src/pages/admin/HolidayManagementPage.tsx](#srcpagesadminHolidayManagementPagetsx)
- [src/pages/admin/PromoCodeManagementPage.tsx](#srcpagesadminPromoCodeManagementPagetsx)
- [src/pages/admin/RentalManagementPage.tsx](#srcpagesadminRentalManagementPagetsx)
- [src/store/adminReservationSelectionStore.ts](#srcstoreadminReservationSelectionStorets)
- [src/store/authStore.ts](#srcstoreauthStorets)
- [src/store/calendarSelectionStore.ts](#srcstorecalendarSelectionStorets)
- [src/store/dateStore.ts](#srcstoredateStorets)
- [src/store/filterStore.ts](#srcstorefilterStorets)
- [src/store/holidayStore.ts](#srcstoreholidayStorets)
- [src/store/orderFilterStore.ts](#srcstoreorderFilterStorets)
- [src/store/promoCodeStore.ts](#srcstorepromoCodeStorets)
- [src/store/reserveStore.ts](#srcstorereserveStorets)
- [src/store/sandboxCalculatorStore.ts](#srcstoresandboxCalculatorStorets)
- [src/store/searchStore.ts](#srcstoresearchStorets)
- [src/store/viewModeStore.ts](#srcstoreviewModeStorets)
- [src/types/accessory.ts](#srctypesaccessoryts)
- [src/types/association.ts](#srctypesassociationts)
- [src/types/availability.ts](#srctypesavailabilityts)
- [src/types/balanceHistory.ts](#srctypesbalanceHistoryts)
- [src/types/discount.ts](#srctypesdiscountts)
- [src/types/equipment.ts](#srctypesequipmentts)
- [src/types/holiday.ts](#srctypesholidayts)
- [src/types/promo_code.ts](#srctypespromo_codets)
- [src/types/rental.ts](#srctypesrentalts)
- [src/types/reservation.ts](#srctypesreservationts)
- [src/types/user.ts](#srctypesuserts)
- [src/utils/phoneUtils.ts](#srcutilsphoneUtilsts)
- [src/vite-env.d.ts](#srcvite-envdts)
- [tailwind.config.js](#tailwindconfigjs)
- [tsconfig.app.json](#tsconfigappjson)
- [tsconfig.json](#tsconfigjson)
- [tsconfig.node.json](#tsconfignodejson)
- [vite.config.ts](#viteconfigts)

---

# ğŸ“ Ğ¡Ñ‚Ñ€ÑƒĞºÑ‚ÑƒÑ€Ğ° Ğ¿Ñ€Ğ¾ĞµĞºÑ‚Ğ° (Ğ¸ĞµÑ€Ğ°Ñ€Ñ…Ğ¸Ñ)
`rental-app-main/`
    â”œâ”€â”€ `public/`
    â”‚   â”œâ”€â”€ ğŸ–¼ï¸ `favicon.svg`
    â”‚   â””â”€â”€ ğŸ–¼ï¸ `vite.svg`
    â”œâ”€â”€ `src/`
    â”‚   â”œâ”€â”€ `app/`
    â”‚   â”œâ”€â”€ `assets/`
    â”‚   â”œâ”€â”€ `components/`
    â”‚   â”‚   â”œâ”€â”€ `DateRangeSelector/`
    â”‚   â”‚   â”œâ”€â”€ `admin/`
    â”‚   â”‚   â”‚   â””â”€â”€ `dashboard/`
    â”‚   â”‚   â”œâ”€â”€ `calendar/`
    â”‚   â”‚   â”œâ”€â”€ `catalog/`
    â”‚   â”‚   â”œâ”€â”€ `equipment/`
    â”‚   â”‚   â”œâ”€â”€ `equipment-card/`
    â”‚   â”‚   â”œâ”€â”€ `profile/`
    â”‚   â”‚   â”œâ”€â”€ `rental/`
    â”‚   â”‚   â”œâ”€â”€ `reservation/`
    â”‚   â”‚   â”œâ”€â”€ `session/`
    â”‚   â”‚   â””â”€â”€ `shared/`
    â”‚   â”œâ”€â”€ `constants/`
    â”‚   â”œâ”€â”€ `contexts/`
    â”‚   â”œâ”€â”€ `hooks/`
    â”‚   â”‚   â”œâ”€â”€ `admin/`
    â”‚   â”‚   â”‚   â””â”€â”€ `create-reservation/`
    â”‚   â”‚   â”œâ”€â”€ `data/`
    â”‚   â”‚   â”œâ”€â”€ `features/`
    â”‚   â”‚   â””â”€â”€ `reservation/`
    â”‚   â”‚       â””â”€â”€ `submission/`
    â”‚   â”œâ”€â”€ `lib/`
    â”‚   â”œâ”€â”€ `pages/`
    â”‚   â”‚   â””â”€â”€ `admin/`
    â”‚   â”œâ”€â”€ `store/`
    â”‚   â”œâ”€â”€ `types/`
    â”‚   â”œâ”€â”€ `utils/`
    â”‚   â”œâ”€â”€ ğŸ“„ `index.css`
    â”‚   â”œâ”€â”€ ğŸ“„ `main.tsx`
    â”‚   â””â”€â”€ ğŸ“„ `vite-env.d.ts`
    â”œâ”€â”€ ğŸ“„ `package.json`
    â”œâ”€â”€ ğŸ“„ `postcss.config.js`
    â”œâ”€â”€ ğŸ“„ `tailwind.config.js`
    â”œâ”€â”€ ğŸ“„ `tsconfig.app.json`
    â”œâ”€â”€ ğŸ“„ `tsconfig.json`
    â”œâ”€â”€ ğŸ“„ `tsconfig.node.json`
    â””â”€â”€ ğŸ“„ `vite.config.ts`

---


## <a name="packagejson"></a>`package.json`

```json
// path: package.json

{
  "name": "rental-app-main",
  "private": true,
  "version": "0.0.0",
  "type": "module",
  "scripts": {
    "dev": "vite",
    "build": "vite build",
    "lint": "eslint .",
    "preview": "vite preview"
  },
  "dependencies": {
    "@fullcalendar/core": "^6.1.17",
    "@fullcalendar/daygrid": "^6.1.17",
    "@fullcalendar/interaction": "^6.1.17",
    "@fullcalendar/react": "^6.1.17",
    "@fullcalendar/resource-timeline": "^6.1.17",
    "@hookform/resolvers": "^5.0.1",
    "@radix-ui/react-checkbox": "^1.3.1",
    "@radix-ui/react-dialog": "^1.1.14",
    "@radix-ui/react-label": "^2.1.6",
    "@radix-ui/react-popover": "^1.1.14",
    "@radix-ui/react-scroll-area": "^1.2.9",
    "@radix-ui/react-select": "^2.2.4",
    "@radix-ui/react-slot": "^1.2.2",
    "@radix-ui/react-switch": "^1.2.5",
    "@radix-ui/react-toggle": "^1.1.8",
    "@radix-ui/react-toggle-group": "^1.1.9",
    "@tanstack/react-query": "^5.76.1",
    "@tanstack/react-query-devtools": "^5.76.1",
    "@types/react-input-mask": "^3.0.6",
    "@uiw/react-md-editor": "^4.0.7",
    "axios": "^1.9.0",
    "class-variance-authority": "^0.7.1",
    "clsx": "^2.1.1",
    "cmdk": "^1.1.1",
    "date-fns": "^4.1.0",
    "lucide-react": "^0.511.0",
    "react": "^19.1.0",
    "react-day-picker": "^9.7.0",
    "react-dom": "^19.1.0",
    "react-error-boundary": "^6.0.0",
    "react-hook-form": "^7.56.4",
    "react-imask": "^7.6.1",
    "react-markdown": "^10.1.0",
    "react-router-dom": "^7.6.0",
    "rehype-sanitize": "^6.0.0",
    "sonner": "^2.0.3",
    "tailwind-merge": "^3.3.0",
    "tailwindcss-animate": "^1.0.7",
    "zod": "^3.25.28",
    "zustand": "^5.0.4"
  },
  "devDependencies": {
    "@eslint/js": "^9.25.0",
    "@tailwindcss/typography": "^0.5.16",
    "@types/mocha": "^10.0.10",
    "@types/node": "^24.0.10",
    "@types/react": "^19.1.2",
    "@types/react-dom": "^19.1.2",
    "@vitejs/plugin-react": "^4.4.1",
    "autoprefixer": "^10.4.15",
    "eslint": "^9.25.0",
    "eslint-plugin-react-hooks": "^5.2.0",
    "eslint-plugin-react-refresh": "^0.4.19",
    "globals": "^16.0.0",
    "postcss": "^8.4.38",
    "tailwindcss": "^3.4.1",
    "typescript": "~5.8.3",
    "typescript-eslint": "^8.30.1",
    "vite": "^6.3.5"
  }
}


```


## <a name="postcssconfigjs"></a>`postcss.config.js`

```javascript
// path: postcss.config.js

// postcss.config.js

export default {
    plugins: {
        tailwindcss: {},
        autoprefixer: {},
    },
}

```


## <a name="publicfaviconsvg"></a>`public/favicon.svg`

```
[Ğ¡Ğ¾Ğ´ĞµÑ€Ğ¶Ğ¸Ğ¼Ğ¾Ğµ SVG Ñ„Ğ°Ğ¹Ğ»Ğ° 'favicon.svg' Ğ½Ğµ Ğ²ĞºĞ»ÑÑ‡ĞµĞ½Ğ¾ Ğ´Ğ»Ñ ÑĞºĞ¾Ğ½Ğ¾Ğ¼Ğ¸Ğ¸ Ğ¼ĞµÑÑ‚Ğ°]
```


## <a name="publicvitesvg"></a>`public/vite.svg`

```
[Ğ¡Ğ¾Ğ´ĞµÑ€Ğ¶Ğ¸Ğ¼Ğ¾Ğµ SVG Ñ„Ğ°Ğ¹Ğ»Ğ° 'vite.svg' Ğ½Ğµ Ğ²ĞºĞ»ÑÑ‡ĞµĞ½Ğ¾ Ğ´Ğ»Ñ ÑĞºĞ¾Ğ½Ğ¾Ğ¼Ğ¸Ğ¸ Ğ¼ĞµÑÑ‚Ğ°]
```


## <a name="srcappApptsx"></a>`src/app/App.tsx`

```tsx
// path: src/app/App.tsx

// src/app/App.tsx

import { Routes, Route } from "react-router-dom";
import HomePage from "../pages/HomePage";
import ReservePage from "../pages/ReservePage";
import ProfilePage from "../pages/ProfilePage";
import MyReservationsPage from "../pages/MyReservationsPage";
import ContactPage from "../pages/ContactPage";
import CalendarPage from "../pages/CalendarPage";
import RequireAuth from "../components/RequireAuth";
import { Toaster } from "sonner"; // <--- 1. Ğ”ĞĞ‘ĞĞ’Ğ¬Ğ¢Ğ• Ğ­Ğ¢ĞĞ¢ Ğ˜ĞœĞŸĞĞ Ğ¢

// Ğ˜Ğ¼Ğ¿Ğ¾Ñ€Ñ‚Ñ‹ Ğ´Ğ»Ñ Ğ°Ğ´Ğ¼Ğ¸Ğ½ Ğ¿Ğ°Ğ½ĞµĞ»Ğ¸
import DashboardPage from "../pages/admin/DashboardPage";
import UserManagementPage from "../pages/UserManagementPage";
import EquipmentManagementPage from "../pages/EquipmentManagementPage";
import AccessoryManagementPage from "../pages/AccessoryManagementPage";
import AllReservationsManagementPage from "../pages/admin/AllReservationsManagementPage";
import PromoCodeManagementPage from "../pages/admin/PromoCodeManagementPage";
import CalendarTestPage from "../pages/CalendarTestPage";
import HolidayManagementPage from "../pages/admin/HolidayManagementPage";
import AssociationManagementPage from "../pages/admin/AssociationManagementPage";
import RentalManagementPage from "../pages/admin/RentalManagementPage";


function App() {
    return (
        // +++ 2. ĞĞ‘Ğ•Ğ ĞĞ˜Ğ¢Ğ• Ğ’Ğ¡Ğ• Ğ’ Ğ¤Ğ ĞĞ“ĞœĞ•ĞĞ¢ Ğ˜ Ğ”ĞĞ‘ĞĞ’Ğ¬Ğ¢Ğ• TOASTER +++
        <>
            <Routes>
                {/* ĞÑĞ½Ğ¾Ğ²Ğ½Ñ‹Ğµ Ğ¼Ğ°Ñ€ÑˆÑ€ÑƒÑ‚Ñ‹ */}
                <Route path="/test-calendar" element={<CalendarTestPage />} />
                <Route path="/" element={<HomePage />} />
                <Route path="/reserve/create" element={<ReservePage />} />
                <Route path="/contacts" element={<ContactPage />} />
                <Route path="/calendar" element={<CalendarPage />} />

                {/* ĞœĞ°Ñ€ÑˆÑ€ÑƒÑ‚Ñ‹, Ñ‚Ñ€ĞµĞ±ÑƒÑÑ‰Ğ¸Ğµ Ğ°Ğ²Ñ‚Ğ¾Ñ€Ğ¸Ğ·Ğ°Ñ†Ğ¸Ğ¸ */}
                <Route
                    path="/profile"
                    element={
                        <RequireAuth>
                            <ProfilePage />
                        </RequireAuth>
                    }
                />
                <Route
                    path="/reservations/my"
                    element={
                        <RequireAuth>
                            <MyReservationsPage />
                        </RequireAuth>
                    }
                />

                {/* ĞœĞ°Ñ€ÑˆÑ€ÑƒÑ‚Ñ‹ Ğ°Ğ´Ğ¼Ğ¸Ğ½-Ğ¿Ğ°Ğ½ĞµĞ»Ğ¸ */}
                <Route
                    path="/admin"
                    element={
                        <RequireAuth role={["manager", "admin"]}>
                            <DashboardPage />
                        </RequireAuth>
                    }
                />
                <Route
                    path="/admin/rentals"
                    element={
                        <RequireAuth role={["manager", "admin"]}>
                            <RentalManagementPage />
                        </RequireAuth>
                    }
                />
                <Route
                    path="/admin/users"
                    element={
                        <RequireAuth role={["manager", "admin"]}>
                            <UserManagementPage />
                        </RequireAuth>
                    }
                />
                <Route
                    path="/admin/equipment"
                    element={
                        <RequireAuth role={["manager", "admin"]}>
                            <EquipmentManagementPage />
                        </RequireAuth>
                    }
                />
                <Route
                    path="/admin/accessories"
                    element={
                        <RequireAuth role={["manager", "admin"]}>
                            <AccessoryManagementPage />
                        </RequireAuth>
                    }
                />
                <Route
                    path="/admin/reservations"
                    element={
                        <RequireAuth role={["manager", "admin"]}>
                            <AllReservationsManagementPage />
                        </RequireAuth>
                    }
                />
                <Route
                    path="/admin/promocodes"
                    element={
                        <RequireAuth role={["manager", "admin"]}>
                            <PromoCodeManagementPage />
                        </RequireAuth>
                    }
                />
                <Route
                    path="/admin/holidays"
                    element={
                        <RequireAuth role={["admin"]}>
                            <HolidayManagementPage />
                        </RequireAuth>
                    }
                />
                <Route
                    path="/admin/associations"
                    element={
                        <RequireAuth role={["manager", "admin"]}>
                            <AssociationManagementPage />
                        </RequireAuth>
                    }
                />

            </Routes>
            <Toaster richColors position="top-right" />
        </>
    );
}

export default App;

```


## <a name="srcassetsreactsvg"></a>`src/assets/react.svg`

```
[Ğ¡Ğ¾Ğ´ĞµÑ€Ğ¶Ğ¸Ğ¼Ğ¾Ğµ SVG Ñ„Ğ°Ğ¹Ğ»Ğ° 'react.svg' Ğ½Ğµ Ğ²ĞºĞ»ÑÑ‡ĞµĞ½Ğ¾ Ğ´Ğ»Ñ ÑĞºĞ¾Ğ½Ğ¾Ğ¼Ğ¸Ğ¸ Ğ¼ĞµÑÑ‚Ğ°]
```


## <a name="srccomponentsAssociationFiltertsx"></a>`src/components/AssociationFilter.tsx`

```tsx
// path: src/components/AssociationFilter.tsx

// src/components/AssociationFilter.tsx

import { useMemo } from "react"; // <--- Ğ”ĞĞ‘ĞĞ’Ğ˜Ğ¢Ğ¬ Ğ˜ĞœĞŸĞĞ Ğ¢
import { ToggleGroup, ToggleGroupItem } from "@/components/ui/toggle-group";
import { useFilterStore } from "@/store/filterStore";
import { useAssociations } from "@/hooks/useAssociations";
import { getFilterToggleClass } from "@/components/ui/filter-toggle";
import { Tags, List } from "lucide-react";

export default function AssociationFilter() {
    const { associationId, setAssociationId } = useFilterStore();
    const { data: allAssociations = [], isLoading } = useAssociations();

    // +++ ĞĞĞ§ĞĞ›Ğ Ğ˜Ğ—ĞœĞ•ĞĞ•ĞĞ˜Ğ™ +++
    // Ğ¤Ğ¸Ğ»ÑŒÑ‚Ñ€ÑƒĞµĞ¼ Ğ°ÑÑĞ¾Ñ†Ğ¸Ğ°Ñ†Ğ¸Ğ¸, Ğ¾ÑÑ‚Ğ°Ğ²Ğ»ÑÑ Ñ‚Ğ¾Ğ»ÑŒĞºĞ¾ Ñ‚Ğµ, Ğº ĞºĞ¾Ñ‚Ğ¾Ñ€Ñ‹Ğ¼ Ğ¿Ñ€Ğ¸Ğ²ÑĞ·Ğ°Ğ½Ğ¾ Ğ¾Ğ±Ğ¾Ñ€ÑƒĞ´Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ
    const associationsWithEquipment = useMemo(() => {
        return allAssociations.filter(assoc => assoc.equipment_ids && assoc.equipment_ids.length > 0);
    }, [allAssociations]);

    // Ğ¢ĞµĞ¿ĞµÑ€ÑŒ Ğ¿Ñ€Ğ¾Ğ²ĞµÑ€ÑĞµĞ¼ Ğ¾Ñ‚Ñ„Ğ¸Ğ»ÑŒÑ‚Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ½Ñ‹Ğ¹ ÑĞ¿Ğ¸ÑĞ¾Ğº
    if (isLoading || associationsWithEquipment.length === 0) {
        return null; // ĞĞµ Ñ€ĞµĞ½Ğ´ĞµÑ€Ğ¸Ğ¼ Ğ½Ğ¸Ñ‡ĞµĞ³Ğ¾, ĞµÑĞ»Ğ¸ Ğ´Ğ°Ğ½Ğ½Ñ‹Ñ… Ğ½ĞµÑ‚ Ğ¸Ğ»Ğ¸ Ğ²ÑĞµ Ğ°ÑÑĞ¾Ñ†Ğ¸Ğ°Ñ†Ğ¸Ğ¸ "Ğ¿ÑƒÑÑ‚Ñ‹Ğµ"
    }
    // +++ ĞšĞĞĞ•Ğ¦ Ğ˜Ğ—ĞœĞ•ĞĞ•ĞĞ˜Ğ™ +++

    return (
        <ToggleGroup
            type="single"
            value={associationId?.toString() ?? "__all__"}
            onValueChange={(val: string) => setAssociationId(val === "__all__" ? null : Number(val))}
            className="flex flex-wrap gap-2"
        >
            <ToggleGroupItem value="__all__" className={getFilterToggleClass("green")}>
                <List />
                Ğ’ÑĞµ Ğ¿Ğ¾Ğ´Ğ±Ğ¾Ñ€ĞºĞ¸
            </ToggleGroupItem>

            {/* Ğ˜ÑĞ¿Ğ¾Ğ»ÑŒĞ·ÑƒĞµĞ¼ Ğ¾Ñ‚Ñ„Ğ¸Ğ»ÑŒÑ‚Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ½Ñ‹Ğ¹ ÑĞ¿Ğ¸ÑĞ¾Ğº Ğ´Ğ»Ñ Ñ€ĞµĞ½Ğ´ĞµÑ€Ğ¸Ğ½Ğ³Ğ° */}
            {associationsWithEquipment.map((assoc) => (
                <ToggleGroupItem
                    key={assoc.id}
                    value={assoc.id.toString()}
                    className={getFilterToggleClass("green")}
                >
                    <Tags className="h-4 w-4" />
                    {assoc.name}
                </ToggleGroupItem>
            ))}
        </ToggleGroup>
    );
}


```


## <a name="srccomponentsAuthFormtsx"></a>`src/components/AuthForm.tsx`

```tsx
// path: src/components/AuthForm.tsx

// src/components/AuthForm.tsx

import { useState } from "react";
import { useForm, Controller } from "react-hook-form";
import { zodResolver } from "@hookform/resolvers/zod";
import { authSchema, AuthSchema } from "@/lib/validationSchemas";
import { useAuthStore } from "@/store/authStore";
import { Input } from "@/components/ui/input";
import { Button } from "@/components/ui/button";
import { Checkbox } from "@/components/ui/checkbox";
import { Label } from "@/components/ui/label";
import { PhoneInput } from "@/components/ui/phone-input";
import { Eye, EyeOff, Mail, Lock, User, LogIn, UserPlus, Phone, Calendar } from "lucide-react"; // <<< Ğ˜Ğ—ĞœĞ•ĞĞ•ĞĞ˜Ğ•: Ğ”Ğ¾Ğ±Ğ°Ğ²Ğ»ĞµĞ½Ğ° Ğ¸ĞºĞ¾Ğ½ĞºĞ° Calendar
import { useNavigate } from "react-router-dom"; // <<< Ğ˜Ğ—ĞœĞ•ĞĞ•ĞĞ˜Ğ•: Ğ”Ğ¾Ğ±Ğ°Ğ²Ğ»ĞµĞ½ useNavigate

export default function AuthForm() {
    const { login, register: registerUser, error, loading } = useAuthStore();
    const [isRegister, setIsRegister] = useState(false);
    const [showPassword, setShowPassword] = useState(false);
    const [phoneError, setPhoneError] = useState("");
    const [emailError, setEmailError] = useState("");
    const navigate = useNavigate(); // <<< Ğ˜Ğ—ĞœĞ•ĞĞ•ĞĞ˜Ğ•: Ğ˜Ğ½Ğ¸Ñ†Ğ¸Ğ°Ğ»Ğ¸Ğ·Ğ¸Ñ€ÑƒĞµĞ¼ Ñ…ÑƒĞº

    const {
        register: formRegister,
        handleSubmit,
        control,
        formState: { errors, isValid },
        reset
    } = useForm<AuthSchema>({
        resolver: zodResolver(authSchema),
        mode: "onChange",
        defaultValues: {
            privacyPolicyAccepted: false,
            termsAccepted: false,
        }
    });

    const onSubmit = async (data: AuthSchema) => {
        try {
            if (isRegister) {
                if (!data.privacyPolicyAccepted || !data.termsAccepted) {
                    // Ğ­Ñ‚Ğ° Ğ¿Ñ€Ğ¾Ğ²ĞµÑ€ĞºĞ° Ğ¾ÑÑ‚Ğ°ĞµÑ‚ÑÑ Ğ½Ğ° ÑĞ»ÑƒÑ‡Ğ°Ğ¹, ĞµÑĞ»Ğ¸ Zod Ğ¿Ğ¾ ĞºĞ°ĞºĞ¾Ğ¹-Ñ‚Ğ¾ Ğ¿Ñ€Ğ¸Ñ‡Ğ¸Ğ½Ğµ Ğ±ÑƒĞ´ĞµÑ‚ Ğ¾Ğ±Ğ¾Ğ¹Ğ´ĞµĞ½
                    throw new Error("ĞĞµĞ¾Ğ±Ñ…Ğ¾Ğ´Ğ¸Ğ¼Ğ¾ Ğ¿Ñ€Ğ¸Ğ½ÑÑ‚ÑŒ ÑƒÑĞ»Ğ¾Ğ²Ğ¸Ñ Ğ¸ÑĞ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ Ğ¸ Ğ¿Ğ¾Ğ»Ğ¸Ñ‚Ğ¸ĞºÑƒ ĞºĞ¾Ğ½Ñ„Ğ¸Ğ´ĞµĞ½Ñ†Ğ¸Ğ°Ğ»ÑŒĞ½Ğ¾ÑÑ‚Ğ¸.");
                }
                await registerUser({
                    email: data.email,
                    password: data.password,
                    full_name: data.fullName ?? "",
                    phone: data.phone,
                    privacy_policy_accepted: data.privacyPolicyAccepted,
                    terms_accepted: data.termsAccepted,
                });
            } else {
                await login(data.email, data.password);
            }
            reset();
        } catch (err) {
            // ĞÑˆĞ¸Ğ±ĞºĞ¸ Ğ¾Ğ±Ñ€Ğ°Ğ±Ğ°Ñ‚Ñ‹Ğ²Ğ°ÑÑ‚ÑÑ Ğ² zustand
            console.error("Auth error:", err);
        }
    };

    const validatePhoneRealTime = (value: string) => {
        if (!value) { setPhoneError(""); return; }
        // ĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑĞµĞ¼, Ñ‡Ñ‚Ğ¾ Ğ½Ğ¾Ğ¼ĞµÑ€ ÑĞ¾Ğ¾Ñ‚Ğ²ĞµÑ‚ÑÑ‚Ğ²ÑƒĞµÑ‚ Ğ¼Ğ°ÑĞºĞµ +7 (XXX) XXX-XX-XX
        const phoneRegex = /^\+7 \(\d{3}\) \d{3}-\d{2}-\d{2}$/;
        setPhoneError(phoneRegex.test(value) ? "" : "Ğ’Ğ²ĞµĞ´Ğ¸Ñ‚Ğµ Ğ¿Ğ¾Ğ»Ğ½Ñ‹Ğ¹ Ğ½Ğ¾Ğ¼ĞµÑ€ Ñ‚ĞµĞ»ĞµÑ„Ğ¾Ğ½Ğ°");
    };

    const validateEmailRealTime = (value: string) => {
        if (!value) { setEmailError(""); return; }
        const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
        setEmailError(emailRegex.test(value) ? "" : "Ğ’Ğ²ĞµĞ´Ğ¸Ñ‚Ğµ ĞºĞ¾Ñ€Ñ€ĞµĞºÑ‚Ğ½Ñ‹Ğ¹ email");
    };

    const toggleMode = () => {
        setIsRegister(!isRegister);
        reset({
            email: '', password: '', fullName: '', phone: '',
            privacyPolicyAccepted: false, termsAccepted: false,
        });
        setPhoneError("");
        setEmailError("");
    };

    const registrationFields = (
        <>
            <div className="grid grid-cols-1 sm:grid-cols-2 gap-4">
                <div>
                    <Label htmlFor="fullName">Ğ¤Ğ˜Ğ *</Label>
                    <div className="relative">
                        <User className="absolute left-3 top-1/2 -translate-y-1/2 h-4 w-4 text-gray-400" />
                        <Input id="fullName" {...formRegister("fullName")} placeholder="Ğ˜Ğ²Ğ°Ğ½ Ğ˜Ğ²Ğ°Ğ½Ğ¾Ğ²" className="pl-9" />
                    </div>
                    {errors.fullName && <p className="text-xs text-red-600 mt-1">{errors.fullName.message}</p>}
                </div>
                <div>
                    <Label htmlFor="phone">Ğ¢ĞµĞ»ĞµÑ„Ğ¾Ğ½</Label>
                    <div className="relative">
                        <Phone className="absolute left-3 top-1/2 -translate-y-1/2 h-4 w-4 text-gray-400" />
                        <Controller
                            control={control}
                            name="phone"
                            render={({ field }) => (
                                <PhoneInput
                                    id="phone"
                                    {...field}
                                    placeholder="+7 (___) ___-__-__"
                                    className="pl-9"
                                    error={!!phoneError}
                                    onChange={(e) => {
                                        field.onChange(e);
                                        validatePhoneRealTime(e.target.value);
                                    }}
                                />
                            )}
                        />
                    </div>
                    {(errors.phone || phoneError) && <p className="text-xs text-red-600 mt-1">{phoneError || errors.phone?.message}</p>}
                </div>
            </div>

            <div className="grid grid-cols-1 sm:grid-cols-2 gap-4">
                <div>
                    <Label htmlFor="emailReg">Email *</Label>
                    <div className="relative">
                        <Mail className="absolute left-3 top-1/2 -translate-y-1/2 h-4 w-4 text-gray-400" />
                        <Input
                            id="emailReg" type="email" {...formRegister("email")}
                            placeholder="your@email.com" className="pl-9"
                            onChange={(e) => {
                                formRegister("email").onChange(e);
                                validateEmailRealTime(e.target.value);
                            }}
                        />
                    </div>
                    {(errors.email || emailError) && <p className="text-xs text-red-600 mt-1">{emailError || errors.email?.message}</p>}
                </div>
                <div>
                    <Label htmlFor="passwordReg">ĞŸĞ°Ñ€Ğ¾Ğ»ÑŒ *</Label>
                    <div className="relative">
                        <Lock className="absolute left-3 top-1/2 -translate-y-1/2 h-4 w-4 text-gray-400" />
                        <Input id="passwordReg" type={showPassword ? "text" : "password"} {...formRegister("password")} placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢" className="pl-9 pr-10" />
                        <Button type="button" variant="ghost" size="icon" className="absolute right-1 top-1/2 -translate-y-1/2 h-8 w-8" onClick={() => setShowPassword(p => !p)}>
                            {showPassword ? <EyeOff className="h-4 w-4" /> : <Eye className="h-4 w-4" />}
                        </Button>
                    </div>
                    {errors.password && <p className="text-xs text-red-600 mt-1">{errors.password.message}</p>}
                </div>
            </div>

            <div className="space-y-3 pt-2">
                <Controller
                    control={control}
                    name="privacyPolicyAccepted"
                    render={({ field }) => (
                        <div className="flex items-start space-x-2">
                            <Checkbox id="privacy" checked={field.value} onCheckedChange={field.onChange} />
                            <div className="grid gap-1.5 leading-none">
                                <Label htmlFor="privacy" className="text-sm font-normal cursor-pointer">
                                    Ğ¯ ÑĞ¾Ğ³Ğ»Ğ°ÑĞµĞ½ Ñ <a href="#" onClick={(e) => e.preventDefault()} className="text-sky-600 hover:underline">Ğ¿Ğ¾Ğ»Ğ¸Ñ‚Ğ¸ĞºĞ¾Ğ¹ Ğ¾Ğ±Ñ€Ğ°Ğ±Ğ¾Ñ‚ĞºĞ¸ Ğ¿ĞµÑ€ÑĞ¾Ğ½Ğ°Ğ»ÑŒĞ½Ñ‹Ñ… Ğ´Ğ°Ğ½Ğ½Ñ‹Ñ…</a> *
                                </Label>
                                {errors.privacyPolicyAccepted && <p className="text-xs text-red-600">{errors.privacyPolicyAccepted.message}</p>}
                            </div>
                        </div>
                    )}
                />
                <Controller
                    control={control}
                    name="termsAccepted"
                    render={({ field }) => (
                        <div className="flex items-start space-x-2">
                            <Checkbox id="terms" checked={field.value} onCheckedChange={field.onChange} />
                            <div className="grid gap-1.5 leading-none">
                                <Label htmlFor="terms" className="text-sm font-normal cursor-pointer">
                                    Ğ¯ Ğ¿Ñ€Ğ¸Ğ½Ğ¸Ğ¼Ğ°Ñ <a href="#" onClick={(e) => e.preventDefault()} className="text-sky-600 hover:underline">ÑƒÑĞ»Ğ¾Ğ²Ğ¸Ñ Ğ¸ÑĞ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ ÑĞµÑ€Ğ²Ğ¸ÑĞ°</a> *
                                </Label>
                                {errors.termsAccepted && <p className="text-xs text-red-600">{errors.termsAccepted.message}</p>}
                            </div>
                        </div>
                    )}
                />
            </div>
        </>
    );

    const loginFields = (
        <div className="grid grid-cols-1 sm:grid-cols-2 gap-4">
            <div>
                <Label htmlFor="emailLogin">Email</Label>
                <div className="relative">
                    <Mail className="absolute left-3 top-1/2 -translate-y-1/2 h-4 w-4 text-gray-400" />
                    <Input
                        id="emailLogin" type="email" {...formRegister("email")}
                        placeholder="your@email.com" className="pl-9"
                        onChange={(e) => {
                            formRegister("email").onChange(e);
                            validateEmailRealTime(e.target.value);
                        }}
                    />
                </div>
                {(errors.email || emailError) && <p className="text-xs text-red-600 mt-1">{emailError || errors.email?.message}</p>}
            </div>
            <div>
                <Label htmlFor="passwordLogin">ĞŸĞ°Ñ€Ğ¾Ğ»ÑŒ</Label>
                <div className="relative">
                    <Lock className="absolute left-3 top-1/2 -translate-y-1/2 h-4 w-4 text-gray-400" />
                    <Input id="passwordLogin" type={showPassword ? "text" : "password"} {...formRegister("password")} placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢" className="pl-9 pr-10" />
                    <Button type="button" variant="ghost" size="icon" className="absolute right-1 top-1/2 -translate-y-1/2 h-8 w-8" onClick={() => setShowPassword(p => !p)}>
                        {showPassword ? <EyeOff className="h-4 w-4" /> : <Eye className="h-4 w-4" />}
                    </Button>
                </div>
                {errors.password && <p className="text-xs text-red-600 mt-1">{errors.password.message}</p>}
            </div>
        </div>
    );

    return (
        <div className="w-full">
            <form onSubmit={handleSubmit(onSubmit)} className="bg-white border border-gray-200 rounded-lg shadow-sm p-6 space-y-6">
                <h2 className="text-xl font-semibold text-center">{isRegister ? "Ğ ĞµĞ³Ğ¸ÑÑ‚Ñ€Ğ°Ñ†Ğ¸Ñ" : "Ğ’Ñ…Ğ¾Ğ´ Ğ² Ğ°ĞºĞºĞ°ÑƒĞ½Ñ‚"}</h2>

                {isRegister ? registrationFields : loginFields}

                {error && (
                    <div className="p-3 bg-red-50 border border-red-200 rounded text-sm text-red-600">
                        {error}
                    </div>
                )}

                {/* +++ ĞĞĞ§ĞĞ›Ğ: Ğ˜Ğ·Ğ¼ĞµĞ½ĞµĞ½Ğ½Ñ‹Ğ¹ Ğ±Ğ»Ğ¾Ğº ĞºĞ½Ğ¾Ğ¿Ğ¾Ğº +++ */}
                <div className="pt-4 border-t space-y-4">
                    <Button type="submit" disabled={!isValid || loading} className="w-full">
                        {loading ? "Ğ—Ğ°Ğ³Ñ€ÑƒĞ·ĞºĞ°..." : (isRegister ? <><UserPlus className="mr-2 h-4 w-4" />Ğ—Ğ°Ñ€ĞµĞ³Ğ¸ÑÑ‚Ñ€Ğ¸Ñ€Ğ¾Ğ²Ğ°Ñ‚ÑŒÑÑ</> : <><LogIn className="mr-2 h-4 w-4" />Ğ’Ğ¾Ğ¹Ñ‚Ğ¸</>)}
                    </Button>
                    <div className="flex justify-center items-center gap-4 text-sm">
                        <Button
                            type="button"
                            variant="outline"
                            size="sm"
                            onClick={() => navigate("/calendar")}
                        >
                            <Calendar className="mr-2 h-4 w-4" />
                            ĞšĞ°Ğ»ĞµĞ½Ğ´Ğ°Ñ€ÑŒ
                        </Button>
                        <Button type="button" variant="link" onClick={toggleMode} className="text-gray-600">
                            {isRegister ? "Ğ£Ğ¶Ğµ ĞµÑÑ‚ÑŒ Ğ°ĞºĞºĞ°ÑƒĞ½Ñ‚? Ğ’Ğ¾Ğ¹Ñ‚Ğ¸" : "ĞĞµÑ‚ Ğ°ĞºĞºĞ°ÑƒĞ½Ñ‚Ğ°?"}
                        </Button>
                    </div>
                </div>
                {/* +++ ĞšĞĞĞ•Ğ¦: Ğ˜Ğ·Ğ¼ĞµĞ½ĞµĞ½Ğ½Ñ‹Ğ¹ Ğ±Ğ»Ğ¾Ğº ĞºĞ½Ğ¾Ğ¿Ğ¾Ğº +++ */}
            </form>
        </div>
    );
}

```


## <a name="srccomponentsAuthStatustsx"></a>`src/components/AuthStatus.tsx`

```tsx
// path: src/components/AuthStatus.tsx

import { useCurrentUser } from "@/hooks/useProfile";
import { useAuthStore } from "@/store/authStore";

export default function AuthStatus() {
    const { data: user, isLoading, isError } = useCurrentUser();
    const { logout } = useAuthStore();

    if (isLoading) {
        return (
            <div className="bg-gray-50 border border-gray-200 rounded-md p-2 mb-2">
                <div className="flex items-center justify-center">
                    <div className="animate-spin rounded-full h-3 w-3 border-b-2 border-gray-400 mr-2"></div>
                    <span className="text-xs text-gray-500">ĞŸÑ€Ğ¾Ğ²ĞµÑ€ĞºĞ° Ğ°Ğ²Ñ‚Ğ¾Ñ€Ğ¸Ğ·Ğ°Ñ†Ğ¸Ğ¸...</span>
                </div>
            </div>
        );
    }

    if (isError) {
        return (
            <div className="bg-gray-50 border border-gray-200 rounded-md p-2 mb-2">
                <div className="flex items-center justify-between">
                    <span className="text-xs text-gray-500">ĞÑˆĞ¸Ğ±ĞºĞ° Ğ·Ğ°Ğ³Ñ€ÑƒĞ·ĞºĞ¸ Ğ¿Ñ€Ğ¾Ñ„Ğ¸Ğ»Ñ</span>
                    <button
                        onClick={logout}
                        className="text-xs text-gray-400 hover:text-gray-600 underline"
                    >
                        Ğ’Ñ‹Ğ¹Ñ‚Ğ¸
                    </button>
                </div>
            </div>
        );
    }

    if (!user) {
        return (
            <div className="bg-gray-50 border border-gray-200 rounded-md p-2 mb-2">
                <div className="flex items-center justify-center">
                    <span className="text-xs text-gray-500">Ğ’Ğ¾Ğ¹Ğ´Ğ¸Ñ‚Ğµ Ğ² ÑĞ¸ÑÑ‚ĞµĞ¼Ñƒ Ğ´Ğ»Ñ Ğ´Ğ¾ÑÑ‚ÑƒĞ¿Ğ° Ğº Ğ¿Ğ¾Ğ»Ğ½Ğ¾Ğ¼Ñƒ Ñ„ÑƒĞ½ĞºÑ†Ğ¸Ğ¾Ğ½Ğ°Ğ»Ñƒ</span>
                </div>
            </div>
        );
    }

    return null; // ĞŸĞ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ÑŒ Ğ°Ğ²Ñ‚Ğ¾Ñ€Ğ¸Ğ·Ğ¾Ğ²Ğ°Ğ½, Ğ½Ğ¸Ñ‡ĞµĞ³Ğ¾ Ğ½Ğµ Ğ¿Ğ¾ĞºĞ°Ğ·Ñ‹Ğ²Ğ°ĞµĞ¼
} 

```


## <a name="srccomponentsAvailabilityStriptsx"></a>`src/components/AvailabilityStrip.tsx`

```tsx
// path: src/components/AvailabilityStrip.tsx

// src/components/AvailabilityStrip.tsx

import { useState } from 'react';
import { Popover, PopoverContent, PopoverAnchor } from '@/components/ui/popover';
import { useDateStore } from '@/store/dateStore';
import type { DayStatus } from '@/types/availability';
import { format } from 'date-fns';
import { ru } from 'date-fns/locale';
import { Button } from './ui/button';
import { useHolidayStore } from '@/store/holidayStore';
import { DateService } from '@/core/services/DateService';
import { toast } from 'sonner';

interface AvailabilityStripProps {
    dailyStatus?: Record<string, DayStatus>;
}

const cellColorMap: Record<string, string> = {
    available: 'bg-green-500 hover:bg-green-600',
    reserved: 'bg-yellow-500 hover:bg-yellow-600',
    rented: 'bg-red-500 hover:bg-red-600',
    default: 'bg-gray-400 hover:bg-gray-500'
};

type PopoverData = {
    date: Date;
    status: string;
};

export default function AvailabilityStrip({ dailyStatus = {} }: AvailabilityStripProps) {
    const { setRange } = useDateStore();
    const holidays = useHolidayStore((state) => state.holidays);

    const [isPopoverOpen, setPopoverOpen] = useState(false);
    const [popoverData, setPopoverData] = useState<PopoverData | null>(null);

    const today = new Date();
    today.setHours(0, 0, 0, 0);

    const dates = Array.from({ length: 30 }, (_, i) => {
        const date = new Date();
        date.setDate(today.getDate() + i);
        return date;
    });

    const handleCellClick = (date: Date, status: string) => {
        setPopoverData({ date, status });
        setPopoverOpen(true);
    };

    // +++ ĞĞĞ§ĞĞ›Ğ: ĞĞ‘ĞĞĞ’Ğ›Ğ•ĞĞĞĞ¯ Ğ›ĞĞ“Ğ˜ĞšĞ ĞĞ‘Ğ ĞĞ‘ĞĞ¢Ğ§Ğ˜ĞšĞ +++
    const handleSetAsStartDate = () => {
        if (!popoverData) return;

        const originalStartDate = popoverData.date;

        // 1. ĞĞ²Ñ‚Ğ¾Ğ¼Ğ°Ñ‚Ğ¸Ñ‡ĞµÑĞºĞ¸ ÑĞ´Ğ²Ğ¸Ğ³Ğ°ĞµĞ¼ Ğ´Ğ°Ñ‚Ñƒ, ĞµÑĞ»Ğ¸ Ğ¾Ğ½Ğ° Ğ¿Ğ¾Ğ¿Ğ°Ğ»Ğ° Ğ½Ğ° Ğ²Ñ‹Ñ…Ğ¾Ğ´Ğ½Ğ¾Ğ¹
        const adjustedStartDate = DateService.adjustDateIfHoliday(originalStartDate, holidays);

        // 2. Ğ Ğ°ÑÑÑ‡Ğ¸Ñ‚Ñ‹Ğ²Ğ°ĞµĞ¼ Ğ´Ğ°Ñ‚Ñƒ Ğ¾ĞºĞ¾Ğ½Ñ‡Ğ°Ğ½Ğ¸Ñ Ğ¾Ñ‚ *ÑĞºĞ¾Ñ€Ñ€ĞµĞºÑ‚Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ½Ğ¾Ğ¹* Ğ´Ğ°Ñ‚Ñ‹ Ğ½Ğ°Ñ‡Ğ°Ğ»Ğ°
        const finalEndDate = DateService.findNextWorkingDay(adjustedStartDate, holidays, 1);

        // 3. ĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑĞµĞ¼, Ğ±Ñ‹Ğ»Ğ° Ğ»Ğ¸ Ğ´Ğ°Ñ‚Ğ° Ğ½Ğ°Ñ‡Ğ°Ğ»Ğ° Ğ¸Ğ·Ğ¼ĞµĞ½ĞµĞ½Ğ°
        if (adjustedStartDate.getTime() !== originalStartDate.getTime()) {
            // 4. Ğ•ÑĞ»Ğ¸ Ğ´Ğ° - Ğ¿Ğ¾ĞºĞ°Ğ·Ñ‹Ğ²Ğ°ĞµĞ¼ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ñ ÑƒĞ²ĞµĞ´Ğ¾Ğ¼Ğ»ĞµĞ½Ğ¸Ğµ
            toast.info(`Ğ”Ğ°Ñ‚Ğ° Ğ½Ğ°Ñ‡Ğ°Ğ»Ğ° ÑĞ´Ğ²Ğ¸Ğ½ÑƒÑ‚Ğ° Ñ ${format(originalStartDate, 'dd.MM.yyyy')} Ğ½Ğ° ${format(adjustedStartDate, 'dd.MM.yyyy')}, Ñ‚Ğ°Ğº ĞºĞ°Ğº Ğ²Ñ‹Ğ±Ñ€Ğ°Ğ½Ğ½Ñ‹Ğ¹ Ğ´ĞµĞ½ÑŒ ÑĞ²Ğ»ÑĞµÑ‚ÑÑ Ğ²Ñ‹Ñ…Ğ¾Ğ´Ğ½Ñ‹Ğ¼.`);
        }

        // 5. Ğ£ÑÑ‚Ğ°Ğ½Ğ°Ğ²Ğ»Ğ¸Ğ²Ğ°ĞµĞ¼ Ğ½Ğ¾Ğ²Ñ‹Ğ¹, ĞºĞ¾Ñ€Ñ€ĞµĞºÑ‚Ğ½Ñ‹Ğ¹ Ğ´Ğ¸Ğ°Ğ¿Ğ°Ğ·Ğ¾Ğ½ Ğ´Ğ°Ñ‚
        setRange(adjustedStartDate, finalEndDate);
        setPopoverOpen(false);
    };
    // +++ ĞšĞĞĞ•Ğ¦: ĞĞ‘ĞĞĞ’Ğ›Ğ•ĞĞĞĞ¯ Ğ›ĞĞ“Ğ˜ĞšĞ ĞĞ‘Ğ ĞĞ‘ĞĞ¢Ğ§Ğ˜ĞšĞ +++

    const statusTextMap: Record<string, string> = {
        available: 'Ğ¡Ğ²Ğ¾Ğ±Ğ¾Ğ´Ğ½Ğ¾',
        reserved: 'Ğ’ Ñ€ĞµĞ·ĞµÑ€Ğ²Ğµ',
        rented: 'Ğ’ Ğ°Ñ€ĞµĞ½Ğ´Ğµ',
        default: 'ĞĞµÑ‚ Ğ´Ğ°Ğ½Ğ½Ñ‹Ñ…'
    };

    return (
        <Popover open={isPopoverOpen} onOpenChange={setPopoverOpen}>
            <PopoverAnchor asChild>
                <div
                    className="w-full h-3 mt-auto flex rounded-sm overflow-hidden border border-gray-400 cursor-pointer"
                    title="ĞŸĞ¾ÑĞ¼Ğ¾Ñ‚Ñ€ĞµÑ‚ÑŒ Ğ´Ğ¾ÑÑ‚ÑƒĞ¿Ğ½Ğ¾ÑÑ‚ÑŒ Ğ¸ Ğ²Ñ‹Ğ±Ñ€Ğ°Ñ‚ÑŒ Ğ´Ğ°Ñ‚Ñ‹"
                >
                    {dates.map(date => {
                        const dateStr = format(date, 'dd.MM.yyyy');
                        const status = dailyStatus[dateStr]?.status ?? 'available';
                        const color = cellColorMap[status] ?? cellColorMap.default;

                        return (
                            <button
                                key={dateStr}
                                className={`flex-1 h-full transition-colors focus:outline-none focus:ring-2 focus:ring-sky-500 z-10 ${color}`}
                                onClick={() => handleCellClick(date, status)}
                                aria-label={`Ğ¡Ñ‚Ğ°Ñ‚ÑƒÑ Ğ½Ğ° ${dateStr}: ${statusTextMap[status]}`}
                            />
                        );
                    })}
                </div>
            </PopoverAnchor>

            <PopoverContent
                className="w-auto p-3 bg-white border rounded-md shadow-lg text-sm"
                side="bottom"
                align="center"
                onCloseAutoFocus={(e) => e.preventDefault()}
                sideOffset={5}
            >
                {popoverData && (
                    <div className="space-y-2">
                        <p>
                            <strong>Ğ”Ğ°Ñ‚Ğ°:</strong> {format(popoverData.date, "PPP", { locale: ru })}
                        </p>
                        <p>
                            <strong>Ğ¡Ñ‚Ğ°Ñ‚ÑƒÑ:</strong> {statusTextMap[popoverData.status] ?? 'ĞĞµĞ¸Ğ·Ğ²ĞµÑÑ‚Ğ½Ğ¾'}
                        </p>
                        {popoverData.status === 'available' && (
                            <Button
                                size="sm"
                                className="mt-2 w-full"
                                onClick={handleSetAsStartDate}
                            >
                                Ğ£ÑÑ‚Ğ°Ğ½Ğ¾Ğ²Ğ¸Ñ‚ÑŒ Ğ´Ğ°Ñ‚Ğ¾Ğ¹ Ğ½Ğ°Ñ‡Ğ°Ğ»Ğ° Ñ€ĞµĞ·ĞµÑ€Ğ²Ğ°
                            </Button>
                        )}
                    </div>
                )}
            </PopoverContent>
        </Popover>
    );
}

```


## <a name="srccomponentsAvailableCheckboxtsx"></a>`src/components/AvailableCheckbox.tsx`

```tsx
// path: src/components/AvailableCheckbox.tsx

import { Checkbox } from "@/components/ui/checkbox"
import { useFilterStore } from "@/store/filterStore"
import { Label } from "@/components/ui/label"

export default function AvailableCheckbox() {
  const { availableOnly, setAvailableOnly } = useFilterStore()

  return (
    <div className="flex items-center space-x-2">
      <Checkbox
        id="available-only"
        checked={availableOnly}
        onCheckedChange={(checked) => setAvailableOnly(Boolean(checked))}
      />
      <Label htmlFor="available-only">Ğ¢Ğ¾Ğ»ÑŒĞºĞ¾ Ğ´Ğ¾ÑÑ‚ÑƒĞ¿Ğ½Ğ¾Ğµ</Label>
    </div>
  )
}


```


## <a name="srccomponentsBrandFiltertsx"></a>`src/components/BrandFilter.tsx`

```tsx
// path: src/components/BrandFilter.tsx

// src/components/BrandFilter.tsx
import { useMemo } from "react"
import { useFilterStore } from "@/store/filterStore"
import type { Equipment } from "@/types/equipment"
import {
    Select,
    SelectContent,
    SelectItem,
    SelectTrigger,
    SelectValue,
} from "@/components/ui/select"

interface BrandFilterProps {
    items: Equipment[]
}

export default function BrandFilter({ items }: BrandFilterProps) {
    const { brand, setBrand } = useFilterStore()

    const brands = useMemo(() => {
        const set = new Set(items.map((i) => i.brand))
        return Array.from(set)
    }, [items])

    return (
        <Select value={brand} onValueChange={setBrand}>
            <SelectTrigger className="w-[200px] border border-sky-300 shadow-sm hover:shadow-md">
                <SelectValue placeholder="Ğ’ÑĞµ Ğ±Ñ€ĞµĞ½Ğ´Ñ‹" />
            </SelectTrigger>
            <SelectContent>
                <SelectItem value="__all__">Ğ’ÑĞµ Ğ±Ñ€ĞµĞ½Ğ´Ñ‹</SelectItem>
                {brands.map((b) => (
                    <SelectItem key={b} value={b}>
                        {b}
                    </SelectItem>
                ))}
            </SelectContent>
        </Select>
    )
}


```


## <a name="srccomponentsCancelReservationDialogtsx"></a>`src/components/CancelReservationDialog.tsx`

```tsx
// path: src/components/CancelReservationDialog.tsx

// src/components/CancelReservationDialog.tsx
import {
    Dialog,
    DialogContent,
    DialogHeader,
    DialogTitle, // Ğ˜Ğ¼Ğ¿Ğ¾Ñ€Ñ‚Ğ¸Ñ€ÑƒĞµĞ¼ DialogTitle
    DialogDescription, // Ğ˜Ğ¼Ğ¿Ğ¾Ñ€Ñ‚Ğ¸Ñ€ÑƒĞµĞ¼ DialogDescription
    DialogFooter,
} from "@/components/ui/dialog";
import { Button } from "@/components/ui/button";

type Props = {
    open: boolean;
    onClose: () => void;
    onConfirm: () => void;
};

export default function CancelReservationDialog({ open, onClose, onConfirm }: Props) {
    return (
        <Dialog open={open} onOpenChange={onClose}>
            <DialogContent>
                <DialogHeader>
                    {/* ğŸ‘‡ Ğ˜Ğ¡ĞŸĞĞ›Ğ¬Ğ—Ğ£Ğ•Ğœ DialogTitle Ğ²Ğ¼ĞµÑÑ‚Ğ¾ h2 */}
                    <DialogTitle className="text-lg font-semibold">ĞÑ‚Ğ¼ĞµĞ½Ğ¸Ñ‚ÑŒ Ğ¾Ñ„Ğ¾Ñ€Ğ¼Ğ»ĞµĞ½Ğ¸Ğµ?</DialogTitle>
                </DialogHeader>
                {/* ğŸ‘‡ Ğ˜Ğ¡ĞŸĞĞ›Ğ¬Ğ—Ğ£Ğ•Ğœ DialogDescription Ğ²Ğ¼ĞµÑÑ‚Ğ¾ p */}
                <DialogDescription className="text-sm text-gray-600">
                    Ğ’ÑĞµ Ğ²Ñ‹Ğ±Ñ€Ğ°Ğ½Ğ½Ñ‹Ğµ Ğ¿Ğ¾Ğ·Ğ¸Ñ†Ğ¸Ğ¸ Ğ±ÑƒĞ´ÑƒÑ‚ ÑƒĞ´Ğ°Ğ»ĞµĞ½Ñ‹, Ğ° Ğ²Ñ‹ Ğ²ĞµÑ€Ğ½Ñ‘Ñ‚ĞµÑÑŒ Ğ½Ğ° Ğ³Ğ»Ğ°Ğ²Ğ½ÑƒÑ ÑÑ‚Ñ€Ğ°Ğ½Ğ¸Ñ†Ñƒ.
                </DialogDescription>
                <DialogFooter className="pt-4">
                    <Button variant="ghost" onClick={onClose}>
                        ĞÑ‚Ğ¼ĞµĞ½Ğ°
                    </Button>
                    <Button
                        className="bg-red-700 hover:bg-red-800 text-white"
                        onClick={onConfirm}
                    >
                        ĞŸĞ¾Ğ´Ñ‚Ğ²ĞµÑ€Ğ´Ğ¸Ñ‚ÑŒ Ğ¾Ñ‚Ğ¼ĞµĞ½Ñƒ
                    </Button>
                </DialogFooter>
            </DialogContent>
        </Dialog>
    );
}

```


## <a name="srccomponentsCardShelltsx"></a>`src/components/CardShell.tsx`

```tsx
// path: src/components/CardShell.tsx

import { Card, CardContent, CardFooter, CardHeader } from "@/components/ui/card"
import { ReactNode } from "react"

type Props = {
    title: string
    status?: ReactNode
    children: ReactNode
    footer?: ReactNode
    className?: string
}

export default function CardShell({ title, status, children, footer, className = "" }: Props) {
    return (
        <Card className={`w-full rounded-xl border shadow-sm hover:shadow-md transition ${className}`}>
            <CardHeader className="flex justify-between items-start">
                <h3 className="text-lg font-semibold">{title}</h3>
                {status && <div>{status}</div>}
            </CardHeader>
            <CardContent className="space-y-2 text-sm text-gray-700">
                {children}
            </CardContent>
            {footer && <CardFooter className="pt-2">{footer}</CardFooter>}
        </Card>
    )
}


```


## <a name="srccomponentsCompactEquipmentCardtsx"></a>`src/components/CompactEquipmentCard.tsx`

```tsx
// path: src/components/CompactEquipmentCard.tsx

// src/components/CompactEquipmentCard.tsx

import React, { useMemo, useCallback } from "react";
import { CheckCircle } from "lucide-react";
import { useReserveStore } from "@/store/reserveStore";
import { useDateStore } from "@/store/dateStore";
import { useSandboxCalculatorStore } from "@/store/sandboxCalculatorStore";
import { usePromoCodeStore } from "@/store/promoCodeStore";
import { formatDateRangeEuropean } from "@/lib/utils";

// Ğ¢Ğ¸Ğ¿Ñ‹
import type { Equipment } from "@/types/equipment";
import type { DayStatus, EquipmentStatus } from "@/types/availability";

interface CompactEquipmentCardProps {
    equipment: Equipment;
    status?: EquipmentStatus | "my_reservation" | "added";
    startDate?: string;
    endDate?: string;
    dailyStatus?: Record<string, DayStatus>;
}

// --- ĞĞĞ§ĞĞ›Ğ Ğ˜Ğ—ĞœĞ•ĞĞ•ĞĞ˜Ğ™ ---

// 1. Ğ£Ğ¿Ñ€Ğ¾Ñ‰Ğ°ĞµĞ¼ ÑÑ‚Ğ¸Ğ»Ğ¸, ÑƒĞ´Ğ°Ğ»ÑÑ `ending_today`
const COMPACT_STATUS_STYLES: Record<EquipmentStatus | "my_reservation" | "added", string> = {
    available: "bg-white border-gray-200 hover:bg-gray-50",
    reserved: "bg-rose-100 border-rose-300",
    rented: "bg-red-200 border-red-400",
    my_reservation: "bg-sky-50 border-sky-200 hover:bg-sky-100",
    added: "bg-green-100 border-green-300",
};
// --- ĞšĞĞĞ•Ğ¦ Ğ˜Ğ—ĞœĞ•ĞĞ•ĞĞ˜Ğ™ ---

const COMPACT_SELECTED_STYLES = "ring-2 ring-offset-1 ring-green-500 border-green-500 bg-green-100";

const CompactEquipmentCardComponent: React.FC<CompactEquipmentCardProps> = ({
                                                                       equipment,
                                                                       status = "available",
                                                                       startDate,
                                                                       endDate,
                                                                   }) => {
    const { toggle, isSelected, selectedAccessories } = useReserveStore();
    const { dayCount } = useDateStore();
    const { durationDiscountPercentage } = useSandboxCalculatorStore();
    const { promoCodePercentage } = usePromoCodeStore();
    const isSelectedByUser = isSelected(equipment.id);

    const accessoriesDailyRate = useMemo(() => {
        const selectedForThisCard = selectedAccessories[equipment.id] || [];
        return equipment.accessories?.reduce((total, acc) =>
            selectedForThisCard.includes(acc.id) ? total + acc.price : total, 0) ?? 0;
    }, [equipment.accessories, equipment.id, selectedAccessories]);

    const totalDiscountPercentage = useMemo(() =>
            durationDiscountPercentage + promoCodePercentage,
        [durationDiscountPercentage, promoCodePercentage]
    );

    const priceData = useMemo(() => {
        const totalDailyRate = equipment.daily_rate + accessoriesDailyRate;
        const priceBefore = totalDailyRate * dayCount;
        const priceAfter = priceBefore * (1 - totalDiscountPercentage / 100);

        return {
            dailyRate: totalDailyRate,
            totalPrice: priceAfter,
            discountPercentage: totalDiscountPercentage,
            days: dayCount,
        };
    }, [equipment.daily_rate, accessoriesDailyRate, dayCount, totalDiscountPercentage]);

    // --- ĞĞĞ§ĞĞ›Ğ Ğ˜Ğ—ĞœĞ•ĞĞ•ĞĞ˜Ğ™: Ğ£Ğ´Ğ°Ğ»ÑĞµĞ¼ useMemo Ğ´Ğ»Ñ finalStatus ---
    // const finalStatus: DisplayStatus = useMemo(() => { ... }); // Ğ­Ğ¢ĞĞ¢ Ğ‘Ğ›ĞĞš ĞŸĞĞ›ĞĞĞ¡Ğ¢Ğ¬Ğ® Ğ£Ğ”ĞĞ›Ğ•Ğ
    // --- ĞšĞĞĞ•Ğ¦ Ğ˜Ğ—ĞœĞ•ĞĞ•ĞĞ˜Ğ™ ---

    const handleCardClick = useCallback((e: React.MouseEvent<HTMLDivElement>) => {
        if ((e.target as HTMLElement).closest("button, a, label, input[type='checkbox']")) return;
        // --- Ğ˜Ğ—ĞœĞ•ĞĞ•ĞĞ˜Ğ•: Ğ˜ÑĞ¿Ğ¾Ğ»ÑŒĞ·ÑƒĞµĞ¼ `status` Ğ½Ğ°Ğ¿Ñ€ÑĞ¼ÑƒÑ ---
        if (status === 'available' || status === 'added') {
            toggle(equipment);
        }
    }, [status, toggle, equipment]);

    const handleDoubleClick = useCallback((e: React.MouseEvent<HTMLDivElement>) => {
        if ((e.target as HTMLElement).closest("button, a, label, input[type='checkbox']")) return;
        // --- Ğ˜Ğ—ĞœĞ•ĞĞ•ĞĞ˜Ğ•: Ğ˜ÑĞ¿Ğ¾Ğ»ÑŒĞ·ÑƒĞµĞ¼ `status` Ğ½Ğ°Ğ¿Ñ€ÑĞ¼ÑƒÑ ---
        if (status === 'available' || status === 'added') {
            toggle(equipment);
        }
    }, [status, toggle, equipment]);

    // --- Ğ˜Ğ—ĞœĞ•ĞĞ•ĞĞ˜Ğ•: Ğ˜ÑĞ¿Ğ¾Ğ»ÑŒĞ·ÑƒĞµĞ¼ `status` Ğ´Ğ»Ñ Ğ¾Ğ¿Ñ€ĞµĞ´ĞµĞ»ĞµĞ½Ğ¸Ñ ÑÑ‚Ğ¸Ğ»Ñ ---
    const backgroundClass = isSelectedByUser
        ? COMPACT_SELECTED_STYLES
        : COMPACT_STATUS_STYLES[status];

    const dateRangeDisplay = (startDate && endDate)
        ? `(${formatDateRangeEuropean(startDate, endDate)})`
        : "";

    return (
        <div
            className={`relative p-3 rounded-lg border transition-all duration-200 cursor-pointer ${backgroundClass}`}
            onClick={handleCardClick}
            onDoubleClick={handleDoubleClick}
            tabIndex={0}
        >
            {isSelectedByUser && (
                <div className="absolute top-1 right-1 z-10 bg-green-600 text-white rounded-full p-0.5 shadow">
                    <CheckCircle className="w-3 h-3" />
                </div>
            )}

            <div className="space-y-2">
                <div className="space-y-1">
                    <h3 className="text-sm font-semibold text-gray-900 truncate" title={equipment.name}>
                        {equipment.name}
                    </h3>
                    <p className="text-xs text-gray-500">
                        {equipment.brand} â€¢ {equipment.equipment_type}
                    </p>
                    {dateRangeDisplay && (
                        <p className="text-xs text-gray-400">{dateRangeDisplay}</p>
                    )}
                </div>

                <div className="space-y-1">
                    <div className="flex justify-between items-center">
                        <span className="text-xs text-gray-600">
                            {priceData.days} {priceData.days === 1 ? 'Ğ´ĞµĞ½ÑŒ' : priceData.days < 5 ? 'Ğ´Ğ½Ñ' : 'Ğ´Ğ½ĞµĞ¹'}
                        </span>
                        <span className="text-sm font-semibold text-gray-900">
                            {priceData.totalPrice.toLocaleString('ru-RU')} â‚½
                        </span>
                    </div>

                    {priceData.discountPercentage > 0 && (
                        <div className="text-xs text-green-600">
                            Ğ¡ĞºĞ¸Ğ´ĞºĞ°: {priceData.discountPercentage.toFixed(0)}%
                        </div>
                    )}
                </div>

                {/* --- ĞĞĞ§ĞĞ›Ğ Ğ˜Ğ—ĞœĞ•ĞĞ•ĞĞ˜Ğ™: Ğ£Ğ¿Ñ€Ğ¾Ñ‰ĞµĞ½Ğ½Ñ‹Ğ¹ Ğ±Ğ»Ğ¾Ğº ÑÑ‚Ğ°Ñ‚ÑƒÑĞ° --- */}
                <div className="text-xs">
                    {status === 'available' && (
                        <span className="text-green-600 font-medium">Ğ¡Ğ²Ğ¾Ğ±Ğ¾Ğ´Ğ½Ğ¾</span>
                    )}
                    {status === 'reserved' && (
                        <span className="text-red-600 font-medium">Ğ’ Ñ€ĞµĞ·ĞµÑ€Ğ²Ğµ</span>
                    )}
                    {status === 'rented' && (
                        <span className="text-red-700 font-medium">Ğ’ Ğ°Ñ€ĞµĞ½Ğ´Ğµ</span>
                    )}
                    {status === 'my_reservation' && (
                        <span className="text-sky-600 font-medium">Ğ’ ÑÑ‚Ğ¾Ğ¼ Ñ€ĞµĞ·ĞµÑ€Ğ²Ğµ</span>
                    )}
                    {status === 'added' && (
                        <span className="text-emerald-600 font-medium">Ğ”Ğ¾Ğ±Ğ°Ğ²Ğ»ĞµĞ½Ğ¾</span>
                    )}
                </div>
                {/* --- ĞšĞĞĞ•Ğ¦ Ğ˜Ğ—ĞœĞ•ĞĞ•ĞĞ˜Ğ™ --- */}
            </div>
        </div>
    );
};

// ĞœĞµĞ¼Ğ¾Ğ¸Ğ·Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ½Ğ°Ñ Ğ²ĞµÑ€ÑĞ¸Ñ ĞºĞ¾Ğ¼Ğ¿Ğ¾Ğ½ĞµĞ½Ñ‚Ğ° Ğ´Ğ»Ñ Ğ¾Ğ¿Ñ‚Ğ¸Ğ¼Ğ¸Ğ·Ğ°Ñ†Ğ¸Ğ¸ Ğ¿Ñ€Ğ¾Ğ¸Ğ·Ğ²Ğ¾Ğ´Ğ¸Ñ‚ĞµĞ»ÑŒĞ½Ğ¾ÑÑ‚Ğ¸
const CompactEquipmentCard = React.memo(CompactEquipmentCardComponent);

export default CompactEquipmentCard;

```


## <a name="srccomponentsConfirmItemRemovalDialogtsx"></a>`src/components/ConfirmItemRemovalDialog.tsx`

```tsx
// path: src/components/ConfirmItemRemovalDialog.tsx

// src/components/ConfirmItemRemovalDialog.tsx
import {
    Dialog,
    DialogContent,
    DialogHeader,
    DialogTitle,
    DialogDescription,
    DialogFooter,
} from "@/components/ui/dialog";
import { Button } from "@/components/ui/button";

type Props = {
    open: boolean;
    onClose: () => void;
    onConfirm: () => void;
    isConfirming: boolean;
    variant?: 'removeItem' | 'cancelReservation'; // âœ¨ ĞĞĞ’Ğ«Ğ™ ĞŸĞ ĞĞŸĞ¡
};

export default function ConfirmItemRemovalDialog({
                                                     open,
                                                     onClose,
                                                     onConfirm,
                                                     isConfirming,
                                                     variant = 'removeItem' // âœ¨ Ğ—ĞĞĞ§Ğ•ĞĞ˜Ğ• ĞŸĞ Ğ£ĞœĞĞ›Ğ§ĞĞĞ˜Ğ®
                                                 }: Props) {

    // âœ¨ ĞšĞĞĞ¢Ğ•ĞĞ¢ Ğ”Ğ›Ğ¯ Ğ ĞĞ—ĞĞ«Ğ¥ Ğ’ĞĞ Ğ˜ĞĞĞ¢ĞĞ’ Ğ”Ğ˜ĞĞ›ĞĞ“Ğ
    const content = {
        removeItem: {
            title: "ĞŸĞ¾Ğ´Ñ‚Ğ²ĞµÑ€Ğ´Ğ¸Ñ‚Ğµ Ğ´ĞµĞ¹ÑÑ‚Ğ²Ğ¸Ğµ",
            description: "Ğ’Ñ‹ ÑƒĞ²ĞµÑ€ĞµĞ½Ñ‹, Ñ‡Ñ‚Ğ¾ Ñ…Ğ¾Ñ‚Ğ¸Ñ‚Ğµ ÑƒĞ´Ğ°Ğ»Ğ¸Ñ‚ÑŒ ÑÑ‚Ñƒ Ğ¿Ğ¾Ğ·Ğ¸Ñ†Ğ¸Ñ Ğ¸Ğ· Ñ€ĞµĞ·ĞµÑ€Ğ²Ğ°?",
            cancelText: "ĞÑ‚Ğ¼ĞµĞ½Ğ°",
            confirmText: "Ğ£Ğ´Ğ°Ğ»Ğ¸Ñ‚ÑŒ",
            confirmLoadingText: "Ğ£Ğ´Ğ°Ğ»ĞµĞ½Ğ¸Ğµ..."
        },
        cancelReservation: {
            title: "Ğ£Ğ´Ğ°Ğ»ĞµĞ½Ğ¸Ğµ Ğ¿Ğ¾ÑĞ»ĞµĞ´Ğ½ĞµĞ¹ Ğ¿Ğ¾Ğ·Ğ¸Ñ†Ğ¸Ğ¸",
            description: "Ğ’Ñ‹ ÑƒĞ´Ğ°Ğ»Ğ¸Ğ»Ğ¸ Ğ¿Ğ¾ÑĞ»ĞµĞ´Ğ½ÑÑ Ğ¿Ğ¾Ğ·Ğ¸Ñ†Ğ¸Ñ. Ğ¥Ğ¾Ñ‚Ğ¸Ñ‚Ğµ Ğ¾Ñ‚Ğ¼ĞµĞ½Ğ¸Ñ‚ÑŒ Ñ€ĞµĞ·ĞµÑ€Ğ² Ğ¿Ğ¾Ğ»Ğ½Ğ¾ÑÑ‚ÑŒÑ?",
            cancelText: "Ğ’ĞµÑ€Ğ½ÑƒÑ‚ÑŒÑÑ Ğº Ñ€ĞµĞ´Ğ°ĞºÑ‚Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ",
            confirmText: "ĞÑ‚Ğ¼ĞµĞ½Ğ¸Ñ‚ÑŒ Ñ€ĞµĞ·ĞµÑ€Ğ²",
            confirmLoadingText: "ĞÑ‚Ğ¼ĞµĞ½Ğ°..."
        }
    }[variant];

    return (
        <Dialog open={open} onOpenChange={onClose}>
            <DialogContent>
                <DialogHeader>
                    <DialogTitle>{content.title}</DialogTitle>
                </DialogHeader>
                <DialogDescription>{content.description}</DialogDescription>
                <DialogFooter className="pt-4">
                    <Button variant="ghost" onClick={onClose} disabled={isConfirming}>
                        {content.cancelText}
                    </Button>
                    <Button
                        variant="destructive"
                        onClick={onConfirm}
                        disabled={isConfirming}
                    >
                        {isConfirming ? content.confirmLoadingText : content.confirmText}
                    </Button>
                </DialogFooter>
            </DialogContent>
        </Dialog>
    );
}

```


## <a name="srccomponentsDateRangeSelectortsx"></a>`src/components/DateRangeSelector.tsx`

```tsx
// path: src/components/DateRangeSelector.tsx

// src/components/DateRangeSelector.tsx

import { useState, type RefObject, useCallback, useEffect, useRef } from 'react';
import { DayPicker, type DateRange } from 'react-day-picker';
import { ru } from 'date-fns/locale';
import { format, addMonths, startOfMonth, endOfMonth } from 'date-fns';
import { ChevronsDown, ChevronsUp } from "lucide-react";
import { useDateStore } from "@/store/dateStore";
import { useSandboxCalculatorStore } from "@/store/sandboxCalculatorStore";
import { useDateRange } from "@/hooks/useDateRange";
import { useHolidayStore } from "@/store/holidayStore";
import { DateService } from '@/core/services/DateService';

interface DateRangeSelectorProps {
    containerRef: RefObject<HTMLDivElement | null>;
}

export default function DateRangeSelector({ containerRef }: DateRangeSelectorProps) {
    const { startDate, endDate, setRange } = useDateStore();
    const { isCalculatorVisible, syncWithDateStore, refreshCalculator } = useSandboxCalculatorStore();

    const [collapsed, setCollapsed] = useState(true);
    const [month, setMonth] = useState(startDate);

    const lastChangeSource = useRef<'calendar' | 'slider' | 'manual' | null>(null);
    const [isAutoUpdating, setIsAutoUpdating] = useState(false);

    const { holidays, fetchHolidays } = useHolidayStore();

    useEffect(() => {
        const firstDayToFetch = startOfMonth(addMonths(month, -1));
        const lastDayToFetch = endOfMonth(addMonths(month, 2));
        void fetchHolidays(firstDayToFetch, lastDayToFetch);
    }, [month, fetchHolidays]);

    // âœ… ĞĞĞ’ĞĞ•: Ğ¡Ğ¸Ğ½Ñ…Ñ€Ğ¾Ğ½Ğ¸Ğ·Ğ¸Ñ€ÑƒĞµĞ¼ ĞºĞ°Ğ»ÑŒĞºÑƒĞ»ÑÑ‚Ğ¾Ñ€ Ğ¿Ñ€Ğ¸ Ğ¸Ğ·Ğ¼ĞµĞ½ĞµĞ½Ğ¸Ğ¸ Ğ²Ñ‹Ñ…Ğ¾Ğ´Ğ½Ñ‹Ñ… Ğ´Ğ½ĞµĞ¹
    useEffect(() => {
        if (holidays.length > 0) {
            refreshCalculator();
        }
    }, [holidays, refreshCalculator]);

    // âœ… ĞĞĞ’ĞĞ•: Ğ¡Ğ¸Ğ½Ñ…Ñ€Ğ¾Ğ½Ğ¸Ğ·Ğ¸Ñ€ÑƒĞµĞ¼ ĞºĞ°Ğ»ÑŒĞºÑƒĞ»ÑÑ‚Ğ¾Ñ€ Ğ¿Ñ€Ğ¸ Ğ¸Ğ·Ğ¼ĞµĞ½ĞµĞ½Ğ¸Ğ¸ ĞºĞ¾Ğ»Ğ¸Ñ‡ĞµÑÑ‚Ğ²Ğ° Ğ´Ğ½ĞµĞ¹
    useEffect(() => {
        const { dayCount } = useDateStore.getState();
        if (dayCount > 0) {
            syncWithDateStore();
        }
    }, [startDate, endDate, syncWithDateStore]);

    const handleRangeChange = useCallback((newStart: Date, newEnd: Date, source?: 'calendar' | 'slider' | 'manual') => {
        lastChangeSource.current = source || 'manual';

        if (source === 'slider') {
            setIsAutoUpdating(true);
            setTimeout(() => setIsAutoUpdating(false), 1000);
        }

        setRange(newStart, newEnd, source, holidays);

        if (source !== 'slider') {
            syncWithDateStore();
        }
    }, [holidays, setRange, syncWithDateStore]);

    useEffect(() => {
        if (lastChangeSource.current === 'slider') {
            lastChangeSource.current = null;
            return;
        }

        lastChangeSource.current = null;
    }, [startDate, endDate]);

    const {
        localStartDate,
        localEndDate,
        handleStartDateChange,
        handleEndDateChange,
    } = useDateRange({
        startDate,
        endDate,
        onRangeChange: handleRangeChange,
        holidays
    });

    const handleSelect = (selectedRange: DateRange | undefined) => {
        if (!selectedRange?.from) return;

        const selectionStartDate = selectedRange.from;
        const finalEndDate = selectedRange.to ?? DateService.findNextWorkingDay(selectionStartDate, holidays, 1);

        const finalRange = { from: selectionStartDate, to: finalEndDate };

        if (finalRange.from && finalRange.to) {
            const { dayCount } = useDateStore.getState();
            const willCalculatorAppear = !isCalculatorVisible && dayCount >= 4;

            if (willCalculatorAppear && containerRef.current) {
                containerRef.current.style.overflowAnchor = 'none';
            }

            handleRangeChange(finalRange.from, finalRange.to, 'calendar');

            if (willCalculatorAppear && containerRef.current) {
                setTimeout(() => {
                    if (containerRef.current) containerRef.current.style.overflowAnchor = 'auto';
                }, 0);
            }
        }
    };

    const today = new Date();
    today.setHours(0, 0, 0, 0);

    const disabledDays = [
        ...holidays,
        { before: today }
    ];

    function formatDateForInput(date: Date): string {
        const year = date.getFullYear();
        const month = String(date.getMonth() + 1).padStart(2, "0");
        const day = String(date.getDate()).padStart(2, "0");
        return `${year}-${month}-${day}`;
    }

    const minEndDate = (() => {
        const start = new Date(localStartDate);
        const timezoneOffset = start.getTimezoneOffset() * 60000;
        const startUTC = new Date(start.getTime() + timezoneOffset);
        startUTC.setDate(startUTC.getDate() + 1);
        return formatDateForInput(startUTC);
    })();

    return (
        <div className="mb-4 border rounded-md p-4 bg-white shadow-sm">
            <div className="flex justify-between items-center mb-2">
                <h2 className="text-base font-semibold text-gray-700">Ğ’Ñ‹Ğ±Ğ¸Ñ€Ğ°Ğ¹Ñ‚Ğµ Ğ´Ğ°Ñ‚Ñ‹ Ğ½Ğ°Ñ‡Ğ°Ğ»Ğ° Ğ¸ Ğ¾ĞºĞ¾Ğ½Ñ‡Ğ°Ğ½Ğ¸Ñ Ğ°Ñ€ĞµĞ½Ğ´Ñ‹:</h2>
                <button
                    onClick={() => setCollapsed(!collapsed)}
                    className="text-gray-600 hover:text-gray-800 transition p-1"
                    title={collapsed ? "Ğ Ğ°Ğ·Ğ²ĞµÑ€Ğ½ÑƒÑ‚ÑŒ ĞºĞ°Ğ»ĞµĞ½Ğ´Ğ°Ñ€ÑŒ" : "Ğ¡Ğ²ĞµÑ€Ğ½ÑƒÑ‚ÑŒ ĞºĞ°Ğ»ĞµĞ½Ğ´Ğ°Ñ€ÑŒ"}
                >
                    {collapsed ? <ChevronsDown className="w-5 h-5" /> : <ChevronsUp className="w-5 h-5" />}
                </button>
            </div>

            {collapsed ? (
                    <div
                        className="flex justify-center items-center gap-4 mt-4 cursor-pointer group"
                        onClick={() => setCollapsed(false)}
                        title="ĞĞ°Ğ¶Ğ¼Ğ¸Ñ‚Ğµ, Ñ‡Ñ‚Ğ¾Ğ±Ñ‹ Ğ¸Ğ·Ğ¼ĞµĞ½Ğ¸Ñ‚ÑŒ Ğ´Ğ°Ñ‚Ñ‹"
                    >
                        <div className="text-center p-3 rounded-lg bg-sky-50 border-2 border-sky-200 w-40 transition-all group-hover:border-sky-400 group-hover:shadow-lg">
                            <div className="text-sm font-medium text-sky-700">ĞĞ°Ñ‡Ğ°Ğ»Ğ¾</div>
                            <div className="text-4xl font-bold text-sky-900 leading-tight">{format(startDate, "dd")}</div>
                            <div className="text-lg font-semibold text-sky-800 capitalize">{format(startDate, "LLLL", { locale: ru })}</div>
                            <div className="text-sm text-sky-600">{format(startDate, "yyyy")}</div>
                        </div>
                        <div className="text-3xl font-light text-gray-300 pb-8">-</div>
                        <div className={`text-center p-3 rounded-lg w-40 transition-all group-hover:shadow-lg ${
                            isAutoUpdating
                                ? 'bg-green-50 border-2 border-green-300 animate-pulse'
                                : 'bg-sky-50 border-2 border-sky-200 group-hover:border-sky-400'
                        }`}>
                            <div className="text-sm font-medium text-sky-700">
                                {isAutoUpdating ? 'ĞĞ±Ğ½Ğ¾Ğ²Ğ»ÑĞµÑ‚ÑÑ...' : 'ĞĞºĞ¾Ğ½Ñ‡Ğ°Ğ½Ğ¸Ğµ'}
                            </div>
                            <div className="text-4xl font-bold text-sky-900 leading-tight">{format(endDate, "dd")}</div>
                            <div className="text-lg font-semibold text-sky-800 capitalize">{format(endDate, "LLLL", { locale: ru })}</div>
                            <div className="text-sm text-sky-600">{format(endDate, "yyyy")}</div>
                        </div>
                    </div>
                ) :
                <>
                    <div className="flex justify-center mb-4">
                        <DayPicker
                            mode="range"
                            locale={ru}
                            selected={{ from: startDate, to: endDate }}
                            onSelect={handleSelect}
                            month={month}
                            onMonthChange={setMonth}
                            showOutsideDays
                            numberOfMonths={2}
                            disabled={disabledDays}
                            min={2}
                            modifiers={{ holiday: holidays }}
                            classNames={{
                                months: 'flex flex-col sm:flex-row space-y-4 sm:space-x-4 sm:space-y-0',
                                month: 'space-y-4',
                                table: 'w-full border-collapse space-y-1',
                                head_row: 'flex',
                                head_cell: 'text-muted-foreground rounded-md w-9 font-normal text-[0.8rem]',
                                row: 'flex w-full mt-2',
                                cell: 'h-9 w-9 text-center text-sm p-0 relative [&:has([aria-selected])]:bg-accent first:[&:has([aria-selected])]:rounded-l-md last:[&:has([aria-selected])]:rounded-r-md focus-within:relative focus-within:z-20',
                                day: 'h-9 w-9 p-0 font-normal aria-selected:opacity-100',
                                nav: 'space-x-1 flex items-center',
                                caption: 'flex justify-center pt-1 relative items-center',
                                caption_label: 'text-sm font-medium',
                                nav_button: 'h-7 w-7 bg-transparent p-0 opacity-50 hover:opacity-100'
                            }}
                            modifiersClassNames={{
                                today: 'bg-accent text-accent-foreground',
                                selected: 'bg-sky-600 text-white hover:bg-sky-600 hover:text-white focus:bg-sky-600 focus:text-white',
                                range_start: 'rounded-l-full',
                                range_end: 'rounded-r-full',
                                range_middle: 'aria-selected:bg-sky-100 aria-selected:text-sky-900',
                                outside: 'day-outside text-muted-foreground opacity-50',
                                disabled: 'text-muted-foreground opacity-50 cursor-not-allowed',
                                holiday: 'text-red-600 bg-red-50 border-red-200 font-bold',
                            }}
                        />
                    </div>
                    <div className="flex flex-col sm:flex-row gap-4 justify-center">
                        <label className="text-sm text-gray-700">
                            Ğ¡:
                            <input
                                type="date"
                                value={localStartDate}
                                onChange={handleStartDateChange}
                                className="ml-2 border border-gray-300 rounded px-2 py-1 text-sm"
                                min={formatDateForInput(new Date())}
                            />
                        </label>
                        <label className="text-sm text-gray-700">
                            ĞŸĞ¾:
                            <input
                                type="date"
                                value={localEndDate}
                                onChange={handleEndDateChange}
                                className="ml-2 border border-gray-300 rounded px-2 py-1 text-sm"
                                min={minEndDate}
                            />
                        </label>
                    </div>
                </>
            }
        </div>
    );
}

```


## <a name="srccomponentsDateRangeSelectorcalendarcss"></a>`src/components/DateRangeSelector/calendar.css`

```css
// path: src/components/DateRangeSelector/calendar.css

/* src/components/DateRangeSelector/calendar.css */

/* ĞĞ±Ñ‰Ğ¸Ğµ ÑÑ‚Ğ¸Ğ»Ğ¸ Ğ´Ğ»Ñ Ğ´Ğ½Ñ, ĞºĞ¾Ñ‚Ğ¾Ñ€Ñ‹Ğµ ÑƒĞ¶Ğµ ĞµÑÑ‚ÑŒ Ğ² index.css, Ğ½Ğ¾ Ğ¼Ñ‹ Ğ¼Ğ¾Ğ¶ĞµĞ¼ Ğ¸Ñ… Ğ´Ğ¾Ğ¿Ğ¾Ğ»Ğ½Ğ¸Ñ‚ÑŒ */
.calendar-day {
    padding: 0.5rem;
    border-radius: 0; /* Ğ£Ğ±Ğ¸Ñ€Ğ°ĞµĞ¼ ÑĞºÑ€ÑƒĞ³Ğ»ĞµĞ½Ğ¸Ğµ Ğ¿Ğ¾ ÑƒĞ¼Ğ¾Ğ»Ñ‡Ğ°Ğ½Ğ¸Ñ Ğ´Ğ»Ñ ÑÑ€ĞµĞ´Ğ½Ğ¸Ñ… Ğ´Ğ½ĞµĞ¹ */
    color: #1f2937; /* Ğ¦Ğ²ĞµÑ‚ Ñ‚ĞµĞºÑÑ‚Ğ° Ğ¿Ğ¾ ÑƒĞ¼Ğ¾Ğ»Ñ‡Ğ°Ğ½Ğ¸Ñ */
    transition: background-color 0.2s, color 0.2s;
}

/* Ğ¡Ñ‚Ğ¸Ğ»Ğ¸ Ğ´Ğ»Ñ Ğ´Ğ½ĞµĞ¹ Ğ²Ğ½ÑƒÑ‚Ñ€Ğ¸ Ğ²Ñ‹Ğ±Ñ€Ğ°Ğ½Ğ½Ğ¾Ğ³Ğ¾ Ğ´Ğ¸Ğ°Ğ¿Ğ°Ğ·Ğ¾Ğ½Ğ° (Ğ´ÑƒĞ±Ğ»Ğ¸Ñ€ÑƒÑÑ‚ index.css Ğ´Ğ»Ñ Ğ½Ğ°Ğ´ĞµĞ¶Ğ½Ğ¾ÑÑ‚Ğ¸) */
.range-middle {
    background-color: #e0f2fe; /* Tailwind sky-100 */
}

/* Ğ¡Ñ‚Ğ¸Ğ»Ğ¸ Ğ´Ğ»Ñ Ğ½Ğ°Ñ‡Ğ°Ğ»ÑŒĞ½Ğ¾Ğ¹ Ğ¸ ĞºĞ¾Ğ½ĞµÑ‡Ğ½Ğ¾Ğ¹ Ğ´Ğ°Ñ‚ Ğ´Ğ¸Ğ°Ğ¿Ğ°Ğ·Ğ¾Ğ½Ğ° (Ğ´ÑƒĞ±Ğ»Ğ¸Ñ€ÑƒÑÑ‚ index.css Ğ´Ğ»Ñ Ğ½Ğ°Ğ´ĞµĞ¶Ğ½Ğ¾ÑÑ‚Ğ¸) */
.range-start,
.range-end {
    background-color: #0284c7; /* Tailwind sky-600 */
    color: white;
    border-radius: 50%; /* Ğ”ĞµĞ»Ğ°ĞµĞ¼ Ğ¸Ñ… ĞºÑ€ÑƒĞ³Ğ»Ñ‹Ğ¼Ğ¸ */
}

/* Ğ£Ğ±Ğ¸Ñ€Ğ°ĞµĞ¼ ÑÑ‚Ğ°Ğ½Ğ´Ğ°Ñ€Ñ‚Ğ½Ğ¾Ğµ Ğ²Ñ‹Ğ´ĞµĞ»ĞµĞ½Ğ¸Ğµ Ğ´Ğ»Ñ Ğ¾Ğ´Ğ¸Ğ½Ğ¾Ñ‡Ğ½Ñ‹Ñ… ĞºĞ»Ğ¸ĞºĞ¾Ğ² Ğ² Ñ€ĞµĞ¶Ğ¸Ğ¼Ğµ Ğ´Ğ¸Ğ°Ğ¿Ğ°Ğ·Ğ¾Ğ½Ğ° */
.day-selected:not([class*="range-"]) {
    background-color: transparent;
    color: inherit;
}

/* Ğ¡Ñ‚Ğ¸Ğ»Ğ¸ Ğ´Ğ»Ñ Ğ½Ğ°Ğ²Ğ¸Ğ³Ğ°Ñ†Ğ¸Ğ¸ Ğ¸ Ğ·Ğ°Ğ³Ğ¾Ğ»Ğ¾Ğ²ĞºĞ¾Ğ² (Ğ´ÑƒĞ±Ğ»Ğ¸Ñ€ÑƒÑÑ‚ index.css Ğ´Ğ»Ñ Ğ½Ğ°Ğ´ĞµĞ¶Ğ½Ğ¾ÑÑ‚Ğ¸) */
.calendar-caption {
    font-weight: bold;
    font-size: 1.1rem;
    text-transform: capitalize;
    padding-bottom: 0.5rem;
}

.calendar-nav {
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.calendar-head-cell {
    font-weight: 500;
    color: #4b5563; /* gray-600 */
    font-size: 0.8rem;
}

.calendar-cell {
    padding: 1px; /* ĞĞµĞ±Ğ¾Ğ»ÑŒÑˆĞ¾Ğ¹ Ğ¾Ñ‚ÑÑ‚ÑƒĞ¿ Ğ¼ĞµĞ¶Ğ´Ñƒ ÑÑ‡ĞµĞ¹ĞºĞ°Ğ¼Ğ¸ Ğ´Ğ»Ñ Ğ²Ğ¸Ğ·ÑƒĞ°Ğ»ÑŒĞ½Ğ¾Ğ³Ğ¾ Ñ€Ğ°Ğ·Ğ´ĞµĞ»ĞµĞ½Ğ¸Ñ */
}

```


## <a name="srccomponentsDiscountCalculatortsx"></a>`src/components/DiscountCalculator.tsx`

```tsx
// path: src/components/DiscountCalculator.tsx

// src/components/DiscountCalculator.tsx

import { useState, useMemo, useRef, useCallback, useEffect } from 'react'; // 1. Ğ”Ğ¾Ğ±Ğ°Ğ²Ğ»ĞµĞ½ Ğ¸Ğ¼Ğ¿Ğ¾Ñ€Ñ‚ useEffect
import { useSandboxCalculatorStore } from '@/store/sandboxCalculatorStore';
import { useDateStore } from '@/store/dateStore';
import { usePromoCodeStore } from '@/store/promoCodeStore';
import { useReserveStore } from '@/store/reserveStore';
import { Card, CardContent } from '@/components/ui/card';
import { Label } from "@/components/ui/label";
import { ChevronRight, Percent, Loader2 } from "lucide-react";
import PromoCodeInput from './PromoCodeInput';
import type { ChangeEvent } from 'react';
import { toast } from 'sonner';
import { api } from '@/lib/api';

export default function DiscountCalculator() {
    const { dayCount } = useDateStore();
    const {
        setDaysFromSlider, isCalculatorVisible, toggleCalculator,
        isLoadingTiers, durationDiscountPercentage,
        syncWithDateStore // 2. ĞŸĞ¾Ğ»ÑƒÑ‡Ğ°ĞµĞ¼ Ñ„ÑƒĞ½ĞºÑ†Ğ¸Ñ ÑĞ¸Ğ½Ñ…Ñ€Ğ¾Ğ½Ğ¸Ğ·Ğ°Ñ†Ğ¸Ğ¸
    } = useSandboxCalculatorStore();

    const {
        promoCode, setPromoCode, promoCodePercentage,
        promoCodeMessage, setPromoCodeResult, removePromoCode
    } = usePromoCodeStore();

    const { items } = useReserveStore();

    const [isApplyingPromoCode, setIsApplyingPromoCode] = useState(false);

    const debounceTimeoutRef = useRef<NodeJS.Timeout | null>(null);

    // 3. --- Ğ”ĞĞ‘ĞĞ’Ğ›Ğ•Ğ Ğ­Ğ¢ĞĞ¢ Ğ‘Ğ›ĞĞš ---
    // Ğ­Ñ‚Ğ¾Ñ‚ ÑÑ„Ñ„ĞµĞºÑ‚ ÑĞ»ĞµĞ´Ğ¸Ñ‚ Ğ·Ğ° Ğ¸Ğ·Ğ¼ĞµĞ½ĞµĞ½Ğ¸ĞµĞ¼ `dayCount` Ğ² Ñ…Ñ€Ğ°Ğ½Ğ¸Ğ»Ğ¸Ñ‰Ğµ Ğ´Ğ°Ñ‚.
    // ĞšĞ°Ğº Ñ‚Ğ¾Ğ»ÑŒĞºĞ¾ `dayCount` Ğ¾Ğ±Ğ½Ğ¾Ğ²Ğ¸Ğ»ÑÑ (Ğ¿Ğ¾ÑĞ»Ğµ ÑƒÑ‡ĞµÑ‚Ğ° Ğ²Ñ‹Ñ…Ğ¾Ğ´Ğ½Ñ‹Ñ…),
    // Ğ¼Ñ‹ Ğ·Ğ°Ğ¿ÑƒÑĞºĞ°ĞµĞ¼ `syncWithDateStore`, ĞºĞ¾Ñ‚Ğ¾Ñ€Ñ‹Ğ¹ Ğ¿ĞµÑ€ĞµÑÑ‡Ğ¸Ñ‚Ñ‹Ğ²Ğ°ĞµÑ‚ ÑĞºĞ¸Ğ´ĞºÑƒ,
    // Ğ¸ÑĞ¿Ğ¾Ğ»ÑŒĞ·ÑƒÑ ÑƒĞ¶Ğµ ĞºĞ¾Ñ€Ñ€ĞµĞºÑ‚Ğ½Ğ¾Ğµ ĞºĞ¾Ğ»Ğ¸Ñ‡ĞµÑÑ‚Ğ²Ğ¾ Ğ´Ğ½ĞµĞ¹.
    useEffect(() => {
        syncWithDateStore();
    }, [dayCount, syncWithDateStore]);
    // ----------------------------

    const handleApplyPromoCode = async () => {
        const currentItems = useReserveStore.getState().items;
        const currentDays = useDateStore.getState().dayCount;

        if (currentItems.length === 0) {
            toast.info("Ğ’Ñ‹Ğ±ĞµÑ€Ğ¸Ñ‚Ğµ Ğ¾Ğ±Ğ¾Ñ€ÑƒĞ´Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ, Ñ‡Ñ‚Ğ¾Ğ±Ñ‹ Ğ¿Ñ€Ğ¸Ğ¼ĞµĞ½Ğ¸Ñ‚ÑŒ Ğ¿Ñ€Ğ¾Ğ¼Ğ¾ĞºĞ¾Ğ´.");
            return;
        }
        if (!promoCode) {
            toast.info("Ğ’Ğ²ĞµĞ´Ğ¸Ñ‚Ğµ Ğ¿Ñ€Ğ¾Ğ¼Ğ¾ĞºĞ¾Ğ´");
            return;
        }

        const totalDailyRate = currentItems.reduce((sum, item) => sum + item.daily_rate, 0);
        const orderAmount = totalDailyRate * currentDays;

        setIsApplyingPromoCode(true);
        try {
            const response = await api.post("/promocodes/validate", {
                code: promoCode,
                order_amount: orderAmount,
                equipment_ids: currentItems.map(item => item.id)
            });
            setPromoCodeResult(response.data.discount_percentage, response.data.message);
            toast.success(response.data.message);
        } catch (error: unknown) {
            const apiError = error as { response?: { data?: { detail?: string } } }
            const errorMessage = apiError.response?.data?.detail || "ĞĞµ ÑƒĞ´Ğ°Ğ»Ğ¾ÑÑŒ Ğ¿Ñ€Ğ¸Ğ¼ĞµĞ½Ğ¸Ñ‚ÑŒ Ğ¿Ñ€Ğ¾Ğ¼Ğ¾ĞºĞ¾Ğ´";
            setPromoCodeResult(0, errorMessage);
            toast.error(errorMessage);
        } finally {
            setIsApplyingPromoCode(false);
        }
    };

    const handleSliderChange = useCallback((event: ChangeEvent<HTMLInputElement>) => {
        const newDays = Number(event.target.value);

        if (debounceTimeoutRef.current) {
            clearTimeout(debounceTimeoutRef.current);
        }

        debounceTimeoutRef.current = setTimeout(() => {
            setDaysFromSlider(newDays);
        }, 10);
    }, [setDaysFromSlider]);

    const totalDiscountPercentage = useMemo(() => durationDiscountPercentage + promoCodePercentage, [durationDiscountPercentage, promoCodePercentage]);

    const getDiscountInfo = (percent: number) => {
        if (percent >= 25) return {label: "ĞœĞ°ĞºÑĞ¸Ğ¼ÑƒĞ¼ Ğ²Ñ‹Ğ³Ğ¾Ğ´Ñ‹!", className: "text-amber-600 font-bold"};
        if (percent >= 20) return {label: "ĞÑ‚Ğ»Ğ¸Ñ‡Ğ½Ğ°Ñ ÑĞºĞ¸Ğ´ĞºĞ°!", className: "text-purple-600 font-bold"};
        if (percent >= 15) return {label: "Ğ¥Ğ¾Ñ€Ğ¾ÑˆĞ°Ñ ÑĞºĞ¸Ğ´ĞºĞ°", className: "text-green-600 font-bold"};
        if (percent > 0) return {label: "ĞĞµĞ±Ğ¾Ğ»ÑŒÑˆĞ°Ñ ÑĞºĞ¸Ğ´ĞºĞ°", className: "text-sky-600"};
        return {label: "Ğ¡ĞºĞ¸Ğ´ĞºĞ° Ğ·Ğ°Ğ²Ğ¸ÑĞ¸Ñ‚ Ğ¾Ñ‚ Ğ´Ğ½ĞµĞ¹", className: "text-gray-500"};
    };

    const discountInfo = getDiscountInfo(totalDiscountPercentage);
    const requirementMessage = items.length === 0 ? "Ğ’Ñ‹Ğ±ĞµÑ€Ğ¸Ñ‚Ğµ Ğ¾Ğ±Ğ¾Ñ€ÑƒĞ´Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ Ğ´Ğ»Ñ Ğ¿Ñ€Ğ¾Ğ¼Ğ¾ĞºĞ¾Ğ´Ğ°." : "";

    if (!isCalculatorVisible) {
        return (
            <Card
                className="my-4 bg-gray-50/50 hover:bg-gray-100 cursor-pointer transition"
                onClick={toggleCalculator}
            >
                <CardContent className="p-3">
                    <div className="flex items-center justify-between">
                        <div className="flex items-center gap-3">
                            <Percent className="w-5 h-5 text-purple-500"/>
                            <div className="text-sm">
                                <p className="text-gray-800">
                                    <span className="text-base font-bold text-purple-600">Ğ•ÑÑ‚ÑŒ Ğ¿Ñ€Ğ¾Ğ¼Ğ¾ĞºĞ¾Ğ´?</span>
                                    <span className="font-medium"> Ğ¸Ğ»Ğ¸ Ñ…Ğ¾Ñ‚Ğ¸Ñ‚Ğµ Ñ€Ğ°ÑÑÑ‡Ğ¸Ñ‚Ğ°Ñ‚ÑŒ ÑĞºĞ¸Ğ´ĞºÑƒ?</span>
                                </p>
                            </div>
                        </div>
                        <ChevronRight className="w-5 h-5 text-gray-400"/>
                    </div>
                </CardContent>
            </Card>
        );
    }

    return (
        <Card className="my-4 bg-white border-sky-200 shadow-md">
            <CardContent className="p-4">
                <div className="flex flex-col md:flex-row items-center justify-between gap-6 w-full">
                    <div className="w-full md:flex-1">
                        <Label htmlFor="days-slider" className="mb-2 block text-sm text-gray-700">
                            ĞšĞ¾Ğ»Ğ¸Ñ‡ĞµÑÑ‚Ğ²Ğ¾ Ğ´Ğ½ĞµĞ¹: <span className="font-bold">{dayCount}</span>
                            <span className="ml-2 text-xs text-gray-500">(Ğ´Ğ²Ğ¸Ğ³Ğ°Ğ¹Ñ‚Ğµ Ğ¿Ğ¾Ğ»Ğ·ÑƒĞ½Ğ¾Ğº Ğ´Ğ»Ñ Ğ¸Ğ·Ğ¼ĞµĞ½ĞµĞ½Ğ¸Ñ Ğ´Ğ°Ñ‚)</span>
                        </Label>
                        <input id="days-slider" type="range" min="1" max="30" value={dayCount} onChange={handleSliderChange}
                               className="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer accent-sky-600"/>
                    </div>
                    <div className="flex-shrink-0 text-center bg-sky-50 py-2 px-4 rounded-lg border w-full md:w-auto min-w-[160px]">
                        {isLoadingTiers ? (
                            <div className="flex items-center justify-center text-gray-500"><Loader2 className="h-4 w-4 animate-spin mr-2" /> Ğ—Ğ°Ğ³Ñ€ÑƒĞ·ĞºĞ°...</div>
                        ) : (
                            <>
                                <div className={`text-2xl font-bold transition-colors duration-300 ${discountInfo.className}`}>Ğ¡ĞºĞ¸Ğ´ĞºĞ°: {totalDiscountPercentage}%</div>
                                <p className={`text-xs mt-1 transition-colors duration-300 ${discountInfo.className}`}>{discountInfo.label}</p>
                            </>
                        )}
                    </div>
                    <div className="w-full md:flex-1">
                        <PromoCodeInput
                            promoCode={promoCode}
                            setPromoCode={setPromoCode}
                            applyPromoCode={handleApplyPromoCode}
                            removePromoCode={removePromoCode}
                            promoCodeMessage={promoCodeMessage}
                            isLoading={isApplyingPromoCode}
                            requirementMessage={requirementMessage}
                        />
                    </div>
                </div>
            </CardContent>
        </Card>
    );
}

```


## <a name="srccomponentsEquipmentGridtsx"></a>`src/components/EquipmentGrid.tsx`

```tsx
// path: src/components/EquipmentGrid.tsx

// src/components/EquipmentGrid.tsx

import EquipmentCard from '@/components/equipment-card';
import CompactEquipmentCard from '@/components/CompactEquipmentCard';
import { Button } from "@/components/ui/button";
import { PackageSearch, FilterX, Loader2 } from "lucide-react";
import type { Equipment } from "@/types/equipment";
// âœ… Ğ˜Ğ¡ĞŸĞ ĞĞ’Ğ›Ğ•ĞĞ˜Ğ•: Ğ”Ğ¾Ğ±Ğ°Ğ²Ğ»ÑĞµĞ¼ Ğ¸Ğ¼Ğ¿Ğ¾Ñ€Ñ‚ Ğ½ĞµĞ´Ğ¾ÑÑ‚Ğ°ÑÑ‰Ğ¸Ñ… Ñ‚Ğ¸Ğ¿Ğ¾Ğ²
import type { AvailabilityInfo, DayStatus, EquipmentStatus } from "@/types/availability";
import type { ViewMode } from '@/store/viewModeStore';

interface EquipmentGridProps {
    isLoading: boolean;
    items: Equipment[];
    // âœ… Ğ˜Ğ¡ĞŸĞ ĞĞ’Ğ›Ğ•ĞĞ˜Ğ•: Ğ£Ğ±Ğ¸Ñ€Ğ°ĞµĞ¼ Ğ½ĞµĞ¸ÑĞ¿Ğ¾Ğ»ÑŒĞ·ÑƒĞµĞ¼Ñ‹Ğ¹ Ğ¿Ğ°Ñ€Ğ°Ğ¼ĞµÑ‚Ñ€
    // totalItemCount: number;
    hasActiveFilters: boolean;
    getEquipmentStatus: (eq: Equipment) => EquipmentStatus | "my_reservation" | "added";
    dailyAvailabilityData?: Record<number, Record<string, DayStatus>>;
    availabilityData?: AvailabilityInfo[];
    onShowMore: () => void;
    onResetFilters: () => void;
    viewMode: ViewMode;
    isFetchingNextPage: boolean;
    hasNextPage: boolean | undefined;
}

export default function EquipmentGrid({
                                          isLoading,
                                          items,
                                          // âœ… Ğ˜Ğ¡ĞŸĞ ĞĞ’Ğ›Ğ•ĞĞ˜Ğ•: Ğ£Ğ±Ğ¸Ñ€Ğ°ĞµĞ¼ Ğ½ĞµĞ¸ÑĞ¿Ğ¾Ğ»ÑŒĞ·ÑƒĞµĞ¼Ñ‹Ğ¹ Ğ¿Ğ°Ñ€Ğ°Ğ¼ĞµÑ‚Ñ€
                                          // totalItemCount,
                                          hasActiveFilters,
                                          getEquipmentStatus,
                                          dailyAvailabilityData,
                                          availabilityData,
                                          onShowMore,
                                          onResetFilters,
                                          viewMode,
                                          isFetchingNextPage,
                                          hasNextPage,
                                      }: EquipmentGridProps) {

    if (isLoading && items.length === 0) {
        return <p className="text-gray-500 text-sm col-span-full text-center py-5">Ğ—Ğ°Ğ³Ñ€ÑƒĞ·ĞºĞ° Ğ¾Ğ±Ğ¾Ñ€ÑƒĞ´Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ...</p>;
    }

    if (items.length === 0) {
        return (
            <div className="col-span-full my-8">
                <div className="flex flex-col items-center justify-center text-center p-8 space-y-4 bg-gray-50/50 rounded-lg border-2 border-dashed">
                    {hasActiveFilters ? <FilterX className="w-16 h-16 text-gray-400" /> : <PackageSearch className="w-16 h-16 text-gray-400" />}
                    <div className="space-y-1">
                        <h3 className="text-lg font-semibold text-gray-800">{hasActiveFilters ? "ĞĞ¸Ñ‡ĞµĞ³Ğ¾ Ğ½Ğµ Ğ½Ğ°Ğ¹Ğ´ĞµĞ½Ğ¾" : "ĞšĞ°Ñ‚Ğ°Ğ»Ğ¾Ğ³ Ğ¿Ğ¾ĞºĞ° Ğ¿ÑƒÑÑ‚"}</h3>
                        <p className="text-sm text-gray-500">{hasActiveFilters ? "ĞŸĞ¾Ğ¿Ñ€Ğ¾Ğ±ÑƒĞ¹Ñ‚Ğµ Ğ¸Ğ·Ğ¼ĞµĞ½Ğ¸Ñ‚ÑŒ Ğ¸Ğ»Ğ¸ ÑĞ±Ñ€Ğ¾ÑĞ¸Ñ‚ÑŒ Ñ„Ğ¸Ğ»ÑŒÑ‚Ñ€Ñ‹." : "Ğ—Ğ´ĞµÑÑŒ Ğ¿Ğ¾ÑĞ²Ğ¸Ñ‚ÑÑ Ğ¾Ğ±Ğ¾Ñ€ÑƒĞ´Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ Ğ´Ğ»Ñ Ğ°Ñ€ĞµĞ½Ğ´Ñ‹."}</p>
                    </div>
                    {hasActiveFilters && (
                        <div className="mt-4">
                            <Button variant="outline" onClick={onResetFilters}>
                                Ğ¡Ğ±Ñ€Ğ¾ÑĞ¸Ñ‚ÑŒ Ñ„Ğ¸Ğ»ÑŒÑ‚Ñ€Ñ‹
                            </Button>
                        </div>
                    )}
                </div>
            </div>
        );
    }

    const gridClasses = viewMode === "compact"
        ? "grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 2xl:grid-cols-5 gap-3 mt-4"
        : "grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-4 sm:gap-6 mt-4";

    return (
        <>
            <div className={gridClasses}>
                {items.map((eq) => {
                    const availability = availabilityData?.find(a => a.equipment_id === eq.id);
                    const equipmentDailyStatus = dailyAvailabilityData?.[eq.id];
                    const status = getEquipmentStatus(eq);

                    const equipmentProps = {
                        equipment: eq,
                        status,
                        startDate: availability?.start_date ?? undefined,
                        endDate: availability?.end_date ?? undefined,
                        dailyStatus: equipmentDailyStatus,
                    };

                    return viewMode === "compact" ? (
                        <CompactEquipmentCard key={eq.id} {...equipmentProps} />
                    ) : (
                        <EquipmentCard key={eq.id} {...equipmentProps} />
                    );
                })}
            </div>
            {hasNextPage && (
                <div className="flex justify-center mt-8">
                    <Button
                        variant="outline"
                        onClick={onShowMore}
                        disabled={isFetchingNextPage}
                    >
                        {isFetchingNextPage ? (
                            <>
                                <Loader2 className="mr-2 h-4 w-4 animate-spin" />
                                Ğ—Ğ°Ğ³Ñ€ÑƒĞ·ĞºĞ°...
                            </>
                        ) : (
                            "ĞŸĞ¾ĞºĞ°Ğ·Ğ°Ñ‚ÑŒ ĞµÑ‰Ñ‘"
                        )}
                    </Button>
                </div>
            )}
        </>
    );
}

```


## <a name="srccomponentsErrorBoundarytsx"></a>`src/components/ErrorBoundary.tsx`

```tsx
// path: src/components/ErrorBoundary.tsx

// src/components/ErrorBoundary.tsx

import { ErrorBoundary as ReactErrorBoundary } from "react-error-boundary"
import ErrorMessage from "./ErrorMessage"

type Props = {
    children: React.ReactNode
}

/**
 * Ğ“Ğ»Ğ¾Ğ±Ğ°Ğ»ÑŒĞ½Ñ‹Ğ¹ Ğ¾Ğ±Ñ€Ğ°Ğ±Ğ¾Ñ‚Ñ‡Ğ¸Ğº Ğ¾ÑˆĞ¸Ğ±Ğ¾Ğº Ğ´Ğ»Ñ Ğ²ÑĞµĞ³Ğ¾ Ğ¿Ñ€Ğ¸Ğ»Ğ¾Ğ¶ĞµĞ½Ğ¸Ñ.
 * ĞŸĞ¾ĞºĞ°Ğ·Ñ‹Ğ²Ğ°ĞµÑ‚ ĞºĞ¾Ğ¼Ğ¿Ğ¾Ğ½ĞµĞ½Ñ‚ `ErrorMessage` Ğ¿Ñ€Ğ¸ ÑĞ±Ğ¾Ğµ Ğ´ĞµÑ€ĞµĞ²Ğ° ĞºĞ¾Ğ¼Ğ¿Ğ¾Ğ½ĞµĞ½Ñ‚Ğ¾Ğ².
 */
export default function ErrorBoundary({ children }: Props) {
    return (
        <ReactErrorBoundary
            fallbackRender={({ error, resetErrorBoundary }) => (
                <ErrorMessage error={error} onRetry={resetErrorBoundary} />
            )}
        >
            {children}
        </ReactErrorBoundary>
    )
}


```


## <a name="srccomponentsErrorMessagetsx"></a>`src/components/ErrorMessage.tsx`

```tsx
// path: src/components/ErrorMessage.tsx

import { AlertCircle, RotateCcw } from "lucide-react"

type Props = {
    error: Error
    onRetry?: () => void
}

export default function ErrorMessage({ error, onRetry }: Props) {
    return (
        <div className="bg-red-50 border border-red-300 text-red-700 p-4 rounded-md shadow-sm text-sm">
            <div className="flex items-start gap-2">
                <AlertCircle className="w-4 h-4 mt-0.5" />
                <div>
                    <p className="font-semibold mb-1">ĞŸÑ€Ğ¾Ğ¸Ğ·Ğ¾ÑˆĞ»Ğ° Ğ¾ÑˆĞ¸Ğ±ĞºĞ°:</p>
                    <pre className="whitespace-pre-wrap break-words">{error.message}</pre>
                </div>
            </div>
            {onRetry && (
                <button
                    onClick={onRetry}
                    className="mt-3 inline-flex items-center text-sm text-sky-700 hover:underline"
                >
                    <RotateCcw className="w-4 h-4 mr-1" />
                    ĞŸĞ¾Ğ²Ñ‚Ğ¾Ñ€Ğ¸Ñ‚ÑŒ
                </button>
            )}
        </div>
    )
}


```


## <a name="srccomponentsFilterPaneltsx"></a>`src/components/FilterPanel.tsx`

```tsx
// path: src/components/FilterPanel.tsx

// src/components/FilterPanel.tsx

import SearchInput from "@/components/SearchInput";
import AvailableCheckbox from "@/components/AvailableCheckbox";
import TypeFilter from "@/components/TypeFilter";
import BrandFilter from "@/components/BrandFilter";
import AssociationFilter from "@/components/AssociationFilter";
import ViewModeToggle from "@/components/ViewModeToggle";
import type { Equipment } from "@/types/equipment";

interface FilterPanelProps {
    // âœ… Ğ¢Ğ¸Ğ¿Ğ¸Ğ·Ğ°Ñ†Ğ¸Ñ Ğ½Ğµ Ğ¼ĞµĞ½ÑĞµÑ‚ÑÑ, Ğ½Ğ¾ Ñ‚ĞµĞ¿ĞµÑ€ÑŒ ÑÑĞ´Ğ° Ğ±ÑƒĞ´ĞµÑ‚ Ğ¿Ñ€Ğ¸Ñ…Ğ¾Ğ´Ğ¸Ñ‚ÑŒ Ğ¿Ğ¾Ğ»Ğ½Ñ‹Ğ¹ ÑĞ¿Ğ¸ÑĞ¾Ğº
    equipmentData: Equipment[];
}

export default function FilterPanel({ equipmentData }: FilterPanelProps) {
    return (
        <div className="bg-white border border-gray-200 shadow-sm rounded-lg p-4 space-y-4">
            <div className="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4">
                <SearchInput />
                <div className="flex items-center gap-2">
                    <AvailableCheckbox />
                    <ViewModeToggle />
                </div>
            </div>
            <div className="flex flex-wrap gap-2 sm:gap-3">
                {/* âœ… ĞŸĞµÑ€ĞµĞ´Ğ°ĞµĞ¼ Ğ¿Ğ¾Ğ»Ğ½Ñ‹Ğ¹ ÑĞ¿Ğ¸ÑĞ¾Ğº Ğ´Ğ°Ğ»ÑŒÑˆĞµ */}
                <TypeFilter items={equipmentData} />
            </div>
            <div className="flex flex-wrap gap-2 sm:gap-3">
                {/* âœ… AssociationFilter ÑƒĞ¶Ğµ Ğ¿Ğ¾Ğ»ÑƒÑ‡Ğ°ĞµÑ‚ Ğ¿Ğ¾Ğ»Ğ½Ñ‹Ğ¹ ÑĞ¿Ğ¸ÑĞ¾Ğº Ğ°ÑÑĞ¾Ñ†Ğ¸Ğ°Ñ†Ğ¸Ğ¹ Ğ¸Ğ· ÑĞ²Ğ¾ĞµĞ³Ğ¾ Ñ…ÑƒĞºĞ°, ĞµĞ³Ğ¾ Ñ‚Ñ€Ğ¾Ğ³Ğ°Ñ‚ÑŒ Ğ½Ğµ Ğ½Ğ°Ğ´Ğ¾ */}
                <AssociationFilter />
            </div>
            <div className="flex flex-wrap gap-2 sm:gap-3">
                {/* âœ… ĞŸĞµÑ€ĞµĞ´Ğ°ĞµĞ¼ Ğ¿Ğ¾Ğ»Ğ½Ñ‹Ğ¹ ÑĞ¿Ğ¸ÑĞ¾Ğº Ğ´Ğ°Ğ»ÑŒÑˆĞµ */}
                <BrandFilter items={equipmentData} />
            </div>
        </div>
    );
}

```


## <a name="srccomponentsMyReservationListtsx"></a>`src/components/MyReservationList.tsx`

```tsx
// path: src/components/MyReservationList.tsx

// src/components/MyReservationList.tsx

import { useMemo, useState } from "react";
import { useReservations } from "@/hooks/useReservations";
import { useAllEquipment } from "@/hooks/useAllEquipment";
import { ReservationService } from "@/core/services";
import ReservationCard from "./ReservationCard";
import { Checkbox } from "@/components/ui/checkbox";
import { useNavigate } from "react-router-dom";
import { useReserveStore } from "@/store/reserveStore";
import { useDateStore } from "@/store/dateStore";
import { Button } from "@/components/ui/button";
import { FileText, FilterX } from "lucide-react";
import ConfirmItemRemovalDialog from "./ConfirmItemRemovalDialog";

import type { Equipment } from "@/types/equipment";
import type { Reservation, ReservationWithNames } from "@/types/reservation";

interface MyReservationListProps {
    continueEditingReservationId?: number;
    highlightId?: number | null;
    reservationsData?: Reservation[];
    isLoading?: boolean;
    isError?: boolean;
}

const LoadingState = () => (
    <p className="text-center py-4">Ğ—Ğ°Ğ³Ñ€ÑƒĞ·ĞºĞ° Ğ´Ğ°Ğ½Ğ½Ñ‹Ñ…...</p>
);

const ErrorState = ({ message }: { message: string }) => (
    <p className="text-red-600 text-center py-4">{message}</p>
);

export default function MyReservationList({
                                              continueEditingReservationId,
                                              highlightId,
                                              reservationsData: propReservationsData,
                                              isLoading: propIsLoading,
                                              isError: propIsError,
                                          }: MyReservationListProps) {
    const { data: allEquipment = [], isLoading: isLoadingEquipment, isError: isEquipmentError } = useAllEquipment();

    const equipmentMap = useMemo(() => {
        const map: Record<number, Equipment> = {};
        allEquipment.forEach(e => { map[e.id] = e; });
        return map;
    }, [allEquipment]);

    const { deleteReservation, updateReservation } = useReservations();

    // Ğ˜ÑĞ¿Ğ¾Ğ»ÑŒĞ·ÑƒĞµĞ¼ Ğ´Ğ°Ğ½Ğ½Ñ‹Ğµ Ğ¸Ğ· Ğ¿Ñ€Ğ¾Ğ¿ÑĞ¾Ğ² Ğ¸Ğ»Ğ¸ Ğ·Ğ°Ğ³Ñ€ÑƒĞ¶Ğ°ĞµĞ¼ Ğ¸Ñ… ÑĞ°Ğ¼Ğ¾ÑÑ‚Ğ¾ÑÑ‚ĞµĞ»ÑŒĞ½Ğ¾
    const reservationsData: Reservation[] = useMemo(() => propReservationsData ?? [], [propReservationsData]);
    const isLoadingReservations = propIsLoading ?? false;
    const isReservationsError = propIsError ?? false;

    const navigate = useNavigate();
    const reserveStore = useReserveStore();
    const dateStore = useDateStore();

    const [deletingId, setDeletingId] = useState<number | null>(null);
    const [hideCompleted, setHideCompleted] = useState<boolean>(false);
    const [itemToRemove, setItemToRemove] = useState<{ reservationId: number; equipmentId: number } | null>(null);

    const reservationsWithNames: ReservationWithNames[] = useMemo(() =>
            ReservationService.createReservationsWithNames(reservationsData, equipmentMap),
        [reservationsData, equipmentMap]
    );

    const filteredByStatus = useMemo(() =>
            hideCompleted
                ? reservationsWithNames.filter((r: ReservationWithNames) => 
                    // Ğ¡ĞºÑ€Ñ‹Ğ²Ğ°ĞµĞ¼ Ñ€ĞµĞ·ĞµÑ€Ğ²Ñ‹ ÑĞ¾ ÑÑ‚Ğ°Ñ‚ÑƒÑĞ°Ğ¼Ğ¸ 'fulfilled' (Ğ²Ñ‹Ğ´Ğ°Ğ½ Ğ² Ğ°Ñ€ĞµĞ½Ğ´Ñƒ) Ğ¸ 'cancelled' (Ğ¾Ñ‚Ğ¼ĞµĞ½ĞµĞ½)
                    r.status !== 'fulfilled' && r.status !== 'cancelled'
                )
                : reservationsWithNames,
        [hideCompleted, reservationsWithNames]
    );

    // Ğ¢ĞµĞ¿ĞµÑ€ÑŒ Ğ´Ğ°Ğ½Ğ½Ñ‹Ğµ ÑƒĞ¶Ğµ Ğ¾Ñ‚Ñ„Ğ¸Ğ»ÑŒÑ‚Ñ€Ğ¾Ğ²Ğ°Ğ½Ñ‹ Ğ¸ Ğ¾Ñ‚ÑĞ¾Ñ€Ñ‚Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ñ‹ Ğ½Ğ° ÑĞµÑ€Ğ²ĞµÑ€Ğµ
    const finalReservations = filteredByStatus;

    if (isLoadingReservations || isLoadingEquipment) {
        return <LoadingState />;
    }

    if (isReservationsError) {
        return <ErrorState message="ĞÑˆĞ¸Ğ±ĞºĞ° Ğ·Ğ°Ğ³Ñ€ÑƒĞ·ĞºĞ¸ Ñ€ĞµĞ·ĞµÑ€Ğ²Ğ¾Ğ²" />;
    }

    if (isEquipmentError) {
        return <ErrorState message="ĞÑˆĞ¸Ğ±ĞºĞ° Ğ·Ğ°Ğ³Ñ€ÑƒĞ·ĞºĞ¸ Ğ¾Ğ±Ğ¾Ñ€ÑƒĞ´Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ" />;
    }

    const cancelReservation = async (id: number) => {
        setDeletingId(id);
        try {
            await deleteReservation.mutateAsync(id);
        } catch (error) {
            console.error(`[MyReservationList] Error cancelling reservation ${id}:`, error);
            alert("ĞÑˆĞ¸Ğ±ĞºĞ° Ğ¿Ñ€Ğ¸ Ğ¾Ñ‚Ğ¼ĞµĞ½Ğµ Ñ€ĞµĞ·ĞµÑ€Ğ²Ğ°.");
        } finally {
            setDeletingId(null);
        }
    };

    const removeItemFromReservation = async (
        reservationId: number,
        equipmentIdToRemove: number
    ) => {
        const reservation = reservationsData.find((r: Reservation) => r.id === reservationId);
        if (!reservation) return;

        const newEquipmentIdsList = reservation.equipment_ids.filter((id: number) => id !== equipmentIdToRemove);
        try {
            if (newEquipmentIdsList.length === 0) {
                await deleteReservation.mutateAsync(reservationId);
            } else {
                await updateReservation.mutateAsync({
                    id: reservationId,
                    equipment_ids: newEquipmentIdsList,
                    start_date: reservation.start_date,
                    end_date: reservation.end_date,
                });
            }
        } catch (error) {
            console.error(`[MyReservationList] Error removing equipment from reservation:`, error);
            alert("ĞÑˆĞ¸Ğ±ĞºĞ° Ğ¿Ñ€Ğ¸ ÑƒĞ´Ğ°Ğ»ĞµĞ½Ğ¸Ğ¸ Ğ¿Ğ¾Ğ·Ğ¸Ñ†Ğ¸Ğ¸ Ğ¸Ğ· Ñ€ĞµĞ·ĞµÑ€Ğ²Ğ°.");
        }
    };

    const requestItemRemoval = (reservationId: number, equipmentId: number) => {
        setItemToRemove({ reservationId, equipmentId });
    };

    const confirmItemRemoval = () => {
        if (itemToRemove) {
            void removeItemFromReservation(itemToRemove.reservationId, itemToRemove.equipmentId)
                .finally(() => {
                    setItemToRemove(null);
                });
        }
    };

    const cancelItemRemoval = () => {
        setItemToRemove(null);
    };


    const repeatReservation = (r: ReservationWithNames) => {
        reserveStore.clear();
        const validEquipment = r.equipment_ids
            .map((id: number) => equipmentMap[id])
            .filter((eq): eq is Equipment => Boolean(eq));
        reserveStore.bulkAdd(validEquipment);
        dateStore.setRange(new Date(r.start_date), new Date(r.end_date));
        navigate("/", {
            state: {
                intent: "add_to_existing_reservation",
                reservationId: r.id,
                startDate: r.start_date,
                endDate: r.end_date,
                equipmentIds: r.equipment_ids
            }
        });
    };

    const renderedCards = finalReservations
        .map((r: ReservationWithNames) => {
            const equipmentListForCard = r.equipment_ids
                .map((id: number) => {
                    const eq = equipmentMap[id];
                    return eq ? { id, label: `${eq.equipment_type} ${eq.brand} ${eq.name}` } : null;
                })
                .filter((item): item is { id: number; label: string } => Boolean(item));

            if (r.equipment_ids.length === 0) {
                return null;
            }

            const autoStartEditForThisCard = r.id === continueEditingReservationId;

            return (
                <ReservationCard
                    key={`${r.id}-${r.equipment_ids.join('-')}-${r.start_date}-${r.end_date}`}
                    id={r.id}
                    start_date={r.start_date}
                    end_date={r.end_date}
                    status={r.status}
                    equipment={equipmentListForCard}
                    onCancel={() => cancelReservation(r.id)}
                    cancelDisabled={deletingId === r.id}
                    onRemoveItem={(equipmentId) => requestItemRemoval(r.id, equipmentId)}
                    onRepeat={() => repeatReservation(r)}
                    autoStartEdit={autoStartEditForThisCard}
                    total_cost={r.total_cost}
                    discount_amount={r.discount_amount}
                    promo_code={r.promo_code}
                    selected_accessories={r.selected_accessories}
                    accessory_links={r.accessory_links}
                    highlightId={highlightId}
                    rental_id={r.rental_id}
                />
            );
        })
        .filter(Boolean);

    const hasFilters = (filteredByStatus.length > 0) &&
        finalReservations.length === 0 &&
        reservationsData.length > 0;

    return (
        <div>
            <div className="mb-4 flex items-center gap-2">
                <Checkbox
                    id="hideCompleted"
                    checked={hideCompleted}
                    onCheckedChange={(checked) => setHideCompleted(Boolean(checked))}
                />
                <label htmlFor="hideCompleted" className="text-sm text-gray-700">
                    Ğ¡ĞºÑ€Ñ‹Ñ‚ÑŒ Ğ·Ğ°Ğ²ĞµÑ€ÑˆÑ‘Ğ½Ğ½Ñ‹Ğµ Ñ€ĞµĞ·ĞµÑ€Ğ²Ñ‹
                </label>
            </div>
            {renderedCards.length === 0 ? (
                <div className="my-8">
                    <div className="flex flex-col items-center justify-center text-center p-8 space-y-4 bg-gray-50/50 rounded-lg border-2 border-dashed">
                        {hasFilters ? <FilterX className="w-16 h-16 text-gray-400" /> : <FileText className="w-16 h-16 text-gray-400" />}
                        <div className="space-y-1">
                            <h3 className="text-lg font-semibold text-gray-800">
                                {hasFilters ? "Ğ ĞµĞ·ĞµÑ€Ğ²Ñ‹ Ğ½Ğµ Ğ½Ğ°Ğ¹Ğ´ĞµĞ½Ñ‹" : "Ğ£ Ğ²Ğ°Ñ Ğ¿Ğ¾ĞºĞ° Ğ½ĞµÑ‚ Ñ€ĞµĞ·ĞµÑ€Ğ²Ğ¾Ğ²"}
                            </h3>
                            <p className="text-sm text-gray-500">
                                {hasFilters
                                    ? "ĞĞ¸ Ğ¾Ğ´Ğ¸Ğ½ Ğ¸Ğ· Ğ²Ğ°ÑˆĞ¸Ñ… Ñ€ĞµĞ·ĞµÑ€Ğ²Ğ¾Ğ² Ğ½Ğµ ÑĞ¾Ğ¾Ñ‚Ğ²ĞµÑ‚ÑÑ‚Ğ²ÑƒĞµÑ‚ Ğ·Ğ°Ğ´Ğ°Ğ½Ğ½Ñ‹Ğ¼ Ñ„Ğ¸Ğ»ÑŒÑ‚Ñ€Ğ°Ğ¼."
                                    : "Ğ—Ğ´ĞµÑÑŒ Ğ±ÑƒĞ´ÑƒÑ‚ Ğ¾Ñ‚Ğ¾Ğ±Ñ€Ğ°Ğ¶Ğ°Ñ‚ÑŒÑÑ Ğ²Ğ°ÑˆĞ¸ Ğ±ÑƒĞ´ÑƒÑ‰Ğ¸Ğµ Ğ¸ Ğ¿Ñ€Ğ¾ÑˆĞ»Ñ‹Ğµ Ğ±Ñ€Ğ¾Ğ½Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ."}
                            </p>
                        </div>
                        {!hasFilters && (
                            <div className="mt-4">
                                <Button onClick={() => navigate("/")}>Ğ¡Ğ¾Ğ·Ğ´Ğ°Ñ‚ÑŒ Ğ¿ĞµÑ€Ğ²Ñ‹Ğ¹ Ñ€ĞµĞ·ĞµÑ€Ğ²</Button>
                            </div>
                        )}
                    </div>
                </div>
            ) : (
                <ul className="space-y-4">{renderedCards}</ul>
            )}

            <ConfirmItemRemovalDialog
                open={!!itemToRemove}
                onClose={cancelItemRemoval}
                onConfirm={confirmItemRemoval}
                isConfirming={updateReservation.isPending || deleteReservation.isPending}
            />
        </div>
    );
}

```


## <a name="srccomponentsNetworkStatustsx"></a>`src/components/NetworkStatus.tsx`

```tsx
// path: src/components/NetworkStatus.tsx

// src/components/NetworkStatus.tsx
import { useNetworkStatus } from "@/hooks/useNetworkStatus"
import { WifiOff, Wifi } from "lucide-react"

export default function NetworkStatus() {
    const isOnline = useNetworkStatus()

    return (
        <div
            className={`fixed bottom-4 left-4 z-50 text-xs font-medium px-3 py-1.5 rounded-md shadow-lg transition
      ${isOnline ? "bg-green-100 text-green-700 border border-green-300" : "bg-red-100 text-red-700 border border-red-300"}
      `}
        >
            <div className="flex items-center gap-2">
                {isOnline ? <Wifi className="w-4 h-4" /> : <WifiOff className="w-4 h-4" />}
                {isOnline ? "Ğ’ ÑĞµÑ‚Ğ¸" : "ĞĞµÑ‚ Ğ¿Ğ¾Ğ´ĞºĞ»ÑÑ‡ĞµĞ½Ğ¸Ñ"}
            </div>
        </div>
    )
}


```


## <a name="srccomponentsPromoCodeInputtsx"></a>`src/components/PromoCodeInput.tsx`

```tsx
// path: src/components/PromoCodeInput.tsx

// src/components/PromoCodeInput.tsx
import { Input } from "@/components/ui/input";
import { Button } from "@/components/ui/button";
import { Label } from "@/components/ui/label";
import { TicketPercent, CheckCircle, XCircle, Loader2, AlertTriangle } from "lucide-react";
import { toast } from "sonner";

interface PromoCodeInputProps {
    promoCode: string;
    setPromoCode: (code: string) => void;
    applyPromoCode: () => void;
    removePromoCode?: () => void;
    promoCodeMessage: string;
    disabled?: boolean;
    isLoading?: boolean;
    requirementMessage?: string;
}

export default function PromoCodeInput({
                                           promoCode,
                                           setPromoCode,
                                           applyPromoCode,
                                           removePromoCode,
                                           promoCodeMessage,
                                           disabled = false,
                                           isLoading = false,
                                           requirementMessage,
                                       }: PromoCodeInputProps) {

    const handleApply = () => {
        if (!promoCode.trim()) {
            toast.info("ĞŸĞ¾Ğ¶Ğ°Ğ»ÑƒĞ¹ÑÑ‚Ğ°, Ğ²Ğ²ĞµĞ´Ğ¸Ñ‚Ğµ Ğ¿Ñ€Ğ¾Ğ¼Ğ¾ĞºĞ¾Ğ´.");
            return;
        }
        applyPromoCode();
    };

    const isApplied = promoCodeMessage && promoCodeMessage.length > 0;
    const isSuccess = isApplied && promoCodeMessage.includes("ÑƒÑĞ¿ĞµÑˆĞ½Ğ¾");
    const isDisabledByRequirement = !!requirementMessage;

    return (
        <div className="space-y-2">
            <div className="flex justify-between items-center">
                <Label htmlFor="promo-code" className="text-sm font-medium">Ğ•ÑÑ‚ÑŒ Ğ¿Ñ€Ğ¾Ğ¼Ğ¾ĞºĞ¾Ğ´?</Label>
                {/* Ğ‘Ñ‹Ğ»Ğ¾: {isSuccess && removePromoCode && ( */}
                {/* Ğ¡Ñ‚Ğ°Ğ»Ğ¾: Ğ£ÑĞ»Ğ¾Ğ²Ğ¸Ğµ Ñ‚ĞµĞ¿ĞµÑ€ÑŒ Ğ·Ğ°Ğ²Ğ¸ÑĞ¸Ñ‚ Ğ¾Ñ‚ Ğ½Ğ°Ğ»Ğ¸Ñ‡Ğ¸Ñ Ñ‚ĞµĞºÑÑ‚Ğ° Ğ² Ğ¿Ğ¾Ğ»Ğµ Ğ¿Ñ€Ğ¾Ğ¼Ğ¾ĞºĞ¾Ğ´Ğ° */}
                {promoCode && removePromoCode && (
                    <button onClick={removePromoCode} className="text-xs text-gray-500 hover:text-red-600 hover:underline">Ğ¡Ğ±Ñ€Ğ¾ÑĞ¸Ñ‚ÑŒ</button>
                )}
            </div>
            <div className="flex items-center gap-2">
                <div className="relative flex-grow">
                    <TicketPercent className="absolute left-2.5 top-2.5 h-4 w-4 text-gray-400" />
                    <Input
                        id="promo-code"
                        type="text"
                        placeholder="SALE15"
                        value={promoCode}
                        onChange={(e) => setPromoCode(e.target.value)}
                        disabled={disabled || isLoading || isSuccess || isDisabledByRequirement}
                        className="pl-8"
                    />
                    {isSuccess && promoCode && (
                        <CheckCircle className="absolute right-2.5 top-2.5 h-4 w-4 text-green-500" />
                    )}
                </div>
                <Button
                    type="button"
                    variant="outline"
                    onClick={handleApply}
                    disabled={disabled || isLoading || isSuccess || isDisabledByRequirement}
                >
                    {isLoading ? <Loader2 className="h-4 w-4 animate-spin" /> : "ĞŸÑ€Ğ¸Ğ¼ĞµĞ½Ğ¸Ñ‚ÑŒ"}
                </Button>
            </div>

            {isDisabledByRequirement && (
                <div className="flex items-center gap-1.5 text-xs mt-1.5 text-orange-600">
                    <AlertTriangle className="h-4 w-4" />
                    <span>{requirementMessage}</span>
                </div>
            )}

            {!isDisabledByRequirement && isApplied && (
                <div className={`flex items-center gap-1.5 text-xs mt-1.5 ${isSuccess ? "text-green-600" : "text-red-600"}`}>
                    {!isSuccess && <XCircle className="h-3.5 w-3.5" />}
                    <span>{promoCodeMessage}</span>
                </div>
            )}
        </div>
    );
}

```


## <a name="srccomponentsRequireAuthtsx"></a>`src/components/RequireAuth.tsx`

```tsx
// path: src/components/RequireAuth.tsx

import { ReactNode } from "react"
import { Navigate, useLocation } from "react-router-dom"
import { useCurrentUser } from "@/hooks/useProfile"

type Props = {
    children: ReactNode
    role?: string | string[] // Ğ”Ğ¾Ğ±Ğ°Ğ²Ğ»ĞµĞ½ Ğ¿Ñ€Ğ¾Ğ¿Ñ role
}

export default function RequireAuth({ children, role }: Props) {
    const { data: user, isLoading } = useCurrentUser()
    const location = useLocation()

    if (isLoading) {
        return <p>Ğ—Ğ°Ğ³Ñ€ÑƒĞ·ĞºĞ° Ğ¿Ñ€Ğ¾Ñ„Ğ¸Ğ»Ñ...</p>
    }
    if (!user) {
        return <Navigate to="/" replace state={{ from: location.pathname }} />
    }
    // Ğ”Ğ¾Ğ±Ğ°Ğ²Ğ»ĞµĞ½Ğ° Ğ¿Ñ€Ğ¾Ğ²ĞµÑ€ĞºĞ° Ñ€Ğ¾Ğ»Ğ¸
    if (role && !(Array.isArray(role) ? role.includes(user.role) : user.role === role)) {
        return <Navigate to="/" replace state={{ from: location.pathname }} />
    }

    return <>{children}</>
}


```


## <a name="srccomponentsReservationCardtsx"></a>`src/components/ReservationCard.tsx`

```tsx
// path: src/components/ReservationCard.tsx

// src/components/ReservationCard.tsx
import { useEffect, useMemo, useState } from "react";
import { useNavigate, useLocation } from "react-router-dom";
import { ReservationEditProvider } from "@/hooks/useInlineReservationEdit"; // âœ¨ Ğ˜Ğ¼Ğ¿Ğ¾Ñ€Ñ‚Ğ¸Ñ€ÑƒĞµĞ¼ Ğ¿Ñ€Ğ¾Ğ²Ğ°Ğ¹Ğ´ĞµÑ€
import EditableReservationCard from "./reservation/EditableReservationCard";
import ViewReservationCard from "./reservation/ViewReservationCard";
import type { Reservation, AccessoryLink } from "@/types/reservation";
import type { EquipmentDisplayDetail } from "@/hooks/reservation/useReservationState";

type Props = {
    id: number;
    equipment: EquipmentDisplayDetail[];
    start_date: string;
    end_date: string;
    status: Reservation['status'];
    onRemoveItem?: (equipmentId: number) => void;
    onCancel?: () => void;
    cancelDisabled?: boolean;
    onRepeat?: () => void;
    autoStartEdit?: boolean;
    total_cost?: number;
    discount_amount?: number;
    promo_code?: string | null;
    selected_accessories?: Record<number, number[]>;
    accessory_links?: AccessoryLink[];
    highlightId?: number | null;
    rental_id?: number | null;
};

export default function ReservationCard({
                                            id, equipment, start_date, end_date, status, onRemoveItem, onCancel,
                                            cancelDisabled, onRepeat, autoStartEdit = false,
                                            total_cost, discount_amount, promo_code, selected_accessories,
                                            accessory_links, highlightId, rental_id
                                        }: Props) {
    const navigate = useNavigate();
    const location = useLocation();

    // âœ¨ 1. Ğ£Ğ¿Ñ€Ğ°Ğ²Ğ»ÑĞµĞ¼ ÑĞ¾ÑÑ‚Ğ¾ÑĞ½Ğ¸ĞµĞ¼ Ñ€ĞµĞ´Ğ°ĞºÑ‚Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ Ğ¿Ñ€ÑĞ¼Ğ¾ Ğ·Ğ´ĞµÑÑŒ.
    const [isEditing, setIsEditing] = useState(autoStartEdit);
    const [hasAutoStarted, setHasAutoStarted] = useState(false);

    // Ğ­Ñ‚Ğ¾Ñ‚ Ğ¾Ğ±ÑŠĞµĞºÑ‚ Ğ²ÑĞµ ĞµÑ‰Ğµ Ğ½ÑƒĞ¶ĞµĞ½ Ğ´Ğ»Ñ Ğ¿ĞµÑ€ĞµĞ´Ğ°Ñ‡Ğ¸ Ğ² Ğ¿Ñ€Ğ¾Ğ²Ğ°Ğ¹Ğ´ĞµÑ€.
    const reservationForProvider: Reservation = useMemo(() => ({
        id, equipment_ids: equipment.map(e => e.id), start_date, end_date, status,
        total_cost, discount_amount, promo_code,
        selected_accessories: selected_accessories || {},
    }), [id, equipment, start_date, end_date, status, total_cost, discount_amount, promo_code, selected_accessories]);

    useEffect(() => {
        if (autoStartEdit && !isEditing && !hasAutoStarted) {
            setIsEditing(true);
            setHasAutoStarted(true);
        }
    }, [autoStartEdit, isEditing, hasAutoStarted]);


    // âœ¨ 2. ĞœÑ‹ Ğ±Ğ¾Ğ»ÑŒÑˆĞµ Ğ½Ğµ Ğ¸ÑĞ¿Ğ¾Ğ»ÑŒĞ·ÑƒĞµĞ¼ Ñ…ÑƒĞº useInlineReservationEdit Ğ½Ğ°Ğ¿Ñ€ÑĞ¼ÑƒÑ Ğ·Ğ´ĞµÑÑŒ.
    // Ğ’Ğ¼ĞµÑÑ‚Ğ¾ ÑÑ‚Ğ¾Ğ³Ğ¾ Ğ¼Ñ‹ ÑƒĞ¿Ñ€Ğ°Ğ²Ğ»ÑĞµĞ¼ ÑĞ¾ÑÑ‚Ğ¾ÑĞ½Ğ¸ĞµĞ¼ isEditing Ğ¸ Ñ€ĞµĞ½Ğ´ĞµÑ€Ğ¸Ğ¼ Ğ»Ğ¸Ğ±Ğ¾ View, Ğ»Ğ¸Ğ±Ğ¾ Provider+Edit.

    const isHighlighted = highlightId === id;

    return (
        <div className={`transition-all duration-300 ${
            isHighlighted 
                ? "ring-2 ring-sky-500 bg-sky-50 shadow-lg rounded-2xl" 
                : ""
        }`}>
            {isEditing ? (
                // âœ¨ 3. ĞĞ±Ğ¾Ñ€Ğ°Ñ‡Ğ¸Ğ²Ğ°ĞµĞ¼ ĞºĞ¾Ğ¼Ğ¿Ğ¾Ğ½ĞµĞ½Ñ‚ Ñ€ĞµĞ´Ğ°ĞºÑ‚Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ Ğ² Ğ½Ğ°Ñˆ Ğ½Ğ¾Ğ²Ñ‹Ğ¹ Ğ¿Ñ€Ğ¾Ğ²Ğ°Ğ¹Ğ´ĞµÑ€.
                <ReservationEditProvider
                    reservation={reservationForProvider}
                    initialEquipmentForDisplay={equipment}
                    onFullCancellation={onCancel}
                    isAdminContext={false}
                    // âœ¨ 4. ĞŸĞµÑ€ĞµĞ´Ğ°ĞµĞ¼ ĞºĞ¾Ğ»Ğ±ÑĞº Ğ´Ğ»Ñ Ğ·Ğ°Ğ²ĞµÑ€ÑˆĞµĞ½Ğ¸Ñ Ñ€ĞµĞ´Ğ°ĞºÑ‚Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ.
                    onFinishEditing={() => {
                        setIsEditing(false);
                        // Ğ•ÑĞ»Ğ¸ ÑÑ‚Ğ¾ Ğ±Ñ‹Ğ»Ğ¾ Ğ°Ğ²Ñ‚Ğ¾Ğ¼Ğ°Ñ‚Ğ¸Ñ‡ĞµÑĞºĞ¾Ğµ Ñ€ĞµĞ´Ğ°ĞºÑ‚Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ, Ñ‡Ğ¸ÑÑ‚Ğ¸Ğ¼ ÑÑ‚ĞµĞ¹Ñ‚ Ğ² location
                        if (autoStartEdit) {
                            navigate(location.pathname, { replace: true, state: {} });
                        }
                    }}
                >
                    {/* EditableReservationCard Ñ‚ĞµĞ¿ĞµÑ€ÑŒ Ğ½Ğµ Ğ¿Ñ€Ğ¸Ğ½Ğ¸Ğ¼Ğ°ĞµÑ‚ Ğ¿Ñ€Ğ¾Ğ¿ÑĞ¾Ğ²! */}
                    <EditableReservationCard />
                </ReservationEditProvider>
            ) : (
                <ViewReservationCard
                    id={id}
                    equipment={equipment}
                    start_date={start_date}
                    end_date={end_date}
                    status={status}
                    // âœ¨ 5. ĞšĞ½Ğ¾Ğ¿ĞºĞ° "Ğ ĞµĞ´Ğ°ĞºÑ‚Ğ¸Ñ€Ğ¾Ğ²Ğ°Ñ‚ÑŒ" Ñ‚ĞµĞ¿ĞµÑ€ÑŒ Ğ¿Ñ€Ğ¾ÑÑ‚Ğ¾ Ğ¿ĞµÑ€ĞµĞºĞ»ÑÑ‡Ğ°ĞµÑ‚ Ğ»Ğ¾ĞºĞ°Ğ»ÑŒĞ½Ğ¾Ğµ ÑĞ¾ÑÑ‚Ğ¾ÑĞ½Ğ¸Ğµ.
                    onEdit={status === 'active' ? () => setIsEditing(true) : undefined}
                    onCancel={onCancel}
                    onRemoveItem={onRemoveItem}
                    onRepeat={onRepeat}
                    cancelDisabled={cancelDisabled}
                    total_cost={total_cost}
                    discount_amount={discount_amount}
                    promo_code={promo_code}
                    accessory_links={accessory_links}
                    rental_id={rental_id}
                />
            )}

            {/* Ğ”Ğ¸Ğ°Ğ»Ğ¾Ğ³ Ğ¿Ğ¾Ğ´Ñ‚Ğ²ĞµÑ€Ğ¶Ğ´ĞµĞ½Ğ¸Ñ ÑƒĞ´Ğ°Ğ»ĞµĞ½Ğ¸Ñ Ğ¾ÑÑ‚Ğ°ĞµÑ‚ÑÑ Ğ·Ğ´ĞµÑÑŒ, Ñ‚.Ğº. Ğ¾Ğ½ ÑĞ²ÑĞ·Ğ°Ğ½ Ñ ViewReservationCard */}
            {/* Ğ•Ğ³Ğ¾ Ğ»Ğ¾Ğ³Ğ¸ĞºĞ° Ğ±ÑƒĞ´ĞµÑ‚ Ğ¿ĞµÑ€ĞµÑĞ¼Ğ¾Ñ‚Ñ€ĞµĞ½Ğ°, ĞµÑĞ»Ğ¸ Ğ¿Ğ¾Ñ‚Ñ€ĞµĞ±ÑƒĞµÑ‚ÑÑ Ğ² Ñ€ĞµĞ¶Ğ¸Ğ¼Ğµ Ñ€ĞµĞ´Ğ°ĞºÑ‚Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ */}
            {/* <ConfirmItemRemovalDialog ... />  <- Ğ¼Ğ¾Ğ¶Ğ½Ğ¾ Ğ¿Ğ¾ĞºĞ° Ğ¾ÑÑ‚Ğ°Ğ²Ğ¸Ñ‚ÑŒ Ğ¸Ğ»Ğ¸ Ğ·Ğ°ĞºĞ¾Ğ¼Ğ¼ĞµĞ½Ñ‚Ğ¸Ñ€Ğ¾Ğ²Ğ°Ñ‚ÑŒ */}
        </div>
    );
}

```


## <a name="srccomponentsReservationFootertsx"></a>`src/components/ReservationFooter.tsx`

```tsx
// path: src/components/ReservationFooter.tsx

// src/components/ReservationFooter.tsx

import { Button } from "@/components/ui/button";
import { ArrowRight, X } from "lucide-react";

interface ReservationFooterProps {
    selectedCount: number;
    onClick: () => void;
    // âœ… Ğ”Ğ¾Ğ±Ğ°Ğ²Ğ»ÑĞµĞ¼ Ğ½Ğ¾Ğ²Ğ¾Ğµ ÑĞ²Ğ¾Ğ¹ÑÑ‚Ğ²Ğ¾ Ğ´Ğ»Ñ ÑĞ±Ñ€Ğ¾ÑĞ°
    onReset: () => void;
    isEditingMode: boolean;
    intent?: string;
}

export default function ReservationFooter({ selectedCount, onClick, onReset, isEditingMode, intent }: ReservationFooterProps) {
    if (selectedCount === 0) {
        return null;
    }

    const buttonText = isEditingMode && intent !== "add_to_new_reservation"
        ? `âœ”ï¸ Ğ”Ğ¾Ğ±Ğ°Ğ²Ğ¸Ñ‚ÑŒ Ğº Ñ€ĞµĞ·ĞµÑ€Ğ²Ñƒ (${selectedCount})`
        : `ğŸ“¥ ĞÑ„Ğ¾Ñ€Ğ¼Ğ¸Ñ‚ÑŒ (${selectedCount})`;

    return (
        <div className="fixed bottom-0 left-0 right-0 z-50 p-4 bg-background/90 backdrop-blur-sm border-t border-border shadow-[0_-4px_15px_rgba(0,0,0,0.08)]">
            <div className="max-w-7xl mx-auto flex justify-between items-center">
                {/* âœ… ĞĞ¾Ğ²Ğ°Ñ ĞºĞ½Ğ¾Ğ¿ĞºĞ° "Ğ¡Ğ±Ñ€Ğ¾ÑĞ¸Ñ‚ÑŒ Ğ²Ñ‹Ğ±Ğ¾Ñ€" ÑĞ»ĞµĞ²Ğ° */}
                <Button
                    onClick={onReset}
                    variant="destructive"
                    size="lg"
                    className="flex items-center gap-2"
                >
                    <X className="h-5 w-5" />
                    Ğ¡Ğ±Ñ€Ğ¾ÑĞ¸Ñ‚ÑŒ Ğ²Ñ‹Ğ±Ğ¾Ñ€
                </Button>

                {/* Ğ‘Ğ»Ğ¾Ğº Ñ Ğ¸Ğ½Ñ„Ğ¾Ñ€Ğ¼Ğ°Ñ†Ğ¸ĞµĞ¹ Ğ¸ Ğ¾ÑĞ½Ğ¾Ğ²Ğ½Ğ¾Ğ¹ ĞºĞ½Ğ¾Ğ¿ĞºĞ¾Ğ¹ ÑĞ¿Ñ€Ğ°Ğ²Ğ° */}
                <div className="flex items-center gap-4">
                    <div className="text-sm text-foreground">
                        <span className="font-semibold">Ğ’Ñ‹Ğ±Ñ€Ğ°Ğ½Ğ¾ Ğ´Ğ»Ñ Ñ€ĞµĞ·ĞµÑ€Ğ²Ğ°:</span>
                        <span className="ml-2 font-bold text-lg">{selectedCount} Ğ¿Ğ¾Ğ·.</span>
                    </div>
                    <Button
                        onClick={onClick}
                        size="lg"
                        className="bg-green-600 hover:bg-green-700 text-white shadow-lg flex items-center gap-2"
                    >
                        {buttonText}
                        <ArrowRight className="h-5 w-5" />
                    </Button>
                </div>
            </div>
        </div>
    );
}

```


## <a name="srccomponentsReservationListtsx"></a>`src/components/ReservationList.tsx`

```tsx
// path: src/components/ReservationList.tsx

import { useReserveSubmission } from "@/hooks/reservation/submission/useReserveSubmission"
import type { Equipment } from "@/types/equipment"

export default function ReservationList() {
    const {
        items,
        unavailableIdsFromAPI,
        submitMessage,
        reservationSuccess,
        removeItemFromStore,
        clearReserveStore,
        handleSubmit,
    } = useReserveSubmission()

    if (items.length === 0) return null

    return (
        <div className="mt-6 p-4 border rounded bg-white shadow-sm max-w-2xl mx-auto">
            <h2 className="text-lg font-bold mb-4">Ğ’Ñ‹Ğ±Ñ€Ğ°Ğ½Ğ½Ğ¾Ğµ Ğ¾Ğ±Ğ¾Ñ€ÑƒĞ´Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ:</h2>

            <ul className="space-y-2 mb-4">
                {items.map((item: Equipment) => (
                    <li
                        key={item.id}
                        className={`flex justify-between items-center border-b pb-1 ${
                            unavailableIdsFromAPI.includes(item.id) ? "bg-red-50 border-red-600" : ""
                        }`}
                    >
                        <div>
                            <p className="font-medium">{item.name}</p>
                            <p className="text-sm text-gray-500">
                                {item.brand} â€¢ {item.equipment_type}
                            </p>
                            {unavailableIdsFromAPI.includes(item.id) && (
                                <p className="text-xs text-red-600 pt-1">
                                    Ğ­Ñ‚Ğ¾ Ğ¾Ğ±Ğ¾Ñ€ÑƒĞ´Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ ÑÑ‚Ğ°Ğ»Ğ¾ Ğ½ĞµĞ´Ğ¾ÑÑ‚ÑƒĞ¿Ğ½Ñ‹Ğ¼
                                </p>
                            )}
                        </div>
                        <button
                            onClick={() => removeItemFromStore(item.id)}
                            className="text-red-600 hover:underline text-sm"
                        >
                            Ğ£Ğ´Ğ°Ğ»Ğ¸Ñ‚ÑŒ
                        </button>
                    </li>
                ))}
            </ul>

            <div className="flex justify-between items-center">
                <button
                    onClick={clearReserveStore}
                    className="text-gray-600 hover:underline text-sm"
                >
                    ĞÑ‡Ğ¸ÑÑ‚Ğ¸Ñ‚ÑŒ Ğ²ÑÑ‘
                </button>
                <button
                    onClick={handleSubmit}
                    className="bg-sky-700 text-white px-4 py-2 rounded hover:bg-sky-800 text-sm font-medium"
                    disabled={unavailableIdsFromAPI.length > 0}
                >
                    ğŸ“¤ ĞÑ‚Ğ¿Ñ€Ğ°Ğ²Ğ¸Ñ‚ÑŒ Ñ€ĞµĞ·ĞµÑ€Ğ²
                </button>
            </div>

            {submitMessage && (
                <p
                    className={`text-sm mt-3 text-center ${
                        reservationSuccess ? "text-green-700" : "text-red-600"
                    }`}
                >
                    {submitMessage}
                </p>
            )}
        </div>
    )
}


```


## <a name="srccomponentsReserveEquipmentCardtsx"></a>`src/components/ReserveEquipmentCard.tsx`

```tsx
// path: src/components/ReserveEquipmentCard.tsx

// src/components/ReserveEquipmentCard.tsx
import { useState } from "react";
import { Trash2, Paperclip, ChevronDown } from "lucide-react";
import { Checkbox } from "@/components/ui/checkbox";
import { Label } from "@/components/ui/label";
import type { Equipment } from "@/types/equipment";
import type { AvailabilityInfo, EquipmentStatus } from "@/types/availability";
import { Card, CardContent } from "@/components/ui/card";
import { formatDateRangeEuropean } from "@/lib/utils";

type Props = {
    equipment: Equipment;
    availability?: AvailabilityInfo;
    onRemove: (id: number) => void;
    // âœ… Ğ”ĞĞ‘ĞĞ’Ğ›Ğ•ĞĞ« ĞĞĞ’Ğ«Ğ• Ğ¡Ğ’ĞĞ™Ğ¡Ğ¢Ğ’Ğ
    isAccessorySelected: (equipmentId: number, accessoryId: number) => boolean;
    onToggleAccessory: (equipmentId: number, accessoryId: number) => void;
};

const statusTextMap: Record<EquipmentStatus | string, string> = {
    available: "Ğ¡Ğ²Ğ¾Ğ±Ğ¾Ğ´Ğ½Ğ¾",
    reserved: "Ğ’ Ñ€ĞµĞ·ĞµÑ€Ğ²Ğµ (Ğ´Ñ€ÑƒĞ³Ğ¸Ğ¼)",
    rented: "Ğ’ Ğ°Ñ€ĞµĞ½Ğ´Ğµ (Ğ´Ñ€ÑƒĞ³Ğ¸Ğ¼)",
    my_reservation: "Ğ’ ÑÑ‚Ğ¾Ğ¼ Ñ€ĞµĞ·ĞµÑ€Ğ²Ğµ",
};

const statusColorMap: Record<EquipmentStatus | string, string> = {
    available: "text-green-600",
    reserved: "text-rose-500",
    rented: "text-red-600",
    my_reservation: "text-sky-700",
};

const bgColorMap: Record<EquipmentStatus | string, string> = {
    available: "bg-white",
    reserved: "bg-rose-50 border-rose-200",
    rented: "bg-rose-100 border-rose-300",
    my_reservation: "bg-sky-50 border-sky-200",
};

function formatDateRange(start?: string, end?: string) {
    if (!start || !end) return "";
    return `(${formatDateRangeEuropean(start, end)})`;
}

export default function ReserveEquipmentCard({
                                                 equipment,
                                                 availability,
                                                 onRemove,
                                                 // âœ… ĞŸĞĞ›Ğ£Ğ§ĞĞ•Ğœ ĞĞĞ’Ğ«Ğ• Ğ¡Ğ’ĞĞ™Ğ¡Ğ¢Ğ’Ğ
                                                 isAccessorySelected,
                                                 onToggleAccessory
                                             }: Props) {
    const status = availability?.status ?? "available";
    const statusText = statusTextMap[status] || "ĞĞµĞ¸Ğ·Ğ²ĞµÑÑ‚Ğ½Ñ‹Ğ¹ ÑÑ‚Ğ°Ñ‚ÑƒÑ";
    const colorClass = statusColorMap[status] || "text-gray-500";
    const bgClass = bgColorMap[status] || "bg-gray-50";
    const dateRange = (status === "reserved" || status === "rented")
        ? formatDateRange(availability?.start_date, availability?.end_date)
        : "";
    const isExternalConflict = status === "reserved" || status === "rented";

    // âœ… Ğ¡ĞĞ¡Ğ¢ĞĞ¯ĞĞ˜Ğ• Ğ”Ğ›Ğ¯ ĞĞ¢ĞĞ‘Ğ ĞĞ–Ğ•ĞĞ˜Ğ¯ Ğ¡ĞŸĞ˜Ğ¡ĞšĞ ĞĞšĞ¡Ğ•Ğ¡Ğ¡Ğ£ĞĞ ĞĞ’
    const [showAccessories, setShowAccessories] = useState(false);

    return (
        <Card
            className={`rounded-xl px-4 py-4 sm:px-6 shadow-sm transition border w-full flex flex-col ${bgClass}`}
        >
            <CardContent className="p-0 flex-1 flex flex-col sm:flex-row justify-between items-start gap-4">
                <div className="flex-1">
                    <h3 className="text-base sm:text-lg font-semibold mb-1">{equipment.name}</h3>
                    <p className="text-xs sm:text-sm text-gray-500 mb-1">
                        {equipment.brand} â€¢ {equipment.equipment_type}
                    </p>
                    <p className="text-xs sm:text-sm mb-1">
                        Ğ¡Ğ¾ÑÑ‚Ğ¾ÑĞ½Ğ¸Ğµ: <strong>{equipment.condition}</strong>
                    </p>
                    <p className="text-sm sm:text-base font-bold mb-1">{equipment.daily_rate} â‚½ / Ğ´ĞµĞ½ÑŒ</p>

                    <p className={`text-sm font-semibold mt-2 ${colorClass}`}>
                        {statusText}
                        {dateRange && <span className="ml-1 text-xs font-normal">{dateRange}</span>}
                    </p>

                    {/* âœ… ĞĞĞ§ĞĞ›Ğ Ğ‘Ğ›ĞĞšĞ Ğ’Ğ«Ğ‘ĞĞ Ğ ĞĞšĞ¡Ğ•Ğ¡Ğ¡Ğ£ĞĞ ĞĞ’ */}
                    {equipment.accessories && equipment.accessories.length > 0 && (
                        <div className="mt-3 border-t pt-3">
                            <button
                                className="w-full flex justify-between items-center text-sm font-medium text-gray-600 hover:text-sky-700 p-1 -m-1 rounded"
                                onClick={() => setShowAccessories(prev => !prev)}
                            >
                                <span className="flex items-center gap-2">
                                    <Paperclip className="w-4 h-4" />
                                    Ğ”Ğ¾Ğ±Ğ°Ğ²Ğ¸Ñ‚ÑŒ Ğ°ĞºÑĞµÑÑÑƒĞ°Ñ€Ñ‹ ({equipment.accessories.length})
                                </span>
                                <ChevronDown className={`w-5 h-5 transition-transform ${showAccessories ? 'rotate-180' : ''}`} />
                            </button>
                            {showAccessories && (
                                <div className="mt-2 space-y-2 pl-1 animate-in fade-in-0 slide-in-from-top-2 duration-300">
                                    {equipment.accessories.map(acc => (
                                        <div key={acc.id} className="flex items-center justify-between p-1 rounded hover:bg-gray-50">
                                            <Label htmlFor={`reserve-acc-${equipment.id}-${acc.id}`} className="flex items-center gap-2 text-xs font-normal cursor-pointer">
                                                <Checkbox
                                                    id={`reserve-acc-${equipment.id}-${acc.id}`}
                                                    checked={isAccessorySelected(equipment.id, acc.id)}
                                                    onCheckedChange={() => onToggleAccessory(equipment.id, acc.id)}
                                                />
                                                {acc.name}
                                            </Label>
                                            <span className="text-xs text-gray-500">{acc.price} â‚½</span>
                                        </div>
                                    ))}
                                </div>
                            )}
                        </div>
                    )}
                    {/* âœ… ĞšĞĞĞ•Ğ¦ Ğ‘Ğ›ĞĞšĞ Ğ’Ğ«Ğ‘ĞĞ Ğ ĞĞšĞ¡Ğ•Ğ¡Ğ¡Ğ£ĞĞ ĞĞ’ */}
                </div>

                <button
                    onClick={() => onRemove(equipment.id)}
                    className={`rounded px-2 py-1 sm:px-3 text-xs sm:text-sm font-medium flex items-center gap-1 mt-1 self-start sm:self-center 
                        ${isExternalConflict
                        ? "bg-red-500 text-white hover:bg-red-600"
                        : "bg-slate-500 text-white hover:bg-slate-600"
                    }`}
                    title="Ğ£Ğ´Ğ°Ğ»Ğ¸Ñ‚ÑŒ Ğ¸Ğ· Ñ€ĞµĞ·ĞµÑ€Ğ²Ğ°"
                >
                    <Trash2 size={14} className="sm:size-4" />
                    Ğ£Ğ´Ğ°Ğ»Ğ¸Ñ‚ÑŒ
                </button>
            </CardContent>
        </Card>
    );
}

```


## <a name="srccomponentsSearchInputtsx"></a>`src/components/SearchInput.tsx`

```tsx
// path: src/components/SearchInput.tsx

import { useSearchStore } from "../store/searchStore"
import { Input } from "@/components/ui/input"

export default function SearchInput() {
  const { query, setQuery } = useSearchStore()

  return (
    <Input
      type="text"
      placeholder="ĞŸĞ¾Ğ¸ÑĞº Ğ¿Ğ¾ Ğ½Ğ°Ğ·Ğ²Ğ°Ğ½Ğ¸Ñ..."
      value={query}
      onChange={(e) => setQuery(e.target.value)}
      className="w-full max-w-sm"
    />
  )
}


```


## <a name="srccomponentsStatusBadgetsx"></a>`src/components/StatusBadge.tsx`

```tsx
// path: src/components/StatusBadge.tsx

export default function StatusBadge({ status }: { status: "active" | "past" }) {
    const isActive = status === "active"
    return (
        <span
            className={`text-xs font-medium px-2 py-1 rounded-full inline-block
        ${isActive
                ? "bg-green-100 text-green-700 border border-green-300"
                : "bg-gray-100 text-gray-500 border border-gray-300"
            }`}
        >
      {isActive ? "ĞĞºÑ‚Ğ¸Ğ²ĞµĞ½" : "Ğ—Ğ°Ğ²ĞµÑ€ÑˆÑ‘Ğ½"}
    </span>
    )
}


```


## <a name="srccomponentsTypeFiltertsx"></a>`src/components/TypeFilter.tsx`

```tsx
// path: src/components/TypeFilter.tsx

// src/components/TypeFilter.tsx
import { ToggleGroup, ToggleGroupItem } from "@/components/ui/toggle-group"
import { useFilterStore } from "@/store/filterStore"
import { useMemo, type ReactNode } from "react"
import type { Equipment } from "@/types/equipment"
import { getFilterToggleClass } from "@/components/ui/filter-toggle"
import {
    Camera,
    Aperture,
    Lightbulb,
    Mic,
    Video,
    Grip,
    Headphones,
    Laptop,
    Package,
    List,
} from "lucide-react"

// Ğ’ÑĞ¿Ğ¾Ğ¼Ğ¾Ğ³Ğ°Ñ‚ĞµĞ»ÑŒĞ½Ğ°Ñ Ñ„ÑƒĞ½ĞºÑ†Ğ¸Ñ Ğ´Ğ»Ñ ÑĞ¾Ğ¿Ğ¾ÑÑ‚Ğ°Ğ²Ğ»ĞµĞ½Ğ¸Ñ Ñ‚Ğ¸Ğ¿Ğ° Ğ¾Ğ±Ğ¾Ñ€ÑƒĞ´Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ Ñ Ğ¸ĞºĞ¾Ğ½ĞºĞ¾Ğ¹
const getIconForType = (type: string): ReactNode => {
    const iconMap: Record<string, ReactNode> = {
        "Ğ¤Ğ¾Ñ‚Ğ¾ĞºĞ°Ğ¼ĞµÑ€Ğ°": <Camera />,
        "ĞĞ±ÑŠĞµĞºÑ‚Ğ¸Ğ²": <Aperture />,
        "Ğ¡Ğ²ĞµÑ‚": <Lightbulb />,
        "ĞœĞ¸ĞºÑ€Ğ¾Ñ„Ğ¾Ğ½": <Mic />,
        "Ğ­ĞºÑˆĞ½ ĞºĞ°Ğ¼ĞµÑ€Ğ°": <Video />,
        "Ğ¨Ñ‚Ğ°Ñ‚Ğ¸Ğ²Ñ‹": <Grip />,
        "ĞÑƒĞ´Ğ¸Ğ¾Ğ¾Ğ±Ğ¾Ñ€ÑƒĞ´Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ": <Headphones />,
        "ĞšĞ¾Ğ¼Ğ¿ÑŒÑÑ‚ĞµÑ€Ğ½Ğ°Ñ Ñ‚ĞµÑ…Ğ½Ğ¸ĞºĞ°": <Laptop />,
        "ĞŸÑ€Ğ¾Ñ‡ĞµĞµ": <Package />,
    }
    // Ğ’Ğ¾Ğ·Ğ²Ñ€Ğ°Ñ‰Ğ°ĞµĞ¼ ÑĞ¾Ğ¾Ñ‚Ğ²ĞµÑ‚ÑÑ‚Ğ²ÑƒÑÑ‰ÑƒÑ Ğ¸ĞºĞ¾Ğ½ĞºÑƒ Ğ¸Ğ»Ğ¸ null, ĞµÑĞ»Ğ¸ ÑĞ¾Ğ²Ğ¿Ğ°Ğ´ĞµĞ½Ğ¸Ñ Ğ½Ğµ Ğ½Ğ°Ğ¹Ğ´ĞµĞ½Ñ‹
    return iconMap[type] || null
}

interface TypeFilterProps {
    items: Equipment[]
}

export default function TypeFilter({ items }: TypeFilterProps) {
    const { type, setType } = useFilterStore()

    const types = useMemo(() => {
        const uniqueTypes = new Set(items.map((eq) => eq.equipment_type))
        return Array.from(uniqueTypes)
    }, [items])

    return (
        <ToggleGroup
            type="single"
            value={type ?? "__all__"}
            onValueChange={(val: string) => setType(val === "__all__" ? null : val)}
            className="flex flex-wrap gap-2"
        >
            <ToggleGroupItem
                value="__all__"
                className={getFilterToggleClass()}
            >
                <List />
                Ğ’ÑĞµ
            </ToggleGroupItem>

            {types.map((t) => (
                <ToggleGroupItem
                    key={t}
                    value={t}
                    className={getFilterToggleClass()}
                >
                    {getIconForType(t)}
                    {t}
                </ToggleGroupItem>
            ))}
        </ToggleGroup>
    )
}

```


## <a name="srccomponentsUserInfoBlocktsx"></a>`src/components/UserInfoBlock.tsx`

```tsx
// path: src/components/UserInfoBlock.tsx

// src/components/UserInfoBlock.tsx
import { Button } from "@/components/ui/button";
import { useNavigate, useLocation } from "react-router-dom";
import { useCurrentUser } from "@/hooks/useProfile";
import { useAuthStore } from "@/store/authStore";
import {
    Shield,
    Calendar,
    Edit,
    FileText,
    LogOut,
    Settings,
    HelpCircle,
    AlertTriangle,
    Send
} from "lucide-react";

type Props = {
    onEditProfile?: () => void;
    showExtraLinks?: boolean;
};

export default function UserInfoBlock({ onEditProfile, showExtraLinks = false }: Props) {
    const { data: user, isLoading, isError } = useCurrentUser();
    const { logout } = useAuthStore();
    const navigate = useNavigate();
    const location = useLocation();

    if (isLoading) {
        return (
            <div className="w-full">
                <div className="bg-gradient-to-r from-white to-gray-50 border border-gray-200 rounded-lg shadow-sm p-4">
                    <p className="text-center text-sm text-gray-500">Ğ—Ğ°Ğ³Ñ€ÑƒĞ·ĞºĞ°...</p>
                </div>
            </div>
        );
    }

    if (isError || !user) {
        return (
            <div className="w-full">
                <div className="bg-gradient-to-r from-white to-gray-50 border border-gray-200 rounded-lg shadow-sm p-4">
                    <p className="text-center text-sm text-red-600">ĞÑˆĞ¸Ğ±ĞºĞ° Ğ·Ğ°Ğ³Ñ€ÑƒĞ·ĞºĞ¸ Ğ¿Ñ€Ğ¾Ñ„Ğ¸Ğ»Ñ</p>
                </div>
            </div>
        );
    }

    const isAdmin = user.role === "admin";
    const isManager = user.role === "manager" || isAdmin;

    const getRoleInfo = () => {
        if (isAdmin) return { label: "ĞĞ´Ğ¼Ğ¸Ğ½", color: "text-red-600", icon: "ğŸ‘‘", bg: "bg-red-50" };
        if (isManager) return { label: "ĞœĞµĞ½ĞµĞ´Ğ¶ĞµÑ€", color: "text-blue-600", icon: "ğŸ›¡ï¸", bg: "bg-blue-50" };
        return { label: "ĞŸĞ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ÑŒ", color: "text-gray-600", icon: "ğŸ‘¤", bg: "bg-gray-50" };
    };

    const roleInfo = getRoleInfo();

    // âœ… Ğ˜Ğ—ĞœĞ•ĞĞ•ĞĞ˜Ğ•: Ğ”Ğ¾Ğ±Ğ°Ğ²Ğ»ÑĞµĞ¼ Ñ„Ğ¾Ñ€Ğ¼Ğ°Ñ‚Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ Ğ¸ Ğ¿Ñ€Ğ¾Ğ²ĞµÑ€ĞºÑƒ Ğ±Ğ°Ğ»Ğ°Ğ½ÑĞ°
    const balance = user.balance ?? 0;
    const balanceColor = balance < 0 ? 'text-red-600' : 'text-green-700';

    return (
        <div className="w-full">
            <div className="bg-gradient-to-r from-white to-gray-50 border border-gray-200 rounded-lg shadow-sm">
                <div className="flex flex-col lg:flex-row items-stretch">
                    <div className="flex-1 p-3 lg:p-4">
                        <div className="flex items-center gap-3">
                            <div className={`w-12 h-12 ${roleInfo.bg} rounded-full flex items-center justify-center text-lg flex-shrink-0`}>
                                {roleInfo.icon}
                            </div>
                            <div className="flex-1 min-w-0">
                                <div className="flex flex-col lg:flex-row lg:items-start lg:gap-6">
                                    <div className="min-w-0">
                                        <div>
                                            <h3 className="font-semibold text-gray-900 text-sm truncate">
                                                {user.full_name}
                                            </h3>
                                            <p className="text-xs text-gray-600 truncate">{user.email}</p>
                                        </div>
                                    </div>
                                    <div className="flex items-center gap-4 mt-2 lg:mt-0">
                                        <div className="flex items-center gap-1">
                                            <Shield className="w-3 h-3 text-gray-400" />
                                            <span className={`text-xs font-medium ${roleInfo.color}`}>
                                                {roleInfo.label}
                                            </span>
                                        </div>
                                        <div className="flex items-center gap-1 text-xs text-gray-500">
                                            <span>Ğ‘Ğ°Ğ»Ğ°Ğ½Ñ:</span>
                                            {/* âœ… Ğ˜Ğ—ĞœĞ•ĞĞ•ĞĞ˜Ğ•: ĞŸÑ€Ğ¸Ğ¼ĞµĞ½ÑĞµĞ¼ Ñ„Ğ¾Ñ€Ğ¼Ğ°Ñ‚Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ Ğ¸ Ñ†Ğ²ĞµÑ‚ */}
                                            <span className={`font-semibold ${balanceColor}`}>
                                                {balance.toLocaleString('ru-RU', { style: 'currency', currency: 'RUB' })}
                                            </span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    {showExtraLinks && (
                        <div className="p-3 lg:p-4 lg:border-l lg:border-r border-gray-200 lg:w-[260px] lg:flex-shrink-0">
                            <h4 className="text-xs text-gray-500 mb-2 font-semibold">ĞŸĞ¾Ğ»ĞµĞ·Ğ½Ğ°Ñ Ğ¸Ğ½Ñ„Ğ¾Ñ€Ğ¼Ğ°Ñ†Ğ¸Ñ:</h4>
                            <div className="space-y-1.5">
                                <a
                                    href="/how-it-works"
                                    onClick={(e) => {
                                        e.preventDefault();
                                        alert("Ğ¡Ñ‚Ñ€Ğ°Ğ½Ğ¸Ñ†Ğ° 'ĞšĞ°Ğº Ñ€Ğ°Ğ±Ğ¾Ñ‚Ğ°ĞµÑ‚ Ğ¿Ñ€Ğ¾ĞºĞ°Ñ‚?' ĞµÑ‰Ğµ Ğ½Ğµ ÑĞ¾Ğ·Ğ´Ğ°Ğ½Ğ°.");
                                    }}
                                    className="flex items-center text-sm text-gray-700 hover:text-sky-600 hover:underline transition-colors duration-150"
                                >
                                    <HelpCircle className="w-4 h-4 mr-2 text-gray-400 flex-shrink-0" />
                                    ĞšĞ°Ğº Ñ€Ğ°Ğ±Ğ¾Ñ‚Ğ°ĞµÑ‚ Ğ¿Ñ€Ğ¾ĞºĞ°Ñ‚?
                                </a>
                                <a
                                    href="/rules"
                                    onClick={(e) => {
                                        e.preventDefault();
                                        alert("Ğ¡Ñ‚Ñ€Ğ°Ğ½Ğ¸Ñ†Ğ° 'ĞĞ°ÑˆĞ¸ Ğ¿Ñ€Ğ°Ğ²Ğ¸Ğ»Ğ°' ĞµÑ‰Ğµ Ğ½Ğµ ÑĞ¾Ğ·Ğ´Ğ°Ğ½Ğ°.");
                                    }}
                                    className="flex items-center text-sm text-gray-700 hover:text-sky-600 hover:underline transition-colors duration-150"
                                >
                                    <AlertTriangle className="w-4 h-4 mr-2 text-orange-400 flex-shrink-0" />
                                    ĞĞ°ÑˆĞ¸ Ğ¿Ñ€Ğ°Ğ²Ğ¸Ğ»Ğ°
                                </a>
                                <button
                                    onClick={() => navigate("/contacts", { state: { from: location.pathname } })}
                                    className="flex items-center text-sm text-gray-700 hover:text-sky-600 hover:underline w-full text-left transition-colors duration-150"
                                >
                                    <Send className="w-4 h-4 mr-2 text-blue-400 flex-shrink-0" />
                                    Ğ¡Ğ²ÑĞ·Ğ°Ñ‚ÑŒÑÑ Ñ Ğ½Ğ°Ğ¼Ğ¸
                                </button>
                            </div>
                        </div>
                    )}

                    <div className="border-t lg:border-t-0 lg:border-l bg-gray-50 lg:bg-transparent p-3 lg:p-4 lg:w-[300px] lg:ml-auto lg:flex-shrink-0">
                        <div className="flex gap-2 w-full">
                            <div className="flex flex-col gap-2 flex-1">
                                <Button
                                    variant="default"
                                    onClick={() =>
                                        navigate("/reservations/my", { state: { from: location.pathname } })
                                    }
                                    className="h-8 px-3 text-xs flex items-center justify-center gap-1.5 w-full"
                                    size="sm"
                                >
                                    <FileText className="w-3 h-3" />
                                    ĞœĞ¾Ğ¸ Ğ·Ğ°ĞºĞ°Ğ·Ñ‹
                                </Button>
                                <Button
                                    onClick={() => navigate("/calendar", { state: { from: location.pathname } })}
                                    className="h-8 px-3 text-xs flex items-center justify-center gap-1.5 bg-amber-500 hover:bg-amber-600 text-white w-full"
                                    size="sm"
                                >
                                    <Calendar className="w-3 h-3" />
                                    ĞšĞ°Ğ»ĞµĞ½Ğ´Ğ°Ñ€ÑŒ
                                </Button>
                                {isManager && (
                                    <Button
                                        variant="secondary"
                                        onClick={() => navigate("/admin")}
                                        className="h-8 px-3 text-xs flex items-center justify-center gap-1.5 bg-gray-800 hover:bg-gray-700 text-white w-full"
                                        size="sm"
                                    >
                                        <Settings className="w-3 h-3" />
                                        {isAdmin ? "ĞĞ´Ğ¼Ğ¸Ğ½ Ğ¿Ğ°Ğ½ĞµĞ»ÑŒ" : "ĞŸĞ°Ğ½ĞµĞ»ÑŒ Ğ¼ĞµĞ½ĞµĞ´Ğ¶ĞµÑ€Ğ°"}
                                    </Button>
                                )}
                            </div>
                            <div className="flex flex-col gap-2">
                                <Button
                                    variant="outline"
                                    onClick={
                                        onEditProfile
                                            ? onEditProfile
                                            : () => navigate("/profile", { state: { from: location.pathname } })
                                    }
                                    className="h-8 px-3 text-xs flex items-center justify-center gap-1.5"
                                    size="sm"
                                >
                                    <Edit className="w-3 h-3" />
                                    ĞŸÑ€Ğ¾Ñ„Ğ¸Ğ»ÑŒ
                                </Button>
                                <Button
                                    variant="destructive"
                                    onClick={logout}
                                    className="h-8 px-3 text-xs flex items-center justify-center gap-1.5"
                                    size="sm"
                                >
                                    <LogOut className="w-3 h-3" />
                                    Ğ’Ñ‹Ğ¹Ñ‚Ğ¸
                                </Button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    );
}

```


## <a name="srccomponentsViewModeToggletsx"></a>`src/components/ViewModeToggle.tsx`

```tsx
// path: src/components/ViewModeToggle.tsx

// src/components/ViewModeToggle.tsx

import { ToggleGroup, ToggleGroupItem } from "@/components/ui/toggle-group";
import { LayoutGrid, List } from "lucide-react";
// Ğ˜Ğ¼Ğ¿Ğ¾Ñ€Ñ‚Ğ¸Ñ€ÑƒĞµĞ¼ Ğ¾Ğ±Ğ½Ğ¾Ğ²Ğ»ĞµĞ½Ğ½Ñ‹Ğ¹ ÑÑ‚Ğ¾Ñ€
import { useViewModeStore, type ViewMode } from "@/store/viewModeStore";

export default function ViewModeToggle() {
  // Ğ˜ÑĞ¿Ğ¾Ğ»ÑŒĞ·ÑƒĞµĞ¼ Ğ½Ğ¾Ğ²Ñ‹Ğµ Ğ¼ĞµÑ‚Ğ¾Ğ´Ñ‹ Ğ¸Ğ· ÑÑ‚Ğ¾Ñ€Ğ°
  const { viewMode, setViewMode } = useViewModeStore();

  return (
      <ToggleGroup
          type="single"
          value={viewMode}
          onValueChange={(value: ViewMode) => {
            // ĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑĞµĞ¼, Ñ‡Ñ‚Ğ¾ Ğ·Ğ½Ğ°Ñ‡ĞµĞ½Ğ¸Ğµ Ğ½Ğµ Ğ¿ÑƒÑÑ‚Ğ¾Ğµ, Ğ¿Ñ€ĞµĞ¶Ğ´Ğµ Ñ‡ĞµĞ¼ Ğ¾Ğ±Ğ½Ğ¾Ğ²Ğ»ÑÑ‚ÑŒ ÑÑ‚Ğ¾Ñ€
            if (value) setViewMode(value);
          }}
          className="flex items-center"
          aria-label="ĞŸĞµÑ€ĞµĞºĞ»ÑÑ‡Ğ°Ñ‚ĞµĞ»ÑŒ Ğ²Ğ¸Ğ´Ğ° ĞºĞ°Ñ€Ñ‚Ğ¾Ñ‡ĞµĞº"
      >
        <ToggleGroupItem value="default" aria-label="Ğ¡Ñ‚Ğ°Ğ½Ğ´Ğ°Ñ€Ñ‚Ğ½Ñ‹Ğ¹ Ğ²Ğ¸Ğ´" className="p-2 h-9 w-9">
          <LayoutGrid className="h-4 w-4" />
        </ToggleGroupItem>
        <ToggleGroupItem value="compact" aria-label="ĞšĞ¾Ğ¼Ğ¿Ğ°ĞºÑ‚Ğ½Ñ‹Ğ¹ Ğ²Ğ¸Ğ´" className="p-2 h-9 w-9">
          <List className="h-4 w-4" />
        </ToggleGroupItem>
      </ToggleGroup>
  );
}

```


## <a name="srccomponentsadminAccessoryDialogstsx"></a>`src/components/admin/AccessoryDialogs.tsx`

```tsx
// path: src/components/admin/AccessoryDialogs.tsx

// src/components/admin/AccessoryDialogs.tsx
import { useForm } from "react-hook-form";
import { zodResolver } from "@hookform/resolvers/zod";
import { accessorySchema, AccessorySchema } from "@/lib/validationSchemas";
import { useCreateAccessory, useUpdateAccessory } from "@/hooks/useAdminAccessories";
import type { Accessory } from "@/types/accessory";

import { Button } from "@/components/ui/button";
import { Input } from "@/components/ui/input";
import { Label } from "@/components/ui/label";
import { Textarea } from "@/components/ui/textarea";
import {
    Dialog,
    DialogContent,
    DialogHeader,
    DialogTitle,
    DialogFooter,
    DialogDescription,
} from "@/components/ui/dialog";

// --- Ğ”Ğ¸Ğ°Ğ»Ğ¾Ğ³ ÑĞ¾Ğ·Ğ´Ğ°Ğ½Ğ¸Ñ ---
interface CreateProps {
    open: boolean;
    onClose: () => void;
}
export function AccessoryCreateDialog({ open, onClose }: CreateProps) {
    const createMutation = useCreateAccessory();
    const { register, handleSubmit, formState: { errors, isValid }, reset } = useForm<AccessorySchema>({
        resolver: zodResolver(accessorySchema) as any,
        mode: "onChange",
    });

    const onSubmit = (data: AccessorySchema) => {
        createMutation.mutate(data, {
            onSuccess: () => {
                reset();
                onClose();
            },
        });
    };

    return (
        <Dialog open={open} onOpenChange={onClose}>
            <DialogContent>
                <DialogHeader>
                    <DialogTitle>ĞĞ¾Ğ²Ñ‹Ğ¹ Ğ°ĞºÑĞµÑÑÑƒĞ°Ñ€</DialogTitle>
                    <DialogDescription>Ğ¡Ğ¾Ğ·Ğ´Ğ°Ğ¹Ñ‚Ğµ Ğ½Ğ¾Ğ²ÑƒÑ Ğ·Ğ°Ğ¿Ğ¸ÑÑŒ Ğ² ĞºĞ°Ñ‚Ğ°Ğ»Ğ¾Ğ³Ğµ Ğ°ĞºÑĞµÑÑÑƒĞ°Ñ€Ğ¾Ğ².</DialogDescription>
                </DialogHeader>
                <form onSubmit={handleSubmit(onSubmit)} className="space-y-4 py-2">
                    {/* ... Ğ¿Ğ¾Ğ»Ñ Ñ„Ğ¾Ñ€Ğ¼Ñ‹ ... */}
                    <div>
                        <Label htmlFor="name">ĞĞ°Ğ·Ğ²Ğ°Ğ½Ğ¸Ğµ *</Label>
                        <Input id="name" {...register("name")} placeholder="ĞĞºĞºÑƒĞ¼ÑƒĞ»ÑÑ‚Ğ¾Ñ€ LP-E6" />
                        {errors.name && <p className="text-xs text-red-600 mt-1">{errors.name.message}</p>}
                    </div>
                    <div className="grid grid-cols-2 gap-4">
                        <div>
                            <Label htmlFor="accessory_type">Ğ¢Ğ¸Ğ¿</Label>
                            <Input id="accessory_type" {...register("accessory_type")} placeholder="ĞŸĞ¸Ñ‚Ğ°Ğ½Ğ¸Ğµ"/>
                        </div>
                        <div>
                            <Label htmlFor="price">Ğ¦ĞµĞ½Ğ° (â‚½/Ğ´ĞµĞ½ÑŒ)</Label>
                            <Input id="price" type="number" step="0.01" {...register("price")} placeholder="100"/>
                            {errors.price && <p className="text-xs text-red-600 mt-1">{errors.price.message}</p>}
                        </div>
                    </div>
                    <div>
                        <Label htmlFor="description">ĞĞ¿Ğ¸ÑĞ°Ğ½Ğ¸Ğµ</Label>
                        <Textarea id="description" {...register("description")} placeholder="Ğ”Ğ»Ñ ĞºĞ°Ğ¼ĞµÑ€ Canon R, R5, R6..." />
                    </div>
                    <DialogFooter>
                        <Button type="button" variant="ghost" onClick={onClose}>ĞÑ‚Ğ¼ĞµĞ½Ğ°</Button>
                        <Button type="submit" disabled={!isValid || createMutation.isPending}>
                            {createMutation.isPending ? "Ğ¡Ğ¾Ğ·Ğ´Ğ°Ğ½Ğ¸Ğµ..." : "Ğ¡Ğ¾Ğ·Ğ´Ğ°Ñ‚ÑŒ"}
                        </Button>
                    </DialogFooter>
                </form>
            </DialogContent>
        </Dialog>
    );
}

// --- Ğ”Ğ¸Ğ°Ğ»Ğ¾Ğ³ Ñ€ĞµĞ´Ğ°ĞºÑ‚Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ ---
interface EditProps {
    accessory: Accessory | null;
    open: boolean;
    onClose: () => void;
}
export function AccessoryEditDialog({ accessory, open, onClose }: EditProps) {
    const updateMutation = useUpdateAccessory();
    const { register, handleSubmit, formState: { errors, isValid }, reset } = useForm<AccessorySchema>({
        resolver: zodResolver(accessorySchema) as any,
        mode: "onChange",
        // 'key' Ğ² defaultValues Ğ½ĞµÑĞ²Ğ½Ğ¾ ÑĞ±Ñ€Ğ°ÑÑ‹Ğ²Ğ°ĞµÑ‚ ÑĞ¾ÑÑ‚Ğ¾ÑĞ½Ğ¸Ğµ Ñ„Ğ¾Ñ€Ğ¼Ñ‹ Ğ¿Ñ€Ğ¸ Ğ¸Ğ·Ğ¼ĞµĞ½ĞµĞ½Ğ¸Ğ¸ accessory
        defaultValues: {
            name: accessory?.name || "",
            accessory_type: accessory?.accessory_type || "",
            price: accessory?.price || 0,
            description: accessory?.description || "",
        },
    });

    const onSubmit = (data: AccessorySchema) => {
        if (!accessory) return;
        updateMutation.mutate({ id: accessory.id, data }, {
            onSuccess: () => {
                reset(data);
                onClose();
            },
        });
    };

    if (!accessory) return null;

    return (
        <Dialog open={open} onOpenChange={onClose}>
            <DialogContent>
                <DialogHeader>
                    <DialogTitle>Ğ ĞµĞ´Ğ°ĞºÑ‚Ğ¸Ñ€Ğ¾Ğ²Ğ°Ñ‚ÑŒ Ğ°ĞºÑĞµÑÑÑƒĞ°Ñ€</DialogTitle>
                    <DialogDescription>"{accessory.name}"</DialogDescription>
                </DialogHeader>
                <form onSubmit={handleSubmit(onSubmit)} className="space-y-4 py-2">
                    {/* ... Ğ¿Ğ¾Ğ»Ñ Ñ„Ğ¾Ñ€Ğ¼Ñ‹ ... */}
                    <div>
                        <Label htmlFor="edit-name">ĞĞ°Ğ·Ğ²Ğ°Ğ½Ğ¸Ğµ *</Label>
                        <Input id="edit-name" {...register("name")} />
                        {errors.name && <p className="text-xs text-red-600 mt-1">{errors.name.message}</p>}
                    </div>
                    <div className="grid grid-cols-2 gap-4">
                        <div>
                            <Label htmlFor="edit-accessory_type">Ğ¢Ğ¸Ğ¿</Label>
                            <Input id="edit-accessory_type" {...register("accessory_type")} />
                        </div>
                        <div>
                            <Label htmlFor="edit-price">Ğ¦ĞµĞ½Ğ° (â‚½/Ğ´ĞµĞ½ÑŒ)</Label>
                            <Input id="edit-price" type="number" step="0.01" {...register("price")} />
                            {errors.price && <p className="text-xs text-red-600 mt-1">{errors.price.message}</p>}
                        </div>
                    </div>
                    <div>
                        <Label htmlFor="edit-description">ĞĞ¿Ğ¸ÑĞ°Ğ½Ğ¸Ğµ</Label>
                        <Textarea id="edit-description" {...register("description")} />
                    </div>
                    <DialogFooter>
                        <Button type="button" variant="ghost" onClick={onClose}>ĞÑ‚Ğ¼ĞµĞ½Ğ°</Button>
                        <Button type="submit" disabled={!isValid || updateMutation.isPending}>
                            {updateMutation.isPending ? "Ğ¡Ğ¾Ñ…Ñ€Ğ°Ğ½ĞµĞ½Ğ¸Ğµ..." : "Ğ¡Ğ¾Ñ…Ñ€Ğ°Ğ½Ğ¸Ñ‚ÑŒ"}
                        </Button>
                    </DialogFooter>
                </form>
            </DialogContent>
        </Dialog>
    );
}

```


## <a name="srccomponentsadminAccessoryTabletsx"></a>`src/components/admin/AccessoryTable.tsx`

```tsx
// path: src/components/admin/AccessoryTable.tsx

// src/components/admin/AccessoryTable.tsx

import { useState } from "react";
import { useAccessories, useDeleteAccessory } from "@/hooks/useAdminAccessories";
import type { Accessory } from "@/types/accessory";
import { AccessoryCreateDialog, AccessoryEditDialog } from "./AccessoryDialogs";

import { Button } from "@/components/ui/button";
import { Input } from "@/components/ui/input";
import {
    Table,
    TableBody,
    TableCell,
    TableHead,
    TableHeader,
    TableRow,
} from "@/components/ui/table";
import { Plus, Edit, Trash2, Search, Wrench, ChevronLeft, ChevronRight } from "lucide-react";

const PAGE_SIZE = 15;

export default function AccessoryTable() {
    // +++ ĞĞĞ§ĞĞ›Ğ Ğ˜Ğ—ĞœĞ•ĞĞ•ĞĞ˜Ğ™ +++
    const [currentPage, setCurrentPage] = useState(1);
    const { data: accessoriesResponse, isLoading, error } = useAccessories(currentPage, PAGE_SIZE);
    const deleteMutation = useDeleteAccessory();

    const accessories = accessoriesResponse?.items ?? [];
    const totalAccessories = accessoriesResponse?.total ?? 0;
    const totalPages = Math.ceil(totalAccessories / PAGE_SIZE);
    // +++ ĞšĞĞĞ•Ğ¦ Ğ˜Ğ—ĞœĞ•ĞĞ•ĞĞ˜Ğ™ +++

    const [search, setSearch] = useState("");
    const [isCreateOpen, setCreateOpen] = useState(false);
    const [editingAccessory, setEditingAccessory] = useState<Accessory | null>(null);

    const filteredAccessories = accessories.filter(acc =>
        acc.name.toLowerCase().includes(search.toLowerCase()) ||
        (acc.accessory_type && acc.accessory_type.toLowerCase().includes(search.toLowerCase()))
    );

    const handleDelete = (id: number) => {
        if (window.confirm("Ğ’Ñ‹ ÑƒĞ²ĞµÑ€ĞµĞ½Ñ‹, Ñ‡Ñ‚Ğ¾ Ñ…Ğ¾Ñ‚Ğ¸Ñ‚Ğµ ÑƒĞ´Ğ°Ğ»Ğ¸Ñ‚ÑŒ ÑÑ‚Ğ¾Ñ‚ Ğ°ĞºÑĞµÑÑÑƒĞ°Ñ€?")) {
            deleteMutation.mutate(id);
        }
    };

    if (isLoading) return <p>Ğ—Ğ°Ğ³Ñ€ÑƒĞ·ĞºĞ° Ğ°ĞºÑĞµÑÑÑƒĞ°Ñ€Ğ¾Ğ²...</p>;
    if (error) return <p className="text-red-600">ĞÑˆĞ¸Ğ±ĞºĞ° Ğ·Ğ°Ğ³Ñ€ÑƒĞ·ĞºĞ¸ Ğ´Ğ°Ğ½Ğ½Ñ‹Ñ….</p>;

    return (
        <>
            <div className="flex items-center justify-between gap-4 mb-4">
                <div className="relative w-full max-w-sm">
                    <Search className="absolute left-3 top-2.5 h-4 w-4 text-muted-foreground" />
                    <Input
                        placeholder="ĞŸĞ¾Ğ¸ÑĞº Ğ¿Ğ¾ Ğ½Ğ°Ğ·Ğ²Ğ°Ğ½Ğ¸Ñ Ğ¸Ğ»Ğ¸ Ñ‚Ğ¸Ğ¿Ñƒ..."
                        value={search}
                        onChange={(e) => setSearch(e.target.value)}
                        className="pl-10"
                    />
                </div>
                <Button onClick={() => setCreateOpen(true)}>
                    <Plus className="mr-2 h-4 w-4" /> Ğ”Ğ¾Ğ±Ğ°Ğ²Ğ¸Ñ‚ÑŒ Ğ°ĞºÑĞµÑÑÑƒĞ°Ñ€
                </Button>
            </div>
            {filteredAccessories.length > 0 ? (
                <>
                    <div className="border rounded-md">
                        <Table>
                            <TableHeader>
                                <TableRow>
                                    <TableHead className="w-[100px]">ID</TableHead>
                                    <TableHead>ĞĞ°Ğ·Ğ²Ğ°Ğ½Ğ¸Ğµ</TableHead>
                                    <TableHead>Ğ¢Ğ¸Ğ¿</TableHead>
                                    <TableHead>Ğ¦ĞµĞ½Ğ°</TableHead>
                                    <TableHead className="text-right">Ğ”ĞµĞ¹ÑÑ‚Ğ²Ğ¸Ñ</TableHead>
                                </TableRow>
                            </TableHeader>
                            <TableBody>
                                {filteredAccessories.map((acc) => (
                                    <TableRow key={acc.id}>
                                        <TableCell>{acc.id}</TableCell>
                                        <TableCell className="font-medium">{acc.name}</TableCell>
                                        <TableCell>{acc.accessory_type}</TableCell>
                                        <TableCell>{acc.price} â‚½</TableCell>
                                        <TableCell className="text-right">
                                            <Button variant="ghost" size="icon" onClick={() => setEditingAccessory(acc)}>
                                                <Edit className="h-4 w-4" />
                                            </Button>
                                            <Button variant="ghost" size="icon" onClick={() => handleDelete(acc.id)} disabled={deleteMutation.isPending}>
                                                <Trash2 className="h-4 w-4 text-red-500" />
                                            </Button>
                                        </TableCell>
                                    </TableRow>
                                ))}
                            </TableBody>
                        </Table>
                    </div>
                    {/* +++ ĞĞĞ§ĞĞ›Ğ: ĞšĞ½Ğ¾Ğ¿ĞºĞ¸ Ğ¿Ğ°Ğ³Ğ¸Ğ½Ğ°Ñ†Ğ¸Ğ¸ +++ */}
                    <div className="flex items-center justify-end space-x-2 py-4">
                        <span className="text-sm text-muted-foreground">
                            Ğ¡Ñ‚Ñ€Ğ°Ğ½Ğ¸Ñ†Ğ° {currentPage} Ğ¸Ğ· {totalPages}
                        </span>
                        <Button
                            variant="outline"
                            size="sm"
                            onClick={() => setCurrentPage(prev => Math.max(prev - 1, 1))}
                            disabled={currentPage === 1}
                        >
                            <ChevronLeft className="h-4 w-4" />
                            ĞĞ°Ğ·Ğ°Ğ´
                        </Button>
                        <Button
                            variant="outline"
                            size="sm"
                            onClick={() => setCurrentPage(prev => Math.min(prev + 1, totalPages))}
                            disabled={currentPage === totalPages}
                        >
                            Ğ’Ğ¿ĞµÑ€ĞµĞ´
                            <ChevronRight className="h-4 w-4" />
                        </Button>
                    </div>
                    {/* +++ ĞšĞĞĞ•Ğ¦: ĞšĞ½Ğ¾Ğ¿ĞºĞ¸ Ğ¿Ğ°Ğ³Ğ¸Ğ½Ğ°Ñ†Ğ¸Ğ¸ +++ */}
                </>
            ) : (
                <div className="text-center py-12 px-4 border rounded-md">
                    <Wrench className="w-16 h-16 text-gray-300 mx-auto mb-3" />
                    <h3 className="text-lg font-semibold text-gray-700">ĞĞºÑĞµÑÑÑƒĞ°Ñ€Ñ‹ Ğ½Ğµ Ğ½Ğ°Ğ¹Ğ´ĞµĞ½Ñ‹</h3>
                    <p className="text-sm text-gray-500 mt-1">{search ? "ĞŸĞ¾Ğ¿Ñ€Ğ¾Ğ±ÑƒĞ¹Ñ‚Ğµ Ğ¸Ğ·Ğ¼ĞµĞ½Ğ¸Ñ‚ÑŒ Ğ¿Ğ¾Ğ¸ÑĞºĞ¾Ğ²Ñ‹Ğ¹ Ğ·Ğ°Ğ¿Ñ€Ğ¾Ñ." : "Ğ”Ğ¾Ğ±Ğ°Ğ²ÑŒÑ‚Ğµ Ğ¿ĞµÑ€Ğ²Ñ‹Ğ¹ Ğ°ĞºÑĞµÑÑÑƒĞ°Ñ€, Ñ‡Ñ‚Ğ¾Ğ±Ñ‹ Ğ¾Ğ½ Ğ¿Ğ¾ÑĞ²Ğ¸Ğ»ÑÑ Ğ² ÑĞ¿Ğ¸ÑĞºĞµ."}</p>
                </div>
            )}

            <AccessoryCreateDialog open={isCreateOpen} onClose={() => setCreateOpen(false)} />
            <AccessoryEditDialog accessory={editingAccessory} open={!!editingAccessory} onClose={() => setEditingAccessory(null)} />
        </>
    );
}

```


## <a name="srccomponentsadminAdminNavigationtsx"></a>`src/components/admin/AdminNavigation.tsx`

```tsx
// path: src/components/admin/AdminNavigation.tsx

// src/components/admin/AdminNavigation.tsx

import { useCurrentUser } from "@/hooks/useProfile";
import { Button } from "@/components/ui/button";
import { useNavigate, useLocation } from "react-router-dom";
import { Users, Package, Shield, Home, Paperclip, ClipboardList, TicketPercent, CalendarDays, Tags, Truck } from "lucide-react"; // <-- Ğ”Ğ¾Ğ±Ğ°Ğ²Ğ»ĞµĞ½Ğ° Ğ¸ĞºĞ¾Ğ½ĞºĞ° Truck

export default function AdminNavigation() {
    const { data: user } = useCurrentUser();
    const navigate = useNavigate();
    const location = useLocation();

    const isAdmin = user?.role === "admin";
    const isManager = user?.role === "manager" || isAdmin;

    if (!isManager) return null;

    const navigationItems = [
        {
            path: "/admin",
            label: "ĞĞ±Ğ·Ğ¾Ñ€",
            icon: <Shield className="w-4 h-4" />,
            accessible: isManager
        },
        {
            path: "/admin/reservations",
            label: "Ğ’ÑĞµ Ñ€ĞµĞ·ĞµÑ€Ğ²Ñ‹",
            icon: <ClipboardList className="w-4 h-4" />,
            accessible: isManager
        },
        // +++ ĞĞĞ’Ğ«Ğ™ ĞŸĞ£ĞĞšĞ¢ ĞœĞ•ĞĞ® +++
        {
            path: "/admin/rentals",
            label: "ĞÑ€ĞµĞ½Ğ´Ñ‹",
            icon: <Truck className="w-4 h-4" />,
            accessible: isManager
        },
        // ++++++++++++++++++++++++
        {
            path: "/admin/users",
            label: "ĞŸĞ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ğ¸",
            icon: <Users className="w-4 h-4" />,
            accessible: isManager,
        },
        {
            path: "/admin/equipment",
            label: "ĞĞ±Ğ¾Ñ€ÑƒĞ´Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ",
            icon: <Package className="w-4 h-4" />,
            accessible: isManager
        },
        {
            path: "/admin/accessories",
            label: "ĞĞºÑĞµÑÑÑƒĞ°Ñ€Ñ‹",
            icon: <Paperclip className="w-4 h-4" />,
            accessible: isManager
        },
        {
            path: "/admin/associations",
            label: "ĞÑÑĞ¾Ñ†Ğ¸Ğ°Ñ†Ğ¸Ğ¸",
            icon: <Tags className="w-4 h-4" />,
            accessible: isManager
        },
        {
            path: "/admin/promocodes",
            label: "ĞŸÑ€Ğ¾Ğ¼Ğ¾ĞºĞ¾Ğ´Ñ‹ Ğ¸ Ğ¡ĞºĞ¸Ğ´ĞºĞ¸",
            icon: <TicketPercent className="w-4 h-4" />,
            accessible: isManager
        },
        {
            path: "/admin/holidays",
            label: "Ğ’Ñ‹Ñ…Ğ¾Ğ´Ğ½Ñ‹Ğµ Ğ´Ğ½Ğ¸",
            icon: <CalendarDays className="w-4 h-4" />,
            accessible: isAdmin
        }
    ];

    const isActive = (path: string) => {
        if (path === "/admin") {
            return location.pathname === "/admin";
        }
        return location.pathname.startsWith(path);
    };

    return (
        <div className="bg-white border rounded-lg shadow-sm p-4 mb-6">
            <div className="flex items-center justify-between mb-4">
                <h2 className="text-lg font-semibold text-gray-900">
                    ĞŸĞ°Ğ½ĞµĞ»ÑŒ ÑƒĞ¿Ñ€Ğ°Ğ²Ğ»ĞµĞ½Ğ¸Ñ
                </h2>
                <Button
                    variant="outline"
                    size="sm"
                    onClick={() => navigate("/")}
                >
                    <Home className="w-4 h-4 mr-2" />
                    ĞĞ° Ğ³Ğ»Ğ°Ğ²Ğ½ÑƒÑ
                </Button>
            </div>

            <div className="flex items-center text-sm text-gray-600 mb-4">
                <span>Ğ Ğ¾Ğ»ÑŒ: </span>
                <span className={`ml-1 font-medium ${
                    isAdmin ? "text-red-600" : "text-blue-600"
                }`}>
                    {user?.role === "admin" ? "ĞĞ´Ğ¼Ğ¸Ğ½Ğ¸ÑÑ‚Ñ€Ğ°Ñ‚Ğ¾Ñ€" : "ĞœĞµĞ½ĞµĞ´Ğ¶ĞµÑ€"}
                </span>
            </div>

            <div className="flex flex-wrap gap-2">
                {navigationItems
                    .filter(item => item.accessible)
                    .map((item) => (
                        <Button
                            key={item.path}
                            variant={isActive(item.path) ? "default" : "outline"}
                            size="sm"
                            onClick={() => navigate(item.path)}
                            className="flex items-center gap-2"
                        >
                            {item.icon}
                            <span>{item.label}</span>
                        </Button>
                    ))
                }
            </div>
        </div>
    );
}

```


## <a name="srccomponentsadminAdminRentalCardtsx"></a>`src/components/admin/AdminRentalCard.tsx`

```tsx
// path: src/components/admin/AdminRentalCard.tsx

// src/components/admin/AdminRentalCard.tsx

import { useState, useMemo, useRef, useEffect } from "react";
import { useNavigate, useLocation } from "react-router-dom";
import { Card, CardContent } from "@/components/ui/card";
import { Button } from "@/components/ui/button";
// âœ… Ğ˜Ğ¡ĞŸĞ ĞĞ’Ğ›Ğ•ĞĞ˜Ğ• 1: Ğ£Ğ±Ğ¸Ñ€Ğ°ĞµĞ¼ Ğ½ĞµĞ¸ÑĞ¿Ğ¾Ğ»ÑŒĞ·ÑƒĞµĞ¼Ñ‹Ğµ Ğ¸ĞºĞ¾Ğ½ĞºĞ¸ Wallet, Landmark, Paperclip
import { Calendar, Edit, Package, Trash2, User, Truck, RotateCcw, List, ChevronDown, Link as LinkIcon, ReceiptText } from "lucide-react";
import { formatDateEuropean, cn } from "@/lib/utils";
import RentalStatusBadge from "./RentalStatusBadge";
import type { AdminRentalOut } from "@/types/rental";
import { useCurrentUser } from "@/hooks/useProfile";
import { useDeleteAdminRental, useRevertRentalToReservation } from "@/hooks/useAdminRentals";
import { ConfirmationDialog } from "@/components/ui/confirmation-dialog";
import type { Equipment } from "@/types/equipment";
import EditableRentalCard from "./EditableRentalCard";
import EquipmentWithAccessoriesList from "@/components/shared/EquipmentWithAccessoriesList";
import { RENTAL_CARD_STYLES } from "@/constants/statusStyles";

interface Props {
    rental: AdminRentalOut;
    onReturn: (rental: AdminRentalOut) => void;
    highlightId?: number;
}

const isToday = (dateString: string): boolean => {
    const date = new Date(dateString);
    const today = new Date();
    return date.getFullYear() === today.getFullYear() &&
        date.getMonth() === today.getMonth() &&
        date.getDate() === today.getDate();
};

export default function AdminRentalCard({ rental, onReturn, highlightId }: Props) {
    const { data: currentUser } = useCurrentUser();
    const deleteMutation = useDeleteAdminRental();
    const revertMutation = useRevertRentalToReservation();
    const [isConfirmingRevert, setConfirmingRevert] = useState(false);
    const [isExpanded, setIsExpanded] = useState(true);
    const [isEditing, setIsEditing] = useState(false);
    const navigate = useNavigate();
    const location = useLocation();
    const cardRef = useRef<HTMLDivElement>(null);

    const isHighlighted = highlightId === rental.id;

    const isAdmin = currentUser?.role === 'admin';
    const canRevert = rental.reservation_id && rental.status !== 'completed' && isToday(rental.created_at);

    const handleDelete = () => {
        if (window.confirm(`Ğ’Ñ‹ ÑƒĞ²ĞµÑ€ĞµĞ½Ñ‹, Ñ‡Ñ‚Ğ¾ Ñ…Ğ¾Ñ‚Ğ¸Ñ‚Ğµ Ğ±ĞµĞ·Ğ²Ğ¾Ğ·Ğ²Ñ€Ğ°Ñ‚Ğ½Ğ¾ ÑƒĞ´Ğ°Ğ»Ğ¸Ñ‚ÑŒ Ğ°Ñ€ĞµĞ½Ğ´Ñƒ #${rental.id}? Ğ­Ñ‚Ğ¾ Ğ´ĞµĞ¹ÑÑ‚Ğ²Ğ¸Ğµ Ğ½ĞµĞ»ÑŒĞ·Ñ Ğ¾Ñ‚Ğ¼ĞµĞ½Ğ¸Ñ‚ÑŒ.`)) {
            deleteMutation.mutate(rental.id);
        }
    };

    const handleRevert = () => {
        revertMutation.mutate(rental.id, {
            onSuccess: () => setConfirmingRevert(false),
            onError: () => setConfirmingRevert(false),
        });
    };


    const handleNavigateToReservation = (reservationId: number) => {
        navigate('/admin/reservations', {
            state: {
                highlightId: reservationId,
                statusFilterOverride: 'all'
            }
        });
    };

    useEffect(() => {
        if (isHighlighted && cardRef.current) {
            cardRef.current.scrollIntoView({
                behavior: "smooth",
                block: "center",
            });
        }
    }, [isHighlighted]);

    if (isEditing) {
        return <EditableRentalCard rental={rental} onCancel={() => setIsEditing(false)} />;
    }

    const statusClass = RENTAL_CARD_STYLES[rental.status] || RENTAL_CARD_STYLES.default;
    
    const highlightClass = isHighlighted
        ? "ring-2 ring-offset-2 ring-amber-500 border-amber-400 bg-amber-50"
        : "";

    return (
        <>
            <div ref={cardRef} className={`relative w-full rounded-lg border transition-all hover:shadow-md ${highlightClass}`}>
                <Card className={cn("w-full", statusClass)}>
                    <CardContent className="p-4">
                        <div className="flex flex-col md:flex-row gap-4 justify-between">
                            {/* Ğ‘Ğ»Ğ¾Ğº Ñ Ğ¾ÑĞ½Ğ¾Ğ²Ğ½Ğ¾Ğ¹ Ğ¸Ğ½Ñ„Ğ¾Ñ€Ğ¼Ğ°Ñ†Ğ¸ĞµĞ¹ */}
                            <div className="flex-1 space-y-2.5">
                                <div className="flex items-center gap-4">
                                    <h3 className="font-bold text-lg text-orange-700 flex items-center gap-2">
                                        <Truck className="w-5 h-5"/> ĞÑ€ĞµĞ½Ğ´Ğ° #{rental.id}
                                    </h3>
                                    <RentalStatusBadge status={rental.status} />
                                </div>
                                <div className="text-sm text-gray-700 space-y-1.5 pl-1">
                                    <div className="flex items-center gap-2">
                                        <User className="w-4 h-4 text-gray-500" />
                                        <span>{rental.user.full_name} ({rental.user.email})</span>
                                    </div>
                                    <div className="flex items-center gap-2">
                                        <span className="text-gray-600">Ğ‘Ğ°Ğ»Ğ°Ğ½Ñ:</span>
                                        <span className={`font-medium ${(rental.user.balance ?? 0) < 0 ? 'text-red-600' : 'text-green-700'}`}>
                                            {(rental.user.balance ?? 0).toLocaleString('ru-RU')} â‚½
                                        </span>
                                    </div>
                                    {rental.reservation_id && (
                                        <div className="flex items-center gap-2">
                                            <LinkIcon className="w-4 h-4 text-gray-500" />
                                            <button
                                                onClick={() => handleNavigateToReservation(rental.reservation_id!)}
                                                className="text-sky-600 hover:underline hover:text-sky-700 transition-colors"
                                            >
                                                Ğ˜Ğ· Ñ€ĞµĞ·ĞµÑ€Ğ²Ğ° #{rental.reservation_id}
                                            </button>
                                        </div>
                                    )}
                                    <div className="flex items-center gap-2">
                                        <Calendar className="w-4 h-4 text-gray-500" />
                                        <span>{formatDateEuropean(rental.start_date)} â€” {formatDateEuropean(rental.end_date)}</span>
                                    </div>
                                    <div className="flex items-start gap-2">
                                        <Package className="w-4 h-4 text-gray-500 mt-0.5 flex-shrink-0" />
                                        <div className="flex-1">
                                            <button
                                                onClick={() => setIsExpanded(!isExpanded)}
                                                className="flex items-center text-left w-full hover:text-sky-700 transition-colors disabled:hover:text-current disabled:cursor-not-allowed"
                                            >
                                                <span>ĞŸĞ¾Ğ·Ğ¸Ñ†Ğ¸Ğ¹ Ğ² Ğ°Ñ€ĞµĞ½Ğ´Ğµ: {rental.equipment.length + (rental.accessory_links?.length ?? 0)}</span>
                                                <ChevronDown className={`w-4 h-4 ml-1 transition-transform ${isExpanded ? 'rotate-180' : ''}`} />
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            {/* Ğ¤Ğ¸Ğ½Ğ°Ğ½ÑĞ¾Ğ²Ñ‹Ğ¹ Ğ±Ğ»Ğ¾Ğº */}
                            <div className="flex-shrink-0 md:w-64 bg-slate-50 p-3 rounded-lg border space-y-2">
                                <h4 className="font-semibold text-sm text-slate-800 flex items-center gap-2"><ReceiptText className="w-4 h-4"/>Ğ¤Ğ¸Ğ½Ğ°Ğ½ÑÑ‹</h4>
                                <div className="text-xs space-y-1.5 text-slate-700">
                                    <div className="flex justify-between"><span>ĞĞ±Ñ‰Ğ°Ñ ÑÑ‚Ğ¾Ğ¸Ğ¼Ğ¾ÑÑ‚ÑŒ:</span> <span className="font-medium">{rental.total_cost.toLocaleString('ru-RU')} â‚½</span></div>
                                    {rental.accessories_cost > 0 && (
                                        <div className="flex justify-between"><span>Ğ’ Ñ‚.Ñ‡. Ğ°ĞºÑĞµÑÑÑƒĞ°Ñ€Ñ‹:</span> <span className="font-medium">{rental.accessories_cost.toLocaleString('ru-RU')} â‚½</span></div>
                                    )}
                                    {rental.discount_amount > 0 && (
                                        <div className="flex justify-between"><span>Ğ¡ĞºĞ¸Ğ´ĞºĞ°:</span> <span className="font-medium text-green-600">-{rental.discount_amount.toLocaleString('ru-RU')} â‚½</span></div>
                                    )}
                                    {rental.prepayment_amount > 0 && (
                                        <div className="flex justify-between"><span>ĞŸÑ€ĞµĞ´Ğ¾Ğ¿Ğ»Ğ°Ñ‚Ğ°:</span> <span className="font-medium text-blue-600">{rental.prepayment_amount.toLocaleString('ru-RU')} â‚½</span></div>
                                    )}
                                    <div className="flex justify-between pt-1 border-t">
                                        <span className="font-semibold text-base">ĞÑÑ‚Ğ°Ñ‚Ğ¾Ğº Ğº Ğ¾Ğ¿Ğ»Ğ°Ñ‚Ğµ:</span>
                                        <span className="font-bold text-base">{rental.remaining_amount.toLocaleString('ru-RU')} â‚½</span>
                                    </div>
                                    {rental.status === 'completed' && rental.final_cost !== null && (
                                        <div className="flex justify-between pt-1 border-t border-dashed">
                                            <span className="font-semibold">Ğ˜Ñ‚Ğ¾Ğ³Ğ¾Ğ²Ğ°Ñ ÑÑ‚Ğ¾Ğ¸Ğ¼Ğ¾ÑÑ‚ÑŒ:</span>
                                            <span className="font-bold">{rental.final_cost.toLocaleString('ru-RU')} â‚½</span>
                                        </div>
                                    )}
                                    <div className="flex justify-between pt-2 border-t text-slate-500">
                                        <span>Ğ’Ğ½ĞµÑĞµĞ½Ğ½Ñ‹Ğ¹ Ğ·Ğ°Ğ»Ğ¾Ğ³:</span>
                                        <span className="font-medium">{rental.deposit_amount.toLocaleString('ru-RU')} â‚½</span>
                                    </div>
                                </div>
                            </div>

                            {/* Ğ‘Ğ»Ğ¾Ğº Ñ ĞºĞ½Ğ¾Ğ¿ĞºĞ°Ğ¼Ğ¸ Ğ´ĞµĞ¹ÑÑ‚Ğ²Ğ¸Ğ¹ */}
                            <div className="flex md:flex-col items-center md:items-end justify-between md:justify-start gap-2 border-t md:border-t-0 md:border-l pt-3 md:pt-0 md:pl-4">
                                <div className="flex flex-col gap-2">
                                    {canRevert && (
                                        <Button size="sm" variant="outline" onClick={() => setConfirmingRevert(true)} className="text-amber-700 border-amber-300 hover:bg-amber-50 hover:text-amber-800">
                                            <RotateCcw className="mr-2 h-4 w-4" />
                                            ĞÑ‚Ğ¼ĞµĞ½Ğ¸Ñ‚ÑŒ Ğ²Ñ‹Ğ´Ğ°Ñ‡Ñƒ
                                        </Button>
                                    )}
                                    <Button size="sm" variant="outline" onClick={() => setIsEditing(true)}>
                                        <Edit className="mr-2 h-4 w-4" />
                                        Ğ ĞµĞ´Ğ°ĞºÑ‚Ğ¸Ñ€Ğ¾Ğ²Ğ°Ñ‚ÑŒ
                                    </Button>
                                    {rental.status !== 'completed' && (
                                        <Button size="sm" variant="default" onClick={() => onReturn(rental)}>
                                            <RotateCcw className="mr-2 h-4 w-4" />
                                            ĞÑ„Ğ¾Ñ€Ğ¼Ğ¸Ñ‚ÑŒ Ğ²Ğ¾Ğ·Ğ²Ñ€Ğ°Ñ‚
                                        </Button>
                                    )}
                                </div>
                                {isAdmin && (
                                    <Button onClick={handleDelete} size="sm" variant="destructive" disabled={deleteMutation.isPending}>
                                        <Trash2 className="mr-2 h-4 w-4" />
                                        {deleteMutation.isPending ? "Ğ£Ğ´Ğ°Ğ»ĞµĞ½Ğ¸Ğµ..." : "Ğ£Ğ´Ğ°Ğ»Ğ¸Ñ‚ÑŒ"}
                                    </Button>
                                )}
                            </div>
                        </div>

                        {/* Ğ Ğ°Ğ·Ğ²Ğ¾Ñ€Ğ°Ñ‡Ğ¸Ğ²Ğ°ĞµĞ¼Ñ‹Ğ¹ Ğ±Ğ»Ğ¾Ğº Ñ ÑĞ¾ÑÑ‚Ğ°Ğ²Ğ¾Ğ¼ Ğ°Ñ€ĞµĞ½Ğ´Ñ‹ */}
                        {isExpanded && (
                            <div className="mt-3 pt-3 border-t border-dashed animate-in fade-in-0 slide-in-from-top-2 duration-300">
                                <div className="flex items-center gap-2 text-sm font-semibold text-gray-600 mb-2">
                                    <List className="w-4 h-4" />
                                    <span>Ğ¡Ğ¾ÑÑ‚Ğ°Ğ² Ğ°Ñ€ĞµĞ½Ğ´Ñ‹:</span>
                                </div>
                                <EquipmentWithAccessoriesList
                                    equipment={rental.equipment.map(equipmentItem => ({
                                        id: equipmentItem.id,
                                        name: `${equipmentItem.equipment_type} ${equipmentItem.brand} ${equipmentItem.name}`
                                    }))}
                                    accessoryLinks={rental.accessory_links || []}
                                    title=""
                                    showTitle={false}
                                    className="border-t-0 pt-0"
                                />
                            </div>
                        )}
                    </CardContent>
                </Card>
            </div>

            <ConfirmationDialog
                open={isConfirmingRevert}
                onOpenChange={setConfirmingRevert}
                title="ĞÑ‚Ğ¼ĞµĞ½Ğ¸Ñ‚ÑŒ Ğ²Ñ‹Ğ´Ğ°Ñ‡Ñƒ Ğ°Ñ€ĞµĞ½Ğ´Ñ‹?"
                description={`ĞÑ€ĞµĞ½Ğ´Ğ° #${rental.id} Ğ±ÑƒĞ´ĞµÑ‚ ÑƒĞ´Ğ°Ğ»ĞµĞ½Ğ°, Ğ° Ğ¸ÑÑ…Ğ¾Ğ´Ğ½Ñ‹Ğ¹ Ñ€ĞµĞ·ĞµÑ€Ğ² #${rental.reservation_id} ÑĞ½Ğ¾Ğ²Ğ° ÑÑ‚Ğ°Ğ½ĞµÑ‚ Ğ°ĞºÑ‚Ğ¸Ğ²Ğ½Ñ‹Ğ¼. Ğ­Ñ‚Ğ¾ Ğ´ĞµĞ¹ÑÑ‚Ğ²Ğ¸Ğµ Ğ½ĞµĞ»ÑŒĞ·Ñ Ğ±ÑƒĞ´ĞµÑ‚ Ğ¾Ñ‚Ğ¼ĞµĞ½Ğ¸Ñ‚ÑŒ.`}
                confirmText="Ğ”Ğ°, Ğ¾Ñ‚Ğ¼ĞµĞ½Ğ¸Ñ‚ÑŒ Ğ²Ñ‹Ğ´Ğ°Ñ‡Ñƒ"
                cancelText="ĞĞ°Ğ·Ğ°Ğ´"
                onConfirm={handleRevert}
                variant="destructive"
            />
        </>
    );
}

```


## <a name="srccomponentsadminAdminReservationCardtsx"></a>`src/components/admin/AdminReservationCard.tsx`

```tsx
// path: src/components/admin/AdminReservationCard.tsx

// src/components/admin/AdminReservationCard.tsx

import { useState, useMemo, useRef, useEffect } from "react";
import { useLocation, useNavigate } from "react-router-dom";
import { Card, CardContent } from "@/components/ui/card";
import { Button } from "@/components/ui/button";
import { Calendar, Edit, Package, Trash2, User, Truck, CheckCircle, AlertTriangle, XCircle, List } from "lucide-react";
import { formatDateEuropean, cn } from "@/lib/utils";
import type { AdminReservationOut } from "@/types/reservation";
import { useDeleteAdminReservation } from "@/hooks/useAdminReservations";
import { ReservationEditProvider } from "@/hooks/useInlineReservationEdit";
import EditableReservationCard from "@/components/reservation/EditableReservationCard";
import type { Equipment } from "@/types/equipment";
import { Checkbox } from "@/components/ui/checkbox";
import { useAdminReservationSelectionStore } from "@/store/adminReservationSelectionStore";
import EquipmentWithAccessoriesList from "@/components/shared/EquipmentWithAccessoriesList";
import FinancialInfoBlock from "@/components/shared/FinancialInfoBlock";
import { RESERVATION_CARD_STYLES } from "@/constants/statusStyles";

interface Props {
    reservation: AdminReservationOut;
    onConvertToRental: (reservation: AdminReservationOut) => void;
    equipmentMap: Map<number, Equipment>;
    highlightId?: number;
}

const getStatusInfo = (reservation: AdminReservationOut) => {
    const now = new Date();
    now.setHours(0, 0, 0, 0);
    const endDate = new Date(reservation.end_date);

    if (reservation.status === 'fulfilled') {
        return { text: "Ğ’Ñ‹Ğ¿Ğ¾Ğ»Ğ½ĞµĞ½", Icon: CheckCircle, className: "text-green-600 bg-green-50 border-green-200", isActionable: false };
    }
    if (reservation.status === 'cancelled') {
        return { text: "ĞÑ‚Ğ¼ĞµĞ½ĞµĞ½", Icon: XCircle, className: "text-gray-600 bg-gray-100 border-gray-200", isActionable: false };
    }
    if (endDate < now || reservation.status === 'overdue') {
        return { text: "ĞŸÑ€Ğ¾ÑÑ€Ğ¾Ñ‡ĞµĞ½", Icon: AlertTriangle, className: "text-orange-600 bg-orange-50 border-orange-200", isActionable: true };
    }
    return { text: "ĞĞºÑ‚Ğ¸Ğ²ĞµĞ½", Icon: Calendar, className: "text-blue-600 bg-blue-50 border-blue-200", isActionable: true };
};

export default function AdminReservationCard({ reservation, onConvertToRental, equipmentMap, highlightId }: Props) {
    const [isEditing, setIsEditing] = useState(false);
    const [isExpanded, setIsExpanded] = useState(false);
    const deleteReservationMutation = useDeleteAdminReservation();
    const cardRef = useRef<HTMLDivElement>(null);
    const navigate = useNavigate();
    const location = useLocation();

    const { selectedIds, toggleId } = useAdminReservationSelectionStore();
    const isSelected = selectedIds.includes(reservation.id);
    const isHighlighted = highlightId === reservation.id;

    const statusInfo = useMemo(() => getStatusInfo(reservation), [reservation]);

    useEffect(() => {
        if (isHighlighted && cardRef.current) {
            cardRef.current.scrollIntoView({
                behavior: "smooth",
                block: "center",
            });
        }
    }, [isHighlighted]);


    const handleDelete = () => {
        if (window.confirm(`Ğ’Ñ‹ ÑƒĞ²ĞµÑ€ĞµĞ½Ñ‹, Ñ‡Ñ‚Ğ¾ Ñ…Ğ¾Ñ‚Ğ¸Ñ‚Ğµ ÑƒĞ´Ğ°Ğ»Ğ¸Ñ‚ÑŒ Ñ€ĞµĞ·ĞµÑ€Ğ² #${reservation.id} Ğ´Ğ»Ñ ĞºĞ»Ğ¸ĞµĞ½Ñ‚Ğ° "${reservation.user_info.full_name}"?`)) {
            deleteReservationMutation.mutate(reservation.id);
        }
    };

    const handleNavigateToRental = () => {
        if (reservation.rental_id) {
            navigate('/admin/rentals', {
                state: {
                    highlightId: reservation.rental_id,
                    statusFilterOverride: 'all'
                }
            });
        }
    };

    const initialEquipmentForDisplay = useMemo(() =>
            reservation.equipment_ids
                .map(id => {
                    const equipment = equipmentMap.get(id);
                    if (!equipment) {
                        return { id, label: `ĞĞ±Ğ¾Ñ€ÑƒĞ´Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ #${id} (Ğ½Ğµ Ğ½Ğ°Ğ¹Ğ´ĞµĞ½Ğ¾)` };
                    }
                    return { id, label: `${equipment.equipment_type} ${equipment.brand} ${equipment.name}` };
                }),
        [reservation.equipment_ids, equipmentMap]
    );

    const equipmentListForDisplay = useMemo(() =>
        reservation.equipment_ids.map(id => {
            const equipment = equipmentMap.get(id);
            return equipment
                ? `${equipment.equipment_type} ${equipment.brand} ${equipment.name}`
                : `ĞĞ±Ğ¾Ñ€ÑƒĞ´Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ #${id} (Ğ½Ğµ Ğ½Ğ°Ğ¹Ğ´ĞµĞ½Ğ¾)`;
        }), [reservation.equipment_ids, equipmentMap]);

    if (isEditing) {
        return (
            <ReservationEditProvider
                reservation={reservation}
                initialEquipmentForDisplay={initialEquipmentForDisplay}
                onFullCancellation={handleDelete}
                isAdminContext={true}
                onFinishEditing={() => setIsEditing(false)}
            >
                <EditableReservationCard />
            </ReservationEditProvider>
        );
    }

    const statusClass = RESERVATION_CARD_STYLES[reservation.status] || RESERVATION_CARD_STYLES.default;
    
    const highlightClass = isHighlighted
        ? "ring-2 ring-offset-2 ring-amber-500 border-amber-400 bg-amber-50"
        : isSelected
            ? 'ring-2 ring-sky-500 border-sky-400'
            : 'border-gray-200';

    return (
        <div ref={cardRef} className={`relative w-full rounded-lg border transition-all hover:shadow-md ${highlightClass}`}>
            <div className="absolute top-4 left-4 z-10">
                <Checkbox
                    checked={isSelected}
                    onCheckedChange={() => toggleId(reservation.id)}
                    aria-label={`Ğ’Ñ‹Ğ±Ñ€Ğ°Ñ‚ÑŒ Ñ€ĞµĞ·ĞµÑ€Ğ² #${reservation.id}`}
                    className="bg-white h-5 w-5"
                />
            </div>
            <Card className={cn("w-full", statusClass)}>
                <CardContent className="p-4 pl-12">
                    <div className="flex flex-col md:flex-row gap-4 justify-between">
                        <div className="flex-1 space-y-2.5">
                            <div className="flex items-center gap-4">
                                <h3 className="font-bold text-lg text-indigo-700">Ğ ĞµĞ·ĞµÑ€Ğ² #{reservation.id}</h3>
                                <span className={`flex items-center gap-1.5 text-xs font-medium px-2 py-1 rounded-md border ${statusInfo.className}`}>
                                    <statusInfo.Icon className="w-3.5 h-3.5" />
                                    {statusInfo.text}
                                </span>
                            </div>
                            <div className="text-sm text-gray-700 space-y-1.5 pl-1">
                                <div className="flex items-center gap-2">
                                    <User className="w-4 h-4 text-gray-500" />
                                    <span>{reservation.user_info.full_name} ({reservation.user_info.email})</span>
                                </div>
                                <div className="flex items-center gap-2">
                                    <Calendar className="w-4 h-4 text-gray-500" />
                                    <span>{formatDateEuropean(reservation.start_date)} â€” {formatDateEuropean(reservation.end_date)}</span>
                                </div>
                                <div className="flex items-start gap-2">
                                    <Package className="w-4 h-4 text-gray-500 mt-1 flex-shrink-0" />
                                    <div className="flex-1">
                                        <div className="flex items-center text-left w-full">
                                            <span>ĞŸĞ¾Ğ·Ğ¸Ñ†Ğ¸Ğ¹ Ğ² Ñ€ĞµĞ·ĞµÑ€Ğ²Ğµ: {equipmentListForDisplay.length}</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        {/* Ğ¤Ğ¸Ğ½Ğ°Ğ½ÑĞ¾Ğ²Ñ‹Ğ¹ Ğ±Ğ»Ğ¾Ğº */}
                        <FinancialInfoBlock
                            totalCost={reservation.total_cost}
                            discountAmount={reservation.discount_amount}
                            promoCode={reservation.promo_code}
                            variant="admin"
                        />

                        <div className="flex md:flex-col items-center md:items-end justify-between md:justify-start gap-2 border-t md:border-t-0 md:border-l pt-3 md:pt-0 md:pl-4">
                            {statusInfo.isActionable ? (
                                <>
                                    <Button onClick={() => onConvertToRental(reservation)} size="sm" className="bg-green-600 hover:bg-green-700 w-full md:w-auto">
                                        <Truck className="mr-2 h-4 w-4" />
                                        Ğ’Ñ‹Ğ´Ğ°Ñ‚ÑŒ Ğ² Ğ°Ñ€ĞµĞ½Ğ´Ñƒ
                                    </Button>
                                    <Button onClick={() => setIsEditing(true)} size="sm" variant="outline" className="w-full md:w-auto">
                                        <Edit className="mr-2 h-4 w-4" />
                                        Ğ ĞµĞ´Ğ°ĞºÑ‚Ğ¸Ñ€Ğ¾Ğ²Ğ°Ñ‚ÑŒ
                                    </Button>
                                </>
                            ) : (
                                <div className="text-sm text-gray-500 flex items-center gap-2 pr-2">
                                    <span>Ğ”ĞµĞ¹ÑÑ‚Ğ²Ğ¸Ğ¹ Ğ½ĞµÑ‚</span>
                                </div>
                            )}

                            {/* ĞšĞ½Ğ¾Ğ¿ĞºĞ° Ğ¿ĞµÑ€ĞµÑ…Ğ¾Ğ´Ğ° Ğº Ğ°Ñ€ĞµĞ½Ğ´Ğµ Ğ´Ğ»Ñ Ğ²Ñ‹Ğ¿Ğ¾Ğ»Ğ½ĞµĞ½Ğ½Ñ‹Ñ… Ñ€ĞµĞ·ĞµÑ€Ğ²Ğ¾Ğ² */}
                            {reservation.status === 'fulfilled' && reservation.rental_id && (
                                <Button onClick={handleNavigateToRental} size="sm" variant="outline" className="w-full md:w-auto text-orange-600 hover:text-orange-700 hover:bg-orange-50 border-orange-200">
                                    <Truck className="mr-2 h-4 w-4" />
                                    ĞŸĞµÑ€ĞµĞ¹Ñ‚Ğ¸ Ğº Ğ°Ñ€ĞµĞ½Ğ´Ğµ
                                </Button>
                            )}

                            <Button onClick={handleDelete} size="sm" variant="destructive" disabled={deleteReservationMutation.isPending} className="w-full md:w-auto">
                                <Trash2 className="mr-2 h-4 w-4" />
                                {deleteReservationMutation.isPending ? "Ğ£Ğ´Ğ°Ğ»ĞµĞ½Ğ¸Ğµ..." : "Ğ£Ğ´Ğ°Ğ»Ğ¸Ñ‚ÑŒ"}
                            </Button>
                        </div>
                    </div>

                    {equipmentListForDisplay.length > 0 && (
                        <div className="mt-3 pt-3 border-t border-dashed animate-in fade-in-0 slide-in-from-top-2 duration-300">
                            <div className="flex items-center gap-2 text-sm font-semibold text-gray-600 mb-2">
                                <List className="w-4 h-4" />
                                <span>Ğ¡Ğ¾ÑÑ‚Ğ°Ğ² Ñ€ĞµĞ·ĞµÑ€Ğ²Ğ°:</span>
                            </div>
                            <EquipmentWithAccessoriesList
                                equipment={reservation.equipment_ids.map(equipmentId => {
                                    const equipment = equipmentMap.get(equipmentId);
                                    return {
                                        id: equipmentId,
                                        name: equipment
                                            ? `${equipment.equipment_type} ${equipment.brand} ${equipment.name}`
                                            : `ĞĞ±Ğ¾Ñ€ÑƒĞ´Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ #${equipmentId} (Ğ½Ğµ Ğ½Ğ°Ğ¹Ğ´ĞµĞ½Ğ¾)`
                                    };
                                })}
                                accessoryLinks={reservation.accessory_links || []}
                                title=""
                                showTitle={false}
                                className="border-t-0 pt-0"
                            />
                        </div>
                    )}
                </CardContent>
            </Card>
        </div>
    );
}

```


## <a name="srccomponentsadminAdminReservationToolbartsx"></a>`src/components/admin/AdminReservationToolbar.tsx`

```tsx
// path: src/components/admin/AdminReservationToolbar.tsx

// src/components/admin/AdminReservationToolbar.tsx

import { Button } from '@/components/ui/button';
import { Checkbox } from '@/components/ui/checkbox';
import { Trash2 } from 'lucide-react';
import { useAdminReservationSelectionStore } from '@/store/adminReservationSelectionStore';

interface Props {
    visibleReservationIds: number[];
    onBulkDelete: () => void;
    isDeleting: boolean;
}

export function AdminReservationToolbar({ visibleReservationIds, onBulkDelete, isDeleting }: Props) {
    const { selectedIds, setSelectedIds, clearSelection } = useAdminReservationSelectionStore();

    const isAllSelected = visibleReservationIds.length > 0 && selectedIds.length === visibleReservationIds.length;
    const isSomeSelected = selectedIds.length > 0 && selectedIds.length < visibleReservationIds.length;

    const handleSelectAll = (checked: boolean | 'indeterminate') => {
        if (checked === true) {
            setSelectedIds(visibleReservationIds);
        } else {
            clearSelection();
        }
    };

    return (
        <div className="flex items-center gap-4 p-3 bg-slate-50 border rounded-md mb-4 h-14">
            <div className="flex items-center gap-2">
                <Checkbox
                    id="select-all"
                    checked={isAllSelected ? true : (isSomeSelected ? 'indeterminate' : false)}
                    onCheckedChange={handleSelectAll}
                    aria-label="Ğ’Ñ‹Ğ±Ñ€Ğ°Ñ‚ÑŒ Ğ²ÑĞµ Ğ²Ğ¸Ğ´Ğ¸Ğ¼Ñ‹Ğµ Ñ€ĞµĞ·ĞµÑ€Ğ²Ñ‹"
                />
                <label htmlFor="select-all" className="text-sm font-medium text-slate-700 cursor-pointer">
                    Ğ’Ñ‹Ğ±Ñ€Ğ°Ñ‚ÑŒ Ğ²ÑĞµ
                </label>
            </div>

            {selectedIds.length > 0 && (
                <div className="flex items-center gap-4 animate-in fade-in-0 duration-300">
          <span className="text-sm text-slate-500">
            Ğ’Ñ‹Ğ±Ñ€Ğ°Ğ½Ğ¾: {selectedIds.length}
          </span>
                    <Button
                        size="sm"
                        variant="destructive"
                        onClick={onBulkDelete}
                        disabled={isDeleting}
                    >
                        <Trash2 className="w-4 h-4 mr-2" />
                        {isDeleting ? 'Ğ£Ğ´Ğ°Ğ»ĞµĞ½Ğ¸Ğµ...' : 'Ğ£Ğ´Ğ°Ğ»Ğ¸Ñ‚ÑŒ Ğ²Ñ‹Ğ±Ñ€Ğ°Ğ½Ğ½Ğ¾Ğµ'}
                    </Button>
                </div>
            )}
        </div>
    );
}

```


## <a name="srccomponentsadminAllRentalsListtsx"></a>`src/components/admin/AllRentalsList.tsx`

```tsx
// path: src/components/admin/AllRentalsList.tsx

// src/components/admin/AllRentalsList.tsx

// +++ Ğ”ĞĞ‘ĞĞ’Ğ¬Ğ¢Ğ• Ğ˜ĞœĞŸĞĞ Ğ¢ AdminRentalOut +++
import type { AdminRentalOut } from "@/types/rental";
import { ClipboardX } from "lucide-react";
import AdminRentalCard from "./AdminRentalCard";

// +++ Ğ˜Ğ—ĞœĞ•ĞĞ˜Ğ¢Ğ• Ğ˜ĞĞ¢Ğ•Ğ Ğ¤Ğ•Ğ™Ğ¡ Props +++
interface Props {
    rentals: AdminRentalOut[];
    onReturn: (rental: AdminRentalOut) => void;
    highlightId?: number | null;
}

export default function AllRentalsList({ rentals, onReturn, highlightId }: Props) {
    if (!rentals || rentals.length === 0) {
        return (
            <div className="flex flex-col items-center justify-center text-center p-12 space-y-4 bg-gray-50/50 rounded-lg border-2 border-dashed">
                <ClipboardX className="w-16 h-16 text-gray-400" />
                <h3 className="text-lg font-semibold text-gray-800">ĞÑ€ĞµĞ½Ğ´Ñ‹ Ğ½Ğµ Ğ½Ğ°Ğ¹Ğ´ĞµĞ½Ñ‹</h3>
                <p className="text-sm text-gray-500">ĞŸĞ¾Ğ¿Ñ€Ğ¾Ğ±ÑƒĞ¹Ñ‚Ğµ Ğ¸Ğ·Ğ¼ĞµĞ½Ğ¸Ñ‚ÑŒ Ñ„Ğ¸Ğ»ÑŒÑ‚Ñ€Ñ‹ Ğ¸Ğ»Ğ¸ Ğ¿Ğ¾Ğ¸ÑĞºĞ¾Ğ²Ñ‹Ğ¹ Ğ·Ğ°Ğ¿Ñ€Ğ¾Ñ.</p>
            </div>
        );
    }

    return (
        <div className="space-y-4">
            {/* +++ ĞŸĞ•Ğ Ğ•Ğ”ĞĞ™Ğ¢Ğ• ĞŸĞ ĞĞŸĞ¡ onReturn Ğ’ ĞšĞĞ Ğ¢ĞĞ§ĞšĞ£ +++ */}
            {rentals.map((rental) => (
                <AdminRentalCard key={rental.id} rental={rental} onReturn={onReturn} highlightId={highlightId} />
            ))}
        </div>
    );
}

```


## <a name="srccomponentsadminAllReservationsListtsx"></a>`src/components/admin/AllReservationsList.tsx`

```tsx
// path: src/components/admin/AllReservationsList.tsx

// src/components/admin/AllReservationsList.tsx

import type { AdminReservationOut } from "@/types/reservation";
import AdminReservationCard from "./AdminReservationCard";
import type { Equipment } from "@/types/equipment";

interface Props {
    reservations: AdminReservationOut[];
    onConvertToRental: (reservation: AdminReservationOut) => void;
    equipmentMap: Map<number, Equipment>;
    highlightId?: number;
}

export default function AllReservationsList({ reservations, onConvertToRental, equipmentMap, highlightId }: Props) {
    return (
        <div className="space-y-4">
            {reservations.map((reservation) => (
                <AdminReservationCard
                    key={reservation.id}
                    reservation={reservation}
                    onConvertToRental={onConvertToRental}
                    equipmentMap={equipmentMap}
                    highlightId={highlightId}
                />
            ))}
        </div>
    );
}

```


## <a name="srccomponentsadminAssociationTabletsx"></a>`src/components/admin/AssociationTable.tsx`

```tsx
// path: src/components/admin/AssociationTable.tsx

// src/components/admin/AssociationTable.tsx

import { useState, useMemo, useEffect } from "react";
import { useAdminAssociations, useCreateAssociation, useUpdateAssociation, useDeleteAssociation } from "@/hooks/useAdminAssociations";
// âŒ Ğ£Ğ”ĞĞ›Ğ•ĞĞ: Ğ‘Ğ¾Ğ»ÑŒÑˆĞµ Ğ½Ğµ Ğ¸ÑĞ¿Ğ¾Ğ»ÑŒĞ·ÑƒĞµĞ¼ Ğ¿Ğ°Ğ³Ğ¸Ğ½Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ½Ñ‹Ğ¹ Ñ…ÑƒĞº Ğ´Ğ»Ñ Ğ¾Ğ±Ğ¾Ñ€ÑƒĞ´Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ
// import { useEquipment } from "@/hooks/useEquipment";
// âœ… Ğ”ĞĞ‘ĞĞ’Ğ›Ğ•ĞĞ: Ğ˜ÑĞ¿Ğ¾Ğ»ÑŒĞ·ÑƒĞµĞ¼ Ñ…ÑƒĞº, ĞºĞ¾Ñ‚Ğ¾Ñ€Ñ‹Ğ¹ Ğ·Ğ°Ğ³Ñ€ÑƒĞ¶Ğ°ĞµÑ‚ ĞŸĞĞ›ĞĞ«Ğ™ ÑĞ¿Ğ¸ÑĞ¾Ğº Ğ¾Ğ±Ğ¾Ñ€ÑƒĞ´Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ Ğ´Ğ»Ñ Ğ½Ğ°ÑˆĞµĞ³Ğ¾ "ÑĞ¿Ñ€Ğ°Ğ²Ğ¾Ñ‡Ğ½Ğ¸ĞºĞ°"
import { useAllEquipment } from "@/hooks/useAllEquipment";
import { useForm, Controller } from "react-hook-form";
import { zodResolver } from "@hookform/resolvers/zod";
import { z } from "zod";
import type { Association } from "@/types/association";
// âŒ Ğ£Ğ”ĞĞ›Ğ•ĞĞ: Ğ­Ñ‚Ğ¾Ñ‚ Ñ‚Ğ¸Ğ¿ Ğ±Ğ¾Ğ»ÑŒÑˆĞµ Ğ½Ğµ Ğ½ÑƒĞ¶ĞµĞ½, Ñ‚Ğ°Ğº ĞºĞ°Ğº Ğ¼Ñ‹ Ğ½Ğµ Ñ€Ğ°Ğ±Ğ¾Ñ‚Ğ°ĞµĞ¼ Ñ Ğ¿Ğ°Ğ³Ğ¸Ğ½Ğ°Ñ†Ğ¸ĞµĞ¹ Ğ·Ğ´ĞµÑÑŒ
// import type { EquipmentListResponse } from "@/core/services/EquipmentService";

// UI Components
import { Button } from "@/components/ui/button";
import { Dialog, DialogContent, DialogHeader, DialogTitle, DialogFooter, DialogDescription } from "@/components/ui/dialog";
import { Input } from "@/components/ui/input";
import { Label } from "@/components/ui/label";
import { MultiSelect } from "@/components/ui/multi-select";
import { Table, TableBody, TableCell, TableHead, TableHeader, TableRow } from "@/components/ui/table";
import { Plus, Edit, Trash2, Tags, Loader2 } from "lucide-react";

const associationSchema = z.object({
    name: z.string().min(3, "ĞĞ°Ğ·Ğ²Ğ°Ğ½Ğ¸Ğµ Ğ¾Ğ±ÑĞ·Ğ°Ñ‚ĞµĞ»ÑŒĞ½Ğ¾"),
    description: z.string().optional(),
    sort_order: z.coerce.number(),
    equipment_ids: z.array(z.number()),
});
type AssociationFormData = z.infer<typeof associationSchema>;

// --- ĞšĞ¾Ğ¼Ğ¿Ğ¾Ğ½ĞµĞ½Ñ‚ Ğ´Ğ¸Ğ°Ğ»Ğ¾Ğ³Ğ¾Ğ²Ğ¾Ğ³Ğ¾ Ğ¾ĞºĞ½Ğ° (Ğ±ĞµĞ· Ğ¸Ğ·Ğ¼ĞµĞ½ĞµĞ½Ğ¸Ğ¹ Ğ² Ğ»Ğ¾Ğ³Ğ¸ĞºĞµ) ---
function AssociationDialog({ open, onClose, association, allEquipment }: {
    open: boolean;
    onClose: () => void;
    association: Association | null;
    allEquipment: { value: string, label: string }[];
}) {
    const createMutation = useCreateAssociation();
    const updateMutation = useUpdateAssociation();

    const {
        register,
        handleSubmit,
        control,
        reset,
        formState: { errors, isValid },
    } = useForm<AssociationFormData>({
        resolver: zodResolver(associationSchema),
        mode: "onChange",
    });

    useEffect(() => {
        if (open) {
            reset({
                name: association?.name ?? "",
                description: association?.description ?? "",
                sort_order: association?.sort_order ?? 0,
                equipment_ids: association?.equipment_ids ?? [],
            });
        }
    }, [association, open, reset]);

    const onSubmit = (data: AssociationFormData) => {
        const handleSuccess = () => {
            reset();
            onClose();
        };

        if (association) {
            updateMutation.mutate({ id: association.id, data }, { onSuccess: handleSuccess });
        } else {
            createMutation.mutate(data, { onSuccess: handleSuccess });
        }
    };

    return (
        <Dialog open={open} onOpenChange={onClose}>
            <DialogContent>
                <DialogHeader>
                    <DialogTitle>{association ? "Ğ ĞµĞ´Ğ°ĞºÑ‚Ğ¸Ñ€Ğ¾Ğ²Ğ°Ñ‚ÑŒ Ğ°ÑÑĞ¾Ñ†Ğ¸Ğ°Ñ†Ğ¸Ñ" : "ĞĞ¾Ğ²Ğ°Ñ Ğ°ÑÑĞ¾Ñ†Ğ¸Ğ°Ñ†Ğ¸Ñ"}</DialogTitle>
                    <DialogDescription>
                        {association ? `Ğ ĞµĞ´Ğ°ĞºÑ‚Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ "${association.name}"` : "Ğ¡Ğ¾Ğ·Ğ´Ğ°Ğ¹Ñ‚Ğµ Ğ½Ğ¾Ğ²ÑƒÑ Ğ¿Ğ¾Ğ´Ğ±Ğ¾Ñ€ĞºÑƒ Ğ¾Ğ±Ğ¾Ñ€ÑƒĞ´Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ."}
                    </DialogDescription>
                </DialogHeader>
                <form onSubmit={handleSubmit(onSubmit)} className="space-y-4 py-2">
                    <div>
                        <Label htmlFor="assoc-name">ĞĞ°Ğ·Ğ²Ğ°Ğ½Ğ¸Ğµ *</Label>
                        <Input id="assoc-name" {...register("name")} placeholder="ĞĞ°Ğ±Ğ¾Ñ€ Ğ´Ğ»Ñ ÑÑ‚Ñ€Ğ¸Ğ¼Ğ¸Ğ½Ğ³Ğ°" />
                        {errors.name && <p className="text-xs text-red-600 mt-1">{errors.name.message}</p>}
                    </div>
                    <div>
                        <Label htmlFor="assoc-sort">ĞŸĞ¾Ñ€ÑĞ´Ğ¾Ğº ÑĞ¾Ñ€Ñ‚Ğ¸Ñ€Ğ¾Ğ²ĞºĞ¸</Label>
                        <Input id="assoc-sort" type="number" {...register("sort_order")} />
                    </div>
                    <div>
                        <Label>ĞĞ±Ğ¾Ñ€ÑƒĞ´Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ Ğ² Ğ¿Ğ¾Ğ´Ğ±Ğ¾Ñ€ĞºĞµ</Label>
                        <Controller
                            name="equipment_ids"
                            control={control}
                            render={({ field }) => (
                                <MultiSelect
                                    placeholder="Ğ’Ñ‹Ğ±ĞµÑ€Ğ¸Ñ‚Ğµ Ğ¾Ğ±Ğ¾Ñ€ÑƒĞ´Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ..."
                                    options={allEquipment}
                                    value={field.value.map(String)}
                                    onValueChange={(selected) => field.onChange(selected.map(Number))}
                                />
                            )}
                        />
                    </div>
                    <DialogFooter>
                        <Button type="button" variant="ghost" onClick={onClose}>ĞÑ‚Ğ¼ĞµĞ½Ğ°</Button>
                        <Button type="submit" disabled={!isValid || createMutation.isPending || updateMutation.isPending}>
                            {createMutation.isPending || updateMutation.isPending ? "Ğ¡Ğ¾Ñ…Ñ€Ğ°Ğ½ĞµĞ½Ğ¸Ğµ..." : "Ğ¡Ğ¾Ñ…Ñ€Ğ°Ğ½Ğ¸Ñ‚ÑŒ"}
                        </Button>
                    </DialogFooter>
                </form>
            </DialogContent>
        </Dialog>
    );
}

// --- ĞÑĞ½Ğ¾Ğ²Ğ½Ğ¾Ğ¹ ĞºĞ¾Ğ¼Ğ¿Ğ¾Ğ½ĞµĞ½Ñ‚ Ñ‚Ğ°Ğ±Ğ»Ğ¸Ñ†Ñ‹ ---
export default function AssociationTable() {
    const { data: associations = [], isLoading } = useAdminAssociations();
    // âœ… Ğ˜Ğ—ĞœĞ•ĞĞ•ĞĞ: Ğ—Ğ°Ğ³Ñ€ÑƒĞ¶Ğ°ĞµĞ¼ Ğ²ĞµÑÑŒ ÑĞ¿Ğ¸ÑĞ¾Ğº Ğ¾Ğ±Ğ¾Ñ€ÑƒĞ´Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ Ğ¾Ğ´Ğ¸Ğ½ Ñ€Ğ°Ğ·.
    const { data: allEquipment = [] } = useAllEquipment();
    const deleteMutation = useDeleteAssociation();

    // âœ… Ğ˜Ğ—ĞœĞ•ĞĞ•ĞĞ: ĞŸÑ€ĞµĞ¾Ğ±Ñ€Ğ°Ğ·ÑƒĞµĞ¼ Ğ¿Ğ¾Ğ»Ğ½Ñ‹Ğ¹ ÑĞ¿Ğ¸ÑĞ¾Ğº Ğ² Ñ„Ğ¾Ñ€Ğ¼Ğ°Ñ‚ Ğ´Ğ»Ñ Ğ²Ñ‹Ğ¿Ğ°Ğ´Ğ°ÑÑ‰ĞµĞ³Ğ¾ Ğ¼ĞµĞ½Ñ.
    const equipmentOptions = useMemo(() =>
            allEquipment.map(e => ({ value: e.id.toString(), label: e.name })),
        [allEquipment]
    );

    const [isDialogOpen, setDialogOpen] = useState(false);
    const [editingAssoc, setEditingAssoc] = useState<Association | null>(null);

    const handleEdit = (assoc: Association) => { setEditingAssoc(assoc); setDialogOpen(true); };
    const handleCreate = () => { setEditingAssoc(null); setDialogOpen(true); };
    const handleDelete = (id: number) => { if (window.confirm("Ğ£Ğ´Ğ°Ğ»Ğ¸Ñ‚ÑŒ Ğ°ÑÑĞ¾Ñ†Ğ¸Ğ°Ñ†Ğ¸Ñ?")) deleteMutation.mutate(id); };

    if (isLoading) return <div className="flex items-center gap-2"><Loader2 className="animate-spin" /> Ğ—Ğ°Ğ³Ñ€ÑƒĞ·ĞºĞ°...</div>;

    return (
        <>
            <div className="flex justify-end mb-4">
                <Button onClick={handleCreate}><Plus className="mr-2 h-4 w-4" /> Ğ¡Ğ¾Ğ·Ğ´Ğ°Ñ‚ÑŒ</Button>
            </div>
            {associations.length > 0 ? (
                <Table>
                    <TableHeader>
                        <TableRow>
                            <TableHead>ĞŸĞ¾Ñ€ÑĞ´Ğ¾Ğº</TableHead>
                            <TableHead>ĞĞ°Ğ·Ğ²Ğ°Ğ½Ğ¸Ğµ</TableHead>
                            <TableHead>ĞšĞ¾Ğ»-Ğ²Ğ¾ ĞµĞ´.</TableHead>
                            <TableHead className="text-right">Ğ”ĞµĞ¹ÑÑ‚Ğ²Ğ¸Ñ</TableHead>
                        </TableRow>
                    </TableHeader>
                    <TableBody>
                        {associations.map((assoc) => (
                            <TableRow key={assoc.id}>
                                <TableCell>{assoc.sort_order}</TableCell>
                                <TableCell className="font-medium">{assoc.name}</TableCell>
                                <TableCell>{assoc.equipment_ids.length}</TableCell>
                                <TableCell className="text-right">
                                    <Button variant="ghost" size="icon" onClick={() => handleEdit(assoc)}><Edit className="h-4 w-4" /></Button>
                                    <Button variant="ghost" size="icon" onClick={() => handleDelete(assoc.id)}><Trash2 className="h-4 w-4 text-red-500" /></Button>
                                </TableCell>
                            </TableRow>
                        ))}
                    </TableBody>
                </Table>
            ) : (
                <div className="text-center py-10 border-dashed border-2 rounded-lg">
                    <Tags className="mx-auto h-12 w-12 text-gray-300" />
                    <h3 className="mt-2 text-sm font-semibold text-gray-800">ĞÑÑĞ¾Ñ†Ğ¸Ğ°Ñ†Ğ¸Ğ¸ Ğ½Ğµ ÑĞ¾Ğ·Ğ´Ğ°Ğ½Ñ‹</h3>
                    <p className="mt-1 text-sm text-gray-500">ĞĞ°Ğ¶Ğ¼Ğ¸Ñ‚Ğµ "Ğ¡Ğ¾Ğ·Ğ´Ğ°Ñ‚ÑŒ", Ñ‡Ñ‚Ğ¾Ğ±Ñ‹ Ğ´Ğ¾Ğ±Ğ°Ğ²Ğ¸Ñ‚ÑŒ Ğ¿ĞµÑ€Ğ²ÑƒÑ.</p>
                </div>
            )}
            {/* âœ… Ğ¢ĞµĞ¿ĞµÑ€ÑŒ Ğ² Ğ´Ğ¸Ğ°Ğ»Ğ¾Ğ³ Ğ³Ğ°Ñ€Ğ°Ğ½Ñ‚Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ½Ğ¾ Ğ¿ĞµÑ€ĞµĞ´Ğ°ĞµÑ‚ÑÑ ĞŸĞĞ›ĞĞ«Ğ™ ÑĞ¿Ğ¸ÑĞ¾Ğº Ğ¾Ğ±Ğ¾Ñ€ÑƒĞ´Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ */}
            {isDialogOpen && <AssociationDialog open={isDialogOpen} onClose={() => setDialogOpen(false)} association={editingAssoc} allEquipment={equipmentOptions} />}
        </>
    );
}

```


## <a name="srccomponentsadminConvertReservationDialogtsx"></a>`src/components/admin/ConvertReservationDialog.tsx`

```tsx
// path: src/components/admin/ConvertReservationDialog.tsx

// src/components/admin/ConvertReservationDialog.tsx

import { useState, useEffect, useMemo } from "react";
import { Dialog, DialogContent, DialogHeader, DialogTitle, DialogFooter, DialogDescription } from "@/components/ui/dialog";
import { Button } from "@/components/ui/button";
import { Label } from "@/components/ui/label";
import { Input } from "@/components/ui/input";
import { Textarea } from "@/components/ui/textarea";
import { useConvertReservationToRental } from "@/hooks/useAdminRentals";
import type { AdminReservationOut } from "@/types/reservation";
import type { Equipment } from "@/types/equipment";
import ReservationFinancialSummary from "./ReservationFinancialSummary";
import { useAvailabilityCheck } from "@/hooks/useAvailabilityCheck";
import { ConfirmationDialog } from "@/components/ui/confirmation-dialog";
import type { AxiosError } from "axios";
import { addDays } from "date-fns"; // +++ 1. Ğ”ĞĞ‘ĞĞ’Ğ¬Ğ¢Ğ• Ğ­Ğ¢ĞĞ¢ Ğ˜ĞœĞŸĞĞ Ğ¢

interface Props {
    reservation: AdminReservationOut | null;
    open: boolean;
    onClose: () => void;
    equipmentMap: Map<number, Equipment>;
}

export default function ConvertReservationDialog({ reservation, open, onClose, equipmentMap }: Props) {
    const [notes, setNotes] = useState("");
    const [deposit, setDeposit] = useState("0");
    const [prepayment, setPrepayment] = useState("0");
    const convertMutation = useConvertReservationToRental();
    const [holidayConflict, setHolidayConflict] = useState<string | null>(null);

    // +++ ĞĞĞ§ĞĞ›Ğ: Ğ˜Ğ—ĞœĞ•ĞĞ•ĞĞĞĞ¯ Ğ›ĞĞ“Ğ˜ĞšĞ Ğ ĞĞ¡Ğ§Ğ•Ğ¢Ğ Ğ”ĞĞ¢ +++
    const { newStartDate, newEndDate } = useMemo(() => {
        const today = new Date();
        today.setHours(0, 0, 0, 0);

        if (!reservation) {
            return { newStartDate: today, newEndDate: addDays(today, 1) };
        }

        const originalEndDate = new Date(reservation.end_date);

        // 2. ĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑĞµĞ¼, ĞµÑĞ»Ğ¸ Ğ´Ğ°Ñ‚Ğ° Ğ¾ĞºĞ¾Ğ½Ñ‡Ğ°Ğ½Ğ¸Ñ Ñ€ĞµĞ·ĞµÑ€Ğ²Ğ° ÑĞµĞ³Ğ¾Ğ´Ğ½Ñ Ğ¸Ğ»Ğ¸ ÑƒĞ¶Ğµ Ğ¿Ñ€Ğ¾ÑˆĞ»Ğ°.
        // Ğ•ÑĞ»Ğ¸ ÑÑ‚Ğ¾ Ñ‚Ğ°Ğº, ÑƒÑÑ‚Ğ°Ğ½Ğ°Ğ²Ğ»Ğ¸Ğ²Ğ°ĞµĞ¼ Ğ½Ğ¾Ğ²ÑƒÑ Ğ´Ğ°Ñ‚Ñƒ Ğ¾ĞºĞ¾Ğ½Ñ‡Ğ°Ğ½Ğ¸Ñ Ğ½Ğ° Ğ·Ğ°Ğ²Ñ‚Ñ€Ğ°.
        const finalEndDate = originalEndDate <= today
            ? addDays(today, 1)
            : originalEndDate;

        return { newStartDate: today, newEndDate: finalEndDate };
    }, [reservation]);
    // +++ ĞšĞĞĞ•Ğ¦: Ğ˜Ğ—ĞœĞ•ĞĞ•ĞĞĞĞ¯ Ğ›ĞĞ“Ğ˜ĞšĞ +++

    const { hasConflicts, conflictingItemIds, isLoading: isCheckingAvailability } = useAvailabilityCheck({
        equipmentIds: reservation?.equipment_ids || [],
        startDate: newStartDate,
        endDate: newEndDate,
        excludeReservationId: reservation?.id,
    });

    useEffect(() => {
        if (!open) {
            setNotes("");
            setDeposit("0");
            setPrepayment("0");
            setHolidayConflict(null);
        }
    }, [open]);

    const handleSubmit = async (force: boolean = false) => {
        if (!reservation) return;

        try {
            await convertMutation.mutateAsync({
                reservationId: reservation.id,
                data: {
                    notes_on_issue: notes,
                    deposit_amount: parseFloat(deposit) || 0,
                    prepayment_amount: parseFloat(prepayment) || 0,
                    force_issue_on_holiday: force,
                },
            });
            onClose();
        } catch (error) {
            const axiosError = error as AxiosError<{ detail?: { error_type?: string; message?: string } }>;
            const detail = axiosError.response?.data?.detail;

            if (axiosError.response?.status === 409 && detail?.error_type === "ISSUE_ON_HOLIDAY") {
                setHolidayConflict(detail.message || "ĞŸĞ¾Ğ´Ñ‚Ğ²ĞµÑ€Ğ´Ğ¸Ñ‚Ğµ Ğ´ĞµĞ¹ÑÑ‚Ğ²Ğ¸Ğµ.");
            }
        }
    };

    const handleForceSubmit = () => {
        setHolidayConflict(null);
        void handleSubmit(true);
    };

    if (!reservation) return null;

    return (
        <>
            <Dialog open={open} onOpenChange={onClose}>
                <DialogContent className="sm:max-w-lg">
                    <DialogHeader>
                        <DialogTitle>Ğ’Ñ‹Ğ´Ğ°Ñ‡Ğ° Ğ°Ñ€ĞµĞ½Ğ´Ñ‹ Ğ¸Ğ· Ñ€ĞµĞ·ĞµÑ€Ğ²Ğ° #{reservation.id}</DialogTitle>
                        <DialogDescription>
                            Ğ”Ğ»Ñ ĞºĞ»Ğ¸ĞµĞ½Ñ‚Ğ°: <strong>{reservation.user_info.full_name}</strong>
                        </DialogDescription>
                    </DialogHeader>

                    <div className="space-y-4 py-2">
                        <ReservationFinancialSummary
                            reservation={reservation}
                            open={open}
                            hasConflicts={hasConflicts}
                            conflictingItemIds={conflictingItemIds}
                            isCheckingAvailability={isCheckingAvailability}
                            equipmentMap={equipmentMap}
                        />

                        <div>
                            <Label htmlFor="deposit_amount">Ğ¡ÑƒĞ¼Ğ¼Ğ° Ğ·Ğ°Ğ»Ğ¾Ğ³Ğ° (â‚½)</Label>
                            <Input id="deposit_amount" type="number" value={deposit} onChange={(e) => setDeposit(e.target.value)} placeholder="0" />
                        </div>
                        <div>
                            <Label htmlFor="prepayment_amount">ĞŸÑ€ĞµĞ´Ğ¾Ğ¿Ğ»Ğ°Ñ‚Ğ° (â‚½)</Label>
                            <Input id="prepayment_amount" type="number" value={prepayment} onChange={(e) => setPrepayment(e.target.value)} placeholder="0" />
                        </div>
                        <div>
                            <Label htmlFor="notes_on_issue">Ğ—Ğ°Ğ¼ĞµÑ‚ĞºĞ¸ Ğ¿Ñ€Ğ¸ Ğ²Ñ‹Ğ´Ğ°Ñ‡Ğµ</Label>
                            <Textarea id="notes_on_issue" value={notes} onChange={(e) => setNotes(e.target.value)} placeholder="ĞĞ°Ğ¿Ñ€Ğ¸Ğ¼ĞµÑ€: Ğ¼ĞµĞ»ĞºĞ°Ñ Ñ†Ğ°Ñ€Ğ°Ğ¿Ğ¸Ğ½Ğ° Ğ½Ğ° ĞºĞ¾Ñ€Ğ¿ÑƒÑĞµ..." />
                        </div>
                    </div>

                    <DialogFooter>
                        <Button variant="ghost" onClick={onClose}>ĞÑ‚Ğ¼ĞµĞ½Ğ°</Button>
                        <Button onClick={() => handleSubmit(false)} disabled={convertMutation.isPending || isCheckingAvailability || hasConflicts}>
                            {convertMutation.isPending ? "ĞĞ±Ñ€Ğ°Ğ±Ğ¾Ñ‚ĞºĞ°..." : "ĞŸĞ¾Ğ´Ñ‚Ğ²ĞµÑ€Ğ´Ğ¸Ñ‚ÑŒ Ğ¸ Ğ²Ñ‹Ğ´Ğ°Ñ‚ÑŒ"}
                        </Button>
                    </DialogFooter>
                </DialogContent>
            </Dialog>

            <ConfirmationDialog
                open={!!holidayConflict}
                onOpenChange={() => setHolidayConflict(null)}
                title="ĞŸĞ¾Ğ´Ñ‚Ğ²ĞµÑ€Ğ¶Ğ´ĞµĞ½Ğ¸Ğµ Ğ²Ñ‹Ğ´Ğ°Ñ‡Ğ¸"
                description={holidayConflict || ""}
                confirmText="Ğ”Ğ°, Ğ²Ñ‹Ğ´Ğ°Ñ‚ÑŒ"
                cancelText="ĞÑ‚Ğ¼ĞµĞ½Ğ°"
                onConfirm={handleForceSubmit}
                variant="destructive"
            />
        </>
    );
}

```


## <a name="srccomponentsadminCreateReservationDialogtsx"></a>`src/components/admin/CreateReservationDialog.tsx`

```tsx
// path: src/components/admin/CreateReservationDialog.tsx

// src/components/admin/CreateReservationDialog.tsx
import { Dialog, DialogContent, DialogHeader, DialogTitle, DialogFooter, DialogDescription } from "@/components/ui/dialog";
import { Button } from "@/components/ui/button";
import { ArrowRight, ArrowLeft } from "lucide-react";
import { useCreateReservationDialog } from "@/hooks/admin/create-reservation/useCreateReservationDialog";
import { CreateReservationStep1Details } from "./CreateReservationStep1Details";
import { CreateReservationStep2Accessories } from "./CreateReservationStep2Accessories";
import FinancialSummaryBlock from "@/components/shared/FinancialSummaryBlock";

interface Props {
    isOpen: boolean;
    onClose: () => void;
}

export default function CreateReservationDialog({ isOpen, onClose }: Props) {
    const {
        step, setStep, form, users, isLoadingUsers, clientPopoverOpen,
        setClientPopoverOpen, equipmentSearch, setEquipmentSearch,
        isLoadingEquipment, filteredAndGroupedEquipment, availabilityMap,
        equipmentWithAccessories, isLoadingAvailability, hasConflictsInSelection,
        isSubmitting, handleNextStep, onSubmit, handleCloseDialog,
        financialData // âœ… 2. ĞŸĞ¾Ğ»ÑƒÑ‡Ğ°ĞµĞ¼ ĞµĞ´Ğ¸Ğ½Ñ‹Ğ¹ Ğ¾Ğ±ÑŠĞµĞºÑ‚ Ñ Ñ„Ğ¸Ğ½Ğ°Ğ½ÑĞ¾Ğ²Ñ‹Ğ¼Ğ¸ Ğ´Ğ°Ğ½Ğ½Ñ‹Ğ¼Ğ¸
    } = useCreateReservationDialog({ isOpen, onClose });

    const { formState: { isValid } } = form;

    const formId = "create-reservation-admin-form";

    return (
        <Dialog open={isOpen} onOpenChange={onClose}>
            <DialogContent className="sm:max-w-[700px] h-[90vh] flex flex-col p-0">
                <DialogHeader className="p-6 pb-4">
                    <DialogTitle>Ğ¡Ğ¾Ğ·Ğ´Ğ°Ñ‚ÑŒ Ğ½Ğ¾Ğ²Ñ‹Ğ¹ Ñ€ĞµĞ·ĞµÑ€Ğ² (Ğ¨Ğ°Ğ³ {step === 'details' ? 1 : 2} Ğ¸Ğ· 2)</DialogTitle>
                    <DialogDescription>
                        {step === 'details'
                            ? "Ğ’Ñ‹Ğ±ĞµÑ€Ğ¸Ñ‚Ğµ ĞºĞ»Ğ¸ĞµĞ½Ñ‚Ğ°, Ğ´Ğ°Ñ‚Ñ‹ Ğ¸ Ğ¾Ğ±Ğ¾Ñ€ÑƒĞ´Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ Ğ´Ğ»Ñ ÑĞ¾Ğ·Ğ´Ğ°Ğ½Ğ¸Ñ."
                            : "Ğ’Ñ‹Ğ±ĞµÑ€Ğ¸Ñ‚Ğµ Ğ´Ğ¾Ğ¿Ğ¾Ğ»Ğ½Ğ¸Ñ‚ĞµĞ»ÑŒĞ½Ñ‹Ğµ Ğ°ĞºÑĞµÑÑÑƒĞ°Ñ€Ñ‹ Ğ´Ğ»Ñ Ğ¿Ğ¾Ğ·Ğ¸Ñ†Ğ¸Ğ¹ Ğ² Ñ€ĞµĞ·ĞµÑ€Ğ²Ğµ."
                        }
                    </DialogDescription>
                </DialogHeader>

                <div className="flex-1 overflow-y-auto px-6">
                    <form id={formId} onSubmit={onSubmit} className="contents">
                        {step === 'details' ? (
                            <CreateReservationStep1Details
                                form={form}
                                users={users}
                                isLoadingUsers={isLoadingUsers}
                                clientPopoverOpen={clientPopoverOpen}
                                setClientPopoverOpen={setClientPopoverOpen}
                                equipmentSearch={equipmentSearch}
                                setEquipmentSearch={setEquipmentSearch}
                                isLoadingEquipment={isLoadingEquipment}
                                filteredAndGroupedEquipment={filteredAndGroupedEquipment}
                                availabilityMap={availabilityMap}
                            />
                        ) : (
                            <CreateReservationStep2Accessories
                                form={form}
                                equipmentWithAccessories={equipmentWithAccessories}
                            />
                        )}
                    </form>
                </div>

                <DialogFooter className="p-6 pt-4 border-t items-center">
                    {step === 'details' ? (
                        <>
                            {/* Ğ˜ÑĞ¿Ğ¾Ğ»ÑŒĞ·ÑƒĞµĞ¼ ÑƒĞ½Ğ¸Ğ²ĞµÑ€ÑĞ°Ğ»ÑŒĞ½Ñ‹Ğ¹ ĞºĞ¾Ğ¼Ğ¿Ğ¾Ğ½ĞµĞ½Ñ‚ Ğ´Ğ»Ñ Ğ¾Ñ‚Ğ¾Ğ±Ñ€Ğ°Ğ¶ĞµĞ½Ğ¸Ñ ÑĞ²Ğ¾Ğ´ĞºĞ¸ */}
                            <FinancialSummaryBlock
                                priceDetails={financialData.priceDetails}
                                promoCode={financialData.promoCode}
                                setPromoCode={financialData.setPromoCode}
                                applyPromoCode={financialData.applyPromoCode}
                                promoCodeMessage={financialData.promoCodeMessage}
                                isLoading={isLoadingAvailability}
                                isApplyingPromoCode={financialData.isApplyingPromoCode}
                                isSubmitting={isSubmitting}
                                hasConflicts={hasConflictsInSelection}
                                variant="admin"
                                showActions={false}
                            />
                            <Button type="button" variant="ghost" onClick={handleCloseDialog}>ĞÑ‚Ğ¼ĞµĞ½Ğ°</Button>
                            <Button type="button" onClick={handleNextStep} disabled={!isValid || isSubmitting || hasConflictsInSelection || isLoadingAvailability}>
                                {equipmentWithAccessories.length > 0 ? "Ğ”Ğ°Ğ»ĞµĞµ" : "Ğ¡Ğ¾Ğ·Ğ´Ğ°Ñ‚ÑŒ Ñ€ĞµĞ·ĞµÑ€Ğ²"}
                                {equipmentWithAccessories.length > 0 && <ArrowRight className="ml-2 h-4 w-4" />}
                            </Button>
                        </>
                    ) : (
                        <>
                            <Button type="button" variant="ghost" onClick={() => setStep('details')} className="mr-auto">
                                <ArrowLeft className="mr-2 h-4 w-4" /> ĞĞ°Ğ·Ğ°Ğ´
                            </Button>
                            <Button type="button" variant="ghost" onClick={handleCloseDialog}>ĞÑ‚Ğ¼ĞµĞ½Ğ°</Button>
                            <Button type="submit" form={formId} disabled={isSubmitting}>
                                {isSubmitting ? "Ğ¡Ğ¾Ğ·Ğ´Ğ°Ğ½Ğ¸Ğµ..." : "Ğ¡Ğ¾Ğ·Ğ´Ğ°Ñ‚ÑŒ Ñ€ĞµĞ·ĞµÑ€Ğ²"}
                            </Button>
                        </>
                    )}
                </DialogFooter>
            </DialogContent>
        </Dialog>
    );
}

```


## <a name="srccomponentsadminCreateReservationStep1Detailstsx"></a>`src/components/admin/CreateReservationStep1Details.tsx`

```tsx
// path: src/components/admin/CreateReservationStep1Details.tsx

// src/components/admin/CreateReservationStep1Details.tsx
import { useState } from "react";
import { Controller, UseFormReturn } from "react-hook-form";
import { Input } from "@/components/ui/input";
import { Label } from "@/components/ui/label";
import { Popover, PopoverContent, PopoverTrigger } from "@/components/ui/popover";
// âœ… Ğ˜Ğ¡ĞŸĞ ĞĞ’Ğ›Ğ•ĞĞ˜Ğ•: Ğ”Ğ¾Ğ±Ğ°Ğ²Ğ»ÑĞµĞ¼ CommandInput Ğ² Ğ¸Ğ¼Ğ¿Ğ¾Ñ€Ñ‚
import { Command, CommandEmpty, CommandGroup, CommandInput, CommandItem, CommandList } from "@/components/ui/command";
import { Button } from "@/components/ui/button";
import { Checkbox } from "@/components/ui/checkbox";
import { Check, ChevronsUpDown, Search, ChevronRight } from "lucide-react";
import type { CreateReservationFormData } from "@/hooks/admin/create-reservation/useCreateReservationForm";
import type { UserOut } from "@/types/user";
import type { Equipment } from "@/types/equipment";
import type { AvailabilityInfo } from "@/types/availability";

const EquipmentNode = ({ item, isChecked, onCheckedChange, availability }: {
    item: Equipment;
    isChecked: boolean;
    onCheckedChange: (checked: boolean) => void;
    availability?: AvailabilityInfo;
}) => {
    const hasConflict = !!availability && availability.status !== 'available';
    const conflictColorClass = availability?.status === 'rented' ? 'bg-red-100' : 'bg-amber-100';
    const hoverClass = hasConflict ? '' : 'hover:bg-gray-50';

    return (
        <div className={`p-2 rounded-md transition-colors ${hasConflict ? conflictColorClass : ''} ${hoverClass}`}>
            <div className="flex items-center justify-between">
                <div className="flex items-center gap-3 flex-1">
                    <Checkbox id={`eq-${item.id}`} checked={isChecked} onCheckedChange={onCheckedChange} />
                    <Label htmlFor={`eq-${item.id}`} className="font-normal w-full cursor-pointer text-sm">{item.brand} {item.name}</Label>
                </div>
                {hasConflict && <span className="text-xs font-medium">{availability?.status === 'rented' ? 'ĞÑ€ĞµĞ½Ğ´Ğ°' : 'Ğ ĞµĞ·ĞµÑ€Ğ²'}</span>}
            </div>
            {hasConflict && availability?.details && <div className="text-xs text-gray-600 mt-1 pl-8">- {availability.details}</div>}
        </div>
    );
};

interface Props {
    form: UseFormReturn<CreateReservationFormData>;
    users?: UserOut[];
    isLoadingUsers: boolean;
    clientPopoverOpen: boolean;
    setClientPopoverOpen: (isOpen: boolean) => void;
    equipmentSearch: string;
    setEquipmentSearch: (query: string) => void;
    isLoadingEquipment: boolean;
    filteredAndGroupedEquipment: { tree: Record<string, Record<string, Equipment[]>>, visibleIds: number[] };
    availabilityMap: Record<number, AvailabilityInfo>;
}

export const CreateReservationStep1Details = ({
                                                  form, users, isLoadingUsers, clientPopoverOpen, setClientPopoverOpen,
                                                  equipmentSearch, setEquipmentSearch, isLoadingEquipment,
                                                  filteredAndGroupedEquipment, availabilityMap
                                              }: Props) => {
    const { register, control, formState: { errors } } = form;
    const [collapsedSections, setCollapsedSections] = useState<Record<string, boolean>>({});

    const toggleSection = (key: string) => {
        setCollapsedSections(prev => ({ ...prev, [key]: !prev[key] }));
    };

    return (
        <div className="space-y-4">
            <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                    <Label>ĞŸĞ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ÑŒ *</Label>
                    <Controller
                        control={control}
                        name="user_id"
                        render={({ field }) => (
                            <Popover open={clientPopoverOpen} onOpenChange={setClientPopoverOpen}>
                                <PopoverTrigger asChild>
                                    <Button variant="outline" role="combobox" className="w-full justify-between" disabled={isLoadingUsers}>
                                        {field.value ? users?.find(u => u.id === field.value)?.full_name : "Ğ’Ñ‹Ğ±ĞµÑ€Ğ¸Ñ‚Ğµ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ñ..."}
                                        <ChevronsUpDown className="ml-2 h-4 w-4 shrink-0 opacity-50" />
                                    </Button>
                                </PopoverTrigger>
                                <PopoverContent className="w-[--radix-popover-trigger-width] p-0">
                                    <Command>
                                        <CommandInput placeholder="ĞŸĞ¾Ğ¸ÑĞº Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ñ..." />
                                        <CommandList><CommandEmpty>ĞŸĞ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ğ¸ Ğ½Ğµ Ğ½Ğ°Ğ¹Ğ´ĞµĞ½Ñ‹.</CommandEmpty>
                                            <CommandGroup>
                                                {users?.map((user) => (
                                                    <CommandItem key={user.id} value={`${user.full_name} ${user.email}`} onSelect={() => { form.setValue("user_id", user.id, { shouldValidate: true }); setClientPopoverOpen(false); }}>
                                                        <Check className={`mr-2 h-4 w-4 ${field.value === user.id ? "opacity-100" : "opacity-0"}`} />
                                                        {user.full_name}
                                                    </CommandItem>
                                                ))}
                                            </CommandGroup>
                                        </CommandList>
                                    </Command>
                                </PopoverContent>
                            </Popover>
                        )}
                    />
                    {errors.user_id && <p className="text-xs text-red-600 mt-1">{errors.user_id.message}</p>}
                </div>
                <div className="grid grid-cols-2 gap-2">
                    <div><Label htmlFor="start_date">ĞĞ°Ñ‡Ğ°Ğ»Ğ¾ *</Label><Input id="start_date" type="date" {...register("start_date")} />{errors.start_date && <p className="text-xs text-red-600 mt-1">{errors.start_date.message}</p>}</div>
                    <div><Label htmlFor="end_date">ĞĞºĞ¾Ğ½Ñ‡Ğ°Ğ½Ğ¸Ğµ *</Label><Input id="end_date" type="date" {...register("end_date")} />{errors.end_date && <p className="text-xs text-red-600 mt-1">{errors.end_date.message}</p>}</div>
                </div>
            </div>

            <div className="space-y-2">
                <Label>ĞĞ±Ğ¾Ñ€ÑƒĞ´Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ *</Label>
                <div className="relative"><Search className="absolute left-3 top-2.5 h-4 w-4 text-muted-foreground" /><Input placeholder="ĞŸĞ¾Ğ¸ÑĞº..." value={equipmentSearch} onChange={(e) => setEquipmentSearch(e.target.value)} className="pl-10" /></div>
                <div className="rounded-md border p-2">
                    {isLoadingEquipment ? <p className="text-center py-4">Ğ—Ğ°Ğ³Ñ€ÑƒĞ·ĞºĞ°...</p> : (
                        <Controller name="equipment_ids" control={control}
                                    render={({ field }) => (
                                        <div className="space-y-3">
                                            {Object.keys(filteredAndGroupedEquipment.tree).map(type => {
                                                const isTypeCollapsed = collapsedSections[type];
                                                return (
                                                    <div key={type}>
                                                        <button type="button" onClick={() => toggleSection(type)} className="w-full flex items-center gap-1 font-semibold text-md sticky top-0 bg-white/80 backdrop-blur-sm py-1 cursor-pointer z-10">
                                                            <ChevronRight className={`w-4 h-4 transition-transform ${!isTypeCollapsed ? 'rotate-90' : ''}`} />
                                                            {type}
                                                        </button>
                                                        {!isTypeCollapsed && Object.keys(filteredAndGroupedEquipment.tree[type]).map(brand => {
                                                            const brandKey = `${type}-${brand}`;
                                                            const isBrandCollapsed = collapsedSections[brandKey];
                                                            return (
                                                                <div key={brandKey} className="pl-4">
                                                                    <button type="button" onClick={() => toggleSection(brandKey)} className="w-full flex items-center gap-1 font-medium text-sm text-gray-600 hover:text-black">
                                                                        <ChevronRight className={`w-4 h-4 transition-transform ${!isBrandCollapsed ? 'rotate-90' : ''}`} />
                                                                        {brand}
                                                                    </button>
                                                                    {!isBrandCollapsed && (
                                                                        <div className="space-y-1 pl-4 border-l ml-2 py-1">
                                                                            {filteredAndGroupedEquipment.tree[type][brand].map(item => (
                                                                                <EquipmentNode key={item.id} item={item} availability={availabilityMap[item.id]}
                                                                                               isChecked={field.value?.includes(item.id)}
                                                                                               onCheckedChange={(checked) => field.onChange(checked ? [...field.value, item.id] : field.value.filter(id => id !== item.id))} />
                                                                            ))}
                                                                        </div>
                                                                    )}
                                                                </div>
                                                            )})}
                                                    </div>
                                                )})}
                                        </div>
                                    )}
                        />
                    )}
                </div>
                {errors.equipment_ids && <p className="text-xs text-red-600 mt-1">{errors.equipment_ids.message}</p>}
            </div>
        </div>
    );
};

```


## <a name="srccomponentsadminCreateReservationStep2Accessoriestsx"></a>`src/components/admin/CreateReservationStep2Accessories.tsx`

```tsx
// path: src/components/admin/CreateReservationStep2Accessories.tsx

// src/components/admin/CreateReservationStep2Accessories.tsx
import { Controller, UseFormReturn } from "react-hook-form";
import { Card, CardContent, CardHeader, CardTitle } from "@/components/ui/card";
import { Checkbox } from "@/components/ui/checkbox";
import { Label } from "@/components/ui/label";
import { ScrollArea } from "@/components/ui/scroll-area";
import { Paperclip } from "lucide-react";
import type { CreateReservationFormData } from "@/hooks/admin/create-reservation/useCreateReservationForm";
import type { Equipment } from "@/types/equipment";

interface Props {
    form: UseFormReturn<CreateReservationFormData>;
    equipmentWithAccessories: Equipment[];
}

export const CreateReservationStep2Accessories = ({ form, equipmentWithAccessories }: Props) => {
    const { control } = form;

    return (
        <div className="space-y-4 overflow-hidden flex flex-col flex-1">
            <ScrollArea className="flex-1 -mx-6 px-6">
                <div className="space-y-4 pb-4">
                    {equipmentWithAccessories.map(equipmentItem => (
                        <Card key={equipmentItem.id}>
                            <CardHeader className="pb-2">
                                <CardTitle className="text-base flex items-center gap-2">
                                    <Paperclip className="h-4 w-4" />
                                    {equipmentItem.name}
                                </CardTitle>
                            </CardHeader>
                            <CardContent>
                                <Controller
                                    name={`selected_accessories.${equipmentItem.id}`}
                                    control={control}
                                    render={({ field }) => (
                                        <div className="space-y-2">
                                            {equipmentItem.accessories.map(acc => (
                                                <div key={acc.id} className="flex items-center justify-between hover:bg-slate-50 p-2 rounded">
                                                    <Label htmlFor={`acc-${equipmentItem.id}-${acc.id}`} className="flex items-center gap-2 font-normal cursor-pointer">
                                                        <Checkbox id={`acc-${equipmentItem.id}-${acc.id}`}
                                                                  checked={field.value?.includes(acc.id)}
                                                                  onCheckedChange={(checked) => {
                                                                      const currentIds = field.value || [];
                                                                      const newIds = checked ? [...currentIds, acc.id] : currentIds.filter(id => id !== acc.id);
                                                                      field.onChange(newIds);
                                                                  }}
                                                        />
                                                        {acc.name}
                                                    </Label>
                                                    <span className="text-xs text-muted-foreground">{acc.price} â‚½</span>
                                                </div>
                                            ))}
                                        </div>
                                    )}
                                />
                            </CardContent>
                        </Card>
                    ))}
                </div>
            </ScrollArea>
        </div>
    );
};

```


## <a name="srccomponentsadminDurationDiscountManagertsx"></a>`src/components/admin/DurationDiscountManager.tsx`

```tsx
// path: src/components/admin/DurationDiscountManager.tsx

// src/components/admin/DurationDiscountManager.tsx

import { useState, useMemo } from 'react';
import { useDurationDiscounts, useCreateDurationDiscount, useDeleteDurationDiscount } from '@/hooks/useAdminDiscounts';
// +++ ĞĞĞ§ĞĞ›Ğ Ğ˜Ğ—ĞœĞ•ĞĞ•ĞĞ˜Ğ™: Ğ˜ÑĞ¿Ñ€Ğ°Ğ²Ğ»ÑĞµĞ¼ Ğ¸Ğ¼Ğ¿Ğ¾Ñ€Ñ‚ Ñ‚Ğ¸Ğ¿Ğ¾Ğ² +++
import type { DiscountPayload, DurationDiscount } from '@/types/discount';
// +++ ĞšĞĞĞ•Ğ¦ Ğ˜Ğ—ĞœĞ•ĞĞ•ĞĞ˜Ğ™ +++
import { Button } from '@/components/ui/button';
import { Input } from '@/components/ui/input';
import { Table, TableBody, TableCell, TableHead, TableHeader, TableRow } from '@/components/ui/table';
import { PlusCircle, Trash2, Loader2, ChevronLeft, ChevronRight } from 'lucide-react';
import { Alert, AlertDescription, AlertTitle } from "@/components/ui/alert";

const PAGE_SIZE = 10;

export default function DurationDiscountManager() {
    const [currentPage, setCurrentPage] = useState(1);
    const { data: discountResponse, isLoading, isError } = useDurationDiscounts(currentPage, PAGE_SIZE);

    const discounts = useMemo(() => discountResponse?.items ?? [], [discountResponse]);
    const totalDiscounts = useMemo(() => discountResponse?.total ?? 0, [discountResponse]);
    const totalPages = Math.ceil(totalDiscounts / PAGE_SIZE);

    const createMutation = useCreateDurationDiscount();
    const deleteMutation = useDeleteDurationDiscount();

    const [newItem, setNewItem] = useState<DiscountPayload>({ min_days: 0, discount_percentage: 0 });

    const handleCreate = () => {
        if (!newItem.min_days || newItem.min_days <= 0) {
            alert("ĞšĞ¾Ğ»Ğ¸Ñ‡ĞµÑÑ‚Ğ²Ğ¾ Ğ´Ğ½ĞµĞ¹ Ğ´Ğ¾Ğ»Ğ¶Ğ½Ğ¾ Ğ±Ñ‹Ñ‚ÑŒ Ğ±Ğ¾Ğ»ÑŒÑˆĞµ 0.");
            return;
        }
        if (!newItem.discount_percentage || newItem.discount_percentage <= 0) {
            alert("ĞŸÑ€Ğ¾Ñ†ĞµĞ½Ñ‚ ÑĞºĞ¸Ğ´ĞºĞ¸ Ğ´Ğ¾Ğ»Ğ¶ĞµĞ½ Ğ±Ñ‹Ñ‚ÑŒ Ğ±Ğ¾Ğ»ÑŒÑˆĞµ 0.");
            return;
        }
        createMutation.mutate(newItem, {
            onSuccess: () => setNewItem({ min_days: 0, discount_percentage: 0 })
        });
    };

    if (isLoading) {
        return <div className="flex items-center gap-2 text-gray-500"><Loader2 className="h-4 w-4 animate-spin"/>Ğ—Ğ°Ğ³Ñ€ÑƒĞ·ĞºĞ° Ğ´Ğ°Ğ½Ğ½Ñ‹Ñ… Ğ¾ ÑĞºĞ¸Ğ´ĞºĞ°Ñ…...</div>;
    }

    if (isError) {
        return <Alert variant="destructive"><AlertTitle>ĞÑˆĞ¸Ğ±ĞºĞ°!</AlertTitle><AlertDescription>ĞĞµ ÑƒĞ´Ğ°Ğ»Ğ¾ÑÑŒ Ğ·Ğ°Ğ³Ñ€ÑƒĞ·Ğ¸Ñ‚ÑŒ Ğ´Ğ°Ğ½Ğ½Ñ‹Ğµ Ğ¾ ÑĞºĞ¸Ğ´ĞºĞ°Ñ….</AlertDescription></Alert>;
    }

    return (
        <div className="space-y-4">
            <div className="border rounded-md">
                <Table>
                    <TableHeader>
                        <TableRow>
                            <TableHead className="w-[40%]">ĞœĞ¸Ğ½Ğ¸Ğ¼Ğ°Ğ»ÑŒĞ½Ğ¾Ğµ ĞºĞ¾Ğ»Ğ¸Ñ‡ĞµÑÑ‚Ğ²Ğ¾ Ğ´Ğ½ĞµĞ¹</TableHead>
                            <TableHead className="w-[40%]">ĞŸÑ€Ğ¾Ñ†ĞµĞ½Ñ‚ ÑĞºĞ¸Ğ´ĞºĞ¸ (%)</TableHead>
                            <TableHead className="text-right">Ğ”ĞµĞ¹ÑÑ‚Ğ²Ğ¸Ñ</TableHead>
                        </TableRow>
                    </TableHeader>
                    <TableBody>
                        {discounts.map((d: DurationDiscount) => (
                            <TableRow key={d.id}>
                                <TableCell>{d.min_days}</TableCell>
                                <TableCell>{d.discount_percentage}%</TableCell>
                                <TableCell className="text-right">
                                    <Button variant="ghost" size="icon" onClick={() => deleteMutation.mutate(d.id)} disabled={deleteMutation.isPending}>
                                        <Trash2 className="h-4 w-4 text-red-500" />
                                    </Button>
                                </TableCell>
                            </TableRow>
                        ))}
                        <TableRow>
                            <TableCell>
                                <Input type="number" placeholder="ĞĞ°Ğ¿Ñ€. 7" value={newItem.min_days || ''} onChange={e => setNewItem((p: DiscountPayload) => ({...p, min_days: parseInt(e.target.value, 10) || 0}))} />
                            </TableCell>
                            <TableCell>
                                <Input type="number" placeholder="ĞĞ°Ğ¿Ñ€. 15" value={newItem.discount_percentage || ''} onChange={e => setNewItem((p: DiscountPayload) => ({...p, discount_percentage: parseInt(e.target.value, 10) || 0}))} />
                            </TableCell>
                            <TableCell className="text-right">
                                <Button size="sm" onClick={handleCreate} disabled={createMutation.isPending}>
                                    {createMutation.isPending ? <Loader2 className="mr-2 h-4 w-4 animate-spin"/> : <PlusCircle className="mr-2 h-4 w-4" />}
                                    Ğ”Ğ¾Ğ±Ğ°Ğ²Ğ¸Ñ‚ÑŒ
                                </Button>
                            </TableCell>
                        </TableRow>
                    </TableBody>
                </Table>
            </div>

            <div className="flex items-center justify-end space-x-2 pt-2">
                <span className="text-sm text-muted-foreground">
                    Ğ¡Ñ‚Ñ€Ğ°Ğ½Ğ¸Ñ†Ğ° {currentPage} Ğ¸Ğ· {totalPages > 0 ? totalPages : 1}
                </span>
                <Button
                    variant="outline"
                    size="sm"
                    onClick={() => setCurrentPage(prev => Math.max(prev - 1, 1))}
                    disabled={currentPage === 1}
                >
                    <ChevronLeft className="h-4 w-4 mr-1" />
                    ĞĞ°Ğ·Ğ°Ğ´
                </Button>
                <Button
                    variant="outline"
                    size="sm"
                    onClick={() => setCurrentPage(prev => Math.min(prev + 1, totalPages))}
                    disabled={currentPage >= totalPages}
                >
                    Ğ’Ğ¿ĞµÑ€ĞµĞ´
                    <ChevronRight className="h-4 w-4 ml-1" />
                </Button>
            </div>

            <p className="text-sm text-gray-600 pt-2">
                <strong>ĞšĞ°Ğº ÑÑ‚Ğ¾ Ñ€Ğ°Ğ±Ğ¾Ñ‚Ğ°ĞµÑ‚:</strong> Ğ¡Ğ¸ÑÑ‚ĞµĞ¼Ğ° Ğ°Ğ²Ñ‚Ğ¾Ğ¼Ğ°Ñ‚Ğ¸Ñ‡ĞµÑĞºĞ¸ Ğ¿Ñ€Ğ¸Ğ¼ĞµĞ½Ğ¸Ñ‚ ÑĞºĞ¸Ğ´ĞºÑƒ Ñ Ğ½Ğ°Ğ¸Ğ±Ğ¾Ğ»ÑŒÑˆĞ¸Ğ¼ Ğ¿Ğ¾Ñ€Ğ¾Ğ³Ğ¾Ğ¼ Ğ´Ğ½ĞµĞ¹, ĞºĞ¾Ñ‚Ğ¾Ñ€Ñ‹Ğ¹ Ğ½Ğµ Ğ¿Ñ€ĞµĞ²Ñ‹ÑˆĞ°ĞµÑ‚ Ğ¾Ğ±Ñ‰ĞµĞµ ĞºĞ¾Ğ»Ğ¸Ñ‡ĞµÑÑ‚Ğ²Ğ¾ Ğ´Ğ½ĞµĞ¹ Ğ°Ñ€ĞµĞ½Ğ´Ñ‹.
                <br />
                <em>ĞĞ°Ğ¿Ñ€Ğ¸Ğ¼ĞµÑ€, ĞµÑĞ»Ğ¸ ĞµÑÑ‚ÑŒ ÑĞºĞ¸Ğ´ĞºĞ¸ Ğ´Ğ»Ñ 3 Ğ¸ 7 Ğ´Ğ½ĞµĞ¹, Ğ° Ğ°Ñ€ĞµĞ½Ğ´Ğ° Ğ½Ğ° 8 Ğ´Ğ½ĞµĞ¹, Ğ±ÑƒĞ´ĞµÑ‚ Ğ¿Ñ€Ğ¸Ğ¼ĞµĞ½ĞµĞ½Ğ° ÑĞºĞ¸Ğ´ĞºĞ° Ğ´Ğ»Ñ 7 Ğ´Ğ½ĞµĞ¹.</em>
            </p>
        </div>
    );
}

```


## <a name="srccomponentsadminEditableRentalCardtsx"></a>`src/components/admin/EditableRentalCard.tsx`

```tsx
// path: src/components/admin/EditableRentalCard.tsx

// components/admin/EditableRentalCard.tsx (ĞĞĞ’Ğ«Ğ™ Ğ¤ĞĞ™Ğ›)

import { Card, CardContent } from "@/components/ui/card";
import { Button } from "@/components/ui/button";
import { Input } from "@/components/ui/input";
import { Label } from "@/components/ui/label";
import { Textarea } from "@/components/ui/textarea";
import { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from "@/components/ui/select";
import { Save, X, Loader2 } from "lucide-react";
import { useAdminRentalEdit } from "@/hooks/admin/useAdminRentalEdit";
import type { AdminRentalOut } from "@/types/reservation";

interface Props {
    rental: AdminRentalOut;
    onCancel: () => void;
}

export default function EditableRentalCard({ rental, onCancel }: Props) {
    const { register, handleSubmit, errors, isValid, isDirty, isSaving } = useAdminRentalEdit({
        rental,
        onSuccess: onCancel, // Ğ—Ğ°ĞºÑ€Ñ‹Ğ²Ğ°ĞµĞ¼ Ñ„Ğ¾Ñ€Ğ¼Ñƒ Ğ¿Ñ€Ğ¸ ÑƒÑĞ¿ĞµÑ…Ğµ
    });

    const statusOptions = [
        { value: "active", label: "ĞĞºÑ‚Ğ¸Ğ²Ğ½Ğ°" },
        { value: "overdue", label: "ĞŸÑ€Ğ¾ÑÑ€Ğ¾Ñ‡ĞµĞ½Ğ°" },
        { value: "completed", label: "Ğ—Ğ°Ğ²ĞµÑ€ÑˆĞµĞ½Ğ°" },
    ];

    return (
        <Card className="w-full transition-shadow border-2 border-dashed border-sky-400 bg-sky-50/50">
            <form onSubmit={handleSubmit}>
                <CardContent className="p-4 space-y-4">
                    <h3 className="font-semibold text-lg text-sky-800">Ğ ĞµĞ´Ğ°ĞºÑ‚Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ Ğ°Ñ€ĞµĞ½Ğ´Ñ‹ #{rental.id}</h3>
                    <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                        {/* Ğ”Ğ°Ñ‚Ñ‹ */}
                        <div className="space-y-2">
                            <Label htmlFor="end_date">Ğ”Ğ°Ñ‚Ğ° Ğ²Ğ¾Ğ·Ğ²Ñ€Ğ°Ñ‚Ğ° (Ğ¿Ğ»Ğ°Ğ½)</Label>
                            <Input id="end_date" type="date" {...register("end_date")} />
                            {errors.end_date && <p className="text-xs text-red-600 mt-1">{errors.end_date.message}</p>}
                        </div>
                        <div className="space-y-2">
                            <Label htmlFor="actual_return_date">Ğ”Ğ°Ñ‚Ğ° Ğ²Ğ¾Ğ·Ğ²Ñ€Ğ°Ñ‚Ğ° (Ñ„Ğ°ĞºÑ‚)</Label>
                            <Input id="actual_return_date" type="date" {...register("actual_return_date")} />
                            {errors.actual_return_date && <p className="text-xs text-red-600 mt-1">{errors.actual_return_date.message}</p>}
                        </div>

                        {/* Ğ¡Ñ‚Ğ°Ñ‚ÑƒÑ Ğ¸ Ğ¤Ğ¸Ğ½Ğ°Ğ½ÑÑ‹ */}
                        <div className="space-y-2">
                            <Label htmlFor="status">Ğ¡Ñ‚Ğ°Ñ‚ÑƒÑ</Label>
                            <select id="status" {...register("status")} className="w-full p-2 border rounded-md">
                                {statusOptions.map(opt => <option key={opt.value} value={opt.value}>{opt.label}</option>)}
                            </select>
                        </div>
                        <div className="space-y-2">
                            <Label htmlFor="deposit_amount">Ğ—Ğ°Ğ»Ğ¾Ğ³ (â‚½)</Label>
                            <Input id="deposit_amount" type="number" {...register("deposit_amount")} />
                        </div>
                        <div className="space-y-2">
                            <Label htmlFor="final_cost">Ğ˜Ñ‚Ğ¾Ğ³Ğ¾Ğ²Ğ°Ñ ÑÑ‚Ğ¾Ğ¸Ğ¼Ğ¾ÑÑ‚ÑŒ (â‚½)</Label>
                            <Input id="final_cost" type="number" {...register("final_cost")} placeholder="ĞÑÑ‚Ğ°Ğ²ÑŒÑ‚Ğµ Ğ¿ÑƒÑÑ‚Ñ‹Ğ¼ Ğ´Ğ»Ñ Ğ°Ğ²Ñ‚Ğ¾Ñ€Ğ°ÑÑ‡ĞµÑ‚Ğ°" />
                        </div>
                    </div>

                    {/* Ğ—Ğ°Ğ¼ĞµÑ‚ĞºĞ¸ */}
                    <div className="space-y-2">
                        <Label htmlFor="notes_on_issue">Ğ—Ğ°Ğ¼ĞµÑ‚ĞºĞ¸ Ğ¿Ñ€Ğ¸ Ğ²Ñ‹Ğ´Ğ°Ñ‡Ğµ</Label>
                        <Textarea id="notes_on_issue" {...register("notes_on_issue")} rows={2} />
                    </div>
                    <div className="space-y-2">
                        <Label htmlFor="notes_on_return">Ğ—Ğ°Ğ¼ĞµÑ‚ĞºĞ¸ Ğ¿Ñ€Ğ¸ Ğ²Ğ¾Ğ·Ğ²Ñ€Ğ°Ñ‚Ğµ</Label>
                        <Textarea id="notes_on_return" {...register("notes_on_return")} rows={2} />
                    </div>

                    {/* ĞšĞ½Ğ¾Ğ¿ĞºĞ¸ ÑƒĞ¿Ñ€Ğ°Ğ²Ğ»ĞµĞ½Ğ¸Ñ */}
                    <div className="flex justify-end gap-2 pt-2 border-t">
                        <Button type="button" variant="ghost" onClick={onCancel} disabled={isSaving}>
                            <X className="mr-2 h-4 w-4" /> ĞÑ‚Ğ¼ĞµĞ½Ğ°
                        </Button>
                        <Button type="submit" disabled={!isValid || !isDirty || isSaving}>
                            {isSaving ? <Loader2 className="mr-2 h-4 w-4 animate-spin" /> : <Save className="mr-2 h-4 w-4" />}
                            Ğ¡Ğ¾Ñ…Ñ€Ğ°Ğ½Ğ¸Ñ‚ÑŒ
                        </Button>
                    </div>
                </CardContent>
            </form>
        </Card>
    );
}

```


## <a name="srccomponentsadminEquipmentCreateDialogtsx"></a>`src/components/admin/EquipmentCreateDialog.tsx`

```tsx
// path: src/components/admin/EquipmentCreateDialog.tsx

// src/components/admin/EquipmentCreateDialog.tsx

import { useMemo } from "react";
import { useForm, Controller } from "react-hook-form";
import { zodResolver } from "@hookform/resolvers/zod";
import { z } from "zod";
import { useCreateEquipment } from "@/hooks/useAdminEquipment";
import { EQUIPMENT_CONDITIONS } from "@/constants/equipmentConstants";

import {
    Dialog,
    DialogContent,
    DialogHeader,
    DialogTitle,
    DialogFooter,
} from "@/components/ui/dialog";
import { Button } from "@/components/ui/button";
import { Input } from "@/components/ui/input";
import { Label } from "@/components/ui/label";
import { Textarea } from "@/components/ui/textarea";
import {
    Select,
    SelectContent,
    SelectItem,
    SelectTrigger,
    SelectValue,
} from "@/components/ui/select";
import type { Equipment } from "@/types/equipment";
import { CreatableSelect } from "@/components/ui/CreatableSelect";

const equipmentCreateSchema = z.object({
    equipment_type: z.string().min(1, "Ğ¢Ğ¸Ğ¿ Ğ¾Ğ±Ğ¾Ñ€ÑƒĞ´Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ Ğ¾Ğ±ÑĞ·Ğ°Ñ‚ĞµĞ»ĞµĞ½"),
    brand: z.string().min(1, "Ğ‘Ñ€ĞµĞ½Ğ´ Ğ¾Ğ±ÑĞ·Ğ°Ñ‚ĞµĞ»ĞµĞ½"),
    name: z.string().min(1, "ĞĞ°Ğ·Ğ²Ğ°Ğ½Ğ¸Ğµ Ğ¾Ğ±ÑĞ·Ğ°Ñ‚ĞµĞ»ÑŒĞ½Ğ¾"),
    serial_number: z.string().optional(),
    condition: z.string().min(1, "Ğ¡Ğ¾ÑÑ‚Ğ¾ÑĞ½Ğ¸Ğµ Ğ¾Ğ±ÑĞ·Ğ°Ñ‚ĞµĞ»ÑŒĞ½Ğ¾"),
    daily_rate: z.number().min(0, "Ğ¢Ğ°Ñ€Ğ¸Ñ„ Ğ½Ğµ Ğ¼Ğ¾Ğ¶ĞµÑ‚ Ğ±Ñ‹Ñ‚ÑŒ Ğ¾Ñ‚Ñ€Ğ¸Ñ†Ğ°Ñ‚ĞµĞ»ÑŒĞ½Ñ‹Ğ¼"),
    notes: z.string().optional(),
    description: z.string().optional(),
    last_maintenance: z.string().optional(),
});

type EquipmentCreateFormData = z.infer<typeof equipmentCreateSchema>;

interface EquipmentCreateDialogProps {
    open: boolean;
    onClose: () => void;
    equipment: Equipment[];
}

export default function EquipmentCreateDialog({
                                                  open,
                                                  onClose,
                                                  equipment
                                              }: EquipmentCreateDialogProps) {
    const createEquipmentMutation = useCreateEquipment();

    const {
        register,
        handleSubmit,
        formState: { errors, isValid },
        reset,
        setValue,
        control,
    } = useForm<EquipmentCreateFormData>({
        resolver: zodResolver(equipmentCreateSchema),
        defaultValues: {
            condition: "Ğ’ĞµĞ»Ğ¸ĞºĞ¾Ğ»ĞµĞ¿Ğ½Ğ¾",
            daily_rate: 0,
        },
        mode: "onChange",
    });

    const equipmentTypes = useMemo(() => {
        const types = new Set(equipment.map(e => e.equipment_type));
        return Array.from(types).sort((a,b) => a.localeCompare(b));
    }, [equipment]);

    const equipmentBrands = useMemo(() => {
        const brands = new Set(equipment.map(e => e.brand));
        return Array.from(brands).sort((a,b) => a.localeCompare(b));
    }, [equipment]);

    const onSubmit = async (data: EquipmentCreateFormData) => {
        try {
            await createEquipmentMutation.mutateAsync(data);
            reset();
            onClose();
        } catch (error) {
            // ĞÑˆĞ¸Ğ±ĞºĞ° Ğ¾Ğ±Ñ€Ğ°Ğ±Ğ¾Ñ‚Ğ°ĞµÑ‚ÑÑ Ğ² Ñ…ÑƒĞºĞµ
        }
    };

    const handleClose = () => {
        reset();
        onClose();
    };

    return (
        <Dialog open={open} onOpenChange={handleClose}>
            <DialogContent className="max-w-2xl max-h-[90vh] overflow-y-auto">
                <DialogHeader>
                    <DialogTitle>Ğ”Ğ¾Ğ±Ğ°Ğ²Ğ¸Ñ‚ÑŒ Ğ½Ğ¾Ğ²Ğ¾Ğµ Ğ¾Ğ±Ğ¾Ñ€ÑƒĞ´Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ</DialogTitle>
                </DialogHeader>

                <form onSubmit={handleSubmit(onSubmit)} className="space-y-4">
                    <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                        {/* Ğ¢Ğ¸Ğ¿ Ğ¾Ğ±Ğ¾Ñ€ÑƒĞ´Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ */}
                        <div>
                            <Label htmlFor="equipment_type">Ğ¢Ğ¸Ğ¿ Ğ¾Ğ±Ğ¾Ñ€ÑƒĞ´Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ *</Label>
                            <Controller
                                name="equipment_type"
                                control={control}
                                render={({ field }) => (
                                    <CreatableSelect
                                        value={field.value}
                                        onChange={field.onChange}
                                        options={equipmentTypes}
                                        placeholder="Ğ’Ñ‹Ğ±ĞµÑ€Ğ¸Ñ‚Ğµ Ğ¸Ğ»Ğ¸ ÑĞ¾Ğ·Ğ´Ğ°Ğ¹Ñ‚Ğµ Ñ‚Ğ¸Ğ¿"
                                        dialogTitle="ĞĞ¾Ğ²Ñ‹Ğ¹ Ñ‚Ğ¸Ğ¿ Ğ¾Ğ±Ğ¾Ñ€ÑƒĞ´Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ"
                                        dialogDescription="Ğ’Ğ²ĞµĞ´Ğ¸Ñ‚Ğµ Ğ½Ğ°Ğ·Ğ²Ğ°Ğ½Ğ¸Ğµ Ğ´Ğ»Ñ Ğ½Ğ¾Ğ²Ğ¾Ğ³Ğ¾ Ñ‚Ğ¸Ğ¿Ğ°."
                                        dialogLabel="ĞĞ°Ğ·Ğ²Ğ°Ğ½Ğ¸Ğµ"
                                    />
                                )}
                            />
                            {errors.equipment_type && (
                                <p className="text-xs text-red-600 mt-1">
                                    {errors.equipment_type.message}
                                </p>
                            )}
                        </div>

                        {/* Ğ‘Ñ€ĞµĞ½Ğ´ */}
                        <div>
                            <Label htmlFor="brand">Ğ‘Ñ€ĞµĞ½Ğ´ *</Label>
                            <Controller
                                name="brand"
                                control={control}
                                render={({ field }) => (
                                    <CreatableSelect
                                        value={field.value}
                                        onChange={field.onChange}
                                        options={equipmentBrands}
                                        placeholder="Ğ’Ñ‹Ğ±ĞµÑ€Ğ¸Ñ‚Ğµ Ğ¸Ğ»Ğ¸ ÑĞ¾Ğ·Ğ´Ğ°Ğ¹Ñ‚Ğµ Ğ±Ñ€ĞµĞ½Ğ´"
                                        dialogTitle="ĞĞ¾Ğ²Ñ‹Ğ¹ Ğ±Ñ€ĞµĞ½Ğ´"
                                        dialogDescription="Ğ’Ğ²ĞµĞ´Ğ¸Ñ‚Ğµ Ğ½Ğ°Ğ·Ğ²Ğ°Ğ½Ğ¸Ğµ Ğ´Ğ»Ñ Ğ½Ğ¾Ğ²Ğ¾Ğ³Ğ¾ Ğ±Ñ€ĞµĞ½Ğ´Ğ°."
                                        dialogLabel="ĞĞ°Ğ·Ğ²Ğ°Ğ½Ğ¸Ğµ"
                                    />
                                )}
                            />
                            {errors.brand && (
                                <p className="text-xs text-red-600 mt-1">
                                    {errors.brand.message}
                                </p>
                            )}
                        </div>
                    </div>

                    <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                        {/* ĞĞ°Ğ·Ğ²Ğ°Ğ½Ğ¸Ğµ */}
                        <div>
                            <Label htmlFor="name">ĞĞ°Ğ·Ğ²Ğ°Ğ½Ğ¸Ğµ *</Label>
                            <Input
                                id="name"
                                {...register("name")}
                                placeholder="EOS R5, MacBook Pro 14..."
                            />
                            {errors.name && (
                                <p className="text-xs text-red-600 mt-1">
                                    {errors.name.message}
                                </p>
                            )}
                        </div>

                        {/* Ğ¡ĞµÑ€Ğ¸Ğ¹Ğ½Ñ‹Ğ¹ Ğ½Ğ¾Ğ¼ĞµÑ€ */}
                        <div>
                            <Label htmlFor="serial_number">Ğ¡ĞµÑ€Ğ¸Ğ¹Ğ½Ñ‹Ğ¹ Ğ½Ğ¾Ğ¼ĞµÑ€</Label>
                            <Input
                                id="serial_number"
                                {...register("serial_number")}
                                placeholder="ĞĞµĞ¾Ğ±ÑĞ·Ğ°Ñ‚ĞµĞ»ÑŒĞ½Ğ¾"
                            />
                        </div>
                    </div>

                    <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                        {/* Ğ¡Ğ¾ÑÑ‚Ğ¾ÑĞ½Ğ¸Ğµ */}
                        <div>
                            <Label htmlFor="condition">Ğ¡Ğ¾ÑÑ‚Ğ¾ÑĞ½Ğ¸Ğµ *</Label>
                            <Select
                                onValueChange={(value) => setValue("condition", value, { shouldValidate: true })}
                                defaultValue="Ğ’ĞµĞ»Ğ¸ĞºĞ¾Ğ»ĞµĞ¿Ğ½Ğ¾"
                            >
                                <SelectTrigger>
                                    <SelectValue placeholder="Ğ’Ñ‹Ğ±ĞµÑ€Ğ¸Ñ‚Ğµ ÑĞ¾ÑÑ‚Ğ¾ÑĞ½Ğ¸Ğµ" />
                                </SelectTrigger>
                                <SelectContent>
                                    {EQUIPMENT_CONDITIONS.map((condition) => (
                                        <SelectItem key={condition} value={condition}>
                                            {condition}
                                        </SelectItem>
                                    ))}
                                </SelectContent>
                            </Select>
                            {errors.condition && (
                                <p className="text-xs text-red-600 mt-1">
                                    {errors.condition.message}
                                </p>
                            )}
                        </div>

                        {/* Ğ¢Ğ°Ñ€Ğ¸Ñ„ Ğ·Ğ° Ğ´ĞµĞ½ÑŒ */}
                        <div>
                            <Label htmlFor="daily_rate">Ğ¢Ğ°Ñ€Ğ¸Ñ„ Ğ·Ğ° Ğ´ĞµĞ½ÑŒ (â‚½) *</Label>
                            <Input
                                id="daily_rate"
                                type="number"
                                step="0.01"
                                min="0"
                                {...register("daily_rate", { valueAsNumber: true })}
                                placeholder="0"
                            />
                            {errors.daily_rate && (
                                <p className="text-xs text-red-600 mt-1">
                                    {errors.daily_rate.message}
                                </p>
                            )}
                        </div>
                    </div>

                    {/* Ğ”Ğ°Ñ‚Ğ° Ğ¿Ğ¾ÑĞ»ĞµĞ´Ğ½ĞµĞ³Ğ¾ Ğ¢Ğ */}
                    <div>
                        <Label htmlFor="last_maintenance">Ğ”Ğ°Ñ‚Ğ° Ğ¿Ğ¾ÑĞ»ĞµĞ´Ğ½ĞµĞ³Ğ¾ Ğ¢Ğ</Label>
                        <Input
                            id="last_maintenance"
                            type="date"
                            {...register("last_maintenance")}
                        />
                    </div>

                    {/* ĞĞ¿Ğ¸ÑĞ°Ğ½Ğ¸Ğµ */}
                    <div>
                        <Label htmlFor="description">ĞĞ¿Ğ¸ÑĞ°Ğ½Ğ¸Ğµ</Label>
                        <Textarea
                            id="description"
                            {...register("description")}
                            placeholder="ĞŸĞ¾Ğ´Ñ€Ğ¾Ğ±Ğ½Ğ¾Ğµ Ğ¾Ğ¿Ğ¸ÑĞ°Ğ½Ğ¸Ğµ Ğ¾Ğ±Ğ¾Ñ€ÑƒĞ´Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ, ĞµĞ³Ğ¾ Ğ¾ÑĞ¾Ğ±ĞµĞ½Ğ½Ğ¾ÑÑ‚Ğ¸..."
                            rows={3}
                        />
                    </div>

                    {/* Ğ—Ğ°Ğ¼ĞµÑ‚ĞºĞ¸ */}
                    <div>
                        <Label htmlFor="notes">Ğ—Ğ°Ğ¼ĞµÑ‚ĞºĞ¸ (Ğ²Ğ¸Ğ´Ğ½Ñ‹ Ñ‚Ğ¾Ğ»ÑŒĞºĞ¾ Ğ¿ĞµÑ€ÑĞ¾Ğ½Ğ°Ğ»Ñƒ)</Label>
                        <Textarea
                            id="notes"
                            {...register("notes")}
                            placeholder="Ğ’Ğ½ÑƒÑ‚Ñ€ĞµĞ½Ğ½Ğ¸Ğµ Ğ·Ğ°Ğ¼ĞµÑ‚ĞºĞ¸ Ğ¾ ÑĞ¾ÑÑ‚Ğ¾ÑĞ½Ğ¸Ğ¸, Ğ¾ÑĞ¾Ğ±ĞµĞ½Ğ½Ğ¾ÑÑ‚ÑÑ…..."
                            rows={2}
                        />
                    </div>

                    <DialogFooter className="pt-4">
                        <Button type="button" variant="outline" onClick={handleClose}>
                            ĞÑ‚Ğ¼ĞµĞ½Ğ°
                        </Button>
                        <Button
                            type="submit"
                            disabled={!isValid || createEquipmentMutation.isPending}
                        >
                            {createEquipmentMutation.isPending ? "Ğ¡Ğ¾Ğ·Ğ´Ğ°Ğ½Ğ¸Ğµ..." : "Ğ¡Ğ¾Ğ·Ğ´Ğ°Ñ‚ÑŒ Ğ¾Ğ±Ğ¾Ñ€ÑƒĞ´Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ"}
                        </Button>
                    </DialogFooter>
                </form>
            </DialogContent>
        </Dialog>
    );
}

```


## <a name="srccomponentsadminEquipmentEditDialogtsx"></a>`src/components/admin/EquipmentEditDialog.tsx`

```tsx
// path: src/components/admin/EquipmentEditDialog.tsx

// src/components/admin/EquipmentEditDialog.tsx

import { Dialog, DialogContent, DialogHeader, DialogTitle } from "@/components/ui/dialog";
import EquipmentEditForm from "@/components/equipment/EquipmentEditForm";
import type { Equipment } from "@/types/equipment";

interface Props {
    open: boolean;
    onClose: () => void;
    equipment: Equipment;
}

export default function EquipmentEditDialog({ open, onClose, equipment }: Props) {
    const handleSuccess = () => {
        onClose();
    };

    return (
        <Dialog open={open} onOpenChange={onClose} modal={false}>
            <DialogContent className="max-w-2xl">
                <DialogHeader>
                    <DialogTitle>Ğ ĞµĞ´Ğ°ĞºÑ‚Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ Ğ¾Ğ±Ğ¾Ñ€ÑƒĞ´Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ</DialogTitle>
                </DialogHeader>
                <EquipmentEditForm
                    equipment={equipment}
                    onSuccess={handleSuccess}
                    onCancel={onClose}
                />
            </DialogContent>
        </Dialog>
    );
}

```


## <a name="srccomponentsadminEquipmentStatstsx"></a>`src/components/admin/EquipmentStats.tsx`

```tsx
// path: src/components/admin/EquipmentStats.tsx

// src/components/admin/EquipmentStats.tsx
import { useMemo } from 'react';
import type { Equipment } from "@/types/equipment";

interface Props {
    equipment: Equipment[];
}

export const EquipmentStats = ({ equipment }: Props) => {
    const stats = useMemo(() => {
        const totalCount = equipment.length;
        if (totalCount === 0) {
            return { totalCount: 0, typesCount: 0, brandsCount: 0, avgRate: 0 };
        }
        return {
            totalCount,
            typesCount: new Set(equipment.map(item => item.equipment_type)).size,
            brandsCount: new Set(equipment.map(item => item.brand)).size,
            avgRate: Math.round(equipment.reduce((sum, item) => sum + item.daily_rate, 0) / totalCount),
        };
    }, [equipment]);

    return (
        <div className="grid grid-cols-2 sm:grid-cols-4 gap-4 pt-4 border-t">
            <div className="text-center">
                <div className="text-2xl font-bold">{stats.totalCount}</div>
                <div className="text-sm text-muted-foreground">Ğ’ÑĞµĞ³Ğ¾ ĞµĞ´Ğ¸Ğ½Ğ¸Ñ†</div>
            </div>
            <div className="text-center">
                <div className="text-2xl font-bold">{stats.typesCount}</div>
                <div className="text-sm text-muted-foreground">Ğ¢Ğ¸Ğ¿Ğ¾Ğ²</div>
            </div>
            <div className="text-center">
                <div className="text-2xl font-bold">{stats.brandsCount}</div>
                <div className="text-sm text-muted-foreground">Ğ‘Ñ€ĞµĞ½Ğ´Ğ¾Ğ²</div>
            </div>
            <div className="text-center">
                <div className="text-2xl font-bold">{stats.avgRate.toLocaleString()} â‚½</div>
                <div className="text-sm text-muted-foreground">Ğ¡Ñ€ĞµĞ´Ğ½Ğ¸Ğ¹ Ñ‚Ğ°Ñ€Ğ¸Ñ„</div>
            </div>
        </div>
    );
};

```


## <a name="srccomponentsadminEquipmentTabletsx"></a>`src/components/admin/EquipmentTable.tsx`

```tsx
// path: src/components/admin/EquipmentTable.tsx

// src/components/admin/EquipmentTable.tsx

import { useState } from "react";
import { Table, TableBody, TableHead, TableHeader, TableRow } from "@/components/ui/table";
import { Package, PackageSearch, Loader2 } from "lucide-react"; // âœ… Ğ”Ğ¾Ğ±Ğ°Ğ²Ğ»ĞµĞ½ Ğ¸Ğ¼Ğ¿Ğ¾Ñ€Ñ‚ Loader2
import { Button } from "@/components/ui/button"; // âœ… Ğ”Ğ¾Ğ±Ğ°Ğ²Ğ»ĞµĞ½ Ğ¸Ğ¼Ğ¿Ğ¾Ñ€Ñ‚ Button
import EquipmentCreateDialog from "./EquipmentCreateDialog";
import { useEquipmentTableLogic } from "@/hooks/admin/useEquipmentTableLogic";
import { EquipmentTableToolbar } from "./EquipmentTableToolbar";
import { EquipmentTableRow } from "./EquipmentTableRow";
import { EquipmentStats } from "./EquipmentStats";
import type { Equipment } from "@/types/equipment";

interface EquipmentTableProps {
    onEditEquipment?: (equipment: Equipment) => void;
    equipment: Equipment[];
    // âœ… ĞĞĞ§ĞĞ›Ğ: Ğ”Ğ¾Ğ±Ğ°Ğ²Ğ»ÑĞµĞ¼ Ğ½Ğ¾Ğ²Ñ‹Ğµ ÑĞ²Ğ¾Ğ¹ÑÑ‚Ğ²Ğ° Ğ´Ğ»Ñ Ğ¿Ğ°Ğ³Ğ¸Ğ½Ğ°Ñ†Ğ¸Ğ¸
    hasNextPage?: boolean;
    isFetchingNextPage?: boolean;
    onLoadMore: () => void;
    // âœ… ĞšĞĞĞ•Ğ¦: ĞĞ¾Ğ²Ñ‹Ğµ ÑĞ²Ğ¾Ğ¹ÑÑ‚Ğ²Ğ° Ğ´Ğ»Ñ Ğ¿Ğ°Ğ³Ğ¸Ğ½Ğ°Ñ†Ğ¸Ğ¸
}

export default function EquipmentTable({
                                           onEditEquipment,
                                           equipment,
                                           hasNextPage,
                                           isFetchingNextPage,
                                           onLoadMore
                                       }: EquipmentTableProps) {
    const [showCreateDialog, setShowCreateDialog] = useState(false);

    const {
        isManager,
        isLoading,
        error,
        filteredEquipment,
        searchQuery,
        selectedIds,
        deleteEquipmentMutation,
        bulkDeleteMutation,
        handlers,
    } = useEquipmentTableLogic(equipment);

    if (isLoading) return <div className="flex justify-center p-4">Ğ—Ğ°Ğ³Ñ€ÑƒĞ·ĞºĞ° Ğ¾Ğ±Ğ¾Ñ€ÑƒĞ´Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ...</div>;
    if (error) return <div className="flex justify-center p-4 text-red-500">ĞÑˆĞ¸Ğ±ĞºĞ° Ğ·Ğ°Ğ³Ñ€ÑƒĞ·ĞºĞ¸ Ğ¾Ğ±Ğ¾Ñ€ÑƒĞ´Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ</div>;

    return (
        <div className="space-y-4">
            <EquipmentTableToolbar
                searchQuery={searchQuery}
                onSearchChange={handlers.setSearchQuery}
                onAdd={() => setShowCreateDialog(true)}
                onBulkDelete={handlers.handleBulkDelete}
                selectedCount={selectedIds.length}
                totalCount={equipment.length}
                filteredCount={filteredEquipment.length}
                isManager={isManager}
                isDeleting={bulkDeleteMutation.isPending}
            />

            {filteredEquipment.length > 0 ? (
                <div className="border rounded-md">
                    <Table>
                        <TableHeader>
                            <TableRow>
                                {isManager && <TableHead className="w-12"></TableHead>}
                                <TableHead><Package className="inline mr-2 h-4 w-4" />Ğ¢Ğ¸Ğ¿</TableHead>
                                <TableHead>Ğ‘Ñ€ĞµĞ½Ğ´</TableHead>
                                <TableHead>ĞĞ°Ğ·Ğ²Ğ°Ğ½Ğ¸Ğµ</TableHead>
                                <TableHead>Ğ¡ĞµÑ€Ğ¸Ğ¹Ğ½Ñ‹Ğ¹ Ğ½Ğ¾Ğ¼ĞµÑ€</TableHead>
                                <TableHead>Ğ¡Ğ¾ÑÑ‚Ğ¾ÑĞ½Ğ¸Ğµ</TableHead>
                                <TableHead>Ğ¢Ğ°Ñ€Ğ¸Ñ„/Ğ´ĞµĞ½ÑŒ</TableHead>
                                {isManager && <TableHead>Ğ”ĞµĞ¹ÑÑ‚Ğ²Ğ¸Ñ</TableHead>}
                            </TableRow>
                        </TableHeader>
                        <TableBody>
                            {filteredEquipment.map((item) => (
                                <EquipmentTableRow
                                    key={item.id}
                                    item={item}
                                    isSelected={selectedIds.includes(item.id)}
                                    isManager={isManager}
                                    isDeleting={deleteEquipmentMutation.isPending}
                                    onSelectItem={handlers.handleSelectItem}
                                    onEdit={onEditEquipment!}
                                    onDelete={handlers.handleDelete}
                                />
                            ))}
                        </TableBody>
                    </Table>
                </div>
            ) : (
                <div className="text-center py-12 px-4 border rounded-md">
                    <PackageSearch className="w-16 h-16 text-gray-300 mx-auto mb-3" />
                    <h3 className="text-lg font-semibold text-gray-700">ĞĞ±Ğ¾Ñ€ÑƒĞ´Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ Ğ½Ğµ Ğ½Ğ°Ğ¹Ğ´ĞµĞ½Ğ¾</h3>
                    <p className="text-sm text-gray-500 max-w-sm">
                        {searchQuery ? "ĞŸĞ¾Ğ¿Ñ€Ğ¾Ğ±ÑƒĞ¹Ñ‚Ğµ Ğ¸Ğ·Ğ¼ĞµĞ½Ğ¸Ñ‚ÑŒ Ğ¿Ğ¾Ğ¸ÑĞºĞ¾Ğ²Ñ‹Ğ¹ Ğ·Ğ°Ğ¿Ñ€Ğ¾Ñ." : "Ğ”Ğ¾Ğ±Ğ°Ğ²ÑŒÑ‚Ğµ Ğ¾Ğ±Ğ¾Ñ€ÑƒĞ´Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ, Ñ‡Ñ‚Ğ¾Ğ±Ñ‹ Ğ¾Ğ½Ğ¾ Ğ¿Ğ¾ÑĞ²Ğ¸Ğ»Ğ¾ÑÑŒ Ğ² ÑĞ¿Ğ¸ÑĞºĞµ."}
                    </p>
                </div>
            )}

            {/* âœ… ĞĞĞ§ĞĞ›Ğ: Ğ‘Ğ»Ğ¾Ğº Ñ ĞºĞ½Ğ¾Ğ¿ĞºĞ¾Ğ¹ Ğ¿Ğ°Ğ³Ğ¸Ğ½Ğ°Ñ†Ğ¸Ğ¸ */}
            {hasNextPage && (
                <div className="flex justify-center pt-2">
                    <Button
                        variant="outline"
                        onClick={onLoadMore}
                        disabled={isFetchingNextPage}
                    >
                        {isFetchingNextPage ? (
                            <>
                                <Loader2 className="mr-2 h-4 w-4 animate-spin" />
                                Ğ—Ğ°Ğ³Ñ€ÑƒĞ·ĞºĞ°...
                            </>
                        ) : (
                            "Ğ—Ğ°Ğ³Ñ€ÑƒĞ·Ğ¸Ñ‚ÑŒ ĞµÑ‰Ñ‘"
                        )}
                    </Button>
                </div>
            )}
            {/* âœ… ĞšĞĞĞ•Ğ¦: Ğ‘Ğ»Ğ¾Ğº Ñ ĞºĞ½Ğ¾Ğ¿ĞºĞ¾Ğ¹ Ğ¿Ğ°Ğ³Ğ¸Ğ½Ğ°Ñ†Ğ¸Ğ¸ */}

            <EquipmentStats equipment={equipment} />

            <EquipmentCreateDialog
                open={showCreateDialog}
                onClose={() => setShowCreateDialog(false)}
                equipment={equipment}
            />
        </div>
    );
}

```


## <a name="srccomponentsadminEquipmentTableRowtsx"></a>`src/components/admin/EquipmentTableRow.tsx`

```tsx
// path: src/components/admin/EquipmentTableRow.tsx

// src/components/admin/EquipmentTableRow.tsx

import { TableCell, TableRow } from "@/components/ui/table";
import { Checkbox } from "@/components/ui/checkbox";
import { Button } from "@/components/ui/button";
import { Edit, Trash2 } from "lucide-react";
import type { Equipment } from "@/types/equipment";
import { getConditionVariantClass } from "@/constants/equipmentConstants";

interface Props {
    item: Equipment;
    isSelected: boolean;
    isManager: boolean;
    isDeleting: boolean;
    onSelectItem: (id: number, checked: boolean) => void;
    onEdit: (item: Equipment) => void;
    onDelete: (id: number) => void;
}

export const EquipmentTableRow = ({ item, isSelected, isManager, isDeleting, onSelectItem, onEdit, onDelete }: Props) => (
    <TableRow>
        {isManager && (
            <TableCell>
                <Checkbox
                    checked={isSelected}
                    onCheckedChange={(checked) => onSelectItem(item.id, Boolean(checked))}
                />
            </TableCell>
        )}
        <TableCell className="font-medium">{item.equipment_type}</TableCell>
        <TableCell>{item.brand}</TableCell>
        <TableCell>{item.name}</TableCell>
        <TableCell>{item.serial_number || "â€”"}</TableCell>
        <TableCell>
            {/* âœ… Ğ˜Ğ—ĞœĞ•ĞĞ•ĞĞ˜Ğ•: Ğ˜ÑĞ¿Ğ¾Ğ»ÑŒĞ·ÑƒĞµĞ¼ Ğ¸Ğ¼Ğ¿Ğ¾Ñ€Ñ‚Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ½ÑƒÑ Ñ„ÑƒĞ½ĞºÑ†Ğ¸Ñ */}
            <span className={`text-xs px-2 py-1 rounded-full font-medium ${getConditionVariantClass(item.condition)}`}>
                {item.condition}
            </span>
        </TableCell>
        <TableCell className="font-medium">{item.daily_rate.toLocaleString()} â‚½</TableCell>
        {isManager && (
            <TableCell>
                <div className="flex gap-2">
                    <Button variant="outline" size="icon" onClick={() => onEdit(item)}>
                        <Edit className="h-4 w-4" />
                    </Button>
                    <Button variant="destructive" size="icon" onClick={() => onDelete(item.id)} disabled={isDeleting}>
                        <Trash2 className="h-4 w-4" />
                    </Button>
                </div>
            </TableCell>
        )}
    </TableRow>
);

```


## <a name="srccomponentsadminEquipmentTableToolbartsx"></a>`src/components/admin/EquipmentTableToolbar.tsx`

```tsx
// path: src/components/admin/EquipmentTableToolbar.tsx

// src/components/admin/EquipmentTableToolbar.tsx
import { Button } from "@/components/ui/button";
import { Input } from "@/components/ui/input";
import { Plus, Search, Trash2 } from "lucide-react";

interface Props {
    searchQuery: string;
    onSearchChange: (value: string) => void;
    onAdd: () => void;
    onBulkDelete: () => void;
    selectedCount: number;
    totalCount: number;
    filteredCount: number;
    isManager: boolean;
    isDeleting: boolean;
}

export const EquipmentTableToolbar = ({
                                          searchQuery,
                                          onSearchChange,
                                          onAdd,
                                          onBulkDelete,
                                          selectedCount,
                                          totalCount,
                                          filteredCount,
                                          isManager,
                                          isDeleting
                                      }: Props) => (
    <div className="flex flex-col sm:flex-row gap-4 items-start sm:items-center justify-between">
        <div className="relative flex-1 w-full sm:w-auto sm:max-w-sm">
            <Search className="absolute left-3 top-2.5 h-4 w-4 text-muted-foreground" />
            <Input
                placeholder="ĞŸĞ¾Ğ¸ÑĞº Ğ¿Ğ¾ Ğ½Ğ°Ğ·Ğ²Ğ°Ğ½Ğ¸Ñ, Ğ±Ñ€ĞµĞ½Ğ´Ñƒ, Ñ‚Ğ¸Ğ¿Ñƒ..."
                value={searchQuery}
                onChange={(e) => onSearchChange(e.target.value)}
                className="pl-10"
            />
        </div>
        <div className="flex flex-col sm:flex-row gap-2 items-stretch sm:items-center w-full sm:w-auto">
            <span className="text-sm text-muted-foreground text-center sm:text-left">
                ĞĞ°Ğ¹Ğ´ĞµĞ½Ğ¾: {filteredCount} Ğ¸Ğ· {totalCount}
            </span>
            {selectedCount > 0 && isManager && (
                <Button variant="destructive" size="sm" onClick={onBulkDelete} disabled={isDeleting}>
                    <Trash2 className="h-4 w-4 mr-2" />
                    Ğ£Ğ´Ğ°Ğ»Ğ¸Ñ‚ÑŒ ({selectedCount})
                </Button>
            )}
            {isManager && (
                <Button onClick={onAdd} size="sm" className="flex items-center gap-2">
                    <Plus className="h-4 w-4" />
                    Ğ”Ğ¾Ğ±Ğ°Ğ²Ğ¸Ñ‚ÑŒ Ğ¾Ğ±Ğ¾Ñ€ÑƒĞ´Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ
                </Button>
            )}
        </div>
    </div>
);

```


## <a name="srccomponentsadminHolidayManagertsx"></a>`src/components/admin/HolidayManager.tsx`

```tsx
// path: src/components/admin/HolidayManager.tsx

// src/components/admin/HolidayManager.tsx

import { useState, useMemo } from 'react';
import { DayPicker } from 'react-day-picker';
import { ru } from 'date-fns/locale';
import { format, startOfMonth, endOfMonth } from 'date-fns';
import { useHolidays, useCreateHoliday, useDeleteHoliday, type HolidayWithDate } from '@/hooks/useAdminHolidays';
import { useGetHolidayRules, useCreateWeeklyRule, useImportPublicHolidays, useDeleteHolidayRule } from '@/hooks/useAdminHolidayRules';

import { Button } from '@/components/ui/button';
import { Input } from '@/components/ui/input';
import { Trash2, CalendarPlus, Globe, Repeat } from 'lucide-react';
import { Dialog, DialogContent, DialogHeader, DialogTitle, DialogFooter, DialogDescription } from "@/components/ui/dialog";
import { toast } from 'sonner';
import { Card, CardContent, CardHeader, CardTitle, CardDescription } from "@/components/ui/card";
import { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from "@/components/ui/select";
import { Label } from "@/components/ui/label";
import { Table, TableBody, TableCell, TableHead, TableHeader, TableRow } from "@/components/ui/table";

type ConflictInfo = {
    date: Date;
    description: string;
    conflicting_reservation_ids: number[];
};

// --- ĞĞ¾Ğ²Ñ‹Ğ¹ ĞºĞ¾Ğ¼Ğ¿Ğ¾Ğ½ĞµĞ½Ñ‚ Ğ´Ğ»Ñ Ñ„Ğ¾Ñ€Ğ¼Ñ‹ ĞµĞ¶ĞµĞ½ĞµĞ´ĞµĞ»ÑŒĞ½Ñ‹Ñ… Ğ¿Ñ€Ğ°Ğ²Ğ¸Ğ» ---
function WeeklyRuleForm({ isLoading }: { isLoading: boolean }) {
    const [dayOfWeek, setDayOfWeek] = useState<string>("6"); // 6 = Ğ’Ğ¾ÑĞºÑ€ĞµÑĞµĞ½ÑŒĞµ
    const [startDate, setStartDate] = useState<string>(format(new Date(), 'yyyy-MM-dd'));
    const [endDate, setEndDate] = useState<string>(`${new Date().getFullYear()}-12-31`);
    const createRuleMutation = useCreateWeeklyRule();

    const daysOfWeek = [
        { label: "ĞŸĞ¾Ğ½ĞµĞ´ĞµĞ»ÑŒĞ½Ğ¸Ğº", value: "0" },
        { label: "Ğ’Ñ‚Ğ¾Ñ€Ğ½Ğ¸Ğº", value: "1" },
        { label: "Ğ¡Ñ€ĞµĞ´Ğ°", value: "2" },
        { label: "Ğ§ĞµÑ‚Ğ²ĞµÑ€Ğ³", value: "3" },
        { label: "ĞŸÑÑ‚Ğ½Ğ¸Ñ†Ğ°", value: "4" },
        { label: "Ğ¡ÑƒĞ±Ğ±Ğ¾Ñ‚Ğ°", value: "5" },
        { label: "Ğ’Ğ¾ÑĞºÑ€ĞµÑĞµĞ½ÑŒĞµ", value: "6" },
    ];

    const handleSubmit = (e: React.FormEvent) => {
        e.preventDefault();
        const selectedDay = daysOfWeek.find(d => d.value === dayOfWeek);
        createRuleMutation.mutate({
            day_of_week: parseInt(dayOfWeek, 10),
            start_date: new Date(startDate),
            end_date: new Date(endDate),
            description: `Ğ•Ğ¶ĞµĞ½ĞµĞ´ĞµĞ»ÑŒĞ½Ñ‹Ğ¹ Ğ²Ñ‹Ñ…Ğ¾Ğ´Ğ½Ğ¾Ğ¹: ${selectedDay?.label}`
        });
    };

    return (
        <Card>
            <CardHeader>
                <CardTitle className="flex items-center gap-2"><Repeat className="w-5 h-5" /> Ğ•Ğ¶ĞµĞ½ĞµĞ´ĞµĞ»ÑŒĞ½Ñ‹Ğµ Ğ²Ñ‹Ñ…Ğ¾Ğ´Ğ½Ñ‹Ğµ</CardTitle>
                <CardDescription>ĞĞ²Ñ‚Ğ¾Ğ¼Ğ°Ñ‚Ğ¸Ñ‡ĞµÑĞºĞ¸ ÑĞ´ĞµĞ»Ğ°Ñ‚ÑŒ Ğ²Ñ‹Ñ…Ğ¾Ğ´Ğ½Ñ‹Ğ¼Ğ¸ Ğ²ÑĞµ Ğ²Ñ‹Ğ±Ñ€Ğ°Ğ½Ğ½Ñ‹Ğµ Ğ´Ğ½Ğ¸ Ğ½ĞµĞ´ĞµĞ»Ğ¸ Ğ² Ğ¿ĞµÑ€Ğ¸Ğ¾Ğ´Ğµ.</CardDescription>
            </CardHeader>
            <CardContent>
                <form onSubmit={handleSubmit} className="space-y-4">
                    <div className="grid grid-cols-1 sm:grid-cols-3 gap-4">
                        <div>
                            <Label>Ğ”ĞµĞ½ÑŒ Ğ½ĞµĞ´ĞµĞ»Ğ¸</Label>
                            <Select value={dayOfWeek} onValueChange={setDayOfWeek}>
                                <SelectTrigger><SelectValue /></SelectTrigger>
                                <SelectContent>
                                    {daysOfWeek.map(day => (
                                        <SelectItem key={day.value} value={day.value}>{day.label}</SelectItem>
                                    ))}
                                </SelectContent>
                            </Select>
                        </div>
                        <div>
                            <Label>ĞĞ°Ñ‡Ğ¸Ğ½Ğ°Ñ Ñ</Label>
                            <Input type="date" value={startDate} onChange={e => setStartDate(e.target.value)} />
                        </div>
                        <div>
                            <Label>Ğ—Ğ°ĞºĞ°Ğ½Ñ‡Ğ¸Ğ²Ğ°Ñ</Label>
                            <Input type="date" value={endDate} onChange={e => setEndDate(e.target.value)} />
                        </div>
                    </div>
                    <Button type="submit" disabled={isLoading || createRuleMutation.isPending} className="w-full sm:w-auto">
                        {createRuleMutation.isPending ? "Ğ¡Ğ¾Ğ·Ğ´Ğ°Ğ½Ğ¸Ğµ..." : "Ğ¡Ğ¾Ğ·Ğ´Ğ°Ñ‚ÑŒ Ğ¿Ñ€Ğ°Ğ²Ğ¸Ğ»Ğ¾"}
                    </Button>
                </form>
            </CardContent>
        </Card>
    );
}

// --- ĞĞ¾Ğ²Ñ‹Ğ¹ ĞºĞ¾Ğ¼Ğ¿Ğ¾Ğ½ĞµĞ½Ñ‚ Ğ´Ğ»Ñ Ñ„Ğ¾Ñ€Ğ¼Ñ‹ Ğ¸Ğ¼Ğ¿Ğ¾Ñ€Ñ‚Ğ° ---
function PublicHolidayImportForm({ isLoading }: { isLoading: boolean }) {
    const [year, setYear] = useState<number>(new Date().getFullYear());
    const [countryCode, setCountryCode] = useState<string>("RU");
    const importMutation = useImportPublicHolidays();

    const handleSubmit = (e: React.FormEvent) => {
        e.preventDefault();
        importMutation.mutate({ year, country_code: countryCode });
    };

    return (
        <Card>
            <CardHeader>
                <CardTitle className="flex items-center gap-2"><Globe className="w-5 h-5" /> Ğ˜Ğ¼Ğ¿Ğ¾Ñ€Ñ‚ Ğ³Ğ¾Ñ. Ğ¿Ñ€Ğ°Ğ·Ğ´Ğ½Ğ¸ĞºĞ¾Ğ²</CardTitle>
                <CardDescription>ĞĞ²Ñ‚Ğ¾Ğ¼Ğ°Ñ‚Ğ¸Ñ‡ĞµÑĞºĞ¸ Ğ´Ğ¾Ğ±Ğ°Ğ²Ğ¸Ñ‚ÑŒ Ğ¾Ñ„Ğ¸Ñ†Ğ¸Ğ°Ğ»ÑŒĞ½Ñ‹Ğµ Ğ¿Ñ€Ğ°Ğ·Ğ´Ğ½Ğ¸ĞºĞ¸ Ğ´Ğ»Ñ ÑÑ‚Ñ€Ğ°Ğ½Ñ‹.</CardDescription>
            </CardHeader>
            <CardContent>
                <form onSubmit={handleSubmit} className="flex flex-col sm:flex-row items-end gap-4">
                    <div className="flex-grow">
                        <Label>Ğ“Ğ¾Ğ´</Label>
                        <Input type="number" value={year} onChange={e => setYear(parseInt(e.target.value, 10))} />
                    </div>
                    <div className="flex-grow">
                        <Label>ĞšĞ¾Ğ´ ÑÑ‚Ñ€Ğ°Ğ½Ñ‹ (ISO 3166-1)</Label>
                        <Input value={countryCode} onChange={e => setCountryCode(e.target.value.toUpperCase())} placeholder="RU" />
                    </div>
                    <Button type="submit" disabled={isLoading || importMutation.isPending}>
                        {importMutation.isPending ? "Ğ˜Ğ¼Ğ¿Ğ¾Ñ€Ñ‚..." : "Ğ˜Ğ¼Ğ¿Ğ¾Ñ€Ñ‚Ğ¸Ñ€Ğ¾Ğ²Ğ°Ñ‚ÑŒ"}
                    </Button>
                </form>
            </CardContent>
        </Card>
    );
}


// --- ĞÑĞ½Ğ¾Ğ²Ğ½Ğ¾Ğ¹ ĞºĞ¾Ğ¼Ğ¿Ğ¾Ğ½ĞµĞ½Ñ‚ HolidayManager ---
export default function HolidayManager() {
    const [month, setMonth] = useState(new Date());
    const [description, setDescription] = useState("");
    const [conflict, setConflict] = useState<ConflictInfo | null>(null);

    const startDate = startOfMonth(month);
    const endDate = endOfMonth(month);

    const { data: holidays = [], isLoading: isLoadingHolidays } = useHolidays(startDate, endDate);
    const createMutation = useCreateHoliday();
    const deleteMutation = useDeleteHoliday();

    const { data: rules = [], isLoading: isLoadingRules } = useGetHolidayRules();
    const deleteRuleMutation = useDeleteHolidayRule();

    const holidayDates = useMemo(() => holidays.map((h: HolidayWithDate) => h.date), [holidays]);
    const holidaySet = useMemo(() => new Set(holidays.map((h: HolidayWithDate) => format(h.date, "yyyy-MM-dd"))), [holidays]);

    const handleDaySelect = (day: Date | undefined) => {
        if (!day) return;

        if (holidaySet.has(format(day, "yyyy-MM-dd"))) {
            toast.info("Ğ­Ñ‚Ğ¾Ñ‚ Ğ´ĞµĞ½ÑŒ ÑƒĞ¶Ğµ ÑĞ²Ğ»ÑĞµÑ‚ÑÑ Ğ²Ñ‹Ñ…Ğ¾Ğ´Ğ½Ñ‹Ğ¼.");
            return;
        }

        createMutation.mutate({
            date: format(day, "yyyy-MM-dd"),
            description: description || undefined,
        }, {
            onError: (error: any) => {
                if (error.response?.status === 409) {
                    setConflict({
                        date: day,
                        description: description,
                        conflicting_reservation_ids: error.response.data.detail.conflicting_reservation_ids,
                    });
                }
            },
            onSuccess: () => setDescription("")
        });
    };

    const handleForceCreate = () => {
        if (!conflict) return;
        createMutation.mutate(
            { date: format(conflict.date, "yyyy-MM-dd"), description: conflict.description, force: true },
            { onSuccess: () => setConflict(null) }
        );
    };

    const handleDeleteHoliday = (date: Date) => {
        if (window.confirm(`Ğ’Ñ‹ ÑƒĞ²ĞµÑ€ĞµĞ½Ñ‹, Ñ‡Ñ‚Ğ¾ Ñ…Ğ¾Ñ‚Ğ¸Ñ‚Ğµ ÑƒĞ´Ğ°Ğ»Ğ¸Ñ‚ÑŒ Ğ²Ñ‹Ñ…Ğ¾Ğ´Ğ½Ğ¾Ğ¹ ${format(date, 'dd.MM.yyyy')}?`)) {
            deleteMutation.mutate(date);
        }
    };

    const handleDeleteRule = (ruleId: number) => {
        if (window.confirm(`Ğ’Ñ‹ ÑƒĞ²ĞµÑ€ĞµĞ½Ñ‹, Ñ‡Ñ‚Ğ¾ Ñ…Ğ¾Ñ‚Ğ¸Ñ‚Ğµ ÑƒĞ´Ğ°Ğ»Ğ¸Ñ‚ÑŒ ÑÑ‚Ğ¾ Ğ¿Ñ€Ğ°Ğ²Ğ¸Ğ»Ğ¾ Ğ¸ Ğ²ÑĞµ ÑĞ¾Ğ·Ğ´Ğ°Ğ½Ğ½Ñ‹Ğµ Ğ¸Ğ¼ Ğ±ÑƒĞ´ÑƒÑ‰Ğ¸Ğµ Ğ²Ñ‹Ñ…Ğ¾Ğ´Ğ½Ñ‹Ğµ?`)) {
            deleteRuleMutation.mutate(ruleId);
        }
    };

    const isLoading = isLoadingHolidays || isLoadingRules;

    return (
        <div className="space-y-6">

            <div className="space-y-4">
                <WeeklyRuleForm isLoading={isLoading} />
                <PublicHolidayImportForm isLoading={isLoading} />
            </div>

            <Card>
                <CardHeader>
                    <CardTitle className="flex items-center gap-2"><CalendarPlus className="w-5 h-5" /> Ğ ÑƒÑ‡Ğ½Ğ¾Ğµ ÑƒĞ¿Ñ€Ğ°Ğ²Ğ»ĞµĞ½Ğ¸Ğµ</CardTitle>
                    <CardDescription>Ğ’Ñ‹Ğ±ĞµÑ€Ğ¸Ñ‚Ğµ Ğ´Ğ°Ñ‚Ñƒ Ğ² ĞºĞ°Ğ»ĞµĞ½Ğ´Ğ°Ñ€Ğµ, Ñ‡Ñ‚Ğ¾Ğ±Ñ‹ ÑĞ´ĞµĞ»Ğ°Ñ‚ÑŒ ĞµĞµ Ğ²Ñ‹Ñ…Ğ¾Ğ´Ğ½Ñ‹Ğ¼, Ğ¸Ğ»Ğ¸ ÑƒĞ´Ğ°Ğ»Ğ¸Ñ‚Ğµ ÑÑƒÑ‰ĞµÑÑ‚Ğ²ÑƒÑÑ‰Ğ¸Ğ¹.</CardDescription>
                </CardHeader>
                <CardContent className="grid grid-cols-1 md:grid-cols-2 gap-8">
                    <div>
                        <div className="space-y-2 mb-4">
                            <Label htmlFor="holiday-desc">ĞĞ°Ğ·Ğ²Ğ°Ğ½Ğ¸Ğµ (Ğ½ĞµĞ¾Ğ±ÑĞ·Ğ°Ñ‚ĞµĞ»ÑŒĞ½Ğ¾)</Label>
                            <Input id="holiday-desc" placeholder="ĞĞ°Ğ¿Ñ€Ğ¸Ğ¼ĞµÑ€, ĞšĞ¾Ñ€Ğ¿Ğ¾Ñ€Ğ°Ñ‚Ğ¸Ğ²" value={description} onChange={(e) => setDescription(e.target.value)} />
                        </div>
                        <div className="flex justify-center border rounded-md p-2">
                            <DayPicker
                                mode="single" locale={ru} month={month} onMonthChange={setMonth}
                                onSelect={handleDaySelect} modifiers={{ holidays: holidayDates }}
                                modifiersClassNames={{ holidays: 'bg-red-100 text-red-800 rounded-md' }}
                                footer={isLoadingHolidays ? <p className="text-center text-sm p-2">Ğ—Ğ°Ğ³Ñ€ÑƒĞ·ĞºĞ°...</p> : <p className="text-center text-sm p-2">Ğ’Ñ‹Ğ±Ñ€Ğ°Ğ½ Ğ¼ĞµÑÑÑ†: {format(month, "LLLL yyyy", { locale: ru })}</p>}
                            />
                        </div>
                    </div>
                    <div>
                        <h3 className="text-md font-semibold mb-4">Ğ’Ñ‹Ñ…Ğ¾Ğ´Ğ½Ñ‹Ğµ Ğ² ÑÑ‚Ğ¾Ğ¼ Ğ¼ĞµÑÑÑ†Ğµ:</h3>
                        {holidays.length > 0 ? (
                            <div className="space-y-2 max-h-96 overflow-y-auto pr-2">
                                {holidays.map((holiday: HolidayWithDate) => (
                                    <div key={holiday.date.toString()} className="flex items-center justify-between p-2 bg-gray-50 rounded-md">
                                        <div>
                                            <span className="font-medium">{format(holiday.date, 'PPP', { locale: ru })}</span>
                                            {holiday.description && <span className="text-gray-600 text-sm ml-2">- {holiday.description}</span>}
                                        </div>
                                        <Button variant="ghost" size="icon" onClick={() => handleDeleteHoliday(holiday.date)} disabled={deleteMutation.isPending}><Trash2 className="h-4 w-4 text-red-500" /></Button>
                                    </div>
                                ))}
                            </div>
                        ) : (<p className="text-sm text-gray-500">Ğ’ ÑÑ‚Ğ¾Ğ¼ Ğ¼ĞµÑÑÑ†Ğµ Ğ²Ñ‹Ñ…Ğ¾Ğ´Ğ½Ñ‹Ğµ Ğ½Ğµ Ğ½Ğ°Ğ·Ğ½Ğ°Ñ‡ĞµĞ½Ñ‹.</p>)}
                    </div>
                </CardContent>
            </Card>

            <Card>
                <CardHeader>
                    <CardTitle>ĞĞºÑ‚Ğ¸Ğ²Ğ½Ñ‹Ğµ Ğ¿Ñ€Ğ°Ğ²Ğ¸Ğ»Ğ° Ğ°Ğ²Ñ‚Ğ¾Ğ¼Ğ°Ñ‚Ğ¸Ğ·Ğ°Ñ†Ğ¸Ğ¸</CardTitle>
                </CardHeader>
                <CardContent>
                    <Table>
                        <TableHeader>
                            <TableRow>
                                <TableHead>ĞĞ¿Ğ¸ÑĞ°Ğ½Ğ¸Ğµ</TableHead>
                                <TableHead>Ğ¢Ğ¸Ğ¿</TableHead>
                                <TableHead>Ğ”Ğ°Ñ‚Ğ° ÑĞ¾Ğ·Ğ´Ğ°Ğ½Ğ¸Ñ</TableHead>
                                <TableHead className="text-right">Ğ”ĞµĞ¹ÑÑ‚Ğ²Ğ¸Ñ</TableHead>
                            </TableRow>
                        </TableHeader>
                        <TableBody>
                            {isLoadingRules ? <TableRow><TableCell colSpan={4} className="text-center">Ğ—Ğ°Ğ³Ñ€ÑƒĞ·ĞºĞ° Ğ¿Ñ€Ğ°Ğ²Ğ¸Ğ»...</TableCell></TableRow> :
                                rules.length === 0 ? <TableRow><TableCell colSpan={4} className="text-center">ĞĞµÑ‚ Ğ°ĞºÑ‚Ğ¸Ğ²Ğ½Ñ‹Ñ… Ğ¿Ñ€Ğ°Ğ²Ğ¸Ğ».</TableCell></TableRow> :
                                    rules.map(rule => (
                                        <TableRow key={rule.id}>
                                            <TableCell>{rule.description}</TableCell>
                                            <TableCell><span className="text-xs font-mono bg-slate-100 px-2 py-1 rounded">{rule.rule_type}</span></TableCell>
                                            <TableCell>{format(new Date(rule.created_at), 'dd.MM.yyyy HH:mm')}</TableCell>
                                            <TableCell className="text-right">
                                                <Button variant="ghost" size="icon" onClick={() => handleDeleteRule(rule.id)} disabled={deleteRuleMutation.isPending}><Trash2 className="h-4 w-4 text-red-500" /></Button>
                                            </TableCell>
                                        </TableRow>
                                    ))}
                        </TableBody>
                    </Table>
                </CardContent>
            </Card>

            <Dialog open={!!conflict} onOpenChange={() => setConflict(null)}>
                <DialogContent>
                    <DialogHeader>
                        <DialogTitle>ĞĞ±Ğ½Ğ°Ñ€ÑƒĞ¶ĞµĞ½ ĞºĞ¾Ğ½Ñ„Ğ»Ğ¸ĞºÑ‚</DialogTitle>
                        <DialogDescription>
                            Ğ’Ñ‹Ğ±Ñ€Ğ°Ğ½Ğ½Ğ°Ñ Ğ´Ğ°Ñ‚Ğ° ÑĞ²Ğ»ÑĞµÑ‚ÑÑ Ğ´Ğ°Ñ‚Ğ¾Ğ¹ Ğ½Ğ°Ñ‡Ğ°Ğ»Ğ° Ğ¸Ğ»Ğ¸ Ğ¾ĞºĞ¾Ğ½Ñ‡Ğ°Ğ½Ğ¸Ñ Ğ´Ğ»Ñ ÑĞ»ĞµĞ´ÑƒÑÑ‰Ğ¸Ñ… Ñ€ĞµĞ·ĞµÑ€Ğ²Ğ¾Ğ²:
                            <strong className="block my-2">ID: {conflict?.conflicting_reservation_ids.join(', ')}</strong>
                            ĞĞ°Ğ·Ğ½Ğ°Ñ‡ĞµĞ½Ğ¸Ğµ ÑÑ‚Ğ¾Ğ³Ğ¾ Ğ´Ğ½Ñ Ğ²Ñ‹Ñ…Ğ¾Ğ´Ğ½Ñ‹Ğ¼ ÑĞ´ĞµĞ»Ğ°ĞµÑ‚ ÑÑ‚Ğ¸ Ñ€ĞµĞ·ĞµÑ€Ğ²Ñ‹ Ğ½ĞµĞºĞ¾Ñ€Ñ€ĞµĞºÑ‚Ğ½Ñ‹Ğ¼Ğ¸. Ğ’Ñ‹ ÑƒĞ²ĞµÑ€ĞµĞ½Ñ‹, Ñ‡Ñ‚Ğ¾ Ñ…Ğ¾Ñ‚Ğ¸Ñ‚Ğµ Ğ¿Ñ€Ğ¾Ğ´Ğ¾Ğ»Ğ¶Ğ¸Ñ‚ÑŒ?
                        </DialogDescription>
                    </DialogHeader>
                    <DialogFooter>
                        <Button variant="ghost" onClick={() => setConflict(null)}>ĞÑ‚Ğ¼ĞµĞ½Ğ°</Button>
                        <Button variant="destructive" onClick={handleForceCreate} disabled={createMutation.isPending}>
                            {createMutation.isPending ? "ĞĞ±Ñ€Ğ°Ğ±Ğ¾Ñ‚ĞºĞ°..." : "Ğ”Ğ°, Ğ²ÑĞµ Ñ€Ğ°Ğ²Ğ½Ğ¾ Ğ½Ğ°Ğ·Ğ½Ğ°Ñ‡Ğ¸Ñ‚ÑŒ"}
                        </Button>
                    </DialogFooter>
                </DialogContent>
            </Dialog>
        </div>
    );
}

```


## <a name="srccomponentsadminPromoCodeDialogtsx"></a>`src/components/admin/PromoCodeDialog.tsx`

```tsx
// path: src/components/admin/PromoCodeDialog.tsx

// src/components/admin/PromoCodeDialog.tsx

import { useEffect, useMemo } from "react";
import { useForm, Controller } from "react-hook-form";
import { zodResolver } from "@hookform/resolvers/zod";
import { Button } from "@/components/ui/button";
import { Dialog, DialogContent, DialogHeader, DialogTitle, DialogFooter, DialogDescription } from "@/components/ui/dialog";
import { Input } from "@/components/ui/input";
import { Label } from "@/components/ui/label";
import { Switch } from "@/components/ui/switch";
import { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from "@/components/ui/select";
import { toast } from "sonner";
import { RefreshCw } from "lucide-react";

import { useCreatePromoCode, useUpdatePromoCode, fetchGeneratedPromoCode } from "@/hooks/useAdminPromoCodes";
import { useEquipment } from "@/hooks/useEquipment";
import { useAdminUsers } from "@/hooks/useAdminUsers";
import { useCurrentUser } from "@/hooks/useProfile";
import type { PromoCodeOut, PromoCodeCreate } from "@/types/promo_code";
import { promoCodeFormSchema, PromoCodeFormData } from "@/lib/validationSchemas";
import { MultiSelect } from "@/components/ui/multi-select";

interface Props {
    promoCode?: PromoCodeOut | null;
    open: boolean;
    onClose: () => void;
}

export function PromoCodeDialog({ promoCode, open, onClose }: Props) {
    const { data: user } = useCurrentUser();
    const createMutation = useCreatePromoCode();
    const updateMutation = useUpdatePromoCode();

    // +++ ĞĞĞ§ĞĞ›Ğ Ğ˜Ğ—ĞœĞ•ĞĞ•ĞĞ˜Ğ™ +++
    // 1. ĞŸĞ¾Ğ»ÑƒÑ‡Ğ°ĞµĞ¼ Ğ¾Ğ±ÑŠĞµĞºÑ‚ Ñ Ğ¿Ğ°Ğ³Ğ¸Ğ½Ğ°Ñ†Ğ¸ĞµĞ¹ Ğ¾Ñ‚ useInfiniteQuery
    const { data: equipmentPages } = useEquipment();
    const { data: usersResponse, isLoading: isLoadingUsers } = useAdminUsers();

    // 2. "Ğ Ğ°Ğ·Ğ²Ğ¾Ñ€Ğ°Ñ‡Ğ¸Ğ²Ğ°ĞµĞ¼" ÑÑ‚Ñ€Ğ°Ğ½Ğ¸Ñ†Ñ‹ Ğ² Ğ¾Ğ´Ğ¸Ğ½ Ğ¿Ğ»Ğ¾ÑĞºĞ¸Ğ¹ Ğ¼Ğ°ÑÑĞ¸Ğ² allEquipment
    const allEquipment = useMemo(() =>
            equipmentPages?.pages.flatMap(page => page.items) ?? [],
        [equipmentPages]);

    // 3. ĞĞ½Ğ°Ğ»Ğ¾Ğ³Ğ¸Ñ‡Ğ½Ğ¾ Ğ¿Ğ¾ÑÑ‚ÑƒĞ¿Ğ°ĞµĞ¼ Ñ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ÑĞ¼Ğ¸
    const users = useMemo(() => 
        usersResponse?.pages?.flatMap(page => page.items) ?? [], 
        [usersResponse]
    );
    // +++ ĞšĞĞĞ•Ğ¦ Ğ˜Ğ—ĞœĞ•ĞĞ•ĞĞ˜Ğ™ +++


    const {
        register,
        handleSubmit,
        control,
        reset,
        setValue,
        formState: { errors, isValid },
    } = useForm<PromoCodeFormData>({
        resolver: zodResolver(promoCodeFormSchema) as any,
        mode: "onChange",
    });

    useEffect(() => {
        if (open) {
            if (promoCode) {
                reset({
                    code: promoCode.code,
                    description: promoCode.description ?? undefined,
                    discount_percentage: promoCode.discount_percentage,
                    is_active: promoCode.is_active,
                    valid_from: promoCode.valid_from ? new Date(promoCode.valid_from) : undefined,
                    expires_at: promoCode.expires_at ? new Date(promoCode.expires_at) : undefined,
                    max_uses: promoCode.max_uses ?? undefined,
                    max_uses_per_user: promoCode.max_uses_per_user ?? undefined,
                    min_order_amount: promoCode.min_order_amount ?? undefined,
                    specific_to_user_id: promoCode.specific_to_user_id ?? undefined,
                    applicable_to_equipment_ids: promoCode.applicable_to_equipment_ids ?? [],
                    applicable_to_equipment_types: promoCode.applicable_to_equipment_types ?? [],
                });
            } else {
                reset({
                    code: "",
                    description: "",
                    discount_percentage: 10,
                    is_active: true,
                    max_uses_per_user: 1,
                    applicable_to_equipment_ids: [],
                    applicable_to_equipment_types: [],
                });
            }
        }
    }, [promoCode, open, reset]);

    const onSubmit = (data: PromoCodeFormData) => {
        const maxDiscount = user?.role === 'admin' ? 50 : 20;
        if (data.discount_percentage > maxDiscount) {
            toast.error(`ĞœĞ°ĞºÑĞ¸Ğ¼Ğ°Ğ»ÑŒĞ½Ğ°Ñ ÑĞºĞ¸Ğ´ĞºĞ° Ğ´Ğ»Ñ Ğ²Ğ°ÑˆĞµĞ¹ Ñ€Ğ¾Ğ»Ğ¸: ${maxDiscount}%`);
            return;
        }

        const payload = {
            ...data,
            valid_from: data.valid_from ? data.valid_from.toISOString() : null,
            expires_at: data.expires_at ? data.expires_at.toISOString() : null,
        };

        if (promoCode) {
            updateMutation.mutate({ id: promoCode.id, data: payload }, { onSuccess: onClose });
        } else {
            createMutation.mutate(payload as PromoCodeCreate, { onSuccess: onClose });
        }
    };

    const handleGenerateCode = async () => {
        const newCode = await fetchGeneratedPromoCode();
        if (newCode) {
            setValue("code", newCode, { shouldValidate: true, shouldDirty: true });
        }
    };

    const isLoading = createMutation.isPending || updateMutation.isPending;

    // +++ ĞĞĞ§ĞĞ›Ğ Ğ˜Ğ—ĞœĞ•ĞĞ•ĞĞ˜Ğ™: Ğ˜ÑĞ¿Ğ¾Ğ»ÑŒĞ·ÑƒĞµĞ¼ `allEquipment` Ğ²Ğ¼ĞµÑÑ‚Ğ¾ `equipments` +++
    const equipmentOptions = useMemo(() => allEquipment.map(e => ({ value: e.id.toString(), label: e.name })), [allEquipment]);
    const equipmentTypeOptions = useMemo(() => [...new Set(allEquipment.map(e => e.equipment_type))].map(type => ({ value: type, label: type })), [allEquipment]);
    // +++ ĞšĞĞĞ•Ğ¦ Ğ˜Ğ—ĞœĞ•ĞĞ•ĞĞ˜Ğ™ +++
    const userOptions = useMemo(() => users.map((u: any) => ({ value: u.id.toString(), label: `${u.full_name} (${u.email})` })), [users]);

    return (
        <Dialog open={open} onOpenChange={onClose}>
            <DialogContent className="sm:max-w-[700px] max-h-[90vh] overflow-y-auto">
                <DialogHeader>
                    <DialogTitle>{promoCode ? "Ğ ĞµĞ´Ğ°ĞºÑ‚Ğ¸Ñ€Ğ¾Ğ²Ğ°Ñ‚ÑŒ Ğ¿Ñ€Ğ¾Ğ¼Ğ¾ĞºĞ¾Ğ´" : "Ğ¡Ğ¾Ğ·Ğ´Ğ°Ñ‚ÑŒ Ğ½Ğ¾Ğ²Ñ‹Ğ¹ Ğ¿Ñ€Ğ¾Ğ¼Ğ¾ĞºĞ¾Ğ´"}</DialogTitle>
                    <DialogDescription>{promoCode ? `Ğ ĞµĞ´Ğ°ĞºÑ‚Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ "${promoCode.code}"` : "Ğ—Ğ°Ğ¿Ğ¾Ğ»Ğ½Ğ¸Ñ‚Ğµ Ğ´ĞµÑ‚Ğ°Ğ»Ğ¸ Ğ´Ğ»Ñ Ğ½Ğ¾Ğ²Ğ¾Ğ³Ğ¾ Ğ¿Ñ€Ğ¾Ğ¼Ğ¾ĞºĞ¾Ğ´Ğ°."}</DialogDescription>
                </DialogHeader>
                <form onSubmit={handleSubmit(onSubmit)} className="space-y-4 py-4 pr-2">
                    <div className="grid grid-cols-4 items-center gap-4">
                        <Label htmlFor="code" className="text-right">ĞšĞ¾Ğ´ *</Label>
                        <div className="col-span-3 flex items-center gap-2">
                            <Input id="code" {...register("code")} className="flex-grow" placeholder="SUMMER25"/>
                            <Button type="button" variant="outline" size="icon" onClick={handleGenerateCode} title="Ğ¡Ğ³ĞµĞ½ĞµÑ€Ğ¸Ñ€Ğ¾Ğ²Ğ°Ñ‚ÑŒ ĞºĞ¾Ğ´"><RefreshCw className="h-4 w-4" /></Button>
                        </div>
                        {errors.code && <p className="col-start-2 col-span-3 text-xs text-red-500 mt-1">{errors.code.message}</p>}
                    </div>

                    <div className="grid grid-cols-4 items-center gap-4">
                        <Label htmlFor="discount_percentage" className="text-right">Ğ¡ĞºĞ¸Ğ´ĞºĞ°, % *</Label>
                        <div className="col-span-3"><Input id="discount_percentage" type="number" {...register("discount_percentage")} /></div>
                        {errors.discount_percentage && <p className="col-start-2 col-span-3 text-xs text-red-500 mt-1">{errors.discount_percentage.message}</p>}
                    </div>

                    <div className="grid grid-cols-4 items-center gap-4">
                        <Label htmlFor="description" className="text-right">ĞĞ¿Ğ¸ÑĞ°Ğ½Ğ¸Ğµ</Label>
                        <div className="col-span-3"><Input id="description" {...register("description")} placeholder="Ğ”Ğ»Ñ Ğ²Ğ½ÑƒÑ‚Ñ€ĞµĞ½Ğ½ĞµĞ³Ğ¾ Ğ¸ÑĞ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ"/></div>
                    </div>

                    <div className="grid grid-cols-4 items-center gap-4">
                        <Label className="text-right">Ğ›Ğ¸Ğ¼Ğ¸Ñ‚Ñ‹</Label>
                        <div className="col-span-3 grid grid-cols-3 gap-2">
                            <Input type="number" {...register("max_uses")} placeholder="Ğ’ÑĞµĞ³Ğ¾"/>
                            <Input type="number" {...register("max_uses_per_user")} placeholder="ĞĞ° ÑĞ·ĞµÑ€Ğ°"/>
                            <Input type="number" {...register("min_order_amount")} placeholder="ĞœĞ¸Ğ½. ÑÑƒĞ¼Ğ¼Ğ° â‚½"/>
                        </div>
                    </div>

                    <div className="grid grid-cols-4 items-center gap-4">
                        <Label className="text-right">Ğ¡Ñ€Ğ¾Ğº Ğ´ĞµĞ¹ÑÑ‚Ğ²Ğ¸Ñ</Label>
                        <div className="col-span-3 grid grid-cols-2 gap-2">
                            <Controller control={control} name="valid_from" render={({ field }) => (<Input type="date" onChange={(e) => field.onChange(e.target.valueAsDate)} value={field.value ? field.value.toISOString().split('T')[0] : ''}/>)} />
                            <Controller control={control} name="expires_at" render={({ field }) => (<Input type="date" onChange={(e) => field.onChange(e.target.valueAsDate)} value={field.value ? field.value.toISOString().split('T')[0] : ''}/>)} />
                        </div>
                        {errors.expires_at && <p className="col-start-2 col-span-3 text-xs text-red-500 mt-1">{errors.expires_at.message}</p>}
                    </div>

                    <div className="grid grid-cols-4 items-center gap-4">
                        <Label className="text-right">Ğ”Ğ»Ñ Ñ‚Ğ¾Ğ²Ğ°Ñ€Ğ¾Ğ²</Label>
                        <div className="col-span-3">
                            <Controller control={control} name="applicable_to_equipment_ids" render={({ field }) => (<MultiSelect placeholder="Ğ”Ğ»Ñ Ğ²ÑĞµĞ³Ğ¾ Ğ¾Ğ±Ğ¾Ñ€ÑƒĞ´Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ" options={equipmentOptions} value={field.value?.map(String) || []} onValueChange={(selected) => field.onChange(selected.map(Number))} />)} />
                        </div>
                    </div>

                    <div className="grid grid-cols-4 items-center gap-4">
                        <Label className="text-right">Ğ”Ğ»Ñ Ñ‚Ğ¸Ğ¿Ğ¾Ğ²</Label>
                        <div className="col-span-3">
                            <Controller control={control} name="applicable_to_equipment_types" render={({ field }) => (<MultiSelect placeholder="Ğ”Ğ»Ñ Ğ²ÑĞµÑ… Ñ‚Ğ¸Ğ¿Ğ¾Ğ²" options={equipmentTypeOptions} value={field.value || []} onValueChange={field.onChange}/>)} />
                        </div>
                    </div>

                    <div className="grid grid-cols-4 items-center gap-4">
                        <Label className="text-right">Ğ”Ğ»Ñ ÑĞ·ĞµÑ€Ğ°</Label>
                        <div className="col-span-3">
                            <Controller control={control} name="specific_to_user_id"
                                        render={({ field }) => (
                                            <Select
                                                onValueChange={(value) => field.onChange(value === 'all' ? undefined : Number(value))}
                                                value={field.value?.toString()}
                                                disabled={isLoadingUsers}
                                            >
                                                <SelectTrigger><SelectValue placeholder="Ğ”Ğ»Ñ Ğ²ÑĞµÑ… Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ĞµĞ¹" /></SelectTrigger>
                                                <SelectContent>
                                                    <SelectItem value="all">Ğ”Ğ»Ñ Ğ²ÑĞµÑ… Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ĞµĞ¹</SelectItem>
                                                    {userOptions.map((opt: any) => <SelectItem key={opt.value} value={opt.value}>{opt.label}</SelectItem>)}
                                                </SelectContent>
                                            </Select>
                                        )}
                            />
                        </div>
                    </div>

                    <div className="grid grid-cols-4 items-center gap-4">
                        <Label className="text-right">Ğ¡Ñ‚Ğ°Ñ‚ÑƒÑ</Label>
                        <div className="col-span-3 flex items-center space-x-2">
                            <Controller control={control} name="is_active" render={({ field }) => (
                                <Switch id="is_active" checked={field.value} onCheckedChange={field.onChange} />
                            )} />
                            <Label htmlFor="is_active" className="font-normal cursor-pointer">ĞĞºÑ‚Ğ¸Ğ²ĞµĞ½</Label>
                        </div>
                    </div>

                    <DialogFooter>
                        <Button type="button" variant="ghost" onClick={onClose}>ĞÑ‚Ğ¼ĞµĞ½Ğ°</Button>
                        <Button type="submit" disabled={!isValid || isLoading}>
                            {isLoading ? "Ğ¡Ğ¾Ñ…Ñ€Ğ°Ğ½ĞµĞ½Ğ¸Ğµ..." : "Ğ¡Ğ¾Ñ…Ñ€Ğ°Ğ½Ğ¸Ñ‚ÑŒ"}
                        </Button>
                    </DialogFooter>
                </form>
            </DialogContent>
        </Dialog>
    );
}

```


## <a name="srccomponentsadminPromoCodeTabletsx"></a>`src/components/admin/PromoCodeTable.tsx`

```tsx
// path: src/components/admin/PromoCodeTable.tsx

// src/components/admin/PromoCodeTable.tsx

import { useState } from "react";
import { useAdminPromoCodes, useDeletePromoCode } from "@/hooks/useAdminPromoCodes";
import { PromoCodeDialog } from "./PromoCodeDialog";
import type { PromoCodeOut } from "@/types/promo_code";
import { formatDateEuropean } from "@/lib/utils";

import { Button } from "@/components/ui/button";
import { Input } from "@/components/ui/input";
import { Badge } from "@/components/ui/badge";
import { Table, TableBody, TableCell, TableHead, TableHeader, TableRow } from "@/components/ui/table";
// âœ… Ğ£Ğ±Ñ€Ğ°Ğ½Ğ° Ğ¸ĞºĞ¾Ğ½ĞºĞ° AlertCircle
import { Plus, Edit, Trash2, Search, Ticket } from "lucide-react";

export default function PromoCodeTable() {
    const { data: promoCodes = [], isLoading, error } = useAdminPromoCodes();
    const deleteMutation = useDeletePromoCode();

    const [search, setSearch] = useState("");
    const [isDialogOpen, setDialogOpen] = useState(false);
    const [editingPromoCode, setEditingPromoCode] = useState<PromoCodeOut | null>(null);

    const filteredPromoCodes = promoCodes.filter(pc =>
        pc.code.toLowerCase().includes(search.toLowerCase()) ||
        pc.description?.toLowerCase().includes(search.toLowerCase())
    );

    const handleCreate = () => {
        setEditingPromoCode(null);
        setDialogOpen(true);
    };

    const handleEdit = (promoCode: PromoCodeOut) => {
        setEditingPromoCode(promoCode);
        setDialogOpen(true);
    };

    const handleDelete = (id: number) => {
        if (window.confirm("Ğ’Ñ‹ ÑƒĞ²ĞµÑ€ĞµĞ½Ñ‹, Ñ‡Ñ‚Ğ¾ Ñ…Ğ¾Ñ‚Ğ¸Ñ‚Ğµ ÑƒĞ´Ğ°Ğ»Ğ¸Ñ‚ÑŒ ÑÑ‚Ğ¾Ñ‚ Ğ¿Ñ€Ğ¾Ğ¼Ğ¾ĞºĞ¾Ğ´? Ğ”ĞµĞ¹ÑÑ‚Ğ²Ğ¸Ğµ Ğ½ĞµĞ¾Ğ±Ñ€Ğ°Ñ‚Ğ¸Ğ¼Ğ¾.")) {
            deleteMutation.mutate(id);
        }
    };

    if (isLoading) return <p className="text-center py-4">Ğ—Ğ°Ğ³Ñ€ÑƒĞ·ĞºĞ° Ğ¿Ñ€Ğ¾Ğ¼Ğ¾ĞºĞ¾Ğ´Ğ¾Ğ²...</p>;
    if (error) return <p className="text-center text-red-600 py-4">ĞÑˆĞ¸Ğ±ĞºĞ° Ğ·Ğ°Ğ³Ñ€ÑƒĞ·ĞºĞ¸ Ğ´Ğ°Ğ½Ğ½Ñ‹Ñ….</p>;

    return (
        <>
            <div className="flex flex-col sm:flex-row items-center justify-between gap-4 mb-4">
                <div className="relative w-full sm:max-w-xs">
                    <Search className="absolute left-3 top-2.5 h-4 w-4 text-muted-foreground" />
                    <Input
                        placeholder="ĞŸĞ¾Ğ¸ÑĞº Ğ¿Ğ¾ ĞºĞ¾Ğ´Ñƒ Ğ¸Ğ»Ğ¸ Ğ¾Ğ¿Ğ¸ÑĞ°Ğ½Ğ¸Ñ..."
                        value={search}
                        onChange={(e) => setSearch(e.target.value)}
                        className="pl-10"
                    />
                </div>
                <Button onClick={handleCreate} className="w-full sm:w-auto">
                    <Plus className="mr-2 h-4 w-4" /> Ğ”Ğ¾Ğ±Ğ°Ğ²Ğ¸Ñ‚ÑŒ Ğ¿Ñ€Ğ¾Ğ¼Ğ¾ĞºĞ¾Ğ´
                </Button>
            </div>

            {filteredPromoCodes.length > 0 ? (
                <div className="border rounded-md overflow-x-auto">
                    <Table>
                        <TableHeader>
                            <TableRow>
                                <TableHead>ĞšĞ¾Ğ´</TableHead>
                                <TableHead>Ğ¡ĞºĞ¸Ğ´ĞºĞ°</TableHead>
                                <TableHead>Ğ¡Ñ‚Ğ°Ñ‚ÑƒÑ</TableHead>
                                <TableHead>Ğ˜ÑĞ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ</TableHead>
                                <TableHead>Ğ¡Ñ€Ğ¾Ğº Ğ´ĞµĞ¹ÑÑ‚Ğ²Ğ¸Ñ</TableHead>
                                <TableHead className="text-right">Ğ”ĞµĞ¹ÑÑ‚Ğ²Ğ¸Ñ</TableHead>
                            </TableRow>
                        </TableHeader>
                        <TableBody>
                            {filteredPromoCodes.map((pc) => (
                                <TableRow key={pc.id}>
                                    <TableCell className="font-medium">{pc.code}</TableCell>
                                    <TableCell>{pc.discount_percentage}%</TableCell>
                                    <TableCell>
                                        <Badge variant={pc.is_active ? "default" : "secondary"}>
                                            {pc.is_active ? "ĞĞºÑ‚Ğ¸Ğ²ĞµĞ½" : "ĞĞµĞ°ĞºÑ‚Ğ¸Ğ²ĞµĞ½"}
                                        </Badge>
                                    </TableCell>
                                    <TableCell>
                                        {pc.times_used} / {pc.max_uses ?? 'âˆ'}
                                    </TableCell>
                                    <TableCell>
                                        {pc.expires_at ? formatDateEuropean(pc.expires_at) : 'Ğ‘ĞµÑÑÑ€Ğ¾Ñ‡Ğ½Ğ¾'}
                                    </TableCell>
                                    <TableCell className="text-right">
                                        <Button variant="ghost" size="icon" onClick={() => handleEdit(pc)}>
                                            <Edit className="h-4 w-4" />
                                        </Button>
                                        <Button variant="ghost" size="icon" onClick={() => handleDelete(pc.id)} disabled={deleteMutation.isPending}>
                                            <Trash2 className="h-4 w-4 text-red-500" />
                                        </Button>
                                    </TableCell>
                                </TableRow>
                            ))}
                        </TableBody>
                    </Table>
                </div>
            ) : (
                <div className="text-center py-12 px-4 border-2 border-dashed rounded-lg">
                    <Ticket className="w-16 h-16 text-gray-300 mx-auto mb-3" />
                    <h3 className="text-lg font-semibold text-gray-700">ĞŸÑ€Ğ¾Ğ¼Ğ¾ĞºĞ¾Ğ´Ñ‹ Ğ½Ğµ Ğ½Ğ°Ğ¹Ğ´ĞµĞ½Ñ‹</h3>
                    <p className="text-sm text-gray-500 mt-1">
                        {search ? "ĞŸĞ¾Ğ¿Ñ€Ğ¾Ğ±ÑƒĞ¹Ñ‚Ğµ Ğ¸Ğ·Ğ¼ĞµĞ½Ğ¸Ñ‚ÑŒ Ğ¿Ğ¾Ğ¸ÑĞºĞ¾Ğ²Ñ‹Ğ¹ Ğ·Ğ°Ğ¿Ñ€Ğ¾Ñ." : "Ğ”Ğ¾Ğ±Ğ°Ğ²ÑŒÑ‚Ğµ Ğ¿ĞµÑ€Ğ²Ñ‹Ğ¹ Ğ¿Ñ€Ğ¾Ğ¼Ğ¾ĞºĞ¾Ğ´, Ñ‡Ñ‚Ğ¾Ğ±Ñ‹ Ğ¾Ğ½ Ğ¿Ğ¾ÑĞ²Ğ¸Ğ»ÑÑ Ğ² ÑĞ¿Ğ¸ÑĞºĞµ."}
                    </p>
                </div>
            )}

            <PromoCodeDialog
                open={isDialogOpen}
                onClose={() => setDialogOpen(false)}
                promoCode={editingPromoCode}
            />
        </>
    );
}

```


## <a name="srccomponentsadminRentalStatusBadgetsx"></a>`src/components/admin/RentalStatusBadge.tsx`

```tsx
// path: src/components/admin/RentalStatusBadge.tsx

// src/components/admin/RentalStatusBadge.tsx

import { Badge } from "@/components/ui/badge";

type RentalStatus = 'active' | 'overdue' | 'completed';

interface Props {
    status: RentalStatus;
}

export default function RentalStatusBadge({ status }: Props) {
    const statusConfig = {
        active: { text: "ĞĞºÑ‚Ğ¸Ğ²Ğ½Ğ°", className: "bg-green-100 text-green-800 border-green-200" },
        overdue: { text: "ĞŸÑ€Ğ¾ÑÑ€Ğ¾Ñ‡ĞµĞ½Ğ°", className: "bg-red-100 text-red-800 border-red-200" },
        completed: { text: "Ğ—Ğ°Ğ²ĞµÑ€ÑˆĞµĞ½Ğ°", className: "bg-gray-100 text-gray-800 border-gray-200" },
    };

    const config = statusConfig[status] || statusConfig.completed;

    return (
        <Badge variant="outline" className={`font-medium ${config.className}`}>
            {config.text}
        </Badge>
    );
}

```


## <a name="srccomponentsadminReservationFinancialSummarytsx"></a>`src/components/admin/ReservationFinancialSummary.tsx`

```tsx
// path: src/components/admin/ReservationFinancialSummary.tsx

// src/components/admin/ReservationFinancialSummary.tsx

import { useMemo } from "react";
import { usePriceCalculator } from "@/hooks/reservation/usePriceCalculator";
import { AlertCircle, Loader2, ReceiptText } from "lucide-react";
import type { AdminReservationOut } from "@/types/reservation";
import type { Equipment } from "@/types/equipment"; // Ğ˜Ğ¼Ğ¿Ğ¾Ñ€Ñ‚Ğ¸Ñ€ÑƒĞµĞ¼ Ñ‚Ğ¸Ğ¿ Equipment

interface ReservationFinancialSummaryProps {
    reservation: AdminReservationOut;
    open: boolean;
    // +++ ĞĞĞ§ĞĞ›Ğ: ĞĞ¾Ğ²Ñ‹Ğµ Ğ¿Ñ€Ğ¾Ğ¿ÑÑ‹ Ğ´Ğ»Ñ Ğ¾Ñ‚Ğ¾Ğ±Ñ€Ğ°Ğ¶ĞµĞ½Ğ¸Ñ ĞºĞ¾Ğ½Ñ„Ğ»Ğ¸ĞºÑ‚Ğ¾Ğ² +++
    hasConflicts: boolean;
    conflictingItemIds: number[];
    isCheckingAvailability: boolean;
    equipmentMap: Map<number, Equipment>;
    // +++ ĞšĞĞĞ•Ğ¦: ĞĞ¾Ğ²Ñ‹Ğµ Ğ¿Ñ€Ğ¾Ğ¿ÑÑ‹ +++
}

export default function ReservationFinancialSummary({
                                                        reservation,
                                                        open,
                                                        hasConflicts,
                                                        conflictingItemIds,
                                                        isCheckingAvailability,
                                                        equipmentMap
                                                    }: ReservationFinancialSummaryProps) {

    const { newStartDate, newEndDate, newDateRangeIsValid } = useMemo(() => {
        const today = new Date();
        today.setHours(0, 0, 0, 0);

        const originalEndDate = new Date(reservation.end_date);

        return {
            newStartDate: today,
            newEndDate: originalEndDate,
            newDateRangeIsValid: originalEndDate > today,
        };
    }, [reservation]);

    const { data: priceDetails, isFetching: isCalculatingPrice, error: priceError } = usePriceCalculator({
        equipmentIds: reservation.equipment_ids || [],
        startDate: newStartDate!,
        endDate: newEndDate!,
        selectedAccessories: reservation.selected_accessories || {},
        promoCode: reservation.promo_code || undefined,
        enabled: open && newDateRangeIsValid,
    });

    const finalCost = priceDetails?.final_total ?? reservation.total_cost ?? 0;

    // +++ ĞŸĞ¾Ğ»ÑƒÑ‡Ğ°ĞµĞ¼ Ğ¸Ğ¼ĞµĞ½Ğ° ĞºĞ¾Ğ½Ñ„Ğ»Ğ¸ĞºÑ‚Ğ½Ğ¾Ğ³Ğ¾ Ğ¾Ğ±Ğ¾Ñ€ÑƒĞ´Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ +++
    const conflictingEquipmentNames = useMemo(() =>
            conflictingItemIds.map(id => equipmentMap.get(id)?.name).filter(Boolean).join(', '),
        [conflictingItemIds, equipmentMap]);

    return (
        <div className="p-3 bg-slate-50 border rounded-lg space-y-2">
            <h4 className="flex items-center gap-2 text-sm font-semibold text-gray-800">
                <ReceiptText className="w-5 h-5 text-sky-600" />
                Ğ¤Ğ¸Ğ½Ğ°Ğ½ÑĞ¾Ğ²Ğ°Ñ ÑĞ²Ğ¾Ğ´ĞºĞ°
            </h4>

            {(isCalculatingPrice || isCheckingAvailability) ? (
                <div className="flex items-center justify-center gap-2 text-sm text-gray-500 py-4">
                    <Loader2 className="h-4 w-4 animate-spin" />
                    {isCheckingAvailability ? "ĞŸÑ€Ğ¾Ğ²ĞµÑ€ĞºĞ° Ğ´Ğ¾ÑÑ‚ÑƒĞ¿Ğ½Ğ¾ÑÑ‚Ğ¸..." : "ĞŸĞµÑ€ĞµÑÑ‡ĞµÑ‚ ÑÑ‚Ğ¾Ğ¸Ğ¼Ğ¾ÑÑ‚Ğ¸..."}
                </div>
            ) : hasConflicts ? (
                // +++ ĞĞĞ§ĞĞ›Ğ: ĞĞ¾Ğ²Ñ‹Ğ¹ Ğ±Ğ»Ğ¾Ğº Ğ´Ğ»Ñ Ğ¾Ñ‚Ğ¾Ğ±Ñ€Ğ°Ğ¶ĞµĞ½Ğ¸Ñ Ğ¾ÑˆĞ¸Ğ±ĞºĞ¸ ĞºĞ¾Ğ½Ñ„Ğ»Ğ¸ĞºÑ‚Ğ° +++
                <div className="text-sm text-red-700 font-medium p-2 bg-red-100 border border-red-200 rounded-md space-y-1">
                    <div className="flex items-center gap-2">
                        <AlertCircle className="h-4 w-4" />
                        <span>ĞšĞ¾Ğ½Ñ„Ğ»Ğ¸ĞºÑ‚ Ğ±Ñ€Ğ¾Ğ½Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ!</span>
                    </div>
                    <p className="text-xs font-normal pl-6">
                        ĞĞ±Ğ¾Ñ€ÑƒĞ´Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ Ğ½ĞµĞ´Ğ¾ÑÑ‚ÑƒĞ¿Ğ½Ğ¾ Ğ² Ğ½Ğ¾Ğ²Ğ¾Ğ¼ Ğ¿ĞµÑ€Ğ¸Ğ¾Ğ´Ğµ: <strong>{conflictingEquipmentNames}</strong>.
                    </p>
                </div>
                // +++ ĞšĞĞĞ•Ğ¦: ĞĞ¾Ğ²Ñ‹Ğ¹ Ğ±Ğ»Ğ¾Ğº +++
            ) : priceError || !newDateRangeIsValid ? (
                <div className="flex items-center gap-2 text-sm text-red-600 font-medium p-2 bg-red-50 rounded-md">
                    <AlertCircle className="h-4 w-4" />
                    <span>{priceError ? "ĞĞµ ÑƒĞ´Ğ°Ğ»Ğ¾ÑÑŒ Ñ€Ğ°ÑÑÑ‡Ğ¸Ñ‚Ğ°Ñ‚ÑŒ Ñ†ĞµĞ½Ñƒ." : "ĞĞµĞ²Ğ¾Ğ·Ğ¼Ğ¾Ğ¶Ğ½Ğ¾ Ğ²Ñ‹Ğ´Ğ°Ñ‚ÑŒ: Ñ€ĞµĞ·ĞµÑ€Ğ² ÑƒĞ¶Ğµ Ğ·Ğ°ĞºĞ¾Ğ½Ñ‡Ğ¸Ğ»ÑÑ."}</span>
                </div>
            ) : (
                <div className="text-xs text-gray-700 space-y-1.5 border-t pt-2">
                    <div className="flex justify-between">
                        <span>ĞŸĞµÑ€Ğ¸Ğ¾Ğ´ Ñ€ĞµĞ·ĞµÑ€Ğ²Ğ°:</span>
                        <span className="font-medium">{new Date(reservation.start_date).toLocaleDateString()} - {new Date(reservation.end_date).toLocaleDateString()}</span>
                    </div>
                    <div className="flex justify-between">
                        <span>Ğ¡Ñ‚Ğ¾Ğ¸Ğ¼Ğ¾ÑÑ‚ÑŒ Ñ€ĞµĞ·ĞµÑ€Ğ²Ğ°:</span>
                        <span className="font-medium">{reservation.total_cost?.toLocaleString('ru-RU')} â‚½</span>
                    </div>
                    <hr className="border-dashed my-1"/>
                    <div className="flex justify-between">
                        <span>ĞĞ¾Ğ²Ñ‹Ğ¹ Ğ¿ĞµÑ€Ğ¸Ğ¾Ğ´ Ğ°Ñ€ĞµĞ½Ğ´Ñ‹:</span>
                        <span className="font-medium">{newStartDate?.toLocaleDateString()} - {newEndDate?.toLocaleDateString()}</span>
                    </div>
                    {priceDetails && (priceDetails.discount_amount > 0) && (
                        <div className="flex justify-between text-green-600">
                            <span>Ğ¡ĞºĞ¸Ğ´ĞºĞ° ({priceDetails.duration_discount_percentage}%):</span>
                            <span className="font-medium">- {priceDetails.discount_amount.toLocaleString('ru-RU')} â‚½</span>
                        </div>
                    )}
                    <div className="flex justify-between text-base font-bold pt-1 border-t mt-1">
                        <span>Ğ˜Ñ‚Ğ¾Ğ³Ğ¾ Ğº ÑĞ¿Ğ¸ÑĞ°Ğ½Ğ¸Ñ Ñ Ğ±Ğ°Ğ»Ğ°Ğ½ÑĞ°:</span>
                        <span className="text-sky-700">{finalCost.toLocaleString('ru-RU')} â‚½</span>
                    </div>
                </div>
            )}
        </div>
    );
}

```


## <a name="srccomponentsadminReturnAccessoriesChecklisttsx"></a>`src/components/admin/ReturnAccessoriesChecklist.tsx`

```tsx
// path: src/components/admin/ReturnAccessoriesChecklist.tsx

// src/components/admin/ReturnAccessoriesChecklist.tsx

import { Label } from "@/components/ui/label";
import { Checkbox } from "@/components/ui/checkbox";
import type { AdminRentalOut } from "@/types/rental";
import type { Accessory } from "@/types/accessory";
import type { Equipment } from "@/types/equipment";

interface Props {
    rental: AdminRentalOut;
    accessoriesByEquipment: Record<number, Accessory[]>;
    checkedAccessories: Set<string>;
    handleToggleAccessory: (equipmentId: number, accessoryId: number) => void;
    totalAccessoriesCount: number;
}

export default function ReturnAccessoriesChecklist({
    rental,
    accessoriesByEquipment,
    checkedAccessories,
    handleToggleAccessory,
    totalAccessoriesCount,
}: Props) {
    if (totalAccessoriesCount === 0) {
        return null;
    }

    return (
        <div className="space-y-3 pt-3 border-t">
            <Label className="font-semibold">ĞŸĞ¾Ğ´Ñ‚Ğ²ĞµÑ€Ğ´Ğ¸Ñ‚Ğµ Ğ²Ğ¾Ğ·Ğ²Ñ€Ğ°Ñ‚ Ğ°ĞºÑĞµÑÑÑƒĞ°Ñ€Ğ¾Ğ²:</Label>
            <div className="space-y-2 max-h-48 overflow-y-auto rounded-md border p-3 bg-slate-50">
                {rental.equipment.map((eq: Equipment) => (
                    accessoriesByEquipment[eq.id] && (
                        <div key={eq.id}>
                            <p className="text-sm font-medium text-gray-700">{eq.name}</p>
                            <ul className="pl-4 mt-1 space-y-1">
                                {accessoriesByEquipment[eq.id].map((acc: Accessory) => {
                                    const key = `${eq.id}-${acc.id}`;
                                    return (
                                        <li key={key} className="flex items-center">
                                            <Checkbox
                                                id={key}
                                                checked={checkedAccessories.has(key)}
                                                onCheckedChange={() => handleToggleAccessory(eq.id, acc.id)}
                                            />
                                            <Label htmlFor={key} className="ml-2 text-sm font-normal cursor-pointer">
                                                {acc.name}
                                            </Label>
                                        </li>
                                    );
                                })}
                            </ul>
                        </div>
                    )
                ))}
            </div>
        </div>
    );
}


```


## <a name="srccomponentsadminReturnFinancialstsx"></a>`src/components/admin/ReturnFinancials.tsx`

```tsx
// path: src/components/admin/ReturnFinancials.tsx

// src/components/admin/ReturnFinancials.tsx

import { Button } from "@/components/ui/button";
import { Label } from "@/components/ui/label";
import { Input } from "@/components/ui/input";
import { Textarea } from "@/components/ui/textarea";
import type { AdminRentalOut } from "@/types/rental";

interface Props {
    rental: AdminRentalOut;
    dynamicRemainingAmount: number;
    paymentAmount: string;
    setPaymentAmount: (value: string) => void;
    paymentDescription: string;
    setPaymentDescription: (value: string) => void;
    paymentApplied: boolean;
    handleApplyPayment: () => void;
    handleCancelPayment: () => void;
    isApplyingPayment: boolean;
    handleAutoFillPayment: () => void;
    overdueSurcharge?: number;
}

export default function ReturnFinancials({
    rental,
    dynamicRemainingAmount,
    paymentAmount,
    setPaymentAmount,
    paymentDescription,
    setPaymentDescription,
    paymentApplied,
    handleApplyPayment,
    handleCancelPayment,
    isApplyingPayment,
    handleAutoFillPayment,
    overdueSurcharge,
}: Props) {
    return (
        <div className="space-y-4 pt-3 border-t">
            <Label className="font-semibold text-base">Ğ¤Ğ¸Ğ½Ğ°Ğ½ÑĞ¾Ğ²Ğ°Ñ Ğ¸Ğ½Ñ„Ğ¾Ñ€Ğ¼Ğ°Ñ†Ğ¸Ñ</Label>
            
            {/* Ğ˜Ğ½Ñ„Ğ¾Ñ€Ğ¼Ğ°Ñ†Ğ¸Ğ¾Ğ½Ğ½Ñ‹Ğµ Ğ¿Ğ¾Ğ»Ñ */}
            <div className="space-y-2 bg-slate-50 p-3 rounded-md">
                <div className="flex justify-between">
                    <span className="text-sm text-gray-600">Ğ¢ĞµĞºÑƒÑ‰Ğ¸Ğ¹ Ğ±Ğ°Ğ»Ğ°Ğ½Ñ ĞºĞ»Ğ¸ĞµĞ½Ñ‚Ğ°:</span>
                    <span className="font-medium">{(rental.user.balance || 0).toLocaleString()} â‚½</span>
                </div>
                <div className="flex justify-between">
                    <span className="text-sm text-gray-600">Ğ¡Ñ‚Ğ¾Ğ¸Ğ¼Ğ¾ÑÑ‚ÑŒ Ğ°Ñ€ĞµĞ½Ğ´Ñ‹:</span>
                    <span className="font-medium">{rental.total_cost.toLocaleString()} â‚½</span>
                </div>
                <div className="flex justify-between">
                    <span className="text-sm text-gray-600">Ğ’Ğ½ĞµÑĞµĞ½Ğ½Ğ°Ñ Ğ¿Ñ€ĞµĞ´Ğ¾Ğ¿Ğ»Ğ°Ñ‚Ğ°:</span>
                    <span className="font-medium">{rental.prepayment_amount.toLocaleString()} â‚½</span>
                </div>
                <div className="flex justify-between">
                    <span className="text-sm text-gray-600">ĞÑÑ‚Ğ°Ñ‚Ğ¾Ğº Ğº Ğ¾Ğ¿Ğ»Ğ°Ñ‚Ğµ:</span>
                    <span className={`font-medium ${dynamicRemainingAmount > 0 ? 'text-red-600' : 'text-green-600'}`}>
                        {dynamicRemainingAmount.toLocaleString()} â‚½
                    </span>
                </div>
                <div className="flex justify-between">
                    <span className="text-sm text-gray-600">Ğ’Ğ½ĞµÑĞµĞ½Ğ½Ñ‹Ğ¹ Ğ·Ğ°Ğ»Ğ¾Ğ³:</span>
                    <span className="font-medium">{rental.deposit_amount.toLocaleString()} â‚½</span>
                </div>
                {overdueSurcharge && overdueSurcharge > 0 && (
                    <div className="flex justify-between text-red-600 font-semibold pt-2 border-t border-dashed">
                        <span>Ğ¨Ñ‚Ñ€Ğ°Ñ„ Ğ·Ğ° Ğ¿Ñ€Ğ¾ÑÑ€Ğ¾Ñ‡ĞºÑƒ:</span>
                        <span>+ {overdueSurcharge.toLocaleString()} â‚½</span>
                    </div>
                )}
            </div>

            {/* ĞŸĞ¾Ğ»Ñ Ğ´Ğ»Ñ Ğ¿Ğ»Ğ°Ñ‚ĞµĞ¶Ğ° */}
            <div className="space-y-3">
                <div>
                    <div className="flex items-center justify-between mb-1">
                        <Label htmlFor="payment_amount">Ğ¡ÑƒĞ¼Ğ¼Ğ° Ğ¿Ğ»Ğ°Ñ‚ĞµĞ¶Ğ°</Label>
                        {!paymentApplied && dynamicRemainingAmount > 0 && (
                            <Button
                                type="button"
                                variant="ghost"
                                size="sm"
                                onClick={handleAutoFillPayment}
                                className="text-xs h-6 px-2"
                            >
                                Ğ—Ğ°Ğ¿Ğ¾Ğ»Ğ½Ğ¸Ñ‚ÑŒ Ğ¾ÑÑ‚Ğ°Ñ‚Ğ¾Ğº
                            </Button>
                        )}
                    </div>
                    <Input
                        id="payment_amount"
                        type="number"
                        value={paymentAmount}
                        onChange={(e) => setPaymentAmount(e.target.value)}
                        placeholder="Ğ’Ğ²ĞµĞ´Ğ¸Ñ‚Ğµ ÑÑƒĞ¼Ğ¼Ñƒ"
                        disabled={paymentApplied}
                        className={paymentApplied ? "bg-green-50 border-green-200" : ""}
                    />
                    {paymentApplied && (
                        <p className="text-xs text-green-600 mt-1 flex items-center">
                            <span className="mr-1">âœ“</span>
                            ĞŸĞ»Ğ°Ñ‚ĞµĞ¶ ÑƒÑ‡Ñ‚ĞµĞ½
                        </p>
                    )}
                </div>
                
                <div>
                    <Label htmlFor="payment_description">ĞĞ¿Ğ¸ÑĞ°Ğ½Ğ¸Ğµ Ğ¿Ğ»Ğ°Ñ‚ĞµĞ¶Ğ°</Label>
                    <Textarea
                        id="payment_description"
                        value={paymentDescription}
                        onChange={(e) => setPaymentDescription(e.target.value)}
                        placeholder="ĞĞ°Ğ¿Ñ€Ğ¸Ğ¼ĞµÑ€: Ğ§Ğ°ÑÑ‚Ğ¸Ñ‡Ğ½Ğ°Ñ Ğ¾Ğ¿Ğ»Ğ°Ñ‚Ğ° Ğ¿Ñ€Ğ¸ Ğ²Ğ¾Ğ·Ğ²Ñ€Ğ°Ñ‚Ğµ"
                        disabled={paymentApplied}
                        className={paymentApplied ? "bg-green-50 border-green-200" : ""}
                    />
                </div>

                {/* ĞšĞ½Ğ¾Ğ¿ĞºĞ¸ ÑƒĞ¿Ñ€Ğ°Ğ²Ğ»ĞµĞ½Ğ¸Ñ Ğ¿Ğ»Ğ°Ñ‚ĞµĞ¶Ğ¾Ğ¼ */}
                <div className="flex gap-2">
                    <Button
                        type="button"
                        variant="outline"
                        onClick={handleApplyPayment}
                        disabled={!paymentAmount || paymentApplied || isApplyingPayment}
                        className="flex-1"
                    >
                        {isApplyingPayment ? "ĞĞ±Ñ€Ğ°Ğ±Ğ¾Ñ‚ĞºĞ°..." : "Ğ’Ğ½ĞµÑÑ‚Ğ¸ Ğ¿Ğ»Ğ°Ñ‚ĞµĞ¶"}
                    </Button>
                    
                    {paymentApplied && (
                        <Button
                            type="button"
                            variant="destructive"
                            onClick={handleCancelPayment}
                            className="flex-1"
                        >
                            ĞÑ‚Ğ¼ĞµĞ½Ğ¸Ñ‚ÑŒ Ğ¿Ğ»Ğ°Ñ‚ĞµĞ¶
                        </Button>
                    )}
                </div>
            </div>
        </div>
    );
}


```


## <a name="srccomponentsadminReturnRentalDialogtsx"></a>`src/components/admin/ReturnRentalDialog.tsx`

```tsx
// path: src/components/admin/ReturnRentalDialog.tsx

// src/components/admin/ReturnRentalDialog.tsx

import { Dialog, DialogContent, DialogHeader, DialogTitle, DialogFooter, DialogDescription } from "@/components/ui/dialog";
import { Button } from "@/components/ui/button";
import { Label } from "@/components/ui/label";
import { Input } from "@/components/ui/input";
import { Textarea } from "@/components/ui/textarea";
import type { AdminRentalOut } from "@/types/rental";
import { useRentalReturnForm } from "@/hooks/admin/useRentalReturnForm";
import ReturnFinancials from "./ReturnFinancials";
import ReturnAccessoriesChecklist from "./ReturnAccessoriesChecklist";

interface Props {
    rental: AdminRentalOut | null;
    open: boolean;
    onClose: () => void;
}

export default function ReturnRentalDialog({ rental, open, onClose }: Props) {
    const {
        // Ğ¡Ğ¾ÑÑ‚Ğ¾ÑĞ½Ğ¸Ñ
        paymentAmount,
        setPaymentAmount,
        paymentDescription,
        setPaymentDescription,
        paymentApplied,
        checkedAccessories,
        dynamicRemainingAmount,
        
        // Ğ¤ÑƒĞ½ĞºÑ†Ğ¸Ğ¸-Ğ¾Ğ±Ñ€Ğ°Ğ±Ğ¾Ñ‚Ñ‡Ğ¸ĞºĞ¸
        handleApplyPayment,
        handleCancelPayment,
        handleToggleAccessory,
        handleAutoFillPayment,
        onSubmit,
        
        // Ğ¡Ğ¾ÑÑ‚Ğ¾ÑĞ½Ğ¸Ñ Ğ¼ÑƒÑ‚Ğ°Ñ†Ğ¸Ğ¹
        isSubmittingReturn,
        isApplyingPayment,
        
        // Ğ”Ğ°Ğ½Ğ½Ñ‹Ğµ Ñ„Ğ¾Ñ€Ğ¼Ñ‹ Ğ¾Ñ‚ react-hook-form
        register,
        handleSubmit,
        formState: { errors, isValid },
        
        // Ğ”Ñ€ÑƒĞ³Ğ¸Ğµ Ğ²Ñ‹Ñ‡Ğ¸ÑĞ»ÑĞµĞ¼Ñ‹Ğµ Ğ·Ğ½Ğ°Ñ‡ĞµĞ½Ğ¸Ñ
        accessoriesByEquipment,
        allAccessoriesChecked,
        totalAccessoriesCount,
    } = useRentalReturnForm({ rental, onClose });

    if (!rental) return null;

    return (
        <Dialog open={open} onOpenChange={onClose}>
            <DialogContent>
                <DialogHeader>
                    <DialogTitle>ĞÑ„Ğ¾Ñ€Ğ¼Ğ»ĞµĞ½Ğ¸Ğµ Ğ²Ğ¾Ğ·Ğ²Ñ€Ğ°Ñ‚Ğ° Ğ°Ñ€ĞµĞ½Ğ´Ñ‹ #{rental.id}</DialogTitle>
                    <DialogDescription>
                        ĞŸĞ¾Ğ´Ñ‚Ğ²ĞµÑ€Ğ´Ğ¸Ñ‚Ğµ Ğ²Ğ¾Ğ·Ğ²Ñ€Ğ°Ñ‚ Ğ¾Ñ‚ ĞºĞ»Ğ¸ĞµĞ½Ñ‚Ğ°: <strong>{rental.user.full_name}</strong>.
                    </DialogDescription>
                </DialogHeader>
                <form onSubmit={handleSubmit(onSubmit)} className="space-y-4 py-2">
                    <div>
                        <Label htmlFor="actual_return_date">Ğ¤Ğ°ĞºÑ‚Ğ¸Ñ‡ĞµÑĞºĞ°Ñ Ğ´Ğ°Ñ‚Ğ° Ğ²Ğ¾Ğ·Ğ²Ñ€Ğ°Ñ‚Ğ° *</Label>
                        <Input
                            id="actual_return_date"
                            type="date"
                            {...register("actual_return_date")}
                        />
                        {errors.actual_return_date && <p className="text-xs text-red-600 mt-1">{errors.actual_return_date.message}</p>}
                    </div>
                    <div>
                        <Label htmlFor="notes_on_return">Ğ—Ğ°Ğ¼ĞµÑ‚ĞºĞ¸ Ğ¿Ñ€Ğ¸ Ğ²Ğ¾Ğ·Ğ²Ñ€Ğ°Ñ‚Ğµ</Label>
                        <Textarea
                            id="notes_on_return"
                            {...register("notes_on_return")}
                            placeholder="ĞĞ°Ğ¿Ñ€Ğ¸Ğ¼ĞµÑ€: Ğ¾Ğ±Ğ¾Ñ€ÑƒĞ´Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ Ñ‡Ğ¸ÑÑ‚Ğ¾Ğµ, ĞºĞ¾Ğ¼Ğ¿Ğ»ĞµĞºÑ‚Ğ°Ñ†Ğ¸Ñ Ğ¿Ğ¾Ğ»Ğ½Ğ°Ñ..."
                        />
                    </div>

                    {/* Ğ¤Ğ¸Ğ½Ğ°Ğ½ÑĞ¾Ğ²Ñ‹Ğ¹ Ğ±Ğ»Ğ¾Ğº */}
                    <ReturnFinancials
                        rental={rental}
                        dynamicRemainingAmount={dynamicRemainingAmount}
                        paymentAmount={paymentAmount}
                        setPaymentAmount={setPaymentAmount}
                        paymentDescription={paymentDescription}
                        setPaymentDescription={setPaymentDescription}
                        paymentApplied={paymentApplied}
                        handleApplyPayment={handleApplyPayment}
                        handleCancelPayment={handleCancelPayment}
                        isApplyingPayment={isApplyingPayment}
                        handleAutoFillPayment={handleAutoFillPayment}
                        overdueSurcharge={rental.overdue_surcharge || undefined}
                    />

                    {/* Ğ¡Ğ¿Ğ¸ÑĞ¾Ğº Ğ°ĞºÑĞµÑÑÑƒĞ°Ñ€Ğ¾Ğ² */}
                    <ReturnAccessoriesChecklist
                        rental={rental}
                        accessoriesByEquipment={accessoriesByEquipment}
                        checkedAccessories={checkedAccessories}
                        handleToggleAccessory={handleToggleAccessory}
                        totalAccessoriesCount={totalAccessoriesCount}
                    />

                    <DialogFooter>
                        <Button type="button" variant="ghost" onClick={onClose}>ĞÑ‚Ğ¼ĞµĞ½Ğ°</Button>
                        <Button
                            type="submit"
                            disabled={!isValid || isSubmittingReturn || (totalAccessoriesCount > 0 && !allAccessoriesChecked)}
                        >
                            {isSubmittingReturn ? "ĞĞ±Ñ€Ğ°Ğ±Ğ¾Ñ‚ĞºĞ°..." : "ĞŸĞ¾Ğ´Ñ‚Ğ²ĞµÑ€Ğ´Ğ¸Ñ‚ÑŒ Ğ²Ğ¾Ğ·Ğ²Ñ€Ğ°Ñ‚"}
                        </Button>
                    </DialogFooter>
                </form>
            </DialogContent>
        </Dialog>
    );
}

```


## <a name="srccomponentsadminUserCreateDialogtsx"></a>`src/components/admin/UserCreateDialog.tsx`

```tsx
// path: src/components/admin/UserCreateDialog.tsx

// src/components/admin/UserCreateDialog.tsx

import { useForm, Controller } from "react-hook-form";
import { zodResolver } from "@hookform/resolvers/zod";
import { adminUserCreateFormSchema, type AdminUserCreateFormSchema } from "@/lib/validationSchemas";
import { useAdminCreateUser } from "@/hooks/useAdminUsers";
import { USER_ROLE_OPTIONS, USER_ROLES } from "@/constants/userConstants";

import { Button } from "@/components/ui/button";
import { Input } from "@/components/ui/input";
import { Label } from "@/components/ui/label";
import { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from "@/components/ui/select";
import { Dialog, DialogContent, DialogHeader, DialogTitle, DialogFooter, DialogDescription } from "@/components/ui/dialog";
import { PhoneInput } from "@/components/ui/phone-input";

interface Props {
    open: boolean;
    onClose: () => void;
}

export function UserCreateDialog({ open, onClose }: Props) {
    const createMutation = useAdminCreateUser();
    const { register, handleSubmit, formState: { errors, isValid }, reset, control } = useForm<AdminUserCreateFormSchema>({
        resolver: zodResolver(adminUserCreateFormSchema),
        mode: "onChange",
        defaultValues: {
            role: USER_ROLES.USER,
            privacyPolicyAccepted: true,
            termsAccepted: true,
            emailVerified: true,
        }
    });

    const onSubmit = (data: AdminUserCreateFormSchema) => {
        createMutation.mutate(data, {
            onSuccess: () => {
                reset();
                onClose();
            },
        });
    };

    const handleDialogClose = () => {
        reset();
        onClose();
    }

    return (
        <Dialog open={open} onOpenChange={handleDialogClose}>
            <DialogContent>
                <DialogHeader>
                    <DialogTitle>ĞĞ¾Ğ²Ñ‹Ğ¹ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ÑŒ</DialogTitle>
                    <DialogDescription>
                        Ğ¡Ğ¾Ğ·Ğ´Ğ°Ğ½Ğ¸Ğµ Ğ½Ğ¾Ğ²Ğ¾Ğ¹ ÑƒÑ‡ĞµÑ‚Ğ½Ğ¾Ğ¹ Ğ·Ğ°Ğ¿Ğ¸ÑĞ¸ Ğ¸ ÑĞ²ÑĞ·Ğ°Ğ½Ğ½Ğ¾Ğ³Ğ¾ Ğ¿Ñ€Ğ¾Ñ„Ğ¸Ğ»Ñ ĞºĞ»Ğ¸ĞµĞ½Ñ‚Ğ°.
                    </DialogDescription>
                </DialogHeader>
                <form onSubmit={handleSubmit(onSubmit)} className="space-y-4 py-2">
                    <div>
                        <Label htmlFor="create-full_name">Ğ¤Ğ˜Ğ *</Label>
                        <Input id="create-full_name" {...register("full_name")} placeholder="Ğ˜Ğ²Ğ°Ğ½ ĞŸĞµÑ‚Ñ€Ğ¾Ğ²" />
                        {errors.full_name && <p className="text-xs text-red-600 mt-1">{errors.full_name.message}</p>}
                    </div>

                    <div>
                        <Label htmlFor="create-email">Email *</Label>
                        <Input id="create-email" type="email" {...register("email")} placeholder="user@example.com" />
                        {errors.email && <p className="text-xs text-red-600 mt-1">{errors.email.message}</p>}
                    </div>

                    {/* +++ ĞĞĞ§ĞĞ›Ğ: ĞĞ¾Ğ²Ğ¾Ğµ Ğ¿Ğ¾Ğ»Ğµ Ğ´Ğ»Ñ Ñ‚ĞµĞ»ĞµÑ„Ğ¾Ğ½Ğ° +++ */}
                    <div>
                        <Label htmlFor="create-phone">Ğ¢ĞµĞ»ĞµÑ„Ğ¾Ğ½</Label>
                        <Controller
                            name="phone"
                            control={control}
                            render={({ field }) => (
                                <PhoneInput
                                    id="create-phone"
                                    placeholder="+7 (___) ___-__-__"
                                    {...field} // ĞŸĞµÑ€ĞµĞ´Ğ°ĞµĞ¼ Ğ²ÑĞµ ÑĞ²Ğ¾Ğ¹ÑÑ‚Ğ²Ğ° Ğ¿Ğ¾Ğ»Ñ (value, onChange, onBlur, ref)
                                />
                            )}
                        />
                        {errors.phone && <p className="text-xs text-red-600 mt-1">{errors.phone.message}</p>}
                    </div>
                    {/* +++ ĞšĞĞĞ•Ğ¦: ĞĞ¾Ğ²Ğ¾Ğµ Ğ¿Ğ¾Ğ»Ğµ Ğ´Ğ»Ñ Ñ‚ĞµĞ»ĞµÑ„Ğ¾Ğ½Ğ° +++ */}

                    <div>
                        <Label htmlFor="create-password">ĞŸĞ°Ñ€Ğ¾Ğ»ÑŒ *</Label>
                        <Input id="create-password" type="password" {...register("password")} placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢" />
                        {errors.password && <p className="text-xs text-red-600 mt-1">{errors.password.message}</p>}
                    </div>

                    <div>
                        <Label htmlFor="create-role">Ğ Ğ¾Ğ»ÑŒ *</Label>
                        <Controller
                            name="role"
                            control={control}
                            render={({ field }) => (
                                <Select onValueChange={field.onChange} defaultValue={field.value}>
                                    <SelectTrigger id="create-role">
                                        <SelectValue placeholder="Ğ’Ñ‹Ğ±ĞµÑ€Ğ¸Ñ‚Ğµ Ñ€Ğ¾Ğ»ÑŒ" />
                                    </SelectTrigger>
                                    <SelectContent>
                                        {USER_ROLE_OPTIONS.map(option => (
                                            <SelectItem key={option.value} value={option.value}>
                                                {option.label}
                                            </SelectItem>
                                        ))}
                                    </SelectContent>
                                </Select>
                            )}
                        />
                        {errors.role && <p className="text-xs text-red-600 mt-1">{errors.role.message}</p>}
                    </div>

                    <DialogFooter className="pt-4">
                        <Button type="button" variant="ghost" onClick={handleDialogClose}>ĞÑ‚Ğ¼ĞµĞ½Ğ°</Button>
                        <Button type="submit" disabled={!isValid || createMutation.isPending}>
                            {createMutation.isPending ? "Ğ¡Ğ¾Ğ·Ğ´Ğ°Ğ½Ğ¸Ğµ..." : "Ğ¡Ğ¾Ğ·Ğ´Ğ°Ñ‚ÑŒ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ñ"}
                        </Button>
                    </DialogFooter>
                </form>
            </DialogContent>
        </Dialog>
    );
}

```


## <a name="srccomponentsadminUserEditDialogtsx"></a>`src/components/admin/UserEditDialog.tsx`

```tsx
// path: src/components/admin/UserEditDialog.tsx

// src/components/admin/UserEditDialog.tsx

import { useEffect, useState } from "react";
import { useForm, Controller } from "react-hook-form";
import { zodResolver } from "@hookform/resolvers/zod";
import { adminUserUpdateSchema, type AdminUserUpdateSchema } from "@/lib/validationSchemas";
import { useAdminUpdateUser, useUpdateUserRole } from "@/hooks/useAdminUsers";
import { useCurrentUser } from "@/hooks/useProfile";
import { USER_ROLE_OPTIONS, USER_ROLE_LABELS } from "@/constants/userConstants";
import type { UserOut, UserRole } from "@/types/user"; // âœ… Ğ˜Ğ—ĞœĞ•ĞĞ•ĞĞ˜Ğ•: Ğ”Ğ¾Ğ±Ğ°Ğ²Ğ»ĞµĞ½ Ğ¸Ğ¼Ğ¿Ğ¾Ñ€Ñ‚ UserRole

import { Button } from "@/components/ui/button";
import { Input } from "@/components/ui/input";
import { Label } from "@/components/ui/label";
import { Textarea } from "@/components/ui/textarea";
import { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from "@/components/ui/select";
import { Dialog, DialogContent, DialogHeader, DialogTitle, DialogFooter, DialogDescription } from "@/components/ui/dialog";
import { ConfirmationDialog } from "@/components/ui/confirmation-dialog";
import { PhoneInput } from "@/components/ui/phone-input";

interface Props {
    user: UserOut | null;
    open: boolean;
    onClose: () => void;
}

const statusOptions = [
    { value: "ĞĞºÑ‚Ğ¸Ğ²Ğ½Ñ‹Ğ¹", label: "ĞĞºÑ‚Ğ¸Ğ²Ğ½Ñ‹Ğ¹" },
    { value: "Ğ¢Ñ€ĞµĞ±ÑƒĞµÑ‚ Ğ¿Ğ¾Ğ´Ñ‚Ğ²ĞµÑ€Ğ¶Ğ´ĞµĞ½Ğ¸Ñ", label: "Ğ¢Ñ€ĞµĞ±ÑƒĞµÑ‚ Ğ¿Ğ¾Ğ´Ñ‚Ğ²ĞµÑ€Ğ¶Ğ´ĞµĞ½Ğ¸Ñ" },
    { value: "Ğ—Ğ°Ğ±Ğ»Ğ¾ĞºĞ¸Ñ€Ğ¾Ğ²Ğ°Ğ½", label: "Ğ—Ğ°Ğ±Ğ»Ğ¾ĞºĞ¸Ñ€Ğ¾Ğ²Ğ°Ğ½" },
];

export function UserEditDialog({ user, open, onClose }: Props) {
    const { data: currentUser } = useCurrentUser();
    const isAdmin = currentUser?.role === 'admin';
    const updateMutation = useAdminUpdateUser();
    const updateRoleMutation = useUpdateUserRole();
    const [showRoleConfirmation, setShowRoleConfirmation] = useState(false);
    const [pendingRoleChange, setPendingRoleChange] = useState<string | null>(null);

    const { register, handleSubmit, formState: { errors, isValid, isDirty }, reset, control } = useForm<AdminUserUpdateSchema>({
        resolver: zodResolver(adminUserUpdateSchema),
        mode: "onChange",
    });

    useEffect(() => {
        if (user && open) {
            const formData = {
                full_name: user.full_name,
                phone: user.phone || "",
                status: user.status || "",
                notes: user.notes || "",
                balance: user.balance,
            };
            reset(formData);
        }
    }, [user, open, reset]); // âœ… Ğ˜Ğ—ĞœĞ•ĞĞ•ĞĞ˜Ğ•: `reset` Ğ·Ğ´ĞµÑÑŒ Ğ±ĞµĞ·Ğ¾Ğ¿Ğ°ÑĞµĞ½, Ğ¾ÑÑ‚Ğ°Ğ²Ğ»ÑĞµĞ¼ ĞµĞ³Ğ¾ Ğ´Ğ»Ñ ÑĞ±Ñ€Ğ¾ÑĞ° Ñ„Ğ¾Ñ€Ğ¼Ñ‹ Ğ¿Ñ€Ğ¸ ÑĞ¼ĞµĞ½Ğµ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ñ

    const handleRoleChange = (newRole: string) => {
        if (!user || !isAdmin || currentUser?.role !== 'admin') return;
        if (newRole !== user.role) {
            setPendingRoleChange(newRole);
            setShowRoleConfirmation(true);
        }
    };

    const confirmRoleChange = () => {
        if (!user || !pendingRoleChange || !isAdmin) return;

        // âœ… Ğ˜Ğ—ĞœĞ•ĞĞ•ĞĞ˜Ğ•: ĞŸÑ€Ğ¸Ğ²Ğ¾Ğ´Ğ¸Ğ¼ ÑÑ‚Ñ€Ğ¾ĞºÑƒ Ğº Ñ‚Ğ¸Ğ¿Ñƒ UserRole, Ñ‡Ñ‚Ğ¾Ğ±Ñ‹ Ğ¸ÑĞ¿Ñ€Ğ°Ğ²Ğ¸Ñ‚ÑŒ Ğ¾ÑˆĞ¸Ğ±ĞºÑƒ TS2322
        updateRoleMutation.mutate({ userId: user.id, newRole: pendingRoleChange as UserRole }, {
            onSuccess: () => {
                setPendingRoleChange(null);
                setShowRoleConfirmation(false);
            },
        });
    };

    const onSubmit = (data: AdminUserUpdateSchema) => {
        if (!user) return;
        updateMutation.mutate({ userId: user.id, data }, {
            onSuccess: () => {
                onClose();
            },
        });
    };

    if (!user) return null;

    return (
        <>
            <Dialog open={open} onOpenChange={onClose}>
                <DialogContent className="sm:max-w-[600px]">
                    <DialogHeader>
                        <DialogTitle>Ğ ĞµĞ´Ğ°ĞºÑ‚Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ Ğ¿Ñ€Ğ¾Ñ„Ğ¸Ğ»Ñ</DialogTitle>
                        <DialogDescription>
                            Ğ’Ñ‹ Ğ¸Ğ·Ğ¼ĞµĞ½ÑĞµÑ‚Ğµ Ğ´Ğ°Ğ½Ğ½Ñ‹Ğµ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ñ: <strong>{user.full_name}</strong>
                        </DialogDescription>
                    </DialogHeader>
                    <form onSubmit={handleSubmit(onSubmit)} className="space-y-4 py-2">
                        <div>
                            <Label htmlFor="edit-email">Email (Ğ½ĞµĞ»ÑŒĞ·Ñ Ğ¸Ğ·Ğ¼ĞµĞ½Ğ¸Ñ‚ÑŒ)</Label>
                            <Input id="edit-email" value={user.email} disabled />
                        </div>

                        <div className="grid grid-cols-1 sm:grid-cols-2 gap-4">
                            <div>
                                <Label htmlFor="edit-full_name">Ğ¤Ğ˜Ğ *</Label>
                                <Input id="edit-full_name" {...register("full_name")} />
                                {errors.full_name && <p className="text-xs text-red-600 mt-1">{errors.full_name.message}</p>}
                            </div>
                            <div>
                                <Label htmlFor="edit-phone">Ğ¢ĞµĞ»ĞµÑ„Ğ¾Ğ½</Label>
                                {/* âœ… Ğ˜Ğ—ĞœĞ•ĞĞ•ĞĞ˜Ğ•: ĞĞ±Ğ¾Ñ€Ğ°Ñ‡Ğ¸Ğ²Ğ°ĞµĞ¼ PhoneInput Ğ² Controller Ğ´Ğ»Ñ ÑÑ‚Ğ°Ğ±Ğ¸Ğ»ÑŒĞ½Ğ¾Ğ¹ Ñ€Ğ°Ğ±Ğ¾Ñ‚Ñ‹ */}
                                <Controller
                                    name="phone"
                                    control={control}
                                    render={({ field }) => (
                                        <PhoneInput id="edit-phone" {...field} />
                                    )}
                                />
                                {errors.phone && <p className="text-xs text-red-600 mt-1">{errors.phone.message}</p>}
                            </div>
                        </div>

                        <div className="grid grid-cols-1 sm:grid-cols-2 gap-4">
                            <div>
                                <Label htmlFor="edit-role">Ğ Ğ¾Ğ»ÑŒ</Label>
                                <Select
                                    onValueChange={handleRoleChange}
                                    value={user.role}
                                    disabled={!isAdmin}
                                >
                                    <SelectTrigger id="edit-role">
                                        <SelectValue />
                                    </SelectTrigger>
                                    <SelectContent>
                                        {USER_ROLE_OPTIONS.map(option => (
                                            <SelectItem key={option.value} value={option.value}>
                                                {option.label}
                                            </SelectItem>
                                        ))}
                                    </SelectContent>
                                </Select>
                                {!isAdmin && <p className="text-xs text-gray-500 mt-1">Ğ¢Ğ¾Ğ»ÑŒĞºĞ¾ Ğ°Ğ´Ğ¼Ğ¸Ğ½ Ğ¼Ğ¾Ğ¶ĞµÑ‚ Ğ¼ĞµĞ½ÑÑ‚ÑŒ Ñ€Ğ¾Ğ»ÑŒ.</p>}
                            </div>
                            <div>
                                <Label htmlFor="edit-status">Ğ¡Ñ‚Ğ°Ñ‚ÑƒÑ</Label>
                                <Controller
                                    name="status"
                                    control={control}
                                    render={({ field }) => (
                                        <Select onValueChange={field.onChange} value={field.value}>
                                            <SelectTrigger id="edit-status">
                                                <SelectValue />
                                            </SelectTrigger>
                                            <SelectContent>
                                                {statusOptions.map(option => (
                                                    <SelectItem key={option.value} value={option.value}>
                                                        {option.label}
                                                    </SelectItem>
                                                ))}
                                            </SelectContent>
                                        </Select>
                                    )}
                                />
                            </div>
                        </div>

                        <div>
                            <Label htmlFor="edit-balance">Ğ‘Ğ°Ğ»Ğ°Ğ½Ñ</Label>
                            <Input id="edit-balance" type="number" step="0.01" {...register("balance")} placeholder="0.00" />
                            {errors.balance && <p className="text-xs text-red-600 mt-1">{errors.balance.message}</p>}
                        </div>

                        <div>
                            <Label htmlFor="edit-notes">Ğ—Ğ°Ğ¼ĞµÑ‚ĞºĞ¸ (Ğ²Ğ¸Ğ´Ğ½Ñ‹ Ñ‚Ğ¾Ğ»ÑŒĞºĞ¾ Ğ¿ĞµÑ€ÑĞ¾Ğ½Ğ°Ğ»Ñƒ)</Label>
                            <Textarea id="edit-notes" {...register("notes")} placeholder="Ğ’Ğ½ÑƒÑ‚Ñ€ĞµĞ½Ğ½ÑÑ Ğ¸Ğ½Ñ„Ğ¾Ñ€Ğ¼Ğ°Ñ†Ğ¸Ñ Ğ¾ ĞºĞ»Ğ¸ĞµĞ½Ñ‚Ğµ..." />
                        </div>

                        <DialogFooter className="pt-4">
                            <Button type="button" variant="ghost" onClick={onClose}>ĞÑ‚Ğ¼ĞµĞ½Ğ°</Button>
                            <Button type="submit" disabled={!isDirty || !isValid || updateMutation.isPending}>
                                {updateMutation.isPending ? "Ğ¡Ğ¾Ñ…Ñ€Ğ°Ğ½ĞµĞ½Ğ¸Ğµ..." : "Ğ¡Ğ¾Ñ…Ñ€Ğ°Ğ½Ğ¸Ñ‚ÑŒ Ğ¸Ğ·Ğ¼ĞµĞ½ĞµĞ½Ğ¸Ñ"}
                            </Button>
                        </DialogFooter>
                    </form>
                </DialogContent>
            </Dialog>

            <ConfirmationDialog
                open={showRoleConfirmation}
                onOpenChange={setShowRoleConfirmation}
                title="ĞŸĞ¾Ğ´Ñ‚Ğ²ĞµÑ€Ğ¶Ğ´ĞµĞ½Ğ¸Ğµ Ğ¸Ğ·Ğ¼ĞµĞ½ĞµĞ½Ğ¸Ñ Ñ€Ğ¾Ğ»Ğ¸"
                description={`Ğ’Ñ‹ ÑƒĞ²ĞµÑ€ĞµĞ½Ñ‹, Ñ‡Ñ‚Ğ¾ Ñ…Ğ¾Ñ‚Ğ¸Ñ‚Ğµ Ğ¸Ğ·Ğ¼ĞµĞ½Ğ¸Ñ‚ÑŒ Ñ€Ğ¾Ğ»ÑŒ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ñ "${user?.full_name}" Ñ "${USER_ROLE_LABELS[user?.role as keyof typeof USER_ROLE_LABELS] || user?.role}" Ğ½Ğ° "${pendingRoleChange ? USER_ROLE_LABELS[pendingRoleChange as keyof typeof USER_ROLE_LABELS] || pendingRoleChange : ''}"?`}
                confirmText="Ğ˜Ğ·Ğ¼ĞµĞ½Ğ¸Ñ‚ÑŒ Ñ€Ğ¾Ğ»ÑŒ"
                cancelText="ĞÑ‚Ğ¼ĞµĞ½Ğ°"
                onConfirm={confirmRoleChange}
                variant="destructive"
            />
        </>
    );
}

```


## <a name="srccomponentsadminUserPaymentDialogtsx"></a>`src/components/admin/UserPaymentDialog.tsx`

```tsx
// path: src/components/admin/UserPaymentDialog.tsx

// src/components/admin/UserPaymentDialog.tsx

import { useForm, Controller } from "react-hook-form";
import { zodResolver } from "@hookform/resolvers/zod";
import { userPaymentSchema, type UserPaymentSchema } from "@/lib/validationSchemas";
import { useAddUserPayment } from "@/hooks/useAdminUsers";
import type { UserOut } from "@/types/user";

import { Button } from "@/components/ui/button";
import { Input } from "@/components/ui/input";
import { Label } from "@/components/ui/label";
import { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from "@/components/ui/select";
import { Textarea } from "@/components/ui/textarea";
import {
    Dialog,
    DialogContent,
    DialogHeader,
    DialogTitle,
    DialogFooter,
    DialogDescription,
} from "@/components/ui/dialog";

const PAYMENT_METHODS = ["ĞĞ°Ğ»Ğ¸Ñ‡Ğ½Ñ‹Ğµ", "ĞšĞ°Ñ€Ñ‚Ğ°", "ĞŸĞµÑ€ĞµĞ²Ğ¾Ğ´"];

interface Props {
    user: UserOut | null;
    open: boolean;
    onClose: () => void;
}

export function UserPaymentDialog({ user, open, onClose }: Props) {
    const paymentMutation = useAddUserPayment();
    const { register, handleSubmit, formState: { errors, isValid }, reset, control } = useForm<UserPaymentSchema>({
        resolver: zodResolver(userPaymentSchema),
        mode: "onChange",
    });

    const onSubmit = (data: UserPaymentSchema) => {
        if (!user) return;

        paymentMutation.mutate({ userId: user.id, data }, {
            onSuccess: () => {
                reset();
                onClose();
            },
        });
    };

    const handleDialogClose = () => {
        if (paymentMutation.isPending) return;
        reset();
        onClose();
    };

    if (!user) return null;

    // Ğ˜Ğ—ĞœĞ•ĞĞ•ĞĞ˜Ğ•: Ğ”Ğ¾Ğ±Ğ°Ğ²Ğ»ÑĞµĞ¼ ?? 0 Ğ´Ğ»Ñ Ğ±ĞµĞ·Ğ¾Ğ¿Ğ°ÑĞ½Ğ¾Ğ³Ğ¾ Ğ´Ğ¾ÑÑ‚ÑƒĞ¿Ğ° Ğº Ğ±Ğ°Ğ»Ğ°Ğ½ÑÑƒ
    const currentBalance = user.balance ?? 0;

    return (
        <Dialog open={open} onOpenChange={handleDialogClose}>
            <DialogContent>
                <DialogHeader>
                    <DialogTitle>ĞŸĞ¾Ğ¿Ğ¾Ğ»Ğ½ĞµĞ½Ğ¸Ğµ Ğ±Ğ°Ğ»Ğ°Ğ½ÑĞ°</DialogTitle>
                    <DialogDescription>
                        Ğ’Ñ‹ Ğ¿Ğ¾Ğ¿Ğ¾Ğ»Ğ½ÑĞµÑ‚Ğµ Ğ±Ğ°Ğ»Ğ°Ğ½Ñ Ğ´Ğ»Ñ <strong>{user.full_name}</strong>.
                        Ğ¢ĞµĞºÑƒÑ‰Ğ¸Ğ¹ Ğ±Ğ°Ğ»Ğ°Ğ½Ñ:
                        <span className={`font-bold ${currentBalance < 0 ? 'text-red-600' : 'text-green-700'}`}>
                            {' '}{currentBalance.toLocaleString('ru-RU')} â‚½
                        </span>
                    </DialogDescription>
                </DialogHeader>
                <form onSubmit={handleSubmit(onSubmit)} className="space-y-4 py-2">
                    <div className="grid grid-cols-2 gap-4">
                        <div>
                            <Label htmlFor="payment-amount">Ğ¡ÑƒĞ¼Ğ¼Ğ° (â‚½) *</Label>
                            <Input id="payment-amount" type="number" step="0.01" {...register("amount")} placeholder="1000" />
                            {errors.amount && <p className="text-xs text-red-600 mt-1">{errors.amount.message}</p>}
                        </div>
                        <div>
                            <Label htmlFor="payment-method">ĞœĞµÑ‚Ğ¾Ğ´ Ğ¾Ğ¿Ğ»Ğ°Ñ‚Ñ‹ *</Label>
                            <Controller
                                name="payment_method"
                                control={control}
                                render={({ field }) => (
                                    <Select onValueChange={field.onChange} defaultValue={field.value}>
                                        <SelectTrigger id="payment-method">
                                            <SelectValue placeholder="Ğ’Ñ‹Ğ±ĞµÑ€Ğ¸Ñ‚Ğµ Ğ¼ĞµÑ‚Ğ¾Ğ´" />
                                        </SelectTrigger>
                                        <SelectContent>
                                            {PAYMENT_METHODS.map(method => (
                                                <SelectItem key={method} value={method}>{method}</SelectItem>
                                            ))}
                                        </SelectContent>
                                    </Select>
                                )}
                            />
                            {errors.payment_method && <p className="text-xs text-red-600 mt-1">{errors.payment_method.message}</p>}
                        </div>
                    </div>
                    <div>
                        <Label htmlFor="payment-description">ĞĞ¿Ğ¸ÑĞ°Ğ½Ğ¸Ğµ (Ğ½ĞµĞ¾Ğ±ÑĞ·Ğ°Ñ‚ĞµĞ»ÑŒĞ½Ğ¾)</Label>
                        <Textarea id="payment-description" {...register("description")} placeholder="ĞĞ°Ğ¿Ñ€Ğ¸Ğ¼ĞµÑ€, Ğ¾Ğ¿Ğ»Ğ°Ñ‚Ğ° Ğ·Ğ°Ğ»Ğ¾Ğ³Ğ° Ğ·Ğ° Ğ°Ñ€ĞµĞ½Ğ´Ñƒ #123" />
                    </div>
                    <DialogFooter className="pt-4">
                        <Button type="button" variant="ghost" onClick={handleDialogClose} disabled={paymentMutation.isPending}>
                            ĞÑ‚Ğ¼ĞµĞ½Ğ°
                        </Button>
                        <Button type="submit" disabled={!isValid || paymentMutation.isPending}>
                            {paymentMutation.isPending ? "ĞŸĞ¾Ğ¿Ğ¾Ğ»Ğ½ĞµĞ½Ğ¸Ğµ..." : "ĞŸĞ¾Ğ¿Ğ¾Ğ»Ğ½Ğ¸Ñ‚ÑŒ Ğ±Ğ°Ğ»Ğ°Ğ½Ñ"}
                        </Button>
                    </DialogFooter>
                </form>
            </DialogContent>
        </Dialog>
    );
}

```


## <a name="srccomponentsadminUserTabletsx"></a>`src/components/admin/UserTable.tsx`

```tsx
// path: src/components/admin/UserTable.tsx

// src/components/admin/UserTable.tsx

import { useState } from "react";
import { Table, TableBody, TableCell, TableHead, TableHeader, TableRow } from "@/components/ui/table";
import { Button } from "@/components/ui/button";
import { UserSearch, Loader2 } from "lucide-react";
import { UserCreateDialog } from "./UserCreateDialog";
import { useUserTableLogic } from "@/hooks/admin/useUserTableLogic";
import { UserTableToolbar } from "./UserTableToolbar";
import { UserTableRow } from "./UserTableRow";
import { UserEditDialog } from "./UserEditDialog";
import { UserPaymentDialog } from "./UserPaymentDialog";
import type { UserOut } from "@/types/user";

interface UserTableProps {
    users: UserOut[];
    isLoading: boolean;
    error: unknown;
    onLoadMore: () => void;
    hasNextPage: boolean;
    isFetchingNextPage: boolean;
}

export default function UserTable({
    users,
    isLoading,
    error,
    onLoadMore,
    hasNextPage,
    isFetchingNextPage,
}: UserTableProps) {
    const [isCreateDialogOpen, setCreateDialogOpen] = useState(false);
    const [isEditDialogOpen, setEditDialogOpen] = useState(false);
    const [selectedUser, setSelectedUser] = useState<UserOut | null>(null);
    const [paymentUser, setPaymentUser] = useState<UserOut | null>(null);

    const {
        currentUser,
        filteredUsers,
        isAdmin,
        searchQuery,
        setSearchQuery,
        confirmDelete,
        mutations,
        handlers,
    } = useUserTableLogic(users);

    const handleEdit = (user: UserOut) => {
        setSelectedUser(user);
        setEditDialogOpen(true);
    };

    const handleAddPayment = (user: UserOut) => {
        setPaymentUser(user);
    };

    if (isLoading) {
        return <div className="text-center py-8">Ğ—Ğ°Ğ³Ñ€ÑƒĞ·ĞºĞ° Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ĞµĞ¹...</div>;
    }

    if (error) {
        return <div className="text-center py-8 text-red-600">ĞÑˆĞ¸Ğ±ĞºĞ° Ğ·Ğ°Ğ³Ñ€ÑƒĞ·ĞºĞ¸ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ĞµĞ¹</div>;
    }

    return (
        <>
            <div className="space-y-4">
                <UserTableToolbar
                    searchQuery={searchQuery}
                    onSearchChange={setSearchQuery}
                    onAddUser={() => setCreateDialogOpen(true)}
                    filteredUserCount={filteredUsers.length}
                    isAdmin={isAdmin}
                />

                <div className="rounded-md border">
                    <Table>
                        <TableHeader>
                            <TableRow>
                                <TableHead>ĞŸĞ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ÑŒ</TableHead>
                                <TableHead>Email</TableHead>
                                <TableHead>Ğ Ğ¾Ğ»ÑŒ</TableHead>
                                <TableHead>Ğ¡Ñ‚Ğ°Ñ‚ÑƒÑ</TableHead>
                                <TableHead>Ğ”Ğ°Ñ‚Ğ° Ñ€ĞµĞ³Ğ¸ÑÑ‚Ñ€Ğ°Ñ†Ğ¸Ğ¸</TableHead>
                                {isAdmin && <TableHead className="text-right">Ğ”ĞµĞ¹ÑÑ‚Ğ²Ğ¸Ñ</TableHead>}
                            </TableRow>
                        </TableHeader>
                        <TableBody>
                            {filteredUsers.length > 0 ? (
                                filteredUsers.map((user) => (
                                    <UserTableRow
                                        key={user.id}
                                        user={user}
                                        currentUser={currentUser}
                                        isAdmin={isAdmin}
                                        confirmDeleteId={confirmDelete}
                                        handlers={handlers}
                                        mutations={mutations}
                                        onEdit={handleEdit}
                                        onAddPayment={handleAddPayment}
                                    />
                                ))
                            ) : (
                                <TableRow>
                                    <TableCell colSpan={isAdmin ? 6 : 5} className="h-24 text-center">
                                        <div className="flex flex-col items-center justify-center text-center p-4">
                                            <UserSearch className="w-16 h-16 text-gray-300 mb-3" />
                                            <h3 className="text-lg font-semibold text-gray-700">ĞŸĞ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ğ¸ Ğ½Ğµ Ğ½Ğ°Ğ¹Ğ´ĞµĞ½Ñ‹</h3>
                                            <p className="text-sm text-gray-500 max-w-sm">
                                                {searchQuery
                                                    ? "ĞŸĞ¾Ğ¿Ñ€Ğ¾Ğ±ÑƒĞ¹Ñ‚Ğµ Ğ¸Ğ·Ğ¼ĞµĞ½Ğ¸Ñ‚ÑŒ Ğ¿Ğ¾Ğ¸ÑĞºĞ¾Ğ²Ñ‹Ğ¹ Ğ·Ğ°Ğ¿Ñ€Ğ¾Ñ."
                                                    : "Ğ’ ÑĞ¸ÑÑ‚ĞµĞ¼Ğµ Ğ¿Ğ¾ĞºĞ° Ğ½ĞµÑ‚ Ğ·Ğ°Ñ€ĞµĞ³Ğ¸ÑÑ‚Ñ€Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ½Ñ‹Ñ… Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ĞµĞ¹."}
                                            </p>
                                        </div>
                                    </TableCell>
                                </TableRow>
                            )}
                        </TableBody>
                    </Table>
                </div>

                {/* ĞšĞ½Ğ¾Ğ¿ĞºĞ° Load More */}
                {hasNextPage && (
                    <div className="flex justify-center mt-6">
                        <Button
                            onClick={onLoadMore}
                            disabled={isFetchingNextPage}
                            variant="outline"
                            className="min-w-[120px]"
                        >
                            {isFetchingNextPage ? (
                                <>
                                    <Loader2 className="w-4 h-4 mr-2 animate-spin" />
                                    Ğ—Ğ°Ğ³Ñ€ÑƒĞ·ĞºĞ°...
                                </>
                            ) : (
                                "Ğ—Ğ°Ğ³Ñ€ÑƒĞ·Ğ¸Ñ‚ÑŒ ĞµÑ‰Ğµ"
                            )}
                        </Button>
                    </div>
                )}

                {!isAdmin && (
                    <div className="bg-blue-50 border border-blue-200 rounded-lg p-4 text-sm text-blue-800">
                        <strong>Ğ ĞµĞ¶Ğ¸Ğ¼ Ğ¼ĞµĞ½ĞµĞ´Ğ¶ĞµÑ€Ğ°:</strong> Ğ’Ñ‹ Ğ¼Ğ¾Ğ¶ĞµÑ‚Ğµ Ğ¿Ñ€Ğ¾ÑĞ¼Ğ°Ñ‚Ñ€Ğ¸Ğ²Ğ°Ñ‚ÑŒ ÑĞ¿Ğ¸ÑĞ¾Ğº Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ĞµĞ¹, Ğ½Ğ¾ Ğ½Ğµ Ğ¼Ğ¾Ğ¶ĞµÑ‚Ğµ Ğ¸Ñ… Ğ¸Ğ·Ğ¼ĞµĞ½ÑÑ‚ÑŒ, Ğ±Ğ»Ğ¾ĞºĞ¸Ñ€Ğ¾Ğ²Ğ°Ñ‚ÑŒ Ğ¸Ğ»Ğ¸ ÑƒĞ´Ğ°Ğ»ÑÑ‚ÑŒ.
                    </div>
                )}
            </div>

            <UserCreateDialog open={isCreateDialogOpen} onClose={() => setCreateDialogOpen(false)} />

            <UserEditDialog
                user={selectedUser}
                open={isEditDialogOpen}
                onClose={() => {
                    setEditDialogOpen(false);
                    setSelectedUser(null);
                }}
            />

            <UserPaymentDialog
                user={paymentUser}
                open={!!paymentUser}
                onClose={() => setPaymentUser(null)}
            />
        </>
    );
}

```


## <a name="srccomponentsadminUserTableRowtsx"></a>`src/components/admin/UserTableRow.tsx`

```tsx
// path: src/components/admin/UserTableRow.tsx

// src/components/admin/UserTableRow.tsx

import type { UserOut } from "@/types/user";
import { TableCell, TableRow } from "@/components/ui/table";
import { Badge } from "@/components/ui/badge";
import { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from "@/components/ui/select";
import { Button } from "@/components/ui/button";
import { Shield, ShieldCheck, UserCheck, UserX, Trash2, Pencil, DollarSign } from "lucide-react";
import type { useUserTableLogic } from "@/hooks/admin/useUserTableLogic";
import { USER_ROLE_LABELS, USER_ROLE_BADGE_VARIANTS, USER_ROLE_OPTIONS } from "@/constants/userConstants";
import { formatDateEuropean } from "@/lib/utils";

type Handlers = ReturnType<typeof useUserTableLogic>['handlers'];
type Mutations = ReturnType<typeof useUserTableLogic>['mutations'];

interface Props {
    user: UserOut;
    currentUser: UserOut | null | undefined;
    isAdmin: boolean;
    confirmDeleteId: number | null;
    handlers: Handlers;
    mutations: Mutations;
    onEdit: (user: UserOut) => void;
    onAddPayment: (user: UserOut) => void;
}

export function UserTableRow({ user, currentUser, isAdmin, confirmDeleteId, handlers, mutations, onEdit, onAddPayment }: Props) {
    return (
        <TableRow key={user.id}>
            <TableCell className="font-medium">
                <div className="flex items-center gap-2">
                    {user.role === "admin" && <ShieldCheck className="w-4 h-4 text-red-500" />}
                    {user.role === "manager" && <Shield className="w-4 h-4 text-blue-500" />}
                    {user.full_name}
                    {user.id === currentUser?.id && <Badge variant="outline" className="text-xs">Ğ­Ñ‚Ğ¾ Ğ²Ñ‹</Badge>}
                </div>
            </TableCell>
            <TableCell>{user.email}</TableCell>
            <TableCell>
                {isAdmin && user.id !== currentUser?.id ? (
                    <Select value={user.role} onValueChange={(value) => handlers.handleRoleChange(user.id, value)}>
                        <SelectTrigger className="w-32"><SelectValue /></SelectTrigger>
                        <SelectContent>
                            {USER_ROLE_OPTIONS.map(option => (
                                <SelectItem key={option.value} value={option.value}>
                                    {option.label}
                                </SelectItem>
                            ))}
                        </SelectContent>
                    </Select>
                ) : (
                    <Badge variant={USER_ROLE_BADGE_VARIANTS[user.role]}>
                        {USER_ROLE_LABELS[user.role]}
                    </Badge>
                )}
            </TableCell>
            <TableCell>
                <Badge variant={user.is_active ? "default" : "secondary"}>{user.is_active ? "ĞĞºÑ‚Ğ¸Ğ²ĞµĞ½" : "Ğ—Ğ°Ğ±Ğ»Ğ¾ĞºĞ¸Ñ€Ğ¾Ğ²Ğ°Ğ½"}</Badge>
            </TableCell>
            <TableCell className="text-sm text-gray-600">
                {formatDateEuropean(user.created_at)}
            </TableCell>
            {isAdmin && (
                <TableCell className="text-right">
                    <div className="flex items-center justify-end gap-2">
                        {user.id !== currentUser?.id ? (
                            <>
                                <Button variant="outline" size="icon" onClick={() => onAddPayment(user)} className="h-8 w-8 text-green-600 border-green-300 hover:bg-green-50 hover:text-green-700">
                                    <DollarSign className="w-4 h-4" />
                                </Button>
                                <Button variant="outline" size="icon" onClick={() => onEdit(user)} className="h-8 w-8">
                                    <Pencil className="w-4 h-4" />
                                </Button>
                                <Button variant="outline" size="sm" onClick={() => handlers.handleToggleBlock(user)} disabled={mutations.blockUser.isPending || mutations.unblockUser.isPending}>
                                    {user.is_active ? <UserX className="w-4 h-4" /> : <UserCheck className="w-4 h-4" />}
                                </Button>
                                <Button variant={confirmDeleteId === user.id ? "destructive" : "outline"} size="sm" onClick={() => handlers.handleDelete(user.id)} disabled={mutations.deleteUser.isPending}>
                                    <Trash2 className="w-4 h-4" />
                                    {confirmDeleteId === user.id && <span className="ml-1 text-xs">ĞŸĞ¾Ğ´Ñ‚Ğ²ĞµÑ€Ğ´Ğ¸Ñ‚ÑŒ</span>}
                                </Button>
                            </>
                        ) : (
                            <Button variant="outline" size="icon" onClick={() => onAddPayment(user)} className="h-8 w-8 text-green-600 border-green-300 hover:bg-green-50 hover:text-green-700">
                                <DollarSign className="w-4 h-4" />
                            </Button>
                        )}
                    </div>
                </TableCell>
            )}
        </TableRow>
    );
}

```


## <a name="srccomponentsadminUserTableToolbartsx"></a>`src/components/admin/UserTableToolbar.tsx`

```tsx
// path: src/components/admin/UserTableToolbar.tsx

// src/components/admin/UserTableToolbar.tsx
import { Input } from "@/components/ui/input";
import { Button } from "@/components/ui/button";
import { Search, Plus } from "lucide-react";

interface Props {
    searchQuery: string;
    onSearchChange: (query: string) => void;
    onAddUser: () => void;
    filteredUserCount: number;
    isAdmin: boolean;
}

export function UserTableToolbar({
                                     searchQuery,
                                     onSearchChange,
                                     onAddUser,
                                     filteredUserCount,
                                     isAdmin
                                 }: Props) {
    return (
        <div className="flex flex-col sm:flex-row gap-4 items-center justify-between">
            <div className="relative flex-grow max-w-sm w-full">
                <Search className="absolute left-3 top-1/2 -translate-y-1/2 text-gray-400 w-4 h-4" />
                <Input
                    placeholder="ĞŸĞ¾Ğ¸ÑĞº Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ĞµĞ¹..."
                    value={searchQuery}
                    onChange={(e) => onSearchChange(e.target.value)}
                    className="pl-10"
                />
            </div>
            <div className="flex items-center gap-4">
                <p className="text-sm text-gray-600">
                    ĞĞ°Ğ¹Ğ´ĞµĞ½Ğ¾: {filteredUserCount}
                </p>
                {isAdmin && (
                    <Button size="sm" onClick={onAddUser}>
                        <Plus className="w-4 h-4 mr-2" />
                        Ğ”Ğ¾Ğ±Ğ°Ğ²Ğ¸Ñ‚ÑŒ
                    </Button>
                )}
            </div>
        </div>
    );
}

```


## <a name="srccomponentsadmindashboardActivityFeedWidgettsx"></a>`src/components/admin/dashboard/ActivityFeedWidget.tsx`

```tsx
// path: src/components/admin/dashboard/ActivityFeedWidget.tsx

// src/components/admin/dashboard/ActivityFeedWidget.tsx

import { Card, CardContent, CardHeader, CardTitle } from "@/components/ui/card";
import { Skeleton } from "@/components/ui/skeleton";
import { Badge } from "@/components/ui/badge";
import { 
    Activity,
    Plus,
    X,
    Play,
    CheckCircle,
    UserPlus,
    Package,
    Calendar
} from "lucide-react";
import { formatDistanceToNow } from "date-fns";
import { ru } from "date-fns/locale";
import type { ActivityFeedItem } from "@/hooks/admin/useDashboardData";

interface ActivityFeedWidgetProps {
    data: ActivityFeedItem[];
    isLoading: boolean;
}

export default function ActivityFeedWidget({ data, isLoading }: ActivityFeedWidgetProps) {
    const getActivityIcon = (type: ActivityFeedItem['type']) => {
        switch (type) {
            case 'reservation_created':
                return <Calendar className="w-4 h-4 text-blue-600" />;
            case 'reservation_cancelled':
                return <X className="w-4 h-4 text-red-600" />;
            case 'rental_started':
                return <Play className="w-4 h-4 text-green-600" />;
            case 'rental_completed':
                return <CheckCircle className="w-4 h-4 text-green-600" />;
            case 'user_registered':
                return <UserPlus className="w-4 h-4 text-purple-600" />;
            case 'equipment_added':
                return <Package className="w-4 h-4 text-orange-600" />;
            default:
                return <Activity className="w-4 h-4 text-gray-600" />;
        }
    };

    const getActivityColor = (type: ActivityFeedItem['type']) => {
        switch (type) {
            case 'reservation_created':
                return 'bg-blue-50 border-blue-200';
            case 'reservation_cancelled':
                return 'bg-red-50 border-red-200';
            case 'rental_started':
                return 'bg-green-50 border-green-200';
            case 'rental_completed':
                return 'bg-green-50 border-green-200';
            case 'user_registered':
                return 'bg-purple-50 border-purple-200';
            case 'equipment_added':
                return 'bg-orange-50 border-orange-200';
            default:
                return 'bg-gray-50 border-gray-200';
        }
    };

    const getActivityBadgeVariant = (type: ActivityFeedItem['type']) => {
        switch (type) {
            case 'reservation_created':
                return 'default' as const;
            case 'reservation_cancelled':
                return 'destructive' as const;
            case 'rental_started':
                return 'secondary' as const;
            case 'rental_completed':
                return 'secondary' as const;
            case 'user_registered':
                return 'outline' as const;
            case 'equipment_added':
                return 'outline' as const;
            default:
                return 'outline' as const;
        }
    };

    const getActivityTypeLabel = (type: ActivityFeedItem['type']) => {
        switch (type) {
            case 'reservation_created':
                return 'Ğ ĞµĞ·ĞµÑ€Ğ² ÑĞ¾Ğ·Ğ´Ğ°Ğ½';
            case 'reservation_cancelled':
                return 'Ğ ĞµĞ·ĞµÑ€Ğ² Ğ¾Ñ‚Ğ¼ĞµĞ½ĞµĞ½';
            case 'rental_started':
                return 'ĞÑ€ĞµĞ½Ğ´Ğ° Ğ½Ğ°Ñ‡Ğ°Ñ‚Ğ°';
            case 'rental_completed':
                return 'ĞÑ€ĞµĞ½Ğ´Ğ° Ğ·Ğ°Ğ²ĞµÑ€ÑˆĞµĞ½Ğ°';
            case 'user_registered':
                return 'ĞŸĞ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ÑŒ Ğ·Ğ°Ñ€ĞµĞ³Ğ¸ÑÑ‚Ñ€Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½';
            case 'equipment_added':
                return 'ĞĞ±Ğ¾Ñ€ÑƒĞ´Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ Ğ´Ğ¾Ğ±Ğ°Ğ²Ğ»ĞµĞ½Ğ¾';
            default:
                return 'Ğ¡Ğ¾Ğ±Ñ‹Ñ‚Ğ¸Ğµ';
        }
    };

    if (isLoading) {
        return (
            <Card>
                <CardHeader>
                    <CardTitle className="flex items-center gap-2">
                        <Activity className="w-5 h-5" />
                        Ğ›ĞµĞ½Ñ‚Ğ° Ğ°ĞºÑ‚Ğ¸Ğ²Ğ½Ğ¾ÑÑ‚Ğ¸
                    </CardTitle>
                </CardHeader>
                <CardContent className="space-y-4">
                    {Array.from({ length: 5 }).map((_, index) => (
                        <div key={index} className="flex items-start gap-3 p-3 border rounded-lg">
                            <Skeleton className="w-8 h-8 rounded-full" />
                            <div className="flex-1 space-y-2">
                                <Skeleton className="h-4 w-3/4" />
                                <Skeleton className="h-3 w-1/2" />
                            </div>
                            <Skeleton className="h-6 w-16" />
                        </div>
                    ))}
                </CardContent>
            </Card>
        );
    }

    return (
        <Card>
            <CardHeader>
                <CardTitle className="flex items-center gap-2">
                    <Activity className="w-5 h-5" />
                    Ğ›ĞµĞ½Ñ‚Ğ° Ğ°ĞºÑ‚Ğ¸Ğ²Ğ½Ğ¾ÑÑ‚Ğ¸
                </CardTitle>
            </CardHeader>
            <CardContent>
                <div className="space-y-3">
                    {data.length > 0 ? (
                        data.map((activity) => (
                            <div 
                                key={activity.id}
                                className={`flex items-start gap-3 p-3 border rounded-lg ${getActivityColor(activity.type)}`}
                            >
                                <div className="flex-shrink-0 mt-0.5">
                                    {getActivityIcon(activity.type)}
                                </div>
                                <div className="flex-1 min-w-0">
                                    <p className="text-sm font-medium text-gray-900 mb-1">
                                        {activity.description}
                                    </p>
                                    <div className="flex items-center gap-2 text-xs text-gray-500">
                                        <span>
                                            {formatDistanceToNow(new Date(activity.timestamp), { 
                                                addSuffix: true, 
                                                locale: ru 
                                            })}
                                        </span>
                                        {activity.user_name && (
                                            <>
                                                <span>â€¢</span>
                                                <span>{activity.user_name}</span>
                                            </>
                                        )}
                                        {activity.equipment_name && (
                                            <>
                                                <span>â€¢</span>
                                                <span>{activity.equipment_name}</span>
                                            </>
                                        )}
                                    </div>
                                </div>
                                <div className="flex-shrink-0">
                                    <Badge 
                                        variant={getActivityBadgeVariant(activity.type)}
                                        className="text-xs"
                                    >
                                        {getActivityTypeLabel(activity.type)}
                                    </Badge>
                                </div>
                            </div>
                        ))
                    ) : (
                        <div className="text-center py-8 text-sm text-gray-500">
                            <Activity className="w-8 h-8 mx-auto mb-2 text-gray-400" />
                            <p>ĞĞµÑ‚ Ğ°ĞºÑ‚Ğ¸Ğ²Ğ½Ğ¾ÑÑ‚Ğ¸</p>
                            <p className="text-xs">Ğ¡Ğ¾Ğ±Ñ‹Ñ‚Ğ¸Ñ Ğ¿Ğ¾ÑĞ²ÑÑ‚ÑÑ Ğ·Ğ´ĞµÑÑŒ Ğ¿Ğ¾ Ğ¼ĞµÑ€Ğµ Ğ¸Ñ… Ğ²Ğ¾Ğ·Ğ½Ğ¸ĞºĞ½Ğ¾Ğ²ĞµĞ½Ğ¸Ñ</p>
                        </div>
                    )}
                </div>
            </CardContent>
        </Card>
    );
}


```


## <a name="srccomponentsadmindashboardKpiCardsWidgettsx"></a>`src/components/admin/dashboard/KpiCardsWidget.tsx`

```tsx
// path: src/components/admin/dashboard/KpiCardsWidget.tsx

// src/components/admin/dashboard/KpiCardsWidget.tsx

import { Card, CardContent, CardHeader, CardTitle } from "@/components/ui/card";
import { Skeleton } from "@/components/ui/skeleton";
import { 
    Users, 
    UserCheck, 
    Package, 
    Calendar,
    DollarSign,
    TrendingUp,
    BarChart3,
    Clock
} from "lucide-react";
import type { DashboardSummary } from "@/hooks/admin/useDashboardData";

interface KpiCardsWidgetProps {
    data: DashboardSummary['kpi'];
    isLoading: boolean;
}

export default function KpiCardsWidget({ data, isLoading }: KpiCardsWidgetProps) {
    if (isLoading) {
        return (
            <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                {Array.from({ length: 8 }).map((_, index) => (
                    <Card key={index}>
                        <CardHeader className="flex flex-row items-center justify-between space-y-0 pb-2">
                            <Skeleton className="h-4 w-20" />
                            <Skeleton className="h-4 w-4" />
                        </CardHeader>
                        <CardContent>
                            <Skeleton className="h-8 w-16 mb-1" />
                            <Skeleton className="h-3 w-24" />
                        </CardContent>
                    </Card>
                ))}
            </div>
        );
    }

    const kpiCards = [
        {
            title: "Ğ’ÑĞµĞ³Ğ¾ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ĞµĞ¹",
            value: data.total_users.toLocaleString(),
            description: `${data.active_users} Ğ°ĞºÑ‚Ğ¸Ğ²Ğ½Ñ‹Ñ…`,
            icon: <Users className="h-4 w-4 text-muted-foreground" />,
            trend: data.active_users > 0 ? "positive" : "neutral"
        },
        {
            title: "ĞĞºÑ‚Ğ¸Ğ²Ğ½Ñ‹Ğµ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ğ¸",
            value: data.active_users.toLocaleString(),
            description: `${Math.round((data.active_users / data.total_users) * 100)}% Ğ¾Ñ‚ Ğ¾Ğ±Ñ‰ĞµĞ³Ğ¾ Ñ‡Ğ¸ÑĞ»Ğ°`,
            icon: <UserCheck className="h-4 w-4 text-muted-foreground" />,
            trend: "positive"
        },
        {
            title: "Ğ’ÑĞµĞ³Ğ¾ Ğ¾Ğ±Ğ¾Ñ€ÑƒĞ´Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ",
            value: data.total_equipment.toLocaleString(),
            description: "Ğ•Ğ´Ğ¸Ğ½Ğ¸Ñ† Ğ² ĞºĞ°Ñ‚Ğ°Ğ»Ğ¾Ğ³Ğµ",
            icon: <Package className="h-4 w-4 text-muted-foreground" />,
            trend: "neutral"
        },
        {
            title: "Ğ’ÑĞµĞ³Ğ¾ Ñ€ĞµĞ·ĞµÑ€Ğ²Ğ¾Ğ²",
            value: data.total_reservations.toLocaleString(),
            description: "Ğ—Ğ° Ğ²ÑĞµ Ğ²Ñ€ĞµĞ¼Ñ",
            icon: <Calendar className="h-4 w-4 text-muted-foreground" />,
            trend: "positive"
        },
        {
            title: "Ğ’Ñ‹Ñ€ÑƒÑ‡ĞºĞ° ÑĞµĞ³Ğ¾Ğ´Ğ½Ñ",
            value: `${data.revenue_today.toLocaleString()} â‚½`,
            description: "Ğ—Ğ° Ñ‚ĞµĞºÑƒÑ‰Ğ¸Ğ¹ Ğ´ĞµĞ½ÑŒ",
            icon: <DollarSign className="h-4 w-4 text-muted-foreground" />,
            trend: data.revenue_today > 0 ? "positive" : "neutral"
        },
        {
            title: "Ğ’Ñ‹Ñ€ÑƒÑ‡ĞºĞ° Ğ·Ğ° Ğ¼ĞµÑÑÑ†",
            value: `${data.revenue_this_month.toLocaleString()} â‚½`,
            description: "Ğ—Ğ° Ñ‚ĞµĞºÑƒÑ‰Ğ¸Ğ¹ Ğ¼ĞµÑÑÑ†",
            icon: <TrendingUp className="h-4 w-4 text-muted-foreground" />,
            trend: "positive"
        },
        {
            title: "Ğ—Ğ°Ğ³Ñ€ÑƒĞ¶ĞµĞ½Ğ½Ğ¾ÑÑ‚ÑŒ",
            value: `${data.occupancy_rate.toFixed(1)}%`,
            description: "Ğ¡Ñ€ĞµĞ´Ğ½ÑÑ Ğ·Ğ°Ğ³Ñ€ÑƒĞ¶ĞµĞ½Ğ½Ğ¾ÑÑ‚ÑŒ",
            icon: <BarChart3 className="h-4 w-4 text-muted-foreground" />,
            trend: data.occupancy_rate > 70 ? "positive" : data.occupancy_rate > 40 ? "neutral" : "negative"
        },
        {
            title: "Ğ¡Ñ€ĞµĞ´Ğ½ÑÑ Ğ´Ğ»Ğ¸Ñ‚ĞµĞ»ÑŒĞ½Ğ¾ÑÑ‚ÑŒ",
            value: `${data.avg_rental_duration.toFixed(1)} Ğ´Ğ½.`,
            description: "ĞÑ€ĞµĞ½Ğ´Ñ‹",
            icon: <Clock className="h-4 w-4 text-muted-foreground" />,
            trend: "neutral"
        }
    ];

    const getTrendColor = (trend: string) => {
        switch (trend) {
            case "positive":
                return "text-green-600";
            case "negative":
                return "text-red-600";
            default:
                return "text-gray-600";
        }
    };

    return (
        <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
            {kpiCards.map((card, index) => (
                <Card key={index} className="hover:shadow-md transition-shadow">
                    <CardHeader className="flex flex-row items-center justify-between space-y-0 pb-2">
                        <CardTitle className="text-sm font-medium">{card.title}</CardTitle>
                        {card.icon}
                    </CardHeader>
                    <CardContent>
                        <div className={`text-2xl font-bold ${getTrendColor(card.trend)}`}>
                            {card.value}
                        </div>
                        <p className="text-xs text-muted-foreground">
                            {card.description}
                        </p>
                    </CardContent>
                </Card>
            ))}
        </div>
    );
}


```


## <a name="srccomponentsadmindashboardPopularEquipmentCharttsx"></a>`src/components/admin/dashboard/PopularEquipmentChart.tsx`

```tsx
// path: src/components/admin/dashboard/PopularEquipmentChart.tsx

// src/components/admin/dashboard/PopularEquipmentChart.tsx

import { Card, CardContent, CardHeader, CardTitle } from "@/components/ui/card";
import { Skeleton } from "@/components/ui/skeleton";
import { Badge } from "@/components/ui/badge";
import { BarChart3, TrendingUp, Package } from "lucide-react";
import type { PopularEquipmentItem } from "@/hooks/admin/useDashboardData";
import { formatNumber } from "@/lib/utils";

interface PopularEquipmentChartProps {
    data: PopularEquipmentItem[];
    isLoading: boolean;
}

export default function PopularEquipmentChart({ data, isLoading }: PopularEquipmentChartProps) {
    if (isLoading) {
        return (
            <Card>
                <CardHeader>
                    <CardTitle className="flex items-center gap-2">
                        <BarChart3 className="w-5 h-5" />
                        ĞŸĞ¾Ğ¿ÑƒĞ»ÑÑ€Ğ½Ğ¾Ğµ Ğ¾Ğ±Ğ¾Ñ€ÑƒĞ´Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ
                    </CardTitle>
                </CardHeader>
                <CardContent className="space-y-4">
                    {Array.from({ length: 5 }).map((_, index) => (
                        <div key={index} className="space-y-2">
                            <div className="flex justify-between items-center">
                                <Skeleton className="h-4 w-32" />
                                <Skeleton className="h-4 w-16" />
                            </div>
                            <Skeleton className="h-6 w-full" />
                        </div>
                    ))}
                </CardContent>
            </Card>
        );
    }

    if (data.length === 0) {
        return (
            <Card>
                <CardHeader>
                    <CardTitle className="flex items-center gap-2">
                        <BarChart3 className="w-5 h-5" />
                        ĞŸĞ¾Ğ¿ÑƒĞ»ÑÑ€Ğ½Ğ¾Ğµ Ğ¾Ğ±Ğ¾Ñ€ÑƒĞ´Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ
                    </CardTitle>
                </CardHeader>
                <CardContent>
                    <div className="text-center py-8 text-sm text-gray-500">
                        <BarChart3 className="w-8 h-8 mx-auto mb-2 text-gray-400" />
                        <p>ĞĞµÑ‚ Ğ´Ğ°Ğ½Ğ½Ñ‹Ñ… Ğ´Ğ»Ñ Ğ¿Ğ¾ÑÑ‚Ñ€Ğ¾ĞµĞ½Ğ¸Ñ Ğ³Ñ€Ğ°Ñ„Ğ¸ĞºĞ°</p>
                        <p className="text-xs">Ğ”Ğ°Ğ½Ğ½Ñ‹Ğµ Ğ¿Ğ¾ÑĞ²ÑÑ‚ÑÑ Ğ¿Ğ¾ÑĞ»Ğµ Ğ¿ĞµÑ€Ğ²Ñ‹Ñ… Ğ°Ñ€ĞµĞ½Ğ´</p>
                    </div>
                </CardContent>
            </Card>
        );
    }

    // Ğ¡Ğ¾Ñ€Ñ‚Ğ¸Ñ€ÑƒĞµĞ¼ Ğ´Ğ°Ğ½Ğ½Ñ‹Ğµ Ğ¿Ğ¾ ĞºĞ¾Ğ»Ğ¸Ñ‡ĞµÑÑ‚Ğ²Ñƒ Ğ°Ñ€ĞµĞ½Ğ´ (Ğ¿Ğ¾ ÑƒĞ±Ñ‹Ğ²Ğ°Ğ½Ğ¸Ñ)
    const sortedData = [...data].sort((a, b) => (b.rental_count || 0) - (a.rental_count || 0));
    
    // Ğ‘ĞµÑ€ĞµĞ¼ Ñ‚Ğ¾Ğ¿-10 Ğ´Ğ»Ñ Ğ¾Ñ‚Ğ¾Ğ±Ñ€Ğ°Ğ¶ĞµĞ½Ğ¸Ñ
    const topData = sortedData.slice(0, 10);
    
    // Ğ”Ğ¾Ğ±Ğ°Ğ²Ğ»ÑĞµĞ¼ fallback ID Ğ´Ğ»Ñ ÑĞ»ĞµĞ¼ĞµĞ½Ñ‚Ğ¾Ğ² Ğ±ĞµĞ· equipment_id
    const dataWithIds = topData.map((item, index) => ({
        ...item,
        equipment_id: item.equipment_id || `fallback-${index}`
    }));
    
    
    // ĞĞ°Ñ…Ğ¾Ğ´Ğ¸Ğ¼ Ğ¼Ğ°ĞºÑĞ¸Ğ¼Ğ°Ğ»ÑŒĞ½Ğ¾Ğµ Ğ·Ğ½Ğ°Ñ‡ĞµĞ½Ğ¸Ğµ Ğ´Ğ»Ñ Ğ½Ğ¾Ñ€Ğ¼Ğ°Ğ»Ğ¸Ğ·Ğ°Ñ†Ğ¸Ğ¸
    const maxRentals = topData.length > 0 ? Math.max(...topData.map(item => item.rental_count || 0)) : 0;


    const totalRentals = data.reduce((sum, item) => sum + (item.rental_count || 0), 0);
    const totalRevenue = data.reduce((sum, item) => sum + (item.revenue || 0), 0);

    return (
        <Card>
            <CardHeader>
                <CardTitle className="flex items-center gap-2">
                    <BarChart3 className="w-5 h-5" />
                    ĞŸĞ¾Ğ¿ÑƒĞ»ÑÑ€Ğ½Ğ¾Ğµ Ğ¾Ğ±Ğ¾Ñ€ÑƒĞ´Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ
                </CardTitle>
            </CardHeader>
            <CardContent className="space-y-6">
                {/* Ğ¡Ğ²Ğ¾Ğ´Ğ½Ğ°Ñ ÑÑ‚Ğ°Ñ‚Ğ¸ÑÑ‚Ğ¸ĞºĞ° */}
                <div className="grid grid-cols-2 gap-4 p-4 bg-gray-50 rounded-lg">
                    <div className="text-center">
                        <div className="flex items-center justify-center gap-1 mb-1">
                            <Package className="w-4 h-4 text-blue-600" />
                            <span className="text-sm font-medium text-gray-600">Ğ’ÑĞµĞ³Ğ¾ Ğ°Ñ€ĞµĞ½Ğ´</span>
                        </div>
                        <div className="text-2xl font-bold text-gray-900">
                            {formatNumber(totalRentals, "0")}
                        </div>
                    </div>
                    <div className="text-center">
                        <div className="flex items-center justify-center gap-1 mb-1">
                            <TrendingUp className="w-4 h-4 text-green-600" />
                            <span className="text-sm font-medium text-gray-600">Ğ’Ñ‹Ñ€ÑƒÑ‡ĞºĞ°</span>
                        </div>
                        <div className="text-2xl font-bold text-gray-900">
                            {formatNumber(totalRevenue, "0")} â‚½
                        </div>
                    </div>
                </div>

                {/* Ğ“Ñ€Ğ°Ñ„Ğ¸Ğº */}
                <div className="space-y-4">
                    {dataWithIds.map((item, index) => (
                        <div key={item.equipment_id} className="space-y-2">
                            <div className="flex justify-between items-center">
                                <div className="flex items-center gap-2">
                                    <span className="text-sm font-medium text-gray-900 truncate max-w-[200px]">
                                        {item.equipment_name}
                                    </span>
                                    {index < 3 && (
                                        <Badge 
                                            variant={index === 0 ? "default" : "secondary"}
                                            className="text-xs"
                                        >
                                            #{index + 1}
                                        </Badge>
                                    )}
                                </div>
                                <div className="text-right">
                                    <div className="text-sm font-semibold text-gray-900">
                                        {formatNumber(item.rental_count, "0")}
                                    </div>
                                    <div className="text-xs text-gray-500">
                                        {formatNumber(item.revenue, "0")} â‚½
                                    </div>
                                </div>
                            </div>
                            <div className="relative">
                                <div className="w-full bg-gray-200 rounded-full h-6 overflow-hidden">
                                    <div 
                                        className={`h-full transition-all duration-500 ease-out ${
                                            index === 0 
                                                ? 'bg-gradient-to-r from-blue-500 to-blue-600' 
                                                : index === 1 
                                                ? 'bg-gradient-to-r from-green-500 to-green-600'
                                                : index === 2
                                                ? 'bg-gradient-to-r from-yellow-500 to-yellow-600'
                                                : 'bg-gradient-to-r from-gray-400 to-gray-500'
                                        }`}
                                        style={{ width: `${maxRentals > 0 ? ((item.rental_count || 0) / maxRentals) * 100 : 0}%` }}
                                    />
                                </div>
                                <div className="absolute inset-0 flex items-center justify-center">
                                    <span className="text-xs font-medium text-white mix-blend-difference">
                                        {maxRentals > 0 ? (((item.rental_count || 0) / maxRentals) * 100).toFixed(1) : 0}%
                                    </span>
                                </div>
                            </div>
                        </div>
                    ))}
                </div>

                {/* Ğ”Ğ¾Ğ¿Ğ¾Ğ»Ğ½Ğ¸Ñ‚ĞµĞ»ÑŒĞ½Ğ°Ñ Ğ¸Ğ½Ñ„Ğ¾Ñ€Ğ¼Ğ°Ñ†Ğ¸Ñ */}
                {data.length > 10 && (
                    <div className="text-center text-sm text-gray-500 pt-2 border-t">
                        ĞŸĞ¾ĞºĞ°Ğ·Ğ°Ğ½Ñ‹ Ñ‚Ğ¾Ğ¿-10 Ğ¸Ğ· {data.length} Ğ¿Ğ¾Ğ·Ğ¸Ñ†Ğ¸Ğ¹
                    </div>
                )}
            </CardContent>
        </Card>
    );
}


```


## <a name="srccomponentsadmindashboardTodayFocusWidgettsx"></a>`src/components/admin/dashboard/TodayFocusWidget.tsx`

```tsx
// path: src/components/admin/dashboard/TodayFocusWidget.tsx

// src/components/admin/dashboard/TodayFocusWidget.tsx

import { useNavigate } from "react-router-dom";
import { Card, CardContent, CardHeader, CardTitle } from "@/components/ui/card";
import { Badge } from "@/components/ui/badge";
import { Skeleton } from "@/components/ui/skeleton";
import { 
    Package, 
    ArrowUpCircle, 
    ArrowDownCircle, 
    AlertTriangle,
    Clock,
    User
} from "lucide-react";
import { differenceInDays } from "date-fns";
import { calculateDaysOverdue } from "@/lib/utils";
import { sortPickupsByPriority, sortOverdueRentalsByDays, getTodayDate } from "@/lib/sortingUtils";
import type { PickupReturnItem, OverdueRentalItem } from "@/hooks/admin/useDashboardData";

interface TodayFocusWidgetProps {
    data: {
        pickups_today: PickupReturnItem[];
        returns_today: PickupReturnItem[];
        overdue_rentals: OverdueRentalItem[];
    };
    isLoading: boolean;
}

export default function TodayFocusWidget({ data, isLoading }: TodayFocusWidgetProps) {
    const navigate = useNavigate();
    
    // ĞŸĞ¾Ğ»ÑƒÑ‡Ğ°ĞµĞ¼ ÑĞµĞ³Ğ¾Ğ´Ğ½ÑÑˆĞ½ÑÑ Ğ´Ğ°Ñ‚Ñƒ Ñ Ğ¾Ğ±Ğ½ÑƒĞ»ĞµĞ½Ğ½Ñ‹Ğ¼ Ğ²Ñ€ĞµĞ¼ĞµĞ½ĞµĞ¼ Ğ´Ğ»Ñ ĞºĞ¾Ñ€Ñ€ĞµĞºÑ‚Ğ½Ğ¾Ğ³Ğ¾ ÑÑ€Ğ°Ğ²Ğ½ĞµĞ½Ğ¸Ñ
    const today = getTodayDate();

    const handlePickupClick = (item: PickupReturnItem) => {
        navigate('/admin/reservations', {
            state: {
                highlightId: item.id,
                statusFilterOverride: 'active' // ĞŸĞ¾ĞºĞ°Ğ·Ñ‹Ğ²Ğ°ĞµĞ¼ Ğ°ĞºÑ‚Ğ¸Ğ²Ğ½Ñ‹Ğµ, Ñ‡Ñ‚Ğ¾Ğ±Ñ‹ Ğ½Ğ°Ğ¹Ñ‚Ğ¸ Ğ½ÑƒĞ¶Ğ½Ñ‹Ğ¹
            }
        });
    };

    const handleReturnClick = (item: PickupReturnItem) => {
        navigate('/admin/rentals', {
            state: {
                highlightId: item.id,
                statusFilterOverride: 'active'
            }
        });
    };

    const handleOverdueClick = (item: OverdueRentalItem) => {
        navigate('/admin/rentals', {
            state: {
                highlightId: item.id,
                statusFilterOverride: 'overdue'
            }
        });
    };

    if (isLoading) {
        return (
            <Card>
                <CardHeader>
                    <CardTitle className="flex items-center gap-2">
                        <Package className="w-5 h-5" />
                        Ğ¤Ğ¾ĞºÑƒÑ Ğ½Ğ° ÑĞµĞ³Ğ¾Ğ´Ğ½Ñ
                    </CardTitle>
                </CardHeader>
                <CardContent className="space-y-4">
                    <div className="space-y-2">
                        <Skeleton className="h-4 w-24" />
                        <Skeleton className="h-16 w-full" />
                    </div>
                    <div className="space-y-2">
                        <Skeleton className="h-4 w-24" />
                        <Skeleton className="h-16 w-full" />
                    </div>
                    <div className="space-y-2">
                        <Skeleton className="h-4 w-24" />
                        <Skeleton className="h-16 w-full" />
                    </div>
                </CardContent>
            </Card>
        );
    }

    const renderPickupItem = (item: PickupReturnItem) => {
        // ĞĞ¿Ñ€ĞµĞ´ĞµĞ»ÑĞµĞ¼, ÑĞ²Ğ»ÑĞµÑ‚ÑÑ Ğ»Ğ¸ Ğ²Ñ‹Ğ´Ğ°Ñ‡Ğ° "Ğ¾Ğ¶Ğ¸Ğ´Ğ°ÑÑ‰ĞµĞ¹"
        const itemStartDate = item.start_date ? new Date(item.start_date) : null;
        const isPendingPickup = itemStartDate && itemStartDate < today;
        const daysPassed = itemStartDate ? differenceInDays(today, itemStartDate) : 0;

        // ĞĞ¿Ñ€ĞµĞ´ĞµĞ»ÑĞµĞ¼ ĞºĞ»Ğ°ÑÑÑ‹ Ğ¸ Ñ‚ĞµĞºÑÑ‚ Ğ½Ğ° Ğ¾ÑĞ½Ğ¾Ğ²Ğµ ÑÑ‚Ğ°Ñ‚ÑƒÑĞ°
        const bgColor = isPendingPickup ? "bg-cyan-50 hover:bg-cyan-100" : "bg-blue-50 hover:bg-blue-100";
        const iconColor = isPendingPickup ? "text-cyan-600" : "text-blue-600";
        const badgeText = isPendingPickup ? `Ğš Ğ²Ñ‹Ğ´Ğ°Ñ‡Ğµ (-${daysPassed} Ğ´Ğ½.)` : "Ğ’Ñ‹Ğ´Ğ°Ñ‡Ğ° ÑĞµĞ³Ğ¾Ğ´Ğ½Ñ";
        const badgeVariant = isPendingPickup ? "outline" : "secondary";

        return (
            <div 
                key={item.id}
                className={`flex items-center justify-between p-3 rounded-lg cursor-pointer ${bgColor} transition-colors`}
                onClick={() => handlePickupClick(item)}
            >
                <div className="flex-1 min-w-0">
                    <div className="flex items-center gap-2 mb-1">
                        <User className={`w-4 h-4 ${iconColor} flex-shrink-0`} />
                        <span className="font-medium text-sm truncate">{item.user_name}</span>
                    </div>
                    <div className="flex items-center gap-2 text-xs text-gray-600">
                        <Package className="w-3 h-3 flex-shrink-0" />
                        <span className="truncate">{item.equipment_name}</span>
                    </div>
                </div>
                <div className="text-right ml-2">
                    <div className="flex items-center justify-end gap-1 text-xs text-gray-500 mb-1">
                        <Clock className="w-3 h-3" />
                        <span>{item.scheduled_time ? new Date(item.scheduled_time).toLocaleDateString('ru-RU') : 'ĞĞµ ÑƒĞºĞ°Ğ·Ğ°Ğ½Ğ¾'}</span>
                    </div>
                    <Badge variant={badgeVariant} className="text-xs">
                        {badgeText}
                    </Badge>
                </div>
            </div>
        );
    };

    const renderReturnItem = (item: PickupReturnItem) => (
        <div 
            key={item.id}
            className="flex items-center justify-between p-3 bg-green-50 rounded-lg cursor-pointer hover:bg-green-100 transition-colors"
            onClick={() => handleReturnClick(item)}
        >
            <div className="flex-1 min-w-0">
                <div className="flex items-center gap-2 mb-1">
                    <User className="w-4 h-4 text-green-600 flex-shrink-0" />
                    <span className="font-medium text-sm truncate">{item.user_name}</span>
                </div>
                <div className="flex items-center gap-2 text-xs text-gray-600">
                    <Package className="w-3 h-3 flex-shrink-0" />
                    <span className="truncate">{item.equipment_name}</span>
                </div>
            </div>
            <div className="text-right ml-2">
                <div className="flex items-center justify-end gap-1 text-xs text-gray-500 mb-1">
                    <Clock className="w-3 h-3" />
                    <span>{item.scheduled_time ? new Date(item.scheduled_time).toLocaleDateString('ru-RU') : 'ĞĞµ ÑƒĞºĞ°Ğ·Ğ°Ğ½Ğ¾'}</span>
                </div>
                <Badge variant="secondary" className="text-xs">
                    {item.status}
                </Badge>
            </div>
        </div>
    );

    const renderOverdueItem = (item: OverdueRentalItem) => {
        // Ğ˜ÑĞ¿Ğ¾Ğ»ÑŒĞ·ÑƒĞµĞ¼ ÑƒÑ‚Ğ¸Ğ»Ğ¸Ñ‚Ğ°Ñ€Ğ½ÑƒÑ Ñ„ÑƒĞ½ĞºÑ†Ğ¸Ñ Ğ´Ğ»Ñ Ğ²Ñ‹Ñ‡Ğ¸ÑĞ»ĞµĞ½Ğ¸Ñ Ğ´Ğ½ĞµĞ¹ Ğ¿Ñ€Ğ¾ÑÑ€Ğ¾Ñ‡ĞºĞ¸
        const daysOverdue = calculateDaysOverdue(item.due_date, item.days_overdue);

        return (
            <div 
                key={item.id}
                className="flex items-center justify-between p-3 bg-red-50 rounded-lg cursor-pointer hover:bg-red-100 transition-colors"
                onClick={() => handleOverdueClick(item)}
            >
                <div className="flex-1 min-w-0">
                    <div className="flex items-center gap-2 mb-1">
                        <User className="w-4 h-4 text-red-600 flex-shrink-0" />
                        <span className="font-medium text-sm truncate">{item.user_name}</span>
                    </div>
                    <div className="flex items-center gap-2 text-xs text-gray-600">
                        <Package className="w-3 h-3 flex-shrink-0" />
                        <span className="truncate">{item.equipment_name}</span>
                    </div>
                </div>
                <div className="text-right ml-2">
                    <div className="flex items-center justify-end gap-1 text-xs text-red-600 mb-1">
                        <AlertTriangle className="w-3 h-3" />
                        <span>
                            {daysOverdue > 0 ? `${daysOverdue} Ğ´Ğ½.` : 'ĞŸÑ€Ğ¾ÑÑ€Ğ¾Ñ‡ĞµĞ½Ğ¾'}
                        </span>
                    </div>
                    <Badge variant="destructive" className="text-xs">
                        ĞŸÑ€Ğ¾ÑÑ€Ğ¾Ñ‡ĞµĞ½Ğ¾
                    </Badge>
                </div>
            </div>
        );
    };

    return (
        <Card>
            <CardHeader>
                <CardTitle className="flex items-center gap-2">
                    <Package className="w-5 h-5" />
                    Ğ¤Ğ¾ĞºÑƒÑ Ğ½Ğ° ÑĞµĞ³Ğ¾Ğ´Ğ½Ñ
                </CardTitle>
            </CardHeader>
            <CardContent className="space-y-6">
                {/* Ğ’Ñ‹Ğ´Ğ°Ñ‡Ğ¸ ÑĞµĞ³Ğ¾Ğ´Ğ½Ñ */}
                <div>
                    <div className="flex items-center gap-2 mb-3">
                        <ArrowUpCircle className="w-4 h-4 text-blue-600" />
                        <h3 className="font-medium text-sm">Ğ’Ñ‹Ğ´Ğ°Ñ‡Ğ¸ ÑĞµĞ³Ğ¾Ğ´Ğ½Ñ</h3>
                        <Badge variant="outline" className="text-xs">
                            {data.pickups_today.length}
                        </Badge>
                    </div>
                    <div className="space-y-2">
                        {data.pickups_today.length > 0 ? (
                            sortPickupsByPriority(data.pickups_today, today).map(renderPickupItem)
                        ) : (
                            <div className="text-center py-4 text-sm text-gray-500">
                                Ğ¡ĞµĞ³Ğ¾Ğ´Ğ½Ñ Ğ½ĞµÑ‚ Ğ²Ñ‹Ğ´Ğ°Ñ‡
                            </div>
                        )}
                    </div>
                </div>

                {/* Ğ’Ğ¾Ğ·Ğ²Ñ€Ğ°Ñ‚Ñ‹ ÑĞµĞ³Ğ¾Ğ´Ğ½Ñ */}
                <div>
                    <div className="flex items-center gap-2 mb-3">
                        <ArrowDownCircle className="w-4 h-4 text-green-600" />
                        <h3 className="font-medium text-sm">Ğ’Ğ¾Ğ·Ğ²Ñ€Ğ°Ñ‚Ñ‹ ÑĞµĞ³Ğ¾Ğ´Ğ½Ñ</h3>
                        <Badge variant="outline" className="text-xs">
                            {data.returns_today.length}
                        </Badge>
                    </div>
                    <div className="space-y-2">
                        {data.returns_today.length > 0 ? (
                            data.returns_today.map(renderReturnItem)
                        ) : (
                            <div className="text-center py-4 text-sm text-gray-500">
                                Ğ¡ĞµĞ³Ğ¾Ğ´Ğ½Ñ Ğ½ĞµÑ‚ Ğ²Ğ¾Ğ·Ğ²Ñ€Ğ°Ñ‚Ğ¾Ğ²
                            </div>
                        )}
                    </div>
                </div>

                {/* ĞŸÑ€Ğ¾ÑÑ€Ğ¾Ñ‡ĞµĞ½Ğ½Ñ‹Ğµ Ğ°Ñ€ĞµĞ½Ğ´Ñ‹ */}
                <div>
                    <div className="flex items-center gap-2 mb-3">
                        <AlertTriangle className="w-4 h-4 text-red-600" />
                        <h3 className="font-medium text-sm">ĞŸÑ€Ğ¾ÑÑ€Ğ¾Ñ‡ĞµĞ½Ğ½Ñ‹Ğµ Ğ°Ñ€ĞµĞ½Ğ´Ñ‹</h3>
                        <Badge variant="outline" className="text-xs">
                            {data.overdue_rentals.length}
                        </Badge>
                    </div>
                    <div className="space-y-2">
                        {data.overdue_rentals.length > 0 ? (
                            sortOverdueRentalsByDays(data.overdue_rentals).map(renderOverdueItem)
                        ) : (
                            <div className="text-center py-4 text-sm text-gray-500">
                                ĞĞµÑ‚ Ğ¿Ñ€Ğ¾ÑÑ€Ğ¾Ñ‡ĞµĞ½Ğ½Ñ‹Ñ… Ğ°Ñ€ĞµĞ½Ğ´
                            </div>
                        )}
                    </div>
                </div>
            </CardContent>
        </Card>
    );
}


```


## <a name="srccomponentscalendarCalendarDateInputRangetsx"></a>`src/components/calendar/CalendarDateInputRange.tsx`

```tsx
// path: src/components/calendar/CalendarDateInputRange.tsx

// src/components/calendar/CalendarDateInputRange.tsx

import { useDateStore } from "@/store/dateStore";
import { useDateRange } from "@/hooks/useDateRange";

export default function CalendarDateInputRange() {
    // âœ… Ğ˜Ğ¡ĞŸĞ ĞĞ’Ğ›Ğ•ĞĞ: ĞŸĞ¾Ğ»ÑƒÑ‡Ğ°ĞµĞ¼ Ğ°ĞºÑ‚ÑƒĞ°Ğ»ÑŒĞ½Ñ‹Ğµ startDate, endDate Ğ¸ setRange Ğ¸Ğ· Ñ…Ñ€Ğ°Ğ½Ğ¸Ğ»Ğ¸Ñ‰Ğ°
    const { startDate, endDate, setRange } = useDateStore();

    const {
        localStartDate,
        localEndDate,
        handleStartDateChange,
        handleEndDateChange
    } = useDateRange({
        // âœ… Ğ˜Ğ¡ĞŸĞ ĞĞ’Ğ›Ğ•ĞĞ: ĞŸĞµÑ€ĞµĞ´Ğ°Ñ‘Ğ¼ Ğ°ĞºÑ‚ÑƒĞ°Ğ»ÑŒĞ½Ñ‹Ğµ Ğ´Ğ°Ñ‚Ñ‹ Ğ² Ñ…ÑƒĞº
        startDate,
        endDate,
        onRangeChange: (start, end, source) => setRange(start, end, source)
    });

    return (
        <div className="flex items-center gap-2" role="group" aria-labelledby="date-range-label">
            <span id="date-range-label" className="sr-only">Ğ’Ñ‹Ğ±Ğ¾Ñ€ Ğ´Ğ¸Ğ°Ğ¿Ğ°Ğ·Ğ¾Ğ½Ğ° Ğ´Ğ°Ñ‚ ĞºĞ°Ğ»ĞµĞ½Ğ´Ğ°Ñ€Ñ</span>
            <label htmlFor="calendar-start-date" className="text-sm text-gray-700 shrink-0">
                Ğ¡:
            </label>
            <input
                id="calendar-start-date"
                type="date"
                value={localStartDate}
                onChange={handleStartDateChange}
                className="border border-gray-300 rounded px-2 py-1.5 text-sm focus:ring-2 focus:ring-sky-500 focus:border-sky-500"
                aria-label="Ğ”Ğ°Ñ‚Ğ° Ğ½Ğ°Ñ‡Ğ°Ğ»Ğ° Ğ´Ğ»Ñ ĞºĞ°Ğ»ĞµĞ½Ğ´Ğ°Ñ€Ñ"
            />

            <label htmlFor="calendar-end-date" className="text-sm text-gray-700 shrink-0">
                ĞŸĞ¾:
            </label>
            <input
                id="calendar-end-date"
                type="date"
                value={localEndDate}
                onChange={handleEndDateChange}
                className="border border-gray-300 rounded px-2 py-1.5 text-sm focus:ring-2 focus:ring-sky-500 focus:border-sky-500"
                aria-label="Ğ”Ğ°Ñ‚Ğ° Ğ¾ĞºĞ¾Ğ½Ñ‡Ğ°Ğ½Ğ¸Ñ Ğ´Ğ»Ñ ĞºĞ°Ğ»ĞµĞ½Ğ´Ğ°Ñ€Ñ"
                min={localStartDate}
            />
        </div>
    );
}

```


## <a name="srccomponentscalendarCalendarFiltersBlocktsx"></a>`src/components/calendar/CalendarFiltersBlock.tsx`

```tsx
// path: src/components/calendar/CalendarFiltersBlock.tsx

// src/components/calendar/CalendarFiltersBlock.tsx
import CalendarDateInputRange from "@/components/calendar/CalendarDateInputRange";
import { Button } from "@/components/ui/button";
import { FilterX } from "lucide-react";
import type { Equipment } from "@/types/equipment";

type Props = {
    equipment: Equipment[];
    typeFilter: string | null;
    setTypeFilter: (v: string | null) => void;
    brandFilter: string | null;
    setBrandFilter: (v: string | null) => void;
    searchText: string;
    setSearchText: (v: string) => void;
    onReset: () => void;
};

export default function CalendarFiltersBlock({
                                                 equipment,
                                                 typeFilter,
                                                 setTypeFilter,
                                                 brandFilter,
                                                 setBrandFilter,
                                                 searchText,
                                                 setSearchText,
                                                 onReset,
                                             }: Props) {
    const types = Array.from(new Set(equipment.map((e) => e.equipment_type)));
    const brands = Array.from(new Set(equipment.map((e) => e.brand)));

    return (
        <div className="flex flex-col gap-4 mb-5 p-4 bg-gray-50 border border-gray-200 rounded-lg shadow-sm print:hidden">
            <div className="flex flex-col md:flex-row md:items-end md:justify-between gap-2">
                <div className="flex flex-col gap-2">
                    <input
                        type="text"
                        placeholder="ĞŸĞ¾Ğ¸ÑĞº Ğ¿Ğ¾ Ğ½Ğ°Ğ·Ğ²Ğ°Ğ½Ğ¸Ñ..."
                        value={searchText}
                        onChange={(e) => setSearchText(e.target.value)}
                        className="border px-3 py-1 rounded-md text-sm w-[250px]"
                    />
                    <CalendarDateInputRange />
                </div>
                <Button
                    variant="ghost"
                    onClick={onReset}
                    className="text-gray-600 hover:text-sky-700"
                >
                    <FilterX className="w-4 h-4 mr-1" />
                    Ğ¡Ğ±Ñ€Ğ¾ÑĞ¸Ñ‚ÑŒ
                </Button>
            </div>

            <div className="flex flex-wrap items-center gap-2">
                <span className="text-sm text-gray-600 mr-2">Ğ¢Ğ¸Ğ¿:</span>
                <Button
                    variant="filter"
                    data-state={typeFilter === null ? "on" : "off"}
                    onClick={() => setTypeFilter(null)}
                >
                    Ğ’ÑĞµ
                </Button>
                {types.map((type) => (
                    <Button
                        key={type}
                        variant="filter"
                        data-state={typeFilter === type ? "on" : "off"}
                        onClick={() => setTypeFilter(type)}
                    >
                        {type}
                    </Button>
                ))}
            </div>

            <div className="flex flex-wrap items-center gap-2">
                <span className="text-sm text-gray-600 mr-2">Ğ‘Ñ€ĞµĞ½Ğ´:</span>
                <Button
                    variant="filter"
                    data-state={brandFilter === null ? "on" : "off"}
                    onClick={() => setBrandFilter(null)}
                >
                    Ğ’ÑĞµ
                </Button>
                {brands.map((brand) => (
                    <Button
                        key={brand}
                        variant="filter"
                        data-state={brandFilter === brand ? "on" : "off"}
                        onClick={() => setBrandFilter(brand)}
                    >
                        {brand}
                    </Button>
                ))}
            </div>
        </div>
    );
}


```


## <a name="srccomponentscalendarCalendarTabletsx"></a>`src/components/calendar/CalendarTable.tsx`

```tsx
// path: src/components/calendar/CalendarTable.tsx

// src/components/calendar/CalendarTable.tsx
import { useCalendarGrid } from "@/hooks/useCalendarGrid";
import { format } from "date-fns";
import { useDateStore } from "@/store/dateStore";
import { useCalendarSelectionStore } from "@/store/calendarSelectionStore";
// import { useCurrentUser } from "@/hooks/useProfile"; // ĞĞµ Ğ¸ÑĞ¿Ğ¾Ğ»ÑŒĞ·ÑƒĞµÑ‚ÑÑ Ğ½Ğ°Ğ¿Ñ€ÑĞ¼ÑƒÑ Ğ´Ğ»Ñ ÑÑ‚Ğ¸Ğ»Ğ¸Ğ·Ğ°Ñ†Ğ¸Ğ¸
import type { DayStatus, EquipmentStatus } from "@/types/availability";

type Equipment = {
    id: number;
    name: string;
    brand: string;
    equipment_type: string;
};

function getDateRange(start: Date, end: Date): Date[] {
    const days = [];
    let d = new Date(start);
    while (d <= end) {
        days.push(new Date(d));
        d.setDate(d.getDate() + 1);
    }
    return days;
}

function formatDateToDayMonthYear(date: Date): string {
    return format(date, "dd.MM.yyyy");
}

const cellBgMap: Record<string, string> = {
    available: "bg-emerald-50",
    reserved: "bg-amber-300",  // Ğ§ÑƒĞ¶Ğ¸Ğµ Ñ€ĞµĞ·ĞµÑ€Ğ²Ñ‹
    rented: "bg-rose-400",     // Ğ§ÑƒĞ¶Ğ¸Ğµ Ğ°Ñ€ĞµĞ½Ğ´Ñ‹
};

const userCellBgMap: Record<string, string> = {
    available: "bg-emerald-50", // Ğ¡Ğ²Ğ¾Ğ±Ğ¾Ğ´Ğ½Ñ‹Ğµ ÑÑ‡ĞµĞ¹ĞºĞ¸ Ğ¾Ğ´Ğ¸Ğ½Ğ°ĞºĞ¾Ğ²Ñ‹ Ğ´Ğ»Ñ Ğ²ÑĞµÑ…
    reserved: "bg-amber-500",  // Ğ¡Ğ’ĞĞ™ Ñ€ĞµĞ·ĞµÑ€Ğ² - Ñ‚ĞµĞ¼Ğ½ĞµĞµ
    rented: "bg-rose-600",     // Ğ¡Ğ’ĞĞ¯ Ğ°Ñ€ĞµĞ½Ğ´Ğ° (ĞµÑĞ»Ğ¸ Ğ¿Ñ€Ğ¸Ğ¼ĞµĞ½Ğ¸Ğ¼Ğ¾ Ğ¸ Ğ½ÑƒĞ¶Ğ½Ğ¾ Ğ¾Ñ‚Ğ»Ğ¸Ñ‡Ğ°Ñ‚ÑŒ) - Ñ‚ĞµĞ¼Ğ½ĞµĞµ
};

export default function CalendarTable({ equipment }: { equipment: Equipment[] }) {
    const { startDate, endDate } = useDateStore();
    const { data: calendarDataFromHook, isLoading, isError, refetch } = useCalendarGrid();
    const { selectedGroupId, setSelectedGroupId } = useCalendarSelectionStore();

    if (!startDate || !endDate) return null;
    if (isLoading) return <div className="p-6 text-center">Ğ—Ğ°Ğ³Ñ€ÑƒĞ·ĞºĞ°...</div>;
    if (isError)
        return (
            <div className="p-6 text-center text-red-700">
                ĞÑˆĞ¸Ğ±ĞºĞ° Ğ·Ğ°Ğ³Ñ€ÑƒĞ·ĞºĞ¸ <button onClick={() => refetch()} className="underline hover:text-red-800">ĞŸĞ¾Ğ²Ñ‚Ğ¾Ñ€Ğ¸Ñ‚ÑŒ</button>
            </div>
        );
    if (!equipment.length || !calendarDataFromHook || Object.keys(calendarDataFromHook).length === 0)
        return <div className="p-6 text-center text-gray-500">ĞĞµÑ‚ Ğ´Ğ°Ğ½Ğ½Ñ‹Ñ… Ğ´Ğ»Ñ Ğ²Ñ‹Ğ±Ñ€Ğ°Ğ½Ğ½Ñ‹Ñ… Ñ„Ğ¸Ğ»ÑŒÑ‚Ñ€Ğ¾Ğ²</div>;

    const dateRange = getDateRange(startDate, endDate);
    const todayStr = formatDateToDayMonthYear(new Date());

    return (
        <div
            className="overflow-x-auto rounded-xl border bg-white shadow"
            onClick={() => setSelectedGroupId(null)} // ÑĞ±Ñ€Ğ¾Ñ Ğ²Ñ‹Ğ´ĞµĞ»ĞµĞ½Ğ¸Ñ Ğ¿Ñ€Ğ¸ ĞºĞ»Ğ¸ĞºĞµ Ğ²Ğ½Ğµ ÑÑ‡ĞµĞµĞº
        >
            <table className="min-w-max table-auto border-collapse">
                <thead>
                <tr>
                    <th
                        className="sticky left-0 z-20 bg-white border-b px-4 py-2 text-sm font-semibold min-w-[220px]"
                        style={{ boxShadow: "2px 0 6px -2px #e0e7ef" }}
                    >
                        ĞĞ±Ğ¾Ñ€ÑƒĞ´Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ
                    </th>
                    {dateRange.map((date) => {
                        const dateStr = formatDateToDayMonthYear(date);
                        const isToday = dateStr === todayStr;

                        return (
                            <th
                                key={dateStr}
                                className={`sticky top-0 z-10 border-b px-2 py-1 text-xs font-medium min-w-[90px] truncate ${
                                    isToday
                                        ? "bg-sky-100 text-sky-800 border-sky-400 border-b-2 today-column"
                                        : "bg-white"
                                }`}
                            >
                                {dateStr}
                            </th>
                        );
                    })}
                </tr>
                </thead>
                <tbody>
                {equipment.map((item) => (
                    <tr key={item.id}>
                        <td className="sticky left-0 bg-white border-r px-3 py-1 z-10 min-w-[220px] text-xs text-gray-800 truncate">
                            {item.equipment_type} {item.brand} {item.name}
                        </td>
                        {dateRange.map((date) => {
                            const dateStr = formatDateToDayMonthYear(date);

                            const cellItemData = calendarDataFromHook[item.id]?.[dateStr];

                            let cell: DayStatus | undefined;

                            // Ğ‘ÑĞºĞµĞ½Ğ´ Ñ‚ĞµĞ¿ĞµÑ€ÑŒ Ğ²ÑĞµĞ³Ğ´Ğ° Ğ´Ğ¾Ğ»Ğ¶ĞµĞ½ Ğ²Ğ¾Ğ·Ğ²Ñ€Ğ°Ñ‰Ğ°Ñ‚ÑŒ Ğ¾Ğ±ÑŠĞµĞºÑ‚ DayStatusItem (ĞºĞ¾Ñ‚Ğ¾Ñ€Ñ‹Ğ¹ ÑĞ¾Ğ¾Ñ‚Ğ²ĞµÑ‚ÑÑ‚Ğ²ÑƒĞµÑ‚ DayStatus Ğ½Ğ° Ñ„Ñ€Ğ¾Ğ½Ñ‚Ğµ)
                            if (typeof cellItemData === 'object' && cellItemData !== null && 'status' in cellItemData) {
                                cell = cellItemData as DayStatus;
                            } else if (typeof cellItemData === 'string') {
                                // Ğ­Ñ‚Ğ¾Ñ‚ Ğ±Ğ»Ğ¾Ğº Ğ´Ğ»Ñ Ğ¾Ğ±Ñ€Ğ°Ñ‚Ğ½Ğ¾Ğ¹ ÑĞ¾Ğ²Ğ¼ĞµÑÑ‚Ğ¸Ğ¼Ğ¾ÑÑ‚Ğ¸, ĞµÑĞ»Ğ¸ Ğ±ÑĞºĞµĞ½Ğ´ Ğ’Ğ”Ğ Ğ£Ğ“ Ğ²ĞµÑ€Ğ½ĞµÑ‚ ÑÑ‚Ñ€Ğ¾ĞºÑƒ
                                console.warn(`[CalendarTable] Received string status for ${item.name} on ${dateStr}. Expected DayStatus object.`);
                                cell = { status: cellItemData as EquipmentStatus, group_id: null, is_user_reservation: false };
                            }

                            const status: EquipmentStatus = cell?.status || "available";
                            const groupId: string | null = cell?.group_id || null;
                            const isUserReservation: boolean = cell?.is_user_reservation || false;
                            const isToday = dateStr === todayStr;

                            const isHighlighted: boolean = !!(groupId && groupId === selectedGroupId);

                            const handleClick = (e: React.MouseEvent) => {
                                e.stopPropagation();
                                setSelectedGroupId(groupId === selectedGroupId ? null : groupId);
                            };

                            const currentBgMap = isUserReservation ? userCellBgMap : cellBgMap;
                            const bgColor = currentBgMap[status] || currentBgMap['available']; // Ğ¤Ğ¾Ğ»Ğ±ÑĞº Ğ½Ğ° 'available'

                            return (
                                <td
                                    key={dateStr}
                                    className={`p-[2px] border border-white ${isToday ? "today-column" : ""}`}
                                    onClick={handleClick}
                                    style={{ cursor: groupId ? 'pointer' : 'default' }} // Ğ”Ğ¾Ğ±Ğ°Ğ²Ğ»ÑĞµĞ¼ ĞºÑƒÑ€ÑĞ¾Ñ€, ĞµÑĞ»Ğ¸ ĞµÑÑ‚ÑŒ groupId
                                >
                                    <div
                                        className={`w-full h-6 rounded-md transition-colors ${bgColor} ${
                                            isHighlighted ? "ring-2 ring-black/40 ring-inset opacity-90" : ""
                                        }`}
                                        title={status + (isUserReservation ? " (Ğ¼Ğ¾Ğ¹)" : "") + (groupId ? ` (Ğ³Ñ€ÑƒĞ¿Ğ¿Ğ°: ${groupId})` : "")}
                                    >
                                        <span className="sr-only">{status}{isUserReservation ? " (Ğ¼Ğ¾Ğ¹)" : ""}{groupId ? ` (Ğ³Ñ€ÑƒĞ¿Ğ¿Ğ°: ${groupId})` : ""}</span>
                                    </div>
                                </td>
                            );
                        })}
                    </tr>
                ))}
                </tbody>
            </table>
        </div>
    );
}

```


## <a name="srccomponentscatalogEquipmentCatalogtsx"></a>`src/components/catalog/EquipmentCatalog.tsx`

```tsx
// path: src/components/catalog/EquipmentCatalog.tsx

// src/components/catalog/EquipmentCatalog.tsx

import { useMemo } from "react";
import FilterPanel from "@/components/FilterPanel";
import EquipmentGrid from "@/components/EquipmentGrid";
import { useAppFilters } from "@/hooks/features/useAppFilters";
import { useAssociations } from "@/hooks/useAssociations";
import { useAllEquipment } from "@/hooks/useAllEquipment";
import { useEquipmentData } from "@/hooks/data/useEquipmentData";
import { useReservationManagement } from "@/hooks/useReservationManagement";
import { useViewModeStore } from "@/store/viewModeStore";

interface EquipmentCatalogProps {
    editingReservationId?: number;
    intent?: string;
}

/**
 * ĞšĞ¾Ğ¼Ğ¿Ğ¾Ğ½ĞµĞ½Ñ‚ ĞºĞ°Ñ‚Ğ°Ğ»Ğ¾Ğ³Ğ° Ğ¾Ğ±Ğ¾Ñ€ÑƒĞ´Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ.
 * Ğ˜Ğ½ĞºĞ°Ğ¿ÑÑƒĞ»Ğ¸Ñ€ÑƒĞµÑ‚ Ğ¾Ñ‚Ğ¾Ğ±Ñ€Ğ°Ğ¶ĞµĞ½Ğ¸Ğµ Ğ¸ Ñ„Ğ¸Ğ»ÑŒÑ‚Ñ€Ğ°Ñ†Ğ¸Ñ ĞºĞ°Ñ‚Ğ°Ğ»Ğ¾Ğ³Ğ° Ğ¾Ğ±Ğ¾Ñ€ÑƒĞ´Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ.
 */
export default function EquipmentCatalog({ editingReservationId: _editingReservationId, intent: _intent }: EquipmentCatalogProps) {
    const { viewMode } = useViewModeStore();

    // 1. ĞŸĞ¾Ğ»ÑƒÑ‡Ğ°ĞµĞ¼ ÑĞ¾ÑÑ‚Ğ¾ÑĞ½Ğ¸Ğµ Ñ„Ğ¸Ğ»ÑŒÑ‚Ñ€Ğ¾Ğ²
    const { query, type, brand, availableOnly, associationId, reset: resetFilters, startDate, endDate } = useAppFilters();

    // 2. ĞŸĞ¾Ğ»ÑƒÑ‡Ğ°ĞµĞ¼ Ğ´Ğ°Ğ½Ğ½Ñ‹Ğµ Ğ´Ğ»Ñ Ñ„Ğ¸Ğ»ÑŒÑ‚Ñ€Ğ¾Ğ²
    const { data: _associations = [] } = useAssociations();
    const { data: allEquipmentForFilters = [] } = useAllEquipment();

    // 3. Ğ’Ñ‹Ğ·Ñ‹Ğ²Ğ°ĞµĞ¼ Ñ…ÑƒĞº Ğ´Ğ»Ñ Ğ¿Ğ¾Ğ»ÑƒÑ‡ĞµĞ½Ğ¸Ñ Ğ´Ğ°Ğ½Ğ½Ñ‹Ñ… Ñ ÑƒÑ‡ĞµÑ‚Ğ¾Ğ¼ Ñ„Ğ¸Ğ»ÑŒÑ‚Ñ€Ğ¾Ğ²
    const {
        equipment,
        totalEquipmentCount: _totalEquipmentCount,
        availabilityData,
        dailyAvailabilityData,
        isLoading,
        isFetchingNextPage,
        hasNextPage,
        fetchNextPage
    } = useEquipmentData({ 
        query, 
        type: type || undefined, 
        brand, 
        associationId: associationId || undefined, 
        availableOnly, 
        startDate: startDate as Date | undefined, 
        endDate: endDate as Date | undefined 
    });

    // Ğ¡Ğ¾Ğ·Ğ´Ğ°ĞµĞ¼ availabilityMap Ğ¸Ğ· availabilityData Ğ´Ğ»Ñ useReservationManagement
    const availabilityMap = useMemo(() => {
        const map: Record<number, any> = {};
        availabilityData?.forEach((info) => {
            map[info.equipment_id] = info;
        });
        return map;
    }, [availabilityData]);

    // 4. Ğ’Ñ‹Ğ·Ñ‹Ğ²Ğ°ĞµĞ¼ Ñ…ÑƒĞº Ğ´Ğ»Ñ Ğ»Ğ¾Ğ³Ğ¸ĞºĞ¸ ÑƒĞ¿Ñ€Ğ°Ğ²Ğ»ĞµĞ½Ğ¸Ñ Ñ€ĞµĞ·ĞµÑ€Ğ²Ğ°Ğ¼Ğ¸
    const {
        getEquipmentStatus
    } = useReservationManagement(equipment, availabilityMap, availableOnly);

    // Ğ’Ñ‹Ñ‡Ğ¸ÑĞ»ÑĞµĞ¼ Ğ´Ğ¾Ğ¿Ğ¾Ğ»Ğ½Ğ¸Ñ‚ĞµĞ»ÑŒĞ½Ñ‹Ğµ Ğ·Ğ½Ğ°Ñ‡ĞµĞ½Ğ¸Ñ
    const hasActiveFilters = !!(type || (brand && brand !== "__all__") || query || associationId);

    return (
        <>
            <FilterPanel equipmentData={allEquipmentForFilters} />

            <EquipmentGrid
                isLoading={isLoading}
                items={equipment}
                hasActiveFilters={hasActiveFilters}
                getEquipmentStatus={getEquipmentStatus}
                dailyAvailabilityData={dailyAvailabilityData}
                availabilityData={availabilityData}
                onShowMore={fetchNextPage}
                onResetFilters={resetFilters}
                viewMode={viewMode}
                isFetchingNextPage={isFetchingNextPage}
                hasNextPage={hasNextPage}
            />
        </>
    );
}


```


## <a name="srccomponentsequipment-cardAccessoriesSectiontsx"></a>`src/components/equipment-card/AccessoriesSection.tsx`

```tsx
// path: src/components/equipment-card/AccessoriesSection.tsx

// src/components/equipment-card/AccessoriesSection.tsx
import React from 'react';
import { Paperclip, ChevronDown } from "lucide-react";
import { Label } from "@/components/ui/label";
import { Checkbox } from "@/components/ui/checkbox";
import type { Equipment } from "@/types/equipment";

interface AccessoriesSectionProps {
    equipment: Equipment;
    isExpanded: boolean;
    isDisabled: boolean;
    onToggleExpand: (e: React.MouseEvent) => void;
    onToggleAccessory: (accId: number) => void;
    isAccessorySelected: (eqId: number, accId: number) => boolean;
}

export const AccessoriesSection: React.FC<AccessoriesSectionProps> = ({
                                                                          equipment, isExpanded, isDisabled, onToggleExpand, onToggleAccessory, isAccessorySelected
                                                                      }) => {
    if (!equipment.accessories?.length) return null;

    return (
        <div className="mt-3 border-t pt-3">
            <button
                className="w-full flex justify-between items-center text-sm font-medium text-gray-600 hover:text-sky-700 p-1 -m-1 rounded"
                onClick={onToggleExpand}
                aria-expanded={isExpanded}
            >
                <span className="flex items-center gap-2">
                    <Paperclip className="w-4 h-4" />
                    ĞĞºÑĞµÑÑÑƒĞ°Ñ€Ñ‹ ({equipment.accessories.length})
                </span>
                <ChevronDown className={`w-5 h-5 transition-transform ${isExpanded ? 'rotate-180' : ''}`} />
            </button>
            {isExpanded && (
                <div className="mt-2 space-y-2 pl-1 animate-in fade-in-0 slide-in-from-top-2 duration-300">
                    {equipment.accessories.map(acc => (
                        <div key={acc.id} className="flex items-center justify-between p-1 rounded hover:bg-gray-50">
                            <Label htmlFor={`acc-${equipment.id}-${acc.id}`} className="flex items-center gap-2 text-xs font-normal cursor-pointer">
                                <Checkbox
                                    id={`acc-${equipment.id}-${acc.id}`}
                                    checked={isAccessorySelected(equipment.id, acc.id)}
                                    onCheckedChange={() => onToggleAccessory(acc.id)}
                                    disabled={isDisabled}
                                />
                                {acc.name}
                            </Label>
                            <span className="text-xs text-gray-500">{acc.price} â‚½</span>
                        </div>
                    ))}
                </div>
            )}
        </div>
    );
};

```


## <a name="srccomponentsequipment-cardCardFootertsx"></a>`src/components/equipment-card/CardFooter.tsx`

```tsx
// path: src/components/equipment-card/CardFooter.tsx

// src/components/equipment-card/CardFooter.tsx
import React from 'react';
import AvailabilityStrip from "@/components/AvailabilityStrip";
import { STATUS_TEXT_STYLES, STATUS_TEXTS } from './constants';
import type { DayStatus, EquipmentStatus } from "@/types/availability";

interface CardFooterProps {
    status: EquipmentStatus | "my_reservation" | "added";
    dateRange: string;
    selected: boolean;
    onToggleSelection: (e: React.MouseEvent) => void;
    dailyStatus?: Record<string, DayStatus>;
}

export const CardFooter: React.FC<CardFooterProps> = ({
                                                          status, dateRange, selected, onToggleSelection, dailyStatus
                                                      }) => (
    <div className="mt-auto pt-4 space-y-2">
        <div className="flex justify-between items-center">
            <p className={`text-sm font-semibold ${STATUS_TEXT_STYLES[status]}`}>
                {STATUS_TEXTS[status]}
                {dateRange && <span className="ml-1 text-xs font-normal">{dateRange}</span>}
            </p>
            {(status === 'available' || status === 'added') && (
                <button
                    onClick={onToggleSelection}
                    className={`px-3 py-1 rounded text-sm font-medium transition ${
                        status === 'added'
                            ? "bg-rose-100 text-rose-700 hover:bg-rose-200"
                            : selected
                                ? "bg-sky-700 text-white hover:bg-sky-800"
                                : "bg-sky-100 text-sky-700 hover:bg-sky-200"
                    }`}
                >
                    {status === 'added' ? "ĞÑ‚Ğ¼ĞµĞ½Ğ¸Ñ‚ÑŒ" : (selected ? "âœ” Ğ’ Ñ€ĞµĞ·ĞµÑ€Ğ²Ğµ" : "â• Ğ’ Ñ€ĞµĞ·ĞµÑ€Ğ²")}
                </button>
            )}
        </div>
        <AvailabilityStrip dailyStatus={dailyStatus} />
    </div>
);

```


## <a name="srccomponentsequipment-cardCardImagetsx"></a>`src/components/equipment-card/CardImage.tsx`

```tsx
// path: src/components/equipment-card/CardImage.tsx

// src/components/equipment-card/CardImage.tsx
import React from 'react';
import { Image as ImageIcon } from "lucide-react";

interface CardImageProps {
    imageUrl?: string;
    name: string;
}

export const CardImage: React.FC<CardImageProps> = ({ imageUrl, name }) => (
    <div className="relative w-full h-40 bg-gray-100 flex items-center justify-center overflow-hidden">
        {imageUrl ? (
            <img
                src={imageUrl}
                alt={name}
                className="w-full h-full object-cover transition-transform duration-300 group-hover:scale-105"
                loading="lazy"
            />
        ) : (
            <ImageIcon className="w-12 h-12 text-gray-300" />
        )}
        <div className="absolute inset-0 bg-black/40 transition-opacity duration-300 group-hover:opacity-0 group-focus-within:opacity-0" />
    </div>
);

```


## <a name="srccomponentsequipment-cardDiscountInfotsx"></a>`src/components/equipment-card/DiscountInfo.tsx`

```tsx
// path: src/components/equipment-card/DiscountInfo.tsx

// src/components/equipment-card/DiscountInfo.tsx
import React from 'react';
import { getDayEnding } from './constants';

interface DiscountInfoProps {
    days: number;
    percentage: number;
    priceBefore: number;
    priceAfter: number;
}

export const DiscountInfo: React.FC<DiscountInfoProps> = ({ days, percentage, priceBefore, priceAfter }) => (
    <div className="mt-2 p-2 bg-gray-50 rounded-md border border-dashed">
        <div className="flex justify-between items-center text-sm">
            <span>{days} {getDayEnding(days)}:</span>
            {percentage > 0 ? (
                <div className="flex items-baseline gap-2">
                    <span className="text-gray-500 line-through">{Math.round(priceBefore).toLocaleString('ru-RU')} â‚½</span>
                    <span className="font-bold text-base text-green-600">{Math.round(priceAfter).toLocaleString('ru-RU')} â‚½</span>
                </div>
            ) : (
                <span className="font-bold text-base text-gray-800">{Math.round(priceBefore).toLocaleString('ru-RU')} â‚½</span>
            )}
        </div>
        {percentage > 0 && <div className="text-xs text-right text-gray-500">Ğ¡ĞºĞ¸Ğ´ĞºĞ° {percentage}%</div>}
    </div>
);

```


## <a name="srccomponentsequipment-cardEquipmentCardtsx"></a>`src/components/equipment-card/EquipmentCard.tsx`

```tsx
// path: src/components/equipment-card/EquipmentCard.tsx

// src/components/equipment-card/EquipmentCard.tsx
import React, { useState } from "react";
import { CheckCircle } from "lucide-react";
import { formatDateRangeEuropean } from "@/lib/utils";
import { useEquipmentCardViewModel } from "@/hooks/features/useEquipmentCardViewModel";

// ĞŸĞ¾Ğ´ĞºĞ¾Ğ¼Ğ¿Ğ¾Ğ½ĞµĞ½Ñ‚Ñ‹
import { CardImage } from "./CardImage";
import { DiscountInfo } from "./DiscountInfo";
import { AccessoriesSection } from "./AccessoriesSection";
import { CardFooter } from "./CardFooter";
import { STATUS_BACKGROUND_STYLES } from './constants';
import EquipmentDetailsDialog from "@/components/equipment/EquipmentDetailsDialog";

// Ğ¢Ğ¸Ğ¿Ñ‹
import type { Equipment } from "@/types/equipment";
import type { DayStatus, EquipmentStatus } from "@/types/availability";

interface EquipmentCardProps {
    equipment: Equipment;
    status?: EquipmentStatus | "my_reservation" | "added";
    startDate?: string;
    endDate?: string;
    dailyStatus?: Record<string, DayStatus>;
}

const EquipmentCardComponent: React.FC<EquipmentCardProps> = ({ equipment, status = "available", startDate, endDate, dailyStatus }) => {
    const [showDetails, setShowDetails] = useState(false);
    const [showAccessories, setShowAccessories] = useState(false);

    // ĞŸĞ¾Ğ»ÑƒÑ‡Ğ°ĞµĞ¼ Ğ²ÑĞµ Ğ´Ğ°Ğ½Ğ½Ñ‹Ğµ Ğ¸ Ñ„ÑƒĞ½ĞºÑ†Ğ¸Ğ¸ Ğ¸Ğ· Ñ…ÑƒĞºĞ°-ViewModel
    const {
        isSelectedByUser,
        isCalculatorVisible,
        discountData,
        handleToggleAccessory,
        handleToggleSelection,
        isAccessorySelected,
    } = useEquipmentCardViewModel({ equipment, status });

    const handleCardClick = (e: React.MouseEvent<HTMLDivElement>) => {
        if ((e.target as HTMLElement).closest("button, a, label, input[type='checkbox']")) return;
        setShowDetails(true);
    };

    const handleDoubleClick = (e: React.MouseEvent<HTMLDivElement>) => {
        if ((e.target as HTMLElement).closest("button, a, label, input[type='checkbox']")) return;
        if (status === 'available' || status === 'added') handleToggleSelection();
    };

    const stopPropagationAndToggle = (e: React.MouseEvent, action: () => void) => {
        e.stopPropagation();
        action();
    };

    const backgroundClass = STATUS_BACKGROUND_STYLES[status] || 'bg-white';
    const selectionClass = isSelectedByUser ? "ring-2 ring-offset-1 ring-sky-500 border-sky-400" : "border-gray-200 hover:shadow-lg";
    const dateRangeDisplay = (startDate && endDate) ? `(${formatDateRangeEuropean(startDate, endDate)})` : "";

    return (
        <>
            <div
                className={`relative group rounded-xl shadow transition w-full max-w-sm flex flex-col justify-between cursor-pointer overflow-hidden ${backgroundClass} ${selectionClass}`}
                onClick={handleCardClick}
                onDoubleClick={handleDoubleClick}
                tabIndex={0}
            >
                {isSelectedByUser && <div className="absolute top-2.5 right-2.5 z-10 bg-sky-600 text-white rounded-full p-1 shadow"><CheckCircle className="w-5 h-5" /></div>}

                <CardImage imageUrl={equipment.image_url} name={equipment.name} />

                <div className="p-4 flex-1 flex flex-col">
                    <div className="flex-grow">
                        <h3 className="text-lg font-semibold mb-1">{equipment.name}</h3>
                        <p className="text-sm text-gray-500 mb-2">{equipment.brand} â€¢ {equipment.equipment_type}</p>
                        {equipment.short_description && <p className="text-sm italic text-gray-600 mb-2">"{equipment.short_description}"</p>}
                        <p className="text-sm mb-1">Ğ¡Ğ¾ÑÑ‚Ğ¾ÑĞ½Ğ¸Ğµ: <strong>{equipment.condition}</strong></p>
                        <p className="text-base font-bold mb-1">{equipment.daily_rate} â‚½ / Ğ´ĞµĞ½ÑŒ</p>
                        {isCalculatorVisible && <DiscountInfo {...discountData} />}
                    </div>

                    <AccessoriesSection
                        equipment={equipment}
                        isExpanded={showAccessories}
                        isDisabled={status !== 'available' && status !== 'added'}
                        onToggleExpand={(e) => stopPropagationAndToggle(e, () => setShowAccessories(p => !p))}
                        onToggleAccessory={handleToggleAccessory}
                        isAccessorySelected={isAccessorySelected}
                    />

                    <CardFooter
                        status={status}
                        dateRange={dateRangeDisplay}
                        selected={isSelectedByUser}
                        onToggleSelection={(e) => stopPropagationAndToggle(e, handleToggleSelection)}
                        dailyStatus={dailyStatus}
                    />
                </div>
            </div>

            <EquipmentDetailsDialog
                open={showDetails}
                onClose={() => setShowDetails(false)}
                equipment={equipment}
                availability={{ equipment_id: equipment.id, status: status as EquipmentStatus, details: "" }}
            />
        </>
    );
};

// ĞœĞµĞ¼Ğ¾Ğ¸Ğ·Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ½Ğ°Ñ Ğ²ĞµÑ€ÑĞ¸Ñ ĞºĞ¾Ğ¼Ğ¿Ğ¾Ğ½ĞµĞ½Ñ‚Ğ° Ğ´Ğ»Ñ Ğ¾Ğ¿Ñ‚Ğ¸Ğ¼Ğ¸Ğ·Ğ°Ñ†Ğ¸Ğ¸ Ğ¿Ñ€Ğ¾Ğ¸Ğ·Ğ²Ğ¾Ğ´Ğ¸Ñ‚ĞµĞ»ÑŒĞ½Ğ¾ÑÑ‚Ğ¸
export const EquipmentCard = React.memo(EquipmentCardComponent);

```


## <a name="srccomponentsequipment-cardconstantsts"></a>`src/components/equipment-card/constants.ts`

```typescript
// path: src/components/equipment-card/constants.ts

// src/components/equipment-card/constants.ts

import type { EquipmentStatus } from "@/types/availability";

type StatusKey = EquipmentStatus | "my_reservation" | "added";

// Ğ¡Ñ‚Ğ¸Ğ»Ğ¸ Ğ¢ĞĞ›Ğ¬ĞšĞ Ğ´Ğ»Ñ Ñ†Ğ²ĞµÑ‚Ğ° Ñ‚ĞµĞºÑÑ‚Ğ°
export const STATUS_TEXT_STYLES: Record<StatusKey, string> = {
    available: "text-green-600",
    reserved: "text-yellow-500",
    rented: "text-red-600",
    my_reservation: "text-sky-700",
    added: "text-emerald-600",
};

// Ğ¡Ñ‚Ğ¸Ğ»Ğ¸ Ğ¢ĞĞ›Ğ¬ĞšĞ Ğ´Ğ»Ñ Ñ†Ğ²ĞµÑ‚Ğ° Ñ„Ğ¾Ğ½Ğ°
export const STATUS_BACKGROUND_STYLES: Record<StatusKey, string> = {
    available: "bg-white",
    reserved: "bg-white",
    rented: "bg-white",
    my_reservation: "bg-sky-50",
    added: "bg-emerald-50",
};

// Ğ¢ĞµĞºÑÑ‚Ğ¾Ğ²Ñ‹Ğµ Ğ¾Ğ¿Ğ¸ÑĞ°Ğ½Ğ¸Ñ Ğ´Ğ»Ñ ÑÑ‚Ğ°Ñ‚ÑƒÑĞ¾Ğ²
export const STATUS_TEXTS: Record<StatusKey, string> = {
    available: "Ğ¡Ğ²Ğ¾Ğ±Ğ¾Ğ´Ğ½Ğ¾",
    reserved: "Ğ’ Ñ€ĞµĞ·ĞµÑ€Ğ²Ğµ",
    rented: "Ğ’ Ğ°Ñ€ĞµĞ½Ğ´Ğµ",
    my_reservation: "Ğ’ ÑÑ‚Ğ¾Ğ¼ Ñ€ĞµĞ·ĞµÑ€Ğ²Ğµ",
    added: "Ğ”Ğ¾Ğ±Ğ°Ğ²Ğ»ĞµĞ½Ğ¾",
};

// Ğ’ÑĞ¿Ğ¾Ğ¼Ğ¾Ğ³Ğ°Ñ‚ĞµĞ»ÑŒĞ½Ğ°Ñ Ñ„ÑƒĞ½ĞºÑ†Ğ¸Ñ Ğ´Ğ»Ñ Ğ¿Ğ¾Ğ»ÑƒÑ‡ĞµĞ½Ğ¸Ñ Ğ¿Ñ€Ğ°Ğ²Ğ¸Ğ»ÑŒĞ½Ğ¾Ğ³Ğ¾ Ğ¾ĞºĞ¾Ğ½Ñ‡Ğ°Ğ½Ğ¸Ñ ÑĞ»Ğ¾Ğ²Ğ° "Ğ´ĞµĞ½ÑŒ"
export const getDayEnding = (num: number): string => {
    if (num > 10 && num < 20) return 'Ğ´Ğ½ĞµĞ¹';
    const lastDigit = num % 10;
    if (lastDigit === 1) return 'Ğ´ĞµĞ½ÑŒ';
    if (lastDigit > 1 && lastDigit < 5) return 'Ğ´Ğ½Ñ';
    return 'Ğ´Ğ½ĞµĞ¹';
};

```


## <a name="srccomponentsequipment-cardindexts"></a>`src/components/equipment-card/index.ts`

```typescript
// path: src/components/equipment-card/index.ts

// src/components/equipment-card/index.ts

export { EquipmentCard as default } from './EquipmentCard';

```


## <a name="srccomponentsequipmentEquipmentDetailsDialogtsx"></a>`src/components/equipment/EquipmentDetailsDialog.tsx`

```tsx
// path: src/components/equipment/EquipmentDetailsDialog.tsx

// src/components/equipment/EquipmentDetailsDialog.tsx
import { useState, useEffect } from "react"; // 1. Ğ˜Ğ¼Ğ¿Ğ¾Ñ€Ñ‚Ğ¸Ñ€ÑƒĞµĞ¼ useEffect
import { Dialog, DialogContent, DialogFooter, DialogHeader, DialogTitle } from "@/components/ui/dialog";
import EquipmentDetailsView from "@/components/equipment/EquipmentDetailsView";
import EquipmentEditForm from "./EquipmentEditForm";
import type { Equipment } from "@/types/equipment";
import type { AvailabilityInfo } from "@/types/availability";
import { Button } from "@/components/ui/button";
import { useReserveStore } from "@/store/reserveStore";
import { useCurrentUser } from "@/hooks/useProfile";
import { Pencil, Check } from "lucide-react";

type Props = {
    open: boolean;
    onClose: () => void;
    equipment: Equipment;
    availability?: AvailabilityInfo;
};

export default function EquipmentDetailsDialog({ open, onClose, equipment, availability }: Props) {
    const { addWithAccessories, isSelected } = useReserveStore();
    const { data: currentUser } = useCurrentUser();

    const [isEditing, setIsEditing] = useState(false);
    const [stagedAccessoryIds, setStagedAccessoryIds] = useState<Set<number>>(new Set());

    // 2. Ğ”Ğ¾Ğ±Ğ°Ğ²Ğ»ÑĞµĞ¼ ÑÑ‚Ğ¾Ñ‚ Ğ±Ğ»Ğ¾Ğº useEffect
    useEffect(() => {
        if (!open) {
            document.body.style.overflow = '';
        }
    }, [open]);

    const selected = isSelected(equipment.id);
    const isAvailableForReservation = availability?.status === "available";
    const userRole = currentUser?.role;
    const canEdit = userRole === "admin" || userRole === "manager";
    const canViewAdminInfo = canEdit;

    const handleMainActionClick = () => {
        if (!selected) {
            addWithAccessories(equipment, Array.from(stagedAccessoryIds));
        }
        onClose();
    };

    const handleEditClick = () => {
        setIsEditing(true);
    };

    const handleDialogCloseTrigger = () => {
        setIsEditing(false);
        setStagedAccessoryIds(new Set());
        onClose();
    };

    const handleToggleStagedAccessory = (accessoryId: number) => {
        setStagedAccessoryIds(prev => {
            const newSet = new Set(prev);
            if (newSet.has(accessoryId)) {
                newSet.delete(accessoryId);
            } else {
                newSet.add(accessoryId);
            }
            return newSet;
        });
    };

    return (
        <Dialog open={open} onOpenChange={(isOpen) => !isOpen && handleDialogCloseTrigger()}>
            <DialogContent className="max-w-xl p-6">
                <DialogHeader className="pb-4">
                    <DialogTitle className="text-lg sm:text-xl">
                        {isEditing ? `Ğ ĞµĞ´Ğ°ĞºÑ‚Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ: ${equipment.name}` : "Ğ”ĞµÑ‚Ğ°Ğ»Ğ¸ Ğ¾Ğ±Ğ¾Ñ€ÑƒĞ´Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ"}
                    </DialogTitle>
                </DialogHeader>

                {isEditing ? (
                    <EquipmentEditForm
                        equipment={equipment}
                        onSuccess={() => { setIsEditing(false); onClose(); }}
                        onCancel={() => setIsEditing(false) }
                    />
                ) : (
                    <EquipmentDetailsView
                        equipment={equipment}
                        canViewAdminInfo={canViewAdminInfo}
                        canToggleAccessories={isAvailableForReservation}
                        isMainSelected={selected}
                        stagedAccessoryIds={stagedAccessoryIds}
                        onToggleStagedAccessory={handleToggleStagedAccessory}
                    />
                )}

                {!isEditing && (
                    <DialogFooter className="pt-4 mt-4 border-t border-gray-200 flex flex-col sm:flex-row sm:justify-end sm:items-center gap-2">
                        {canEdit && (
                            <Button
                                variant="secondary"
                                onClick={handleEditClick}
                                className="w-full sm:w-auto order-last sm:order-none"
                            >
                                <Pencil size={15} className="mr-1.5" />
                                Ğ ĞµĞ´Ğ°ĞºÑ‚Ğ¸Ñ€Ğ¾Ğ²Ğ°Ñ‚ÑŒ
                            </Button>
                        )}
                        {isAvailableForReservation && (
                            <Button
                                onClick={handleMainActionClick}
                                variant="default"
                                className="w-full sm:w-auto"
                            >
                                {selected
                                    ? <><Check size={16} className="mr-1.5" />Ğ“Ğ¾Ñ‚Ğ¾Ğ²Ğ¾</>
                                    : "â• Ğ”Ğ¾Ğ±Ğ°Ğ²Ğ¸Ñ‚ÑŒ Ğ² Ñ€ĞµĞ·ĞµÑ€Ğ²"
                                }
                            </Button>
                        )}
                    </DialogFooter>
                )}
            </DialogContent>
        </Dialog>
    );
}

```


## <a name="srccomponentsequipmentEquipmentDetailsViewtsx"></a>`src/components/equipment/EquipmentDetailsView.tsx`

```tsx
// path: src/components/equipment/EquipmentDetailsView.tsx

// src/components/equipment/EquipmentDetailsView.tsx
import type { Equipment } from "@/types/equipment";
import { formatDateEuropean } from "@/lib/utils";
import ReactMarkdown from 'react-markdown';
import { Image as ImageIcon, Paperclip, Plus, Check } from "lucide-react";
import { Button } from "@/components/ui/button";
import { useReserveStore } from "@/store/reserveStore";

type Props = {
    equipment: Equipment;
    canViewAdminInfo: boolean;
    canToggleAccessories: boolean;
    // ğŸ‘‡ Ğ˜Ğ—ĞœĞ•ĞĞ•ĞĞ˜Ğ•: ĞĞ¾Ğ²Ñ‹Ğµ Ğ¿Ñ€Ğ¾Ğ¿ÑÑ‹ Ğ´Ğ»Ñ ÑƒĞ¿Ñ€Ğ°Ğ²Ğ»ĞµĞ½Ğ¸Ñ ÑĞ¾ÑÑ‚Ğ¾ÑĞ½Ğ¸ĞµĞ¼
    isMainSelected: boolean;
    stagedAccessoryIds: Set<number>;
    onToggleStagedAccessory: (accessoryId: number) => void;
};

export default function EquipmentDetailsView({
                                                 equipment,
                                                 canViewAdminInfo,
                                                 canToggleAccessories,
                                                 isMainSelected,
                                                 stagedAccessoryIds,
                                                 onToggleStagedAccessory
                                             }: Props) {
    const { toggleAccessory, isAccessorySelected } = useReserveStore();

    // ğŸ‘‡ Ğ˜Ğ—ĞœĞ•ĞĞ•ĞĞ˜Ğ•: ĞĞ±Ñ€Ğ°Ğ±Ğ¾Ñ‚Ñ‡Ğ¸Ğº Ñ‚ĞµĞ¿ĞµÑ€ÑŒ Ñ€Ğ°Ğ·Ğ´ĞµĞ»ÑĞµÑ‚ Ğ»Ğ¾Ğ³Ğ¸ĞºÑƒ
    const handleToggleAccessory = (accessoryId: number) => {
        // Ğ•ÑĞ»Ğ¸ Ğ¾ÑĞ½Ğ¾Ğ²Ğ½Ğ¾Ğ¹ Ñ‚Ğ¾Ğ²Ğ°Ñ€ ÑƒĞ¶Ğµ Ğ² Ñ€ĞµĞ·ĞµÑ€Ğ²Ğµ, Ñ€Ğ°Ğ±Ğ¾Ñ‚Ğ°ĞµĞ¼ Ñ Ğ³Ğ»Ğ¾Ğ±Ğ°Ğ»ÑŒĞ½Ñ‹Ğ¼ ÑÑ‚Ğ¾Ñ€Ğ¾Ğ¼
        if (isMainSelected) {
            toggleAccessory(equipment.id, accessoryId);
        } else {
            // Ğ˜Ğ½Ğ°Ñ‡Ğµ - Ñ€Ğ°Ğ±Ğ¾Ñ‚Ğ°ĞµĞ¼ Ñ Ğ»Ğ¾ĞºĞ°Ğ»ÑŒĞ½Ñ‹Ğ¼ ÑĞ¾ÑÑ‚Ğ¾ÑĞ½Ğ¸ĞµĞ¼ "Ğ¾Ñ‚Ğ¼ĞµÑ‡ĞµĞ½Ğ½Ñ‹Ñ…"
            onToggleStagedAccessory(accessoryId);
        }
    };

    const allImages = [equipment.image_url, ...(equipment.image_urls || [])].filter(Boolean) as string[];

    return (
        <div className="space-y-3 text-sm">
            {/* ... Ğ±Ğ»Ğ¾Ğº Ñ Ğ¸Ğ·Ğ¾Ğ±Ñ€Ğ°Ğ¶ĞµĞ½Ğ¸ÑĞ¼Ğ¸ Ğ¸ Ğ¾Ğ¿Ğ¸ÑĞ°Ğ½Ğ¸ĞµĞ¼ Ğ¾ÑÑ‚Ğ°ĞµÑ‚ÑÑ Ğ±ĞµĞ· Ğ¸Ğ·Ğ¼ĞµĞ½ĞµĞ½Ğ¸Ğ¹ ... */}
            {allImages.length > 0 ? (
                <div className="flex overflow-x-auto space-x-2 pb-2 -mx-1 px-1">
                    {allImages.map((url, index) => (
                        <div key={index} className="flex-shrink-0 w-48 h-32 rounded-lg overflow-hidden bg-gray-100 border">
                            <img src={url} alt={`${equipment.name} image ${index + 1}`} className="w-full h-full object-cover" />
                        </div>
                    ))}
                </div>
            ) : (
                <div className="w-full h-32 bg-gray-100 flex items-center justify-center rounded-lg border">
                    <ImageIcon className="w-12 h-12 text-gray-300" />
                </div>
            )}

            <h3 className="text-base sm:text-lg font-bold text-gray-900 leading-tight pt-2">
                {equipment.equipment_type} {equipment.brand} {equipment.name}
            </h3>

            <div className="mt-2 space-y-1">
                <p><span className="font-medium text-gray-700">Ğ¦ĞµĞ½Ğ°:</span> {equipment.daily_rate} â‚½ / Ğ´ĞµĞ½ÑŒ</p>
                <p><span className="font-medium text-gray-700">Ğ¡Ğ¾ÑÑ‚Ğ¾ÑĞ½Ğ¸Ğµ:</span> {equipment.condition}</p>
            </div>

            {equipment.accessories && equipment.accessories.length > 0 && (
                <div className="pt-3 mt-3 border-t">
                    <p className="font-semibold text-gray-800 mb-2 flex items-center gap-2">
                        <Paperclip className="w-4 h-4 text-gray-500"/>
                        Ğ”Ğ¾ÑÑ‚ÑƒĞ¿Ğ½Ñ‹Ğµ Ğ°ĞºÑĞµÑÑÑƒĞ°Ñ€Ñ‹:
                    </p>
                    <ul className="space-y-1.5">
                        {equipment.accessories.map(acc => {
                            // ğŸ‘‡ Ğ˜Ğ—ĞœĞ•ĞĞ•ĞĞ˜Ğ•: ĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑĞµĞ¼ ÑÑ‚Ğ°Ñ‚ÑƒÑ Ğ² Ğ·Ğ°Ğ²Ğ¸ÑĞ¸Ğ¼Ğ¾ÑÑ‚Ğ¸ Ğ¾Ñ‚ Ñ‚Ğ¾Ğ³Ğ¾, Ğ´Ğ¾Ğ±Ğ°Ğ²Ğ»ĞµĞ½ Ğ»Ğ¸ Ñ‚Ğ¾Ğ²Ğ°Ñ€ Ğ² Ñ€ĞµĞ·ĞµÑ€Ğ²
                            const isAdded = isMainSelected
                                ? isAccessorySelected(equipment.id, acc.id)
                                : stagedAccessoryIds.has(acc.id);

                            return (
                                <li key={acc.id} className="flex justify-between items-center bg-gray-50/70 p-2 rounded-md hover:bg-gray-100 transition-colors">
                                    <div>
                                        <span className="font-medium">{acc.name}</span>
                                        <span className="text-xs text-gray-600 ml-2">{acc.price} â‚½</span>
                                    </div>
                                    <Button
                                        size="icon"
                                        variant={isAdded ? "default" : "outline"}
                                        className={`h-7 w-7 shrink-0 ${isAdded ? 'bg-green-600 hover:bg-green-700' : ''}`}
                                        onClick={() => handleToggleAccessory(acc.id)}
                                        aria-label={isAdded ? "Ğ£Ğ±Ñ€Ğ°Ñ‚ÑŒ Ğ°ĞºÑĞµÑÑÑƒĞ°Ñ€" : "Ğ”Ğ¾Ğ±Ğ°Ğ²Ğ¸Ñ‚ÑŒ Ğ°ĞºÑĞµÑÑÑƒĞ°Ñ€"}
                                        disabled={!canToggleAccessories}
                                    >
                                        {isAdded ? <Check className="h-4 w-4" /> : <Plus className="h-4 w-4" />}
                                    </Button>
                                </li>
                            );
                        })}
                    </ul>
                </div>
            )}

            {/* ... Ğ¾ÑÑ‚Ğ°Ğ»ÑŒĞ½Ñ‹Ğµ Ğ±Ğ»Ğ¾ĞºĞ¸ (Ğ¾Ğ¿Ğ¸ÑĞ°Ğ½Ğ¸Ğµ, ÑĞ»ÑƒĞ¶ĞµĞ±Ğ½Ğ°Ñ Ğ¸Ğ½Ñ„Ğ¾Ñ€Ğ¼Ğ°Ñ†Ğ¸Ñ) Ğ¾ÑÑ‚Ğ°ÑÑ‚ÑÑ Ğ±ĞµĞ· Ğ¸Ğ·Ğ¼ĞµĞ½ĞµĞ½Ğ¸Ğ¹ ... */}
            {equipment.description && (
                <div className="pt-3 mt-3 border-t">
                    <p className="font-semibold text-gray-800 mb-1">ĞĞ¿Ğ¸ÑĞ°Ğ½Ğ¸Ğµ:</p>
                    <div className="prose prose-sm max-w-none text-gray-700 bg-gray-50 p-3 rounded-md border border-gray-200">
                        <ReactMarkdown>{equipment.description}</ReactMarkdown>
                    </div>
                </div>
            )}

            {canViewAdminInfo && (equipment.notes || equipment.last_maintenance) && (
                <div className="pt-3 mt-3 border-t space-y-2">
                    <h4 className="text-sm font-semibold text-sky-700">Ğ¡Ğ»ÑƒĞ¶ĞµĞ±Ğ½Ğ°Ñ Ğ¸Ğ½Ñ„Ğ¾Ñ€Ğ¼Ğ°Ñ†Ğ¸Ñ:</h4>
                    {equipment.last_maintenance && (
                        <p className="text-xs text-gray-600"><strong>ĞŸĞ¾ÑĞ»ĞµĞ´Ğ½ĞµĞµ Ğ¢Ğ:</strong> {formatDateEuropean(equipment.last_maintenance)}</p>
                    )}
                    {equipment.notes && (
                        <div>
                            <p className="text-xs font-semibold text-gray-600 mb-0.5">Ğ—Ğ°Ğ¼ĞµÑ‚ĞºĞ¸:</p>
                            <p className="text-xs text-gray-500 whitespace-pre-wrap bg-gray-50 p-2 rounded-md border border-gray-200">{equipment.notes}</p>
                        </div>
                    )}
                </div>
            )}
        </div>
    );
}

```


## <a name="srccomponentsequipmentEquipmentEditFormtsx"></a>`src/components/equipment/EquipmentEditForm.tsx`

```tsx
// path: src/components/equipment/EquipmentEditForm.tsx

// src/components/equipment/EquipmentEditForm.tsx

import { useForm, Controller } from "react-hook-form";
import { zodResolver } from "@hookform/resolvers/zod";
import {
    equipmentUpdateExtendedSchema,
    type EquipmentUpdateExtendedSchema as EquipmentUpdateFormData
} from "@/lib/validationSchemas";
import { useUpdateEquipmentDetails } from "@/hooks/useUpdateEquipmentDetails";
import { useAccessories } from "@/hooks/useAdminAccessories";
import type { Equipment } from "@/types/equipment";
import type { Accessory } from "@/types/accessory"; // Ğ”Ğ¾Ğ±Ğ°Ğ²Ğ»ÑĞµĞ¼ Ğ¸Ğ¼Ğ¿Ğ¾Ñ€Ñ‚ Ñ‚Ğ¸Ğ¿Ğ° Accessory
import { Input } from "@/components/ui/input";
import { Button } from "@/components/ui/button";
import { Label } from "@/components/ui/label";
import { Textarea } from "@/components/ui/textarea";
import { formatDate } from "@/lib/utils";
import MDEditor from '@uiw/react-md-editor';
import rehypeSanitize from 'rehype-sanitize';
import { Checkbox } from "@/components/ui/checkbox";
import { useAllEquipment } from "@/hooks/useAllEquipment";
import { CreatableSelect } from "@/components/ui/CreatableSelect";
import { useMemo } from "react";

type Props = {
    equipment: Equipment;
    onSuccess: (updatedData: Equipment) => void;
    onCancel: () => void;
};

export default function EquipmentEditForm({ equipment, onSuccess, onCancel }: Props) {
    const { data: allEquipmentData = [] } = useAllEquipment();
    // Ğ—Ğ°Ğ¿Ñ€Ğ°ÑˆĞ¸Ğ²Ğ°ĞµĞ¼ Ğ°ĞºÑĞµÑÑÑƒĞ°Ñ€Ñ‹ Ñ Ğ¿Ğ°Ğ³Ğ¸Ğ½Ğ°Ñ†Ğ¸ĞµĞ¹ (Ğ±ĞµÑ€ĞµĞ¼ Ğ¾Ğ´Ğ½Ñƒ Ğ±Ğ¾Ğ»ÑŒÑˆÑƒÑ "ÑÑ‚Ñ€Ğ°Ğ½Ğ¸Ñ†Ñƒ")
    const { data: accessoriesResponse, isLoading: isLoadingAccessories } = useAccessories(1, 500);
    // Ğ˜Ğ·Ğ²Ğ»ĞµĞºĞ°ĞµĞ¼ Ğ¼Ğ°ÑÑĞ¸Ğ² .items Ğ¸Ğ· Ğ¾Ñ‚Ğ²ĞµÑ‚Ğ°
    const allAccessories = accessoriesResponse?.items || [];

    const equipmentTypes = useMemo(() => {
        const types = new Set(allEquipmentData.map(e => e.equipment_type));
        return Array.from(types).sort((a, b) => a.localeCompare(b));
    }, [allEquipmentData]);

    const equipmentBrands = useMemo(() => {
        const brands = new Set(allEquipmentData.map(e => e.brand));
        return Array.from(brands).sort((a, b) => a.localeCompare(b));
    }, [allEquipmentData]);

    const {
        register,
        handleSubmit,
        control,
        formState: { errors, isDirty, isValid },
    } = useForm<EquipmentUpdateFormData>({
        resolver: zodResolver(equipmentUpdateExtendedSchema) as any,
        defaultValues: {
            equipment_type: equipment.equipment_type ?? undefined,
            brand: equipment.brand ?? undefined,
            name: equipment.name ?? undefined,
            serial_number: equipment.serial_number ?? undefined,
            condition: equipment.condition ?? undefined,
            daily_rate: equipment.daily_rate ?? undefined,
            notes: equipment.notes ?? undefined,
            description: equipment.description ?? undefined,
            last_maintenance: equipment.last_maintenance ? formatDate(equipment.last_maintenance) : undefined,
            short_description: equipment.short_description ?? undefined,
            image_url: equipment.image_url ?? undefined,
            image_urls: equipment.image_urls ?? [],
            accessory_ids: equipment.accessories?.map(acc => acc.id) ?? [],
        },
        mode: "onChange",
    });

    const updateEquipmentMutation = useUpdateEquipmentDetails();

    const onSubmitHandler = async (data: EquipmentUpdateFormData) => {
        await updateEquipmentMutation.mutateAsync(
            { id: equipment.id, data },
            {
                onSuccess: (updatedEquipmentDataFromApi) => {
                    onSuccess(updatedEquipmentDataFromApi);
                },
            }
        );
    };

    return (
        <form onSubmit={handleSubmit(onSubmitHandler)} className="space-y-4 py-4 max-h-[75vh] overflow-y-auto pr-4">
            {/* ... Ğ¾ÑÑ‚Ğ°Ğ»ÑŒĞ½Ğ°Ñ Ñ‡Ğ°ÑÑ‚ÑŒ Ñ„Ğ¾Ñ€Ğ¼Ñ‹ Ğ¾ÑÑ‚Ğ°ĞµÑ‚ÑÑ Ğ±ĞµĞ· Ğ¸Ğ·Ğ¼ĞµĞ½ĞµĞ½Ğ¸Ğ¹ ... */}
            <div>
                <Label htmlFor="name">ĞĞ°Ğ·Ğ²Ğ°Ğ½Ğ¸Ğµ</Label>
                <Input id="name" {...register("name")} />
                {errors.name && <p className="text-xs text-red-600 mt-1">{errors.name.message}</p>}
            </div>

            <div className="grid grid-cols-1 sm:grid-cols-2 gap-4">
                <div>
                    <Label htmlFor="equipment_type">Ğ¢Ğ¸Ğ¿ Ğ¾Ğ±Ğ¾Ñ€ÑƒĞ´Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ</Label>
                    <Controller
                        name="equipment_type"
                        control={control}
                        render={({ field }) => (
                            <CreatableSelect
                                value={field.value}
                                onChange={field.onChange}
                                options={equipmentTypes}
                                placeholder="Ğ’Ñ‹Ğ±ĞµÑ€Ğ¸Ñ‚Ğµ Ğ¸Ğ»Ğ¸ ÑĞ¾Ğ·Ğ´Ğ°Ğ¹Ñ‚Ğµ Ñ‚Ğ¸Ğ¿"
                                dialogTitle="ĞĞ¾Ğ²Ñ‹Ğ¹ Ñ‚Ğ¸Ğ¿ Ğ¾Ğ±Ğ¾Ñ€ÑƒĞ´Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ"
                                dialogDescription="Ğ’Ğ²ĞµĞ´Ğ¸Ñ‚Ğµ Ğ½Ğ°Ğ·Ğ²Ğ°Ğ½Ğ¸Ğµ Ğ´Ğ»Ñ Ğ½Ğ¾Ğ²Ğ¾Ğ³Ğ¾ Ñ‚Ğ¸Ğ¿Ğ°."
                                dialogLabel="ĞĞ°Ğ·Ğ²Ğ°Ğ½Ğ¸Ğµ"
                            />
                        )}
                    />
                    {errors.equipment_type && <p className="text-xs text-red-600 mt-1">{errors.equipment_type.message}</p>}
                </div>
                <div>
                    <Label htmlFor="brand">Ğ‘Ñ€ĞµĞ½Ğ´</Label>
                    <Controller
                        name="brand"
                        control={control}
                        render={({ field }) => (
                            <CreatableSelect
                                value={field.value}
                                onChange={field.onChange}
                                options={equipmentBrands}
                                placeholder="Ğ’Ñ‹Ğ±ĞµÑ€Ğ¸Ñ‚Ğµ Ğ¸Ğ»Ğ¸ ÑĞ¾Ğ·Ğ´Ğ°Ğ¹Ñ‚Ğµ Ğ±Ñ€ĞµĞ½Ğ´"
                                dialogTitle="ĞĞ¾Ğ²Ñ‹Ğ¹ Ğ±Ñ€ĞµĞ½Ğ´"
                                dialogDescription="Ğ’Ğ²ĞµĞ´Ğ¸Ñ‚Ğµ Ğ½Ğ°Ğ·Ğ²Ğ°Ğ½Ğ¸Ğµ Ğ´Ğ»Ñ Ğ½Ğ¾Ğ²Ğ¾Ğ³Ğ¾ Ğ±Ñ€ĞµĞ½Ğ´Ğ°."
                                dialogLabel="ĞĞ°Ğ·Ğ²Ğ°Ğ½Ğ¸Ğµ"
                            />
                        )}
                    />
                    {errors.brand && <p className="text-xs text-red-600 mt-1">{errors.brand.message}</p>}
                </div>
            </div>

            <div>
                <Label htmlFor="short_description">ĞšÑ€Ğ°Ñ‚ĞºĞ¾Ğµ Ğ¾Ğ¿Ğ¸ÑĞ°Ğ½Ğ¸Ğµ (Ğ´Ğ»Ñ ĞºĞ°Ñ€Ñ‚Ğ¾Ñ‡ĞºĞ¸)</Label>
                <Input id="short_description" {...register("short_description")} placeholder="ĞĞ°Ğ¿Ñ€Ğ¸Ğ¼ĞµÑ€: ĞŸÑ€Ğ¾Ñ„ĞµÑÑĞ¸Ğ¾Ğ½Ğ°Ğ»ÑŒĞ½Ğ°Ñ Ğ±ĞµĞ·Ğ·ĞµÑ€ĞºĞ°Ğ»ÑŒĞ½Ğ°Ñ ĞºĞ°Ğ¼ĞµÑ€Ğ°..." />
                {errors.short_description && <p className="text-xs text-red-600 mt-1">{errors.short_description.message}</p>}
            </div>

            <div>
                <Label htmlFor="image_url">URL Ğ¾ÑĞ½Ğ¾Ğ²Ğ½Ğ¾Ğ³Ğ¾ Ğ¸Ğ·Ğ¾Ğ±Ñ€Ğ°Ğ¶ĞµĞ½Ğ¸Ñ</Label>
                <Input id="image_url" {...register("image_url")} placeholder="https://example.com/main_image.jpg" />
                {errors.image_url && <p className="text-xs text-red-600 mt-1">{errors.image_url.message}</p>}
            </div>

            <div>
                <Label htmlFor="image_urls">URL Ğ´Ğ¾Ğ¿Ğ¾Ğ»Ğ½Ğ¸Ñ‚ĞµĞ»ÑŒĞ½Ñ‹Ñ… Ğ¸Ğ·Ğ¾Ğ±Ñ€Ğ°Ğ¶ĞµĞ½Ğ¸Ğ¹ (ĞºĞ°Ğ¶Ğ´Ñ‹Ğ¹ Ñ Ğ½Ğ¾Ğ²Ğ¾Ğ¹ ÑÑ‚Ñ€Ğ¾ĞºĞ¸)</Label>
                <Controller
                    name="image_urls"
                    control={control}
                    render={({ field }) => (
                        <Textarea
                            id="image_urls"
                            placeholder={"https://example.com/image1.jpg\nhttps://example.com/image2.jpg"}
                            value={Array.isArray(field.value) ? field.value.join('\n') : ''}
                            onChange={(e) => {
                                const urls = e.target.value ? e.target.value.split('\n') : [];
                                field.onChange(urls);
                            }}
                            rows={4}
                        />
                    )}
                />
                {errors.image_urls && <p className="text-xs text-red-600 mt-1">{errors.image_urls.message as string}</p>}
            </div>

            <div>
                <Label htmlFor="serial_number">Ğ¡ĞµÑ€Ğ¸Ğ¹Ğ½Ñ‹Ğ¹ Ğ½Ğ¾Ğ¼ĞµÑ€</Label>
                <Input id="serial_number" {...register("serial_number")} />
                {errors.serial_number && <p className="text-xs text-red-600 mt-1">{errors.serial_number.message}</p>}
            </div>

            <div className="grid grid-cols-1 sm:grid-cols-2 gap-4">
                <div>
                    <Label htmlFor="condition">Ğ¡Ğ¾ÑÑ‚Ğ¾ÑĞ½Ğ¸Ğµ</Label>
                    <Input id="condition" {...register("condition")} />
                    {errors.condition && <p className="text-xs text-red-600 mt-1">{errors.condition.message}</p>}
                </div>
                <div>
                    <Label htmlFor="daily_rate">Ğ¦ĞµĞ½Ğ° Ğ·Ğ° Ğ´ĞµĞ½ÑŒ (â‚½)</Label>
                    <Controller
                        name="daily_rate"
                        control={control}
                        render={({ field }) => (
                            <Input
                                {...field}
                                id="daily_rate"
                                type="number"
                                value={field.value ?? ""}
                                onChange={(e) => {
                                    const val = e.target.value;
                                    field.onChange(val === '' ? undefined : parseFloat(val));
                                }}
                                step="0.01"
                                placeholder="0.00"
                            />
                        )}
                    />
                    {errors.daily_rate && <p className="text-xs text-red-600 mt-1">{errors.daily_rate.message}</p>}
                </div>
            </div>

            <div>
                <Label htmlFor="description">ĞĞ¿Ğ¸ÑĞ°Ğ½Ğ¸Ğµ (Markdown)</Label>
                <Controller
                    name="description"
                    control={control}
                    render={({ field }) => (
                        <div data-color-mode="light">
                            <MDEditor
                                value={field.value ?? ""}
                                onChange={(val) => field.onChange(val ?? "")}
                                previewOptions={{ rehypePlugins: [[rehypeSanitize]] }}
                                height={250}
                            />
                        </div>
                    )}
                />
                {errors.description && <p className="text-xs text-red-600 mt-1">{errors.description.message}</p>}
            </div>

            <div className="space-y-2 pt-4 border-t">
                <Label>ĞŸÑ€Ğ¸Ğ²ÑĞ·Ğ°Ğ½Ğ½Ñ‹Ğµ Ğ°ĞºÑĞµÑÑÑƒĞ°Ñ€Ñ‹</Label>
                <p className="text-sm text-muted-foreground">
                    Ğ’Ñ‹Ğ±ĞµÑ€Ğ¸Ñ‚Ğµ Ğ°ĞºÑĞµÑÑÑƒĞ°Ñ€Ñ‹, ĞºĞ¾Ñ‚Ğ¾Ñ€Ñ‹Ğµ Ğ±ÑƒĞ´ÑƒÑ‚ Ğ¿Ñ€ĞµĞ´Ğ»Ğ°Ğ³Ğ°Ñ‚ÑŒÑÑ Ğ²Ğ¼ĞµÑÑ‚Ğµ Ñ ÑÑ‚Ğ¸Ğ¼ Ğ¾Ğ±Ğ¾Ñ€ÑƒĞ´Ğ¾Ğ²Ğ°Ğ½Ğ¸ĞµĞ¼.
                </p>
                {isLoadingAccessories ? (
                    <p className="text-sm text-muted-foreground">Ğ—Ğ°Ğ³Ñ€ÑƒĞ·ĞºĞ° ÑĞ¿Ğ¸ÑĞºĞ° Ğ°ĞºÑĞµÑÑÑƒĞ°Ñ€Ğ¾Ğ²...</p>
                ) : (
                    <Controller
                        control={control}
                        name="accessory_ids"
                        render={({ field }) => (
                            <div className="space-y-2 max-h-48 overflow-y-auto rounded-md border p-4 bg-slate-50">
                                {allAccessories.map((accessory: Accessory) => ( // Ğ”Ğ¾Ğ±Ğ°Ğ²Ğ»ÑĞµĞ¼ Ñ‚Ğ¸Ğ¿ Ğ´Ğ»Ñ accessory
                                    <div key={accessory.id} className="flex items-center justify-between hover:bg-slate-100 p-2 rounded">
                                        <div className="flex items-center gap-2">
                                            <Checkbox
                                                id={`accessory-${accessory.id}`}
                                                checked={field.value?.includes(accessory.id)}
                                                onCheckedChange={(checked) => {
                                                    const currentIds = field.value ?? [];
                                                    const newIds = checked
                                                        ? [...currentIds, accessory.id]
                                                        : currentIds.filter(id => id !== accessory.id);
                                                    field.onChange(newIds);
                                                }}
                                            />
                                            <Label htmlFor={`accessory-${accessory.id}`} className="font-normal cursor-pointer">
                                                {accessory.name}
                                            </Label>
                                        </div>
                                        <span className="text-xs text-muted-foreground">{accessory.price} â‚½</span>
                                    </div>
                                ))}
                            </div>
                        )}
                    />
                )}
            </div>

            <div>
                <Label htmlFor="notes">Ğ—Ğ°Ğ¼ĞµÑ‚ĞºĞ¸ (Ğ²Ğ¸Ğ´Ğ½Ğ¾ Ñ‚Ğ¾Ğ»ÑŒĞºĞ¾ Ğ¼ĞµĞ½ĞµĞ´Ğ¶ĞµÑ€Ğ°Ğ¼/Ğ°Ğ´Ğ¼Ğ¸Ğ½Ğ°Ğ¼)</Label>
                <Textarea id="notes" {...register("notes")} rows={3} />
                {errors.notes && <p className="text-xs text-red-600 mt-1">{errors.notes.message}</p>}
            </div>

            <div>
                <Label htmlFor="last_maintenance">Ğ”Ğ°Ñ‚Ğ° Ğ¿Ğ¾ÑĞ»ĞµĞ´Ğ½ĞµĞ³Ğ¾ Ğ¢Ğ (Ğ²Ğ¸Ğ´Ğ½Ğ¾ Ñ‚Ğ¾Ğ»ÑŒĞºĞ¾ Ğ¼ĞµĞ½ĞµĞ´Ğ¶ĞµÑ€Ğ°Ğ¼/Ğ°Ğ´Ğ¼Ğ¸Ğ½Ğ°Ğ¼)</Label>
                <Input
                    id="last_maintenance"
                    type="date"
                    {...register("last_maintenance")}
                />
                {errors.last_maintenance && <p className="text-xs text-red-600 mt-1">{errors.last_maintenance.message}</p>}
            </div>

            <div className="flex justify-end gap-3 pt-4 border-t mt-6">
                <Button type="button" variant="ghost" onClick={onCancel}>
                    ĞÑ‚Ğ¼ĞµĞ½Ğ°
                </Button>
                <Button type="submit" disabled={!isDirty || !isValid || updateEquipmentMutation.isPending}>
                    {updateEquipmentMutation.isPending ? "Ğ¡Ğ¾Ñ…Ñ€Ğ°Ğ½ĞµĞ½Ğ¸Ğµ..." : "Ğ¡Ğ¾Ñ…Ñ€Ğ°Ğ½Ğ¸Ñ‚ÑŒ Ğ¸Ğ·Ğ¼ĞµĞ½ĞµĞ½Ğ¸Ñ"}
                </Button>
            </div>
        </form>
    );
}

```


## <a name="srccomponentsprofileBalanceHistoryTabletsx"></a>`src/components/profile/BalanceHistoryTable.tsx`

```tsx
// path: src/components/profile/BalanceHistoryTable.tsx

// src/components/profile/BalanceHistoryTable.tsx

import { useState } from "react";
import { useBalanceHistory, useAdminBalanceHistory } from "@/hooks/useBalanceHistory";
import {
    Table,
    TableBody,
    TableCell,
    TableHead,
    TableHeader,
    TableRow,
    TableCaption,
} from "@/components/ui/table";
import { Button } from "@/components/ui/button";
import { formatDateEuropean } from "@/lib/utils";
import { Loader2, AlertTriangle, ChevronLeft, ChevronRight, Inbox } from "lucide-react";

interface Props {
    userId: number;
    // Ğ¤Ğ»Ğ°Ğ³, Ğ¾Ğ¿Ñ€ĞµĞ´ĞµĞ»ÑÑÑ‰Ğ¸Ğ¹, Ğ¸ÑĞ¿Ğ¾Ğ»ÑŒĞ·ÑƒĞµĞ¼ Ğ»Ğ¸ Ğ¼Ñ‹ Ğ°Ğ´Ğ¼Ğ¸Ğ½ÑĞºĞ¸Ğ¹ Ñ…ÑƒĞº Ğ´Ğ»Ñ Ğ¿Ğ¾Ğ»ÑƒÑ‡ĞµĞ½Ğ¸Ñ Ğ´Ğ°Ğ½Ğ½Ñ‹Ñ…
    isAdminView?: boolean;
}

export default function BalanceHistoryTable({ userId, isAdminView = false }: Props) {
    const [currentPage, setCurrentPage] = useState(1);

    // Ğ’ Ğ·Ğ°Ğ²Ğ¸ÑĞ¸Ğ¼Ğ¾ÑÑ‚Ğ¸ Ğ¾Ñ‚ Ñ„Ğ»Ğ°Ğ³Ğ° isAdminView, Ğ¸ÑĞ¿Ğ¾Ğ»ÑŒĞ·ÑƒĞµĞ¼ ÑĞ¾Ğ¾Ñ‚Ğ²ĞµÑ‚ÑÑ‚Ğ²ÑƒÑÑ‰Ğ¸Ğ¹ Ñ…ÑƒĞº
    const queryResult = isAdminView
        ? useAdminBalanceHistory(userId, currentPage)
        : useBalanceHistory(currentPage);

    const { data: historyResponse, isLoading, isError, error } = queryResult;

    const history = historyResponse?.items ?? [];
    const totalEntries = historyResponse?.total ?? 0;
    const totalPages = Math.ceil(totalEntries / 15); // 15 - PAGE_SIZE Ğ¸Ğ· Ñ…ÑƒĞºĞ°

    if (isLoading) {
        return (
            <div className="flex items-center justify-center gap-2 text-gray-500 py-8">
                <Loader2 className="h-5 w-5 animate-spin" />
                <span>Ğ—Ğ°Ğ³Ñ€ÑƒĞ·ĞºĞ° Ğ¸ÑÑ‚Ğ¾Ñ€Ğ¸Ğ¸ Ñ‚Ñ€Ğ°Ğ½Ğ·Ğ°ĞºÑ†Ğ¸Ğ¹...</span>
            </div>
        );
    }

    if (isError) {
        return (
            <div className="flex items-center justify-center gap-2 text-red-600 bg-red-50 p-4 rounded-md">
                <AlertTriangle className="h-5 w-5" />
                <span>ĞÑˆĞ¸Ğ±ĞºĞ° Ğ·Ğ°Ğ³Ñ€ÑƒĞ·ĞºĞ¸: {error?.message || "ĞĞµ ÑƒĞ´Ğ°Ğ»Ğ¾ÑÑŒ Ğ¿Ğ¾Ğ»ÑƒÑ‡Ğ¸Ñ‚ÑŒ Ğ´Ğ°Ğ½Ğ½Ñ‹Ğµ"}</span>
            </div>
        );
    }

    if (history.length === 0) {
        return (
            <div className="text-center py-10 text-gray-500 border-2 border-dashed rounded-lg">
                <Inbox className="mx-auto h-12 w-12 text-gray-300" />
                <p className="mt-2 font-medium">Ğ˜ÑÑ‚Ğ¾Ñ€Ğ¸Ñ Ñ‚Ñ€Ğ°Ğ½Ğ·Ğ°ĞºÑ†Ğ¸Ğ¹ Ğ¿ÑƒÑÑ‚Ğ°</p>
                <p className="text-sm">Ğ—Ğ´ĞµÑÑŒ Ğ±ÑƒĞ´ÑƒÑ‚ Ğ¾Ñ‚Ğ¾Ğ±Ñ€Ğ°Ğ¶Ğ°Ñ‚ÑŒÑÑ Ğ²ÑĞµ Ğ´Ğ²Ğ¸Ğ¶ĞµĞ½Ğ¸Ñ Ğ¿Ğ¾ Ğ²Ğ°ÑˆĞµĞ¼Ñƒ ÑÑ‡ĞµÑ‚Ñƒ.</p>
            </div>
        );
    }

    return (
        <div className="space-y-4">
            <div className="border rounded-lg">
                <Table>
                    <TableCaption>
                        {totalEntries > 0 ? `ĞŸĞ¾ĞºĞ°Ğ·Ğ°Ğ½Ğ¾ ${history.length} Ğ¸Ğ· ${totalEntries} Ğ·Ğ°Ğ¿Ğ¸ÑĞµĞ¹.` : 'Ğ—Ğ°Ğ¿Ğ¸ÑĞµĞ¹ Ğ½Ğµ Ğ½Ğ°Ğ¹Ğ´ĞµĞ½Ğ¾.'}
                    </TableCaption>
                    <TableHeader>
                        <TableRow>
                            <TableHead className="w-[120px]">Ğ”Ğ°Ñ‚Ğ°</TableHead>
                            <TableHead>Ğ¢Ğ¸Ğ¿ Ğ¾Ğ¿ĞµÑ€Ğ°Ñ†Ğ¸Ğ¸</TableHead>
                            <TableHead>ĞĞ¿Ğ¸ÑĞ°Ğ½Ğ¸Ğµ</TableHead>
                            <TableHead className="text-right w-[150px]">Ğ¡ÑƒĞ¼Ğ¼Ğ°</TableHead>
                        </TableRow>
                    </TableHeader>
                    <TableBody>
                        {history.map((entry) => {
                            const amountColor = entry.amount < 0 ? 'text-red-600' : 'text-green-600';
                            const amountSign = entry.amount > 0 ? '+' : '';

                            return (
                                <TableRow key={entry.id}>
                                    <TableCell className="font-medium text-xs">
                                        {formatDateEuropean(entry.created_at)}
                                    </TableCell>
                                    <TableCell className="text-xs">{entry.operation_type}</TableCell>
                                    <TableCell className="text-xs">{entry.description}</TableCell>
                                    <TableCell className={`text-right font-semibold ${amountColor}`}>
                                        {amountSign} {entry.amount.toLocaleString('ru-RU', { style: 'currency', currency: 'RUB' })}
                                    </TableCell>
                                </TableRow>
                            );
                        })}
                    </TableBody>
                </Table>
            </div>

            {totalPages > 1 && (
                <div className="flex items-center justify-end space-x-2">
                    <span className="text-sm text-muted-foreground">
                        Ğ¡Ñ‚Ñ€Ğ°Ğ½Ğ¸Ñ†Ğ° {currentPage} Ğ¸Ğ· {totalPages}
                    </span>
                    <Button
                        variant="outline"
                        size="sm"
                        onClick={() => setCurrentPage(prev => Math.max(prev - 1, 1))}
                        disabled={currentPage === 1}
                    >
                        <ChevronLeft className="h-4 w-4 mr-1" />
                        ĞĞ°Ğ·Ğ°Ğ´
                    </Button>
                    <Button
                        variant="outline"
                        size="sm"
                        onClick={() => setCurrentPage(prev => Math.min(prev + 1, totalPages))}
                        disabled={currentPage === totalPages}
                    >
                        Ğ’Ğ¿ĞµÑ€ĞµĞ´
                        <ChevronRight className="h-4 w-4 ml-1" />
                    </Button>
                </div>
            )}
        </div>
    );
}

```


## <a name="srccomponentsrentalMyRentalCardtsx"></a>`src/components/rental/MyRentalCard.tsx`

```tsx
// path: src/components/rental/MyRentalCard.tsx

// src/components/rental/MyRentalCard.tsx

import { useState } from "react";
import { Card } from "@/components/ui/card";
import { Button } from "@/components/ui/button";
import RentalStatusBadge from "./RentalStatusBadge";
import { CalendarRange, Truck, ExternalLink, ChevronDown, Paperclip, Tag, ReceiptText, Clock, AlertTriangle } from "lucide-react";
import { useNavigate } from "react-router-dom";
import { formatDateEuropean, calculateDaysOverdue } from "@/lib/utils";
import type { AdminRentalOut } from "@/types/rental";
import { RENTAL_CARD_STYLES } from "@/constants/statusStyles";

interface MyRentalCardProps {
    rental: AdminRentalOut;
    highlightId?: number | null;
}

export default function MyRentalCard({ rental, highlightId }: MyRentalCardProps) {
    const navigate = useNavigate();
    const [expandedAccessories, setExpandedAccessories] = useState<Record<number, boolean>>({});
    
    const isHighlighted = highlightId === rental.id;
    
    const toggleAccessories = (equipmentId: number) => {
        setExpandedAccessories(prev => ({
            ...prev,
            [equipmentId]: !prev[equipmentId]
        }));
    };
    
    
    const start = rental.start_date ? new Date(rental.start_date) : null;
    const end = rental.end_date ? new Date(rental.end_date) : null;
    const actualReturn = rental.actual_return_date ? new Date(rental.actual_return_date) : null;

    const handleReservationClick = () => {
        if (rental.reservation_id) {
            navigate("/reservations/my", { 
                state: { 
                    highlightReservationId: rental.reservation_id,
                    from: "rental"
                } 
            });
        }
    };

    // Ğ›Ğ¾Ğ³Ğ¸ĞºĞ° Ğ´Ğ»Ñ ÑÑ‚Ğ¸Ğ»Ğ¸Ğ·Ğ°Ñ†Ğ¸Ğ¸ ĞºĞ°Ñ€Ñ‚Ğ¾Ñ‡ĞºĞ¸ Ğ² Ğ·Ğ°Ğ²Ğ¸ÑĞ¸Ğ¼Ğ¾ÑÑ‚Ğ¸ Ğ¾Ñ‚ ÑÑ‚Ğ°Ñ‚ÑƒÑĞ°
    const statusClass = RENTAL_CARD_STYLES[rental.status] || RENTAL_CARD_STYLES.default;

    return (
        <Card 
            className={`p-4 space-y-4 transition-all duration-300 ${statusClass} ${isHighlighted ? "ring-2 ring-orange-500 shadow-lg" : ""}`}
        >
            {/* Ğ—Ğ°Ğ³Ğ¾Ğ»Ğ¾Ğ²Ğ¾Ğº Ñ ID Ğ¸ ÑÑ‚Ğ°Ñ‚ÑƒÑĞ¾Ğ¼ */}
            <div className="flex items-center justify-between">
                <div className="flex items-center gap-3">
                    <Truck className="w-5 h-5 text-orange-600" />
                    <h3 className="text-lg font-semibold text-gray-900">
                        ĞÑ€ĞµĞ½Ğ´Ğ° #{rental.id}
                    </h3>
                </div>
                <div className="flex items-center gap-2">
                    <RentalStatusBadge status={rental.status} />
                    {/* Ğ¡ÑÑ‹Ğ»ĞºĞ° Ğ½Ğ° Ñ€ĞµĞ·ĞµÑ€Ğ² */}
                    {rental.reservation_id && (
                        <Button
                            variant="outline"
                            size="sm"
                            onClick={handleReservationClick}
                            className="text-sky-600 hover:text-sky-700 hover:bg-sky-50 border-sky-200"
                        >
                            <ExternalLink className="w-3 h-3 mr-1" />
                            Ğ ĞµĞ·ĞµÑ€Ğ² #{rental.reservation_id}
                        </Button>
                    )}
                </div>
            </div>

            {/* Ğ”Ğ°Ñ‚Ñ‹ */}
            <div className="flex items-center gap-2 text-sm text-gray-600">
                <CalendarRange className="w-4 h-4" />
                <span>
                    {start && end && (
                        <>
                            {formatDateEuropean(start)} - {formatDateEuropean(end)}
                        </>
                    )}
                </span>
            </div>

            {/* Ğ¤Ğ°ĞºÑ‚Ğ¸Ñ‡ĞµÑĞºĞ°Ñ Ğ´Ğ°Ñ‚Ğ° Ğ²Ğ¾Ğ·Ğ²Ñ€Ğ°Ñ‚Ğ° */}
            {actualReturn && (
                <div className="text-sm text-gray-600">
                    <span className="font-medium">Ğ’Ğ¾Ğ·Ğ²Ñ€Ğ°Ñ‚:</span> {formatDateEuropean(actualReturn)}
                </div>
            )}

            {/* Ğ¡Ğ¾ÑÑ‚Ğ°Ğ² Ğ°Ñ€ĞµĞ½Ğ´Ñ‹ */}
            <div className="space-y-2 pt-3 border-t">
                <h4 className="font-medium text-sm text-gray-800">Ğ¡Ğ¾ÑÑ‚Ğ°Ğ² Ğ°Ñ€ĞµĞ½Ğ´Ñ‹:</h4>
                <div className="space-y-2">
                    {rental.equipment.map((item) => {
                        const accessoriesForItem = rental.accessory_links?.filter(link => link.equipment_id === item.id);
                        return (
                            <div key={item.id} className="text-sm text-gray-700 bg-gray-50/70 p-2 rounded-md border">
                                <p>â€¢ {item.name}</p>
                                {accessoriesForItem && accessoriesForItem.length > 0 && (
                                    <div className="mt-2 pl-4">
                                        <button onClick={() => toggleAccessories(item.id)} className="flex items-center text-xs text-sky-700 hover:underline font-medium">
                                            <Paperclip className="w-3 h-3 mr-1" />
                                            ĞĞºÑĞµÑÑÑƒĞ°Ñ€Ñ‹ ({accessoriesForItem.length})
                                            <ChevronDown className={`w-4 h-4 ml-1 transition-transform ${expandedAccessories[item.id] ? 'rotate-180' : ''}`} />
                                        </button>
                                        {expandedAccessories[item.id] && (
                                            <ul className="list-disc list-inside text-xs text-gray-600 mt-1 pl-2 animate-in fade-in duration-200">
                                                {accessoriesForItem.map(link => (
                                                    <li key={link.accessory.id}>{link.accessory.name}</li>
                                                ))}
                                            </ul>
                                        )}
                                    </div>
                                )}
                            </div>
                        );
                    })}
                </div>
            </div>

            {/* Ğ¤Ğ¸Ğ½Ğ°Ğ½ÑĞ¾Ğ²Ñ‹Ğ¹ Ğ±Ğ»Ğ¾Ğº Ñ Ñ‚Ğ°Ğ¹Ğ¼ĞµÑ€Ğ¾Ğ¼ */}
            <div className="flex items-start justify-between pt-3 border-t flex-wrap-reverse gap-4">
                {/* Ğ¤Ğ¸Ğ½Ğ°Ğ½ÑĞ¾Ğ²Ñ‹Ğ¹ Ğ±Ğ»Ğ¾Ğº */}
                <div className="text-xs space-y-1.5 text-slate-700 flex-grow">
                    <h4 className="font-semibold text-sm text-slate-800 flex items-center gap-2 mb-2"><ReceiptText className="w-4 h-4"/>Ğ¤Ğ¸Ğ½Ğ°Ğ½ÑÑ‹</h4>
                    <div className="flex justify-between gap-4"><span>Ğ¡Ñ‚Ğ¾Ğ¸Ğ¼Ğ¾ÑÑ‚ÑŒ Ğ°Ñ€ĞµĞ½Ğ´Ñ‹:</span> <span className="font-medium">{rental.total_cost.toLocaleString('ru-RU')} â‚½</span></div>
                    {rental.discount_amount > 0 && (
                        <div className="flex justify-between gap-4 text-green-600"><span>Ğ¡ĞºĞ¸Ğ´ĞºĞ°:</span> <span className="font-medium">- {rental.discount_amount.toLocaleString('ru-RU')} â‚½</span></div>
                    )}
                    {rental.promo_code && (
                        <div className="flex justify-between items-center gap-4 text-purple-600"><span>ĞŸÑ€Ğ¾Ğ¼Ğ¾ĞºĞ¾Ğ´:</span> <span className="font-medium flex items-center gap-1"><Tag className="w-3 h-3"/>{rental.promo_code}</span></div>
                    )}
                    {rental.overdue_surcharge && rental.overdue_surcharge > 0 && (
                        <div className="flex justify-between gap-4 text-red-600 font-bold pt-1 border-t border-dashed mt-1"><span>Ğ”Ğ¾Ğ¿Ğ»Ğ°Ñ‚Ğ° Ğ·Ğ° Ğ¿Ñ€Ğ¾ÑÑ€Ğ¾Ñ‡ĞºÑƒ:</span> <span>{rental.overdue_surcharge.toLocaleString('ru-RU')} â‚½</span></div>
                    )}
                </div>
                
                {/* Ğ¢Ğ°Ğ¹Ğ¼ĞµÑ€ ÑÑ‚Ğ°Ñ‚ÑƒÑĞ° */}
                {(() => {
                    if (rental.status === 'overdue') {
                        const daysOverdue = calculateDaysOverdue(rental.end_date, rental.overdue_days);
                        return (
                            <div className="flex items-center gap-2 px-2 py-1 rounded-md border text-xs font-medium text-red-600 bg-red-100/60 border-red-200">
                                <AlertTriangle className="w-4 h-4"/>
                                {`ĞŸÑ€Ğ¾ÑÑ€Ğ¾Ñ‡ĞµĞ½Ğ° Ğ½Ğ° ${daysOverdue} Ğ´Ğ½.`}
                            </div>
                        );
                    }
                    if (rental.status === 'active' && rental.days_remaining !== null) {
                        const daysLeft = rental.days_remaining;
                        if (daysLeft <= 1) {
                            return (
                                <div className="flex items-center gap-2 px-2 py-1 rounded-md border text-xs font-medium text-orange-600 bg-orange-100/60 border-orange-200">
                                    <Clock className="w-4 h-4"/>
                                    {`ĞÑÑ‚Ğ°Ğ»ÑÑ ${daysLeft} Ğ´ĞµĞ½ÑŒ`}
                                </div>
                            );
                        }
                        return (
                            <div className="flex items-center gap-2 px-2 py-1 rounded-md border text-xs font-medium text-green-700 bg-green-100/60 border-green-200">
                                <Clock className="w-4 h-4"/>
                                {`ĞÑÑ‚Ğ°Ğ»Ğ¾ÑÑŒ ${daysLeft} Ğ´Ğ½.`}
                            </div>
                        );
                    }
                    return null;
                })()}
            </div>


            {/* Ğ—Ğ°Ğ¼ĞµÑ‚ĞºĞ¸ */}
            {rental.notes_on_issue && (
                <div className="pt-2 border-t">
                    <div className="text-sm">
                        <span className="font-medium text-gray-700">Ğ—Ğ°Ğ¼ĞµÑ‚ĞºĞ¸ Ğ¿Ñ€Ğ¸ Ğ²Ñ‹Ğ´Ğ°Ñ‡Ğµ:</span>
                        <p className="text-gray-600 mt-1">{rental.notes_on_issue}</p>
                    </div>
                </div>
            )}

            {rental.notes_on_return && (
                <div className="pt-2 border-t">
                    <div className="text-sm">
                        <span className="font-medium text-gray-700">Ğ—Ğ°Ğ¼ĞµÑ‚ĞºĞ¸ Ğ¿Ñ€Ğ¸ Ğ²Ğ¾Ğ·Ğ²Ñ€Ğ°Ñ‚Ğµ:</span>
                        <p className="text-gray-600 mt-1">{rental.notes_on_return}</p>
                    </div>
                </div>
            )}
        </Card>
    );
}


```


## <a name="srccomponentsrentalMyRentalsListtsx"></a>`src/components/rental/MyRentalsList.tsx`

```tsx
// path: src/components/rental/MyRentalsList.tsx

// src/components/rental/MyRentalsList.tsx

import { useMemo } from "react";
import { useMyRentals } from "@/hooks/useMyRentals";
import MyRentalCard from "./MyRentalCard";
import { Button } from "@/components/ui/button";
import { RefreshCw, Truck } from "lucide-react";

interface MyRentalsListProps {
    highlightId?: number | null;
    rentalsData?: any;
}

const LoadingState = () => (
    <div className="text-center py-8">
        <div className="flex items-center justify-center mb-4">
            <RefreshCw className="w-8 h-8 animate-spin text-orange-600" />
        </div>
        <p className="text-gray-600">Ğ—Ğ°Ğ³Ñ€ÑƒĞ·ĞºĞ° Ğ°Ñ€ĞµĞ½Ğ´...</p>
    </div>
);

const ErrorState = ({ message, onRetry }: { message: string; onRetry: () => void }) => (
    <div className="text-center py-8">
        <div className="flex items-center justify-center mb-4">
            <Truck className="w-8 h-8 text-gray-400" />
        </div>
        <p className="text-red-600 mb-4">{message}</p>
        <Button onClick={onRetry} variant="outline" size="sm">
            <RefreshCw className="w-4 h-4 mr-2" />
            ĞŸĞ¾Ğ¿Ñ€Ğ¾Ğ±Ğ¾Ğ²Ğ°Ñ‚ÑŒ ÑĞ½Ğ¾Ğ²Ğ°
        </Button>
    </div>
);

const EmptyState = () => (
    <div className="text-center py-12">
        <div className="flex items-center justify-center mb-4">
            <Truck className="w-12 h-12 text-gray-400" />
        </div>
        <h3 className="text-lg font-medium text-gray-900 mb-2">ĞĞµÑ‚ Ğ°Ñ€ĞµĞ½Ğ´</h3>
        <p className="text-gray-600">
            Ğ£ Ğ²Ğ°Ñ Ğ¿Ğ¾ĞºĞ° Ğ½ĞµÑ‚ Ğ°ĞºÑ‚Ğ¸Ğ²Ğ½Ñ‹Ñ… Ğ¸Ğ»Ğ¸ Ğ·Ğ°Ğ²ĞµÑ€ÑˆĞµĞ½Ğ½Ñ‹Ñ… Ğ°Ñ€ĞµĞ½Ğ´.
        </p>
    </div>
);

export default function MyRentalsList({ highlightId, rentalsData: propRentalsData }: MyRentalsListProps) {
    const { data, isLoading, isError, error, fetchNextPage, hasNextPage, isFetchingNextPage, refetch } = useMyRentals();

    // Ğ˜ÑĞ¿Ğ¾Ğ»ÑŒĞ·ÑƒĞµĞ¼ Ğ´Ğ°Ğ½Ğ½Ñ‹Ğµ Ğ¸Ğ· Ğ¿Ñ€Ğ¾Ğ¿ÑĞ¾Ğ² Ğ¸Ğ»Ğ¸ Ğ·Ğ°Ğ³Ñ€ÑƒĞ¶Ğ°ĞµĞ¼ Ğ¸Ñ… ÑĞ°Ğ¼Ğ¾ÑÑ‚Ğ¾ÑÑ‚ĞµĞ»ÑŒĞ½Ğ¾
    const allRentals = useMemo(() => {
        if (propRentalsData?.pages) {
            return propRentalsData.pages.flatMap(page => page.items);
        }
        if (data?.pages) {
            return data.pages.flatMap(page => page.items);
        }
        return [];
    }, [propRentalsData, data]);

    if (isLoading) {
        return <LoadingState />;
    }

    if (isError) {
        return (
            <ErrorState 
                message={error?.message || "ĞÑˆĞ¸Ğ±ĞºĞ° Ğ¿Ñ€Ğ¸ Ğ·Ğ°Ğ³Ñ€ÑƒĞ·ĞºĞµ Ğ°Ñ€ĞµĞ½Ğ´"} 
                onRetry={() => refetch()} 
            />
        );
    }

    if (allRentals.length === 0) {
        return <EmptyState />;
    }

    return (
        <div className="space-y-4">
            {/* Ğ¡Ğ¿Ğ¸ÑĞ¾Ğº Ğ°Ñ€ĞµĞ½Ğ´ */}
            <div className="space-y-4">
                {allRentals.map((rental) => (
                    <MyRentalCard 
                        key={rental.id} 
                        rental={rental} 
                        highlightId={highlightId}
                    />
                ))}
            </div>

            {/* ĞšĞ½Ğ¾Ğ¿ĞºĞ° Ğ·Ğ°Ğ³Ñ€ÑƒĞ·ĞºĞ¸ Ğ´Ğ¾Ğ¿Ğ¾Ğ»Ğ½Ğ¸Ñ‚ĞµĞ»ÑŒĞ½Ñ‹Ñ… Ğ°Ñ€ĞµĞ½Ğ´ */}
            {hasNextPage && (
                <div className="text-center pt-4">
                    <Button
                        onClick={() => fetchNextPage()}
                        disabled={isFetchingNextPage}
                        variant="outline"
                        size="sm"
                    >
                        {isFetchingNextPage ? (
                            <>
                                <RefreshCw className="w-4 h-4 mr-2 animate-spin" />
                                Ğ—Ğ°Ğ³Ñ€ÑƒĞ·ĞºĞ°...
                            </>
                        ) : (
                            "Ğ—Ğ°Ğ³Ñ€ÑƒĞ·Ğ¸Ñ‚ÑŒ ĞµÑ‰Ğµ"
                        )}
                    </Button>
                </div>
            )}
        </div>
    );
}


```


## <a name="srccomponentsrentalRentalStatusBadgetsx"></a>`src/components/rental/RentalStatusBadge.tsx`

```tsx
// path: src/components/rental/RentalStatusBadge.tsx

// src/components/rental/RentalStatusBadge.tsx

import { Badge } from "@/components/ui/badge";

type Status = 'active' | 'overdue' | 'completed';

interface Props {
    status: Status;
}

const statusConfig: Record<Status, { text: string; className: string }> = {
    active: {
        text: "ĞĞºÑ‚Ğ¸Ğ²Ğ½Ğ°",
        className: "bg-green-100 text-green-800 border-green-200",
    },
    overdue: {
        text: "ĞŸÑ€Ğ¾ÑÑ€Ğ¾Ñ‡ĞµĞ½Ğ°",
        className: "bg-orange-100 text-orange-800 border-orange-200",
    },
    completed: {
        text: "Ğ—Ğ°Ğ²ĞµÑ€ÑˆĞµĞ½Ğ°",
        className: "bg-gray-100 text-gray-800 border-gray-200",
    },
};

export default function RentalStatusBadge({ status }: Props) {
    const config = statusConfig[status] || statusConfig.completed;

    return (
        <Badge variant="outline" className={`font-medium ${config.className}`}>
            {config.text}
        </Badge>
    );
}


```


## <a name="srccomponentsreservationAvailableAccessoriesDropdowntsx"></a>`src/components/reservation/AvailableAccessoriesDropdown.tsx`

```tsx
// path: src/components/reservation/AvailableAccessoriesDropdown.tsx

// src/components/reservation/AvailableAccessoriesDropdown.tsx

import { useState } from 'react';
import { Paperclip, ChevronDown, PlusCircle } from 'lucide-react';
import { Button } from '@/components/ui/button';
import { Accessory } from '@/types/accessory';

interface Props {
    accessories: Accessory[];
    equipmentId: number;
    onToggleAccessory: (equipmentId: number, accessoryId: number) => void;
    disabled?: boolean;
    hasTopBorder: boolean;
}

export const AvailableAccessoriesDropdown = ({ accessories, equipmentId, onToggleAccessory, disabled, hasTopBorder }: Props) => {
    const [isExpanded, setExpanded] = useState(false);

    if (accessories.length === 0) {
        return null;
    }

    return (
        <div className={`pt-2 mt-2 ${hasTopBorder ? 'border-t border-dashed' : ''}`}>
            <button
                className="w-full flex justify-between items-center text-sm font-medium text-gray-600 hover:text-sky-700 p-1 -m-1 rounded"
                onClick={(e) => { e.stopPropagation(); setExpanded(p => !p); }}
                aria-expanded={isExpanded}
                disabled={disabled}
            >
                <span className="flex items-center gap-2">
                    <Paperclip className="w-4 h-4" />
                    Ğ”Ğ¾Ğ±Ğ°Ğ²Ğ¸Ñ‚ÑŒ Ğ°ĞºÑĞµÑÑÑƒĞ°Ñ€Ñ‹ ({accessories.length})
                </span>
                <ChevronDown className={`w-5 h-5 transition-transform ${isExpanded ? 'rotate-180' : ''}`} />
            </button>
            {isExpanded && (
                <div className="mt-2 space-y-1 pl-1 animate-in fade-in-0 slide-in-from-top-2 duration-300">
                    {accessories.map(acc => (
                        <div key={acc.id} className="flex items-center justify-between p-1 rounded hover:bg-gray-50">
                            <span className="text-xs font-normal">
                                {acc.name} ({acc.price} â‚½)
                            </span>
                            <Button
                                size="sm"
                                variant="ghost"
                                className="h-6 px-2 text-xs"
                                onClick={() => onToggleAccessory(equipmentId, acc.id)}
                                disabled={disabled}
                            >
                                <PlusCircle className="w-3.5 h-3.5 mr-1" />
                                Ğ”Ğ¾Ğ±Ğ°Ğ²Ğ¸Ñ‚ÑŒ
                            </Button>
                        </div>
                    ))}
                </div>
            )}
        </div>
    );
}

```


## <a name="srccomponentsreservationEditableDateRangetsx"></a>`src/components/reservation/EditableDateRange.tsx`

```tsx
// path: src/components/reservation/EditableDateRange.tsx

// src/components/reservation/EditableDateRange.tsx

import { CalendarRange } from "lucide-react";
import { useDateRange } from "@/hooks/useDateRange";
import { formatDate, formatDateEuropean } from "@/lib/utils";

interface EditableDateRangeProps {
    startDate: Date;
    endDate: Date;
    onChange: (startDate: Date, endDate: Date, source?: 'calendar' | 'slider' | 'manual') => void;
    disabled?: boolean;
}

export default function EditableDateRange({
                                              startDate,
                                              endDate,
                                              onChange,
                                              disabled = false
                                          }: EditableDateRangeProps) {
    const {
        localStartDate,
        localEndDate,
        handleStartDateChange,
        handleEndDateChange
    } = useDateRange({
        // âœ… Ğ˜Ğ¡ĞŸĞ ĞĞ’Ğ›Ğ•ĞĞ: ĞœĞµĞ½ÑĞµĞ¼ initialStartDate/initialEndDate Ğ½Ğ° startDate/endDate
        startDate: startDate,
        endDate: endDate,
        onRangeChange: onChange
    });

    const today = formatDate(new Date());

    return (
        <div className="space-y-3">
            <div className="flex items-center gap-2 text-sm font-medium text-gray-700">
                <CalendarRange className="w-4 h-4" />
                Ğ”Ğ°Ñ‚Ñ‹ Ñ€ĞµĞ·ĞµÑ€Ğ²Ğ°:
            </div>

            <div className="grid grid-cols-1 sm:grid-cols-2 gap-3">
                <div className="space-y-1">
                    <label htmlFor="edit-start-date" className="block text-xs text-gray-600">
                        ĞĞ°Ñ‡Ğ°Ğ»Ğ¾:
                    </label>
                    <input
                        id="edit-start-date"
                        type="date"
                        value={localStartDate}
                        onChange={handleStartDateChange}
                        disabled={disabled}
                        min={today}
                        className={`w-full px-3 py-2 text-sm border rounded-md focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-colors ${
                            disabled
                                ? 'bg-gray-100 cursor-not-allowed'
                                : 'bg-white hover:border-blue-300'
                        }`}
                    />
                    <div className="text-xs text-gray-500">
                        {formatDateEuropean(new Date(localStartDate))}
                    </div>
                </div>

                <div className="space-y-1">
                    <label htmlFor="edit-end-date" className="block text-xs text-gray-600">
                        ĞĞºĞ¾Ğ½Ñ‡Ğ°Ğ½Ğ¸Ğµ:
                    </label>
                    <input
                        id="edit-end-date"
                        type="date"
                        value={localEndDate}
                        onChange={handleEndDateChange}
                        disabled={disabled}
                        min={localStartDate}
                        className={`w-full px-3 py-2 text-sm border rounded-md focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-colors ${
                            disabled
                                ? 'bg-gray-100 cursor-not-allowed'
                                : 'bg-white hover:border-blue-300'
                        }`}
                    />
                    <div className="text-xs text-gray-500">
                        {formatDateEuropean(new Date(localEndDate))}
                    </div>
                </div>
            </div>
        </div>
    );
}

```


## <a name="srccomponentsreservationEditableEquipmentItemtsx"></a>`src/components/reservation/EditableEquipmentItem.tsx`

```tsx
// path: src/components/reservation/EditableEquipmentItem.tsx

// src/components/reservation/EditableEquipmentItem.tsx
import { X } from "lucide-react";
import EquipmentItemWithConflicts from "./EquipmentItemWithConflicts";
import { AvailableAccessoriesDropdown } from "./AvailableAccessoriesDropdown"; // <-- ĞĞ¾Ğ²Ñ‹Ğ¹ Ğ¸Ğ¼Ğ¿Ğ¾Ñ€Ñ‚
import type { Equipment } from "@/types/equipment";
import type { AvailabilityInfo } from "@/types/availability";
import { Button } from "@/components/ui/button";

interface Props {
    itemDetail: { id: number; label: string };
    fullEquipmentItem: Equipment | undefined;
    isNew: boolean;
    hasConflict: boolean;
    availability?: AvailabilityInfo;
    selectedAccessoryIds: number[];
    onRemove: (id: number) => void;
    onToggleAccessory: (equipmentId: number, accessoryId: number) => void;
    disabled?: boolean;
}

export default function EditableEquipmentItem({
                                                  itemDetail,
                                                  fullEquipmentItem,
                                                  isNew,
                                                  hasConflict,
                                                  availability,
                                                  selectedAccessoryIds,
                                                  onRemove,
                                                  onToggleAccessory,
                                                  disabled
                                              }: Props) {

    if (!fullEquipmentItem) {
        return <div className="p-3 bg-gray-100 rounded-md text-sm text-red-600">ĞÑˆĞ¸Ğ±ĞºĞ°: Ğ´Ğ°Ğ½Ğ½Ñ‹Ğµ Ğ¾Ğ±Ğ¾Ñ€ÑƒĞ´Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ Ğ½Ğµ Ğ½Ğ°Ğ¹Ğ´ĞµĞ½Ñ‹.</div>;
    }

    // Ğ Ğ°Ğ·Ğ´ĞµĞ»ÑĞµĞ¼ Ğ°ĞºÑĞµÑÑÑƒĞ°Ñ€Ñ‹ Ğ½Ğ° ÑƒĞ¶Ğµ Ğ²Ñ‹Ğ±Ñ€Ğ°Ğ½Ğ½Ñ‹Ğµ Ğ¸ Ğ´Ğ¾ÑÑ‚ÑƒĞ¿Ğ½Ñ‹Ğµ Ğ´Ğ»Ñ Ğ²Ñ‹Ğ±Ğ¾Ñ€Ğ°
    const selectedAccessoryDetails = fullEquipmentItem.accessories?.filter(
        acc => selectedAccessoryIds.includes(acc.id)
    ) || [];

    const availableAccessoriesDetails = fullEquipmentItem.accessories?.filter(
        acc => !selectedAccessoryIds.includes(acc.id)
    ) || [];


    return (
        <div className="bg-white p-3 rounded-md border">
            {/* Ğ‘Ğ»Ğ¾Ğº Ñ Ğ¾ÑĞ½Ğ¾Ğ²Ğ½Ğ¾Ğ¹ Ğ¸Ğ½Ñ„Ğ¾Ñ€Ğ¼Ğ°Ñ†Ğ¸ĞµĞ¹ Ğ¾Ğ± Ğ¾Ğ±Ğ¾Ñ€ÑƒĞ´Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğ¸ (Ğ±ĞµĞ· Ğ¸Ğ·Ğ¼ĞµĞ½ĞµĞ½Ğ¸Ğ¹) */}
            <EquipmentItemWithConflicts
                item={itemDetail}
                isNew={isNew}
                hasConflict={hasConflict}
                availability={availability}
                onRemove={onRemove}
                disabled={disabled}
            />

            {/* Ğ‘Ğ»Ğ¾Ğº Ğ´Ğ»Ñ ÑƒĞ¶Ğµ Ğ´Ğ¾Ğ±Ğ°Ğ²Ğ»ĞµĞ½Ğ½Ñ‹Ñ… Ğ°ĞºÑĞµÑÑÑƒĞ°Ñ€Ğ¾Ğ² */}
            {selectedAccessoryDetails.length > 0 && (
                <div className="pl-8 pr-2 pt-2 border-t mt-2">
                    <p className="text-xs font-medium text-gray-500 mb-1">Ğ”Ğ¾Ğ±Ğ°Ğ²Ğ»ĞµĞ½Ğ½Ñ‹Ğµ Ğ°ĞºÑĞµÑÑÑƒĞ°Ñ€Ñ‹:</p>
                    <ul className="space-y-1">
                        {selectedAccessoryDetails.map(acc => (
                            <li key={acc.id} className="flex justify-between items-center text-xs text-gray-800 hover:bg-slate-50 p-1 rounded">
                                <span>- {acc.name} <strong>({acc.price} â‚½)</strong></span>
                                <Button
                                    variant="ghost"
                                    size="icon"
                                    className="h-5 w-5 text-gray-400 hover:bg-red-50 hover:text-red-600"
                                    onClick={() => onToggleAccessory(fullEquipmentItem.id, acc.id)}
                                    disabled={disabled}
                                    title="Ğ£Ğ±Ñ€Ğ°Ñ‚ÑŒ Ğ°ĞºÑĞµÑÑÑƒĞ°Ñ€"
                                >
                                    <X className="w-3 h-3" />
                                </Button>
                            </li>
                        ))}
                    </ul>
                </div>
            )}

            {/* Ğ’Ñ‹Ğ¿Ğ°Ğ´Ğ°ÑÑ‰Ğ¸Ğ¹ ÑĞ¿Ğ¸ÑĞ¾Ğº Ğ´Ğ»Ñ Ğ´Ğ¾Ğ±Ğ°Ğ²Ğ»ĞµĞ½Ğ¸Ñ Ğ½Ğ¾Ğ²Ñ‹Ñ… Ğ°ĞºÑĞµÑÑÑƒĞ°Ñ€Ğ¾Ğ² */}
            <AvailableAccessoriesDropdown
                accessories={availableAccessoriesDetails}
                equipmentId={fullEquipmentItem.id}
                onToggleAccessory={onToggleAccessory}
                disabled={disabled}
                hasTopBorder={selectedAccessoryDetails.length > 0}
            />
        </div>
    );
}

```


## <a name="srccomponentsreservationEditableReservationCardtsx"></a>`src/components/reservation/EditableReservationCard.tsx`

```tsx
// path: src/components/reservation/EditableReservationCard.tsx

// src/components/reservation/EditableReservationCard.tsx

import React from "react"; // âœ… Ğ£Ğ±Ñ€Ğ°Ğ»Ğ¸ Ğ½ĞµĞ¸ÑĞ¿Ğ¾Ğ»ÑŒĞ·ÑƒĞµĞ¼Ñ‹Ğ¹ useMemo
import { Card } from "@/components/ui/card";
import { Button } from "@/components/ui/button";
import { Badge } from "@/components/ui/badge";
import { Loader2, Plus, Save, X, AlertTriangle, Sparkles } from "lucide-react";
import EditableDateRange from "./EditableDateRange";
import FinancialSummaryBlock from "@/components/shared/FinancialSummaryBlock";
import EditableEquipmentItem from "./EditableEquipmentItem";
import { useReservationEditContext } from "@/contexts/ReservationEditContext";
import { useNavigate } from "react-router-dom";
import HolidayConfirmationDialog from "./HolidayConfirmationDialog";
import { formatDateEuropean } from "@/lib/utils"; // âœ… Ğ”Ğ¾Ğ±Ğ°Ğ²Ğ¸Ğ»Ğ¸ Ğ½ĞµĞ´Ğ¾ÑÑ‚Ğ°ÑÑ‰Ğ¸Ğ¹ Ğ¸Ğ¼Ğ¿Ğ¾Ñ€Ñ‚

export default function EditableReservationCard() {
    const {
        reservationId,
        editState,
        availabilityMap,
        equipmentMap,
        hasConflicts,
        saveChanges,
        cancelEdit,
        updateDates,
        removeEquipmentItem,
        isLoading,
        isCheckingAvailability,
        isSaving,
        localSelectedAccessories,
        toggleAccessory,
        holidayConflict,
        confirmHolidayAdjustment,
        cancelHolidayAdjustment,
        priceDetails,
        financials,
        setPromoCode,
        applyPromoCode,
        removePromoCode,
    } = useReservationEditContext();

    const navigate = useNavigate();

    const displayNewItemsCount = editState.newlyAddedEquipmentIdsAsArray.length;
    const equipmentToDisplay = editState.currentEquipmentDetails;
    const totalItemsInEdit = equipmentToDisplay.length;

    const onAddEquipment = () => {
        navigate("/", {
            state: {
                intent: "add_to_reservation",
                reservationId: reservationId,
                equipmentIds: editState.currentEquipmentDetails.map(eq => eq.id),
                startDate: editState.startDate.toISOString(),
                endDate: editState.endDate.toISOString(),
            }
        });
    };

    return (
        <>
            <Card className="w-full px-5 py-4 rounded-2xl border shadow-md bg-blue-50 border-blue-300 transition-all">
                <div className="space-y-4">
                    <div className="flex justify-between items-center">
                        <div className="flex items-center gap-2">
                            <div className="text-base font-semibold text-blue-700">
                                âœï¸ Ğ ĞµĞ´Ğ°ĞºÑ‚Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ Ñ€ĞµĞ·ĞµÑ€Ğ²Ğ° #{reservationId}
                            </div>
                            {isCheckingAvailability && (
                                <div className="flex items-center gap-1 text-xs text-blue-600">
                                    <Loader2 className="w-3 h-3 animate-spin" />
                                    ĞŸÑ€Ğ¾Ğ²ĞµÑ€ĞºĞ° Ğ´Ğ¾ÑÑ‚ÑƒĞ¿Ğ½Ğ¾ÑÑ‚Ğ¸...
                                </div>
                            )}
                        </div>
                        <div className="flex items-center gap-2">
                            <Badge variant="outline" className="bg-blue-100 text-blue-700 border-blue-300">
                                Ğ ĞµĞ´Ğ°ĞºÑ‚Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ
                            </Badge>
                            {displayNewItemsCount > 0 && (
                                <Badge variant="outline" className="bg-green-100 text-green-700 border-green-300">
                                    <Sparkles className="w-3 h-3 mr-1" />
                                    +{displayNewItemsCount} Ğ½Ğ¾Ğ²Ñ‹Ñ…
                                </Badge>
                            )}
                        </div>
                    </div>

                    <div className="grid grid-cols-1 md:grid-cols-3 gap-6">
                        <div className="md:col-span-2 space-y-4">
                            {hasConflicts && (
                                <div className="flex items-start gap-2 p-3 bg-red-50 border border-red-200 rounded-md">
                                    <AlertTriangle className="w-4 h-4 text-red-600 mt-0.5 flex-shrink-0" />
                                    <div className="text-sm text-red-700">
                                        <div className="font-medium">ĞĞ±Ğ½Ğ°Ñ€ÑƒĞ¶ĞµĞ½Ñ‹ ĞºĞ¾Ğ½Ñ„Ğ»Ğ¸ĞºÑ‚Ñ‹!</div>
                                        <div className="text-xs mt-1">
                                            ĞĞµĞºĞ¾Ñ‚Ğ¾Ñ€Ğ¾Ğµ Ğ¾Ğ±Ğ¾Ñ€ÑƒĞ´Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ Ğ½ĞµĞ´Ğ¾ÑÑ‚ÑƒĞ¿Ğ½Ğ¾ Ğ½Ğ° Ğ²Ñ‹Ğ±Ñ€Ğ°Ğ½Ğ½Ñ‹Ğµ Ğ´Ğ°Ñ‚Ñ‹.
                                            ĞŸĞ¾Ğ¶Ğ°Ğ»ÑƒĞ¹ÑÑ‚Ğ°, Ğ¸ÑĞ¿Ñ€Ğ°Ğ²ÑŒÑ‚Ğµ ĞºĞ¾Ğ½Ñ„Ğ»Ğ¸ĞºÑ‚Ñ‹ Ğ¿ĞµÑ€ĞµĞ´ ÑĞ¾Ñ…Ñ€Ğ°Ğ½ĞµĞ½Ğ¸ĞµĞ¼.
                                        </div>
                                    </div>
                                </div>
                            )}

                            <EditableDateRange
                                startDate={editState.startDate}
                                endDate={editState.endDate}
                                onChange={updateDates}
                                disabled={isLoading}
                            />

                            <div className="space-y-3">
                                <div className="flex justify-between items-center">
                                    <div className="text-sm font-medium text-gray-700">
                                        ĞĞ±Ğ¾Ñ€ÑƒĞ´Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ ({totalItemsInEdit} Ğ¿Ğ¾Ğ·.
                                        {displayNewItemsCount > 0 && (
                                            <span className="text-green-600">
                                                , Ğ¸Ğ· Ğ½Ğ¸Ñ… {displayNewItemsCount} Ğ½Ğ¾Ğ²Ñ‹Ñ…
                                            </span>
                                        )}
                                        ):
                                    </div>
                                    <Button
                                        variant="outline"
                                        size="sm"
                                        onClick={onAddEquipment}
                                        disabled={isLoading}
                                        className="text-xs px-3 py-1 h-7"
                                    >
                                        <Plus className="w-3 h-3 mr-1" />
                                        Ğ”Ğ¾Ğ±Ğ°Ğ²Ğ¸Ñ‚ÑŒ
                                    </Button>
                                </div>
                                {totalItemsInEdit === 0 ? (
                                    <div className="text-sm text-gray-500 text-center py-6 border border-dashed border-gray-300 rounded-md">
                                        ĞĞµÑ‚ Ğ¾Ğ±Ğ¾Ñ€ÑƒĞ´Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ Ğ² Ñ€ĞµĞ·ĞµÑ€Ğ²Ğµ.{" "}
                                        <button
                                            onClick={onAddEquipment}
                                            disabled={isLoading}
                                            className="text-blue-600 hover:underline"
                                        >
                                            Ğ”Ğ¾Ğ±Ğ°Ğ²Ğ¸Ñ‚ÑŒ Ğ¾Ğ±Ğ¾Ñ€ÑƒĞ´Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ
                                        </button>
                                    </div>
                                ) : (
                                    <div className="space-y-2">
                                        {equipmentToDisplay.map((itemDetail) => {
                                            const availability = availabilityMap[itemDetail.id];
                                            const itemHasConflict = !!availability && (
                                                availability.status === "reserved" || availability.status === "rented"
                                            );
                                            const isNew = editState.newlyAddedEquipmentIdsAsArray.includes(itemDetail.id);

                                            return (
                                                <EditableEquipmentItem
                                                    key={itemDetail.id}
                                                    itemDetail={itemDetail}
                                                    fullEquipmentItem={equipmentMap.get(itemDetail.id)}
                                                    isNew={isNew}
                                                    hasConflict={itemHasConflict}
                                                    availability={availability}
                                                    selectedAccessoryIds={localSelectedAccessories[itemDetail.id] || []}
                                                    onRemove={() => removeEquipmentItem(itemDetail.id)}
                                                    onToggleAccessory={toggleAccessory}
                                                    disabled={isLoading}
                                                />
                                            );
                                        })}
                                    </div>
                                )}
                            </div>
                        </div>

                        <div className="md:col-span-1">
                            <FinancialSummaryBlock
                                priceDetails={priceDetails}
                                promoCode={financials.promoCode}
                                setPromoCode={setPromoCode}
                                applyPromoCode={applyPromoCode}
                                removePromoCode={removePromoCode}
                                promoCodeMessage={financials.promoCodeMessage}
                                isLoading={isCheckingAvailability}
                                hasConflicts={hasConflicts}
                                variant="inline"
                                showActions={false}
                            />
                        </div>
                    </div>

                    <div className="flex flex-col sm:flex-row justify-end items-center gap-3 pt-4 border-t border-blue-200 mt-4">
                        <Button
                            variant="ghost"
                            onClick={cancelEdit}
                            disabled={isLoading}
                            className="text-sm mr-auto"
                        >
                            <X className="w-4 h-4 mr-1" />
                            ĞÑ‚Ğ¼ĞµĞ½Ğ°
                        </Button>
                        <Button
                            onClick={() => saveChanges()}
                            disabled={!editState.hasChanges || hasConflicts || isLoading || totalItemsInEdit === 0}
                            className="text-sm min-w-[120px]"
                        >
                            {isSaving ? (
                                <>
                                    <Loader2 className="w-4 h-4 mr-1 animate-spin" />
                                    Ğ¡Ğ¾Ñ…Ñ€Ğ°Ğ½ĞµĞ½Ğ¸Ğµ...
                                </>
                            ) : (
                                <>
                                    <Save className="w-4 h-4 mr-1" />
                                    Ğ¡Ğ¾Ñ…Ñ€Ğ°Ğ½Ğ¸Ñ‚ÑŒ
                                </>
                            )}
                        </Button>
                    </div>

                    <div className="text-xs text-gray-500 bg-gray-50 border border-gray-200 rounded p-2 space-y-1 mt-4">
                        <div>ğŸ’¡ ĞŸĞ¾Ğ´ÑĞºĞ°Ğ·ĞºĞ¸:</div>
                        <ul className="space-y-0.5 ml-3">
                            <li>â€¢ Ğ—ĞµĞ»ĞµĞ½Ñ‹Ğ¼ Ğ¾Ñ‚Ğ¼ĞµÑ‡ĞµĞ½Ñ‹ Ğ½Ğ¾Ğ²Ñ‹Ğµ Ğ¿Ğ¾Ğ·Ğ¸Ñ†Ğ¸Ğ¸, Ğ´Ğ¾Ğ±Ğ°Ğ²Ğ»ĞµĞ½Ğ½Ñ‹Ğµ Ğ¿Ñ€Ğ¸ Ñ‚ĞµĞºÑƒÑ‰ĞµĞ¼ Ñ€ĞµĞ´Ğ°ĞºÑ‚Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğ¸.</li>
                            <li>â€¢ Ğ–ĞµĞ»Ñ‚Ñ‹Ğ¼/ĞºÑ€Ğ°ÑĞ½Ñ‹Ğ¼ Ğ¾Ñ‚Ğ¼ĞµÑ‡ĞµĞ½Ñ‹ ĞºĞ¾Ğ½Ñ„Ğ»Ğ¸ĞºÑ‚Ñ‹ Ñ Ğ´Ñ€ÑƒĞ³Ğ¸Ğ¼Ğ¸ Ñ€ĞµĞ·ĞµÑ€Ğ²Ğ°Ğ¼Ğ¸.</li>
                            <li>â€¢ ĞĞ°Ğ¶Ğ¼Ğ¸Ñ‚Ğµ "Ğ”Ğ¾Ğ±Ğ°Ğ²Ğ¸Ñ‚ÑŒ Ğ¾Ğ±Ğ¾Ñ€ÑƒĞ´Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ" Ğ´Ğ»Ñ Ğ²Ñ‹Ğ±Ğ¾Ñ€Ğ° Ğ´Ğ¾Ğ¿Ğ¾Ğ»Ğ½Ğ¸Ñ‚ĞµĞ»ÑŒĞ½Ñ‹Ñ… Ğ¿Ğ¾Ğ·Ğ¸Ñ†Ğ¸Ğ¹.</li>
                            <li>â€¢ ĞšĞ½Ğ¾Ğ¿ĞºĞ° "Ğ¡Ğ¾Ñ…Ñ€Ğ°Ğ½Ğ¸Ñ‚ÑŒ" Ğ°ĞºÑ‚Ğ¸Ğ²Ğ½Ğ° Ñ‚Ğ¾Ğ»ÑŒĞºĞ¾ Ğ¿Ñ€Ğ¸ Ğ½Ğ°Ğ»Ğ¸Ñ‡Ğ¸Ğ¸ Ğ¸Ğ·Ğ¼ĞµĞ½ĞµĞ½Ğ¸Ğ¹ Ğ¸ Ğ¾Ñ‚ÑÑƒÑ‚ÑÑ‚Ğ²Ğ¸Ğ¸ ĞºĞ¾Ğ½Ñ„Ğ»Ğ¸ĞºÑ‚Ğ¾Ğ².</li>
                            <li>â€¢ ĞŸĞ¾ÑĞ»Ğµ ÑĞ¾Ñ…Ñ€Ğ°Ğ½ĞµĞ½Ğ¸Ñ Ğ½Ğ¾Ğ²Ñ‹Ğµ Ğ¿Ğ¾Ğ·Ğ¸Ñ†Ğ¸Ğ¸ ÑÑ‚Ğ°Ğ½ÑƒÑ‚ Ğ¾Ğ±Ñ‹Ñ‡Ğ½Ñ‹Ğ¼Ğ¸ Ñ‡Ğ°ÑÑ‚ÑĞ¼Ğ¸ Ñ€ĞµĞ·ĞµÑ€Ğ²Ğ°.</li>
                        </ul>
                    </div>
                </div>
            </Card>

            <HolidayConfirmationDialog
                open={!!holidayConflict}
                message={holidayConflict?.message || ""}
                suggestedDate={holidayConflict ? formatDateEuropean(new Date(holidayConflict.suggested_end_date)) : ""}
                onConfirm={confirmHolidayAdjustment}
                onCancel={cancelHolidayAdjustment}
                isConfirming={isSaving}
            />
        </>
    );
}

```


## <a name="srccomponentsreservationEquipmentItemWithConflictstsx"></a>`src/components/reservation/EquipmentItemWithConflicts.tsx`

```tsx
// path: src/components/reservation/EquipmentItemWithConflicts.tsx

// src/components/reservation/EquipmentItemWithConflicts.tsx
import { Button } from "@/components/ui/button";
import { MinusCircle, AlertTriangle, CheckCircle, Sparkles } from "lucide-react";
import { formatDateRangeEuropean } from "@/lib/utils";
import type { AvailabilityInfo } from "@/types/availability";

interface EquipmentItemWithConflictsProps {
    item: { id: number; label: string };
    isNew: boolean;
    hasConflict: boolean;
    availability?: AvailabilityInfo;
    onRemove?: (id: number) => void;
    disabled?: boolean;
}

export default function EquipmentItemWithConflicts({
                                                       item,
                                                       isNew,
                                                       hasConflict,
                                                       availability,
                                                       onRemove,
                                                       disabled = false
                                                   }: EquipmentItemWithConflictsProps) {

    const getStatusInfo = () => {
        if (hasConflict && availability) {
            const dateRange = availability.start_date && availability.end_date
                ? formatDateRangeEuropean(availability.start_date, availability.end_date)
                : "";

            if (availability.status === "reserved") {
                return {
                    icon: <AlertTriangle className="w-4 h-4" />,
                    color: "text-yellow-600",
                    bgColor: "bg-yellow-50 border-yellow-200",
                    status: "Ğ—Ğ°Ñ€ĞµĞ·ĞµÑ€Ğ²Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¾",
                    dateText: dateRange
                };
            } else if (availability.status === "rented") {
                return {
                    icon: <AlertTriangle className="w-4 h-4" />,
                    color: "text-red-600",
                    bgColor: "bg-red-50 border-red-200",
                    status: "Ğ’ Ğ°Ñ€ĞµĞ½Ğ´Ğµ",
                    dateText: dateRange
                };
            }
        }

        if (isNew) {
            return {
                icon: <Sparkles className="w-4 h-4" />,
                color: "text-green-600",
                bgColor: "bg-green-50 border-green-200",
                status: "ĞĞ¾Ğ²Ğ°Ñ Ğ¿Ğ¾Ğ·Ğ¸Ñ†Ğ¸Ñ",
                dateText: ""
            };
        }

        return {
            icon: <CheckCircle className="w-4 h-4" />,
            color: "text-gray-600",
            bgColor: "bg-gray-50 border-gray-200",
            status: "Ğ”Ğ¾ÑÑ‚ÑƒĞ¿Ğ½Ğ¾",
            dateText: ""
        };
    };

    const statusInfo = getStatusInfo();

    return (
        <div className={`flex justify-between items-start p-3 rounded-md border transition-colors ${statusInfo.bgColor}`}>
            <div className="flex-1 min-w-0">
                <div className="flex items-start gap-2">
                    <div className={`flex-shrink-0 mt-0.5 ${statusInfo.color}`}>
                        {statusInfo.icon}
                    </div>

                    <div className="flex-1 min-w-0">
                        <div className="text-sm font-medium text-gray-900 truncate">
                            {item.label}
                        </div>

                        <div className={`text-xs ${statusInfo.color} mt-1`}>
                            {statusInfo.status}
                            {statusInfo.dateText && (
                                <span className="ml-1 font-normal">
                  ({statusInfo.dateText})
                </span>
                            )}
                        </div>

                        {hasConflict && (
                            <div className="text-xs text-red-600 mt-1 font-medium">
                                âš ï¸ ĞšĞ¾Ğ½Ñ„Ğ»Ğ¸ĞºÑ‚: Ğ¾Ğ±Ğ¾Ñ€ÑƒĞ´Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ Ğ½ĞµĞ´Ğ¾ÑÑ‚ÑƒĞ¿Ğ½Ğ¾ Ğ½Ğ° Ğ²Ñ‹Ğ±Ñ€Ğ°Ğ½Ğ½Ñ‹Ğµ Ğ´Ğ°Ñ‚Ñ‹
                            </div>
                        )}
                    </div>
                </div>
            </div>

            {onRemove && (
                <Button
                    variant="ghost"
                    size="icon"
                    onClick={() => onRemove(item.id)}
                    disabled={disabled}
                    className={`ml-2 h-8 w-8 flex-shrink-0 hover:text-red-700 ${
                        disabled
                            ? "text-gray-400 cursor-not-allowed"
                            : hasConflict
                                ? "text-red-500 hover:bg-red-100"
                                : "text-gray-500 hover:bg-gray-100"
                    }`}
                    title="Ğ£Ğ´Ğ°Ğ»Ğ¸Ñ‚ÑŒ Ğ¸Ğ· Ñ€ĞµĞ·ĞµÑ€Ğ²Ğ°"
                >
                    <MinusCircle className="w-4 h-4" />
                </Button>
            )}
        </div>
    );
}

```


## <a name="srccomponentsreservationHolidayConfirmationDialogtsx"></a>`src/components/reservation/HolidayConfirmationDialog.tsx`

```tsx
// path: src/components/reservation/HolidayConfirmationDialog.tsx

// src/components/reservation/HolidayConfirmationDialog.tsx
import {
    Dialog,
    DialogContent,
    DialogHeader,
    DialogTitle,
    DialogDescription,
    DialogFooter,
} from "@/components/ui/dialog";
import { Button } from "@/components/ui/button";
import { AlertTriangle } from "lucide-react";

type Props = {
    open: boolean;
    message: string;
    suggestedDate: string;
    onConfirm: () => void;
    onCancel: () => void;
    isConfirming: boolean;
};

export default function HolidayConfirmationDialog({
                                                      open,
                                                      message,
                                                      suggestedDate,
                                                      onConfirm,
                                                      onCancel,
                                                      isConfirming,
                                                  }: Props) {
    return (
        <Dialog open={open} onOpenChange={onCancel}>
            <DialogContent>
                <DialogHeader>
                    <DialogTitle className="flex items-center gap-2">
                        <AlertTriangle className="text-amber-500" />
                        Ğ”Ğ°Ñ‚Ğ° Ğ¾ĞºĞ¾Ğ½Ñ‡Ğ°Ğ½Ğ¸Ñ - Ğ²Ñ‹Ñ…Ğ¾Ğ´Ğ½Ğ¾Ğ¹
                    </DialogTitle>
                </DialogHeader>
                <DialogDescription>
                    <p>{message}</p>
                    <p className="mt-2">
                        Ğ’Ñ‹ Ñ…Ğ¾Ñ‚Ğ¸Ñ‚Ğµ Ğ°Ğ²Ñ‚Ğ¾Ğ¼Ğ°Ñ‚Ğ¸Ñ‡ĞµÑĞºĞ¸ Ğ¸Ğ·Ğ¼ĞµĞ½Ğ¸Ñ‚ÑŒ Ğ´Ğ°Ñ‚Ñƒ Ğ¾ĞºĞ¾Ğ½Ñ‡Ğ°Ğ½Ğ¸Ñ Ğ½Ğ° Ğ±Ğ»Ğ¸Ğ¶Ğ°Ğ¹ÑˆĞ¸Ğ¹ Ñ€Ğ°Ğ±Ğ¾Ñ‡Ğ¸Ğ¹ Ğ´ĞµĞ½ÑŒ:
                        <strong className="text-gray-800"> {suggestedDate}</strong>?
                    </p>
                </DialogDescription>
                <DialogFooter className="pt-4">
                    <Button variant="ghost" onClick={onCancel} disabled={isConfirming}>
                        ĞĞµÑ‚, Ñ Ğ²Ñ‹Ğ±ĞµÑ€Ñƒ Ğ´Ñ€ÑƒĞ³ÑƒÑ Ğ´Ğ°Ñ‚Ñƒ
                    </Button>
                    <Button
                        onClick={onConfirm}
                        disabled={isConfirming}
                    >
                        {isConfirming ? "Ğ¡Ğ¾Ñ…Ñ€Ğ°Ğ½ĞµĞ½Ğ¸Ğµ..." : "Ğ”Ğ°, Ğ¸Ğ·Ğ¼ĞµĞ½Ğ¸Ñ‚ÑŒ"}
                    </Button>
                </DialogFooter>
            </DialogContent>
        </Dialog>
    );
}

```


## <a name="srccomponentsreservationReservationItemsListtsx"></a>`src/components/reservation/ReservationItemsList.tsx`

```tsx
// path: src/components/reservation/ReservationItemsList.tsx

// src/components/reservation/ReservationItemsList.tsx
import ReserveEquipmentCard from "@/components/ReserveEquipmentCard";
import { Button } from "@/components/ui/button";
import { Paperclip, X } from "lucide-react";
import type { Equipment } from "@/types/equipment";
import type { AvailabilityInfo } from "@/types/availability";

interface Props {
    items: Equipment[];
    selectedAccessories: Record<number, number[]>;
    availabilityMap: Record<number, AvailabilityInfo>;
    unavailableIdsFromAPI: number[];
    invalidItems: number[];
    onRemoveItem: (id: number) => void;
    onRemoveAccessory: (equipmentId: number, accessoryId: number) => void;
    // âœ… Ğ”ĞĞ‘ĞĞ’Ğ›Ğ•ĞĞ« ĞĞĞ’Ğ«Ğ• Ğ¡Ğ’ĞĞ™Ğ¡Ğ¢Ğ’Ğ
    isAccessorySelected: (equipmentId: number, accessoryId: number) => boolean;
    onToggleAccessory: (equipmentId: number, accessoryId: number) => void;
}

export default function ReservationItemsList({
                                                 items,
                                                 selectedAccessories,
                                                 availabilityMap,
                                                 unavailableIdsFromAPI,
                                                 invalidItems,
                                                 onRemoveItem,
                                                 onRemoveAccessory,
                                                 // âœ… ĞŸĞĞ›Ğ£Ğ§ĞĞ•Ğœ ĞĞĞ’Ğ«Ğ• Ğ¡Ğ’ĞĞ™Ğ¡Ğ¢Ğ’Ğ
                                                 isAccessorySelected,
                                                 onToggleAccessory,
                                             }: Props) {
    return (
        <div className="space-y-4 pt-4">
            {items.map((item) => {
                const selectedAccessoryIds = selectedAccessories[item.id] || [];
                const selectedAccessoryDetails = item.accessories?.filter(acc =>
                    selectedAccessoryIds.includes(acc.id)
                ) || [];

                return (
                    <div
                        key={item.id}
                        className={`border rounded-lg overflow-hidden shadow-sm transition-all ${
                            unavailableIdsFromAPI.includes(item.id) || invalidItems.includes(item.id)
                                ? "border-red-400 bg-red-50"
                                : "border-gray-200 bg-white"
                        }`}
                    >
                        <ReserveEquipmentCard
                            equipment={item}
                            availability={availabilityMap[item.id]}
                            onRemove={() => onRemoveItem(item.id)}
                            // âœ… ĞŸĞ•Ğ Ğ•Ğ”ĞĞ•Ğœ Ğ¤Ğ£ĞĞšĞ¦Ğ˜Ğ˜ Ğ’ ĞšĞĞ Ğ¢ĞĞ§ĞšĞ£
                            isAccessorySelected={isAccessorySelected}
                            onToggleAccessory={onToggleAccessory}
                        />

                        {selectedAccessoryDetails.length > 0 && (
                            <div className="px-4 pb-3 pt-2 bg-slate-50 border-t border-dashed">
                                <h4 className="flex items-center gap-1.5 text-xs font-semibold text-gray-600 mb-2">
                                    <Paperclip className="h-3.5 w-3.5" />
                                    Ğ”Ğ¾Ğ¿. Ğ°ĞºÑĞµÑÑÑƒĞ°Ñ€Ñ‹:
                                </h4>
                                <ul className="space-y-1.5">
                                    {selectedAccessoryDetails.map(acc => (
                                        <li key={acc.id} className="flex items-center justify-between text-xs hover:bg-slate-100 p-1 rounded-md">
                                            <span className="text-gray-800">{acc.name}</span>
                                            <div className="flex items-center gap-2">
                                                <span className="text-gray-500 font-medium">{acc.price} â‚½</span>
                                                <Button
                                                    variant="ghost"
                                                    size="icon"
                                                    className="h-5 w-5 text-gray-400 hover:text-red-500 hover:bg-red-50"
                                                    onClick={() => onRemoveAccessory(item.id, acc.id)}
                                                    title="Ğ£Ğ´Ğ°Ğ»Ğ¸Ñ‚ÑŒ Ğ°ĞºÑĞµÑÑÑƒĞ°Ñ€"
                                                >
                                                    <X className="h-3 w-3" />
                                                </Button>
                                            </div>
                                        </li>
                                    ))}
                                </ul>
                            </div>
                        )}

                        {(unavailableIdsFromAPI.includes(item.id) || invalidItems.includes(item.id)) && (
                            <p className="text-sm text-red-600 px-4 pb-2 pt-0">
                                Ğ­Ñ‚Ğ¾ Ğ¾Ğ±Ğ¾Ñ€ÑƒĞ´Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ Ğ½ĞµĞ´Ğ¾ÑÑ‚ÑƒĞ¿Ğ½Ğ¾ Ğ½Ğ° Ğ²Ñ‹Ğ±Ñ€Ğ°Ğ½Ğ½Ñ‹Ğµ Ğ´Ğ°Ñ‚Ñ‹.
                            </p>
                        )}
                    </div>
                )
            })}
        </div>
    );
}

```


## <a name="srccomponentsreservationReservationStatusBadgetsx"></a>`src/components/reservation/ReservationStatusBadge.tsx`

```tsx
// path: src/components/reservation/ReservationStatusBadge.tsx

// src/components/reservation/ReservationStatusBadge.tsx

import { Badge } from "@/components/ui/badge";
import type { Reservation } from "@/types/reservation";

type Status = Reservation['status'];

interface Props {
    status: Status;
}

const statusConfig: Record<Status, { text: string; className: string }> = {
    active: {
        text: "ĞĞºÑ‚Ğ¸Ğ²ĞµĞ½",
        className: "bg-green-100 text-green-800 border-green-200",
    },
    fulfilled: {
        text: "Ğ’Ñ‹Ğ´Ğ°Ğ½ Ğ² Ğ°Ñ€ĞµĞ½Ğ´Ñƒ",
        className: "bg-blue-100 text-blue-800 border-blue-200",
    },
    cancelled: {
        text: "ĞÑ‚Ğ¼ĞµĞ½ĞµĞ½",
        className: "bg-gray-100 text-gray-800 border-gray-200",
    },
    overdue: {
        text: "ĞŸÑ€Ğ¾ÑÑ€Ğ¾Ñ‡ĞµĞ½",
        className: "bg-orange-100 text-orange-800 border-orange-200",
    },
};

export default function ReservationStatusBadge({ status }: Props) {
    const config = statusConfig[status] || statusConfig.cancelled;

    return (
        <Badge variant="outline" className={`font-medium ${config.className}`}>
            {config.text}
        </Badge>
    );
}


```


## <a name="srccomponentsreservationViewReservationCardtsx"></a>`src/components/reservation/ViewReservationCard.tsx`

```tsx
// path: src/components/reservation/ViewReservationCard.tsx

// src/components/reservation/ViewReservationCard.tsx

import { Button } from "@/components/ui/button";
import { Card } from "@/components/ui/card";
import ReservationStatusBadge from "./ReservationStatusBadge";
import { MinusCircle, CalendarRange, Edit2, RotateCcw, Trash2, ExternalLink } from "lucide-react";
import { useNavigate, useLocation } from "react-router-dom";
import { formatDateEuropean } from "@/lib/utils";
import type { Reservation, AccessoryLink } from "@/types/reservation";
import { useState } from "react";
import EquipmentWithAccessoriesList from "@/components/shared/EquipmentWithAccessoriesList";
import FinancialInfoBlock from "@/components/shared/FinancialInfoBlock";
import { RESERVATION_CARD_STYLES } from "@/constants/statusStyles";

interface ViewReservationCardProps {
    id: number;
    equipment: { id: number; label: string }[];
    start_date: string;
    end_date: string;
    status: Reservation['status'];
    onEdit?: () => void;
    onCancel?: () => void;
    onRemoveItem?: (equipmentId: number) => void;
    onRepeat?: () => void;
    cancelDisabled?: boolean;
    total_cost?: number;
    discount_amount?: number;
    promo_code?: string | null;
    rental_id?: number | null;
    accessory_links?: AccessoryLink[];
}

export default function ViewReservationCard(props: ViewReservationCardProps) {
    const {
        id,
        equipment,
        start_date,
        end_date,
        status,
        onEdit,
        onCancel,
        onRemoveItem,
        onRepeat,
        cancelDisabled,
        total_cost,
        discount_amount,
        promo_code,
        rental_id,
        accessory_links,
    } = props;

    const navigate = useNavigate();
    const location = useLocation();

    const start = start_date ? new Date(start_date) : null;
    const end = end_date ? new Date(end_date) : null;

    const now = new Date();
    const isPast = !!end && end < now;

    const msPerDay = 1000 * 60 * 60 * 24;
    const daysUntilStart = start ? Math.ceil((start.getTime() - now.getTime()) / msPerDay) : null;
    const daysUntilEnd = end ? Math.floor((end.getTime() - now.getTime()) / msPerDay) : null;

    const isProtected = !isPast && daysUntilEnd !== null && daysUntilEnd < 2;
    const isActionable = status === 'active';
    const canBeRepeated = status === 'fulfilled' || status === 'cancelled';
    const cardColor = RESERVATION_CARD_STYLES[status] || RESERVATION_CARD_STYLES.default;

    const getStatusInfo = () => {
        if (isPast) {
            return {
                showMessage: false,
                message: "",
                className: ""
            };
        }

        if (daysUntilStart !== null) {
            if (daysUntilStart <= 0) {
                return {
                    showMessage: true,
                    message: "Ğ ĞµĞ·ĞµÑ€Ğ² ÑƒĞ¶Ğµ Ğ½Ğ°Ñ‡Ğ°Ğ»ÑÑ",
                    className: "text-green-600"
                };
            } else if (daysUntilStart <= 3) {
                return {
                    showMessage: true,
                    message: `Ğ”Ğ¾ Ğ½Ğ°Ñ‡Ğ°Ğ»Ğ° Ñ€ĞµĞ·ĞµÑ€Ğ²Ğ°: ${daysUntilStart} Ğ´Ğ½.`,
                    className: "text-orange-600 font-medium"
                };
            } else {
                return {
                    showMessage: true,
                    message: `Ğ”Ğ¾ Ğ½Ğ°Ñ‡Ğ°Ğ»Ğ° Ñ€ĞµĞ·ĞµÑ€Ğ²Ğ°: ${daysUntilStart} Ğ´Ğ½.`,
                    className: "text-gray-600"
                };
            }
        }

        return {
            showMessage: false,
            message: "",
            className: ""
        };
    };

    const statusInfo = getStatusInfo();

    const handleRentalClick = () => {
        if (rental_id) {
            navigate("/reservations/my", {
                state: {
                    highlightRentalId: rental_id,
                    from: "reservation"
                }
            });
        }
    };

    return (
        <Card className={`w-full px-5 py-4 rounded-2xl border shadow-sm hover:shadow-md transition-all ${cardColor}`}>
            <div className="space-y-3">
                <div className="flex justify-between items-center">
                    <div className="text-base font-semibold text-sky-700">Ğ ĞµĞ·ĞµÑ€Ğ² #{id}</div>
                    <div className="flex items-center gap-2">
                        <ReservationStatusBadge status={status} />
                        {rental_id && status === 'fulfilled' && (
                            <Button
                                variant="outline"
                                size="sm"
                                onClick={handleRentalClick}
                                className="text-orange-600 hover:text-orange-700 hover:bg-orange-50 border-orange-200"
                            >
                                <ExternalLink className="w-3 h-3 mr-1" />
                                ĞÑ€ĞµĞ½Ğ´Ğ° #{rental_id}
                            </Button>
                        )}
                    </div>
                </div>

                <div className="flex flex-col sm:flex-row sm:justify-between sm:items-center gap-2 pt-2 border-t border-dashed">
                    {start && end ? (
                        <div className="flex items-center gap-2 text-sm">
                            <CalendarRange className="w-4 h-4 text-gray-500 flex-shrink-0" />
                            <span>{formatDateEuropean(start)} â€” {formatDateEuropean(end)}</span>
                        </div>
                    ) : (
                        <p className="text-red-600 text-sm">ĞÑˆĞ¸Ğ±ĞºĞ° Ğ² Ğ´Ğ°Ñ‚Ğµ Ñ€ĞµĞ·ĞµÑ€Ğ²Ğ°</p>
                    )}

                    <FinancialInfoBlock
                        totalCost={total_cost}
                        discountAmount={discount_amount}
                        promoCode={promo_code}
                        variant="default"
                        className="justify-start sm:justify-end"
                    />
                </div>

                {statusInfo.showMessage && status === 'active' && (
                    <div className="flex items-center gap-2 text-sm">
                        <div className={`px-2 py-1 rounded-md text-xs ${statusInfo.className} bg-opacity-10`}>
                            {statusInfo.message}
                        </div>
                    </div>
                )}

                {/* Ğ¡Ğ¾ÑÑ‚Ğ°Ğ² Ñ€ĞµĞ·ĞµÑ€Ğ²Ğ° */}
                <EquipmentWithAccessoriesList
                    equipment={equipment.map(item => ({ id: item.id, name: item.label }))}
                    accessoryLinks={accessory_links || []}
                    title="Ğ¡Ğ¾ÑÑ‚Ğ°Ğ² Ñ€ĞµĞ·ĞµÑ€Ğ²Ğ°:"
                    showTitle={true}
                    className="pt-2 border-t"
                    showRemoveButton={isActionable && !!onRemoveItem}
                    onRemoveItem={onRemoveItem}
                    isRemoveDisabled={isProtected}
                    removeButtonTitle={isProtected ? "Ğ£Ğ´Ğ°Ğ»ĞµĞ½Ğ¸Ğµ Ñ‡ĞµÑ€ĞµĞ· Ğ¼ĞµĞ½ĞµĞ´Ğ¶ĞµÑ€Ğ°" : "Ğ£Ğ´Ğ°Ğ»Ğ¸Ñ‚ÑŒ Ğ¸Ğ· Ñ€ĞµĞ·ĞµÑ€Ğ²Ğ°"}
                />

                {canBeRepeated && onRepeat ? (
                    <div className="flex justify-end pt-2 border-t border-gray-200">
                        <Button variant="outline" size="sm" onClick={onRepeat}>
                            <RotateCcw className="w-4 h-4 mr-1" />
                            ĞŸĞ¾Ğ²Ñ‚Ğ¾Ñ€Ğ¸Ñ‚ÑŒ Ñ€ĞµĞ·ĞµÑ€Ğ²
                        </Button>
                    </div>
                ) : (
                    <div className="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-2 pt-2 border-t border-gray-200">
                        {isProtected ? (
                            <div className="flex flex-col gap-2">
                                <p className="text-sm font-medium text-rose-700">
                                    ĞÑ‚Ğ¼ĞµĞ½Ğ° Ğ¸ Ñ€ĞµĞ´Ğ°ĞºÑ‚Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ Ñ‚Ğ¾Ğ»ÑŒĞºĞ¾ Ñ‡ĞµÑ€ĞµĞ· Ğ¼ĞµĞ½ĞµĞ´Ğ¶ĞµÑ€Ğ°
                                </p>
                                <Button
                                    variant="outline"
                                    size="sm"
                                    onClick={() => navigate("/contacts", { state: { from: location.pathname } })}
                                >
                                    ĞĞ°Ğ¿Ğ¸ÑĞ°Ñ‚ÑŒ Ğ¼ĞµĞ½ĞµĞ´Ğ¶ĞµÑ€Ñƒ
                                </Button>
                            </div>
                        ) : (
                            <div className="text-sm text-gray-600">
                                {daysUntilEnd !== null && daysUntilEnd >= 0 && (
                                    <span>Ğ”Ğ¾ Ğ¾ĞºĞ¾Ğ½Ñ‡Ğ°Ğ½Ğ¸Ñ: {daysUntilEnd} Ğ´Ğ½.</span>
                                )}
                            </div>
                        )}

                        <div className="flex gap-2 justify-end w-full sm:w-auto">
                            {isActionable && onEdit && !isProtected && (
                                <Button variant="secondary" size="sm" onClick={onEdit}>
                                    <Edit2 className="w-4 h-4 mr-1" />
                                    Ğ ĞµĞ´Ğ°ĞºÑ‚Ğ¸Ñ€Ğ¾Ğ²Ğ°Ñ‚ÑŒ
                                </Button>
                            )}
                            {isActionable && onCancel && !isProtected && (
                                <Button
                                    variant="destructive"
                                    size="sm"
                                    disabled={cancelDisabled}
                                    onClick={onCancel}
                                >
                                    <Trash2 className="w-4 h-4 mr-1" />
                                    {cancelDisabled ? "ĞÑ‚Ğ¼ĞµĞ½Ğ°..." : "ĞÑ‚Ğ¼ĞµĞ½Ğ¸Ñ‚ÑŒ"}
                                </Button>
                            )}
                        </div>
                    </div>
                )}
            </div>
        </Card>
    );
}

```


## <a name="srccomponentssessionUserSessiontsx"></a>`src/components/session/UserSession.tsx`

```tsx
// path: src/components/session/UserSession.tsx

// src/components/session/UserSession.tsx

import AuthForm from "@/components/AuthForm";
import UserInfoBlock from "@/components/UserInfoBlock";
import { useCurrentUser } from "@/hooks/useProfile";

/**
 * ĞšĞ¾Ğ¼Ğ¿Ğ¾Ğ½ĞµĞ½Ñ‚ Ğ´Ğ»Ñ ÑƒĞ¿Ñ€Ğ°Ğ²Ğ»ĞµĞ½Ğ¸Ñ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ÑŒÑĞºĞ¾Ğ¹ ÑĞµÑÑĞ¸ĞµĞ¹.
 * ĞÑ‚Ğ¾Ğ±Ñ€Ğ°Ğ¶Ğ°ĞµÑ‚ Ñ„Ğ¾Ñ€Ğ¼Ñƒ Ğ°Ğ²Ñ‚Ğ¾Ñ€Ğ¸Ğ·Ğ°Ñ†Ğ¸Ğ¸ Ğ´Ğ»Ñ Ğ³Ğ¾ÑÑ‚ĞµĞ¹ Ğ¸Ğ»Ğ¸ Ğ¸Ğ½Ñ„Ğ¾Ñ€Ğ¼Ğ°Ñ†Ğ¸Ñ Ğ¾ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ğµ Ğ´Ğ»Ñ Ğ°Ğ²Ñ‚Ğ¾Ñ€Ğ¸Ğ·Ğ¾Ğ²Ğ°Ğ½Ğ½Ñ‹Ñ….
 */
export default function UserSession() {
    const { data: user } = useCurrentUser();

    return user ? <UserInfoBlock showExtraLinks={true} /> : <AuthForm />;
}


```


## <a name="srccomponentssharedEquipmentWithAccessoriesListtsx"></a>`src/components/shared/EquipmentWithAccessoriesList.tsx`

```tsx
// path: src/components/shared/EquipmentWithAccessoriesList.tsx

// src/components/shared/EquipmentWithAccessoriesList.tsx

import { useState } from "react";
import { Paperclip, ChevronDown, MinusCircle } from "lucide-react";
import { Button } from "@/components/ui/button";
import type { AccessoryLink } from "@/types/reservation";

interface EquipmentItem {
    id: number;
    name: string;
}

interface EquipmentWithAccessoriesListProps {
    equipment: EquipmentItem[];
    accessoryLinks?: AccessoryLink[];
    title?: string;
    showTitle?: boolean;
    className?: string;
    showRemoveButton?: boolean;
    onRemoveItem?: (equipmentId: number) => void;
    isRemoveDisabled?: boolean;
    removeButtonTitle?: string;
}

export default function EquipmentWithAccessoriesList({
    equipment,
    accessoryLinks = [],
    title = "Ğ¡Ğ¾ÑÑ‚Ğ°Ğ² Ñ€ĞµĞ·ĞµÑ€Ğ²Ğ°:",
    showTitle = true,
    className = "",
    showRemoveButton = false,
    onRemoveItem,
    isRemoveDisabled = false,
    removeButtonTitle = "Ğ£Ğ´Ğ°Ğ»Ğ¸Ñ‚ÑŒ Ğ¸Ğ· Ñ€ĞµĞ·ĞµÑ€Ğ²Ğ°"
}: EquipmentWithAccessoriesListProps) {
    const [expandedAccessories, setExpandedAccessories] = useState<Record<number, boolean>>({});

    // Ğ›Ğ¾Ğ³Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ Ğ´Ğ»Ñ Ğ¾Ñ‚Ğ»Ğ°Ğ´ĞºĞ¸ Ğ¾Ñ‚ÑÑƒÑ‚ÑÑ‚Ğ²ÑƒÑÑ‰Ğ¸Ñ… Ğ°ĞºÑĞµÑÑÑƒĞ°Ñ€Ğ¾Ğ²
    const missingAccessories = accessoryLinks.filter(link => !link.accessory);
    if (missingAccessories.length > 0) {
        console.warn('ĞĞ±Ğ½Ğ°Ñ€ÑƒĞ¶ĞµĞ½Ñ‹ AccessoryLink Ñ Ğ¾Ñ‚ÑÑƒÑ‚ÑÑ‚Ğ²ÑƒÑÑ‰Ğ¸Ğ¼Ğ¸ accessory:', missingAccessories);
    }

    const toggleAccessories = (equipmentId: number) => {
        setExpandedAccessories(prev => ({
            ...prev,
            [equipmentId]: !prev[equipmentId]
        }));
    };

    if (equipment.length === 0) {
        return (
            <div className={`space-y-2 pt-2 border-t ${className}`}>
                {showTitle && (
                    <h4 className="font-medium text-sm text-gray-800">{title}</h4>
                )}
                <div className="text-sm text-gray-500 italic">ĞĞµÑ‚ Ğ¾Ğ±Ğ¾Ñ€ÑƒĞ´Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ Ğ² Ñ€ĞµĞ·ĞµÑ€Ğ²Ğµ</div>
            </div>
        );
    }

    return (
        <div className={`space-y-2 pt-2 border-t ${className}`}>
            {showTitle && (
                <h4 className="font-medium text-sm text-gray-800">{title}</h4>
            )}
            <div className="space-y-2">
                {equipment.map((item) => {
                    // Ğ¤Ğ¸Ğ»ÑŒÑ‚Ñ€ÑƒĞµĞ¼ Ğ°ĞºÑĞµÑÑÑƒĞ°Ñ€Ñ‹, Ñ‡Ñ‚Ğ¾Ğ±Ñ‹ ÑƒĞ±ĞµĞ´Ğ¸Ñ‚ÑŒÑÑ, Ñ‡Ñ‚Ğ¾ Ğ´Ğ°Ğ½Ğ½Ñ‹Ğµ Ğ¾ Ğ½Ğ¸Ñ… ÑÑƒÑ‰ĞµÑÑ‚Ğ²ÑƒÑÑ‚
                    const accessoriesForItem = accessoryLinks.filter(link => 
                        link.equipment_id === item.id && link.accessory
                    );
                    
                    return (
                        <div key={item.id} className="text-sm text-gray-700 bg-gray-50/70 p-2 rounded-md border">
                            <div className="flex justify-between items-center">
                                <p>â€¢ {item.name}</p>
                                {showRemoveButton && onRemoveItem && (
                                    <Button
                                        variant="ghost"
                                        size="icon"
                                        onClick={() => onRemoveItem(item.id)}
                                        className={`hover:text-rose-700 ${
                                            isRemoveDisabled ? "text-gray-400 cursor-not-allowed" : "text-rose-500"
                                        }`}
                                        title={removeButtonTitle}
                                        aria-label="Ğ£Ğ´Ğ°Ğ»Ğ¸Ñ‚ÑŒ Ğ¾Ğ±Ğ¾Ñ€ÑƒĞ´Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ"
                                        disabled={isRemoveDisabled}
                                    >
                                        <MinusCircle className="w-4 h-4" />
                                    </Button>
                                )}
                            </div>
                            {accessoriesForItem.length > 0 && (
                                <div className="mt-2 pl-4">
                                    <button 
                                        onClick={() => toggleAccessories(item.id)} 
                                        className="flex items-center text-xs text-sky-700 hover:underline font-medium"
                                    >
                                        <Paperclip className="w-3 h-3 mr-1" />
                                        ĞĞºÑĞµÑÑÑƒĞ°Ñ€Ñ‹ ({accessoriesForItem.length})
                                        <ChevronDown className={`w-4 h-4 ml-1 transition-transform ${expandedAccessories[item.id] ? 'rotate-180' : ''}`} />
                                    </button>
                                    {expandedAccessories[item.id] && (
                                        <ul className="list-disc list-inside text-xs text-gray-600 mt-1 pl-2 animate-in fade-in duration-200">
                                            {accessoriesForItem.map(link => {
                                                // Ğ”Ğ¾Ğ¿Ğ¾Ğ»Ğ½Ğ¸Ñ‚ĞµĞ»ÑŒĞ½Ğ°Ñ Ğ·Ğ°Ñ‰Ğ¸Ñ‚Ğ° Ğ½Ğ° ÑĞ»ÑƒÑ‡Ğ°Ğ¹, ĞµÑĞ»Ğ¸ accessory ÑÑ‚Ğ°Ğ» null Ğ¿Ğ¾ÑĞ»Ğµ Ñ„Ğ¸Ğ»ÑŒÑ‚Ñ€Ğ°Ñ†Ğ¸Ğ¸
                                                if (!link.accessory) {
                                                    console.warn('ĞĞ±Ğ½Ğ°Ñ€ÑƒĞ¶ĞµĞ½ AccessoryLink Ñ Ğ¾Ñ‚ÑÑƒÑ‚ÑÑ‚Ğ²ÑƒÑÑ‰Ğ¸Ğ¼ accessory:', link);
                                                    return null;
                                                }
                                                return (
                                                    <li key={link.accessory.id}>{link.accessory.name}</li>
                                                );
                                            })}
                                        </ul>
                                    )}
                                </div>
                            )}
                        </div>
                    );
                })}
            </div>
        </div>
    );
}


```


## <a name="srccomponentssharedFinancialInfoBlocktsx"></a>`src/components/shared/FinancialInfoBlock.tsx`

```tsx
// path: src/components/shared/FinancialInfoBlock.tsx

// src/components/shared/FinancialInfoBlock.tsx

import { Tag, Receipt, ReceiptText } from "lucide-react";
import { cn } from "@/lib/utils";

interface FinancialInfoBlockProps {
    totalCost?: number | null;
    discountAmount?: number | null;
    promoCode?: string | null;
    variant?: 'default' | 'compact' | 'admin';
    className?: string;
}

export default function FinancialInfoBlock({
    totalCost,
    discountAmount,
    promoCode,
    variant = 'default',
    className
}: FinancialInfoBlockProps) {
    // ĞĞ´Ğ¼Ğ¸Ğ½ÑĞºĞ¸Ğ¹ ÑÑ‚Ğ¸Ğ»ÑŒ - ĞºĞ°Ğº Ğ² AdminRentalCard
    if (variant === 'admin') {
        return (
            <div className={cn("flex-shrink-0 md:w-64 bg-slate-50 p-3 rounded-lg border space-y-2", className)}>
                <h4 className="font-semibold text-sm text-slate-800 flex items-center gap-2">
                    <ReceiptText className="w-4 h-4"/>Ğ¤Ğ¸Ğ½Ğ°Ğ½ÑÑ‹
                </h4>
                <div className="text-xs space-y-1.5 text-slate-700">
                    <div className="flex justify-between">
                        <span>ĞĞ±Ñ‰Ğ°Ñ ÑÑ‚Ğ¾Ğ¸Ğ¼Ğ¾ÑÑ‚ÑŒ:</span> 
                        <span className="font-medium">{totalCost?.toLocaleString('ru-RU') ?? 'Ğ/Ğ”'} â‚½</span>
                    </div>
                    {promoCode && (
                        <div className="flex justify-between">
                            <span>ĞŸÑ€Ğ¾Ğ¼Ğ¾ĞºĞ¾Ğ´:</span> 
                            <span className="font-medium text-purple-600">{promoCode}</span>
                        </div>
                    )}
                    {(discountAmount ?? 0) > 0 && (
                        <div className="flex justify-between">
                            <span>Ğ¡ĞºĞ¸Ğ´ĞºĞ°:</span> 
                            <span className="font-medium text-green-600">-{discountAmount?.toLocaleString('ru-RU')} â‚½</span>
                        </div>
                    )}
                </div>
            </div>
        );
    }

    // ĞšĞ¾Ğ¼Ğ¿Ğ°ĞºÑ‚Ğ½Ñ‹Ğ¹ Ğ¸ ÑÑ‚Ğ°Ğ½Ğ´Ğ°Ñ€Ñ‚Ğ½Ñ‹Ğ¹ ÑÑ‚Ğ¸Ğ»Ğ¸ (Ğ¾Ğ±ÑŠĞµĞ´Ğ¸Ğ½ĞµĞ½Ñ‹ Ğ´Ğ»Ñ ÑƒÑÑ‚Ñ€Ğ°Ğ½ĞµĞ½Ğ¸Ñ Ğ´ÑƒĞ±Ğ»Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ)
    const isCompact = variant === 'compact';
    const containerClasses = isCompact 
        ? "flex flex-wrap items-center justify-start gap-x-4 gap-y-1 text-sm pt-2 border-t border-dashed"
        : "flex flex-wrap items-center justify-start gap-x-4 gap-y-1 text-sm";
    
    return (
        <div className={cn(containerClasses, className)}>
            {promoCode && (
                <div className="flex items-center gap-1.5 text-xs text-purple-600 self-end">
                    <Tag className="w-3 h-3" />
                    <span>{promoCode}</span>
                </div>
            )}
            <div className="text-right">
                <div className="flex items-center gap-1.5 font-semibold">
                    <Receipt className="w-4 h-4 text-gray-500" />
                    Ğ˜Ñ‚Ğ¾Ğ³:
                    <span className="text-gray-800">
                        {totalCost?.toLocaleString('ru-RU') ?? 'Ğ/Ğ”'} â‚½
                    </span>
                </div>
                {(discountAmount ?? 0) > 0 && (
                    <div className="text-xs text-green-600 mt-0.5">
                        ÑĞ¾ ÑĞºĞ¸Ğ´ĞºĞ¾Ğ¹ Ğ² {discountAmount?.toLocaleString('ru-RU')} â‚½
                    </div>
                )}
            </div>
        </div>
    );
}


```


## <a name="srccomponentssharedFinancialSummaryBlocktsx"></a>`src/components/shared/FinancialSummaryBlock.tsx`

```tsx
// path: src/components/shared/FinancialSummaryBlock.tsx

// src/components/shared/FinancialSummaryBlock.tsx

import { Button } from "@/components/ui/button";
import PromoCodeInput from "@/components/PromoCodeInput";
import { ReceiptText, Loader2, AlertTriangle } from "lucide-react";
import { cn } from "@/lib/utils";
import type { PriceDetails } from "@/hooks/reservation/usePriceCalculator";

interface FinancialSummaryBlockProps {
    // Ğ”Ğ°Ğ½Ğ½Ñ‹Ğµ Ğ¾ ÑÑ‚Ğ¾Ğ¸Ğ¼Ğ¾ÑÑ‚Ğ¸
    priceDetails?: PriceDetails | null;
    
    // Ğ”Ğ¾Ğ¿Ğ¾Ğ»Ğ½Ğ¸Ñ‚ĞµĞ»ÑŒĞ½Ñ‹Ğµ Ñ„Ğ¸Ğ½Ğ°Ğ½ÑĞ¾Ğ²Ñ‹Ğµ Ğ´Ğ°Ğ½Ğ½Ñ‹Ğµ
    accessoriesDailyTotal?: number;
    
    // ĞŸÑ€Ğ¾Ğ¼Ğ¾ĞºĞ¾Ğ´
    promoCode: string;
    setPromoCode: (code: string) => void;
    applyPromoCode: () => void;
    removePromoCode?: () => void;
    promoCodeMessage?: string;
    
    // Ğ¡Ğ¾ÑÑ‚Ğ¾ÑĞ½Ğ¸Ñ Ğ·Ğ°Ğ³Ñ€ÑƒĞ·ĞºĞ¸
    isLoading?: boolean;
    isApplyingPromoCode?: boolean;
    isSubmitting?: boolean;
    
    // Ğ’Ğ°Ğ»Ğ¸Ğ´Ğ°Ñ†Ğ¸Ñ
    isFormValid?: boolean;
    hasConflicts?: boolean;
    
    // Ğ”ĞµĞ¹ÑÑ‚Ğ²Ğ¸Ñ
    onCancel?: () => void;
    onAddMore?: () => void;
    onSubmit?: () => void;
    
    // Ğ¡Ñ‚Ğ¸Ğ»Ğ¸Ğ·Ğ°Ñ†Ğ¸Ñ
    variant?: 'default' | 'compact' | 'admin' | 'inline';
    className?: string;
    showActions?: boolean;
}

/**
 * Ğ£Ğ½Ğ¸Ğ²ĞµÑ€ÑĞ°Ğ»ÑŒĞ½Ñ‹Ğ¹ ĞºĞ¾Ğ¼Ğ¿Ğ¾Ğ½ĞµĞ½Ñ‚ Ğ´Ğ»Ñ Ğ¾Ñ‚Ğ¾Ğ±Ñ€Ğ°Ğ¶ĞµĞ½Ğ¸Ñ Ñ„Ğ¸Ğ½Ğ°Ğ½ÑĞ¾Ğ²Ğ¾Ğ¹ ÑĞ²Ğ¾Ğ´ĞºĞ¸ Ñ€ĞµĞ·ĞµÑ€Ğ²Ğ°.
 * Ğ—Ğ°Ğ¼ĞµĞ½ÑĞµÑ‚ ReservationSummary, AdminReservationSummary Ğ¸ ReservationFinancialSummary.
 */
export default function FinancialSummaryBlock({
    priceDetails,
    accessoriesDailyTotal = 0,
    promoCode,
    setPromoCode,
    applyPromoCode,
    removePromoCode,
    promoCodeMessage = "",
    isLoading = false,
    isApplyingPromoCode = false,
    isSubmitting = false,
    isFormValid = true,
    hasConflicts = false,
    onCancel,
    onAddMore,
    onSubmit,
    variant = 'default',
    className,
    showActions = true
}: FinancialSummaryBlockProps) {
    
    // Ğ˜Ğ·Ğ²Ğ»ĞµĞºĞ°ĞµĞ¼ Ğ´Ğ°Ğ½Ğ½Ñ‹Ğµ Ğ¸Ğ· priceDetails
    const dayCount = priceDetails?.day_count ?? 0;
    const fullTotal = priceDetails?.full_total ?? 0;
    const finalTotal = priceDetails?.final_total ?? 0;
    const discountAmount = priceDetails?.discount_amount ?? 0;
    const durationDiscountPercentage = priceDetails?.duration_discount_percentage ?? 0;
    const promoDiscountPercentage = priceDetails?.promo_discount_percentage ?? 0;
    const totalDiscountPercentage = durationDiscountPercentage + promoDiscountPercentage;
    const apiPromoCodeMessage = priceDetails?.promo_code_message ?? "";
    
    // Ğ˜ÑĞ¿Ğ¾Ğ»ÑŒĞ·ÑƒĞµĞ¼ ÑĞ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ğµ Ğ¸Ğ· API Ğ¸Ğ»Ğ¸ Ğ¿ĞµÑ€ĞµĞ´Ğ°Ğ½Ğ½Ğ¾Ğµ
    const displayPromoCodeMessage = apiPromoCodeMessage || promoCodeMessage;
    
    // ĞšĞ¾Ğ¼Ğ¿Ğ°ĞºÑ‚Ğ½Ñ‹Ğ¹ Ğ²Ğ°Ñ€Ğ¸Ğ°Ğ½Ñ‚ Ğ´Ğ»Ñ ĞºĞ°Ñ€Ñ‚Ğ¾Ñ‡ĞµĞº
    if (variant === 'compact') {
        return (
            <div className={cn("flex flex-wrap items-center justify-start gap-x-4 gap-y-1 text-sm", className)}>
                {promoCode && (
                    <div className="flex items-center gap-1.5 text-xs text-purple-600 self-end">
                        <span className="px-1.5 py-0.5 bg-purple-100 rounded text-xs">
                            {promoCode}
                        </span>
                    </div>
                )}
                <div className="text-right">
                    <div className="flex items-center gap-1.5 font-semibold">
                        <ReceiptText className="w-4 h-4 text-gray-500" />
                        Ğ˜Ñ‚Ğ¾Ğ³:
                        <span className="text-gray-800">
                            {finalTotal.toLocaleString('ru-RU')} â‚½
                        </span>
                    </div>
                    {discountAmount > 0 && (
                        <div className="text-xs text-green-600 mt-0.5">
                            ÑĞ¾ ÑĞºĞ¸Ğ´ĞºĞ¾Ğ¹ Ğ² {discountAmount.toLocaleString('ru-RU')} â‚½
                        </div>
                    )}
                </div>
            </div>
        );
    }
    
    // ĞĞ´Ğ¼Ğ¸Ğ½ÑĞºĞ¸Ğ¹ Ğ²Ğ°Ñ€Ğ¸Ğ°Ğ½Ñ‚
    if (variant === 'admin') {
        return (
            <div className={cn("flex-1 space-y-2 text-sm", className)}>
                <div className="grid grid-cols-2 gap-x-4 gap-y-1">
                    <span className="text-gray-600">Ğ”Ğ½ĞµĞ¹ Ğ°Ñ€ĞµĞ½Ğ´Ñ‹:</span>
                    <span className="font-medium text-right">{dayCount}</span>

                    <span className="text-gray-600">Ğ¡ÑƒĞ¼Ğ¼Ğ° Ğ±ĞµĞ· ÑĞºĞ¸Ğ´ĞºĞ¸:</span>
                    <span className="font-medium text-right">{fullTotal.toLocaleString('ru-RU')} â‚½</span>

                    {totalDiscountPercentage > 0 && (
                        <>
                            <span className="text-green-600">Ğ¡ĞºĞ¸Ğ´ĞºĞ° ({totalDiscountPercentage}%):</span>
                            <span className="font-medium text-green-600 text-right">- {discountAmount.toLocaleString('ru-RU')} â‚½</span>
                        </>
                    )}

                    <span className="font-semibold text-base mt-1">Ğ˜Ñ‚Ğ¾Ğ³Ğ¾:</span>
                    <span className="font-bold text-base text-right mt-1">{finalTotal.toLocaleString('ru-RU')} â‚½</span>
                </div>

                <div className="pt-2">
                    <PromoCodeInput
                        promoCode={promoCode}
                        setPromoCode={setPromoCode}
                        applyPromoCode={applyPromoCode}
                        promoCodeMessage={displayPromoCodeMessage}
                        disabled={isSubmitting || isLoading}
                        isLoading={isApplyingPromoCode}
                    />
                </div>

                {isLoading && (
                    <div className="flex items-center gap-2 text-xs text-gray-500 pt-1">
                        <Loader2 className="h-3 w-3 animate-spin" />
                        <span>ĞŸÑ€Ğ¾Ğ²ĞµÑ€ĞºĞ° Ğ´Ğ¾ÑÑ‚ÑƒĞ¿Ğ½Ğ¾ÑÑ‚Ğ¸...</span>
                    </div>
                )}
                {hasConflicts && (
                    <div className="flex items-center gap-2 text-xs text-red-600 font-medium pt-1">
                        <AlertTriangle className="h-4 w-4" />
                        <span>ĞĞ±Ğ½Ğ°Ñ€ÑƒĞ¶ĞµĞ½Ñ‹ ĞºĞ¾Ğ½Ñ„Ğ»Ğ¸ĞºÑ‚Ñ‹ Ğ² Ğ²Ñ‹Ğ±Ğ¾Ñ€Ğµ!</span>
                    </div>
                )}
            </div>
        );
    }
    
    // Inline Ğ²Ğ°Ñ€Ğ¸Ğ°Ğ½Ñ‚ Ğ´Ğ»Ñ Ñ€ĞµĞ´Ğ°ĞºÑ‚Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ
    if (variant === 'inline') {
        return (
            <div className={cn("space-y-3", className)}>
                <div className="flex items-center gap-2 text-sm font-medium text-gray-700">
                    <ReceiptText className="w-4 h-4" />
                    Ğ¤Ğ¸Ğ½Ğ°Ğ½ÑĞ¾Ğ²Ğ°Ñ ÑĞ²Ğ¾Ğ´ĞºĞ°
                </div>
                
                {isLoading ? (
                    <div className="text-center py-4 text-gray-500 flex items-center justify-center gap-2">
                        <Loader2 className="h-4 w-4 animate-spin" />
                        Ğ Ğ°ÑÑ‡ĞµÑ‚ ÑÑ‚Ğ¾Ğ¸Ğ¼Ğ¾ÑÑ‚Ğ¸...
                    </div>
                ) : (
                    <div className="text-sm text-gray-700 space-y-2">
                        <div className="flex justify-between">
                            <span>ĞÑ€ĞµĞ½Ğ´Ğ° Ğ¾Ğ±Ğ¾Ñ€ÑƒĞ´Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ ({dayCount} Ğ´Ğ½.):</span>
                            <span>{fullTotal.toLocaleString('ru-RU')} â‚½</span>
                        </div>
                        
                        {accessoriesDailyTotal > 0 && (
                            <div className="flex justify-between text-gray-600 pl-4">
                                <span>- Ğ² Ñ‚.Ñ‡. Ğ°ĞºÑĞµÑÑÑƒĞ°Ñ€Ñ‹ ({accessoriesDailyTotal.toLocaleString('ru-RU')} â‚½/Ğ´ĞµĞ½ÑŒ):</span>
                                <span>{(accessoriesDailyTotal * dayCount).toLocaleString('ru-RU')} â‚½</span>
                            </div>
                        )}
                        
                        <div className="flex justify-between pt-2 border-t border-dashed">
                            <span>Ğ¡ÑƒĞ¼Ğ¼Ğ° Ğ±ĞµĞ· ÑĞºĞ¸Ğ´ĞºĞ¸:</span>
                            <strong>{fullTotal.toLocaleString('ru-RU')} â‚½</strong>
                        </div>
                        
                        {totalDiscountPercentage > 0 && (
                            <div className="flex justify-between text-green-600">
                                <span>Ğ¡ĞºĞ¸Ğ´ĞºĞ° ({totalDiscountPercentage}%):</span>
                                <strong>- {discountAmount.toLocaleString('ru-RU', { minimumFractionDigits: 2, maximumFractionDigits: 2 })} â‚½</strong>
                            </div>
                        )}
                        
                        <div className="flex justify-between text-base font-bold pt-2 border-t mt-2">
                            <span>Ğš Ğ¾Ğ¿Ğ»Ğ°Ñ‚Ğµ:</span>
                            <span className="text-sky-700 ml-2">{finalTotal.toLocaleString('ru-RU', { minimumFractionDigits: 2, maximumFractionDigits: 2 })} â‚½</span>
                        </div>
                    </div>
                )}
                
                <div className="pt-2">
                    <PromoCodeInput
                        promoCode={promoCode}
                        setPromoCode={setPromoCode}
                        applyPromoCode={applyPromoCode}
                        removePromoCode={removePromoCode}
                        promoCodeMessage={displayPromoCodeMessage}
                        disabled={isSubmitting || isLoading}
                        isLoading={isApplyingPromoCode}
                    />
                </div>
            </div>
        );
    }
    
    // Ğ¡Ñ‚Ğ°Ğ½Ğ´Ğ°Ñ€Ñ‚Ğ½Ñ‹Ğ¹ Ğ²Ğ°Ñ€Ğ¸Ğ°Ğ½Ñ‚ (ĞºĞ°Ğº ReservationSummary)
    return (
        <div className={cn("mt-6 p-4 border rounded-lg bg-white shadow-sm space-y-4", className)}>
            <div className="flex items-center gap-2 text-lg font-semibold text-gray-800">
                <ReceiptText className="w-6 h-6 text-sky-600" />
                Ğ˜Ñ‚Ğ¾Ğ³Ğ¾Ğ²Ñ‹Ğ¹ Ñ€Ğ°ÑÑ‡ĞµÑ‚
            </div>

            <div className="border-t pt-4">
                <PromoCodeInput
                    promoCode={promoCode}
                    setPromoCode={setPromoCode}
                    applyPromoCode={applyPromoCode}
                    removePromoCode={removePromoCode}
                    promoCodeMessage={displayPromoCodeMessage}
                    disabled={isSubmitting || isLoading}
                    isLoading={isApplyingPromoCode}
                />
            </div>

            {isLoading ? (
                <div className="text-center py-4 text-gray-500 flex items-center justify-center gap-2">
                    <Loader2 className="h-4 w-4 animate-spin" />
                    Ğ Ğ°ÑÑ‡ĞµÑ‚ ÑÑ‚Ğ¾Ğ¸Ğ¼Ğ¾ÑÑ‚Ğ¸...
                </div>
            ) : (
                <div className="text-sm text-gray-700 space-y-2 border-t pt-4">
                    <div className="flex justify-between">
                        <span>ĞÑ€ĞµĞ½Ğ´Ğ° Ğ¾Ğ±Ğ¾Ñ€ÑƒĞ´Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ ({dayCount} Ğ´Ğ½.):</span>
                    </div>
                    {accessoriesDailyTotal > 0 && (
                        <div className="flex justify-between text-gray-600 pl-4">
                            <span>- Ğ² Ñ‚.Ñ‡. Ğ°ĞºÑĞµÑÑÑƒĞ°Ñ€Ñ‹ ({accessoriesDailyTotal.toLocaleString('ru-RU')} â‚½/Ğ´ĞµĞ½ÑŒ):</span>
                            <span>{(accessoriesDailyTotal * dayCount).toLocaleString('ru-RU')} â‚½</span>
                        </div>
                    )}
                    <div className="flex justify-between pt-2 border-t border-dashed">
                        <span>Ğ¡ÑƒĞ¼Ğ¼Ğ° Ğ±ĞµĞ· ÑĞºĞ¸Ğ´ĞºĞ¸:</span>
                        <strong>{fullTotal.toLocaleString('ru-RU')} â‚½</strong>
                    </div>
                    {totalDiscountPercentage > 0 && (
                        <div className="flex justify-between text-green-600">
                            <span>Ğ¡ĞºĞ¸Ğ´ĞºĞ° ({totalDiscountPercentage}%):</span>
                            <strong>- {discountAmount.toLocaleString('ru-RU', { minimumFractionDigits: 2, maximumFractionDigits: 2 })} â‚½</strong>
                        </div>
                    )}
                    <div className="flex justify-between text-base font-bold pt-2 border-t mt-2">
                        <span>Ğš Ğ¾Ğ¿Ğ»Ğ°Ñ‚Ğµ:</span>
                        <span className="text-sky-700 ml-2">{finalTotal.toLocaleString('ru-RU', { minimumFractionDigits: 2, maximumFractionDigits: 2 })} â‚½</span>
                    </div>
                </div>
            )}

            {showActions && (onCancel || onAddMore || onSubmit) && (
                <div className="flex flex-col sm:flex-row justify-end items-center pt-3 gap-3">
                    {onCancel && (
                        <Button variant="ghost" className="text-red-600 hover:bg-red-50 w-full sm:w-auto" onClick={onCancel}>
                            ĞÑ‚Ğ¼ĞµĞ½Ğ¸Ñ‚ÑŒ Ğ¾Ñ„Ğ¾Ñ€Ğ¼Ğ»ĞµĞ½Ğ¸Ğµ
                        </Button>
                    )}
                    {onAddMore && (
                        <Button variant="outline" className="w-full sm:w-auto" onClick={onAddMore}>
                            Ğ”Ğ¾Ğ±Ğ°Ğ²Ğ¸Ñ‚ÑŒ Ğ¾Ğ±Ğ¾Ñ€ÑƒĞ´Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ
                        </Button>
                    )}
                    {onSubmit && (
                        <Button
                            disabled={!isFormValid || isSubmitting || isLoading || isApplyingPromoCode}
                            className="px-6 py-2 w-full sm:w-auto"
                            onClick={onSubmit}
                        >
                            {isSubmitting ? "ĞĞ±Ñ€Ğ°Ğ±Ğ¾Ñ‚ĞºĞ°..." : "ĞŸĞ¾Ğ´Ñ‚Ğ²ĞµÑ€Ğ´Ğ¸Ñ‚ÑŒ Ñ€ĞµĞ·ĞµÑ€Ğ²"}
                        </Button>
                    )}
                </div>
            )}
        </div>
    );
}


```


## <a name="srccomponentssharedOrderToolbartsx"></a>`src/components/shared/OrderToolbar.tsx`

```tsx
// path: src/components/shared/OrderToolbar.tsx

import { Input } from "@/components/ui/input"
import { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from "@/components/ui/select"
import { Checkbox } from "@/components/ui/checkbox"
import { Label } from "@/components/ui/label"
import { useOrderFilterStore, type SortOption, type OrderContext } from "@/store/orderFilterStore"

interface OrderToolbarProps {
    context: OrderContext
    showHideCompletedCheckbox?: boolean
}

export default function OrderToolbar({ context, showHideCompletedCheckbox }: OrderToolbarProps) {
    const { searchQuery, statusFilter, sortOption, setSearchQuery, setStatusFilter, setSortOption } = useOrderFilterStore()

    // ĞĞ¿Ñ€ĞµĞ´ĞµĞ»ÑĞµĞ¼ placeholder Ğ´Ğ»Ñ Ğ¿Ğ¾Ğ¸ÑĞºĞ° Ğ² Ğ·Ğ°Ğ²Ğ¸ÑĞ¸Ğ¼Ğ¾ÑÑ‚Ğ¸ Ğ¾Ñ‚ ĞºĞ¾Ğ½Ñ‚ĞµĞºÑÑ‚Ğ°
    const getSearchPlaceholder = () => {
        switch (context) {
            case "user-reservations":
            case "user-rentals":
                return "ĞŸĞ¾Ğ¸ÑĞº Ğ¿Ğ¾ Ğ¾Ğ±Ğ¾Ñ€ÑƒĞ´Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ..."
            case "admin-reservations":
            case "admin-rentals":
                return "ĞŸĞ¾Ğ¸ÑĞº Ğ¿Ğ¾ ĞºĞ»Ğ¸ĞµĞ½Ñ‚Ñƒ..."
            default:
                return "ĞŸĞ¾Ğ¸ÑĞº..."
        }
    }

    // ĞĞ¿Ñ€ĞµĞ´ĞµĞ»ÑĞµĞ¼ Ğ¾Ğ¿Ñ†Ğ¸Ğ¸ ÑÑ‚Ğ°Ñ‚ÑƒÑĞ° Ğ² Ğ·Ğ°Ğ²Ğ¸ÑĞ¸Ğ¼Ğ¾ÑÑ‚Ğ¸ Ğ¾Ñ‚ ĞºĞ¾Ğ½Ñ‚ĞµĞºÑÑ‚Ğ°
    const getStatusOptions = () => {
        switch (context) {
            case "user-reservations":
                return [
                    { value: "active", label: "ĞĞºÑ‚Ğ¸Ğ²Ğ½Ñ‹Ğµ" },
                    { value: "completed", label: "Ğ—Ğ°Ğ²ĞµÑ€ÑˆĞµĞ½Ğ½Ñ‹Ğµ" },
                    { value: "all", label: "Ğ’ÑĞµ" }
                ]
            case "user-rentals":
                return [
                    { value: "active", label: "ĞĞºÑ‚Ğ¸Ğ²Ğ½Ñ‹Ğµ" },
                    { value: "overdue", label: "ĞŸÑ€Ğ¾ÑÑ€Ğ¾Ñ‡ĞµĞ½Ğ½Ñ‹Ğµ" },
                    { value: "completed", label: "Ğ—Ğ°Ğ²ĞµÑ€ÑˆĞµĞ½Ğ½Ñ‹Ğµ" },
                    { value: "all", label: "Ğ’ÑĞµ" }
                ]
            case "admin-reservations":
                return [
                    { value: "active", label: "ĞĞºÑ‚Ğ¸Ğ²Ğ½Ñ‹Ğµ" },
                    { value: "completed", label: "Ğ—Ğ°Ğ²ĞµÑ€ÑˆĞµĞ½Ğ½Ñ‹Ğµ" },
                    { value: "all", label: "Ğ’ÑĞµ" }
                ]
            case "admin-rentals":
                return [
                    { value: "active", label: "ĞĞºÑ‚Ğ¸Ğ²Ğ½Ñ‹Ğµ" },
                    { value: "overdue", label: "ĞŸÑ€Ğ¾ÑÑ€Ğ¾Ñ‡ĞµĞ½Ğ½Ñ‹Ğµ" },
                    { value: "completed", label: "Ğ—Ğ°Ğ²ĞµÑ€ÑˆĞµĞ½Ğ½Ñ‹Ğµ" },
                    { value: "all", label: "Ğ’ÑĞµ" }
                ]
            default:
                return []
        }
    }

    const statusOptions = getStatusOptions()

    // Ğ›Ğ¾Ğ³Ğ¸ĞºĞ° Ğ´Ğ»Ñ Ñ‡ĞµĞºĞ±Ğ¾ĞºÑĞ° "Ğ¡ĞºÑ€Ñ‹Ñ‚ÑŒ Ğ·Ğ°Ğ²ĞµÑ€ÑˆĞµĞ½Ğ½Ñ‹Ğµ"
    const isHideCompletedChecked = statusFilter !== 'all'
    const handleHideCompletedChange = (checked: boolean | 'indeterminate') => {
        // Ğ•ÑĞ»Ğ¸ indeterminate, ÑÑ‡Ğ¸Ñ‚Ğ°ĞµĞ¼ ĞºĞ°Ğº false
        setStatusFilter(checked === true ? 'active' : 'all')
    }

    return (
        <div className="mb-4 flex flex-wrap items-center gap-4">
            <Input
                type="text"
                placeholder={getSearchPlaceholder()}
                value={searchQuery}
                onChange={(e) => setSearchQuery(e.target.value)}
                className="max-w-xs"
            />
            
            {showHideCompletedCheckbox ? (
                <div className="flex items-center space-x-2">
                    <Checkbox
                        id="hide-completed-orders"
                        checked={isHideCompletedChecked}
                        onCheckedChange={handleHideCompletedChange}
                    />
                    <Label htmlFor="hide-completed-orders">Ğ¡ĞºÑ€Ñ‹Ñ‚ÑŒ Ğ·Ğ°Ğ²ĞµÑ€ÑˆĞµĞ½Ğ½Ñ‹Ğµ</Label>
                </div>
            ) : (
                <Select value={statusFilter || "active"} onValueChange={setStatusFilter}>
                    <SelectTrigger className="w-52">
                        <SelectValue placeholder="Ğ¤Ğ¸Ğ»ÑŒÑ‚Ñ€ Ğ¿Ğ¾ ÑÑ‚Ğ°Ñ‚ÑƒÑÑƒ" />
                    </SelectTrigger>
                    <SelectContent>
                        {statusOptions.map((option) => (
                            <SelectItem key={option.value} value={option.value}>
                                {option.label}
                            </SelectItem>
                        ))}
                    </SelectContent>
                </Select>
            )}

            <Select value={sortOption} onValueChange={(val) => setSortOption(val as SortOption)}>
                <SelectTrigger className="w-52">
                    <SelectValue placeholder="Ğ¡Ğ¾Ñ€Ñ‚Ğ¸Ñ€Ğ¾Ğ²ĞºĞ°" />
                </SelectTrigger>
                <SelectContent>
                    <SelectItem value="id_desc">ĞĞ¾Ğ¼ĞµÑ€ â†“</SelectItem>
                    <SelectItem value="id_asc">ĞĞ¾Ğ¼ĞµÑ€ â†‘</SelectItem>
                    <SelectItem value="start_desc">ĞĞ°Ñ‡Ğ°Ğ»Ğ¾ â†“</SelectItem>
                    <SelectItem value="start_asc">ĞĞ°Ñ‡Ğ°Ğ»Ğ¾ â†‘</SelectItem>
                    <SelectItem value="end_desc">ĞĞºĞ¾Ğ½Ñ‡Ğ°Ğ½Ğ¸Ğµ â†“</SelectItem>
                    <SelectItem value="end_asc">ĞĞºĞ¾Ğ½Ñ‡Ğ°Ğ½Ğ¸Ğµ â†‘</SelectItem>
                    <SelectItem value="count_desc">ĞŸĞ¾Ğ·Ğ¸Ñ†Ğ¸Ğ¹ â†“</SelectItem>
                    <SelectItem value="count_asc">ĞŸĞ¾Ğ·Ğ¸Ñ†Ğ¸Ğ¹ â†‘</SelectItem>
                </SelectContent>
            </Select>
        </div>
    )
}


```


## <a name="srcconstantsequipmentConstantsts"></a>`src/constants/equipmentConstants.ts`

```typescript
// path: src/constants/equipmentConstants.ts

// src/constants/equipmentConstants.ts

/**
 * Ğ¡Ğ¿Ğ¸ÑĞ¾Ğº Ğ²Ğ¾Ğ·Ğ¼Ğ¾Ğ¶Ğ½Ñ‹Ñ… ÑĞ¾ÑÑ‚Ğ¾ÑĞ½Ğ¸Ğ¹ Ğ¾Ğ±Ğ¾Ñ€ÑƒĞ´Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ.
 * Ğ˜ÑĞ¿Ğ¾Ğ»ÑŒĞ·ÑƒĞµÑ‚ÑÑ Ğ´Ğ»Ñ Ğ²Ñ‹Ğ¿Ğ°Ğ´Ğ°ÑÑ‰Ğ¸Ñ… ÑĞ¿Ğ¸ÑĞºĞ¾Ğ² Ğ² Ñ„Ğ¾Ñ€Ğ¼Ğ°Ñ… Ğ¸ Ğ´Ğ»Ñ Ğ²Ğ°Ğ»Ğ¸Ğ´Ğ°Ñ†Ğ¸Ğ¸.
 */
export const EQUIPMENT_CONDITIONS: readonly string[] = [
    "Ğ’ĞµĞ»Ğ¸ĞºĞ¾Ğ»ĞµĞ¿Ğ½Ğ¾",
    "ĞÑ‚Ğ»Ğ¸Ñ‡Ğ½Ğ¾",
    "Ğ¥Ğ¾Ñ€Ğ¾ÑˆĞ¾",
    "Ğ£Ğ´Ğ¾Ğ²Ğ»ĞµÑ‚Ğ²Ğ¾Ñ€Ğ¸Ñ‚ĞµĞ»ÑŒĞ½Ğ¾",
    "Ğ¢Ñ€ĞµĞ±ÑƒĞµÑ‚ Ñ€ĞµĞ¼Ğ¾Ğ½Ñ‚Ğ°",
];

/**
 * Ğ£Ñ‚Ğ¸Ğ»Ğ¸Ñ‚Ğ° Ğ´Ğ»Ñ Ğ¿Ğ¾Ğ»ÑƒÑ‡ĞµĞ½Ğ¸Ñ Tailwind CSS ĞºĞ»Ğ°ÑÑĞ¾Ğ² Ğ´Ğ»Ñ ÑÑ‚Ğ¸Ğ»Ğ¸Ğ·Ğ°Ñ†Ğ¸Ğ¸ ÑĞ¾ÑÑ‚Ğ¾ÑĞ½Ğ¸Ñ Ğ¾Ğ±Ğ¾Ñ€ÑƒĞ´Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ.
 * @param condition Ğ¡Ñ‚Ñ€Ğ¾ĞºĞ° Ñ Ğ½Ğ°Ğ·Ğ²Ğ°Ğ½Ğ¸ĞµĞ¼ ÑĞ¾ÑÑ‚Ğ¾ÑĞ½Ğ¸Ñ.
 * @returns Ğ¡Ñ‚Ñ€Ğ¾ĞºĞ° Ñ CSS ĞºĞ»Ğ°ÑÑĞ°Ğ¼Ğ¸ Ğ´Ğ»Ñ Ñ„Ğ¾Ğ½Ğ° Ğ¸ Ñ‚ĞµĞºÑÑ‚Ğ°.
 */
export function getConditionVariantClass(condition: string): string {
    switch (condition) {
        case "Ğ’ĞµĞ»Ğ¸ĞºĞ¾Ğ»ĞµĞ¿Ğ½Ğ¾":
            return "bg-green-100 text-green-800";
        case "ĞÑ‚Ğ»Ğ¸Ñ‡Ğ½Ğ¾":
            return "bg-sky-100 text-sky-800";
        case "Ğ¥Ğ¾Ñ€Ğ¾ÑˆĞ¾":
            return "bg-yellow-100 text-yellow-800";
        case "Ğ£Ğ´Ğ¾Ğ²Ğ»ĞµÑ‚Ğ²Ğ¾Ñ€Ğ¸Ñ‚ĞµĞ»ÑŒĞ½Ğ¾":
            return "bg-orange-100 text-orange-800";
        case "Ğ¢Ñ€ĞµĞ±ÑƒĞµÑ‚ Ñ€ĞµĞ¼Ğ¾Ğ½Ñ‚Ğ°":
            return "bg-red-100 text-red-800";
        default:
            return "bg-gray-100 text-gray-800";
    }
};

```


## <a name="srcconstantspaginationConstantsts"></a>`src/constants/paginationConstants.ts`

```typescript
// path: src/constants/paginationConstants.ts

// src/constants/paginationConstants.ts

export const PAGINATION_CONSTANTS = {
    HOME_PAGE_SIZE: 12,
    ADMIN_PAGE_SIZE: 10,
};

```


## <a name="srcconstantsstatusStylests"></a>`src/constants/statusStyles.ts`

```typescript
// path: src/constants/statusStyles.ts

// src/constants/statusStyles.ts

// Ğ¡Ñ‚Ğ¸Ğ»Ğ¸ Ğ´Ğ»Ñ ĞºĞ°Ñ€Ñ‚Ğ¾Ñ‡ĞµĞº Ğ Ğ•Ğ—Ğ•Ğ Ğ’ĞĞ’
export const RESERVATION_CARD_STYLES: Record<string, string> = {
    active: "bg-white hover:shadow-md",
    fulfilled: "bg-blue-50 border-blue-200 text-gray-800",
    cancelled: "bg-gray-100 border-gray-300 text-gray-600 hover:shadow-sm",
    overdue: "bg-orange-50 border-orange-200 text-gray-800",
    default: "bg-white hover:shadow-md"
};

// Ğ¡Ñ‚Ğ¸Ğ»Ğ¸ Ğ´Ğ»Ñ ĞºĞ°Ñ€Ñ‚Ğ¾Ñ‡ĞµĞº ĞĞ Ğ•ĞĞ”Ğ«
export const RENTAL_CARD_STYLES: Record<string, string> = {
    active: "bg-white hover:shadow-md",
    completed: "bg-gray-100 border-gray-200 text-gray-600 hover:shadow-sm",
    overdue: "bg-red-50/70 border-red-300",
    default: "bg-white hover:shadow-md"
};


```


## <a name="srcconstantsuserConstantsts"></a>`src/constants/userConstants.ts`

```typescript
// path: src/constants/userConstants.ts

// src/constants/userConstants.ts

/**
 * Ğ¡Ğ¸ÑÑ‚ĞµĞ¼Ğ½Ñ‹Ğµ Ğ¸Ğ¼ĞµĞ½Ğ° Ñ€Ğ¾Ğ»ĞµĞ¹ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ĞµĞ¹.
 * Ğ˜ÑĞ¿Ğ¾Ğ»ÑŒĞ·ÑƒÑÑ‚ÑÑ Ğ´Ğ»Ñ Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ñ Ñ API Ğ¸ Ğ² Ğ»Ğ¾Ğ³Ğ¸ĞºĞµ.
 */
export const USER_ROLES = {
    USER: "user",
    MANAGER: "manager",
    ADMIN: "admin",
} as const;

// Ğ¡Ğ¾Ğ·Ğ´Ğ°ĞµĞ¼ Ñ‚Ğ¸Ğ¿ Ğ½Ğ° Ğ¾ÑĞ½Ğ¾Ğ²Ğµ ĞºĞ»ÑÑ‡ĞµĞ¹ Ğ¾Ğ±ÑŠĞµĞºÑ‚Ğ° USER_ROLES Ğ´Ğ»Ñ ÑƒĞ´Ğ¾Ğ±ÑÑ‚Ğ²Ğ°
type UserRoleKey = keyof typeof USER_ROLES;

/**
 * Ğ¢Ğ¸Ğ¿ Ğ´Ğ»Ñ ÑĞ¸ÑÑ‚ĞµĞ¼Ğ½Ñ‹Ñ… Ğ¸Ğ¼ĞµĞ½ Ñ€Ğ¾Ğ»ĞµĞ¹.
 * ĞŸÑ€Ğ¸Ğ¼ĞµÑ€: 'user' | 'manager' | 'admin'
 */
export type UserRole = (typeof USER_ROLES)[UserRoleKey];

// âœ… Ğ˜Ğ—ĞœĞ•ĞĞ•ĞĞ˜Ğ•: Ğ¡Ğ¾Ğ·Ğ´Ğ°ĞµĞ¼ Ğ¼Ğ°ÑÑĞ¸Ğ² Ñ€Ğ¾Ğ»ĞµĞ¹ Ğ¸ ÑĞ²Ğ½Ğ¾ ÑƒĞºĞ°Ğ·Ñ‹Ğ²Ğ°ĞµĞ¼ TypeScript,
// Ñ‡Ñ‚Ğ¾ ÑÑ‚Ğ¾ Ğ½ĞµĞ¿ÑƒÑÑ‚Ğ¾Ğ¹ ĞºĞ¾Ñ€Ñ‚ĞµĞ¶ Ğ¸Ğ· Ğ½Ğ°ÑˆĞ¸Ñ… ĞºĞ¾Ğ½ĞºÑ€ĞµÑ‚Ğ½Ñ‹Ñ… Ñ€Ğ¾Ğ»ĞµĞ¹.
// Ğ­Ñ‚Ğ¾ Ğ¸ ĞµÑÑ‚ÑŒ Ğ¸ÑĞ¿Ñ€Ğ°Ğ²Ğ»ĞµĞ½Ğ¸Ğµ Ğ¾ÑˆĞ¸Ğ±ĞºĞ¸.
export const USER_ROLE_VALUES = Object.values(USER_ROLES) as [UserRole, ...UserRole[]];

/**
 * ĞœĞµÑ‚ĞºĞ¸ Ñ€Ğ¾Ğ»ĞµĞ¹ Ğ´Ğ»Ñ Ğ¾Ñ‚Ğ¾Ğ±Ñ€Ğ°Ğ¶ĞµĞ½Ğ¸Ñ Ğ² Ğ¸Ğ½Ñ‚ĞµÑ€Ñ„ĞµĞ¹ÑĞµ.
 */
export const USER_ROLE_LABELS: Record<UserRole, string> = {
    [USER_ROLES.USER]: "ĞŸĞ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ÑŒ",
    [USER_ROLES.MANAGER]: "ĞœĞµĞ½ĞµĞ´Ğ¶ĞµÑ€",
    [USER_ROLES.ADMIN]: "ĞĞ´Ğ¼Ğ¸Ğ½",
};

/**
 * Ğ’Ğ°Ñ€Ğ¸Ğ°Ğ½Ñ‚Ñ‹ (Ñ†Ğ²ĞµÑ‚Ğ°) Ğ´Ğ»Ñ ĞºĞ¾Ğ¼Ğ¿Ğ¾Ğ½ĞµĞ½Ñ‚Ğ° Badge Ğ¸Ğ· UI-Ğ±Ğ¸Ğ±Ğ»Ğ¸Ğ¾Ñ‚ĞµĞºĞ¸.
 */
export const USER_ROLE_BADGE_VARIANTS: Record<UserRole, "secondary" | "default" | "destructive"> = {
    [USER_ROLES.USER]: "secondary",
    [USER_ROLES.MANAGER]: "default",
    [USER_ROLES.ADMIN]: "destructive",
};

/**
 * ĞŸĞ¾Ğ»Ğ½Ñ‹Ğ¹ Ğ½Ğ°Ğ±Ğ¾Ñ€ Ğ´Ğ°Ğ½Ğ½Ñ‹Ñ… Ğ´Ğ»Ñ ĞºĞ°Ğ¶Ğ´Ğ¾Ğ¹ Ñ€Ğ¾Ğ»Ğ¸, ÑƒĞ´Ğ¾Ğ±Ğ½Ñ‹Ğ¹ Ğ´Ğ»Ñ Ğ³ĞµĞ½ĞµÑ€Ğ°Ñ†Ğ¸Ğ¸ UI-ÑĞ»ĞµĞ¼ĞµĞ½Ñ‚Ğ¾Ğ².
 */
export const USER_ROLE_OPTIONS = (Object.keys(USER_ROLES) as UserRoleKey[]).map(key => ({
    value: USER_ROLES[key],
    label: USER_ROLE_LABELS[USER_ROLES[key]],
}));

```


## <a name="srccontextsReservationEditContexttsx"></a>`src/contexts/ReservationEditContext.tsx`

```tsx
// path: src/contexts/ReservationEditContext.tsx

// src/contexts/ReservationEditContext.tsx

import { createContext, useContext } from 'react';
import type { AvailabilityInfo } from '@/types/availability';
import type { EditState } from '@/hooks/reservation/useReservationState';
import type { Equipment } from '@/types/equipment'; // âœ… Ğ”Ğ¾Ğ±Ğ°Ğ²Ğ»ĞµĞ½ Ğ¸Ğ¼Ğ¿Ğ¾Ñ€Ñ‚
import type { PriceDetails } from '@/hooks/reservation/usePriceCalculator';

export type ReservationEditContextValue = {
    reservationId: number;
    editState: EditState & { hasChanges: boolean; newlyAddedEquipmentIdsAsArray: number[] };
    availabilityMap: Record<number, AvailabilityInfo>;
    hasConflicts: boolean;
    isLoading: boolean;
    isCheckingAvailability: boolean;
    isSaving: boolean;
    isCalculatingPrice: boolean;
    isCancelling: boolean;
    isCancelConfirmationVisible: boolean;
    startEdit: () => void;
    cancelEdit: () => void;
    saveChanges: () => Promise<boolean | void>;
    // âœ… Ğ”ĞĞ‘ĞĞ’Ğ›Ğ•ĞĞ« Ğ­Ğ¢Ğ˜ Ğ”Ğ’Ğ Ğ¡Ğ’ĞĞ™Ğ¡Ğ¢Ğ’Ğ
    equipmentMap: Map<number, Equipment>;
    allEquipment: Equipment[];
    updateDates: (newStartDate: Date, newEndDate: Date) => void;
    addEquipmentItems: (itemsToAdd: any[]) => void;
    removeEquipmentItem: (idToRemove: number) => void;
    handleConfirmFullCancellation: () => Promise<void>;
    handleCloseCancellationDialog: () => void;
    financials: {
        dayCount: number;
        fullTotal: number;
        finalTotal: number;
        discountAmount: number;
        durationDiscountAmount: number;
        durationDiscountPercentage: number;
        promoDiscountAmount: number;
        promoCodePercentage: number;
        promoCodeMessage: string;
        promoCode: string;
    };
    priceDetails?: PriceDetails | null; // Ğ”Ğ¾Ğ±Ğ°Ğ²Ğ»ÑĞµĞ¼ priceDetails Ğ¸Ğ· usePriceCalculator
    setPromoCode: (code: string) => void;
    applyPromoCode: () => void;
    removePromoCode: () => void;
    localSelectedAccessories: Record<number, number[]>;
    toggleAccessory: (equipmentId: number, accessoryId: number) => void;
    holidayConflict: { message: string, suggested_end_date: string } | null;
    confirmHolidayAdjustment: () => void;
    cancelHolidayAdjustment: () => void;
};

export const ReservationEditContext = createContext<ReservationEditContextValue | null>(null);

export const useReservationEditContext = () => {
    const context = useContext(ReservationEditContext);
    if (!context) {
        throw new Error('useReservationEditContext must be used within a ReservationEditProvider');
    }
    return context;
};

```


## <a name="srccoreservicesAccessoryServicets"></a>`src/core/services/AccessoryService.ts`

```typescript
// path: src/core/services/AccessoryService.ts

// src/core/services/AccessoryService.ts

import { api } from "@/lib/api";
import type { Accessory, AccessoryListResponse } from "@/types/accessory"; // Ğ£Ğ±ĞµĞ´Ğ¸Ñ‚ĞµÑÑŒ, Ñ‡Ñ‚Ğ¾ AccessoryListResponse Ğ¸Ğ¼Ğ¿Ğ¾Ñ€Ñ‚Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½

export interface AccessoryCreateInput {
    name: string;
    accessory_type: string;
    price: number;
    description?: string;
}

export interface AccessoryUpdateInput extends AccessoryCreateInput {
    id: number;
}

export interface AccessoryFilterOptions {
    search?: string;
    accessoryType?: string;
    minPrice?: number;
    maxPrice?: number;
}

export interface AccessoryValidationResult {
    isValid: boolean;
    errors: string[];
}

export class AccessoryService {
    /**
     * ĞŸĞ¾Ğ»ÑƒÑ‡Ğ°ĞµÑ‚ Ğ²ÑĞµ Ğ°ĞºÑĞµÑÑÑƒĞ°Ñ€Ñ‹ Ñ Ğ¿Ğ°Ğ³Ğ¸Ğ½Ğ°Ñ†Ğ¸ĞµĞ¹
     */
    static async getAllAccessories(skip: number, limit: number): Promise<AccessoryListResponse> {
        const response = await api.get("/accessories/", {
            params: { skip, limit }
        });
        // Ğ’ĞĞ–ĞĞ: API Ğ²Ğ¾Ğ·Ğ²Ñ€Ğ°Ñ‰Ğ°ĞµÑ‚ Ğ¾Ğ±ÑŠĞµĞºÑ‚ { items: [], total: 0 },
        // Ğ¸ Ñ‚ĞµĞ¿ĞµÑ€ÑŒ Ğ½Ğ°Ñˆ ÑĞµÑ€Ğ²Ğ¸Ñ ĞºĞ¾Ñ€Ñ€ĞµĞºÑ‚Ğ½Ğ¾ ĞµĞ³Ğ¾ Ğ¾Ğ±Ñ€Ğ°Ğ±Ğ°Ñ‚Ñ‹Ğ²Ğ°ĞµÑ‚.
        return response.data;
    }

    /**
     * ĞŸĞ¾Ğ»ÑƒÑ‡Ğ°ĞµÑ‚ Ğ°ĞºÑĞµÑÑÑƒĞ°Ñ€ Ğ¿Ğ¾ ID
     */
    static async getAccessoryById(id: number): Promise<Accessory> {
        const response = await api.get(`/accessories/${id}`);
        return response.data;
    }

    /**
     * Ğ¡Ğ¾Ğ·Ğ´Ğ°ĞµÑ‚ Ğ½Ğ¾Ğ²Ñ‹Ğ¹ Ğ°ĞºÑĞµÑÑÑƒĞ°Ñ€
     */
    static async createAccessory(input: AccessoryCreateInput): Promise<Accessory> {
        const response = await api.post("/accessories/", input);
        return response.data;
    }

    /**
     * ĞĞ±Ğ½Ğ¾Ğ²Ğ»ÑĞµÑ‚ Ğ°ĞºÑĞµÑÑÑƒĞ°Ñ€
     */
    static async updateAccessory(input: AccessoryUpdateInput): Promise<Accessory> {
        const response = await api.put(`/accessories/${input.id}`, input);
        return response.data;
    }

    /**
     * Ğ£Ğ´Ğ°Ğ»ÑĞµÑ‚ Ğ°ĞºÑĞµÑÑÑƒĞ°Ñ€
     */
    static async deleteAccessory(id: number): Promise<void> {
        await api.delete(`/accessories/${id}`);
    }

    /**
     * ĞŸĞ¾Ğ»ÑƒÑ‡Ğ°ĞµÑ‚ Ğ°ĞºÑĞµÑÑÑƒĞ°Ñ€Ñ‹ Ğ´Ğ»Ñ ĞºĞ¾Ğ½ĞºÑ€ĞµÑ‚Ğ½Ğ¾Ğ³Ğ¾ Ğ¾Ğ±Ğ¾Ñ€ÑƒĞ´Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ
     */
    static async getAccessoriesForEquipment(equipmentId: number): Promise<Accessory[]> {
        const response = await api.get(`/equipment/${equipmentId}/accessories`);
        return response.data;
    }

    /**
     * Ğ¤Ğ¸Ğ»ÑŒÑ‚Ñ€ÑƒĞµÑ‚ Ğ°ĞºÑĞµÑÑÑƒĞ°Ñ€Ñ‹ Ğ¿Ğ¾ Ğ·Ğ°Ğ´Ğ°Ğ½Ğ½Ñ‹Ğ¼ ĞºÑ€Ğ¸Ñ‚ĞµÑ€Ğ¸ÑĞ¼
     */
    static filterAccessories(
        accessories: Accessory[],
        filters: AccessoryFilterOptions
    ): Accessory[] {
        return accessories.filter(accessory => {
            // Ğ¤Ğ¸Ğ»ÑŒÑ‚Ñ€ Ğ¿Ğ¾ Ğ¿Ğ¾Ğ¸ÑĞºÑƒ
            if (filters.search) {
                const searchLower = filters.search.toLowerCase();
                const matchesSearch =
                    accessory.name.toLowerCase().includes(searchLower) ||
                    accessory.accessory_type.toLowerCase().includes(searchLower) ||
                    (accessory.description && accessory.description.toLowerCase().includes(searchLower));

                if (!matchesSearch) {
                    return false;
                }
            }

            // Ğ¤Ğ¸Ğ»ÑŒÑ‚Ñ€ Ğ¿Ğ¾ Ñ‚Ğ¸Ğ¿Ñƒ Ğ°ĞºÑĞµÑÑÑƒĞ°Ñ€Ğ°
            if (filters.accessoryType && accessory.accessory_type !== filters.accessoryType) {
                return false;
            }

            // Ğ¤Ğ¸Ğ»ÑŒÑ‚Ñ€ Ğ¿Ğ¾ Ğ¼Ğ¸Ğ½Ğ¸Ğ¼Ğ°Ğ»ÑŒĞ½Ğ¾Ğ¹ Ñ†ĞµĞ½Ğµ
            if (filters.minPrice !== undefined && accessory.price < filters.minPrice) {
                return false;
            }

            // Ğ¤Ğ¸Ğ»ÑŒÑ‚Ñ€ Ğ¿Ğ¾ Ğ¼Ğ°ĞºÑĞ¸Ğ¼Ğ°Ğ»ÑŒĞ½Ğ¾Ğ¹ Ñ†ĞµĞ½Ğµ
            if (filters.maxPrice !== undefined && accessory.price > filters.maxPrice) {
                return false;
            }

            return true;
        });
    }

    /**
     * Ğ“Ñ€ÑƒĞ¿Ğ¿Ğ¸Ñ€ÑƒĞµÑ‚ Ğ°ĞºÑĞµÑÑÑƒĞ°Ñ€Ñ‹ Ğ¿Ğ¾ Ñ‚Ğ¸Ğ¿Ñƒ
     */
    static groupAccessoriesByType(accessories: Accessory[]): Record<string, Accessory[]> {
        return accessories.reduce((acc, accessory) => {
            const type = accessory.accessory_type;
            if (!acc[type]) {
                acc[type] = [];
            }
            acc[type].push(accessory);
            return acc;
        }, {} as Record<string, Accessory[]>);
    }

    /**
     * Ğ¡Ğ¾Ñ€Ñ‚Ğ¸Ñ€ÑƒĞµÑ‚ Ğ°ĞºÑĞµÑÑÑƒĞ°Ñ€Ñ‹ Ğ¿Ğ¾ Ğ·Ğ°Ğ´Ğ°Ğ½Ğ½Ğ¾Ğ¼Ñƒ ĞºÑ€Ğ¸Ñ‚ĞµÑ€Ğ¸Ñ
     */
    static sortAccessories(
        accessories: Accessory[],
        sortBy: 'name' | 'accessory_type' | 'price',
        sortOrder: 'asc' | 'desc' = 'asc'
    ): Accessory[] {
        return [...accessories].sort((a, b) => {
            let aValue: any = a[sortBy];
            let bValue: any = b[sortBy];

            // Ğ”Ğ»Ñ Ñ‡Ğ¸ÑĞµĞ» (price)
            if (sortBy === 'price') {
                aValue = Number(aValue) || 0;
                bValue = Number(bValue) || 0;
            }

            // Ğ¡Ñ‚Ñ€Ğ¾ĞºĞ¾Ğ²Ğ¾Ğµ ÑÑ€Ğ°Ğ²Ğ½ĞµĞ½Ğ¸Ğµ
            if (typeof aValue === 'string' && typeof bValue === 'string') {
                aValue = aValue.toLowerCase();
                bValue = bValue.toLowerCase();
            }

            if (aValue < bValue) {
                return sortOrder === 'asc' ? -1 : 1;
            }
            if (aValue > bValue) {
                return sortOrder === 'asc' ? 1 : -1;
            }
            return 0;
        });
    }

    /**
     * Ğ’Ğ°Ğ»Ğ¸Ğ´Ğ¸Ñ€ÑƒĞµÑ‚ Ğ´Ğ°Ğ½Ğ½Ñ‹Ğµ Ğ°ĞºÑĞµÑÑÑƒĞ°Ñ€Ğ°
     */
    static validateAccessoryData(input: AccessoryCreateInput): AccessoryValidationResult {
        const errors: string[] = [];

        if (!input.name?.trim()) {
            errors.push("ĞĞ°Ğ·Ğ²Ğ°Ğ½Ğ¸Ğµ Ğ°ĞºÑĞµÑÑÑƒĞ°Ñ€Ğ° Ğ¾Ğ±ÑĞ·Ğ°Ñ‚ĞµĞ»ÑŒĞ½Ğ¾");
        }

        if (!input.accessory_type?.trim()) {
            errors.push("Ğ¢Ğ¸Ğ¿ Ğ°ĞºÑĞµÑÑÑƒĞ°Ñ€Ğ° Ğ¾Ğ±ÑĞ·Ğ°Ñ‚ĞµĞ»ĞµĞ½");
        }

        if (input.price <= 0) {
            errors.push("Ğ¦ĞµĞ½Ğ° Ğ´Ğ¾Ğ»Ğ¶Ğ½Ğ° Ğ±Ñ‹Ñ‚ÑŒ Ğ±Ğ¾Ğ»ÑŒÑˆĞµ Ğ½ÑƒĞ»Ñ");
        }

        return {
            isValid: errors.length === 0,
            errors
        };
    }

    /**
     * Ğ Ğ°ÑÑÑ‡Ğ¸Ñ‚Ñ‹Ğ²Ğ°ĞµÑ‚ Ğ¾Ğ±Ñ‰ÑƒÑ ÑÑ‚Ğ¾Ğ¸Ğ¼Ğ¾ÑÑ‚ÑŒ Ğ²Ñ‹Ğ±Ñ€Ğ°Ğ½Ğ½Ñ‹Ñ… Ğ°ĞºÑĞµÑÑÑƒĞ°Ñ€Ğ¾Ğ²
     */
    static calculateAccessoriesTotal(
        selectedAccessories: Record<number, number[]>,
        allAccessories: Accessory[]
    ): number {
        let total = 0;

        Object.entries(selectedAccessories).forEach(([equipmentId, accessoryIds]) => {
            accessoryIds.forEach(accessoryId => {
                const accessory = allAccessories.find(acc => acc.id === accessoryId);
                if (accessory) {
                    total += accessory.price;
                }
            });
        });

        return total;
    }

    /**
     * ĞŸĞ¾Ğ»ÑƒÑ‡Ğ°ĞµÑ‚ Ğ°ĞºÑĞµÑÑÑƒĞ°Ñ€Ñ‹ Ğ¿Ğ¾ Ğ¸Ñ… ID
     */
    static getAccessoriesByIds(
        accessoryIds: number[],
        allAccessories: Accessory[]
    ): Accessory[] {
        return allAccessories.filter(accessory => accessoryIds.includes(accessory.id));
    }

    /**
     * Ğ“ĞµĞ½ĞµÑ€Ğ¸Ñ€ÑƒĞµÑ‚ ĞºĞ»ÑÑ‡ Ğ´Ğ»Ñ ĞºÑÑˆĞ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ Ğ°ĞºÑĞµÑÑÑƒĞ°Ñ€Ğ¾Ğ²
     */
    static generateAccessoriesCacheKey(filters?: AccessoryFilterOptions): string {
        return JSON.stringify(["accessories", filters]);
    }

    /**
     * Ğ“ĞµĞ½ĞµÑ€Ğ¸Ñ€ÑƒĞµÑ‚ ĞºĞ»ÑÑ‡ Ğ´Ğ»Ñ ĞºÑÑˆĞ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ Ğ°ĞºÑĞµÑÑÑƒĞ°Ñ€Ğ¾Ğ² Ğ¾Ğ±Ğ¾Ñ€ÑƒĞ´Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ
     */
    static generateEquipmentAccessoriesCacheKey(equipmentId: number): string {
        return JSON.stringify(["equipment-accessories", equipmentId]);
    }
}

```


## <a name="srccoreservicesAvailabilityServicets"></a>`src/core/services/AvailabilityService.ts`

```typescript
// path: src/core/services/AvailabilityService.ts

// src/core/services/AvailabilityService.ts

import { api } from "@/lib/api";
import { formatDate } from "@/lib/utils";
import type { AvailabilityInfo, AvailabilityListResponse, DayStatus } from "@/types/availability";

export interface AvailabilityStatusParams {
    equipmentIds: number[];
    startDate: Date;
    endDate: Date;
    excludeReservationId?: number;
}

export interface DailyStatusParams {
    equipmentIds: number[];
    startDate: Date;
    endDate: Date;
    excludeReservationId?: number;
}

export interface ConflictCheckParams {
    equipmentIds: number[];
    startDate: Date;
    endDate: Date;
    excludeReservationId?: number;
}

/**
 * Ğ¡ĞµÑ€Ğ²Ğ¸Ñ Ğ´Ğ»Ñ Ñ€Ğ°Ğ±Ğ¾Ñ‚Ñ‹ Ñ Ğ´Ğ¾ÑÑ‚ÑƒĞ¿Ğ½Ğ¾ÑÑ‚ÑŒÑ Ğ¾Ğ±Ğ¾Ñ€ÑƒĞ´Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ.
 * Ğ¦ĞµĞ½Ñ‚Ñ€Ğ°Ğ»Ğ¸Ğ·ÑƒĞµÑ‚ Ğ²ÑĞµ API-Ğ·Ğ°Ğ¿Ñ€Ğ¾ÑÑ‹, ÑĞ²ÑĞ·Ğ°Ğ½Ğ½Ñ‹Ğµ Ñ Ğ¿Ñ€Ğ¾Ğ²ĞµÑ€ĞºĞ¾Ğ¹ Ğ´Ğ¾ÑÑ‚ÑƒĞ¿Ğ½Ğ¾ÑÑ‚Ğ¸.
 */
export class AvailabilityService {
    /**
     * ĞŸĞ¾Ğ»ÑƒÑ‡Ğ°ĞµÑ‚ Ğ¾Ğ±Ñ‰Ğ¸Ğ¹ ÑÑ‚Ğ°Ñ‚ÑƒÑ (available, rented, reserved) Ğ´Ğ»Ñ ÑĞ¿Ğ¸ÑĞºĞ° Ğ¾Ğ±Ğ¾Ñ€ÑƒĞ´Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ.
     * Ğ’Ñ‹Ğ·Ñ‹Ğ²Ğ°ĞµÑ‚ ÑĞ½Ğ´Ğ¿Ğ¾Ğ¸Ğ½Ñ‚ /calendar/view.
     */
    static async getStatuses(params: AvailabilityStatusParams): Promise<AvailabilityInfo[]> {
        if (!params.startDate || !params.endDate || params.equipmentIds.length === 0) {
            return [];
        }

        const searchParams = new URLSearchParams();
        
        searchParams.append("start", formatDate(params.startDate));
        searchParams.append("end", formatDate(params.endDate));
        
        params.equipmentIds.forEach(id => {
            searchParams.append("ids", id.toString());
        });

        if (params.excludeReservationId !== undefined) {
            searchParams.append("exclude_reservation_id", params.excludeReservationId.toString());
        }

        const response = await api.get<AvailabilityListResponse>(`/calendar/view?${searchParams.toString()}`);
        return response.data.items;
    }

    /**
     * ĞŸĞ¾Ğ»ÑƒÑ‡Ğ°ĞµÑ‚ ÑÑ‚Ğ°Ñ‚ÑƒÑÑ‹ Ğ¿Ğ¾ Ğ´Ğ½ÑĞ¼ Ğ´Ğ»Ñ ĞºĞ°Ğ»ĞµĞ½Ğ´Ğ°Ñ€Ñ-Ğ¿Ğ¾Ğ»Ğ¾ÑĞºĞ¸.
     * Ğ’Ñ‹Ğ·Ñ‹Ğ²Ğ°ĞµÑ‚ ÑĞ½Ğ´Ğ¿Ğ¾Ğ¸Ğ½Ñ‚ /calendar/day-statuses.
     */
    static async getDailyStatuses(params: DailyStatusParams): Promise<Record<number, DayStatus[]>> {
        if (!params.startDate || !params.endDate || params.equipmentIds.length === 0) {
            return {};
        }

        const searchParams = new URLSearchParams();
        
        searchParams.append("start", formatDate(params.startDate));
        searchParams.append("end", formatDate(params.endDate));
        
        params.equipmentIds.forEach(id => {
            searchParams.append("ids", id.toString());
        });

        if (params.excludeReservationId !== undefined) {
            searchParams.append("exclude_reservation_id", params.excludeReservationId.toString());
        }

        const response = await api.get<Record<number, DayStatus[]>>(`/calendar/day-statuses?${searchParams.toString()}`);
        return response.data;
    }

    /**
     * ĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑĞµÑ‚ ĞºĞ¾Ğ½Ñ„Ğ»Ğ¸ĞºÑ‚Ñ‹ Ğ´Ğ»Ñ ÑƒĞºĞ°Ğ·Ğ°Ğ½Ğ½Ğ¾Ğ³Ğ¾ Ğ¾Ğ±Ğ¾Ñ€ÑƒĞ´Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ.
     * Ğ’Ğ¾Ğ·Ğ²Ñ€Ğ°Ñ‰Ğ°ĞµÑ‚ ÑĞ¿Ğ¸ÑĞ¾Ğº ID Ğ¾Ğ±Ğ¾Ñ€ÑƒĞ´Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ Ñ ĞºĞ¾Ğ½Ñ„Ğ»Ğ¸ĞºÑ‚Ğ°Ğ¼Ğ¸.
     * Ğ­Ñ‚Ğ¾Ñ‚ Ğ¼ĞµÑ‚Ğ¾Ğ´ Ğ¼Ğ¾Ğ¶ĞµÑ‚ Ğ±Ñ‹Ñ‚ÑŒ Ğ¾Ğ¿Ñ†Ğ¸Ğ¾Ğ½Ğ°Ğ»ÑŒĞ½Ñ‹Ğ¼, ĞµÑĞ»Ğ¸ getStatuses Ğ²Ğ¾Ğ·Ğ²Ñ€Ğ°Ñ‰Ğ°ĞµÑ‚ Ğ´Ğ¾ÑÑ‚Ğ°Ñ‚Ğ¾Ñ‡Ğ½Ğ¾ Ğ¸Ğ½Ñ„Ğ¾Ñ€Ğ¼Ğ°Ñ†Ğ¸Ğ¸.
     */
    static async checkConflicts(params: ConflictCheckParams): Promise<number[]> {
        const statuses = await this.getStatuses(params);
        
        return statuses
            .filter(info => info.status === "reserved" || info.status === "rented")
            .map(info => info.equipment_id);
    }
}


```


## <a name="srccoreservicesCalendarServicets"></a>`src/core/services/CalendarService.ts`

```typescript
// path: src/core/services/CalendarService.ts

// src/core/services/CalendarService.ts
import { api } from "@/lib/api";
import type { DayStatus } from "@/types/availability";
import type { Equipment } from "@/types/equipment";

export interface CalendarGridData {
  [equipmentId: number]: {
    [date: string]: DayStatus;
  };
}

export interface CalendarFilterOptions {
  type?: string;
  brand?: string;
  query?: string;
}

export class CalendarService {
  /**
   * ĞŸĞ¾Ğ»ÑƒÑ‡Ğ°ĞµÑ‚ ÑÑ‚Ğ°Ñ‚ÑƒÑÑ‹ Ğ´Ğ½ĞµĞ¹ Ğ´Ğ»Ñ ĞºĞ°Ğ»ĞµĞ½Ğ´Ğ°Ñ€Ñ
   */
  static async getDayStatuses(
    startDate: string,
    endDate: string,
    equipmentIds: number[]
  ): Promise<CalendarGridData> {
    if (!startDate || !endDate) {
      console.warn(
        "[CalendarService] getDayStatuses Ğ²Ñ‹Ğ·Ğ²Ğ°Ğ½ Ñ Ğ½ĞµĞ²Ğ°Ğ»Ğ¸Ğ´Ğ½Ñ‹Ğ¼Ğ¸ Ğ´Ğ°Ñ‚Ğ°Ğ¼Ğ¸"
      );
      return {};
    }

    if (equipmentIds.length === 0) {
      console.warn(
        "[CalendarService] getDayStatuses Ğ²Ñ‹Ğ·Ğ²Ğ°Ğ½ Ñ Ğ¿ÑƒÑÑ‚Ñ‹Ğ¼ ÑĞ¿Ğ¸ÑĞºĞ¾Ğ¼ ID Ğ¾Ğ±Ğ¾Ñ€ÑƒĞ´Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ"
      );
      return {};
    }

    try {
      const response = await api.get("/calendar/day-statuses", {
        params: {
          start: startDate,
          end: endDate,
          ids: equipmentIds,
        },
      });

      console.log(
        "[CalendarService] API response for /calendar/day-statuses:",
        response
      );

      if (
        response?.data?.equipment_day_statuses !== undefined
      ) {
        return response.data.equipment_day_statuses;
      } else {
        console.error(
          "[CalendarService] API response did not contain 'equipment_day_statuses'",
          response?.data
        );
        return {};
      }
    } catch (error) {
      console.error(
        "[CalendarService] Error fetching /calendar/day-statuses:",
        error
      );
      throw error;
    }
  }

  /**
   * Ğ¤Ğ¸Ğ»ÑŒÑ‚Ñ€ÑƒĞµÑ‚ Ğ¾Ğ±Ğ¾Ñ€ÑƒĞ´Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ Ğ´Ğ»Ñ ĞºĞ°Ğ»ĞµĞ½Ğ´Ğ°Ñ€Ñ Ğ¿Ğ¾ Ğ·Ğ°Ğ´Ğ°Ğ½Ğ½Ñ‹Ğ¼ ĞºÑ€Ğ¸Ñ‚ĞµÑ€Ğ¸ÑĞ¼
   */
  static filterEquipmentForCalendar(
    equipment: Equipment[],
    options: CalendarFilterOptions
  ): number[] {
    return equipment
      .filter((item) => {
        // Ğ¤Ğ¸Ğ»ÑŒÑ‚Ñ€ Ğ¿Ğ¾ Ñ‚Ğ¸Ğ¿Ñƒ
        if (options.type && options.type !== item.equipment_type) {
          return false;
        }

        // Ğ¤Ğ¸Ğ»ÑŒÑ‚Ñ€ Ğ¿Ğ¾ Ğ±Ñ€ĞµĞ½Ğ´Ñƒ
        if (options.brand && options.brand !== "__all__" && options.brand !== item.brand) {
          return false;
        }

        // Ğ¤Ğ¸Ğ»ÑŒÑ‚Ñ€ Ğ¿Ğ¾ Ğ¿Ğ¾Ğ¸ÑĞºĞ¾Ğ²Ğ¾Ğ¼Ñƒ Ğ·Ğ°Ğ¿Ñ€Ğ¾ÑÑƒ
        if (options.query) {
          const query = options.query.toLowerCase();
          const matchesQuery =
            item.name?.toLowerCase().includes(query) ||
            item.brand?.toLowerCase().includes(query) ||
            item.equipment_type?.toLowerCase().includes(query);
          
          if (!matchesQuery) {
            return false;
          }
        }

        return true;
      })
      .map((item) => item.id);
  }

  /**
   * Ğ¡Ğ¾Ğ·Ğ´Ğ°ĞµÑ‚ ĞºĞ»ÑÑ‡ Ğ·Ğ°Ğ¿Ñ€Ğ¾ÑĞ° Ğ´Ğ»Ñ ĞºÑÑˆĞ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ
   */
  static createQueryKey(
    startDate: string,
    endDate: string,
    equipmentIds: number[]
  ): string[] {
    return [
      "calendar-grid",
      startDate,
      endDate,
      JSON.stringify(equipmentIds.sort((a, b) => a - b)),
    ];
  }
} 

```


## <a name="srccoreservicesDateServicets"></a>`src/core/services/DateService.ts`

```typescript
// path: src/core/services/DateService.ts

// src/core/services/DateService.ts

import { addDays, format } from 'date-fns';

export interface DateRange {
  startDate: Date;
  endDate: Date;
}

export interface DateRangeValidationResult {
  isValid: boolean;
  error?: string;
  adjustedRange?: DateRange;
}

export class DateService {
  /**
   * ĞšĞ¾Ñ€Ñ€ĞµĞºÑ‚Ğ¸Ñ€ÑƒĞµÑ‚ Ğ´Ğ°Ñ‚Ñƒ, ĞµÑĞ»Ğ¸ Ğ¾Ğ½Ğ° Ğ²Ñ‹Ğ¿Ğ°Ğ´Ğ°ĞµÑ‚ Ğ½Ğ° Ğ²Ñ‹Ñ…Ğ¾Ğ´Ğ½Ğ¾Ğ¹, ÑĞ´Ğ²Ğ¸Ğ³Ğ°Ñ ĞµÑ‘ Ğ½Ğ° Ğ±Ğ»Ğ¸Ğ¶Ğ°Ğ¹ÑˆĞ¸Ğ¹ Ñ€Ğ°Ğ±Ğ¾Ñ‡Ğ¸Ğ¹ Ğ´ĞµĞ½ÑŒ.
   * @param date - ĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑĞµĞ¼Ğ°Ñ Ğ´Ğ°Ñ‚Ğ°
   * @param holidays - ĞœĞ°ÑÑĞ¸Ğ² Ğ´Ğ°Ñ‚-Ğ²Ñ‹Ñ…Ğ¾Ğ´Ğ½Ñ‹Ñ…
   * @returns Ğ¡ĞºĞ¾Ñ€Ñ€ĞµĞºÑ‚Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ½Ğ°Ñ Ğ´Ğ°Ñ‚Ğ°
   */
  static adjustDateIfHoliday(date: Date, holidays: Date[]): Date {
    let adjustedDate = new Date(date);
    const holidaySet = new Set(holidays.map(h => format(h, 'yyyy-MM-dd')));

    // ĞŸĞ¾ĞºĞ° Ğ¸Ñ‚Ğ¾Ğ³Ğ¾Ğ²Ğ°Ñ Ğ´Ğ°Ñ‚Ğ° ÑĞ²Ğ»ÑĞµÑ‚ÑÑ Ğ²Ñ‹Ñ…Ğ¾Ğ´Ğ½Ñ‹Ğ¼, Ğ´Ğ¾Ğ±Ğ°Ğ²Ğ»ÑĞµĞ¼ Ğ¾Ğ´Ğ¸Ğ½ Ğ´ĞµĞ½ÑŒ
    while (holidaySet.has(format(adjustedDate, 'yyyy-MM-dd'))) {
      adjustedDate = addDays(adjustedDate, 1);
    }
    return adjustedDate;
  }

  /**
   * Ğ’Ğ°Ğ»Ğ¸Ğ´Ğ¸Ñ€ÑƒĞµÑ‚ Ğ´Ğ¸Ğ°Ğ¿Ğ°Ğ·Ğ¾Ğ½ Ğ´Ğ°Ñ‚
   */
  static validateDateRange(startDate: Date, endDate: Date): DateRangeValidationResult {
    if (!startDate || !endDate) {
      return {
        isValid: false,
        error: 'Ğ”Ğ°Ñ‚Ñ‹ Ğ½Ğ°Ñ‡Ğ°Ğ»Ğ° Ğ¸ Ğ¾ĞºĞ¾Ğ½Ñ‡Ğ°Ğ½Ğ¸Ñ Ğ¾Ğ±ÑĞ·Ğ°Ñ‚ĞµĞ»ÑŒĞ½Ñ‹'
      };
    }

    if (isNaN(startDate.getTime()) || isNaN(endDate.getTime())) {
      return {
        isValid: false,
        error: 'ĞĞµĞºĞ¾Ñ€Ñ€ĞµĞºÑ‚Ğ½Ñ‹Ğ¹ Ñ„Ğ¾Ñ€Ğ¼Ğ°Ñ‚ Ğ´Ğ°Ñ‚Ñ‹'
      };
    }

    if (startDate >= endDate) {
      return {
        isValid: false,
        error: 'Ğ”Ğ°Ñ‚Ğ° Ğ¾ĞºĞ¾Ğ½Ñ‡Ğ°Ğ½Ğ¸Ñ Ğ´Ğ¾Ğ»Ğ¶Ğ½Ğ° Ğ±Ñ‹Ñ‚ÑŒ Ğ¿Ğ¾Ğ·Ğ¶Ğµ Ğ´Ğ°Ñ‚Ñ‹ Ğ½Ğ°Ñ‡Ğ°Ğ»Ğ°'
      };
    }

    return {
      isValid: true
    };
  }

  /**
   * ĞšĞ¾Ñ€Ñ€ĞµĞºÑ‚Ğ¸Ñ€ÑƒĞµÑ‚ Ğ´Ğ¸Ğ°Ğ¿Ğ°Ğ·Ğ¾Ğ½ Ğ´Ğ°Ñ‚, ĞµÑĞ»Ğ¸ endDate Ñ€Ğ°Ğ½ÑŒÑˆĞµ startDate
   */
  static adjustDateRange(startDate: Date, endDate: Date): DateRange {
    if (startDate >= endDate) {
      const adjustedEndDate = new Date(startDate);
      adjustedEndDate.setDate(adjustedEndDate.getDate() + 1);
      return {
        startDate,
        endDate: adjustedEndDate
      };
    }

    return { startDate, endDate };
  }

  /**
   * ĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑĞµÑ‚, ÑĞ²Ğ»ÑĞµÑ‚ÑÑ Ğ»Ğ¸ Ğ´Ğ°Ñ‚Ğ° Ğ²Ğ°Ğ»Ğ¸Ğ´Ğ½Ğ¾Ğ¹
   */
  static isValidDate(date: Date): boolean {
    return date instanceof Date && !isNaN(date.getTime());
  }

  /**
   * Ğ¡Ğ¾Ğ·Ğ´Ğ°ĞµÑ‚ ÑĞ»ĞµĞ´ÑƒÑÑ‰ÑƒÑ Ğ´Ğ°Ñ‚Ñƒ Ğ¿Ğ¾ÑĞ»Ğµ ÑƒĞºĞ°Ğ·Ğ°Ğ½Ğ½Ğ¾Ğ¹
   */
  static getNextDay(date: Date): Date {
    const nextDay = new Date(date);
    nextDay.setDate(nextDay.getDate() + 1);
    return nextDay;
  }

  /**
   * Ğ¡Ğ¾Ğ·Ğ´Ğ°ĞµÑ‚ Ğ¿Ñ€ĞµĞ´Ñ‹Ğ´ÑƒÑ‰ÑƒÑ Ğ´Ğ°Ñ‚Ñƒ Ğ¿ĞµÑ€ĞµĞ´ ÑƒĞºĞ°Ğ·Ğ°Ğ½Ğ½Ğ¾Ğ¹
   */
  static getPreviousDay(date: Date): Date {
    const previousDay = new Date(date);
    previousDay.setDate(previousDay.getDate() - 1);
    return previousDay;
  }

  /**
   * Ğ’Ñ‹Ñ‡Ğ¸ÑĞ»ÑĞµÑ‚ ĞºĞ¾Ğ»Ğ¸Ñ‡ĞµÑÑ‚Ğ²Ğ¾ Ğ´Ğ½ĞµĞ¹ Ğ¼ĞµĞ¶Ğ´Ñƒ Ğ´Ğ²ÑƒĞ¼Ñ Ğ´Ğ°Ñ‚Ğ°Ğ¼Ğ¸
   */
  static getDaysDifference(startDate: Date, endDate: Date): number {
    const timeDiff = endDate.getTime() - startDate.getTime();
    return Math.ceil(timeDiff / (1000 * 3600 * 24));
  }

  /**
   * ĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑĞµÑ‚, Ğ½Ğ°Ñ…Ğ¾Ğ´Ğ¸Ñ‚ÑÑ Ğ»Ğ¸ Ğ´Ğ°Ñ‚Ğ° Ğ² Ğ·Ğ°Ğ´Ğ°Ğ½Ğ½Ğ¾Ğ¼ Ğ´Ğ¸Ğ°Ğ¿Ğ°Ğ·Ğ¾Ğ½Ğµ
   */
  static isDateInRange(date: Date, startDate: Date, endDate: Date): boolean {
    return date >= startDate && date <= endDate;
  }

  /**
   * Ğ¤Ğ¾Ñ€Ğ¼Ğ°Ñ‚Ğ¸Ñ€ÑƒĞµÑ‚ Ğ´Ğ°Ñ‚Ñƒ Ğ² ÑÑ‚Ñ€Ğ¾ĞºÑƒ Ğ´Ğ»Ñ API (YYYY-MM-DD)
   */
  static formatDateForAPI(date: Date): string {
    return date.toISOString().split('T')[0];
  }

  /**
   * ĞŸĞ°Ñ€ÑĞ¸Ñ‚ ÑÑ‚Ñ€Ğ¾ĞºÑƒ Ğ´Ğ°Ñ‚Ñ‹ Ğ² Ğ¾Ğ±ÑŠĞµĞºÑ‚ Date
   */
  static parseDate(dateString: string): Date | null {
    const date = new Date(dateString);
    return this.isValidDate(date) ? date : null;
  }

  /**
   * ĞĞ°Ñ…Ğ¾Ğ´Ğ¸Ñ‚ ÑĞ»ĞµĞ´ÑƒÑÑ‰Ğ¸Ğ¹ Ñ€Ğ°Ğ±Ğ¾Ñ‡Ğ¸Ğ¹ Ğ´ĞµĞ½ÑŒ, Ğ¸ÑĞºĞ»ÑÑ‡Ğ°Ñ Ğ¿Ñ€Ğ°Ğ·Ğ´Ğ½Ğ¸ĞºĞ¸
   * @param startDate - Ğ½Ğ°Ñ‡Ğ°Ğ»ÑŒĞ½Ğ°Ñ Ğ´Ğ°Ñ‚Ğ°
   * @param holidays - Ğ¼Ğ°ÑÑĞ¸Ğ² Ğ´Ğ°Ñ‚ Ğ¿Ñ€Ğ°Ğ·Ğ´Ğ½Ğ¸ĞºĞ¾Ğ²
   * @param daysToAdd - ĞºĞ¾Ğ»Ğ¸Ñ‡ĞµÑÑ‚Ğ²Ğ¾ Ğ´Ğ½ĞµĞ¹ Ğ´Ğ»Ñ Ğ´Ğ¾Ğ±Ğ°Ğ²Ğ»ĞµĞ½Ğ¸Ñ (Ğ¿Ğ¾ ÑƒĞ¼Ğ¾Ğ»Ñ‡Ğ°Ğ½Ğ¸Ñ 1)
   * @returns Ğ”Ğ°Ñ‚Ğ° ÑĞ»ĞµĞ´ÑƒÑÑ‰ĞµĞ³Ğ¾ Ñ€Ğ°Ğ±Ğ¾Ñ‡ĞµĞ³Ğ¾ Ğ´Ğ½Ñ
   */
  static findNextWorkingDay(startDate: Date, holidays: Date[], daysToAdd: number = 1): Date {
    let finalDate = addDays(startDate, daysToAdd);

    // Ğ¡Ğ¾Ğ·Ğ´Ğ°ĞµĞ¼ Set Ğ¸Ğ· Ğ´Ğ°Ñ‚ Ğ¿Ñ€Ğ°Ğ·Ğ´Ğ½Ğ¸ĞºĞ¾Ğ² Ğ´Ğ»Ñ Ğ±Ñ‹ÑÑ‚Ñ€Ğ¾Ğ¹ Ğ¿Ñ€Ğ¾Ğ²ĞµÑ€ĞºĞ¸
    const holidaySet = new Set(holidays.map(h => format(h, 'yyyy-MM-dd')));

    // ĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑĞµĞ¼, Ğ½Ğµ ÑĞ²Ğ»ÑĞµÑ‚ÑÑ Ğ»Ğ¸ ĞºĞ¾Ğ½ĞµÑ‡Ğ½Ğ°Ñ Ğ´Ğ°Ñ‚Ğ° Ğ²Ñ‹Ñ…Ğ¾Ğ´Ğ½Ñ‹Ğ¼.
    // Ğ•ÑĞ»Ğ¸ Ğ´Ğ°, ÑĞ´Ğ²Ğ¸Ğ³Ğ°ĞµĞ¼ ĞµĞµ Ğ²Ğ¿ĞµÑ€ĞµĞ´ Ğ´Ğ¾ Ñ‚ĞµÑ… Ğ¿Ğ¾Ñ€, Ğ¿Ğ¾ĞºĞ° Ğ½Ğµ Ğ½Ğ°Ğ¹Ğ´ĞµĞ¼ Ñ€Ğ°Ğ±Ğ¾Ñ‡Ğ¸Ğ¹ Ğ´ĞµĞ½ÑŒ.
    while (holidaySet.has(format(finalDate, 'yyyy-MM-dd'))) {
      finalDate = addDays(finalDate, 1);
    }

    return finalDate;
  }

  /**
   * Ğ¡Ğ¾Ğ·Ğ´Ğ°ĞµÑ‚ Ğ´Ğ¸Ğ°Ğ¿Ğ°Ğ·Ğ¾Ğ½ Ğ´Ğ°Ñ‚ Ñ Ğ°Ğ²Ñ‚Ğ¾Ğ¼Ğ°Ñ‚Ğ¸Ñ‡ĞµÑĞºĞ¸Ğ¼ Ğ¿Ğ¾Ğ¸ÑĞºĞ¾Ğ¼ Ñ€Ğ°Ğ±Ğ¾Ñ‡ĞµĞ³Ğ¾ Ğ´Ğ½Ñ Ğ¾ĞºĞ¾Ğ½Ñ‡Ğ°Ğ½Ğ¸Ñ
   * @param startDate - Ğ´Ğ°Ñ‚Ğ° Ğ½Ğ°Ñ‡Ğ°Ğ»Ğ°
   * @param holidays - Ğ¼Ğ°ÑÑĞ¸Ğ² Ğ´Ğ°Ñ‚ Ğ¿Ñ€Ğ°Ğ·Ğ´Ğ½Ğ¸ĞºĞ¾Ğ²
   * @param daysToAdd - ĞºĞ¾Ğ»Ğ¸Ñ‡ĞµÑÑ‚Ğ²Ğ¾ Ğ´Ğ½ĞµĞ¹ Ğ´Ğ»Ñ Ğ´Ğ¾Ğ±Ğ°Ğ²Ğ»ĞµĞ½Ğ¸Ñ (Ğ¿Ğ¾ ÑƒĞ¼Ğ¾Ğ»Ñ‡Ğ°Ğ½Ğ¸Ñ 1)
   * @returns ĞĞ±ÑŠĞµĞºÑ‚ Ñ Ğ´Ğ°Ñ‚Ğ°Ğ¼Ğ¸ Ğ½Ğ°Ñ‡Ğ°Ğ»Ğ° Ğ¸ Ğ¾ĞºĞ¾Ğ½Ñ‡Ğ°Ğ½Ğ¸Ñ
   */
  static createWorkingDayRange(startDate: Date, holidays: Date[], daysToAdd: number = 1): DateRange {
    const endDate = this.findNextWorkingDay(startDate, holidays, daysToAdd);
    return {
      startDate,
      endDate
    };
  }
}

```


## <a name="srccoreservicesEquipmentServicets"></a>`src/core/services/EquipmentService.ts`

```typescript
// path: src/core/services/EquipmentService.ts

// src/core/services/EquipmentService.ts

import { api } from "@/lib/api";
import type { Equipment } from "@/types/equipment";
import type { AvailabilityInfo, AvailabilityListResponse } from "@/types/availability";
import { formatDate } from "@/lib/utils"; // 1. Ğ£Ğ±ĞµĞ´Ğ¸Ñ‚ĞµÑÑŒ, Ñ‡Ñ‚Ğ¾ ÑÑ‚Ğ¾Ñ‚ Ğ¸Ğ¼Ğ¿Ğ¾Ñ€Ñ‚ Ğ¿Ñ€Ğ¸ÑÑƒÑ‚ÑÑ‚Ğ²ÑƒĞµÑ‚

export interface EquipmentListResponse {
    items: Equipment[];
    total: number;
}

export interface EquipmentFilterParams {
    query?: string;
    type?: string | null;
    brand?: string | null;
    associationId?: number | null;
    startDate?: Date | null;
    endDate?: Date | null;
    availableOnly?: boolean;
}

export class EquipmentService {
    static async getAllEquipment(
        skip: number,
        limit: number,
        filters: EquipmentFilterParams = {}
    ): Promise<EquipmentListResponse> {
        const params: Record<string, any> = { skip, limit };

        if (filters.query) {
            params.query = filters.query;
        }
        if (filters.type) {
            params.type = filters.type;
        }
        if (filters.brand) {
            params.brand = filters.brand;
        }
        if (filters.associationId) {
            params.associationId = filters.associationId;
        }

        if (filters.availableOnly && filters.startDate && filters.endDate) {
            params.availableOnly = true;
            params.startDate = formatDate(filters.startDate);
            params.endDate = formatDate(filters.endDate);
        }

        const response = await api.get<EquipmentListResponse>("/equipment/", { params });
        return response.data;
    }

    static async checkAvailability(input: { ids: number[]; start: Date | null; end: Date | null; excludeReservationId?: number; }): Promise<AvailabilityInfo[]> {
        if (!input.start || !input.end || input.ids.length === 0) {
            return [];
        }

        const searchParams = new URLSearchParams();

        // V-- 2. Ğ˜Ğ¡ĞŸĞ ĞĞ’Ğ›Ğ•ĞĞ˜Ğ• Ğ—Ğ”Ğ•Ğ¡Ğ¬ --V
        searchParams.append("start", formatDate(input.start));
        searchParams.append("end", formatDate(input.end));
        // ^-- ĞšĞĞĞ•Ğ¦ Ğ˜Ğ¡ĞŸĞ ĞĞ’Ğ›Ğ•ĞĞ˜Ğ¯ --^

        input.ids.forEach(id => {
            searchParams.append("ids", id.toString());
        });

        if (input.excludeReservationId !== undefined) {
            searchParams.append("exclude_reservation_id", input.excludeReservationId.toString());
        }

        const response = await api.get<AvailabilityListResponse>(`/calendar/view?${searchParams.toString()}`);
        return response.data.items;
    }

    static filterAndGroupEquipment(
        allEquipment: Equipment[],
        searchQuery: string
    ): { tree: Record<string, Record<string, Equipment[]>>; visibleIds: number[] } {
        const lowerCaseQuery = searchQuery.toLowerCase();
        const filtered = searchQuery
            ? allEquipment.filter(item =>
                item.name.toLowerCase().includes(lowerCaseQuery) ||
                item.brand.toLowerCase().includes(lowerCaseQuery) ||
                item.equipment_type.toLowerCase().includes(lowerCaseQuery)
            )
            : allEquipment;

        const visibleIds = filtered.map(item => item.id);

        const tree: Record<string, Record<string, Equipment[]>> = {};
        for (const eq of filtered) {
            if (!tree[eq.equipment_type]) {
                tree[eq.equipment_type] = {};
            }
            if (!tree[eq.equipment_type][eq.brand]) {
                tree[eq.equipment_type][eq.brand] = [];
            }
            tree[eq.equipment_type][eq.brand].push(eq);
        }

        return { tree, visibleIds };
    }

    static filterEquipment(
        equipmentData: Equipment[],
        params: EquipmentFilterParams
    ): Equipment[] {
        let result = equipmentData;
        if (params.query) {
            const lowerCaseQuery = params.query.toLowerCase();
            result = result.filter((item) =>
                item.name.toLowerCase().includes(lowerCaseQuery) ||
                item.brand.toLowerCase().includes(lowerCaseQuery) ||
                item.equipment_type.toLowerCase().includes(lowerCaseQuery)
            );
        }
        if (params.type) {
            result = result.filter((item) => item.equipment_type === params.type);
        }
        if (params.brand && params.brand !== "__all__") {
            result = result.filter((item) => item.brand === params.brand);
        }
        return result;
    }

    static async getEquipmentById(id: number): Promise<Equipment> {
        const response = await api.get(`/equipment/${id}`);
        return response.data;
    }

    static async createEquipment(input: Omit<Equipment, 'id' | 'accessories' | 'associations'>): Promise<Equipment> {
        const response = await api.post("/equipment/", input);
        return response.data;
    }

    static async updateEquipment(id: number, input: Partial<Omit<Equipment, 'id'>>): Promise<Equipment> {
        const response = await api.put(`/equipment/${id}`, input);
        return response.data;
    }

    static async deleteEquipment(id: number): Promise<void> {
        await api.delete(`/equipment/${id}`);
    }
}

```


## <a name="srccoreservicesPhoneServicets"></a>`src/core/services/PhoneService.ts`

```typescript
// path: src/core/services/PhoneService.ts

// src/core/services/PhoneService.ts

export interface PhoneValidationResult {
  isValid: boolean;
  error?: string;
  normalizedPhone?: string;
}

export class PhoneService {
  /**
   * Ğ’Ğ°Ğ»Ğ¸Ğ´Ğ¸Ñ€ÑƒĞµÑ‚ Ñ€Ğ¾ÑÑĞ¸Ğ¹ÑĞºĞ¸Ğ¹ Ñ‚ĞµĞ»ĞµÑ„Ğ¾Ğ½Ğ½Ñ‹Ğ¹ Ğ½Ğ¾Ğ¼ĞµÑ€
   */
  static validate(phone: string): PhoneValidationResult {
    if (!phone) {
      return {
        isValid: false,
        error: 'ĞĞ¾Ğ¼ĞµÑ€ Ñ‚ĞµĞ»ĞµÑ„Ğ¾Ğ½Ğ° Ğ¾Ğ±ÑĞ·Ğ°Ñ‚ĞµĞ»ĞµĞ½'
      };
    }

    const normalized = this.normalize(phone);
    
    // ĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑĞµĞ¼, Ñ‡Ñ‚Ğ¾ Ğ½Ğ¾Ğ¼ĞµÑ€ ÑĞ¾Ğ´ĞµÑ€Ğ¶Ğ¸Ñ‚ Ñ‚Ğ¾Ğ»ÑŒĞºĞ¾ Ñ†Ğ¸Ñ„Ñ€Ñ‹
    if (!/^\d+$/.test(normalized)) {
      return {
        isValid: false,
        error: 'ĞĞ¾Ğ¼ĞµÑ€ Ğ´Ğ¾Ğ»Ğ¶ĞµĞ½ ÑĞ¾Ğ´ĞµÑ€Ğ¶Ğ°Ñ‚ÑŒ Ñ‚Ğ¾Ğ»ÑŒĞºĞ¾ Ñ†Ğ¸Ñ„Ñ€Ñ‹'
      };
    }

    // ĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑĞµĞ¼ Ğ´Ğ»Ğ¸Ğ½Ñƒ (10 Ğ¸Ğ»Ğ¸ 11 Ñ†Ğ¸Ñ„Ñ€ Ğ´Ğ»Ñ Ñ€Ğ¾ÑÑĞ¸Ğ¹ÑĞºĞ¸Ñ… Ğ½Ğ¾Ğ¼ĞµÑ€Ğ¾Ğ²)
    if (normalized.length < 10 || normalized.length > 11) {
      return {
        isValid: false,
        error: 'ĞĞ¾Ğ¼ĞµÑ€ Ğ´Ğ¾Ğ»Ğ¶ĞµĞ½ ÑĞ¾Ğ´ĞµÑ€Ğ¶Ğ°Ñ‚ÑŒ 10 Ğ¸Ğ»Ğ¸ 11 Ñ†Ğ¸Ñ„Ñ€'
      };
    }

    // Ğ•ÑĞ»Ğ¸ 11 Ñ†Ğ¸Ñ„Ñ€, Ğ¿ĞµÑ€Ğ²Ğ°Ñ Ğ´Ğ¾Ğ»Ğ¶Ğ½Ğ° Ğ±Ñ‹Ñ‚ÑŒ 7 Ğ¸Ğ»Ğ¸ 8
    if (normalized.length === 11 && !['7', '8'].includes(normalized[0])) {
      return {
        isValid: false,
        error: 'ĞĞ¾Ğ¼ĞµÑ€ Ğ´Ğ¾Ğ»Ğ¶ĞµĞ½ Ğ½Ğ°Ñ‡Ğ¸Ğ½Ğ°Ñ‚ÑŒÑÑ Ñ 7 Ğ¸Ğ»Ğ¸ 8'
      };
    }

    return {
      isValid: true,
      normalizedPhone: normalized
    };
  }

  /**
   * ĞĞ¾Ñ€Ğ¼Ğ°Ğ»Ğ¸Ğ·ÑƒĞµÑ‚ Ñ‚ĞµĞ»ĞµÑ„Ğ¾Ğ½Ğ½Ñ‹Ğ¹ Ğ½Ğ¾Ğ¼ĞµÑ€ (ÑƒĞ±Ğ¸Ñ€Ğ°ĞµÑ‚ Ğ²ÑĞµ ÑĞ¸Ğ¼Ğ²Ğ¾Ğ»Ñ‹ ĞºÑ€Ğ¾Ğ¼Ğµ Ñ†Ğ¸Ñ„Ñ€)
   */
  static normalize(phone: string): string {
    return phone.replace(/\D/g, '');
  }

  /**
   * Ğ¤Ğ¾Ñ€Ğ¼Ğ°Ñ‚Ğ¸Ñ€ÑƒĞµÑ‚ Ñ‚ĞµĞ»ĞµÑ„Ğ¾Ğ½Ğ½Ñ‹Ğ¹ Ğ½Ğ¾Ğ¼ĞµÑ€ Ğ´Ğ»Ñ Ğ¾Ñ‚Ğ¾Ğ±Ñ€Ğ°Ğ¶ĞµĞ½Ğ¸Ñ
   */
  static format(phone: string): string {
    const normalized = this.normalize(phone);
    
    if (normalized.length === 11) {
      // +7 (XXX) XXX-XX-XX
      return `+7 (${normalized.slice(1, 4)}) ${normalized.slice(4, 7)}-${normalized.slice(7, 9)}-${normalized.slice(9)}`;
    } else if (normalized.length === 10) {
      // +7 (XXX) XXX-XX-XX (Ğ´Ğ¾Ğ±Ğ°Ğ²Ğ»ÑĞµĞ¼ 7 Ğ² Ğ½Ğ°Ñ‡Ğ°Ğ»Ğ¾)
      return `+7 (${normalized.slice(0, 3)}) ${normalized.slice(3, 6)}-${normalized.slice(6, 8)}-${normalized.slice(8)}`;
    }
    
    return phone; // Ğ’Ğ¾Ğ·Ğ²Ñ€Ğ°Ñ‰Ğ°ĞµĞ¼ ĞºĞ°Ğº ĞµÑÑ‚ÑŒ, ĞµÑĞ»Ğ¸ Ğ½Ğµ ÑƒĞ´Ğ°ĞµÑ‚ÑÑ Ğ¾Ñ‚Ñ„Ğ¾Ñ€Ğ¼Ğ°Ñ‚Ğ¸Ñ€Ğ¾Ğ²Ğ°Ñ‚ÑŒ
  }

  /**
   * ĞŸĞ¾Ğ»ÑƒÑ‡Ğ°ĞµÑ‚ Ğ¿Ğ¾Ğ»Ğ½Ñ‹Ğ¹ Ğ½Ğ¾Ğ¼ĞµÑ€ Ğ´Ğ»Ñ API (Ğ²ÑĞµĞ³Ğ´Ğ° 11 Ñ†Ğ¸Ñ„Ñ€ Ñ 7 Ğ² Ğ½Ğ°Ñ‡Ğ°Ğ»Ğµ)
   */
  static getFullNumber(phone: string): string {
    const normalized = this.normalize(phone);
    
    if (normalized.length === 11) {
      return normalized;
    } else if (normalized.length === 10) {
      return `7${normalized}`;
    }
    
    return normalized; // Ğ’Ğ¾Ğ·Ğ²Ñ€Ğ°Ñ‰Ğ°ĞµĞ¼ ĞºĞ°Ğº ĞµÑÑ‚ÑŒ, ĞµÑĞ»Ğ¸ Ğ½Ğµ ÑƒĞ´Ğ°ĞµÑ‚ÑÑ Ğ¾Ğ±Ñ€Ğ°Ğ±Ğ¾Ñ‚Ğ°Ñ‚ÑŒ
  }
} 

```


## <a name="srccoreservicesPromoCodeServicets"></a>`src/core/services/PromoCodeService.ts`

```typescript
// path: src/core/services/PromoCodeService.ts

// src/core/services/PromoCodeService.ts

import { api } from "@/lib/api";
import type { PromoCodeOut, PromoCodeCreate, PromoCodeUpdate } from "@/types/promo_code";

export interface PromoCodeValidationResult {
    isValid: boolean;
    message: string | null;
    discountPercentage: number;
}

export interface PromoCodeFilterOptions {
    isActive?: boolean;
    search?: string;
}

export class PromoCodeService {
    /**
     * ĞŸĞ¾Ğ»ÑƒÑ‡Ğ°ĞµÑ‚ Ğ²ÑĞµ Ğ¿Ñ€Ğ¾Ğ¼Ğ¾ĞºĞ¾Ğ´Ñ‹
     */
    static async getAllPromoCodes(): Promise<PromoCodeOut[]> {
        const response = await api.get("/promocodes/");
        return response.data;
    }

    /**
     * ĞŸĞ¾Ğ»ÑƒÑ‡Ğ°ĞµÑ‚ Ğ¿Ñ€Ğ¾Ğ¼Ğ¾ĞºĞ¾Ğ´ Ğ¿Ğ¾ ID
     */
    static async getPromoCodeById(id: number): Promise<PromoCodeOut> {
        const response = await api.get(`/promocodes/${id}`);
        return response.data;
    }

    /**
     * Ğ¡Ğ¾Ğ·Ğ´Ğ°ĞµÑ‚ Ğ½Ğ¾Ğ²Ñ‹Ğ¹ Ğ¿Ñ€Ğ¾Ğ¼Ğ¾ĞºĞ¾Ğ´
     */
    static async createPromoCode(input: PromoCodeCreate): Promise<PromoCodeOut> {
        const response = await api.post("/promocodes/", input);
        return response.data;
    }

    /**
     * ĞĞ±Ğ½Ğ¾Ğ²Ğ»ÑĞµÑ‚ Ğ¿Ñ€Ğ¾Ğ¼Ğ¾ĞºĞ¾Ğ´
     */
    static async updatePromoCode(id: number, input: PromoCodeUpdate): Promise<PromoCodeOut> {
        const response = await api.put(`/promocodes/${id}`, input);
        return response.data;
    }

    /**
     * Ğ£Ğ´Ğ°Ğ»ÑĞµÑ‚ Ğ¿Ñ€Ğ¾Ğ¼Ğ¾ĞºĞ¾Ğ´
     */
    static async deletePromoCode(id: number): Promise<void> {
        await api.delete(`/promocodes/${id}`);
    }

    /**
     * ĞĞºÑ‚Ğ¸Ğ²Ğ¸Ñ€ÑƒĞµÑ‚/Ğ´ĞµĞ°ĞºÑ‚Ğ¸Ğ²Ğ¸Ñ€ÑƒĞµÑ‚ Ğ¿Ñ€Ğ¾Ğ¼Ğ¾ĞºĞ¾Ğ´
     */
    static async togglePromoCodeStatus(id: number, isActive: boolean): Promise<PromoCodeOut> {
        const response = await api.patch(`/promocodes/${id}/toggle-status`, { is_active: isActive });
        return response.data;
    }

    /**
     * Ğ’Ğ°Ğ»Ğ¸Ğ´Ğ¸Ñ€ÑƒĞµÑ‚ Ğ¿Ñ€Ğ¾Ğ¼Ğ¾ĞºĞ¾Ğ´ Ğ´Ğ»Ñ ĞºĞ¾Ğ½ĞºÑ€ĞµÑ‚Ğ½Ğ¾Ğ³Ğ¾ Ğ·Ğ°ĞºĞ°Ğ·Ğ°
     */
    static async validatePromoCode(
        code: string,
        equipmentIds: number[],
        totalAmount: number,
        userId?: number
    ): Promise<PromoCodeValidationResult> {
        try {
            const response = await api.post("/promocodes/validate", {
                code,
                equipment_ids: equipmentIds,
                total_amount: totalAmount,
                user_id: userId
            });
            return response.data;
        } catch (error: any) {
            return {
                isValid: false,
                message: error.response?.data?.detail || "ĞŸÑ€Ğ¾Ğ¼Ğ¾ĞºĞ¾Ğ´ Ğ½ĞµĞ´ĞµĞ¹ÑÑ‚Ğ²Ğ¸Ñ‚ĞµĞ»ĞµĞ½",
                discountPercentage: 0
            };
        }
    }

    /**
     * Ğ¤Ğ¸Ğ»ÑŒÑ‚Ñ€ÑƒĞµÑ‚ Ğ¿Ñ€Ğ¾Ğ¼Ğ¾ĞºĞ¾Ğ´Ñ‹ Ğ¿Ğ¾ Ğ·Ğ°Ğ´Ğ°Ğ½Ğ½Ñ‹Ğ¼ ĞºÑ€Ğ¸Ñ‚ĞµÑ€Ğ¸ÑĞ¼
     */
    static filterPromoCodes(
        promoCodes: PromoCodeOut[],
        filters: PromoCodeFilterOptions
    ): PromoCodeOut[] {
        return promoCodes.filter(promo => {
            // Ğ¤Ğ¸Ğ»ÑŒÑ‚Ñ€ Ğ¿Ğ¾ Ğ°ĞºÑ‚Ğ¸Ğ²Ğ½Ğ¾ÑÑ‚Ğ¸
            if (filters.isActive !== undefined && promo.is_active !== filters.isActive) {
                return false;
            }

            // Ğ¤Ğ¸Ğ»ÑŒÑ‚Ñ€ Ğ¿Ğ¾ Ğ¿Ğ¾Ğ¸ÑĞºÑƒ
            if (filters.search) {
                const searchLower = filters.search.toLowerCase();
                const matchesSearch = 
                    promo.code.toLowerCase().includes(searchLower) ||
                    (promo.description && promo.description.toLowerCase().includes(searchLower));
                
                if (!matchesSearch) {
                    return false;
                }
            }

            return true;
        });
    }

    /**
     * Ğ’Ğ°Ğ»Ğ¸Ğ´Ğ¸Ñ€ÑƒĞµÑ‚ Ğ´Ğ°Ğ½Ğ½Ñ‹Ğµ Ğ¿Ñ€Ğ¾Ğ¼Ğ¾ĞºĞ¾Ğ´Ğ° Ğ¿ĞµÑ€ĞµĞ´ ÑĞ¾Ğ·Ğ´Ğ°Ğ½Ğ¸ĞµĞ¼/Ğ¾Ğ±Ğ½Ğ¾Ğ²Ğ»ĞµĞ½Ğ¸ĞµĞ¼
     */
    static validatePromoCodeData(input: PromoCodeCreate): { isValid: boolean; errors: string[] } {
        const errors: string[] = [];

        if (!input.code?.trim()) {
            errors.push("ĞšĞ¾Ğ´ Ğ¿Ñ€Ğ¾Ğ¼Ğ¾ĞºĞ¾Ğ´Ğ° Ğ¾Ğ±ÑĞ·Ğ°Ñ‚ĞµĞ»ĞµĞ½");
        }

        if (input.discount_percentage <= 0 || input.discount_percentage > 100) {
            errors.push("ĞŸÑ€Ğ¾Ñ†ĞµĞ½Ñ‚ ÑĞºĞ¸Ğ´ĞºĞ¸ Ğ´Ğ¾Ğ»Ğ¶ĞµĞ½ Ğ±Ñ‹Ñ‚ÑŒ Ğ¾Ñ‚ 1 Ğ´Ğ¾ 100");
        }

        if (input.valid_from && input.expires_at) {
            const validFrom = new Date(input.valid_from);
            const expiresAt = new Date(input.expires_at);
            
            if (validFrom >= expiresAt) {
                errors.push("Ğ”Ğ°Ñ‚Ğ° Ğ¾ĞºĞ¾Ğ½Ñ‡Ğ°Ğ½Ğ¸Ñ Ğ´Ğ¾Ğ»Ğ¶Ğ½Ğ° Ğ±Ñ‹Ñ‚ÑŒ Ğ¿Ğ¾Ğ·Ğ¶Ğµ Ğ´Ğ°Ñ‚Ñ‹ Ğ½Ğ°Ñ‡Ğ°Ğ»Ğ°");
            }
        }

        if (input.max_uses !== null && input.max_uses <= 0) {
            errors.push("ĞœĞ°ĞºÑĞ¸Ğ¼Ğ°Ğ»ÑŒĞ½Ğ¾Ğµ ĞºĞ¾Ğ»Ğ¸Ñ‡ĞµÑÑ‚Ğ²Ğ¾ Ğ¸ÑĞ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğ¹ Ğ´Ğ¾Ğ»Ğ¶Ğ½Ğ¾ Ğ±Ñ‹Ñ‚ÑŒ Ğ±Ğ¾Ğ»ÑŒÑˆĞµ Ğ½ÑƒĞ»Ñ");
        }

        if (input.max_uses_per_user !== null && input.max_uses_per_user <= 0) {
            errors.push("ĞœĞ°ĞºÑĞ¸Ğ¼Ğ°Ğ»ÑŒĞ½Ğ¾Ğµ ĞºĞ¾Ğ»Ğ¸Ñ‡ĞµÑÑ‚Ğ²Ğ¾ Ğ¸ÑĞ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğ¹ Ğ½Ğ° Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ñ Ğ´Ğ¾Ğ»Ğ¶Ğ½Ğ¾ Ğ±Ñ‹Ñ‚ÑŒ Ğ±Ğ¾Ğ»ÑŒÑˆĞµ Ğ½ÑƒĞ»Ñ");
        }

        if (input.min_order_amount !== null && input.min_order_amount <= 0) {
            errors.push("ĞœĞ¸Ğ½Ğ¸Ğ¼Ğ°Ğ»ÑŒĞ½Ğ°Ñ ÑÑƒĞ¼Ğ¼Ğ° Ğ·Ğ°ĞºĞ°Ğ·Ğ° Ğ´Ğ¾Ğ»Ğ¶Ğ½Ğ° Ğ±Ñ‹Ñ‚ÑŒ Ğ±Ğ¾Ğ»ÑŒÑˆĞµ Ğ½ÑƒĞ»Ñ");
        }

        return {
            isValid: errors.length === 0,
            errors
        };
    }

    /**
     * ĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑĞµÑ‚, Ğ°ĞºÑ‚Ğ¸Ğ²ĞµĞ½ Ğ»Ğ¸ Ğ¿Ñ€Ğ¾Ğ¼Ğ¾ĞºĞ¾Ğ´ Ğ² Ğ´Ğ°Ğ½Ğ½Ñ‹Ğ¹ Ğ¼Ğ¾Ğ¼ĞµĞ½Ñ‚
     */
    static isPromoCodeActive(promoCode: PromoCodeOut): boolean {
        if (!promoCode.is_active) {
            return false;
        }

        const now = new Date();

        // ĞŸÑ€Ğ¾Ğ²ĞµÑ€ĞºĞ° Ğ´Ğ°Ñ‚Ñ‹ Ğ½Ğ°Ñ‡Ğ°Ğ»Ğ°
        if (promoCode.valid_from) {
            const validFrom = new Date(promoCode.valid_from);
            if (now < validFrom) {
                return false;
            }
        }

        // ĞŸÑ€Ğ¾Ğ²ĞµÑ€ĞºĞ° Ğ´Ğ°Ñ‚Ñ‹ Ğ¾ĞºĞ¾Ğ½Ñ‡Ğ°Ğ½Ğ¸Ñ
        if (promoCode.expires_at) {
            const expiresAt = new Date(promoCode.expires_at);
            if (now > expiresAt) {
                return false;
            }
        }

        // ĞŸÑ€Ğ¾Ğ²ĞµÑ€ĞºĞ° Ğ¼Ğ°ĞºÑĞ¸Ğ¼Ğ°Ğ»ÑŒĞ½Ğ¾Ğ³Ğ¾ ĞºĞ¾Ğ»Ğ¸Ñ‡ĞµÑÑ‚Ğ²Ğ° Ğ¸ÑĞ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğ¹
        if (promoCode.max_uses !== null && promoCode.times_used >= promoCode.max_uses) {
            return false;
        }

        return true;
    }

    /**
     * Ğ“ĞµĞ½ĞµÑ€Ğ¸Ñ€ÑƒĞµÑ‚ ĞºĞ»ÑÑ‡ Ğ´Ğ»Ñ ĞºÑÑˆĞ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ Ğ¿Ñ€Ğ¾Ğ¼Ğ¾ĞºĞ¾Ğ´Ğ¾Ğ²
     */
    static generatePromoCodesCacheKey(filters?: PromoCodeFilterOptions): string {
        return JSON.stringify(["promo-codes", filters]);
    }

    /**
     * Ğ“ĞµĞ½ĞµÑ€Ğ¸Ñ€ÑƒĞµÑ‚ ĞºĞ»ÑÑ‡ Ğ´Ğ»Ñ ĞºÑÑˆĞ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ Ğ²Ğ°Ğ»Ğ¸Ğ´Ğ°Ñ†Ğ¸Ğ¸ Ğ¿Ñ€Ğ¾Ğ¼Ğ¾ĞºĞ¾Ğ´Ğ°
     */
    static generateValidationCacheKey(
        code: string,
        equipmentIds: number[],
        totalAmount: number,
        userId?: number
    ): string {
        return JSON.stringify([
            "promo-code-validation",
            code,
            equipmentIds.sort(),
            totalAmount,
            userId
        ]);
    }
} 

```


## <a name="srccoreservicesReservationServicets"></a>`src/core/services/ReservationService.ts`

```typescript
// path: src/core/services/ReservationService.ts

// src/core/services/ReservationService.ts

import { api } from "@/lib/api";
import type { Equipment } from "@/types/equipment";
import type { Reservation, ReservationWithNames, ReservationListResponse } from "@/types/reservation";

// Ğ•Ğ´Ğ¸Ğ½Ñ‹Ğ¹ Ñ‚Ğ¸Ğ¿ Ğ´Ğ»Ñ ÑĞ¾Ğ·Ğ´Ğ°Ğ½Ğ¸Ñ Ñ€ĞµĞ·ĞµÑ€Ğ²Ğ°, ĞºĞ¾Ñ‚Ğ¾Ñ€Ñ‹Ğ¹ Ğ±ÑƒĞ´ĞµÑ‚ Ğ¸ÑĞ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ÑŒÑÑ Ğ²ĞµĞ·Ğ´Ğµ
export interface ReservationCreateInput {
    user_id?: number;
    start_date: string;
    end_date: string;
    equipment_ids: number[];
    selected_accessories: Record<number, number[]>;
    promo_code?: string;
}

export interface ReservationUpdateInput {
    id: number;
    start_date: string;
    end_date: string;
    equipment_ids: number[];
    selected_accessories: Record<number, number[]>;
    promo_code?: string;
    isAdminContext?: boolean;
}

export class ReservationService {
    /**
     * Ğ Ğ°ÑÑÑ‡Ğ¸Ñ‚Ñ‹Ğ²Ğ°ĞµÑ‚ ÑÑ‚Ğ¾Ğ¸Ğ¼Ğ¾ÑÑ‚ÑŒ Ñ€ĞµĞ·ĞµÑ€Ğ²Ğ°
     */
    static async calculatePrice(input: Omit<ReservationCreateInput, 'user_id'>): Promise<any> {
        const payload = {
            ...input,
            selected_accessories: input.selected_accessories || {},
            promo_code: input.promo_code || null,
        };

        const response = await api.post("/reservations/calculate", payload);
        return response.data;
    }

    /**
     * Ğ¡Ğ¾Ğ·Ğ´Ğ°ĞµÑ‚ Ğ½Ğ¾Ğ²Ñ‹Ğ¹ Ñ€ĞµĞ·ĞµÑ€Ğ²
     */
    static async createReservation(input: ReservationCreateInput) {
        const { user_id, ...payload } = input;
        const finalPayload = user_id !== undefined ? { user_id, ...payload } : payload;

        const response = await api.post("/reservations/", finalPayload);
        return response.data;
    }

    /**
     * ĞĞ±Ğ½Ğ¾Ğ²Ğ»ÑĞµÑ‚ ÑÑƒÑ‰ĞµÑÑ‚Ğ²ÑƒÑÑ‰Ğ¸Ğ¹ Ñ€ĞµĞ·ĞµÑ€Ğ²
     */
    static async updateReservation(input: ReservationUpdateInput) {
        const { isAdminContext, id, ...payload } = input;
        const url = isAdminContext
            ? `/admin/reservations/${id}`
            : `/reservations/${id}`;

        const response = await api.put(url, payload);
        return response.data;
    }

    /**
     * ĞÑ‚Ğ¼ĞµĞ½ÑĞµÑ‚ Ñ€ĞµĞ·ĞµÑ€Ğ²
     */
    static async cancelReservation(id: number) {
        const response = await api.delete(`/reservations/${id}`);
        return response.data;
    }

    /**
     * ĞŸĞ¾Ğ»ÑƒÑ‡Ğ°ĞµÑ‚ ÑĞ¿Ğ¸ÑĞ¾Ğº Ñ€ĞµĞ·ĞµÑ€Ğ²Ğ¾Ğ² Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ñ
     */
    static async getUserReservations(params?: { search?: string; status?: string; sort?: string }): Promise<Reservation[]> {
        // Ğ£ĞºĞ°Ğ·Ñ‹Ğ²Ğ°ĞµĞ¼, Ñ‡Ñ‚Ğ¾ Ğ¾Ğ¶Ğ¸Ğ´Ğ°ĞµĞ¼ Ğ¾Ğ±ÑŠĞµĞºÑ‚ Ñ Ğ¿Ğ°Ğ³Ğ¸Ğ½Ğ°Ñ†Ğ¸ĞµĞ¹
        const response = await api.get<ReservationListResponse>("/reservations/", {
            params: params ? {
                search: params.search,
                status: params.status,
                sort: params.sort
            } : undefined
        });
        // Ğ’Ğ¾Ğ·Ğ²Ñ€Ğ°Ñ‰Ğ°ĞµĞ¼ Ñ‚Ğ¾Ğ»ÑŒĞºĞ¾ Ğ¼Ğ°ÑÑĞ¸Ğ² items
        return response.data.items;
    }

    /**
     * ĞŸĞ¾Ğ»ÑƒÑ‡Ğ°ĞµÑ‚ Ğ²ÑĞµ Ñ€ĞµĞ·ĞµÑ€Ğ²Ñ‹ (Ğ´Ğ»Ñ Ğ°Ğ´Ğ¼Ğ¸Ğ½Ğ°)
     */
    static async getAllReservations() {
        // ĞŸÑ€Ğ¸Ğ¼ĞµÑ‡Ğ°Ğ½Ğ¸Ğµ: ÑÑ‚Ğ¾Ñ‚ Ğ¼ĞµÑ‚Ğ¾Ğ´ Ğ½Ğµ Ğ¸ÑĞ¿Ğ¾Ğ»ÑŒĞ·ÑƒĞµÑ‚ÑÑ Ğ´Ğ»Ñ Ğ¿Ğ°Ğ³Ğ¸Ğ½Ğ°Ñ†Ğ¸Ğ¸, Ğ½Ğ¾ Ğ¾ÑÑ‚Ğ°Ğ²Ğ»ĞµĞ½ Ğ´Ğ»Ñ ÑĞ¾Ğ²Ğ¼ĞµÑÑ‚Ğ¸Ğ¼Ğ¾ÑÑ‚Ğ¸.
        // Ğ”Ğ»Ñ Ğ¿Ğ°Ğ³Ğ¸Ğ½Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ½Ğ¾Ğ³Ğ¾ ÑĞ¿Ğ¸ÑĞºĞ° Ğ°Ğ´Ğ¼Ğ¸Ğ½Ğ° Ğ¸ÑĞ¿Ğ¾Ğ»ÑŒĞ·ÑƒĞµÑ‚ÑÑ /admin/reservations
        const response = await api.get("/reservations/");
        return response.data;
    }

    /**
     * ĞŸĞ¾Ğ»ÑƒÑ‡Ğ°ĞµÑ‚ Ğ´ĞµÑ‚Ğ°Ğ»Ğ¸ Ñ€ĞµĞ·ĞµÑ€Ğ²Ğ° Ğ¿Ğ¾ ID
     */
    static async getReservationById(id: number) {
        const response = await api.get(`/reservations/${id}`);
        return response.data;
    }

    /**
     * ĞŸÑ€ĞµĞ¾Ğ±Ñ€Ğ°Ğ·ÑƒĞµÑ‚ Ñ€ĞµĞ·ĞµÑ€Ğ²Ñ‹, Ğ´Ğ¾Ğ±Ğ°Ğ²Ğ»ÑÑ Ğ¸Ğ¼ĞµĞ½Ğ° Ğ¾Ğ±Ğ¾Ñ€ÑƒĞ´Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ
     */
    static createReservationsWithNames(
        reservationsData: Reservation[],
        equipmentMap: Record<number, Equipment>
    ): ReservationWithNames[] {
        if (!reservationsData || reservationsData.length === 0) {
            return [];
        }

        return reservationsData.map((r: Reservation) => ({
            ...r,
            equipment_names: r.equipment_ids
                .map((id: number) => equipmentMap[id])
                .filter((eq): eq is Equipment => Boolean(eq))
                .map((eq: Equipment) => `${eq.equipment_type} ${eq.brand} ${eq.name}`),
        }));
    }
}

```


## <a name="srccoreservicesUserServicets"></a>`src/core/services/UserService.ts`

```typescript
// path: src/core/services/UserService.ts

// src/core/services/UserService.ts

import { api } from "@/lib/api";
import type { UserOut, UserRole, UserListResponse, UserPaymentRequest } from "@/types/user";
import type { BalanceHistoryListResponse } from "@/types/balanceHistory";

export interface UserCreateInput {
    full_name: string;
    email: string;
    password: string;
    role: UserRole;
    phone?: string;
    privacyPolicyAccepted: boolean;
    termsAccepted: boolean;
    emailVerified: boolean;
}

export interface UserUpdateInput extends Partial<UserCreateInput> {
    id: number;
}

export interface UserFilterOptions {
    search?: string;
    role?: UserRole;
    isActive?: boolean;
    status?: string;
}

export interface UserValidationResult {
    isValid: boolean;
    errors: string[];
}

export class UserService {
    /**
     * ĞŸÑ€ĞµĞ¾Ğ±Ñ€Ğ°Ğ·ÑƒĞµÑ‚ camelCase Ğ¿Ğ¾Ğ»Ñ Ğ² snake_case Ğ´Ğ»Ñ API
     */
    private static toApiFormat(input: Partial<UserCreateInput>): Record<string, any> {
        const apiPayload: Record<string, any> = {};

        if (input.full_name !== undefined) apiPayload.full_name = input.full_name;
        if (input.email !== undefined) apiPayload.email = input.email;
        if (input.password !== undefined) apiPayload.password = input.password;
        if (input.role !== undefined) apiPayload.role = input.role;
        if (input.phone !== undefined) apiPayload.phone = input.phone;
        if (input.privacyPolicyAccepted !== undefined) apiPayload.privacy_policy_accepted = input.privacyPolicyAccepted;
        if (input.termsAccepted !== undefined) apiPayload.terms_accepted = input.termsAccepted;
        if (input.emailVerified !== undefined) apiPayload.email_verified = input.emailVerified;

        return apiPayload;
    }

    /**
     * ĞŸĞ¾Ğ»ÑƒÑ‡Ğ°ĞµÑ‚ Ğ²ÑĞµÑ… Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ĞµĞ¹ Ñ Ğ¿Ğ°Ğ³Ğ¸Ğ½Ğ°Ñ†Ğ¸ĞµĞ¹
     */
    static async getAllUsers(skip: number = 0, limit: number = 15): Promise<UserListResponse> {
        try {
            const response = await api.get<UserListResponse>("/user/admin/users", {
                params: { skip, limit }
            });
            return response.data;
        } catch (error) {
            console.error("ĞÑˆĞ¸Ğ±ĞºĞ° Ğ¿Ñ€Ğ¸ Ğ¿Ğ¾Ğ»ÑƒÑ‡ĞµĞ½Ğ¸Ğ¸ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ĞµĞ¹:", error);
            throw error;
        }
    }

    /**
     * ĞŸĞ¾Ğ»ÑƒÑ‡Ğ°ĞµÑ‚ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ñ Ğ¿Ğ¾ ID
     */
    static async getUserById(id: number): Promise<UserOut> {
        try {
            const response = await api.get(`/user/admin/users/${id}`);
            return response.data;
        } catch (error) {
            console.error(`ĞÑˆĞ¸Ğ±ĞºĞ° Ğ¿Ñ€Ğ¸ Ğ¿Ğ¾Ğ»ÑƒÑ‡ĞµĞ½Ğ¸Ğ¸ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ñ Ñ ID ${id}:`, error);
            throw error;
        }
    }

    /**
     * Ğ¡Ğ¾Ğ·Ğ´Ğ°ĞµÑ‚ Ğ½Ğ¾Ğ²Ğ¾Ğ³Ğ¾ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ñ
     */
    static async createUser(input: UserCreateInput): Promise<UserOut> {
        try {
            const apiPayload = this.toApiFormat(input);
            const response = await api.post("/user/admin/users", apiPayload);
            return response.data;
        } catch (error) {
            console.error("ĞÑˆĞ¸Ğ±ĞºĞ° Ğ¿Ñ€Ğ¸ ÑĞ¾Ğ·Ğ´Ğ°Ğ½Ğ¸Ğ¸ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ñ:", error);
            throw error;
        }
    }

    /**
     * ĞĞ±Ğ½Ğ¾Ğ²Ğ»ÑĞµÑ‚ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ñ
     */
    static async updateUser(input: UserUpdateInput): Promise<UserOut> {
        try {
            const { id, ...updateData } = input;
            const apiPayload = this.toApiFormat(updateData);
            const response = await api.put(`/user/admin/users/${id}`, apiPayload);
            return response.data;
        } catch (error) {
            console.error(`ĞÑˆĞ¸Ğ±ĞºĞ° Ğ¿Ñ€Ğ¸ Ğ¾Ğ±Ğ½Ğ¾Ğ²Ğ»ĞµĞ½Ğ¸Ğ¸ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ñ Ñ ID ${input.id}:`, error);
            throw error;
        }
    }

    /**
     * ĞĞ±Ğ½Ğ¾Ğ²Ğ»ÑĞµÑ‚ Ñ€Ğ¾Ğ»ÑŒ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ñ (Ñ‚Ğ¾Ğ»ÑŒĞºĞ¾ Ğ°Ğ´Ğ¼Ğ¸Ğ½)
     */
    static async updateUserRole(userId: number, newRole: UserRole): Promise<any> {
        try {
            // Ğ˜Ğ—ĞœĞ•ĞĞ•ĞĞ˜Ğ•: ĞÑ‚Ğ¿Ñ€Ğ°Ğ²Ğ»ÑĞµĞ¼ `new_role` ĞºĞ°Ğº Ğ¿Ğ°Ñ€Ğ°Ğ¼ĞµÑ‚Ñ€ Ğ·Ğ°Ğ¿Ñ€Ğ¾ÑĞ°, Ğ° Ğ½Ğµ Ğ² Ñ‚ĞµĞ»Ğµ.
            // Ğ¢Ğ°ĞºĞ¶Ğµ Ğ¼ĞµĞ½ÑĞµĞ¼ Ğ¾Ğ¶Ğ¸Ğ´Ğ°ĞµĞ¼Ñ‹Ğ¹ Ñ‚Ğ¸Ğ¿ Ğ¾Ñ‚Ğ²ĞµÑ‚Ğ° Ğ½Ğ° `any`, Ñ‚Ğ°Ğº ĞºĞ°Ğº API Ğ²Ğ¾Ğ·Ğ²Ñ€Ğ°Ñ‰Ğ°ĞµÑ‚ { message: "..." }
            const response = await api.put(`/user/admin/users/${userId}/role?new_role=${newRole}`);
            return response.data;
        } catch (error) {
            console.error(`ĞÑˆĞ¸Ğ±ĞºĞ° Ğ¿Ñ€Ğ¸ Ğ¾Ğ±Ğ½Ğ¾Ğ²Ğ»ĞµĞ½Ğ¸Ğ¸ Ñ€Ğ¾Ğ»Ğ¸ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ñ ${userId}:`, error);
            throw error;
        }
    }

    /**
     * Ğ£Ğ´Ğ°Ğ»ÑĞµÑ‚ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ñ
     */
    static async deleteUser(id: number): Promise<void> {
        try {
            await api.delete(`/user/admin/users/${id}`);
        } catch (error) {
            console.error(`ĞÑˆĞ¸Ğ±ĞºĞ° Ğ¿Ñ€Ğ¸ ÑƒĞ´Ğ°Ğ»ĞµĞ½Ğ¸Ğ¸ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ñ Ñ ID ${id}:`, error);
            throw error;
        }
    }

    /**
     * ĞĞºÑ‚Ğ¸Ğ²Ğ¸Ñ€ÑƒĞµÑ‚/Ğ´ĞµĞ°ĞºÑ‚Ğ¸Ğ²Ğ¸Ñ€ÑƒĞµÑ‚ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ñ
     */
    static async toggleUserStatus(id: number, isActive: boolean): Promise<UserOut> {
        try {
            const endpoint = isActive ? `/user/admin/users/${id}/unblock` : `/user/admin/users/${id}/block`;
            const response = await api.put(endpoint);
            return response.data;
        } catch (error) {
            console.error(`ĞÑˆĞ¸Ğ±ĞºĞ° Ğ¿Ñ€Ğ¸ Ğ¸Ğ·Ğ¼ĞµĞ½ĞµĞ½Ğ¸Ğ¸ ÑÑ‚Ğ°Ñ‚ÑƒÑĞ° Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ñ ${id}:`, error);
            throw error;
        }
    }

    /**
     * ĞŸĞ¾Ğ»ÑƒÑ‡Ğ°ĞµÑ‚ Ğ¿Ñ€Ğ¾Ñ„Ğ¸Ğ»ÑŒ Ñ‚ĞµĞºÑƒÑ‰ĞµĞ³Ğ¾ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ñ
     */
    static async getCurrentUserProfile(): Promise<UserOut> {
        try {
            const response = await api.get("/user/");
            return response.data;
        } catch (error) {
            console.error("ĞÑˆĞ¸Ğ±ĞºĞ° Ğ¿Ñ€Ğ¸ Ğ¿Ğ¾Ğ»ÑƒÑ‡ĞµĞ½Ğ¸Ğ¸ Ğ¿Ñ€Ğ¾Ñ„Ğ¸Ğ»Ñ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ñ:", error);
            throw error;
        }
    }

    /**
     * ĞĞ±Ğ½Ğ¾Ğ²Ğ»ÑĞµÑ‚ Ğ¿Ñ€Ğ¾Ñ„Ğ¸Ğ»ÑŒ Ñ‚ĞµĞºÑƒÑ‰ĞµĞ³Ğ¾ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ñ
     */
    static async updateCurrentUserProfile(input: Partial<UserCreateInput>): Promise<UserOut> {
        try {
            const apiPayload = this.toApiFormat(input);
            const response = await api.put("/user/", apiPayload);
            return response.data;
        } catch (error) {
            console.error("ĞÑˆĞ¸Ğ±ĞºĞ° Ğ¿Ñ€Ğ¸ Ğ¾Ğ±Ğ½Ğ¾Ğ²Ğ»ĞµĞ½Ğ¸Ğ¸ Ğ¿Ñ€Ğ¾Ñ„Ğ¸Ğ»Ñ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ñ:", error);
            throw error;
        }
    }

    /**
     * ĞŸĞ¾Ğ»ÑƒÑ‡Ğ°ĞµÑ‚ Ğ¸ÑÑ‚Ğ¾Ñ€Ğ¸Ñ Ğ±Ğ°Ğ»Ğ°Ğ½ÑĞ° Ğ´Ğ»Ñ Ñ‚ĞµĞºÑƒÑ‰ĞµĞ³Ğ¾ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ñ Ñ Ğ¿Ğ°Ğ³Ğ¸Ğ½Ğ°Ñ†Ğ¸ĞµĞ¹.
     */
    static async getMyBalanceHistory(skip: number, limit: number): Promise<BalanceHistoryListResponse> {
        try {
            const response = await api.get<BalanceHistoryListResponse>("/user/balance-history", {
                params: { skip, limit }
            });
            return response.data;
        } catch (error) {
            console.error("ĞÑˆĞ¸Ğ±ĞºĞ° Ğ¿Ñ€Ğ¸ Ğ¿Ğ¾Ğ»ÑƒÑ‡ĞµĞ½Ğ¸Ğ¸ Ğ¸ÑÑ‚Ğ¾Ñ€Ğ¸Ğ¸ Ğ±Ğ°Ğ»Ğ°Ğ½ÑĞ°:", error);
            throw error;
        }
    }

    /**
     * ĞŸĞ¾Ğ»ÑƒÑ‡Ğ°ĞµÑ‚ Ğ¸ÑÑ‚Ğ¾Ñ€Ğ¸Ñ Ğ±Ğ°Ğ»Ğ°Ğ½ÑĞ° Ğ´Ğ»Ñ Ğ»ÑĞ±Ğ¾Ğ³Ğ¾ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ñ Ğ¿Ğ¾ ID (Ğ´Ğ»Ñ Ğ°Ğ´Ğ¼Ğ¸Ğ½Ğ¸ÑÑ‚Ñ€Ğ°Ñ‚Ğ¾Ñ€Ğ¾Ğ²).
     */
    static async getUserBalanceHistory(userId: number, skip: number, limit: number): Promise<BalanceHistoryListResponse> {
        try {
            const response = await api.get<BalanceHistoryListResponse>(`/user/admin/users/${userId}/balance-history`, {
                params: { skip, limit }
            });
            return response.data;
        } catch (error) {
            console.error(`ĞÑˆĞ¸Ğ±ĞºĞ° Ğ¿Ñ€Ğ¸ Ğ¿Ğ¾Ğ»ÑƒÑ‡ĞµĞ½Ğ¸Ğ¸ Ğ¸ÑÑ‚Ğ¾Ñ€Ğ¸Ğ¸ Ğ±Ğ°Ğ»Ğ°Ğ½ÑĞ° Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ñ ${userId}:`, error);
            throw error;
        }
    }

    /**
     * Ğ ĞµĞ³Ğ¸ÑÑ‚Ñ€Ğ¸Ñ€ÑƒĞµÑ‚ Ğ¿Ğ»Ğ°Ñ‚ĞµĞ¶ Ğ¸ Ğ¿Ğ¾Ğ¿Ğ¾Ğ»Ğ½ÑĞµÑ‚ Ğ±Ğ°Ğ»Ğ°Ğ½Ñ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ñ (Ğ´Ğ»Ñ Ğ¼ĞµĞ½ĞµĞ´Ğ¶ĞµÑ€Ğ¾Ğ²/Ğ°Ğ´Ğ¼Ğ¸Ğ½Ğ¾Ğ²).
     */
    static async addUserPayment(userId: number, data: UserPaymentRequest): Promise<UserOut> {
        try {
            const response = await api.post<UserOut>(`/user/admin/users/${userId}/add-payment`, data);
            return response.data;
        } catch (error) {
            console.error(`ĞÑˆĞ¸Ğ±ĞºĞ° Ğ¿Ñ€Ğ¸ Ğ´Ğ¾Ğ±Ğ°Ğ²Ğ»ĞµĞ½Ğ¸Ğ¸ Ğ¿Ğ»Ğ°Ñ‚ĞµĞ¶Ğ° Ğ´Ğ»Ñ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ñ ${userId}:`, error);
            throw error;
        }
    }

    /**
     * Ğ¤Ğ¸Ğ»ÑŒÑ‚Ñ€ÑƒĞµÑ‚ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ĞµĞ¹ Ğ¿Ğ¾ Ğ·Ğ°Ğ´Ğ°Ğ½Ğ½Ñ‹Ğ¼ ĞºÑ€Ğ¸Ñ‚ĞµÑ€Ğ¸ÑĞ¼
     */
    static filterUsers(
        users: UserOut[],
        filters: UserFilterOptions
    ): UserOut[] {
        return users.filter(user => {
            if (filters.search) {
                const searchLower = filters.search.toLowerCase();
                const matchesSearch =
                    user.full_name.toLowerCase().includes(searchLower) ||
                    user.email.toLowerCase().includes(searchLower) ||
                    (user.phone && user.phone.toLowerCase().includes(searchLower));
                if (!matchesSearch) return false;
            }
            if (filters.role && user.role !== filters.role) return false;
            if (filters.isActive !== undefined && user.is_active !== filters.isActive) return false;
            if (filters.status && user.status !== filters.status) return false;
            return true;
        });
    }

    /**
     * Ğ’Ğ°Ğ»Ğ¸Ğ´Ğ¸Ñ€ÑƒĞµÑ‚ Ğ´Ğ°Ğ½Ğ½Ñ‹Ğµ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ñ
     */
    static validateUserData(input: UserCreateInput): UserValidationResult {
        const errors: string[] = [];
        if (!input.full_name?.trim()) errors.push("ĞŸĞ¾Ğ»Ğ½Ğ¾Ğµ Ğ¸Ğ¼Ñ Ğ¾Ğ±ÑĞ·Ğ°Ñ‚ĞµĞ»ÑŒĞ½Ğ¾");
        if (!input.email?.trim()) {
            errors.push("Email Ğ¾Ğ±ÑĞ·Ğ°Ñ‚ĞµĞ»ĞµĞ½");
        } else if (!this.isValidEmail(input.email)) {
            errors.push("ĞĞµĞºĞ¾Ñ€Ñ€ĞµĞºÑ‚Ğ½Ñ‹Ğ¹ Ñ„Ğ¾Ñ€Ğ¼Ğ°Ñ‚ email");
        }
        if (!input.role) errors.push("Ğ Ğ¾Ğ»ÑŒ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ñ Ğ¾Ğ±ÑĞ·Ğ°Ñ‚ĞµĞ»ÑŒĞ½Ğ°");
        if (input.phone && !this.isValidPhone(input.phone)) errors.push("ĞĞµĞºĞ¾Ñ€Ñ€ĞµĞºÑ‚Ğ½Ñ‹Ğ¹ Ñ„Ğ¾Ñ€Ğ¼Ğ°Ñ‚ Ñ‚ĞµĞ»ĞµÑ„Ğ¾Ğ½Ğ°");
        if (!input.privacyPolicyAccepted) errors.push("ĞĞµĞ¾Ğ±Ñ…Ğ¾Ğ´Ğ¸Ğ¼Ğ¾ Ğ¿Ñ€Ğ¸Ğ½ÑÑ‚ÑŒ Ğ¿Ğ¾Ğ»Ğ¸Ñ‚Ğ¸ĞºÑƒ ĞºĞ¾Ğ½Ñ„Ğ¸Ğ´ĞµĞ½Ñ†Ğ¸Ğ°Ğ»ÑŒĞ½Ğ¾ÑÑ‚Ğ¸");
        if (!input.termsAccepted) errors.push("ĞĞµĞ¾Ğ±Ñ…Ğ¾Ğ´Ğ¸Ğ¼Ğ¾ Ğ¿Ñ€Ğ¸Ğ½ÑÑ‚ÑŒ ÑƒÑĞ»Ğ¾Ğ²Ğ¸Ñ Ğ¸ÑĞ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ");
        return { isValid: errors.length === 0, errors };
    }

    /**
     * ĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑĞµÑ‚ Ğ²Ğ°Ğ»Ğ¸Ğ´Ğ½Ğ¾ÑÑ‚ÑŒ email
     */
    private static isValidEmail(email: string): boolean {
        const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
        return emailRegex.test(email);
    }

    /**
     * ĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑĞµÑ‚ Ğ²Ğ°Ğ»Ğ¸Ğ´Ğ½Ğ¾ÑÑ‚ÑŒ Ñ‚ĞµĞ»ĞµÑ„Ğ¾Ğ½Ğ°
     */
    private static isValidPhone(phone: string): boolean {
        const phoneRegex = /^[+]?[0-9\s-()]+$/;
        return phoneRegex.test(phone) && phone.replace(/\D/g, '').length >= 10;
    }

    /**
     * Ğ¡Ğ¾Ñ€Ñ‚Ğ¸Ñ€ÑƒĞµÑ‚ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ĞµĞ¹ Ğ¿Ğ¾ Ğ·Ğ°Ğ´Ğ°Ğ½Ğ½Ğ¾Ğ¼Ñƒ ĞºÑ€Ğ¸Ñ‚ĞµÑ€Ğ¸Ñ
     */
    static sortUsers(
        users: UserOut[],
        sortBy: 'full_name' | 'email' | 'role' | 'created_at' | 'balance',
        sortOrder: 'asc' | 'desc' = 'asc'
    ): UserOut[] {
        return [...users].sort((a, b) => {
            let aValue: string | number | Date = a[sortBy] as string | number | Date;
            let bValue: string | number | Date = b[sortBy] as string | number | Date;

            if (aValue === null || aValue === undefined) aValue = '';
            if (bValue === null || bValue === undefined) bValue = '';

            if (sortBy === 'created_at') {
                aValue = new Date(aValue as string).getTime();
                bValue = new Date(bValue as string).getTime();
            }

            if (sortBy === 'balance') {
                aValue = Number(aValue) || 0;
                bValue = Number(bValue) || 0;
            }

            if (typeof aValue === 'string' && typeof bValue === 'string') {
                aValue = aValue.toLowerCase();
                bValue = bValue.toLowerCase();
            }

            if (aValue < bValue) return sortOrder === 'asc' ? -1 : 1;
            if (aValue > bValue) return sortOrder === 'asc' ? 1 : -1;
            return 0;
        });
    }

    /**
     * Ğ“ĞµĞ½ĞµÑ€Ğ¸Ñ€ÑƒĞµÑ‚ ĞºĞ»ÑÑ‡ Ğ´Ğ»Ñ ĞºÑÑˆĞ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ĞµĞ¹
     */
    static generateUsersCacheKey(filters?: UserFilterOptions): string {
        return JSON.stringify(["users", filters]);
    }

    /**
     * Ğ“ĞµĞ½ĞµÑ€Ğ¸Ñ€ÑƒĞµÑ‚ ĞºĞ»ÑÑ‡ Ğ´Ğ»Ñ ĞºÑÑˆĞ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ Ğ¿Ñ€Ğ¾Ñ„Ğ¸Ğ»Ñ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ñ
     */
    static generateUserProfileCacheKey(): string {
        return JSON.stringify(["user-profile"]);
    }
}

```


## <a name="srccoreservicesindexts"></a>`src/core/services/index.ts`

```typescript
// path: src/core/services/index.ts

// src/core/services/index.ts

// Ğ­ĞºÑĞ¿Ğ¾Ñ€Ñ‚ Ğ²ÑĞµÑ… ÑĞµÑ€Ğ²Ğ¸ÑĞ¾Ğ²
export { ReservationService } from './ReservationService';
export { EquipmentService } from './EquipmentService';
export { AvailabilityService } from './AvailabilityService';
export { PromoCodeService } from './PromoCodeService';
export { UserService } from './UserService';
export { AccessoryService } from './AccessoryService';
export { PhoneService } from './PhoneService';
export { CalendarService } from './CalendarService';
export { DateService } from './DateService';

// Ğ­ĞºÑĞ¿Ğ¾Ñ€Ñ‚ Ñ‚Ğ¸Ğ¿Ğ¾Ğ²
export type {
    ReservationCreateInput,
    ReservationUpdateInput
} from './ReservationService';

export type {
    EquipmentListResponse,
    EquipmentFilterParams
} from './EquipmentService';

export type {
    PromoCodeValidationResult,
    PromoCodeFilterOptions
} from './PromoCodeService';

export type {
    UserCreateInput,
    UserUpdateInput,
    UserFilterOptions,
    UserValidationResult
} from './UserService';

export type {
    AccessoryCreateInput,
    AccessoryUpdateInput,
    AccessoryFilterOptions,
    AccessoryValidationResult
} from './AccessoryService';

export type {
    PhoneValidationResult
} from './PhoneService';

export type {
    CalendarGridData,
    CalendarFilterOptions
} from './CalendarService';

export type {
    DateRange,
    DateRangeValidationResult
} from './DateService';

export type {
    AvailabilityStatusParams,
    DailyStatusParams,
    ConflictCheckParams
} from './AvailabilityService';

```


## <a name="srchooksadmincreate-reservationuseCreateReservationDatats"></a>`src/hooks/admin/create-reservation/useCreateReservationData.ts`

```typescript
// path: src/hooks/admin/create-reservation/useCreateReservationData.ts

// src/hooks/admin/create-reservation/useCreateReservationData.ts

import { useMemo } from "react";
import { useAdminUsers } from "@/hooks/useAdminUsers";
import { useEquipment } from "@/hooks/useEquipment";
import { useAvailabilityCheck } from "@/hooks/useAvailabilityCheck";
import { EquipmentService } from "@/core/services";
import type { Equipment } from "@/types/equipment";

interface UseCreateReservationDataInputs {
    equipmentSearch: string;
    watchedStartDate: string;
    watchedEndDate: string;
    watchedEquipmentIds: number[];
}

/**
 * Ğ¥ÑƒĞº Ğ´Ğ»Ñ Ğ¿Ğ¾Ğ»ÑƒÑ‡ĞµĞ½Ğ¸Ñ Ğ¸ Ğ¾Ğ±Ñ€Ğ°Ğ±Ğ¾Ñ‚ĞºĞ¸ Ğ´Ğ°Ğ½Ğ½Ñ‹Ñ… Ğ´Ğ»Ñ Ñ„Ğ¾Ñ€Ğ¼Ñ‹ ÑĞ¾Ğ·Ğ´Ğ°Ğ½Ğ¸Ñ Ñ€ĞµĞ·ĞµÑ€Ğ²Ğ°.
 * Ğ¡Ğ¾Ğ´ĞµÑ€Ğ¶Ğ¸Ñ‚ Ğ²ÑÑ Ğ»Ğ¾Ğ³Ğ¸ĞºÑƒ Ğ¿Ğ¾Ğ»ÑƒÑ‡ĞµĞ½Ğ¸Ñ Ğ´Ğ°Ğ½Ğ½Ñ‹Ñ…: Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ğ¸, Ğ¾Ğ±Ğ¾Ñ€ÑƒĞ´Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ, Ğ´Ğ¾ÑÑ‚ÑƒĞ¿Ğ½Ğ¾ÑÑ‚ÑŒ.
 */
export const useCreateReservationData = ({
    equipmentSearch,
    watchedStartDate,
    watchedEndDate,
    watchedEquipmentIds
}: UseCreateReservationDataInputs) => {

    // 1. Ğ—Ğ°Ğ³Ñ€ÑƒĞ·ĞºĞ° Ğ¸ÑÑ…Ğ¾Ğ´Ğ½Ñ‹Ñ… Ğ´Ğ°Ğ½Ğ½Ñ‹Ñ…
    const { data: usersResponse, isLoading: isLoadingUsers } = useAdminUsers();
    const { data: equipmentPages, isLoading: isLoadingEquipment } = useEquipment({}); // Ğ’Ñ‹Ğ·Ñ‹Ğ²Ğ°ĞµĞ¼ Ñ Ğ¿ÑƒÑÑ‚Ñ‹Ğ¼ Ğ¾Ğ±ÑŠĞµĞºÑ‚Ğ¾Ğ¼ Ñ„Ğ¸Ğ»ÑŒÑ‚Ñ€Ğ¾Ğ²

    // 2. "Ğ Ğ°Ğ·Ğ²Ğ¾Ñ€Ğ°Ñ‡Ğ¸Ğ²Ğ°ĞµĞ¼" ÑÑ‚Ñ€Ğ°Ğ½Ğ¸Ñ†Ñ‹ Ğ² Ğ¾Ğ´Ğ¸Ğ½ Ğ¿Ğ»Ğ¾ÑĞºĞ¸Ğ¹ Ğ¼Ğ°ÑÑĞ¸Ğ² `allEquipment`
    const allEquipment = useMemo(() =>
        equipmentPages?.pages.flatMap((page) => page.items) ?? [],
        [equipmentPages]);

    const users = useMemo(() => 
        usersResponse?.pages?.flatMap(page => page.items) ?? [], 
        [usersResponse]
    );

    // 3. Ğ¤Ğ¸Ğ»ÑŒÑ‚Ñ€Ğ°Ñ†Ğ¸Ñ Ğ¸ Ğ³Ñ€ÑƒĞ¿Ğ¿Ğ¸Ñ€Ğ¾Ğ²ĞºĞ° Ğ¾Ğ±Ğ¾Ñ€ÑƒĞ´Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ
    const filteredAndGroupedEquipment = useMemo(() => {
        return EquipmentService.filterAndGroupEquipment(allEquipment, equipmentSearch);
    }, [allEquipment, equipmentSearch]);

    // 4. ĞŸÑ€Ğ¾Ğ²ĞµÑ€ĞºĞ° Ğ´Ğ¾ÑÑ‚ÑƒĞ¿Ğ½Ğ¾ÑÑ‚Ğ¸ Ğ¾Ñ‚Ñ„Ğ¸Ğ»ÑŒÑ‚Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ½Ğ¾Ğ³Ğ¾ Ğ¾Ğ±Ğ¾Ñ€ÑƒĞ´Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ
    const { validStartDate, validEndDate } = useMemo(() => {
        const start = watchedStartDate ? new Date(watchedStartDate) : null;
        const end = watchedEndDate ? new Date(watchedEndDate) : null;
        return {
            validStartDate: start && !isNaN(start.getTime()) ? start : null,
            validEndDate: end && !isNaN(end.getTime()) ? end : null,
        }
    }, [watchedStartDate, watchedEndDate]);

    const { 
        availabilityMap, 
        hasConflicts: hasConflictsInSelection, 
        isLoading: isLoadingAvailability 
    } = useAvailabilityCheck({
        equipmentIds: filteredAndGroupedEquipment.visibleIds,
        startDate: validStartDate || new Date(),
        endDate: validEndDate || new Date(),
        enabled: !!(validStartDate && validEndDate && filteredAndGroupedEquipment.visibleIds.length > 0)
    });

    // Ğ’ÑĞ¿Ğ¾Ğ¼Ğ¾Ğ³Ğ°Ñ‚ĞµĞ»ÑŒĞ½Ğ°Ñ Ñ„ÑƒĞ½ĞºÑ†Ğ¸Ñ Ğ´Ğ»Ñ Ğ¿Ğ¾Ğ»ÑƒÑ‡ĞµĞ½Ğ¸Ñ Ğ¾Ğ±Ğ¾Ñ€ÑƒĞ´Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ Ñ Ğ°ĞºÑĞµÑÑÑƒĞ°Ñ€Ğ°Ğ¼Ğ¸
    const getEquipmentWithAccessories = (allEq: Equipment[], ids: number[]): Equipment[] => {
        const selectedIds = new Set(ids);
        return allEq.filter(eq => selectedIds.has(eq.id) && eq.accessories && eq.accessories.length > 0);
    };

    const equipmentWithAccessories = useMemo(() => getEquipmentWithAccessories(allEquipment, watchedEquipmentIds), [watchedEquipmentIds, allEquipment]);

    return {
        users,
        isLoadingUsers,
        allEquipment,
        isLoadingEquipment,
        filteredAndGroupedEquipment,
        availabilityMap,
        isLoadingAvailability,
        hasConflictsInSelection,
        equipmentWithAccessories
    };
};


```


## <a name="srchooksadmincreate-reservationuseCreateReservationDialogts"></a>`src/hooks/admin/create-reservation/useCreateReservationDialog.ts`

```typescript
// path: src/hooks/admin/create-reservation/useCreateReservationDialog.ts

// src/hooks/admin/create-reservation/useCreateReservationDialog.ts

import { useState, useEffect, useCallback } from "react";
import { useCreateAdminReservation } from "@/hooks/useAdminReservations";
import { useAdminReservationCalculator } from "../useAdminReservationCalculator";
import { formatDate } from "@/lib/utils";
import { useCreateReservationData } from "./useCreateReservationData";
import { useCreateReservationForm, type CreateReservationFormData } from "./useCreateReservationForm";

const todayDate = new Date();
const tomorrowDate = new Date();
tomorrowDate.setDate(todayDate.getDate() + 1);

/**
 * Ğ£ĞŸĞ ĞĞ©Ğ•ĞĞĞ«Ğ™ Ğ¥Ğ£Ğš-ĞĞ ĞšĞ•Ğ¡Ğ¢Ğ ĞĞ¢ĞĞ 
 * Ğ£Ğ¿Ñ€Ğ°Ğ²Ğ»ÑĞµÑ‚ ÑĞ¾ÑÑ‚Ğ¾ÑĞ½Ğ¸ĞµĞ¼ Ğ´Ğ¸Ğ°Ğ»Ğ¾Ğ³Ğ° ÑĞ¾Ğ·Ğ´Ğ°Ğ½Ğ¸Ñ Ñ€ĞµĞ·ĞµÑ€Ğ²Ğ°, Ğ¸ÑĞ¿Ğ¾Ğ»ÑŒĞ·ÑƒÑ Ğ´Ğ¾Ñ‡ĞµÑ€Ğ½Ğ¸Ğµ Ñ…ÑƒĞºĞ¸ Ğ´Ğ»Ñ Ğ´Ğ°Ğ½Ğ½Ñ‹Ñ… Ğ¸ Ñ€Ğ°ÑÑ‡ĞµÑ‚Ğ¾Ğ².
 */
export const useCreateReservationDialog = ({ isOpen, onClose }: { isOpen: boolean; onClose: () => void }) => {
    // 1. Ğ¡Ğ¾ÑÑ‚Ğ¾ÑĞ½Ğ¸Ğµ UI Ğ´Ğ¸Ğ°Ğ»Ğ¾Ğ³Ğ°
    const [step, setStep] = useState<'details' | 'accessories'>('details');
    const [equipmentSearch, setEquipmentSearch] = useState("");
    const [clientPopoverOpen, setClientPopoverOpen] = useState(false);

    // 2. Ğ£Ğ¿Ñ€Ğ°Ğ²Ğ»ĞµĞ½Ğ¸Ğµ Ñ„Ğ¾Ñ€Ğ¼Ğ¾Ğ¹ Ñ‡ĞµÑ€ĞµĞ· ÑĞ¿ĞµÑ†Ğ¸Ğ°Ğ»Ğ¸Ğ·Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ½Ñ‹Ğ¹ Ñ…ÑƒĞº
    const { form, watch, trigger, handleSubmit, reset } = useCreateReservationForm();

    const watchedStartDate = watch("start_date");
    const watchedEndDate = watch("end_date");
    const watchedEquipmentIds = watch("equipment_ids");

    // 3. ĞŸĞ¾Ğ»ÑƒÑ‡ĞµĞ½Ğ¸Ğµ Ğ´Ğ°Ğ½Ğ½Ñ‹Ñ… Ñ‡ĞµÑ€ĞµĞ· ÑĞ¿ĞµÑ†Ğ¸Ğ°Ğ»Ğ¸Ğ·Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ½Ñ‹Ğ¹ Ñ…ÑƒĞº
    const {
        users,
        isLoadingUsers,
        allEquipment,
        isLoadingEquipment,
        filteredAndGroupedEquipment,
        availabilityMap,
        isLoadingAvailability,
        hasConflictsInSelection,
        equipmentWithAccessories,
    } = useCreateReservationData({
        equipmentSearch,
        watchedStartDate,
        watchedEndDate,
        watchedEquipmentIds,
    });

    // 4. Ğ Ğ°ÑÑ‡ĞµÑ‚ Ñ„Ğ¸Ğ½Ğ°Ğ½ÑĞ¾Ğ²
    const financialData = useAdminReservationCalculator(watch, allEquipment);

    // 5. Ğ›Ğ¾Ğ³Ğ¸ĞºĞ° Ğ¾Ñ‚Ğ¿Ñ€Ğ°Ğ²ĞºĞ¸ Ñ„Ğ¾Ñ€Ğ¼Ñ‹
    const createReservationMutation = useCreateAdminReservation();

    const handleCloseDialog = useCallback(() => onClose(), [onClose]);

    const processSubmit = useCallback((data: CreateReservationFormData) => {
        if (hasConflictsInSelection) {
            alert("ĞĞµĞ»ÑŒĞ·Ñ ÑĞ¾Ğ·Ğ´Ğ°Ñ‚ÑŒ Ñ€ĞµĞ·ĞµÑ€Ğ², Ñ‚Ğ°Ğº ĞºĞ°Ğº Ğ² Ğ²Ğ°ÑˆĞµĞ¼ Ğ²Ñ‹Ğ±Ğ¾Ñ€Ğµ ĞµÑÑ‚ÑŒ ĞºĞ¾Ğ½Ñ„Ğ»Ğ¸ĞºÑ‚Ğ½Ñ‹Ğµ Ğ¿Ğ¾Ğ·Ğ¸Ñ†Ğ¸Ğ¸.");
            return;
        }
        createReservationMutation.mutate(data, { onSuccess: handleCloseDialog });
    }, [hasConflictsInSelection, createReservationMutation, handleCloseDialog]);

    const handleNextStep = useCallback(async () => {
        const isValid = await trigger(["user_id", "start_date", "end_date", "equipment_ids"]);
        if (!isValid) return;

        if (equipmentWithAccessories.length > 0) {
            setStep('accessories');
        } else {
            // âœ… Ğ˜Ğ¡ĞŸĞ ĞĞ’Ğ›Ğ•ĞĞ˜Ğ•: Ğ”Ğ¾Ğ±Ğ°Ğ²Ğ»ĞµĞ½Ğ¾ ĞºĞ»ÑÑ‡ĞµĞ²Ğ¾Ğµ ÑĞ»Ğ¾Ğ²Ğ¾ `await` Ğ´Ğ»Ñ Ğ°ÑĞ¸Ğ½Ñ…Ñ€Ğ¾Ğ½Ğ½Ğ¾Ğ³Ğ¾ Ğ²Ñ‹Ğ·Ğ¾Ğ²Ğ°.
            await handleSubmit(processSubmit)();
        }
    }, [trigger, equipmentWithAccessories, handleSubmit, processSubmit]);

    // 6. Ğ¡Ğ±Ñ€Ğ¾Ñ ÑĞ¾ÑÑ‚Ğ¾ÑĞ½Ğ¸Ñ Ğ¿Ñ€Ğ¸ Ğ·Ğ°ĞºÑ€Ñ‹Ñ‚Ğ¸Ğ¸ Ğ´Ğ¸Ğ°Ğ»Ğ¾Ğ³Ğ°
    useEffect(() => {
        if (!isOpen) {
            reset({
                equipment_ids: [], 
                selected_accessories: {},
                start_date: formatDate(todayDate), 
                end_date: formatDate(tomorrowDate),
            });
            setEquipmentSearch("");
            setStep('details');
        }
    }, [isOpen, reset]);

    // 7. Ğ’Ğ¾Ğ·Ğ²Ñ€Ğ°Ñ‰Ğ°ĞµĞ¼ ĞµĞ´Ğ¸Ğ½Ñ‹Ğ¹ Ğ¸Ğ½Ñ‚ĞµÑ€Ñ„ĞµĞ¹Ñ Ğ´Ğ»Ñ ĞºĞ¾Ğ¼Ğ¿Ğ¾Ğ½ĞµĞ½Ñ‚Ğ°
    return {
        step,
        form,
        isSubmitting: createReservationMutation.isPending,
        users,
        isLoadingUsers,
        clientPopoverOpen,
        setClientPopoverOpen,
        equipmentSearch,
        setEquipmentSearch,
        isLoadingEquipment,
        filteredAndGroupedEquipment,
        equipmentWithAccessories,
        availabilityMap,
        isLoadingAvailability,
        hasConflictsInSelection,
        setStep,
        handleNextStep,
        onSubmit: handleSubmit(processSubmit),
        handleCloseDialog,
        financialData,
    };
};


```


## <a name="srchooksadmincreate-reservationuseCreateReservationFormts"></a>`src/hooks/admin/create-reservation/useCreateReservationForm.ts`

```typescript
// path: src/hooks/admin/create-reservation/useCreateReservationForm.ts

// src/hooks/admin/create-reservation/useCreateReservationForm.ts

import { useForm } from "react-hook-form";
import { zodResolver } from "@hookform/resolvers/zod";
import { z } from "zod";
import { formatDate } from "@/lib/utils";

const createSchema = z.object({
    user_id: z.coerce.number().min(1, "ĞĞµĞ¾Ğ±Ñ…Ğ¾Ğ´Ğ¸Ğ¼Ğ¾ Ğ²Ñ‹Ğ±Ñ€Ğ°Ñ‚ÑŒ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ñ"),
    start_date: z.string().min(1, "ĞĞµĞ¾Ğ±Ñ…Ğ¾Ğ´Ğ¸Ğ¼Ğ¾ ÑƒĞºĞ°Ğ·Ğ°Ñ‚ÑŒ Ğ´Ğ°Ñ‚Ñƒ Ğ½Ğ°Ñ‡Ğ°Ğ»Ğ°"),
    end_date: z.string().min(1, "ĞĞµĞ¾Ğ±Ñ…Ğ¾Ğ´Ğ¸Ğ¼Ğ¾ ÑƒĞºĞ°Ğ·Ğ°Ñ‚ÑŒ Ğ´Ğ°Ñ‚Ñƒ Ğ¾ĞºĞ¾Ğ½Ñ‡Ğ°Ğ½Ğ¸Ñ"),
    equipment_ids: z.array(z.number()).min(1, "Ğ’Ñ‹Ğ±ĞµÑ€Ğ¸Ñ‚Ğµ Ñ…Ğ¾Ñ‚Ñ Ğ±Ñ‹ Ğ¾Ğ´Ğ½Ñƒ Ğ¿Ğ¾Ğ·Ğ¸Ñ†Ğ¸Ñ Ğ¾Ğ±Ğ¾Ñ€ÑƒĞ´Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ"),
    selected_accessories: z.record(z.array(z.number())).optional(),
}).refine(data => new Date(data.end_date) >= new Date(data.start_date), {
    message: "Ğ”Ğ°Ñ‚Ğ° Ğ¾ĞºĞ¾Ğ½Ñ‡Ğ°Ğ½Ğ¸Ñ Ğ½Ğµ Ğ¼Ğ¾Ğ¶ĞµÑ‚ Ğ±Ñ‹Ñ‚ÑŒ Ñ€Ğ°Ğ½ÑŒÑˆĞµ Ğ´Ğ°Ñ‚Ñ‹ Ğ½Ğ°Ñ‡Ğ°Ğ»Ğ°",
    path: ["end_date"],
});

export type CreateReservationFormData = z.infer<typeof createSchema>;

const todayDate = new Date();
const tomorrowDate = new Date();
tomorrowDate.setDate(todayDate.getDate() + 1);

/**
 * Ğ¥ÑƒĞº Ğ´Ğ»Ñ ÑƒĞ¿Ñ€Ğ°Ğ²Ğ»ĞµĞ½Ğ¸Ñ Ñ„Ğ¾Ñ€Ğ¼Ğ¾Ğ¹ ÑĞ¾Ğ·Ğ´Ğ°Ğ½Ğ¸Ñ Ñ€ĞµĞ·ĞµÑ€Ğ²Ğ°.
 * Ğ¡Ğ¾Ğ´ĞµÑ€Ğ¶Ğ¸Ñ‚ Ğ²ÑÑ Ğ»Ğ¾Ğ³Ğ¸ĞºÑƒ, ÑĞ²ÑĞ·Ğ°Ğ½Ğ½ÑƒÑ Ñ react-hook-form.
 */
export const useCreateReservationForm = () => {
    const form = useForm<CreateReservationFormData>({
        resolver: zodResolver(createSchema), 
        mode: "onChange",
        defaultValues: {
            equipment_ids: [], 
            selected_accessories: {},
            start_date: formatDate(todayDate), 
            end_date: formatDate(tomorrowDate),
        },
    });

    const { watch, trigger, handleSubmit, reset } = form;

    return {
        form,
        watch,
        trigger,
        handleSubmit,
        reset,
    };
};


```


## <a name="srchooksadminuseAdminRentalEditts"></a>`src/hooks/admin/useAdminRentalEdit.ts`

```typescript
// path: src/hooks/admin/useAdminRentalEdit.ts

// hooks/admin/useAdminRentalEdit.ts (ĞĞĞ’Ğ«Ğ™ Ğ¤ĞĞ™Ğ›)

import { useForm } from "react-hook-form";
import { zodResolver } from "@hookform/resolvers/zod";
import { z } from "zod";
import { useMutation, useQueryClient } from "@tanstack/react-query";
import { toast } from "sonner";
import { api } from "@/lib/api";
import { formatDate } from "@/lib/utils";
import type { AdminRentalOut } from "@/types/reservation";

// Ğ¡Ñ…ĞµĞ¼Ğ° Ğ²Ğ°Ğ»Ğ¸Ğ´Ğ°Ñ†Ğ¸Ğ¸ Ğ´Ğ»Ñ Ñ„Ğ¾Ñ€Ğ¼Ñ‹ Ñ€ĞµĞ´Ğ°ĞºÑ‚Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ
const rentalEditSchema = z.object({
    end_date: z.string().optional(),
    actual_return_date: z.string().nullable().optional(),
    status: z.string().optional(),
    final_cost: z.coerce.number().optional(),
    deposit_amount: z.coerce.number().optional(),
    notes_on_issue: z.string().optional(),
    notes_on_return: z.string().optional(),
});

type RentalEditFormData = z.infer<typeof rentalEditSchema>;

interface UseAdminRentalEditProps {
    rental: AdminRentalOut;
    onSuccess: () => void;
}

export function useAdminRentalEdit({ rental, onSuccess }: UseAdminRentalEditProps) {
    const queryClient = useQueryClient();

    const { register, handleSubmit, formState: { errors, isValid, isDirty } } = useForm<RentalEditFormData>({
        resolver: zodResolver(rentalEditSchema),
        defaultValues: {
            end_date: formatDate(rental.end_date),
            actual_return_date: rental.actual_return_date ? formatDate(rental.actual_return_date) : null,
            status: rental.status,
            final_cost: rental.final_cost ?? undefined,
            deposit_amount: rental.deposit_amount,
            notes_on_issue: rental.notes_on_issue ?? "",
            notes_on_return: rental.notes_on_return ?? "",
        },
        mode: "onChange",
    });

    const updateMutation = useMutation({
        mutationFn: (data: RentalEditFormData) => api.put(`/admin/rentals/${rental.id}`, data),
        onSuccess: () => {
            toast.success("ĞÑ€ĞµĞ½Ğ´Ğ° ÑƒÑĞ¿ĞµÑˆĞ½Ğ¾ Ğ¾Ğ±Ğ½Ğ¾Ğ²Ğ»ĞµĞ½Ğ°");
            void queryClient.invalidateQueries({ queryKey: ["adminRentals"] });
            onSuccess(); // Ğ—Ğ°ĞºÑ€Ñ‹Ğ²Ğ°ĞµĞ¼ Ñ„Ğ¾Ñ€Ğ¼Ñƒ Ñ€ĞµĞ´Ğ°ĞºÑ‚Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ
        },
        onError: (error: any) => {
            toast.error(error?.response?.data?.detail || "ĞÑˆĞ¸Ğ±ĞºĞ° Ğ¿Ñ€Ğ¸ Ğ¾Ğ±Ğ½Ğ¾Ğ²Ğ»ĞµĞ½Ğ¸Ğ¸ Ğ°Ñ€ĞµĞ½Ğ´Ñ‹");
        },
    });

    const onSubmit = (data: RentalEditFormData) => {
        updateMutation.mutate(data);
    };

    return {
        register,
        handleSubmit: handleSubmit(onSubmit),
        errors,
        isValid,
        isDirty,
        isSaving: updateMutation.isPending,
    };
}

```


## <a name="srchooksadminuseAdminReservationCalculatorts"></a>`src/hooks/admin/useAdminReservationCalculator.ts`

```typescript
// path: src/hooks/admin/useAdminReservationCalculator.ts

// src/hooks/admin/useAdminReservationCalculator.ts

import { useMemo } from "react";
import { UseFormWatch } from "react-hook-form";
import { usePromoCodeStore } from "@/store/promoCodeStore";
import { usePriceCalculator } from "../reservation/usePriceCalculator";
import type { CreateReservationFormData } from "./create-reservation/useCreateReservationForm";
import type { Equipment } from "@/types/equipment";

/**
 * Ğ¥ÑƒĞº Ğ´Ğ»Ñ Ñ€Ğ°ÑÑ‡ĞµÑ‚Ğ° ÑÑ‚Ğ¾Ğ¸Ğ¼Ğ¾ÑÑ‚Ğ¸ Ñ€ĞµĞ·ĞµÑ€Ğ²Ğ° Ğ² Ğ°Ğ´Ğ¼Ğ¸Ğ½-Ğ¿Ğ°Ğ½ĞµĞ»Ğ¸.
 * Ğ˜ÑĞ¿Ğ¾Ğ»ÑŒĞ·ÑƒĞµÑ‚ Ñ†ĞµĞ½Ñ‚Ñ€Ğ°Ğ»Ğ¸Ğ·Ğ¾Ğ²Ğ°Ğ½Ğ½Ñ‹Ğ¹ usePriceCalculator ĞºĞ°Ğº ĞµĞ´Ğ¸Ğ½Ñ‹Ğ¹ Ğ¸ÑÑ‚Ğ¾Ñ‡Ğ½Ğ¸Ğº Ğ¿Ñ€Ğ°Ğ²Ğ´Ñ‹.
 */
export function useAdminReservationCalculator(
    watch: UseFormWatch<CreateReservationFormData>,
    allEquipment: Equipment[] = []
) {
    const watchedStartDateStr = watch("start_date");
    const watchedEndDateStr = watch("end_date");
    const watchedEquipmentIds = watch("equipment_ids");
    const watchedSelectedAccessories = watch("selected_accessories") || {};

    const { promoCode, setPromoCode, promoCodeMessage } = usePromoCodeStore();

    const startDate = useMemo(() => watchedStartDateStr ? new Date(watchedStartDateStr) : new Date(), [watchedStartDateStr]);
    const endDate = useMemo(() => watchedEndDateStr ? new Date(watchedEndDateStr) : new Date(), [watchedEndDateStr]);

    const equipmentForCalc = useMemo(() =>
            allEquipment.filter(e => watchedEquipmentIds.includes(e.id)),
        [allEquipment, watchedEquipmentIds]
    );

    // Ğ˜ÑĞ¿Ğ¾Ğ»ÑŒĞ·ÑƒĞµĞ¼ Ñ€Ğ°ÑÑˆĞ¸Ñ€ĞµĞ½Ğ½Ñ‹Ğ¹ usePriceCalculator
    const priceCalculator = usePriceCalculator({
        equipmentIds: equipmentForCalc.map(i => i.id),
        startDate,
        endDate,
        selectedAccessories: watchedSelectedAccessories,
        promoCode: promoCode,
        enabled: watchedEquipmentIds.length > 0 && !!watchedStartDateStr && !!watchedEndDateStr
    });

    const applyPromoCode = () => {
        console.log("Applying promo code from admin calculator context:", promoCode);
    };

    // Ğ’Ğ¾Ğ·Ğ²Ñ€Ğ°Ñ‰Ğ°ĞµĞ¼ Ğ´Ğ°Ğ½Ğ½Ñ‹Ğµ Ğ¸Ğ· Ñ†ĞµĞ½Ñ‚Ñ€Ğ°Ğ»Ğ¸Ğ·Ğ¾Ğ²Ğ°Ğ½Ğ½Ğ¾Ğ³Ğ¾ Ñ…ÑƒĞºĞ°
    return {
        // ĞÑĞ½Ğ¾Ğ²Ğ½Ñ‹Ğµ Ğ´Ğ°Ğ½Ğ½Ñ‹Ğµ Ğ¸Ğ· usePriceCalculator
        priceDetails: priceCalculator.priceDetails,
        
        // Ğ¤Ğ¸Ğ½Ğ°Ğ½ÑĞ¾Ğ²Ñ‹Ğµ Ğ´Ğ°Ğ½Ğ½Ñ‹Ğµ Ğ¸Ğ· usePriceCalculator
        dayCount: priceCalculator.dayCount,
        fullTotal: priceCalculator.fullTotal,
        finalTotal: priceCalculator.finalTotal,
        discountAmount: priceCalculator.discountAmount,
        totalDiscountPercentage: priceCalculator.totalDiscountPercentage,
        durationDiscountPercentage: priceCalculator.durationDiscountPercentage,
        promoDiscountPercentage: priceCalculator.promoDiscountPercentage,
        
        // ĞŸÑ€Ğ¾Ğ¼Ğ¾ĞºĞ¾Ğ´
        promoCode,
        setPromoCode,
        applyPromoCode,
        promoCodeMessage: priceCalculator.promoCodeMessage || promoCodeMessage,
        
        // Ğ¡Ğ¾ÑÑ‚Ğ¾ÑĞ½Ğ¸Ñ Ğ·Ğ°Ğ³Ñ€ÑƒĞ·ĞºĞ¸
        isApplyingPromoCode: priceCalculator.isApplyingPromoCode,
        isCalculatingPrice: priceCalculator.isCalculatingPrice,
        isFetchingPrice: priceCalculator.isFetchingPrice,
    };
}

```


## <a name="srchooksadminuseDashboardDatats"></a>`src/hooks/admin/useDashboardData.ts`

```typescript
// path: src/hooks/admin/useDashboardData.ts

// src/hooks/admin/useDashboardData.ts

import { useQuery } from "@tanstack/react-query";
import { api } from "@/lib/api";

// Ğ¢Ğ¸Ğ¿Ñ‹ Ğ´Ğ°Ğ½Ğ½Ñ‹Ñ… Ğ´Ğ»Ñ Ğ´Ğ°ÑˆĞ±Ğ¾Ñ€Ğ´Ğ°
export interface DashboardSummary {
    pickups_today: PickupReturnItem[];
    returns_today: PickupReturnItem[];
    overdue_rentals: OverdueRentalItem[];
    kpi: {
        total_users: number;
        active_users: number;
        total_equipment: number;
        total_reservations: number;
        revenue_today: number;
        revenue_this_month: number;
        occupancy_rate: number;
        avg_rental_duration: number;
    };
    recent_activity: ActivityFeedItem[];
    popular_equipment: PopularEquipmentItem[];
}

export interface PickupReturnItem {
    id: number;
    user_name: string;
    equipment_name: string;
    scheduled_time: string | null;
    status: string;
    start_date?: string;
}

export interface OverdueRentalItem {
    id: number;
    user_name: string;
    equipment_name: string;
    due_date: string | null;
    days_overdue: number | null;
}

export interface ActivityFeedItem {
    id: number;
    type: 'reservation_created' | 'reservation_cancelled' | 'rental_started' | 'rental_completed' | 'user_registered' | 'equipment_added';
    description: string;
    timestamp: string;
    user_name?: string;
    equipment_name?: string;
}

export interface PopularEquipmentItem {
    equipment_id: number;
    equipment_name: string;
    rental_count: number;
    revenue: number;
}

export const useDashboardData = () => {
    return useQuery({
        queryKey: ['admin', 'dashboardSummary'],
        queryFn: async (): Promise<DashboardSummary> => {
            const response = await api.get('/admin/dashboard-summary');
            return response.data;
        },
        staleTime: 5 * 60 * 1000, // 5 Ğ¼Ğ¸Ğ½ÑƒÑ‚
        refetchInterval: 2 * 60 * 1000, // 2 Ğ¼Ğ¸Ğ½ÑƒÑ‚Ñ‹
        retry: 3,
        retryDelay: (attemptIndex) => Math.min(1000 * 2 ** attemptIndex, 30000),
    });
};


```


## <a name="srchooksadminuseEquipmentTableLogicts"></a>`src/hooks/admin/useEquipmentTableLogic.ts`

```typescript
// path: src/hooks/admin/useEquipmentTableLogic.ts

// src/hooks/admin/useEquipmentTableLogic.ts
import { useState, useMemo } from "react";
import { useQueryClient } from "@tanstack/react-query";
import { useCurrentUser } from "@/hooks/useProfile";
// â›”ï¸ Ğ£Ğ´Ğ°Ğ»ÑĞµĞ¼ useEquipment, Ñ‚Ğ°Ğº ĞºĞ°Ğº Ñ…ÑƒĞº Ğ±Ğ¾Ğ»ÑŒÑˆĞµ Ğ½Ğµ Ğ±ÑƒĞ´ĞµÑ‚ Ğ·Ğ°Ğ³Ñ€ÑƒĞ¶Ğ°Ñ‚ÑŒ Ğ´Ğ°Ğ½Ğ½Ñ‹Ğµ ÑĞ°Ğ¼
// import { useEquipment } from "@/hooks/useEquipment";
import { useDeleteEquipment, useBulkDeleteEquipment } from "@/hooks/useAdminEquipment";
import { api } from "@/lib/api";
import { toast } from "sonner";
import type { Equipment } from "@/types/equipment"; // âœ… Ğ”Ğ¾Ğ±Ğ°Ğ²Ğ»ÑĞµĞ¼ Ğ¸Ğ¼Ğ¿Ğ¾Ñ€Ñ‚ Ñ‚Ğ¸Ğ¿Ğ°

interface EquipmentAvailability {
    hasActiveReservations: boolean;
    hasActiveRentals: boolean;
    activeReservationsCount: number;
    activeRentalsCount: number;
}

// âœ… Ğ¥ÑƒĞº Ñ‚ĞµĞ¿ĞµÑ€ÑŒ Ğ¿Ñ€Ğ¸Ğ½Ğ¸Ğ¼Ğ°ĞµÑ‚ Ğ¼Ğ°ÑÑĞ¸Ğ² Ğ¾Ğ±Ğ¾Ñ€ÑƒĞ´Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ ĞºĞ°Ğº Ğ°Ñ€Ğ³ÑƒĞ¼ĞµĞ½Ñ‚
export const useEquipmentTableLogic = (equipment: Equipment[] = []) => {
    const queryClient = useQueryClient();
    const { data: currentUser } = useCurrentUser();
    // â›”ï¸ Ğ£Ğ´Ğ°Ğ»ÑĞµĞ¼ Ğ²Ğ½ÑƒÑ‚Ñ€ĞµĞ½Ğ½Ğ¸Ğ¹ Ğ²Ñ‹Ğ·Ğ¾Ğ² useEquipment()
    // const { data: equipment = [], isLoading, error } = useEquipment();

    const [searchQuery, setSearchQuery] = useState("");
    const [selectedIds, setSelectedIds] = useState<number[]>([]);

    const deleteEquipmentMutation = useDeleteEquipment();
    const bulkDeleteMutation = useBulkDeleteEquipment();

    const isManager = currentUser?.role === "manager" || currentUser?.role === "admin";

    const filteredEquipment = useMemo(() => {
        const lowerCaseQuery = searchQuery.toLowerCase();
        return equipment.filter(item =>
            item.name.toLowerCase().includes(lowerCaseQuery) ||
            item.brand.toLowerCase().includes(lowerCaseQuery) ||
            item.equipment_type.toLowerCase().includes(lowerCaseQuery) ||
            (item.serial_number && item.serial_number.toLowerCase().includes(lowerCaseQuery))
        );
    }, [equipment, searchQuery]);

    const handleSelectAll = (checked: boolean) => {
        setSelectedIds(checked ? filteredEquipment.map(item => item.id) : []);
    };

    const handleSelectItem = (itemId: number, checked: boolean) => {
        setSelectedIds(prev =>
            checked ? [...prev, itemId] : prev.filter(id => id !== itemId)
        );
    };

    const handleDelete = async (itemId: number) => {
        if (!isManager) return;

        try {
            const availability = await queryClient.fetchQuery<EquipmentAvailability>({
                queryKey: ["equipment-availability", itemId],
                queryFn: async () => (await api.get<EquipmentAvailability>(`/equipment/${itemId}/availability`)).data,
            });

            if (availability.hasActiveReservations || availability.hasActiveRentals) {
                const messages = [];
                if (availability.hasActiveReservations) messages.push(`${availability.activeReservationsCount} Ğ°ĞºÑ‚Ğ¸Ğ²Ğ½Ñ‹Ñ… Ñ€ĞµĞ·ĞµÑ€Ğ²Ğ¾Ğ²`);
                if (availability.hasActiveRentals) messages.push(`${availability.activeRentalsCount} Ğ°ĞºÑ‚Ğ¸Ğ²Ğ½Ñ‹Ñ… Ğ°Ñ€ĞµĞ½Ğ´`);
                toast.error(`ĞĞµĞ²Ğ¾Ğ·Ğ¼Ğ¾Ğ¶Ğ½Ğ¾ ÑƒĞ´Ğ°Ğ»Ğ¸Ñ‚ÑŒ: Ñƒ Ğ¾Ğ±Ğ¾Ñ€ÑƒĞ´Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ ĞµÑÑ‚ÑŒ ${messages.join(" Ğ¸ ")}.`);
                return;
            }

            const equipmentToDelete = filteredEquipment.find(item => item.id === itemId);
            if (window.confirm(`Ğ£Ğ´Ğ°Ğ»Ğ¸Ñ‚ÑŒ "${equipmentToDelete?.name}"? Ğ”ĞµĞ¹ÑÑ‚Ğ²Ğ¸Ğµ Ğ½ĞµĞ»ÑŒĞ·Ñ Ğ¾Ñ‚Ğ¼ĞµĞ½Ğ¸Ñ‚ÑŒ.`)) {
                deleteEquipmentMutation.mutate(itemId);
            }
        } catch (err) {
            toast.error("ĞÑˆĞ¸Ğ±ĞºĞ° Ğ¿Ñ€Ğ¸ Ğ¿Ñ€Ğ¾Ğ²ĞµÑ€ĞºĞµ ÑÑ‚Ğ°Ñ‚ÑƒÑĞ° Ğ¾Ğ±Ğ¾Ñ€ÑƒĞ´Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ.");
            console.error("Availability check failed:", err);
        }
    };

    const handleBulkDelete = () => {
        if (!isManager || selectedIds.length === 0) return;
        if (window.confirm(`Ğ£Ğ´Ğ°Ğ»Ğ¸Ñ‚ÑŒ ${selectedIds.length} ĞµĞ´. Ğ¾Ğ±Ğ¾Ñ€ÑƒĞ´Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ?`)) {
            bulkDeleteMutation.mutate(selectedIds, {
                onSuccess: () => setSelectedIds([]),
            });
        }
    };

    const handlers = {
        setSearchQuery,
        handleSelectAll,
        handleSelectItem,
        handleDelete,
        handleBulkDelete
    };

    return {
        isManager,
        // âœ… Ğ¢Ğ°Ğº ĞºĞ°Ğº Ğ·Ğ°Ğ³Ñ€ÑƒĞ·ĞºĞ° Ğ¿Ñ€Ğ¾Ğ¸ÑÑ…Ğ¾Ğ´Ğ¸Ñ‚ Ğ²Ñ‹ÑˆĞµ, Ğ·Ğ´ĞµÑÑŒ Ğ¼Ñ‹ ÑÑ‡Ğ¸Ñ‚Ğ°ĞµĞ¼, Ñ‡Ñ‚Ğ¾ ĞµÑ‘ Ğ½ĞµÑ‚
        isLoading: false,
        error: null,
        equipment,
        filteredEquipment,
        searchQuery,
        selectedIds,
        deleteEquipmentMutation,
        bulkDeleteMutation,
        handlers,
    };
};

```


## <a name="srchooksadminuseRentalReturnFormts"></a>`src/hooks/admin/useRentalReturnForm.ts`

```typescript
// path: src/hooks/admin/useRentalReturnForm.ts

// src/hooks/admin/useRentalReturnForm.ts

import { useForm } from "react-hook-form";
import { zodResolver } from "@hookform/resolvers/zod";
import { z } from "zod";
import { useReturnRental } from "@/hooks/useAdminRentals";
import { useAddUserPayment } from "@/hooks/useAdminUsers";
import { useQueryClient } from "@tanstack/react-query";
import { toast } from "sonner";
import type { AdminRentalOut, RentalAccessoryDetail } from "@/types/rental";
import { formatDate } from "@/lib/utils";
import { useState, useMemo, useEffect } from "react";
import type { Accessory } from "@/types/accessory";
import type { Equipment } from "@/types/equipment";

interface Props {
    rental: AdminRentalOut | null;
    onClose: () => void;
}

const returnSchema = z.object({
    actual_return_date: z.string().min(1, "Ğ”Ğ°Ñ‚Ğ° Ğ¾Ğ±ÑĞ·Ğ°Ñ‚ĞµĞ»ÑŒĞ½Ğ°"),
    notes_on_return: z.string().optional(),
});

type ReturnFormData = z.infer<typeof returnSchema>;

export function useRentalReturnForm({ rental, onClose }: Props) {
    const returnMutation = useReturnRental();
    const queryClient = useQueryClient();
    const paymentMutation = useAddUserPayment();
    
    const { register, handleSubmit, formState: { errors, isValid }, reset } = useForm<ReturnFormData>({
        resolver: zodResolver(returnSchema),
        mode: "onChange",
        defaultValues: {
            actual_return_date: formatDate(new Date()),
            notes_on_return: "",
        },
    });

    const [checkedAccessories, setCheckedAccessories] = useState<Set<string>>(new Set());
    
    // Ğ¡Ğ¾ÑÑ‚Ğ¾ÑĞ½Ğ¸Ğµ Ğ´Ğ»Ñ Ğ¿Ğ»Ğ°Ñ‚ĞµĞ¶Ğ°
    const [paymentAmount, setPaymentAmount] = useState("");
    const [paymentDescription, setPaymentDescription] = useState("");
    const [paymentApplied, setPaymentApplied] = useState(false);

    // Ğ”Ğ¸Ğ½Ğ°Ğ¼Ğ¸Ñ‡ĞµÑĞºĞ¸Ğ¹ Ğ¿ĞµÑ€ĞµÑÑ‡ĞµÑ‚ Ğ¾ÑÑ‚Ğ°Ñ‚ĞºĞ° Ñ ÑƒÑ‡ĞµÑ‚Ğ¾Ğ¼ ÑˆÑ‚Ñ€Ğ°Ñ„Ğ° Ğ·Ğ° Ğ¿Ñ€Ğ¾ÑÑ€Ğ¾Ñ‡ĞºÑƒ
    const dynamicRemainingAmount = useMemo(() => {
        if (!rental) return 0;
        
        const remaining = rental.remaining_amount || 0;
        const surcharge = rental.overdue_surcharge || 0;
        const payment = parseFloat(paymentAmount) || 0;

        // Ğ˜Ñ‚Ğ¾Ğ³Ğ¾Ğ²Ñ‹Ğ¹ Ğ¾ÑÑ‚Ğ°Ñ‚Ğ¾Ğº = (ĞÑÑ‚Ğ°Ñ‚Ğ¾Ğº Ğ¿Ğ¾ Ğ°Ñ€ĞµĞ½Ğ´Ğµ) + (Ğ¨Ñ‚Ñ€Ğ°Ñ„) - (Ğ’Ğ½ĞµÑĞµĞ½Ğ½Ñ‹Ğ¹ Ğ¿Ğ»Ğ°Ñ‚ĞµĞ¶)
        return Math.max(0, remaining + surcharge - payment);
    }, [rental, paymentAmount]);

    // Ğ“Ñ€ÑƒĞ¿Ğ¿Ğ¸Ñ€Ğ¾Ğ²ĞºĞ° Ğ°ĞºÑĞµÑÑÑƒĞ°Ñ€Ğ¾Ğ² Ğ¿Ğ¾ Ğ¾Ğ±Ğ¾Ñ€ÑƒĞ´Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ
    const accessoriesByEquipment = useMemo(() => {
        if (!rental?.accessory_links) return {};
        return rental.accessory_links.reduce((acc: Record<number, Accessory[]>, current: RentalAccessoryDetail) => {
            const equipmentId = current.equipment_id;
            (acc[equipmentId] = acc[equipmentId] || []).push(current.accessory);
            return acc;
        }, {} as Record<number, Accessory[]>);
    }, [rental]);

    const totalAccessoriesCount = rental?.accessory_links?.length ?? 0;
    const allAccessoriesChecked = checkedAccessories.size === totalAccessoriesCount;

    const handleToggleAccessory = (equipmentId: number, accessoryId: number) => {
        const key = `${equipmentId}-${accessoryId}`;
        setCheckedAccessories(prev => {
            const newSet = new Set(prev);
            if (newSet.has(key)) {
                newSet.delete(key);
            } else {
                newSet.add(key);
            }
            return newSet;
        });
    };

    // Ğ›Ğ¾Ğ³Ğ¸ĞºĞ° Ğ¾Ğ±Ñ€Ğ°Ğ±Ğ¾Ñ‚ĞºĞ¸ Ğ¿Ğ»Ğ°Ñ‚ĞµĞ¶Ğ°
    const handleApplyPayment = async () => {
        if (!rental || !paymentAmount) return;
        
        try {
            await paymentMutation.mutateAsync({
                userId: rental.user.id,
                data: {
                    amount: parseFloat(paymentAmount),
                    payment_method: "cash",
                    description: paymentDescription || `ĞŸĞ»Ğ°Ñ‚ĞµĞ¶ Ğ¿Ñ€Ğ¸ Ğ²Ğ¾Ğ·Ğ²Ñ€Ğ°Ñ‚Ğµ Ğ°Ñ€ĞµĞ½Ğ´Ñ‹ #${rental.id}`
                }
            });
            
            setPaymentApplied(true);
            toast.success("ĞŸĞ»Ğ°Ñ‚ĞµĞ¶ ÑƒÑĞ¿ĞµÑˆĞ½Ğ¾ Ğ·Ğ°Ğ½ĞµÑĞµĞ½.");
            
            // Ğ˜Ğ½Ğ²Ğ°Ğ»Ğ¸Ğ´Ğ¸Ñ€ÑƒĞµĞ¼ Ğ·Ğ°Ğ¿Ñ€Ğ¾ÑÑ‹ Ğ´Ğ»Ñ Ğ¾Ğ±Ğ½Ğ¾Ğ²Ğ»ĞµĞ½Ğ¸Ñ Ğ´Ğ°Ğ½Ğ½Ñ‹Ñ…
            await queryClient.invalidateQueries({ queryKey: ["adminUsers"] });
            await queryClient.invalidateQueries({ queryKey: ["adminRentals"] });
        } catch (error) {
            console.error("ĞÑˆĞ¸Ğ±ĞºĞ° Ğ¿Ñ€Ğ¸ Ğ²Ğ½ĞµÑĞµĞ½Ğ¸Ğ¸ Ğ¿Ğ»Ğ°Ñ‚ĞµĞ¶Ğ°:", error);
        }
    };

    // Ğ›Ğ¾Ğ³Ğ¸ĞºĞ° Ğ¾Ñ‚Ğ¼ĞµĞ½Ñ‹ Ğ¿Ğ»Ğ°Ñ‚ĞµĞ¶Ğ°
    const handleCancelPayment = () => {
        setPaymentAmount("");
        setPaymentDescription("");
        setPaymentApplied(false);
        toast.info("Ğ’Ğ²Ğ¾Ğ´ Ğ¿Ğ»Ğ°Ñ‚ĞµĞ¶Ğ° Ğ¾Ñ‚Ğ¼ĞµĞ½ĞµĞ½.");
    };

    // ĞĞ²Ñ‚Ğ¾Ğ·Ğ°Ğ¿Ğ¾Ğ»Ğ½ĞµĞ½Ğ¸Ğµ ÑÑƒĞ¼Ğ¼Ñ‹ Ğ¿Ğ»Ğ°Ñ‚ĞµĞ¶Ğ° Ñ ÑƒÑ‡ĞµÑ‚Ğ¾Ğ¼ ÑˆÑ‚Ñ€Ğ°Ñ„Ğ° Ğ·Ğ° Ğ¿Ñ€Ğ¾ÑÑ€Ğ¾Ñ‡ĞºÑƒ
    const handleAutoFillPayment = () => {
        if (rental) {
            const remaining = rental.remaining_amount || 0;
            const surcharge = rental.overdue_surcharge || 0;
            const totalAmount = remaining + surcharge;
            setPaymentAmount(totalAmount.toString());
        }
    };

    useEffect(() => {
        if (rental) {
            setCheckedAccessories(new Set());
            setPaymentAmount("");
            setPaymentDescription("");
            setPaymentApplied(false);
            reset({
                actual_return_date: formatDate(new Date()),
                notes_on_return: "",
            });
        }
    }, [rental, reset]);

    const onSubmit = (data: ReturnFormData) => {
        if (!rental) return;
        returnMutation.mutate(
            {
                rentalId: rental.id,
                data: {
                    ...data,
                    accessories_returned_confirmation: allAccessoriesChecked,
                }
            },
            {
                onSuccess: () => {
                    reset();
                    onClose();
                },
            }
        );
    };

    return {
        // Ğ¡Ğ¾ÑÑ‚Ğ¾ÑĞ½Ğ¸Ñ
        paymentAmount,
        setPaymentAmount,
        paymentDescription,
        setPaymentDescription,
        paymentApplied,
        checkedAccessories,
        dynamicRemainingAmount,
        
        // Ğ¤ÑƒĞ½ĞºÑ†Ğ¸Ğ¸-Ğ¾Ğ±Ñ€Ğ°Ğ±Ğ¾Ñ‚Ñ‡Ğ¸ĞºĞ¸
        handleApplyPayment,
        handleCancelPayment,
        handleToggleAccessory,
        handleAutoFillPayment,
        onSubmit,
        
        // Ğ¡Ğ¾ÑÑ‚Ğ¾ÑĞ½Ğ¸Ñ Ğ¼ÑƒÑ‚Ğ°Ñ†Ğ¸Ğ¹
        isSubmittingReturn: returnMutation.isPending,
        isApplyingPayment: paymentMutation.isPending,
        
        // Ğ”Ğ°Ğ½Ğ½Ñ‹Ğµ Ñ„Ğ¾Ñ€Ğ¼Ñ‹ Ğ¾Ñ‚ react-hook-form
        register,
        handleSubmit,
        formState: { errors, isValid },
        
        // Ğ”Ñ€ÑƒĞ³Ğ¸Ğµ Ğ²Ñ‹Ñ‡Ğ¸ÑĞ»ÑĞµĞ¼Ñ‹Ğµ Ğ·Ğ½Ğ°Ñ‡ĞµĞ½Ğ¸Ñ
        accessoriesByEquipment,
        allAccessoriesChecked,
        totalAccessoriesCount,
    };
}


```


## <a name="srchooksadminuseUserTableLogicts"></a>`src/hooks/admin/useUserTableLogic.ts`

```typescript
// path: src/hooks/admin/useUserTableLogic.ts

// src/hooks/admin/useUserTableLogic.ts

import { useState, useMemo } from "react";
import { useCurrentUser } from "@/hooks/useProfile";
import {
    useUpdateUserRole,
    useBlockUser,
    useUnblockUser,
    useDeleteUser
} from "@/hooks/useAdminUsers";
import type { UserOut, UserRole } from "@/types/user";

export function useUserTableLogic(users: UserOut[]) {
    const { data: currentUser } = useCurrentUser();

    const [searchQuery, setSearchQuery] = useState("");
    const [confirmDelete, setConfirmDelete] = useState<number | null>(null);

    const updateRoleMutation = useUpdateUserRole();
    const blockUserMutation = useBlockUser();
    const unblockUserMutation = useUnblockUser();
    const deleteUserMutation = useDeleteUser();

    const isAdmin = currentUser?.role === "admin";

    const filteredUsers = useMemo(() => {
        return users.filter(user =>
            user.full_name.toLowerCase().includes(searchQuery.toLowerCase()) ||
            user.email.toLowerCase().includes(searchQuery.toLowerCase()) ||
            user.role.toLowerCase().includes(searchQuery.toLowerCase())
        );
    }, [users, searchQuery]);

    const handleRoleChange = (userId: number, newRole: string) => {
        if (!isAdmin) return;
        // Ğ˜Ğ—ĞœĞ•ĞĞ•ĞĞ˜Ğ•: ĞŸÑ€Ğ¸Ğ²Ğ¾Ğ´Ğ¸Ğ¼ string Ğº Ñ‚Ğ¸Ğ¿Ñƒ UserRole Ğ¿ĞµÑ€ĞµĞ´ Ğ²Ñ‹Ğ·Ğ¾Ğ²Ğ¾Ğ¼ Ğ¼ÑƒÑ‚Ğ°Ñ†Ğ¸Ğ¸
        updateRoleMutation.mutate({ userId, newRole: newRole as UserRole });
    };

    const handleToggleBlock = (user: UserOut) => {
        if (!isAdmin) return;
        if (user.is_active) {
            blockUserMutation.mutate(user.id);
        } else {
            unblockUserMutation.mutate(user.id);
        }
    };

    const handleDelete = (userId: number) => {
        if (!isAdmin) return;
        if (confirmDelete === userId) {
            deleteUserMutation.mutate(userId);
            setConfirmDelete(null);
        } else {
            setConfirmDelete(userId);
            setTimeout(() => setConfirmDelete(null), 5000);
        }
    };

    return {
        currentUser,
        filteredUsers,
        isAdmin,
        searchQuery,
        setSearchQuery,
        confirmDelete,
        mutations: {
            updateRole: updateRoleMutation,
            blockUser: blockUserMutation,
            unblockUser: unblockUserMutation,
            deleteUser: deleteUserMutation,
        },
        handlers: {
            handleRoleChange,
            handleToggleBlock,
            handleDelete,
        },
    };
}

```


## <a name="srchooksdatauseEquipmentDatats"></a>`src/hooks/data/useEquipmentData.ts`

```typescript
// path: src/hooks/data/useEquipmentData.ts

// src/hooks/data/useEquipmentData.ts

import { useMemo } from "react";
import { useEquipment } from "@/hooks/useEquipment";
import { useAvailabilityCheck } from "@/hooks/useAvailabilityCheck";
import { useDailyAvailability } from "@/hooks/useDailyAvailability";
import { useReserveStore } from "@/store/reserveStore";
import type { Equipment } from "@/types/equipment";
import type { AvailabilityInfo, DailyAvailabilityData } from "@/types/availability";

export interface EquipmentFilters {
    query?: string;
    type?: string;
    brand?: string;
    associationId?: number;
    availableOnly?: boolean;
    startDate?: Date;
    endDate?: Date;
}

export interface UseEquipmentDataReturn {
    equipment: Equipment[];
    totalEquipmentCount: number;
    availabilityData: AvailabilityInfo[];
    dailyAvailabilityData: DailyAvailabilityData | undefined;
    isLoading: boolean;
    isFetchingNextPage: boolean;
    hasNextPage: boolean;
    fetchNextPage: () => void;
}

export const useEquipmentData = (filters: EquipmentFilters): UseEquipmentDataReturn => {
    const { addToReservationMode } = useReserveStore();

    // Ğ—Ğ°Ğ³Ñ€ÑƒĞ¶Ğ°ĞµĞ¼ Ğ¿Ğ°Ğ³Ğ¸Ğ½Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ½Ñ‹Ğ¹ ÑĞ¿Ğ¸ÑĞ¾Ğº Ğ¾Ğ±Ğ¾Ñ€ÑƒĞ´Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ
    const {
        data: equipmentPages,
        fetchNextPage,
        hasNextPage,
        isLoading,
        isFetchingNextPage
    } = useEquipment(filters);

    // Ğ˜Ğ·Ğ²Ğ»ĞµĞºĞ°ĞµĞ¼ Ğ¿Ğ»Ğ¾ÑĞºĞ¸Ğ¹ Ğ¼Ğ°ÑÑĞ¸Ğ² Ğ¾Ğ±Ğ¾Ñ€ÑƒĞ´Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ
    const equipment = useMemo(() =>
        equipmentPages?.pages.flatMap(page => page.items) ?? [],
        [equipmentPages]
    );

    const totalEquipmentCount = equipmentPages?.pages[0]?.total ?? 0;

    // Ğ—Ğ°Ğ³Ñ€ÑƒĞ¶Ğ°ĞµĞ¼ Ğ´Ğ°Ğ½Ğ½Ñ‹Ğµ Ğ¾ Ğ´Ğ¾ÑÑ‚ÑƒĞ¿Ğ½Ğ¾ÑÑ‚Ğ¸ Ğ´Ğ»Ñ Ğ²ÑĞµĞ³Ğ¾ Ğ¾Ğ±Ğ¾Ñ€ÑƒĞ´Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ
    const { availabilityMap } = useAvailabilityCheck({
        equipmentIds: equipment.map(e => e.id),
        startDate: filters.startDate || new Date(),
        endDate: filters.endDate || new Date(),
        excludeReservationId: addToReservationMode || undefined,
        enabled: !!(filters.startDate && filters.endDate && equipment.length > 0)
    });

    // ĞŸÑ€ĞµĞ¾Ğ±Ñ€Ğ°Ğ·ÑƒĞµĞ¼ availabilityMap Ğ¾Ğ±Ñ€Ğ°Ñ‚Ğ½Ğ¾ Ğ² Ğ¼Ğ°ÑÑĞ¸Ğ² Ğ´Ğ»Ñ ÑĞ¾Ğ²Ğ¼ĞµÑÑ‚Ğ¸Ğ¼Ğ¾ÑÑ‚Ğ¸
    const availabilityData = useMemo(() => 
        Object.values(availabilityMap), 
        [availabilityMap]
    );

    // Ğ—Ğ°Ğ³Ñ€ÑƒĞ¶Ğ°ĞµĞ¼ Ğ´Ğ°Ğ½Ğ½Ñ‹Ğµ Ğ¾ ĞµĞ¶ĞµĞ´Ğ½ĞµĞ²Ğ½Ğ¾Ğ¹ Ğ´Ğ¾ÑÑ‚ÑƒĞ¿Ğ½Ğ¾ÑÑ‚Ğ¸ Ğ´Ğ»Ñ Ğ²Ğ¸Ğ´Ğ¸Ğ¼Ñ‹Ñ… ÑĞ»ĞµĞ¼ĞµĞ½Ñ‚Ğ¾Ğ²
    const thirtyDaysFromNow = useMemo(() => new Date(Date.now() + 30 * 24 * 60 * 60 * 1000), []);
    const { data: dailyAvailabilityData } = useDailyAvailability({
        ids: equipment.map(item => item.id),
        start: new Date(),
        end: thirtyDaysFromNow,
    });

    return {
        equipment,
        totalEquipmentCount,
        availabilityData,
        dailyAvailabilityData,
        isLoading,
        isFetchingNextPage,
        hasNextPage,
        fetchNextPage
    };
};



```


## <a name="srchooksfeaturesuseAppFiltersts"></a>`src/hooks/features/useAppFilters.ts`

```typescript
// path: src/hooks/features/useAppFilters.ts

// src/hooks/features/useAppFilters.ts

import { useSearchStore } from "@/store/searchStore";
import { useFilterStore } from "@/store/filterStore";
import { useDateStore } from "@/store/dateStore";

/**
 * Ğ¥ÑƒĞº Ğ´Ğ»Ñ Ğ¸Ğ½ĞºĞ°Ğ¿ÑÑƒĞ»ÑÑ†Ğ¸Ğ¸ Ğ»Ğ¾Ğ³Ğ¸ĞºĞ¸ Ğ¿Ğ¾Ğ»ÑƒÑ‡ĞµĞ½Ğ¸Ñ Ğ²ÑĞµÑ… Ñ„Ğ¸Ğ»ÑŒÑ‚Ñ€Ğ¾Ğ² Ğ¿Ñ€Ğ¸Ğ»Ğ¾Ğ¶ĞµĞ½Ğ¸Ñ
 * ĞĞ±ÑŠĞµĞ´Ğ¸Ğ½ÑĞµÑ‚ ÑĞ¾ÑÑ‚Ğ¾ÑĞ½Ğ¸Ğµ Ğ¸Ğ· Ñ‚Ñ€ĞµÑ… ÑÑ‚Ğ¾Ñ€Ğ¾Ğ²: Ğ¿Ğ¾Ğ¸ÑĞºĞ°, Ñ„Ğ¸Ğ»ÑŒÑ‚Ñ€Ğ¾Ğ² Ğ¸ Ğ´Ğ°Ñ‚
 */
export const useAppFilters = () => {
    const search = useSearchStore();
    const filters = useFilterStore();
    const dates = useDateStore();

    return {
        // ĞŸĞ¾Ğ¸ÑĞº
        query: search.query,
        
        // Ğ¤Ğ¸Ğ»ÑŒÑ‚Ñ€Ñ‹
        type: filters.type,
        brand: filters.brand,
        availableOnly: filters.availableOnly,
        associationId: filters.associationId,
        reset: filters.reset,
        
        // Ğ”Ğ°Ñ‚Ñ‹
        startDate: dates.startDate,
        endDate: dates.endDate,
    };
};



```


## <a name="srchooksfeaturesuseEquipmentCardViewModelts"></a>`src/hooks/features/useEquipmentCardViewModel.ts`

```typescript
// path: src/hooks/features/useEquipmentCardViewModel.ts

// src/hooks/features/useEquipmentCardViewModel.ts

import { useMemo, useCallback } from "react";
import { useReserveStore } from "@/store/reserveStore";
import { useDateStore } from "@/store/dateStore";
import { useSandboxCalculatorStore } from "@/store/sandboxCalculatorStore";
import { usePromoCodeStore } from "@/store/promoCodeStore";
import type { Equipment } from "@/types/equipment";
import type { EquipmentStatus } from "@/types/availability";

interface UseEquipmentCardViewModelProps {
    equipment: Equipment;
    status?: EquipmentStatus | "my_reservation" | "added";
}

/**
 * Ğ¥ÑƒĞº Ğ´Ğ»Ñ ÑƒĞ¿Ñ€Ğ°Ğ²Ğ»ĞµĞ½Ğ¸Ñ Ğ»Ğ¾Ğ³Ğ¸ĞºĞ¾Ğ¹ ĞºĞ°Ñ€Ñ‚Ğ¾Ñ‡ĞºĞ¸ Ğ¾Ğ±Ğ¾Ñ€ÑƒĞ´Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ.
 * Ğ¡Ğ¾Ğ´ĞµÑ€Ğ¶Ğ¸Ñ‚ Ğ²ÑĞµ Ñ…ÑƒĞºĞ¸, Ñ€Ğ°ÑÑ‡ĞµÑ‚Ñ‹ Ğ¸ Ğ¾Ğ±Ñ€Ğ°Ğ±Ğ¾Ñ‚Ñ‡Ğ¸ĞºĞ¸ ÑĞ¾Ğ±Ñ‹Ñ‚Ğ¸Ğ¹ Ğ´Ğ»Ñ EquipmentCard.
 */
export const useEquipmentCardViewModel = ({ equipment, status: _status = "available" }: UseEquipmentCardViewModelProps) => {
    // ĞŸĞ¾Ğ»ÑƒÑ‡ĞµĞ½Ğ¸Ğµ Ğ´Ğ°Ğ½Ğ½Ñ‹Ñ… Ğ¸Ğ· Ğ²ÑĞµÑ… ÑÑ‚Ğ¾Ñ€Ğ¾Ğ²
    const { toggle, isSelected, toggleAccessory, isAccessorySelected, selectedAccessories } = useReserveStore();
    const { dayCount } = useDateStore();
    const { isCalculatorVisible, durationDiscountPercentage } = useSandboxCalculatorStore();
    const { promoCodePercentage } = usePromoCodeStore();

    // ĞŸÑ€Ğ¾Ğ²ĞµÑ€ĞºĞ° Ğ²Ñ‹Ğ±Ñ€Ğ°Ğ½Ğ½Ğ¾ÑÑ‚Ğ¸ Ğ¾Ğ±Ğ¾Ñ€ÑƒĞ´Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ
    const isSelectedByUser = isSelected(equipment.id);

    // Ğ Ğ°ÑÑ‡ĞµÑ‚ ÑÑƒÑ‚Ğ¾Ñ‡Ğ½Ğ¾Ğ¹ ÑÑ‚Ğ¾Ğ¸Ğ¼Ğ¾ÑÑ‚Ğ¸ Ğ°ĞºÑĞµÑÑÑƒĞ°Ñ€Ğ¾Ğ²
    const accessoriesDailyRate = useMemo(() => {
        const selectedForThisCard = selectedAccessories[equipment.id] || [];
        return equipment.accessories?.reduce((total, acc) => 
            selectedForThisCard.includes(acc.id) ? total + acc.price : total, 0) ?? 0;
    }, [equipment.accessories, equipment.id, selectedAccessories]);

    // Ğ Ğ°ÑÑ‡ĞµÑ‚ Ğ¾Ğ±Ñ‰ĞµĞ¹ ÑĞºĞ¸Ğ´ĞºĞ¸
    const totalDiscountPercentage = useMemo(() => 
        durationDiscountPercentage + promoCodePercentage, 
        [durationDiscountPercentage, promoCodePercentage]
    );

    // Ğ”Ğ°Ğ½Ğ½Ñ‹Ğµ Ğ´Ğ»Ñ Ğ¾Ñ‚Ğ¾Ğ±Ñ€Ğ°Ğ¶ĞµĞ½Ğ¸Ñ ÑĞºĞ¸Ğ´ĞºĞ¸
    const discountData = useMemo(() => {
        const totalDailyRate = equipment.daily_rate + accessoriesDailyRate;
        const priceBefore = totalDailyRate * dayCount;
        return {
            days: dayCount,
            percentage: totalDiscountPercentage,
            priceBefore,
            priceAfter: priceBefore * (1 - totalDiscountPercentage / 100),
        };
    }, [equipment.daily_rate, accessoriesDailyRate, dayCount, totalDiscountPercentage]);

    // ĞĞ±Ñ€Ğ°Ğ±Ğ¾Ñ‚Ñ‡Ğ¸Ğº Ğ¿ĞµÑ€ĞµĞºĞ»ÑÑ‡ĞµĞ½Ğ¸Ñ Ğ°ĞºÑĞµÑÑÑƒĞ°Ñ€Ğ°
    const handleToggleAccessory = useCallback((accessoryId: number) => {
        if (!isSelectedByUser) toggle(equipment);
        toggleAccessory(equipment.id, accessoryId);
    }, [isSelectedByUser, toggle, equipment, toggleAccessory]);

    // ĞĞ±Ñ€Ğ°Ğ±Ğ¾Ñ‚Ñ‡Ğ¸Ğº Ğ¿ĞµÑ€ĞµĞºĞ»ÑÑ‡ĞµĞ½Ğ¸Ñ Ğ²Ñ‹Ğ±Ğ¾Ñ€Ğ° Ğ¾Ğ±Ğ¾Ñ€ÑƒĞ´Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ
    const handleToggleSelection = useCallback(() => {
        toggle(equipment);
    }, [toggle, equipment]);

    return {
        // Ğ¡Ğ¾ÑÑ‚Ğ¾ÑĞ½Ğ¸Ğµ
        isSelectedByUser,
        isCalculatorVisible,
        
        // Ğ Ğ°ÑÑ‡ĞµÑ‚Ñ‹
        accessoriesDailyRate,
        totalDiscountPercentage,
        discountData,
        
        // Ğ¤ÑƒĞ½ĞºÑ†Ğ¸Ğ¸
        handleToggleAccessory,
        handleToggleSelection,
        isAccessorySelected,
    };
};


```


## <a name="srchooksreservationsubmissionuseReservationFormDatats"></a>`src/hooks/reservation/submission/useReservationFormData.ts`

```typescript
// path: src/hooks/reservation/submission/useReservationFormData.ts

// src/hooks/reservation/submission/useReservationFormData.ts

import { useReserveStore } from "@/store/reserveStore";
import { useDateStore } from "@/store/dateStore";
import { usePromoCodeStore } from "@/store/promoCodeStore";
import { useCurrentUser } from "@/hooks/useProfile";

/**
 * Ğ¥ÑƒĞº-Ğ°Ğ³Ñ€ĞµĞ³Ğ°Ñ‚Ğ¾Ñ€ Ğ´Ğ»Ñ ÑĞ±Ğ¾Ñ€Ğ° Ğ´Ğ°Ğ½Ğ½Ñ‹Ñ… Ğ¸Ğ· Ñ€Ğ°Ğ·Ğ»Ğ¸Ñ‡Ğ½Ñ‹Ñ… Ñ…Ñ€Ğ°Ğ½Ğ¸Ğ»Ğ¸Ñ‰ (Zustand).
 * Ğ¡Ğ¾Ğ±Ğ¸Ñ€Ğ°ĞµÑ‚ Ğ¸ Ğ²Ğ¾Ğ·Ğ²Ñ€Ğ°Ñ‰Ğ°ĞµÑ‚ ĞµĞ´Ğ¸Ğ½Ñ‹Ğ¹ Ğ¾Ğ±ÑŠĞµĞºÑ‚ ÑĞ¾ Ğ²ÑĞµĞ¼Ğ¸ Ğ½ĞµĞ¾Ğ±Ñ…Ğ¾Ğ´Ğ¸Ğ¼Ñ‹Ğ¼Ğ¸ Ğ´Ğ°Ğ½Ğ½Ñ‹Ğ¼Ğ¸ Ğ´Ğ»Ñ ÑÑ‚Ñ€Ğ°Ğ½Ğ¸Ñ†Ñ‹ Ğ¾Ñ„Ğ¾Ñ€Ğ¼Ğ»ĞµĞ½Ğ¸Ñ.
 */
export const useReservationFormData = () => {
    // ĞŸĞ¾Ğ»ÑƒÑ‡ĞµĞ½Ğ¸Ğµ Ğ´Ğ°Ğ½Ğ½Ñ‹Ñ… Ğ¸Ğ· Ğ²ÑĞµÑ… ÑÑ‚Ğ¾Ñ€Ğ¾Ğ²
    const { data: user } = useCurrentUser();
    const { startDate, endDate, setStartDate, setEndDate, dayCount } = useDateStore();
    const { 
        items, 
        selectedAccessories, 
        remove: removeItemFromStore, 
        clear: clearReserveStore, 
        isAccessorySelected, 
        toggleAccessory 
    } = useReserveStore();
    const { 
        promoCode: promoCodeInput, 
        setPromoCode: setPromoCodeInput, 
        removePromoCode 
    } = usePromoCodeStore();

    return {
        // Ğ”Ğ°Ğ½Ğ½Ñ‹Ğµ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ñ
        user,
        
        // Ğ”Ğ°Ğ½Ğ½Ñ‹Ğµ Ğ´Ğ°Ñ‚
        startDate,
        endDate,
        dayCount,
        
        // Ğ”Ğ°Ğ½Ğ½Ñ‹Ğµ Ñ€ĞµĞ·ĞµÑ€Ğ²Ğ°
        items,
        selectedAccessories,
        
        // ĞŸÑ€Ğ¾Ğ¼Ğ¾ĞºĞ¾Ğ´
        promoCodeInput,
        
        // Ğ¤ÑƒĞ½ĞºÑ†Ğ¸Ğ¸ ÑƒĞ¿Ñ€Ğ°Ğ²Ğ»ĞµĞ½Ğ¸Ñ Ğ´Ğ°Ñ‚Ğ°Ğ¼Ğ¸
        setStartDate,
        setEndDate,
        
        // Ğ¤ÑƒĞ½ĞºÑ†Ğ¸Ğ¸ ÑƒĞ¿Ñ€Ğ°Ğ²Ğ»ĞµĞ½Ğ¸Ñ Ñ€ĞµĞ·ĞµÑ€Ğ²Ğ¾Ğ¼
        removeItemFromStore,
        clearReserveStore,
        isAccessorySelected,
        toggleAccessory,
        
        // Ğ¤ÑƒĞ½ĞºÑ†Ğ¸Ğ¸ ÑƒĞ¿Ñ€Ğ°Ğ²Ğ»ĞµĞ½Ğ¸Ñ Ğ¿Ñ€Ğ¾Ğ¼Ğ¾ĞºĞ¾Ğ´Ğ¾Ğ¼
        setPromoCodeInput,
        removePromoCode,
    };
};


```


## <a name="srchooksreservationsubmissionuseReserveSubmissionts"></a>`src/hooks/reservation/submission/useReserveSubmission.ts`

```typescript
// path: src/hooks/reservation/submission/useReserveSubmission.ts

// src/hooks/reservation/submission/useReserveSubmission.ts

import { useMemo, useState } from "react";
import { toast } from "sonner";
import { useReservations } from "@/hooks/useReservations";
import { useAvailabilityCheck } from "@/hooks/useAvailabilityCheck";
import { reservationCreateSchema, type ReservationCreateInput } from "@/lib/validationSchemas";
import { usePriceCalculator } from "../usePriceCalculator";
import { formatDate } from "@/lib/utils";
import { useReservationFormData } from "./useReservationFormData";

/**
 * Ğ¥ÑƒĞº-ĞºĞ¾Ğ¾Ñ€Ğ´Ğ¸Ğ½Ğ°Ñ‚Ğ¾Ñ€ Ğ´Ğ»Ñ ÑÑ‚Ñ€Ğ°Ğ½Ğ¸Ñ†Ñ‹ Ğ¾Ñ„Ğ¾Ñ€Ğ¼Ğ»ĞµĞ½Ğ¸Ñ Ñ€ĞµĞ·ĞµÑ€Ğ²Ğ°.
 * Ğ˜ÑĞ¿Ğ¾Ğ»ÑŒĞ·ÑƒĞµÑ‚ Ñ…ÑƒĞº-Ğ°Ğ³Ñ€ĞµĞ³Ğ°Ñ‚Ğ¾Ñ€ Ğ´Ğ»Ñ Ğ¿Ğ¾Ğ»ÑƒÑ‡ĞµĞ½Ğ¸Ñ Ğ´Ğ°Ğ½Ğ½Ñ‹Ñ… Ğ¸ ÑĞ¾Ğ´ĞµÑ€Ğ¶Ğ¸Ñ‚ Ğ»Ğ¾Ğ³Ğ¸ĞºÑƒ Ğ¾Ğ±Ñ€Ğ°Ğ±Ğ¾Ñ‚ĞºĞ¸ Ğ¸ Ğ¾Ñ‚Ğ¿Ñ€Ğ°Ğ²ĞºĞ¸ Ñ„Ğ¾Ñ€Ğ¼Ñ‹.
 */
export function useReserveSubmission() {
    // ĞŸĞ¾Ğ»ÑƒÑ‡ĞµĞ½Ğ¸Ğµ Ğ²ÑĞµÑ… Ğ´Ğ°Ğ½Ğ½Ñ‹Ñ… Ñ‡ĞµÑ€ĞµĞ· Ñ…ÑƒĞº-Ğ°Ğ³Ñ€ĞµĞ³Ğ°Ñ‚Ğ¾Ñ€
    const {
        user,
        startDate,
        endDate,
        dayCount,
        items,
        selectedAccessories,
        promoCodeInput,
        setStartDate,
        setEndDate,
        removeItemFromStore,
        clearReserveStore,
        isAccessorySelected,
        toggleAccessory,
        setPromoCodeInput,
        removePromoCode,
    } = useReservationFormData();

    // Ğ›Ğ¾ĞºĞ°Ğ»ÑŒĞ½Ğ¾Ğµ ÑĞ¾ÑÑ‚Ğ¾ÑĞ½Ğ¸Ğµ Ğ´Ğ»Ñ Ğ¿Ñ€Ğ¾Ğ¼Ğ¾ĞºĞ¾Ğ´Ğ°, ĞºĞ¾Ñ‚Ğ¾Ñ€Ñ‹Ğ¹ Ğ±Ñ‹Ğ» Ğ¿Ñ€Ğ¸Ğ¼ĞµĞ½ĞµĞ½ Ğº Ñ€Ğ°ÑÑ‡ĞµÑ‚Ñƒ
    const [appliedPromoCode, setAppliedPromoCode] = useState(promoCodeInput);

    // --- Ğ ĞĞ¡Ğ§Ğ•Ğ¢Ğ« Ğ˜ ĞŸĞ ĞĞ’Ğ•Ğ ĞšĞ˜ ---
    const equipmentIds = useMemo(() => items.map(i => i.id), [items]);

    // ĞŸÑ€Ğ¾Ğ²ĞµÑ€ĞºĞ° Ğ´Ğ¾ÑÑ‚ÑƒĞ¿Ğ½Ğ¾ÑÑ‚Ğ¸ Ğ¾Ğ±Ğ¾Ñ€ÑƒĞ´Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ Ğ½Ğ° Ğ²Ñ‹Ğ±Ñ€Ğ°Ğ½Ğ½Ñ‹Ğµ Ğ´Ğ°Ñ‚Ñ‹
    const { availabilityMap, conflictingItemIds, isLoading: isCheckingAvailability } = useAvailabilityCheck({
        equipmentIds, startDate, endDate
    });

    // Ğ Ğ°ÑÑ‡ĞµÑ‚ Ğ¸Ñ‚Ğ¾Ğ³Ğ¾Ğ²Ğ¾Ğ¹ ÑÑ‚Ğ¾Ğ¸Ğ¼Ğ¾ÑÑ‚Ğ¸ Ñ Ğ¿Ğ¾Ğ¼Ğ¾Ñ‰ÑŒÑ Ñ€Ğ°ÑÑˆĞ¸Ñ€ĞµĞ½Ğ½Ğ¾Ğ³Ğ¾ usePriceCalculator
    const priceCalculator = usePriceCalculator({
        equipmentIds, startDate, endDate, selectedAccessories, promoCode: appliedPromoCode
    });

    // Ğ Ğ°ÑÑ‡ĞµÑ‚ ÑÑƒÑ‚Ğ¾Ñ‡Ğ½Ğ¾Ğ¹ ÑÑ‚Ğ¾Ğ¸Ğ¼Ğ¾ÑÑ‚Ğ¸ Ğ°ĞºÑĞµÑÑÑƒĞ°Ñ€Ğ¾Ğ² (Ğ´Ğ»Ñ Ğ¸Ğ½Ñ„Ğ¾Ñ€Ğ¼Ğ°Ñ†Ğ¸Ğ¸)
    const accessoriesDailyTotal = useMemo(() => {
        return items.reduce((total, item) => {
            const selectedForThisItem = selectedAccessories[item.id] || [];
            return total + (item.accessories?.reduce((accTotal, accessory) =>
                selectedForThisItem.includes(accessory.id) ? accTotal + accessory.price : accTotal, 0) ?? 0);
        }, 0);
    }, [items, selectedAccessories]);

    // --- Ğ›ĞĞ“Ğ˜ĞšĞ ĞĞ¢ĞŸĞ ĞĞ’ĞšĞ˜ Ğ¤ĞĞ ĞœĞ« ---
    const { createReservation } = useReservations();
    const { isPending: isSubmitting, isSuccess: reservationSuccess, mutateAsync, error } = createReservation;

    // Ğ˜Ğ·Ğ²Ğ»ĞµĞºĞ°ĞµĞ¼ ID Ğ½ĞµĞ´Ğ¾ÑÑ‚ÑƒĞ¿Ğ½Ñ‹Ñ… Ñ‚Ğ¾Ğ²Ğ°Ñ€Ğ¾Ğ² Ğ¸Ğ· Ğ¾ÑˆĞ¸Ğ±ĞºĞ¸, ĞµÑĞ»Ğ¸ Ğ¾Ğ½Ğ° ĞµÑÑ‚ÑŒ
    const unavailableIdsFromAPI = useMemo(() => (error as { unavailable_ids?: number[] })?.unavailable_ids ?? [], [error]);

    const handleSubmit = async () => {
        if (!user) {
            toast.error("ĞĞµĞ¾Ğ±Ñ…Ğ¾Ğ´Ğ¸Ğ¼Ğ¾ Ğ°Ğ²Ñ‚Ğ¾Ñ€Ğ¸Ğ·Ğ¾Ğ²Ğ°Ñ‚ÑŒÑÑ Ğ´Ğ»Ñ ÑĞ¾Ğ·Ğ´Ğ°Ğ½Ğ¸Ñ Ñ€ĞµĞ·ĞµÑ€Ğ²Ğ°.");
            return;
        }
        if (conflictingItemIds.length > 0) {
            toast.error("ĞĞµĞºĞ¾Ñ‚Ğ¾Ñ€Ñ‹Ğµ Ğ²Ñ‹Ğ±Ñ€Ğ°Ğ½Ğ½Ñ‹Ğµ Ğ¿Ğ¾Ğ·Ğ¸Ñ†Ğ¸Ğ¸ Ğ½ĞµĞ´Ğ¾ÑÑ‚ÑƒĞ¿Ğ½Ñ‹. Ğ£Ğ´Ğ°Ğ»Ğ¸Ñ‚Ğµ Ğ¸Ñ… Ğ¸Ğ»Ğ¸ Ğ¸Ğ·Ğ¼ĞµĞ½Ğ¸Ñ‚Ğµ Ğ´Ğ°Ñ‚Ñ‹.");
            return;
        }

        const payload: ReservationCreateInput = {
            equipment_ids: items.map(i => i.id),
            start_date: formatDate(startDate),
            end_date: formatDate(endDate),
            selected_accessories: selectedAccessories,
            promo_code: appliedPromoCode || undefined,
        };

        const validationResult = reservationCreateSchema.safeParse(payload);
        if (!validationResult.success) {
            const errorMessages = validationResult.error.errors.map(e => e.message).join("\n");
            toast.error(`ĞÑˆĞ¸Ğ±ĞºĞ° Ğ²Ğ°Ğ»Ğ¸Ğ´Ğ°Ñ†Ğ¸Ğ¸ Ğ´Ğ°Ğ½Ğ½Ñ‹Ñ…:\n${errorMessages}`);
            return;
        }

        try {
            await mutateAsync(validationResult.data);
            toast.success("Ğ ĞµĞ·ĞµÑ€Ğ² ÑƒÑĞ¿ĞµÑˆĞ½Ğ¾ ÑĞ¾Ğ·Ğ´Ğ°Ğ½!");
            clearReserveStore();
            // ĞÑ‡Ğ¸Ñ‰Ğ°ĞµĞ¼ Ğ¿Ñ€Ğ¾Ğ¼Ğ¾ĞºĞ¾Ğ´ Ğ¿Ğ¾ÑĞ»Ğµ ÑƒÑĞ¿ĞµÑˆĞ½Ğ¾Ğ³Ğ¾ Ñ€ĞµĞ·ĞµÑ€Ğ²Ğ°
            removePromoCode();
        } catch (e: unknown) {
            // ĞÑˆĞ¸Ğ±ĞºĞ¸ (Ğ²ĞºĞ»ÑÑ‡Ğ°Ñ 409 Ñ ĞºĞ¾Ğ½Ñ„Ğ»Ğ¸ĞºÑ‚Ğ°Ğ¼Ğ¸) Ñ‚ĞµĞ¿ĞµÑ€ÑŒ Ğ¾Ğ±Ñ€Ğ°Ğ±Ğ°Ñ‚Ñ‹Ğ²Ğ°ÑÑ‚ÑÑ Ğ¸ Ğ¾Ñ‚Ğ¾Ğ±Ñ€Ğ°Ğ¶Ğ°ÑÑ‚ÑÑ
            // Ñ†ĞµĞ½Ñ‚Ñ€Ğ°Ğ»Ğ¸Ğ·Ğ¾Ğ²Ğ°Ğ½Ğ½Ğ¾ Ğ² Ñ…ÑƒĞºĞµ useReservations. Ğ—Ğ´ĞµÑÑŒ Ğ¼Ñ‹ Ğ¿Ñ€Ğ¾ÑÑ‚Ğ¾ Ğ»Ğ¾Ğ³Ğ¸Ñ€ÑƒĞµĞ¼ Ğ¸Ñ….
            console.error("Submission failed:", e);
        }
    };

    // Ğ¤ÑƒĞ½ĞºÑ†Ğ¸Ñ, ĞºĞ¾Ñ‚Ğ¾Ñ€Ğ°Ñ "Ñ„Ğ¸ĞºÑĞ¸Ñ€ÑƒĞµÑ‚" Ğ²Ğ²ĞµĞ´ĞµĞ½Ğ½Ñ‹Ğ¹ Ğ¿Ñ€Ğ¾Ğ¼Ğ¾ĞºĞ¾Ğ´ Ğ´Ğ»Ñ Ñ€Ğ°ÑÑ‡ĞµÑ‚Ğ°
    const applyPromoCode = () => {
        setAppliedPromoCode(promoCodeInput);
    };

    // --- Ğ’ĞĞ—Ğ’Ğ ĞĞ¢ Ğ”ĞĞĞĞ«Ğ¥ Ğ”Ğ›Ğ¯ UI ---
    // Ğ¡Ğ¾Ğ±Ğ¸Ñ€Ğ°ĞµĞ¼ Ğ²ÑĞµ Ğ½ĞµĞ¾Ğ±Ñ…Ğ¾Ğ´Ğ¸Ğ¼Ñ‹Ğµ Ğ´Ğ°Ğ½Ğ½Ñ‹Ğµ Ğ¸ Ñ„ÑƒĞ½ĞºÑ†Ğ¸Ğ¸ Ğ² Ğ¾Ğ´Ğ¸Ğ½ Ğ¾Ğ±ÑŠĞµĞºÑ‚ Ğ´Ğ»Ñ Ğ¿ĞµÑ€ĞµĞ´Ğ°Ñ‡Ğ¸ Ğ² ĞºĞ¾Ğ¼Ğ¿Ğ¾Ğ½ĞµĞ½Ñ‚
    return {
        // Ğ”Ğ°Ğ½Ğ½Ñ‹Ğµ Ğ¸ ÑĞ¾ÑÑ‚Ğ¾ÑĞ½Ğ¸Ğµ
        items,
        user,
        startDate,
        endDate,
        availabilityMap,
        unavailableIdsFromAPI,
        invalidItems: conflictingItemIds,
        isLoadingAvailability: isCheckingAvailability || priceCalculator.isCalculatingPrice,
        isSubmitting,
        isApplyingPromoCode: priceCalculator.isApplyingPromoCode,
        reservationSuccess,
        submitMessage: (error as Error)?.message,
        selectedAccessories,
        // Ğ¤Ğ¸Ğ½Ğ°Ğ½ÑĞ¾Ğ²Ñ‹Ğµ Ñ€Ğ°ÑÑ‡ĞµÑ‚Ñ‹ Ğ¸Ğ· Ñ†ĞµĞ½Ñ‚Ñ€Ğ°Ğ»Ğ¸Ğ·Ğ¾Ğ²Ğ°Ğ½Ğ½Ğ¾Ğ³Ğ¾ Ñ…ÑƒĞºĞ°
        priceDetails: priceCalculator.priceDetails,
        dayCount: priceCalculator.dayCount || dayCount,
        fullTotal: priceCalculator.fullTotal,
        totalDiscountPercentage: priceCalculator.totalDiscountPercentage,
        discountAmount: priceCalculator.discountAmount,
        finalTotal: priceCalculator.finalTotal,
        accessoriesDailyTotal,
        // ĞŸÑ€Ğ¾Ğ¼Ğ¾ĞºĞ¾Ğ´
        promoCode: promoCodeInput,
        promoCodeMessage: priceCalculator.promoCodeMessage,
        // Ğ¤ÑƒĞ½ĞºÑ†Ğ¸Ğ¸ Ğ¸ Ğ´ĞµĞ¹ÑÑ‚Ğ²Ğ¸Ñ
        setStartDate,
        setEndDate,
        clearReserveStore,
        removeItemFromStore,
        isAccessorySelected,
        toggleAccessory,
        setPromoCode: setPromoCodeInput,
        applyPromoCode,
        removePromoCode,
        handleSubmit,
    };
}


```


## <a name="srchooksreservationusePriceCalculatorts"></a>`src/hooks/reservation/usePriceCalculator.ts`

```typescript
// path: src/hooks/reservation/usePriceCalculator.ts

// src/hooks/reservation/usePriceCalculator.ts

import { useQuery } from "@tanstack/react-query";
import { ReservationService, type PriceDetails } from "@/core/services";
import { formatDate } from "@/lib/utils";

interface UsePriceCalculatorInput {
    equipmentIds: number[];
    startDate: Date;
    endDate: Date;
    selectedAccessories: Record<number, number[]>;
    promoCode?: string;
    enabled?: boolean;
}

export { type PriceDetails };

/**
 * Ğ•Ğ´Ğ¸Ğ½Ñ‹Ğ¹ Ñ…ÑƒĞº Ğ´Ğ»Ñ Ñ€Ğ°ÑÑ‡ĞµÑ‚Ğ° ÑÑ‚Ğ¾Ğ¸Ğ¼Ğ¾ÑÑ‚Ğ¸ Ñ€ĞµĞ·ĞµÑ€Ğ²Ğ°.
 * Ğ¯Ğ²Ğ»ÑĞµÑ‚ÑÑ ĞµĞ´Ğ¸Ğ½ÑÑ‚Ğ²ĞµĞ½Ğ½Ñ‹Ğ¼ Ğ¸ÑÑ‚Ğ¾Ñ‡Ğ½Ğ¸ĞºĞ¾Ğ¼ Ğ¿Ñ€Ğ°Ğ²Ğ´Ñ‹ Ğ´Ğ»Ñ Ğ²ÑĞµÑ… Ñ„Ğ¸Ğ½Ğ°Ğ½ÑĞ¾Ğ²Ñ‹Ñ… Ñ€Ğ°ÑÑ‡ĞµÑ‚Ğ¾Ğ² Ğ² Ğ¿Ñ€Ğ¸Ğ»Ğ¾Ğ¶ĞµĞ½Ğ¸Ğ¸.
 */
export const usePriceCalculator = ({
    equipmentIds, 
    startDate, 
    endDate, 
    selectedAccessories, 
    promoCode, 
    enabled = true
}: UsePriceCalculatorInput) => {

    const queryKey = [
        "priceCalculation",
        [...equipmentIds].sort(),
        formatDate(startDate),
        formatDate(endDate),
        JSON.stringify(selectedAccessories),
        promoCode || ""
    ];

    const query = useQuery<PriceDetails>({
        queryKey: queryKey,
        queryFn: async () => {
            return ReservationService.calculatePrice({
                equipment_ids: equipmentIds,
                start_date: formatDate(startDate),
                end_date: formatDate(endDate),
                selected_accessories: selectedAccessories,
                promo_code: promoCode
            });
        },
        enabled: enabled && equipmentIds.length > 0 && !!startDate && !!endDate && startDate < endDate,
        staleTime: 5000,
    });

    // Ğ’Ğ¾Ğ·Ğ²Ñ€Ğ°Ñ‰Ğ°ĞµĞ¼ Ñ€Ğ°ÑÑˆĞ¸Ñ€ĞµĞ½Ğ½Ñ‹Ğ¹ Ğ¾Ğ±ÑŠĞµĞºÑ‚ Ñ Ğ´Ğ¾Ğ¿Ğ¾Ğ»Ğ½Ğ¸Ñ‚ĞµĞ»ÑŒĞ½Ñ‹Ğ¼Ğ¸ Ğ²Ñ‹Ñ‡Ğ¸ÑĞ»ÑĞµĞ¼Ñ‹Ğ¼Ğ¸ Ğ¿Ğ¾Ğ»ÑĞ¼Ğ¸
    return {
        ...query,
        // ĞÑĞ½Ğ¾Ğ²Ğ½Ñ‹Ğµ Ğ´Ğ°Ğ½Ğ½Ñ‹Ğµ Ğ¸Ğ· API
        priceDetails: query.data,
        
        // Ğ’Ñ‹Ñ‡Ğ¸ÑĞ»ÑĞµĞ¼Ñ‹Ğµ Ğ¿Ğ¾Ğ»Ñ Ğ´Ğ»Ñ ÑƒĞ´Ğ¾Ğ±ÑÑ‚Ğ²Ğ° Ğ¸ÑĞ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ
        dayCount: query.data?.day_count ?? 0,
        fullTotal: query.data?.full_total ?? 0,
        finalTotal: query.data?.final_total ?? 0,
        discountAmount: query.data?.discount_amount ?? 0,
        durationDiscountPercentage: query.data?.duration_discount_percentage ?? 0,
        promoDiscountPercentage: query.data?.promo_discount_percentage ?? 0,
        totalDiscountPercentage: (query.data?.duration_discount_percentage ?? 0) + (query.data?.promo_discount_percentage ?? 0),
        promoCodeMessage: query.data?.promo_code_message ?? "",
        
        // Ğ¡Ğ¾ÑÑ‚Ğ¾ÑĞ½Ğ¸Ñ Ğ·Ğ°Ğ³Ñ€ÑƒĞ·ĞºĞ¸
        isCalculatingPrice: query.isLoading,
        isFetchingPrice: query.isFetching,
        isApplyingPromoCode: query.isFetching && !!promoCode,
    };
};

```


## <a name="srchooksreservationuseReservationActionsts"></a>`src/hooks/reservation/useReservationActions.ts`

```typescript
// path: src/hooks/reservation/useReservationActions.ts

// src/hooks/reservation/useReservationActions.ts

import { useState, useCallback, useMemo } from "react";
import { toast } from "sonner";
import { useReserveStore } from "@/store/reserveStore";
import { useEditReservation } from "../useEditReservation";
import { ReservationService } from "@/core/services";
import type { Reservation } from "@/types/reservation";
import { type EditState } from "./useReservationState";

export function useReservationActions({
                                          reservation,
                                          state,
                                          hasConflicts,
                                          appliedPromoCode,
                                          onFullCancellation,
                                          isAdminContext,
                                          onFinishEditing, // âœ¨ 1. ĞŸÑ€Ğ¸Ğ½Ğ¸Ğ¼Ğ°ĞµĞ¼ ĞºĞ¾Ğ»Ğ±ÑĞº
                                      }: {
    reservation: Reservation,
    state: EditState,
    hasConflicts: boolean,
    appliedPromoCode: string,
    onFullCancellation?: () => Promise<void> | void,
    isAdminContext: boolean,
    onFinishEditing: () => void; // âœ¨ 2. Ğ”Ğ¾Ğ±Ğ°Ğ²Ğ»ÑĞµĞ¼ ĞµĞ³Ğ¾ Ğ² Ñ‚Ğ¸Ğ¿
}) {
    const editApiMutation = useEditReservation();
    const { clear: clearReserveStore } = useReserveStore();

    const finalHasChanges = useMemo(() => {
        const promoCodeChanged = appliedPromoCode !== (reservation.promo_code || "");
        return state.hasChanges || promoCodeChanged;
    }, [state.hasChanges, appliedPromoCode, reservation.promo_code]);

    const saveChanges = useCallback(async (): Promise<boolean> => {
        if (!finalHasChanges) {
            toast.info("ĞĞµÑ‚ Ğ¸Ğ·Ğ¼ĞµĞ½ĞµĞ½Ğ¸Ğ¹ Ğ´Ğ»Ñ ÑĞ¾Ñ…Ñ€Ğ°Ğ½ĞµĞ½Ğ¸Ñ.");
            return false;
        }
        if (hasConflicts) {
            toast.error("ĞĞµĞ²Ğ¾Ğ·Ğ¼Ğ¾Ğ¶Ğ½Ğ¾ ÑĞ¾Ñ…Ñ€Ğ°Ğ½Ğ¸Ñ‚ÑŒ Ñ€ĞµĞ·ĞµÑ€Ğ² Ñ ĞºĞ¾Ğ½Ñ„Ğ»Ğ¸ĞºÑ‚Ğ°Ğ¼Ğ¸.");
            return false;
        }
        if (state.currentEquipmentDetails.length === 0) {
            toast.error("Ğ ĞµĞ·ĞµÑ€Ğ² Ğ´Ğ¾Ğ»Ğ¶ĞµĞ½ ÑĞ¾Ğ´ĞµÑ€Ğ¶Ğ°Ñ‚ÑŒ Ñ…Ğ¾Ñ‚Ñ Ğ±Ñ‹ Ğ¾Ğ´Ğ½Ñƒ Ğ¿Ğ¾Ğ·Ğ¸Ñ†Ğ¸Ñ.");
            return false;
        }

        try {
            await editApiMutation.mutateAsync({
                id: reservation.id,
                start_date: state.startDate.toISOString().split('T')[0],
                end_date: state.endDate.toISOString().split('T')[0],
                equipment_ids: state.currentEquipmentDetails.map(eq => eq.id),
                promo_code: appliedPromoCode || undefined,
                selected_accessories: state.localSelectedAccessories,
                isAdminContext,
            });
            toast.success("Ğ ĞµĞ·ĞµÑ€Ğ² ÑƒÑĞ¿ĞµÑˆĞ½Ğ¾ Ğ¾Ğ±Ğ½Ğ¾Ğ²Ğ»ĞµĞ½!");
            clearReserveStore();
            onFinishEditing(); // âœ¨ 3. Ğ’Ñ‹Ğ·Ñ‹Ğ²Ğ°ĞµĞ¼ ĞºĞ¾Ğ»Ğ±ÑĞº Ğ¿Ğ¾ÑĞ»Ğµ ÑƒÑĞ¿ĞµÑˆĞ½Ğ¾Ğ³Ğ¾ ÑĞ¾Ñ…Ñ€Ğ°Ğ½ĞµĞ½Ğ¸Ñ
            return true;
        } catch (error) {
            toast.error("ĞÑˆĞ¸Ğ±ĞºĞ° Ğ¿Ñ€Ğ¸ ÑĞ¾Ñ…Ñ€Ğ°Ğ½ĞµĞ½Ğ¸Ğ¸ Ğ¸Ğ·Ğ¼ĞµĞ½ĞµĞ½Ğ¸Ğ¹.");
            return false;
        }
    }, [
        reservation.id, state, finalHasChanges, hasConflicts,
        appliedPromoCode, editApiMutation, clearReserveStore, isAdminContext, onFinishEditing
    ]);

    const [isCancelling, setIsCancelling] = useState(false);

    const handleConfirmFullCancellation = useCallback(async () => {
        if (!onFullCancellation) return;
        setIsCancelling(true);
        try {
            await onFullCancellation();
        } catch (error) {
            toast.error("ĞĞµ ÑƒĞ´Ğ°Ğ»Ğ¾ÑÑŒ Ğ¾Ñ‚Ğ¼ĞµĞ½Ğ¸Ñ‚ÑŒ Ñ€ĞµĞ·ĞµÑ€Ğ².");
        } finally {
            setIsCancelling(false);
        }
    }, [onFullCancellation]);

    return {
        saveChanges,
        isSaving: editApiMutation.isPending,
        handleConfirmFullCancellation,
        isCancelling,
        finalHasChanges,
    };
}

```


## <a name="srchooksreservationuseReservationDatats"></a>`src/hooks/reservation/useReservationData.ts`

```typescript
// path: src/hooks/reservation/useReservationData.ts

// src/hooks/reservation/useReservationData.ts

import { useState, useMemo, useEffect } from "react";
import { usePriceCalculator } from "./usePriceCalculator";
import { useAvailabilityCheck } from "@/hooks/useAvailabilityCheck";
import type { EditState } from "./useReservationState";
import type { Reservation } from "@/types/reservation";

const emptyFinancials = {
    dayCount: 0,
    fullTotal: 0,
    finalTotal: 0,
    discountAmount: 0,
    durationDiscountAmount: 0,
    durationDiscountPercentage: 0,
    promoDiscountAmount: 0,
    promoCodePercentage: 0,
    promoCodeMessage: "",
};

export function useReservationData(reservation: Reservation, state: EditState) {
    const [promoCode, setPromoCode] = useState(reservation.promo_code || "");
    const [appliedPromoCode, setAppliedPromoCode] = useState(reservation.promo_code || "");

    const { availabilityMap, hasConflicts, isLoading: isCheckingAvailability } = useAvailabilityCheck({
        equipmentIds: state.currentEquipmentDetails.map(eq => eq.id),
        startDate: state.startDate,
        endDate: state.endDate,
        // âœ¨ Ğ“Ğ›ĞĞ’ĞĞĞ• Ğ˜Ğ¡ĞŸĞ ĞĞ’Ğ›Ğ•ĞĞ˜Ğ•: ĞœÑ‹ Ğ²ÑĞµĞ³Ğ´Ğ° Ğ² Ñ€ĞµĞ¶Ğ¸Ğ¼Ğµ Ñ€ĞµĞ´Ğ°ĞºÑ‚Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ,
        // Ğ¿Ğ¾ÑÑ‚Ğ¾Ğ¼Ñƒ Ğ²ÑĞµĞ³Ğ´Ğ° Ğ¿ĞµÑ€ĞµĞ´Ğ°ĞµĞ¼ ID Ğ´Ğ»Ñ Ğ¸ÑĞºĞ»ÑÑ‡ĞµĞ½Ğ¸Ñ.
        excludeReservationId: reservation.id,
    });

    const priceCalculator = usePriceCalculator({
        equipmentIds: state.currentEquipmentDetails.map(i => i.id),
        startDate: state.startDate,
        endDate: state.endDate,
        selectedAccessories: state.localSelectedAccessories,
        promoCode: appliedPromoCode,
        enabled: true // Ğ¥ÑƒĞº Ğ°ĞºÑ‚Ğ¸Ğ²ĞµĞ½ Ğ²ÑĞµĞ³Ğ´Ğ°, ĞºĞ¾Ğ³Ğ´Ğ° Ğ¸ÑĞ¿Ğ¾Ğ»ÑŒĞ·ÑƒĞµÑ‚ÑÑ
    });

    const financials = useMemo(() => {
        if (!priceCalculator.priceDetails) {
            return { ...emptyFinancials, promoCode: promoCode };
        }
        const priceDetails = priceCalculator.priceDetails;
        const durationDiscountAmount = priceDetails.full_total * (priceDetails.duration_discount_percentage / 100);
        const promoDiscountAmount = priceDetails.full_total * (priceDetails.promo_discount_percentage / 100);
        return {
            dayCount: priceDetails.day_count,
            fullTotal: priceDetails.full_total,
            finalTotal: priceDetails.final_total,
            discountAmount: priceDetails.discount_amount,
            durationDiscountAmount,
            durationDiscountPercentage: priceDetails.duration_discount_percentage,
            promoDiscountAmount,
            promoCodePercentage: priceDetails.promo_discount_percentage,
            promoCodeMessage: priceDetails.promo_code_message ?? "",
            promoCode: promoCode,
        };
    }, [priceCalculator.priceDetails, promoCode]);

    const applyPromoCode = () => setAppliedPromoCode(promoCode);
    const removePromoCode = () => {
        setPromoCode("");
        setAppliedPromoCode("");
    };

    return {
        availabilityMap,
        hasConflicts,
        isCheckingAvailability,
        isCalculatingPrice: priceCalculator.isCalculatingPrice,
        financials,
        promoCode,
        setPromoCode,
        applyPromoCode,
        removePromoCode,
        appliedPromoCode,
        priceDetails: priceCalculator.priceDetails,
    };
}

```


## <a name="srchooksreservationuseReservationEditStatets"></a>`src/hooks/reservation/useReservationEditState.ts`

```typescript
// path: src/hooks/reservation/useReservationEditState.ts

// src/hooks/reservation/useReservationEditState.ts
import { useState, useMemo, useCallback, useEffect } from "react";
import type { Reservation } from "@/types/reservation";
// âŒ Ğ£Ğ´Ğ°Ğ»ĞµĞ½ Ğ½ĞµĞ¸ÑĞ¿Ğ¾Ğ»ÑŒĞ·ÑƒĞµĞ¼Ñ‹Ğ¹ Ğ¸Ğ¼Ğ¿Ğ¾Ñ€Ñ‚ `Equipment`
// import type { Equipment } from "@/types/equipment";

// âœ… ĞĞ¿ĞµÑ‡Ğ°Ñ‚ĞºĞ° Ğ¸ÑĞ¿Ñ€Ğ°Ğ²Ğ»ĞµĞ½Ğ°: Ğ¿ĞµÑ€ĞµĞ¸ÑĞ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ -> Ğ¿ĞµÑ€ĞµĞ¸ÑĞ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ
// Ğ˜Ğ½Ñ‚ĞµÑ€Ñ„ĞµĞ¹ÑÑ‹ Ğ²Ñ‹Ğ½ĞµÑĞµĞ½Ñ‹ Ğ´Ğ»Ñ Ğ¿ĞµÑ€ĞµĞ¸ÑĞ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ
export interface EquipmentDisplayDetail {
    id: number;
    label: string;
}

export interface EditState {
    isEditing: boolean;
    startDate: Date;
    endDate: Date;
    originalEquipmentIds: ReadonlySet<number>;
    currentEquipmentDetails: EquipmentDisplayDetail[];
    newlyAddedEquipmentIds: ReadonlySet<number>;
    hasChanges: boolean;
}

/**
 * Ğ£Ğ¿Ñ€Ğ°Ğ²Ğ»ÑĞµÑ‚ Ğ¾ÑĞ½Ğ¾Ğ²Ğ½Ñ‹Ğ¼ ÑĞ¾ÑÑ‚Ğ¾ÑĞ½Ğ¸ĞµĞ¼ Ñ€ĞµĞ´Ğ°ĞºÑ‚Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ Ñ€ĞµĞ·ĞµÑ€Ğ²Ğ°.
 */
export function useReservationEditState(
    reservation: Reservation,
    initialEquipmentForDisplay: ReadonlyArray<EquipmentDisplayDetail>
) {
    const initialStartDate = useMemo(() => new Date(reservation.start_date), [reservation.start_date]);
    const initialEndDate = useMemo(() => new Date(reservation.end_date), [reservation.end_date]);
    const initialOriginalIds = useMemo(() => new Set(reservation.equipment_ids), [reservation.equipment_ids]);
    const initialCurrentDetails = useMemo(() => [...initialEquipmentForDisplay], [initialEquipmentForDisplay]);

    const [editState, setEditState] = useState<EditState>({
        isEditing: false,
        startDate: initialStartDate,
        endDate: initialEndDate,
        originalEquipmentIds: initialOriginalIds,
        currentEquipmentDetails: initialCurrentDetails,
        newlyAddedEquipmentIds: new Set<number>(),
        hasChanges: false
    });

    const calculateChanges = useCallback((
        currentState: EditState
    ): boolean => {
        const datesChanged =
            currentState.startDate.getTime() !== initialStartDate.getTime() ||
            currentState.endDate.getTime() !== initialEndDate.getTime();

        const currentIdSet = new Set(currentState.currentEquipmentDetails.map(eq => eq.id));
        const equipmentChanged =
            initialOriginalIds.size !== currentIdSet.size ||
            !Array.from(initialOriginalIds).every(id => currentIdSet.has(id));

        return datesChanged || equipmentChanged;
    }, [initialStartDate, initialEndDate, initialOriginalIds]);

    // Ğ¡Ğ±Ñ€Ğ¾Ñ ÑĞ¾ÑÑ‚Ğ¾ÑĞ½Ğ¸Ñ, ĞµÑĞ»Ğ¸ Ğ¿Ñ€Ğ¾Ğ¿ÑÑ‹ Ñ€ĞµĞ·ĞµÑ€Ğ²Ğ° Ğ¸Ğ·Ğ¼ĞµĞ½Ğ¸Ğ»Ğ¸ÑÑŒ Ğ¸Ğ·Ğ²Ğ½Ğµ
    useEffect(() => {
        if (!editState.isEditing) {
            setEditState({
                isEditing: false,
                startDate: initialStartDate,
                endDate: initialEndDate,
                originalEquipmentIds: initialOriginalIds,
                currentEquipmentDetails: initialCurrentDetails,
                newlyAddedEquipmentIds: new Set<number>(),
                hasChanges: false,
            });
        }
    }, [initialStartDate, initialEndDate, initialOriginalIds, initialCurrentDetails, editState.isEditing]);

    const resetToInitialState = useCallback(() => {
        setEditState({
            isEditing: false,
            startDate: initialStartDate,
            endDate: initialEndDate,
            originalEquipmentIds: initialOriginalIds,
            currentEquipmentDetails: initialCurrentDetails,
            newlyAddedEquipmentIds: new Set<number>(),
            hasChanges: false,
        });
    }, [initialStartDate, initialEndDate, initialOriginalIds, initialCurrentDetails]);

    return {
        editState,
        setEditState,
        calculateChanges,
        initialOriginalIds,
        initialStartDate,
        initialEndDate,
        resetToInitialState,
    };
}

```


## <a name="srchooksreservationuseReservationStatets"></a>`src/hooks/reservation/useReservationState.ts`

```typescript
// path: src/hooks/reservation/useReservationState.ts

// src/hooks/reservation/useReservationState.ts

import { useState, useMemo, useCallback, useEffect } from "react";
import type { Reservation } from "@/types/reservation";
import type { Equipment } from "@/types/equipment";

export interface EquipmentDisplayDetail {
    id: number;
    label: string;
}

export interface EditState {
    // isEditing: boolean; // âœ¨ Ğ£Ğ”ĞĞ›Ğ•ĞĞ
    startDate: Date;
    endDate: Date;
    originalEquipmentIds: ReadonlySet<number>;
    currentEquipmentDetails: EquipmentDisplayDetail[];
    newlyAddedEquipmentIds: ReadonlySet<number>;
    localSelectedAccessories: Record<number, number[]>;
    hasChanges: boolean;
}

function createDisplayLabel(equipmentItem: Equipment): string {
    return `${equipmentItem.equipment_type} ${equipmentItem.brand} ${equipmentItem.name}`;
}

export function useReservationState(
    reservation: Reservation,
    initialEquipmentForDisplay: ReadonlyArray<EquipmentDisplayDetail>
) {
    const initialValues = useMemo(() => ({
        startDate: new Date(reservation.start_date),
        endDate: new Date(reservation.end_date),
        equipmentIds: new Set(reservation.equipment_ids),
        equipmentDetails: [...initialEquipmentForDisplay],
        accessories: reservation.selected_accessories || {},
    }), [reservation, initialEquipmentForDisplay]);

    const [state, setState] = useState<Omit<EditState, 'hasChanges'>>({ // âœ¨ hasChanges ÑƒĞ±Ñ€Ğ°Ğ½Ğ¾ Ğ¸Ğ· Ğ½Ğ°Ñ‡Ğ°Ğ»ÑŒĞ½Ğ¾Ğ³Ğ¾ ÑĞ¾ÑÑ‚Ğ¾ÑĞ½Ğ¸Ñ
        startDate: initialValues.startDate,
        endDate: initialValues.endDate,
        originalEquipmentIds: initialValues.equipmentIds,
        currentEquipmentDetails: initialValues.equipmentDetails,
        newlyAddedEquipmentIds: new Set<number>(),
        localSelectedAccessories: initialValues.accessories,
    });

    // âœ¨ Ğ’Ñ‹Ñ‡Ğ¸ÑĞ»ÑĞµĞ¼ hasChanges Ñ‡ĞµÑ€ĞµĞ· useMemo
    const hasChanges = useMemo(() => {
        const datesChanged =
            state.startDate.getTime() !== initialValues.startDate.getTime() ||
            state.endDate.getTime() !== initialValues.endDate.getTime();

        const currentIdSet = new Set(state.currentEquipmentDetails.map(eq => eq.id));
        const equipmentChanged =
            initialValues.equipmentIds.size !== currentIdSet.size ||
            !Array.from(initialValues.equipmentIds).every(id => currentIdSet.has(id));

        const accessoriesChanged =
            JSON.stringify(state.localSelectedAccessories) !== JSON.stringify(initialValues.accessories);

        return datesChanged || equipmentChanged || accessoriesChanged;
    }, [state, initialValues]);


    const [isCancelConfirmationVisible, setCancelConfirmationVisible] = useState(false);

    const updateDates = useCallback((newStartDate: Date, newEndDate: Date) => {
        setState(prev => ({ ...prev, startDate: newStartDate, endDate: newEndDate }));
    }, []);

    const addEquipmentItems = useCallback((itemsToAdd: Equipment[]) => {
        setState(prev => {
            const currentIds = new Set(prev.currentEquipmentDetails.map(d => d.id));
            const newDetails = itemsToAdd
                .filter(item => !currentIds.has(item.id))
                .map(item => ({ id: item.id, label: createDisplayLabel(item) }));

            if (newDetails.length === 0) return prev;

            const newNewlyAddedIds = new Set(prev.newlyAddedEquipmentIds);
            itemsToAdd.forEach(item => {
                if (!initialValues.equipmentIds.has(item.id)) {
                    newNewlyAddedIds.add(item.id);
                }
            });

            return {
                ...prev,
                currentEquipmentDetails: [...prev.currentEquipmentDetails, ...newDetails],
                newlyAddedEquipmentIds: newNewlyAddedIds,
            };
        });
    }, [initialValues.equipmentIds]);

    const removeEquipmentItem = useCallback((idToRemove: number) => {
        if (state.currentEquipmentDetails.length <= 1) {
            setCancelConfirmationVisible(true);
        } else {
            setState(prev => {
                const newDetails = prev.currentEquipmentDetails.filter(eq => eq.id !== idToRemove);
                const newNewlyAddedIds = new Set(prev.newlyAddedEquipmentIds);
                newNewlyAddedIds.delete(idToRemove);

                const newAccessories = { ...prev.localSelectedAccessories };
                delete newAccessories[idToRemove];

                return {
                    ...prev,
                    currentEquipmentDetails: newDetails,
                    newlyAddedEquipmentIds: newNewlyAddedIds,
                    localSelectedAccessories: newAccessories,
                };
            });
        }
    }, [state.currentEquipmentDetails.length]);

    const toggleAccessory = useCallback((equipmentId: number, accessoryId: number) => {
        setState(prev => {
            const newAccessoriesState = { ...prev.localSelectedAccessories };
            const currentSelection = newAccessoriesState[equipmentId] || [];
            const isSelected = currentSelection.includes(accessoryId);

            const newSelection = isSelected
                ? currentSelection.filter(id => id !== accessoryId)
                : [...currentSelection, accessoryId];

            if (newSelection.length > 0) {
                newAccessoriesState[equipmentId] = newSelection;
            } else {
                delete newAccessoriesState[equipmentId];
            }
            return { ...prev, localSelectedAccessories: newAccessoriesState };
        });
    }, []);

    return {
        // âœ¨ Ğ’Ğ¾Ğ·Ğ²Ñ€Ğ°Ñ‰Ğ°ĞµĞ¼ Ğ²Ñ‹Ñ‡Ğ¸ÑĞ»ĞµĞ½Ğ½Ğ¾Ğµ Ğ·Ğ½Ğ°Ñ‡ĞµĞ½Ğ¸Ğµ hasChanges
        state: { ...state, hasChanges },
        actions: {
            updateDates,
            addEquipmentItems,
            removeEquipmentItem,
            toggleAccessory,
        },
        dialogs: {
            isCancelConfirmationVisible,
            setCancelConfirmationVisible,
        },
    };
}

```


## <a name="srchooksuseAdminAccessoriests"></a>`src/hooks/useAdminAccessories.ts`

```typescript
// path: src/hooks/useAdminAccessories.ts

// src/hooks/useAdminAccessories.ts

import { useQuery, useMutation, useQueryClient } from "@tanstack/react-query";
import { api } from "@/lib/api";
import { toast } from "sonner";
import type { Accessory, AccessoryListResponse } from "@/types/accessory";
import { AccessoryService } from "@/core/services";

// Ğ¢Ğ¸Ğ¿Ñ‹ Ğ´Ğ»Ñ ÑĞ¾Ğ·Ğ´Ğ°Ğ½Ğ¸Ñ Ğ¸ Ğ¾Ğ±Ğ½Ğ¾Ğ²Ğ»ĞµĞ½Ğ¸Ñ
type AccessoryPayload = {
    name: string;
    accessory_type?: string;
    price?: number;
    description?: string;
};

// +++ ĞĞĞ§ĞĞ›Ğ Ğ˜Ğ—ĞœĞ•ĞĞ•ĞĞ˜Ğ™ +++
// Ğ”Ğ¾Ğ±Ğ°Ğ²Ğ»ÑĞµĞ¼ Ğ·Ğ½Ğ°Ñ‡ĞµĞ½Ğ¸Ñ Ğ¿Ğ¾ ÑƒĞ¼Ğ¾Ğ»Ñ‡Ğ°Ğ½Ğ¸Ñ Ğ´Ğ»Ñ ÑÑ‚Ñ€Ğ°Ğ½Ğ¸Ñ†Ñ‹ Ğ¸ Ñ€Ğ°Ğ·Ğ¼ĞµÑ€Ğ° ÑÑ‚Ñ€Ğ°Ğ½Ğ¸Ñ†Ñ‹
export function useAccessories(page: number = 1, pageSize: number = 20) {
// +++ ĞšĞĞĞ•Ğ¦ Ğ˜Ğ—ĞœĞ•ĞĞ•ĞĞ˜Ğ™ +++
    const skip = (page - 1) * pageSize;

    return useQuery<AccessoryListResponse>({
        queryKey: ["accessories", page, pageSize],
        queryFn: async () => {
            return await AccessoryService.getAllAccessories(skip, pageSize);
        },
        staleTime: 5 * 60 * 1000, // 5 Ğ¼Ğ¸Ğ½ÑƒÑ‚
    });
}

// Ğ¡Ğ¾Ğ·Ğ´Ğ°Ğ½Ğ¸Ğµ Ğ½Ğ¾Ğ²Ğ¾Ğ³Ğ¾ Ğ°ĞºÑĞµÑÑÑƒĞ°Ñ€Ğ°
export function useCreateAccessory() {
    const queryClient = useQueryClient();
    return useMutation({
        mutationFn: (data: AccessoryPayload) => api.post<Accessory>("/accessories/", data),
        onSuccess: () => {
            void queryClient.invalidateQueries({ queryKey: ["accessories"] });
            toast.success("ĞĞºÑĞµÑÑÑƒĞ°Ñ€ ÑƒÑĞ¿ĞµÑˆĞ½Ğ¾ ÑĞ¾Ğ·Ğ´Ğ°Ğ½");
        },
        onError: (error: any) => {
            toast.error(error?.response?.data?.detail || "ĞÑˆĞ¸Ğ±ĞºĞ° Ğ¿Ñ€Ğ¸ ÑĞ¾Ğ·Ğ´Ğ°Ğ½Ğ¸Ğ¸ Ğ°ĞºÑĞµÑÑÑƒĞ°Ñ€Ğ°");
        },
    });
}

// ĞĞ±Ğ½Ğ¾Ğ²Ğ»ĞµĞ½Ğ¸Ğµ Ğ°ĞºÑĞµÑÑÑƒĞ°Ñ€Ğ°
export function useUpdateAccessory() {
    const queryClient = useQueryClient();
    return useMutation({
        mutationFn: ({ id, data }: { id: number, data: AccessoryPayload }) =>
            api.put<Accessory>(`/accessories/${id}`, data),
        onSuccess: () => {
            void queryClient.invalidateQueries({ queryKey: ["accessories"] });
            toast.success("ĞĞºÑĞµÑÑÑƒĞ°Ñ€ ÑƒÑĞ¿ĞµÑˆĞ½Ğ¾ Ğ¾Ğ±Ğ½Ğ¾Ğ²Ğ»ĞµĞ½");
        },
        onError: (error: any) => {
            toast.error(error?.response?.data?.detail || "ĞÑˆĞ¸Ğ±ĞºĞ° Ğ¿Ñ€Ğ¸ Ğ¾Ğ±Ğ½Ğ¾Ğ²Ğ»ĞµĞ½Ğ¸Ğ¸ Ğ°ĞºÑĞµÑÑÑƒĞ°Ñ€Ğ°");
        },
    });
}

// Ğ£Ğ´Ğ°Ğ»ĞµĞ½Ğ¸Ğµ Ğ°ĞºÑĞµÑÑÑƒĞ°Ñ€Ğ°
export function useDeleteAccessory() {
    const queryClient = useQueryClient();
    return useMutation({
        mutationFn: (id: number) => api.delete(`/accessories/${id}`),
        onSuccess: () => {
            void queryClient.invalidateQueries({ queryKey: ["accessories"] });
            toast.success("ĞĞºÑĞµÑÑÑƒĞ°Ñ€ ÑƒĞ´Ğ°Ğ»ĞµĞ½");
        },
        onError: (error: any) => {
            toast.error(error?.response?.data?.detail || "ĞÑˆĞ¸Ğ±ĞºĞ° Ğ¿Ñ€Ğ¸ ÑƒĞ´Ğ°Ğ»ĞµĞ½Ğ¸Ğ¸ Ğ°ĞºÑĞµÑÑÑƒĞ°Ñ€Ğ°");
        },
    });
}

```


## <a name="srchooksuseAdminAssociationsts"></a>`src/hooks/useAdminAssociations.ts`

```typescript
// path: src/hooks/useAdminAssociations.ts

// src/hooks/useAdminAssociations.ts

import { useQuery, useMutation, useQueryClient } from "@tanstack/react-query";
import { api } from "@/lib/api";
import { toast } from "sonner";
// +++ ĞĞĞ§ĞĞ›Ğ Ğ˜Ğ—ĞœĞ•ĞĞ•ĞĞ˜Ğ™: Ğ˜Ğ¼Ğ¿Ğ¾Ñ€Ñ‚Ğ¸Ñ€ÑƒĞµĞ¼ Ñ‚Ğ¸Ğ¿ Ğ´Ğ»Ñ Ğ¾Ñ‚Ğ²ĞµÑ‚Ğ° Ñ Ğ¿Ğ°Ğ³Ğ¸Ğ½Ğ°Ñ†Ğ¸ĞµĞ¹ +++
import type { Association, AssociationCreate, AssociationUpdate, AssociationListResponse } from "@/types/association";
// +++ ĞšĞĞĞ•Ğ¦ Ğ˜Ğ—ĞœĞ•ĞĞ•ĞĞ˜Ğ™ +++

const ADMIN_ASSOCIATIONS_KEY = ["admin", "associations"];

// Ğ¥ÑƒĞº Ğ´Ğ»Ñ Ğ¿Ğ¾Ğ»ÑƒÑ‡ĞµĞ½Ğ¸Ñ Ğ´Ğ°Ğ½Ğ½Ñ‹Ñ… Ñ‚Ğ°ĞºĞ¾Ğ¹ Ğ¶Ğµ, ĞºĞ°Ğº Ğ¸ Ğ¿ÑƒĞ±Ğ»Ğ¸Ñ‡Ğ½Ñ‹Ğ¹, Ğ½Ğ¾ Ñ Ğ´Ñ€ÑƒĞ³Ğ¸Ğ¼ ĞºĞ»ÑÑ‡Ğ¾Ğ¼
export function useAdminAssociations() {
    // +++ ĞĞĞ§ĞĞ›Ğ Ğ˜Ğ—ĞœĞ•ĞĞ•ĞĞ˜Ğ™: Ğ˜ÑĞ¿Ñ€Ğ°Ğ²Ğ»ÑĞµĞ¼ Ñ…ÑƒĞº Ğ´Ğ»Ñ Ñ€Ğ°Ğ±Ğ¾Ñ‚Ñ‹ Ñ Ğ¾Ğ±ÑŠĞµĞºÑ‚Ğ¾Ğ¼ Ğ¾Ñ‚Ğ²ĞµÑ‚Ğ° +++
    return useQuery<AssociationListResponse, Error, Association[]>({
        queryKey: ADMIN_ASSOCIATIONS_KEY,
        queryFn: async () => {
            // 1. ĞĞ¶Ğ¸Ğ´Ğ°ĞµĞ¼ Ğ¾Ñ‚ API Ğ¾Ğ±ÑŠĞµĞºÑ‚ AssociationListResponse
            const response = await api.get<AssociationListResponse>("/associations/");
            return response.data; // Ğ’Ğ¾Ğ·Ğ²Ñ€Ğ°Ñ‰Ğ°ĞµĞ¼ Ğ²ĞµÑÑŒ Ğ¾Ğ±ÑŠĞµĞºÑ‚ { items: [...], total: ... }
        },
        // 2. Ğ¡ Ğ¿Ğ¾Ğ¼Ğ¾Ñ‰ÑŒÑ `select` Ğ¸Ğ·Ğ²Ğ»ĞµĞºĞ°ĞµĞ¼ Ğ¸ Ğ²Ğ¾Ğ·Ğ²Ñ€Ğ°Ñ‰Ğ°ĞµĞ¼ Ñ‚Ğ¾Ğ»ÑŒĞºĞ¾ Ğ¼Ğ°ÑÑĞ¸Ğ² `items`
        select: (data) => data.items,
    });
    // +++ ĞšĞĞĞ•Ğ¦ Ğ˜Ğ—ĞœĞ•ĞĞ•ĞĞ˜Ğ™ +++
}

export function useCreateAssociation() {
    const queryClient = useQueryClient();
    return useMutation({
        mutationFn: (data: AssociationCreate) => api.post<Association>("/associations/", data),
        onSuccess: () => {
            void queryClient.invalidateQueries({ queryKey: ADMIN_ASSOCIATIONS_KEY });
            toast.success("ĞÑÑĞ¾Ñ†Ğ¸Ğ°Ñ†Ğ¸Ñ ÑƒÑĞ¿ĞµÑˆĞ½Ğ¾ ÑĞ¾Ğ·Ğ´Ğ°Ğ½Ğ°");
        },
        onError: (e: any) => toast.error(e.response?.data?.detail || "ĞÑˆĞ¸Ğ±ĞºĞ° ÑĞ¾Ğ·Ğ´Ğ°Ğ½Ğ¸Ñ"),
    });
}

export function useUpdateAssociation() {
    const queryClient = useQueryClient();
    return useMutation({
        mutationFn: ({ id, data }: { id: number, data: AssociationUpdate }) =>
            api.put<Association>(`/associations/${id}`, data),
        onSuccess: () => {
            void queryClient.invalidateQueries({ queryKey: ADMIN_ASSOCIATIONS_KEY });
            toast.success("ĞÑÑĞ¾Ñ†Ğ¸Ğ°Ñ†Ğ¸Ñ ÑƒÑĞ¿ĞµÑˆĞ½Ğ¾ Ğ¾Ğ±Ğ½Ğ¾Ğ²Ğ»ĞµĞ½Ğ°");
        },
        onError: (e: any) => toast.error(e.response?.data?.detail || "ĞÑˆĞ¸Ğ±ĞºĞ° Ğ¾Ğ±Ğ½Ğ¾Ğ²Ğ»ĞµĞ½Ğ¸Ñ"),
    });
}

export function useDeleteAssociation() {
    const queryClient = useQueryClient();
    return useMutation({
        mutationFn: (id: number) => api.delete(`/associations/${id}`),
        onSuccess: () => {
            void queryClient.invalidateQueries({ queryKey: ADMIN_ASSOCIATIONS_KEY });
            toast.success("ĞÑÑĞ¾Ñ†Ğ¸Ğ°Ñ†Ğ¸Ñ ÑƒĞ´Ğ°Ğ»ĞµĞ½Ğ°");
        },
        onError: (e: any) => toast.error(e.response?.data?.detail || "ĞÑˆĞ¸Ğ±ĞºĞ° ÑƒĞ´Ğ°Ğ»ĞµĞ½Ğ¸Ñ"),
    });
}

```


## <a name="srchooksuseAdminDiscountsts"></a>`src/hooks/useAdminDiscounts.ts`

```typescript
// path: src/hooks/useAdminDiscounts.ts

// src/hooks/useAdminDiscounts.ts

import { useQuery, useMutation, useQueryClient } from "@tanstack/react-query";
import { api } from "@/lib/api";
import { toast } from "sonner";
// +++ ĞĞĞ§ĞĞ›Ğ Ğ˜Ğ—ĞœĞ•ĞĞ•ĞĞ˜Ğ™: Ğ˜ÑĞ¿Ñ€Ğ°Ğ²Ğ»ÑĞµĞ¼ Ğ¸Ğ¼Ğ¿Ğ¾Ñ€Ñ‚ +++
import type { DurationDiscount, DiscountPayload, DiscountListResponse } from "@/types/discount";
// +++ ĞšĞĞĞ•Ğ¦ Ğ˜Ğ—ĞœĞ•ĞĞ•ĞĞ˜Ğ™ +++

const DURATION_DISCOUNTS_KEY = "durationDiscounts";

export const useDurationDiscounts = (page: number = 1, pageSize: number = 10) => {
    const skip = (page - 1) * pageSize;
    return useQuery<DiscountListResponse>({
        queryKey: [DURATION_DISCOUNTS_KEY, page, pageSize],
        queryFn: async () => {
            const response = await api.get<DiscountListResponse>("/discounts/", {
                params: { skip, limit: pageSize }
            });
            return response.data;
        },
    });
};

export const useCreateDurationDiscount = () => {
    const queryClient = useQueryClient();
    return useMutation({
        mutationFn: (data: DiscountPayload) => api.post("/discounts/", data),
        onSuccess: () => {
            toast.success("ĞĞ¾Ğ²Ñ‹Ğ¹ ÑƒÑ€Ğ¾Ğ²ĞµĞ½ÑŒ ÑĞºĞ¸Ğ´ĞºĞ¸ Ğ´Ğ¾Ğ±Ğ°Ğ²Ğ»ĞµĞ½");
            void queryClient.invalidateQueries({ queryKey: [DURATION_DISCOUNTS_KEY] });
        },
        onError: (e: any) => toast.error(e.response?.data?.detail || "ĞÑˆĞ¸Ğ±ĞºĞ° ÑĞ¾Ğ·Ğ´Ğ°Ğ½Ğ¸Ñ"),
    });
};

export const useUpdateDurationDiscount = () => {
    const queryClient = useQueryClient();
    return useMutation({
        mutationFn: ({ id, ...data }: DurationDiscount) => api.put(`/discounts/${id}`, data),
        onSuccess: () => {
            toast.success("Ğ¡ĞºĞ¸Ğ´ĞºĞ° Ğ¾Ğ±Ğ½Ğ¾Ğ²Ğ»ĞµĞ½Ğ°");
            void queryClient.invalidateQueries({ queryKey: [DURATION_DISCOUNTS_KEY] });
        },
        onError: (e: any) => toast.error(e.response?.data?.detail || "ĞÑˆĞ¸Ğ±ĞºĞ° Ğ¾Ğ±Ğ½Ğ¾Ğ²Ğ»ĞµĞ½Ğ¸Ñ"),
    });
};

export const useDeleteDurationDiscount = () => {
    const queryClient = useQueryClient();
    return useMutation({
        mutationFn: (id: number) => api.delete(`/discounts/${id}`),
        onSuccess: () => {
            toast.success("Ğ¡ĞºĞ¸Ğ´ĞºĞ° ÑƒĞ´Ğ°Ğ»ĞµĞ½Ğ°");
            void queryClient.invalidateQueries({ queryKey: [DURATION_DISCOUNTS_KEY] });
        },
        onError: (e: any) => toast.error(e.response?.data?.detail || "ĞÑˆĞ¸Ğ±ĞºĞ° ÑƒĞ´Ğ°Ğ»ĞµĞ½Ğ¸Ñ"),
    });
};

```


## <a name="srchooksuseAdminEquipmentts"></a>`src/hooks/useAdminEquipment.ts`

```typescript
// path: src/hooks/useAdminEquipment.ts

//src/hooks/useAdminEquipment.ts


import { useMutation, useQueryClient } from "@tanstack/react-query";
import { api } from "@/lib/api";
import { toast } from "sonner";
import type { Equipment } from "@/types/equipment";

export interface EquipmentCreateData {
    equipment_type: string;
    brand: string;
    name: string;
    serial_number?: string;
    condition?: string;
    daily_rate?: number;
    notes?: string;
    description?: string;
    last_maintenance?: string; // format: YYYY-MM-DD
}

// Ğ¡Ğ¾Ğ·Ğ´Ğ°Ğ½Ğ¸Ğµ Ğ½Ğ¾Ğ²Ğ¾Ğ³Ğ¾ Ğ¾Ğ±Ğ¾Ñ€ÑƒĞ´Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ (Ğ´Ğ»Ñ Ğ¼ĞµĞ½ĞµĞ´Ğ¶ĞµÑ€Ğ¾Ğ² Ğ¸ Ğ°Ğ´Ğ¼Ğ¸Ğ½Ğ¾Ğ²)
export function useCreateEquipment() {
    const queryClient = useQueryClient();

    return useMutation({
        mutationFn: async (equipmentData: EquipmentCreateData) => {
            const response = await api.post<Equipment>("/equipment/", equipmentData);
            return response.data;
        },
        onSuccess: () => {
            queryClient.invalidateQueries({ queryKey: ["equipment"] });
            queryClient.invalidateQueries({ queryKey: ["availability"] });
            queryClient.invalidateQueries({ queryKey: ["calendar-grid"] });
            toast.success("ĞĞ±Ğ¾Ñ€ÑƒĞ´Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ ÑƒÑĞ¿ĞµÑˆĞ½Ğ¾ ÑĞ¾Ğ·Ğ´Ğ°Ğ½Ğ¾");
        },
        onError: (error: any) => {
            toast.error(error?.response?.data?.detail || "ĞÑˆĞ¸Ğ±ĞºĞ° Ğ¿Ñ€Ğ¸ ÑĞ¾Ğ·Ğ´Ğ°Ğ½Ğ¸Ğ¸ Ğ¾Ğ±Ğ¾Ñ€ÑƒĞ´Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ");
        },
    });
}

// Ğ£Ğ´Ğ°Ğ»ĞµĞ½Ğ¸Ğµ Ğ¾Ğ±Ğ¾Ñ€ÑƒĞ´Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ (Ğ´Ğ»Ñ Ğ¼ĞµĞ½ĞµĞ´Ğ¶ĞµÑ€Ğ¾Ğ² Ğ¸ Ğ°Ğ´Ğ¼Ğ¸Ğ½Ğ¾Ğ²)
export function useDeleteEquipment() {
    const queryClient = useQueryClient();

    return useMutation({
        mutationFn: async (equipmentId: number) => {
            const response = await api.delete(`/equipment/${equipmentId}`);
            return response.data;
        },
        onSuccess: () => {
            queryClient.invalidateQueries({ queryKey: ["equipment"] });
            queryClient.invalidateQueries({ queryKey: ["availability"] });
            queryClient.invalidateQueries({ queryKey: ["calendar-grid"] });
            toast.success("ĞĞ±Ğ¾Ñ€ÑƒĞ´Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ ÑƒĞ´Ğ°Ğ»ĞµĞ½Ğ¾");
        },
        onError: (error: any) => {
            toast.error(error?.response?.data?.detail || "ĞÑˆĞ¸Ğ±ĞºĞ° Ğ¿Ñ€Ğ¸ ÑƒĞ´Ğ°Ğ»ĞµĞ½Ğ¸Ğ¸ Ğ¾Ğ±Ğ¾Ñ€ÑƒĞ´Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ");
        },
    });
}

// ĞœĞ°ÑÑĞ¾Ğ²Ğ¾Ğµ ÑƒĞ´Ğ°Ğ»ĞµĞ½Ğ¸Ğµ Ğ¾Ğ±Ğ¾Ñ€ÑƒĞ´Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ
export function useBulkDeleteEquipment() {
    const queryClient = useQueryClient();

    return useMutation({
        mutationFn: async (equipmentIds: number[]) => {
            // Ğ’Ñ‹Ğ¿Ğ¾Ğ»Ğ½ÑĞµĞ¼ Ğ¿Ğ°Ñ€Ğ°Ğ»Ğ»ĞµĞ»ÑŒĞ½Ğ¾Ğµ ÑƒĞ´Ğ°Ğ»ĞµĞ½Ğ¸Ğµ
            const deletePromises = equipmentIds.map(id => 
                api.delete(`/equipment/${id}`)
            );
            await Promise.all(deletePromises);
            return { deleted_count: equipmentIds.length };
        },
        onSuccess: (data) => {
            queryClient.invalidateQueries({ queryKey: ["equipment"] });
            queryClient.invalidateQueries({ queryKey: ["availability"] });
            queryClient.invalidateQueries({ queryKey: ["calendar-grid"] });
            toast.success(`Ğ£Ğ´Ğ°Ğ»ĞµĞ½Ğ¾ ${data.deleted_count} ĞµĞ´Ğ¸Ğ½Ğ¸Ñ† Ğ¾Ğ±Ğ¾Ñ€ÑƒĞ´Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ`);
        },
        onError: (error: any) => {
            toast.error("ĞÑˆĞ¸Ğ±ĞºĞ° Ğ¿Ñ€Ğ¸ Ğ¼Ğ°ÑÑĞ¾Ğ²Ğ¾Ğ¼ ÑƒĞ´Ğ°Ğ»ĞµĞ½Ğ¸Ğ¸ Ğ¾Ğ±Ğ¾Ñ€ÑƒĞ´Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ");
        },
    });
}

// ĞœĞ°ÑÑĞ¾Ğ²Ğ¾Ğµ Ğ¾Ğ±Ğ½Ğ¾Ğ²Ğ»ĞµĞ½Ğ¸Ğµ Ñ‚Ğ°Ñ€Ğ¸Ñ„Ğ¾Ğ²
export function useBulkUpdateRates() {
    const queryClient = useQueryClient();

    return useMutation({
        mutationFn: async (updates: { id: number; daily_rate: number }[]) => {
            // Ğ’Ñ‹Ğ¿Ğ¾Ğ»Ğ½ÑĞµĞ¼ Ğ¿Ğ°Ñ€Ğ°Ğ»Ğ»ĞµĞ»ÑŒĞ½Ğ¾Ğµ Ğ¾Ğ±Ğ½Ğ¾Ğ²Ğ»ĞµĞ½Ğ¸Ğµ
            const updatePromises = updates.map(({ id, daily_rate }) => 
                api.put(`/equipment/${id}`, { daily_rate })
            );
            await Promise.all(updatePromises);
            return { updated_count: updates.length };
        },
        onSuccess: (data) => {
            queryClient.invalidateQueries({ queryKey: ["equipment"] });
            toast.success(`ĞĞ±Ğ½Ğ¾Ğ²Ğ»ĞµĞ½Ñ‹ Ñ‚Ğ°Ñ€Ğ¸Ñ„Ñ‹ Ğ´Ğ»Ñ ${data.updated_count} ĞµĞ´Ğ¸Ğ½Ğ¸Ñ† Ğ¾Ğ±Ğ¾Ñ€ÑƒĞ´Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ`);
        },
        onError: (error: any) => {
            toast.error("ĞÑˆĞ¸Ğ±ĞºĞ° Ğ¿Ñ€Ğ¸ Ğ¼Ğ°ÑÑĞ¾Ğ²Ğ¾Ğ¼ Ğ¾Ğ±Ğ½Ğ¾Ğ²Ğ»ĞµĞ½Ğ¸Ğ¸ Ñ‚Ğ°Ñ€Ğ¸Ñ„Ğ¾Ğ²");
        },
    });
}


```


## <a name="srchooksuseAdminHolidayRulests"></a>`src/hooks/useAdminHolidayRules.ts`

```typescript
// path: src/hooks/useAdminHolidayRules.ts

// src/hooks/useAdminHolidayRules.ts

import { useQuery, useMutation, useQueryClient } from "@tanstack/react-query";
import { toast } from "sonner";
import { api } from "@/lib/api";

// Ğ¢Ğ¸Ğ¿Ñ‹, ÑĞ¾Ğ¾Ñ‚Ğ²ĞµÑ‚ÑÑ‚Ğ²ÑƒÑÑ‰Ğ¸Ğµ Pydantic-ÑÑ…ĞµĞ¼Ğ°Ğ¼ Ğ½Ğ° Ğ±ÑĞºĞµĞ½Ğ´Ğµ
interface HolidayRuleOut {
    id: number;
    rule_type: string;
    description: string;
    created_at: string;
}

interface RecurringHolidayRuleCreate {
    day_of_week: number;
    start_date: Date;
    end_date: Date;
    description: string;
}

// +++ ĞĞĞ§ĞĞ›Ğ Ğ˜Ğ—ĞœĞ•ĞĞ•ĞĞ˜Ğ™: Ğ”Ğ¾Ğ±Ğ°Ğ²Ğ»ÑĞµĞ¼ Ñ‚Ğ¸Ğ¿ Ğ´Ğ»Ñ Ğ¾Ñ‚Ğ²ĞµÑ‚Ğ° API +++
interface HolidayRuleListResponse {
    items: HolidayRuleOut[];
    total: number;
}
// +++ ĞšĞĞĞ•Ğ¦ Ğ˜Ğ—ĞœĞ•ĞĞ•ĞĞ˜Ğ™ +++


const HOLIDAY_RULES_KEY = ["holidayRules"];
const HOLIDAYS_QUERY_KEY = ["holidays"];

// 1. Ğ¥ÑƒĞº Ğ´Ğ»Ñ Ğ¿Ğ¾Ğ»ÑƒÑ‡ĞµĞ½Ğ¸Ñ ÑĞ¿Ğ¸ÑĞºĞ° Ğ¿Ñ€Ğ°Ğ²Ğ¸Ğ»
export function useGetHolidayRules() {
    // +++ ĞĞĞ§ĞĞ›Ğ Ğ˜Ğ—ĞœĞ•ĞĞ•ĞĞ˜Ğ™: Ğ˜ÑĞ¿Ñ€Ğ°Ğ²Ğ»ÑĞµĞ¼ Ñ…ÑƒĞº Ğ´Ğ»Ñ Ñ€Ğ°Ğ±Ğ¾Ñ‚Ñ‹ Ñ Ğ¾Ğ±ÑŠĞµĞºÑ‚Ğ¾Ğ¼ Ğ¾Ñ‚Ğ²ĞµÑ‚Ğ° +++
    return useQuery<HolidayRuleListResponse, Error, HolidayRuleOut[]>({
        queryKey: HOLIDAY_RULES_KEY,
        queryFn: async () => {
            // 1. ĞĞ¶Ğ¸Ğ´Ğ°ĞµĞ¼ Ğ¾Ñ‚ API Ğ¾Ğ±ÑŠĞµĞºÑ‚ HolidayRuleListResponse
            const response = await api.get<HolidayRuleListResponse>("/holidays/rules");
            return response.data;
        },
        // 2. Ğ¡ Ğ¿Ğ¾Ğ¼Ğ¾Ñ‰ÑŒÑ `select` Ğ¸Ğ·Ğ²Ğ»ĞµĞºĞ°ĞµĞ¼ Ğ¸ Ğ²Ğ¾Ğ·Ğ²Ñ€Ğ°Ñ‰Ğ°ĞµĞ¼ Ñ‚Ğ¾Ğ»ÑŒĞºĞ¾ Ğ¼Ğ°ÑÑĞ¸Ğ² `items`
        select: (data) => data.items,
    });
    // +++ ĞšĞĞĞ•Ğ¦ Ğ˜Ğ—ĞœĞ•ĞĞ•ĞĞ˜Ğ™ +++
}

// 2. Ğ¥ÑƒĞº Ğ´Ğ»Ñ ÑĞ¾Ğ·Ğ´Ğ°Ğ½Ğ¸Ñ Ğ¿Ñ€Ğ°Ğ²Ğ¸Ğ»Ğ° ĞµĞ¶ĞµĞ½ĞµĞ´ĞµĞ»ÑŒĞ½Ñ‹Ñ… Ğ²Ñ‹Ñ…Ğ¾Ğ´Ğ½Ñ‹Ñ…
export function useCreateWeeklyRule() {
    const queryClient = useQueryClient();
    return useMutation({
        mutationFn: (data: RecurringHolidayRuleCreate) => api.post("/holidays/recurring/weekly", data),
        onSuccess: () => {
            toast.success("ĞŸÑ€Ğ°Ğ²Ğ¸Ğ»Ğ¾ Ğ´Ğ»Ñ ĞµĞ¶ĞµĞ½ĞµĞ´ĞµĞ»ÑŒĞ½Ñ‹Ñ… Ğ²Ñ‹Ñ…Ğ¾Ğ´Ğ½Ñ‹Ñ… ÑƒÑĞ¿ĞµÑˆĞ½Ğ¾ ÑĞ¾Ğ·Ğ´Ğ°Ğ½Ğ¾!");
            void queryClient.invalidateQueries({ queryKey: HOLIDAY_RULES_KEY });
            void queryClient.invalidateQueries({ queryKey: HOLIDAYS_QUERY_KEY });
        },
        onError: (error: any) => {
            toast.error(error.response?.data?.detail || "ĞÑˆĞ¸Ğ±ĞºĞ° Ğ¿Ñ€Ğ¸ ÑĞ¾Ğ·Ğ´Ğ°Ğ½Ğ¸Ğ¸ Ğ¿Ñ€Ğ°Ğ²Ğ¸Ğ»Ğ°");
        },
    });
}

// 3. Ğ¥ÑƒĞº Ğ´Ğ»Ñ Ğ¸Ğ¼Ğ¿Ğ¾Ñ€Ñ‚Ğ° Ğ³Ğ¾ÑÑƒĞ´Ğ°Ñ€ÑÑ‚Ğ²ĞµĞ½Ğ½Ñ‹Ñ… Ğ¿Ñ€Ğ°Ğ·Ğ´Ğ½Ğ¸ĞºĞ¾Ğ²
export function useImportPublicHolidays() {
    const queryClient = useQueryClient();
    return useMutation({
        mutationFn: ({ country_code, year }: { country_code: string; year: number }) =>
            api.post(`/holidays/import/public?country_code=${country_code}&year=${year}`),
        onSuccess: () => {
            toast.success("Ğ“Ğ¾ÑÑƒĞ´Ğ°Ñ€ÑÑ‚Ğ²ĞµĞ½Ğ½Ñ‹Ğµ Ğ¿Ñ€Ğ°Ğ·Ğ´Ğ½Ğ¸ĞºĞ¸ ÑƒÑĞ¿ĞµÑˆĞ½Ğ¾ Ğ¸Ğ¼Ğ¿Ğ¾Ñ€Ñ‚Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ñ‹!");
            void queryClient.invalidateQueries({ queryKey: HOLIDAY_RULES_KEY });
            void queryClient.invalidateQueries({ queryKey: HOLIDAYS_QUERY_KEY });
        },
        onError: (error: any) => {
            toast.error(error.response?.data?.detail || "ĞÑˆĞ¸Ğ±ĞºĞ° Ğ¿Ñ€Ğ¸ Ğ¸Ğ¼Ğ¿Ğ¾Ñ€Ñ‚Ğµ Ğ¿Ñ€Ğ°Ğ·Ğ´Ğ½Ğ¸ĞºĞ¾Ğ²");
        },
    });
}


// 4. Ğ¥ÑƒĞº Ğ´Ğ»Ñ ÑƒĞ´Ğ°Ğ»ĞµĞ½Ğ¸Ñ Ğ¿Ñ€Ğ°Ğ²Ğ¸Ğ»Ğ°
export function useDeleteHolidayRule() {
    const queryClient = useQueryClient();
    return useMutation({
        mutationFn: (ruleId: number) => api.delete(`/holidays/rules/${ruleId}`),
        onSuccess: () => {
            toast.success("ĞŸÑ€Ğ°Ğ²Ğ¸Ğ»Ğ¾ Ğ¸ ÑĞ²ÑĞ·Ğ°Ğ½Ğ½Ñ‹Ğµ Ñ Ğ½Ğ¸Ğ¼ Ğ²Ñ‹Ñ…Ğ¾Ğ´Ğ½Ñ‹Ğµ ÑƒĞ´Ğ°Ğ»ĞµĞ½Ñ‹.");
            void queryClient.invalidateQueries({ queryKey: HOLIDAY_RULES_KEY });
            void queryClient.invalidateQueries({ queryKey: HOLIDAYS_QUERY_KEY });
        },
        onError: (error: any) => {
            toast.error(error.response?.data?.detail || "ĞÑˆĞ¸Ğ±ĞºĞ° Ğ¿Ñ€Ğ¸ ÑƒĞ´Ğ°Ğ»ĞµĞ½Ğ¸Ğ¸ Ğ¿Ñ€Ğ°Ğ²Ğ¸Ğ»Ğ°");
        },
    });
}

```


## <a name="srchooksuseAdminHolidaysts"></a>`src/hooks/useAdminHolidays.ts`

```typescript
// path: src/hooks/useAdminHolidays.ts

// src/hooks/useAdminHolidays.ts

import { useQuery, useMutation, useQueryClient } from "@tanstack/react-query";
import { toast } from "sonner";
import { api } from "@/lib/api";
import { formatDate } from "@/lib/utils";
import type { AxiosError } from "axios";
// +++ ĞĞĞ§ĞĞ›Ğ Ğ˜Ğ—ĞœĞ•ĞĞ•ĞĞ˜Ğ™: Ğ˜Ğ¼Ğ¿Ğ¾Ñ€Ñ‚Ğ¸Ñ€ÑƒĞµĞ¼ Ğ½ÑƒĞ¶Ğ½Ñ‹Ğµ Ñ‚Ğ¸Ğ¿Ñ‹ +++
import type { Holiday, HolidayListResponse } from "@/types/holiday";
// +++ ĞšĞĞĞ•Ğ¦ Ğ˜Ğ—ĞœĞ•ĞĞ•ĞĞ˜Ğ™ +++


// ĞĞ¾Ğ²Ñ‹Ğ¹ Ñ‚Ğ¸Ğ¿ Ğ´Ğ»Ñ Ğ²Ğ½ÑƒÑ‚Ñ€ĞµĞ½Ğ½ĞµĞ³Ğ¾ Ğ¸ÑĞ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ, Ğ³Ğ´Ğµ date ÑĞ²Ğ»ÑĞµÑ‚ÑÑ Ğ¾Ğ±ÑŠĞµĞºÑ‚Ğ¾Ğ¼ Date
export interface HolidayWithDate extends Omit<Holiday, 'date'> {
    date: Date;
}

export interface HolidayCreatePayload {
    date: string; // YYYY-MM-DD
    description?: string;
    force?: boolean; // Ğ¤Ğ»Ğ°Ğ³ Ğ´Ğ»Ñ Ğ¿Ğ¾Ğ´Ñ‚Ğ²ĞµÑ€Ğ¶Ğ´ĞµĞ½Ğ¸Ñ ÑĞ¾Ğ·Ğ´Ğ°Ğ½Ğ¸Ñ Ğ¿Ñ€Ğ¸ ĞºĞ¾Ğ½Ñ„Ğ»Ğ¸ĞºÑ‚Ğ°Ñ…
}

// Ğ¢Ğ¸Ğ¿ Ğ´Ğ»Ñ Ğ¾ÑˆĞ¸Ğ±ĞºĞ¸ ĞºĞ¾Ğ½Ñ„Ğ»Ğ¸ĞºÑ‚Ğ° Ğ¾Ñ‚ API
interface ConflictErrorData {
    detail: {
        message: string;
        conflicting_reservation_ids: number[];
    };
}

const HOLIDAYS_QUERY_KEY = "holidays";

/**
 * Ğ¥ÑƒĞº Ğ´Ğ»Ñ Ğ¿Ğ¾Ğ»ÑƒÑ‡ĞµĞ½Ğ¸Ñ ÑĞ¿Ğ¸ÑĞºĞ° Ğ²Ñ‹Ñ…Ğ¾Ğ´Ğ½Ñ‹Ñ… Ğ² Ğ·Ğ°Ğ´Ğ°Ğ½Ğ½Ğ¾Ğ¼ Ğ´Ğ¸Ğ°Ğ¿Ğ°Ğ·Ğ¾Ğ½Ğµ Ğ´Ğ°Ñ‚.
 */
export function useHolidays(startDate: Date, endDate: Date) {
    const formattedStart = formatDate(startDate);
    const formattedEnd = formatDate(endDate);

    // +++ ĞĞĞ§ĞĞ›Ğ Ğ˜Ğ—ĞœĞ•ĞĞ•ĞĞ˜Ğ™: ĞŸĞ¾Ğ»Ğ½Ğ¾ÑÑ‚ÑŒÑ Ğ¸ÑĞ¿Ñ€Ğ°Ğ²Ğ»ĞµĞ½Ğ½Ñ‹Ğ¹ Ñ…ÑƒĞº +++
    return useQuery<HolidayListResponse, Error, HolidayWithDate[]>({
        queryKey: [HOLIDAYS_QUERY_KEY, formattedStart, formattedEnd],
        queryFn: async () => {
            const response = await api.get<HolidayListResponse>("/holidays/", {
                params: {
                    start_date: formattedStart,
                    end_date: formattedEnd,
                    // 1. Ğ”Ğ¾Ğ±Ğ°Ğ²Ğ»ÑĞµĞ¼ Ğ½ĞµĞ´Ğ¾ÑÑ‚Ğ°ÑÑ‰Ğ¸Ğ¹ Ğ¿Ğ°Ñ€Ğ°Ğ¼ĞµÑ‚Ñ€ limit
                    limit: 100,
                },
            });
            return response.data; // Ğ’Ğ¾Ğ·Ğ²Ñ€Ğ°Ñ‰Ğ°ĞµĞ¼ Ğ²ĞµÑÑŒ Ğ¾Ğ±ÑŠĞµĞºÑ‚ { items: [...], total: ... }
        },
        // 2. Ğ¡ Ğ¿Ğ¾Ğ¼Ğ¾Ñ‰ÑŒÑ `select` Ğ¸Ğ·Ğ²Ğ»ĞµĞºĞ°ĞµĞ¼ Ğ¼Ğ°ÑÑĞ¸Ğ² items Ğ¸ Ğ¿Ñ€ĞµĞ¾Ğ±Ñ€Ğ°Ğ·ÑƒĞµĞ¼ Ğ´Ğ°Ñ‚Ñ‹
        select: (data) => {
            return data.items.map(h => ({ ...h, date: new Date(h.date) }));
        },
        enabled: !!startDate && !!endDate,
    });
    // +++ ĞšĞĞĞ•Ğ¦ Ğ˜Ğ—ĞœĞ•ĞĞ•ĞĞ˜Ğ™ +++
}

/**
 * Ğ¥ÑƒĞº Ğ´Ğ»Ñ ÑĞ¾Ğ·Ğ´Ğ°Ğ½Ğ¸Ñ Ğ½Ğ¾Ğ²Ğ¾Ğ³Ğ¾ Ğ²Ñ‹Ñ…Ğ¾Ğ´Ğ½Ğ¾Ğ³Ğ¾ Ğ´Ğ½Ñ.
 * ĞĞ±Ñ€Ğ°Ğ±Ğ°Ñ‚Ñ‹Ğ²Ğ°ĞµÑ‚ ÑĞ¿ĞµÑ†Ğ¸Ñ„Ğ¸Ñ‡ĞµÑĞºÑƒÑ Ğ¾ÑˆĞ¸Ğ±ĞºÑƒ ĞºĞ¾Ğ½Ñ„Ğ»Ğ¸ĞºÑ‚Ğ° (409).
 */
export function useCreateHoliday() {
    const queryClient = useQueryClient();
    return useMutation<unknown, AxiosError<ConflictErrorData>, HolidayCreatePayload>({
        mutationFn: (data) => api.post("/holidays/", data),
        onSuccess: () => {
            toast.success("Ğ’Ñ‹Ñ…Ğ¾Ğ´Ğ½Ğ¾Ğ¹ Ğ´ĞµĞ½ÑŒ ÑƒÑĞ¿ĞµÑˆĞ½Ğ¾ Ğ´Ğ¾Ğ±Ğ°Ğ²Ğ»ĞµĞ½");
            void queryClient.invalidateQueries({ queryKey: [HOLIDAYS_QUERY_KEY] });
        },
        onError: (error) => {
            if (error.response?.status === 409) {
                // ĞÑˆĞ¸Ğ±ĞºĞ° ĞºĞ¾Ğ½Ñ„Ğ»Ğ¸ĞºÑ‚Ğ° Ğ±ÑƒĞ´ĞµÑ‚ Ğ¾Ğ±Ñ€Ğ°Ğ±Ğ¾Ñ‚Ğ°Ğ½Ğ° Ğ² ĞºĞ¾Ğ¼Ğ¿Ğ¾Ğ½ĞµĞ½Ñ‚Ğµ
                return;
            }
            toast.error(error.response?.data?.detail?.message || "ĞÑˆĞ¸Ğ±ĞºĞ° Ğ¿Ñ€Ğ¸ ÑĞ¾Ğ·Ğ´Ğ°Ğ½Ğ¸Ğ¸ Ğ²Ñ‹Ñ…Ğ¾Ğ´Ğ½Ğ¾Ğ³Ğ¾ Ğ´Ğ½Ñ");
        },
    });
}

/**
 * Ğ¥ÑƒĞº Ğ´Ğ»Ñ ÑƒĞ´Ğ°Ğ»ĞµĞ½Ğ¸Ñ Ğ²Ñ‹Ñ…Ğ¾Ğ´Ğ½Ğ¾Ğ³Ğ¾ Ğ´Ğ½Ñ.
 */
export function useDeleteHoliday() {
    const queryClient = useQueryClient();
    return useMutation({
        mutationFn: (date: Date) => api.delete(`/holidays/${formatDate(date)}`),
        onSuccess: () => {
            toast.success("Ğ’Ñ‹Ñ…Ğ¾Ğ´Ğ½Ğ¾Ğ¹ Ğ´ĞµĞ½ÑŒ ÑƒĞ´Ğ°Ğ»ĞµĞ½");
            void queryClient.invalidateQueries({ queryKey: [HOLIDAYS_QUERY_KEY] });
        },
        onError: (error: any) => {
            toast.error(error.response?.data?.detail || "ĞÑˆĞ¸Ğ±ĞºĞ° Ğ¿Ñ€Ğ¸ ÑƒĞ´Ğ°Ğ»ĞµĞ½Ğ¸Ğ¸ Ğ²Ñ‹Ñ…Ğ¾Ğ´Ğ½Ğ¾Ğ³Ğ¾ Ğ´Ğ½Ñ");
        },
    });
}

```


## <a name="srchooksuseAdminPromoCodests"></a>`src/hooks/useAdminPromoCodes.ts`

```typescript
// path: src/hooks/useAdminPromoCodes.ts

// src/hooks/useAdminPromoCodes.ts

import { useQuery, useMutation, useQueryClient } from "@tanstack/react-query";
import { api } from "@/lib/api";
import { toast } from "sonner";
// +++ ĞĞĞ§ĞĞ›Ğ Ğ˜Ğ—ĞœĞ•ĞĞ•ĞĞ˜Ğ™: Ğ˜Ğ¼Ğ¿Ğ¾Ñ€Ñ‚Ğ¸Ñ€ÑƒĞµĞ¼ Ğ½Ğ¾Ğ²Ñ‹Ğ¹ Ñ‚Ğ¸Ğ¿ +++
import type {
    PromoCodeOut,
    PromoCodeCreate,
    PromoCodeUpdate,
    PromoCodeListResponse
} from "@/types/promo_code";
// +++ ĞšĞĞĞ•Ğ¦ Ğ˜Ğ—ĞœĞ•ĞĞ•ĞĞ˜Ğ™ +++

const PROMO_CODES_QUERY_KEY = ["admin", "promocodes"];

/**
 * Ğ¥ÑƒĞº Ğ´Ğ»Ñ Ğ¿Ğ¾Ğ»ÑƒÑ‡ĞµĞ½Ğ¸Ñ ÑĞ¿Ğ¸ÑĞºĞ° Ğ²ÑĞµÑ… Ğ¿Ñ€Ğ¾Ğ¼Ğ¾ĞºĞ¾Ğ´Ğ¾Ğ².
 */
export function useAdminPromoCodes() {
    // +++ ĞĞĞ§ĞĞ›Ğ Ğ˜Ğ—ĞœĞ•ĞĞ•ĞĞ˜Ğ™: ĞŸĞ¾Ğ»Ğ½Ğ¾ÑÑ‚ÑŒÑ Ğ¸ÑĞ¿Ñ€Ğ°Ğ²Ğ»ĞµĞ½Ğ½Ñ‹Ğ¹ Ñ…ÑƒĞº +++
    return useQuery<PromoCodeListResponse, Error, PromoCodeOut[]>({
        queryKey: PROMO_CODES_QUERY_KEY,
        queryFn: async () => {
            // 1. Ğ£ĞºĞ°Ğ·Ñ‹Ğ²Ğ°ĞµĞ¼, Ñ‡Ñ‚Ğ¾ API Ğ²ĞµÑ€Ğ½ĞµÑ‚ Ğ¾Ğ±ÑŠĞµĞºÑ‚ PromoCodeListResponse
            const response = await api.get<PromoCodeListResponse>("/promocodes/");
            // 2. Ğ’Ğ¾Ğ·Ğ²Ñ€Ğ°Ñ‰Ğ°ĞµĞ¼ Ğ²ĞµÑÑŒ Ğ¾Ğ±ÑŠĞµĞºÑ‚ { items: [...], total: ... }
            return response.data;
        },
        // 3. Ğ¡ Ğ¿Ğ¾Ğ¼Ğ¾Ñ‰ÑŒÑ Ğ¾Ğ¿Ñ†Ğ¸Ğ¸ `select` Ğ¸Ğ·Ğ²Ğ»ĞµĞºĞ°ĞµĞ¼ Ñ‚Ğ¾Ğ»ÑŒĞºĞ¾ Ğ¼Ğ°ÑÑĞ¸Ğ² `items`.
        //    ĞšĞ¾Ğ¼Ğ¿Ğ¾Ğ½ĞµĞ½Ñ‚, Ğ¸ÑĞ¿Ğ¾Ğ»ÑŒĞ·ÑƒÑÑ‰Ğ¸Ğ¹ Ñ…ÑƒĞº, Ğ¿Ğ¾Ğ»ÑƒÑ‡Ğ¸Ñ‚ ÑƒĞ¶Ğµ Ğ³Ğ¾Ñ‚Ğ¾Ğ²Ñ‹Ğ¹ Ğ¼Ğ°ÑÑĞ¸Ğ².
        select: (data) => data.items,
        staleTime: 5 * 60 * 1000, // 5 Ğ¼Ğ¸Ğ½ÑƒÑ‚
    });
    // +++ ĞšĞĞĞ•Ğ¦ Ğ˜Ğ—ĞœĞ•ĞĞ•ĞĞ˜Ğ™ +++
}

/**
 * Ğ—Ğ°Ğ¿Ñ€Ğ°ÑˆĞ¸Ğ²Ğ°ĞµÑ‚ Ğ½Ğ¾Ğ²Ñ‹Ğ¹ ÑĞ³ĞµĞ½ĞµÑ€Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ½Ñ‹Ğ¹ ĞºĞ¾Ğ´ Ñ Ğ±ÑĞºĞµĞ½Ğ´Ğ°.
 */
export async function fetchGeneratedPromoCode(): Promise<string> {
    try {
        const response = await api.get<{ generated_code: string }>("/promocodes/generate/new-code");
        return response.data.generated_code;
    } catch (error) {
        toast.error("ĞÑˆĞ¸Ğ±ĞºĞ° Ğ¿Ñ€Ğ¸ Ğ³ĞµĞ½ĞµÑ€Ğ°Ñ†Ğ¸Ğ¸ ĞºĞ¾Ğ´Ğ°");
        console.error("Failed to generate promo code:", error);
        return "";
    }
}

/**
 * Ğ¥ÑƒĞº Ğ´Ğ»Ñ ÑĞ¾Ğ·Ğ´Ğ°Ğ½Ğ¸Ñ Ğ½Ğ¾Ğ²Ğ¾Ğ³Ğ¾ Ğ¿Ñ€Ğ¾Ğ¼Ğ¾ĞºĞ¾Ğ´Ğ°.
 */
export function useCreatePromoCode() {
    const queryClient = useQueryClient();
    return useMutation({
        mutationFn: async (data: PromoCodeCreate) => {
            const response = await api.post<PromoCodeOut>("/promocodes/", data);
            return response.data;
        },
        onSuccess: () => {
            void queryClient.invalidateQueries({ queryKey: PROMO_CODES_QUERY_KEY });
            toast.success("ĞŸÑ€Ğ¾Ğ¼Ğ¾ĞºĞ¾Ğ´ ÑƒÑĞ¿ĞµÑˆĞ½Ğ¾ ÑĞ¾Ğ·Ğ´Ğ°Ğ½");
        },
        onError: (error: any) => {
            toast.error(error?.response?.data?.detail || "ĞÑˆĞ¸Ğ±ĞºĞ° Ğ¿Ñ€Ğ¸ ÑĞ¾Ğ·Ğ´Ğ°Ğ½Ğ¸Ğ¸ Ğ¿Ñ€Ğ¾Ğ¼Ğ¾ĞºĞ¾Ğ´Ğ°");
        },
    });
}

/**
 * Ğ¥ÑƒĞº Ğ´Ğ»Ñ Ğ¾Ğ±Ğ½Ğ¾Ğ²Ğ»ĞµĞ½Ğ¸Ñ Ğ¿Ñ€Ğ¾Ğ¼Ğ¾ĞºĞ¾Ğ´Ğ°.
 */
export function useUpdatePromoCode() {
    const queryClient = useQueryClient();
    return useMutation({
        mutationFn: async ({ id, data }: { id: number; data: PromoCodeUpdate }) => {
            const response = await api.put<PromoCodeOut>(`/promocodes/${id}`, data);
            return response.data;
        },
        onSuccess: (updatedPromoCode) => {
            void queryClient.invalidateQueries({ queryKey: PROMO_CODES_QUERY_KEY });
            toast.success(`ĞŸÑ€Ğ¾Ğ¼Ğ¾ĞºĞ¾Ğ´ "${updatedPromoCode.code}" ÑƒÑĞ¿ĞµÑˆĞ½Ğ¾ Ğ¾Ğ±Ğ½Ğ¾Ğ²Ğ»ĞµĞ½`);
        },
        onError: (error: any) => {
            toast.error(error?.response?.data?.detail || "ĞÑˆĞ¸Ğ±ĞºĞ° Ğ¿Ñ€Ğ¸ Ğ¾Ğ±Ğ½Ğ¾Ğ²Ğ»ĞµĞ½Ğ¸Ğ¸ Ğ¿Ñ€Ğ¾Ğ¼Ğ¾ĞºĞ¾Ğ´Ğ°");
        },
    });
}

/**
 * Ğ¥ÑƒĞº Ğ´Ğ»Ñ ÑƒĞ´Ğ°Ğ»ĞµĞ½Ğ¸Ñ Ğ¿Ñ€Ğ¾Ğ¼Ğ¾ĞºĞ¾Ğ´Ğ°.
 */
export function useDeletePromoCode() {
    const queryClient = useQueryClient();
    return useMutation({
        mutationFn: (id: number) => api.delete(`/promocodes/${id}`),
        onSuccess: () => {
            void queryClient.invalidateQueries({ queryKey: PROMO_CODES_QUERY_KEY });
            toast.success("ĞŸÑ€Ğ¾Ğ¼Ğ¾ĞºĞ¾Ğ´ ÑƒĞ´Ğ°Ğ»ĞµĞ½");
        },
        onError: (error: any) => {
            toast.error(error?.response?.data?.detail || "ĞÑˆĞ¸Ğ±ĞºĞ° Ğ¿Ñ€Ğ¸ ÑƒĞ´Ğ°Ğ»ĞµĞ½Ğ¸Ğ¸ Ğ¿Ñ€Ğ¾Ğ¼Ğ¾ĞºĞ¾Ğ´Ğ°");
        },
    });
}

```


## <a name="srchooksuseAdminRentalsts"></a>`src/hooks/useAdminRentals.ts`

```typescript
// path: src/hooks/useAdminRentals.ts

// src/hooks/useAdminRentals.ts

import { useInfiniteQuery, useMutation, useQueryClient, type QueryFunctionContext } from "@tanstack/react-query";
import { toast } from "sonner";
import { api } from "@/lib/api";
// +++ Ğ˜Ğ—ĞœĞ•ĞĞ•ĞĞ˜Ğ•: Ğ˜Ğ¼Ğ¿Ğ¾Ñ€Ñ‚Ğ¸Ñ€ÑƒĞµĞ¼ Ğ¾Ğ±Ğ½Ğ¾Ğ²Ğ»ĞµĞ½Ğ½Ñ‹Ğµ Ñ‚Ğ¸Ğ¿Ñ‹ +++
import type { AdminRentalListResponse, RentalReturnRequest, AdminRentalOut } from "@/types/rental";


export interface AdminRentalsParams {
    status?: "active" | "overdue" | "completed" | null;
    search?: string;
    limit?: number;
}

const ADMIN_RENTALS_QUERY_KEY = ["adminRentals"];
const ADMIN_RESERVATIONS_QUERY_KEY = "adminReservations";

interface ConvertReservationPayload {
    reservationId: number;
    data: {
        notes_on_issue?: string;
        deposit_amount: number;
        force_issue_on_holiday?: boolean;
    };
}

// +++ ĞĞĞ§ĞĞ›Ğ: ĞĞ‘ĞĞĞ’Ğ›Ğ•ĞĞĞ«Ğ™ Ğ¢Ğ˜ĞŸ Ğ”Ğ›Ğ¯ PAYLOAD Ğ’ĞĞ—Ğ’Ğ ĞĞ¢Ğ +++
interface ReturnRentalPayload {
    rentalId: number;
    data: RentalReturnRequest;
}
// +++ ĞšĞĞĞ•Ğ¦: ĞĞ‘ĞĞĞ’Ğ›Ğ•ĞĞĞĞ“Ğ Ğ¢Ğ˜ĞŸĞ +++


export function useAdminRentals(params: AdminRentalsParams = {}) {
    const { limit = 10, ...otherParams } = params;

    return useInfiniteQuery<AdminRentalListResponse, Error>({
        queryKey: [ADMIN_RENTALS_QUERY_KEY, otherParams],
        queryFn: async ({ pageParam = 0 }: QueryFunctionContext) => {
            const skip = (pageParam as number) * limit;
            const response = await api.get<AdminRentalListResponse>("/admin/rentals/", {
                params: { ...otherParams, skip, limit },
            });
            return response.data;
        },
        initialPageParam: 0,
        getNextPageParam: (lastPage, allPages) => {
            const loadedItems = allPages.reduce((acc, page) => acc + page.items.length, 0);
            if (loadedItems < lastPage.total) {
                return allPages.length;
            }
            return undefined;
        },
        staleTime: 60 * 1000,
    });
}

export function useConvertReservationToRental() {
    const queryClient = useQueryClient();
    return useMutation({
        mutationFn: ({ reservationId, data }: ConvertReservationPayload) =>
            api.post(`/admin/rentals/from-reservation/${reservationId}`, data),
        onSuccess: () => {
            toast.success("Ğ ĞµĞ·ĞµÑ€Ğ² ÑƒÑĞ¿ĞµÑˆĞ½Ğ¾ ĞºĞ¾Ğ½Ğ²ĞµÑ€Ñ‚Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½ Ğ² Ğ°Ñ€ĞµĞ½Ğ´Ñƒ!");
            void queryClient.invalidateQueries({ queryKey: [ADMIN_RENTALS_QUERY_KEY] });
            void queryClient.invalidateQueries({ queryKey: [ADMIN_RESERVATIONS_QUERY_KEY] });
        },
        onError: (error: any) => {
            console.error("Conversion error:", error);
            throw error;
        },
    });
}

export function useDeleteAdminRental() {
    const queryClient = useQueryClient();
    return useMutation({
        mutationFn: (rentalId: number) => api.delete(`/admin/rentals/${rentalId}`),
        onSuccess: () => {
            toast.success("ĞÑ€ĞµĞ½Ğ´Ğ° ÑƒÑĞ¿ĞµÑˆĞ½Ğ¾ ÑƒĞ´Ğ°Ğ»ĞµĞ½Ğ°");
            void queryClient.invalidateQueries({ queryKey: [ADMIN_RENTALS_QUERY_KEY] });
        },
        onError: (error: any) => {
            toast.error(error?.response?.data?.detail || "ĞÑˆĞ¸Ğ±ĞºĞ° Ğ¿Ñ€Ğ¸ ÑƒĞ´Ğ°Ğ»ĞµĞ½Ğ¸Ğ¸ Ğ°Ñ€ĞµĞ½Ğ´Ñ‹");
        },
    });
}

export function useReturnRental() {
    const queryClient = useQueryClient();
    return useMutation({
        // +++ Ğ˜Ğ—ĞœĞ•ĞĞ•ĞĞ˜Ğ•: ĞœÑƒÑ‚Ğ°Ñ†Ğ¸Ñ Ñ‚ĞµĞ¿ĞµÑ€ÑŒ Ğ¿Ñ€Ğ¸Ğ½Ğ¸Ğ¼Ğ°ĞµÑ‚ Ğ½Ğ¾Ğ²Ñ‹Ğ¹ payload +++
        mutationFn: ({ rentalId, data }: ReturnRentalPayload) =>
            api.post(`/admin/rentals/${rentalId}/return`, data),
        onSuccess: (_data, variables) => {
            toast.success("Ğ’Ğ¾Ğ·Ğ²Ñ€Ğ°Ñ‚ Ğ°Ñ€ĞµĞ½Ğ´Ñ‹ ÑƒÑĞ¿ĞµÑˆĞ½Ğ¾ Ğ¾Ñ„Ğ¾Ñ€Ğ¼Ğ»ĞµĞ½!");
            queryClient.setQueryData(
                [ADMIN_RENTALS_QUERY_KEY],
                (oldData: any) => {
                    if (!oldData) return oldData;
                    const newPages = oldData.pages.map((page: AdminRentalListResponse) => ({
                        ...page,
                        items: page.items.filter((rental: AdminRentalOut) => rental.id !== variables.rentalId),
                        total: page.total - 1
                    }));
                    return { ...oldData, pages: newPages };
                }
            );
            void queryClient.invalidateQueries({ queryKey: [ADMIN_RENTALS_QUERY_KEY] });
            void queryClient.invalidateQueries({ queryKey: ["availability"] });
            void queryClient.invalidateQueries({ queryKey: ["calendar-grid"] });
        },
        onError: (error: any) => {
            toast.error(error?.response?.data?.detail || "ĞÑˆĞ¸Ğ±ĞºĞ° Ğ¿Ñ€Ğ¸ Ğ¾Ñ„Ğ¾Ñ€Ğ¼Ğ»ĞµĞ½Ğ¸Ğ¸ Ğ²Ğ¾Ğ·Ğ²Ñ€Ğ°Ñ‚Ğ°");
        },
    });
}

export function useRevertRentalToReservation() {
    const queryClient = useQueryClient();
    return useMutation({
        mutationFn: (rentalId: number) =>
            api.post(`/admin/rentals/${rentalId}/revert-to-reservation`),
        onSuccess: () => {
            toast.success("Ğ’Ñ‹Ğ´Ğ°Ñ‡Ğ° Ğ°Ñ€ĞµĞ½Ğ´Ñ‹ ÑƒÑĞ¿ĞµÑˆĞ½Ğ¾ Ğ¾Ñ‚Ğ¼ĞµĞ½ĞµĞ½Ğ°!");
            void queryClient.invalidateQueries({ queryKey: [ADMIN_RENTALS_QUERY_KEY] });
            void queryClient.invalidateQueries({ queryKey: [ADMIN_RESERVATIONS_QUERY_KEY] });
        },
        onError: (error: any) => {
            const errorMessage = error?.response?.data?.detail || "ĞÑˆĞ¸Ğ±ĞºĞ° Ğ¿Ñ€Ğ¸ Ğ¾Ñ‚Ğ¼ĞµĞ½Ğµ Ğ²Ñ‹Ğ´Ğ°Ñ‡Ğ¸ Ğ°Ñ€ĞµĞ½Ğ´Ñ‹";
            toast.error(errorMessage);
        },
    });
}

```


## <a name="srchooksuseAdminReservationsts"></a>`src/hooks/useAdminReservations.ts`

```typescript
// path: src/hooks/useAdminReservations.ts

// src/hooks/useAdminReservations.ts

import { useInfiniteQuery, useMutation, useQueryClient, type QueryFunctionContext } from "@tanstack/react-query";
import { toast } from "sonner";
import { api } from "@/lib/api";
import type { AdminReservationListResponse } from "@/types/reservation";
import { transformAccessoryLinks } from "@/lib/utils";

export interface AdminReservationsParams {
    status?: "active" | "completed" | "fulfilled" | "cancelled" | "overdue" | null;
    search?: string;
    limit?: number;
}

const ADMIN_RESERVATIONS_QUERY_KEY = ["adminReservations"];

export function useAdminReservations(params: AdminReservationsParams = {}) {
    const { limit = 10, ...otherParams } = params;

    return useInfiniteQuery<AdminReservationListResponse, Error>({
        queryKey: [ADMIN_RESERVATIONS_QUERY_KEY, otherParams],
        queryFn: async ({ pageParam = 0 }: QueryFunctionContext) => {
            const skip = (pageParam as number) * limit;
            const response = await api.get<AdminReservationListResponse>("/admin/reservations/", {
                params: { ...otherParams, skip, limit },
            });
            return response.data;
        },
        initialPageParam: 0,
        getNextPageParam: (lastPage, allPages) => {
            const loadedItems = allPages.reduce((acc, page) => acc + page.items.length, 0);
            if (loadedItems < lastPage.total) {
                return allPages.length;
            }
            return undefined;
        },
        staleTime: 60 * 1000,
        select: (data) => ({
            ...data,
            pages: data.pages.map(page => ({
                ...page,
                items: page.items.map(transformAccessoryLinks)
            }))
        }),
    });
}

export function useCreateAdminReservation() {
    const queryClient = useQueryClient();
    return useMutation({
        mutationFn: (data: any) => api.post("/admin/reservations/", data),
        onSuccess: () => {
            toast.success("Ğ ĞµĞ·ĞµÑ€Ğ² ÑƒÑĞ¿ĞµÑˆĞ½Ğ¾ ÑĞ¾Ğ·Ğ´Ğ°Ğ½");
            void queryClient.invalidateQueries({ queryKey: [ADMIN_RESERVATIONS_QUERY_KEY] });
        },
        onError: (error: any) => {
            toast.error(error?.response?.data?.detail || "ĞÑˆĞ¸Ğ±ĞºĞ° Ğ¿Ñ€Ğ¸ ÑĞ¾Ğ·Ğ´Ğ°Ğ½Ğ¸Ğ¸ Ñ€ĞµĞ·ĞµÑ€Ğ²Ğ°");
        },
    });
}

export function useDeleteAdminReservation() {
    const queryClient = useQueryClient();
    return useMutation({
        mutationFn: (reservationId: number) => api.delete(`/admin/reservations/${reservationId}`),
        onSuccess: () => {
            toast.success("Ğ ĞµĞ·ĞµÑ€Ğ² ÑƒÑĞ¿ĞµÑˆĞ½Ğ¾ ÑƒĞ´Ğ°Ğ»ĞµĞ½");
            void queryClient.invalidateQueries({ queryKey: [ADMIN_RESERVATIONS_QUERY_KEY] });
        },
        onError: (error: any) => {
            toast.error(error?.response?.data?.detail || "ĞÑˆĞ¸Ğ±ĞºĞ° Ğ¿Ñ€Ğ¸ ÑƒĞ´Ğ°Ğ»ĞµĞ½Ğ¸Ğ¸ Ñ€ĞµĞ·ĞµÑ€Ğ²Ğ°");
        },
    });
}

export function useBulkDeleteAdminReservations() {
    const queryClient = useQueryClient();
    return useMutation({
        mutationFn: (reservationIds: number[]) => {
            const payload = { reservation_ids: reservationIds };

            // --- Ğ˜Ğ—ĞœĞ•ĞĞ•ĞĞ˜Ğ•: ĞŸĞĞ›ĞĞĞ¡Ğ¢Ğ¬Ğ® ĞœĞ•ĞĞ¯Ğ•Ğœ ĞŸĞ£Ğ¢Ğ¬ ---
            return api.post(`/admin/reservations/delete-many`, payload);
        },
        onSuccess: () => {
            toast.success("Ğ’Ñ‹Ğ±Ñ€Ğ°Ğ½Ğ½Ñ‹Ğµ Ñ€ĞµĞ·ĞµÑ€Ğ²Ñ‹ ÑƒÑĞ¿ĞµÑˆĞ½Ğ¾ ÑƒĞ´Ğ°Ğ»ĞµĞ½Ñ‹");
            void queryClient.invalidateQueries({ queryKey: [ADMIN_RESERVATIONS_QUERY_KEY] });
        },
        onError: (error: any) => {
            toast.error(error?.response?.data?.detail || "ĞÑˆĞ¸Ğ±ĞºĞ° Ğ¿Ñ€Ğ¸ Ğ¼Ğ°ÑÑĞ¾Ğ²Ğ¾Ğ¼ ÑƒĞ´Ğ°Ğ»ĞµĞ½Ğ¸Ğ¸ Ñ€ĞµĞ·ĞµÑ€Ğ²Ğ¾Ğ²");
        },
    });
}

```


## <a name="srchooksuseAdminUsersts"></a>`src/hooks/useAdminUsers.ts`

```typescript
// path: src/hooks/useAdminUsers.ts

// src/hooks/useAdminUsers.ts

import { useQuery, useInfiniteQuery, useMutation, useQueryClient } from "@tanstack/react-query";
import { UserService } from "@/core/services";
import { toast } from "sonner";
import type { UserListResponse, UserRole, UserPaymentRequest } from "@/types/user";
import type { AdminUserCreateFormSchema, AdminUserUpdateSchema } from "@/lib/validationSchemas";

// Ğ¢Ğ¸Ğ¿ Ğ´Ğ»Ñ Ğ´Ğ°Ğ½Ğ½Ñ‹Ñ…, Ğ¾Ñ‚Ğ¿Ñ€Ğ°Ğ²Ğ»ÑĞµĞ¼Ñ‹Ñ… Ğ¿Ñ€Ğ¸ Ğ¾Ğ±Ğ½Ğ¾Ğ²Ğ»ĞµĞ½Ğ¸Ğ¸
type AdminUserUpdatePayload = {
    userId: number;
    data: AdminUserUpdateSchema;
};

// Ğ¡Ğ¾Ğ·Ğ´Ğ°Ğ½Ğ¸Ğµ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ñ (Ñ‚Ğ¾Ğ»ÑŒĞºĞ¾ Ğ°Ğ´Ğ¼Ğ¸Ğ½Ğ¸ÑÑ‚Ñ€Ğ°Ñ‚Ğ¾Ñ€)
export function useAdminCreateUser() {
    const queryClient = useQueryClient();
    return useMutation({
        mutationFn: async (userData: AdminUserCreateFormSchema) => {
            return await UserService.createUser(userData);
        },
        onSuccess: () => {
            void queryClient.invalidateQueries({ queryKey: ["admin", "users"] });
            toast.success("ĞŸĞ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ÑŒ ÑƒÑĞ¿ĞµÑˆĞ½Ğ¾ ÑĞ¾Ğ·Ğ´Ğ°Ğ½");
        },
        onError: (error: unknown) => {
            const apiError = error as { response?: { data?: { detail?: string } } }
            toast.error(apiError?.response?.data?.detail || "ĞÑˆĞ¸Ğ±ĞºĞ° Ğ¿Ñ€Ğ¸ ÑĞ¾Ğ·Ğ´Ğ°Ğ½Ğ¸Ğ¸ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ñ");
        },
    });
}

// ĞĞ±Ğ½Ğ¾Ğ²Ğ»ĞµĞ½Ğ¸Ğµ Ğ´Ğ°Ğ½Ğ½Ñ‹Ñ… Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ñ (Ğ°Ğ´Ğ¼Ğ¸Ğ½Ğ¸ÑÑ‚Ñ€Ğ°Ñ‚Ğ¾Ñ€/Ğ¼ĞµĞ½ĞµĞ´Ğ¶ĞµÑ€)
export function useAdminUpdateUser() {
    const queryClient = useQueryClient();
    return useMutation({
        mutationFn: async ({ userId, data }: AdminUserUpdatePayload) => {
            return await UserService.updateUser({ id: userId, ...data });
        },
        onSuccess: (updatedUser) => {
            void queryClient.invalidateQueries({ queryKey: ["admin", "users"] });
            toast.success(`ĞŸÑ€Ğ¾Ñ„Ğ¸Ğ»ÑŒ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ñ ${updatedUser.full_name} ÑƒÑĞ¿ĞµÑˆĞ½Ğ¾ Ğ¾Ğ±Ğ½Ğ¾Ğ²Ğ»ĞµĞ½.`);
        },
        onError: (error: unknown) => {
            const apiError = error as { response?: { data?: { detail?: string } } }
            toast.error(apiError?.response?.data?.detail || "ĞÑˆĞ¸Ğ±ĞºĞ° Ğ¿Ñ€Ğ¸ Ğ¾Ğ±Ğ½Ğ¾Ğ²Ğ»ĞµĞ½Ğ¸Ğ¸ Ğ¿Ñ€Ğ¾Ñ„Ğ¸Ğ»Ñ.");
        }
    });
}

// ĞŸĞ¾Ğ»ÑƒÑ‡ĞµĞ½Ğ¸Ğµ Ğ²ÑĞµÑ… Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ĞµĞ¹ Ñ Ğ¿Ğ°Ğ³Ğ¸Ğ½Ğ°Ñ†Ğ¸ĞµĞ¹ (Ğ´Ğ»Ñ Ğ¼ĞµĞ½ĞµĞ´Ğ¶ĞµÑ€Ğ¾Ğ² Ğ¸ Ğ°Ğ´Ğ¼Ğ¸Ğ½Ğ¸ÑÑ‚Ñ€Ğ°Ñ‚Ğ¾Ñ€Ğ¾Ğ²)
export function useAdminUsers() {
    return useInfiniteQuery<UserListResponse>({
        queryKey: ["admin", "users"],
        queryFn: async ({ pageParam = 0 }) => {
            const skip = (pageParam as number) * 15; // 15 Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ĞµĞ¹ Ğ½Ğ° ÑÑ‚Ñ€Ğ°Ğ½Ğ¸Ñ†Ñƒ
            return await UserService.getAllUsers(skip, 15);
        },
        initialPageParam: 0,
        getNextPageParam: (lastPage, allPages) => {
            const totalLoaded = allPages.reduce((acc, page) => acc + page.items.length, 0);
            return totalLoaded < lastPage.total ? allPages.length : undefined;
        },
        staleTime: 5 * 60 * 1000, // 5 Ğ¼Ğ¸Ğ½ÑƒÑ‚
    });
}

// Ğ˜Ğ·Ğ¼ĞµĞ½ĞµĞ½Ğ¸Ğµ Ñ€Ğ¾Ğ»Ğ¸ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ñ (Ñ‚Ğ¾Ğ»ÑŒĞºĞ¾ Ğ°Ğ´Ğ¼Ğ¸Ğ½Ğ¸ÑÑ‚Ñ€Ğ°Ñ‚Ğ¾Ñ€)
export function useUpdateUserRole() {
    const queryClient = useQueryClient();
    return useMutation({
        // Ğ˜Ğ—ĞœĞ•ĞĞ•ĞĞ˜Ğ•: Ğ£ĞºĞ°Ğ·Ñ‹Ğ²Ğ°ĞµĞ¼ ĞºĞ¾Ğ½ĞºÑ€ĞµÑ‚Ğ½Ñ‹Ğ¹ Ñ‚Ğ¸Ğ¿ UserRole Ğ²Ğ¼ĞµÑÑ‚Ğ¾ string
        mutationFn: async ({ userId, newRole }: { userId: number; newRole: UserRole }) => {
            return await UserService.updateUserRole(userId, newRole);
        },
        onSuccess: () => {
            void queryClient.invalidateQueries({ queryKey: ["admin", "users"] });
            toast.success("Ğ Ğ¾Ğ»ÑŒ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ñ ÑƒÑĞ¿ĞµÑˆĞ½Ğ¾ Ğ¸Ğ·Ğ¼ĞµĞ½ĞµĞ½Ğ°");
        },
        onError: (error: unknown) => {
            const apiError = error as { response?: { data?: { detail?: string } } }
            toast.error(apiError?.response?.data?.detail || "ĞÑˆĞ¸Ğ±ĞºĞ° Ğ¿Ñ€Ğ¸ Ğ¸Ğ·Ğ¼ĞµĞ½ĞµĞ½Ğ¸Ğ¸ Ñ€Ğ¾Ğ»Ğ¸");
        },
    });
}

// Ğ‘Ğ»Ğ¾ĞºĞ¸Ñ€Ğ¾Ğ²ĞºĞ° Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ñ (Ñ‚Ğ¾Ğ»ÑŒĞºĞ¾ Ğ°Ğ´Ğ¼Ğ¸Ğ½Ğ¸ÑÑ‚Ñ€Ğ°Ñ‚Ğ¾Ñ€)
export function useBlockUser() {
    const queryClient = useQueryClient();
    return useMutation({
        mutationFn: async (userId: number) => {
            return await UserService.toggleUserStatus(userId, false);
        },
        onSuccess: () => {
            void queryClient.invalidateQueries({ queryKey: ["admin", "users"] });
            toast.success("ĞŸĞ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ÑŒ Ğ·Ğ°Ğ±Ğ»Ğ¾ĞºĞ¸Ñ€Ğ¾Ğ²Ğ°Ğ½");
        },
        onError: (error: unknown) => {
            const apiError = error as { response?: { data?: { detail?: string } } }
            toast.error(apiError?.response?.data?.detail || "ĞÑˆĞ¸Ğ±ĞºĞ° Ğ¿Ñ€Ğ¸ Ğ±Ğ»Ğ¾ĞºĞ¸Ñ€Ğ¾Ğ²ĞºĞµ");
        },
    });
}

// Ğ Ğ°Ğ·Ğ±Ğ»Ğ¾ĞºĞ¸Ñ€Ğ¾Ğ²ĞºĞ° Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ñ (Ñ‚Ğ¾Ğ»ÑŒĞºĞ¾ Ğ°Ğ´Ğ¼Ğ¸Ğ½Ğ¸ÑÑ‚Ñ€Ğ°Ñ‚Ğ¾Ñ€)
export function useUnblockUser() {
    const queryClient = useQueryClient();
    return useMutation({
        mutationFn: async (userId: number) => {
            return await UserService.toggleUserStatus(userId, true);
        },
        onSuccess: () => {
            void queryClient.invalidateQueries({ queryKey: ["admin", "users"] });
            toast.success("ĞŸĞ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ÑŒ Ñ€Ğ°Ğ·Ğ±Ğ»Ğ¾ĞºĞ¸Ñ€Ğ¾Ğ²Ğ°Ğ½");
        },
        onError: (error: unknown) => {
            const apiError = error as { response?: { data?: { detail?: string } } }
            toast.error(apiError?.response?.data?.detail || "ĞÑˆĞ¸Ğ±ĞºĞ° Ğ¿Ñ€Ğ¸ Ñ€Ğ°Ğ·Ğ±Ğ»Ğ¾ĞºĞ¸Ñ€Ğ¾Ğ²ĞºĞµ");
        },
    });
}

// Ğ£Ğ´Ğ°Ğ»ĞµĞ½Ğ¸Ğµ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ñ (Ñ‚Ğ¾Ğ»ÑŒĞºĞ¾ Ğ°Ğ´Ğ¼Ğ¸Ğ½Ğ¸ÑÑ‚Ñ€Ğ°Ñ‚Ğ¾Ñ€)
export function useDeleteUser() {
    const queryClient = useQueryClient();
    return useMutation({
        mutationFn: async (userId: number) => {
            await UserService.deleteUser(userId);
        },
        onSuccess: () => {
            void queryClient.invalidateQueries({ queryKey: ["admin", "users"] });
            toast.success("ĞŸĞ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ÑŒ Ğ¸ ÑĞ²ÑĞ·Ğ°Ğ½Ğ½Ñ‹Ğ¹ ĞºĞ»Ğ¸ĞµĞ½Ñ‚ ÑƒĞ´Ğ°Ğ»ĞµĞ½Ñ‹");
        },
        onError: (error: unknown) => {
            const apiError = error as { response?: { data?: { detail?: string } } }
            toast.error(apiError?.response?.data?.detail || "ĞÑˆĞ¸Ğ±ĞºĞ° Ğ¿Ñ€Ğ¸ ÑƒĞ´Ğ°Ğ»ĞµĞ½Ğ¸Ğ¸");
        },
    });
}

/**
 * Ğ¥ÑƒĞº Ğ´Ğ»Ñ Ğ´Ğ¾Ğ±Ğ°Ğ²Ğ»ĞµĞ½Ğ¸Ñ Ğ¿Ğ»Ğ°Ñ‚ĞµĞ¶Ğ° Ğ¸ Ğ¿Ğ¾Ğ¿Ğ¾Ğ»Ğ½ĞµĞ½Ğ¸Ñ Ğ±Ğ°Ğ»Ğ°Ğ½ÑĞ° Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ñ.
 */
export function useAddUserPayment() {
    const queryClient = useQueryClient();
    return useMutation({
        mutationFn: async ({ userId, data }: { userId: number; data: UserPaymentRequest }) => {
            return await UserService.addUserPayment(userId, data);
        },
        onSuccess: (updatedUser) => {
            void queryClient.invalidateQueries({ queryKey: ["admin", "users"] });
            // ĞœĞ¾Ğ¶Ğ½Ğ¾ Ñ‚Ğ°ĞºĞ¶Ğµ Ñ‚Ğ¾Ñ‡ĞµÑ‡Ğ½Ğ¾ Ğ¾Ğ±Ğ½Ğ¾Ğ²Ğ¸Ñ‚ÑŒ ĞºÑÑˆ ĞºĞ¾Ğ½ĞºÑ€ĞµÑ‚Ğ½Ğ¾Ğ³Ğ¾ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ñ, ĞµÑĞ»Ğ¸ Ğ¾Ğ½ Ğ³Ğ´Ğµ-Ñ‚Ğ¾ Ğ¸ÑĞ¿Ğ¾Ğ»ÑŒĞ·ÑƒĞµÑ‚ÑÑ
            toast.success(`Ğ‘Ğ°Ğ»Ğ°Ğ½Ñ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ñ ${updatedUser.full_name} ÑƒÑĞ¿ĞµÑˆĞ½Ğ¾ Ğ¿Ğ¾Ğ¿Ğ¾Ğ»Ğ½ĞµĞ½.`);
        },
        onError: (error: unknown) => {
            const apiError = error as { response?: { data?: { detail?: string } } };
            toast.error(apiError?.response?.data?.detail || "ĞÑˆĞ¸Ğ±ĞºĞ° Ğ¿Ñ€Ğ¸ Ğ¿Ğ¾Ğ¿Ğ¾Ğ»Ğ½ĞµĞ½Ğ¸Ğ¸ Ğ±Ğ°Ğ»Ğ°Ğ½ÑĞ°.");
        },
    });
}

```


## <a name="srchooksuseAllEquipmentts"></a>`src/hooks/useAllEquipment.ts`

```typescript
// path: src/hooks/useAllEquipment.ts

// src/hooks/useAllEquipment.ts

import { useQuery } from "@tanstack/react-query";
import { EquipmentService } from "@/core/services";
import { handleQueryError } from "@/lib/queryHelpers";

// Ğ­Ñ‚Ğ¾Ñ‚ Ñ…ÑƒĞº Ğ±ÑƒĞ´ĞµÑ‚ Ğ·Ğ°Ğ³Ñ€ÑƒĞ¶Ğ°Ñ‚ÑŒ Ğ’Ğ¡Ğ• Ğ¾Ğ±Ğ¾Ñ€ÑƒĞ´Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ Ğ´Ğ»Ñ Ñ„Ğ¾Ñ€Ğ¼ Ğ¸ Ğ²Ñ‹Ğ¿Ğ°Ğ´Ğ°ÑÑ‰Ğ¸Ñ… ÑĞ¿Ğ¸ÑĞºĞ¾Ğ²
export function useAllEquipment() {
    return useQuery({
        queryKey: ["allEquipment"], // Ğ£Ğ½Ğ¸ĞºĞ°Ğ»ÑŒĞ½Ñ‹Ğ¹ ĞºĞ»ÑÑ‡
        queryFn: async () => {
            try {
                // Ğ—Ğ°Ğ¿Ñ€Ğ°ÑˆĞ¸Ğ²Ğ°ĞµĞ¼ Ğ±Ğ¾Ğ»ÑŒÑˆĞ¾Ğ¹ Ğ»Ğ¸Ğ¼Ğ¸Ñ‚, Ñ‡Ñ‚Ğ¾Ğ±Ñ‹ Ğ¿Ğ¾Ğ»ÑƒÑ‡Ğ¸Ñ‚ÑŒ Ğ²ÑĞµ Ğ·Ğ°Ğ¿Ğ¸ÑĞ¸
                const response = await EquipmentService.getAllEquipment(0, 1000);
                return response.items; // Ğ’Ğ¾Ğ·Ğ²Ñ€Ğ°Ñ‰Ğ°ĞµĞ¼ Ñ‚Ğ¾Ğ»ÑŒĞºĞ¾ Ğ¼Ğ°ÑÑĞ¸Ğ²
            } catch (error) {
                handleQueryError(error);
                throw error;
            }
        },
        staleTime: 60 * 60 * 1000, // ĞšÑÑˆĞ¸Ñ€ÑƒĞµĞ¼ Ğ½Ğ° Ñ‡Ğ°Ñ
    });
}

```


## <a name="srchooksuseAssociationsts"></a>`src/hooks/useAssociations.ts`

```typescript
// path: src/hooks/useAssociations.ts

// src/hooks/useAssociations.ts

import { useQuery } from "@tanstack/react-query";
import { api } from "@/lib/api";
import type { Association, AssociationListResponse } from "@/types/association"; // Ğ˜Ğ¼Ğ¿Ğ¾Ñ€Ñ‚Ğ¸Ñ€ÑƒĞµĞ¼ Ğ¾Ğ±Ğ° Ñ‚Ğ¸Ğ¿Ğ°

const ASSOCIATIONS_QUERY_KEY = ["associations"];

export function useAssociations() {
    // Ğ˜Ğ—ĞœĞ•ĞĞ•ĞĞ˜Ğ•: Ğ¥ÑƒĞº Ñ‚ĞµĞ¿ĞµÑ€ÑŒ Ğ¾Ğ¶Ğ¸Ğ´Ğ°ĞµÑ‚ Association[] ĞºĞ°Ğº ĞºĞ¾Ğ½ĞµÑ‡Ğ½Ñ‹Ğ¹ Ñ€ĞµĞ·ÑƒĞ»ÑŒÑ‚Ğ°Ñ‚ Ğ´Ğ»Ñ ĞºĞ¾Ğ¼Ğ¿Ğ¾Ğ½ĞµĞ½Ñ‚Ğ°
    return useQuery<Association[]>({
        queryKey: ASSOCIATIONS_QUERY_KEY,
        queryFn: async () => {
            // Ğ—Ğ°Ğ¿Ñ€Ğ°ÑˆĞ¸Ğ²Ğ°ĞµĞ¼ Ñƒ API Ğ¾Ğ±ÑŠĞµĞºÑ‚ AssociationListResponse
            const response = await api.get<AssociationListResponse>("/associations/");
            // Ğ Ğ²Ğ¾Ğ·Ğ²Ñ€Ğ°Ñ‰Ğ°ĞµĞ¼ Ñ‚Ğ¾Ğ»ÑŒĞºĞ¾ Ğ¼Ğ°ÑÑĞ¸Ğ² `items`
            return response.data.items;
        },
        staleTime: 5 * 60 * 1000, // 5 Ğ¼Ğ¸Ğ½ÑƒÑ‚
    });
}

```


## <a name="srchooksuseAvailabilityCheckts"></a>`src/hooks/useAvailabilityCheck.ts`

```typescript
// path: src/hooks/useAvailabilityCheck.ts

// src/hooks/useAvailabilityCheck.ts

import { useQuery } from "@tanstack/react-query";
import { useMemo } from "react";
import { AvailabilityService } from "@/core/services";
import type { AvailabilityInfo } from "@/types/availability";
import { handleQueryError } from "@/lib/queryHelpers";

export interface UseAvailabilityCheckProps {
    equipmentIds: number[];
    startDate: Date;
    endDate: Date;
    excludeReservationId?: number;
    enabled?: boolean;
}

export interface UseAvailabilityCheckReturn {
    isLoading: boolean;
    isError: boolean;
    availabilityMap: Record<number, AvailabilityInfo>;
    conflictingItemIds: number[];
    hasConflicts: boolean;
    error: Error | null;
}

/**
 * Ğ¦ĞµĞ½Ñ‚Ñ€Ğ°Ğ»ÑŒĞ½Ñ‹Ğ¹ Ñ…ÑƒĞº Ğ´Ğ»Ñ Ğ¿Ñ€Ğ¾Ğ²ĞµÑ€ĞºĞ¸ Ğ´Ğ¾ÑÑ‚ÑƒĞ¿Ğ½Ğ¾ÑÑ‚Ğ¸ Ğ¾Ğ±Ğ¾Ñ€ÑƒĞ´Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ.
 * Ğ˜ÑĞ¿Ğ¾Ğ»ÑŒĞ·ÑƒĞµÑ‚ useQuery Ğ¸Ğ· @tanstack/react-query Ğ´Ğ»Ñ Ğ¿Ğ¾Ğ»ÑƒÑ‡ĞµĞ½Ğ¸Ñ Ğ¸ ĞºÑÑˆĞ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ Ğ´Ğ°Ğ½Ğ½Ñ‹Ñ… Ğ¾ Ğ´Ğ¾ÑÑ‚ÑƒĞ¿Ğ½Ğ¾ÑÑ‚Ğ¸.
 * 
 * @param props - ĞŸĞ°Ñ€Ğ°Ğ¼ĞµÑ‚Ñ€Ñ‹ Ğ´Ğ»Ñ Ğ¿Ñ€Ğ¾Ğ²ĞµÑ€ĞºĞ¸ Ğ´Ğ¾ÑÑ‚ÑƒĞ¿Ğ½Ğ¾ÑÑ‚Ğ¸
 * @returns ĞĞ±ÑŠĞµĞºÑ‚ Ñ Ğ´Ğ°Ğ½Ğ½Ñ‹Ğ¼Ğ¸ Ğ¾ Ğ´Ğ¾ÑÑ‚ÑƒĞ¿Ğ½Ğ¾ÑÑ‚Ğ¸ Ğ¸ ÑÑ‚Ğ°Ñ‚ÑƒÑĞ¾Ğ¼ Ğ·Ğ°Ğ³Ñ€ÑƒĞ·ĞºĞ¸
 */
export function useAvailabilityCheck({
    equipmentIds,
    startDate,
    endDate,
    excludeReservationId,
    enabled = true
}: UseAvailabilityCheckProps): UseAvailabilityCheckReturn {
    
    // Ğ¤Ğ¾Ñ€Ğ¼Ğ¸Ñ€ÑƒĞµĞ¼ ÑƒĞ½Ğ¸ĞºĞ°Ğ»ÑŒĞ½Ñ‹Ğ¹ queryKey Ğ½Ğ° Ğ¾ÑĞ½Ğ¾Ğ²Ğµ Ğ²Ñ…Ğ¾Ğ´Ğ½Ñ‹Ñ… Ğ¿Ğ°Ñ€Ğ°Ğ¼ĞµÑ‚Ñ€Ğ¾Ğ²
    const queryKey = useMemo(() => {
        const stringifiedIds = JSON.stringify([...equipmentIds].sort((a, b) => a - b));
        return [
            "availability-check",
            stringifiedIds,
            startDate.toISOString(),
            endDate.toISOString(),
            excludeReservationId
        ] as const;
    }, [equipmentIds, startDate, endDate, excludeReservationId]);

    // ĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑĞµĞ¼ Ğ²Ğ°Ğ»Ğ¸Ğ´Ğ½Ğ¾ÑÑ‚ÑŒ Ğ¿Ğ°Ñ€Ğ°Ğ¼ĞµÑ‚Ñ€Ğ¾Ğ²
    const isParamsValid = useMemo(() => {
        return !!(
            equipmentIds.length > 0 &&
            startDate && !isNaN(startDate.getTime()) &&
            endDate && !isNaN(endDate.getTime()) &&
            startDate <= endDate
        );
    }, [equipmentIds, startDate, endDate]);

    const query = useQuery({
        queryKey,
        queryFn: async (): Promise<AvailabilityInfo[]> => {
            if (!isParamsValid) return [];
            
            try {
                return await AvailabilityService.getStatuses({
                    equipmentIds,
                    startDate,
                    endDate,
                    excludeReservationId
                });
            } catch (error: unknown) {
                console.error("[useAvailabilityCheck] Error fetching availability:", error);
                handleQueryError(error);
                throw error;
            }
        },
        enabled: enabled && isParamsValid,
        staleTime: 30 * 1000, // 30 ÑĞµĞºÑƒĞ½Ğ´
        gcTime: 5 * 60 * 1000, // 5 Ğ¼Ğ¸Ğ½ÑƒÑ‚
    });

    // ĞĞ±Ñ€Ğ°Ğ±Ğ°Ñ‚Ñ‹Ğ²Ğ°ĞµĞ¼ Ğ´Ğ°Ğ½Ğ½Ñ‹Ğµ Ğ¸ ÑĞ¾Ğ·Ğ´Ğ°ĞµĞ¼ ĞºĞ°Ñ€Ñ‚Ñƒ Ğ´Ğ¾ÑÑ‚ÑƒĞ¿Ğ½Ğ¾ÑÑ‚Ğ¸
    const processedData = useMemo(() => {
        const availabilityData = query.data || [];
        
        // Ğ¡Ğ¾Ğ·Ğ´Ğ°ĞµĞ¼ ĞºĞ°Ñ€Ñ‚Ñƒ Ğ´Ğ¾ÑÑ‚ÑƒĞ¿Ğ½Ğ¾ÑÑ‚Ğ¸ Ğ´Ğ»Ñ Ğ±Ñ‹ÑÑ‚Ñ€Ğ¾Ğ³Ğ¾ Ğ´Ğ¾ÑÑ‚ÑƒĞ¿Ğ°
        const availabilityMap: Record<number, AvailabilityInfo> = {};
        availabilityData.forEach((info) => {
            availabilityMap[info.equipment_id] = info;
        });

        // ĞĞ°Ñ…Ğ¾Ğ´Ğ¸Ğ¼ ID Ğ²ÑĞµÑ… ĞºĞ¾Ğ½Ñ„Ğ»Ğ¸ĞºÑ‚Ğ½Ñ‹Ñ… Ğ¿Ğ¾Ğ·Ğ¸Ñ†Ğ¸Ğ¹
        const conflictingItemIds = availabilityData
            .filter(info => info.status === "reserved" || info.status === "rented")
            .map(info => info.equipment_id);

        return {
            availabilityMap,
            conflictingItemIds,
            hasConflicts: conflictingItemIds.length > 0
        };
    }, [query.data]);

    return {
        isLoading: query.isLoading,
        isError: query.isError,
        availabilityMap: processedData.availabilityMap,
        conflictingItemIds: processedData.conflictingItemIds,
        hasConflicts: processedData.hasConflicts,
        error: query.error
    };
}


```


## <a name="srchooksuseBalanceHistoryts"></a>`src/hooks/useBalanceHistory.ts`

```typescript
// path: src/hooks/useBalanceHistory.ts

// src/hooks/useBalanceHistory.ts

import { useQuery } from "@tanstack/react-query";
import { UserService } from "@/core/services";
import type { BalanceHistoryListResponse } from "@/types/balanceHistory";
import { useCurrentUser } from "./useProfile";

const PAGE_SIZE = 15;

/**
 * Ğ¥ÑƒĞº Ğ´Ğ»Ñ Ğ¿Ğ¾Ğ»ÑƒÑ‡ĞµĞ½Ğ¸Ñ Ğ¿Ğ°Ğ³Ğ¸Ğ½Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ½Ğ¾Ğ¹ Ğ¸ÑÑ‚Ğ¾Ñ€Ğ¸Ğ¸ Ğ±Ğ°Ğ»Ğ°Ğ½ÑĞ° Ğ¢Ğ•ĞšĞ£Ğ©Ğ•Ğ“Ğ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ñ.
 */
export function useBalanceHistory(page: number) {
    const { data: user } = useCurrentUser();

    return useQuery<BalanceHistoryListResponse>({
        queryKey: ["balanceHistory", "me", page],
        queryFn: async () => {
            const skip = (page - 1) * PAGE_SIZE;
            return await UserService.getMyBalanceHistory(skip, PAGE_SIZE);
        },
        enabled: !!user, // Ğ’Ñ‹Ğ¿Ğ¾Ğ»Ğ½ÑÑ‚ÑŒ Ğ·Ğ°Ğ¿Ñ€Ğ¾Ñ Ñ‚Ğ¾Ğ»ÑŒĞºĞ¾ ĞµÑĞ»Ğ¸ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ÑŒ Ğ°Ğ²Ñ‚Ğ¾Ñ€Ğ¸Ğ·Ğ¾Ğ²Ğ°Ğ½
        staleTime: 60 * 1000, // 1 Ğ¼Ğ¸Ğ½ÑƒÑ‚Ğ°
    });
}

/**
 * Ğ¥ÑƒĞº Ğ´Ğ»Ñ Ğ¿Ğ¾Ğ»ÑƒÑ‡ĞµĞ½Ğ¸Ñ Ğ¿Ğ°Ğ³Ğ¸Ğ½Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ½Ğ¾Ğ¹ Ğ¸ÑÑ‚Ğ¾Ñ€Ğ¸Ğ¸ Ğ±Ğ°Ğ»Ğ°Ğ½ÑĞ° Ğ›Ğ®Ğ‘ĞĞ“Ğ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ñ (Ğ´Ğ»Ñ Ğ°Ğ´Ğ¼Ğ¸Ğ½Ğ¾Ğ²).
 */
export function useAdminBalanceHistory(userId: number, page: number) {
    const { data: currentUser } = useCurrentUser();
    const isManager = currentUser?.role === 'admin' || currentUser?.role === 'manager';

    return useQuery<BalanceHistoryListResponse>({
        queryKey: ["balanceHistory", "admin", userId, page],
        queryFn: async () => {
            const skip = (page - 1) * PAGE_SIZE;
            return await UserService.getUserBalanceHistory(userId, skip, PAGE_SIZE);
        },
        enabled: isManager && !!userId, // Ğ’Ñ‹Ğ¿Ğ¾Ğ»Ğ½ÑÑ‚ÑŒ Ğ·Ğ°Ğ¿Ñ€Ğ¾Ñ Ñ‚Ğ¾Ğ»ÑŒĞºĞ¾ ĞµÑĞ»Ğ¸ Ñ‚ĞµĞºÑƒÑ‰Ğ¸Ğ¹ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ÑŒ - Ğ°Ğ´Ğ¼Ğ¸Ğ½/Ğ¼ĞµĞ½ĞµĞ´Ğ¶ĞµÑ€
        staleTime: 60 * 1000,
    });
}

```


## <a name="srchooksuseCalendarGridts"></a>`src/hooks/useCalendarGrid.ts`

```typescript
// path: src/hooks/useCalendarGrid.ts

// src/hooks/useCalendarGrid.ts

import { useQuery } from "@tanstack/react-query"
import { useDateStore } from "@/store/dateStore"
import { useFilterStore } from "@/store/filterStore"
import { useSearchStore } from "@/store/searchStore"
import { useEquipment } from "./useEquipment"
import { formatDate } from "@/lib/utils"
import { CalendarService } from "@/core/services"
import type { CalendarGridData } from "@/core/services"
import { useMemo } from "react" // <-- Ğ”Ğ¾Ğ±Ğ°Ğ²Ğ»ÑĞµĞ¼ Ğ¸Ğ¼Ğ¿Ğ¾Ñ€Ñ‚ useMemo

export function useCalendarGrid() {
    const { startDate, endDate } = useDateStore()
    const { type, brand } = useFilterStore()
    const { query } = useSearchStore()
    // Ğ˜Ğ—ĞœĞ•ĞĞ•ĞĞ˜Ğ•: useEquipment Ğ²Ğ¾Ğ·Ğ²Ñ€Ğ°Ñ‰Ğ°ĞµÑ‚ Ğ¾Ğ±ÑŠĞµĞºÑ‚ ÑĞ¾ ÑÑ‚Ñ€Ğ°Ğ½Ğ¸Ñ†Ğ°Ğ¼Ğ¸, Ğ° Ğ½Ğµ Ğ¿Ñ€Ğ¾ÑÑ‚Ğ¾ Ğ´Ğ°Ğ½Ğ½Ñ‹Ğµ
    const { data: equipmentPages, isLoading: isLoadingEquipment } = useEquipment()

    // Ğ˜Ğ—ĞœĞ•ĞĞ•ĞĞ˜Ğ•: "Ğ Ğ°Ğ·Ğ²Ğ¾Ñ€Ğ°Ñ‡Ğ¸Ğ²Ğ°ĞµĞ¼" Ğ²ÑĞµ ÑÑ‚Ñ€Ğ°Ğ½Ğ¸Ñ†Ñ‹ Ğ² Ğ¾Ğ´Ğ¸Ğ½ Ğ¿Ğ»Ğ¾ÑĞºĞ¸Ğ¹ Ğ¼Ğ°ÑÑĞ¸Ğ²
    const allEquipment = useMemo(() =>
            equipmentPages?.pages.flatMap(page => page.items) ?? [],
        [equipmentPages]);

    // Ğ¢ĞµĞ¿ĞµÑ€ÑŒ Ñ„Ğ¸Ğ»ÑŒÑ‚Ñ€ÑƒĞµĞ¼ Ğ¿Ñ€Ğ°Ğ²Ğ¸Ğ»ÑŒĞ½Ñ‹Ğ¹ Ğ¼Ğ°ÑÑĞ¸Ğ² allEquipment
    const filteredIds = CalendarService.filterEquipmentForCalendar(
        allEquipment,
        {
            type: type || undefined,
            brand: brand || undefined,
            query: query || undefined
        }
    )

    const formattedStartDateAPI = startDate ? formatDate(startDate) : null
    const formattedEndDateAPI = endDate ? formatDate(endDate) : null

    const enabled =
        !!formattedStartDateAPI &&
        !!formattedEndDateAPI &&
        !isLoadingEquipment &&
        filteredIds.length > 0

    const queryKey = CalendarService.createQueryKey(
        formattedStartDateAPI!,
        formattedEndDateAPI!,
        filteredIds
    )

    return useQuery<CalendarGridData>({
        queryKey: queryKey,
        queryFn: async () => {
            if (!formattedStartDateAPI || !formattedEndDateAPI) {
                return {}
            }
            if (filteredIds.length === 0) {
                return {}
            }

            return CalendarService.getDayStatuses(
                formattedStartDateAPI,
                formattedEndDateAPI,
                filteredIds
            )
        },
        enabled,
        staleTime: 60 * 1000,
        placeholderData: (previousData) => previousData,
    })
}

```


## <a name="srchooksuseDailyAvailabilityts"></a>`src/hooks/useDailyAvailability.ts`

```typescript
// path: src/hooks/useDailyAvailability.ts

// src/hooks/useDailyAvailability.ts
import { useQuery } from "@tanstack/react-query";
import { api } from "@/lib/api";
import { formatDate } from "@/lib/utils";
import type { DayStatus } from "@/types/availability";

type DailyAvailabilityData = Record<number, Record<string, DayStatus>>; // { equipmentId: { "DD.MM.YYYY": DayStatus } }

type Params = {
    ids: number[];
    start: Date;
    end: Date;
};

export function useDailyAvailability({ ids, start, end }: Params) {
    const formattedStartDate = formatDate(start);
    const formattedEndDate = formatDate(end);

    // Sort IDs to ensure consistent query key
    const sortedIds = JSON.stringify([...ids].sort((a, b) => a - b));

    return useQuery<DailyAvailabilityData>({
        queryKey: ["daily-availability", sortedIds, formattedStartDate, formattedEndDate],
        queryFn: async () => {
            const resp = await api.get("/calendar/day-statuses", {
                params: {
                    start: formattedStartDate,
                    end: formattedEndDate,
                    ids,
                },
            });
            // The actual data is nested inside equipment_day_statuses
            const result = resp.data?.equipment_day_statuses ?? {};
            

            
            return result;
        },
        enabled: ids.length > 0 && !!start && !!end,
        staleTime: 5 * 60 * 1000, // 5 mins
    });
}

```


## <a name="srchooksuseDateRangets"></a>`src/hooks/useDateRange.ts`

```typescript
// path: src/hooks/useDateRange.ts

// src/hooks/useDateRange.ts

import { useState, useEffect } from 'react';
import { formatDate } from '@/lib/utils';
import { DateService } from '@/core/services';

interface UseDateRangeProps {
    startDate: Date;
    endDate: Date;
    onRangeChange: (startDate: Date, endDate: Date, source?: 'calendar' | 'slider' | 'manual', holidays?: Date[]) => void;
    holidays?: Date[];
}

interface UseDateRangeReturn {
    localStartDate: string;
    localEndDate: string;
    handleStartDateChange: (e: React.ChangeEvent<HTMLInputElement>) => void;
    handleEndDateChange: (e: React.ChangeEvent<HTMLInputElement>) => void;
}

export function useDateRange({
                                 startDate,
                                 endDate,
                                 onRangeChange,
                                 holidays = [] // Ğ£ÑÑ‚Ğ°Ğ½Ğ°Ğ²Ğ»Ğ¸Ğ²Ğ°ĞµĞ¼ Ğ·Ğ½Ğ°Ñ‡ĞµĞ½Ğ¸Ğµ Ğ¿Ğ¾ ÑƒĞ¼Ğ¾Ğ»Ñ‡Ğ°Ğ½Ğ¸Ñ
                             }: UseDateRangeProps): UseDateRangeReturn {
    // Ğ›Ğ¾ĞºĞ°Ğ»ÑŒĞ½Ğ¾Ğµ ÑĞ¾ÑÑ‚Ğ¾ÑĞ½Ğ¸Ğµ Ğ´Ğ»Ñ input'Ğ¾Ğ² Ğ²ÑĞµĞ³Ğ´Ğ° Ğ² Ñ„Ğ¾Ñ€Ğ¼Ğ°Ñ‚Ğµ 'YYYY-MM-DD'
    const [localStartDate, setLocalStartDate] = useState<string>(formatDate(startDate));
    const [localEndDate, setLocalEndDate] = useState<string>(formatDate(endDate));

    // Ğ¡Ğ¸Ğ½Ñ…Ñ€Ğ¾Ğ½Ğ¸Ğ·Ğ¸Ñ€ÑƒĞµĞ¼ Ğ»Ğ¾ĞºĞ°Ğ»ÑŒĞ½Ğ¾Ğµ ÑĞ¾ÑÑ‚Ğ¾ÑĞ½Ğ¸Ğµ, ĞµÑĞ»Ğ¸ Ğ¿Ñ€Ğ¾Ğ¿ÑÑ‹ Ğ¸Ğ·Ğ¼ĞµĞ½Ğ¸Ğ»Ğ¸ÑÑŒ Ğ¸Ğ·Ğ²Ğ½Ğµ
    useEffect(() => {
        setLocalStartDate(formatDate(startDate));
        setLocalEndDate(formatDate(endDate));
    }, [startDate, endDate]);

    const handleStartDateChange = (e: React.ChangeEvent<HTMLInputElement>) => {
        const newStartDate = new Date(e.target.value);
        if (DateService.isValidDate(newStartDate)) {
            // Ğ•ÑĞ»Ğ¸ Ğ´Ğ°Ñ‚Ğ° Ğ¾ĞºĞ¾Ğ½Ñ‡Ğ°Ğ½Ğ¸Ñ Ğ¾ĞºĞ°Ğ·Ğ°Ğ»Ğ°ÑÑŒ Ñ€Ğ°Ğ½ÑŒÑˆĞµ Ğ½Ğ¾Ğ²Ğ¾Ğ¹ Ğ´Ğ°Ñ‚Ñ‹ Ğ½Ğ°Ñ‡Ğ°Ğ»Ğ°, ĞºĞ¾Ñ€Ñ€ĞµĞºÑ‚Ğ¸Ñ€ÑƒĞµĞ¼ ĞµĞµ
            const adjustedRange = DateService.adjustDateRange(newStartDate, endDate);
            // Ğ’Ñ‹Ğ·Ñ‹Ğ²Ğ°ĞµĞ¼ ĞºĞ¾Ğ»Ğ±ÑĞº Ñ Ğ¾Ğ±ÑŠĞµĞºÑ‚Ğ°Ğ¼Ğ¸ Date Ğ¸ Ğ¿ĞµÑ€ĞµĞ´Ğ°ĞµĞ¼ holidays
            onRangeChange(adjustedRange.startDate, adjustedRange.endDate, 'manual', holidays);
        }
    };

    const handleEndDateChange = (e: React.ChangeEvent<HTMLInputElement>) => {
        const newEndDate = new Date(e.target.value);
        if (DateService.isValidDate(newEndDate)) {
            // Ğ•ÑĞ»Ğ¸ Ğ´Ğ°Ñ‚Ğ° Ğ¾ĞºĞ¾Ğ½Ñ‡Ğ°Ğ½Ğ¸Ñ Ğ¾ĞºĞ°Ğ·Ğ°Ğ»Ğ°ÑÑŒ Ñ€Ğ°Ğ½ÑŒÑˆĞµ Ğ´Ğ°Ñ‚Ñ‹ Ğ½Ğ°Ñ‡Ğ°Ğ»Ğ°, ĞºĞ¾Ñ€Ñ€ĞµĞºÑ‚Ğ¸Ñ€ÑƒĞµĞ¼ ĞµĞµ
            const adjustedRange = DateService.adjustDateRange(startDate, newEndDate);
            // Ğ’Ñ‹Ğ·Ñ‹Ğ²Ğ°ĞµĞ¼ ĞºĞ¾Ğ»Ğ±ÑĞº Ñ Ğ¾Ğ±ÑŠĞµĞºÑ‚Ğ°Ğ¼Ğ¸ Date Ğ¸ Ğ¿ĞµÑ€ĞµĞ´Ğ°ĞµĞ¼ holidays
            onRangeChange(adjustedRange.startDate, adjustedRange.endDate, 'manual', holidays);
        }
    };

    return {
        localStartDate,
        localEndDate,
        handleStartDateChange,
        handleEndDateChange,
    };
}

```


## <a name="srchooksuseEditReservationts"></a>`src/hooks/useEditReservation.ts`

```typescript
// path: src/hooks/useEditReservation.ts

// src/hooks/useEditReservation.ts
import { useMutation, useQueryClient } from "@tanstack/react-query";
import { ReservationService } from "@/core/services";

interface EditReservationInput {
    id: number;
    start_date: string;
    end_date: string;
    equipment_ids: number[];
    promo_code?: string;
    selected_accessories?: Record<number, number[]>;
    isAdminContext?: boolean;
    // âœ¨ ĞĞĞ’Ğ«Ğ™ Ğ¤Ğ›ĞĞ“
    confirm_date_adjustment?: boolean;
}

export function useEditReservation() {
    const queryClient = useQueryClient();

    return useMutation({
        mutationFn: async (data: EditReservationInput) => {
            console.log(`[useEditReservation] ĞÑ‚Ğ¿Ñ€Ğ°Ğ²ĞºĞ° Ğ·Ğ°Ğ¿Ñ€Ğ¾ÑĞ° Ğ½Ğ° Ğ¾Ğ±Ğ½Ğ¾Ğ²Ğ»ĞµĞ½Ğ¸Ğµ Ñ€ĞµĞ·ĞµÑ€Ğ²Ğ° ${data.id}`);
            console.log(`[useEditReservation] Ğ”Ğ°Ğ½Ğ½Ñ‹Ğµ:`, data);

            const { id, isAdminContext, ...payload } = data;
            
            // ĞŸÑ€ĞµĞ¾Ğ±Ñ€Ğ°Ğ·ÑƒĞµĞ¼ Ğ´Ğ°Ğ½Ğ½Ñ‹Ğµ Ğ² Ñ„Ğ¾Ñ€Ğ¼Ğ°Ñ‚, Ğ¾Ğ¶Ğ¸Ğ´Ğ°ĞµĞ¼Ñ‹Ğ¹ ÑĞµÑ€Ğ²Ğ¸ÑĞ¾Ğ¼
            const servicePayload = {
                id,
                start_date: payload.start_date,
                end_date: payload.end_date,
                equipment_ids: payload.equipment_ids,
                selected_accessories: payload.selected_accessories || {},
                promo_code: payload.promo_code,
                isAdminContext
            };

            console.log(`[useEditReservation] ĞÑ‚Ğ¿Ñ€Ğ°Ğ²ĞºĞ° Ğ·Ğ°Ğ¿Ñ€Ğ¾ÑĞ° Ñ‡ĞµÑ€ĞµĞ· ÑĞµÑ€Ğ²Ğ¸Ñ`);

            const response = await ReservationService.updateReservation(servicePayload);

            console.log(`[useEditReservation] ĞÑ‚Ğ²ĞµÑ‚ ÑĞµÑ€Ğ²ĞµÑ€Ğ°:`, response);
            return response;
        },
        onSuccess: async (_data, variables) => {
            console.log(`[useEditReservation] Ğ£ÑĞ¿ĞµÑˆĞ½Ğ¾Ğµ Ğ¾Ğ±Ğ½Ğ¾Ğ²Ğ»ĞµĞ½Ğ¸Ğµ Ñ€ĞµĞ·ĞµÑ€Ğ²Ğ° ${variables.id}`);
            if (variables.isAdminContext) {
                await queryClient.invalidateQueries({ queryKey: ["adminReservations"] });
            }
            await queryClient.invalidateQueries({ queryKey: ["reservations"] });
            await queryClient.invalidateQueries({ queryKey: ["availability"] });
            await queryClient.invalidateQueries({ queryKey: ["calendar-grid"] });
        },
        onError: (error: unknown, variables) => {
            console.error(`[useEditReservation] ĞÑˆĞ¸Ğ±ĞºĞ° Ğ¿Ñ€Ğ¸ Ğ¾Ğ±Ğ½Ğ¾Ğ²Ğ»ĞµĞ½Ğ¸Ğ¸ Ñ€ĞµĞ·ĞµÑ€Ğ²Ğ° ${variables.id}:`, error);
        },
    });
}

```


## <a name="srchooksuseEquipmentts"></a>`src/hooks/useEquipment.ts`

```typescript
// path: src/hooks/useEquipment.ts

// src/hooks/useEquipment.ts

import { useInfiniteQuery, type QueryFunctionContext } from "@tanstack/react-query";
import { EquipmentService, type EquipmentListResponse, type EquipmentFilterParams } from "@/core/services/EquipmentService";
import { handleQueryError } from "@/lib/queryHelpers";
import { PAGINATION_CONSTANTS } from "@/constants/paginationConstants";
import { formatDate } from "@/lib/utils";

export function useEquipment(filters: EquipmentFilterParams = {}) {
    // Ğ”ĞµÑÑ‚Ñ€ÑƒĞºÑ‚ÑƒÑ€Ğ¸Ñ€ÑƒĞµĞ¼ Ğ²ÑĞµ Ğ²Ğ¾Ğ·Ğ¼Ğ¾Ğ¶Ğ½Ñ‹Ğµ Ñ„Ğ¸Ğ»ÑŒÑ‚Ñ€Ñ‹
    const { query, type, brand, associationId, availableOnly, startDate, endDate } = filters;

    return useInfiniteQuery<EquipmentListResponse, Error>({
        // Ğ”Ğ¾Ğ±Ğ°Ğ²Ğ»ÑĞµĞ¼ Ğ½Ğ¾Ğ²Ñ‹Ğµ Ğ¿Ğ°Ñ€Ğ°Ğ¼ĞµÑ‚Ñ€Ñ‹ Ğ² ĞºĞ»ÑÑ‡ Ğ·Ğ°Ğ¿Ñ€Ğ¾ÑĞ° Ğ´Ğ»Ñ ĞºĞ¾Ñ€Ñ€ĞµĞºÑ‚Ğ½Ğ¾Ğ³Ğ¾ ĞºÑÑˆĞ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ
        queryKey: ["equipment", {
            query,
            type,
            brand,
            associationId,
            availableOnly,
            // Ğ˜ÑĞ¿Ğ¾Ğ»ÑŒĞ·ÑƒĞµĞ¼ Ğ¾Ñ‚Ñ„Ğ¾Ñ€Ğ¼Ğ°Ñ‚Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ½Ñ‹Ğµ Ğ´Ğ°Ñ‚Ñ‹ Ğ² ĞºĞ»ÑÑ‡Ğµ, Ñ‡Ñ‚Ğ¾Ğ±Ñ‹ Ğ¸Ğ·Ğ±ĞµĞ¶Ğ°Ñ‚ÑŒ Ğ¿Ñ€Ğ¾Ğ±Ğ»ĞµĞ¼ Ñ Ğ¾Ğ±ÑŠĞµĞºÑ‚Ğ°Ğ¼Ğ¸ Date
            startDate: startDate ? formatDate(startDate) : undefined,
            endDate: endDate ? formatDate(endDate) : undefined,
        }],

        queryFn: async ({ pageParam = 0 }: QueryFunctionContext): Promise<EquipmentListResponse> => {
            const pageSize = PAGINATION_CONSTANTS.HOME_PAGE_SIZE;
            const skip = (pageParam as number) * pageSize;
            try {
                // ĞŸĞµÑ€ĞµĞ´Ğ°ĞµĞ¼ Ğ²ĞµÑÑŒ Ğ¾Ğ±ÑŠĞµĞºÑ‚ filters Ğ² ÑĞµÑ€Ğ²Ğ¸Ñ
                return await EquipmentService.getAllEquipment(skip, pageSize, filters);
            } catch (error) {
                handleQueryError(error);
                throw error; // ĞŸÑ€Ğ¾Ğ±Ñ€Ğ°ÑÑ‹Ğ²Ğ°ĞµĞ¼ Ğ¾ÑˆĞ¸Ğ±ĞºÑƒ Ğ´Ğ°Ğ»ÑŒÑˆĞµ Ğ´Ğ»Ñ react-query
            }
        },
        initialPageParam: 0,
        getNextPageParam: (lastPage, allPages) => {
            const loadedItems = allPages.flatMap(page => page.items).length;

            if (loadedItems < lastPage.total) {
                return allPages.length;
            }
            return undefined;
        },
        staleTime: 5 * 60 * 1000, // 5 Ğ¼Ğ¸Ğ½ÑƒÑ‚
    });
}

```


## <a name="srchooksuseEquipmentAvailabilityts"></a>`src/hooks/useEquipmentAvailability.ts`

```typescript
// path: src/hooks/useEquipmentAvailability.ts

import { useQuery } from "@tanstack/react-query";
import { api } from "@/lib/api";

interface EquipmentAvailability {
    hasActiveReservations: boolean;
    hasActiveRentals: boolean;
    activeReservationsCount: number;
    activeRentalsCount: number;
}

export function useEquipmentAvailability(equipmentId: number) {
    return useQuery({
        queryKey: ["equipment-availability", equipmentId],
        queryFn: async () => {
            const response = await api.get<EquipmentAvailability>(`/equipment/${equipmentId}/availability`);
            return response.data;
        },
    });
} 

```


## <a name="srchooksuseEquipmentMapts"></a>`src/hooks/useEquipmentMap.ts`

```typescript
// path: src/hooks/useEquipmentMap.ts

// src/hooks/useEquipmentMap.ts

import { useMemo } from "react";
import type { Equipment } from "@/types/equipment";
import type { InfiniteData } from "@tanstack/react-query";
import type { EquipmentListResponse } from "@/core/services";

/**
 * Ğ¥ÑƒĞº Ğ´Ğ»Ñ ÑĞ¾Ğ·Ğ´Ğ°Ğ½Ğ¸Ñ ĞºĞ°Ñ€Ñ‚Ñ‹ Ğ¾Ğ±Ğ¾Ñ€ÑƒĞ´Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ Ğ¿Ğ¾ ID Ğ¸Ğ· Ğ´Ğ°Ğ½Ğ½Ñ‹Ñ… useInfiniteQuery
 * @param equipmentPages - ĞĞ±ÑŠĞµĞºÑ‚ InfiniteData, Ğ²Ğ¾Ğ·Ğ²Ñ€Ğ°Ñ‰Ğ°ĞµĞ¼Ñ‹Ğ¹ Ñ…ÑƒĞºĞ¾Ğ¼ useEquipment
 * @returns ĞšĞ°Ñ€Ñ‚Ğ° Ğ¾Ğ±Ğ¾Ñ€ÑƒĞ´Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ, Ğ³Ğ´Ğµ ĞºĞ»ÑÑ‡ - ID Ğ¾Ğ±Ğ¾Ñ€ÑƒĞ´Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ
 */
export const useEquipmentMap = (equipmentPages: InfiniteData<EquipmentListResponse, unknown> | undefined) => {
    return useMemo(() => {
        // Ğ˜Ğ—ĞœĞ•ĞĞ•ĞĞ˜Ğ•: "Ğ Ğ°Ğ·Ğ²Ğ¾Ñ€Ğ°Ñ‡Ğ¸Ğ²Ğ°ĞµĞ¼" Ğ²ÑĞµ ÑÑ‚Ñ€Ğ°Ğ½Ğ¸Ñ†Ñ‹ Ğ² Ğ¾Ğ´Ğ¸Ğ½ Ğ¿Ğ»Ğ¾ÑĞºĞ¸Ğ¹ Ğ¼Ğ°ÑÑĞ¸Ğ² `allEquipment`
        const allEquipment = equipmentPages?.pages.flatMap(page => page.items) ?? [];

        const map: Record<number, Equipment> = {};
        // Ğ¢ĞµĞ¿ĞµÑ€ÑŒ allEquipment - ÑÑ‚Ğ¾ Ğ¿Ñ€Ğ°Ğ²Ğ¸Ğ»ÑŒĞ½Ñ‹Ğ¹ Ğ¼Ğ°ÑÑĞ¸Ğ², Ğ¸ forEach Ğ±ÑƒĞ´ĞµÑ‚ Ñ€Ğ°Ğ±Ğ¾Ñ‚Ğ°Ñ‚ÑŒ
        allEquipment.forEach((e: Equipment) => {
            map[e.id] = e;
        });
        return map;
    }, [equipmentPages]);
};

```


## <a name="srchooksuseErrorHandlerts"></a>`src/hooks/useErrorHandler.ts`

```typescript
// path: src/hooks/useErrorHandler.ts

// src/hooks/useErrorHandler.ts
import { useCallback } from "react"

type UseErrorHandler = () => (error: unknown) => void

/**
 * Ğ¥ÑƒĞº, Ğ¿Ñ€Ğ¾Ğ±Ñ€Ğ°ÑÑ‹Ğ²Ğ°ÑÑ‰Ğ¸Ğ¹ Ğ¾ÑˆĞ¸Ğ±ĞºÑƒ Ğ²Ğ¾ Ğ²Ğ½ĞµÑˆĞ½Ğ¸Ğ¹ ErrorBoundary Ñ‡ĞµÑ€ĞµĞ· throw.
 * Ğ’Ñ‹Ğ·Ñ‹Ğ²Ğ°ĞµÑ‚ÑÑ Ğ²Ñ€ÑƒÑ‡Ğ½ÑƒÑ Ğ¸Ğ· async-ĞºĞ¾Ğ½Ñ‚ĞµĞºÑÑ‚Ğ°.
 */
export const useErrorHandler: UseErrorHandler = () => {
    return useCallback((error: unknown) => {
        if (error instanceof Error) {
            throw error
        } else {
            throw new Error("ĞŸÑ€Ğ¾Ğ¸Ğ·Ğ¾ÑˆĞ»Ğ° Ğ½ĞµĞ¸Ğ·Ğ²ĞµÑÑ‚Ğ½Ğ°Ñ Ğ¾ÑˆĞ¸Ğ±ĞºĞ°")
        }
    }, [])
}


```


## <a name="srchooksuseInlineReservationEdittsx"></a>`src/hooks/useInlineReservationEdit.tsx`

```tsx
// path: src/hooks/useInlineReservationEdit.tsx

// src/hooks/useInlineReservationEdit.tsx

import React, { useMemo, useState, useEffect } from "react";
import { useReserveStore } from "@/store/reserveStore";
import { useReservationState, type EquipmentDisplayDetail } from "./reservation/useReservationState";
import { useReservationData } from "./reservation/useReservationData";
import { useEditReservation } from "./useEditReservation";
import type { Reservation } from "@/types/reservation";
import { ReservationEditContext, type ReservationEditContextValue } from "@/contexts/ReservationEditContext";
import { toast } from "sonner";
import { formatDate } from "@/lib/utils"; // <-- 1. Ğ”ĞĞ‘ĞĞ’Ğ›Ğ•Ğ Ğ˜ĞœĞŸĞĞ Ğ¢
import { useAllEquipment } from "./useAllEquipment";
import type { Equipment } from "@/types/equipment";

/**
 * ĞÑĞ½Ğ¾Ğ²Ğ½Ğ¾Ğ¹ Ñ…ÑƒĞº, ĞºĞ¾Ñ‚Ğ¾Ñ€Ñ‹Ğ¹ Ğ¸Ğ½ĞºĞ°Ğ¿ÑÑƒĞ»Ğ¸Ñ€ÑƒĞµÑ‚ Ğ²ÑÑ ÑĞ»Ğ¾Ğ¶Ğ½ÑƒÑ Ğ»Ğ¾Ğ³Ğ¸ĞºÑƒ Ñ€ĞµĞ´Ğ°ĞºÑ‚Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ Ñ€ĞµĞ·ĞµÑ€Ğ²Ğ°.
 * ĞĞ½ Ğ¸ÑĞ¿Ğ¾Ğ»ÑŒĞ·ÑƒĞµÑ‚ÑÑ Ğ²Ğ½ÑƒÑ‚Ñ€Ğ¸ Ğ¿Ñ€Ğ¾Ğ²Ğ°Ğ¹Ğ´ĞµÑ€Ğ° ReservationEditProvider.
 */
const useInlineReservationEditLogic = (
    reservation: Reservation,
    initialEquipmentForDisplay: ReadonlyArray<EquipmentDisplayDetail>,
    onFullCancellation: (() => Promise<void> | void) | undefined,
    isAdminContext: boolean,
    onFinishEditing: () => void
): ReservationEditContextValue => {

    const { state, actions: stateActions, dialogs } = useReservationState(
        reservation,
        initialEquipmentForDisplay
    );

    const {
        availabilityMap, hasConflicts, isCheckingAvailability, isCalculatingPrice,
        financials, setPromoCode, applyPromoCode, removePromoCode, appliedPromoCode,
        priceDetails,
    } = useReservationData(reservation, state);

    const { data: allEquipment = [] } = useAllEquipment();

    const equipmentMap = useMemo(() =>
            new Map(allEquipment.map(e => [e.id, e])),
        [allEquipment]
    );

    useEffect(() => {
        const reserveStoreState = useReserveStore.getState();

        if (reserveStoreState.addToReservationMode === reservation.id && reserveStoreState.items.length > 0) {

            if (allEquipment.length > 0) {
                const newItemsData = reserveStoreState.items.map(itemInStore => {
                    const fullItemData = allEquipment.find((eq: Equipment) => eq.id === itemInStore.id);
                    return fullItemData || itemInStore;
                });

                stateActions.addEquipmentItems(newItemsData);
                reserveStoreState.clear();
            }
        }
    }, [allEquipment, reservation.id, stateActions]);

    const [holidayConflict, setHolidayConflict] = useState<{ message: string, suggested_end_date: string } | null>(null);
    const editApiMutation = useEditReservation();

    const finalHasChanges = useMemo(() => {
        const promoCodeChanged = appliedPromoCode !== (reservation.promo_code || "");
        return state.hasChanges || promoCodeChanged;
    }, [state.hasChanges, appliedPromoCode, reservation.promo_code]);

    const saveChanges = async (confirmAdjustment: boolean = false): Promise<boolean> => {
        if (!finalHasChanges && !confirmAdjustment) {
            toast.info("ĞĞµÑ‚ Ğ¸Ğ·Ğ¼ĞµĞ½ĞµĞ½Ğ¸Ğ¹ Ğ´Ğ»Ñ ÑĞ¾Ñ…Ñ€Ğ°Ğ½ĞµĞ½Ğ¸Ñ.");
            return false;
        }
        if (hasConflicts) {
            toast.error("ĞĞµĞ²Ğ¾Ğ·Ğ¼Ğ¾Ğ¶Ğ½Ğ¾ ÑĞ¾Ñ…Ñ€Ğ°Ğ½Ğ¸Ñ‚ÑŒ Ñ€ĞµĞ·ĞµÑ€Ğ² Ñ ĞºĞ¾Ğ½Ñ„Ğ»Ğ¸ĞºÑ‚Ğ°Ğ¼Ğ¸.");
            return false;
        }
        if (state.currentEquipmentDetails.length === 0) {
            toast.error("Ğ ĞµĞ·ĞµÑ€Ğ² Ğ´Ğ¾Ğ»Ğ¶ĞµĞ½ ÑĞ¾Ğ´ĞµÑ€Ğ¶Ğ°Ñ‚ÑŒ Ñ…Ğ¾Ñ‚Ñ Ğ±Ñ‹ Ğ¾Ğ´Ğ½Ñƒ Ğ¿Ğ¾Ğ·Ğ¸Ñ†Ğ¸Ñ.");
            return false;
        }

        try {
            await editApiMutation.mutateAsync({
                id: reservation.id,
                // V-- 2. Ğ˜Ğ¡ĞŸĞ ĞĞ’Ğ›Ğ•ĞĞ˜Ğ• Ğ—Ğ”Ğ•Ğ¡Ğ¬ --V
                start_date: formatDate(state.startDate),
                end_date: formatDate(state.endDate),
                // ^-- ĞšĞĞĞ•Ğ¦ Ğ˜Ğ¡ĞŸĞ ĞĞ’Ğ›Ğ•ĞĞ˜Ğ¯ --^
                equipment_ids: state.currentEquipmentDetails.map(eq => eq.id),
                promo_code: appliedPromoCode,
                selected_accessories: state.localSelectedAccessories,
                isAdminContext,
                confirm_date_adjustment: confirmAdjustment,
            });
            toast.success("Ğ ĞµĞ·ĞµÑ€Ğ² ÑƒÑĞ¿ĞµÑˆĞ½Ğ¾ Ğ¾Ğ±Ğ½Ğ¾Ğ²Ğ»ĞµĞ½!");
            if (holidayConflict) setHolidayConflict(null);
            onFinishEditing();
            return true;
        } catch (error) {
            const errorDetail = (error as any)?.response?.data?.detail;

            let parsedDetail = null;
            if (typeof errorDetail === 'string') {
                try { parsedDetail = JSON.parse(errorDetail); } catch (e) { /* ĞÑˆĞ¸Ğ±ĞºĞ° Ğ½Ğµ Ğ² Ñ„Ğ¾Ñ€Ğ¼Ğ°Ñ‚Ğµ JSON */ }
            } else {
                parsedDetail = errorDetail;
            }

            if (
                (error as any).response?.status === 409 &&
                parsedDetail?.error_type === "END_DATE_IS_HOLIDAY"
            ) {
                setHolidayConflict(parsedDetail);
            } else {
                const message = typeof errorDetail === 'string' ? errorDetail : "ĞÑˆĞ¸Ğ±ĞºĞ° Ğ¿Ñ€Ğ¸ ÑĞ¾Ñ…Ñ€Ğ°Ğ½ĞµĞ½Ğ¸Ğ¸ Ğ¸Ğ·Ğ¼ĞµĞ½ĞµĞ½Ğ¸Ğ¹.";
                toast.error(message);
            }
            return false;
        }
    };

    const handleConfirmHolidayAdjustment = () => {
        void saveChanges(true);
    };

    const { clear: clearReserveStore, setReservationId } = useReserveStore.getState();

    const cancelEdit = () => {
        clearReserveStore();
        onFinishEditing();
    };

    const editStateForUI = useMemo(() => ({
        ...state,
        hasChanges: finalHasChanges,
        newlyAddedEquipmentIdsAsArray: Array.from(state.newlyAddedEquipmentIds)
    }), [state, finalHasChanges]);

    return {
        reservationId: reservation.id,
        editState: editStateForUI,
        availabilityMap,
        hasConflicts,
        isLoading: editApiMutation.isPending || isCheckingAvailability,
        isCheckingAvailability,
        isSaving: editApiMutation.isPending,
        isCalculatingPrice,
        isCancelling: false,
        isCancelConfirmationVisible: dialogs.isCancelConfirmationVisible,
        startEdit: () => setReservationId(reservation.id),
        cancelEdit,
        saveChanges: () => saveChanges(false),
        equipmentMap,
        allEquipment,
        updateDates: stateActions.updateDates,
        addEquipmentItems: stateActions.addEquipmentItems,
        removeEquipmentItem: stateActions.removeEquipmentItem,
        handleConfirmFullCancellation: async () => { if (onFullCancellation) await onFullCancellation() },
        handleCloseCancellationDialog: () => dialogs.setCancelConfirmationVisible(false),
        financials,
        priceDetails,
        setPromoCode,
        applyPromoCode,
        removePromoCode,
        localSelectedAccessories: state.localSelectedAccessories,
        toggleAccessory: stateActions.toggleAccessory,
        holidayConflict: holidayConflict,
        confirmHolidayAdjustment: handleConfirmHolidayAdjustment,
        cancelHolidayAdjustment: () => setHolidayConflict(null),
    };
};

/**
 * ĞšĞ¾Ğ¼Ğ¿Ğ¾Ğ½ĞµĞ½Ñ‚-Ğ¿Ñ€Ğ¾Ğ²Ğ°Ğ¹Ğ´ĞµÑ€, ĞºĞ¾Ñ‚Ğ¾Ñ€Ñ‹Ğ¹ Ğ¾Ğ±Ğ¾Ñ€Ğ°Ñ‡Ğ¸Ğ²Ğ°ĞµÑ‚ Ğ´Ğ¾Ñ‡ĞµÑ€Ğ½Ğ¸Ğµ ĞºĞ¾Ğ¼Ğ¿Ğ¾Ğ½ĞµĞ½Ñ‚Ñ‹
 * Ğ¸ Ğ¿Ñ€ĞµĞ´Ğ¾ÑÑ‚Ğ°Ğ²Ğ»ÑĞµÑ‚ Ğ¸Ğ¼ Ğ´Ğ¾ÑÑ‚ÑƒĞ¿ ĞºĞ¾ Ğ²ÑĞµĞ¹ Ğ»Ğ¾Ğ³Ğ¸ĞºĞµ Ñ€ĞµĞ´Ğ°ĞºÑ‚Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ Ñ‡ĞµÑ€ĞµĞ· Ñ…ÑƒĞº useReservationEditContext.
 */
export const ReservationEditProvider: React.FC<{
    children: React.ReactNode;
    reservation: Reservation;
    initialEquipmentForDisplay: ReadonlyArray<EquipmentDisplayDetail>;
    onFullCancellation?: (() => Promise<void> | void) | undefined;
    isAdminContext?: boolean;
    onFinishEditing: () => void;
}> = (props) => {
    const contextValue = useInlineReservationEditLogic(
        props.reservation,
        props.initialEquipmentForDisplay,
        props.onFullCancellation,
        props.isAdminContext || false,
        props.onFinishEditing
    );

    return (
        <ReservationEditContext.Provider value={contextValue}>
            {props.children}
        </ReservationEditContext.Provider>
    );
};

```


## <a name="srchooksuseMyRentalsts"></a>`src/hooks/useMyRentals.ts`

```typescript
// path: src/hooks/useMyRentals.ts

import { useInfiniteQuery, type QueryFunctionContext } from "@tanstack/react-query";
import { api } from "@/lib/api";
import type { AdminRentalListResponse } from "@/types/rental";
import { useCurrentUser } from "./useProfile";

const MY_RENTALS_KEY = "myRentals";

interface UseMyRentalsParams {
    search?: string;
    status?: string;
    sort?: string;
}

export function useMyRentals(params?: UseMyRentalsParams, limit: number = 10) {
    const { data: user } = useCurrentUser();

    return useInfiniteQuery<AdminRentalListResponse, Error>({
        queryKey: [MY_RENTALS_KEY, params],
        queryFn: async ({ pageParam = 0 }: QueryFunctionContext) => {
            const skip = (pageParam as number) * limit;
            const response = await api.get<AdminRentalListResponse>("/user/rentals", {
                params: { skip, limit, ...params },
            });
            return response.data;
        },
        initialPageParam: 0,
        getNextPageParam: (lastPage, allPages) => {
            const loadedItems = allPages.reduce((acc, page) => acc + page.items.length, 0);
            if (loadedItems < lastPage.total) {
                return allPages.length;
            }
            return undefined;
        },
        enabled: !!user, // Ğ’Ñ‹Ğ¿Ğ¾Ğ»Ğ½ÑÑ‚ÑŒ Ğ·Ğ°Ğ¿Ñ€Ğ¾Ñ Ñ‚Ğ¾Ğ»ÑŒĞºĞ¾ ĞµÑĞ»Ğ¸ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ÑŒ Ğ°Ğ²Ñ‚Ğ¾Ñ€Ğ¸Ğ·Ğ¾Ğ²Ğ°Ğ½
    });
}


```


## <a name="srchooksuseNetworkStatusts"></a>`src/hooks/useNetworkStatus.ts`

```typescript
// path: src/hooks/useNetworkStatus.ts

// src/hooks/useNetworkStatus.ts
import { useEffect, useState } from "react"

/**
 * Ğ¥ÑƒĞº Ğ¾Ñ‚ÑĞ»ĞµĞ¶Ğ¸Ğ²Ğ°ĞµÑ‚ ÑÑ‚Ğ°Ñ‚ÑƒÑ Ğ¿Ğ¾Ğ´ĞºĞ»ÑÑ‡ĞµĞ½Ğ¸Ñ (online/offline).
 * Ğ’Ğ¾Ğ·Ğ²Ñ€Ğ°Ñ‰Ğ°ĞµÑ‚ true â€” ĞµÑĞ»Ğ¸ Ğ² ÑĞµÑ‚Ğ¸, false â€” ĞµÑĞ»Ğ¸ Ğ¾Ñ„Ñ„Ğ»Ğ°Ğ¹Ğ½.
 */
export function useNetworkStatus(): boolean {
    const [isOnline, setIsOnline] = useState(navigator.onLine)

    useEffect(() => {
        const handleOnline = () => setIsOnline(true)
        const handleOffline = () => setIsOnline(false)

        window.addEventListener("online", handleOnline)
        window.addEventListener("offline", handleOffline)

        return () => {
            window.removeEventListener("online", handleOnline)
            window.removeEventListener("offline", handleOffline)
        }
    }, [])

    return isOnline
}


```


## <a name="srchooksusePhoneValidationts"></a>`src/hooks/usePhoneValidation.ts`

```typescript
// path: src/hooks/usePhoneValidation.ts

// src/hooks/usePhoneValidation.ts

import { useState, useCallback } from 'react';
import { PhoneService } from '@/core/services';

interface UsePhoneValidationOptions {
    format?: 'russian' | 'international';
    required?: boolean;
    onValidationChange?: (isValid: boolean) => void;
}

interface UsePhoneValidationReturn {
    isValid: boolean;
    error: string | null;
    validatePhone: (phone: string) => boolean;
    clearError: () => void;
}

/**
 * Ğ¥ÑƒĞº Ğ´Ğ»Ñ Ğ²Ğ°Ğ»Ğ¸Ğ´Ğ°Ñ†Ğ¸Ğ¸ Ñ‚ĞµĞ»ĞµÑ„Ğ¾Ğ½Ğ½Ñ‹Ñ… Ğ½Ğ¾Ğ¼ĞµÑ€Ğ¾Ğ² Ğ² Ñ€ĞµĞ°Ğ»ÑŒĞ½Ğ¾Ğ¼ Ğ²Ñ€ĞµĞ¼ĞµĞ½Ğ¸
 */
export function usePhoneValidation(options: UsePhoneValidationOptions = {}): UsePhoneValidationReturn {
    const {
        format = 'russian',
        required = false,
        onValidationChange
    } = options;

    const [isValid, setIsValid] = useState(false);
    const [error, setError] = useState<string | null>(null);

    const validatePhone = useCallback((phone: string): boolean => {
        // Ğ•ÑĞ»Ğ¸ Ğ¿Ğ¾Ğ»Ğµ Ğ½Ğµ Ğ¾Ğ±ÑĞ·Ğ°Ñ‚ĞµĞ»ÑŒĞ½Ğ¾ Ğ¸ Ğ¿ÑƒÑÑ‚Ğ¾Ğµ, ÑÑ‡Ğ¸Ñ‚Ğ°ĞµĞ¼ Ğ²Ğ°Ğ»Ğ¸Ğ´Ğ½Ñ‹Ğ¼
        if (!required && !phone.trim()) {
            setIsValid(true);
            setError(null);
            onValidationChange?.(true);
            return true;
        }

        // Ğ•ÑĞ»Ğ¸ Ğ¿Ğ¾Ğ»Ğµ Ğ¾Ğ±ÑĞ·Ğ°Ñ‚ĞµĞ»ÑŒĞ½Ğ¾ Ğ¸ Ğ¿ÑƒÑÑ‚Ğ¾Ğµ
        if (required && !phone.trim()) {
            setIsValid(false);
            setError('ĞĞ¾Ğ¼ĞµÑ€ Ñ‚ĞµĞ»ĞµÑ„Ğ¾Ğ½Ğ° Ğ¾Ğ±ÑĞ·Ğ°Ñ‚ĞµĞ»ĞµĞ½');
            onValidationChange?.(false);
            return false;
        }

        // Ğ˜ÑĞ¿Ğ¾Ğ»ÑŒĞ·ÑƒĞµĞ¼ PhoneService Ğ´Ğ»Ñ Ğ²Ğ°Ğ»Ğ¸Ğ´Ğ°Ñ†Ğ¸Ğ¸
        const validationResult = PhoneService.validate(phone);
        
        if (!validationResult.isValid) {
            setIsValid(false);
            setError(validationResult.error || 'ĞĞµĞºĞ¾Ñ€Ñ€ĞµĞºÑ‚Ğ½Ñ‹Ğ¹ Ğ½Ğ¾Ğ¼ĞµÑ€ Ñ‚ĞµĞ»ĞµÑ„Ğ¾Ğ½Ğ°');
            onValidationChange?.(false);
            return false;
        }

        // Ğ’ÑĞµ Ğ¿Ñ€Ğ¾Ğ²ĞµÑ€ĞºĞ¸ Ğ¿Ñ€Ğ¾Ğ¹Ğ´ĞµĞ½Ñ‹
        setIsValid(true);
        setError(null);
        onValidationChange?.(true);
        return true;
    }, [format, required, onValidationChange]);

    const clearError = useCallback(() => {
        setError(null);
    }, []);

    return {
        isValid,
        error,
        validatePhone,
        clearError
    };
}

/**
 * Ğ¥ÑƒĞº Ğ´Ğ»Ñ Ğ²Ğ°Ğ»Ğ¸Ğ´Ğ°Ñ†Ğ¸Ğ¸ Ñ‚ĞµĞ»ĞµÑ„Ğ¾Ğ½Ğ° Ñ debounce
 */
export function usePhoneValidationWithDebounce(
    options: UsePhoneValidationOptions & { debounceMs?: number } = {}
): UsePhoneValidationReturn & { debouncedValidate: (phone: string) => void } {
    const { debounceMs = 500, ...validationOptions } = options;
    const [debounceTimeout, setDebounceTimeout] = useState<NodeJS.Timeout | null>(null);
    
    const baseValidation = usePhoneValidation(validationOptions);

    const debouncedValidate = useCallback((phone: string) => {
        // ĞÑ‡Ğ¸Ñ‰Ğ°ĞµĞ¼ Ğ¿Ñ€ĞµĞ´Ñ‹Ğ´ÑƒÑ‰Ğ¸Ğ¹ Ñ‚Ğ°Ğ¹Ğ¼Ğ°ÑƒÑ‚
        if (debounceTimeout) {
            clearTimeout(debounceTimeout);
        }

        // Ğ£ÑÑ‚Ğ°Ğ½Ğ°Ğ²Ğ»Ğ¸Ğ²Ğ°ĞµĞ¼ Ğ½Ğ¾Ğ²Ñ‹Ğ¹ Ñ‚Ğ°Ğ¹Ğ¼Ğ°ÑƒÑ‚
        const timeout = setTimeout(() => {
            baseValidation.validatePhone(phone);
        }, debounceMs);

        setDebounceTimeout(timeout);
    }, [baseValidation, debounceMs, debounceTimeout]);

    return {
        ...baseValidation,
        debouncedValidate
    };
} 

```


## <a name="srchooksuseProfilets"></a>`src/hooks/useProfile.ts`

```typescript
// path: src/hooks/useProfile.ts

import { useQuery, useMutation, useQueryClient } from "@tanstack/react-query";
import { api } from "@/lib/api";
import type { UserOut } from "@/types/user";
import { handleQueryError } from "@/lib/queryHelpers";

/**
 * Ğ¢Ğ¸Ğ¿ Ğ´Ğ°Ğ½Ğ½Ñ‹Ñ… Ğ´Ğ»Ñ Ğ¾Ğ±Ğ½Ğ¾Ğ²Ğ»ĞµĞ½Ğ¸Ñ Ğ¿Ñ€Ğ¾Ñ„Ğ¸Ğ»Ñ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ñ
 */
type ProfileUpdatePayload = {
    full_name: string;
    email: string;
    phone?: string;
};

/**
 * Ğ¢Ğ¸Ğ¿ Ğ¾ÑˆĞ¸Ğ±ĞºĞ¸ API
 */
type APIError = {
    response?: {
        status?: number;
        data?: {
            detail?: string;
        };
    };
    message?: string;
};

/**
 * Ğ¥ÑƒĞº Ğ´Ğ»Ñ Ğ¿Ğ¾Ğ»ÑƒÑ‡ĞµĞ½Ğ¸Ñ Ğ´Ğ°Ğ½Ğ½Ñ‹Ñ… Ñ‚ĞµĞºÑƒÑ‰ĞµĞ³Ğ¾ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ñ
 * @returns Query Ğ¾Ğ±ÑŠĞµĞºÑ‚ Ñ Ğ´Ğ°Ğ½Ğ½Ñ‹Ğ¼Ğ¸ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ñ
 */
export function useCurrentUser() {
    return useQuery<UserOut | null, Error>({
        queryKey: ["current_user"],
        queryFn: async () => {
            // ĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑĞµĞ¼ Ğ½Ğ°Ğ»Ğ¸Ñ‡Ğ¸Ğµ Ñ‚Ğ¾ĞºĞµĞ½Ğ° Ğ¿ĞµÑ€ĞµĞ´ Ğ·Ğ°Ğ¿Ñ€Ğ¾ÑĞ¾Ğ¼
            const accessToken = localStorage.getItem("access_token");
            if (!accessToken) {
                return null;
            }

            try {
                const res = await api.get<UserOut>("/user/");
                return res.data;
            } catch (error: unknown) {
                const apiError = error as APIError;
                if (apiError.response?.status === 401) {
                    // ĞÑ‡Ğ¸Ñ‰Ğ°ĞµĞ¼ Ğ½ĞµĞ´ĞµĞ¹ÑÑ‚Ğ²Ğ¸Ñ‚ĞµĞ»ÑŒĞ½Ñ‹Ğ¹ Ñ‚Ğ¾ĞºĞµĞ½
                    localStorage.removeItem("access_token");
                    return null;
                }
                console.error("[useCurrentUser] Error fetching user data:", apiError);
                handleQueryError(error);
                throw error;
            }
        },
        staleTime: 1000 * 60 * 10, // ĞºÑÑˆ Ğ½Ğ° 10 Ğ¼Ğ¸Ğ½ÑƒÑ‚
        retry: (failureCount, error) => {
            // ĞĞµ Ğ¿Ğ¾Ğ²Ñ‚Ğ¾Ñ€ÑĞµĞ¼ Ğ·Ğ°Ğ¿Ñ€Ğ¾Ñ Ğ¿Ñ€Ğ¸ 401 Ğ¾ÑˆĞ¸Ğ±ĞºĞµ
            if (error instanceof Error && error.message.includes("401")) {
                return false;
            }
            return failureCount < 3;
        },
        // ĞĞµ Ğ²Ñ‹Ğ¿Ğ¾Ğ»Ğ½ÑĞµĞ¼ Ğ·Ğ°Ğ¿Ñ€Ğ¾Ñ, ĞµÑĞ»Ğ¸ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ÑŒ Ğ½Ğµ Ğ°Ğ²Ñ‚Ğ¾Ñ€Ğ¸Ğ·Ğ¾Ğ²Ğ°Ğ½
        enabled: !!localStorage.getItem("access_token"),
    });
}

/**
 * Ğ¥ÑƒĞº Ğ´Ğ»Ñ Ğ¾Ğ±Ğ½Ğ¾Ğ²Ğ»ĞµĞ½Ğ¸Ñ Ğ´Ğ°Ğ½Ğ½Ñ‹Ñ… Ğ¿Ñ€Ğ¾Ñ„Ğ¸Ğ»Ñ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ñ
 * @returns Mutation Ğ¾Ğ±ÑŠĞµĞºÑ‚ Ğ´Ğ»Ñ Ğ¾Ğ±Ğ½Ğ¾Ğ²Ğ»ĞµĞ½Ğ¸Ñ Ğ¿Ñ€Ğ¾Ñ„Ğ¸Ğ»Ñ
 */
export function useProfileUpdate() {
    const queryClient = useQueryClient();

    return useMutation<void, Error, ProfileUpdatePayload>({
        mutationFn: async (data: ProfileUpdatePayload) => {
            try {
                await api.put("/user/", data);
            } catch (error: unknown) {
                console.error("[useProfileUpdate] Error updating profile:", error);
                handleQueryError(error);
                throw error;
            }
        },
        onSuccess: () => {
            queryClient.invalidateQueries({ queryKey: ["current_user"] });
        },
        onError: (error: Error) => {
            console.error("[useProfileUpdate] Mutation error:", error);
        },
    });
}


```


## <a name="srchooksuseReservationManagementts"></a>`src/hooks/useReservationManagement.ts`

```typescript
// path: src/hooks/useReservationManagement.ts

// src/hooks/useReservationManagement.ts

import { useEffect, useMemo } from 'react';
import { useLocation } from 'react-router-dom';
import { useReserveStore } from '@/store/reserveStore';
import type { Equipment } from '@/types/equipment';
import type { AvailabilityInfo, EquipmentStatus } from '@/types/availability';

type UseReservationManagementReturn = {
    editingReservationId: number | null;
    intent: string | null;
    getEquipmentStatus: (eq: Equipment) => EquipmentStatus | "my_reservation" | "added";
};

export function useReservationManagement(
    filteredItems: Equipment[],
    availabilityMap: Record<number, AvailabilityInfo>,
    availableOnly: boolean
): UseReservationManagementReturn {
    const location = useLocation();
    const { items: selectedItems, addToReservationMode } = useReserveStore();

    const editingReservationEquipmentIds = useMemo(() => {
        if (location.state?.intent === "add_to_reservation" && location.state?.reservationId) {
            return new Set(location.state?.equipmentIds || []);
        }
        return new Set<number>();
    }, [location.state]);

    useEffect(() => {
        const intent = location.state?.intent;
        const reservationIdFromLocation = location.state?.reservationId;
        const storeActions = useReserveStore.getState();

        if (intent === "add_to_reservation" && reservationIdFromLocation) {
            if (storeActions.addToReservationMode !== reservationIdFromLocation) {
                storeActions.clear();
                storeActions.setAddToReservationMode(reservationIdFromLocation);
            }
        } else if (intent === "add_to_new_reservation") {
            if (storeActions.addToReservationMode !== null) {
                storeActions.clear();
            }
        } else {
            if (storeActions.addToReservationMode !== null) {
                storeActions.clear();
            }
        }
    }, [location.state]);

    // availabilityMap Ñ‚ĞµĞ¿ĞµÑ€ÑŒ Ğ¿ĞµÑ€ĞµĞ´Ğ°ĞµÑ‚ÑÑ ĞºĞ°Ğº Ğ¿Ğ°Ñ€Ğ°Ğ¼ĞµÑ‚Ñ€, Ğ½Ğµ Ğ½ÑƒĞ¶Ğ½Ğ¾ ÑĞ¾Ğ·Ğ´Ğ°Ğ²Ğ°Ñ‚ÑŒ ĞµĞ³Ğ¾ Ğ·Ğ´ĞµÑÑŒ


    const getEquipmentStatus = (eq: Equipment): EquipmentStatus | "my_reservation" | "added" => {
        if (location.state?.intent === "add_to_reservation" && location.state?.reservationId === addToReservationMode) {
            if (editingReservationEquipmentIds.has(eq.id)) {
                return "my_reservation";
            }
            if (selectedItems.some(i => i.id === eq.id)) {
                return "added";
            }
        }

        const itemAvailability = availabilityMap[eq.id];

        // --- ĞĞĞ§ĞĞ›Ğ Ğ˜Ğ—ĞœĞ•ĞĞ•ĞĞ˜Ğ™ (Ğ’ĞĞ—Ğ’Ğ ĞĞ©ĞĞ•Ğœ ĞšĞĞš Ğ‘Ğ«Ğ›Ğ) ---
        // Ğ¢ĞµĞ¿ĞµÑ€ÑŒ Ğ±ÑĞºĞµĞ½Ğ´ ÑĞ°Ğ¼ Ğ¾Ñ‚Ğ´Ğ°ĞµÑ‚ Ğ¿Ñ€Ğ°Ğ²Ğ¸Ğ»ÑŒĞ½Ñ‹Ğ¹ ÑÑ‚Ğ°Ñ‚ÑƒÑ, Ğ½Ğ°Ğ¼ Ğ½Ğµ Ğ½ÑƒĞ¶Ğ½Ğ° Ğ´Ğ¾Ğ¿Ğ¾Ğ»Ğ½Ğ¸Ñ‚ĞµĞ»ÑŒĞ½Ğ°Ñ Ğ»Ğ¾Ğ³Ğ¸ĞºĞ°
        return itemAvailability?.status ?? "available";
        // --- ĞšĞĞĞ•Ğ¦ Ğ˜Ğ—ĞœĞ•ĞĞ•ĞĞ˜Ğ™ ---
    };

    return {
        editingReservationId: location.state?.reservationId ?? null,
        intent: location.state?.intent ?? null,
        getEquipmentStatus
    };
}

```


## <a name="srchooksuseReservationsts"></a>`src/hooks/useReservations.ts`

```typescript
// path: src/hooks/useReservations.ts

// src/hooks/useReservations.ts

import { useQuery, useMutation, useQueryClient } from "@tanstack/react-query";
import { ReservationService, type ReservationCreateInput } from "@/core/services/ReservationService";
import type { Reservation } from "@/types/reservation";
import { handleQueryError } from "@/lib/queryHelpers";
import { useCurrentUser } from "./useProfile";
import { toast } from "sonner";
import { transformAccessoryLinks } from "@/lib/utils";

const RESERVATIONS_KEY = ["reservations"];

const invalidateReservationQueries = (queryClient: ReturnType<typeof useQueryClient>) => {
    void queryClient.invalidateQueries({ queryKey: RESERVATIONS_KEY });
    void queryClient.invalidateQueries({ queryKey: ["availability"] });
    void queryClient.invalidateQueries({ queryKey: ["calendar-grid"] });
};

const handleMutationError = (error: unknown, contextMessage: string) => {
    console.error(`[useReservations] Error on ${contextMessage}:`, error);
    const apiError = error as { response?: { data?: { detail?: any } } };
    const detail = apiError.response?.data?.detail;
    let message = `ĞÑˆĞ¸Ğ±ĞºĞ°: ${contextMessage}`;

    if (typeof detail === 'string') {
        message = detail;
    } else if (typeof detail?.message === 'string') {
        message = detail.message;
    }

    toast.error(message);

    if (detail?.unavailable_ids) {
        const errorToThrow = new Error(message);
        (errorToThrow as any).unavailable_ids = detail.unavailable_ids;
        throw errorToThrow;
    }
};

interface UseReservationsParams {
    search?: string;
    status?: string;
    sort?: string;
}

export function useReservations(params?: UseReservationsParams) {
    const queryClient = useQueryClient();
    const { data: user } = useCurrentUser();

    const reservationsQuery = useQuery<Reservation[], Error>({
        queryKey: [...RESERVATIONS_KEY, params],
        queryFn: async (): Promise<Reservation[]> => {
            try {
                return await ReservationService.getUserReservations(params);
            } catch (error) {
                handleQueryError(error);
                throw error;
            }
        },
        enabled: !!user,
        staleTime: 5 * 60 * 1000,
        select: (data) => data.map(transformAccessoryLinks),
    });

    const createReservation = useMutation({
        mutationFn: (data: ReservationCreateInput) => ReservationService.createReservation(data),
        onSuccess: () => {
            invalidateReservationQueries(queryClient);
        },
        onError: (error) => handleMutationError(error, "Ğ½Ğµ ÑƒĞ´Ğ°Ğ»Ğ¾ÑÑŒ ÑĞ¾Ğ·Ğ´Ğ°Ñ‚ÑŒ Ñ€ĞµĞ·ĞµÑ€Ğ²")
    });

    const updateReservation = useMutation({
        mutationFn: (data: any) => ReservationService.updateReservation(data),
        onSuccess: () => {
            invalidateReservationQueries(queryClient);
            toast.success("Ğ ĞµĞ·ĞµÑ€Ğ² ÑƒÑĞ¿ĞµÑˆĞ½Ğ¾ Ğ¾Ğ±Ğ½Ğ¾Ğ²Ğ»ĞµĞ½!");
        },
        onError: (error) => handleMutationError(error, "Ğ½Ğµ ÑƒĞ´Ğ°Ğ»Ğ¾ÑÑŒ Ğ¾Ğ±Ğ½Ğ¾Ğ²Ğ¸Ñ‚ÑŒ Ñ€ĞµĞ·ĞµÑ€Ğ²")
    });

    const deleteReservation = useMutation({
        mutationFn: (id: number) => ReservationService.cancelReservation(id),
        onSuccess: () => {
            invalidateReservationQueries(queryClient);
            toast.success("Ğ ĞµĞ·ĞµÑ€Ğ² ÑƒÑĞ¿ĞµÑˆĞ½Ğ¾ ÑƒĞ´Ğ°Ğ»ĞµĞ½!");
        },
        onError: (error) => handleMutationError(error, "Ğ½Ğµ ÑƒĞ´Ğ°Ğ»Ğ¾ÑÑŒ ÑƒĞ´Ğ°Ğ»Ğ¸Ñ‚ÑŒ Ñ€ĞµĞ·ĞµÑ€Ğ²")
    });

    return {
        reservationsQuery,
        createReservation,
        updateReservation,
        deleteReservation,
    };
}

```


## <a name="srchooksuseUpdateEquipmentDetailsts"></a>`src/hooks/useUpdateEquipmentDetails.ts`

```typescript
// path: src/hooks/useUpdateEquipmentDetails.ts

// src/hooks/useUpdateEquipmentDetails.ts
import { useMutation, useQueryClient } from "@tanstack/react-query";
import { toast } from "sonner";
import { api } from "@/lib/api";
import type { Equipment } from "@/types/equipment";
import type { EquipmentUpdateExtendedSchema } from "@/lib/validationSchemas";

interface UpdateEquipmentPayload {
    id: number;
    data: EquipmentUpdateExtendedSchema;
}

export function useUpdateEquipmentDetails() {
    const queryClient = useQueryClient();

    return useMutation<Equipment, Error, UpdateEquipmentPayload>({
        mutationFn: async ({ id, data }) => {
            const payload: Record<string, string | number | boolean | string[] | number[] | null> = {};
            for (const key in data) {
                if (Object.prototype.hasOwnProperty.call(data, key)) {
                    const typedKey = key as keyof EquipmentUpdateExtendedSchema;
                    if (data[typedKey] !== undefined) {
                        payload[typedKey] = data[typedKey];
                    }
                }
            }
            const response = await api.put<Equipment>(`/equipment/${id}`, payload);
            return response.data;
        },
        onSuccess: async (updatedEquipment, variables) => { // <--- Ğ”Ğ¾Ğ±Ğ°Ğ²Ğ»ĞµĞ½ async
            toast.success(`ĞĞ±Ğ¾Ñ€ÑƒĞ´Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ "${updatedEquipment.name}" ÑƒÑĞ¿ĞµÑˆĞ½Ğ¾ Ğ¾Ğ±Ğ½Ğ¾Ğ²Ğ»ĞµĞ½Ğ¾!`);

            // Ğ˜Ğ½Ğ²Ğ°Ğ»Ğ¸Ğ´Ğ°Ñ†Ğ¸Ñ Ğ¸ Ğ¾Ğ±Ğ½Ğ¾Ğ²Ğ»ĞµĞ½Ğ¸Ğµ ĞºÑÑˆĞ°
            // 1. Ğ˜Ğ½Ğ²Ğ°Ğ»Ğ¸Ğ´Ğ¸Ñ€ÑƒĞµĞ¼ Ğ¾Ğ±Ñ‰Ğ¸Ğ¹ ÑĞ¿Ğ¸ÑĞ¾Ğº Ğ¾Ğ±Ğ¾Ñ€ÑƒĞ´Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ
            await queryClient.invalidateQueries({ queryKey: ["equipment"] }); // <--- Ğ”Ğ¾Ğ±Ğ°Ğ²Ğ»ĞµĞ½ await

            // 2. ĞœĞ¾Ğ¶Ğ½Ğ¾ Ñ‚Ğ°ĞºĞ¶Ğµ Ñ‚Ğ¾Ñ‡ĞµÑ‡Ğ½Ğ¾ Ğ¾Ğ±Ğ½Ğ¾Ğ²Ğ¸Ñ‚ÑŒ ĞºÑÑˆ Ğ´Ğ»Ñ ÑÑ‚Ğ¾Ğ³Ğ¾ ĞºĞ¾Ğ½ĞºÑ€ĞµÑ‚Ğ½Ğ¾Ğ³Ğ¾ ÑĞ»ĞµĞ¼ĞµĞ½Ñ‚Ğ°,
            // ĞµÑĞ»Ğ¸ Ğ¾Ğ½ Ğ³Ğ´Ğµ-Ñ‚Ğ¾ Ğ·Ğ°Ğ¿Ñ€Ğ°ÑˆĞ¸Ğ²Ğ°ĞµÑ‚ÑÑ Ğ¿Ğ¾ Ğ¾Ñ‚Ğ´ĞµĞ»ÑŒĞ½Ğ¾Ğ¼Ñƒ ĞºĞ»ÑÑ‡Ñƒ (Ğ½Ğ°Ğ¿Ñ€Ğ¸Ğ¼ĞµÑ€, ["equipment", variables.id])
            // await queryClient.setQueryData(["equipment", variables.id], updatedEquipment); // <--- Ğ”Ğ¾Ğ±Ğ°Ğ²Ğ»ĞµĞ½ await, ĞµÑĞ»Ğ¸ Ğ¸ÑĞ¿Ğ¾Ğ»ÑŒĞ·ÑƒĞµÑ‚ÑÑ

            queryClient.setQueryData<Equipment[]>(["equipment"], (oldData) =>
                oldData?.map((item) =>
                    item.id === variables.id ? { ...item, ...updatedEquipment } : item
                ) ?? []
            );

            // 4. Ğ˜Ğ½Ğ²Ğ°Ğ»Ğ¸Ğ´Ğ¸Ñ€ÑƒĞµĞ¼ Ğ´Ğ°Ğ½Ğ½Ñ‹Ğµ Ğ¾ Ğ´Ğ¾ÑÑ‚ÑƒĞ¿Ğ½Ğ¾ÑÑ‚Ğ¸
            await queryClient.invalidateQueries({ queryKey: ["availability"] }); // <--- Ğ”Ğ¾Ğ±Ğ°Ğ²Ğ»ĞµĞ½ await
            await queryClient.invalidateQueries({ queryKey: ["calendar-grid"] }); // <--- Ğ”Ğ¾Ğ±Ğ°Ğ²Ğ»ĞµĞ½ await
            await queryClient.invalidateQueries({ queryKey: ["calendar-events"] }); // <--- Ğ”Ğ¾Ğ±Ğ°Ğ²Ğ»ĞµĞ½ await
        },
        onError: (error) => {
            toast.error(`ĞÑˆĞ¸Ğ±ĞºĞ° Ğ¿Ñ€Ğ¸ Ğ¾Ğ±Ğ½Ğ¾Ğ²Ğ»ĞµĞ½Ğ¸Ğ¸ Ğ¾Ğ±Ğ¾Ñ€ÑƒĞ´Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ: ${error.message}`);
            console.error("ĞÑˆĞ¸Ğ±ĞºĞ° Ğ¿Ñ€Ğ¸ Ğ¾Ğ±Ğ½Ğ¾Ğ²Ğ»ĞµĞ½Ğ¸Ğ¸ Ğ¾Ğ±Ğ¾Ñ€ÑƒĞ´Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ:", error);
        },
    });
}

```


## <a name="srchooksuseVisibleItemsts"></a>`src/hooks/useVisibleItems.ts`

```typescript
// path: src/hooks/useVisibleItems.ts

import { useState, useEffect } from 'react';

/**
 * Ğ£Ğ¿Ñ€Ğ°Ğ²Ğ»ÑĞµÑ‚ ĞºĞ¾Ğ»Ğ¸Ñ‡ĞµÑÑ‚Ğ²Ğ¾Ğ¼ Ğ²Ğ¸Ğ´Ğ¸Ğ¼Ñ‹Ñ… ÑĞ»ĞµĞ¼ĞµĞ½Ñ‚Ğ¾Ğ² Ğ² ÑĞ¿Ğ¸ÑĞºĞµ Ñ ÑƒÑ‡ĞµÑ‚Ğ¾Ğ¼ Ñ„Ğ¸Ğ»ÑŒÑ‚Ñ€Ğ°Ñ†Ğ¸Ğ¸.
 * @param totalCount ĞĞ±Ñ‰ĞµĞµ ĞºĞ¾Ğ»Ğ¸Ñ‡ĞµÑÑ‚Ğ²Ğ¾ ÑĞ»ĞµĞ¼ĞµĞ½Ñ‚Ğ¾Ğ² Ğ² Ğ¾Ñ‚Ñ„Ğ¸Ğ»ÑŒÑ‚Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ½Ğ¾Ğ¼ ÑĞ¿Ğ¸ÑĞºĞµ.
 */
export function useVisibleItems(totalCount: number) {
    // `intendedSize` â€” ÑÑ‚Ğ¾ ĞºĞ¾Ğ»Ğ¸Ñ‡ĞµÑÑ‚Ğ²Ğ¾ ÑĞ»ĞµĞ¼ĞµĞ½Ñ‚Ğ¾Ğ², ĞºĞ¾Ñ‚Ğ¾Ñ€Ğ¾Ğµ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ÑŒ *Ñ…Ğ¾Ñ‡ĞµÑ‚* Ğ²Ğ¸Ğ´ĞµÑ‚ÑŒ (Ğ½Ğ°Ğ¿Ñ€Ğ¸Ğ¼ĞµÑ€, Ğ¿Ğ¾ÑĞ»Ğµ Ğ½Ğ°Ğ¶Ğ°Ñ‚Ğ¸Ñ ĞºĞ½Ğ¾Ğ¿ĞºĞ¸ "24").
    const [intendedSize, setIntendedSize] = useState(12);

    // `visibleCount` â€” ÑÑ‚Ğ¾ Ñ„Ğ°ĞºÑ‚Ğ¸Ñ‡ĞµÑĞºĞ¾Ğµ ĞºĞ¾Ğ»Ğ¸Ñ‡ĞµÑÑ‚Ğ²Ğ¾ ÑĞ»ĞµĞ¼ĞµĞ½Ñ‚Ğ¾Ğ² Ğ´Ğ»Ñ Ğ¾Ñ‚Ğ¾Ğ±Ñ€Ğ°Ğ¶ĞµĞ½Ğ¸Ñ, Ğ¾Ğ³Ñ€Ğ°Ğ½Ğ¸Ñ‡ĞµĞ½Ğ½Ğ¾Ğµ `totalCount`.
    const [visibleCount, setVisibleCount] = useState(12);

    // `increaseVisibleCount` Ğ¾Ğ±Ğ½Ğ¾Ğ²Ğ»ÑĞµÑ‚ Ğ½Ğ°Ğ¼ĞµÑ€ĞµĞ½Ğ¸Ğµ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ñ ÑƒĞ²Ğ¸Ğ´ĞµÑ‚ÑŒ Ğ±Ğ¾Ğ»ÑŒÑˆĞµ ÑĞ»ĞµĞ¼ĞµĞ½Ñ‚Ğ¾Ğ².
    const increaseVisibleCount = (step: number = 12) => {
        setIntendedSize((prev) => prev + step);
    };

    // `setVisibility` (Ğ¿ĞµÑ€ĞµĞ¸Ğ¼ĞµĞ½Ğ¾Ğ²Ğ°Ğ½Ğ° Ğ´Ğ»Ñ ÑÑĞ½Ğ¾ÑÑ‚Ğ¸ Ğ² `setIntendedSize`) Ğ²Ñ‹Ğ·Ñ‹Ğ²Ğ°ĞµÑ‚ÑÑ ĞºĞ½Ğ¾Ğ¿ĞºĞ°Ğ¼Ğ¸ "12", "24", Ğ¸ Ñ‚.Ğ´.
    const setVisibility = (count: number) => {
        setIntendedSize(count);
    };

    // Ğ­Ñ‚Ğ¾Ñ‚ useEffect ÑĞ¸Ğ½Ñ…Ñ€Ğ¾Ğ½Ğ¸Ğ·Ğ¸Ñ€ÑƒĞµÑ‚ Ñ„Ğ°ĞºÑ‚Ğ¸Ñ‡ĞµÑĞºĞ¾Ğµ ĞºĞ¾Ğ»Ğ¸Ñ‡ĞµÑÑ‚Ğ²Ğ¾ Ğ²Ğ¸Ğ´Ğ¸Ğ¼Ñ‹Ñ… ÑĞ»ĞµĞ¼ĞµĞ½Ñ‚Ğ¾Ğ².
    // ĞĞ½ ÑÑ€Ğ°Ğ±Ğ°Ñ‚Ñ‹Ğ²Ğ°ĞµÑ‚, ĞºĞ¾Ğ³Ğ´Ğ° Ğ¼ĞµĞ½ÑĞµÑ‚ÑÑ Ğ»Ğ¸Ğ±Ğ¾ Ğ½Ğ°Ğ¼ĞµÑ€ĞµĞ½Ğ¸Ğµ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ñ (`intendedSize`), Ğ»Ğ¸Ğ±Ğ¾ Ğ¾Ğ±Ñ‰ĞµĞµ ĞºĞ¾Ğ»Ğ¸Ñ‡ĞµÑÑ‚Ğ²Ğ¾ ÑĞ»ĞµĞ¼ĞµĞ½Ñ‚Ğ¾Ğ² (`totalCount`).
    useEffect(() => {
        // Ğ•ÑĞ»Ğ¸ Ğ¾Ğ±Ñ‰ĞµĞµ ĞºĞ¾Ğ»Ğ¸Ñ‡ĞµÑÑ‚Ğ²Ğ¾ Ñ€Ğ°Ğ²Ğ½Ğ¾ 0, Ğ½Ğ¸Ñ‡ĞµĞ³Ğ¾ Ğ½Ğµ Ğ¿Ğ¾ĞºĞ°Ğ·Ñ‹Ğ²Ğ°ĞµĞ¼.
        if (totalCount === 0) {
            setVisibleCount(0);
        } else {
            // Ğ’ Ğ¾ÑÑ‚Ğ°Ğ»ÑŒĞ½Ñ‹Ñ… ÑĞ»ÑƒÑ‡Ğ°ÑÑ… Ğ¿Ğ¾ĞºĞ°Ğ·Ñ‹Ğ²Ğ°ĞµĞ¼ Ğ¼ĞµĞ½ÑŒÑˆĞµĞµ Ğ¸Ğ· Ğ´Ğ²ÑƒÑ…:
            // Ğ»Ğ¸Ğ±Ğ¾ ÑĞºĞ¾Ğ»ÑŒĞºĞ¾ Ñ…Ğ¾Ñ‡ĞµÑ‚ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ÑŒ, Ğ»Ğ¸Ğ±Ğ¾ ÑĞºĞ¾Ğ»ÑŒĞºĞ¾ ĞµÑÑ‚ÑŒ Ğ²ÑĞµĞ³Ğ¾.
            setVisibleCount(Math.min(intendedSize, totalCount));
        }
    }, [intendedSize, totalCount]);

    return { visibleCount, setVisibleCount: setVisibility, increaseVisibleCount };
}

```


## <a name="srcindexcss"></a>`src/index.css`

```css
// path: src/index.css

@tailwind base;
@tailwind components;
@tailwind utilities;

/* Ğ‘Ğ°Ğ·Ğ¾Ğ²Ñ‹Ğµ ÑÑ‚Ğ¸Ğ»Ğ¸ html/body */
html,
body {
  margin: 0;
  padding: 0;
  min-height: 100vh;
  background-color: #f9fafb; /* Tailwind gray-50 */
  color: #111827; /* Tailwind gray-900 */
  font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI",
  Roboto, Helvetica, Arial, sans-serif;
  line-height: 1.5;
  -webkit-font-smoothing: antialiased;
}

a {
  color: inherit;
  text-decoration: none;
}

button {
  cursor: pointer;
  font-family: inherit;
}


@layer base {
  :root {
    --background: 0 0% 100%;
    --foreground: 0 0% 3.9%;
    --card: 0 0% 100%;
    --card-foreground: 0 0% 3.9%;
    --popover: 0 0% 100%;
    --popover-foreground: 0 0% 3.9%;
    --primary: 0 0% 9%;
    --primary-foreground: 0 0% 98%;
    --secondary: 0 0% 96.1%;
    --secondary-foreground: 0 0% 9%;
    --muted: 0 0% 96.1%;
    --muted-foreground: 0 0% 45.1%;
    --accent: 0 0% 96.1%;
    --accent-foreground: 0 0% 9%;
    --destructive: 0 84.2% 60.2%;
    --destructive-foreground: 0 0% 98%;
    --border: 0 0% 89.8%;
    --input: 0 0% 89.8%;
    --ring: 0 0% 3.9%;
    --chart-1: 12 76% 61%;
    --chart-2: 173 58% 39%;
    --chart-3: 197 37% 24%;
    --chart-4: 43 74% 66%;
    --chart-5: 27 87% 67%;
    --radius: 0.5rem;
  }
  .dark {
    --background: 0 0% 3.9%;
    --foreground: 0 0% 98%;
    --card: 0 0% 3.9%;
    --card-foreground: 0 0% 98%;
    --popover: 0 0% 3.9%;
    --popover-foreground: 0 0% 98%;
    --primary: 0 0% 98%;
    --primary-foreground: 0 0% 9%;
    --secondary: 0 0% 14.9%;
    --secondary-foreground: 0 0% 98%;
    --muted: 0 0% 14.9%;
    --muted-foreground: 0 0% 63.9%;
    --accent: 0 0% 14.9%;
    --accent-foreground: 0 0% 98%;
    --destructive: 0 62.8% 30.6%;
    --destructive-foreground: 0 0% 98%;
    --border: 0 0% 14.9%;
    --input: 0 0% 14.9%;
    --ring: 0 0% 83.1%;
    --chart-1: 220 70% 50%;
    --chart-2: 160 60% 45%;
    --chart-3: 30 80% 55%;
    --chart-4: 280 65% 60%;
    --chart-5: 340 75% 55%;
  }
}

@layer base {
  * {
    @apply border-border;
  }
  body {
    @apply bg-background text-foreground;
  }
}

/* ĞŸĞ¾Ğ´ÑĞ²ĞµÑ‚ĞºĞ° Ğ²ĞµÑ€Ñ‚Ğ¸ĞºĞ°Ğ»ÑŒĞ½Ğ¾Ğ³Ğ¾ ÑÑ‚Ğ¾Ğ»Ğ±Ñ†Ğ° "Ğ¡ĞµĞ³Ğ¾Ğ´Ğ½Ñ" */
.today-column {
  box-shadow: inset -1px 0 0 0 rgba(59, 130, 246, 0.5),
    /* sky-500 */ inset 1px 0 0 0 rgba(59, 130, 246, 0.5);
}

/* === Ğ¡Ğ¢Ğ˜Ğ›Ğ˜ Ğ”Ğ›Ğ¯ REACT-DAY-PICKER === */
/* Ğ£Ğ´Ğ°Ğ»ÑĞµĞ¼ ÑÑ‚Ğ°Ñ€Ñ‹Ğ¹ Ğ±Ğ»Ğ¾Ğº ÑÑ‚Ğ¸Ğ»ĞµĞ¹ Ğ¸ Ğ·Ğ°Ğ¼ĞµĞ½ÑĞµĞ¼ ĞµĞ³Ğ¾ Ğ½Ğ° ÑÑ‚Ğ¾Ñ‚ */
@layer components {
  .day-range-start {
    @apply rounded-r-none;
  }
  .day-range-end {
    @apply rounded-l-none;
  }
  .day-outside {
    @apply text-muted-foreground opacity-50;
  }
}

/* Ğ’ ÑĞ°Ğ¼Ñ‹Ğ¹ ĞºĞ¾Ğ½ĞµÑ† Ñ„Ğ°Ğ¹Ğ»Ğ° src/index.css */

.super-test-border {
  border: 10px dashed lime !important;
}


@layer components {
  /* Ğ‘Ğ°Ğ·Ğ¾Ğ²Ñ‹Ğ¹ ÑÑ‚Ğ¸Ğ»ÑŒ Ğ´Ğ»Ñ Ğ²Ñ‹Ğ±Ñ€Ğ°Ğ½Ğ½Ğ¾Ğ³Ğ¾ Ğ´Ğ½Ñ (ĞºÑ€ÑƒĞ¶Ğ¾Ğº) */
  .day-selected {
    @apply bg-sky-600 text-white hover:bg-sky-700 focus:bg-sky-700 rounded-full;
  }

  /* ĞĞ°Ñ‡Ğ°Ğ»Ğ¾ Ğ´Ğ¸Ğ°Ğ¿Ğ°Ğ·Ğ¾Ğ½Ğ° - ÑĞºÑ€ÑƒĞ³Ğ»ĞµĞ½Ğ¸Ğµ Ñ‚Ğ¾Ğ»ÑŒĞºĞ¾ ÑĞ»ĞµĞ²Ğ° */
  .day-range-start {
    @apply rounded-r-none;
  }

  /* ĞšĞ¾Ğ½ĞµÑ† Ğ´Ğ¸Ğ°Ğ¿Ğ°Ğ·Ğ¾Ğ½Ğ° - ÑĞºÑ€ÑƒĞ³Ğ»ĞµĞ½Ğ¸Ğµ Ñ‚Ğ¾Ğ»ÑŒĞºĞ¾ ÑĞ¿Ñ€Ğ°Ğ²Ğ° */
  .day-range-end {
    @apply rounded-l-none;
  }

  /* Ğ”Ğ½Ğ¸ Ğ² ÑĞµÑ€ĞµĞ´Ğ¸Ğ½Ğµ Ğ´Ğ¸Ğ°Ğ¿Ğ°Ğ·Ğ¾Ğ½Ğ° - ÑƒĞ±Ğ¸Ñ€Ğ°ĞµĞ¼ ÑĞºÑ€ÑƒĞ³Ğ»ĞµĞ½Ğ¸Ğµ Ğ¸ Ğ´Ğ¾Ğ±Ğ°Ğ²Ğ»ÑĞµĞ¼ Ñ„Ğ¾Ğ½ */
  .day-range-middle {
    @apply bg-sky-100 text-gray-800 rounded-none hover:bg-sky-200;
  }
}




```


## <a name="srclibapits"></a>`src/lib/api.ts`

```typescript
// path: src/lib/api.ts

import axios from "axios"

// Ğ’ÑĞ¿Ğ¾Ğ¼Ğ¾Ğ³Ğ°Ñ‚ĞµĞ»ÑŒĞ½Ğ°Ñ Ñ„ÑƒĞ½ĞºÑ†Ğ¸Ñ Ğ´Ğ»Ñ Ğ¿Ğ¾Ğ»ÑƒÑ‡ĞµĞ½Ğ¸Ñ Ğ·Ğ½Ğ°Ñ‡ĞµĞ½Ğ¸Ñ cookie Ğ¿Ğ¾ Ğ¸Ğ¼ĞµĞ½Ğ¸
function getCookie(name: string): string | null {
  const match = document.cookie.match(new RegExp('(^| )' + name + '=([^;]+)'));
  if (match) {
    return match[2];
  }
  return null;
}

export const api = axios.create({
  baseURL: "http://localhost:8000", // Ğ¸Ğ»Ğ¸ Ğ°ĞºÑ‚ÑƒĞ°Ğ»ÑŒĞ½Ñ‹Ğ¹ Ñ…Ğ¾ÑÑ‚ [cite: 1]
})

// Interceptor Ğ´Ğ»Ñ Ğ¾Ğ±Ñ€Ğ°Ğ±Ğ¾Ñ‚ĞºĞ¸ Ğ¾Ñ‚Ğ²ĞµÑ‚Ğ¾Ğ²
api.interceptors.response.use(
  (response) => response,
  (error) => {
    // Ğ•ÑĞ»Ğ¸ Ğ¿Ğ¾Ğ»ÑƒÑ‡Ğ°ĞµĞ¼ 401 Ğ¾ÑˆĞ¸Ğ±ĞºÑƒ, Ğ¾Ñ‡Ğ¸Ñ‰Ğ°ĞµĞ¼ Ñ‚Ğ¾ĞºĞµĞ½
    if (error.response?.status === 401) {
      localStorage.removeItem("access_token");
    }
    return Promise.reject(error);
  }
)

// Interceptor Ğ´Ğ»Ñ Ğ´Ğ¾Ğ±Ğ°Ğ²Ğ»ĞµĞ½Ğ¸Ñ Ñ‚Ğ¾ĞºĞµĞ½Ğ¾Ğ² (Authorization Ğ¸ CSRF)
api.interceptors.request.use(
    (config) => {
      // 1. Ğ”Ğ¾Ğ±Ğ°Ğ²Ğ»ÑĞµĞ¼ Authorization: Bearer <token>
      const accessToken = localStorage.getItem("access_token") // [cite: 1]
      if (accessToken) {
        config.headers.Authorization = `Bearer ${accessToken}` // [cite: 1]
      }

      // 2. Ğ”Ğ¾Ğ±Ğ°Ğ²Ğ»ÑĞµĞ¼ CSRF-Ñ‚Ğ¾ĞºĞµĞ½
      // Ğ‘ÑĞºĞµĞ½Ğ´ (fastapi-csrf-protect) Ğ¾Ğ±Ñ‹Ñ‡Ğ½Ğ¾ ÑƒÑÑ‚Ğ°Ğ½Ğ°Ğ²Ğ»Ğ¸Ğ²Ğ°ĞµÑ‚ CSRF-Ñ‚Ğ¾ĞºĞµĞ½ Ğ² cookie
      // Ñ Ğ¸Ğ¼ĞµĞ½ĞµĞ¼ 'fastapi-csrf-token'. Ğ¤Ñ€Ğ¾Ğ½Ñ‚ĞµĞ½Ğ´ Ğ´Ğ¾Ğ»Ğ¶ĞµĞ½ Ğ¿Ñ€Ğ¾Ñ‡Ğ¸Ñ‚Ğ°Ñ‚ÑŒ ĞµĞ³Ğ¾
      // Ğ¸ Ğ¾Ñ‚Ğ¿Ñ€Ğ°Ğ²Ğ¸Ñ‚ÑŒ Ğ² Ğ·Ğ°Ğ³Ğ¾Ğ»Ğ¾Ğ²ĞºĞµ 'X-CSRF-Token'.
      // Ğ­Ñ‚Ğ¾ Ğ½ÑƒĞ¶Ğ½Ğ¾ Ğ´Ğ»Ñ Ğ¼ĞµÑ‚Ğ¾Ğ´Ğ¾Ğ², Ğ¸Ğ·Ğ¼ĞµĞ½ÑÑÑ‰Ğ¸Ñ… ÑĞ¾ÑÑ‚Ğ¾ÑĞ½Ğ¸Ğµ (POST, PUT, DELETE, PATCH).
      const csrfToken = getCookie("fastapi-csrf-token") // Ğ˜Ğ¼Ñ cookie Ğ¾Ñ‚ fastapi-csrf-protect
      if (csrfToken) {
        config.headers["X-CSRF-Token"] = csrfToken
      }

      // Ğ›Ğ¾Ğ³Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ Ğ´Ğ»Ñ Ğ¾Ñ‚Ğ»Ğ°Ğ´ĞºĞ¸ (Ğ¼Ğ¾Ğ¶Ğ½Ğ¾ ÑƒĞ±Ñ€Ğ°Ñ‚ÑŒ Ğ² production)
      // console.log("Request Config:", config.method?.toUpperCase(), config.url, config.headers);

      return config
    },
    (error) => {
      // ĞĞ±Ñ€Ğ°Ğ±Ğ¾Ñ‚ĞºĞ° Ğ¾ÑˆĞ¸Ğ±Ğ¾Ğº Ğ·Ğ°Ğ¿Ñ€Ğ¾ÑĞ° (ĞµÑĞ»Ğ¸ Ğ½ÑƒĞ¶Ğ½Ğ¾)
      return Promise.reject(error)
    }
)

```


## <a name="srclibqueryClientts"></a>`src/lib/queryClient.ts`

```typescript
// path: src/lib/queryClient.ts

// src/lib/queryClient.ts
import { QueryClient, QueryCacheNotifyEvent, Query } from "@tanstack/react-query"

export const queryClient = new QueryClient({
    defaultOptions: {
        queries: {
            staleTime: 1000 * 60,
            refetchOnWindowFocus: true,
            retry: 1
        }
    }
})

// ğŸ”§ ĞŸĞ¾Ğ´Ğ¿Ğ¸ÑĞºĞ° Ğ½Ğ° ÑĞ¾Ğ±Ñ‹Ñ‚Ğ¸Ñ Ğ¾ÑˆĞ¸Ğ±Ğ¾Ğº Ğ² ĞºÑÑˆĞµ
queryClient.getQueryCache().subscribe((event: QueryCacheNotifyEvent) => {
    // ĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑĞµĞ¼, ÑĞ¾Ğ´ĞµÑ€Ğ¶Ğ¸Ñ‚ Ğ»Ğ¸ ÑĞ¾Ğ±Ñ‹Ñ‚Ğ¸Ğµ Ğ¾Ğ±ÑŠĞµĞºÑ‚ Query
    const query = 'query' in event ? (event as { query: Query }).query : undefined

    if (
        query?.state.status === "error" &&
        isUnauthorizedError(query.state.error)
    ) {
        handleUnauthorized()
    }
})

function isUnauthorizedError(error: unknown): boolean {
    return error instanceof Error && error.message.includes("401")
}

function handleUnauthorized() {
    localStorage.removeItem("access_token")
    window.location.href = "/"
}


```


## <a name="srclibqueryHelpersts"></a>`src/lib/queryHelpers.ts`

```typescript
// path: src/lib/queryHelpers.ts

import { toast } from "sonner"

export function handleQueryError(error: unknown) {
    const message =
        error instanceof Error
            ? error.message
            : typeof error === "string"
                ? error
                : "ĞĞµĞ¸Ğ·Ğ²ĞµÑÑ‚Ğ½Ğ°Ñ Ğ¾ÑˆĞ¸Ğ±ĞºĞ° Ğ·Ğ°Ğ¿Ñ€Ğ¾ÑĞ°"
    toast.error(message)
    console.error("[Query error]", error)
}


```


## <a name="srclibsortingUtilsts"></a>`src/lib/sortingUtils.ts`

```typescript
// path: src/lib/sortingUtils.ts

// src/lib/sortingUtils.ts

import { differenceInDays } from "date-fns";
import type { PickupReturnItem, OverdueRentalItem } from "@/hooks/admin/useDashboardData";

/**
 * Ğ¡Ğ¾Ñ€Ñ‚Ğ¸Ñ€ÑƒĞµÑ‚ Ğ²Ñ‹Ğ´Ğ°Ñ‡Ğ¸ Ğ¿Ğ¾ Ğ¿Ñ€Ğ¸Ğ¾Ñ€Ğ¸Ñ‚ĞµÑ‚Ñƒ:
 * 1. Ğ’Ñ‹Ğ´Ğ°Ñ‡Ğ¸ Ğ½Ğ° ÑĞµĞ³Ğ¾Ğ´Ğ½Ñ (Ğ±ĞµĞ· start_date Ğ¸Ğ»Ğ¸ start_date = ÑĞµĞ³Ğ¾Ğ´Ğ½Ñ)
 * 2. ĞŸÑ€Ğ¾ÑÑ€Ğ¾Ñ‡ĞµĞ½Ğ½Ñ‹Ğµ Ğ²Ñ‹Ğ´Ğ°Ñ‡Ğ¸ Ğ¿Ğ¾ ĞºĞ¾Ğ»Ğ¸Ñ‡ĞµÑÑ‚Ğ²Ñƒ Ğ´Ğ½ĞµĞ¹ Ğ¿Ñ€Ğ¾ÑÑ€Ğ¾Ñ‡ĞºĞ¸ (Ğ¿Ğ¾ Ğ²Ğ¾Ğ·Ñ€Ğ°ÑÑ‚Ğ°Ğ½Ğ¸Ñ)
 */
export const sortPickupsByPriority = (pickups: PickupReturnItem[], today: Date): PickupReturnItem[] => {
    return [...pickups].sort((a, b) => {
        const aStartDate = a.start_date ? new Date(a.start_date) : null;
        const bStartDate = b.start_date ? new Date(b.start_date) : null;
        
        // Ğ•ÑĞ»Ğ¸ Ñƒ ÑĞ»ĞµĞ¼ĞµĞ½Ñ‚Ğ° Ğ½ĞµÑ‚ start_date, ÑÑ‡Ğ¸Ñ‚Ğ°ĞµĞ¼ ĞµĞ³Ğ¾ Ğ²Ñ‹Ğ´Ğ°Ñ‡ĞµĞ¹ Ğ½Ğ° ÑĞµĞ³Ğ¾Ğ´Ğ½Ñ
        const aIsToday = !aStartDate || aStartDate.getTime() === today.getTime();
        const bIsToday = !bStartDate || bStartDate.getTime() === today.getTime();
        
        // Ğ¡Ğ½Ğ°Ñ‡Ğ°Ğ»Ğ° Ğ²Ñ‹Ğ´Ğ°Ñ‡Ğ¸ Ğ½Ğ° ÑĞµĞ³Ğ¾Ğ´Ğ½Ñ
        if (aIsToday && !bIsToday) return -1;
        if (!aIsToday && bIsToday) return 1;
        
        // Ğ•ÑĞ»Ğ¸ Ğ¾Ğ±Ğ° Ğ½Ğµ Ğ½Ğ° ÑĞµĞ³Ğ¾Ğ´Ğ½Ñ, ÑĞ¾Ñ€Ñ‚Ğ¸Ñ€ÑƒĞµĞ¼ Ğ¿Ğ¾ ĞºĞ¾Ğ»Ğ¸Ñ‡ĞµÑÑ‚Ğ²Ñƒ Ğ´Ğ½ĞµĞ¹ Ğ¿Ñ€Ğ¾ÑÑ€Ğ¾Ñ‡ĞºĞ¸
        if (!aIsToday && !bIsToday) {
            const aDaysPassed = aStartDate ? differenceInDays(today, aStartDate) : 0;
            const bDaysPassed = bStartDate ? differenceInDays(today, bStartDate) : 0;
            return aDaysPassed - bDaysPassed; // ĞœĞµĞ½ÑŒÑˆĞµ Ğ´Ğ½ĞµĞ¹ Ğ¿Ñ€Ğ¾ÑÑ€Ğ¾Ñ‡ĞºĞ¸ - Ğ²Ñ‹ÑˆĞµ Ğ² ÑĞ¿Ğ¸ÑĞºĞµ
        }
        
        return 0;
    });
};

/**
 * Ğ¡Ğ¾Ñ€Ñ‚Ğ¸Ñ€ÑƒĞµÑ‚ Ğ¿Ñ€Ğ¾ÑÑ€Ğ¾Ñ‡ĞµĞ½Ğ½Ñ‹Ğµ Ğ°Ñ€ĞµĞ½Ğ´Ñ‹ Ğ¿Ğ¾ ĞºĞ¾Ğ»Ğ¸Ñ‡ĞµÑÑ‚Ğ²Ñƒ Ğ´Ğ½ĞµĞ¹ Ğ¿Ñ€Ğ¾ÑÑ€Ğ¾Ñ‡ĞºĞ¸ (Ğ¿Ğ¾ Ğ²Ğ¾Ğ·Ñ€Ğ°ÑÑ‚Ğ°Ğ½Ğ¸Ñ)
 */
export const sortOverdueRentalsByDays = (overdueRentals: OverdueRentalItem[]): OverdueRentalItem[] => {
    return [...overdueRentals].sort((a, b) => {
        // Ğ˜ÑĞ¿Ğ¾Ğ»ÑŒĞ·ÑƒĞµĞ¼ days_overdue ĞµÑĞ»Ğ¸ ĞµÑÑ‚ÑŒ, Ğ¸Ğ½Ğ°Ñ‡Ğµ Ğ²Ñ‹Ñ‡Ğ¸ÑĞ»ÑĞµĞ¼ Ñ€Ğ°Ğ·Ğ½Ğ¾ÑÑ‚ÑŒ
        const aDaysOverdue = a.days_overdue ?? 0;
        const bDaysOverdue = b.days_overdue ?? 0;
        
        return aDaysOverdue - bDaysOverdue; // ĞœĞµĞ½ÑŒÑˆĞµ Ğ´Ğ½ĞµĞ¹ Ğ¿Ñ€Ğ¾ÑÑ€Ğ¾Ñ‡ĞºĞ¸ - Ğ²Ñ‹ÑˆĞµ Ğ² ÑĞ¿Ğ¸ÑĞºĞµ
    });
};

/**
 * Ğ¡Ğ¾Ğ·Ğ´Ğ°ĞµÑ‚ ÑĞµĞ³Ğ¾Ğ´Ğ½ÑÑˆĞ½ÑÑ Ğ´Ğ°Ñ‚Ñƒ Ñ Ğ¾Ğ±Ğ½ÑƒĞ»ĞµĞ½Ğ½Ñ‹Ğ¼ Ğ²Ñ€ĞµĞ¼ĞµĞ½ĞµĞ¼ Ğ´Ğ»Ñ ĞºĞ¾Ñ€Ñ€ĞµĞºÑ‚Ğ½Ğ¾Ğ³Ğ¾ ÑÑ€Ğ°Ğ²Ğ½ĞµĞ½Ğ¸Ñ
 */
export const getTodayDate = (): Date => {
    const today = new Date();
    today.setHours(0, 0, 0, 0);
    return today;
};


```


## <a name="srclibutilsts"></a>`src/lib/utils.ts`

```typescript
// path: src/lib/utils.ts

// src/lib/utils.ts

import { clsx, type ClassValue } from "clsx"
import { twMerge } from "tailwind-merge"

/**
 * Ğ¦ĞµĞ½Ñ‚Ñ€Ğ°Ğ»Ğ¸Ğ·Ğ¾Ğ²Ğ°Ğ½Ğ½Ğ¾ Ñ€Ğ°ÑÑÑ‡Ğ¸Ñ‚Ñ‹Ğ²Ğ°ĞµÑ‚ ĞºĞ¾Ğ»Ğ¸Ñ‡ĞµÑÑ‚Ğ²Ğ¾ Ñ‚Ğ°Ñ€Ğ¸Ñ„Ğ¸Ñ†Ğ¸Ñ€ÑƒĞµĞ¼Ñ‹Ñ… Ğ´Ğ½ĞµĞ¹ (Ğ½Ğ¾Ñ‡ĞµĞ¹), Ğ²Ñ‹Ñ‡Ğ¸Ñ‚Ğ°Ñ Ğ¿Ñ€Ğ°Ğ·Ğ´Ğ½Ğ¸ĞºĞ¸.
 * @param start - Ğ”Ğ°Ñ‚Ğ° Ğ½Ğ°Ñ‡Ğ°Ğ»Ğ°
 * @param end - Ğ”Ğ°Ñ‚Ğ° Ğ¾ĞºĞ¾Ğ½Ñ‡Ğ°Ğ½Ğ¸Ñ
 * @param holidays - ĞœĞ°ÑÑĞ¸Ğ² Ğ´Ğ°Ñ‚, ÑĞ²Ğ»ÑÑÑ‰Ğ¸Ñ…ÑÑ Ğ²Ñ‹Ñ…Ğ¾Ğ´Ğ½Ñ‹Ğ¼Ğ¸
 * @returns ĞšĞ¾Ğ»Ğ¸Ñ‡ĞµÑÑ‚Ğ²Ğ¾ Ñ‚Ğ°Ñ€Ğ¸Ñ„Ğ¸Ñ†Ğ¸Ñ€ÑƒĞµĞ¼Ñ‹Ñ… Ğ´Ğ½ĞµĞ¹.
 */
export function calculateDayCount(
    start?: Date | null,
    end?: Date | null,
    holidays: Date[] = []
): number {
  // ĞŸÑ€Ğ¾Ğ²ĞµÑ€ĞºĞ° Ğ½Ğ° ĞºĞ¾Ñ€Ñ€ĞµĞºÑ‚Ğ½Ğ¾ÑÑ‚ÑŒ Ğ´Ğ°Ñ‚
  if (!start || !end || start >= end) {
    return 0;
  }

  // Ğ¡Ñ‡Ğ¸Ñ‚Ğ°ĞµĞ¼ Ğ¾Ğ±Ñ‰ĞµĞµ ĞºĞ¾Ğ»Ğ¸Ñ‡ĞµÑÑ‚Ğ²Ğ¾ "Ğ½Ğ¾Ñ‡ĞµĞ¹"
  const totalDays = Math.round((end.getTime() - start.getTime()) / (1000 * 60 * 60 * 24));

  if (holidays.length === 0) {
    return Math.max(0, totalDays);
  }

  // Ğ¡Ğ¾Ğ·Ğ´Ğ°ĞµĞ¼ Ğ¼Ğ½Ğ¾Ğ¶ĞµÑÑ‚Ğ²Ğ¾ Ğ´Ğ°Ñ‚ Ğ¿Ñ€Ğ°Ğ·Ğ´Ğ½Ğ¸ĞºĞ¾Ğ² (Ğ² Ñ„Ğ¾Ñ€Ğ¼Ğ°Ñ‚Ğµ YYYY-MM-DD) Ğ´Ğ»Ñ Ğ±Ñ‹ÑÑ‚Ñ€Ğ¾Ğ¹ Ğ¿Ñ€Ğ¾Ğ²ĞµÑ€ĞºĞ¸
  const holidaySet = new Set(holidays.map(h => formatDate(h)));

  let nonBillableDays = 0;
  // ĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑĞµĞ¼ ĞºĞ°Ğ¶Ğ´Ñ‹Ğ¹ Ğ´ĞµĞ½ÑŒ Ğ²Ğ½ÑƒÑ‚Ñ€Ğ¸ Ğ´Ğ¸Ğ°Ğ¿Ğ°Ğ·Ğ¾Ğ½Ğ°
  for (let i = 0; i < totalDays; i++) {
    const currentDay = new Date(start);
    currentDay.setDate(start.getDate() + i);

    // ĞŸÑ€Ğ¾Ğ¿ÑƒÑĞºĞ°ĞµĞ¼ ÑĞ°Ğ¼ Ğ´ĞµĞ½ÑŒ Ğ½Ğ°Ñ‡Ğ°Ğ»Ğ°, Ñ‚Ğ°Ğº ĞºĞ°Ğº Ğ¿Ğ¾ Ğ¿Ñ€Ğ°Ğ²Ğ¸Ğ»Ğ°Ğ¼ Ğ¾Ğ½ Ñ‚Ğ°Ñ€Ğ¸Ñ„Ğ¸Ñ†Ğ¸Ñ€ÑƒĞµÑ‚ÑÑ
    if (i === 0) continue;

    if (holidaySet.has(formatDate(currentDay))) {
      nonBillableDays++;
    }
  }

  return Math.max(0, totalDays - nonBillableDays);
}

/**
 * Ğ£Ğ½Ğ¸Ğ²ĞµÑ€ÑĞ°Ğ»ÑŒĞ½Ñ‹Ğ¹ Ñ„Ğ¾Ñ€Ğ¼Ğ°Ñ‚Ñ‚ĞµÑ€ Ğ´Ğ°Ñ‚Ñ‹ (YYYY-MM-DD)
 * ĞŸÑ€Ğ¸Ğ½Ğ¸Ğ¼Ğ°ĞµÑ‚ Date Ğ¸Ğ»Ğ¸ ÑÑ‚Ñ€Ğ¾ĞºÑƒ, Ğ²Ğ¾Ğ·Ğ²Ñ€Ğ°Ñ‰Ğ°ĞµÑ‚ ÑÑ‚Ñ€Ğ¾ĞºÑƒ Ğ² Ñ„Ğ¾Ñ€Ğ¼Ğ°Ñ‚Ğµ '2024-05-21'
 * Ğ˜ÑĞ¿Ğ¾Ğ»ÑŒĞ·ÑƒĞµÑ‚ÑÑ Ğ´Ğ»Ñ API Ğ¸ input[type="date"]
 */
export function formatDate(date: Date | string | null | undefined): string {
  if (!date) return "";
  const d = typeof date === "string" ? new Date(date) : date;
  if (isNaN(d.getTime())) return "";
  const year = d.getFullYear();
  const month = String(d.getMonth() + 1).padStart(2, "0");
  const day = String(d.getDate()).padStart(2, "0");
  return `${year}-${month}-${day}`;
}

/**
 * Ğ¤Ğ¾Ñ€Ğ¼Ğ°Ñ‚Ñ‚ĞµÑ€ Ğ´Ğ°Ñ‚Ñ‹ Ğ´Ğ»Ñ UI (Ğ”Ğ”.ĞœĞœ.Ğ“Ğ“Ğ“Ğ“)
 * ĞŸÑ€Ğ¸Ğ½Ğ¸Ğ¼Ğ°ĞµÑ‚ Date Ğ¸Ğ»Ğ¸ ÑÑ‚Ñ€Ğ¾ĞºÑƒ, Ğ²Ğ¾Ğ·Ğ²Ñ€Ğ°Ñ‰Ğ°ĞµÑ‚ ÑÑ‚Ñ€Ğ¾ĞºÑƒ Ğ² Ñ„Ğ¾Ñ€Ğ¼Ğ°Ñ‚Ğµ '21.05.2024'
 * Ğ˜ÑĞ¿Ğ¾Ğ»ÑŒĞ·ÑƒĞµÑ‚ÑÑ Ñ‚Ğ¾Ğ»ÑŒĞºĞ¾ Ğ´Ğ»Ñ Ğ²Ñ‹Ğ²Ğ¾Ğ´Ğ° Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ñ!
 */
export function formatDateEuropean(date: Date | string | null | undefined): string {
  if (!date) return "";
  const d = typeof date === "string" ? new Date(date) : date;
  if (isNaN(d.getTime())) return "";
  const day = String(d.getDate()).padStart(2, "0");
  const month = String(d.getMonth() + 1).padStart(2, "0");
  const year = d.getFullYear();
  return `${day}.${month}.${year}`;
}

/**
 * Ğ¤Ğ¾Ñ€Ğ¼Ğ°Ñ‚Ñ‚ĞµÑ€ Ğ´Ğ¸Ğ°Ğ¿Ğ°Ğ·Ğ¾Ğ½Ğ° Ğ´Ğ°Ñ‚ Ğ´Ğ»Ñ UI (Ğ½Ğ°Ğ¿Ñ€Ğ¸Ğ¼ĞµÑ€: 21.05.2024 â€” 28.05.2024)
 */
export function formatDateRangeEuropean(start?: Date | string | null, end?: Date | string | null): string {
  if (!start || !end) return "";
  return `${formatDateEuropean(start)} â€” ${formatDateEuropean(end)}`;
}

/**
 * Ğ‘ĞµĞ·Ğ¾Ğ¿Ğ°ÑĞ½Ğ¾ Ñ„Ğ¾Ñ€Ğ¼Ğ°Ñ‚Ğ¸Ñ€ÑƒĞµÑ‚ Ñ‡Ğ¸ÑĞ»Ğ¾Ğ²Ğ¾Ğµ Ğ·Ğ½Ğ°Ñ‡ĞµĞ½Ğ¸Ğµ Ğ² ÑÑ‚Ñ€Ğ¾ĞºÑƒ Ñ Ñ€Ğ°Ğ·Ğ´ĞµĞ»Ğ¸Ñ‚ĞµĞ»ÑĞ¼Ğ¸ Ñ‚Ñ‹ÑÑÑ‡
 * @param value - Ñ‡Ğ¸ÑĞ»Ğ¾Ğ²Ğ¾Ğµ Ğ·Ğ½Ğ°Ñ‡ĞµĞ½Ğ¸Ğµ Ğ´Ğ»Ñ Ñ„Ğ¾Ñ€Ğ¼Ğ°Ñ‚Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ
 * @param fallback - Ğ·Ğ½Ğ°Ñ‡ĞµĞ½Ğ¸Ğµ Ğ¿Ğ¾ ÑƒĞ¼Ğ¾Ğ»Ñ‡Ğ°Ğ½Ğ¸Ñ, ĞµÑĞ»Ğ¸ value Ğ½Ğµ Ğ¾Ğ¿Ñ€ĞµĞ´ĞµĞ»ĞµĞ½Ğ¾
 * @returns Ğ¾Ñ‚Ñ„Ğ¾Ñ€Ğ¼Ğ°Ñ‚Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ½Ğ°Ñ ÑÑ‚Ñ€Ğ¾ĞºĞ°
 */
export function formatNumber(value: number | null | undefined, fallback: string = "0"): string {
  if (value === null || value === undefined || isNaN(value)) {
    return fallback;
  }
  return value.toLocaleString('ru-RU');
}

/**
 * Ğ£Ñ‚Ğ¸Ğ»Ğ¸Ñ‚Ğ° Ğ¾Ğ±ÑŠĞµĞ´Ğ¸Ğ½ĞµĞ½Ğ¸Ñ ĞºĞ»Ğ°ÑÑĞ¾Ğ² Ñ Ğ¿Ğ¾Ğ´Ğ´ĞµÑ€Ğ¶ĞºĞ¾Ğ¹ Tailwind Ğ¸ clsx
 */
export function cn(...inputs: ClassValue[]) {
  return twMerge(clsx(inputs));
}

/**
 * Ğ’Ñ‹Ñ‡Ğ¸ÑĞ»ÑĞµÑ‚ ĞºĞ¾Ğ»Ğ¸Ñ‡ĞµÑÑ‚Ğ²Ğ¾ Ğ´Ğ½ĞµĞ¹ Ğ¿Ñ€Ğ¾ÑÑ€Ğ¾Ñ‡ĞºĞ¸ Ğ´Ğ»Ñ Ğ°Ñ€ĞµĞ½Ğ´Ñ‹
 * @param dueDate - Ğ”Ğ°Ñ‚Ğ° Ğ²Ğ¾Ğ·Ğ²Ñ€Ğ°Ñ‚Ğ° (ÑÑ‚Ñ€Ğ¾ĞºĞ° Ğ¸Ğ»Ğ¸ Date)
 * @param daysOverdue - ĞšĞ¾Ğ»Ğ¸Ñ‡ĞµÑÑ‚Ğ²Ğ¾ Ğ´Ğ½ĞµĞ¹ Ğ¿Ñ€Ğ¾ÑÑ€Ğ¾Ñ‡ĞºĞ¸ Ñ Ğ±ÑĞºĞµĞ½Ğ´Ğ° (ĞµÑĞ»Ğ¸ ĞµÑÑ‚ÑŒ)
 * @returns ĞšĞ¾Ğ»Ğ¸Ñ‡ĞµÑÑ‚Ğ²Ğ¾ Ğ´Ğ½ĞµĞ¹ Ğ¿Ñ€Ğ¾ÑÑ€Ğ¾Ñ‡ĞºĞ¸
 */
export function calculateDaysOverdue(dueDate: string | Date | null | undefined, daysOverdue?: number | null): number {
  // Ğ•ÑĞ»Ğ¸ Ğ±ÑĞºĞµĞ½Ğ´ Ğ¿Ñ€ĞµĞ´Ğ¾ÑÑ‚Ğ°Ğ²Ğ¸Ğ» ĞºĞ¾Ğ»Ğ¸Ñ‡ĞµÑÑ‚Ğ²Ğ¾ Ğ´Ğ½ĞµĞ¹ Ğ¿Ñ€Ğ¾ÑÑ€Ğ¾Ñ‡ĞºĞ¸, Ğ¸ÑĞ¿Ğ¾Ğ»ÑŒĞ·ÑƒĞµĞ¼ ĞµĞ³Ğ¾
  if (daysOverdue !== undefined && daysOverdue !== null) {
    return daysOverdue;
  }
  
  // ĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑĞµĞ¼, Ñ‡Ñ‚Ğ¾ dueDate Ğ²Ğ°Ğ»Ğ¸Ğ´ĞµĞ½
  if (!dueDate) {
    return 0;
  }
  
  // Ğ’Ñ‹Ñ‡Ğ¸ÑĞ»ÑĞµĞ¼ Ğ½Ğ° ĞºĞ»Ğ¸ĞµĞ½Ñ‚Ğµ, ĞµÑĞ»Ğ¸ Ğ¿Ğ¾Ğ»Ğµ Ğ½Ğµ Ğ¿Ñ€ĞµĞ´Ğ¾ÑÑ‚Ğ°Ğ²Ğ»ĞµĞ½Ğ¾
  const due = typeof dueDate === "string" ? new Date(dueDate) : dueDate;
  
  // ĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑĞµĞ¼, Ñ‡Ñ‚Ğ¾ Ğ´Ğ°Ñ‚Ğ° Ğ²Ğ°Ğ»Ğ¸Ğ´Ğ½Ğ°
  if (isNaN(due.getTime())) {
    return 0;
  }
  
  const today = new Date();
  
  // Ğ¡Ğ±Ñ€Ğ°ÑÑ‹Ğ²Ğ°ĞµĞ¼ Ğ²Ñ€ĞµĞ¼Ñ Ğ´Ğ»Ñ ĞºĞ¾Ñ€Ñ€ĞµĞºÑ‚Ğ½Ğ¾Ğ³Ğ¾ ÑÑ€Ğ°Ğ²Ğ½ĞµĞ½Ğ¸Ñ Ğ´Ğ°Ñ‚
  today.setHours(0, 0, 0, 0);
  due.setHours(0, 0, 0, 0);
  
  const diffTime = today.getTime() - due.getTime();
  const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
  
  return diffDays > 0 ? diffDays : 0;
}

/**
 * ĞŸÑ€ĞµĞ¾Ğ±Ñ€Ğ°Ğ·ÑƒĞµÑ‚ accessory_links Ğ² selected_accessories Ğ´Ğ»Ñ ÑĞ¾Ğ²Ğ¼ĞµÑÑ‚Ğ¸Ğ¼Ğ¾ÑÑ‚Ğ¸ Ñ ĞºĞ¾Ğ¼Ğ¿Ğ¾Ğ½ĞµĞ½Ñ‚Ğ°Ğ¼Ğ¸
 * @param reservation - ĞĞ±ÑŠĞµĞºÑ‚ Ñ€ĞµĞ·ĞµÑ€Ğ²Ğ° Ñ accessory_links
 * @returns ĞĞ±ÑŠĞµĞºÑ‚ Ñ€ĞµĞ·ĞµÑ€Ğ²Ğ° Ñ Ğ´Ğ¾Ğ±Ğ°Ğ²Ğ»ĞµĞ½Ğ½Ñ‹Ğ¼ selected_accessories
 */
export function transformAccessoryLinks<T extends { accessory_links?: Array<{ equipment_id: number; accessory: { id: number } }> }>(reservation: T): T & { selected_accessories: Record<number, number[]> } {
  if (!reservation.accessory_links || reservation.accessory_links.length === 0) {
    return { ...reservation, selected_accessories: {} };
  }
  
  const selected_accessories = reservation.accessory_links.reduce((acc, link) => {
    if (!acc[link.equipment_id]) {
      acc[link.equipment_id] = [];
    }
    acc[link.equipment_id].push(link.accessory.id);
    return acc;
  }, {} as Record<number, number[]>);
  
  return { ...reservation, selected_accessories };
}

```


## <a name="srclibvalidationSchemasts"></a>`src/lib/validationSchemas.ts`

```typescript
// path: src/lib/validationSchemas.ts

// src/lib/validationSchemas.ts

import { z } from "zod";
import { USER_ROLE_VALUES } from "@/constants/userConstants";
import { validateRussianPhone } from "@/utils/phoneUtils";

// --- ĞÑƒÑ‚ĞµĞ½Ñ‚Ğ¸Ñ„Ğ¸ĞºĞ°Ñ†Ğ¸Ñ ---
export const authSchema = z.object({
    email: z.string().min(1, "Email Ğ¾Ğ±ÑĞ·Ğ°Ñ‚ĞµĞ»ĞµĞ½").email("ĞĞµĞºĞ¾Ñ€Ñ€ĞµĞºÑ‚Ğ½Ñ‹Ğ¹ email"),
    password: z.string().min(6, "ĞŸĞ°Ñ€Ğ¾Ğ»ÑŒ Ğ´Ğ¾Ğ»Ğ¶ĞµĞ½ Ğ±Ñ‹Ñ‚ÑŒ Ğ½Ğµ Ğ¼ĞµĞ½ĞµĞµ 6 ÑĞ¸Ğ¼Ğ²Ğ¾Ğ»Ğ¾Ğ²"),
    fullName: z.string().min(2, "Ğ¤Ğ˜Ğ Ğ´Ğ¾Ğ»Ğ¶Ğ½Ğ¾ Ğ±Ñ‹Ñ‚ÑŒ Ğ½Ğµ ĞºĞ¾Ñ€Ğ¾Ñ‡Ğµ 2 ÑĞ¸Ğ¼Ğ²Ğ¾Ğ»Ğ¾Ğ²").optional(),
    phone: z.string().optional().refine(val => !val || validateRussianPhone(val), {
        message: "ĞĞµĞºĞ¾Ñ€Ñ€ĞµĞºÑ‚Ğ½Ñ‹Ğ¹ Ñ„Ğ¾Ñ€Ğ¼Ğ°Ñ‚ Ğ½Ğ¾Ğ¼ĞµÑ€Ğ° Ñ‚ĞµĞ»ĞµÑ„Ğ¾Ğ½Ğ°. Ğ˜ÑĞ¿Ğ¾Ğ»ÑŒĞ·ÑƒĞ¹Ñ‚Ğµ Ñ„Ğ¾Ñ€Ğ¼Ğ°Ñ‚: +7 (XXX) XXX-XX-XX",
    }),
    privacyPolicyAccepted: z.boolean().optional(),
    termsAccepted: z.boolean().optional(),
});
export type AuthSchema = z.infer<typeof authSchema>;


// --- Ğ ĞµĞ·ĞµÑ€Ğ²Ñ‹ ---
// Ğ­Ñ‚Ğ° Zod-ÑÑ…ĞµĞ¼Ğ° Ñ‚ĞµĞ¿ĞµÑ€ÑŒ ÑĞ²Ğ»ÑĞµÑ‚ÑÑ Ğ•Ğ”Ğ˜ĞĞ¡Ğ¢Ğ’Ğ•ĞĞĞ«Ğœ Ğ¸ÑÑ‚Ğ¾Ñ‡Ğ½Ğ¸ĞºĞ¾Ğ¼ Ğ¿Ñ€Ğ°Ğ²Ğ´Ñ‹ Ğ´Ğ»Ñ Ñ‚Ğ¸Ğ¿Ğ° Ğ´Ğ°Ğ½Ğ½Ñ‹Ñ… Ğ¿Ñ€Ğ¸ ÑĞ¾Ğ·Ğ´Ğ°Ğ½Ğ¸Ğ¸ Ñ€ĞµĞ·ĞµÑ€Ğ²Ğ°.
export const reservationCreateSchema = z.object({
    user_id: z.number().optional(), // Ğ”Ğ»Ñ ÑĞ¾Ğ·Ğ´Ğ°Ğ½Ğ¸Ñ Ñ€ĞµĞ·ĞµÑ€Ğ²Ğ° Ğ°Ğ´Ğ¼Ğ¸Ğ½Ğ¾Ğ¼
    equipment_ids: z.array(z.number()).min(1, "ĞĞµĞ¾Ğ±Ñ…Ğ¾Ğ´Ğ¸Ğ¼Ğ¾ Ğ²Ñ‹Ğ±Ñ€Ğ°Ñ‚ÑŒ Ñ…Ğ¾Ñ‚Ñ Ğ±Ñ‹ Ğ¾Ğ´Ğ½Ğ¾ Ğ¾Ğ±Ğ¾Ñ€ÑƒĞ´Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ Ğ´Ğ»Ñ Ñ€ĞµĞ·ĞµÑ€Ğ²Ğ°."),
    start_date: z.string().refine((date) => /^\d{4}-\d{2}-\d{2}$/.test(date) && !isNaN(new Date(date).getTime()), {
        message: "ĞĞµĞºĞ¾Ñ€Ñ€ĞµĞºÑ‚Ğ½Ğ°Ñ Ğ´Ğ°Ñ‚Ğ° Ğ½Ğ°Ñ‡Ğ°Ğ»Ğ°.",
    }),
    end_date: z.string().refine((date) => /^\d{4}-\d{2}-\d{2}$/.test(date) && !isNaN(new Date(date).getTime()), {
        message: "ĞĞµĞºĞ¾Ñ€Ñ€ĞµĞºÑ‚Ğ½Ğ°Ñ Ğ´Ğ°Ñ‚Ğ° Ğ¾ĞºĞ¾Ğ½Ñ‡Ğ°Ğ½Ğ¸Ñ.",
    }),
    selected_accessories: z.record(z.array(z.number())).default({}),
    promo_code: z.string().optional(),
}).refine(data => new Date(data.end_date) > new Date(data.start_date), {
    message: "Ğ”Ğ°Ñ‚Ğ° Ğ¾ĞºĞ¾Ğ½Ñ‡Ğ°Ğ½Ğ¸Ñ Ğ´Ğ¾Ğ»Ğ¶Ğ½Ğ° Ğ±Ñ‹Ñ‚ÑŒ Ğ¿Ğ¾Ğ·Ğ¶Ğµ Ğ´Ğ°Ñ‚Ñ‹ Ğ½Ğ°Ñ‡Ğ°Ğ»Ğ°.",
    path: ["end_date"],
});

// Ğ­ĞºÑĞ¿Ğ¾Ñ€Ñ‚Ğ¸Ñ€ÑƒĞµĞ¼ Ñ‚Ğ¸Ğ¿, ÑĞ¾Ğ·Ğ´Ğ°Ğ½Ğ½Ñ‹Ğ¹ Ğ½Ğ° Ğ¾ÑĞ½Ğ¾Ğ²Ğµ Zod-ÑÑ…ĞµĞ¼Ñ‹.
// Ğ¢ĞµĞ¿ĞµÑ€ÑŒ ÑÑ‚Ğ¾Ñ‚ Ñ‚Ğ¸Ğ¿ Ğ±ÑƒĞ´ĞµÑ‚ Ğ¸ÑĞ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ÑŒÑÑ Ğ² ÑĞµÑ€Ğ²Ğ¸ÑĞ°Ñ… Ğ¸ Ñ…ÑƒĞºĞ°Ñ…, Ğ³Ğ°Ñ€Ğ°Ğ½Ñ‚Ğ¸Ñ€ÑƒÑ ÑĞ¾Ğ¾Ñ‚Ğ²ĞµÑ‚ÑÑ‚Ğ²Ğ¸Ğµ.
export type ReservationCreateInput = z.infer<typeof reservationCreateSchema>;


// --- Ğ£Ğ¿Ñ€Ğ°Ğ²Ğ»ĞµĞ½Ğ¸Ğµ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ÑĞ¼Ğ¸ (ĞĞ´Ğ¼Ğ¸Ğ½-Ğ¿Ğ°Ğ½ĞµĞ»ÑŒ) ---
export const adminUserCreateFormSchema = z.object({
    full_name: z.string().min(2, "Ğ¤Ğ˜Ğ Ğ¾Ğ±ÑĞ·Ğ°Ñ‚ĞµĞ»ÑŒĞ½Ğ¾"),
    email: z.string().min(1, "Email Ğ¾Ğ±ÑĞ·Ğ°Ñ‚ĞµĞ»ĞµĞ½").email("ĞĞµĞºĞ¾Ñ€Ñ€ĞµĞºÑ‚Ğ½Ñ‹Ğ¹ email"),
    password: z.string().min(6, "ĞŸĞ°Ñ€Ğ¾Ğ»ÑŒ Ğ´Ğ¾Ğ»Ğ¶ĞµĞ½ Ğ±Ñ‹Ñ‚ÑŒ Ğ½Ğµ Ğ¼ĞµĞ½ĞµĞµ 6 ÑĞ¸Ğ¼Ğ²Ğ¾Ğ»Ğ¾Ğ²"),
    phone: z.string().optional(),
    role: z.enum(USER_ROLE_VALUES, {
        errorMap: () => ({ message: "ĞĞµĞ¾Ğ±Ñ…Ğ¾Ğ´Ğ¸Ğ¼Ğ¾ Ğ²Ñ‹Ğ±Ñ€Ğ°Ñ‚ÑŒ Ñ€Ğ¾Ğ»ÑŒ." })
    }),
    privacyPolicyAccepted: z.boolean(),
    termsAccepted: z.boolean(),
    emailVerified: z.boolean(),
});
export type AdminUserCreateFormSchema = z.infer<typeof adminUserCreateFormSchema>;

export const adminUserUpdateSchema = z.object({
    full_name: z.string().min(2, "Ğ¤Ğ˜Ğ Ğ¾Ğ±ÑĞ·Ğ°Ñ‚ĞµĞ»ÑŒĞ½Ğ¾").optional(),
    phone: z.string().optional(),
    status: z.string().optional(),
    notes: z.string().optional(),
    balance: z.coerce.number().optional()
});
export type AdminUserUpdateSchema = z.infer<typeof adminUserUpdateSchema>;

export const adminUserRoleUpdateSchema = z.object({
    role: z.enum(USER_ROLE_VALUES, {
        errorMap: () => ({ message: "ĞĞµĞ¾Ğ±Ñ…Ğ¾Ğ´Ğ¸Ğ¼Ğ¾ Ğ²Ñ‹Ğ±Ñ€Ğ°Ñ‚ÑŒ Ñ€Ğ¾Ğ»ÑŒ." })
    })
});
export type AdminUserRoleUpdateSchema = z.infer<typeof adminUserRoleUpdateSchema>;


// --- Ğ£Ğ¿Ñ€Ğ°Ğ²Ğ»ĞµĞ½Ğ¸Ğµ Ğ¾Ğ±Ğ¾Ñ€ÑƒĞ´Ğ¾Ğ²Ğ°Ğ½Ğ¸ĞµĞ¼ ---
export const equipmentUpdateExtendedSchema = z.object({
    equipment_type: z.string().min(1, "Ğ¢Ğ¸Ğ¿ Ğ¾Ğ±Ğ¾Ñ€ÑƒĞ´Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ Ğ½Ğµ Ğ´Ğ¾Ğ»Ğ¶ĞµĞ½ Ğ±Ñ‹Ñ‚ÑŒ Ğ¿ÑƒÑÑ‚Ñ‹Ğ¼.").optional(),
    brand: z.string().min(1, "Ğ‘Ñ€ĞµĞ½Ğ´ Ğ½Ğµ Ğ´Ğ¾Ğ»Ğ¶ĞµĞ½ Ğ±Ñ‹Ñ‚ÑŒ Ğ¿ÑƒÑÑ‚Ñ‹Ğ¼.").optional(),
    name: z.string().min(1, "ĞĞ°Ğ·Ğ²Ğ°Ğ½Ğ¸Ğµ Ğ½Ğµ Ğ´Ğ¾Ğ»Ğ¶Ğ½Ğ¾ Ğ±Ñ‹Ñ‚ÑŒ Ğ¿ÑƒÑÑ‚Ñ‹Ğ¼.").optional(),
    serial_number: z.string().nullable().optional(),
    condition: z.string().optional(),
    daily_rate: z.preprocess(
        (val) => (val === "" || val === null || val === undefined) ? undefined : parseFloat(String(val)),
        z.number({ invalid_type_error: "Ğ¡Ñ‚Ğ¾Ğ¸Ğ¼Ğ¾ÑÑ‚ÑŒ Ğ´Ğ¾Ğ»Ğ¶Ğ½Ğ° Ğ±Ñ‹Ñ‚ÑŒ Ñ‡Ğ¸ÑĞ»Ğ¾Ğ¼." })
            .positive("Ğ¡Ñ‚Ğ¾Ğ¸Ğ¼Ğ¾ÑÑ‚ÑŒ Ğ´Ğ¾Ğ»Ğ¶Ğ½Ğ° Ğ±Ñ‹Ñ‚ÑŒ Ğ¿Ğ¾Ğ»Ğ¾Ğ¶Ğ¸Ñ‚ĞµĞ»ÑŒĞ½Ñ‹Ğ¼ Ñ‡Ğ¸ÑĞ»Ğ¾Ğ¼.")
            .optional()
    ),
    notes: z.string().nullable().optional(),
    description: z.string().nullable().optional(),
    last_maintenance: z.string().nullable().optional().refine(val => val === null || val === undefined || val === "" || /^\d{4}-\d{2}-\d{2}$/.test(val), {
        message: "Ğ”Ğ°Ñ‚Ğ° Ğ¿Ğ¾ÑĞ»ĞµĞ´Ğ½ĞµĞ³Ğ¾ Ğ¢Ğ Ğ´Ğ¾Ğ»Ğ¶Ğ½Ğ° Ğ±Ñ‹Ñ‚ÑŒ Ğ² Ñ„Ğ¾Ñ€Ğ¼Ğ°Ñ‚Ğµ Ğ“Ğ“Ğ“Ğ“-ĞœĞœ-Ğ”Ğ” Ğ¸Ğ»Ğ¸ Ğ¾Ñ‚ÑÑƒÑ‚ÑÑ‚Ğ²Ğ¾Ğ²Ğ°Ñ‚ÑŒ.",
    }).transform(val => (val === "" ? undefined : val)),
    short_description: z.string().nullable().optional(),
    image_url: z.string().nullable().optional(),
    image_urls: z.array(z.string()).optional(),
    accessory_ids: z.array(z.number()).optional(),
});
export type EquipmentUpdateExtendedSchema = z.infer<typeof equipmentUpdateExtendedSchema>;


// --- Ğ£Ğ¿Ñ€Ğ°Ğ²Ğ»ĞµĞ½Ğ¸Ğµ Ğ°ĞºÑĞµÑÑÑƒĞ°Ñ€Ğ°Ğ¼Ğ¸ ---
export const accessorySchema = z.object({
    name: z.string().min(2, { message: "ĞĞ°Ğ·Ğ²Ğ°Ğ½Ğ¸Ğµ Ğ´Ğ¾Ğ»Ğ¶Ğ½Ğ¾ ÑĞ¾Ğ´ĞµÑ€Ğ¶Ğ°Ñ‚ÑŒ Ğ¼Ğ¸Ğ½Ğ¸Ğ¼ÑƒĞ¼ 2 ÑĞ¸Ğ¼Ğ²Ğ¾Ğ»Ğ°." }),
    accessory_type: z.string().optional(),
    price: z.preprocess(
        (value) => (value === "" ? undefined : value),
        z.coerce.number({ invalid_type_error: "Ğ¦ĞµĞ½Ğ° Ğ´Ğ¾Ğ»Ğ¶Ğ½Ğ° Ğ±Ñ‹Ñ‚ÑŒ Ñ‡Ğ¸ÑĞ»Ğ¾Ğ¼." })
            .min(0, { message: "Ğ¦ĞµĞ½Ğ° Ğ½Ğµ Ğ¼Ğ¾Ğ¶ĞµÑ‚ Ğ±Ñ‹Ñ‚ÑŒ Ğ¾Ñ‚Ñ€Ğ¸Ñ†Ğ°Ñ‚ĞµĞ»ÑŒĞ½Ğ¾Ğ¹." })
            .optional()
    ),
    description: z.string().optional(),
});
export type AccessorySchema = z.infer<typeof accessorySchema>;


// --- Ğ£Ğ¿Ñ€Ğ°Ğ²Ğ»ĞµĞ½Ğ¸Ğµ Ğ¿Ñ€Ğ¾Ğ¼Ğ¾ĞºĞ¾Ğ´Ğ°Ğ¼Ğ¸ ---
export const promoCodeFormSchema = z.object({
    code: z.string().min(3, "ĞšĞ¾Ğ´ Ğ´Ğ¾Ğ»Ğ¶ĞµĞ½ ÑĞ¾Ğ´ĞµÑ€Ğ¶Ğ°Ñ‚ÑŒ Ğ¼Ğ¸Ğ½Ğ¸Ğ¼ÑƒĞ¼ 3 ÑĞ¸Ğ¼Ğ²Ğ¾Ğ»Ğ°").max(50),
    description: z.string().optional(),
    discount_percentage: z.coerce.number({ invalid_type_error: "Ğ¡ĞºĞ¸Ğ´ĞºĞ° Ğ´Ğ¾Ğ»Ğ¶Ğ½Ğ° Ğ±Ñ‹Ñ‚ÑŒ Ñ‡Ğ¸ÑĞ»Ğ¾Ğ¼" })
        .min(1, "Ğ¡ĞºĞ¸Ğ´ĞºĞ° Ğ´Ğ¾Ğ»Ğ¶Ğ½Ğ° Ğ±Ñ‹Ñ‚ÑŒ Ğ±Ğ¾Ğ»ÑŒÑˆĞµ 0")
        .max(50, "ĞœĞ°ĞºÑĞ¸Ğ¼Ğ°Ğ»ÑŒĞ½Ğ°Ñ ÑĞºĞ¸Ğ´ĞºĞ° 50%"),
    is_active: z.boolean().default(true),
    valid_from: z.date().optional(),
    expires_at: z.date().optional(),
    max_uses: z.preprocess(
        (val) => (val === "" || val === null || val === undefined) ? undefined : parseInt(String(val), 10),
        z.number().positive("Ğ—Ğ½Ğ°Ñ‡ĞµĞ½Ğ¸Ğµ Ğ´Ğ¾Ğ»Ğ¶Ğ½Ğ¾ Ğ±Ñ‹Ñ‚ÑŒ Ğ±Ğ¾Ğ»ÑŒÑˆĞµ 0").optional()
    ),
    max_uses_per_user: z.preprocess(
        (val) => (val === "" || val === null || val === undefined) ? undefined : parseInt(String(val), 10),
        z.number().positive("Ğ—Ğ½Ğ°Ñ‡ĞµĞ½Ğ¸Ğµ Ğ´Ğ¾Ğ»Ğ¶Ğ½Ğ¾ Ğ±Ñ‹Ñ‚ÑŒ Ğ±Ğ¾Ğ»ÑŒÑˆĞµ 0").optional()
    ),
    min_order_amount: z.preprocess(
        (val) => (val === "" || val === null || val === undefined) ? undefined : parseFloat(String(val)),
        z.number().positive("Ğ—Ğ½Ğ°Ñ‡ĞµĞ½Ğ¸Ğµ Ğ´Ğ¾Ğ»Ğ¶Ğ½Ğ¾ Ğ±Ñ‹Ñ‚ÑŒ Ğ±Ğ¾Ğ»ÑŒÑˆĞµ 0").optional()
    ),
    applicable_to_equipment_ids: z.array(z.number()).optional(),
    applicable_to_equipment_types: z.array(z.string()).optional(),
    specific_to_user_id: z.coerce.number().optional(),
}).refine(data => {
    if (data.valid_from && data.expires_at) {
        return data.expires_at >= data.valid_from;
    }
    return true;
}, {
    message: "Ğ”Ğ°Ñ‚Ğ° Ğ¾ĞºĞ¾Ğ½Ñ‡Ğ°Ğ½Ğ¸Ñ Ğ½Ğµ Ğ¼Ğ¾Ğ¶ĞµÑ‚ Ğ±Ñ‹Ñ‚ÑŒ Ñ€Ğ°Ğ½ÑŒÑˆĞµ Ğ´Ğ°Ñ‚Ñ‹ Ğ½Ğ°Ñ‡Ğ°Ğ»Ğ°",
    path: ["expires_at"],
});
export type PromoCodeFormData = z.infer<typeof promoCodeFormSchema>;

// +++ ĞĞĞ§ĞĞ›Ğ: ĞĞ¾Ğ²Ğ°Ñ ÑÑ…ĞµĞ¼Ğ° Ğ´Ğ»Ñ Ñ„Ğ¾Ñ€Ğ¼Ñ‹ Ğ¿Ğ¾Ğ¿Ğ¾Ğ»Ğ½ĞµĞ½Ğ¸Ñ Ğ±Ğ°Ğ»Ğ°Ğ½ÑĞ° +++
export const userPaymentSchema = z.object({
    amount: z.coerce
        .number({ invalid_type_error: "Ğ¡ÑƒĞ¼Ğ¼Ğ° Ğ´Ğ¾Ğ»Ğ¶Ğ½Ğ° Ğ±Ñ‹Ñ‚ÑŒ Ñ‡Ğ¸ÑĞ»Ğ¾Ğ¼" })
        .positive("Ğ¡ÑƒĞ¼Ğ¼Ğ° Ğ´Ğ¾Ğ»Ğ¶Ğ½Ğ° Ğ±Ñ‹Ñ‚ÑŒ Ğ±Ğ¾Ğ»ÑŒÑˆĞµ Ğ½ÑƒĞ»Ñ"),
    payment_method: z.string().min(1, "ĞĞµĞ¾Ğ±Ñ…Ğ¾Ğ´Ğ¸Ğ¼Ğ¾ Ğ²Ñ‹Ğ±Ñ€Ğ°Ñ‚ÑŒ Ğ¼ĞµÑ‚Ğ¾Ğ´ Ğ¾Ğ¿Ğ»Ğ°Ñ‚Ñ‹"),
    description: z.string().optional(),
});
export type UserPaymentSchema = z.infer<typeof userPaymentSchema>;
// +++ ĞšĞĞĞ•Ğ¦: ĞĞ¾Ğ²Ğ°Ñ ÑÑ…ĞµĞ¼Ğ° +++

```


## <a name="srcmaintsx"></a>`src/main.tsx`

```tsx
// path: src/main.tsx

// src/main.tsx

import React from "react";
import ReactDOM from "react-dom/client";
import {BrowserRouter} from "react-router-dom";
import App from "./app/App";

// 1. Ğ¡ĞĞĞ§ĞĞ›Ğ Ğ¸Ğ¼Ğ¿Ğ¾Ñ€Ñ‚Ğ¸Ñ€ÑƒĞµĞ¼ ÑÑ‚Ğ¸Ğ»Ğ¸ Ğ±Ğ¸Ğ±Ğ»Ğ¸Ğ¾Ñ‚ĞµĞºĞ¸
import 'react-day-picker/dist/style.css';

// 2. ĞŸĞĞ¢ĞĞœ Ğ¸Ğ¼Ğ¿Ğ¾Ñ€Ñ‚Ğ¸Ñ€ÑƒĞµĞ¼ Ğ½Ğ°ÑˆĞ¸ ÑĞ¾Ğ±ÑÑ‚Ğ²ĞµĞ½Ğ½Ñ‹Ğµ ÑÑ‚Ğ¸Ğ»Ğ¸ Ğ´Ğ»Ñ Ğ¸Ñ… Ğ¿ĞµÑ€ĞµĞ¾Ğ¿Ñ€ĞµĞ´ĞµĞ»ĞµĞ½Ğ¸Ñ
import "./index.css";

import {QueryClientProvider} from "@tanstack/react-query";
import {queryClient} from "./lib/queryClient";
import {ReactQueryDevtools} from "@tanstack/react-query-devtools";
import ErrorBoundary from "./components/ErrorBoundary";
import NetworkStatus from "./components/NetworkStatus";

ReactDOM.createRoot(document.getElementById("root")!).render(
    <React.StrictMode>
        <QueryClientProvider client={queryClient}>
            <ErrorBoundary>
                <BrowserRouter>
                    <App/>
                    <NetworkStatus/>
                </BrowserRouter>
            </ErrorBoundary>
            <ReactQueryDevtools initialIsOpen={false}/>
        </QueryClientProvider>
    </React.StrictMode>
);

```


## <a name="srcpagesAccessoryManagementPagetsx"></a>`src/pages/AccessoryManagementPage.tsx`

```tsx
// path: src/pages/AccessoryManagementPage.tsx

// src/pages/AccessoryManagementPage.tsx

import AdminNavigation from "@/components/admin/AdminNavigation";
// âœ… Ğ˜ĞœĞŸĞĞ Ğ¢Ğ˜Ğ Ğ£Ğ•Ğœ Ğ Ğ•ĞĞ›Ğ¬ĞĞ«Ğ™ ĞšĞĞœĞŸĞĞĞ•ĞĞ¢
import AccessoryTable from "@/components/admin/AccessoryTable";
import { Button } from "@/components/ui/button";
import { Shield, Paperclip } from "lucide-react";
import { useNavigate } from "react-router-dom";
import { useCurrentUser } from "@/hooks/useProfile";

export default function AccessoryManagementPage() {
    const { data: currentUser } = useCurrentUser();
    const navigate = useNavigate();
    const isManager = currentUser?.role === "manager" || currentUser?.role === "admin";

    if (!isManager) {
        return (
            <div className="max-w-4xl mx-auto px-4 py-8 text-center">
                <Shield className="w-16 h-16 text-gray-400 mx-auto mb-4" />
                <h1 className="text-2xl font-bold text-gray-900 mb-2">Ğ”Ğ¾ÑÑ‚ÑƒĞ¿ Ğ¾Ğ³Ñ€Ğ°Ğ½Ğ¸Ñ‡ĞµĞ½</h1>
                <p className="text-gray-600 mb-4">
                    Ğ£ Ğ²Ğ°Ñ Ğ½ĞµÑ‚ Ğ¿Ñ€Ğ°Ğ² Ğ´Ğ»Ñ Ğ´Ğ¾ÑÑ‚ÑƒĞ¿Ğ° Ğº ÑÑ‚Ğ¾Ğ¼Ñƒ Ñ€Ğ°Ğ·Ğ´ĞµĞ»Ñƒ.
                </p>
                <Button onClick={() => navigate("/")}>ĞĞ° Ğ³Ğ»Ğ°Ğ²Ğ½ÑƒÑ</Button>
            </div>
        );
    }

    return (
        <div className="max-w-7xl mx-auto px-4 py-6 space-y-6">
            <AdminNavigation />
            <div className="flex items-center gap-3">
                <Paperclip className="w-8 h-8 text-purple-600" />
                <div>
                    <h1 className="text-3xl font-bold text-gray-900">
                        Ğ£Ğ¿Ñ€Ğ°Ğ²Ğ»ĞµĞ½Ğ¸Ğµ Ğ°ĞºÑĞµÑÑÑƒĞ°Ñ€Ğ°Ğ¼Ğ¸
                    </h1>
                    <p className="text-gray-600 mt-1">
                        Ğ”Ğ¾Ğ±Ğ°Ğ²Ğ»ĞµĞ½Ğ¸Ğµ, Ñ€ĞµĞ´Ğ°ĞºÑ‚Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ Ğ¸ ÑƒĞ´Ğ°Ğ»ĞµĞ½Ğ¸Ğµ Ğ°ĞºÑĞµÑÑÑƒĞ°Ñ€Ğ¾Ğ².
                    </p>
                </div>
            </div>
            <div className="bg-white rounded-lg border shadow-sm p-6">
                {/* âœ… Ğ—ĞĞœĞ•ĞĞ¯Ğ•Ğœ Ğ—ĞĞ“Ğ›Ğ£Ğ¨ĞšĞ£ ĞĞ ĞšĞĞœĞŸĞĞĞ•ĞĞ¢ */}
                <AccessoryTable />
            </div>
        </div>
    );
}

```


## <a name="srcpagesCalendarPagetsx"></a>`src/pages/CalendarPage.tsx`

```tsx
// path: src/pages/CalendarPage.tsx

// src/pages/CalendarPage.tsx

import { useEffect, useState, useMemo, useCallback } from "react";
import { useDateStore } from "@/store/dateStore";
import { useEquipment } from "@/hooks/useEquipment";
import { useAllEquipment } from "@/hooks/useAllEquipment"; // ++ 1. Ğ˜Ğ¼Ğ¿Ğ¾Ñ€Ñ‚Ğ¸Ñ€ÑƒĞµĞ¼ Ñ…ÑƒĞº Ğ´Ğ»Ñ Ğ¿Ğ¾Ğ»ÑƒÑ‡ĞµĞ½Ğ¸Ñ Ğ²ÑĞµÑ… Ğ´Ğ°Ğ½Ğ½Ñ‹Ñ… Ğ´Ğ»Ñ Ñ„Ğ¸Ğ»ÑŒÑ‚Ñ€Ğ¾Ğ²
import CalendarFiltersBlock from "@/components/calendar/CalendarFiltersBlock";
import CalendarTable from "@/components/calendar/CalendarTable";
import { useCalendarSelectionStore } from "@/store/calendarSelectionStore";
import { Button } from "@/components/ui/button";
import { Home, ArrowLeft, Loader2 } from "lucide-react";
import { useNavigate } from "react-router-dom";

export default function CalendarPage() {
    const { setRange } = useDateStore();
    const { setSelectedGroupId } = useCalendarSelectionStore();
    const navigate = useNavigate();

    // -- Ğ£Ğ´Ğ°Ğ»ÑĞµĞ¼ Ğ½ĞµĞ¸ÑĞ¿Ğ¾Ğ»ÑŒĞ·ÑƒĞµĞ¼Ñ‹Ğ¹ currentUser --

    const [typeFilter, setTypeFilter] = useState<string | null>(null);
    const [brandFilter, setBrandFilter] = useState<string | null>(null);
    const [searchText, setSearchText] = useState<string>("");
    const [isLoadingAll, setIsLoadingAll] = useState(false);

    // ++ 2. ĞŸĞ¾Ğ»ÑƒÑ‡Ğ°ĞµĞ¼ ĞŸĞĞ›ĞĞ«Ğ™ ÑĞ¿Ğ¸ÑĞ¾Ğº Ğ¾Ğ±Ğ¾Ñ€ÑƒĞ´Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ ĞĞ”Ğ˜Ğ Ñ€Ğ°Ğ· Ğ´Ğ»Ñ Ğ³ĞµĞ½ĞµÑ€Ğ°Ñ†Ğ¸Ğ¸ Ğ¾Ğ¿Ñ†Ğ¸Ğ¹ Ğ² Ñ„Ğ¸Ğ»ÑŒÑ‚Ñ€Ğ°Ñ… ++
    const { data: allEquipmentForFilters = [] } = useAllEquipment();

    // ++ 3. ĞŸĞ¾Ğ»ÑƒÑ‡Ğ°ĞµĞ¼ ĞŸĞĞ“Ğ˜ĞĞ˜Ğ ĞĞ’ĞĞĞĞ«Ğ™ Ğ¸ ÑƒĞ¶Ğµ Ğ¾Ñ‚Ñ„Ğ¸Ğ»ÑŒÑ‚Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ½Ñ‹Ğ¹ ÑĞµÑ€Ğ²ĞµÑ€Ğ¾Ğ¼ ÑĞ¿Ğ¸ÑĞ¾Ğº Ğ´Ğ»Ñ Ğ¾Ñ‚Ğ¾Ğ±Ñ€Ğ°Ğ¶ĞµĞ½Ğ¸Ñ Ğ² Ñ‚Ğ°Ğ±Ğ»Ğ¸Ñ†Ğµ ++
    const {
        data: equipmentPages,
        fetchNextPage,
        hasNextPage,
        isFetchingNextPage
    } = useEquipment({
        type: typeFilter,
        brand: brandFilter,
        query: searchText
    });

    const paginatedAndFilteredEquipment = useMemo(() => equipmentPages?.pages.flatMap(page => page.items) ?? [], [equipmentPages]);

    // ++ 4. ĞĞ±Ğ¾Ñ€Ğ°Ñ‡Ğ¸Ğ²Ğ°ĞµĞ¼ Ñ„ÑƒĞ½ĞºÑ†Ğ¸Ñ Ğ² useCallback Ğ¸ Ğ´Ğ¾Ğ±Ğ°Ğ²Ğ»ÑĞµĞ¼ Ğ² Ğ·Ğ°Ğ²Ğ¸ÑĞ¸Ğ¼Ğ¾ÑÑ‚Ğ¸ useEffect, Ñ‡Ñ‚Ğ¾Ğ±Ñ‹ Ğ¸ÑĞ¿Ñ€Ğ°Ğ²Ğ¸Ñ‚ÑŒ Ğ¿Ñ€ĞµĞ´ÑƒĞ¿Ñ€ĞµĞ¶Ğ´ĞµĞ½Ğ¸Ğµ ++
    const resetToDefaultRange = useCallback(() => {
        const today = new Date();
        const expectedStart = new Date(today);
        expectedStart.setDate(today.getDate() - 3);
        const expectedEnd = new Date(today);
        expectedEnd.setDate(today.getDate() + 13);
        setRange(expectedStart, expectedEnd);
    }, [setRange]);

    useEffect(() => {
        resetToDefaultRange();
    }, [resetToDefaultRange]);

    const handleResetAll = () => {
        resetToDefaultRange();
        setTypeFilter(null);
        setBrandFilter(null);
        setSearchText("");
        setSelectedGroupId(null);
    };

    const handleLoadAll = () => {
        setIsLoadingAll(true);
    };

    useEffect(() => {
        if (isLoadingAll && hasNextPage && !isFetchingNextPage) {
            // ++ 5. Ğ”Ğ¾Ğ±Ğ°Ğ²Ğ»ÑĞµĞ¼ `void` Ñ‡Ñ‚Ğ¾Ğ±Ñ‹ Ğ¸ÑĞ¿Ñ€Ğ°Ğ²Ğ¸Ñ‚ÑŒ Ğ¿Ñ€ĞµĞ´ÑƒĞ¿Ñ€ĞµĞ¶Ğ´ĞµĞ½Ğ¸Ğµ Ğ¾ Ğ½ĞµĞ¸ÑĞ¿Ğ¾Ğ»ÑŒĞ·ÑƒĞµĞ¼Ğ¾Ğ¼ Promise ++
            void fetchNextPage();
        }
        if (isLoadingAll && !hasNextPage && !isFetchingNextPage) {
            setIsLoadingAll(false);
        }
    }, [isLoadingAll, hasNextPage, isFetchingNextPage, fetchNextPage]);

    return (
        <div className="p-4 space-y-4">
            <div className="flex justify-between items-center mb-4">
                <div className="flex gap-2">
                    <Button variant="outline" onClick={() => navigate(-1)} className="flex items-center gap-2">
                        <ArrowLeft className="w-4 h-4" /> ĞĞ°Ğ·Ğ°Ğ´
                    </Button>
                    <Button variant="outline" onClick={() => navigate("/")} className="flex items-center gap-2">
                        <Home className="w-4 h-4" /> ĞĞ° Ğ³Ğ»Ğ°Ğ²Ğ½ÑƒÑ
                    </Button>
                </div>
            </div>

            <div className="flex flex-wrap gap-4 p-4 bg-white rounded-lg border shadow-sm mb-4">
                <div className="flex items-center gap-2"><div className="w-4 h-4 bg-emerald-50 rounded"></div><span className="text-sm">Ğ¡Ğ²Ğ¾Ğ±Ğ¾Ğ´Ğ½Ğ¾</span></div>
                <div className="flex items-center gap-2"><div className="w-4 h-4 bg-amber-300 rounded"></div><span className="text-sm">Ğ ĞµĞ·ĞµÑ€Ğ²</span></div>
                <div className="flex items-center gap-2"><div className="w-4 h-4 bg-rose-400 rounded"></div><span className="text-sm">ĞÑ€ĞµĞ½Ğ´Ğ°</span></div>
                {/* ĞŸÑ€Ğ¾Ğ²ĞµÑ€ĞºÑƒ Ğ½Ğ° currentUser Ğ¼Ğ¾Ğ¶Ğ½Ğ¾ ÑƒĞ±Ñ€Ğ°Ñ‚ÑŒ, ĞµÑĞ»Ğ¸ Ğ¾Ğ½Ğ° Ğ±Ğ¾Ğ»ÑŒÑˆĞµ Ğ½Ğ¸Ğ³Ğ´Ğµ Ğ½Ğµ Ğ¸ÑĞ¿Ğ¾Ğ»ÑŒĞ·ÑƒĞµÑ‚ÑÑ, Ğ»Ğ¸Ğ±Ğ¾ Ğ¾ÑÑ‚Ğ°Ğ²Ğ¸Ñ‚ÑŒ Ğ´Ğ»Ñ Ğ±ÑƒĞ´ÑƒÑ‰Ğ¸Ñ… Ñ€Ğ°ÑÑˆĞ¸Ñ€ĞµĞ½Ğ¸Ğ¹ */}
                <div className="flex items-center gap-2"><div className="w-4 h-4 bg-amber-500 rounded"></div><span className="text-sm">ĞœĞ¾Ğ¹ Ñ€ĞµĞ·ĞµÑ€Ğ²</span></div>
            </div>

            {/* ++ 6. ĞŸĞµÑ€ĞµĞ´Ğ°ĞµĞ¼ ĞŸĞĞ›ĞĞ«Ğ™ ÑĞ¿Ğ¸ÑĞ¾Ğº Ğ² Ğ±Ğ»Ğ¾Ğº Ñ„Ğ¸Ğ»ÑŒÑ‚Ñ€Ğ¾Ğ² Ğ´Ğ»Ñ Ğ³ĞµĞ½ĞµÑ€Ğ°Ñ†Ğ¸Ğ¸ Ğ²ÑĞµÑ… Ğ¾Ğ¿Ñ†Ğ¸Ğ¹ ++ */}
            <CalendarFiltersBlock
                equipment={allEquipmentForFilters}
                typeFilter={typeFilter}
                setTypeFilter={setTypeFilter}
                brandFilter={brandFilter}
                setBrandFilter={setBrandFilter}
                searchText={searchText}
                setSearchText={setSearchText}
                onReset={handleResetAll}
            />
            {/* ++ 7. ĞŸĞµÑ€ĞµĞ´Ğ°ĞµĞ¼ ĞŸĞĞ“Ğ˜ĞĞ˜Ğ ĞĞ’ĞĞĞĞ«Ğ™ ÑĞ¿Ğ¸ÑĞ¾Ğº Ğ² Ñ‚Ğ°Ğ±Ğ»Ğ¸Ñ†Ñƒ Ğ´Ğ»Ñ Ğ¾Ñ‚Ğ¾Ğ±Ñ€Ğ°Ğ¶ĞµĞ½Ğ¸Ñ ++ */}
            <CalendarTable equipment={paginatedAndFilteredEquipment} />

            {hasNextPage && (
                <div className="flex justify-center items-center gap-4 mt-4">
                    <Button variant="outline" onClick={() => fetchNextPage()} disabled={isFetchingNextPage || isLoadingAll}>
                        {isFetchingNextPage && !isLoadingAll ? (
                            <><Loader2 className="mr-2 h-4 w-4 animate-spin" /> Ğ—Ğ°Ğ³Ñ€ÑƒĞ·ĞºĞ°...</>
                        ) : ( "Ğ—Ğ°Ğ³Ñ€ÑƒĞ·Ğ¸Ñ‚ÑŒ ĞµÑ‰Ñ‘" )}
                    </Button>
                    <Button variant="secondary" onClick={handleLoadAll} disabled={isFetchingNextPage || isLoadingAll}>
                        {isLoadingAll ? (
                            <><Loader2 className="mr-2 h-4 w-4 animate-spin" /> Ğ—Ğ°Ğ³Ñ€ÑƒĞ·ĞºĞ° Ğ²ÑĞµÑ…...</>
                        ) : ( "Ğ—Ğ°Ğ³Ñ€ÑƒĞ·Ğ¸Ñ‚ÑŒ Ğ²ÑÑ‘" )}
                    </Button>
                </div>
            )}
        </div>
    );
}

```


## <a name="srcpagesCalendarTestPagetsx"></a>`src/pages/CalendarTestPage.tsx`

```tsx
// path: src/pages/CalendarTestPage.tsx

// src/pages/CalendarTestPage.tsx
// Ğ­Ñ‚Ğ¾Ñ‚ Ñ„Ğ°Ğ¹Ğ» ÑĞ¾Ğ´ĞµÑ€Ğ¶Ğ¸Ñ‚ Ğ¿Ğ¾Ğ»Ğ½Ñ‹Ğ¹ ĞºĞ¾Ğ´ Ğ´Ğ»Ñ ÑÑ‚Ñ€Ğ°Ğ½Ğ¸Ñ†Ñ‹ Ñ ĞºĞ°ÑÑ‚Ğ¾Ğ¼Ğ¸Ğ·Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ½Ñ‹Ğ¼ ĞºĞ°Ğ»ĞµĞ½Ğ´Ğ°Ñ€Ñ‘Ğ¼.

import { useState } from 'react';
import { DayPicker, type DateRange } from 'react-day-picker';
import { ru } from 'date-fns/locale'; // Ğ˜Ğ¼Ğ¿Ğ¾Ñ€Ñ‚Ğ¸Ñ€ÑƒĞµĞ¼ Ñ€ÑƒÑÑĞºÑƒÑ Ğ»Ğ¾ĞºĞ°Ğ»ÑŒ Ğ´Ğ»Ñ Ğ½Ğ°Ğ·Ğ²Ğ°Ğ½Ğ¸Ğ¹

export default function CalendarTestPage() {
    // Ğ›Ğ¾ĞºĞ°Ğ»ÑŒĞ½Ğ¾Ğµ ÑĞ¾ÑÑ‚Ğ¾ÑĞ½Ğ¸Ğµ Ğ´Ğ»Ñ Ñ…Ñ€Ğ°Ğ½ĞµĞ½Ğ¸Ñ Ğ²Ñ‹Ğ±Ñ€Ğ°Ğ½Ğ½Ğ¾Ğ³Ğ¾ Ğ´Ğ¸Ğ°Ğ¿Ğ°Ğ·Ğ¾Ğ½Ğ° Ğ´Ğ°Ñ‚
    const [range, setRange] = useState<DateRange | undefined>();

    return (
        // ĞšĞ¾Ğ½Ñ‚ĞµĞ¹Ğ½ĞµÑ€ Ğ´Ğ»Ñ Ñ†ĞµĞ½Ñ‚Ñ€Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ ĞºĞ°Ğ»ĞµĞ½Ğ´Ğ°Ñ€Ñ Ğ½Ğ° ÑÑ‚Ñ€Ğ°Ğ½Ğ¸Ñ†Ğµ
        <div className="p-10 bg-gray-100 min-h-screen flex flex-col items-center justify-center">
            <h1 className="text-3xl font-bold text-gray-800 text-center mb-6">
                Ğ¢ĞµÑÑ‚Ğ¾Ğ²Ñ‹Ğ¹ ĞºĞ°Ğ»ĞµĞ½Ğ´Ğ°Ñ€ÑŒ Ñ ĞºÑ€Ğ°ÑĞ½Ñ‹Ğ¼ Ğ²Ñ‹Ğ´ĞµĞ»ĞµĞ½Ğ¸ĞµĞ¼
            </h1>

            <div className="bg-white p-4 rounded-lg shadow-lg border">
                <DayPicker
                    mode="range"
                    locale={ru} // Ğ˜ÑĞ¿Ğ¾Ğ»ÑŒĞ·ÑƒĞµĞ¼ Ñ€ÑƒÑÑĞºÑƒÑ Ğ»Ğ¾ĞºĞ°Ğ»ÑŒ
                    selected={range}
                    onSelect={setRange}
                    numberOfMonths={2}
                    showOutsideDays
                    // Ğ¡Ñ‚Ğ¸Ğ»Ğ¸ Ğ´Ğ»Ñ Ğ¾ÑĞ½Ğ¾Ğ²Ğ½Ñ‹Ñ… ÑĞ»ĞµĞ¼ĞµĞ½Ñ‚Ğ¾Ğ² ĞºĞ°Ğ»ĞµĞ½Ğ´Ğ°Ñ€Ñ, Ğ²Ğ·ÑÑ‚Ñ‹Ğµ Ğ¸Ğ· Ğ²Ğ°ÑˆĞµĞ³Ğ¾ Ğ¿Ñ€Ğ¾ĞµĞºÑ‚Ğ°
                    classNames={{
                        months: 'flex flex-col sm:flex-row space-y-4 sm:space-x-4 sm:space-y-0',
                        month: 'space-y-4',
                        table: 'w-full border-collapse space-y-1',
                        head_row: 'flex',
                        head_cell: 'text-muted-foreground rounded-md w-9 font-normal text-[0.8rem]',
                        row: 'flex w-full mt-2',
                        cell: 'h-9 w-9 text-center text-sm p-0 relative [&:has([aria-selected])]:bg-accent first:[&:has([aria-selected])]:rounded-l-md last:[&:has([aria-selected])]:rounded-r-md focus-within:relative focus-within:z-20',
                        day: 'h-9 w-9 p-0 font-normal aria-selected:opacity-100',
                        nav: 'space-x-1 flex items-center',
                        caption: 'flex justify-center pt-1 relative items-center',
                        caption_label: 'text-sm font-medium',
                        nav_button: 'h-7 w-7 bg-transparent p-0 opacity-50 hover:opacity-100'
                    }}
                    // Ğ¡Ñ‚Ğ¸Ğ»Ğ¸ Ğ´Ğ»Ñ ÑĞ¾ÑÑ‚Ğ¾ÑĞ½Ğ¸Ğ¹ Ğ´Ğ½ĞµĞ¹ (Ğ¼Ğ¾Ğ´Ğ¸Ñ„Ğ¸ĞºĞ°Ñ‚Ğ¾Ñ€Ğ¾Ğ²)
                    modifiersClassNames={{
                        today: 'bg-accent text-accent-foreground',
                        // Ğ¡Ğ¸Ğ½Ğ¸Ğµ Ñ†Ğ²ĞµÑ‚Ğ° Ğ´Ğ»Ñ Ğ²Ñ‹Ğ±Ñ€Ğ°Ğ½Ğ½Ñ‹Ñ… Ğ´Ğ°Ñ‚
                        selected: 'bg-sky-600 text-white hover:bg-sky-600 hover:text-white focus:bg-sky-600 focus:text-white',
                        // Ğ¡ĞºÑ€ÑƒĞ³Ğ»ĞµĞ½Ğ¸Ñ Ğ´Ğ»Ñ Ğ½Ğ°Ñ‡Ğ°Ğ»Ğ° Ğ¸ ĞºĞ¾Ğ½Ñ†Ğ° Ğ´Ğ¸Ğ°Ğ¿Ğ°Ğ·Ğ¾Ğ½Ğ°
                        range_start: 'rounded-l-full',
                        range_end: 'rounded-r-full',
                        range_middle: 'aria-selected:bg-sky-100 aria-selected:text-sky-900',
                        outside: 'day-outside text-muted-foreground opacity-50',
                        disabled: 'text-muted-foreground opacity-50',
                    }}
                />
            </div>
            <div className="mt-4 p-4 bg-white rounded-lg shadow-lg border text-sm text-gray-700">
                <p>Ğ’Ñ‹Ğ±Ñ€Ğ°Ğ½Ğ½Ñ‹Ğ¹ Ğ´Ğ¸Ğ°Ğ¿Ğ°Ğ·Ğ¾Ğ½:</p>
                {range?.from ? (
                    <pre className="mt-2 font-mono">{JSON.stringify(range, null, 2)}</pre>
                ) : (
                    <p className="text-gray-500 italic mt-1">ĞĞ¸Ñ‡ĞµĞ³Ğ¾ Ğ½Ğµ Ğ²Ñ‹Ğ±Ñ€Ğ°Ğ½Ğ¾</p>
                )}
            </div>
        </div>
    );
}

```


## <a name="srcpagesContactPagetsx"></a>`src/pages/ContactPage.tsx`

```tsx
// path: src/pages/ContactPage.tsx

// src/pages/ContactPage.tsx
import { Button } from "@/components/ui/button"
import { useNavigate, useLocation } from "react-router-dom"

export default function ContactPage() {
    const navigate = useNavigate()
    const location = useLocation()

    const backTo = location.state?.from || -1

    const telegramBot = "d30manager"
    const message = encodeURIComponent(
        "Ğ—Ğ´Ñ€Ğ°Ğ²ÑÑ‚Ğ²ÑƒĞ¹Ñ‚Ğµ, Ñ Ñ…Ğ¾Ñ‡Ñƒ Ğ¾Ñ‚Ğ¼ĞµĞ½Ğ¸Ñ‚ÑŒ Ñ€ĞµĞ·ĞµÑ€Ğ². Ğ”Ğ¾ ĞµĞ³Ğ¾ Ğ¾ĞºĞ¾Ğ½Ñ‡Ğ°Ğ½Ğ¸Ñ Ğ¾ÑÑ‚Ğ°Ğ»Ğ¾ÑÑŒ Ğ¼ĞµĞ½ĞµĞµ 2 Ğ´Ğ½ĞµĞ¹."
    )
    const telegramLink = `https://t.me/${telegramBot}?start=${message}`

    return (
        <div className="max-w-2xl mx-auto px-4 py-6 sm:py-8 space-y-6">
            <h1 className="text-2xl font-bold text-center sm:text-left">Ğ¡Ğ²ÑĞ·ÑŒ Ñ Ğ¼ĞµĞ½ĞµĞ´Ğ¶ĞµÑ€Ğ¾Ğ¼</h1>

            <p className="text-sm text-gray-700">
                Ğ•ÑĞ»Ğ¸ Ğ²Ñ‹ Ñ…Ğ¾Ñ‚Ğ¸Ñ‚Ğµ Ğ¾Ñ‚Ğ¼ĞµĞ½Ğ¸Ñ‚ÑŒ Ñ€ĞµĞ·ĞµÑ€Ğ², Ğ´Ğ¾ Ğ¾ĞºĞ¾Ğ½Ñ‡Ğ°Ğ½Ğ¸Ñ ĞºĞ¾Ñ‚Ğ¾Ñ€Ğ¾Ğ³Ğ¾ Ğ¾ÑÑ‚Ğ°Ğ»Ğ¾ÑÑŒ Ğ¼ĞµĞ½ĞµĞµ 2-Ñ… Ğ´Ğ½ĞµĞ¹,
                Ğ¿Ğ¾Ğ¶Ğ°Ğ»ÑƒĞ¹ÑÑ‚Ğ°, ÑĞ²ÑĞ¶Ğ¸Ñ‚ĞµÑÑŒ Ñ Ğ½Ğ°Ğ¼Ğ¸ Ğ»ÑĞ±Ñ‹Ğ¼ ÑƒĞ´Ğ¾Ğ±Ğ½Ñ‹Ğ¼ ÑĞ¿Ğ¾ÑĞ¾Ğ±Ğ¾Ğ¼:
            </p>

            <ul className="text-sm text-gray-800 list-disc list-inside space-y-1">
                <li>Email:{" "}
                    <a href="mailto:info@digital30.ru" className="text-sky-600 hover:underline">
                        info@digital30.ru
                    </a>
                </li>
                <li>Ğ¢ĞµĞ»ĞµÑ„Ğ¾Ğ½: <span className="font-semibold">+7 (908) 6177177</span></li>
                <li>Telegram:{" "}
                    <a href={`https://t.me/${telegramBot}`} className="text-sky-600 hover:underline">
                        @{telegramBot}
                    </a>
                </li>
            </ul>

            <div className="flex flex-col sm:flex-row gap-3 pt-4 sm:pt-6">
                <Button
                    onClick={() => window.open(telegramLink, "_blank")}
                    variant="default"
                    className="w-full sm:w-auto"
                >
                    ğŸ’¬ ĞĞ°Ğ¿Ğ¸ÑĞ°Ñ‚ÑŒ Ğ² Telegram
                </Button>

                <Button
                    variant="outline"
                    onClick={() => typeof backTo === "string" ? navigate(backTo) : navigate(-1)}
                    className="w-full sm:w-auto"
                >
                    â† Ğ’ĞµÑ€Ğ½ÑƒÑ‚ÑŒÑÑ Ğ½Ğ°Ğ·Ğ°Ğ´
                </Button>
            </div>
        </div>
    )
}


```


## <a name="srcpagesEquipmentManagementPagetsx"></a>`src/pages/EquipmentManagementPage.tsx`

```tsx
// path: src/pages/EquipmentManagementPage.tsx

// src/pages/EquipmentManagementPage.tsx

import { useState, useEffect, useMemo } from "react";
import { useCurrentUser } from "@/hooks/useProfile";
import AdminNavigation from "@/components/admin/AdminNavigation";
import EquipmentTable from "@/components/admin/EquipmentTable";
import EquipmentEditDialog from "@/components/admin/EquipmentEditDialog";
import { Button } from "@/components/ui/button";
import { Shield, Package } from "lucide-react";
import { useNavigate } from "react-router-dom";
import type { Equipment } from "@/types/equipment";
import { useEquipment } from "@/hooks/useEquipment";
import type { EquipmentListResponse } from "@/core/services/EquipmentService";

export default function EquipmentManagementPage() {
    const { data: currentUser } = useCurrentUser();
    const navigate = useNavigate();

    // âœ… Ğ˜Ğ—ĞœĞ•ĞĞ•ĞĞ˜Ğ•: ĞŸĞ¾Ğ»ÑƒÑ‡Ğ°ĞµĞ¼ Ğ¸Ğ· Ñ…ÑƒĞºĞ° Ğ´Ğ¾Ğ¿Ğ¾Ğ»Ğ½Ğ¸Ñ‚ĞµĞ»ÑŒĞ½Ñ‹Ğµ Ğ´Ğ°Ğ½Ğ½Ñ‹Ğµ Ğ´Ğ»Ñ Ğ¿Ğ°Ğ³Ğ¸Ğ½Ğ°Ñ†Ğ¸Ğ¸
    const {
        data: equipmentPages,
        fetchNextPage,
        hasNextPage,
        isFetchingNextPage
    } = useEquipment();

    // "Ğ Ğ°ÑĞ¿Ğ»ÑÑ‰Ğ¸Ğ²Ğ°ĞµĞ¼" ÑÑ‚Ñ€Ğ°Ğ½Ğ¸Ñ†Ñ‹ Ğ² Ğ¾Ğ´Ğ¸Ğ½ Ğ¾Ğ±Ñ‰Ğ¸Ğ¹ Ğ¼Ğ°ÑÑĞ¸Ğ² Ñ Ğ¿Ğ¾Ğ¼Ğ¾Ñ‰ÑŒÑ useMemo
    const allEquipment = useMemo(() =>
            equipmentPages?.pages.flatMap((page: EquipmentListResponse) => page.items) ?? [],
        [equipmentPages]);

    const [selectedEquipment, setSelectedEquipment] = useState<Equipment | null>(null);
    const [showEditDialog, setShowEditDialog] = useState(false);

    const isAdmin = currentUser?.role === "admin";
    const isManager = currentUser?.role === "manager" || isAdmin;

    useEffect(() => {
        if (!showEditDialog) {
            document.body.style.overflow = '';
        }
    }, [showEditDialog]);

    if (!isManager) {
        return (
            <div className="max-w-4xl mx-auto px-4 py-8">
                <div className="text-center">
                    <Shield className="w-16 h-16 text-gray-400 mx-auto mb-4" />
                    <h1 className="text-2xl font-bold text-gray-900 mb-2">
                        Ğ”Ğ¾ÑÑ‚ÑƒĞ¿ Ğ¾Ğ³Ñ€Ğ°Ğ½Ğ¸Ñ‡ĞµĞ½
                    </h1>
                    <p className="text-gray-600 mb-4">
                        Ğ£ Ğ²Ğ°Ñ Ğ½ĞµÑ‚ Ğ¿Ñ€Ğ°Ğ² Ğ´Ğ»Ñ Ğ´Ğ¾ÑÑ‚ÑƒĞ¿Ğ° Ğº ÑƒĞ¿Ñ€Ğ°Ğ²Ğ»ĞµĞ½Ğ¸Ñ Ğ¾Ğ±Ğ¾Ñ€ÑƒĞ´Ğ¾Ğ²Ğ°Ğ½Ğ¸ĞµĞ¼.
                    </p>
                    <Button onClick={() => navigate("/")}>
                        ĞĞ° Ğ³Ğ»Ğ°Ğ²Ğ½ÑƒÑ
                    </Button>
                </div>
            </div>
        );
    }

    const handleEditEquipment = (equipment: Equipment) => {
        setSelectedEquipment(equipment);
        setShowEditDialog(true);
    };

    const handleCloseDialog = () => {
        setShowEditDialog(false);
        setSelectedEquipment(null);
    };

    return (
        <div className="max-w-7xl mx-auto px-4 py-6 space-y-6">
            <AdminNavigation />

            <div className="flex items-center justify-between">
                <div className="flex items-center gap-3">
                    <Package className="w-8 h-8 text-green-600" />
                    <div>
                        <h1 className="text-3xl font-bold text-gray-900">
                            Ğ£Ğ¿Ñ€Ğ°Ğ²Ğ»ĞµĞ½Ğ¸Ğµ Ğ¾Ğ±Ğ¾Ñ€ÑƒĞ´Ğ¾Ğ²Ğ°Ğ½Ğ¸ĞµĞ¼
                        </h1>
                        <p className="text-gray-600 mt-1">
                            Ğ”Ğ¾Ğ±Ğ°Ğ²Ğ»ĞµĞ½Ğ¸Ğµ, Ñ€ĞµĞ´Ğ°ĞºÑ‚Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ Ğ¸ ÑƒĞ´Ğ°Ğ»ĞµĞ½Ğ¸Ğµ Ğ¾Ğ±Ğ¾Ñ€ÑƒĞ´Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ Ğ´Ğ»Ñ Ğ°Ñ€ĞµĞ½Ğ´Ñ‹
                        </p>
                    </div>
                </div>
            </div>

            <div className="bg-white rounded-lg border shadow-sm p-6">
                {/* âœ… Ğ˜Ğ—ĞœĞ•ĞĞ•ĞĞ˜Ğ•: ĞŸĞµÑ€ĞµĞ´Ğ°ĞµĞ¼ Ğ½Ğ¾Ğ²Ñ‹Ğµ ÑĞ²Ğ¾Ğ¹ÑÑ‚Ğ²Ğ° Ğ´Ğ»Ñ Ğ¿Ğ°Ğ³Ğ¸Ğ½Ğ°Ñ†Ğ¸Ğ¸ Ğ² Ñ‚Ğ°Ğ±Ğ»Ğ¸Ñ†Ñƒ */}
                <EquipmentTable
                    onEditEquipment={handleEditEquipment}
                    equipment={allEquipment}
                    onLoadMore={fetchNextPage}
                    hasNextPage={hasNextPage}
                    isFetchingNextPage={isFetchingNextPage}
                />
            </div>

            {/* Ğ‘Ğ»Ğ¾ĞºĞ¸ Ñ ÑĞ¾Ğ²ĞµÑ‚Ğ°Ğ¼Ğ¸ Ğ¸ ÑĞ¾ÑÑ‚Ğ¾ÑĞ½Ğ¸ÑĞ¼Ğ¸ Ğ¾ÑÑ‚Ğ°ÑÑ‚ÑÑ Ğ±ĞµĞ· Ğ¸Ğ·Ğ¼ĞµĞ½ĞµĞ½Ğ¸Ğ¹ */}
            <div className="bg-blue-50 border border-blue-200 rounded-lg p-4">
                <h3 className="font-semibold text-blue-900 mb-3">ğŸ’¡ ĞŸĞ¾Ğ»ĞµĞ·Ğ½Ñ‹Ğµ ÑĞ¾Ğ²ĞµÑ‚Ñ‹</h3>
                <div className="grid grid-cols-1 md:grid-cols-2 gap-4 text-sm text-blue-800">
                    <div>
                        <p className="font-medium mb-2">Ğ”Ğ¾Ğ±Ğ°Ğ²Ğ»ĞµĞ½Ğ¸Ğµ Ğ¾Ğ±Ğ¾Ñ€ÑƒĞ´Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ:</p>
                        <ul className="space-y-1">
                            <li>â€¢ Ğ£ĞºĞ°Ğ·Ñ‹Ğ²Ğ°Ğ¹Ñ‚Ğµ Ğ¿Ğ¾Ğ´Ñ€Ğ¾Ğ±Ğ½Ğ¾Ğµ Ğ¾Ğ¿Ğ¸ÑĞ°Ğ½Ğ¸Ğµ Ğ´Ğ»Ñ ĞºĞ»Ğ¸ĞµĞ½Ñ‚Ğ¾Ğ²</li>
                            <li>â€¢ Ğ”Ğ¾Ğ±Ğ°Ğ²Ğ»ÑĞ¹Ñ‚Ğµ ÑĞµÑ€Ğ¸Ğ¹Ğ½Ñ‹Ğµ Ğ½Ğ¾Ğ¼ĞµÑ€Ğ° Ğ´Ğ»Ñ ÑƒÑ‡ĞµÑ‚Ğ°</li>
                            <li>â€¢ Ğ£ÑÑ‚Ğ°Ğ½Ğ°Ğ²Ğ»Ğ¸Ğ²Ğ°Ğ¹Ñ‚Ğµ Ğ°ĞºÑ‚ÑƒĞ°Ğ»ÑŒĞ½Ñ‹Ğµ Ñ‚Ğ°Ñ€Ğ¸Ñ„Ñ‹</li>
                        </ul>
                    </div>
                    <div>
                        <p className="font-medium mb-2">Ğ£Ğ¿Ñ€Ğ°Ğ²Ğ»ĞµĞ½Ğ¸Ğµ:</p>
                        <ul className="space-y-1">
                            <li>â€¢ Ğ˜ÑĞ¿Ğ¾Ğ»ÑŒĞ·ÑƒĞ¹Ñ‚Ğµ Ğ¿Ğ¾Ğ¸ÑĞº Ğ´Ğ»Ñ Ğ±Ñ‹ÑÑ‚Ñ€Ğ¾Ğ³Ğ¾ Ğ½Ğ°Ñ…Ğ¾Ğ¶Ğ´ĞµĞ½Ğ¸Ñ</li>
                            <li>â€¢ Ğ’Ñ‹Ğ´ĞµĞ»ÑĞ¹Ñ‚Ğµ Ğ½ĞµÑĞºĞ¾Ğ»ÑŒĞºĞ¾ ÑĞ»ĞµĞ¼ĞµĞ½Ñ‚Ğ¾Ğ² Ğ´Ğ»Ñ Ğ¼Ğ°ÑÑĞ¾Ğ²Ñ‹Ñ… Ğ¾Ğ¿ĞµÑ€Ğ°Ñ†Ğ¸Ğ¹</li>
                            <li>â€¢ Ğ ĞµĞ³ÑƒĞ»ÑÑ€Ğ½Ğ¾ Ğ¾Ğ±Ğ½Ğ¾Ğ²Ğ»ÑĞ¹Ñ‚Ğµ ÑĞ¾ÑÑ‚Ğ¾ÑĞ½Ğ¸Ğµ Ğ¾Ğ±Ğ¾Ñ€ÑƒĞ´Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ</li>
                        </ul>
                    </div>
                </div>
            </div>
            <div className="bg-gray-50 rounded-lg p-4">
                <h3 className="font-semibold text-gray-900 mb-3">Ğ¡Ğ¾ÑÑ‚Ğ¾ÑĞ½Ğ¸Ñ Ğ¾Ğ±Ğ¾Ñ€ÑƒĞ´Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ</h3>
                <div className="grid grid-cols-2 md:grid-cols-5 gap-3 text-sm">
                    <div className="bg-green-100 text-green-800 p-2 rounded text-center">
                        <div className="font-medium">Ğ’ĞµĞ»Ğ¸ĞºĞ¾Ğ»ĞµĞ¿Ğ½Ğ¾</div>
                        <div className="text-xs">ĞšĞ°Ğº Ğ½Ğ¾Ğ²Ğ¾Ğµ</div>
                    </div>
                    <div className="bg-blue-100 text-blue-800 p-2 rounded text-center">
                        <div className="font-medium">ĞÑ‚Ğ»Ğ¸Ñ‡Ğ½Ğ¾</div>
                        <div className="text-xs">ĞœĞ¸Ğ½Ğ¸Ğ¼Ğ°Ğ»ÑŒĞ½Ñ‹Ğ¹ Ğ¸Ğ·Ğ½Ğ¾Ñ</div>
                    </div>
                    <div className="bg-yellow-100 text-yellow-800 p-2 rounded text-center">
                        <div className="font-medium">Ğ¥Ğ¾Ñ€Ğ¾ÑˆĞ¾</div>
                        <div className="text-xs">ĞĞµĞ±Ğ¾Ğ»ÑŒÑˆĞ¸Ğµ Ğ¿Ğ¾Ñ‚ĞµÑ€Ñ‚Ğ¾ÑÑ‚Ğ¸</div>
                    </div>
                    <div className="bg-orange-100 text-orange-800 p-2 rounded text-center">
                        <div className="font-medium">Ğ£Ğ´Ğ¾Ğ²Ğ»ĞµÑ‚Ğ²Ğ¾Ñ€Ğ¸Ñ‚ĞµĞ»ÑŒĞ½Ğ¾</div>
                        <div className="text-xs">Ğ—Ğ°Ğ¼ĞµÑ‚Ğ½Ñ‹Ğ¹ Ğ¸Ğ·Ğ½Ğ¾Ñ</div>
                    </div>
                    <div className="bg-red-100 text-red-800 p-2 rounded text-center">
                        <div className="font-medium">Ğ¢Ñ€ĞµĞ±ÑƒĞµÑ‚ Ñ€ĞµĞ¼Ğ¾Ğ½Ñ‚Ğ°</div>
                        <div className="text-xs">ĞĞµ ÑĞ´Ğ°ĞµÑ‚ÑÑ</div>
                    </div>
                </div>
            </div>

            {selectedEquipment && (
                <EquipmentEditDialog
                    open={showEditDialog}
                    onClose={handleCloseDialog}
                    equipment={selectedEquipment}
                />
            )}
        </div>
    );
}

```


## <a name="srcpagesHomePagetsx"></a>`src/pages/HomePage.tsx`

```tsx
// path: src/pages/HomePage.tsx

// src/pages/HomePage.tsx

import { useEffect, useRef, useState, useMemo } from "react";
import { useNavigate, useLocation } from "react-router-dom";
import { useReserveStore } from "@/store/reserveStore";
import { X } from "lucide-react";

// ĞšĞ¾Ğ¼Ğ¿Ğ¾Ğ½ĞµĞ½Ñ‚Ñ‹
import AuthStatus from "@/components/AuthStatus";
import DateRangeSelector from "@/components/DateRangeSelector";
import DiscountCalculator from "@/components/DiscountCalculator";
import ReservationFooter from "@/components/ReservationFooter";
import EquipmentCatalog from "@/components/catalog/EquipmentCatalog";
import UserSession from "@/components/session/UserSession";
import { Button } from "@/components/ui/button";

// Ğ¥ÑƒĞºĞ¸
import { useReservationManagement } from "@/hooks/useReservationManagement";
import { useDateStore } from "@/store/dateStore";
import { useHolidayStore } from "@/store/holidayStore";
import { useEquipmentData } from "@/hooks/data/useEquipmentData";
import { useAppFilters } from "@/hooks/features/useAppFilters";

export default function HomePage() {
    const navigate = useNavigate();
    const location = useLocation();
    const containerRef = useRef<HTMLDivElement>(null);
    const { clearItemsOnly, items: selectedItems = [] } = useReserveStore();
    
    // ĞŸĞ¾Ğ»ÑƒÑ‡Ğ°ĞµĞ¼ Ğ½ÑƒĞ¶Ğ½Ñ‹Ğµ Ğ´Ğ°Ğ½Ğ½Ñ‹Ğµ Ğ¸ Ñ„ÑƒĞ½ĞºÑ†Ğ¸Ğ¸ Ğ¸Ğ· Ñ…Ñ€Ğ°Ğ½Ğ¸Ğ»Ğ¸Ñ‰
    const { setRange, initializeDates } = useDateStore();
    const { holidays, fetchHolidays } = useHolidayStore();
    const [datesInitialized, setDatesInitialized] = useState(false);

    // ĞŸĞ¾Ğ»ÑƒÑ‡Ğ°ĞµĞ¼ ÑĞ¾ÑÑ‚Ğ¾ÑĞ½Ğ¸Ğµ Ñ„Ğ¸Ğ»ÑŒÑ‚Ñ€Ğ¾Ğ² Ğ´Ğ»Ñ Ğ¿ĞµÑ€ĞµĞ´Ğ°Ñ‡Ğ¸ Ğ² EquipmentCatalog
    const { query, type, brand, availableOnly, associationId, startDate, endDate } = useAppFilters();

    // ĞŸĞ¾Ğ»ÑƒÑ‡Ğ°ĞµĞ¼ Ğ´Ğ°Ğ½Ğ½Ñ‹Ğµ Ğ¾Ğ±Ğ¾Ñ€ÑƒĞ´Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ Ğ´Ğ»Ñ useReservationManagement
    const {
        equipment,
        availabilityData,
    } = useEquipmentData({ query, type, brand, associationId, availableOnly, startDate, endDate });

    // Ğ¡Ğ¾Ğ·Ğ´Ğ°ĞµĞ¼ availabilityMap Ğ¸Ğ· availabilityData Ğ´Ğ»Ñ useReservationManagement
    const availabilityMap = useMemo(() => {
        const map: Record<number, any> = {};
        availabilityData?.forEach((info) => {
            map[info.equipment_id] = info;
        });
        return map;
    }, [availabilityData]);

    // ĞŸĞ¾Ğ»ÑƒÑ‡Ğ°ĞµĞ¼ Ğ»Ğ¾Ğ³Ğ¸ĞºÑƒ ÑƒĞ¿Ñ€Ğ°Ğ²Ğ»ĞµĞ½Ğ¸Ñ Ñ€ĞµĞ·ĞµÑ€Ğ²Ğ°Ğ¼Ğ¸
    const {
        editingReservationId,
        intent,
    } = useReservationManagement(equipment, availabilityMap, availableOnly);

    // +++ ĞĞĞ§ĞĞ›Ğ: Ğ”ĞĞ‘ĞĞ’Ğ›Ğ•ĞĞ Ğ›ĞĞ“Ğ˜ĞšĞ Ğ˜ĞĞ˜Ğ¦Ğ˜ĞĞ›Ğ˜Ğ—ĞĞ¦Ğ˜Ğ˜ Ğ”ĞĞ¢ +++
    // 1. Ğ—Ğ°Ğ³Ñ€ÑƒĞ¶Ğ°ĞµĞ¼ Ğ²Ñ‹Ñ…Ğ¾Ğ´Ğ½Ñ‹Ğµ Ğ¿Ñ€Ğ¸ Ğ¼Ğ¾Ğ½Ñ‚Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğ¸ ĞºĞ¾Ğ¼Ğ¿Ğ¾Ğ½ĞµĞ½Ñ‚Ğ°
    useEffect(() => {
        const today = new Date();
        const futureDate = new Date();
        futureDate.setDate(today.getDate() + 30); // Ğ—Ğ°Ğ³Ñ€ÑƒĞ¶Ğ°ĞµĞ¼ Ğ½Ğ° 30 Ğ´Ğ½ĞµĞ¹ Ğ²Ğ¿ĞµÑ€ĞµĞ´
        fetchHolidays(today, futureDate);
    }, [fetchHolidays]);

    // 2. Ğ˜Ğ½Ğ¸Ñ†Ğ¸Ğ°Ğ»Ğ¸Ğ·Ğ¸Ñ€ÑƒĞµĞ¼ Ğ´Ğ°Ñ‚Ñ‹, ĞºĞ°Ğº Ñ‚Ğ¾Ğ»ÑŒĞºĞ¾ Ğ²Ñ‹Ñ…Ğ¾Ğ´Ğ½Ñ‹Ğµ Ğ·Ğ°Ğ³Ñ€ÑƒĞ¶ĞµĞ½Ñ‹
    useEffect(() => {
        // Ğ’Ñ‹Ğ¿Ğ¾Ğ»Ğ½ÑĞµĞ¼ Ñ‚Ğ¾Ğ»ÑŒĞºĞ¾ Ğ¾Ğ´Ğ¸Ğ½ Ñ€Ğ°Ğ·, ĞºĞ¾Ğ³Ğ´Ğ° Ğ¿Ğ¾ÑĞ²Ğ¸Ğ»Ğ¸ÑÑŒ Ğ´Ğ°Ğ½Ğ½Ñ‹Ğµ Ğ¾ Ğ²Ñ‹Ñ…Ğ¾Ğ´Ğ½Ñ‹Ñ…
        if (holidays.length > 0 && !datesInitialized) {
            initializeDates(holidays);
            setDatesInitialized(true);
        }
    }, [holidays, initializeDates, datesInitialized]);
    // +++ ĞšĞĞĞ•Ğ¦ +++

    // Ğ¡Ğ¸Ğ½Ñ…Ñ€Ğ¾Ğ½Ğ¸Ğ·Ğ°Ñ†Ğ¸Ñ Ğ´Ğ°Ñ‚ Ğ¸Ğ· ÑĞ¾ÑÑ‚Ğ¾ÑĞ½Ğ¸Ñ Ğ½Ğ°Ğ²Ğ¸Ğ³Ğ°Ñ†Ğ¸Ğ¸
    useEffect(() => {
        const start = (location.state as any)?.startDate;
        const end = (location.state as any)?.endDate;
        if (start && end) {
            const startDate = new Date(start);
            const endDate = new Date(end);
            setRange(startDate, endDate, 'manual', holidays); // ĞŸĞµÑ€ĞµĞ´Ğ°ĞµĞ¼ Ğ¿Ñ€Ğ°Ğ·Ğ´Ğ½Ğ¸ĞºĞ¸ Ğ´Ğ»Ñ ĞºĞ¾Ñ€Ñ€ĞµĞºÑ‚Ğ½Ğ¾Ğ³Ğ¾ Ñ€Ğ°ÑÑ‡ĞµÑ‚Ğ°
        }
    }, [location.state, setRange, holidays]);

    const handleCompleteAddition = () => {
        const { addToReservationMode } = useReserveStore.getState();
        if (addToReservationMode) {
            navigate(location.state?.from || "/reservations/my", {
                replace: true,
                state: {
                    continueEditing: addToReservationMode,
                },
            });
        } else {
            navigate("/reserve/create");
        }
    };

    const handleCancelAddition = () => {
        useReserveStore.getState().clear();
        navigate("/reservations/my", {
            replace: true,
            state: {
                continueEditing: editingReservationId,
            },
        });
    };

    return (
        <div className="bg-gray-50 min-h-screen">
            <div ref={containerRef} className="max-w-7xl mx-auto px-4 py-6 space-y-4 pb-20">
                <AuthStatus />
                <UserSession />

                {editingReservationId && (
                    <div className="flex items-center justify-between p-3 bg-sky-100 border border-sky-300 text-sky-700 rounded-md text-sm shadow">
                        <span>
                            Ğ’Ñ‹ Ğ´Ğ¾Ğ±Ğ°Ğ²Ğ»ÑĞµÑ‚Ğµ Ğ¾Ğ±Ğ¾Ñ€ÑƒĞ´Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ Ğº Ñ€ĞµĞ·ĞµÑ€Ğ²Ñƒ <strong>#{editingReservationId}</strong>. ĞšĞ¾Ğ³Ğ´Ğ° Ğ·Ğ°ĞºĞ¾Ğ½Ñ‡Ğ¸Ñ‚Ğµ, Ğ½Ğ°Ğ¶Ğ¼Ğ¸Ñ‚Ğµ ĞºĞ½Ğ¾Ğ¿ĞºÑƒ Ğ²Ğ½Ğ¸Ğ·Ñƒ ÑÑ‚Ñ€Ğ°Ğ½Ğ¸Ñ†Ñ‹.
                        </span>
                        <Button
                            variant="ghost"
                            size="sm"
                            onClick={handleCancelAddition}
                            className="text-sky-700 hover:bg-sky-200 hover:text-sky-800 flex-shrink-0"
                        >
                            <X className="w-4 h-4 mr-1.5" />
                            ĞÑ‚Ğ¼ĞµĞ½Ğ¸Ñ‚ÑŒ Ğ´Ğ¾Ğ±Ğ°Ğ²Ğ»ĞµĞ½Ğ¸Ğµ
                        </Button>
                    </div>
                )}

                <h1 className="text-2xl font-bold mt-4 text-center">ĞšĞ°Ñ‚Ğ°Ğ»Ğ¾Ğ³ Ğ¾Ğ±Ğ¾Ñ€ÑƒĞ´Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ</h1>

                <DateRangeSelector containerRef={containerRef} />
                <DiscountCalculator />

                <EquipmentCatalog 
                    editingReservationId={editingReservationId}
                    intent={intent}
                />
            </div>

            <ReservationFooter
                selectedCount={selectedItems.length}
                onClick={handleCompleteAddition}
                onReset={clearItemsOnly}
                isEditingMode={!!editingReservationId}
                intent={intent || ''}
            />
        </div>
    );
}

```


## <a name="srcpagesMyReservationsPagetsx"></a>`src/pages/MyReservationsPage.tsx`

```tsx
// path: src/pages/MyReservationsPage.tsx

// src/pages/MyReservationsPage.tsx
import { useState, useEffect, useMemo } from "react";
import { useNavigate, useLocation } from "react-router-dom";
import { Button } from "@/components/ui/button";
import { ToggleGroup, ToggleGroupItem } from "@/components/ui/toggle-group";
import MyReservationList from "../components/MyReservationList";
import { useCurrentUser } from "@/hooks/useProfile";
import UserInfoBlock from "@/components/UserInfoBlock";
import { useMyRentals } from "@/hooks/useMyRentals";
import MyRentalsList from "@/components/rental/MyRentalsList";
import { ClipboardList, Truck } from "lucide-react";
import OrderToolbar from "@/components/shared/OrderToolbar";
import { useOrderFilterStore } from "@/store/orderFilterStore";
import { useReservations } from "@/hooks/useReservations";

interface MyReservationsLocationState {
    from?: string;
    continueEditing?: number;
    highlightRentalId?: number;
    highlightReservationId?: number;
}

export default function MyReservationsPage() {
    const { data: user, isLoading } = useCurrentUser();
    const navigate = useNavigate();
    const location = useLocation();

    const [activeTab, setActiveTab] = useState<'reservations' | 'rentals'>('reservations');
    const [highlightId, setHighlightId] = useState<number | null>(null);

    const locationState = location.state as MyReservationsLocationState | null;

    const cameFrom = locationState?.from;
    const continueEditingReservationId = locationState?.continueEditing;

    // ĞŸĞ¾Ğ»ÑƒÑ‡Ğ°ĞµĞ¼ Ğ¿Ğ°Ñ€Ğ°Ğ¼ĞµÑ‚Ñ€Ñ‹ Ñ„Ğ¸Ğ»ÑŒÑ‚Ñ€Ğ°Ñ†Ğ¸Ğ¸ Ğ¸Ğ· ÑÑ‚Ğ¾Ñ€Ğ°
    const { searchQuery, statusFilter, sortOption } = useOrderFilterStore();

    // ĞĞ¿Ñ€ĞµĞ´ĞµĞ»ÑĞµĞ¼ ĞºĞ¾Ğ½Ñ‚ĞµĞºÑÑ‚ Ğ´Ğ»Ñ OrderToolbar
    const toolbarContext = useMemo(() => {
        return activeTab === 'reservations' ? 'user-reservations' : 'user-rentals';
    }, [activeTab]);

    // ĞŸĞ¾Ğ´Ğ³Ğ¾Ñ‚Ğ°Ğ²Ğ»Ğ¸Ğ²Ğ°ĞµĞ¼ Ğ¿Ğ°Ñ€Ğ°Ğ¼ĞµÑ‚Ñ€Ñ‹ Ğ´Ğ»Ñ API Ğ·Ğ°Ğ¿Ñ€Ğ¾ÑĞ¾Ğ²
    const apiParams = useMemo(() => ({
        search: searchQuery || undefined,
        status: statusFilter === 'all' ? undefined : statusFilter,
        sort: sortOption
    }), [searchQuery, statusFilter, sortOption]);

    // ĞŸĞ¾Ğ»ÑƒÑ‡Ğ°ĞµĞ¼ Ğ´Ğ°Ğ½Ğ½Ñ‹Ğµ Ñ ÑĞµÑ€Ğ²ĞµÑ€Ğ½Ğ¾Ğ¹ Ñ„Ğ¸Ğ»ÑŒÑ‚Ñ€Ğ°Ñ†Ğ¸ĞµĞ¹
    const { reservationsQuery } = useReservations(apiParams);
    const { data: rentalsData } = useMyRentals(apiParams);

    useEffect(() => {
        const { highlightRentalId, highlightReservationId } = locationState || {};
        if (highlightRentalId) {
            setActiveTab('rentals');
            setHighlightId(highlightRentalId);
        } else if (highlightReservationId) {
            setActiveTab('reservations');
            setHighlightId(highlightReservationId);
        }
    }, [locationState]);

    useEffect(() => {
        // Ğ¡Ğ±Ñ€Ğ¾Ñ Ğ¿Ğ¾Ğ´ÑĞ²ĞµÑ‚ĞºĞ¸ Ñ‡ĞµÑ€ĞµĞ· Ğ½ĞµĞºĞ¾Ñ‚Ğ¾Ñ€Ğ¾Ğµ Ğ²Ñ€ĞµĞ¼Ñ
        if (highlightId) {
            const timer = setTimeout(() => {
                setHighlightId(null);
                navigate(location.pathname, { replace: true, state: {} });
            }, 2500);
            return () => clearTimeout(timer);
        }
    }, [highlightId, navigate, location.pathname]);

    useEffect(() => {
        if (continueEditingReservationId) {
            console.log(`[MyReservationsPage] Processing return from equipment addition to reservation #${continueEditingReservationId}`);
        }
    }, [continueEditingReservationId]);

    if (isLoading) {
        return (
            <p className="text-center mt-12 text-sm text-gray-500">
                Ğ—Ğ°Ğ³Ñ€ÑƒĞ·ĞºĞ° Ğ¿Ñ€Ğ¾Ñ„Ğ¸Ğ»Ñ...
            </p>
        );
    }

    if (!user) {
        return (
            <div className="text-center mt-12">
                <p className="text-lg">
                    Ğ¢Ğ¾Ğ»ÑŒĞºĞ¾ Ğ°Ğ²Ñ‚Ğ¾Ñ€Ğ¸Ğ·Ğ¾Ğ²Ğ°Ğ½Ğ½Ñ‹Ğµ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ğ¸ Ğ¼Ğ¾Ğ³ÑƒÑ‚ Ğ¿Ñ€Ğ¾ÑĞ¼Ğ°Ñ‚Ñ€Ğ¸Ğ²Ğ°Ñ‚ÑŒ ÑĞ²Ğ¾Ğ¸ Ñ€ĞµĞ·ĞµÑ€Ğ²Ñ‹.
                </p>
                <Button className="mt-4" onClick={() => navigate("/reserve/create")}>
                    Ğ’Ğ¾Ğ¹Ñ‚Ğ¸ Ğ¸ Ğ¾Ñ„Ğ¾Ñ€Ğ¼Ğ¸Ñ‚ÑŒ Ñ€ĞµĞ·ĞµÑ€Ğ²
                </Button>
            </div>
        );
    }

    const handleEditProfile = () => {
        navigate("/profile", { state: { from: location.pathname } });
    };

    return (
        <div className="max-w-4xl mx-auto px-4 py-6 space-y-6">
            <div className="mb-6">
                <UserInfoBlock onEditProfile={handleEditProfile} />
            </div>

            <div className="flex items-center justify-between">
                <h1 className="text-2xl font-bold">ĞœĞ¾Ğ¸ Ğ·Ğ°ĞºĞ°Ğ·Ñ‹</h1>
                <div className="flex items-center gap-3">
                    <Button variant="secondary" onClick={() => navigate(cameFrom || "/")}>
                        â† ĞĞ°Ğ·Ğ°Ğ´
                    </Button>
                    <Button variant="outline" onClick={() => navigate("/")}>
                        ĞĞ° Ğ³Ğ»Ğ°Ğ²Ğ½ÑƒÑ
                    </Button>
                </div>
            </div>

            {/* Ğ’ĞºĞ»Ğ°Ğ´ĞºĞ¸ */}
            <ToggleGroup
                type="single"
                value={activeTab}
                onValueChange={(value) => { if (value) setActiveTab(value as any); }}
                className="w-full"
            >
                <ToggleGroupItem value="reservations" className="w-1/2 data-[state=on]:bg-sky-100 data-[state=on]:text-sky-800">
                    <ClipboardList className="w-4 h-4 mr-2" />
                    Ğ ĞµĞ·ĞµÑ€Ğ²Ñ‹
                </ToggleGroupItem>
                <ToggleGroupItem value="rentals" className="w-1/2 data-[state=on]:bg-orange-100 data-[state=on]:text-orange-800">
                    <Truck className="w-4 h-4 mr-2" />
                    ĞÑ€ĞµĞ½Ğ´Ñ‹
                </ToggleGroupItem>
            </ToggleGroup>

            {/* Ğ£Ğ²ĞµĞ´Ğ¾Ğ¼Ğ»ĞµĞ½Ğ¸Ğµ Ğ¾ Ñ€ĞµĞ´Ğ°ĞºÑ‚Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğ¸ Ñ€ĞµĞ·ĞµÑ€Ğ²Ğ° */}
            {continueEditingReservationId && activeTab === 'reservations' && (
                <div className="p-3 bg-sky-100 border border-sky-300 text-sky-700 rounded-md text-sm">
                    Ğ’Ñ‹ Ğ²ĞµÑ€Ğ½ÑƒĞ»Ğ¸ÑÑŒ Ğº Ñ€ĞµĞ´Ğ°ĞºÑ‚Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ Ñ€ĞµĞ·ĞµÑ€Ğ²Ğ° #{continueEditingReservationId}. Ğ’Ñ‹Ğ±Ñ€Ğ°Ğ½Ğ½Ñ‹Ğµ Ğ¿Ğ¾Ğ·Ğ¸Ñ†Ğ¸Ğ¸ Ğ´Ğ¾Ğ±Ğ°Ğ²Ğ»ĞµĞ½Ñ‹.
                </div>
            )}

            {/* Ğ¢ÑƒĞ»Ğ±Ğ°Ñ€ Ñ„Ğ¸Ğ»ÑŒÑ‚Ñ€Ğ°Ñ†Ğ¸Ğ¸ */}
            <OrderToolbar context={toolbarContext} showHideCompletedCheckbox={true} />

            {/* Ğ£ÑĞ»Ğ¾Ğ²Ğ½Ñ‹Ğ¹ Ñ€ĞµĞ½Ğ´ĞµÑ€Ğ¸Ğ½Ğ³ ÑĞ¿Ğ¸ÑĞºĞ¾Ğ² */}
            <div>
                {activeTab === 'reservations' ? (
                    <MyReservationList
                        continueEditingReservationId={continueEditingReservationId}
                        highlightId={highlightId}
                        reservationsData={reservationsQuery.data}
                        isLoading={reservationsQuery.isLoading}
                        isError={reservationsQuery.isError}
                    />
                ) : (
                    <MyRentalsList 
                        highlightId={highlightId}
                        rentalsData={rentalsData}
                    />
                )}
            </div>
        </div>
    );
}

```


## <a name="srcpagesProfilePagetsx"></a>`src/pages/ProfilePage.tsx`

```tsx
// path: src/pages/ProfilePage.tsx

// src/pages/ProfilePage.tsx

import { useState, useEffect } from "react"
import { Input } from "@/components/ui/input"
import { Label } from "@/components/ui/label"
import { Button } from "@/components/ui/button"
import { useNavigate, useLocation } from "react-router-dom"
import { useProfileUpdate, useCurrentUser } from "@/hooks/useProfile"
import { useAuthStore } from "@/store/authStore"
import { toast } from "sonner"
import { PhoneInput } from "@/components/ui/phone-input"
import { Alert, AlertDescription } from "@/components/ui/alert"
import { AlertCircle, CheckCircle } from "lucide-react"
// âœ… 1. Ğ˜Ğ¼Ğ¿Ğ¾Ñ€Ñ‚Ğ¸Ñ€ÑƒĞµĞ¼ Ğ½Ğ°Ñˆ Ğ½Ğ¾Ğ²Ñ‹Ğ¹ ĞºĞ¾Ğ¼Ğ¿Ğ¾Ğ½ĞµĞ½Ñ‚ Ğ´Ğ»Ñ Ğ¾Ñ‚Ğ¾Ğ±Ñ€Ğ°Ğ¶ĞµĞ½Ğ¸Ñ Ğ¸ÑÑ‚Ğ¾Ñ€Ğ¸Ğ¸
import BalanceHistoryTable from "@/components/profile/BalanceHistoryTable";

// Ğ¤ÑƒĞ½ĞºÑ†Ğ¸Ñ Ğ²Ğ°Ğ»Ğ¸Ğ´Ğ°Ñ†Ğ¸Ğ¸ Ñ‚ĞµĞ»ĞµÑ„Ğ¾Ğ½Ğ°
const validatePhone = (phone: string): boolean => {
    if (!phone) return true; // ĞŸÑƒÑÑ‚Ğ¾Ğ¹ Ñ‚ĞµĞ»ĞµÑ„Ğ¾Ğ½ Ñ€Ğ°Ğ·Ñ€ĞµÑˆĞµĞ½
    return /^\+7 \(\d{3}\) \d{3}-\d{2}-\d{2}$/.test(phone);
};

export default function ProfilePage() {
    const navigate = useNavigate()
    const location = useLocation()
    const { logout } = useAuthStore()

    const backTo = location.state?.from || "/"

    const { data: user, isLoading } = useCurrentUser()
    const updateProfile = useProfileUpdate()

    const [fullName, setFullName] = useState("")
    const [email, setEmail] = useState("")
    const [phone, setPhone] = useState("")
    const [emailChanged, setEmailChanged] = useState(false)
    const [originalEmail, setOriginalEmail] = useState("")
    const [showEmailWarning, setShowEmailWarning] = useState(false)

    useEffect(() => {
        if (user) {
            setFullName(user.full_name)
            setEmail(user.email)
            setPhone(user.phone || "")
            setOriginalEmail(user.email)
        }
    }, [user])

    // ĞÑ‚ÑĞ»ĞµĞ¶Ğ¸Ğ²Ğ°ĞµĞ¼ Ğ¸Ğ·Ğ¼ĞµĞ½ĞµĞ½Ğ¸Ñ email
    useEffect(() => {
        if (originalEmail && email !== originalEmail) {
            setEmailChanged(true)
            setShowEmailWarning(true)
        } else {
            setEmailChanged(false)
            setShowEmailWarning(false)
        }
    }, [email, originalEmail])

    const handleUpdate = async (e: React.FormEvent) => {
        e.preventDefault()

        // Ğ’Ğ°Ğ»Ğ¸Ğ´Ğ°Ñ†Ğ¸Ñ Ñ‚ĞµĞ»ĞµÑ„Ğ¾Ğ½Ğ°
        if (!validatePhone(phone)) {
            toast.error("ĞĞµĞºĞ¾Ñ€Ñ€ĞµĞºÑ‚Ğ½Ñ‹Ğ¹ Ñ„Ğ¾Ñ€Ğ¼Ğ°Ñ‚ Ğ½Ğ¾Ğ¼ĞµÑ€Ğ° Ñ‚ĞµĞ»ĞµÑ„Ğ¾Ğ½Ğ°")
            return
        }

        try {
            // ĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑĞµĞ¼, Ğ¸Ğ·Ğ¼ĞµĞ½Ğ¸Ğ»ÑÑ Ğ»Ğ¸ email
            const emailChanged = user && email !== user.email;

            await updateProfile.mutateAsync({ full_name: fullName, email, phone }) // <<< Ğ˜Ğ—ĞœĞ•ĞĞ•ĞĞ˜Ğ•: ĞŸĞµÑ€ĞµĞ´Ğ°ĞµĞ¼ Ñ‚ĞµĞ»ĞµÑ„Ğ¾Ğ½
            toast.success("ĞŸÑ€Ğ¾Ñ„Ğ¸Ğ»ÑŒ ÑƒÑĞ¿ĞµÑˆĞ½Ğ¾ Ğ¾Ğ±Ğ½Ğ¾Ğ²Ğ»Ñ‘Ğ½")

            // <<< Ğ˜Ğ—ĞœĞ•ĞĞ•ĞĞ˜Ğ•: ĞŸĞ¾ĞºĞ°Ğ·Ñ‹Ğ²Ğ°ĞµĞ¼ ÑƒĞ²ĞµĞ´Ğ¾Ğ¼Ğ»ĞµĞ½Ğ¸Ğµ-Ğ·Ğ°Ğ³Ğ»ÑƒÑˆĞºÑƒ, ĞµÑĞ»Ğ¸ email Ğ±Ñ‹Ğ» Ğ¸Ğ·Ğ¼ĞµĞ½ĞµĞ½
            if (emailChanged) {
                toast.info("ĞĞ° Ğ²Ğ°ÑˆÑƒ Ğ½Ğ¾Ğ²ÑƒÑ Ğ¿Ğ¾Ñ‡Ñ‚Ñƒ Ğ¾Ñ‚Ğ¿Ñ€Ğ°Ğ²Ğ»ĞµĞ½Ğ° ÑÑÑ‹Ğ»ĞºĞ° Ğ´Ğ»Ñ Ğ¿Ğ¾Ğ´Ñ‚Ğ²ĞµÑ€Ğ¶Ğ´ĞµĞ½Ğ¸Ñ (Ñ„ÑƒĞ½ĞºÑ†Ğ¸Ğ¾Ğ½Ğ°Ğ» Ğ² Ñ€Ğ°Ğ·Ñ€Ğ°Ğ±Ğ¾Ñ‚ĞºĞµ).")
                // Ğ’ Ğ±ÑƒĞ´ÑƒÑ‰ĞµĞ¼ Ğ·Ğ´ĞµÑÑŒ Ğ¼Ğ¾Ğ¶Ğ½Ğ¾ Ğ±ÑƒĞ´ĞµÑ‚ ÑĞ±Ñ€Ğ¾ÑĞ¸Ñ‚ÑŒ email Ğ² Ñ„Ğ¾Ñ€Ğ¼Ğµ Ğ¾Ğ±Ñ€Ğ°Ñ‚Ğ½Ğ¾ Ğ½Ğ° ÑÑ‚Ğ°Ñ€Ñ‹Ğ¹,
                // Ğ¿Ğ¾ĞºĞ° Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ÑŒ Ğ½Ğµ Ğ¿Ğ¾Ğ´Ñ‚Ğ²ĞµÑ€Ğ´Ğ¸Ñ‚ Ğ½Ğ¾Ğ²Ñ‹Ğ¹.
            }

        } catch (err) {
            console.error(err)
            toast.error("ĞÑˆĞ¸Ğ±ĞºĞ° Ğ¿Ñ€Ğ¸ Ğ¾Ğ±Ğ½Ğ¾Ğ²Ğ»ĞµĞ½Ğ¸Ğ¸ Ğ¿Ñ€Ğ¾Ñ„Ğ¸Ğ»Ñ")
        }
    }

    if (isLoading) {
        return <p className="text-center mt-12 text-gray-500">Ğ—Ğ°Ğ³Ñ€ÑƒĞ·ĞºĞ°...</p>
    }

    if (!user) {
        return (
            <div className="text-center mt-12">
                <p className="text-lg">Ğ’Ñ‹ Ğ½Ğµ Ğ°Ğ²Ñ‚Ğ¾Ñ€Ğ¸Ğ·Ğ¾Ğ²Ğ°Ğ½Ñ‹.</p>
                <Button className="mt-4" onClick={() => navigate("/")}>
                    ĞĞ° Ğ³Ğ»Ğ°Ğ²Ğ½ÑƒÑ
                </Button>
            </div>
        )
    }

    return (
        // âœ… 2. Ğ£Ğ²ĞµĞ»Ğ¸Ñ‡Ğ¸Ğ²Ğ°ĞµĞ¼ Ğ¼Ğ°ĞºÑĞ¸Ğ¼Ğ°Ğ»ÑŒĞ½ÑƒÑ ÑˆĞ¸Ñ€Ğ¸Ğ½Ñƒ ĞºĞ¾Ğ½Ñ‚ĞµĞ¹Ğ½ĞµÑ€Ğ°, Ñ‡Ñ‚Ğ¾Ğ±Ñ‹ Ñ‚Ğ°Ğ±Ğ»Ğ¸Ñ†Ğ° Ğ¿Ğ¾Ğ¼ĞµÑÑ‚Ğ¸Ğ»Ğ°ÑÑŒ
        <div className="max-w-4xl mx-auto px-4 py-8 space-y-6">
            <div className="bg-white border rounded-lg shadow-sm p-6 space-y-4">
                <h1 className="text-xl font-bold text-center">Ğ ĞµĞ´Ğ°ĞºÑ‚Ğ¸Ñ€Ğ¾Ğ²Ğ°Ñ‚ÑŒ Ğ¿Ñ€Ğ¾Ñ„Ğ¸Ğ»ÑŒ</h1>

                <form onSubmit={handleUpdate} className="space-y-4">
                    <div>
                        <Label htmlFor="fullName">Ğ¤Ğ˜Ğ</Label>
                        <Input
                            id="fullName"
                            type="text"
                            value={fullName}
                            onChange={(e) => setFullName(e.target.value)}
                            required
                        />
                    </div>

                    <div>
                        <Label htmlFor="email">Email</Label>
                        <Input
                            id="email"
                            type="email"
                            value={email}
                            onChange={(e) => setEmail(e.target.value)}
                            required
                        />
                    </div>

                    {/* +++ ĞĞĞ§ĞĞ›Ğ: ĞĞ¾Ğ²Ğ¾Ğµ Ğ¿Ğ¾Ğ»Ğµ Ğ´Ğ»Ñ Ñ‚ĞµĞ»ĞµÑ„Ğ¾Ğ½Ğ° +++ */}
                    <div>
                        <Label htmlFor="phone">Ğ¢ĞµĞ»ĞµÑ„Ğ¾Ğ½</Label>
                        <PhoneInput
                            id="phone"
                            value={phone}
                            onChange={(e) => setPhone(e.target.value)}
                            placeholder="+7 (___) ___-__-__"
                        />
                    </div>
                    {/* +++ ĞšĞĞĞ•Ğ¦: ĞĞ¾Ğ²Ğ¾Ğµ Ğ¿Ğ¾Ğ»Ğµ Ğ´Ğ»Ñ Ñ‚ĞµĞ»ĞµÑ„Ğ¾Ğ½Ğ° +++ */}

                    {showEmailWarning && (
                        <Alert>
                            <AlertCircle className="h-4 w-4" />
                            <AlertDescription>
                                ĞŸĞ¾ÑĞ»Ğµ Ğ¸Ğ·Ğ¼ĞµĞ½ĞµĞ½Ğ¸Ñ email Ğ¿Ğ¾Ñ‚Ñ€ĞµĞ±ÑƒĞµÑ‚ÑÑ Ğ¿Ğ¾Ğ´Ñ‚Ğ²ĞµÑ€Ğ¶Ğ´ĞµĞ½Ğ¸Ğµ Ğ½Ğ¾Ğ²Ğ¾Ğ³Ğ¾ Ğ°Ğ´Ñ€ĞµÑĞ°.
                                ĞĞ° ÑƒĞºĞ°Ğ·Ğ°Ğ½Ğ½ÑƒÑ Ğ¿Ğ¾Ñ‡Ñ‚Ñƒ Ğ±ÑƒĞ´ĞµÑ‚ Ğ¾Ñ‚Ğ¿Ñ€Ğ°Ğ²Ğ»ĞµĞ½Ğ° ÑÑÑ‹Ğ»ĞºĞ° Ğ´Ğ»Ñ Ğ¿Ğ¾Ğ´Ñ‚Ğ²ĞµÑ€Ğ¶Ğ´ĞµĞ½Ğ¸Ñ.
                            </AlertDescription>
                        </Alert>
                    )}

                    <div className="flex justify-between items-center pt-2">
                        <Button type="submit" disabled={updateProfile.isPending}>
                            {updateProfile.isPending ? "Ğ¡Ğ¾Ñ…Ñ€Ğ°Ğ½ĞµĞ½Ğ¸Ğµ..." : "Ğ¡Ğ¾Ñ…Ñ€Ğ°Ğ½Ğ¸Ñ‚ÑŒ"}
                        </Button>
                        <Button type="button" variant="ghost" onClick={() => navigate(backTo)}>
                            ĞĞ°Ğ·Ğ°Ğ´
                        </Button>
                    </div>
                </form>

                <div className="pt-4 border-t text-center space-y-2">
                    <p className="text-xs text-gray-500">
                        Ğ”Ğ»Ñ Ğ¸Ğ·Ğ¼ĞµĞ½ĞµĞ½Ğ¸Ñ Ğ¿Ğ°Ñ€Ğ¾Ğ»Ñ Ğ¾Ğ±Ñ€Ğ°Ñ‚Ğ¸Ñ‚ĞµÑÑŒ Ğº Ğ°Ğ´Ğ¼Ğ¸Ğ½Ğ¸ÑÑ‚Ñ€Ğ°Ñ‚Ğ¾Ñ€Ñƒ.
                    </p>
                    <Button
                        variant="link"
                        className="text-red-600"
                        onClick={() => {
                            logout()
                            navigate("/")
                        }}
                    >
                        Ğ’Ñ‹Ğ¹Ñ‚Ğ¸ Ğ¸Ğ· Ğ°ĞºĞºĞ°ÑƒĞ½Ñ‚Ğ°
                    </Button>
                </div>
            </div>

            {/* âœ… 3. Ğ”Ğ¾Ğ±Ğ°Ğ²Ğ»ÑĞµĞ¼ Ğ½Ğ¾Ğ²Ñ‹Ğ¹ Ğ±Ğ»Ğ¾Ğº Ñ Ğ¸ÑÑ‚Ğ¾Ñ€Ğ¸ĞµĞ¹ Ğ±Ğ°Ğ»Ğ°Ğ½ÑĞ° */}
            <div className="bg-white border rounded-lg shadow-sm p-6 space-y-4">
                <h2 className="text-xl font-bold">Ğ˜ÑÑ‚Ğ¾Ñ€Ğ¸Ñ Ğ±Ğ°Ğ»Ğ°Ğ½ÑĞ°</h2>
                <BalanceHistoryTable userId={user.id} />
            </div>
        </div>
    )
}

```


## <a name="srcpagesReservePagetsx"></a>`src/pages/ReservePage.tsx`

```tsx
// path: src/pages/ReservePage.tsx

// src/pages/ReservePage.tsx
import { useNavigate, useLocation } from "react-router-dom";
import { useState, useMemo } from "react";
import AuthForm from "@/components/AuthForm";
import UserInfoBlock from "@/components/UserInfoBlock";
import CancelReservationDialog from "@/components/CancelReservationDialog";
import { Button } from "@/components/ui/button";
import { useReserveSubmission } from "@/hooks/reservation/submission/useReserveSubmission";
import { formatDate } from "@/lib/utils";
import { ShoppingCart } from "lucide-react";

import ReservationItemsList from "@/components/reservation/ReservationItemsList";
import FinancialSummaryBlock from "@/components/shared/FinancialSummaryBlock";

export default function ReservePage() {
    const navigate = useNavigate();
    const location = useLocation();

    const {
        items,
        user,
        startDate,
        endDate,
        setStartDate,
        setEndDate,
        availabilityMap,
        unavailableIdsFromAPI,
        invalidItems,
        submitMessage,
        reservationSuccess,
        clearReserveStore,
        removeItemFromStore,
        isAccessorySelected,
        toggleAccessory,
        isLoadingAvailability,
        isSubmitting,
        isApplyingPromoCode,
        priceDetails,
        accessoriesDailyTotal,
        promoCode,
        promoCodeMessage,
        applyPromoCode,
        setPromoCode,
        removePromoCode,
        handleSubmit,
        selectedAccessories,
    } = useReserveSubmission();

    const [showCancelDialog, setShowCancelDialog] = useState(false);

    const handleConfirmCancel = () => {
        clearReserveStore();
        navigate("/");
    };

    const isFormValid = useMemo(() => {
        return !!(user && invalidItems.length === 0 && unavailableIdsFromAPI.length === 0);
    }, [user, invalidItems.length, unavailableIdsFromAPI.length]);

    // âœ… Ğ”ĞĞ‘ĞĞ’Ğ›Ğ•ĞĞ: Ğ Ğ°ÑÑ‡ĞµÑ‚ Ğ¼Ğ¸Ğ½Ğ¸Ğ¼Ğ°Ğ»ÑŒĞ½Ğ¾Ğ¹ Ğ´Ğ°Ñ‚Ñ‹ Ğ´Ğ»Ñ Ğ¿Ğ¾Ğ»Ñ "ĞšĞ¾Ğ½ĞµÑ†"
    const minEndDate = useMemo(() => {
        const nextDay = new Date(startDate);
        nextDay.setDate(startDate.getDate() + 1);
        return formatDate(nextDay);
    }, [startDate]);

    if (items.length === 0 && !reservationSuccess) {
        return (
            <div className="text-center mt-12 p-4">
                <ShoppingCart className="mx-auto h-16 w-16 text-gray-300" />
                <p className="mt-4 text-lg text-gray-700">Ğ’Ğ°ÑˆĞ° ĞºĞ¾Ñ€Ğ·Ğ¸Ğ½Ğ° Ğ¿ÑƒÑÑ‚Ğ°.</p>
                <p className="mt-1 text-sm text-gray-500">Ğ’Ñ‹ ĞµÑ‰Ğµ Ğ½Ğµ Ğ²Ñ‹Ğ±Ñ€Ğ°Ğ»Ğ¸ Ğ¾Ğ±Ğ¾Ñ€ÑƒĞ´Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ Ğ´Ğ»Ñ Ñ€ĞµĞ·ĞµÑ€Ğ²Ğ°.</p>
                <Button
                    variant="default"
                    className="mt-6"
                    onClick={() => navigate("/", { state: { intent: "add_to_new_reservation" } })}
                >
                    ĞŸĞµÑ€ĞµĞ¹Ñ‚Ğ¸ Ğº Ğ²Ñ‹Ğ±Ğ¾Ñ€Ñƒ Ğ¾Ğ±Ğ¾Ñ€ÑƒĞ´Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ
                </Button>
            </div>
        );
    }

    if (reservationSuccess) {
        return (
            <div className="text-center pt-8 space-y-4 p-6 bg-green-50 rounded-lg border border-green-200 max-w-3xl mx-auto">
                <p className="text-xl font-semibold text-green-700">âœ… Ğ ĞµĞ·ĞµÑ€Ğ² ÑƒÑĞ¿ĞµÑˆĞ½Ğ¾ ÑĞ¾Ğ·Ğ´Ğ°Ğ½!</p>
                {submitMessage && (<p className="text-sm text-green-600">{submitMessage}</p>)}
                <div className="flex gap-3 justify-center">
                    <Button variant="outline" onClick={() => navigate("/")}>ĞĞ° Ğ³Ğ»Ğ°Ğ²Ğ½ÑƒÑ</Button>
                    <Button variant="default" onClick={() => navigate("/reservations/my")}>Ğš Ğ¼Ğ¾Ğ¸Ğ¼ Ñ€ĞµĞ·ĞµÑ€Ğ²Ğ°Ğ¼</Button>
                </div>
            </div>
        );
    }

    return (
        <>
            <div className="max-w-3xl mx-auto px-4 py-6 space-y-6">
                <div className="flex items-center justify-between">
                    <h1 className="text-2xl font-bold">ĞÑ„Ğ¾Ñ€Ğ¼Ğ»ĞµĞ½Ğ¸Ğµ Ñ€ĞµĞ·ĞµÑ€Ğ²Ğ°</h1>
                    <button
                        onClick={() => navigate("/", { state: { intent: "add_to_new_reservation" } })}
                        className="text-sm text-sky-600 hover:underline"
                    >
                        â† Ğ’ĞµÑ€Ğ½ÑƒÑ‚ÑŒÑÑ Ğº Ğ²Ñ‹Ğ±Ğ¾Ñ€Ñƒ
                    </button>
                </div>

                {!user ? <AuthForm /> : <UserInfoBlock onEditProfile={() => navigate("/profile", { state: { from: location.pathname } })} />}

                <div className="p-4 border rounded-md shadow-sm bg-white">
                    <h2 className="text-lg font-semibold mb-3 text-gray-700">Ğ”Ğ°Ñ‚Ñ‹ Ñ€ĞµĞ·ĞµÑ€Ğ²Ğ°:</h2>
                    <div className="flex flex-col sm:flex-row justify-center items-center gap-4">
                        <div className="flex flex-col items-start w-full sm:w-auto">
                            <label htmlFor="start-date" className="text-sm text-gray-600 mb-1">ĞĞ°Ñ‡Ğ°Ğ»Ğ¾:</label>
                            <input id="start-date" type="date" className="border rounded px-3 py-1 text-sm shadow-sm w-full focus:ring-sky-500 focus:border-sky-500"
                                   value={formatDate(startDate)}
                                   onChange={(e) => { const d = new Date(e.target.value); if(!isNaN(d.getTime())) setStartDate(d); }}
                                   min={formatDate(new Date())} />
                        </div>
                        <div className="flex flex-col items-start w-full sm:w-auto">
                            <label htmlFor="end-date" className="text-sm text-gray-600 mb-1">ĞšĞ¾Ğ½ĞµÑ†:</label>
                            <input id="end-date" type="date" className="border rounded px-3 py-1 text-sm shadow-sm w-full focus:ring-sky-500 focus:border-sky-500"
                                   value={formatDate(endDate)}
                                   onChange={(e) => { const d = new Date(e.target.value); if(!isNaN(d.getTime())) setEndDate(d); }}
                                // âœ… Ğ˜Ğ—ĞœĞ•ĞĞ•ĞĞ˜Ğ•: Ğ£ÑÑ‚Ğ°Ğ½Ğ¾Ğ²Ğ»ĞµĞ½Ğ¾ Ğ¼Ğ¸Ğ½Ğ¸Ğ¼Ğ°Ğ»ÑŒĞ½Ğ¾Ğµ Ğ·Ğ½Ğ°Ñ‡ĞµĞ½Ğ¸Ğµ Ğ´Ğ»Ñ Ğ¿Ğ¾Ğ»Ñ
                                   min={minEndDate} />
                        </div>
                    </div>
                </div>

                {isLoadingAvailability && <p className="text-center text-gray-500 py-3">ĞŸÑ€Ğ¾Ğ²ĞµÑ€ĞºĞ° Ğ´Ğ¾ÑÑ‚ÑƒĞ¿Ğ½Ğ¾ÑÑ‚Ğ¸...</p>}

                <ReservationItemsList
                    items={items}
                    selectedAccessories={selectedAccessories}
                    availabilityMap={availabilityMap}
                    unavailableIdsFromAPI={unavailableIdsFromAPI}
                    invalidItems={invalidItems}
                    onRemoveItem={removeItemFromStore}
                    onRemoveAccessory={toggleAccessory}
                    isAccessorySelected={isAccessorySelected}
                    onToggleAccessory={toggleAccessory}
                />

                <FinancialSummaryBlock
                    priceDetails={priceDetails}
                    accessoriesDailyTotal={accessoriesDailyTotal}
                    promoCode={promoCode}
                    setPromoCode={setPromoCode}
                    applyPromoCode={applyPromoCode}
                    removePromoCode={removePromoCode}
                    promoCodeMessage={promoCodeMessage}
                    isLoading={isLoadingAvailability}
                    isApplyingPromoCode={isApplyingPromoCode}
                    isSubmitting={isSubmitting}
                    isFormValid={isFormValid}
                    onCancel={() => setShowCancelDialog(true)}
                    onAddMore={() => navigate("/", { state: { intent: "add_to_new_reservation" } })}
                    onSubmit={handleSubmit}
                    variant="default"
                    showActions={true}
                />
            </div>

            <CancelReservationDialog
                open={showCancelDialog}
                onClose={() => setShowCancelDialog(false)}
                onConfirm={handleConfirmCancel}
            />
        </>
    );
}

```


## <a name="srcpagesUserManagementPagetsx"></a>`src/pages/UserManagementPage.tsx`

```tsx
// path: src/pages/UserManagementPage.tsx

// src/pages/UserManagementPage.tsx

import { useMemo } from "react";
import { useCurrentUser } from "@/hooks/useProfile";
import { useAdminUsers } from "@/hooks/useAdminUsers";
import AdminNavigation from "@/components/admin/AdminNavigation";
import UserTable from "@/components/admin/UserTable";
import { Button } from "@/components/ui/button";
import { Shield, Users } from "lucide-react";
import { useNavigate } from "react-router-dom";

export default function UserManagementPage() {
    const { data: currentUser } = useCurrentUser();
    const navigate = useNavigate();
    
    // ĞŸĞ¾Ğ»ÑƒÑ‡Ğ°ĞµĞ¼ Ğ´Ğ°Ğ½Ğ½Ñ‹Ğµ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ĞµĞ¹ Ñ Ğ¿Ğ°Ğ³Ğ¸Ğ½Ğ°Ñ†Ğ¸ĞµĞ¹
    const {
        data: usersData,
        isLoading,
        error,
        fetchNextPage,
        hasNextPage,
        isFetchingNextPage,
    } = useAdminUsers();

    // ĞĞ±ÑŠĞµĞ´Ğ¸Ğ½ÑĞµĞ¼ Ğ²ÑĞµ ÑÑ‚Ñ€Ğ°Ğ½Ğ¸Ñ†Ñ‹ Ğ² Ğ¾Ğ´Ğ¸Ğ½ Ğ¼Ğ°ÑÑĞ¸Ğ² Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ĞµĞ¹
    const allUsers = useMemo(() => {
        if (!usersData?.pages) return [];
        return usersData.pages.flatMap(page => page.items);
    }, [usersData]);

    const isAdmin = currentUser?.role === "admin";
    const isManager = currentUser?.role === "manager" || isAdmin;

    // Ğ•ÑĞ»Ğ¸ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ÑŒ Ğ½Ğµ Ğ¸Ğ¼ĞµĞµÑ‚ Ğ¿Ñ€Ğ°Ğ² Ğ´Ğ¾ÑÑ‚ÑƒĞ¿Ğ°
    if (!isManager) {
        return (
            <div className="max-w-4xl mx-auto px-4 py-8">
                <div className="text-center">
                    <Shield className="w-16 h-16 text-gray-400 mx-auto mb-4" />
                    <h1 className="text-2xl font-bold text-gray-900 mb-2">
                        Ğ”Ğ¾ÑÑ‚ÑƒĞ¿ Ğ¾Ğ³Ñ€Ğ°Ğ½Ğ¸Ñ‡ĞµĞ½
                    </h1>
                    <p className="text-gray-600 mb-4">
                        Ğ£ Ğ²Ğ°Ñ Ğ½ĞµÑ‚ Ğ¿Ñ€Ğ°Ğ² Ğ´Ğ»Ñ Ğ´Ğ¾ÑÑ‚ÑƒĞ¿Ğ° Ğº ÑƒĞ¿Ñ€Ğ°Ğ²Ğ»ĞµĞ½Ğ¸Ñ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ÑĞ¼Ğ¸.
                    </p>
                    <Button onClick={() => navigate("/")}>
                        ĞĞ° Ğ³Ğ»Ğ°Ğ²Ğ½ÑƒÑ
                    </Button>
                </div>
            </div>
        );
    }

    return (
        <div className="max-w-7xl mx-auto px-4 py-6 space-y-6">
            <AdminNavigation />

            {/* Ğ—Ğ°Ğ³Ğ¾Ğ»Ğ¾Ğ²Ğ¾Ğº ÑÑ‚Ñ€Ğ°Ğ½Ğ¸Ñ†Ñ‹ */}
            <div className="flex items-center justify-between">
                <div className="flex items-center gap-3">
                    <Users className="w-8 h-8 text-blue-600" />
                    <div>
                        <h1 className="text-3xl font-bold text-gray-900">
                            Ğ£Ğ¿Ñ€Ğ°Ğ²Ğ»ĞµĞ½Ğ¸Ğµ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ÑĞ¼Ğ¸
                        </h1>
                        <p className="text-gray-600 mt-1">
                            {isAdmin
                                ? "Ğ£Ğ¿Ñ€Ğ°Ğ²Ğ»ĞµĞ½Ğ¸Ğµ ÑƒÑ‡ĞµÑ‚Ğ½Ñ‹Ğ¼Ğ¸ Ğ·Ğ°Ğ¿Ğ¸ÑÑĞ¼Ğ¸, Ñ€Ğ¾Ğ»ÑĞ¼Ğ¸ Ğ¸ Ğ¿Ñ€Ğ°Ğ²Ğ°Ğ¼Ğ¸ Ğ´Ğ¾ÑÑ‚ÑƒĞ¿Ğ°"
                                : "ĞŸÑ€Ğ¾ÑĞ¼Ğ¾Ñ‚Ñ€ Ğ·Ğ°Ñ€ĞµĞ³Ğ¸ÑÑ‚Ñ€Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ½Ñ‹Ñ… Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ĞµĞ¹ ÑĞ¸ÑÑ‚ĞµĞ¼Ñ‹"
                            }
                        </p>
                    </div>
                </div>
            </div>

            {/* ĞÑĞ½Ğ¾Ğ²Ğ½Ğ¾Ğ¹ ĞºĞ¾Ğ½Ñ‚ĞµĞ½Ñ‚ */}
            <div className="bg-white rounded-lg border shadow-sm p-6">
                <UserTable 
                    users={allUsers}
                    isLoading={isLoading}
                    error={error}
                    onLoadMore={fetchNextPage}
                    hasNextPage={hasNextPage}
                    isFetchingNextPage={isFetchingNextPage}
                />
            </div>

            {/* Ğ”Ğ¾Ğ¿Ğ¾Ğ»Ğ½Ğ¸Ñ‚ĞµĞ»ÑŒĞ½Ğ°Ñ Ğ¸Ğ½Ñ„Ğ¾Ñ€Ğ¼Ğ°Ñ†Ğ¸Ñ Ğ´Ğ»Ñ Ğ¼ĞµĞ½ĞµĞ´Ğ¶ĞµÑ€Ğ¾Ğ² */}
            {!isAdmin && (
                <div className="bg-amber-50 border border-amber-200 rounded-lg p-4">
                    <div className="flex items-start gap-3">
                        <Shield className="w-5 h-5 text-amber-600 mt-0.5" />
                        <div className="text-sm">
                            <p className="font-medium text-amber-800 mb-1">
                                ĞĞ³Ñ€Ğ°Ğ½Ğ¸Ñ‡ĞµĞ½Ğ½Ñ‹Ğ¹ Ğ´Ğ¾ÑÑ‚ÑƒĞ¿
                            </p>
                            <p className="text-amber-700">
                                ĞšĞ°Ğº Ğ¼ĞµĞ½ĞµĞ´Ğ¶ĞµÑ€, Ğ²Ñ‹ Ğ¼Ğ¾Ğ¶ĞµÑ‚Ğµ Ğ¿Ñ€Ğ¾ÑĞ¼Ğ°Ñ‚Ñ€Ğ¸Ğ²Ğ°Ñ‚ÑŒ ÑĞ¿Ğ¸ÑĞ¾Ğº Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ĞµĞ¹, Ğ½Ğ¾ Ğ½Ğµ Ğ¼Ğ¾Ğ¶ĞµÑ‚Ğµ:
                            </p>
                            <ul className="list-disc list-inside mt-2 text-amber-700 space-y-1">
                                <li>Ğ˜Ğ·Ğ¼ĞµĞ½ÑÑ‚ÑŒ Ñ€Ğ¾Ğ»Ğ¸ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ĞµĞ¹</li>
                                <li>Ğ‘Ğ»Ğ¾ĞºĞ¸Ñ€Ğ¾Ğ²Ğ°Ñ‚ÑŒ Ğ¸Ğ»Ğ¸ Ñ€Ğ°Ğ·Ğ±Ğ»Ğ¾ĞºĞ¸Ñ€Ğ¾Ğ²Ğ°Ñ‚ÑŒ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ĞµĞ¹</li>
                                <li>Ğ£Ğ´Ğ°Ğ»ÑÑ‚ÑŒ ÑƒÑ‡ĞµÑ‚Ğ½Ñ‹Ğµ Ğ·Ğ°Ğ¿Ğ¸ÑĞ¸</li>
                            </ul>
                            <p className="text-amber-700 mt-2">
                                Ğ”Ğ»Ñ Ğ²Ñ‹Ğ¿Ğ¾Ğ»Ğ½ĞµĞ½Ğ¸Ñ ÑÑ‚Ğ¸Ñ… Ğ´ĞµĞ¹ÑÑ‚Ğ²Ğ¸Ğ¹ Ğ¾Ğ±Ñ€Ğ°Ñ‚Ğ¸Ñ‚ĞµÑÑŒ Ğº Ğ°Ğ´Ğ¼Ğ¸Ğ½Ğ¸ÑÑ‚Ñ€Ğ°Ñ‚Ğ¾Ñ€Ñƒ.
                            </p>
                        </div>
                    </div>
                </div>
            )}

            {/* Ğ˜Ğ½Ñ„Ğ¾Ñ€Ğ¼Ğ°Ñ†Ğ¸Ñ Ğ¾ Ñ€Ğ¾Ğ»ÑÑ… */}
            <div className="bg-gray-50 rounded-lg p-4">
                <h3 className="font-semibold text-gray-900 mb-3">ĞĞ¿Ğ¸ÑĞ°Ğ½Ğ¸Ğµ Ñ€Ğ¾Ğ»ĞµĞ¹ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ĞµĞ¹</h3>
                <div className="grid grid-cols-1 md:grid-cols-3 gap-4 text-sm">
                    <div className="bg-white p-3 rounded border">
                        <div className="font-medium text-gray-900 mb-2">ğŸ‘¤ ĞŸĞ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ÑŒ</div>
                        <ul className="text-gray-600 space-y-1">
                            <li>â€¢ ĞŸÑ€Ğ¾ÑĞ¼Ğ¾Ñ‚Ñ€ ĞºĞ°Ñ‚Ğ°Ğ»Ğ¾Ğ³Ğ° Ğ¾Ğ±Ğ¾Ñ€ÑƒĞ´Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ</li>
                            <li>â€¢ Ğ¡Ğ¾Ğ·Ğ´Ğ°Ğ½Ğ¸Ğµ Ğ¸ ÑƒĞ¿Ñ€Ğ°Ğ²Ğ»ĞµĞ½Ğ¸Ğµ ÑĞ²Ğ¾Ğ¸Ğ¼Ğ¸ Ñ€ĞµĞ·ĞµÑ€Ğ²Ğ°Ğ¼Ğ¸</li>
                            <li>â€¢ Ğ ĞµĞ´Ğ°ĞºÑ‚Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ ÑĞ¾Ğ±ÑÑ‚Ğ²ĞµĞ½Ğ½Ğ¾Ğ³Ğ¾ Ğ¿Ñ€Ğ¾Ñ„Ğ¸Ğ»Ñ</li>
                        </ul>
                    </div>
                    <div className="bg-white p-3 rounded border">
                        <div className="font-medium text-blue-900 mb-2">ğŸ›¡ï¸ ĞœĞµĞ½ĞµĞ´Ğ¶ĞµÑ€</div>
                        <ul className="text-gray-600 space-y-1">
                            <li>â€¢ Ğ’ÑĞµ Ğ¿Ñ€Ğ°Ğ²Ğ° Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ñ</li>
                            <li>â€¢ Ğ£Ğ¿Ñ€Ğ°Ğ²Ğ»ĞµĞ½Ğ¸Ğµ Ğ¾Ğ±Ğ¾Ñ€ÑƒĞ´Ğ¾Ğ²Ğ°Ğ½Ğ¸ĞµĞ¼</li>
                            <li>â€¢ ĞŸÑ€Ğ¾ÑĞ¼Ğ¾Ñ‚Ñ€ Ğ²ÑĞµÑ… Ñ€ĞµĞ·ĞµÑ€Ğ²Ğ¾Ğ²</li>
                            <li>â€¢ ĞŸÑ€Ğ¾ÑĞ¼Ğ¾Ñ‚Ñ€ ÑĞ¿Ğ¸ÑĞºĞ° Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ĞµĞ¹</li>
                        </ul>
                    </div>
                    <div className="bg-white p-3 rounded border">
                        <div className="font-medium text-red-900 mb-2">ğŸ‘‘ ĞĞ´Ğ¼Ğ¸Ğ½Ğ¸ÑÑ‚Ñ€Ğ°Ñ‚Ğ¾Ñ€</div>
                        <ul className="text-gray-600 space-y-1">
                            <li>â€¢ Ğ’ÑĞµ Ğ¿Ñ€Ğ°Ğ²Ğ° Ğ¼ĞµĞ½ĞµĞ´Ğ¶ĞµÑ€Ğ°</li>
                            <li>â€¢ Ğ£Ğ¿Ñ€Ğ°Ğ²Ğ»ĞµĞ½Ğ¸Ğµ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ÑĞ¼Ğ¸</li>
                            <li>â€¢ Ğ˜Ğ·Ğ¼ĞµĞ½ĞµĞ½Ğ¸Ğµ Ñ€Ğ¾Ğ»ĞµĞ¹</li>
                            <li>â€¢ Ğ‘Ğ»Ğ¾ĞºĞ¸Ñ€Ğ¾Ğ²ĞºĞ° Ğ¸ ÑƒĞ´Ğ°Ğ»ĞµĞ½Ğ¸Ğµ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ĞµĞ¹</li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    );
}

```


## <a name="srcpagesadminAllReservationsManagementPagetsx"></a>`src/pages/admin/AllReservationsManagementPage.tsx`

```tsx
// path: src/pages/admin/AllReservationsManagementPage.tsx

// src/pages/admin/AllReservationsManagementPage.tsx

import { useState, useMemo, useEffect } from "react";
import { useLocation, useNavigate } from "react-router-dom";
import AdminNavigation from "@/components/admin/AdminNavigation";
import { useAdminReservations, useBulkDeleteAdminReservations } from "@/hooks/useAdminReservations";
import { Button } from "@/components/ui/button";
import { ClipboardList, Plus, Loader2, ClipboardX } from "lucide-react";
import AllReservationsList from "@/components/admin/AllReservationsList";
import CreateReservationDialog from "@/components/admin/CreateReservationDialog";
import ConvertReservationDialog from "@/components/admin/ConvertReservationDialog";
import type { AdminReservationOut } from "@/types/reservation";
import { useAllEquipment } from "@/hooks/useAllEquipment";
import { useAdminReservationSelectionStore } from "@/store/adminReservationSelectionStore";
import { AdminReservationToolbar } from "@/components/admin/AdminReservationToolbar";
import { ConfirmationDialog } from "@/components/ui/confirmation-dialog";
import OrderToolbar from "@/components/shared/OrderToolbar";
import { useOrderFilterStore } from "@/store/orderFilterStore";

export default function AllReservationsManagementPage() {
    const location = useLocation();
    const navigate = useNavigate();
    const [localHighlightId, setLocalHighlightId] = useState<number | null>(null);

    const [isCreateDialogOpen, setCreateDialogOpen] = useState(false);
    const [conversionTarget, setConversionTarget] = useState<AdminReservationOut | null>(null);
    const [isConfirmingDelete, setConfirmingDelete] = useState(false);

    // ĞŸĞ¾Ğ»ÑƒÑ‡Ğ°ĞµĞ¼ Ğ¿Ğ°Ñ€Ğ°Ğ¼ĞµÑ‚Ñ€Ñ‹ Ñ„Ğ¸Ğ»ÑŒÑ‚Ñ€Ğ°Ñ†Ğ¸Ğ¸ Ğ¸Ğ· ÑÑ‚Ğ¾Ñ€Ğ°
    const { searchQuery, statusFilter, setSearchQuery, setStatusFilter } = useOrderFilterStore();

    // Ğ­Ñ‚Ğ¾Ñ‚ useEffect Ğ¾Ğ±Ñ€Ğ°Ğ±Ğ¾Ñ‚Ğ°ĞµÑ‚ ÑĞ¾ÑÑ‚Ğ¾ÑĞ½Ğ¸Ğµ, Ğ¿ĞµÑ€ĞµĞ´Ğ°Ğ½Ğ½Ğ¾Ğµ Ğ¿Ñ€Ğ¸ Ğ½Ğ°Ğ²Ğ¸Ğ³Ğ°Ñ†Ğ¸Ğ¸
    useEffect(() => {
        const state = location.state as { highlightId?: number; statusFilterOverride?: string } | null;
        if (state?.highlightId) {
            setLocalHighlightId(state.highlightId);
        }
        if (state?.statusFilterOverride) {
            setStatusFilter(state.statusFilterOverride);
            setSearchQuery(""); // Ğ¡Ğ±Ñ€Ğ°ÑÑ‹Ğ²Ğ°ĞµĞ¼ Ğ¿Ğ¾Ğ¸ÑĞº Ğ´Ğ»Ñ Ñ‡Ğ¸ÑÑ‚Ğ¾Ñ‚Ñ‹
        }
    }, [location.state, setStatusFilter, setSearchQuery]);

    // Ğ­Ñ‚Ğ¾Ñ‚ useEffect ÑĞ±Ñ€Ğ¾ÑĞ¸Ñ‚ Ğ¿Ğ¾Ğ´ÑĞ²ĞµÑ‚ĞºÑƒ Ñ‡ĞµÑ€ĞµĞ· 3 ÑĞµĞºÑƒĞ½Ğ´Ñ‹
    useEffect(() => {
        if (localHighlightId) {
            const timer = setTimeout(() => {
                setLocalHighlightId(null);
                // ĞÑ‡Ğ¸Ñ‰Ğ°ĞµĞ¼ location.state, Ñ‡Ñ‚Ğ¾Ğ±Ñ‹ Ğ¿Ğ¾Ğ´ÑĞ²ĞµÑ‚ĞºĞ° Ğ½Ğµ "Ğ·Ğ°Ğ»Ğ¸Ğ¿Ğ°Ğ»Ğ°" Ğ¿Ñ€Ğ¸ Ğ¾Ğ±Ğ½Ğ¾Ğ²Ğ»ĞµĞ½Ğ¸Ğ¸ ÑÑ‚Ñ€Ğ°Ğ½Ğ¸Ñ†Ñ‹
                navigate(location.pathname, { replace: true, state: {} });
            }, 3000);
            return () => clearTimeout(timer);
        }
    }, [localHighlightId, navigate, location.pathname]);

    const {
        data,
        isLoading: isLoadingReservations,
        error,
        fetchNextPage,
        hasNextPage,
        isFetchingNextPage
    } = useAdminReservations({
        search: searchQuery,
        status: statusFilter === "all" ? undefined : statusFilter,
    });

    const { data: allEquipment = [], isLoading: isLoadingEquipment } = useAllEquipment();
    const { selectedIds, clearSelection } = useAdminReservationSelectionStore();
    const bulkDeleteMutation = useBulkDeleteAdminReservations();

    useEffect(() => {
        return () => {
            clearSelection();
        };
    }, []);

    const equipmentMap = useMemo(() => {
        return new Map(allEquipment.map(e => [e.id, e]));
    }, [allEquipment]);

    const allReservations = useMemo(() => {
        const flatList = data?.pages.flatMap(page => page.items) ?? [];
        return Array.from(new Map(flatList.map(item => [item.id, item])).values());
    }, [data]);

    const visibleReservationIds = useMemo(() => allReservations.map(r => r.id), [allReservations]);

    const isLoading = isLoadingReservations || isLoadingEquipment;

    const handleBulkDelete = () => {
        if (selectedIds.length === 0) return;
        setConfirmingDelete(true);
    };

    const confirmBulkDelete = () => {
        bulkDeleteMutation.mutate(selectedIds, {
            onSuccess: () => {
                clearSelection();
                setConfirmingDelete(false);
            },
            onError: () => {
                setConfirmingDelete(false);
            }
        });
    };

    return (
        <div className="max-w-7xl mx-auto px-4 py-6 space-y-6">
            <AdminNavigation />

            <div className="flex items-center gap-3">
                <ClipboardList className="w-8 h-8 text-indigo-600" />
                <div>
                    <h1 className="text-3xl font-bold text-gray-900">
                        Ğ£Ğ¿Ñ€Ğ°Ğ²Ğ»ĞµĞ½Ğ¸Ğµ Ñ€ĞµĞ·ĞµÑ€Ğ²Ğ°Ğ¼Ğ¸
                    </h1>
                    <p className="text-gray-600 mt-1">
                        ĞŸÑ€Ğ¾ÑĞ¼Ğ¾Ñ‚Ñ€, ÑĞ¾Ğ·Ğ´Ğ°Ğ½Ğ¸Ğµ Ğ¸ Ñ€ĞµĞ´Ğ°ĞºÑ‚Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ Ğ²ÑĞµÑ… Ñ€ĞµĞ·ĞµÑ€Ğ²Ğ¾Ğ² Ğ² ÑĞ¸ÑÑ‚ĞµĞ¼Ğµ.
                    </p>
                </div>
            </div>

            <div className="bg-white rounded-lg border shadow-sm p-4 flex flex-col md:flex-row items-center justify-between gap-4">
                <div className="w-full">
                    <OrderToolbar context="admin-reservations" />
                </div>
                <Button onClick={() => setCreateDialogOpen(true)} className="w-full md:w-auto">
                    <Plus className="mr-2 h-4 w-4" />
                    Ğ¡Ğ¾Ğ·Ğ´Ğ°Ñ‚ÑŒ Ñ€ĞµĞ·ĞµÑ€Ğ²
                </Button>
            </div>

            <AdminReservationToolbar
                visibleReservationIds={visibleReservationIds}
                onBulkDelete={handleBulkDelete}
                isDeleting={bulkDeleteMutation.isPending}
            />

            <div className="bg-white rounded-lg border shadow-sm p-4 md:p-6">
                {isLoading && <p className="text-center text-gray-500 py-4">Ğ—Ğ°Ğ³Ñ€ÑƒĞ·ĞºĞ° Ğ´Ğ°Ğ½Ğ½Ñ‹Ñ…...</p>}
                {error && <p className="text-center text-red-600 py-4">ĞÑˆĞ¸Ğ±ĞºĞ° Ğ·Ğ°Ğ³Ñ€ÑƒĞ·ĞºĞ¸ Ğ´Ğ°Ğ½Ğ½Ñ‹Ñ…: {error.message}</p>}

                {!isLoading && !error && allReservations.length === 0 && (
                    <div className="flex flex-col items-center justify-center text-center p-12 space-y-4 bg-gray-50/50 rounded-lg border-2 border-dashed">
                        <ClipboardX className="w-16 h-16 text-gray-400" />
                        <h3 className="text-lg font-semibold text-gray-800">Ğ ĞµĞ·ĞµÑ€Ğ²Ñ‹ Ğ½Ğµ Ğ½Ğ°Ğ¹Ğ´ĞµĞ½Ñ‹</h3>
                        <p className="text-sm text-gray-500">ĞŸĞ¾Ğ¿Ñ€Ğ¾Ğ±ÑƒĞ¹Ñ‚Ğµ Ğ¸Ğ·Ğ¼ĞµĞ½Ğ¸Ñ‚ÑŒ Ñ„Ğ¸Ğ»ÑŒÑ‚Ñ€Ñ‹ Ğ¸Ğ»Ğ¸ ÑĞ¾Ğ·Ğ´Ğ°Ğ¹Ñ‚Ğµ Ğ½Ğ¾Ğ²Ñ‹Ğ¹ Ñ€ĞµĞ·ĞµÑ€Ğ².</p>
                    </div>
                )}

                {!isLoading && !error && allReservations.length > 0 && (
                    <AllReservationsList
                        reservations={allReservations}
                        onConvertToRental={setConversionTarget}
                        equipmentMap={equipmentMap}
                        highlightId={localHighlightId}
                    />
                )}
                {hasNextPage && (
                    <div className="flex justify-center mt-6">
                        <Button
                            variant="outline"
                            onClick={() => fetchNextPage()}
                            disabled={isFetchingNextPage}
                        >
                            {isFetchingNextPage ? (
                                <><Loader2 className="mr-2 h-4 w-4 animate-spin" /> Ğ—Ğ°Ğ³Ñ€ÑƒĞ·ĞºĞ°...</>
                            ) : "Ğ—Ğ°Ğ³Ñ€ÑƒĞ·Ğ¸Ñ‚ÑŒ ĞµÑ‰Ğµ"}
                        </Button>
                    </div>
                )}
            </div>

            <CreateReservationDialog
                isOpen={isCreateDialogOpen}
                onClose={() => setCreateDialogOpen(false)}
            />
            <ConvertReservationDialog
                reservation={conversionTarget}
                open={!!conversionTarget}
                onClose={() => setConversionTarget(null)}
                equipmentMap={equipmentMap}
            />

            <ConfirmationDialog
                open={isConfirmingDelete}
                onOpenChange={setConfirmingDelete}
                title="ĞŸĞ¾Ğ´Ñ‚Ğ²ĞµÑ€Ğ´Ğ¸Ñ‚Ğµ ÑƒĞ´Ğ°Ğ»ĞµĞ½Ğ¸Ğµ"
                description={`Ğ’Ñ‹ ÑƒĞ²ĞµÑ€ĞµĞ½Ñ‹, Ñ‡Ñ‚Ğ¾ Ñ…Ğ¾Ñ‚Ğ¸Ñ‚Ğµ ÑƒĞ´Ğ°Ğ»Ğ¸Ñ‚ÑŒ ${selectedIds.length} Ñ€ĞµĞ·ĞµÑ€Ğ²(Ğ¾Ğ²)? Ğ­Ñ‚Ğ¾ Ğ´ĞµĞ¹ÑÑ‚Ğ²Ğ¸Ğµ Ğ½ĞµĞ»ÑŒĞ·Ñ Ğ¾Ñ‚Ğ¼ĞµĞ½Ğ¸Ñ‚ÑŒ.`}
                confirmText="Ğ”Ğ°, ÑƒĞ´Ğ°Ğ»Ğ¸Ñ‚ÑŒ"
                cancelText="ĞÑ‚Ğ¼ĞµĞ½Ğ°"
                onConfirm={confirmBulkDelete}
                variant="destructive"
            />
        </div>
    );
}

```


## <a name="srcpagesadminAssociationManagementPagetsx"></a>`src/pages/admin/AssociationManagementPage.tsx`

```tsx
// path: src/pages/admin/AssociationManagementPage.tsx

import AdminNavigation from "@/components/admin/AdminNavigation";
import AssociationTable from "@/components/admin/AssociationTable";
import { Tags } from "lucide-react";

export default function AssociationManagementPage() {
    return (
        <div className="max-w-7xl mx-auto px-4 py-6 space-y-6">
            <AdminNavigation />
            <div className="flex items-center gap-3">
                <Tags className="w-8 h-8 text-green-600" />
                <div>
                    <h1 className="text-3xl font-bold text-gray-900">
                        Ğ£Ğ¿Ñ€Ğ°Ğ²Ğ»ĞµĞ½Ğ¸Ğµ Ğ°ÑÑĞ¾Ñ†Ğ¸Ğ°Ñ†Ğ¸ÑĞ¼Ğ¸
                    </h1>
                    <p className="text-gray-600 mt-1">
                        Ğ¡Ğ¾Ğ·Ğ´Ğ°Ğ²Ğ°Ğ¹Ñ‚Ğµ Ğ¸ Ñ€ĞµĞ´Ğ°ĞºÑ‚Ğ¸Ñ€ÑƒĞ¹Ñ‚Ğµ Ğ¿Ğ¾Ğ´Ğ±Ğ¾Ñ€ĞºĞ¸ Ğ¾Ğ±Ğ¾Ñ€ÑƒĞ´Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ Ğ´Ğ»Ñ Ğ±Ñ‹ÑÑ‚Ñ€Ğ¾Ğ³Ğ¾ Ğ´Ğ¾ÑÑ‚ÑƒĞ¿Ğ°.
                    </p>
                </div>
            </div>
            <div className="bg-white rounded-lg border shadow-sm p-6">
                <AssociationTable />
            </div>
        </div>
    );
}



```


## <a name="srcpagesadminDashboardPagetsx"></a>`src/pages/admin/DashboardPage.tsx`

```tsx
// path: src/pages/admin/DashboardPage.tsx

// src/pages/admin/DashboardPage.tsx

import { useCurrentUser } from "@/hooks/useProfile";
import { useDashboardData } from "@/hooks/admin/useDashboardData";
import AdminNavigation from "@/components/admin/AdminNavigation";
import TodayFocusWidget from "@/components/admin/dashboard/TodayFocusWidget";
import KpiCardsWidget from "@/components/admin/dashboard/KpiCardsWidget";
import ActivityFeedWidget from "@/components/admin/dashboard/ActivityFeedWidget";
import PopularEquipmentChart from "@/components/admin/dashboard/PopularEquipmentChart";
import { Card, CardContent } from "@/components/ui/card";
import { Alert, AlertDescription } from "@/components/ui/alert";
import { Skeleton } from "@/components/ui/skeleton";
import { AlertCircle, RefreshCw } from "lucide-react";
import { Button } from "@/components/ui/button";

export default function DashboardPage() {
    const { data: currentUser } = useCurrentUser();
    const { data: dashboardData, isLoading, isError, error, refetch } = useDashboardData();

    const isAdmin = currentUser?.role === "admin";
    const isManager = currentUser?.role === "manager" || isAdmin;

    if (!isManager) {
        return (
            <div className="max-w-7xl mx-auto px-4 py-6">
                <AdminNavigation />
                <div className="flex items-center justify-center min-h-[400px]">
                    <Alert className="max-w-md">
                        <AlertCircle className="h-4 w-4" />
                        <AlertDescription>
                            Ğ”Ğ¾ÑÑ‚ÑƒĞ¿ Ğ¾Ğ³Ñ€Ğ°Ğ½Ğ¸Ñ‡ĞµĞ½. Ğ¢Ñ€ĞµĞ±ÑƒÑÑ‚ÑÑ Ğ¿Ñ€Ğ°Ğ²Ğ° Ğ¼ĞµĞ½ĞµĞ´Ğ¶ĞµÑ€Ğ° Ğ¸Ğ»Ğ¸ Ğ°Ğ´Ğ¼Ğ¸Ğ½Ğ¸ÑÑ‚Ñ€Ğ°Ñ‚Ğ¾Ñ€Ğ°.
                        </AlertDescription>
                    </Alert>
                </div>
            </div>
        );
    }

    if (isError) {
        return (
            <div className="max-w-7xl mx-auto px-4 py-6 space-y-6">
                <AdminNavigation />
                <div className="flex items-center justify-center min-h-[400px]">
                    <Card className="max-w-md">
                        <CardContent className="pt-6">
                            <Alert variant="destructive">
                                <AlertCircle className="h-4 w-4" />
                                <AlertDescription className="mt-2">
                                    <div className="font-medium mb-2">ĞÑˆĞ¸Ğ±ĞºĞ° Ğ·Ğ°Ğ³Ñ€ÑƒĞ·ĞºĞ¸ Ğ´Ğ°Ğ½Ğ½Ñ‹Ñ…</div>
                                    <div className="text-sm text-muted-foreground mb-4">
                                        {error?.message || "ĞĞµ ÑƒĞ´Ğ°Ğ»Ğ¾ÑÑŒ Ğ·Ğ°Ğ³Ñ€ÑƒĞ·Ğ¸Ñ‚ÑŒ Ğ´Ğ°Ğ½Ğ½Ñ‹Ğµ Ğ´Ğ°ÑˆĞ±Ğ¾Ñ€Ğ´Ğ°"}
                                    </div>
                                    <Button 
                                        onClick={() => refetch()} 
                                        variant="outline" 
                                        size="sm"
                                        className="w-full"
                                    >
                                        <RefreshCw className="w-4 h-4 mr-2" />
                                        ĞŸĞ¾Ğ¿Ñ€Ğ¾Ğ±Ğ¾Ğ²Ğ°Ñ‚ÑŒ ÑĞ½Ğ¾Ğ²Ğ°
                                    </Button>
                                </AlertDescription>
                            </Alert>
                        </CardContent>
                    </Card>
                </div>
            </div>
        );
    }

    return (
        <div className="max-w-7xl mx-auto px-4 py-6 space-y-6">
            <AdminNavigation />

            {/* Ğ—Ğ°Ğ³Ğ¾Ğ»Ğ¾Ğ²Ğ¾Ğº */}
            <div className="flex items-center justify-between">
                <div>
                    <h1 className="text-3xl font-bold text-gray-900">
                        ĞŸĞ°Ğ½ĞµĞ»ÑŒ ÑƒĞ¿Ñ€Ğ°Ğ²Ğ»ĞµĞ½Ğ¸Ñ
                    </h1>
                    <p className="text-gray-600 mt-1">
                        Ğ”Ğ¾Ğ±Ñ€Ğ¾ Ğ¿Ğ¾Ğ¶Ğ°Ğ»Ğ¾Ğ²Ğ°Ñ‚ÑŒ, {currentUser?.full_name}!
                    </p>
                </div>
                <div className="flex items-center gap-2">
                    {isLoading && (
                        <div className="flex items-center gap-2 text-sm text-gray-500">
                            <RefreshCw className="w-4 h-4 animate-spin" />
                            ĞĞ±Ğ½Ğ¾Ğ²Ğ»ĞµĞ½Ğ¸Ğµ...
                        </div>
                    )}
                    <Button 
                        onClick={() => refetch()} 
                        variant="outline" 
                        size="sm"
                        disabled={isLoading}
                    >
                        <RefreshCw className={`w-4 h-4 mr-2 ${isLoading ? 'animate-spin' : ''}`} />
                        ĞĞ±Ğ½Ğ¾Ğ²Ğ¸Ñ‚ÑŒ
                    </Button>
                </div>
            </div>

            {/* KPI Cards */}
            {isLoading ? (
                <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                    {Array.from({ length: 8 }).map((_, index) => (
                        <Card key={index}>
                            <CardContent className="p-6">
                                <div className="space-y-2">
                                    <Skeleton className="h-4 w-20" />
                                    <Skeleton className="h-8 w-16" />
                                    <Skeleton className="h-3 w-24" />
                                </div>
                            </CardContent>
                        </Card>
                    ))}
                </div>
            ) : (
                <KpiCardsWidget 
                    data={dashboardData?.kpi || {
                        total_users: 0,
                        active_users: 0,
                        total_equipment: 0,
                        total_reservations: 0,
                        revenue_today: 0,
                        revenue_this_month: 0,
                        occupancy_rate: 0,
                        avg_rental_duration: 0
                    }} 
                    isLoading={false} 
                />
            )}

            {/* ĞÑĞ½Ğ¾Ğ²Ğ½Ğ¾Ğ¹ ĞºĞ¾Ğ½Ñ‚ĞµĞ½Ñ‚ - Ğ°Ğ´Ğ°Ğ¿Ñ‚Ğ¸Ğ²Ğ½Ğ°Ñ ÑĞµÑ‚ĞºĞ° */}
            <div className="grid grid-cols-1 lg:grid-cols-3 gap-6">
                {/* Ğ›ĞµĞ²Ğ°Ñ ĞºĞ¾Ğ»Ğ¾Ğ½ĞºĞ° - Ğ¤Ğ¾ĞºÑƒÑ Ğ½Ğ° ÑĞµĞ³Ğ¾Ğ´Ğ½Ñ */}
                <div className="lg:col-span-1">
                    {isLoading ? (
                        <Card>
                            <CardContent className="p-6">
                                <div className="space-y-4">
                                    <Skeleton className="h-6 w-32" />
                                    {Array.from({ length: 3 }).map((_, index) => (
                                        <div key={index} className="space-y-2">
                                            <Skeleton className="h-4 w-24" />
                                            <Skeleton className="h-16 w-full" />
                                        </div>
                                    ))}
                                </div>
                            </CardContent>
                        </Card>
                    ) : (
                        <TodayFocusWidget 
                            data={{
                                pickups_today: dashboardData?.pickups_today || [],
                                returns_today: dashboardData?.returns_today || [],
                                overdue_rentals: dashboardData?.overdue_rentals || []
                            }} 
                            isLoading={false} 
                        />
                    )}
                </div>

                {/* ĞŸÑ€Ğ°Ğ²Ğ°Ñ ĞºĞ¾Ğ»Ğ¾Ğ½ĞºĞ° - Ğ›ĞµĞ½Ñ‚Ğ° Ğ°ĞºÑ‚Ğ¸Ğ²Ğ½Ğ¾ÑÑ‚Ğ¸ Ğ¸ Ğ³Ñ€Ğ°Ñ„Ğ¸Ğº */}
                <div className="lg:col-span-2 space-y-6">
                    {/* Ğ›ĞµĞ½Ñ‚Ğ° Ğ°ĞºÑ‚Ğ¸Ğ²Ğ½Ğ¾ÑÑ‚Ğ¸ */}
                    <ActivityFeedWidget 
                        data={dashboardData?.recent_activity || []} 
                        isLoading={isLoading} 
                    />

                    {/* Ğ“Ñ€Ğ°Ñ„Ğ¸Ğº Ğ¿Ğ¾Ğ¿ÑƒĞ»ÑÑ€Ğ½Ğ¾Ğ³Ğ¾ Ğ¾Ğ±Ğ¾Ñ€ÑƒĞ´Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ */}
                    <PopularEquipmentChart 
                        data={dashboardData?.popular_equipment || []} 
                        isLoading={isLoading} 
                    />
                </div>
            </div>

            {/* Ğ”Ğ¾Ğ¿Ğ¾Ğ»Ğ½Ğ¸Ñ‚ĞµĞ»ÑŒĞ½Ğ°Ñ Ğ¸Ğ½Ñ„Ğ¾Ñ€Ğ¼Ğ°Ñ†Ğ¸Ñ */}
            {!isLoading && dashboardData && (
                <div className="text-center text-sm text-gray-500 pt-4 border-t">
                    <p>
                        Ğ”Ğ°Ğ½Ğ½Ñ‹Ğµ Ğ¾Ğ±Ğ½Ğ¾Ğ²Ğ»ÑÑÑ‚ÑÑ Ğ°Ğ²Ñ‚Ğ¾Ğ¼Ğ°Ñ‚Ğ¸Ñ‡ĞµÑĞºĞ¸ ĞºĞ°Ğ¶Ğ´Ñ‹Ğµ 2 Ğ¼Ğ¸Ğ½ÑƒÑ‚Ñ‹. 
                        ĞŸĞ¾ÑĞ»ĞµĞ´Ğ½ĞµĞµ Ğ¾Ğ±Ğ½Ğ¾Ğ²Ğ»ĞµĞ½Ğ¸Ğµ: {new Date().toLocaleTimeString('ru-RU')}
                    </p>
                </div>
            )}
        </div>
    );
}


```


## <a name="srcpagesadminHolidayManagementPagetsx"></a>`src/pages/admin/HolidayManagementPage.tsx`

```tsx
// path: src/pages/admin/HolidayManagementPage.tsx

// src/pages/admin/HolidayManagementPage.tsx

import AdminNavigation from "@/components/admin/AdminNavigation";
import HolidayManager from "@/components/admin/HolidayManager"; // Ğ­Ñ‚Ğ¾Ñ‚ ĞºĞ¾Ğ¼Ğ¿Ğ¾Ğ½ĞµĞ½Ñ‚ Ğ¼Ñ‹ ÑĞ¾Ğ·Ğ´Ğ°Ğ´Ğ¸Ğ¼ Ğ´Ğ°Ğ»ĞµĞµ
import { CalendarDays } from "lucide-react";

export default function HolidayManagementPage() {
    return (
        <div className="max-w-7xl mx-auto px-4 py-6 space-y-6">
            <AdminNavigation />
            <div className="flex items-center gap-3">
                <CalendarDays className="w-8 h-8 text-cyan-600" />
                <div>
                    <h1 className="text-3xl font-bold text-gray-900">
                        Ğ£Ğ¿Ñ€Ğ°Ğ²Ğ»ĞµĞ½Ğ¸Ğµ Ğ²Ñ‹Ñ…Ğ¾Ğ´Ğ½Ñ‹Ğ¼Ğ¸ Ğ´Ğ½ÑĞ¼Ğ¸
                    </h1>
                    <p className="text-gray-600 mt-1">
                        ĞĞ°Ğ·Ğ½Ğ°Ñ‡ÑŒÑ‚Ğµ Ğ¿Ñ€Ğ°Ğ·Ğ´Ğ½Ğ¸Ñ‡Ğ½Ñ‹Ğµ Ğ¸ Ğ½ĞµÑ€Ğ°Ğ±Ğ¾Ñ‡Ğ¸Ğµ Ğ´Ğ½Ğ¸, ĞºĞ¾Ñ‚Ğ¾Ñ€Ñ‹Ğµ Ğ½Ğµ Ğ±ÑƒĞ´ÑƒÑ‚ Ñ‚Ğ°Ñ€Ğ¸Ñ„Ğ¸Ñ†Ğ¸Ñ€Ğ¾Ğ²Ğ°Ñ‚ÑŒÑÑ.
                    </p>
                </div>
            </div>
            <div className="bg-white rounded-lg border shadow-sm p-6">
                <HolidayManager />
            </div>
        </div>
    );
}

```


## <a name="srcpagesadminPromoCodeManagementPagetsx"></a>`src/pages/admin/PromoCodeManagementPage.tsx`

```tsx
// path: src/pages/admin/PromoCodeManagementPage.tsx

// src/pages/admin/PromoCodeManagementPage.tsx

import AdminNavigation from "@/components/admin/AdminNavigation";
import { TicketPercent } from "lucide-react";
import PromoCodeTable from "@/components/admin/PromoCodeTable";
import DurationDiscountManager from "@/components/admin/DurationDiscountManager";

export default function PromoCodeManagementPage() {
    return (
        <div className="max-w-7xl mx-auto px-4 py-6 space-y-6">
            <AdminNavigation />

            <div className="flex items-center gap-3">
                <TicketPercent className="w-8 h-8 text-purple-600" />
                <div>
                    <h1 className="text-3xl font-bold text-gray-900">
                        ĞŸÑ€Ğ¾Ğ¼Ğ¾ĞºĞ¾Ğ´Ñ‹ Ğ¸ ÑĞºĞ¸Ğ´ĞºĞ¸
                    </h1>
                    <p className="text-gray-600 mt-1">
                        Ğ¡Ğ¾Ğ·Ğ´Ğ°Ğ½Ğ¸Ğµ, Ñ€ĞµĞ´Ğ°ĞºÑ‚Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ Ğ¸ Ğ¿Ñ€Ğ¾ÑĞ¼Ğ¾Ñ‚Ñ€ Ğ¿Ñ€Ğ¾Ğ¼Ğ¾ĞºĞ¾Ğ´Ğ¾Ğ² Ğ¸ Ğ°Ğ²Ñ‚Ğ¾Ğ¼Ğ°Ñ‚Ğ¸Ñ‡ĞµÑĞºĞ¸Ñ… ÑĞºĞ¸Ğ´Ğ¾Ğº.
                    </p>
                </div>
            </div>

            {/* Ğ‘Ğ»Ğ¾Ğº Ñ Ğ¿Ñ€Ğ¾Ğ¼Ğ¾ĞºĞ¾Ğ´Ğ°Ğ¼Ğ¸ (Ğ¾ÑÑ‚Ğ°ĞµÑ‚ÑÑ Ğ±ĞµĞ· Ğ¸Ğ·Ğ¼ĞµĞ½ĞµĞ½Ğ¸Ğ¹) */}
            <div className="bg-white rounded-lg border shadow-sm p-6">
                <PromoCodeTable />
            </div>

            {/* 2. <-- Ğ”ĞĞ‘ĞĞ’Ğ›Ğ¯Ğ•Ğœ ĞĞĞ’Ğ«Ğ™ Ğ‘Ğ›ĞĞš Ğ”Ğ›Ğ¯ Ğ£ĞŸĞ ĞĞ’Ğ›Ğ•ĞĞ˜Ğ¯ Ğ¡ĞšĞ˜Ğ”ĞšĞĞœĞ˜ */}
            <div className="bg-white rounded-lg border shadow-sm p-6">
                <DurationDiscountManager />
            </div>
        </div>
    );
}

```


## <a name="srcpagesadminRentalManagementPagetsx"></a>`src/pages/admin/RentalManagementPage.tsx`

```tsx
// path: src/pages/admin/RentalManagementPage.tsx

// src/pages/admin/RentalManagementPage.tsx

import { useState, useMemo, useEffect } from "react";
import { useLocation, useNavigate } from "react-router-dom";
import AdminNavigation from "@/components/admin/AdminNavigation";
import { Button } from "@/components/ui/button";
import { Truck, Plus, Loader2 } from "lucide-react";
import { useAdminRentals } from "@/hooks/useAdminRentals";
import AllRentalsList from "@/components/admin/AllRentalsList";
import ReturnRentalDialog from "@/components/admin/ReturnRentalDialog";
import type { AdminRentalOut } from "@/types/rental";
import OrderToolbar from "@/components/shared/OrderToolbar";
import { useOrderFilterStore } from "@/store/orderFilterStore";



export default function RentalManagementPage() {
    const location = useLocation();
    const navigate = useNavigate();
    const [localHighlightId, setLocalHighlightId] = useState<number | null>(null);
    const [returnTarget, setReturnTarget] = useState<AdminRentalOut | null>(null);

    // ĞŸĞ¾Ğ»ÑƒÑ‡Ğ°ĞµĞ¼ Ğ¿Ğ°Ñ€Ğ°Ğ¼ĞµÑ‚Ñ€Ñ‹ Ñ„Ğ¸Ğ»ÑŒÑ‚Ñ€Ğ°Ñ†Ğ¸Ğ¸ Ğ¸Ğ· ÑÑ‚Ğ¾Ñ€Ğ°
    const { searchQuery, statusFilter, setSearchQuery, setStatusFilter } = useOrderFilterStore();

    const {
        data,
        isLoading,
        error,
        fetchNextPage,
        hasNextPage,
        isFetchingNextPage
    } = useAdminRentals({
        search: searchQuery,
        status: statusFilter === "all" ? undefined : (statusFilter as "active" | "overdue" | "completed" | null),
    });

    const allRentals = useMemo(() => data?.pages.flatMap(page => page.items) ?? [], [data]);

    // Ğ­Ñ‚Ğ¾Ñ‚ useEffect Ğ¾Ğ±Ñ€Ğ°Ğ±Ğ¾Ñ‚Ğ°ĞµÑ‚ ÑĞ¾ÑÑ‚Ğ¾ÑĞ½Ğ¸Ğµ, Ğ¿ĞµÑ€ĞµĞ´Ğ°Ğ½Ğ½Ğ¾Ğµ Ğ¿Ñ€Ğ¸ Ğ½Ğ°Ğ²Ğ¸Ğ³Ğ°Ñ†Ğ¸Ğ¸
    useEffect(() => {
        const state = location.state as { highlightId?: number; statusFilterOverride?: string } | null;
        if (state?.highlightId) {
            setLocalHighlightId(state.highlightId);
        }
        if (state?.statusFilterOverride) {
            setStatusFilter(state.statusFilterOverride);
            setSearchQuery(""); // Ğ¡Ğ±Ñ€Ğ°ÑÑ‹Ğ²Ğ°ĞµĞ¼ Ğ¿Ğ¾Ğ¸ÑĞº Ğ´Ğ»Ñ Ñ‡Ğ¸ÑÑ‚Ğ¾Ñ‚Ñ‹
        }
    }, [location.state, setStatusFilter, setSearchQuery]);

    // Ğ­Ñ‚Ğ¾Ñ‚ useEffect ÑĞ±Ñ€Ğ¾ÑĞ¸Ñ‚ Ğ¿Ğ¾Ğ´ÑĞ²ĞµÑ‚ĞºÑƒ Ñ‡ĞµÑ€ĞµĞ· 3 ÑĞµĞºÑƒĞ½Ğ´Ñ‹
    useEffect(() => {
        if (localHighlightId) {
            const timer = setTimeout(() => {
                setLocalHighlightId(null);
                // ĞÑ‡Ğ¸Ñ‰Ğ°ĞµĞ¼ location.state, Ñ‡Ñ‚Ğ¾Ğ±Ñ‹ Ğ¿Ğ¾Ğ´ÑĞ²ĞµÑ‚ĞºĞ° Ğ½Ğµ "Ğ·Ğ°Ğ»Ğ¸Ğ¿Ğ°Ğ»Ğ°" Ğ¿Ñ€Ğ¸ Ğ¾Ğ±Ğ½Ğ¾Ğ²Ğ»ĞµĞ½Ğ¸Ğ¸ ÑÑ‚Ñ€Ğ°Ğ½Ğ¸Ñ†Ñ‹
                navigate(location.pathname, { replace: true, state: {} });
            }, 3000);
            return () => clearTimeout(timer);
        }
    }, [localHighlightId, navigate, location.pathname]);

    return (
        <div className="max-w-7xl mx-auto px-4 py-6 space-y-6">
            <AdminNavigation />

            <div className="flex items-center gap-3">
                <Truck className="w-8 h-8 text-orange-600" />
                <div>
                    <h1 className="text-3xl font-bold text-gray-900">
                        Ğ£Ğ¿Ñ€Ğ°Ğ²Ğ»ĞµĞ½Ğ¸Ğµ ĞÑ€ĞµĞ½Ğ´Ğ°Ğ¼Ğ¸
                    </h1>
                    <p className="text-gray-600 mt-1">
                        ĞŸÑ€Ğ¾ÑĞ¼Ğ¾Ñ‚Ñ€, ÑĞ¾Ğ·Ğ´Ğ°Ğ½Ğ¸Ğµ Ğ¸ Ğ·Ğ°Ğ²ĞµÑ€ÑˆĞµĞ½Ğ¸Ğµ Ñ„Ğ¸Ğ·Ğ¸Ñ‡ĞµÑĞºĞ¾Ğ¹ Ğ²Ñ‹Ğ´Ğ°Ñ‡Ğ¸ Ğ¾Ğ±Ğ¾Ñ€ÑƒĞ´Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ.
                    </p>
                </div>
            </div>

            <div className="bg-white rounded-lg border shadow-sm p-4 flex flex-col md:flex-row items-center justify-between gap-4">
                <div className="w-full">
                    <OrderToolbar context="admin-rentals" />
                </div>
                <Button disabled className="w-full md:w-auto">
                    <Plus className="mr-2 h-4 w-4" />
                    Ğ¡Ğ¾Ğ·Ğ´Ğ°Ñ‚ÑŒ Ğ°Ñ€ĞµĞ½Ğ´Ñƒ
                </Button>
            </div>

            <div className="bg-white rounded-lg border shadow-sm p-4 md:p-6">
                {isLoading && <p className="text-center text-gray-500 py-4">Ğ—Ğ°Ğ³Ñ€ÑƒĞ·ĞºĞ° Ğ°Ñ€ĞµĞ½Ğ´...</p>}
                {error && <p className="text-center text-red-600 py-4">ĞÑˆĞ¸Ğ±ĞºĞ° Ğ·Ğ°Ğ³Ñ€ÑƒĞ·ĞºĞ¸ Ğ´Ğ°Ğ½Ğ½Ñ‹Ñ…: {error.message}</p>}
                {!isLoading && !error && (
                    <AllRentalsList rentals={allRentals} onReturn={setReturnTarget} highlightId={localHighlightId} />
                )}
                {hasNextPage && (
                    <div className="flex justify-center mt-6">
                        <Button
                            variant="outline"
                            onClick={() => fetchNextPage()}
                            disabled={isFetchingNextPage}
                        >
                            {isFetchingNextPage ? (
                                <><Loader2 className="mr-2 h-4 w-4 animate-spin" /> Ğ—Ğ°Ğ³Ñ€ÑƒĞ·ĞºĞ°...</>
                            ) : "Ğ—Ğ°Ğ³Ñ€ÑƒĞ·Ğ¸Ñ‚ÑŒ ĞµÑ‰Ğµ"}
                        </Button>
                    </div>
                )}
            </div>

            <ReturnRentalDialog
                rental={returnTarget}
                open={!!returnTarget}
                onClose={() => setReturnTarget(null)}
            />
        </div>
    );
}

```


## <a name="srcstoreadminReservationSelectionStorets"></a>`src/store/adminReservationSelectionStore.ts`

```typescript
// path: src/store/adminReservationSelectionStore.ts

// src/store/adminReservationSelectionStore.ts

import { create } from 'zustand';

type SelectionState = {
    selectedIds: number[];
    toggleId: (id: number) => void;
    setSelectedIds: (ids: number[]) => void;
    clearSelection: () => void;
};

export const useAdminReservationSelectionStore = create<SelectionState>((set) => ({
    selectedIds: [],
    toggleId: (id) =>
        set((state) => ({
            selectedIds: state.selectedIds.includes(id)
                ? state.selectedIds.filter((selectedId) => selectedId !== id)
                : [...state.selectedIds, id],
        })),
    setSelectedIds: (ids) => set({ selectedIds: ids }),
    clearSelection: () => set({ selectedIds: [] }),
}));

```


## <a name="srcstoreauthStorets"></a>`src/store/authStore.ts`

```typescript
// path: src/store/authStore.ts

// src/store/authStore.ts

import { create } from "zustand"
import { api } from "@/lib/api"
import { queryClient } from "@/lib/queryClient"

// <<< Ğ˜Ğ—ĞœĞ•ĞĞ•ĞĞ˜Ğ•: ĞĞ±Ğ½Ğ¾Ğ²Ğ»ÑĞµĞ¼ Ñ‚Ğ¸Ğ¿ Ğ´Ğ°Ğ½Ğ½Ñ‹Ñ… Ğ´Ğ»Ñ Ñ€ĞµĞ³Ğ¸ÑÑ‚Ñ€Ğ°Ñ†Ğ¸Ğ¸
type RegisterPayload = {
    full_name: string
    email: string
    password: string
    phone?: string
    privacy_policy_accepted: boolean
    terms_accepted: boolean
}

type AuthStore = {
    loading: boolean
    error: string | null
    login: (email: string, password: string) => Promise<void>
    register: (data: RegisterPayload) => Promise<void>
    logout: () => void
}

export const useAuthStore = create<AuthStore>((set) => ({
    loading: false,
    error: null,

    login: async (email, password) => {
        set({ loading: true, error: null })
        try {
            const response = await api.post(
                "/auth/token",
                new URLSearchParams({ username: email, password }),
                {
                    headers: {
                        "Content-Type": "application/x-www-form-urlencoded",
                    },
                }
            )

            const token = response.data.access_token
            localStorage.setItem("access_token", token)

            // âœ… ĞĞ±Ğ½Ğ¾Ğ²Ğ»ÑĞµĞ¼ ĞºÑÑˆ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ñ
            await queryClient.invalidateQueries({ queryKey: ["current_user"] })
        } catch (err: unknown) {
            const error = err as { response?: { data?: { detail?: string } } }
            set({
                error: error?.response?.data?.detail || "ĞÑˆĞ¸Ğ±ĞºĞ° Ğ²Ñ…Ğ¾Ğ´Ğ°",
            })
        } finally {
            set({ loading: false })
        }
    },

    // <<< Ğ˜Ğ—ĞœĞ•ĞĞ•ĞĞ˜Ğ•: ĞĞ±Ğ½Ğ¾Ğ²Ğ»ÑĞµĞ¼ Ñ„ÑƒĞ½ĞºÑ†Ğ¸Ñ register Ğ´Ğ»Ñ Ğ¾Ñ‚Ğ¿Ñ€Ğ°Ğ²ĞºĞ¸ Ğ²ÑĞµÑ… Ğ¿Ğ¾Ğ»ĞµĞ¹
    register: async (data) => {
        set({ loading: true, error: null })
        try {
            await api.post("/auth/register", data) // ĞÑ‚Ğ¿Ñ€Ğ°Ğ²Ğ»ÑĞµĞ¼ Ğ¿Ğ¾Ğ»Ğ½Ñ‹Ğ¹ Ğ¾Ğ±ÑŠĞµĞºÑ‚ `data`

            // ĞĞ²Ñ‚Ğ¾Ğ¼Ğ°Ñ‚Ğ¸Ñ‡ĞµÑĞºĞ¸ Ğ²Ñ…Ğ¾Ğ´Ğ¸Ğ¼ Ğ¿Ğ¾ÑĞ»Ğµ Ñ€ĞµĞ³Ğ¸ÑÑ‚Ñ€Ğ°Ñ†Ğ¸Ğ¸
            const response = await api.post(
                "/auth/token",
                new URLSearchParams({ username: data.email, password: data.password }),
                {
                    headers: {
                        "Content-Type": "application/x-www-form-urlencoded",
                    },
                }
            )

            const token = response.data.access_token
            localStorage.setItem("access_token", token)

            // âœ… ĞĞ±Ğ½Ğ¾Ğ²Ğ»ÑĞµĞ¼ ĞºÑÑˆ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ñ
            await queryClient.invalidateQueries({ queryKey: ["current_user"] })
        } catch (err: unknown) {
            const error = err as { response?: { data?: { detail?: string } } }
            set({
                error: error?.response?.data?.detail || "ĞÑˆĞ¸Ğ±ĞºĞ° Ñ€ĞµĞ³Ğ¸ÑÑ‚Ñ€Ğ°Ñ†Ğ¸Ğ¸",
            })
        } finally {
            set({ loading: false })
        }
    },

    logout: () => {
        localStorage.removeItem("access_token")
        queryClient.invalidateQueries({ queryKey: ["current_user"] })
    },
}))

```


## <a name="srcstorecalendarSelectionStorets"></a>`src/store/calendarSelectionStore.ts`

```typescript
// path: src/store/calendarSelectionStore.ts

// src/store/calendarSelectionStore.ts
import { create } from "zustand";

type CalendarSelectionState = {
    selectedGroupId: string | null;
    setSelectedGroupId: (id: string | null) => void;
};

export const useCalendarSelectionStore = create<CalendarSelectionState>((set) => ({
    selectedGroupId: null,
    setSelectedGroupId: (id) => set({ selectedGroupId: id }),
}));


```


## <a name="srcstoredateStorets"></a>`src/store/dateStore.ts`

```typescript
// path: src/store/dateStore.ts

// src/store/dateStore.ts

import { create } from "zustand";
import { calculateDayCount } from "@/lib/utils";
import { addDays } from "date-fns";
import { DateService } from "@/core/services/DateService";

type DateState = {
    startDate: Date;
    endDate: Date;
    dayCount: number;
    // +++ Ğ”ĞĞ‘ĞĞ’Ğ›Ğ•ĞĞ ĞĞĞ’ĞĞ¯ Ğ¤Ğ£ĞĞšĞ¦Ğ˜Ğ¯ Ğ’ Ğ¢Ğ˜ĞŸ +++
    initializeDates: (holidays: Date[]) => void;
    setRange: (from: Date, to: Date, source?: 'calendar' | 'slider' | 'manual', holidays?: Date[]) => void;
    setStartDate: (date: Date, holidays?: Date[]) => void;
    setEndDate: (date: Date, holidays?: Date[]) => void;
    setDayCount: (days: number, holidays?: Date[]) => void;
    reset: (holidays?: Date[]) => void;
};

// Ğ’ÑĞ¿Ğ¾Ğ¼Ğ¾Ğ³Ğ°Ñ‚ĞµĞ»ÑŒĞ½Ñ‹Ğµ Ñ„ÑƒĞ½ĞºÑ†Ğ¸Ğ¸
function normalizeDate(date: Date): Date {
    const local = new Date(date);
    local.setHours(12, 0, 0, 0); // Ğ£ÑÑ‚Ğ°Ğ½Ğ°Ğ²Ğ»Ğ¸Ğ²Ğ°ĞµĞ¼ Ğ²Ñ€ĞµĞ¼Ñ Ğ½Ğ° Ğ¿Ğ¾Ğ»Ğ´ĞµĞ½ÑŒ Ğ´Ğ»Ñ Ğ¸Ğ·Ğ±ĞµĞ¶Ğ°Ğ½Ğ¸Ñ Ğ¿Ñ€Ğ¾Ğ±Ğ»ĞµĞ¼ Ñ Ñ‡Ğ°ÑĞ¾Ğ²Ñ‹Ğ¼Ğ¸ Ğ¿Ğ¾ÑÑĞ°Ğ¼Ğ¸
    return local;
}

function isValidDate(date: Date): boolean {
    return date instanceof Date && !isNaN(date.getTime());
}

function isValidDateRange(start: Date, end: Date): boolean {
    return isValidDate(start) && isValidDate(end) && start < end;
}

// ĞĞ°Ñ‡Ğ°Ğ»ÑŒĞ½Ñ‹Ğµ Ğ·Ğ½Ğ°Ñ‡ĞµĞ½Ğ¸Ñ Ğ¿Ğ¾ ÑƒĞ¼Ğ¾Ğ»Ñ‡Ğ°Ğ½Ğ¸Ñ
const defaultStart = normalizeDate(new Date());
const defaultEnd = normalizeDate(new Date(new Date().setDate(new Date().getDate() + 1)));

export const useDateStore = create<DateState>((set, get) => ({
    startDate: defaultStart,
    endDate: defaultEnd,
    dayCount: 1,

    // +++ ĞĞĞ§ĞĞ›Ğ: ĞĞĞ’ĞĞ¯ Ğ¤Ğ£ĞĞšĞ¦Ğ˜Ğ¯ Ğ”Ğ›Ğ¯ Ğ˜ĞĞ˜Ğ¦Ğ˜ĞĞ›Ğ˜Ğ—ĞĞ¦Ğ˜Ğ˜ Ğ”ĞĞ¢ +++
    initializeDates: (holidays: Date[]) => {
        const today = normalizeDate(new Date());
        // Ğ¡Ğ´Ğ²Ğ¸Ğ³Ğ°ĞµĞ¼ Ğ´Ğ°Ñ‚Ñƒ Ğ½Ğ°Ñ‡Ğ°Ğ»Ğ°, ĞµÑĞ»Ğ¸ ÑĞµĞ³Ğ¾Ğ´Ğ½Ñ Ğ²Ñ‹Ñ…Ğ¾Ğ´Ğ½Ğ¾Ğ¹
        const initialStartDate = DateService.adjustDateIfHoliday(today, holidays);
        // ĞĞ°Ñ…Ğ¾Ğ´Ğ¸Ğ¼ ÑĞ»ĞµĞ´ÑƒÑÑ‰Ğ¸Ğ¹ Ñ€Ğ°Ğ±Ğ¾Ñ‡Ğ¸Ğ¹ Ğ´ĞµĞ½ÑŒ Ğ¿Ğ¾ÑĞ»Ğµ ÑĞºĞ¾Ñ€Ñ€ĞµĞºÑ‚Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ½Ğ¾Ğ¹ Ğ´Ğ°Ñ‚Ñ‹ Ğ½Ğ°Ñ‡Ğ°Ğ»Ğ°
        const initialEndDate = DateService.findNextWorkingDay(initialStartDate, holidays, 1);

        // Ğ£ÑÑ‚Ğ°Ğ½Ğ°Ğ²Ğ»Ğ¸Ğ²Ğ°ĞµĞ¼ Ğ½Ğ¾Ğ²Ñ‹Ğ¹ Ğ´Ğ¸Ğ°Ğ¿Ğ°Ğ·Ğ¾Ğ½
        get().setRange(initialStartDate, initialEndDate, 'manual', holidays);
    },
    // +++ ĞšĞĞĞ•Ğ¦: ĞĞĞ’ĞĞ¯ Ğ¤Ğ£ĞĞšĞ¦Ğ˜Ğ¯ +++

    setRange: (from, to, source, holidays = []) => {
        const currentState = get();
        const normalizedFrom = normalizeDate(from);
        let normalizedTo = normalizeDate(to);

        if (normalizedFrom.getTime() >= normalizedTo.getTime()) {
            normalizedTo = new Date(normalizedFrom);
            normalizedTo.setDate(normalizedTo.getDate() + 1);
        }

        normalizedTo = DateService.adjustDateIfHoliday(normalizedTo, holidays);

        if (
            normalizedFrom.getTime() === currentState.startDate.getTime() &&
            normalizedTo.getTime() === currentState.endDate.getTime()
        ) {
            return;
        }

        if (!isValidDateRange(normalizedFrom, normalizedTo)) {
            console.error("[dateStore] Invalid date range:", { from, to });
            return;
        }

        const newDayCount = calculateDayCount(normalizedFrom, normalizedTo, holidays);

        set({
            startDate: normalizedFrom,
            endDate: normalizedTo,
            dayCount: newDayCount,
        });
    },

    setStartDate: (date, holidays = []) => {
        if (!isValidDate(date)) return;
        const state = get();
        const normalizedDate = normalizeDate(date);
        if (isValidDateRange(normalizedDate, state.endDate)) {
            get().setRange(normalizedDate, state.endDate, 'manual', holidays);
        } else {
            const newEndDate = new Date(normalizedDate);
            newEndDate.setDate(newEndDate.getDate() + 1);
            get().setRange(normalizedDate, newEndDate, 'manual', holidays);
        }
    },

    setEndDate: (date, holidays = []) => {
        if (!isValidDate(date)) return;
        const state = get();
        const normalizedDate = normalizeDate(date);
        if (isValidDateRange(state.startDate, normalizedDate)) {
            get().setRange(state.startDate, normalizedDate, 'manual', holidays);
        }
    },

    setDayCount: (days, holidays = []) => {
        const state = get();
        const potentialEndDate = addDays(state.startDate, days);
        get().setRange(state.startDate, potentialEndDate, 'slider', holidays);
    },

    reset: (holidays = []) => {
        const newStart = normalizeDate(new Date());
        const newEnd = normalizeDate(new Date());
        newEnd.setDate(newEnd.getDate() + 1);
        get().setRange(newStart, newEnd, 'manual', holidays);
    },
}));

```


## <a name="srcstorefilterStorets"></a>`src/store/filterStore.ts`

```typescript
// path: src/store/filterStore.ts

// src/store/filterStore.ts
import { create } from "zustand"

type FilterState = {
  brand: string
  type: string | null
  associationId: number | null
  availableOnly: boolean
  setBrand: (brand: string) => void
  setType: (type: string | null) => void
  setAssociationId: (id: number | null) => void
  setAvailableOnly: (value: boolean) => void
  reset: () => void
}

export const useFilterStore = create<FilterState>((set) => ({
  brand: "__all__",            // ĞŸĞ¾ ÑƒĞ¼Ğ¾Ğ»Ñ‡Ğ°Ğ½Ğ¸Ñ Ğ¿Ğ¾ĞºĞ°Ğ·Ñ‹Ğ²Ğ°Ñ‚ÑŒ Ğ²ÑĞµ Ğ±Ñ€ĞµĞ½Ğ´Ñ‹
  type: null,                  // <-- ĞŸĞ¾ ÑƒĞ¼Ğ¾Ğ»Ñ‡Ğ°Ğ½Ğ¸Ñ Ğ¿Ğ¾ĞºĞ°Ğ·Ñ‹Ğ²Ğ°Ñ‚ÑŒ Ğ²ÑĞµ Ñ‚Ğ¸Ğ¿Ñ‹
  associationId: null,
  availableOnly: false,
  setBrand: (brand) => set({ brand }),
  setType: (type) => set({ type }),
  setAssociationId: (id) => set({ associationId: id }),
  setAvailableOnly: (value) => set({ availableOnly: value }),
  reset: () => set({
    brand: "__all__",
    type: null,               // <-- Ğ¡Ğ±Ñ€Ğ¾Ñ Ğ´Ğ¾Ğ»Ğ¶ĞµĞ½ Ñ‚Ğ¾Ğ¶Ğµ Ğ´Ğ°Ğ²Ğ°Ñ‚ÑŒ null
    associationId: null,
    availableOnly: false,
  }),
}))


```


## <a name="srcstoreholidayStorets"></a>`src/store/holidayStore.ts`

```typescript
// path: src/store/holidayStore.ts

// src/store/holidayStore.ts

import { create } from 'zustand';
import { api } from '@/lib/api';
import { formatDate } from '@/lib/utils';
import type { Holiday, HolidayListResponse } from '@/types/holiday';

type HolidayState = {
    holidays: Date[];
    isLoading: boolean;
    lastFetchedRange: { start: string; end: string } | null;
    fetchHolidays: (start: Date, end: Date) => Promise<void>;
};

export const useHolidayStore = create<HolidayState>((set, get) => ({
    holidays: [],
    isLoading: false,
    lastFetchedRange: null,

    fetchHolidays: async (start, end) => {
        const formattedStart = formatDate(start);
        const formattedEnd = formatDate(end);
        const currentRange = get().lastFetchedRange;

        if (
            get().holidays.length > 0 &&
            currentRange?.start === formattedStart &&
            currentRange?.end === formattedEnd
        ) {
            return;
        }

        set({ isLoading: true });
        try {
            const response = await api.get<HolidayListResponse>('/holidays/', {
                params: {
                    start_date: formattedStart,
                    end_date: formattedEnd,
                    // Ğ˜Ğ—ĞœĞ•ĞĞ•ĞĞ˜Ğ•: Ğ£ÑÑ‚Ğ°Ğ½Ğ°Ğ²Ğ»Ğ¸Ğ²Ğ°ĞµĞ¼ Ğ»Ğ¸Ğ¼Ğ¸Ñ‚ Ğ² 100, Ñ‡Ñ‚Ğ¾Ğ±Ñ‹ ÑĞ¾Ğ¾Ñ‚Ğ²ĞµÑ‚ÑÑ‚Ğ²Ğ¾Ğ²Ğ°Ñ‚ÑŒ Ğ²Ğ°Ğ»Ğ¸Ğ´Ğ°Ñ†Ğ¸Ğ¸ Ğ±ÑĞºĞµĞ½Ğ´Ğ°
                    limit: 100
                },
            });

            const holidayDates = response.data.items.map((h: Holiday) => new Date(h.date));
            set({
                holidays: holidayDates,
                lastFetchedRange: { start: formattedStart, end: formattedEnd },
            });
        } catch (error) {
            console.error("Failed to fetch holidays:", error);
            set({ holidays: [], lastFetchedRange: null });
        } finally {
            set({ isLoading: false });
        }
    },
}));

```


## <a name="srcstoreorderFilterStorets"></a>`src/store/orderFilterStore.ts`

```typescript
// path: src/store/orderFilterStore.ts

import { create } from "zustand"

export type SortOption =
    | "start_asc"
    | "start_desc"
    | "end_asc"
    | "end_desc"
    | "count_asc"
    | "count_desc"
    | "id_asc"
    | "id_desc"

export type OrderContext = 
    | "user-reservations"
    | "user-rentals"
    | "admin-reservations"
    | "admin-rentals"

type OrderFilterState = {
    searchQuery: string
    statusFilter: string | null
    sortOption: SortOption
    setSearchQuery: (query: string) => void
    setStatusFilter: (filter: string | null) => void
    setSortOption: (option: SortOption) => void
    resetFilters: () => void
}

export const useOrderFilterStore = create<OrderFilterState>()((set) => ({
    searchQuery: "",
    statusFilter: "active",
    sortOption: "id_desc",
    setSearchQuery: (query) => set({ searchQuery: query }),
    setStatusFilter: (filter) => set({ statusFilter: filter }),
    setSortOption: (option) => set({ sortOption: option }),
    resetFilters: () => set({ 
        searchQuery: "", 
        statusFilter: "active", 
        sortOption: "id_desc" 
    }),
}))


```


## <a name="srcstorepromoCodeStorets"></a>`src/store/promoCodeStore.ts`

```typescript
// path: src/store/promoCodeStore.ts

// src/store/promoCodeStore.ts

import { create } from "zustand";
import { toast } from "sonner";

type PromoCodeState = {
    promoCode: string;
    promoCodePercentage: number;
    promoCodeMessage: string;
};

type PromoCodeActions = {
    setPromoCode: (code: string) => void;
    setPromoCodeResult: (percentage: number, message: string) => void;
    removePromoCode: () => void;
    clearPromoCode: () => void; // Ğ”Ğ»Ñ ÑĞ±Ñ€Ğ¾ÑĞ° Ğ±ĞµĞ· ÑƒĞ²ĞµĞ´Ğ¾Ğ¼Ğ»ĞµĞ½Ğ¸Ñ
};

type PromoCodeStore = PromoCodeState & PromoCodeActions;

export const usePromoCodeStore = create<PromoCodeStore>((set) => ({
    // State
    promoCode: "",
    promoCodePercentage: 0,
    promoCodeMessage: "",

    // Actions
    setPromoCode: (code) => set({ promoCode: code, promoCodeMessage: "" }), // Ğ¡Ğ±Ñ€Ğ°ÑÑ‹Ğ²Ğ°ĞµĞ¼ ÑĞ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ğµ Ğ¿Ñ€Ğ¸ Ğ½Ğ¾Ğ²Ğ¾Ğ¼ Ğ²Ğ²Ğ¾Ğ´Ğµ

    setPromoCodeResult: (percentage, message) => set({
        promoCodePercentage: percentage,
        promoCodeMessage: message
    }),

    removePromoCode: () => {
        set({ promoCode: "", promoCodePercentage: 0, promoCodeMessage: "" });
        toast.info("ĞŸÑ€Ğ¾Ğ¼Ğ¾ĞºĞ¾Ğ´ ÑĞ±Ñ€Ğ¾ÑˆĞµĞ½.");
    },

    // "Ğ¢Ğ¸Ñ…Ğ¸Ğ¹" ÑĞ±Ñ€Ğ¾Ñ, Ğ¸ÑĞ¿Ğ¾Ğ»ÑŒĞ·ÑƒĞµĞ¼Ñ‹Ğ¹ Ğ¿Ñ€Ğ¾Ğ³Ñ€Ğ°Ğ¼Ğ¼Ğ½Ğ¾ Ğ¿Ñ€Ğ¸ Ğ·Ğ°ĞºÑ€Ñ‹Ñ‚Ğ¸Ğ¸ Ñ„Ğ¾Ñ€Ğ¼/Ğ´Ğ¸Ğ°Ğ»Ğ¾Ğ³Ğ¾Ğ²
    clearPromoCode: () => set({ promoCode: "", promoCodePercentage: 0, promoCodeMessage: "" }),
}));

```


## <a name="srcstorereserveStorets"></a>`src/store/reserveStore.ts`

```typescript
// path: src/store/reserveStore.ts

// src/store/reserveStore.ts
import { create } from "zustand";
import { subscribeWithSelector } from "zustand/middleware";
import type { Equipment } from "@/types/equipment";

type ReserveState = {
    items: Equipment[];
    reservationId: number | null;
    addToReservationMode: number | null;
    selectedAccessories: Record<number, number[]>;
};

type ReserveActions = {
    toggle: (equipment: Equipment) => void;
    add: (equipment: Equipment) => void;
    // ğŸ‘‡ Ğ”ĞĞ‘ĞĞ’Ğ›Ğ•Ğ ĞĞĞ’Ğ«Ğ™ ĞœĞ•Ğ¢ĞĞ” Ğ’ Ğ¢Ğ˜ĞŸ
    addWithAccessories: (equipment: Equipment, accessoryIds: number[]) => void;
    remove: (equipmentId: number) => void;
    bulkAdd: (equipmentList: Equipment[]) => void;
    clear: () => void;
    clearItemsOnly: () => void;
    isSelected: (equipmentId: number) => boolean;
    setReservationId: (id: number | null) => void;
    setAddToReservationMode: (reservationId: number | null) => void;
    completeAddition: () => Equipment[];
    logState: () => void;
    toggleAccessory: (equipmentId: number, accessoryId: number) => void;
    isAccessorySelected: (equipmentId: number, accessoryId: number) => boolean;
    clearAccessoriesForEquipment: (equipmentId: number) => void;
};

type ReserveStore = ReserveState & ReserveActions;

const isEquipmentSelected = (items: Equipment[], equipmentId: number) =>
    items.some((item) => item.id === equipmentId);

export const useReserveStore = create<ReserveStore>()(
    subscribeWithSelector((set, get) => ({
        items: [],
        reservationId: null,
        addToReservationMode: null,
        selectedAccessories: {},

        toggle: (equipment: Equipment) => {
            const currentItems = get().items;
            const isAlreadySelected = isEquipmentSelected(currentItems, equipment.id);

            if (isAlreadySelected) {
                get().clearAccessoriesForEquipment(equipment.id);
            }

            const newItems = isAlreadySelected
                ? currentItems.filter((item) => item.id !== equipment.id)
                : [...currentItems, equipment];

            set({ items: newItems });
        },

        add: (equipment: Equipment) => {
            const currentItems = get().items;
            if (!isEquipmentSelected(currentItems, equipment.id)) {
                set({ items: [...currentItems, equipment] });
            }
        },

        // ğŸ‘‡ Ğ Ğ•ĞĞ›Ğ˜Ğ—ĞĞ¦Ğ˜Ğ¯ ĞĞĞ’ĞĞ“Ğ ĞœĞ•Ğ¢ĞĞ”Ğ
        addWithAccessories: (equipment, accessoryIds) => {
            set(state => {
                // Ğ”Ğ¾Ğ±Ğ°Ğ²Ğ»ÑĞµĞ¼ Ğ¾ÑĞ½Ğ¾Ğ²Ğ½Ğ¾Ğµ Ğ¾Ğ±Ğ¾Ñ€ÑƒĞ´Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ, ĞµÑĞ»Ğ¸ ĞµĞ³Ğ¾ ĞµÑ‰Ğµ Ğ½ĞµÑ‚
                const items = state.items.some(i => i.id === equipment.id)
                    ? state.items
                    : [...state.items, equipment];

                // Ğ”Ğ¾Ğ±Ğ°Ğ²Ğ»ÑĞµĞ¼ Ğ¸Ğ»Ğ¸ Ğ¾Ğ±Ğ½Ğ¾Ğ²Ğ»ÑĞµĞ¼ Ğ°ĞºÑĞµÑÑÑƒĞ°Ñ€Ñ‹ Ğ´Ğ»Ñ ÑÑ‚Ğ¾Ğ³Ğ¾ Ğ¾Ğ±Ğ¾Ñ€ÑƒĞ´Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ
                const newSelectedAccessories = { ...state.selectedAccessories };
                if (accessoryIds.length > 0) {
                    newSelectedAccessories[equipment.id] = accessoryIds;
                } else {
                    // Ğ•ÑĞ»Ğ¸ Ğ¿ĞµÑ€ĞµĞ´Ğ°Ğ½ Ğ¿ÑƒÑÑ‚Ğ¾Ğ¹ Ğ¼Ğ°ÑÑĞ¸Ğ², ÑƒĞ´Ğ°Ğ»ÑĞµĞ¼ Ğ°ĞºÑĞµÑÑÑƒĞ°Ñ€Ñ‹ Ğ´Ğ»Ñ ÑÑ‚Ğ¾Ğ³Ğ¾ ÑĞ»ĞµĞ¼ĞµĞ½Ñ‚Ğ°
                    delete newSelectedAccessories[equipment.id];
                }

                return { items, selectedAccessories: newSelectedAccessories };
            });
        },

        remove: (equipmentId: number) => {
            get().clearAccessoriesForEquipment(equipmentId);
            set(state => ({
                items: state.items.filter((item) => item.id !== equipmentId)
            }));
        },

        bulkAdd: (equipmentList: Equipment[]) => {
            set(state => {
                const currentIds = new Set(state.items.map(item => item.id));
                const newEquipment = equipmentList.filter(eq => !currentIds.has(eq.id));
                return { items: [...state.items, ...newEquipment] };
            });
        },

        clear: () => {
            set({
                items: [],
                reservationId: null,
                addToReservationMode: null,
                selectedAccessories: {},
            });
        },

        clearItemsOnly: () => {
            set({ items: [], selectedAccessories: {} });
        },

        isSelected: (equipmentId: number) => isEquipmentSelected(get().items, equipmentId),

        setReservationId: (id: number | null) => set({ reservationId: id }),

        setAddToReservationMode: (reservationId: number | null) => set({ addToReservationMode: reservationId }),

        completeAddition: () => {
            const state = get();
            const addedItems = [...state.items];
            set({ items: [], addToReservationMode: null, selectedAccessories: {} });
            return addedItems;
        },

        logState: () => {
            console.log(`[ReserveStore] Current state:`, get());
        },

        toggleAccessory: (equipmentId, accessoryId) => {
            set(state => {
                const currentSelection = state.selectedAccessories[equipmentId] || [];
                const isSelected = currentSelection.includes(accessoryId);
                const newSelection = isSelected
                    ? currentSelection.filter(id => id !== accessoryId)
                    : [...currentSelection, accessoryId];

                const newSelectedAccessories = { ...state.selectedAccessories };

                if (newSelection.length > 0) {
                    newSelectedAccessories[equipmentId] = newSelection;
                } else {
                    delete newSelectedAccessories[equipmentId];
                }

                return { selectedAccessories: newSelectedAccessories };
            });
        },

        isAccessorySelected: (equipmentId, accessoryId) => {
            const selection = get().selectedAccessories[equipmentId];
            return selection ? selection.includes(accessoryId) : false;
        },

        clearAccessoriesForEquipment: (equipmentId) => {
            set(state => {
                if (!state.selectedAccessories[equipmentId]) {
                    return state;
                }
                const newSelections = { ...state.selectedAccessories };
                delete newSelections[equipmentId];
                return { selectedAccessories: newSelections };
            });
        }
    }))
);

// ĞŸĞ¾Ğ´Ğ¿Ğ¸ÑĞºĞ¸ Ğ½Ğ° Ğ¸Ğ·Ğ¼ĞµĞ½ĞµĞ½Ğ¸Ñ Ğ´Ğ»Ñ Ğ¾Ñ‚Ğ»Ğ°Ğ´ĞºĞ¸ (Ğ¾ÑÑ‚Ğ°ÑÑ‚ÑÑ Ğ±ĞµĞ· Ğ¸Ğ·Ğ¼ĞµĞ½ĞµĞ½Ğ¸Ğ¹)
useReserveStore.subscribe(
    (state) => state.items,
    (items, previousItems) => {
        if (items.length !== previousItems.length) {
            console.log(`[ReserveStore] Items changed: ${previousItems.length} -> ${items.length}`);
        }
    }
);

useReserveStore.subscribe(
    (state) => state.reservationId,
    (reservationId, previousReservationId) => {
        if (reservationId !== previousReservationId) {
            console.log(`[ReserveStore] Reservation ID changed: ${previousReservationId} -> ${reservationId}`);
        }
    }
);

useReserveStore.subscribe(
    (state) => state.addToReservationMode,
    (addToReservationMode, previousAddToReservationMode) => {
        if (addToReservationMode !== previousAddToReservationMode) {
            console.log(`[ReserveStore] Add to reservation mode changed: ${previousAddToReservationMode} -> ${addToReservationMode}`);
        }
    }
);

```


## <a name="srcstoresandboxCalculatorStorets"></a>`src/store/sandboxCalculatorStore.ts`

```typescript
// path: src/store/sandboxCalculatorStore.ts

// src/store/sandboxCalculatorStore.ts

import { create } from "zustand";
import { useDateStore } from "./dateStore";
import { useHolidayStore } from "./holidayStore";
import { api } from "@/lib/api";
import type { DurationDiscount, DiscountListResponse } from "@/types/discount";

type SandboxCalculatorState = {
    durationDiscountTiers: DurationDiscount[];
    durationDiscountPercentage: number;
    isLoadingTiers: boolean;
    isCalculatorVisible: boolean;
};

type SandboxCalculatorActions = {
    fetchDiscountTiers: () => Promise<void>;
    setDaysFromCalendar: (days: number) => void;
    setDaysFromSlider: (days: number) => void;
    toggleCalculator: () => void;
    _calculateDurationDiscount: (dayCount: number) => void;
    syncWithDateStore: () => void;
    refreshCalculator: () => void;
};

type SandboxCalculatorStore = SandboxCalculatorState & SandboxCalculatorActions;

export const useSandboxCalculatorStore = create<SandboxCalculatorStore>((set, get) => ({
    durationDiscountTiers: [],
    durationDiscountPercentage: 0,
    isLoadingTiers: false,
    isCalculatorVisible: false,

    _calculateDurationDiscount: (dayCount: number) => {
        const tiers = get().durationDiscountTiers;
        const applicableDiscount = tiers
            .filter(tier => dayCount >= tier.min_days)
            .sort((a, b) => b.min_days - a.min_days)[0];
        set({
            durationDiscountPercentage: applicableDiscount ? applicableDiscount.discount_percentage : 0,
        });
    },

    syncWithDateStore: () => {
        const { dayCount } = useDateStore.getState();
        const { holidays } = useHolidayStore.getState();
        const { _calculateDurationDiscount, isCalculatorVisible, fetchDiscountTiers } = get();

        if (dayCount >= 4 && !isCalculatorVisible) {
            set({ isCalculatorVisible: true });
            void fetchDiscountTiers();
        }

        if (get().durationDiscountTiers.length > 0) {
            _calculateDurationDiscount(dayCount);
        }
    },

    fetchDiscountTiers: async () => {
        if (get().durationDiscountTiers.length > 0 || get().isLoadingTiers) return;
        set({ isLoadingTiers: true });
        try {
            const response = await api.get<DiscountListResponse>("/discounts/");
            set({ durationDiscountTiers: response.data.items, isLoadingTiers: false });
            const { dayCount } = useDateStore.getState();
            get()._calculateDurationDiscount(dayCount);
        } catch (error) {
            console.error("Failed to fetch discount tiers:", error);
            set({ isLoadingTiers: false });
        }
    },

    setDaysFromCalendar: (days: number) => {
        const { isCalculatorVisible, fetchDiscountTiers, _calculateDurationDiscount } = get();

        if (!isCalculatorVisible && days >= 4) {
            void fetchDiscountTiers();
        }
        if (get().durationDiscountTiers.length > 0) {
            _calculateDurationDiscount(days);
        }
        if (days >= 4) {
            set({ isCalculatorVisible: true });
        }
    },

    setDaysFromSlider: (days: number) => {
        const dateStore = useDateStore.getState();
        const { holidays } = useHolidayStore.getState();

        // --- Ğ˜Ğ—ĞœĞ•ĞĞ•ĞĞ˜Ğ• Ğ—Ğ”Ğ•Ğ¡Ğ¬ ---
        // Ğ¢ĞµĞ¿ĞµÑ€ÑŒ ÑÑ‚Ğ° Ñ„ÑƒĞ½ĞºÑ†Ğ¸Ñ Ñ‚Ğ¾Ğ»ÑŒĞºĞ¾ Ğ¿ĞµÑ€ĞµĞ´Ğ°ĞµÑ‚ Ğ´Ğ°Ğ½Ğ½Ñ‹Ğµ Ğ² dateStore
        // Ğ¸ Ğ±Ğ¾Ğ»ÑŒÑˆĞµ Ğ½Ğµ Ğ²Ñ‹Ğ·Ñ‹Ğ²Ğ°ĞµÑ‚ Ñ€Ğ°ÑÑ‡ĞµÑ‚ ÑĞºĞ¸Ğ´ĞºĞ¸ Ğ½Ğ°Ğ¿Ñ€ÑĞ¼ÑƒÑ.
        dateStore.setDayCount(days, holidays);
        // -------------------------

        if (days >= 4) set({ isCalculatorVisible: true });
    },

    toggleCalculator: () => {
        const alreadyVisible = get().isCalculatorVisible;
        if (!alreadyVisible) void get().fetchDiscountTiers();
        set({ isCalculatorVisible: !alreadyVisible });
    },

    refreshCalculator: () => {
        const { dayCount } = useDateStore.getState();
        const { _calculateDurationDiscount } = get();

        if (get().durationDiscountTiers.length > 0 && dayCount > 0) {
            _calculateDurationDiscount(dayCount);
        }
    },
}));

```


## <a name="srcstoresearchStorets"></a>`src/store/searchStore.ts`

```typescript
// path: src/store/searchStore.ts

import { create } from "zustand"

interface SearchState {
  query: string
  setQuery: (value: string) => void
}

export const useSearchStore = create<SearchState>((set) => ({
  query: "",
  setQuery: (value) => set({ query: value })
}))


```


## <a name="srcstoreviewModeStorets"></a>`src/store/viewModeStore.ts`

```typescript
// path: src/store/viewModeStore.ts

// src/store/viewModeStore.ts

import { create } from "zustand";

// Ğ˜ÑĞ¿Ğ¾Ğ»ÑŒĞ·ÑƒĞµĞ¼ 'default' Ğ¸ 'compact' Ğ´Ğ»Ñ ĞµĞ´Ğ¸Ğ½Ğ¾Ğ¾Ğ±Ñ€Ğ°Ğ·Ğ¸Ñ
export type ViewMode = 'default' | 'compact';

type ViewState = {
  viewMode: ViewMode;
  setViewMode: (mode: ViewMode) => void;
};

export const useViewModeStore = create<ViewState>((set) => ({
  viewMode: 'default', // Ğ˜ÑÑ…Ğ¾Ğ´Ğ½Ğ¾Ğµ ÑĞ¾ÑÑ‚Ğ¾ÑĞ½Ğ¸Ğµ
  // Ğ‘Ğ¾Ğ»ĞµĞµ ÑĞ²Ğ½Ñ‹Ğ¹ Ğ¼ĞµÑ‚Ğ¾Ğ´ ÑƒÑÑ‚Ğ°Ğ½Ğ¾Ğ²ĞºĞ¸, ĞºĞ¾Ñ‚Ğ¾Ñ€Ñ‹Ğ¹ Ğ¿Ğ¾Ğ½Ğ°Ğ´Ğ¾Ğ±Ğ¸Ñ‚ÑÑ Ğ´Ğ»Ñ ToggleGroup
  setViewMode: (mode) => set({ viewMode: mode }),
}));

```


## <a name="srctypesaccessoryts"></a>`src/types/accessory.ts`

```typescript
// path: src/types/accessory.ts

// src/types/accessory.ts

export interface Accessory {
    id: number;
    name: string;
    accessory_type: string;
    price: number;
    description?: string;
}

// Ğ”ĞĞ‘ĞĞ’Ğ›Ğ¯Ğ•Ğœ Ğ­Ğ¢ĞĞ¢ Ğ˜ĞĞ¢Ğ•Ğ Ğ¤Ğ•Ğ™Ğ¡
export interface AccessoryListResponse {
    items: Accessory[];
    total: number;
}

```


## <a name="srctypesassociationts"></a>`src/types/association.ts`

```typescript
// path: src/types/association.ts

// src/types/association.ts

export interface Association {
    id: number;
    name: string;
    description?: string;
    sort_order: number;
    equipment_ids: number[];
}

export type AssociationCreate = Omit<Association, 'id'>;
export type AssociationUpdate = Partial<AssociationCreate>;

// Ğ”ĞĞ‘ĞĞ’Ğ¬Ğ¢Ğ• Ğ­Ğ¢ĞĞ¢ Ğ­ĞšĞ¡ĞŸĞĞ Ğ¢
export interface AssociationListResponse {
    items: Association[];
    total: number;
}

```


## <a name="srctypesavailabilityts"></a>`src/types/availability.ts`

```typescript
// path: src/types/availability.ts

// src/types/availability.ts

export type EquipmentStatus = "available" | "reserved" | "rented";

export interface AvailabilityInfo {
  equipment_id: number;
  status: EquipmentStatus;
  start_date?: string | null;
  end_date?: string | null;
  details: string;
}

// Ğ”ĞĞ‘ĞĞ’Ğ¬Ğ¢Ğ• Ğ­Ğ¢ĞĞ¢ Ğ˜ĞĞ¢Ğ•Ğ Ğ¤Ğ•Ğ™Ğ¡
// ĞĞ½ Ğ¾Ğ¿Ğ¸ÑÑ‹Ğ²Ğ°ĞµÑ‚ ÑÑ‚Ñ€ÑƒĞºÑ‚ÑƒÑ€Ñƒ Ğ¾Ñ‚Ğ²ĞµÑ‚Ğ° Ğ¾Ñ‚ /calendar/view
export interface AvailabilityListResponse {
  items: AvailabilityInfo[];
  total: number;
}


export interface ConflictDetail {
  type: 'reservation' | 'rental';
  id: number;
  user_name?: string; // Ğ˜Ğ¼Ñ ĞºĞ»Ğ¸ĞµĞ½Ñ‚Ğ° Ğ² ĞºĞ¾Ğ½Ñ„Ğ»Ğ¸ĞºÑ‚Ğµ
  start_date: string;
  end_date: string;
}

export interface EquipmentConflictInfo {
  equipment_id: number;
  conflicts: ConflictDetail[];
}

export interface DayStatus {
  status: EquipmentStatus;
  group_id: string | null;
  is_user_reservation: boolean;
}

```


## <a name="srctypesbalanceHistoryts"></a>`src/types/balanceHistory.ts`

```typescript
// path: src/types/balanceHistory.ts

// src/types/balanceHistory.ts

export interface BalanceHistoryEntry {
    id: number;
    user_id: number;
    rental_id: number | null;
    amount: number;
    operation_type: string;
    description: string | null;
    created_at: string; // Ğ”Ğ°Ñ‚Ğ° Ğ² Ñ„Ğ¾Ñ€Ğ¼Ğ°Ñ‚Ğµ ISO-ÑÑ‚Ñ€Ğ¾ĞºĞ¸
}

export interface BalanceHistoryListResponse {
    items: BalanceHistoryEntry[];
    total: number;
}

```


## <a name="srctypesdiscountts"></a>`src/types/discount.ts`

```typescript
// path: src/types/discount.ts

// src/types/discount.ts

// Ğ¢Ğ¸Ğ¿ Ğ´Ğ»Ñ ÑĞºĞ¸Ğ´ĞºĞ¸, ĞºĞ°Ğº Ğ¾Ğ½Ğ° Ğ¿Ñ€Ğ¸Ñ…Ğ¾Ğ´Ğ¸Ñ‚ Ğ¾Ñ‚ API
export interface DurationDiscount {
    id: number;
    min_days: number;
    discount_percentage: number;
}

// Ğ¢Ğ¸Ğ¿ Ğ´Ğ»Ñ Ğ´Ğ°Ğ½Ğ½Ñ‹Ñ…, Ğ¾Ñ‚Ğ¿Ñ€Ğ°Ğ²Ğ»ÑĞµĞ¼Ñ‹Ñ… Ğ½Ğ° API Ğ´Ğ»Ñ ÑĞ¾Ğ·Ğ´Ğ°Ğ½Ğ¸Ñ ÑĞºĞ¸Ğ´ĞºĞ¸
export type DiscountPayload = Omit<DurationDiscount, 'id'>;

// Ğ¢Ğ¸Ğ¿ Ğ´Ğ»Ñ Ğ¾Ñ‚Ğ²ĞµÑ‚Ğ° Ğ¾Ñ‚ API ÑĞ¾ ÑĞ¿Ğ¸ÑĞºĞ¾Ğ¼ ÑĞºĞ¸Ğ´Ğ¾Ğº
export interface DiscountListResponse {
    items: DurationDiscount[];
    total: number;
}

```


## <a name="srctypesequipmentts"></a>`src/types/equipment.ts`

```typescript
// path: src/types/equipment.ts

// src/types/equipment.ts

// âœ… Ğ”ĞĞ‘ĞĞ’Ğ›Ğ•Ğ Ğ˜ĞœĞŸĞĞ Ğ¢
import type { Accessory } from "./accessory";

export interface Equipment {
  id: number;
  equipment_type: string;
  brand: string;
  name: string;
  serial_number?: string;
  condition: string;
  daily_rate: number;
  notes?: string;
  description?: string;
  last_maintenance?: string;
  image_url?: string;
  image_urls?: string[];
  short_description?: string;
  // âœ… Ğ”ĞĞ‘ĞĞ’Ğ›Ğ•ĞĞ ĞŸĞĞ›Ğ•
  accessories: Accessory[];
}

```


## <a name="srctypesholidayts"></a>`src/types/holiday.ts`

```typescript
// path: src/types/holiday.ts

// src/types/holiday.ts

// Ğ¢Ğ¸Ğ¿ Ğ´Ğ»Ñ Ğ¾Ğ´Ğ½Ğ¾Ğ³Ğ¾ Ğ²Ñ‹Ñ…Ğ¾Ğ´Ğ½Ğ¾Ğ³Ğ¾ Ğ´Ğ½Ñ, ĞºĞ°Ğº Ğ¾Ğ½ Ğ¿Ñ€Ğ¸Ñ…Ğ¾Ğ´Ğ¸Ñ‚ Ğ¾Ñ‚ API
export interface Holiday {
    date: string; // Ğ¤Ğ¾Ñ€Ğ¼Ğ°Ñ‚ 'YYYY-MM-DD'
    description: string | null;
    created_at: string;
    created_by_id: number;
}

// Ğ¢Ğ¸Ğ¿ Ğ´Ğ»Ñ Ğ¾Ñ‚Ğ²ĞµÑ‚Ğ° API ÑĞ¾ ÑĞ¿Ğ¸ÑĞºĞ¾Ğ¼ Ğ²Ñ‹Ñ…Ğ¾Ğ´Ğ½Ñ‹Ñ…
export interface HolidayListResponse {
    items: Holiday[];
    total: number;
}

```


## <a name="srctypespromo_codets"></a>`src/types/promo_code.ts`

```typescript
// path: src/types/promo_code.ts

// src/types/promo_code.ts

// Ğ¢Ğ¸Ğ¿ Ğ´Ğ»Ñ Ğ´Ğ°Ğ½Ğ½Ñ‹Ñ…, ĞºĞ¾Ñ‚Ğ¾Ñ€Ñ‹Ğµ Ğ¼Ñ‹ Ğ¿Ğ¾Ğ»ÑƒÑ‡Ğ°ĞµĞ¼ Ğ¾Ñ‚ API Ğ¿Ñ€Ğ¸ Ğ·Ğ°Ğ¿Ñ€Ğ¾ÑĞµ ÑĞ¿Ğ¸ÑĞºĞ° Ğ¿Ñ€Ğ¾Ğ¼Ğ¾ĞºĞ¾Ğ´Ğ¾Ğ²
export interface PromoCodeOut {
    id: number;
    code: string;
    description: string | null;
    discount_percentage: number;
    is_active: boolean;
    valid_from: string | null; // Ğ”Ğ°Ñ‚Ñ‹ Ğ¿Ñ€Ğ¸Ñ…Ğ¾Ğ´ÑÑ‚ ĞºĞ°Ğº ÑÑ‚Ñ€Ğ¾ĞºĞ¸ Ğ² Ñ„Ğ¾Ñ€Ğ¼Ğ°Ñ‚Ğµ ISO
    expires_at: string | null;
    max_uses: number | null;
    times_used: number;
    max_uses_per_user: number | null;
    min_order_amount: number | null;
    specific_to_user_id: number | null;
    applicable_to_equipment_ids: number[] | null;
    applicable_to_equipment_types: string[] | null;
    created_at: string;
    created_by_id: number;
    creator_email?: string; // ĞĞ¿Ñ†Ğ¸Ğ¾Ğ½Ğ°Ğ»ÑŒĞ½Ğ¾Ğµ Ğ¿Ğ¾Ğ»Ğµ Ğ´Ğ»Ñ ÑƒĞ´Ğ¾Ğ±ÑÑ‚Ğ²Ğ°
}

// Ğ¢Ğ¸Ğ¿ Ğ´Ğ»Ñ Ğ´Ğ°Ğ½Ğ½Ñ‹Ñ…, ĞºĞ¾Ñ‚Ğ¾Ñ€Ñ‹Ğµ Ğ¼Ñ‹ Ğ¾Ñ‚Ğ¿Ñ€Ğ°Ğ²Ğ»ÑĞµĞ¼ Ğ½Ğ° API Ğ´Ğ»Ñ ÑĞ¾Ğ·Ğ´Ğ°Ğ½Ğ¸Ñ Ğ¿Ñ€Ğ¾Ğ¼Ğ¾ĞºĞ¾Ğ´Ğ°
// ĞŸĞ¾Ğ»Ñ, ĞºĞ¾Ñ‚Ğ¾Ñ€Ñ‹Ğµ Ğ³ĞµĞ½ĞµÑ€Ğ¸Ñ€ÑƒÑÑ‚ÑÑ ÑĞµÑ€Ğ²ĞµÑ€Ğ¾Ğ¼ (id, times_used, created_at Ğ¸ Ñ‚.Ğ´.), Ğ·Ğ´ĞµÑÑŒ Ğ¾Ñ‚ÑÑƒÑ‚ÑÑ‚Ğ²ÑƒÑÑ‚.
export type PromoCodeCreate = Omit<PromoCodeOut, 'id' | 'times_used' | 'created_at' | 'created_by_id' | 'creator_email'>;

// Ğ¢Ğ¸Ğ¿ Ğ´Ğ»Ñ Ğ¾Ğ±Ğ½Ğ¾Ğ²Ğ»ĞµĞ½Ğ¸Ñ. Ğ’ÑĞµ Ğ¿Ğ¾Ğ»Ñ Ğ¾Ğ¿Ñ†Ğ¸Ğ¾Ğ½Ğ°Ğ»ÑŒĞ½Ñ‹, Ñ‚Ğ°Ğº ĞºĞ°Ğº Ğ¼Ñ‹ Ğ¼Ğ¾Ğ¶ĞµĞ¼ Ğ¾Ğ±Ğ½Ğ¾Ğ²Ğ»ÑÑ‚ÑŒ Ğ¸Ñ… Ğ¿Ğ¾ Ğ¾Ğ´Ğ½Ğ¾Ğ¼Ñƒ.
export type PromoCodeUpdate = Partial<PromoCodeCreate>;

// +++ ĞĞĞ§ĞĞ›Ğ Ğ˜Ğ—ĞœĞ•ĞĞ•ĞĞ˜Ğ™: Ğ”Ğ¾Ğ±Ğ°Ğ²ÑŒÑ‚Ğµ ÑÑ‚Ğ¾Ñ‚ Ğ¸Ğ½Ñ‚ĞµÑ€Ñ„ĞµĞ¹Ñ +++
// ĞĞ½ Ğ¾Ğ¿Ğ¸ÑÑ‹Ğ²Ğ°ĞµÑ‚ ÑÑ‚Ñ€ÑƒĞºÑ‚ÑƒÑ€Ñƒ Ğ¾Ñ‚Ğ²ĞµÑ‚Ğ° API Ñ Ğ¿Ğ°Ğ³Ğ¸Ğ½Ğ°Ñ†Ğ¸ĞµĞ¹
export interface PromoCodeListResponse {
    items: PromoCodeOut[];
    total: number;
}
// +++ ĞšĞĞĞ•Ğ¦ Ğ˜Ğ—ĞœĞ•ĞĞ•ĞĞ˜Ğ™ +++

```


## <a name="srctypesrentalts"></a>`src/types/rental.ts`

```typescript
// path: src/types/rental.ts

// src/types/rental.ts

import type { UserOut } from "./user";
import type { Equipment } from "./equipment";
import type { Accessory } from "./accessory";

export interface RentalAccessoryDetail {
    equipment_id: number;
    accessory: Accessory;
}

export interface RentalReturnRequest {
    actual_return_date: string; // Ğ¤Ğ¾Ñ€Ğ¼Ğ°Ñ‚ 'YYYY-MM-DD'
    notes_on_return?: string;
    accessories_returned_confirmation: boolean;
}

export interface AdminRentalOut {
    id: number;
    user_id: number;
    created_by_id: number;
    reservation_id: number | null;
    start_date: string;
    end_date: string;
    actual_return_date: string | null;
    status: 'active' | 'overdue' | 'completed';
    total_cost: number;
    discount_amount: number;
    promo_code: string | null;
    final_cost: number | null;
    deposit_amount: number;
    prepayment_amount: number;
    accessories_cost: number;
    remaining_amount: number;
    notes_on_issue: string | null;
    notes_on_return: string | null;
    created_at: string;
    updated_at: string;
    user: UserOut;
    created_by: UserOut;
    equipment: Equipment[];
    // --- Ğ˜Ğ—ĞœĞ•ĞĞ•ĞĞ˜Ğ• Ğ—Ğ”Ğ•Ğ¡Ğ¬ ---
    accessory_links: RentalAccessoryDetail[];
    // -------------------------
    days_remaining: number | null;
    overdue_days: number | null;
    overdue_surcharge: number | null;
}

export interface AdminRentalListResponse {
    items: AdminRentalOut[];
    total: number;
}

```


## <a name="srctypesreservationts"></a>`src/types/reservation.ts`

```typescript
// path: src/types/reservation.ts

// src/types/reservation.ts

import type { UserOut } from "./user";
import type { Accessory } from "./accessory";

export interface AccessoryLink {
    equipment_id: number;
    accessory: Accessory;
}

export interface Reservation {
    id: number;
    equipment_ids: number[];
    start_date: string;
    end_date: string;
    status: 'active' | 'fulfilled' | 'cancelled' | 'overdue';
    total_cost?: number;
    discount_amount?: number;
    promo_code?: string | null;
    selected_accessories?: Record<number, number[]>;
    accessory_links?: AccessoryLink[];
    rental_id?: number | null;
}

export interface ReservationWithNames extends Reservation {
    equipment_names: string[];
}

export interface ReservationListResponse {
    items: Reservation[];
    total: number;
}

/* // Ğ—Ğ°ĞºĞ¾Ğ¼Ğ¼ĞµĞ½Ñ‚Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ½Ñ‹Ğ¹ Ğ¸Ğ½Ñ‚ĞµÑ€Ñ„ĞµĞ¹Ñ
export interface ReservationItem {
    id: number;
    user_id: number;
    equipment_ids: number[];
    start_date: string;
    end_date: string;
    status: 'active' | 'fulfilled' | 'cancelled' | 'overdue';
    selected_accessories?: Record<number, number[]>;
    total_cost?: number;
    discount_amount?: number;
    promo_code?: string | null;
    rental_id?: number | null;
}
*/

export interface AdminReservationOut {
    id: number;
    user_id: number;
    equipment_ids: number[];
    start_date: string;
    end_date: string;
    status: 'active' | 'fulfilled' | 'cancelled' | 'overdue';
    selected_accessories?: Record<number, number[]>;
    accessory_links?: AccessoryLink[];
    user_info: UserOut;
    total_cost?: number;
    discount_amount?: number;
    promo_code?: string | null;
    rental_id?: number | null;
}

export interface AdminReservationListResponse {
    items: AdminReservationOut[];
    total: number;
}

```


## <a name="srctypesuserts"></a>`src/types/user.ts`

```typescript
// path: src/types/user.ts

// src/types/user.ts

import { z } from "zod";
import { USER_ROLE_VALUES, type UserRole as UserRoleType } from "@/constants/userConstants";

export type UserRole = UserRoleType;

// Ğ¡Ñ…ĞµĞ¼Ğ° Ğ´Ğ»Ñ Ğ²Ğ°Ğ»Ğ¸Ğ´Ğ°Ñ†Ğ¸Ğ¸ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ñ
export const userOutSchema = z.object({
    id: z.number(),
    full_name: z.string(),
    email: z.string().email(),
    role: z.enum(USER_ROLE_VALUES),
    is_active: z.boolean().nullable().transform((val) => val ?? false),
    phone: z.string().nullable().optional(),
    status: z.string().nullable().optional(),
    balance: z.number().optional(),
    notes: z.string().nullable().optional(),
    privacy_policy_accepted: z.boolean(),
    terms_accepted: z.boolean(),
    email_verified: z.boolean(),
    created_at: z.string().datetime(),
});

// Ğ¢Ğ¸Ğ¿, ĞºĞ¾Ñ‚Ğ¾Ñ€Ñ‹Ğ¹ Ğ¿Ğ¾Ğ»ÑƒÑ‡Ğ°ĞµÑ‚ÑÑ Ğ¸Ğ· ÑÑ…ĞµĞ¼Ñ‹
export type UserOut = z.infer<typeof userOutSchema>;

// +++ Ğ”ĞĞ‘ĞĞ’Ğ¬Ğ¢Ğ• Ğ­Ğ¢ĞĞ¢ Ğ˜ĞĞ¢Ğ•Ğ Ğ¤Ğ•Ğ™Ğ¡ +++
// ĞĞ½ Ğ¾Ğ¿Ğ¸ÑÑ‹Ğ²Ğ°ĞµÑ‚ ÑÑ‚Ñ€ÑƒĞºÑ‚ÑƒÑ€Ñƒ Ğ¾Ñ‚Ğ²ĞµÑ‚Ğ° Ğ¾Ñ‚ /user/admin/users
export interface UserListResponse {
    items: UserOut[];
    total: number;
}

// +++ ĞĞĞ§ĞĞ›Ğ: Ğ¢Ğ¸Ğ¿ Ğ´Ğ»Ñ Ğ·Ğ°Ğ¿Ñ€Ğ¾ÑĞ° Ğ½Ğ° Ğ¿Ğ¾Ğ¿Ğ¾Ğ»Ğ½ĞµĞ½Ğ¸Ğµ Ğ±Ğ°Ğ»Ğ°Ğ½ÑĞ° +++
export interface UserPaymentRequest {
    amount: number;
    payment_method: string;
    description?: string;
}
// +++ ĞšĞĞĞ•Ğ¦: Ğ¢Ğ¸Ğ¿ Ğ´Ğ»Ñ Ğ·Ğ°Ğ¿Ñ€Ğ¾ÑĞ° +++

```


## <a name="srcutilsphoneUtilsts"></a>`src/utils/phoneUtils.ts`

```typescript
// path: src/utils/phoneUtils.ts

// src/utils/phoneUtils.ts

/**
 * Ğ£Ñ‚Ğ¸Ğ»Ğ¸Ñ‚Ñ‹ Ğ´Ğ»Ñ Ñ€Ğ°Ğ±Ğ¾Ñ‚Ñ‹ Ñ Ñ‚ĞµĞ»ĞµÑ„Ğ¾Ğ½Ğ½Ñ‹Ğ¼Ğ¸ Ğ½Ğ¾Ğ¼ĞµÑ€Ğ°Ğ¼Ğ¸
 */

// Ğ ĞµĞ³ÑƒĞ»ÑÑ€Ğ½Ñ‹Ğµ Ğ²Ñ‹Ñ€Ğ°Ğ¶ĞµĞ½Ğ¸Ñ Ğ´Ğ»Ñ Ğ²Ğ°Ğ»Ğ¸Ğ´Ğ°Ñ†Ğ¸Ğ¸ Ñ€Ğ°Ğ·Ğ»Ğ¸Ñ‡Ğ½Ñ‹Ñ… Ñ„Ğ¾Ñ€Ğ¼Ğ°Ñ‚Ğ¾Ğ² Ñ‚ĞµĞ»ĞµÑ„Ğ¾Ğ½Ğ¾Ğ²
export const PHONE_PATTERNS = {
    // Ğ Ğ¾ÑÑĞ¸Ğ¹ÑĞºĞ¸Ğ¹ Ñ„Ğ¾Ñ€Ğ¼Ğ°Ñ‚: +7 (XXX) XXX-XX-XX
    RUSSIAN: /^\+7\s?\(?(\d{3})\)?\s?(\d{3})-?(\d{2})-?(\d{2})$/,
    // ĞœĞµĞ¶Ğ´ÑƒĞ½Ğ°Ñ€Ğ¾Ğ´Ğ½Ñ‹Ğ¹ Ñ„Ğ¾Ñ€Ğ¼Ğ°Ñ‚: +X (XXX) XXX-XXXX
    INTERNATIONAL: /^\+\d{1,3}\s?\(?(\d{3})\)?\s?(\d{3})-?(\d{4})$/,
    // ĞŸÑ€Ğ¾ÑÑ‚Ğ¾Ğ¹ Ñ„Ğ¾Ñ€Ğ¼Ğ°Ñ‚: Ñ‚Ğ¾Ğ»ÑŒĞºĞ¾ Ñ†Ğ¸Ñ„Ñ€Ñ‹
    DIGITS_ONLY: /^\+?[\d\s\-\(\)]+$/,
} as const;

/**
 * Ğ’Ğ°Ğ»Ğ¸Ğ´Ğ¸Ñ€ÑƒĞµÑ‚ Ñ€Ğ¾ÑÑĞ¸Ğ¹ÑĞºĞ¸Ğ¹ Ğ½Ğ¾Ğ¼ĞµÑ€ Ñ‚ĞµĞ»ĞµÑ„Ğ¾Ğ½Ğ°
 */
export function validateRussianPhone(phone: string): boolean {
    if (!phone) return false;

    // Ğ£Ğ´Ğ°Ğ»ÑĞµĞ¼ Ğ²ÑÑ‘, Ñ‡Ñ‚Ğ¾ Ğ½Ğµ ÑĞ²Ğ»ÑĞµÑ‚ÑÑ Ñ†Ğ¸Ñ„Ñ€Ğ¾Ğ¹
    const cleanPhone = phone.replace(/[^\d]/g, '');

    // ĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑĞµĞ¼, Ñ‡Ñ‚Ğ¾ Ğ½Ğ¾Ğ¼ĞµÑ€ Ğ½Ğ°Ñ‡Ğ¸Ğ½Ğ°ĞµÑ‚ÑÑ Ñ 7 Ğ¸Ğ»Ğ¸ 8 Ğ¸ Ğ¸Ğ¼ĞµĞµÑ‚ 11 Ñ†Ğ¸Ñ„Ñ€
    if (!/^[78]\d{10}$/.test(cleanPhone)) {
        return false;
    }

    return true;
}

/**
 * Ğ’Ğ°Ğ»Ğ¸Ğ´Ğ¸Ñ€ÑƒĞµÑ‚ Ğ¼ĞµĞ¶Ğ´ÑƒĞ½Ğ°Ñ€Ğ¾Ğ´Ğ½Ñ‹Ğ¹ Ğ½Ğ¾Ğ¼ĞµÑ€ Ñ‚ĞµĞ»ĞµÑ„Ğ¾Ğ½Ğ°
 */
export function validateInternationalPhone(phone: string): boolean {
    if (!phone) return false;
    
    // Ğ£Ğ±Ğ¸Ñ€Ğ°ĞµĞ¼ Ğ²ÑĞµ Ğ¿Ñ€Ğ¾Ğ±ĞµĞ»Ñ‹ Ğ¸ Ğ´ĞµÑ„Ğ¸ÑÑ‹ Ğ´Ğ»Ñ Ğ¿Ñ€Ğ¾Ğ²ĞµÑ€ĞºĞ¸
    const cleanPhone = phone.replace(/[\s\-\(\)]/g, '');
    
    // ĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑĞµĞ¼, Ñ‡Ñ‚Ğ¾ Ğ½Ğ¾Ğ¼ĞµÑ€ Ğ½Ğ°Ñ‡Ğ¸Ğ½Ğ°ĞµÑ‚ÑÑ Ñ + Ğ¸ Ğ¸Ğ¼ĞµĞµÑ‚ Ğ¾Ñ‚ 7 Ğ´Ğ¾ 15 Ñ†Ğ¸Ñ„Ñ€
    if (!/^\+\d{7,15}$/.test(cleanPhone)) {
        return false;
    }
    
    return true;
}

/**
 * ĞĞ¾Ñ€Ğ¼Ğ°Ğ»Ğ¸Ğ·ÑƒĞµÑ‚ Ğ½Ğ¾Ğ¼ĞµÑ€ Ñ‚ĞµĞ»ĞµÑ„Ğ¾Ğ½Ğ° Ğº ÑÑ‚Ğ°Ğ½Ğ´Ğ°Ñ€Ñ‚Ğ½Ğ¾Ğ¼Ñƒ Ñ„Ğ¾Ñ€Ğ¼Ğ°Ñ‚Ñƒ
 */
export function normalizePhone(phone: string, format: 'russian' | 'international' = 'russian'): string {
    if (!phone) return '';
    
    // Ğ£Ğ±Ğ¸Ñ€Ğ°ĞµĞ¼ Ğ²ÑĞµ ÑĞ¸Ğ¼Ğ²Ğ¾Ğ»Ñ‹ ĞºÑ€Ğ¾Ğ¼Ğµ Ñ†Ğ¸Ñ„Ñ€ Ğ¸ +
    const cleanPhone = phone.replace(/[^\d+]/g, '');
    
    if (format === 'russian') {
        // Ğ”Ğ»Ñ Ñ€Ğ¾ÑÑĞ¸Ğ¹ÑĞºĞ¸Ñ… Ğ½Ğ¾Ğ¼ĞµÑ€Ğ¾Ğ²
        if (cleanPhone.startsWith('8')) {
            return cleanPhone.replace(/^8/, '+7');
        }
        if (cleanPhone.startsWith('7')) {
            return '+' + cleanPhone;
        }
        if (cleanPhone.startsWith('+7')) {
            return cleanPhone;
        }
        // Ğ•ÑĞ»Ğ¸ Ğ½Ğ¾Ğ¼ĞµÑ€ Ğ½Ğ°Ñ‡Ğ¸Ğ½Ğ°ĞµÑ‚ÑÑ Ñ 9, Ğ´Ğ¾Ğ±Ğ°Ğ²Ğ»ÑĞµĞ¼ +7
        if (cleanPhone.startsWith('9') && cleanPhone.length === 10) {
            return '+7' + cleanPhone;
        }
    }
    
    return cleanPhone;
}

/**
 * Ğ¤Ğ¾Ñ€Ğ¼Ğ°Ñ‚Ğ¸Ñ€ÑƒĞµÑ‚ Ğ½Ğ¾Ğ¼ĞµÑ€ Ñ‚ĞµĞ»ĞµÑ„Ğ¾Ğ½Ğ° Ğ´Ğ»Ñ Ğ¾Ñ‚Ğ¾Ğ±Ñ€Ğ°Ğ¶ĞµĞ½Ğ¸Ñ
 */
export function formatPhone(phone: string, format: 'russian' | 'international' = 'russian'): string {
    if (!phone) return '';
    
    const normalized = normalizePhone(phone, format);
    
    if (format === 'russian') {
        // Ğ¤Ğ¾Ñ€Ğ¼Ğ°Ñ‚: +7 (XXX) XXX-XX-XX
        const match = normalized.match(/^\+7(\d{3})(\d{3})(\d{2})(\d{2})$/);
        if (match) {
            return `+7 (${match[1]}) ${match[2]}-${match[3]}-${match[4]}`;
        }
    } else {
        // Ğ¤Ğ¾Ñ€Ğ¼Ğ°Ñ‚: +X (XXX) XXX-XXXX
        const match = normalized.match(/^\+(\d{1,3})(\d{3})(\d{3})(\d{4})$/);
        if (match) {
            return `+${match[1]} (${match[2]}) ${match[3]}-${match[4]}`;
        }
    }
    
    return normalized;
}

/**
 * Ğ˜Ğ·Ğ²Ğ»ĞµĞºĞ°ĞµÑ‚ Ñ‚Ğ¾Ğ»ÑŒĞºĞ¾ Ñ†Ğ¸Ñ„Ñ€Ñ‹ Ğ¸Ğ· Ğ½Ğ¾Ğ¼ĞµÑ€Ğ° Ñ‚ĞµĞ»ĞµÑ„Ğ¾Ğ½Ğ°
 */
export function extractDigits(phone: string): string {
    if (!phone) return '';
    return phone.replace(/\D/g, '');
}

/**
 * ĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑĞµÑ‚, ÑĞ²Ğ»ÑĞµÑ‚ÑÑ Ğ»Ğ¸ Ğ½Ğ¾Ğ¼ĞµÑ€ Ñ‚ĞµĞ»ĞµÑ„Ğ¾Ğ½Ğ° Ğ¿Ğ¾Ğ»Ğ½Ñ‹Ğ¼
 */
export function isPhoneComplete(phone: string, format: 'russian' | 'international' = 'russian'): boolean {
    if (!phone) return false;
    
    const digits = extractDigits(phone);
    
    if (format === 'russian') {
        // Ğ Ğ¾ÑÑĞ¸Ğ¹ÑĞºĞ¸Ğ¹ Ğ½Ğ¾Ğ¼ĞµÑ€ Ğ´Ğ¾Ğ»Ğ¶ĞµĞ½ Ğ¸Ğ¼ĞµÑ‚ÑŒ 11 Ñ†Ğ¸Ñ„Ñ€ (Ñ ĞºĞ¾Ğ´Ğ¾Ğ¼ ÑÑ‚Ñ€Ğ°Ğ½Ñ‹)
        return digits.length === 11 && digits.startsWith('7');
    } else {
        // ĞœĞµĞ¶Ğ´ÑƒĞ½Ğ°Ñ€Ğ¾Ğ´Ğ½Ñ‹Ğ¹ Ğ½Ğ¾Ğ¼ĞµÑ€ Ğ´Ğ¾Ğ»Ğ¶ĞµĞ½ Ğ¸Ğ¼ĞµÑ‚ÑŒ Ğ¾Ñ‚ 7 Ğ´Ğ¾ 15 Ñ†Ğ¸Ñ„Ñ€
        return digits.length >= 7 && digits.length <= 15;
    }
}

/**
 * ĞŸĞ¾Ğ»ÑƒÑ‡Ğ°ĞµÑ‚ ĞºĞ¾Ğ´ ÑÑ‚Ñ€Ğ°Ğ½Ñ‹ Ğ¸Ğ· Ğ½Ğ¾Ğ¼ĞµÑ€Ğ° Ñ‚ĞµĞ»ĞµÑ„Ğ¾Ğ½Ğ°
 */
export function getCountryCode(phone: string): string | null {
    if (!phone) return null;
    
    const normalized = normalizePhone(phone, 'international');
    const match = normalized.match(/^\+(\d{1,3})/);
    
    return match ? match[1] : null;
}

/**
 * ĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑĞµÑ‚, ÑĞ²Ğ»ÑĞµÑ‚ÑÑ Ğ»Ğ¸ Ğ½Ğ¾Ğ¼ĞµÑ€ Ñ€Ğ¾ÑÑĞ¸Ğ¹ÑĞºĞ¸Ğ¼
 */
export function isRussianPhone(phone: string): boolean {
    if (!phone) return false;
    
    const countryCode = getCountryCode(phone);
    return countryCode === '7';
} 

```


## <a name="srcvite-envdts"></a>`src/vite-env.d.ts`

```typescript
// path: src/vite-env.d.ts

/// <reference types="vite/client" />


```


## <a name="tailwindconfigjs"></a>`tailwind.config.js`

```javascript
// path: tailwind.config.js

/** @type {import('tailwindcss').Config} */
export default {
	darkMode: ["class"],
	content: [
		"./index.html",
		"./src/**/*.{js,ts,jsx,tsx,css}",
	],
	theme: {
		extend: {
			borderRadius: {
				lg: 'var(--radius)',
				md: 'calc(var(--radius) - 2px)',
				sm: 'calc(var(--radius) - 4px)'
			},
			colors: {
				background: 'hsl(var(--background))',
				foreground: 'hsl(var(--foreground))',
				card: {
					DEFAULT: 'hsl(var(--card))',
					foreground: 'hsl(var(--card-foreground))'
				},
				popover: {
					DEFAULT: 'hsl(var(--popover))',
					foreground: 'hsl(var(--popover-foreground))'
				},
				primary: {
					DEFAULT: 'hsl(var(--primary))',
					foreground: 'hsl(var(--primary-foreground))'
				},
				secondary: {
					DEFAULT: 'hsl(var(--secondary))',
					foreground: 'hsl(var(--secondary-foreground))'
				},
				muted: {
					DEFAULT: 'hsl(var(--muted))',
					foreground: 'hsl(var(--muted-foreground))'
				},
				accent: {
					DEFAULT: 'hsl(var(--accent))',
					foreground: 'hsl(var(--accent-foreground))'
				},
				destructive: {
					DEFAULT: 'hsl(var(--destructive))',
					foreground: 'hsl(var(--destructive-foreground))'
				},
				border: 'hsl(var(--border))',
				input: 'hsl(var(--input))',
				ring: 'hsl(var(--ring))',
				chart: {
					'1': 'hsl(var(--chart-1))',
					'2': 'hsl(var(--chart-2))',
					'3': 'hsl(var(--chart-3))',
					'4': 'hsl(var(--chart-4))',
					'5': 'hsl(var(--chart-5))'
				}
			}
		}
	},
	plugins: [
		require('tailwindcss-animate'),
		require('@tailwindcss/typography'),
	],
}

```


## <a name="tsconfigappjson"></a>`tsconfig.app.json`

```json
// path: tsconfig.app.json

{
  "compilerOptions": {
    "tsBuildInfoFile": "./node_modules/.tmp/tsconfig.app.tsbuildinfo",
    "target": "ES2020",
    "useDefineForClassFields": true,
    "lib": ["ES2020", "DOM", "DOM.Iterable"],
    "module": "ESNext",
    "skipLibCheck": true,

    /* Bundler mode */
    "moduleResolution": "bundler",
    "allowImportingTsExtensions": true,
    "verbatimModuleSyntax": true,
    "moduleDetection": "force",
    "noEmit": true,
    "jsx": "react-jsx",

    /* Linting */
    "strict": true,
    "noUnusedLocals": true,
    "noUnusedParameters": true,
    "erasableSyntaxOnly": true,
    "noFallthroughCasesInSwitch": true,
    "noUncheckedSideEffectImports": true,

    /* âœ… Ğ”Ğ¾Ğ±Ğ°Ğ²Ğ»ÑĞµĞ¼ Ğ´Ğ»Ñ alias */
    "baseUrl": ".",
    "paths": {
      "@/*": ["src/*"]
    }
  },
  "include": ["src"]
}


```


## <a name="tsconfigjson"></a>`tsconfig.json`

```json
// path: tsconfig.json

{
  "compilerOptions": {
    "target": "ESNext",
    "useDefineForClassFields": true,
    "module": "ESNext",
    "moduleResolution": "bundler",
    "strict": true,
    "jsx": "react-jsx",

    // âœ… Ğ´Ğ¾Ğ±Ğ°Ğ²Ğ»ÑĞµĞ¼
    "baseUrl": ".",
    "paths": {
      "@/*": ["src/*"]
    },
    "allowSyntheticDefaultImports": true
  },
  "include": ["src"]
}


```


## <a name="tsconfignodejson"></a>`tsconfig.node.json`

```json
// path: tsconfig.node.json

{
  "compilerOptions": {
    "tsBuildInfoFile": "./node_modules/.tmp/tsconfig.node.tsbuildinfo",
    "target": "ES2022",
    "lib": ["ES2023"],
    "module": "ESNext",
    "skipLibCheck": true,

    /* Bundler mode */
    "moduleResolution": "bundler",
    "types": ["node"],
    "allowImportingTsExtensions": true,
    "verbatimModuleSyntax": true,
    "moduleDetection": "force",
    "noEmit": true,

    /* Linting */
    "strict": true,
    "noUnusedLocals": true,
    "noUnusedParameters": true,
    "erasableSyntaxOnly": true,
    "noFallthroughCasesInSwitch": true,
    "noUncheckedSideEffectImports": true
  },
  "include": ["vite.config.ts"]
}


```


## <a name="viteconfigts"></a>`vite.config.ts`

```typescript
// path: vite.config.ts

import { defineConfig } from 'vite'
import react from '@vitejs/plugin-react'
import { fileURLToPath, URL } from 'url' // Ğ˜Ğ¼Ğ¿Ğ¾Ñ€Ñ‚Ğ¸Ñ€ÑƒĞµĞ¼ ÑƒÑ‚Ğ¸Ğ»Ğ¸Ñ‚Ñ‹ Ğ´Ğ»Ñ Ñ€Ğ°Ğ±Ğ¾Ñ‚Ñ‹ Ñ Ğ¿ÑƒÑ‚ÑĞ¼Ğ¸

export default defineConfig({
  plugins: [react()],

  server: {
    port: 5173,
    strictPort: true,
  },

  resolve: {
    alias: {
      // Ğ˜ÑĞ¿Ğ¾Ğ»ÑŒĞ·ÑƒĞµĞ¼ ÑĞ¾Ğ²Ñ€ĞµĞ¼ĞµĞ½Ğ½Ñ‹Ğ¹ ÑĞ¿Ğ¾ÑĞ¾Ğ± Ğ´Ğ»Ñ ÑĞ¾Ğ·Ğ´Ğ°Ğ½Ğ¸Ñ alias
      "@": fileURLToPath(new URL('./src', import.meta.url))
    }
  }
})

```


## ğŸ“¦ Ğ—Ğ°Ğ²Ğ¸ÑĞ¸Ğ¼Ğ¾ÑÑ‚Ğ¸ Ğ¿Ñ€Ğ¾ĞµĞºÑ‚Ğ°

- `@fullcalendar/core`: ^6.1.17
- `@fullcalendar/daygrid`: ^6.1.17
- `@fullcalendar/interaction`: ^6.1.17
- `@fullcalendar/react`: ^6.1.17
- `@fullcalendar/resource-timeline`: ^6.1.17
- `@hookform/resolvers`: ^5.0.1
- `@radix-ui/react-checkbox`: ^1.3.1
- `@radix-ui/react-dialog`: ^1.1.14
- `@radix-ui/react-label`: ^2.1.6
- `@radix-ui/react-popover`: ^1.1.14
- `@radix-ui/react-scroll-area`: ^1.2.9
- `@radix-ui/react-select`: ^2.2.4
- `@radix-ui/react-slot`: ^1.2.2
- `@radix-ui/react-switch`: ^1.2.5
- `@radix-ui/react-toggle`: ^1.1.8
- `@radix-ui/react-toggle-group`: ^1.1.9
- `@tanstack/react-query`: ^5.76.1
- `@tanstack/react-query-devtools`: ^5.76.1
- `@types/react-input-mask`: ^3.0.6
- `@uiw/react-md-editor`: ^4.0.7
- `axios`: ^1.9.0
- `class-variance-authority`: ^0.7.1
- `clsx`: ^2.1.1
- `cmdk`: ^1.1.1
- `date-fns`: ^4.1.0
- `lucide-react`: ^0.511.0
- `react`: ^19.1.0
- `react-day-picker`: ^9.7.0
- `react-dom`: ^19.1.0
- `react-error-boundary`: ^6.0.0
- `react-hook-form`: ^7.56.4
- `react-imask`: ^7.6.1
- `react-markdown`: ^10.1.0
- `react-router-dom`: ^7.6.0
- `rehype-sanitize`: ^6.0.0
- `sonner`: ^2.0.3
- `tailwind-merge`: ^3.3.0
- `tailwindcss-animate`: ^1.0.7
- `zod`: ^3.25.28
- `zustand`: ^5.0.4

### Dev-Ğ·Ğ°Ğ²Ğ¸ÑĞ¸Ğ¼Ğ¾ÑÑ‚Ğ¸

- `@eslint/js`: ^9.25.0
- `@tailwindcss/typography`: ^0.5.16
- `@types/mocha`: ^10.0.10
- `@types/node`: ^24.0.10
- `@types/react`: ^19.1.2
- `@types/react-dom`: ^19.1.2
- `@vitejs/plugin-react`: ^4.4.1
- `autoprefixer`: ^10.4.15
- `eslint`: ^9.25.0
- `eslint-plugin-react-hooks`: ^5.2.0
- `eslint-plugin-react-refresh`: ^0.4.19
- `globals`: ^16.0.0
- `postcss`: ^8.4.38
- `tailwindcss`: ^3.4.1
- `typescript`: ~5.8.3
- `typescript-eslint`: ^8.30.1
- `vite`: ^6.3.5


```


## <a name="rentalappmainsplitpy"></a>`rental-app-main/split.py`

```python
// path: rental-app-main/split.py

import os
from pathlib import Path
import fnmatch

# ĞŸĞ°Ğ¿ĞºĞ° Ğ¿Ñ€Ğ¾ĞµĞºÑ‚Ğ°
project_root = Path(__file__).resolve().parent
output_filename = project_root / "smart_react_code.md"

# Ğ§Ñ‚Ğ¾ Ğ²ĞºĞ»ÑÑ‡Ğ°ĞµĞ¼
INCLUDE_DIRS = {"src", 'public'}
INCLUDE_FILES = {"App.tsx", "main.tsx", 'requirements.txt', 'package.json', 'package-lock.json',
                 'tsconfig.json', 'tsconfig.node.json', 'tsconfig.app.json', 'vite.config.json'}
INCLUDE_EXTENSIONS = {".tsx", ".html", ".ts", 'svg', '.css', '.js', '.txt'}

# Ğ§Ñ‚Ğ¾ Ğ¿Ğ¾Ğ»Ğ½Ğ¾ÑÑ‚ÑŒÑ Ğ¸ÑĞºĞ»ÑÑ‡Ğ°ĞµĞ¼ (Ğ¸ Ğ½Ğµ Ğ¾Ñ‚Ğ¾Ğ±Ñ€Ğ°Ğ¶Ğ°ĞµĞ¼ Ğ² ÑÑ‚Ñ€ÑƒĞºÑ‚ÑƒÑ€Ğµ)
EXCLUDE_DIRS = {'.git', '.venv', 'node_modules'}
EXCLUDE_FILES = {'*.pyc', '*.pyo', '*.db', '__init__.py'}

# ĞŸĞ¾Ñ€Ğ¾Ğ³ ÑƒÑĞµÑ‡ĞµĞ½Ğ¸Ñ
MAX_LINES = 350
TRUNCATE_LINES = 50

def is_excluded(file_path: Path) -> bool:
    return any(fnmatch.fnmatch(file_path.name, pattern) for pattern in EXCLUDE_FILES)

def is_included(file_path: Path) -> bool:
    parts = file_path.relative_to(project_root).parts
    return (
            file_path.name in INCLUDE_FILES or
            (parts and parts[0] in INCLUDE_DIRS and file_path.suffix in INCLUDE_EXTENSIONS)
    )

def collect_files():
    included = []
    for root, dirs, files in os.walk(project_root):
        # ÑƒĞ´Ğ°Ğ»ÑĞµĞ¼ ÑĞ¸ÑÑ‚ĞµĞ¼Ğ½Ñ‹Ğµ Ğ¿Ğ°Ğ¿ĞºĞ¸ Ğ½Ğ° Ğ¼ĞµÑÑ‚Ğµ â€” Ğ½Ğµ Ğ¿Ğ¾Ğ¿Ğ°Ğ´ÑƒÑ‚ Ğ´Ğ°Ğ¶Ğµ Ğ² Ğ¾Ğ±Ñ…Ğ¾Ğ´
        dirs[:] = [d for d in dirs if d not in EXCLUDE_DIRS]
        for file in files:
            path = Path(root) / file
            rel_path = path.relative_to(project_root)
            if any(part in EXCLUDE_DIRS for part in rel_path.parts):
                continue
            if is_excluded(path):
                continue
            if is_included(path):
                included.append(path)
    return included

def summarize_structure(included, truncation_map):
    lines = ["# Ğ¡Ñ‚Ñ€ÑƒĞºÑ‚ÑƒÑ€Ğ° Ğ¿Ñ€Ğ¾ĞµĞºÑ‚Ğ°\n"]
    for file in sorted(included, key=lambda x: str(x)):
        rel = file.relative_to(project_root)
        if truncation_map.get(str(rel)):
            lines.append(f"- âš ï¸ `{rel}` (ÑƒÑĞµÑ‡Ñ‘Ğ½)")
        else:
            lines.append(f"- âœ… `{rel}`")
    return "\n".join(lines)

def write_output(included):
    truncation_map = {}
    with open(output_filename, "w", encoding="utf-8") as out:
        out.write("# Ğ¡Ğ¶Ğ°Ñ‚Ñ‹Ğ¹ Ğ¸ÑÑ…Ğ¾Ğ´Ğ½Ñ‹Ğ¹ ĞºĞ¾Ğ´ Ğ¿Ñ€Ğ¾ĞµĞºÑ‚Ğ° Ñ„Ñ€Ğ¾Ğ½Ñ‚ÑĞ½Ğ´Ğ° Ğ´Ğ»Ñ AI-Ğ¿Ğ¾Ğ¼Ğ¾Ñ‰Ğ½Ğ¸ĞºĞ°\n\n")

        code_blocks = []
        for path in sorted(included, key=lambda p: str(p.relative_to(project_root))):
            rel_path = path.relative_to(project_root)
            ext = path.suffix
            block = [f"\n\n## `{rel_path}`\n\n"]
            block.append("```python\n" if ext == ".py" else "```html\n")

            try:
                lines = path.read_text(encoding="utf-8").splitlines()
                if len(lines) > MAX_LINES:
                    truncation_map[str(rel_path)] = True
                    block.extend(lines[:TRUNCATE_LINES])
                    block.append(f"# ... truncated ({len(lines)} lines total)")
                    block.append("# âš ï¸ ĞŸĞ¾Ğ»Ğ½Ñ‹Ğ¹ ĞºĞ¾Ğ´ Ğ´Ğ¾ÑÑ‚ÑƒĞ¿ĞµĞ½ Ğ² Ğ¾Ñ€Ğ¸Ğ³Ğ¸Ğ½Ğ°Ğ»ÑŒĞ½Ğ¾Ğ¼ Ñ„Ğ°Ğ¹Ğ»Ğµ")
                else:
                    block.extend(lines)
            except Exception as e:
                block.append(f"# ĞÑˆĞ¸Ğ±ĞºĞ° Ñ‡Ñ‚ĞµĞ½Ğ¸Ñ Ñ„Ğ°Ğ¹Ğ»Ğ°: {e}")
            block.append("\n```\n")
            code_blocks.append("\n".join(block))

        structure = summarize_structure(included, truncation_map)
        out.write(structure)
        out.write("\n\n---\n")
        out.write("\n".join(code_blocks))

def main():
    included_files = collect_files()
    write_output(included_files)
    print(f"âœ… Ğ¤Ğ°Ğ¹Ğ» '{output_filename.name}' ÑƒÑĞ¿ĞµÑˆĞ½Ğ¾ ÑĞ¾Ğ·Ğ´Ğ°Ğ½.")

if __name__ == "__main__":
    main()


```


## <a name="rentalappmainsplitoptimizedpy"></a>`rental-app-main/split_optimized.py`

```python
// path: rental-app-main/split_optimized.py

import os
import json
import fnmatch
import argparse
from pathlib import Path
from collections import defaultdict

project_root = Path(__file__).resolve().parent
output_filename = project_root / "smart_react_code.md"

INCLUDE_DIRS = {"src", "public"}
INCLUDE_FILES = {
    "App.tsx", "main.tsx", "package.json", "package-lock.json",
    "tsconfig.json", "tsconfig.node.json", "tsconfig.app.json", "vite.config.json", 'tailwind.config.js', 'postcss.config.js', 'vite.config.ts',
    'postcss.config.cjs'
}
INCLUDE_EXTENSIONS = {".tsx", ".html", ".ts", ".svg", ".css", ".js", ".txt"}

EXCLUDE_DIRS = {".git", ".venv", "node_modules", ".idea", ".vscode", "dist", "build"}
EXCLUDE_FILES = {"*.pyc", "*.pyo", "*.db", "__init__.py"}

IMPORTANT_FILES = {
    "App.tsx", "HomePage.tsx", "ReservePage.tsx", "ReserveEditPage.tsx"
}
EXCLUDED_UI_COMPONENTS = {"src/components/ui"}

MAX_LINES = 400
TRUNCATE_LINES = 50


def is_excluded(file_path: Path, include_ui=False) -> bool:
    if not include_ui:
        for excluded_dir in EXCLUDED_UI_COMPONENTS:
            if excluded_dir in str(file_path).replace("\\", "/"):
                return True
    return any(fnmatch.fnmatch(file_path.name, pattern) for pattern in EXCLUDE_FILES)


def is_included(file_path: Path, light=False) -> bool:
    parts = file_path.relative_to(project_root).parts
    if light and not any(part in ["components", "pages", "types"] for part in parts):
        return False
    return (
            file_path.name in INCLUDE_FILES or
            (parts and parts[0] in INCLUDE_DIRS and file_path.suffix in INCLUDE_EXTENSIONS)
    )


def collect_files(light=False, include_ui=False):
    included = []
    for root, dirs, files in os.walk(project_root):
        dirs[:] = [d for d in dirs if d not in EXCLUDE_DIRS]
        for file in files:
            path = Path(root) / file
            rel_path = path.relative_to(project_root)
            if any(part in EXCLUDE_DIRS for part in rel_path.parts):
                continue
            if is_excluded(path, include_ui=include_ui):
                continue
            if is_included(path, light):
                included.append(path)
    return included


def summarize_structure(grouped, truncation_map):
    lines = ["# ğŸ“ Ğ¡Ñ‚Ñ€ÑƒĞºÑ‚ÑƒÑ€Ğ° Ğ¿Ñ€Ğ¾ĞµĞºÑ‚Ğ°"]
    for folder in sorted(grouped):
        lines.append(f"\n### `{folder}`")
        for file in sorted(grouped[folder], key=lambda x: str(x)):
            rel = file.relative_to(project_root)
            icon = "âš ï¸" if truncation_map.get(str(rel)) else "âœ…"
            star = "â­" if rel.name in IMPORTANT_FILES else ""
            lines.append(f"- {star} {icon} `{rel}`")
    return "\n".join(lines)


def write_output(included, light=False, include_ui=False):
    truncation_map = {}
    grouped = defaultdict(list)
    for file in included:
        grouped[str(file.relative_to(project_root).parent)].append(file)

    with open(output_filename, "w", encoding="utf-8") as out:
        out.write("# ğŸ¤– Ğ¡Ğ¶Ğ°Ñ‚Ñ‹Ğ¹ Ğ¸ÑÑ…Ğ¾Ğ´Ğ½Ñ‹Ğ¹ ĞºĞ¾Ğ´ Ñ„Ñ€Ğ¾Ğ½Ñ‚ĞµĞ½Ğ´Ğ° Ğ´Ğ»Ñ AI-Ğ¿Ğ¾Ğ¼Ğ¾Ñ‰Ğ½Ğ¸ĞºĞ°\n\n")

        out.write("## ğŸ”— Ğ‘Ñ‹ÑÑ‚Ñ€Ğ°Ñ Ğ½Ğ°Ğ²Ğ¸Ğ³Ğ°Ñ†Ğ¸Ñ Ğ¿Ğ¾ Ñ„Ğ°Ğ¹Ğ»Ğ°Ğ¼\n")
        for path in sorted(included, key=lambda p: str(p.relative_to(project_root))):
            rel_path = path.relative_to(project_root)
            anchor = str(rel_path).replace("/", "").replace(".", "").replace("\\", "")
            out.write(f"- [{rel_path}](#{anchor})\n")
        out.write("\n---\n\n")

        structure = summarize_structure(grouped, truncation_map)
        out.write(structure)
        out.write("\n\n---\n")

        for path in sorted(included, key=lambda p: str(p.relative_to(project_root))):
            rel_path = path.relative_to(project_root)
            ext = path.suffix
            block = [f"\n\n## `{rel_path}`\n\n"]
            block.append("```python\n" if ext == ".py" else "```html\n")

            try:
                lines = path.read_text(encoding="utf-8").splitlines()
                if len(lines) > MAX_LINES:
                    truncation_map[str(rel_path)] = True
                    block.extend(lines[:TRUNCATE_LINES])
                    block.append(f"# ... truncated ({len(lines)} lines total)")
                    block.append("# âš ï¸ ĞŸĞ¾Ğ»Ğ½Ñ‹Ğ¹ ĞºĞ¾Ğ´ Ğ´Ğ¾ÑÑ‚ÑƒĞ¿ĞµĞ½ Ğ² Ğ¾Ñ€Ğ¸Ğ³Ğ¸Ğ½Ğ°Ğ»ÑŒĞ½Ğ¾Ğ¼ Ñ„Ğ°Ğ¹Ğ»Ğµ")
                else:
                    block.extend(lines)
            except Exception as e:
                block.append(f"# ĞÑˆĞ¸Ğ±ĞºĞ° Ñ‡Ñ‚ĞµĞ½Ğ¸Ñ Ñ„Ğ°Ğ¹Ğ»Ğ°: {e}")
            block.append("\n```\n")
            out.write("\n".join(block))

        pkg_path = project_root / "package.json"
        if pkg_path.exists():
            try:
                deps = json.loads(pkg_path.read_text(encoding="utf-8")).get("dependencies", {})
                out.write("\n\n## ğŸ“¦ Ğ—Ğ°Ğ²Ğ¸ÑĞ¸Ğ¼Ğ¾ÑÑ‚Ğ¸ Ğ¿Ñ€Ğ¾ĞµĞºÑ‚Ğ°\n\n")
                for name, version in sorted(deps.items()):
                    out.write(f"- `{name}`: {version}\n")
            except Exception as e:
                out.write(f"\n\n## ĞÑˆĞ¸Ğ±ĞºĞ° Ñ‡Ñ‚ĞµĞ½Ğ¸Ñ package.json: {e}\n")


def main():
    parser = argparse.ArgumentParser()
    parser.add_argument("--light", action="store_true", help="Ğ¡Ğ¾Ğ±Ñ€Ğ°Ñ‚ÑŒ Ñ‚Ğ¾Ğ»ÑŒĞºĞ¾ ĞºĞ»ÑÑ‡ĞµĞ²Ñ‹Ğµ ĞºĞ¾Ğ¼Ğ¿Ğ¾Ğ½ĞµĞ½Ñ‚Ñ‹ Ğ¸ Ñ‚Ğ¸Ğ¿Ñ‹")
    parser.add_argument("--include-ui", action="store_true", help="Ğ’ĞºĞ»ÑÑ‡Ğ¸Ñ‚ÑŒ ĞºĞ¾Ğ¼Ğ¿Ğ¾Ğ½ĞµĞ½Ñ‚Ñ‹ Ğ¸Ğ· src/components/ui")
    args = parser.parse_args()
    included_files = collect_files(light=args.light, include_ui=args.include_ui)
    write_output(included_files, light=args.light, include_ui=args.include_ui)

    readme_path = project_root / "README_AI.md"
    with open(readme_path, "w", encoding="utf-8") as readme:
        readme.write("# ğŸ“˜ Ğ˜Ğ½ÑÑ‚Ñ€ÑƒĞºÑ†Ğ¸Ñ Ğ´Ğ»Ñ AI-Ğ¿Ğ¾Ğ¼Ğ¾Ñ‰Ğ½Ğ¸ĞºĞ°\n\n")
        readme.write("Ğ­Ñ‚Ğ¾Ñ‚ Ğ¿Ñ€Ğ¾ĞµĞºÑ‚ ÑĞ¾Ğ±Ñ€Ğ°Ğ½ ÑĞºÑ€Ğ¸Ğ¿Ñ‚Ğ¾Ğ¼ `split_optimized.py` Ğ´Ğ»Ñ Ğ°Ğ½Ğ°Ğ»Ğ¸Ğ·Ğ° Ğ˜Ğ˜.\n\n")
        readme.write("## ğŸ“‚ Ğ¡Ğ¾Ğ´ĞµÑ€Ğ¶Ğ¸Ğ¼Ğ¾Ğµ\n")
        readme.write("- `smart_react_code.md` â€” Ğ¾ÑĞ½Ğ¾Ğ²Ğ½Ğ¾Ğ¹ Ñ„Ğ°Ğ¹Ğ» Ñ ĞºĞ¾Ğ´Ğ¾Ğ¼\n")
        readme.write("- `README_AI.md` â€” ÑÑ‚Ğ° Ğ¸Ğ½ÑÑ‚Ñ€ÑƒĞºÑ†Ğ¸Ñ\n\n")
        readme.write("## ğŸš€ ĞšĞ°Ğº Ğ¸ÑĞ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ÑŒ\n")
        readme.write("ĞŸĞµÑ€ĞµĞ´Ğ°Ğ¹ `smart_react_code.md` Ğ² AI-Ğ¿Ğ¾Ğ¼Ğ¾Ñ‰Ğ½Ğ¸Ğº. ĞĞ½ ÑĞ¾Ğ´ĞµÑ€Ğ¶Ğ¸Ñ‚ ÑÑ‚Ñ€ÑƒĞºÑ‚ÑƒÑ€Ñƒ, Ğ¾Ğ³Ğ»Ğ°Ğ²Ğ»ĞµĞ½Ğ¸Ğµ, ĞºĞ»ÑÑ‡ĞµĞ²Ñ‹Ğµ ÑƒÑ‡Ğ°ÑÑ‚ĞºĞ¸ ĞºĞ¾Ğ´Ğ°.\n")
        readme.write("ĞŸĞ¾ ÑƒĞ¼Ğ¾Ğ»Ñ‡Ğ°Ğ½Ğ¸Ñ UI-ĞºĞ¾Ğ¼Ğ¿Ğ¾Ğ½ĞµĞ½Ñ‚Ñ‹ (`src/components/ui`) Ğ¸ÑĞºĞ»ÑÑ‡ĞµĞ½Ñ‹, Ğ²ĞºĞ»ÑÑ‡Ğ¸ Ğ¸Ñ… Ñ„Ğ»Ğ°Ğ³Ğ¾Ğ¼ `--include-ui` Ğ¿Ñ€Ğ¸ Ğ½ĞµĞ¾Ğ±Ñ…Ğ¾Ğ´Ğ¸Ğ¼Ğ¾ÑÑ‚Ğ¸.\n")

    print(f"âœ… Ğ¤Ğ°Ğ¹Ğ» '{output_filename.name}' Ğ¸ README_AI.md ÑƒÑĞ¿ĞµÑˆĞ½Ğ¾ ÑĞ¾Ğ·Ğ´Ğ°Ğ½Ñ‹.")


if __name__ == "__main__":
    main()


```


## <a name="rentalappmainsplitoptimizedgempy"></a>`rental-app-main/split_optimized_gem.py`

```python
// path: rental-app-main/split_optimized_gem.py

import os
import json
import fnmatch
import argparse
from pathlib import Path
from collections import defaultdict

# <<< Ğ˜Ğ—ĞœĞ•ĞĞ•ĞĞ˜Ğ•: ĞŸÑƒÑ‚ÑŒ Ğº Ğ¿Ñ€Ğ¾ĞµĞºÑ‚Ñƒ Ğ¾Ğ¿Ñ€ĞµĞ´ĞµĞ»ÑĞµÑ‚ÑÑ Ğ¾Ñ‚Ğ½Ğ¾ÑĞ¸Ñ‚ĞµĞ»ÑŒĞ½Ğ¾ ÑĞºÑ€Ğ¸Ğ¿Ñ‚Ğ°
project_root = Path(__file__).resolve().parent
output_filename = project_root / "smart_react_code_gem.md"

# --- ĞšĞ¾Ğ½Ñ„Ğ¸Ğ³ÑƒÑ€Ğ°Ñ†Ğ¸Ñ Ğ²ĞºĞ»ÑÑ‡ĞµĞ½Ğ¸Ğ¹ ---
INCLUDE_DIRS = {"src", "public"}
INCLUDE_FILES = {
    "package.json", # package-lock.json ÑƒĞ±Ñ€Ğ°Ğ½
    "tsconfig.json", "tsconfig.node.json", "tsconfig.app.json",
    'tailwind.config.js', 'postcss.config.js', 'vite.config.ts',
}
# <<< Ğ˜Ğ—ĞœĞ•ĞĞ•ĞĞ˜Ğ•: .svg ÑƒĞ±Ñ€Ğ°Ğ½ Ğ¾Ñ‚ÑÑĞ´Ğ°, Ğ±ÑƒĞ´ĞµÑ‚ Ğ¾Ğ±Ñ€Ğ°Ğ±Ğ°Ñ‚Ñ‹Ğ²Ğ°Ñ‚ÑŒÑÑ Ğ¾Ñ‚Ğ´ĞµĞ»ÑŒĞ½Ğ¾
INCLUDE_EXTENSIONS = {".tsx", ".ts", ".css", ".js"}

# <<< Ğ˜Ğ—ĞœĞ•ĞĞ•ĞĞ˜Ğ•: ĞĞ¾Ğ²Ğ°Ñ ĞºĞ¾Ğ½ÑÑ‚Ğ°Ğ½Ñ‚Ğ° Ğ´Ğ»Ñ Ğ»ĞµĞ³ĞºĞ¾Ğ²ĞµÑĞ½Ñ‹Ñ… Ñ„Ğ°Ğ¹Ğ»Ğ¾Ğ², ÑĞ¾Ğ´ĞµÑ€Ğ¶Ğ¸Ğ¼Ğ¾Ğµ ĞºĞ¾Ñ‚Ğ¾Ñ€Ñ‹Ñ… Ğ½Ğµ Ğ½ÑƒĞ¶Ğ½Ğ¾
LIGHTWEIGHT_EXTENSIONS = {".svg"}

# --- ĞšĞ¾Ğ½Ñ„Ğ¸Ğ³ÑƒÑ€Ğ°Ñ†Ğ¸Ñ Ğ¸ÑĞºĞ»ÑÑ‡ĞµĞ½Ğ¸Ğ¹ ---
EXCLUDE_DIRS = {".git", ".venv", "node_modules", ".idea", ".vscode", "dist", "build"}
# <<< Ğ˜Ğ—ĞœĞ•ĞĞ•ĞĞ˜Ğ•: Ğ”Ğ¾Ğ±Ğ°Ğ²Ğ»ĞµĞ½ package-lock.json Ğ² Ğ¸ÑĞºĞ»ÑÑ‡ĞµĞ½Ğ¸Ñ
EXCLUDE_FILES = {"*.pyc", "*.pyo", "*.db", "__init__.py", "package-lock.json"}
EXCLUDED_UI_COMPONENTS = {"src/components/ui"} # ĞÑ‚Ğ»Ğ¸Ñ‡Ğ½Ğ¾Ğµ Ğ¿Ñ€Ğ°Ğ²Ğ¸Ğ»Ğ¾, Ğ¾ÑÑ‚Ğ°Ğ²Ğ»ÑĞµĞ¼!

# --- ĞšĞ¾Ğ½Ñ„Ğ¸Ğ³ÑƒÑ€Ğ°Ñ†Ğ¸Ñ Ğ´Ğ»Ñ ÑƒĞ»ÑƒÑ‡ÑˆĞµĞ½Ğ¸Ñ Ñ‡Ğ¸Ñ‚Ğ°ĞµĞ¼Ğ¾ÑÑ‚Ğ¸ ---
IMPORTANT_FILES = {
    "App.tsx", "HomePage.tsx", "ReservePage.tsx"
}
# <<< Ğ˜Ğ—ĞœĞ•ĞĞ•ĞĞ˜Ğ•: Ğ£Ğ»ÑƒÑ‡ÑˆĞµĞ½Ğ½Ğ°Ñ Ğ»Ğ¾Ğ³Ğ¸ĞºĞ° Ğ´Ğ»Ñ Ñ€ĞµĞ¶Ğ¸Ğ¼Ğ° --light
LIGHT_MODE_INCLUDE_DIRS = {"src/pages", "src/components", "src/hooks", "src/store", "src/lib", "src/types", "src/utils", "src/contexts",
                           "src/constants"}

def is_excluded(file_path: Path, include_ui=False) -> bool:
    """ĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑĞµÑ‚, Ğ´Ğ¾Ğ»Ğ¶ĞµĞ½ Ğ»Ğ¸ Ñ„Ğ°Ğ¹Ğ» Ğ±Ñ‹Ñ‚ÑŒ Ğ¿Ğ¾Ğ»Ğ½Ğ¾ÑÑ‚ÑŒÑ Ğ¸ÑĞºĞ»ÑÑ‡ĞµĞ½."""
    if not include_ui:
        # Ğ˜ÑĞ¿Ğ¾Ğ»ÑŒĞ·ÑƒĞµĞ¼ as_posix() Ğ´Ğ»Ñ ÑƒĞ½Ğ¸Ğ²ĞµÑ€ÑĞ°Ğ»ÑŒĞ½Ğ¾ÑÑ‚Ğ¸ Ğ¿ÑƒÑ‚ĞµĞ¹
        if any(excluded_dir in file_path.as_posix() for excluded_dir in EXCLUDED_UI_COMPONENTS):
            return True
    return any(fnmatch.fnmatch(file_path.name, pattern) for pattern in EXCLUDE_FILES)


def is_included(file_path: Path, light=False) -> bool:
    """ĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑĞµÑ‚, Ğ´Ğ¾Ğ»Ğ¶ĞµĞ½ Ğ»Ğ¸ Ñ„Ğ°Ğ¹Ğ» Ğ±Ñ‹Ñ‚ÑŒ Ğ²ĞºĞ»ÑÑ‡ĞµĞ½ Ğ² ÑĞ±Ğ¾Ñ€ĞºÑƒ."""
    rel_path_posix = file_path.relative_to(project_root).as_posix()

    if light:
        # Ğ’ĞºĞ»ÑÑ‡Ğ°ĞµĞ¼ ĞºĞ»ÑÑ‡ĞµĞ²Ñ‹Ğµ Ñ„Ğ°Ğ¹Ğ»Ñ‹ Ğ¸ Ñ„Ğ°Ğ¹Ğ»Ñ‹ Ğ¸Ğ· Ğ²Ğ°Ğ¶Ğ½Ñ‹Ñ… Ğ´Ğ¸Ñ€ĞµĞºÑ‚Ğ¾Ñ€Ğ¸Ğ¹
        is_in_light_dir = any(rel_path_posix.startswith(d) for d in LIGHT_MODE_INCLUDE_DIRS)
        return file_path.name in INCLUDE_FILES or is_in_light_dir

    # Ğ¡Ñ‚Ğ°Ğ½Ğ´Ğ°Ñ€Ñ‚Ğ½Ñ‹Ğ¹ Ñ€ĞµĞ¶Ğ¸Ğ¼
    parts = file_path.relative_to(project_root).parts
    return (
            file_path.name in INCLUDE_FILES or
            (parts and parts[0] in INCLUDE_DIRS and (file_path.suffix in INCLUDE_EXTENSIONS or file_path.suffix in LIGHTWEIGHT_EXTENSIONS))
    )


def collect_files(light=False, include_ui=False):
    """Ğ¡Ğ¾Ğ±Ğ¸Ñ€Ğ°ĞµÑ‚ Ğ²ÑĞµ Ñ„Ğ°Ğ¹Ğ»Ñ‹, ÑĞ¾Ğ¾Ñ‚Ğ²ĞµÑ‚ÑÑ‚Ğ²ÑƒÑÑ‰Ğ¸Ğµ ĞºÑ€Ğ¸Ñ‚ĞµÑ€Ğ¸ÑĞ¼."""
    included = []
    for root, dirs, files in os.walk(project_root, topdown=True):
        # ĞŸÑ€ĞµĞ¾Ğ±Ñ€Ğ°Ğ·ÑƒĞµĞ¼ root Ğ² Path Ğ´Ğ»Ñ ÑƒĞ´Ğ¾Ğ±ÑÑ‚Ğ²Ğ°
        root_path = Path(root)

        # Ğ­Ñ„Ñ„ĞµĞºÑ‚Ğ¸Ğ²Ğ½Ğ¾ Ğ¾Ñ‚ÑĞµĞºĞ°ĞµĞ¼ Ğ½ĞµĞ½ÑƒĞ¶Ğ½Ñ‹Ğµ Ğ´Ğ¸Ñ€ĞµĞºÑ‚Ğ¾Ñ€Ğ¸Ğ¸
        dirs[:] = [d for d in dirs if (root_path / d).relative_to(project_root).as_posix() not in EXCLUDE_DIRS and d not in EXCLUDE_DIRS]

        for file in files:
            path = root_path / file
            if is_excluded(path, include_ui=include_ui):
                continue
            if is_included(path, light):
                included.append(path)
    return included


def summarize_structure(grouped, included_files):
    """Ğ¡Ğ¾Ğ·Ğ´Ğ°ĞµÑ‚ Ñ‚ĞµĞºÑÑ‚Ğ¾Ğ²Ğ¾Ğµ Ğ¿Ñ€ĞµĞ´ÑÑ‚Ğ°Ğ²Ğ»ĞµĞ½Ğ¸Ğµ ÑÑ‚Ñ€ÑƒĞºÑ‚ÑƒÑ€Ñ‹ Ğ¿Ñ€Ğ¾ĞµĞºÑ‚Ğ°."""
    lines = ["# ğŸ“ Ğ¡Ñ‚Ñ€ÑƒĞºÑ‚ÑƒÑ€Ğ° Ğ¿Ñ€Ğ¾ĞµĞºÑ‚Ğ°"]
    # Ğ¡Ğ¾Ğ·Ğ´Ğ°ĞµĞ¼ Ğ¼Ğ½Ğ¾Ğ¶ĞµÑÑ‚Ğ²Ğ¾ Ğ¿ÑƒÑ‚ĞµĞ¹ Ğ´Ğ»Ñ Ğ±Ñ‹ÑÑ‚Ñ€Ğ¾Ğ¹ Ğ¿Ñ€Ğ¾Ğ²ĞµÑ€ĞºĞ¸ Ğ½Ğ°Ğ»Ğ¸Ñ‡Ğ¸Ñ Ñ„Ğ°Ğ¹Ğ»Ğ°
    included_set = {str(f.relative_to(project_root)) for f in included_files}

    for folder in sorted(grouped):
        lines.append(f"\n### `{folder if folder != '.' else '.'}`")
        for file_path_str in sorted(grouped[folder]):
            if file_path_str not in included_set:
                continue

            file_path = project_root / file_path_str
            # <<< Ğ˜Ğ—ĞœĞ•ĞĞ•ĞĞ˜Ğ•: Ğ¸ĞºĞ¾Ğ½ĞºĞ° Ñ‚ĞµĞ¿ĞµÑ€ÑŒ Ğ·Ğ°Ğ²Ğ¸ÑĞ¸Ñ‚ Ğ¾Ñ‚ Ñ‚Ğ¸Ğ¿Ğ° Ñ„Ğ°Ğ¹Ğ»Ğ°, Ğ° Ğ½Ğµ Ğ¾Ñ‚ ÑƒÑĞµÑ‡ĞµĞ½Ğ¸Ñ
            icon = "ğŸ“„" if file_path.suffix not in LIGHTWEIGHT_EXTENSIONS else "ğŸ–¼ï¸"
            star = "â­" if file_path.name in IMPORTANT_FILES else ""
            lines.append(f"- {star} âœ… `{file_path_str}`") # Ğ£Ğ±Ñ€Ğ°Ğ»Ğ¸ âš ï¸, Ñ‚Ğ°Ğº ĞºĞ°Ğº ÑƒÑĞµÑ‡ĞµĞ½Ğ¸Ğµ Ğ±Ğ¾Ğ»ÑŒÑˆĞµ Ğ½Ğµ Ğ¸ÑĞ¿Ğ¾Ğ»ÑŒĞ·ÑƒĞµÑ‚ÑÑ
    return "\n".join(lines)


def write_output(included, light=False):
    """Ğ—Ğ°Ğ¿Ğ¸ÑÑ‹Ğ²Ğ°ĞµÑ‚ ÑĞ¾Ğ±Ñ€Ğ°Ğ½Ğ½Ñ‹Ğ¹ ĞºĞ¾Ğ´ Ğ² Ğ²Ñ‹Ñ…Ğ¾Ğ´Ğ½Ğ¾Ğ¹ Ñ„Ğ°Ğ¹Ğ»."""
    grouped = defaultdict(list)
    for file in included:
        rel_path = file.relative_to(project_root)
        grouped[str(rel_path.parent)].append(str(rel_path))

    with open(output_filename, "w", encoding="utf-8") as out:
        out.write("# ğŸ¤– Ğ¡Ğ¶Ğ°Ñ‚Ñ‹Ğ¹ Ğ¸ÑÑ…Ğ¾Ğ´Ğ½Ñ‹Ğ¹ ĞºĞ¾Ğ´ Ñ„Ñ€Ğ¾Ğ½Ñ‚ĞµĞ½Ğ´Ğ° Ğ´Ğ»Ñ AI-Ğ¿Ğ¾Ğ¼Ğ¾Ñ‰Ğ½Ğ¸ĞºĞ°\n\n")

        # --- Ğ¡ĞµĞºÑ†Ğ¸Ñ Ğ½Ğ°Ğ²Ğ¸Ğ³Ğ°Ñ†Ğ¸Ğ¸ ---
        out.write("## ğŸ”— Ğ‘Ñ‹ÑÑ‚Ñ€Ğ°Ñ Ğ½Ğ°Ğ²Ğ¸Ğ³Ğ°Ñ†Ğ¸Ñ Ğ¿Ğ¾ Ñ„Ğ°Ğ¹Ğ»Ğ°Ğ¼\n")
        for path in sorted(included, key=lambda p: str(p.relative_to(project_root))):
            rel_path_str = str(path.relative_to(project_root)).replace("\\", "/")
            anchor = rel_path_str.replace("/", "").replace(".", "")
            out.write(f"- [{rel_path_str}](#{anchor})\n")
        out.write("\n---\n\n")

        # --- Ğ¡ĞµĞºÑ†Ğ¸Ñ ÑÑ‚Ñ€ÑƒĞºÑ‚ÑƒÑ€Ñ‹ ---
        structure = summarize_structure(grouped, included)
        out.write(structure)
        out.write("\n\n---\n")

        # --- Ğ¡ĞµĞºÑ†Ğ¸Ñ Ñ ĞºĞ¾Ğ´Ğ¾Ğ¼ ---
        for path in sorted(included, key=lambda p: str(p.relative_to(project_root))):
            rel_path = path.relative_to(project_root)
            rel_path_str = str(rel_path).replace("\\", "/")
            anchor = rel_path_str.replace("/", "").replace(".", "")

            out.write(f'\n\n## <a name="{anchor}"></a>`{rel_path_str}`\n\n')

            # <<< Ğ˜Ğ—ĞœĞ•ĞĞ•ĞĞ˜Ğ•: Ğ¡Ğ¿ĞµÑ†Ğ¸Ğ°Ğ»ÑŒĞ½Ğ°Ñ Ğ¾Ğ±Ñ€Ğ°Ğ±Ğ¾Ñ‚ĞºĞ° Ğ´Ğ»Ñ "Ğ»ĞµĞ³ĞºĞ¾Ğ²ĞµÑĞ½Ñ‹Ñ…" Ñ„Ğ°Ğ¹Ğ»Ğ¾Ğ²
            if path.suffix in LIGHTWEIGHT_EXTENSIONS:
                out.write(f"```\n\n```\n")
                continue

            # ĞĞ¿Ñ€ĞµĞ´ĞµĞ»ÑĞµĞ¼ ÑĞ·Ñ‹Ğº Ğ´Ğ»Ñ Ğ¿Ğ¾Ğ´ÑĞ²ĞµÑ‚ĞºĞ¸ ÑĞ¸Ğ½Ñ‚Ğ°ĞºÑĞ¸ÑĞ°
            lang_map = {'.tsx': 'tsx', '.ts': 'typescript', '.css': 'css', '.js': 'javascript', '.json': 'json'}
            lang = lang_map.get(path.suffix, 'html')

            block = [f"```{lang}"]
            try:
                # <<< Ğ˜Ğ—ĞœĞ•ĞĞ•ĞĞ˜Ğ•: Ğ£Ğ±Ñ€Ğ°Ğ½ Ğ¼ĞµÑ…Ğ°Ğ½Ğ¸Ğ·Ğ¼ ÑƒÑĞµÑ‡ĞµĞ½Ğ¸Ñ. Ğ›ÑƒÑ‡ÑˆĞµ Ğ¿Ñ€ĞµĞ´Ğ¾ÑÑ‚Ğ°Ğ²Ğ¸Ñ‚ÑŒ Ğ¿Ğ¾Ğ»Ğ½Ñ‹Ğ¹ ĞºĞ¾Ğ´, ĞµÑĞ»Ğ¸ Ñ„Ğ°Ğ¹Ğ» Ğ²ĞºĞ»ÑÑ‡ĞµĞ½.
                content = path.read_text(encoding="utf-8")
                # Ğ”Ğ¾Ğ±Ğ°Ğ²Ğ»ÑĞµĞ¼ ĞºĞ¾Ğ¼Ğ¼ĞµĞ½Ñ‚Ğ°Ñ€Ğ¸Ğ¹ Ñ Ğ¿ÑƒÑ‚ĞµĞ¼ Ğº Ñ„Ğ°Ğ¹Ğ»Ñƒ Ğ´Ğ»Ñ Ğ´Ğ¾Ğ¿Ğ¾Ğ»Ğ½Ğ¸Ñ‚ĞµĞ»ÑŒĞ½Ğ¾Ğ³Ğ¾ ĞºĞ¾Ğ½Ñ‚ĞµĞºÑÑ‚Ğ°
                block.insert(1, f"// {rel_path_str}\n")
                block.append(content)
            except Exception as e:
                block.append(f"# ĞÑˆĞ¸Ğ±ĞºĞ° Ñ‡Ñ‚ĞµĞ½Ğ¸Ñ Ñ„Ğ°Ğ¹Ğ»Ğ°: {e}")
            block.append("\n```\n")
            out.write("\n".join(block))

        # --- Ğ¡ĞµĞºÑ†Ğ¸Ñ Ğ·Ğ°Ğ²Ğ¸ÑĞ¸Ğ¼Ğ¾ÑÑ‚ĞµĞ¹ ---
        pkg_path = project_root / "package.json"
        if pkg_path.exists():
            try:
                pkg_data = json.loads(pkg_path.read_text(encoding="utf-8"))
                deps = pkg_data.get("dependencies", {})
                dev_deps = pkg_data.get("devDependencies", {})

                out.write("\n\n## ğŸ“¦ Ğ—Ğ°Ğ²Ğ¸ÑĞ¸Ğ¼Ğ¾ÑÑ‚Ğ¸ Ğ¿Ñ€Ğ¾ĞµĞºÑ‚Ğ°\n\n")
                for name, version in sorted(deps.items()):
                    out.write(f"- `{name}`: {version}\n")

                if dev_deps:
                    out.write("\n### Dev-Ğ·Ğ°Ğ²Ğ¸ÑĞ¸Ğ¼Ğ¾ÑÑ‚Ğ¸\n\n")
                    for name, version in sorted(dev_deps.items()):
                        out.write(f"- `{name}`: {version}\n")

            except Exception as e:
                out.write(f"\n\n## ĞÑˆĞ¸Ğ±ĞºĞ° Ñ‡Ñ‚ĞµĞ½Ğ¸Ñ package.json: {e}\n")

def main():
    parser = argparse.ArgumentParser(description="Ğ¡Ğ±Ğ¾Ñ€Ñ‰Ğ¸Ğº ĞºĞ¾Ğ´Ğ° Ğ¿Ñ€Ğ¾ĞµĞºÑ‚Ğ° Ğ´Ğ»Ñ Ğ°Ğ½Ğ°Ğ»Ğ¸Ğ·Ğ° Ğ˜Ğ˜.")
    parser.add_argument("--light", action="store_true", help="Ğ¡Ğ¾Ğ±Ñ€Ğ°Ñ‚ÑŒ Ñ‚Ğ¾Ğ»ÑŒĞºĞ¾ ĞºĞ»ÑÑ‡ĞµĞ²Ñ‹Ğµ Ğ´Ğ¸Ñ€ĞµĞºÑ‚Ğ¾Ñ€Ğ¸Ğ¸ (pages, components, hooks, store, lib, types, utils).")
    parser.add_argument("--include-ui", action="store_true", help="Ğ’ĞºĞ»ÑÑ‡Ğ¸Ñ‚ÑŒ ĞºĞ¾Ğ¼Ğ¿Ğ¾Ğ½ĞµĞ½Ñ‚Ñ‹ Ğ¸Ğ· src/components/ui.")
    args = parser.parse_args()

    print("Ğ¡Ğ±Ğ¾Ñ€ĞºĞ° Ñ„Ğ°Ğ¹Ğ»Ğ¾Ğ²...")
    included_files = collect_files(light=args.light, include_ui=args.include_ui)

    print(f"ĞĞ°Ğ¹Ğ´ĞµĞ½Ğ¾ {len(included_files)} Ñ„Ğ°Ğ¹Ğ»Ğ¾Ğ² Ğ´Ğ»Ñ Ğ²ĞºĞ»ÑÑ‡ĞµĞ½Ğ¸Ñ.")
    write_output(included_files, light=args.light)

    print(f"âœ… Ğ¤Ğ°Ğ¹Ğ» '{output_filename.name}' ÑƒÑĞ¿ĞµÑˆĞ½Ğ¾ ÑĞ¾Ğ·Ğ´Ğ°Ğ½.")

if __name__ == "__main__":
    main()

```


## <a name="rentalappmainsplitoptimizedgemNEW1py"></a>`rental-app-main/split_optimized_gem_NEW_1.py`

```python
// path: rental-app-main/split_optimized_gem_NEW_1.py

import os
import json
import fnmatch
import argparse
from pathlib import Path
from collections import defaultdict
import re # ### Ğ˜Ğ—ĞœĞ•ĞĞ•ĞĞ˜Ğ•: Ğ”Ğ¾Ğ±Ğ°Ğ²Ğ»ĞµĞ½ Ğ¼Ğ¾Ğ´ÑƒĞ»ÑŒ Ğ´Ğ»Ñ Ñ€ĞµĞ³ÑƒĞ»ÑÑ€Ğ½Ñ‹Ñ… Ğ²Ñ‹Ñ€Ğ°Ğ¶ĞµĞ½Ğ¸Ğ¹

# <<< Ğ˜Ğ—ĞœĞ•ĞĞ•ĞĞ˜Ğ•: ĞŸÑƒÑ‚ÑŒ Ğº Ğ¿Ñ€Ğ¾ĞµĞºÑ‚Ñƒ Ğ¾Ğ¿Ñ€ĞµĞ´ĞµĞ»ÑĞµÑ‚ÑÑ Ğ¾Ñ‚Ğ½Ğ¾ÑĞ¸Ñ‚ĞµĞ»ÑŒĞ½Ğ¾ ÑĞºÑ€Ğ¸Ğ¿Ñ‚Ğ°
project_root = Path(__file__).resolve().parent
output_filename = project_root / "smart_react_code_gem_v2.md"

# --- ĞšĞ¾Ğ½Ñ„Ğ¸Ğ³ÑƒÑ€Ğ°Ñ†Ğ¸Ñ Ğ²ĞºĞ»ÑÑ‡ĞµĞ½Ğ¸Ğ¹ ---
INCLUDE_DIRS = {"src", "public"}
INCLUDE_FILES = {
    "package.json",
    "tsconfig.json", "tsconfig.node.json", "tsconfig.app.json",
    'tailwind.config.js', 'postcss.config.js', 'vite.config.ts',
}
INCLUDE_EXTENSIONS = {".tsx", ".ts", ".css", ".js"}
LIGHTWEIGHT_EXTENSIONS = {".svg"}

# --- ĞšĞ¾Ğ½Ñ„Ğ¸Ğ³ÑƒÑ€Ğ°Ñ†Ğ¸Ñ Ğ¸ÑĞºĞ»ÑÑ‡ĞµĞ½Ğ¸Ğ¹ ---
EXCLUDE_DIRS = {".git", ".venv", "node_modules", ".idea", ".vscode", "dist", "build"}
EXCLUDE_FILES = {"*.pyc", "*.pyo", "*.db", "__init__.py", "package-lock.json"}
EXCLUDED_UI_COMPONENTS = {"src/components/ui"}

# --- ĞšĞ¾Ğ½Ñ„Ğ¸Ğ³ÑƒÑ€Ğ°Ñ†Ğ¸Ñ Ğ´Ğ»Ñ ÑƒĞ»ÑƒÑ‡ÑˆĞµĞ½Ğ¸Ñ Ñ‡Ğ¸Ñ‚Ğ°ĞµĞ¼Ğ¾ÑÑ‚Ğ¸ ---
IMPORTANT_FILES = {
    "App.tsx", "HomePage.tsx", "ReservePage.tsx", "AdminPanelPage.tsx"
}
# <<< Ğ˜Ğ—ĞœĞ•ĞĞ•ĞĞ˜Ğ•: ĞĞ¾Ğ²Ğ°Ñ, Ğ±Ğ¾Ğ»ĞµĞµ Ğ³Ğ¸Ğ±ĞºĞ°Ñ ÑĞ¸ÑÑ‚ĞµĞ¼Ğ° Ğ¿Ñ€Ğ¾Ñ„Ğ¸Ğ»ĞµĞ¹ ---
PROFILES = {
    "full": {
        "include_dirs": {"src", "public"},
        "description": "ĞŸĞ¾Ğ»Ğ½Ğ°Ñ ÑĞ±Ğ¾Ñ€ĞºĞ° Ğ²ÑĞµĞ³Ğ¾ Ğ¿Ñ€Ğ¾ĞµĞºÑ‚Ğ°."
    },
    "light": {
        "include_dirs": {"src/pages", "src/components", "src/hooks", "src/store", "src/lib", "src/types", "src/utils", "src/contexts", "src/constants"},
        "description": "Ğ¡Ğ±Ğ¾Ñ€ĞºĞ° Ñ‚Ğ¾Ğ»ÑŒĞºĞ¾ ĞºĞ»ÑÑ‡ĞµĞ²Ñ‹Ñ… Ğ´Ğ¸Ñ€ĞµĞºÑ‚Ğ¾Ñ€Ğ¸Ğ¹ Ñ Ğ±Ğ¸Ğ·Ğ½ĞµÑ-Ğ»Ğ¾Ğ³Ğ¸ĞºĞ¾Ğ¹."
    },
    "user": {
        "include_dirs": {"src/pages", "src/components", "src/hooks", "src/store", "src/lib", "src/types", "src/utils", "src/contexts", "src/constants"},
        "exclude_paths": {"src/pages/admin", "src/components/admin"},
        "description": "Ğ¡Ğ±Ğ¾Ñ€ĞºĞ° Ñ‚Ğ¾Ğ»ÑŒĞºĞ¾ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ÑŒÑĞºĞ¾Ğ¹ Ñ‡Ğ°ÑÑ‚Ğ¸ Ğ¿Ñ€Ğ¸Ğ»Ğ¾Ğ¶ĞµĞ½Ğ¸Ñ (Ğ±ĞµĞ· Ğ°Ğ´Ğ¼Ğ¸Ğ½ĞºĞ¸)."
    },
    "admin": {
        "include_dirs": {"src/pages/admin", "src/components/admin", "src/hooks/admin", "src/store", "src/lib", "src/types", "src/utils", "src/hooks/useAdmin"},
        "description": "Ğ¡Ğ±Ğ¾Ñ€ĞºĞ° Ñ‚Ğ¾Ğ»ÑŒĞºĞ¾ Ğ°Ğ´Ğ¼Ğ¸Ğ½Ğ¸ÑÑ‚Ñ€Ğ°Ñ‚Ğ¸Ğ²Ğ½Ğ¾Ğ¹ Ñ‡Ğ°ÑÑ‚Ğ¸ Ğ¿Ñ€Ğ¸Ğ»Ğ¾Ğ¶ĞµĞ½Ğ¸Ñ."
    }
}


def is_excluded(file_path: Path, profile_config: dict, include_ui=False) -> bool:
    """ĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑĞµÑ‚, Ğ´Ğ¾Ğ»Ğ¶ĞµĞ½ Ğ»Ğ¸ Ñ„Ğ°Ğ¹Ğ» Ğ±Ñ‹Ñ‚ÑŒ Ğ¿Ğ¾Ğ»Ğ½Ğ¾ÑÑ‚ÑŒÑ Ğ¸ÑĞºĞ»ÑÑ‡ĞµĞ½."""
    rel_path_posix = file_path.relative_to(project_root).as_posix()

    if not include_ui and any(ex_dir in rel_path_posix for ex_dir in EXCLUDED_UI_COMPONENTS):
        return True

    # <<< Ğ˜Ğ—ĞœĞ•ĞĞ•ĞĞ˜Ğ•: ĞŸÑ€Ğ¾Ğ²ĞµÑ€ĞºĞ° Ğ½Ğ° Ğ¸ÑĞºĞ»ÑÑ‡ĞµĞ½Ğ¸Ñ Ğ¸Ğ· Ğ¿Ñ€Ğ¾Ñ„Ğ¸Ğ»Ñ
    if "exclude_paths" in profile_config and any(ex_path in rel_path_posix for ex_path in profile_config["exclude_paths"]):
        return True

    return any(fnmatch.fnmatch(file_path.name, pattern) for pattern in EXCLUDE_FILES)


def is_included(file_path: Path, profile_config: dict) -> bool:
    """ĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑĞµÑ‚, Ğ´Ğ¾Ğ»Ğ¶ĞµĞ½ Ğ»Ğ¸ Ñ„Ğ°Ğ¹Ğ» Ğ±Ñ‹Ñ‚ÑŒ Ğ²ĞºĞ»ÑÑ‡ĞµĞ½ Ğ² ÑĞ±Ğ¾Ñ€ĞºÑƒ Ğ½Ğ° Ğ¾ÑĞ½Ğ¾Ğ²Ğµ Ğ¿Ñ€Ğ¾Ñ„Ğ¸Ğ»Ñ."""
    rel_path_posix = file_path.relative_to(project_root).as_posix()

    # Ğ’ĞºĞ»ÑÑ‡Ğ°ĞµĞ¼ ĞºĞ»ÑÑ‡ĞµĞ²Ñ‹Ğµ Ñ„Ğ°Ğ¹Ğ»Ñ‹ ĞºĞ¾Ğ½Ñ„Ğ¸Ğ³ÑƒÑ€Ğ°Ñ†Ğ¸Ğ¸ Ğ²ÑĞµĞ³Ğ´Ğ°
    if file_path.name in INCLUDE_FILES:
        return True

    # ĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑĞµĞ¼, Ğ½Ğ°Ñ…Ğ¾Ğ´Ğ¸Ñ‚ÑÑ Ğ»Ğ¸ Ñ„Ğ°Ğ¹Ğ» Ğ² Ğ¾Ğ´Ğ½Ğ¾Ğ¹ Ğ¸Ğ· Ñ€Ğ°Ğ·Ñ€ĞµÑˆĞµĞ½Ğ½Ñ‹Ñ… Ğ´Ğ¸Ñ€ĞµĞºÑ‚Ğ¾Ñ€Ğ¸Ğ¹ Ğ¿Ñ€Ğ¾Ñ„Ğ¸Ğ»Ñ
    if not any(rel_path_posix.startswith(d) for d in profile_config["include_dirs"]):
        return False

    # ĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑĞµĞ¼ Ñ€Ğ°ÑÑˆĞ¸Ñ€ĞµĞ½Ğ¸Ğµ Ñ„Ğ°Ğ¹Ğ»Ğ°
    return file_path.suffix in INCLUDE_EXTENSIONS or file_path.suffix in LIGHTWEIGHT_EXTENSIONS


def collect_files(profile: str, include_ui=False):
    """Ğ¡Ğ¾Ğ±Ğ¸Ñ€Ğ°ĞµÑ‚ Ğ²ÑĞµ Ñ„Ğ°Ğ¹Ğ»Ñ‹, ÑĞ¾Ğ¾Ñ‚Ğ²ĞµÑ‚ÑÑ‚Ğ²ÑƒÑÑ‰Ğ¸Ğµ Ğ²Ñ‹Ğ±Ñ€Ğ°Ğ½Ğ½Ğ¾Ğ¼Ñƒ Ğ¿Ñ€Ğ¾Ñ„Ğ¸Ğ»Ñ."""
    if profile not in PROFILES:
        raise ValueError(f"ĞŸÑ€Ğ¾Ñ„Ğ¸Ğ»ÑŒ '{profile}' Ğ½Ğµ Ğ½Ğ°Ğ¹Ğ´ĞµĞ½.")
    profile_config = PROFILES[profile]
    print(f"Ğ˜ÑĞ¿Ğ¾Ğ»ÑŒĞ·ÑƒĞµÑ‚ÑÑ Ğ¿Ñ€Ğ¾Ñ„Ğ¸Ğ»ÑŒ: '{profile}' ({profile_config['description']})")

    included = []
    for root, dirs, files in os.walk(project_root, topdown=True):
        root_path = Path(root)
        dirs[:] = [d for d in dirs if (root_path / d).relative_to(project_root).as_posix() not in EXCLUDE_DIRS and d not in EXCLUDE_DIRS]

        for file in files:
            path = root_path / file
            if is_excluded(path, profile_config, include_ui=include_ui):
                continue
            if is_included(path, profile_config):
                included.append(path)
    return included

# <<< Ğ˜Ğ—ĞœĞ•ĞĞ•ĞĞ˜Ğ•: ĞŸĞ¾Ğ»Ğ½Ğ¾ÑÑ‚ÑŒÑ Ğ¿ĞµÑ€ĞµĞ¿Ğ¸ÑĞ°Ğ½Ğ½Ğ°Ñ Ñ„ÑƒĞ½ĞºÑ†Ğ¸Ñ Ğ´Ğ»Ñ Ğ³ĞµĞ½ĞµÑ€Ğ°Ñ†Ğ¸Ğ¸ Ğ¸ĞµÑ€Ğ°Ñ€Ñ…Ğ¸Ñ‡ĞµÑĞºĞ¾Ğ³Ğ¾ Ğ´ĞµÑ€ĞµĞ²Ğ° ---
def generate_tree_structure(included_files):
    """Ğ¡Ğ¾Ğ·Ğ´Ğ°ĞµÑ‚ Ñ‚ĞµĞºÑÑ‚Ğ¾Ğ²Ğ¾Ğµ Ğ¿Ñ€ĞµĞ´ÑÑ‚Ğ°Ğ²Ğ»ĞµĞ½Ğ¸Ğµ Ğ¸ĞµÑ€Ğ°Ñ€Ñ…Ğ¸Ñ‡ĞµÑĞºĞ¾Ğ¹ ÑÑ‚Ñ€ÑƒĞºÑ‚ÑƒÑ€Ñ‹ Ğ¿Ñ€Ğ¾ĞµĞºÑ‚Ğ°."""
    tree = defaultdict(list)
    for path in included_files:
        rel_path = path.relative_to(project_root)
        parent = str(rel_path.parent)
        tree[parent].append(rel_path)

    lines = ["# ğŸ“ Ğ¡Ñ‚Ñ€ÑƒĞºÑ‚ÑƒÑ€Ğ° Ğ¿Ñ€Ğ¾ĞµĞºÑ‚Ğ° (Ğ¸ĞµÑ€Ğ°Ñ€Ñ…Ğ¸Ñ)"]

    def build_tree(folder: str, prefix: str = ""):
        # ĞŸĞ¾Ğ»ÑƒÑ‡Ğ°ĞµĞ¼ Ğ¸ ÑĞ¾Ñ€Ñ‚Ğ¸Ñ€ÑƒĞµĞ¼ Ñ„Ğ°Ğ¹Ğ»Ñ‹ Ğ¸ Ğ¿Ğ¾Ğ´Ğ¿Ğ°Ğ¿ĞºĞ¸
        files = sorted([f for f in tree.get(folder, []) if f.parent.name == folder or folder == '.'])
        subfolders = sorted([d for d in tree if Path(d).parent == Path(folder) and d != folder])

        # Ğ¡Ğ½Ğ°Ñ‡Ğ°Ğ»Ğ° Ğ²Ñ‹Ğ²Ğ¾Ğ´Ğ¸Ğ¼ Ğ¿Ğ¾Ğ´Ğ¿Ğ°Ğ¿ĞºĞ¸
        for i, subfolder in enumerate(subfolders):
            is_last = (i == len(subfolders) - 1) and (len(files) == 0)
            lines.append(f"{prefix}{'â””â”€â”€ ' if is_last else 'â”œâ”€â”€ '}`{Path(subfolder).name}/`")
            build_tree(subfolder, prefix + ('    ' if is_last else 'â”‚   '))

        # Ğ—Ğ°Ñ‚ĞµĞ¼ Ğ²Ñ‹Ğ²Ğ¾Ğ´Ğ¸Ğ¼ Ñ„Ğ°Ğ¹Ğ»Ñ‹
        for i, file_path in enumerate(files):
            is_last = i == len(files) - 1
            icon = "ğŸ–¼ï¸" if file_path.suffix in LIGHTWEIGHT_EXTENSIONS else "ğŸ“„"
            star = "â­" if file_path.name in IMPORTANT_FILES else ""
            lines.append(f"{prefix}{'â””â”€â”€ ' if is_last else 'â”œâ”€â”€ '}{star}{icon} `{file_path.name}`")

    lines.append(f"`{project_root.name}/`")
    build_tree('.', '    ')
    return "\n".join(lines)


def write_output(included, strip_comments=False, strip_empty_lines=False):
    """Ğ—Ğ°Ğ¿Ğ¸ÑÑ‹Ğ²Ğ°ĞµÑ‚ ÑĞ¾Ğ±Ñ€Ğ°Ğ½Ğ½Ñ‹Ğ¹ ĞºĞ¾Ğ´ Ğ² Ğ²Ñ‹Ñ…Ğ¾Ğ´Ğ½Ğ¾Ğ¹ Ñ„Ğ°Ğ¹Ğ» Ñ Ğ¾Ğ¿Ñ†Ğ¸Ğ¾Ğ½Ğ°Ğ»ÑŒĞ½Ğ¾Ğ¹ Ğ¾Ñ‡Ğ¸ÑÑ‚ĞºĞ¾Ğ¹."""
    with open(output_filename, "w", encoding="utf-8") as out:
        out.write("# ğŸ¤– Ğ¡Ğ¶Ğ°Ñ‚Ñ‹Ğ¹ Ğ¸ÑÑ…Ğ¾Ğ´Ğ½Ñ‹Ğ¹ ĞºĞ¾Ğ´ Ñ„Ñ€Ğ¾Ğ½Ñ‚ĞµĞ½Ğ´Ğ° Ğ´Ğ»Ñ AI-Ğ¿Ğ¾Ğ¼Ğ¾Ñ‰Ğ½Ğ¸ĞºĞ°\n\n")

        # --- Ğ¡ĞµĞºÑ†Ğ¸Ñ Ğ½Ğ°Ğ²Ğ¸Ğ³Ğ°Ñ†Ğ¸Ğ¸ ---
        out.write("## ğŸ”— Ğ‘Ñ‹ÑÑ‚Ñ€Ğ°Ñ Ğ½Ğ°Ğ²Ğ¸Ğ³Ğ°Ñ†Ğ¸Ñ Ğ¿Ğ¾ Ñ„Ğ°Ğ¹Ğ»Ğ°Ğ¼\n")
        for path in sorted(included, key=lambda p: str(p.relative_to(project_root))):
            rel_path_str = str(path.relative_to(project_root)).replace("\\", "/")
            anchor = rel_path_str.replace("/", "").replace(".", "")
            out.write(f"- [{rel_path_str}](#{anchor})\n")
        out.write("\n---\n\n")

        # --- Ğ¡ĞµĞºÑ†Ğ¸Ñ ÑÑ‚Ñ€ÑƒĞºÑ‚ÑƒÑ€Ñ‹ (Ğ½Ğ¾Ğ²Ğ¾Ğµ Ğ¸ĞµÑ€Ğ°Ñ€Ñ…Ğ¸Ñ‡ĞµÑĞºĞ¾Ğµ Ğ´ĞµÑ€ĞµĞ²Ğ¾) ---
        structure = generate_tree_structure(included)
        out.write(structure)
        out.write("\n\n---\n")

        # --- Ğ¡ĞµĞºÑ†Ğ¸Ñ Ñ ĞºĞ¾Ğ´Ğ¾Ğ¼ ---
        for path in sorted(included, key=lambda p: str(p.relative_to(project_root))):
            rel_path = path.relative_to(project_root)
            rel_path_str = str(rel_path).replace("\\", "/")
            anchor = rel_path_str.replace("/", "").replace(".", "")
            out.write(f'\n\n## <a name="{anchor}"></a>`{rel_path_str}`\n\n')

            if path.suffix in LIGHTWEIGHT_EXTENSIONS:
                out.write(f"```\n[Ğ¡Ğ¾Ğ´ĞµÑ€Ğ¶Ğ¸Ğ¼Ğ¾Ğµ SVG Ñ„Ğ°Ğ¹Ğ»Ğ° '{path.name}' Ğ½Ğµ Ğ²ĞºĞ»ÑÑ‡ĞµĞ½Ğ¾ Ğ´Ğ»Ñ ÑĞºĞ¾Ğ½Ğ¾Ğ¼Ğ¸Ğ¸ Ğ¼ĞµÑÑ‚Ğ°]\n```\n")
                continue

            lang_map = {'.tsx': 'tsx', '.ts': 'typescript', '.css': 'css', '.js': 'javascript', '.json': 'json'}
            lang = lang_map.get(path.suffix, '')

            block = [f"```{lang}"]
            try:
                content = path.read_text(encoding="utf-8")

                # <<< Ğ˜Ğ—ĞœĞ•ĞĞ•ĞĞ˜Ğ•: ĞĞ¿Ñ†Ğ¸Ğ¾Ğ½Ğ°Ğ»ÑŒĞ½Ğ°Ñ Ğ¾Ñ‡Ğ¸ÑÑ‚ĞºĞ° ĞºĞ¾Ğ½Ñ‚ĞµĞ½Ñ‚Ğ° ---
                if strip_comments:
                    content = re.sub(r'//.*|/\*[\s\S]*?\*/', '', content)
                if strip_empty_lines:
                    content = "\n".join([line for line in content.splitlines() if line.strip()])

                block.insert(1, f"// path: {rel_path_str}\n")
                block.append(content)
            except Exception as e:
                block.append(f"# ĞÑˆĞ¸Ğ±ĞºĞ° Ñ‡Ñ‚ĞµĞ½Ğ¸Ñ Ñ„Ğ°Ğ¹Ğ»Ğ°: {e}")
            block.append("\n```\n")
            out.write("\n".join(block))

        # --- Ğ¡ĞµĞºÑ†Ğ¸Ñ Ğ·Ğ°Ğ²Ğ¸ÑĞ¸Ğ¼Ğ¾ÑÑ‚ĞµĞ¹ ---
        pkg_path = project_root / "package.json"
        if pkg_path.exists():
            try:
                pkg_data = json.loads(pkg_path.read_text(encoding="utf-8"))
                deps = pkg_data.get("dependencies", {})
                dev_deps = pkg_data.get("devDependencies", {})

                out.write("\n\n## ğŸ“¦ Ğ—Ğ°Ğ²Ğ¸ÑĞ¸Ğ¼Ğ¾ÑÑ‚Ğ¸ Ğ¿Ñ€Ğ¾ĞµĞºÑ‚Ğ°\n\n")
                if deps:
                    for name, version in sorted(deps.items()):
                        out.write(f"- `{name}`: {version}\n")
                else:
                    out.write("ĞÑĞ½Ğ¾Ğ²Ğ½Ñ‹Ğµ Ğ·Ğ°Ğ²Ğ¸ÑĞ¸Ğ¼Ğ¾ÑÑ‚Ğ¸ Ğ½Ğµ Ğ½Ğ°Ğ¹Ğ´ĞµĞ½Ñ‹.\n")

                if dev_deps:
                    out.write("\n### Dev-Ğ·Ğ°Ğ²Ğ¸ÑĞ¸Ğ¼Ğ¾ÑÑ‚Ğ¸\n\n")
                    for name, version in sorted(dev_deps.items()):
                        out.write(f"- `{name}`: {version}\n")
                else:
                    out.write("Dev-Ğ·Ğ°Ğ²Ğ¸ÑĞ¸Ğ¼Ğ¾ÑÑ‚Ğ¸ Ğ½Ğµ Ğ½Ğ°Ğ¹Ğ´ĞµĞ½Ñ‹.\n")
            except Exception as e:
                out.write(f"\n\n## ĞÑˆĞ¸Ğ±ĞºĞ° Ñ‡Ñ‚ĞµĞ½Ğ¸Ñ package.json: {e}\n")


def main():
    parser = argparse.ArgumentParser(description="Ğ¡Ğ±Ğ¾Ñ€Ñ‰Ğ¸Ğº ĞºĞ¾Ğ´Ğ° Ğ¿Ñ€Ğ¾ĞµĞºÑ‚Ğ° Ğ´Ğ»Ñ Ğ°Ğ½Ğ°Ğ»Ğ¸Ğ·Ğ° Ğ˜Ğ˜.")
    # <<< Ğ˜Ğ—ĞœĞ•ĞĞ•ĞĞ˜Ğ•: Ğ—Ğ°Ğ¼ĞµĞ½Ğ° --light Ğ½Ğ° --profile ---
    parser.add_argument("--profile", default="full", choices=PROFILES.keys(),
                        help="ĞŸÑ€Ğ¾Ñ„Ğ¸Ğ»ÑŒ ÑĞ±Ğ¾Ñ€ĞºĞ¸: full, light, user, admin.")
    parser.add_argument("--include-ui", action="store_true", help="Ğ’ĞºĞ»ÑÑ‡Ğ¸Ñ‚ÑŒ ĞºĞ¾Ğ¼Ğ¿Ğ¾Ğ½ĞµĞ½Ñ‚Ñ‹ Ğ¸Ğ· src/components/ui.")
    # <<< Ğ˜Ğ—ĞœĞ•ĞĞ•ĞĞ˜Ğ•: ĞĞ¾Ğ²Ñ‹Ğµ Ñ„Ğ»Ğ°Ğ³Ğ¸ Ğ´Ğ»Ñ Ğ¾Ğ¿Ñ‚Ğ¸Ğ¼Ğ¸Ğ·Ğ°Ñ†Ğ¸Ğ¸ ---
    parser.add_argument("--strip-comments", action="store_true", help="Ğ£Ğ´Ğ°Ğ»Ğ¸Ñ‚ÑŒ ĞºĞ¾Ğ¼Ğ¼ĞµĞ½Ñ‚Ğ°Ñ€Ğ¸Ğ¸ Ğ¸Ğ· ĞºĞ¾Ğ´Ğ°.")
    parser.add_argument("--strip-empty-lines", action="store_true", help="Ğ£Ğ´Ğ°Ğ»Ğ¸Ñ‚ÑŒ Ğ¿ÑƒÑÑ‚Ñ‹Ğµ ÑÑ‚Ñ€Ğ¾ĞºĞ¸ Ğ¸Ğ· ĞºĞ¾Ğ´Ğ°.")

    args = parser.parse_args()

    print("Ğ¡Ğ±Ğ¾Ñ€ĞºĞ° Ñ„Ğ°Ğ¹Ğ»Ğ¾Ğ²...")
    included_files = collect_files(profile=args.profile, include_ui=args.include_ui)

    print(f"ĞĞ°Ğ¹Ğ´ĞµĞ½Ğ¾ {len(included_files)} Ñ„Ğ°Ğ¹Ğ»Ğ¾Ğ² Ğ´Ğ»Ñ Ğ²ĞºĞ»ÑÑ‡ĞµĞ½Ğ¸Ñ.")
    write_output(included_files, strip_comments=args.strip_comments, strip_empty_lines=args.strip_empty_lines)

    print(f"âœ… Ğ¤Ğ°Ğ¹Ğ» '{output_filename.name}' ÑƒÑĞ¿ĞµÑˆĞ½Ğ¾ ÑĞ¾Ğ·Ğ´Ğ°Ğ½.")

if __name__ == "__main__":
    main()

```


## <a name="rentalappmainsplitoptimizedgrokpy"></a>`rental-app-main/split_optimized_grok.py`

```python
// path: rental-app-main/split_optimized_grok.py

import os
import json
import fnmatch
import argparse
from pathlib import Path
from collections import defaultdict

project_root = Path(__file__).resolve().parent
output_filename = project_root / "smart_react_code_grok.md"

INCLUDE_DIRS = {"src", "public"}
INCLUDE_FILES = {
    "App.tsx", "main.tsx", "package.json",
    "tsconfig.json", "tsconfig.node.json", "tsconfig.app.json", "vite.config.json", 'tailwind.config.js', 'postcss.config.js', 'vite.config.ts',
    'postcss.config.cjs'
}
INCLUDE_EXTENSIONS = {".tsx", ".html", ".ts", ".svg", ".css", ".js", ".txt"}

EXCLUDE_DIRS = {".git", ".venv", "node_modules", ".idea", ".vscode", "dist", "build"}
EXCLUDE_FILES = {"*.pyc", "*.pyo", "*.db", "__init__.py", "package-lock.json"}  # Ğ˜ÑĞºĞ»ÑÑ‡ĞµĞ½ package-lock.json Ğ¸Ğ·-Ğ·Ğ° Ñ€Ğ°Ğ·Ğ¼ĞµÑ€Ğ°

EXCLUDED_UI_COMPONENTS = {"src/components/ui"}

IMPORTANT_FILES = {
    "App.tsx", "HomePage.tsx", "ReservePage.tsx", "ReserveEditPage.tsx"
}

MAX_LINES = 200  # Ğ£Ğ¼ĞµĞ½ÑŒÑˆĞµĞ½Ğ¾ Ğ´Ğ»Ñ Ğ±Ğ¾Ğ»ĞµĞµ Ğ°Ğ³Ñ€ĞµÑÑĞ¸Ğ²Ğ½Ğ¾Ğ¹ ÑƒÑĞµÑ‡ĞµĞ½Ğ¸Ñ
TRUNCATE_LINES = 30  # Ğ£Ğ¼ĞµĞ½ÑŒÑˆĞµĞ½Ğ¾ ĞºĞ¾Ğ»Ğ¸Ñ‡ĞµÑÑ‚Ğ²Ğ¾ ÑÑ‚Ñ€Ğ¾Ğº Ğ´Ğ»Ñ ÑƒÑĞµÑ‡ĞµĞ½Ğ¸Ñ
MAX_TOTAL_SIZE_KB = 200  # ĞĞ¾Ğ²Ñ‹Ğ¹ Ğ»Ğ¸Ğ¼Ğ¸Ñ‚: Ğ¼Ğ°ĞºÑĞ¸Ğ¼Ğ°Ğ»ÑŒĞ½Ñ‹Ğ¹ Ñ€Ğ°Ğ·Ğ¼ĞµÑ€ Ğ²Ñ‹Ñ…Ğ¾Ğ´Ğ½Ğ¾Ğ³Ğ¾ Ñ„Ğ°Ğ¹Ğ»Ğ° Ğ² KB (Ğ¿Ñ€Ğ¸Ğ¼ĞµÑ€Ğ½Ğ¾ 200k ÑĞ¸Ğ¼Ğ²Ğ¾Ğ»Ğ¾Ğ² ~ 200KB)


def is_excluded(file_path: Path, include_ui=False) -> bool:
    if not include_ui:
        for excluded_dir in EXCLUDED_UI_COMPONENTS:
            if excluded_dir in str(file_path).replace("\\", "/"):
                return True
    return any(fnmatch.fnmatch(file_path.name, pattern) for pattern in EXCLUDE_FILES)


def is_included(file_path: Path, light=False) -> bool:
    parts = file_path.relative_to(project_root).parts
    if light and not any(part in ["components", "pages", "types", "hooks", "store", "utils", "lib"] for part in parts):
        return False
    return (
            file_path.name in INCLUDE_FILES or
            (parts and parts[0] in INCLUDE_DIRS and file_path.suffix in INCLUDE_EXTENSIONS)
    )


def collect_files(light=False, include_ui=False):
    included = []
    for root, dirs, files in os.walk(project_root):
        dirs[:] = [d for d in dirs if d not in EXCLUDE_DIRS]
        for file in files:
            path = Path(root) / file
            rel_path = path.relative_to(project_root)
            if any(part in EXCLUDE_DIRS for part in rel_path.parts):
                continue
            if is_excluded(path, include_ui=include_ui):
                continue
            if is_included(path, light):
                included.append(path)
    return included


def summarize_structure(grouped, truncation_map):
    lines = ["# ğŸ“ Ğ¡Ñ‚Ñ€ÑƒĞºÑ‚ÑƒÑ€Ğ° Ğ¿Ñ€Ğ¾ĞµĞºÑ‚Ğ°"]
    for folder in sorted(grouped):
        lines.append(f"\n### `{folder}`")
        for file in sorted(grouped[folder], key=lambda x: str(x)):
            rel = file.relative_to(project_root)
            icon = "âš ï¸" if truncation_map.get(str(rel)) else "âœ…"
            star = "â­" if rel.name in IMPORTANT_FILES else ""
            lines.append(f"- {star} {icon} `{rel}`")
    return "\n".join(lines)


def estimate_size(content: str) -> int:
    return len(content.encode('utf-8')) // 1024  # Ğ Ğ°Ğ·Ğ¼ĞµÑ€ Ğ² KB


def write_output(included):
    truncation_map = {}
    grouped = defaultdict(list)
    for file in included:
        grouped[str(file.relative_to(project_root).parent)].append(file)

    content_parts = []
    current_size = 0

    content_parts.append("# ğŸ¤– Ğ¡Ğ¶Ğ°Ñ‚Ñ‹Ğ¹ Ğ¸ÑÑ…Ğ¾Ğ´Ğ½Ñ‹Ğ¹ ĞºĞ¾Ğ´ Ñ„Ñ€Ğ¾Ğ½Ñ‚ĞµĞ½Ğ´Ğ° Ğ´Ğ»Ñ AI-Ğ¿Ğ¾Ğ¼Ğ¾Ñ‰Ğ½Ğ¸ĞºĞ°\n\n")

    content_parts.append("## ğŸ”— Ğ‘Ñ‹ÑÑ‚Ñ€Ğ°Ñ Ğ½Ğ°Ğ²Ğ¸Ğ³Ğ°Ñ†Ğ¸Ñ Ğ¿Ğ¾ Ñ„Ğ°Ğ¹Ğ»Ğ°Ğ¼\n")
    for path in sorted(included, key=lambda p: str(p.relative_to(project_root))):
        rel_path = path.relative_to(project_root)
        anchor = str(rel_path).replace("/", "").replace(".", "").replace("\\", "")
        content_parts.append(f"- [{rel_path}](#{anchor})\n")
    content_parts.append("\n---\n\n")

    structure = summarize_structure(grouped, truncation_map)
    content_parts.append(structure)
    content_parts.append("\n\n---\n")

    # Ğ¡Ğ¾Ñ€Ñ‚Ğ¸Ñ€ÑƒĞµĞ¼ Ñ„Ğ°Ğ¹Ğ»Ñ‹: ÑĞ½Ğ°Ñ‡Ğ°Ğ»Ğ° Ğ²Ğ°Ğ¶Ğ½Ñ‹Ğµ, Ğ¿Ğ¾Ñ‚Ğ¾Ğ¼ Ğ¾ÑÑ‚Ğ°Ğ»ÑŒĞ½Ñ‹Ğµ
    sorted_included = sorted(
        included,
        key=lambda p: (0 if p.name in IMPORTANT_FILES else 1, str(p.relative_to(project_root)))
    )

    for path in sorted_included:
        rel_path = path.relative_to(project_root)
        ext = path.suffix
        block = [f"\n\n## `{rel_path}`\n\n"]
        block.append("```python\n" if ext == ".py" else "```html\n")

        try:
            lines = path.read_text(encoding="utf-8").splitlines()
            if len(lines) > MAX_LINES:
                truncation_map[str(rel_path)] = True
                block.extend(lines[:TRUNCATE_LINES])
                block.append(f"# ... truncated ({len(lines)} lines total)")
                block.append("# âš ï¸ ĞŸĞ¾Ğ»Ğ½Ñ‹Ğ¹ ĞºĞ¾Ğ´ Ğ´Ğ¾ÑÑ‚ÑƒĞ¿ĞµĞ½ Ğ² Ğ¾Ñ€Ğ¸Ğ³Ğ¸Ğ½Ğ°Ğ»ÑŒĞ½Ğ¾Ğ¼ Ñ„Ğ°Ğ¹Ğ»Ğµ")
            else:
                block.extend(lines)
        except Exception as e:
            block.append(f"# ĞÑˆĞ¸Ğ±ĞºĞ° Ñ‡Ñ‚ĞµĞ½Ğ¸Ñ Ñ„Ğ°Ğ¹Ğ»Ğ°: {e}")
        block.append("\n```\n")

        new_block = "\n".join(block)
        block_size = estimate_size(new_block)
        if current_size + block_size > MAX_TOTAL_SIZE_KB:
            content_parts.append("\n\n# âš ï¸ Ğ¤Ğ°Ğ¹Ğ» ÑƒÑĞµÑ‡ĞµĞ½: Ğ¿Ñ€ĞµĞ²Ñ‹ÑˆĞµĞ½ Ğ»Ğ¸Ğ¼Ğ¸Ñ‚ Ñ€Ğ°Ğ·Ğ¼ĞµÑ€Ğ°. Ğ˜ÑĞºĞ»ÑÑ‡ĞµĞ½Ñ‹ Ğ¼ĞµĞ½ĞµĞµ ĞºÑ€Ğ¸Ñ‚Ğ¸Ñ‡Ğ½Ñ‹Ğµ Ñ„Ğ°Ğ¹Ğ»Ñ‹.\n")
            break  # ĞŸÑ€ĞµĞºÑ€Ğ°Ñ‰Ğ°ĞµĞ¼ Ğ´Ğ¾Ğ±Ğ°Ğ²Ğ»ĞµĞ½Ğ¸Ğµ, ĞµÑĞ»Ğ¸ Ğ¿Ñ€ĞµĞ²Ñ‹ÑˆĞµĞ½ Ğ»Ğ¸Ğ¼Ğ¸Ñ‚
        content_parts.append(new_block)
        current_size += block_size

    pkg_path = project_root / "package.json"
    if pkg_path.exists():
        try:
            deps = json.loads(pkg_path.read_text(encoding="utf-8")).get("dependencies", {})
            content_parts.append("\n\n## ğŸ“¦ Ğ—Ğ°Ğ²Ğ¸ÑĞ¸Ğ¼Ğ¾ÑÑ‚Ğ¸ Ğ¿Ñ€Ğ¾ĞµĞºÑ‚Ğ°\n\n")
            for name, version in sorted(deps.items()):
                content_parts.append(f"- `{name}`: {version}\n")
        except Exception as e:
            content_parts.append(f"\n\n## ĞÑˆĞ¸Ğ±ĞºĞ° Ñ‡Ñ‚ĞµĞ½Ğ¸Ñ package.json: {e}\n")

    full_content = "".join(content_parts)
    with open(output_filename, "w", encoding="utf-8") as out:
        out.write(full_content)


def main():
    parser = argparse.ArgumentParser()
    parser.add_argument("--no-light", action="store_true", help="ĞÑ‚ĞºĞ»ÑÑ‡Ğ¸Ñ‚ÑŒ light Ñ€ĞµĞ¶Ğ¸Ğ¼ (ÑĞ¾Ğ±Ñ€Ğ°Ñ‚ÑŒ Ğ²ÑĞµ Ñ„Ğ°Ğ¹Ğ»Ñ‹ Ğ²Ğ¼ĞµÑÑ‚Ğ¾ ĞºĞ»ÑÑ‡ĞµĞ²Ñ‹Ñ…)")
    parser.add_argument("--include-ui", action="store_true", help="Ğ’ĞºĞ»ÑÑ‡Ğ¸Ñ‚ÑŒ ĞºĞ¾Ğ¼Ğ¿Ğ¾Ğ½ĞµĞ½Ñ‚Ñ‹ Ğ¸Ğ· src/components/ui")
    args = parser.parse_args()
    light = not args.no_light  # ĞŸĞ¾ ÑƒĞ¼Ğ¾Ğ»Ñ‡Ğ°Ğ½Ğ¸Ñ light=True, --no-light Ğ¾Ñ‚ĞºĞ»ÑÑ‡Ğ°ĞµÑ‚
    included_files = collect_files(light=light, include_ui=args.include_ui)
    write_output(included_files)

    readme_path = project_root / "README_AI.md"
    with open(readme_path, "w", encoding="utf-8") as readme:
        readme.write("# ğŸ“˜ Ğ˜Ğ½ÑÑ‚Ñ€ÑƒĞºÑ†Ğ¸Ñ Ğ´Ğ»Ñ AI-Ğ¿Ğ¾Ğ¼Ğ¾Ñ‰Ğ½Ğ¸ĞºĞ°\n\n")
        readme.write("Ğ­Ñ‚Ğ¾Ñ‚ Ğ¿Ñ€Ğ¾ĞµĞºÑ‚ ÑĞ¾Ğ±Ñ€Ğ°Ğ½ ÑĞºÑ€Ğ¸Ğ¿Ñ‚Ğ¾Ğ¼ `split_optimized.py` Ğ´Ğ»Ñ Ğ°Ğ½Ğ°Ğ»Ğ¸Ğ·Ğ° Ğ˜Ğ˜.\n\n")
        readme.write("## ğŸ“‚ Ğ¡Ğ¾Ğ´ĞµÑ€Ğ¶Ğ¸Ğ¼Ğ¾Ğµ\n")
        readme.write("- `smart_react_code.md` â€” Ğ¾ÑĞ½Ğ¾Ğ²Ğ½Ğ¾Ğ¹ Ñ„Ğ°Ğ¹Ğ» Ñ ĞºĞ¾Ğ´Ğ¾Ğ¼\n")
        readme.write("- `README_AI.md` â€” ÑÑ‚Ğ° Ğ¸Ğ½ÑÑ‚Ñ€ÑƒĞºÑ†Ğ¸Ñ\n\n")
        readme.write("## ğŸš€ ĞšĞ°Ğº Ğ¸ÑĞ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ÑŒ\n")
        readme.write("ĞŸĞµÑ€ĞµĞ´Ğ°Ğ¹ `smart_react_code.md` Ğ² AI-Ğ¿Ğ¾Ğ¼Ğ¾Ñ‰Ğ½Ğ¸Ğº. ĞĞ½ ÑĞ¾Ğ´ĞµÑ€Ğ¶Ğ¸Ñ‚ ÑÑ‚Ñ€ÑƒĞºÑ‚ÑƒÑ€Ñƒ, Ğ¾Ğ³Ğ»Ğ°Ğ²Ğ»ĞµĞ½Ğ¸Ğµ, ĞºĞ»ÑÑ‡ĞµĞ²Ñ‹Ğµ ÑƒÑ‡Ğ°ÑÑ‚ĞºĞ¸ ĞºĞ¾Ğ´Ğ°.\n")
        readme.write("ĞŸĞ¾ ÑƒĞ¼Ğ¾Ğ»Ñ‡Ğ°Ğ½Ğ¸Ñ Ğ¸ÑĞ¿Ğ¾Ğ»ÑŒĞ·ÑƒĞµÑ‚ÑÑ light Ñ€ĞµĞ¶Ğ¸Ğ¼ Ğ´Ğ»Ñ ÑƒĞ¼ĞµĞ½ÑŒÑˆĞµĞ½Ğ¸Ñ Ñ€Ğ°Ğ·Ğ¼ĞµÑ€Ğ° (Ñ‚Ğ¾Ğ»ÑŒĞºĞ¾ ĞºĞ»ÑÑ‡ĞµĞ²Ñ‹Ğµ Ğ´Ğ¸Ñ€ĞµĞºÑ‚Ğ¾Ñ€Ğ¸Ğ¸: components, pages, types, hooks, store, utils, lib). Ğ§Ñ‚Ğ¾Ğ±Ñ‹ ÑĞ¾Ğ±Ñ€Ğ°Ñ‚ÑŒ Ğ²ÑĞµ Ñ„Ğ°Ğ¹Ğ»Ñ‹, Ğ¸ÑĞ¿Ğ¾Ğ»ÑŒĞ·ÑƒĞ¹Ñ‚Ğµ --no-light.\n")
        readme.write("UI-ĞºĞ¾Ğ¼Ğ¿Ğ¾Ğ½ĞµĞ½Ñ‚Ñ‹ (`src/components/ui`) Ğ¸ÑĞºĞ»ÑÑ‡ĞµĞ½Ñ‹, Ğ²ĞºĞ»ÑÑ‡Ğ¸ Ğ¸Ñ… Ñ„Ğ»Ğ°Ğ³Ğ¾Ğ¼ `--include-ui` Ğ¿Ñ€Ğ¸ Ğ½ĞµĞ¾Ğ±Ñ…Ğ¾Ğ´Ğ¸Ğ¼Ğ¾ÑÑ‚Ğ¸.\n")
        readme.write("ĞœĞ°ĞºÑĞ¸Ğ¼Ğ°Ğ»ÑŒĞ½Ñ‹Ğ¹ Ñ€Ğ°Ğ·Ğ¼ĞµÑ€ Ñ„Ğ°Ğ¹Ğ»Ğ° Ğ¾Ğ³Ñ€Ğ°Ğ½Ğ¸Ñ‡ĞµĞ½ ~200KB Ğ´Ğ»Ñ ĞºĞ¾Ğ¼Ñ„Ğ¾Ñ€Ñ‚Ğ½Ğ¾Ğ¹ Ñ€Ğ°Ğ±Ğ¾Ñ‚Ñ‹ Ñ ĞºĞ¾Ğ½Ñ‚ĞµĞºÑÑ‚Ğ¾Ğ¼ AI.\n")

    print(f"âœ… Ğ¤Ğ°Ğ¹Ğ» '{output_filename.name}' Ğ¸ README_AI.md ÑƒÑĞ¿ĞµÑˆĞ½Ğ¾ ÑĞ¾Ğ·Ğ´Ğ°Ğ½Ñ‹.")


if __name__ == "__main__":
    main()

```


## <a name="rentalappmainsrcappApptsx"></a>`rental-app-main/src/app/App.tsx`

```tsx
// path: rental-app-main/src/app/App.tsx

// src/app/App.tsx

import { Routes, Route } from "react-router-dom";
import HomePage from "../pages/HomePage";
import ReservePage from "../pages/ReservePage";
import ProfilePage from "../pages/ProfilePage";
import MyReservationsPage from "../pages/MyReservationsPage";
import ContactPage from "../pages/ContactPage";
import CalendarPage from "../pages/CalendarPage";
import RequireAuth from "../components/RequireAuth";
import { Toaster } from "sonner"; // <--- 1. Ğ”ĞĞ‘ĞĞ’Ğ¬Ğ¢Ğ• Ğ­Ğ¢ĞĞ¢ Ğ˜ĞœĞŸĞĞ Ğ¢

// Ğ˜Ğ¼Ğ¿Ğ¾Ñ€Ñ‚Ñ‹ Ğ´Ğ»Ñ Ğ°Ğ´Ğ¼Ğ¸Ğ½ Ğ¿Ğ°Ğ½ĞµĞ»Ğ¸
import DashboardPage from "../pages/admin/DashboardPage";
import UserManagementPage from "../pages/UserManagementPage";
import EquipmentManagementPage from "../pages/EquipmentManagementPage";
import AccessoryManagementPage from "../pages/AccessoryManagementPage";
import AllReservationsManagementPage from "../pages/admin/AllReservationsManagementPage";
import PromoCodeManagementPage from "../pages/admin/PromoCodeManagementPage";
import CalendarTestPage from "../pages/CalendarTestPage";
import HolidayManagementPage from "../pages/admin/HolidayManagementPage";
import AssociationManagementPage from "../pages/admin/AssociationManagementPage";
import RentalManagementPage from "../pages/admin/RentalManagementPage";


function App() {
    return (
        // +++ 2. ĞĞ‘Ğ•Ğ ĞĞ˜Ğ¢Ğ• Ğ’Ğ¡Ğ• Ğ’ Ğ¤Ğ ĞĞ“ĞœĞ•ĞĞ¢ Ğ˜ Ğ”ĞĞ‘ĞĞ’Ğ¬Ğ¢Ğ• TOASTER +++
        <>
            <Routes>
                {/* ĞÑĞ½Ğ¾Ğ²Ğ½Ñ‹Ğµ Ğ¼Ğ°Ñ€ÑˆÑ€ÑƒÑ‚Ñ‹ */}
                <Route path="/test-calendar" element={<CalendarTestPage />} />
                <Route path="/" element={<HomePage />} />
                <Route path="/reserve/create" element={<ReservePage />} />
                <Route path="/contacts" element={<ContactPage />} />
                <Route path="/calendar" element={<CalendarPage />} />

                {/* ĞœĞ°Ñ€ÑˆÑ€ÑƒÑ‚Ñ‹, Ñ‚Ñ€ĞµĞ±ÑƒÑÑ‰Ğ¸Ğµ Ğ°Ğ²Ñ‚Ğ¾Ñ€Ğ¸Ğ·Ğ°Ñ†Ğ¸Ğ¸ */}
                <Route
                    path="/profile"
                    element={
                        <RequireAuth>
                            <ProfilePage />
                        </RequireAuth>
                    }
                />
                <Route
                    path="/reservations/my"
                    element={
                        <RequireAuth>
                            <MyReservationsPage />
                        </RequireAuth>
                    }
                />

                {/* ĞœĞ°Ñ€ÑˆÑ€ÑƒÑ‚Ñ‹ Ğ°Ğ´Ğ¼Ğ¸Ğ½-Ğ¿Ğ°Ğ½ĞµĞ»Ğ¸ */}
                <Route
                    path="/admin"
                    element={
                        <RequireAuth role={["manager", "admin"]}>
                            <DashboardPage />
                        </RequireAuth>
                    }
                />
                <Route
                    path="/admin/rentals"
                    element={
                        <RequireAuth role={["manager", "admin"]}>
                            <RentalManagementPage />
                        </RequireAuth>
                    }
                />
                <Route
                    path="/admin/users"
                    element={
                        <RequireAuth role={["manager", "admin"]}>
                            <UserManagementPage />
                        </RequireAuth>
                    }
                />
                <Route
                    path="/admin/equipment"
                    element={
                        <RequireAuth role={["manager", "admin"]}>
                            <EquipmentManagementPage />
                        </RequireAuth>
                    }
                />
                <Route
                    path="/admin/accessories"
                    element={
                        <RequireAuth role={["manager", "admin"]}>
                            <AccessoryManagementPage />
                        </RequireAuth>
                    }
                />
                <Route
                    path="/admin/reservations"
                    element={
                        <RequireAuth role={["manager", "admin"]}>
                            <AllReservationsManagementPage />
                        </RequireAuth>
                    }
                />
                <Route
                    path="/admin/promocodes"
                    element={
                        <RequireAuth role={["manager", "admin"]}>
                            <PromoCodeManagementPage />
                        </RequireAuth>
                    }
                />
                <Route
                    path="/admin/holidays"
                    element={
                        <RequireAuth role={["admin"]}>
                            <HolidayManagementPage />
                        </RequireAuth>
                    }
                />
                <Route
                    path="/admin/associations"
                    element={
                        <RequireAuth role={["manager", "admin"]}>
                            <AssociationManagementPage />
                        </RequireAuth>
                    }
                />

            </Routes>
            <Toaster richColors position="top-right" />
        </>
    );
}

export default App;

```


## <a name="rentalappmainsrcassetsreactsvg"></a>`rental-app-main/src/assets/react.svg`

```
[Ğ¡Ğ¾Ğ´ĞµÑ€Ğ¶Ğ¸Ğ¼Ğ¾Ğµ SVG Ñ„Ğ°Ğ¹Ğ»Ğ° 'react.svg' Ğ½Ğµ Ğ²ĞºĞ»ÑÑ‡ĞµĞ½Ğ¾ Ğ´Ğ»Ñ ÑĞºĞ¾Ğ½Ğ¾Ğ¼Ğ¸Ğ¸ Ğ¼ĞµÑÑ‚Ğ°]
```


## <a name="rentalappmainsrccomponentsAssociationFiltertsx"></a>`rental-app-main/src/components/AssociationFilter.tsx`

```tsx
// path: rental-app-main/src/components/AssociationFilter.tsx

// src/components/AssociationFilter.tsx

import { useMemo } from "react"; // <--- Ğ”ĞĞ‘ĞĞ’Ğ˜Ğ¢Ğ¬ Ğ˜ĞœĞŸĞĞ Ğ¢
import { ToggleGroup, ToggleGroupItem } from "@/components/ui/toggle-group";
import { useFilterStore } from "@/store/filterStore";
import { useAssociations } from "@/hooks/useAssociations";
import { getFilterToggleClass } from "@/components/ui/filter-toggle";
import { Tags, List } from "lucide-react";

export default function AssociationFilter() {
    const { associationId, setAssociationId } = useFilterStore();
    const { data: allAssociations = [], isLoading } = useAssociations();

    // +++ ĞĞĞ§ĞĞ›Ğ Ğ˜Ğ—ĞœĞ•ĞĞ•ĞĞ˜Ğ™ +++
    // Ğ¤Ğ¸Ğ»ÑŒÑ‚Ñ€ÑƒĞµĞ¼ Ğ°ÑÑĞ¾Ñ†Ğ¸Ğ°Ñ†Ğ¸Ğ¸, Ğ¾ÑÑ‚Ğ°Ğ²Ğ»ÑÑ Ñ‚Ğ¾Ğ»ÑŒĞºĞ¾ Ñ‚Ğµ, Ğº ĞºĞ¾Ñ‚Ğ¾Ñ€Ñ‹Ğ¼ Ğ¿Ñ€Ğ¸Ğ²ÑĞ·Ğ°Ğ½Ğ¾ Ğ¾Ğ±Ğ¾Ñ€ÑƒĞ´Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ
    const associationsWithEquipment = useMemo(() => {
        return allAssociations.filter(assoc => assoc.equipment_ids && assoc.equipment_ids.length > 0);
    }, [allAssociations]);

    // Ğ¢ĞµĞ¿ĞµÑ€ÑŒ Ğ¿Ñ€Ğ¾Ğ²ĞµÑ€ÑĞµĞ¼ Ğ¾Ñ‚Ñ„Ğ¸Ğ»ÑŒÑ‚Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ½Ñ‹Ğ¹ ÑĞ¿Ğ¸ÑĞ¾Ğº
    if (isLoading || associationsWithEquipment.length === 0) {
        return null; // ĞĞµ Ñ€ĞµĞ½Ğ´ĞµÑ€Ğ¸Ğ¼ Ğ½Ğ¸Ñ‡ĞµĞ³Ğ¾, ĞµÑĞ»Ğ¸ Ğ´Ğ°Ğ½Ğ½Ñ‹Ñ… Ğ½ĞµÑ‚ Ğ¸Ğ»Ğ¸ Ğ²ÑĞµ Ğ°ÑÑĞ¾Ñ†Ğ¸Ğ°Ñ†Ğ¸Ğ¸ "Ğ¿ÑƒÑÑ‚Ñ‹Ğµ"
    }
    // +++ ĞšĞĞĞ•Ğ¦ Ğ˜Ğ—ĞœĞ•ĞĞ•ĞĞ˜Ğ™ +++

    return (
        <ToggleGroup
            type="single"
            value={associationId?.toString() ?? "__all__"}
            onValueChange={(val: string) => setAssociationId(val === "__all__" ? null : Number(val))}
            className="flex flex-wrap gap-2"
        >
            <ToggleGroupItem value="__all__" className={getFilterToggleClass("green")}>
                <List />
                Ğ’ÑĞµ Ğ¿Ğ¾Ğ´Ğ±Ğ¾Ñ€ĞºĞ¸
            </ToggleGroupItem>

            {/* Ğ˜ÑĞ¿Ğ¾Ğ»ÑŒĞ·ÑƒĞµĞ¼ Ğ¾Ñ‚Ñ„Ğ¸Ğ»ÑŒÑ‚Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ½Ñ‹Ğ¹ ÑĞ¿Ğ¸ÑĞ¾Ğº Ğ´Ğ»Ñ Ñ€ĞµĞ½Ğ´ĞµÑ€Ğ¸Ğ½Ğ³Ğ° */}
            {associationsWithEquipment.map((assoc) => (
                <ToggleGroupItem
                    key={assoc.id}
                    value={assoc.id.toString()}
                    className={getFilterToggleClass("green")}
                >
                    <Tags className="h-4 w-4" />
                    {assoc.name}
                </ToggleGroupItem>
            ))}
        </ToggleGroup>
    );
}


```


## <a name="rentalappmainsrccomponentsAuthFormtsx"></a>`rental-app-main/src/components/AuthForm.tsx`

```tsx
// path: rental-app-main/src/components/AuthForm.tsx

// src/components/AuthForm.tsx

import { useState } from "react";
import { useForm, Controller } from "react-hook-form";
import { zodResolver } from "@hookform/resolvers/zod";
import { authSchema, AuthSchema } from "@/lib/validationSchemas";
import { useAuthStore } from "@/store/authStore";
import { Input } from "@/components/ui/input";
import { Button } from "@/components/ui/button";
import { Checkbox } from "@/components/ui/checkbox";
import { Label } from "@/components/ui/label";
import { PhoneInput } from "@/components/ui/phone-input";
import { Eye, EyeOff, Mail, Lock, User, LogIn, UserPlus, Phone, Calendar } from "lucide-react"; // <<< Ğ˜Ğ—ĞœĞ•ĞĞ•ĞĞ˜Ğ•: Ğ”Ğ¾Ğ±Ğ°Ğ²Ğ»ĞµĞ½Ğ° Ğ¸ĞºĞ¾Ğ½ĞºĞ° Calendar
import { useNavigate } from "react-router-dom"; // <<< Ğ˜Ğ—ĞœĞ•ĞĞ•ĞĞ˜Ğ•: Ğ”Ğ¾Ğ±Ğ°Ğ²Ğ»ĞµĞ½ useNavigate

export default function AuthForm() {
    const { login, register: registerUser, error, loading } = useAuthStore();
    const [isRegister, setIsRegister] = useState(false);
    const [showPassword, setShowPassword] = useState(false);
    const [phoneError, setPhoneError] = useState("");
    const [emailError, setEmailError] = useState("");
    const navigate = useNavigate(); // <<< Ğ˜Ğ—ĞœĞ•ĞĞ•ĞĞ˜Ğ•: Ğ˜Ğ½Ğ¸Ñ†Ğ¸Ğ°Ğ»Ğ¸Ğ·Ğ¸Ñ€ÑƒĞµĞ¼ Ñ…ÑƒĞº

    const {
        register: formRegister,
        handleSubmit,
        control,
        formState: { errors, isValid },
        reset
    } = useForm<AuthSchema>({
        resolver: zodResolver(authSchema),
        mode: "onChange",
        defaultValues: {
            privacyPolicyAccepted: false,
            termsAccepted: false,
        }
    });

    const onSubmit = async (data: AuthSchema) => {
        try {
            if (isRegister) {
                if (!data.privacyPolicyAccepted || !data.termsAccepted) {
                    // Ğ­Ñ‚Ğ° Ğ¿Ñ€Ğ¾Ğ²ĞµÑ€ĞºĞ° Ğ¾ÑÑ‚Ğ°ĞµÑ‚ÑÑ Ğ½Ğ° ÑĞ»ÑƒÑ‡Ğ°Ğ¹, ĞµÑĞ»Ğ¸ Zod Ğ¿Ğ¾ ĞºĞ°ĞºĞ¾Ğ¹-Ñ‚Ğ¾ Ğ¿Ñ€Ğ¸Ñ‡Ğ¸Ğ½Ğµ Ğ±ÑƒĞ´ĞµÑ‚ Ğ¾Ğ±Ğ¾Ğ¹Ğ´ĞµĞ½
                    throw new Error("ĞĞµĞ¾Ğ±Ñ…Ğ¾Ğ´Ğ¸Ğ¼Ğ¾ Ğ¿Ñ€Ğ¸Ğ½ÑÑ‚ÑŒ ÑƒÑĞ»Ğ¾Ğ²Ğ¸Ñ Ğ¸ÑĞ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ Ğ¸ Ğ¿Ğ¾Ğ»Ğ¸Ñ‚Ğ¸ĞºÑƒ ĞºĞ¾Ğ½Ñ„Ğ¸Ğ´ĞµĞ½Ñ†Ğ¸Ğ°Ğ»ÑŒĞ½Ğ¾ÑÑ‚Ğ¸.");
                }
                await registerUser({
                    email: data.email,
                    password: data.password,
                    full_name: data.fullName ?? "",
                    phone: data.phone,
                    privacy_policy_accepted: data.privacyPolicyAccepted,
                    terms_accepted: data.termsAccepted,
                });
            } else {
                await login(data.email, data.password);
            }
            reset();
        } catch (err) {
            // ĞÑˆĞ¸Ğ±ĞºĞ¸ Ğ¾Ğ±Ñ€Ğ°Ğ±Ğ°Ñ‚Ñ‹Ğ²Ğ°ÑÑ‚ÑÑ Ğ² zustand
            console.error("Auth error:", err);
        }
    };

    const validatePhoneRealTime = (value: string) => {
        if (!value) { setPhoneError(""); return; }
        // ĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑĞµĞ¼, Ñ‡Ñ‚Ğ¾ Ğ½Ğ¾Ğ¼ĞµÑ€ ÑĞ¾Ğ¾Ñ‚Ğ²ĞµÑ‚ÑÑ‚Ğ²ÑƒĞµÑ‚ Ğ¼Ğ°ÑĞºĞµ +7 (XXX) XXX-XX-XX
        const phoneRegex = /^\+7 \(\d{3}\) \d{3}-\d{2}-\d{2}$/;
        setPhoneError(phoneRegex.test(value) ? "" : "Ğ’Ğ²ĞµĞ´Ğ¸Ñ‚Ğµ Ğ¿Ğ¾Ğ»Ğ½Ñ‹Ğ¹ Ğ½Ğ¾Ğ¼ĞµÑ€ Ñ‚ĞµĞ»ĞµÑ„Ğ¾Ğ½Ğ°");
    };

    const validateEmailRealTime = (value: string) => {
        if (!value) { setEmailError(""); return; }
        const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
        setEmailError(emailRegex.test(value) ? "" : "Ğ’Ğ²ĞµĞ´Ğ¸Ñ‚Ğµ ĞºĞ¾Ñ€Ñ€ĞµĞºÑ‚Ğ½Ñ‹Ğ¹ email");
    };

    const toggleMode = () => {
        setIsRegister(!isRegister);
        reset({
            email: '', password: '', fullName: '', phone: '',
            privacyPolicyAccepted: false, termsAccepted: false,
        });
        setPhoneError("");
        setEmailError("");
    };

    const registrationFields = (
        <>
            <div className="grid grid-cols-1 sm:grid-cols-2 gap-4">
                <div>
                    <Label htmlFor="fullName">Ğ¤Ğ˜Ğ *</Label>
                    <div className="relative">
                        <User className="absolute left-3 top-1/2 -translate-y-1/2 h-4 w-4 text-gray-400" />
                        <Input id="fullName" {...formRegister("fullName")} placeholder="Ğ˜Ğ²Ğ°Ğ½ Ğ˜Ğ²Ğ°Ğ½Ğ¾Ğ²" className="pl-9" />
                    </div>
                    {errors.fullName && <p className="text-xs text-red-600 mt-1">{errors.fullName.message}</p>}
                </div>
                <div>
                    <Label htmlFor="phone">Ğ¢ĞµĞ»ĞµÑ„Ğ¾Ğ½</Label>
                    <div className="relative">
                        <Phone className="absolute left-3 top-1/2 -translate-y-1/2 h-4 w-4 text-gray-400" />
                        <Controller
                            control={control}
                            name="phone"
                            render={({ field }) => (
                                <PhoneInput
                                    id="phone"
                                    {...field}
                                    placeholder="+7 (___) ___-__-__"
                                    className="pl-9"
                                    error={!!phoneError}
                                    onChange={(e) => {
                                        field.onChange(e);
                                        validatePhoneRealTime(e.target.value);
                                    }}
                                />
                            )}
                        />
                    </div>
                    {(errors.phone || phoneError) && <p className="text-xs text-red-600 mt-1">{phoneError || errors.phone?.message}</p>}
                </div>
            </div>

            <div className="grid grid-cols-1 sm:grid-cols-2 gap-4">
                <div>
                    <Label htmlFor="emailReg">Email *</Label>
                    <div className="relative">
                        <Mail className="absolute left-3 top-1/2 -translate-y-1/2 h-4 w-4 text-gray-400" />
                        <Input
                            id="emailReg" type="email" {...formRegister("email")}
                            placeholder="your@email.com" className="pl-9"
                            onChange={(e) => {
                                formRegister("email").onChange(e);
                                validateEmailRealTime(e.target.value);
                            }}
                        />
                    </div>
                    {(errors.email || emailError) && <p className="text-xs text-red-600 mt-1">{emailError || errors.email?.message}</p>}
                </div>
                <div>
                    <Label htmlFor="passwordReg">ĞŸĞ°Ñ€Ğ¾Ğ»ÑŒ *</Label>
                    <div className="relative">
                        <Lock className="absolute left-3 top-1/2 -translate-y-1/2 h-4 w-4 text-gray-400" />
                        <Input id="passwordReg" type={showPassword ? "text" : "password"} {...formRegister("password")} placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢" className="pl-9 pr-10" />
                        <Button type="button" variant="ghost" size="icon" className="absolute right-1 top-1/2 -translate-y-1/2 h-8 w-8" onClick={() => setShowPassword(p => !p)}>
                            {showPassword ? <EyeOff className="h-4 w-4" /> : <Eye className="h-4 w-4" />}
                        </Button>
                    </div>
                    {errors.password && <p className="text-xs text-red-600 mt-1">{errors.password.message}</p>}
                </div>
            </div>

            <div className="space-y-3 pt-2">
                <Controller
                    control={control}
                    name="privacyPolicyAccepted"
                    render={({ field }) => (
                        <div className="flex items-start space-x-2">
                            <Checkbox id="privacy" checked={field.value} onCheckedChange={field.onChange} />
                            <div className="grid gap-1.5 leading-none">
                                <Label htmlFor="privacy" className="text-sm font-normal cursor-pointer">
                                    Ğ¯ ÑĞ¾Ğ³Ğ»Ğ°ÑĞµĞ½ Ñ <a href="#" onClick={(e) => e.preventDefault()} className="text-sky-600 hover:underline">Ğ¿Ğ¾Ğ»Ğ¸Ñ‚Ğ¸ĞºĞ¾Ğ¹ Ğ¾Ğ±Ñ€Ğ°Ğ±Ğ¾Ñ‚ĞºĞ¸ Ğ¿ĞµÑ€ÑĞ¾Ğ½Ğ°Ğ»ÑŒĞ½Ñ‹Ñ… Ğ´Ğ°Ğ½Ğ½Ñ‹Ñ…</a> *
                                </Label>
                                {errors.privacyPolicyAccepted && <p className="text-xs text-red-600">{errors.privacyPolicyAccepted.message}</p>}
                            </div>
                        </div>
                    )}
                />
                <Controller
                    control={control}
                    name="termsAccepted"
                    render={({ field }) => (
                        <div className="flex items-start space-x-2">
                            <Checkbox id="terms" checked={field.value} onCheckedChange={field.onChange} />
                            <div className="grid gap-1.5 leading-none">
                                <Label htmlFor="terms" className="text-sm font-normal cursor-pointer">
                                    Ğ¯ Ğ¿Ñ€Ğ¸Ğ½Ğ¸Ğ¼Ğ°Ñ <a href="#" onClick={(e) => e.preventDefault()} className="text-sky-600 hover:underline">ÑƒÑĞ»Ğ¾Ğ²Ğ¸Ñ Ğ¸ÑĞ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ ÑĞµÑ€Ğ²Ğ¸ÑĞ°</a> *
                                </Label>
                                {errors.termsAccepted && <p className="text-xs text-red-600">{errors.termsAccepted.message}</p>}
                            </div>
                        </div>
                    )}
                />
            </div>
        </>
    );

    const loginFields = (
        <div className="grid grid-cols-1 sm:grid-cols-2 gap-4">
            <div>
                <Label htmlFor="emailLogin">Email</Label>
                <div className="relative">
                    <Mail className="absolute left-3 top-1/2 -translate-y-1/2 h-4 w-4 text-gray-400" />
                    <Input
                        id="emailLogin" type="email" {...formRegister("email")}
                        placeholder="your@email.com" className="pl-9"
                        onChange={(e) => {
                            formRegister("email").onChange(e);
                            validateEmailRealTime(e.target.value);
                        }}
                    />
                </div>
                {(errors.email || emailError) && <p className="text-xs text-red-600 mt-1">{emailError || errors.email?.message}</p>}
            </div>
            <div>
                <Label htmlFor="passwordLogin">ĞŸĞ°Ñ€Ğ¾Ğ»ÑŒ</Label>
                <div className="relative">
                    <Lock className="absolute left-3 top-1/2 -translate-y-1/2 h-4 w-4 text-gray-400" />
                    <Input id="passwordLogin" type={showPassword ? "text" : "password"} {...formRegister("password")} placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢" className="pl-9 pr-10" />
                    <Button type="button" variant="ghost" size="icon" className="absolute right-1 top-1/2 -translate-y-1/2 h-8 w-8" onClick={() => setShowPassword(p => !p)}>
                        {showPassword ? <EyeOff className="h-4 w-4" /> : <Eye className="h-4 w-4" />}
                    </Button>
                </div>
                {errors.password && <p className="text-xs text-red-600 mt-1">{errors.password.message}</p>}
            </div>
        </div>
    );

    return (
        <div className="w-full">
            <form onSubmit={handleSubmit(onSubmit)} className="bg-white border border-gray-200 rounded-lg shadow-sm p-6 space-y-6">
                <h2 className="text-xl font-semibold text-center">{isRegister ? "Ğ ĞµĞ³Ğ¸ÑÑ‚Ñ€Ğ°Ñ†Ğ¸Ñ" : "Ğ’Ñ…Ğ¾Ğ´ Ğ² Ğ°ĞºĞºĞ°ÑƒĞ½Ñ‚"}</h2>

                {isRegister ? registrationFields : loginFields}

                {error && (
                    <div className="p-3 bg-red-50 border border-red-200 rounded text-sm text-red-600">
                        {error}
                    </div>
                )}

                {/* +++ ĞĞĞ§ĞĞ›Ğ: Ğ˜Ğ·Ğ¼ĞµĞ½ĞµĞ½Ğ½Ñ‹Ğ¹ Ğ±Ğ»Ğ¾Ğº ĞºĞ½Ğ¾Ğ¿Ğ¾Ğº +++ */}
                <div className="pt-4 border-t space-y-4">
                    <Button type="submit" disabled={!isValid || loading} className="w-full">
                        {loading ? "Ğ—Ğ°Ğ³Ñ€ÑƒĞ·ĞºĞ°..." : (isRegister ? <><UserPlus className="mr-2 h-4 w-4" />Ğ—Ğ°Ñ€ĞµĞ³Ğ¸ÑÑ‚Ñ€Ğ¸Ñ€Ğ¾Ğ²Ğ°Ñ‚ÑŒÑÑ</> : <><LogIn className="mr-2 h-4 w-4" />Ğ’Ğ¾Ğ¹Ñ‚Ğ¸</>)}
                    </Button>
                    <div className="flex justify-center items-center gap-4 text-sm">
                        <Button
                            type="button"
                            variant="outline"
                            size="sm"
                            onClick={() => navigate("/calendar")}
                        >
                            <Calendar className="mr-2 h-4 w-4" />
                            ĞšĞ°Ğ»ĞµĞ½Ğ´Ğ°Ñ€ÑŒ
                        </Button>
                        <Button type="button" variant="link" onClick={toggleMode} className="text-gray-600">
                            {isRegister ? "Ğ£Ğ¶Ğµ ĞµÑÑ‚ÑŒ Ğ°ĞºĞºĞ°ÑƒĞ½Ñ‚? Ğ’Ğ¾Ğ¹Ñ‚Ğ¸" : "ĞĞµÑ‚ Ğ°ĞºĞºĞ°ÑƒĞ½Ñ‚Ğ°?"}
                        </Button>
                    </div>
                </div>
                {/* +++ ĞšĞĞĞ•Ğ¦: Ğ˜Ğ·Ğ¼ĞµĞ½ĞµĞ½Ğ½Ñ‹Ğ¹ Ğ±Ğ»Ğ¾Ğº ĞºĞ½Ğ¾Ğ¿Ğ¾Ğº +++ */}
            </form>
        </div>
    );
}

```


## <a name="rentalappmainsrccomponentsAuthStatustsx"></a>`rental-app-main/src/components/AuthStatus.tsx`

```tsx
// path: rental-app-main/src/components/AuthStatus.tsx

import { useCurrentUser } from "@/hooks/useProfile";
import { useAuthStore } from "@/store/authStore";

export default function AuthStatus() {
    const { data: user, isLoading, isError } = useCurrentUser();
    const { logout } = useAuthStore();

    if (isLoading) {
        return (
            <div className="bg-gray-50 border border-gray-200 rounded-md p-2 mb-2">
                <div className="flex items-center justify-center">
                    <div className="animate-spin rounded-full h-3 w-3 border-b-2 border-gray-400 mr-2"></div>
                    <span className="text-xs text-gray-500">ĞŸÑ€Ğ¾Ğ²ĞµÑ€ĞºĞ° Ğ°Ğ²Ñ‚Ğ¾Ñ€Ğ¸Ğ·Ğ°Ñ†Ğ¸Ğ¸...</span>
                </div>
            </div>
        );
    }

    if (isError) {
        return (
            <div className="bg-gray-50 border border-gray-200 rounded-md p-2 mb-2">
                <div className="flex items-center justify-between">
                    <span className="text-xs text-gray-500">ĞÑˆĞ¸Ğ±ĞºĞ° Ğ·Ğ°Ğ³Ñ€ÑƒĞ·ĞºĞ¸ Ğ¿Ñ€Ğ¾Ñ„Ğ¸Ğ»Ñ</span>
                    <button
                        onClick={logout}
                        className="text-xs text-gray-400 hover:text-gray-600 underline"
                    >
                        Ğ’Ñ‹Ğ¹Ñ‚Ğ¸
                    </button>
                </div>
            </div>
        );
    }

    if (!user) {
        return (
            <div className="bg-gray-50 border border-gray-200 rounded-md p-2 mb-2">
                <div className="flex items-center justify-center">
                    <span className="text-xs text-gray-500">Ğ’Ğ¾Ğ¹Ğ´Ğ¸Ñ‚Ğµ Ğ² ÑĞ¸ÑÑ‚ĞµĞ¼Ñƒ Ğ´Ğ»Ñ Ğ´Ğ¾ÑÑ‚ÑƒĞ¿Ğ° Ğº Ğ¿Ğ¾Ğ»Ğ½Ğ¾Ğ¼Ñƒ Ñ„ÑƒĞ½ĞºÑ†Ğ¸Ğ¾Ğ½Ğ°Ğ»Ñƒ</span>
                </div>
            </div>
        );
    }

    return null; // ĞŸĞ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ÑŒ Ğ°Ğ²Ñ‚Ğ¾Ñ€Ğ¸Ğ·Ğ¾Ğ²Ğ°Ğ½, Ğ½Ğ¸Ñ‡ĞµĞ³Ğ¾ Ğ½Ğµ Ğ¿Ğ¾ĞºĞ°Ğ·Ñ‹Ğ²Ğ°ĞµĞ¼
} 

```


## <a name="rentalappmainsrccomponentsAvailabilityStriptsx"></a>`rental-app-main/src/components/AvailabilityStrip.tsx`

```tsx
// path: rental-app-main/src/components/AvailabilityStrip.tsx

// src/components/AvailabilityStrip.tsx

import { useState } from 'react';
import { Popover, PopoverContent, PopoverAnchor } from '@/components/ui/popover';
import { useDateStore } from '@/store/dateStore';
import type { DayStatus } from '@/types/availability';
import { format } from 'date-fns';
import { ru } from 'date-fns/locale';
import { Button } from './ui/button';
import { useHolidayStore } from '@/store/holidayStore';
import { DateService } from '@/core/services/DateService';
import { toast } from 'sonner';

interface AvailabilityStripProps {
    dailyStatus?: Record<string, DayStatus>;
}

const cellColorMap: Record<string, string> = {
    available: 'bg-green-500 hover:bg-green-600',
    reserved: 'bg-yellow-500 hover:bg-yellow-600',
    rented: 'bg-red-500 hover:bg-red-600',
    default: 'bg-gray-400 hover:bg-gray-500'
};

type PopoverData = {
    date: Date;
    status: string;
};

export default function AvailabilityStrip({ dailyStatus = {} }: AvailabilityStripProps) {
    const { setRange } = useDateStore();
    const holidays = useHolidayStore((state) => state.holidays);

    const [isPopoverOpen, setPopoverOpen] = useState(false);
    const [popoverData, setPopoverData] = useState<PopoverData | null>(null);

    const today = new Date();
    today.setHours(0, 0, 0, 0);

    const dates = Array.from({ length: 30 }, (_, i) => {
        const date = new Date();
        date.setDate(today.getDate() + i);
        return date;
    });

    const handleCellClick = (date: Date, status: string) => {
        setPopoverData({ date, status });
        setPopoverOpen(true);
    };

    // +++ ĞĞĞ§ĞĞ›Ğ: ĞĞ‘ĞĞĞ’Ğ›Ğ•ĞĞĞĞ¯ Ğ›ĞĞ“Ğ˜ĞšĞ ĞĞ‘Ğ ĞĞ‘ĞĞ¢Ğ§Ğ˜ĞšĞ +++
    const handleSetAsStartDate = () => {
        if (!popoverData) return;

        const originalStartDate = popoverData.date;

        // 1. ĞĞ²Ñ‚Ğ¾Ğ¼Ğ°Ñ‚Ğ¸Ñ‡ĞµÑĞºĞ¸ ÑĞ´Ğ²Ğ¸Ğ³Ğ°ĞµĞ¼ Ğ´Ğ°Ñ‚Ñƒ, ĞµÑĞ»Ğ¸ Ğ¾Ğ½Ğ° Ğ¿Ğ¾Ğ¿Ğ°Ğ»Ğ° Ğ½Ğ° Ğ²Ñ‹Ñ…Ğ¾Ğ´Ğ½Ğ¾Ğ¹
        const adjustedStartDate = DateService.adjustDateIfHoliday(originalStartDate, holidays);

        // 2. Ğ Ğ°ÑÑÑ‡Ğ¸Ñ‚Ñ‹Ğ²Ğ°ĞµĞ¼ Ğ´Ğ°Ñ‚Ñƒ Ğ¾ĞºĞ¾Ğ½Ñ‡Ğ°Ğ½Ğ¸Ñ Ğ¾Ñ‚ *ÑĞºĞ¾Ñ€Ñ€ĞµĞºÑ‚Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ½Ğ¾Ğ¹* Ğ´Ğ°Ñ‚Ñ‹ Ğ½Ğ°Ñ‡Ğ°Ğ»Ğ°
        const finalEndDate = DateService.findNextWorkingDay(adjustedStartDate, holidays, 1);

        // 3. ĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑĞµĞ¼, Ğ±Ñ‹Ğ»Ğ° Ğ»Ğ¸ Ğ´Ğ°Ñ‚Ğ° Ğ½Ğ°Ñ‡Ğ°Ğ»Ğ° Ğ¸Ğ·Ğ¼ĞµĞ½ĞµĞ½Ğ°
        if (adjustedStartDate.getTime() !== originalStartDate.getTime()) {
            // 4. Ğ•ÑĞ»Ğ¸ Ğ´Ğ° - Ğ¿Ğ¾ĞºĞ°Ğ·Ñ‹Ğ²Ğ°ĞµĞ¼ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ñ ÑƒĞ²ĞµĞ´Ğ¾Ğ¼Ğ»ĞµĞ½Ğ¸Ğµ
            toast.info(`Ğ”Ğ°Ñ‚Ğ° Ğ½Ğ°Ñ‡Ğ°Ğ»Ğ° ÑĞ´Ğ²Ğ¸Ğ½ÑƒÑ‚Ğ° Ñ ${format(originalStartDate, 'dd.MM.yyyy')} Ğ½Ğ° ${format(adjustedStartDate, 'dd.MM.yyyy')}, Ñ‚Ğ°Ğº ĞºĞ°Ğº Ğ²Ñ‹Ğ±Ñ€Ğ°Ğ½Ğ½Ñ‹Ğ¹ Ğ´ĞµĞ½ÑŒ ÑĞ²Ğ»ÑĞµÑ‚ÑÑ Ğ²Ñ‹Ñ…Ğ¾Ğ´Ğ½Ñ‹Ğ¼.`);
        }

        // 5. Ğ£ÑÑ‚Ğ°Ğ½Ğ°Ğ²Ğ»Ğ¸Ğ²Ğ°ĞµĞ¼ Ğ½Ğ¾Ğ²Ñ‹Ğ¹, ĞºĞ¾Ñ€Ñ€ĞµĞºÑ‚Ğ½Ñ‹Ğ¹ Ğ´Ğ¸Ğ°Ğ¿Ğ°Ğ·Ğ¾Ğ½ Ğ´Ğ°Ñ‚
        setRange(adjustedStartDate, finalEndDate);
        setPopoverOpen(false);
    };
    // +++ ĞšĞĞĞ•Ğ¦: ĞĞ‘ĞĞĞ’Ğ›Ğ•ĞĞĞĞ¯ Ğ›ĞĞ“Ğ˜ĞšĞ ĞĞ‘Ğ ĞĞ‘ĞĞ¢Ğ§Ğ˜ĞšĞ +++

    const statusTextMap: Record<string, string> = {
        available: 'Ğ¡Ğ²Ğ¾Ğ±Ğ¾Ğ´Ğ½Ğ¾',
        reserved: 'Ğ’ Ñ€ĞµĞ·ĞµÑ€Ğ²Ğµ',
        rented: 'Ğ’ Ğ°Ñ€ĞµĞ½Ğ´Ğµ',
        default: 'ĞĞµÑ‚ Ğ´Ğ°Ğ½Ğ½Ñ‹Ñ…'
    };

    return (
        <Popover open={isPopoverOpen} onOpenChange={setPopoverOpen}>
            <PopoverAnchor asChild>
                <div
                    className="w-full h-3 mt-auto flex rounded-sm overflow-hidden border border-gray-400 cursor-pointer"
                    title="ĞŸĞ¾ÑĞ¼Ğ¾Ñ‚Ñ€ĞµÑ‚ÑŒ Ğ´Ğ¾ÑÑ‚ÑƒĞ¿Ğ½Ğ¾ÑÑ‚ÑŒ Ğ¸ Ğ²Ñ‹Ğ±Ñ€Ğ°Ñ‚ÑŒ Ğ´Ğ°Ñ‚Ñ‹"
                >
                    {dates.map(date => {
                        const dateStr = format(date, 'dd.MM.yyyy');
                        const status = dailyStatus[dateStr]?.status ?? 'available';
                        const color = cellColorMap[status] ?? cellColorMap.default;

                        return (
                            <button
                                key={dateStr}
                                className={`flex-1 h-full transition-colors focus:outline-none focus:ring-2 focus:ring-sky-500 z-10 ${color}`}
                                onClick={() => handleCellClick(date, status)}
                                aria-label={`Ğ¡Ñ‚Ğ°Ñ‚ÑƒÑ Ğ½Ğ° ${dateStr}: ${statusTextMap[status]}`}
                            />
                        );
                    })}
                </div>
            </PopoverAnchor>

            <PopoverContent
                className="w-auto p-3 bg-white border rounded-md shadow-lg text-sm"
                side="bottom"
                align="center"
                onCloseAutoFocus={(e) => e.preventDefault()}
                sideOffset={5}
            >
                {popoverData && (
                    <div className="space-y-2">
                        <p>
                            <strong>Ğ”Ğ°Ñ‚Ğ°:</strong> {format(popoverData.date, "PPP", { locale: ru })}
                        </p>
                        <p>
                            <strong>Ğ¡Ñ‚Ğ°Ñ‚ÑƒÑ:</strong> {statusTextMap[popoverData.status] ?? 'ĞĞµĞ¸Ğ·Ğ²ĞµÑÑ‚Ğ½Ğ¾'}
                        </p>
                        {popoverData.status === 'available' && (
                            <Button
                                size="sm"
                                className="mt-2 w-full"
                                onClick={handleSetAsStartDate}
                            >
                                Ğ£ÑÑ‚Ğ°Ğ½Ğ¾Ğ²Ğ¸Ñ‚ÑŒ Ğ´Ğ°Ñ‚Ğ¾Ğ¹ Ğ½Ğ°Ñ‡Ğ°Ğ»Ğ° Ñ€ĞµĞ·ĞµÑ€Ğ²Ğ°
                            </Button>
                        )}
                    </div>
                )}
            </PopoverContent>
        </Popover>
    );
}

```


## <a name="rentalappmainsrccomponentsAvailableCheckboxtsx"></a>`rental-app-main/src/components/AvailableCheckbox.tsx`

```tsx
// path: rental-app-main/src/components/AvailableCheckbox.tsx

import { Checkbox } from "@/components/ui/checkbox"
import { useFilterStore } from "@/store/filterStore"
import { Label } from "@/components/ui/label"

export default function AvailableCheckbox() {
  const { availableOnly, setAvailableOnly } = useFilterStore()

  return (
    <div className="flex items-center space-x-2">
      <Checkbox
        id="available-only"
        checked={availableOnly}
        onCheckedChange={(checked) => setAvailableOnly(Boolean(checked))}
      />
      <Label htmlFor="available-only">Ğ¢Ğ¾Ğ»ÑŒĞºĞ¾ Ğ´Ğ¾ÑÑ‚ÑƒĞ¿Ğ½Ğ¾Ğµ</Label>
    </div>
  )
}


```


## <a name="rentalappmainsrccomponentsBrandFiltertsx"></a>`rental-app-main/src/components/BrandFilter.tsx`

```tsx
// path: rental-app-main/src/components/BrandFilter.tsx

// src/components/BrandFilter.tsx
import { useMemo } from "react"
import { useFilterStore } from "@/store/filterStore"
import type { Equipment } from "@/types/equipment"
import {
    Select,
    SelectContent,
    SelectItem,
    SelectTrigger,
    SelectValue,
} from "@/components/ui/select"

interface BrandFilterProps {
    items: Equipment[]
}

export default function BrandFilter({ items }: BrandFilterProps) {
    const { brand, setBrand } = useFilterStore()

    const brands = useMemo(() => {
        const set = new Set(items.map((i) => i.brand))
        return Array.from(set)
    }, [items])

    return (
        <Select value={brand} onValueChange={setBrand}>
            <SelectTrigger className="w-[200px] border border-sky-300 shadow-sm hover:shadow-md">
                <SelectValue placeholder="Ğ’ÑĞµ Ğ±Ñ€ĞµĞ½Ğ´Ñ‹" />
            </SelectTrigger>
            <SelectContent>
                <SelectItem value="__all__">Ğ’ÑĞµ Ğ±Ñ€ĞµĞ½Ğ´Ñ‹</SelectItem>
                {brands.map((b) => (
                    <SelectItem key={b} value={b}>
                        {b}
                    </SelectItem>
                ))}
            </SelectContent>
        </Select>
    )
}


```


## <a name="rentalappmainsrccomponentsCancelReservationDialogtsx"></a>`rental-app-main/src/components/CancelReservationDialog.tsx`

```tsx
// path: rental-app-main/src/components/CancelReservationDialog.tsx

// src/components/CancelReservationDialog.tsx
import {
    Dialog,
    DialogContent,
    DialogHeader,
    DialogTitle, // Ğ˜Ğ¼Ğ¿Ğ¾Ñ€Ñ‚Ğ¸Ñ€ÑƒĞµĞ¼ DialogTitle
    DialogDescription, // Ğ˜Ğ¼Ğ¿Ğ¾Ñ€Ñ‚Ğ¸Ñ€ÑƒĞµĞ¼ DialogDescription
    DialogFooter,
} from "@/components/ui/dialog";
import { Button } from "@/components/ui/button";

type Props = {
    open: boolean;
    onClose: () => void;
    onConfirm: () => void;
};

export default function CancelReservationDialog({ open, onClose, onConfirm }: Props) {
    return (
        <Dialog open={open} onOpenChange={onClose}>
            <DialogContent>
                <DialogHeader>
                    {/* ğŸ‘‡ Ğ˜Ğ¡ĞŸĞĞ›Ğ¬Ğ—Ğ£Ğ•Ğœ DialogTitle Ğ²Ğ¼ĞµÑÑ‚Ğ¾ h2 */}
                    <DialogTitle className="text-lg font-semibold">ĞÑ‚Ğ¼ĞµĞ½Ğ¸Ñ‚ÑŒ Ğ¾Ñ„Ğ¾Ñ€Ğ¼Ğ»ĞµĞ½Ğ¸Ğµ?</DialogTitle>
                </DialogHeader>
                {/* ğŸ‘‡ Ğ˜Ğ¡ĞŸĞĞ›Ğ¬Ğ—Ğ£Ğ•Ğœ DialogDescription Ğ²Ğ¼ĞµÑÑ‚Ğ¾ p */}
                <DialogDescription className="text-sm text-gray-600">
                    Ğ’ÑĞµ Ğ²Ñ‹Ğ±Ñ€Ğ°Ğ½Ğ½Ñ‹Ğµ Ğ¿Ğ¾Ğ·Ğ¸Ñ†Ğ¸Ğ¸ Ğ±ÑƒĞ´ÑƒÑ‚ ÑƒĞ´Ğ°Ğ»ĞµĞ½Ñ‹, Ğ° Ğ²Ñ‹ Ğ²ĞµÑ€Ğ½Ñ‘Ñ‚ĞµÑÑŒ Ğ½Ğ° Ğ³Ğ»Ğ°Ğ²Ğ½ÑƒÑ ÑÑ‚Ñ€Ğ°Ğ½Ğ¸Ñ†Ñƒ.
                </DialogDescription>
                <DialogFooter className="pt-4">
                    <Button variant="ghost" onClick={onClose}>
                        ĞÑ‚Ğ¼ĞµĞ½Ğ°
                    </Button>
                    <Button
                        className="bg-red-700 hover:bg-red-800 text-white"
                        onClick={onConfirm}
                    >
                        ĞŸĞ¾Ğ´Ñ‚Ğ²ĞµÑ€Ğ´Ğ¸Ñ‚ÑŒ Ğ¾Ñ‚Ğ¼ĞµĞ½Ñƒ
                    </Button>
                </DialogFooter>
            </DialogContent>
        </Dialog>
    );
}

```


## <a name="rentalappmainsrccomponentsCardShelltsx"></a>`rental-app-main/src/components/CardShell.tsx`

```tsx
// path: rental-app-main/src/components/CardShell.tsx

import { Card, CardContent, CardFooter, CardHeader } from "@/components/ui/card"
import { ReactNode } from "react"

type Props = {
    title: string
    status?: ReactNode
    children: ReactNode
    footer?: ReactNode
    className?: string
}

export default function CardShell({ title, status, children, footer, className = "" }: Props) {
    return (
        <Card className={`w-full rounded-xl border shadow-sm hover:shadow-md transition ${className}`}>
            <CardHeader className="flex justify-between items-start">
                <h3 className="text-lg font-semibold">{title}</h3>
                {status && <div>{status}</div>}
            </CardHeader>
            <CardContent className="space-y-2 text-sm text-gray-700">
                {children}
            </CardContent>
            {footer && <CardFooter className="pt-2">{footer}</CardFooter>}
        </Card>
    )
}


```


## <a name="rentalappmainsrccomponentsCompactEquipmentCardtsx"></a>`rental-app-main/src/components/CompactEquipmentCard.tsx`

```tsx
// path: rental-app-main/src/components/CompactEquipmentCard.tsx

// src/components/CompactEquipmentCard.tsx

import React, { useMemo, useCallback } from "react";
import { CheckCircle } from "lucide-react";
import { useReserveStore } from "@/store/reserveStore";
import { useDateStore } from "@/store/dateStore";
import { useSandboxCalculatorStore } from "@/store/sandboxCalculatorStore";
import { usePromoCodeStore } from "@/store/promoCodeStore";
import { formatDateRangeEuropean } from "@/lib/utils";

// Ğ¢Ğ¸Ğ¿Ñ‹
import type { Equipment } from "@/types/equipment";
import type { DayStatus, EquipmentStatus } from "@/types/availability";

interface CompactEquipmentCardProps {
    equipment: Equipment;
    status?: EquipmentStatus | "my_reservation" | "added";
    startDate?: string;
    endDate?: string;
    dailyStatus?: Record<string, DayStatus>;
}

// --- ĞĞĞ§ĞĞ›Ğ Ğ˜Ğ—ĞœĞ•ĞĞ•ĞĞ˜Ğ™ ---

// 1. Ğ£Ğ¿Ñ€Ğ¾Ñ‰Ğ°ĞµĞ¼ ÑÑ‚Ğ¸Ğ»Ğ¸, ÑƒĞ´Ğ°Ğ»ÑÑ `ending_today`
const COMPACT_STATUS_STYLES: Record<EquipmentStatus | "my_reservation" | "added", string> = {
    available: "bg-white border-gray-200 hover:bg-gray-50",
    reserved: "bg-rose-100 border-rose-300",
    rented: "bg-red-200 border-red-400",
    my_reservation: "bg-sky-50 border-sky-200 hover:bg-sky-100",
    added: "bg-green-100 border-green-300",
};
// --- ĞšĞĞĞ•Ğ¦ Ğ˜Ğ—ĞœĞ•ĞĞ•ĞĞ˜Ğ™ ---

const COMPACT_SELECTED_STYLES = "ring-2 ring-offset-1 ring-green-500 border-green-500 bg-green-100";

const CompactEquipmentCardComponent: React.FC<CompactEquipmentCardProps> = ({
                                                                       equipment,
                                                                       status = "available",
                                                                       startDate,
                                                                       endDate,
                                                                   }) => {
    const { toggle, isSelected, selectedAccessories } = useReserveStore();
    const { dayCount } = useDateStore();
    const { durationDiscountPercentage } = useSandboxCalculatorStore();
    const { promoCodePercentage } = usePromoCodeStore();
    const isSelectedByUser = isSelected(equipment.id);

    const accessoriesDailyRate = useMemo(() => {
        const selectedForThisCard = selectedAccessories[equipment.id] || [];
        return equipment.accessories?.reduce((total, acc) =>
            selectedForThisCard.includes(acc.id) ? total + acc.price : total, 0) ?? 0;
    }, [equipment.accessories, equipment.id, selectedAccessories]);

    const totalDiscountPercentage = useMemo(() =>
            durationDiscountPercentage + promoCodePercentage,
        [durationDiscountPercentage, promoCodePercentage]
    );

    const priceData = useMemo(() => {
        const totalDailyRate = equipment.daily_rate + accessoriesDailyRate;
        const priceBefore = totalDailyRate * dayCount;
        const priceAfter = priceBefore * (1 - totalDiscountPercentage / 100);

        return {
            dailyRate: totalDailyRate,
            totalPrice: priceAfter,
            discountPercentage: totalDiscountPercentage,
            days: dayCount,
        };
    }, [equipment.daily_rate, accessoriesDailyRate, dayCount, totalDiscountPercentage]);

    // --- ĞĞĞ§ĞĞ›Ğ Ğ˜Ğ—ĞœĞ•ĞĞ•ĞĞ˜Ğ™: Ğ£Ğ´Ğ°Ğ»ÑĞµĞ¼ useMemo Ğ´Ğ»Ñ finalStatus ---
    // const finalStatus: DisplayStatus = useMemo(() => { ... }); // Ğ­Ğ¢ĞĞ¢ Ğ‘Ğ›ĞĞš ĞŸĞĞ›ĞĞĞ¡Ğ¢Ğ¬Ğ® Ğ£Ğ”ĞĞ›Ğ•Ğ
    // --- ĞšĞĞĞ•Ğ¦ Ğ˜Ğ—ĞœĞ•ĞĞ•ĞĞ˜Ğ™ ---

    const handleCardClick = useCallback((e: React.MouseEvent<HTMLDivElement>) => {
        if ((e.target as HTMLElement).closest("button, a, label, input[type='checkbox']")) return;
        // --- Ğ˜Ğ—ĞœĞ•ĞĞ•ĞĞ˜Ğ•: Ğ˜ÑĞ¿Ğ¾Ğ»ÑŒĞ·ÑƒĞµĞ¼ `status` Ğ½Ğ°Ğ¿Ñ€ÑĞ¼ÑƒÑ ---
        if (status === 'available' || status === 'added') {
            toggle(equipment);
        }
    }, [status, toggle, equipment]);

    const handleDoubleClick = useCallback((e: React.MouseEvent<HTMLDivElement>) => {
        if ((e.target as HTMLElement).closest("button, a, label, input[type='checkbox']")) return;
        // --- Ğ˜Ğ—ĞœĞ•ĞĞ•ĞĞ˜Ğ•: Ğ˜ÑĞ¿Ğ¾Ğ»ÑŒĞ·ÑƒĞµĞ¼ `status` Ğ½Ğ°Ğ¿Ñ€ÑĞ¼ÑƒÑ ---
        if (status === 'available' || status === 'added') {
            toggle(equipment);
        }
    }, [status, toggle, equipment]);

    // --- Ğ˜Ğ—ĞœĞ•ĞĞ•ĞĞ˜Ğ•: Ğ˜ÑĞ¿Ğ¾Ğ»ÑŒĞ·ÑƒĞµĞ¼ `status` Ğ´Ğ»Ñ Ğ¾Ğ¿Ñ€ĞµĞ´ĞµĞ»ĞµĞ½Ğ¸Ñ ÑÑ‚Ğ¸Ğ»Ñ ---
    const backgroundClass = isSelectedByUser
        ? COMPACT_SELECTED_STYLES
        : COMPACT_STATUS_STYLES[status];

    const dateRangeDisplay = (startDate && endDate)
        ? `(${formatDateRangeEuropean(startDate, endDate)})`
        : "";

    return (
        <div
            className={`relative p-3 rounded-lg border transition-all duration-200 cursor-pointer ${backgroundClass}`}
            onClick={handleCardClick}
            onDoubleClick={handleDoubleClick}
            tabIndex={0}
        >
            {isSelectedByUser && (
                <div className="absolute top-1 right-1 z-10 bg-green-600 text-white rounded-full p-0.5 shadow">
                    <CheckCircle className="w-3 h-3" />
                </div>
            )}

            <div className="space-y-2">
                <div className="space-y-1">
                    <h3 className="text-sm font-semibold text-gray-900 truncate" title={equipment.name}>
                        {equipment.name}
                    </h3>
                    <p className="text-xs text-gray-500">
                        {equipment.brand} â€¢ {equipment.equipment_type}
                    </p>
                    {dateRangeDisplay && (
                        <p className="text-xs text-gray-400">{dateRangeDisplay}</p>
                    )}
                </div>

                <div className="space-y-1">
                    <div className="flex justify-between items-center">
                        <span className="text-xs text-gray-600">
                            {priceData.days} {priceData.days === 1 ? 'Ğ´ĞµĞ½ÑŒ' : priceData.days < 5 ? 'Ğ´Ğ½Ñ' : 'Ğ´Ğ½ĞµĞ¹'}
                        </span>
                        <span className="text-sm font-semibold text-gray-900">
                            {priceData.totalPrice.toLocaleString('ru-RU')} â‚½
                        </span>
                    </div>

                    {priceData.discountPercentage > 0 && (
                        <div className="text-xs text-green-600">
                            Ğ¡ĞºĞ¸Ğ´ĞºĞ°: {priceData.discountPercentage.toFixed(0)}%
                        </div>
                    )}
                </div>

                {/* --- ĞĞĞ§ĞĞ›Ğ Ğ˜Ğ—ĞœĞ•ĞĞ•ĞĞ˜Ğ™: Ğ£Ğ¿Ñ€Ğ¾Ñ‰ĞµĞ½Ğ½Ñ‹Ğ¹ Ğ±Ğ»Ğ¾Ğº ÑÑ‚Ğ°Ñ‚ÑƒÑĞ° --- */}
                <div className="text-xs">
                    {status === 'available' && (
                        <span className="text-green-600 font-medium">Ğ¡Ğ²Ğ¾Ğ±Ğ¾Ğ´Ğ½Ğ¾</span>
                    )}
                    {status === 'reserved' && (
                        <span className="text-red-600 font-medium">Ğ’ Ñ€ĞµĞ·ĞµÑ€Ğ²Ğµ</span>
                    )}
                    {status === 'rented' && (
                        <span className="text-red-700 font-medium">Ğ’ Ğ°Ñ€ĞµĞ½Ğ´Ğµ</span>
                    )}
                    {status === 'my_reservation' && (
                        <span className="text-sky-600 font-medium">Ğ’ ÑÑ‚Ğ¾Ğ¼ Ñ€ĞµĞ·ĞµÑ€Ğ²Ğµ</span>
                    )}
                    {status === 'added' && (
                        <span className="text-emerald-600 font-medium">Ğ”Ğ¾Ğ±Ğ°Ğ²Ğ»ĞµĞ½Ğ¾</span>
                    )}
                </div>
                {/* --- ĞšĞĞĞ•Ğ¦ Ğ˜Ğ—ĞœĞ•ĞĞ•ĞĞ˜Ğ™ --- */}
            </div>
        </div>
    );
};

// ĞœĞµĞ¼Ğ¾Ğ¸Ğ·Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ½Ğ°Ñ Ğ²ĞµÑ€ÑĞ¸Ñ ĞºĞ¾Ğ¼Ğ¿Ğ¾Ğ½ĞµĞ½Ñ‚Ğ° Ğ´Ğ»Ñ Ğ¾Ğ¿Ñ‚Ğ¸Ğ¼Ğ¸Ğ·Ğ°Ñ†Ğ¸Ğ¸ Ğ¿Ñ€Ğ¾Ğ¸Ğ·Ğ²Ğ¾Ğ´Ğ¸Ñ‚ĞµĞ»ÑŒĞ½Ğ¾ÑÑ‚Ğ¸
const CompactEquipmentCard = React.memo(CompactEquipmentCardComponent);

export default CompactEquipmentCard;

```


## <a name="rentalappmainsrccomponentsConfirmItemRemovalDialogtsx"></a>`rental-app-main/src/components/ConfirmItemRemovalDialog.tsx`

```tsx
// path: rental-app-main/src/components/ConfirmItemRemovalDialog.tsx

// src/components/ConfirmItemRemovalDialog.tsx
import {
    Dialog,
    DialogContent,
    DialogHeader,
    DialogTitle,
    DialogDescription,
    DialogFooter,
} from "@/components/ui/dialog";
import { Button } from "@/components/ui/button";

type Props = {
    open: boolean;
    onClose: () => void;
    onConfirm: () => void;
    isConfirming: boolean;
    variant?: 'removeItem' | 'cancelReservation'; // âœ¨ ĞĞĞ’Ğ«Ğ™ ĞŸĞ ĞĞŸĞ¡
};

export default function ConfirmItemRemovalDialog({
                                                     open,
                                                     onClose,
                                                     onConfirm,
                                                     isConfirming,
                                                     variant = 'removeItem' // âœ¨ Ğ—ĞĞĞ§Ğ•ĞĞ˜Ğ• ĞŸĞ Ğ£ĞœĞĞ›Ğ§ĞĞĞ˜Ğ®
                                                 }: Props) {

    // âœ¨ ĞšĞĞĞ¢Ğ•ĞĞ¢ Ğ”Ğ›Ğ¯ Ğ ĞĞ—ĞĞ«Ğ¥ Ğ’ĞĞ Ğ˜ĞĞĞ¢ĞĞ’ Ğ”Ğ˜ĞĞ›ĞĞ“Ğ
    const content = {
        removeItem: {
            title: "ĞŸĞ¾Ğ´Ñ‚Ğ²ĞµÑ€Ğ´Ğ¸Ñ‚Ğµ Ğ´ĞµĞ¹ÑÑ‚Ğ²Ğ¸Ğµ",
            description: "Ğ’Ñ‹ ÑƒĞ²ĞµÑ€ĞµĞ½Ñ‹, Ñ‡Ñ‚Ğ¾ Ñ…Ğ¾Ñ‚Ğ¸Ñ‚Ğµ ÑƒĞ´Ğ°Ğ»Ğ¸Ñ‚ÑŒ ÑÑ‚Ñƒ Ğ¿Ğ¾Ğ·Ğ¸Ñ†Ğ¸Ñ Ğ¸Ğ· Ñ€ĞµĞ·ĞµÑ€Ğ²Ğ°?",
            cancelText: "ĞÑ‚Ğ¼ĞµĞ½Ğ°",
            confirmText: "Ğ£Ğ´Ğ°Ğ»Ğ¸Ñ‚ÑŒ",
            confirmLoadingText: "Ğ£Ğ´Ğ°Ğ»ĞµĞ½Ğ¸Ğµ..."
        },
        cancelReservation: {
            title: "Ğ£Ğ´Ğ°Ğ»ĞµĞ½Ğ¸Ğµ Ğ¿Ğ¾ÑĞ»ĞµĞ´Ğ½ĞµĞ¹ Ğ¿Ğ¾Ğ·Ğ¸Ñ†Ğ¸Ğ¸",
            description: "Ğ’Ñ‹ ÑƒĞ´Ğ°Ğ»Ğ¸Ğ»Ğ¸ Ğ¿Ğ¾ÑĞ»ĞµĞ´Ğ½ÑÑ Ğ¿Ğ¾Ğ·Ğ¸Ñ†Ğ¸Ñ. Ğ¥Ğ¾Ñ‚Ğ¸Ñ‚Ğµ Ğ¾Ñ‚Ğ¼ĞµĞ½Ğ¸Ñ‚ÑŒ Ñ€ĞµĞ·ĞµÑ€Ğ² Ğ¿Ğ¾Ğ»Ğ½Ğ¾ÑÑ‚ÑŒÑ?",
            cancelText: "Ğ’ĞµÑ€Ğ½ÑƒÑ‚ÑŒÑÑ Ğº Ñ€ĞµĞ´Ğ°ĞºÑ‚Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ",
            confirmText: "ĞÑ‚Ğ¼ĞµĞ½Ğ¸Ñ‚ÑŒ Ñ€ĞµĞ·ĞµÑ€Ğ²",
            confirmLoadingText: "ĞÑ‚Ğ¼ĞµĞ½Ğ°..."
        }
    }[variant];

    return (
        <Dialog open={open} onOpenChange={onClose}>
            <DialogContent>
                <DialogHeader>
                    <DialogTitle>{content.title}</DialogTitle>
                </DialogHeader>
                <DialogDescription>{content.description}</DialogDescription>
                <DialogFooter className="pt-4">
                    <Button variant="ghost" onClick={onClose} disabled={isConfirming}>
                        {content.cancelText}
                    </Button>
                    <Button
                        variant="destructive"
                        onClick={onConfirm}
                        disabled={isConfirming}
                    >
                        {isConfirming ? content.confirmLoadingText : content.confirmText}
                    </Button>
                </DialogFooter>
            </DialogContent>
        </Dialog>
    );
}

```


## <a name="rentalappmainsrccomponentsDateRangeSelectortsx"></a>`rental-app-main/src/components/DateRangeSelector.tsx`

```tsx
// path: rental-app-main/src/components/DateRangeSelector.tsx

// src/components/DateRangeSelector.tsx

import { useState, type RefObject, useCallback, useEffect, useRef } from 'react';
import { DayPicker, type DateRange } from 'react-day-picker';
import { ru } from 'date-fns/locale';
import { format, addMonths, startOfMonth, endOfMonth } from 'date-fns';
import { ChevronsDown, ChevronsUp } from "lucide-react";
import { useDateStore } from "@/store/dateStore";
import { useSandboxCalculatorStore } from "@/store/sandboxCalculatorStore";
import { useDateRange } from "@/hooks/useDateRange";
import { useHolidayStore } from "@/store/holidayStore";
import { DateService } from '@/core/services/DateService';

interface DateRangeSelectorProps {
    containerRef: RefObject<HTMLDivElement | null>;
}

export default function DateRangeSelector({ containerRef }: DateRangeSelectorProps) {
    const { startDate, endDate, setRange } = useDateStore();
    const { isCalculatorVisible, syncWithDateStore, refreshCalculator } = useSandboxCalculatorStore();

    const [collapsed, setCollapsed] = useState(true);
    const [month, setMonth] = useState(startDate);

    const lastChangeSource = useRef<'calendar' | 'slider' | 'manual' | null>(null);
    const [isAutoUpdating, setIsAutoUpdating] = useState(false);

    const { holidays, fetchHolidays } = useHolidayStore();

    useEffect(() => {
        const firstDayToFetch = startOfMonth(addMonths(month, -1));
        const lastDayToFetch = endOfMonth(addMonths(month, 2));
        void fetchHolidays(firstDayToFetch, lastDayToFetch);
    }, [month, fetchHolidays]);

    // âœ… ĞĞĞ’ĞĞ•: Ğ¡Ğ¸Ğ½Ñ…Ñ€Ğ¾Ğ½Ğ¸Ğ·Ğ¸Ñ€ÑƒĞµĞ¼ ĞºĞ°Ğ»ÑŒĞºÑƒĞ»ÑÑ‚Ğ¾Ñ€ Ğ¿Ñ€Ğ¸ Ğ¸Ğ·Ğ¼ĞµĞ½ĞµĞ½Ğ¸Ğ¸ Ğ²Ñ‹Ñ…Ğ¾Ğ´Ğ½Ñ‹Ñ… Ğ´Ğ½ĞµĞ¹
    useEffect(() => {
        if (holidays.length > 0) {
            refreshCalculator();
        }
    }, [holidays, refreshCalculator]);

    // âœ… ĞĞĞ’ĞĞ•: Ğ¡Ğ¸Ğ½Ñ…Ñ€Ğ¾Ğ½Ğ¸Ğ·Ğ¸Ñ€ÑƒĞµĞ¼ ĞºĞ°Ğ»ÑŒĞºÑƒĞ»ÑÑ‚Ğ¾Ñ€ Ğ¿Ñ€Ğ¸ Ğ¸Ğ·Ğ¼ĞµĞ½ĞµĞ½Ğ¸Ğ¸ ĞºĞ¾Ğ»Ğ¸Ñ‡ĞµÑÑ‚Ğ²Ğ° Ğ´Ğ½ĞµĞ¹
    useEffect(() => {
        const { dayCount } = useDateStore.getState();
        if (dayCount > 0) {
            syncWithDateStore();
        }
    }, [startDate, endDate, syncWithDateStore]);

    const handleRangeChange = useCallback((newStart: Date, newEnd: Date, source?: 'calendar' | 'slider' | 'manual') => {
        lastChangeSource.current = source || 'manual';

        if (source === 'slider') {
            setIsAutoUpdating(true);
            setTimeout(() => setIsAutoUpdating(false), 1000);
        }

        setRange(newStart, newEnd, source, holidays);

        if (source !== 'slider') {
            syncWithDateStore();
        }
    }, [holidays, setRange, syncWithDateStore]);

    useEffect(() => {
        if (lastChangeSource.current === 'slider') {
            lastChangeSource.current = null;
            return;
        }

        lastChangeSource.current = null;
    }, [startDate, endDate]);

    const {
        localStartDate,
        localEndDate,
        handleStartDateChange,
        handleEndDateChange,
    } = useDateRange({
        startDate,
        endDate,
        onRangeChange: handleRangeChange,
        holidays
    });

    const handleSelect = (selectedRange: DateRange | undefined) => {
        if (!selectedRange?.from) return;

        const selectionStartDate = selectedRange.from;
        const finalEndDate = selectedRange.to ?? DateService.findNextWorkingDay(selectionStartDate, holidays, 1);

        const finalRange = { from: selectionStartDate, to: finalEndDate };

        if (finalRange.from && finalRange.to) {
            const { dayCount } = useDateStore.getState();
            const willCalculatorAppear = !isCalculatorVisible && dayCount >= 4;

            if (willCalculatorAppear && containerRef.current) {
                containerRef.current.style.overflowAnchor = 'none';
            }

            handleRangeChange(finalRange.from, finalRange.to, 'calendar');

            if (willCalculatorAppear && containerRef.current) {
                setTimeout(() => {
                    if (containerRef.current) containerRef.current.style.overflowAnchor = 'auto';
                }, 0);
            }
        }
    };

    const today = new Date();
    today.setHours(0, 0, 0, 0);

    const disabledDays = [
        ...holidays,
        { before: today }
    ];

    function formatDateForInput(date: Date): string {
        const year = date.getFullYear();
        const month = String(date.getMonth() + 1).padStart(2, "0");
        const day = String(date.getDate()).padStart(2, "0");
        return `${year}-${month}-${day}`;
    }

    const minEndDate = (() => {
        const start = new Date(localStartDate);
        const timezoneOffset = start.getTimezoneOffset() * 60000;
        const startUTC = new Date(start.getTime() + timezoneOffset);
        startUTC.setDate(startUTC.getDate() + 1);
        return formatDateForInput(startUTC);
    })();

    return (
        <div className="mb-4 border rounded-md p-4 bg-white shadow-sm">
            <div className="flex justify-between items-center mb-2">
                <h2 className="text-base font-semibold text-gray-700">Ğ’Ñ‹Ğ±Ğ¸Ñ€Ğ°Ğ¹Ñ‚Ğµ Ğ´Ğ°Ñ‚Ñ‹ Ğ½Ğ°Ñ‡Ğ°Ğ»Ğ° Ğ¸ Ğ¾ĞºĞ¾Ğ½Ñ‡Ğ°Ğ½Ğ¸Ñ Ğ°Ñ€ĞµĞ½Ğ´Ñ‹:</h2>
                <button
                    onClick={() => setCollapsed(!collapsed)}
                    className="text-gray-600 hover:text-gray-800 transition p-1"
                    title={collapsed ? "Ğ Ğ°Ğ·Ğ²ĞµÑ€Ğ½ÑƒÑ‚ÑŒ ĞºĞ°Ğ»ĞµĞ½Ğ´Ğ°Ñ€ÑŒ" : "Ğ¡Ğ²ĞµÑ€Ğ½ÑƒÑ‚ÑŒ ĞºĞ°Ğ»ĞµĞ½Ğ´Ğ°Ñ€ÑŒ"}
                >
                    {collapsed ? <ChevronsDown className="w-5 h-5" /> : <ChevronsUp className="w-5 h-5" />}
                </button>
            </div>

            {collapsed ? (
                    <div
                        className="flex justify-center items-center gap-4 mt-4 cursor-pointer group"
                        onClick={() => setCollapsed(false)}
                        title="ĞĞ°Ğ¶Ğ¼Ğ¸Ñ‚Ğµ, Ñ‡Ñ‚Ğ¾Ğ±Ñ‹ Ğ¸Ğ·Ğ¼ĞµĞ½Ğ¸Ñ‚ÑŒ Ğ´Ğ°Ñ‚Ñ‹"
                    >
                        <div className="text-center p-3 rounded-lg bg-sky-50 border-2 border-sky-200 w-40 transition-all group-hover:border-sky-400 group-hover:shadow-lg">
                            <div className="text-sm font-medium text-sky-700">ĞĞ°Ñ‡Ğ°Ğ»Ğ¾</div>
                            <div className="text-4xl font-bold text-sky-900 leading-tight">{format(startDate, "dd")}</div>
                            <div className="text-lg font-semibold text-sky-800 capitalize">{format(startDate, "LLLL", { locale: ru })}</div>
                            <div className="text-sm text-sky-600">{format(startDate, "yyyy")}</div>
                        </div>
                        <div className="text-3xl font-light text-gray-300 pb-8">-</div>
                        <div className={`text-center p-3 rounded-lg w-40 transition-all group-hover:shadow-lg ${
                            isAutoUpdating
                                ? 'bg-green-50 border-2 border-green-300 animate-pulse'
                                : 'bg-sky-50 border-2 border-sky-200 group-hover:border-sky-400'
                        }`}>
                            <div className="text-sm font-medium text-sky-700">
                                {isAutoUpdating ? 'ĞĞ±Ğ½Ğ¾Ğ²Ğ»ÑĞµÑ‚ÑÑ...' : 'ĞĞºĞ¾Ğ½Ñ‡Ğ°Ğ½Ğ¸Ğµ'}
                            </div>
                            <div className="text-4xl font-bold text-sky-900 leading-tight">{format(endDate, "dd")}</div>
                            <div className="text-lg font-semibold text-sky-800 capitalize">{format(endDate, "LLLL", { locale: ru })}</div>
                            <div className="text-sm text-sky-600">{format(endDate, "yyyy")}</div>
                        </div>
                    </div>
                ) :
                <>
                    <div className="flex justify-center mb-4">
                        <DayPicker
                            mode="range"
                            locale={ru}
                            selected={{ from: startDate, to: endDate }}
                            onSelect={handleSelect}
                            month={month}
                            onMonthChange={setMonth}
                            showOutsideDays
                            numberOfMonths={2}
                            disabled={disabledDays}
                            min={2}
                            modifiers={{ holiday: holidays }}
                            classNames={{
                                months: 'flex flex-col sm:flex-row space-y-4 sm:space-x-4 sm:space-y-0',
                                month: 'space-y-4',
                                table: 'w-full border-collapse space-y-1',
                                head_row: 'flex',
                                head_cell: 'text-muted-foreground rounded-md w-9 font-normal text-[0.8rem]',
                                row: 'flex w-full mt-2',
                                cell: 'h-9 w-9 text-center text-sm p-0 relative [&:has([aria-selected])]:bg-accent first:[&:has([aria-selected])]:rounded-l-md last:[&:has([aria-selected])]:rounded-r-md focus-within:relative focus-within:z-20',
                                day: 'h-9 w-9 p-0 font-normal aria-selected:opacity-100',
                                nav: 'space-x-1 flex items-center',
                                caption: 'flex justify-center pt-1 relative items-center',
                                caption_label: 'text-sm font-medium',
                                nav_button: 'h-7 w-7 bg-transparent p-0 opacity-50 hover:opacity-100'
                            }}
                            modifiersClassNames={{
                                today: 'bg-accent text-accent-foreground',
                                selected: 'bg-sky-600 text-white hover:bg-sky-600 hover:text-white focus:bg-sky-600 focus:text-white',
                                range_start: 'rounded-l-full',
                                range_end: 'rounded-r-full',
                                range_middle: 'aria-selected:bg-sky-100 aria-selected:text-sky-900',
                                outside: 'day-outside text-muted-foreground opacity-50',
                                disabled: 'text-muted-foreground opacity-50 cursor-not-allowed',
                                holiday: 'text-red-600 bg-red-50 border-red-200 font-bold',
                            }}
                        />
                    </div>
                    <div className="flex flex-col sm:flex-row gap-4 justify-center">
                        <label className="text-sm text-gray-700">
                            Ğ¡:
                            <input
                                type="date"
                                value={localStartDate}
                                onChange={handleStartDateChange}
                                className="ml-2 border border-gray-300 rounded px-2 py-1 text-sm"
                                min={formatDateForInput(new Date())}
                            />
                        </label>
                        <label className="text-sm text-gray-700">
                            ĞŸĞ¾:
                            <input
                                type="date"
                                value={localEndDate}
                                onChange={handleEndDateChange}
                                className="ml-2 border border-gray-300 rounded px-2 py-1 text-sm"
                                min={minEndDate}
                            />
                        </label>
                    </div>
                </>
            }
        </div>
    );
}

```


## <a name="rentalappmainsrccomponentsDateRangeSelectorcalendarcss"></a>`rental-app-main/src/components/DateRangeSelector/calendar.css`

```css
// path: rental-app-main/src/components/DateRangeSelector/calendar.css

/* src/components/DateRangeSelector/calendar.css */

/* ĞĞ±Ñ‰Ğ¸Ğµ ÑÑ‚Ğ¸Ğ»Ğ¸ Ğ´Ğ»Ñ Ğ´Ğ½Ñ, ĞºĞ¾Ñ‚Ğ¾Ñ€Ñ‹Ğµ ÑƒĞ¶Ğµ ĞµÑÑ‚ÑŒ Ğ² index.css, Ğ½Ğ¾ Ğ¼Ñ‹ Ğ¼Ğ¾Ğ¶ĞµĞ¼ Ğ¸Ñ… Ğ´Ğ¾Ğ¿Ğ¾Ğ»Ğ½Ğ¸Ñ‚ÑŒ */
.calendar-day {
    padding: 0.5rem;
    border-radius: 0; /* Ğ£Ğ±Ğ¸Ñ€Ğ°ĞµĞ¼ ÑĞºÑ€ÑƒĞ³Ğ»ĞµĞ½Ğ¸Ğµ Ğ¿Ğ¾ ÑƒĞ¼Ğ¾Ğ»Ñ‡Ğ°Ğ½Ğ¸Ñ Ğ´Ğ»Ñ ÑÑ€ĞµĞ´Ğ½Ğ¸Ñ… Ğ´Ğ½ĞµĞ¹ */
    color: #1f2937; /* Ğ¦Ğ²ĞµÑ‚ Ñ‚ĞµĞºÑÑ‚Ğ° Ğ¿Ğ¾ ÑƒĞ¼Ğ¾Ğ»Ñ‡Ğ°Ğ½Ğ¸Ñ */
    transition: background-color 0.2s, color 0.2s;
}

/* Ğ¡Ñ‚Ğ¸Ğ»Ğ¸ Ğ´Ğ»Ñ Ğ´Ğ½ĞµĞ¹ Ğ²Ğ½ÑƒÑ‚Ñ€Ğ¸ Ğ²Ñ‹Ğ±Ñ€Ğ°Ğ½Ğ½Ğ¾Ğ³Ğ¾ Ğ´Ğ¸Ğ°Ğ¿Ğ°Ğ·Ğ¾Ğ½Ğ° (Ğ´ÑƒĞ±Ğ»Ğ¸Ñ€ÑƒÑÑ‚ index.css Ğ´Ğ»Ñ Ğ½Ğ°Ğ´ĞµĞ¶Ğ½Ğ¾ÑÑ‚Ğ¸) */
.range-middle {
    background-color: #e0f2fe; /* Tailwind sky-100 */
}

/* Ğ¡Ñ‚Ğ¸Ğ»Ğ¸ Ğ´Ğ»Ñ Ğ½Ğ°Ñ‡Ğ°Ğ»ÑŒĞ½Ğ¾Ğ¹ Ğ¸ ĞºĞ¾Ğ½ĞµÑ‡Ğ½Ğ¾Ğ¹ Ğ´Ğ°Ñ‚ Ğ´Ğ¸Ğ°Ğ¿Ğ°Ğ·Ğ¾Ğ½Ğ° (Ğ´ÑƒĞ±Ğ»Ğ¸Ñ€ÑƒÑÑ‚ index.css Ğ´Ğ»Ñ Ğ½Ğ°Ğ´ĞµĞ¶Ğ½Ğ¾ÑÑ‚Ğ¸) */
.range-start,
.range-end {
    background-color: #0284c7; /* Tailwind sky-600 */
    color: white;
    border-radius: 50%; /* Ğ”ĞµĞ»Ğ°ĞµĞ¼ Ğ¸Ñ… ĞºÑ€ÑƒĞ³Ğ»Ñ‹Ğ¼Ğ¸ */
}

/* Ğ£Ğ±Ğ¸Ñ€Ğ°ĞµĞ¼ ÑÑ‚Ğ°Ğ½Ğ´Ğ°Ñ€Ñ‚Ğ½Ğ¾Ğµ Ğ²Ñ‹Ğ´ĞµĞ»ĞµĞ½Ğ¸Ğµ Ğ´Ğ»Ñ Ğ¾Ğ´Ğ¸Ğ½Ğ¾Ñ‡Ğ½Ñ‹Ñ… ĞºĞ»Ğ¸ĞºĞ¾Ğ² Ğ² Ñ€ĞµĞ¶Ğ¸Ğ¼Ğµ Ğ´Ğ¸Ğ°Ğ¿Ğ°Ğ·Ğ¾Ğ½Ğ° */
.day-selected:not([class*="range-"]) {
    background-color: transparent;
    color: inherit;
}

/* Ğ¡Ñ‚Ğ¸Ğ»Ğ¸ Ğ´Ğ»Ñ Ğ½Ğ°Ğ²Ğ¸Ğ³Ğ°Ñ†Ğ¸Ğ¸ Ğ¸ Ğ·Ğ°Ğ³Ğ¾Ğ»Ğ¾Ğ²ĞºĞ¾Ğ² (Ğ´ÑƒĞ±Ğ»Ğ¸Ñ€ÑƒÑÑ‚ index.css Ğ´Ğ»Ñ Ğ½Ğ°Ğ´ĞµĞ¶Ğ½Ğ¾ÑÑ‚Ğ¸) */
.calendar-caption {
    font-weight: bold;
    font-size: 1.1rem;
    text-transform: capitalize;
    padding-bottom: 0.5rem;
}

.calendar-nav {
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.calendar-head-cell {
    font-weight: 500;
    color: #4b5563; /* gray-600 */
    font-size: 0.8rem;
}

.calendar-cell {
    padding: 1px; /* ĞĞµĞ±Ğ¾Ğ»ÑŒÑˆĞ¾Ğ¹ Ğ¾Ñ‚ÑÑ‚ÑƒĞ¿ Ğ¼ĞµĞ¶Ğ´Ñƒ ÑÑ‡ĞµĞ¹ĞºĞ°Ğ¼Ğ¸ Ğ´Ğ»Ñ Ğ²Ğ¸Ğ·ÑƒĞ°Ğ»ÑŒĞ½Ğ¾Ğ³Ğ¾ Ñ€Ğ°Ğ·Ğ´ĞµĞ»ĞµĞ½Ğ¸Ñ */
}

```


## <a name="rentalappmainsrccomponentsDiscountCalculatortsx"></a>`rental-app-main/src/components/DiscountCalculator.tsx`

```tsx
// path: rental-app-main/src/components/DiscountCalculator.tsx

// src/components/DiscountCalculator.tsx

import { useState, useMemo, useRef, useCallback, useEffect } from 'react'; // 1. Ğ”Ğ¾Ğ±Ğ°Ğ²Ğ»ĞµĞ½ Ğ¸Ğ¼Ğ¿Ğ¾Ñ€Ñ‚ useEffect
import { useSandboxCalculatorStore } from '@/store/sandboxCalculatorStore';
import { useDateStore } from '@/store/dateStore';
import { usePromoCodeStore } from '@/store/promoCodeStore';
import { useReserveStore } from '@/store/reserveStore';
import { Card, CardContent } from '@/components/ui/card';
import { Label } from "@/components/ui/label";
import { ChevronRight, Percent, Loader2 } from "lucide-react";
import PromoCodeInput from './PromoCodeInput';
import type { ChangeEvent } from 'react';
import { toast } from 'sonner';
import { api } from '@/lib/api';

export default function DiscountCalculator() {
    const { dayCount } = useDateStore();
    const {
        setDaysFromSlider, isCalculatorVisible, toggleCalculator,
        isLoadingTiers, durationDiscountPercentage,
        syncWithDateStore // 2. ĞŸĞ¾Ğ»ÑƒÑ‡Ğ°ĞµĞ¼ Ñ„ÑƒĞ½ĞºÑ†Ğ¸Ñ ÑĞ¸Ğ½Ñ…Ñ€Ğ¾Ğ½Ğ¸Ğ·Ğ°Ñ†Ğ¸Ğ¸
    } = useSandboxCalculatorStore();

    const {
        promoCode, setPromoCode, promoCodePercentage,
        promoCodeMessage, setPromoCodeResult, removePromoCode
    } = usePromoCodeStore();

    const { items } = useReserveStore();

    const [isApplyingPromoCode, setIsApplyingPromoCode] = useState(false);

    const debounceTimeoutRef = useRef<NodeJS.Timeout | null>(null);

    // 3. --- Ğ”ĞĞ‘ĞĞ’Ğ›Ğ•Ğ Ğ­Ğ¢ĞĞ¢ Ğ‘Ğ›ĞĞš ---
    // Ğ­Ñ‚Ğ¾Ñ‚ ÑÑ„Ñ„ĞµĞºÑ‚ ÑĞ»ĞµĞ´Ğ¸Ñ‚ Ğ·Ğ° Ğ¸Ğ·Ğ¼ĞµĞ½ĞµĞ½Ğ¸ĞµĞ¼ `dayCount` Ğ² Ñ…Ñ€Ğ°Ğ½Ğ¸Ğ»Ğ¸Ñ‰Ğµ Ğ´Ğ°Ñ‚.
    // ĞšĞ°Ğº Ñ‚Ğ¾Ğ»ÑŒĞºĞ¾ `dayCount` Ğ¾Ğ±Ğ½Ğ¾Ğ²Ğ¸Ğ»ÑÑ (Ğ¿Ğ¾ÑĞ»Ğµ ÑƒÑ‡ĞµÑ‚Ğ° Ğ²Ñ‹Ñ…Ğ¾Ğ´Ğ½Ñ‹Ñ…),
    // Ğ¼Ñ‹ Ğ·Ğ°Ğ¿ÑƒÑĞºĞ°ĞµĞ¼ `syncWithDateStore`, ĞºĞ¾Ñ‚Ğ¾Ñ€Ñ‹Ğ¹ Ğ¿ĞµÑ€ĞµÑÑ‡Ğ¸Ñ‚Ñ‹Ğ²Ğ°ĞµÑ‚ ÑĞºĞ¸Ğ´ĞºÑƒ,
    // Ğ¸ÑĞ¿Ğ¾Ğ»ÑŒĞ·ÑƒÑ ÑƒĞ¶Ğµ ĞºĞ¾Ñ€Ñ€ĞµĞºÑ‚Ğ½Ğ¾Ğµ ĞºĞ¾Ğ»Ğ¸Ñ‡ĞµÑÑ‚Ğ²Ğ¾ Ğ´Ğ½ĞµĞ¹.
    useEffect(() => {
        syncWithDateStore();
    }, [dayCount, syncWithDateStore]);
    // ----------------------------

    const handleApplyPromoCode = async () => {
        const currentItems = useReserveStore.getState().items;
        const currentDays = useDateStore.getState().dayCount;

        if (currentItems.length === 0) {
            toast.info("Ğ’Ñ‹Ğ±ĞµÑ€Ğ¸Ñ‚Ğµ Ğ¾Ğ±Ğ¾Ñ€ÑƒĞ´Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ, Ñ‡Ñ‚Ğ¾Ğ±Ñ‹ Ğ¿Ñ€Ğ¸Ğ¼ĞµĞ½Ğ¸Ñ‚ÑŒ Ğ¿Ñ€Ğ¾Ğ¼Ğ¾ĞºĞ¾Ğ´.");
            return;
        }
        if (!promoCode) {
            toast.info("Ğ’Ğ²ĞµĞ´Ğ¸Ñ‚Ğµ Ğ¿Ñ€Ğ¾Ğ¼Ğ¾ĞºĞ¾Ğ´");
            return;
        }

        const totalDailyRate = currentItems.reduce((sum, item) => sum + item.daily_rate, 0);
        const orderAmount = totalDailyRate * currentDays;

        setIsApplyingPromoCode(true);
        try {
            const response = await api.post("/promocodes/validate", {
                code: promoCode,
                order_amount: orderAmount,
                equipment_ids: currentItems.map(item => item.id)
            });
            setPromoCodeResult(response.data.discount_percentage, response.data.message);
            toast.success(response.data.message);
        } catch (error: unknown) {
            const apiError = error as { response?: { data?: { detail?: string } } }
            const errorMessage = apiError.response?.data?.detail || "ĞĞµ ÑƒĞ´Ğ°Ğ»Ğ¾ÑÑŒ Ğ¿Ñ€Ğ¸Ğ¼ĞµĞ½Ğ¸Ñ‚ÑŒ Ğ¿Ñ€Ğ¾Ğ¼Ğ¾ĞºĞ¾Ğ´";
            setPromoCodeResult(0, errorMessage);
            toast.error(errorMessage);
        } finally {
            setIsApplyingPromoCode(false);
        }
    };

    const handleSliderChange = useCallback((event: ChangeEvent<HTMLInputElement>) => {
        const newDays = Number(event.target.value);

        if (debounceTimeoutRef.current) {
            clearTimeout(debounceTimeoutRef.current);
        }

        debounceTimeoutRef.current = setTimeout(() => {
            setDaysFromSlider(newDays);
        }, 10);
    }, [setDaysFromSlider]);

    const totalDiscountPercentage = useMemo(() => durationDiscountPercentage + promoCodePercentage, [durationDiscountPercentage, promoCodePercentage]);

    const getDiscountInfo = (percent: number) => {
        if (percent >= 25) return {label: "ĞœĞ°ĞºÑĞ¸Ğ¼ÑƒĞ¼ Ğ²Ñ‹Ğ³Ğ¾Ğ´Ñ‹!", className: "text-amber-600 font-bold"};
        if (percent >= 20) return {label: "ĞÑ‚Ğ»Ğ¸Ñ‡Ğ½Ğ°Ñ ÑĞºĞ¸Ğ´ĞºĞ°!", className: "text-purple-600 font-bold"};
        if (percent >= 15) return {label: "Ğ¥Ğ¾Ñ€Ğ¾ÑˆĞ°Ñ ÑĞºĞ¸Ğ´ĞºĞ°", className: "text-green-600 font-bold"};
        if (percent > 0) return {label: "ĞĞµĞ±Ğ¾Ğ»ÑŒÑˆĞ°Ñ ÑĞºĞ¸Ğ´ĞºĞ°", className: "text-sky-600"};
        return {label: "Ğ¡ĞºĞ¸Ğ´ĞºĞ° Ğ·Ğ°Ğ²Ğ¸ÑĞ¸Ñ‚ Ğ¾Ñ‚ Ğ´Ğ½ĞµĞ¹", className: "text-gray-500"};
    };

    const discountInfo = getDiscountInfo(totalDiscountPercentage);
    const requirementMessage = items.length === 0 ? "Ğ’Ñ‹Ğ±ĞµÑ€Ğ¸Ñ‚Ğµ Ğ¾Ğ±Ğ¾Ñ€ÑƒĞ´Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ Ğ´Ğ»Ñ Ğ¿Ñ€Ğ¾Ğ¼Ğ¾ĞºĞ¾Ğ´Ğ°." : "";

    if (!isCalculatorVisible) {
        return (
            <Card
                className="my-4 bg-gray-50/50 hover:bg-gray-100 cursor-pointer transition"
                onClick={toggleCalculator}
            >
                <CardContent className="p-3">
                    <div className="flex items-center justify-between">
                        <div className="flex items-center gap-3">
                            <Percent className="w-5 h-5 text-purple-500"/>
                            <div className="text-sm">
                                <p className="text-gray-800">
                                    <span className="text-base font-bold text-purple-600">Ğ•ÑÑ‚ÑŒ Ğ¿Ñ€Ğ¾Ğ¼Ğ¾ĞºĞ¾Ğ´?</span>
                                    <span className="font-medium"> Ğ¸Ğ»Ğ¸ Ñ…Ğ¾Ñ‚Ğ¸Ñ‚Ğµ Ñ€Ğ°ÑÑÑ‡Ğ¸Ñ‚Ğ°Ñ‚ÑŒ ÑĞºĞ¸Ğ´ĞºÑƒ?</span>
                                </p>
                            </div>
                        </div>
                        <ChevronRight className="w-5 h-5 text-gray-400"/>
                    </div>
                </CardContent>
            </Card>
        );
    }

    return (
        <Card className="my-4 bg-white border-sky-200 shadow-md">
            <CardContent className="p-4">
                <div className="flex flex-col md:flex-row items-center justify-between gap-6 w-full">
                    <div className="w-full md:flex-1">
                        <Label htmlFor="days-slider" className="mb-2 block text-sm text-gray-700">
                            ĞšĞ¾Ğ»Ğ¸Ñ‡ĞµÑÑ‚Ğ²Ğ¾ Ğ´Ğ½ĞµĞ¹: <span className="font-bold">{dayCount}</span>
                            <span className="ml-2 text-xs text-gray-500">(Ğ´Ğ²Ğ¸Ğ³Ğ°Ğ¹Ñ‚Ğµ Ğ¿Ğ¾Ğ»Ğ·ÑƒĞ½Ğ¾Ğº Ğ´Ğ»Ñ Ğ¸Ğ·Ğ¼ĞµĞ½ĞµĞ½Ğ¸Ñ Ğ´Ğ°Ñ‚)</span>
                        </Label>
                        <input id="days-slider" type="range" min="1" max="30" value={dayCount} onChange={handleSliderChange}
                               className="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer accent-sky-600"/>
                    </div>
                    <div className="flex-shrink-0 text-center bg-sky-50 py-2 px-4 rounded-lg border w-full md:w-auto min-w-[160px]">
                        {isLoadingTiers ? (
                            <div className="flex items-center justify-center text-gray-500"><Loader2 className="h-4 w-4 animate-spin mr-2" /> Ğ—Ğ°Ğ³Ñ€ÑƒĞ·ĞºĞ°...</div>
                        ) : (
                            <>
                                <div className={`text-2xl font-bold transition-colors duration-300 ${discountInfo.className}`}>Ğ¡ĞºĞ¸Ğ´ĞºĞ°: {totalDiscountPercentage}%</div>
                                <p className={`text-xs mt-1 transition-colors duration-300 ${discountInfo.className}`}>{discountInfo.label}</p>
                            </>
                        )}
                    </div>
                    <div className="w-full md:flex-1">
                        <PromoCodeInput
                            promoCode={promoCode}
                            setPromoCode={setPromoCode}
                            applyPromoCode={handleApplyPromoCode}
                            removePromoCode={removePromoCode}
                            promoCodeMessage={promoCodeMessage}
                            isLoading={isApplyingPromoCode}
                            requirementMessage={requirementMessage}
                        />
                    </div>
                </div>
            </CardContent>
        </Card>
    );
}

```


## <a name="rentalappmainsrccomponentsEquipmentGridtsx"></a>`rental-app-main/src/components/EquipmentGrid.tsx`

```tsx
// path: rental-app-main/src/components/EquipmentGrid.tsx

// src/components/EquipmentGrid.tsx

import EquipmentCard from '@/components/equipment-card';
import CompactEquipmentCard from '@/components/CompactEquipmentCard';
import { Button } from "@/components/ui/button";
import { PackageSearch, FilterX, Loader2 } from "lucide-react";
import type { Equipment } from "@/types/equipment";
// âœ… Ğ˜Ğ¡ĞŸĞ ĞĞ’Ğ›Ğ•ĞĞ˜Ğ•: Ğ”Ğ¾Ğ±Ğ°Ğ²Ğ»ÑĞµĞ¼ Ğ¸Ğ¼Ğ¿Ğ¾Ñ€Ñ‚ Ğ½ĞµĞ´Ğ¾ÑÑ‚Ğ°ÑÑ‰Ğ¸Ñ… Ñ‚Ğ¸Ğ¿Ğ¾Ğ²
import type { AvailabilityInfo, DayStatus, EquipmentStatus } from "@/types/availability";
import type { ViewMode } from '@/store/viewModeStore';

interface EquipmentGridProps {
    isLoading: boolean;
    items: Equipment[];
    // âœ… Ğ˜Ğ¡ĞŸĞ ĞĞ’Ğ›Ğ•ĞĞ˜Ğ•: Ğ£Ğ±Ğ¸Ñ€Ğ°ĞµĞ¼ Ğ½ĞµĞ¸ÑĞ¿Ğ¾Ğ»ÑŒĞ·ÑƒĞµĞ¼Ñ‹Ğ¹ Ğ¿Ğ°Ñ€Ğ°Ğ¼ĞµÑ‚Ñ€
    // totalItemCount: number;
    hasActiveFilters: boolean;
    getEquipmentStatus: (eq: Equipment) => EquipmentStatus | "my_reservation" | "added";
    dailyAvailabilityData?: Record<number, Record<string, DayStatus>>;
    availabilityData?: AvailabilityInfo[];
    onShowMore: () => void;
    onResetFilters: () => void;
    viewMode: ViewMode;
    isFetchingNextPage: boolean;
    hasNextPage: boolean | undefined;
}

export default function EquipmentGrid({
                                          isLoading,
                                          items,
                                          // âœ… Ğ˜Ğ¡ĞŸĞ ĞĞ’Ğ›Ğ•ĞĞ˜Ğ•: Ğ£Ğ±Ğ¸Ñ€Ğ°ĞµĞ¼ Ğ½ĞµĞ¸ÑĞ¿Ğ¾Ğ»ÑŒĞ·ÑƒĞµĞ¼Ñ‹Ğ¹ Ğ¿Ğ°Ñ€Ğ°Ğ¼ĞµÑ‚Ñ€
                                          // totalItemCount,
                                          hasActiveFilters,
                                          getEquipmentStatus,
                                          dailyAvailabilityData,
                                          availabilityData,
                                          onShowMore,
                                          onResetFilters,
                                          viewMode,
                                          isFetchingNextPage,
                                          hasNextPage,
                                      }: EquipmentGridProps) {

    if (isLoading && items.length === 0) {
        return <p className="text-gray-500 text-sm col-span-full text-center py-5">Ğ—Ğ°Ğ³Ñ€ÑƒĞ·ĞºĞ° Ğ¾Ğ±Ğ¾Ñ€ÑƒĞ´Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ...</p>;
    }

    if (items.length === 0) {
        return (
            <div className="col-span-full my-8">
                <div className="flex flex-col items-center justify-center text-center p-8 space-y-4 bg-gray-50/50 rounded-lg border-2 border-dashed">
                    {hasActiveFilters ? <FilterX className="w-16 h-16 text-gray-400" /> : <PackageSearch className="w-16 h-16 text-gray-400" />}
                    <div className="space-y-1">
                        <h3 className="text-lg font-semibold text-gray-800">{hasActiveFilters ? "ĞĞ¸Ñ‡ĞµĞ³Ğ¾ Ğ½Ğµ Ğ½Ğ°Ğ¹Ğ´ĞµĞ½Ğ¾" : "ĞšĞ°Ñ‚Ğ°Ğ»Ğ¾Ğ³ Ğ¿Ğ¾ĞºĞ° Ğ¿ÑƒÑÑ‚"}</h3>
                        <p className="text-sm text-gray-500">{hasActiveFilters ? "ĞŸĞ¾Ğ¿Ñ€Ğ¾Ğ±ÑƒĞ¹Ñ‚Ğµ Ğ¸Ğ·Ğ¼ĞµĞ½Ğ¸Ñ‚ÑŒ Ğ¸Ğ»Ğ¸ ÑĞ±Ñ€Ğ¾ÑĞ¸Ñ‚ÑŒ Ñ„Ğ¸Ğ»ÑŒÑ‚Ñ€Ñ‹." : "Ğ—Ğ´ĞµÑÑŒ Ğ¿Ğ¾ÑĞ²Ğ¸Ñ‚ÑÑ Ğ¾Ğ±Ğ¾Ñ€ÑƒĞ´Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ Ğ´Ğ»Ñ Ğ°Ñ€ĞµĞ½Ğ´Ñ‹."}</p>
                    </div>
                    {hasActiveFilters && (
                        <div className="mt-4">
                            <Button variant="outline" onClick={onResetFilters}>
                                Ğ¡Ğ±Ñ€Ğ¾ÑĞ¸Ñ‚ÑŒ Ñ„Ğ¸Ğ»ÑŒÑ‚Ñ€Ñ‹
                            </Button>
                        </div>
                    )}
                </div>
            </div>
        );
    }

    const gridClasses = viewMode === "compact"
        ? "grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 2xl:grid-cols-5 gap-3 mt-4"
        : "grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-4 sm:gap-6 mt-4";

    return (
        <>
            <div className={gridClasses}>
                {items.map((eq) => {
                    const availability = availabilityData?.find(a => a.equipment_id === eq.id);
                    const equipmentDailyStatus = dailyAvailabilityData?.[eq.id];
                    const status = getEquipmentStatus(eq);

                    const equipmentProps = {
                        equipment: eq,
                        status,
                        startDate: availability?.start_date ?? undefined,
                        endDate: availability?.end_date ?? undefined,
                        dailyStatus: equipmentDailyStatus,
                    };

                    return viewMode === "compact" ? (
                        <CompactEquipmentCard key={eq.id} {...equipmentProps} />
                    ) : (
                        <EquipmentCard key={eq.id} {...equipmentProps} />
                    );
                })}
            </div>
            {hasNextPage && (
                <div className="flex justify-center mt-8">
                    <Button
                        variant="outline"
                        onClick={onShowMore}
                        disabled={isFetchingNextPage}
                    >
                        {isFetchingNextPage ? (
                            <>
                                <Loader2 className="mr-2 h-4 w-4 animate-spin" />
                                Ğ—Ğ°Ğ³Ñ€ÑƒĞ·ĞºĞ°...
                            </>
                        ) : (
                            "ĞŸĞ¾ĞºĞ°Ğ·Ğ°Ñ‚ÑŒ ĞµÑ‰Ñ‘"
                        )}
                    </Button>
                </div>
            )}
        </>
    );
}

```


## <a name="rentalappmainsrccomponentsErrorBoundarytsx"></a>`rental-app-main/src/components/ErrorBoundary.tsx`

```tsx
// path: rental-app-main/src/components/ErrorBoundary.tsx

// src/components/ErrorBoundary.tsx

import { ErrorBoundary as ReactErrorBoundary } from "react-error-boundary"
import ErrorMessage from "./ErrorMessage"

type Props = {
    children: React.ReactNode
}

/**
 * Ğ“Ğ»Ğ¾Ğ±Ğ°Ğ»ÑŒĞ½Ñ‹Ğ¹ Ğ¾Ğ±Ñ€Ğ°Ğ±Ğ¾Ñ‚Ñ‡Ğ¸Ğº Ğ¾ÑˆĞ¸Ğ±Ğ¾Ğº Ğ´Ğ»Ñ Ğ²ÑĞµĞ³Ğ¾ Ğ¿Ñ€Ğ¸Ğ»Ğ¾Ğ¶ĞµĞ½Ğ¸Ñ.
 * ĞŸĞ¾ĞºĞ°Ğ·Ñ‹Ğ²Ğ°ĞµÑ‚ ĞºĞ¾Ğ¼Ğ¿Ğ¾Ğ½ĞµĞ½Ñ‚ `ErrorMessage` Ğ¿Ñ€Ğ¸ ÑĞ±Ğ¾Ğµ Ğ´ĞµÑ€ĞµĞ²Ğ° ĞºĞ¾Ğ¼Ğ¿Ğ¾Ğ½ĞµĞ½Ñ‚Ğ¾Ğ².
 */
export default function ErrorBoundary({ children }: Props) {
    return (
        <ReactErrorBoundary
            fallbackRender={({ error, resetErrorBoundary }) => (
                <ErrorMessage error={error} onRetry={resetErrorBoundary} />
            )}
        >
            {children}
        </ReactErrorBoundary>
    )
}


```


## <a name="rentalappmainsrccomponentsErrorMessagetsx"></a>`rental-app-main/src/components/ErrorMessage.tsx`

```tsx
// path: rental-app-main/src/components/ErrorMessage.tsx

import { AlertCircle, RotateCcw } from "lucide-react"

type Props = {
    error: Error
    onRetry?: () => void
}

export default function ErrorMessage({ error, onRetry }: Props) {
    return (
        <div className="bg-red-50 border border-red-300 text-red-700 p-4 rounded-md shadow-sm text-sm">
            <div className="flex items-start gap-2">
                <AlertCircle className="w-4 h-4 mt-0.5" />
                <div>
                    <p className="font-semibold mb-1">ĞŸÑ€Ğ¾Ğ¸Ğ·Ğ¾ÑˆĞ»Ğ° Ğ¾ÑˆĞ¸Ğ±ĞºĞ°:</p>
                    <pre className="whitespace-pre-wrap break-words">{error.message}</pre>
                </div>
            </div>
            {onRetry && (
                <button
                    onClick={onRetry}
                    className="mt-3 inline-flex items-center text-sm text-sky-700 hover:underline"
                >
                    <RotateCcw className="w-4 h-4 mr-1" />
                    ĞŸĞ¾Ğ²Ñ‚Ğ¾Ñ€Ğ¸Ñ‚ÑŒ
                </button>
            )}
        </div>
    )
}


```


## <a name="rentalappmainsrccomponentsFilterPaneltsx"></a>`rental-app-main/src/components/FilterPanel.tsx`

```tsx
// path: rental-app-main/src/components/FilterPanel.tsx

// src/components/FilterPanel.tsx

import SearchInput from "@/components/SearchInput";
import AvailableCheckbox from "@/components/AvailableCheckbox";
import TypeFilter from "@/components/TypeFilter";
import BrandFilter from "@/components/BrandFilter";
import AssociationFilter from "@/components/AssociationFilter";
import ViewModeToggle from "@/components/ViewModeToggle";
import type { Equipment } from "@/types/equipment";

interface FilterPanelProps {
    // âœ… Ğ¢Ğ¸Ğ¿Ğ¸Ğ·Ğ°Ñ†Ğ¸Ñ Ğ½Ğµ Ğ¼ĞµĞ½ÑĞµÑ‚ÑÑ, Ğ½Ğ¾ Ñ‚ĞµĞ¿ĞµÑ€ÑŒ ÑÑĞ´Ğ° Ğ±ÑƒĞ´ĞµÑ‚ Ğ¿Ñ€Ğ¸Ñ…Ğ¾Ğ´Ğ¸Ñ‚ÑŒ Ğ¿Ğ¾Ğ»Ğ½Ñ‹Ğ¹ ÑĞ¿Ğ¸ÑĞ¾Ğº
    equipmentData: Equipment[];
}

export default function FilterPanel({ equipmentData }: FilterPanelProps) {
    return (
        <div className="bg-white border border-gray-200 shadow-sm rounded-lg p-4 space-y-4">
            <div className="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4">
                <SearchInput />
                <div className="flex items-center gap-2">
                    <AvailableCheckbox />
                    <ViewModeToggle />
                </div>
            </div>
            <div className="flex flex-wrap gap-2 sm:gap-3">
                {/* âœ… ĞŸĞµÑ€ĞµĞ´Ğ°ĞµĞ¼ Ğ¿Ğ¾Ğ»Ğ½Ñ‹Ğ¹ ÑĞ¿Ğ¸ÑĞ¾Ğº Ğ´Ğ°Ğ»ÑŒÑˆĞµ */}
                <TypeFilter items={equipmentData} />
            </div>
            <div className="flex flex-wrap gap-2 sm:gap-3">
                {/* âœ… AssociationFilter ÑƒĞ¶Ğµ Ğ¿Ğ¾Ğ»ÑƒÑ‡Ğ°ĞµÑ‚ Ğ¿Ğ¾Ğ»Ğ½Ñ‹Ğ¹ ÑĞ¿Ğ¸ÑĞ¾Ğº Ğ°ÑÑĞ¾Ñ†Ğ¸Ğ°Ñ†Ğ¸Ğ¹ Ğ¸Ğ· ÑĞ²Ğ¾ĞµĞ³Ğ¾ Ñ…ÑƒĞºĞ°, ĞµĞ³Ğ¾ Ñ‚Ñ€Ğ¾Ğ³Ğ°Ñ‚ÑŒ Ğ½Ğµ Ğ½Ğ°Ğ´Ğ¾ */}
                <AssociationFilter />
            </div>
            <div className="flex flex-wrap gap-2 sm:gap-3">
                {/* âœ… ĞŸĞµÑ€ĞµĞ´Ğ°ĞµĞ¼ Ğ¿Ğ¾Ğ»Ğ½Ñ‹Ğ¹ ÑĞ¿Ğ¸ÑĞ¾Ğº Ğ´Ğ°Ğ»ÑŒÑˆĞµ */}
                <BrandFilter items={equipmentData} />
            </div>
        </div>
    );
}

```


## <a name="rentalappmainsrccomponentsMyReservationListtsx"></a>`rental-app-main/src/components/MyReservationList.tsx`

```tsx
// path: rental-app-main/src/components/MyReservationList.tsx

// src/components/MyReservationList.tsx

import { useMemo, useState } from "react";
import { useReservations } from "@/hooks/useReservations";
import { useAllEquipment } from "@/hooks/useAllEquipment";
import { ReservationService } from "@/core/services";
import ReservationCard from "./ReservationCard";
import { Checkbox } from "@/components/ui/checkbox";
import { useNavigate } from "react-router-dom";
import { useReserveStore } from "@/store/reserveStore";
import { useDateStore } from "@/store/dateStore";
import { Button } from "@/components/ui/button";
import { FileText, FilterX } from "lucide-react";
import ConfirmItemRemovalDialog from "./ConfirmItemRemovalDialog";

import type { Equipment } from "@/types/equipment";
import type { Reservation, ReservationWithNames } from "@/types/reservation";

interface MyReservationListProps {
    continueEditingReservationId?: number;
    highlightId?: number | null;
    reservationsData?: Reservation[];
    isLoading?: boolean;
    isError?: boolean;
}

const LoadingState = () => (
    <p className="text-center py-4">Ğ—Ğ°Ğ³Ñ€ÑƒĞ·ĞºĞ° Ğ´Ğ°Ğ½Ğ½Ñ‹Ñ…...</p>
);

const ErrorState = ({ message }: { message: string }) => (
    <p className="text-red-600 text-center py-4">{message}</p>
);

export default function MyReservationList({
                                              continueEditingReservationId,
                                              highlightId,
                                              reservationsData: propReservationsData,
                                              isLoading: propIsLoading,
                                              isError: propIsError,
                                          }: MyReservationListProps) {
    const { data: allEquipment = [], isLoading: isLoadingEquipment, isError: isEquipmentError } = useAllEquipment();

    const equipmentMap = useMemo(() => {
        const map: Record<number, Equipment> = {};
        allEquipment.forEach(e => { map[e.id] = e; });
        return map;
    }, [allEquipment]);

    const { deleteReservation, updateReservation } = useReservations();

    // Ğ˜ÑĞ¿Ğ¾Ğ»ÑŒĞ·ÑƒĞµĞ¼ Ğ´Ğ°Ğ½Ğ½Ñ‹Ğµ Ğ¸Ğ· Ğ¿Ñ€Ğ¾Ğ¿ÑĞ¾Ğ² Ğ¸Ğ»Ğ¸ Ğ·Ğ°Ğ³Ñ€ÑƒĞ¶Ğ°ĞµĞ¼ Ğ¸Ñ… ÑĞ°Ğ¼Ğ¾ÑÑ‚Ğ¾ÑÑ‚ĞµĞ»ÑŒĞ½Ğ¾
    const reservationsData: Reservation[] = useMemo(() => propReservationsData ?? [], [propReservationsData]);
    const isLoadingReservations = propIsLoading ?? false;
    const isReservationsError = propIsError ?? false;

    const navigate = useNavigate();
    const reserveStore = useReserveStore();
    const dateStore = useDateStore();

    const [deletingId, setDeletingId] = useState<number | null>(null);
    const [hideCompleted, setHideCompleted] = useState<boolean>(false);
    const [itemToRemove, setItemToRemove] = useState<{ reservationId: number; equipmentId: number } | null>(null);

    const reservationsWithNames: ReservationWithNames[] = useMemo(() =>
            ReservationService.createReservationsWithNames(reservationsData, equipmentMap),
        [reservationsData, equipmentMap]
    );

    const filteredByStatus = useMemo(() =>
            hideCompleted
                ? reservationsWithNames.filter((r: ReservationWithNames) => 
                    // Ğ¡ĞºÑ€Ñ‹Ğ²Ğ°ĞµĞ¼ Ñ€ĞµĞ·ĞµÑ€Ğ²Ñ‹ ÑĞ¾ ÑÑ‚Ğ°Ñ‚ÑƒÑĞ°Ğ¼Ğ¸ 'fulfilled' (Ğ²Ñ‹Ğ´Ğ°Ğ½ Ğ² Ğ°Ñ€ĞµĞ½Ğ´Ñƒ) Ğ¸ 'cancelled' (Ğ¾Ñ‚Ğ¼ĞµĞ½ĞµĞ½)
                    r.status !== 'fulfilled' && r.status !== 'cancelled'
                )
                : reservationsWithNames,
        [hideCompleted, reservationsWithNames]
    );

    // Ğ¢ĞµĞ¿ĞµÑ€ÑŒ Ğ´Ğ°Ğ½Ğ½Ñ‹Ğµ ÑƒĞ¶Ğµ Ğ¾Ñ‚Ñ„Ğ¸Ğ»ÑŒÑ‚Ñ€Ğ¾Ğ²Ğ°Ğ½Ñ‹ Ğ¸ Ğ¾Ñ‚ÑĞ¾Ñ€Ñ‚Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ñ‹ Ğ½Ğ° ÑĞµÑ€Ğ²ĞµÑ€Ğµ
    const finalReservations = filteredByStatus;

    if (isLoadingReservations || isLoadingEquipment) {
        return <LoadingState />;
    }

    if (isReservationsError) {
        return <ErrorState message="ĞÑˆĞ¸Ğ±ĞºĞ° Ğ·Ğ°Ğ³Ñ€ÑƒĞ·ĞºĞ¸ Ñ€ĞµĞ·ĞµÑ€Ğ²Ğ¾Ğ²" />;
    }

    if (isEquipmentError) {
        return <ErrorState message="ĞÑˆĞ¸Ğ±ĞºĞ° Ğ·Ğ°Ğ³Ñ€ÑƒĞ·ĞºĞ¸ Ğ¾Ğ±Ğ¾Ñ€ÑƒĞ´Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ" />;
    }

    const cancelReservation = async (id: number) => {
        setDeletingId(id);
        try {
            await deleteReservation.mutateAsync(id);
        } catch (error) {
            console.error(`[MyReservationList] Error cancelling reservation ${id}:`, error);
            alert("ĞÑˆĞ¸Ğ±ĞºĞ° Ğ¿Ñ€Ğ¸ Ğ¾Ñ‚Ğ¼ĞµĞ½Ğµ Ñ€ĞµĞ·ĞµÑ€Ğ²Ğ°.");
        } finally {
            setDeletingId(null);
        }
    };

    const removeItemFromReservation = async (
        reservationId: number,
        equipmentIdToRemove: number
    ) => {
        const reservation = reservationsData.find((r: Reservation) => r.id === reservationId);
        if (!reservation) return;

        const newEquipmentIdsList = reservation.equipment_ids.filter((id: number) => id !== equipmentIdToRemove);
        try {
            if (newEquipmentIdsList.length === 0) {
                await deleteReservation.mutateAsync(reservationId);
            } else {
                await updateReservation.mutateAsync({
                    id: reservationId,
                    equipment_ids: newEquipmentIdsList,
                    start_date: reservation.start_date,
                    end_date: reservation.end_date,
                });
            }
        } catch (error) {
            console.error(`[MyReservationList] Error removing equipment from reservation:`, error);
            alert("ĞÑˆĞ¸Ğ±ĞºĞ° Ğ¿Ñ€Ğ¸ ÑƒĞ´Ğ°Ğ»ĞµĞ½Ğ¸Ğ¸ Ğ¿Ğ¾Ğ·Ğ¸Ñ†Ğ¸Ğ¸ Ğ¸Ğ· Ñ€ĞµĞ·ĞµÑ€Ğ²Ğ°.");
        }
    };

    const requestItemRemoval = (reservationId: number, equipmentId: number) => {
        setItemToRemove({ reservationId, equipmentId });
    };

    const confirmItemRemoval = () => {
        if (itemToRemove) {
            void removeItemFromReservation(itemToRemove.reservationId, itemToRemove.equipmentId)
                .finally(() => {
                    setItemToRemove(null);
                });
        }
    };

    const cancelItemRemoval = () => {
        setItemToRemove(null);
    };


    const repeatReservation = (r: ReservationWithNames) => {
        reserveStore.clear();
        const validEquipment = r.equipment_ids
            .map((id: number) => equipmentMap[id])
            .filter((eq): eq is Equipment => Boolean(eq));
        reserveStore.bulkAdd(validEquipment);
        dateStore.setRange(new Date(r.start_date), new Date(r.end_date));
        navigate("/", {
            state: {
                intent: "add_to_existing_reservation",
                reservationId: r.id,
                startDate: r.start_date,
                endDate: r.end_date,
                equipmentIds: r.equipment_ids
            }
        });
    };

    const renderedCards = finalReservations
        .map((r: ReservationWithNames) => {
            const equipmentListForCard = r.equipment_ids
                .map((id: number) => {
                    const eq = equipmentMap[id];
                    return eq ? { id, label: `${eq.equipment_type} ${eq.brand} ${eq.name}` } : null;
                })
                .filter((item): item is { id: number; label: string } => Boolean(item));

            if (r.equipment_ids.length === 0) {
                return null;
            }

            const autoStartEditForThisCard = r.id === continueEditingReservationId;

            return (
                <ReservationCard
                    key={`${r.id}-${r.equipment_ids.join('-')}-${r.start_date}-${r.end_date}`}
                    id={r.id}
                    start_date={r.start_date}
                    end_date={r.end_date}
                    status={r.status}
                    equipment={equipmentListForCard}
                    onCancel={() => cancelReservation(r.id)}
                    cancelDisabled={deletingId === r.id}
                    onRemoveItem={(equipmentId) => requestItemRemoval(r.id, equipmentId)}
                    onRepeat={() => repeatReservation(r)}
                    autoStartEdit={autoStartEditForThisCard}
                    total_cost={r.total_cost}
                    discount_amount={r.discount_amount}
                    promo_code={r.promo_code}
                    selected_accessories={r.selected_accessories}
                    accessory_links={r.accessory_links}
                    highlightId={highlightId}
                    rental_id={r.rental_id}
                />
            );
        })
        .filter(Boolean);

    const hasFilters = (filteredByStatus.length > 0) &&
        finalReservations.length === 0 &&
        reservationsData.length > 0;

    return (
        <div>
            <div className="mb-4 flex items-center gap-2">
                <Checkbox
                    id="hideCompleted"
                    checked={hideCompleted}
                    onCheckedChange={(checked) => setHideCompleted(Boolean(checked))}
                />
                <label htmlFor="hideCompleted" className="text-sm text-gray-700">
                    Ğ¡ĞºÑ€Ñ‹Ñ‚ÑŒ Ğ·Ğ°Ğ²ĞµÑ€ÑˆÑ‘Ğ½Ğ½Ñ‹Ğµ Ñ€ĞµĞ·ĞµÑ€Ğ²Ñ‹
                </label>
            </div>
            {renderedCards.length === 0 ? (
                <div className="my-8">
                    <div className="flex flex-col items-center justify-center text-center p-8 space-y-4 bg-gray-50/50 rounded-lg border-2 border-dashed">
                        {hasFilters ? <FilterX className="w-16 h-16 text-gray-400" /> : <FileText className="w-16 h-16 text-gray-400" />}
                        <div className="space-y-1">
                            <h3 className="text-lg font-semibold text-gray-800">
                                {hasFilters ? "Ğ ĞµĞ·ĞµÑ€Ğ²Ñ‹ Ğ½Ğµ Ğ½Ğ°Ğ¹Ğ´ĞµĞ½Ñ‹" : "Ğ£ Ğ²Ğ°Ñ Ğ¿Ğ¾ĞºĞ° Ğ½ĞµÑ‚ Ñ€ĞµĞ·ĞµÑ€Ğ²Ğ¾Ğ²"}
                            </h3>
                            <p className="text-sm text-gray-500">
                                {hasFilters
                                    ? "ĞĞ¸ Ğ¾Ğ´Ğ¸Ğ½ Ğ¸Ğ· Ğ²Ğ°ÑˆĞ¸Ñ… Ñ€ĞµĞ·ĞµÑ€Ğ²Ğ¾Ğ² Ğ½Ğµ ÑĞ¾Ğ¾Ñ‚Ğ²ĞµÑ‚ÑÑ‚Ğ²ÑƒĞµÑ‚ Ğ·Ğ°Ğ´Ğ°Ğ½Ğ½Ñ‹Ğ¼ Ñ„Ğ¸Ğ»ÑŒÑ‚Ñ€Ğ°Ğ¼."
                                    : "Ğ—Ğ´ĞµÑÑŒ Ğ±ÑƒĞ´ÑƒÑ‚ Ğ¾Ñ‚Ğ¾Ğ±Ñ€Ğ°Ğ¶Ğ°Ñ‚ÑŒÑÑ Ğ²Ğ°ÑˆĞ¸ Ğ±ÑƒĞ´ÑƒÑ‰Ğ¸Ğµ Ğ¸ Ğ¿Ñ€Ğ¾ÑˆĞ»Ñ‹Ğµ Ğ±Ñ€Ğ¾Ğ½Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ."}
                            </p>
                        </div>
                        {!hasFilters && (
                            <div className="mt-4">
                                <Button onClick={() => navigate("/")}>Ğ¡Ğ¾Ğ·Ğ´Ğ°Ñ‚ÑŒ Ğ¿ĞµÑ€Ğ²Ñ‹Ğ¹ Ñ€ĞµĞ·ĞµÑ€Ğ²</Button>
                            </div>
                        )}
                    </div>
                </div>
            ) : (
                <ul className="space-y-4">{renderedCards}</ul>
            )}

            <ConfirmItemRemovalDialog
                open={!!itemToRemove}
                onClose={cancelItemRemoval}
                onConfirm={confirmItemRemoval}
                isConfirming={updateReservation.isPending || deleteReservation.isPending}
            />
        </div>
    );
}

```


## <a name="rentalappmainsrccomponentsNetworkStatustsx"></a>`rental-app-main/src/components/NetworkStatus.tsx`

```tsx
// path: rental-app-main/src/components/NetworkStatus.tsx

// src/components/NetworkStatus.tsx
import { useNetworkStatus } from "@/hooks/useNetworkStatus"
import { WifiOff, Wifi } from "lucide-react"

export default function NetworkStatus() {
    const isOnline = useNetworkStatus()

    return (
        <div
            className={`fixed bottom-4 left-4 z-50 text-xs font-medium px-3 py-1.5 rounded-md shadow-lg transition
      ${isOnline ? "bg-green-100 text-green-700 border border-green-300" : "bg-red-100 text-red-700 border border-red-300"}
      `}
        >
            <div className="flex items-center gap-2">
                {isOnline ? <Wifi className="w-4 h-4" /> : <WifiOff className="w-4 h-4" />}
                {isOnline ? "Ğ’ ÑĞµÑ‚Ğ¸" : "ĞĞµÑ‚ Ğ¿Ğ¾Ğ´ĞºĞ»ÑÑ‡ĞµĞ½Ğ¸Ñ"}
            </div>
        </div>
    )
}


```


## <a name="rentalappmainsrccomponentsPromoCodeInputtsx"></a>`rental-app-main/src/components/PromoCodeInput.tsx`

```tsx
// path: rental-app-main/src/components/PromoCodeInput.tsx

// src/components/PromoCodeInput.tsx
import { Input } from "@/components/ui/input";
import { Button } from "@/components/ui/button";
import { Label } from "@/components/ui/label";
import { TicketPercent, CheckCircle, XCircle, Loader2, AlertTriangle } from "lucide-react";
import { toast } from "sonner";

interface PromoCodeInputProps {
    promoCode: string;
    setPromoCode: (code: string) => void;
    applyPromoCode: () => void;
    removePromoCode?: () => void;
    promoCodeMessage: string;
    disabled?: boolean;
    isLoading?: boolean;
    requirementMessage?: string;
}

export default function PromoCodeInput({
                                           promoCode,
                                           setPromoCode,
                                           applyPromoCode,
                                           removePromoCode,
                                           promoCodeMessage,
                                           disabled = false,
                                           isLoading = false,
                                           requirementMessage,
                                       }: PromoCodeInputProps) {

    const handleApply = () => {
        if (!promoCode.trim()) {
            toast.info("ĞŸĞ¾Ğ¶Ğ°Ğ»ÑƒĞ¹ÑÑ‚Ğ°, Ğ²Ğ²ĞµĞ´Ğ¸Ñ‚Ğµ Ğ¿Ñ€Ğ¾Ğ¼Ğ¾ĞºĞ¾Ğ´.");
            return;
        }
        applyPromoCode();
    };

    const isApplied = promoCodeMessage && promoCodeMessage.length > 0;
    const isSuccess = isApplied && promoCodeMessage.includes("ÑƒÑĞ¿ĞµÑˆĞ½Ğ¾");
    const isDisabledByRequirement = !!requirementMessage;

    return (
        <div className="space-y-2">
            <div className="flex justify-between items-center">
                <Label htmlFor="promo-code" className="text-sm font-medium">Ğ•ÑÑ‚ÑŒ Ğ¿Ñ€Ğ¾Ğ¼Ğ¾ĞºĞ¾Ğ´?</Label>
                {/* Ğ‘Ñ‹Ğ»Ğ¾: {isSuccess && removePromoCode && ( */}
                {/* Ğ¡Ñ‚Ğ°Ğ»Ğ¾: Ğ£ÑĞ»Ğ¾Ğ²Ğ¸Ğµ Ñ‚ĞµĞ¿ĞµÑ€ÑŒ Ğ·Ğ°Ğ²Ğ¸ÑĞ¸Ñ‚ Ğ¾Ñ‚ Ğ½Ğ°Ğ»Ğ¸Ñ‡Ğ¸Ñ Ñ‚ĞµĞºÑÑ‚Ğ° Ğ² Ğ¿Ğ¾Ğ»Ğµ Ğ¿Ñ€Ğ¾Ğ¼Ğ¾ĞºĞ¾Ğ´Ğ° */}
                {promoCode && removePromoCode && (
                    <button onClick={removePromoCode} className="text-xs text-gray-500 hover:text-red-600 hover:underline">Ğ¡Ğ±Ñ€Ğ¾ÑĞ¸Ñ‚ÑŒ</button>
                )}
            </div>
            <div className="flex items-center gap-2">
                <div className="relative flex-grow">
                    <TicketPercent className="absolute left-2.5 top-2.5 h-4 w-4 text-gray-400" />
                    <Input
                        id="promo-code"
                        type="text"
                        placeholder="SALE15"
                        value={promoCode}
                        onChange={(e) => setPromoCode(e.target.value)}
                        disabled={disabled || isLoading || isSuccess || isDisabledByRequirement}
                        className="pl-8"
                    />
                    {isSuccess && promoCode && (
                        <CheckCircle className="absolute right-2.5 top-2.5 h-4 w-4 text-green-500" />
                    )}
                </div>
                <Button
                    type="button"
                    variant="outline"
                    onClick={handleApply}
                    disabled={disabled || isLoading || isSuccess || isDisabledByRequirement}
                >
                    {isLoading ? <Loader2 className="h-4 w-4 animate-spin" /> : "ĞŸÑ€Ğ¸Ğ¼ĞµĞ½Ğ¸Ñ‚ÑŒ"}
                </Button>
            </div>

            {isDisabledByRequirement && (
                <div className="flex items-center gap-1.5 text-xs mt-1.5 text-orange-600">
                    <AlertTriangle className="h-4 w-4" />
                    <span>{requirementMessage}</span>
                </div>
            )}

            {!isDisabledByRequirement && isApplied && (
                <div className={`flex items-center gap-1.5 text-xs mt-1.5 ${isSuccess ? "text-green-600" : "text-red-600"}`}>
                    {!isSuccess && <XCircle className="h-3.5 w-3.5" />}
                    <span>{promoCodeMessage}</span>
                </div>
            )}
        </div>
    );
}

```


## <a name="rentalappmainsrccomponentsRequireAuthtsx"></a>`rental-app-main/src/components/RequireAuth.tsx`

```tsx
// path: rental-app-main/src/components/RequireAuth.tsx

import { ReactNode } from "react"
import { Navigate, useLocation } from "react-router-dom"
import { useCurrentUser } from "@/hooks/useProfile"

type Props = {
    children: ReactNode
    role?: string | string[] // Ğ”Ğ¾Ğ±Ğ°Ğ²Ğ»ĞµĞ½ Ğ¿Ñ€Ğ¾Ğ¿Ñ role
}

export default function RequireAuth({ children, role }: Props) {
    const { data: user, isLoading } = useCurrentUser()
    const location = useLocation()

    if (isLoading) {
        return <p>Ğ—Ğ°Ğ³Ñ€ÑƒĞ·ĞºĞ° Ğ¿Ñ€Ğ¾Ñ„Ğ¸Ğ»Ñ...</p>
    }
    if (!user) {
        return <Navigate to="/" replace state={{ from: location.pathname }} />
    }
    // Ğ”Ğ¾Ğ±Ğ°Ğ²Ğ»ĞµĞ½Ğ° Ğ¿Ñ€Ğ¾Ğ²ĞµÑ€ĞºĞ° Ñ€Ğ¾Ğ»Ğ¸
    if (role && !(Array.isArray(role) ? role.includes(user.role) : user.role === role)) {
        return <Navigate to="/" replace state={{ from: location.pathname }} />
    }

    return <>{children}</>
}


```


## <a name="rentalappmainsrccomponentsReservationCardtsx"></a>`rental-app-main/src/components/ReservationCard.tsx`

```tsx
// path: rental-app-main/src/components/ReservationCard.tsx

// src/components/ReservationCard.tsx
import { useEffect, useMemo, useState } from "react";
import { useNavigate, useLocation } from "react-router-dom";
import { ReservationEditProvider } from "@/hooks/useInlineReservationEdit"; // âœ¨ Ğ˜Ğ¼Ğ¿Ğ¾Ñ€Ñ‚Ğ¸Ñ€ÑƒĞµĞ¼ Ğ¿Ñ€Ğ¾Ğ²Ğ°Ğ¹Ğ´ĞµÑ€
import EditableReservationCard from "./reservation/EditableReservationCard";
import ViewReservationCard from "./reservation/ViewReservationCard";
import type { Reservation, AccessoryLink } from "@/types/reservation";
import type { EquipmentDisplayDetail } from "@/hooks/reservation/useReservationState";

type Props = {
    id: number;
    equipment: EquipmentDisplayDetail[];
    start_date: string;
    end_date: string;
    status: Reservation['status'];
    onRemoveItem?: (equipmentId: number) => void;
    onCancel?: () => void;
    cancelDisabled?: boolean;
    onRepeat?: () => void;
    autoStartEdit?: boolean;
    total_cost?: number;
    discount_amount?: number;
    promo_code?: string | null;
    selected_accessories?: Record<number, number[]>;
    accessory_links?: AccessoryLink[];
    highlightId?: number | null;
    rental_id?: number | null;
};

export default function ReservationCard({
                                            id, equipment, start_date, end_date, status, onRemoveItem, onCancel,
                                            cancelDisabled, onRepeat, autoStartEdit = false,
                                            total_cost, discount_amount, promo_code, selected_accessories,
                                            accessory_links, highlightId, rental_id
                                        }: Props) {
    const navigate = useNavigate();
    const location = useLocation();

    // âœ¨ 1. Ğ£Ğ¿Ñ€Ğ°Ğ²Ğ»ÑĞµĞ¼ ÑĞ¾ÑÑ‚Ğ¾ÑĞ½Ğ¸ĞµĞ¼ Ñ€ĞµĞ´Ğ°ĞºÑ‚Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ Ğ¿Ñ€ÑĞ¼Ğ¾ Ğ·Ğ´ĞµÑÑŒ.
    const [isEditing, setIsEditing] = useState(autoStartEdit);
    const [hasAutoStarted, setHasAutoStarted] = useState(false);

    // Ğ­Ñ‚Ğ¾Ñ‚ Ğ¾Ğ±ÑŠĞµĞºÑ‚ Ğ²ÑĞµ ĞµÑ‰Ğµ Ğ½ÑƒĞ¶ĞµĞ½ Ğ´Ğ»Ñ Ğ¿ĞµÑ€ĞµĞ´Ğ°Ñ‡Ğ¸ Ğ² Ğ¿Ñ€Ğ¾Ğ²Ğ°Ğ¹Ğ´ĞµÑ€.
    const reservationForProvider: Reservation = useMemo(() => ({
        id, equipment_ids: equipment.map(e => e.id), start_date, end_date, status,
        total_cost, discount_amount, promo_code,
        selected_accessories: selected_accessories || {},
    }), [id, equipment, start_date, end_date, status, total_cost, discount_amount, promo_code, selected_accessories]);

    useEffect(() => {
        if (autoStartEdit && !isEditing && !hasAutoStarted) {
            setIsEditing(true);
            setHasAutoStarted(true);
        }
    }, [autoStartEdit, isEditing, hasAutoStarted]);


    // âœ¨ 2. ĞœÑ‹ Ğ±Ğ¾Ğ»ÑŒÑˆĞµ Ğ½Ğµ Ğ¸ÑĞ¿Ğ¾Ğ»ÑŒĞ·ÑƒĞµĞ¼ Ñ…ÑƒĞº useInlineReservationEdit Ğ½Ğ°Ğ¿Ñ€ÑĞ¼ÑƒÑ Ğ·Ğ´ĞµÑÑŒ.
    // Ğ’Ğ¼ĞµÑÑ‚Ğ¾ ÑÑ‚Ğ¾Ğ³Ğ¾ Ğ¼Ñ‹ ÑƒĞ¿Ñ€Ğ°Ğ²Ğ»ÑĞµĞ¼ ÑĞ¾ÑÑ‚Ğ¾ÑĞ½Ğ¸ĞµĞ¼ isEditing Ğ¸ Ñ€ĞµĞ½Ğ´ĞµÑ€Ğ¸Ğ¼ Ğ»Ğ¸Ğ±Ğ¾ View, Ğ»Ğ¸Ğ±Ğ¾ Provider+Edit.

    const isHighlighted = highlightId === id;

    return (
        <div className={`transition-all duration-300 ${
            isHighlighted 
                ? "ring-2 ring-sky-500 bg-sky-50 shadow-lg rounded-2xl" 
                : ""
        }`}>
            {isEditing ? (
                // âœ¨ 3. ĞĞ±Ğ¾Ñ€Ğ°Ñ‡Ğ¸Ğ²Ğ°ĞµĞ¼ ĞºĞ¾Ğ¼Ğ¿Ğ¾Ğ½ĞµĞ½Ñ‚ Ñ€ĞµĞ´Ğ°ĞºÑ‚Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ Ğ² Ğ½Ğ°Ñˆ Ğ½Ğ¾Ğ²Ñ‹Ğ¹ Ğ¿Ñ€Ğ¾Ğ²Ğ°Ğ¹Ğ´ĞµÑ€.
                <ReservationEditProvider
                    reservation={reservationForProvider}
                    initialEquipmentForDisplay={equipment}
                    onFullCancellation={onCancel}
                    isAdminContext={false}
                    // âœ¨ 4. ĞŸĞµÑ€ĞµĞ´Ğ°ĞµĞ¼ ĞºĞ¾Ğ»Ğ±ÑĞº Ğ´Ğ»Ñ Ğ·Ğ°Ğ²ĞµÑ€ÑˆĞµĞ½Ğ¸Ñ Ñ€ĞµĞ´Ğ°ĞºÑ‚Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ.
                    onFinishEditing={() => {
                        setIsEditing(false);
                        // Ğ•ÑĞ»Ğ¸ ÑÑ‚Ğ¾ Ğ±Ñ‹Ğ»Ğ¾ Ğ°Ğ²Ñ‚Ğ¾Ğ¼Ğ°Ñ‚Ğ¸Ñ‡ĞµÑĞºĞ¾Ğµ Ñ€ĞµĞ´Ğ°ĞºÑ‚Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ, Ñ‡Ğ¸ÑÑ‚Ğ¸Ğ¼ ÑÑ‚ĞµĞ¹Ñ‚ Ğ² location
                        if (autoStartEdit) {
                            navigate(location.pathname, { replace: true, state: {} });
                        }
                    }}
                >
                    {/* EditableReservationCard Ñ‚ĞµĞ¿ĞµÑ€ÑŒ Ğ½Ğµ Ğ¿Ñ€Ğ¸Ğ½Ğ¸Ğ¼Ğ°ĞµÑ‚ Ğ¿Ñ€Ğ¾Ğ¿ÑĞ¾Ğ²! */}
                    <EditableReservationCard />
                </ReservationEditProvider>
            ) : (
                <ViewReservationCard
                    id={id}
                    equipment={equipment}
                    start_date={start_date}
                    end_date={end_date}
                    status={status}
                    // âœ¨ 5. ĞšĞ½Ğ¾Ğ¿ĞºĞ° "Ğ ĞµĞ´Ğ°ĞºÑ‚Ğ¸Ñ€Ğ¾Ğ²Ğ°Ñ‚ÑŒ" Ñ‚ĞµĞ¿ĞµÑ€ÑŒ Ğ¿Ñ€Ğ¾ÑÑ‚Ğ¾ Ğ¿ĞµÑ€ĞµĞºĞ»ÑÑ‡Ğ°ĞµÑ‚ Ğ»Ğ¾ĞºĞ°Ğ»ÑŒĞ½Ğ¾Ğµ ÑĞ¾ÑÑ‚Ğ¾ÑĞ½Ğ¸Ğµ.
                    onEdit={status === 'active' ? () => setIsEditing(true) : undefined}
                    onCancel={onCancel}
                    onRemoveItem={onRemoveItem}
                    onRepeat={onRepeat}
                    cancelDisabled={cancelDisabled}
                    total_cost={total_cost}
                    discount_amount={discount_amount}
                    promo_code={promo_code}
                    accessory_links={accessory_links}
                    rental_id={rental_id}
                />
            )}

            {/* Ğ”Ğ¸Ğ°Ğ»Ğ¾Ğ³ Ğ¿Ğ¾Ğ´Ñ‚Ğ²ĞµÑ€Ğ¶Ğ´ĞµĞ½Ğ¸Ñ ÑƒĞ´Ğ°Ğ»ĞµĞ½Ğ¸Ñ Ğ¾ÑÑ‚Ğ°ĞµÑ‚ÑÑ Ğ·Ğ´ĞµÑÑŒ, Ñ‚.Ğº. Ğ¾Ğ½ ÑĞ²ÑĞ·Ğ°Ğ½ Ñ ViewReservationCard */}
            {/* Ğ•Ğ³Ğ¾ Ğ»Ğ¾Ğ³Ğ¸ĞºĞ° Ğ±ÑƒĞ´ĞµÑ‚ Ğ¿ĞµÑ€ĞµÑĞ¼Ğ¾Ñ‚Ñ€ĞµĞ½Ğ°, ĞµÑĞ»Ğ¸ Ğ¿Ğ¾Ñ‚Ñ€ĞµĞ±ÑƒĞµÑ‚ÑÑ Ğ² Ñ€ĞµĞ¶Ğ¸Ğ¼Ğµ Ñ€ĞµĞ´Ğ°ĞºÑ‚Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ */}
            {/* <ConfirmItemRemovalDialog ... />  <- Ğ¼Ğ¾Ğ¶Ğ½Ğ¾ Ğ¿Ğ¾ĞºĞ° Ğ¾ÑÑ‚Ğ°Ğ²Ğ¸Ñ‚ÑŒ Ğ¸Ğ»Ğ¸ Ğ·Ğ°ĞºĞ¾Ğ¼Ğ¼ĞµĞ½Ñ‚Ğ¸Ñ€Ğ¾Ğ²Ğ°Ñ‚ÑŒ */}
        </div>
    );
}

```


## <a name="rentalappmainsrccomponentsReservationFootertsx"></a>`rental-app-main/src/components/ReservationFooter.tsx`

```tsx
// path: rental-app-main/src/components/ReservationFooter.tsx

// src/components/ReservationFooter.tsx

import { Button } from "@/components/ui/button";
import { ArrowRight, X } from "lucide-react";

interface ReservationFooterProps {
    selectedCount: number;
    onClick: () => void;
    // âœ… Ğ”Ğ¾Ğ±Ğ°Ğ²Ğ»ÑĞµĞ¼ Ğ½Ğ¾Ğ²Ğ¾Ğµ ÑĞ²Ğ¾Ğ¹ÑÑ‚Ğ²Ğ¾ Ğ´Ğ»Ñ ÑĞ±Ñ€Ğ¾ÑĞ°
    onReset: () => void;
    isEditingMode: boolean;
    intent?: string;
}

export default function ReservationFooter({ selectedCount, onClick, onReset, isEditingMode, intent }: ReservationFooterProps) {
    if (selectedCount === 0) {
        return null;
    }

    const buttonText = isEditingMode && intent !== "add_to_new_reservation"
        ? `âœ”ï¸ Ğ”Ğ¾Ğ±Ğ°Ğ²Ğ¸Ñ‚ÑŒ Ğº Ñ€ĞµĞ·ĞµÑ€Ğ²Ñƒ (${selectedCount})`
        : `ğŸ“¥ ĞÑ„Ğ¾Ñ€Ğ¼Ğ¸Ñ‚ÑŒ (${selectedCount})`;

    return (
        <div className="fixed bottom-0 left-0 right-0 z-50 p-4 bg-background/90 backdrop-blur-sm border-t border-border shadow-[0_-4px_15px_rgba(0,0,0,0.08)]">
            <div className="max-w-7xl mx-auto flex justify-between items-center">
                {/* âœ… ĞĞ¾Ğ²Ğ°Ñ ĞºĞ½Ğ¾Ğ¿ĞºĞ° "Ğ¡Ğ±Ñ€Ğ¾ÑĞ¸Ñ‚ÑŒ Ğ²Ñ‹Ğ±Ğ¾Ñ€" ÑĞ»ĞµĞ²Ğ° */}
                <Button
                    onClick={onReset}
                    variant="destructive"
                    size="lg"
                    className="flex items-center gap-2"
                >
                    <X className="h-5 w-5" />
                    Ğ¡Ğ±Ñ€Ğ¾ÑĞ¸Ñ‚ÑŒ Ğ²Ñ‹Ğ±Ğ¾Ñ€
                </Button>

                {/* Ğ‘Ğ»Ğ¾Ğº Ñ Ğ¸Ğ½Ñ„Ğ¾Ñ€Ğ¼Ğ°Ñ†Ğ¸ĞµĞ¹ Ğ¸ Ğ¾ÑĞ½Ğ¾Ğ²Ğ½Ğ¾Ğ¹ ĞºĞ½Ğ¾Ğ¿ĞºĞ¾Ğ¹ ÑĞ¿Ñ€Ğ°Ğ²Ğ° */}
                <div className="flex items-center gap-4">
                    <div className="text-sm text-foreground">
                        <span className="font-semibold">Ğ’Ñ‹Ğ±Ñ€Ğ°Ğ½Ğ¾ Ğ´Ğ»Ñ Ñ€ĞµĞ·ĞµÑ€Ğ²Ğ°:</span>
                        <span className="ml-2 font-bold text-lg">{selectedCount} Ğ¿Ğ¾Ğ·.</span>
                    </div>
                    <Button
                        onClick={onClick}
                        size="lg"
                        className="bg-green-600 hover:bg-green-700 text-white shadow-lg flex items-center gap-2"
                    >
                        {buttonText}
                        <ArrowRight className="h-5 w-5" />
                    </Button>
                </div>
            </div>
        </div>
    );
}

```


## <a name="rentalappmainsrccomponentsReservationListtsx"></a>`rental-app-main/src/components/ReservationList.tsx`

```tsx
// path: rental-app-main/src/components/ReservationList.tsx

import { useReserveSubmission } from "@/hooks/reservation/submission/useReserveSubmission"
import type { Equipment } from "@/types/equipment"

export default function ReservationList() {
    const {
        items,
        unavailableIdsFromAPI,
        submitMessage,
        reservationSuccess,
        removeItemFromStore,
        clearReserveStore,
        handleSubmit,
    } = useReserveSubmission()

    if (items.length === 0) return null

    return (
        <div className="mt-6 p-4 border rounded bg-white shadow-sm max-w-2xl mx-auto">
            <h2 className="text-lg font-bold mb-4">Ğ’Ñ‹Ğ±Ñ€Ğ°Ğ½Ğ½Ğ¾Ğµ Ğ¾Ğ±Ğ¾Ñ€ÑƒĞ´Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ:</h2>

            <ul className="space-y-2 mb-4">
                {items.map((item: Equipment) => (
                    <li
                        key={item.id}
                        className={`flex justify-between items-center border-b pb-1 ${
                            unavailableIdsFromAPI.includes(item.id) ? "bg-red-50 border-red-600" : ""
                        }`}
                    >
                        <div>
                            <p className="font-medium">{item.name}</p>
                            <p className="text-sm text-gray-500">
                                {item.brand} â€¢ {item.equipment_type}
                            </p>
                            {unavailableIdsFromAPI.includes(item.id) && (
                                <p className="text-xs text-red-600 pt-1">
                                    Ğ­Ñ‚Ğ¾ Ğ¾Ğ±Ğ¾Ñ€ÑƒĞ´Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ ÑÑ‚Ğ°Ğ»Ğ¾ Ğ½ĞµĞ´Ğ¾ÑÑ‚ÑƒĞ¿Ğ½Ñ‹Ğ¼
                                </p>
                            )}
                        </div>
                        <button
                            onClick={() => removeItemFromStore(item.id)}
                            className="text-red-600 hover:underline text-sm"
                        >
                            Ğ£Ğ´Ğ°Ğ»Ğ¸Ñ‚ÑŒ
                        </button>
                    </li>
                ))}
            </ul>

            <div className="flex justify-between items-center">
                <button
                    onClick={clearReserveStore}
                    className="text-gray-600 hover:underline text-sm"
                >
                    ĞÑ‡Ğ¸ÑÑ‚Ğ¸Ñ‚ÑŒ Ğ²ÑÑ‘
                </button>
                <button
                    onClick={handleSubmit}
                    className="bg-sky-700 text-white px-4 py-2 rounded hover:bg-sky-800 text-sm font-medium"
                    disabled={unavailableIdsFromAPI.length > 0}
                >
                    ğŸ“¤ ĞÑ‚Ğ¿Ñ€Ğ°Ğ²Ğ¸Ñ‚ÑŒ Ñ€ĞµĞ·ĞµÑ€Ğ²
                </button>
            </div>

            {submitMessage && (
                <p
                    className={`text-sm mt-3 text-center ${
                        reservationSuccess ? "text-green-700" : "text-red-600"
                    }`}
                >
                    {submitMessage}
                </p>
            )}
        </div>
    )
}


```


## <a name="rentalappmainsrccomponentsReserveEquipmentCardtsx"></a>`rental-app-main/src/components/ReserveEquipmentCard.tsx`

```tsx
// path: rental-app-main/src/components/ReserveEquipmentCard.tsx

// src/components/ReserveEquipmentCard.tsx
import { useState } from "react";
import { Trash2, Paperclip, ChevronDown } from "lucide-react";
import { Checkbox } from "@/components/ui/checkbox";
import { Label } from "@/components/ui/label";
import type { Equipment } from "@/types/equipment";
import type { AvailabilityInfo, EquipmentStatus } from "@/types/availability";
import { Card, CardContent } from "@/components/ui/card";
import { formatDateRangeEuropean } from "@/lib/utils";

type Props = {
    equipment: Equipment;
    availability?: AvailabilityInfo;
    onRemove: (id: number) => void;
    // âœ… Ğ”ĞĞ‘ĞĞ’Ğ›Ğ•ĞĞ« ĞĞĞ’Ğ«Ğ• Ğ¡Ğ’ĞĞ™Ğ¡Ğ¢Ğ’Ğ
    isAccessorySelected: (equipmentId: number, accessoryId: number) => boolean;
    onToggleAccessory: (equipmentId: number, accessoryId: number) => void;
};

const statusTextMap: Record<EquipmentStatus | string, string> = {
    available: "Ğ¡Ğ²Ğ¾Ğ±Ğ¾Ğ´Ğ½Ğ¾",
    reserved: "Ğ’ Ñ€ĞµĞ·ĞµÑ€Ğ²Ğµ (Ğ´Ñ€ÑƒĞ³Ğ¸Ğ¼)",
    rented: "Ğ’ Ğ°Ñ€ĞµĞ½Ğ´Ğµ (Ğ´Ñ€ÑƒĞ³Ğ¸Ğ¼)",
    my_reservation: "Ğ’ ÑÑ‚Ğ¾Ğ¼ Ñ€ĞµĞ·ĞµÑ€Ğ²Ğµ",
};

const statusColorMap: Record<EquipmentStatus | string, string> = {
    available: "text-green-600",
    reserved: "text-rose-500",
    rented: "text-red-600",
    my_reservation: "text-sky-700",
};

const bgColorMap: Record<EquipmentStatus | string, string> = {
    available: "bg-white",
    reserved: "bg-rose-50 border-rose-200",
    rented: "bg-rose-100 border-rose-300",
    my_reservation: "bg-sky-50 border-sky-200",
};

function formatDateRange(start?: string, end?: string) {
    if (!start || !end) return "";
    return `(${formatDateRangeEuropean(start, end)})`;
}

export default function ReserveEquipmentCard({
                                                 equipment,
                                                 availability,
                                                 onRemove,
                                                 // âœ… ĞŸĞĞ›Ğ£Ğ§ĞĞ•Ğœ ĞĞĞ’Ğ«Ğ• Ğ¡Ğ’ĞĞ™Ğ¡Ğ¢Ğ’Ğ
                                                 isAccessorySelected,
                                                 onToggleAccessory
                                             }: Props) {
    const status = availability?.status ?? "available";
    const statusText = statusTextMap[status] || "ĞĞµĞ¸Ğ·Ğ²ĞµÑÑ‚Ğ½Ñ‹Ğ¹ ÑÑ‚Ğ°Ñ‚ÑƒÑ";
    const colorClass = statusColorMap[status] || "text-gray-500";
    const bgClass = bgColorMap[status] || "bg-gray-50";
    const dateRange = (status === "reserved" || status === "rented")
        ? formatDateRange(availability?.start_date, availability?.end_date)
        : "";
    const isExternalConflict = status === "reserved" || status === "rented";

    // âœ… Ğ¡ĞĞ¡Ğ¢ĞĞ¯ĞĞ˜Ğ• Ğ”Ğ›Ğ¯ ĞĞ¢ĞĞ‘Ğ ĞĞ–Ğ•ĞĞ˜Ğ¯ Ğ¡ĞŸĞ˜Ğ¡ĞšĞ ĞĞšĞ¡Ğ•Ğ¡Ğ¡Ğ£ĞĞ ĞĞ’
    const [showAccessories, setShowAccessories] = useState(false);

    return (
        <Card
            className={`rounded-xl px-4 py-4 sm:px-6 shadow-sm transition border w-full flex flex-col ${bgClass}`}
        >
            <CardContent className="p-0 flex-1 flex flex-col sm:flex-row justify-between items-start gap-4">
                <div className="flex-1">
                    <h3 className="text-base sm:text-lg font-semibold mb-1">{equipment.name}</h3>
                    <p className="text-xs sm:text-sm text-gray-500 mb-1">
                        {equipment.brand} â€¢ {equipment.equipment_type}
                    </p>
                    <p className="text-xs sm:text-sm mb-1">
                        Ğ¡Ğ¾ÑÑ‚Ğ¾ÑĞ½Ğ¸Ğµ: <strong>{equipment.condition}</strong>
                    </p>
                    <p className="text-sm sm:text-base font-bold mb-1">{equipment.daily_rate} â‚½ / Ğ´ĞµĞ½ÑŒ</p>

                    <p className={`text-sm font-semibold mt-2 ${colorClass}`}>
                        {statusText}
                        {dateRange && <span className="ml-1 text-xs font-normal">{dateRange}</span>}
                    </p>

                    {/* âœ… ĞĞĞ§ĞĞ›Ğ Ğ‘Ğ›ĞĞšĞ Ğ’Ğ«Ğ‘ĞĞ Ğ ĞĞšĞ¡Ğ•Ğ¡Ğ¡Ğ£ĞĞ ĞĞ’ */}
                    {equipment.accessories && equipment.accessories.length > 0 && (
                        <div className="mt-3 border-t pt-3">
                            <button
                                className="w-full flex justify-between items-center text-sm font-medium text-gray-600 hover:text-sky-700 p-1 -m-1 rounded"
                                onClick={() => setShowAccessories(prev => !prev)}
                            >
                                <span className="flex items-center gap-2">
                                    <Paperclip className="w-4 h-4" />
                                    Ğ”Ğ¾Ğ±Ğ°Ğ²Ğ¸Ñ‚ÑŒ Ğ°ĞºÑĞµÑÑÑƒĞ°Ñ€Ñ‹ ({equipment.accessories.length})
                                </span>
                                <ChevronDown className={`w-5 h-5 transition-transform ${showAccessories ? 'rotate-180' : ''}`} />
                            </button>
                            {showAccessories && (
                                <div className="mt-2 space-y-2 pl-1 animate-in fade-in-0 slide-in-from-top-2 duration-300">
                                    {equipment.accessories.map(acc => (
                                        <div key={acc.id} className="flex items-center justify-between p-1 rounded hover:bg-gray-50">
                                            <Label htmlFor={`reserve-acc-${equipment.id}-${acc.id}`} className="flex items-center gap-2 text-xs font-normal cursor-pointer">
                                                <Checkbox
                                                    id={`reserve-acc-${equipment.id}-${acc.id}`}
                                                    checked={isAccessorySelected(equipment.id, acc.id)}
                                                    onCheckedChange={() => onToggleAccessory(equipment.id, acc.id)}
                                                />
                                                {acc.name}
                                            </Label>
                                            <span className="text-xs text-gray-500">{acc.price} â‚½</span>
                                        </div>
                                    ))}
                                </div>
                            )}
                        </div>
                    )}
                    {/* âœ… ĞšĞĞĞ•Ğ¦ Ğ‘Ğ›ĞĞšĞ Ğ’Ğ«Ğ‘ĞĞ Ğ ĞĞšĞ¡Ğ•Ğ¡Ğ¡Ğ£ĞĞ ĞĞ’ */}
                </div>

                <button
                    onClick={() => onRemove(equipment.id)}
                    className={`rounded px-2 py-1 sm:px-3 text-xs sm:text-sm font-medium flex items-center gap-1 mt-1 self-start sm:self-center 
                        ${isExternalConflict
                        ? "bg-red-500 text-white hover:bg-red-600"
                        : "bg-slate-500 text-white hover:bg-slate-600"
                    }`}
                    title="Ğ£Ğ´Ğ°Ğ»Ğ¸Ñ‚ÑŒ Ğ¸Ğ· Ñ€ĞµĞ·ĞµÑ€Ğ²Ğ°"
                >
                    <Trash2 size={14} className="sm:size-4" />
                    Ğ£Ğ´Ğ°Ğ»Ğ¸Ñ‚ÑŒ
                </button>
            </CardContent>
        </Card>
    );
}

```


## <a name="rentalappmainsrccomponentsSearchInputtsx"></a>`rental-app-main/src/components/SearchInput.tsx`

```tsx
// path: rental-app-main/src/components/SearchInput.tsx

import { useSearchStore } from "../store/searchStore"
import { Input } from "@/components/ui/input"

export default function SearchInput() {
  const { query, setQuery } = useSearchStore()

  return (
    <Input
      type="text"
      placeholder="ĞŸĞ¾Ğ¸ÑĞº Ğ¿Ğ¾ Ğ½Ğ°Ğ·Ğ²Ğ°Ğ½Ğ¸Ñ..."
      value={query}
      onChange={(e) => setQuery(e.target.value)}
      className="w-full max-w-sm"
    />
  )
}


```


## <a name="rentalappmainsrccomponentsStatusBadgetsx"></a>`rental-app-main/src/components/StatusBadge.tsx`

```tsx
// path: rental-app-main/src/components/StatusBadge.tsx

export default function StatusBadge({ status }: { status: "active" | "past" }) {
    const isActive = status === "active"
    return (
        <span
            className={`text-xs font-medium px-2 py-1 rounded-full inline-block
        ${isActive
                ? "bg-green-100 text-green-700 border border-green-300"
                : "bg-gray-100 text-gray-500 border border-gray-300"
            }`}
        >
      {isActive ? "ĞĞºÑ‚Ğ¸Ğ²ĞµĞ½" : "Ğ—Ğ°Ğ²ĞµÑ€ÑˆÑ‘Ğ½"}
    </span>
    )
}


```


## <a name="rentalappmainsrccomponentsTypeFiltertsx"></a>`rental-app-main/src/components/TypeFilter.tsx`

```tsx
// path: rental-app-main/src/components/TypeFilter.tsx

// src/components/TypeFilter.tsx
import { ToggleGroup, ToggleGroupItem } from "@/components/ui/toggle-group"
import { useFilterStore } from "@/store/filterStore"
import { useMemo, type ReactNode } from "react"
import type { Equipment } from "@/types/equipment"
import { getFilterToggleClass } from "@/components/ui/filter-toggle"
import {
    Camera,
    Aperture,
    Lightbulb,
    Mic,
    Video,
    Grip,
    Headphones,
    Laptop,
    Package,
    List,
} from "lucide-react"

// Ğ’ÑĞ¿Ğ¾Ğ¼Ğ¾Ğ³Ğ°Ñ‚ĞµĞ»ÑŒĞ½Ğ°Ñ Ñ„ÑƒĞ½ĞºÑ†Ğ¸Ñ Ğ´Ğ»Ñ ÑĞ¾Ğ¿Ğ¾ÑÑ‚Ğ°Ğ²Ğ»ĞµĞ½Ğ¸Ñ Ñ‚Ğ¸Ğ¿Ğ° Ğ¾Ğ±Ğ¾Ñ€ÑƒĞ´Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ Ñ Ğ¸ĞºĞ¾Ğ½ĞºĞ¾Ğ¹
const getIconForType = (type: string): ReactNode => {
    const iconMap: Record<string, ReactNode> = {
        "Ğ¤Ğ¾Ñ‚Ğ¾ĞºĞ°Ğ¼ĞµÑ€Ğ°": <Camera />,
        "ĞĞ±ÑŠĞµĞºÑ‚Ğ¸Ğ²": <Aperture />,
        "Ğ¡Ğ²ĞµÑ‚": <Lightbulb />,
        "ĞœĞ¸ĞºÑ€Ğ¾Ñ„Ğ¾Ğ½": <Mic />,
        "Ğ­ĞºÑˆĞ½ ĞºĞ°Ğ¼ĞµÑ€Ğ°": <Video />,
        "Ğ¨Ñ‚Ğ°Ñ‚Ğ¸Ğ²Ñ‹": <Grip />,
        "ĞÑƒĞ´Ğ¸Ğ¾Ğ¾Ğ±Ğ¾Ñ€ÑƒĞ´Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ": <Headphones />,
        "ĞšĞ¾Ğ¼Ğ¿ÑŒÑÑ‚ĞµÑ€Ğ½Ğ°Ñ Ñ‚ĞµÑ…Ğ½Ğ¸ĞºĞ°": <Laptop />,
        "ĞŸÑ€Ğ¾Ñ‡ĞµĞµ": <Package />,
    }
    // Ğ’Ğ¾Ğ·Ğ²Ñ€Ğ°Ñ‰Ğ°ĞµĞ¼ ÑĞ¾Ğ¾Ñ‚Ğ²ĞµÑ‚ÑÑ‚Ğ²ÑƒÑÑ‰ÑƒÑ Ğ¸ĞºĞ¾Ğ½ĞºÑƒ Ğ¸Ğ»Ğ¸ null, ĞµÑĞ»Ğ¸ ÑĞ¾Ğ²Ğ¿Ğ°Ğ´ĞµĞ½Ğ¸Ñ Ğ½Ğµ Ğ½Ğ°Ğ¹Ğ´ĞµĞ½Ñ‹
    return iconMap[type] || null
}

interface TypeFilterProps {
    items: Equipment[]
}

export default function TypeFilter({ items }: TypeFilterProps) {
    const { type, setType } = useFilterStore()

    const types = useMemo(() => {
        const uniqueTypes = new Set(items.map((eq) => eq.equipment_type))
        return Array.from(uniqueTypes)
    }, [items])

    return (
        <ToggleGroup
            type="single"
            value={type ?? "__all__"}
            onValueChange={(val: string) => setType(val === "__all__" ? null : val)}
            className="flex flex-wrap gap-2"
        >
            <ToggleGroupItem
                value="__all__"
                className={getFilterToggleClass()}
            >
                <List />
                Ğ’ÑĞµ
            </ToggleGroupItem>

            {types.map((t) => (
                <ToggleGroupItem
                    key={t}
                    value={t}
                    className={getFilterToggleClass()}
                >
                    {getIconForType(t)}
                    {t}
                </ToggleGroupItem>
            ))}
        </ToggleGroup>
    )
}

```


## <a name="rentalappmainsrccomponentsUserInfoBlocktsx"></a>`rental-app-main/src/components/UserInfoBlock.tsx`

```tsx
// path: rental-app-main/src/components/UserInfoBlock.tsx

// src/components/UserInfoBlock.tsx
import { Button } from "@/components/ui/button";
import { useNavigate, useLocation } from "react-router-dom";
import { useCurrentUser } from "@/hooks/useProfile";
import { useAuthStore } from "@/store/authStore";
import {
    Shield,
    Calendar,
    Edit,
    FileText,
    LogOut,
    Settings,
    HelpCircle,
    AlertTriangle,
    Send
} from "lucide-react";

type Props = {
    onEditProfile?: () => void;
    showExtraLinks?: boolean;
};

export default function UserInfoBlock({ onEditProfile, showExtraLinks = false }: Props) {
    const { data: user, isLoading, isError } = useCurrentUser();
    const { logout } = useAuthStore();
    const navigate = useNavigate();
    const location = useLocation();

    if (isLoading) {
        return (
            <div className="w-full">
                <div className="bg-gradient-to-r from-white to-gray-50 border border-gray-200 rounded-lg shadow-sm p-4">
                    <p className="text-center text-sm text-gray-500">Ğ—Ğ°Ğ³Ñ€ÑƒĞ·ĞºĞ°...</p>
                </div>
            </div>
        );
    }

    if (isError || !user) {
        return (
            <div className="w-full">
                <div className="bg-gradient-to-r from-white to-gray-50 border border-gray-200 rounded-lg shadow-sm p-4">
                    <p className="text-center text-sm text-red-600">ĞÑˆĞ¸Ğ±ĞºĞ° Ğ·Ğ°Ğ³Ñ€ÑƒĞ·ĞºĞ¸ Ğ¿Ñ€Ğ¾Ñ„Ğ¸Ğ»Ñ</p>
                </div>
            </div>
        );
    }

    const isAdmin = user.role === "admin";
    const isManager = user.role === "manager" || isAdmin;

    const getRoleInfo = () => {
        if (isAdmin) return { label: "ĞĞ´Ğ¼Ğ¸Ğ½", color: "text-red-600", icon: "ğŸ‘‘", bg: "bg-red-50" };
        if (isManager) return { label: "ĞœĞµĞ½ĞµĞ´Ğ¶ĞµÑ€", color: "text-blue-600", icon: "ğŸ›¡ï¸", bg: "bg-blue-50" };
        return { label: "ĞŸĞ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ÑŒ", color: "text-gray-600", icon: "ğŸ‘¤", bg: "bg-gray-50" };
    };

    const roleInfo = getRoleInfo();

    // âœ… Ğ˜Ğ—ĞœĞ•ĞĞ•ĞĞ˜Ğ•: Ğ”Ğ¾Ğ±Ğ°Ğ²Ğ»ÑĞµĞ¼ Ñ„Ğ¾Ñ€Ğ¼Ğ°Ñ‚Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ Ğ¸ Ğ¿Ñ€Ğ¾Ğ²ĞµÑ€ĞºÑƒ Ğ±Ğ°Ğ»Ğ°Ğ½ÑĞ°
    const balance = user.balance ?? 0;
    const balanceColor = balance < 0 ? 'text-red-600' : 'text-green-700';

    return (
        <div className="w-full">
            <div className="bg-gradient-to-r from-white to-gray-50 border border-gray-200 rounded-lg shadow-sm">
                <div className="flex flex-col lg:flex-row items-stretch">
                    <div className="flex-1 p-3 lg:p-4">
                        <div className="flex items-center gap-3">
                            <div className={`w-12 h-12 ${roleInfo.bg} rounded-full flex items-center justify-center text-lg flex-shrink-0`}>
                                {roleInfo.icon}
                            </div>
                            <div className="flex-1 min-w-0">
                                <div className="flex flex-col lg:flex-row lg:items-start lg:gap-6">
                                    <div className="min-w-0">
                                        <div>
                                            <h3 className="font-semibold text-gray-900 text-sm truncate">
                                                {user.full_name}
                                            </h3>
                                            <p className="text-xs text-gray-600 truncate">{user.email}</p>
                                        </div>
                                    </div>
                                    <div className="flex items-center gap-4 mt-2 lg:mt-0">
                                        <div className="flex items-center gap-1">
                                            <Shield className="w-3 h-3 text-gray-400" />
                                            <span className={`text-xs font-medium ${roleInfo.color}`}>
                                                {roleInfo.label}
                                            </span>
                                        </div>
                                        <div className="flex items-center gap-1 text-xs text-gray-500">
                                            <span>Ğ‘Ğ°Ğ»Ğ°Ğ½Ñ:</span>
                                            {/* âœ… Ğ˜Ğ—ĞœĞ•ĞĞ•ĞĞ˜Ğ•: ĞŸÑ€Ğ¸Ğ¼ĞµĞ½ÑĞµĞ¼ Ñ„Ğ¾Ñ€Ğ¼Ğ°Ñ‚Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ Ğ¸ Ñ†Ğ²ĞµÑ‚ */}
                                            <span className={`font-semibold ${balanceColor}`}>
                                                {balance.toLocaleString('ru-RU', { style: 'currency', currency: 'RUB' })}
                                            </span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    {showExtraLinks && (
                        <div className="p-3 lg:p-4 lg:border-l lg:border-r border-gray-200 lg:w-[260px] lg:flex-shrink-0">
                            <h4 className="text-xs text-gray-500 mb-2 font-semibold">ĞŸĞ¾Ğ»ĞµĞ·Ğ½Ğ°Ñ Ğ¸Ğ½Ñ„Ğ¾Ñ€Ğ¼Ğ°Ñ†Ğ¸Ñ:</h4>
                            <div className="space-y-1.5">
                                <a
                                    href="/how-it-works"
                                    onClick={(e) => {
                                        e.preventDefault();
                                        alert("Ğ¡Ñ‚Ñ€Ğ°Ğ½Ğ¸Ñ†Ğ° 'ĞšĞ°Ğº Ñ€Ğ°Ğ±Ğ¾Ñ‚Ğ°ĞµÑ‚ Ğ¿Ñ€Ğ¾ĞºĞ°Ñ‚?' ĞµÑ‰Ğµ Ğ½Ğµ ÑĞ¾Ğ·Ğ´Ğ°Ğ½Ğ°.");
                                    }}
                                    className="flex items-center text-sm text-gray-700 hover:text-sky-600 hover:underline transition-colors duration-150"
                                >
                                    <HelpCircle className="w-4 h-4 mr-2 text-gray-400 flex-shrink-0" />
                                    ĞšĞ°Ğº Ñ€Ğ°Ğ±Ğ¾Ñ‚Ğ°ĞµÑ‚ Ğ¿Ñ€Ğ¾ĞºĞ°Ñ‚?
                                </a>
                                <a
                                    href="/rules"
                                    onClick={(e) => {
                                        e.preventDefault();
                                        alert("Ğ¡Ñ‚Ñ€Ğ°Ğ½Ğ¸Ñ†Ğ° 'ĞĞ°ÑˆĞ¸ Ğ¿Ñ€Ğ°Ğ²Ğ¸Ğ»Ğ°' ĞµÑ‰Ğµ Ğ½Ğµ ÑĞ¾Ğ·Ğ´Ğ°Ğ½Ğ°.");
                                    }}
                                    className="flex items-center text-sm text-gray-700 hover:text-sky-600 hover:underline transition-colors duration-150"
                                >
                                    <AlertTriangle className="w-4 h-4 mr-2 text-orange-400 flex-shrink-0" />
                                    ĞĞ°ÑˆĞ¸ Ğ¿Ñ€Ğ°Ğ²Ğ¸Ğ»Ğ°
                                </a>
                                <button
                                    onClick={() => navigate("/contacts", { state: { from: location.pathname } })}
                                    className="flex items-center text-sm text-gray-700 hover:text-sky-600 hover:underline w-full text-left transition-colors duration-150"
                                >
                                    <Send className="w-4 h-4 mr-2 text-blue-400 flex-shrink-0" />
                                    Ğ¡Ğ²ÑĞ·Ğ°Ñ‚ÑŒÑÑ Ñ Ğ½Ğ°Ğ¼Ğ¸
                                </button>
                            </div>
                        </div>
                    )}

                    <div className="border-t lg:border-t-0 lg:border-l bg-gray-50 lg:bg-transparent p-3 lg:p-4 lg:w-[300px] lg:ml-auto lg:flex-shrink-0">
                        <div className="flex gap-2 w-full">
                            <div className="flex flex-col gap-2 flex-1">
                                <Button
                                    variant="default"
                                    onClick={() =>
                                        navigate("/reservations/my", { state: { from: location.pathname } })
                                    }
                                    className="h-8 px-3 text-xs flex items-center justify-center gap-1.5 w-full"
                                    size="sm"
                                >
                                    <FileText className="w-3 h-3" />
                                    ĞœĞ¾Ğ¸ Ğ·Ğ°ĞºĞ°Ğ·Ñ‹
                                </Button>
                                <Button
                                    onClick={() => navigate("/calendar", { state: { from: location.pathname } })}
                                    className="h-8 px-3 text-xs flex items-center justify-center gap-1.5 bg-amber-500 hover:bg-amber-600 text-white w-full"
                                    size="sm"
                                >
                                    <Calendar className="w-3 h-3" />
                                    ĞšĞ°Ğ»ĞµĞ½Ğ´Ğ°Ñ€ÑŒ
                                </Button>
                                {isManager && (
                                    <Button
                                        variant="secondary"
                                        onClick={() => navigate("/admin")}
                                        className="h-8 px-3 text-xs flex items-center justify-center gap-1.5 bg-gray-800 hover:bg-gray-700 text-white w-full"
                                        size="sm"
                                    >
                                        <Settings className="w-3 h-3" />
                                        {isAdmin ? "ĞĞ´Ğ¼Ğ¸Ğ½ Ğ¿Ğ°Ğ½ĞµĞ»ÑŒ" : "ĞŸĞ°Ğ½ĞµĞ»ÑŒ Ğ¼ĞµĞ½ĞµĞ´Ğ¶ĞµÑ€Ğ°"}
                                    </Button>
                                )}
                            </div>
                            <div className="flex flex-col gap-2">
                                <Button
                                    variant="outline"
                                    onClick={
                                        onEditProfile
                                            ? onEditProfile
                                            : () => navigate("/profile", { state: { from: location.pathname } })
                                    }
                                    className="h-8 px-3 text-xs flex items-center justify-center gap-1.5"
                                    size="sm"
                                >
                                    <Edit className="w-3 h-3" />
                                    ĞŸÑ€Ğ¾Ñ„Ğ¸Ğ»ÑŒ
                                </Button>
                                <Button
                                    variant="destructive"
                                    onClick={logout}
                                    className="h-8 px-3 text-xs flex items-center justify-center gap-1.5"
                                    size="sm"
                                >
                                    <LogOut className="w-3 h-3" />
                                    Ğ’Ñ‹Ğ¹Ñ‚Ğ¸
                                </Button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    );
}

```


## <a name="rentalappmainsrccomponentsViewModeToggletsx"></a>`rental-app-main/src/components/ViewModeToggle.tsx`

```tsx
// path: rental-app-main/src/components/ViewModeToggle.tsx

// src/components/ViewModeToggle.tsx

import { ToggleGroup, ToggleGroupItem } from "@/components/ui/toggle-group";
import { LayoutGrid, List } from "lucide-react";
// Ğ˜Ğ¼Ğ¿Ğ¾Ñ€Ñ‚Ğ¸Ñ€ÑƒĞµĞ¼ Ğ¾Ğ±Ğ½Ğ¾Ğ²Ğ»ĞµĞ½Ğ½Ñ‹Ğ¹ ÑÑ‚Ğ¾Ñ€
import { useViewModeStore, type ViewMode } from "@/store/viewModeStore";

export default function ViewModeToggle() {
  // Ğ˜ÑĞ¿Ğ¾Ğ»ÑŒĞ·ÑƒĞµĞ¼ Ğ½Ğ¾Ğ²Ñ‹Ğµ Ğ¼ĞµÑ‚Ğ¾Ğ´Ñ‹ Ğ¸Ğ· ÑÑ‚Ğ¾Ñ€Ğ°
  const { viewMode, setViewMode } = useViewModeStore();

  return (
      <ToggleGroup
          type="single"
          value={viewMode}
          onValueChange={(value: ViewMode) => {
            // ĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑĞµĞ¼, Ñ‡Ñ‚Ğ¾ Ğ·Ğ½Ğ°Ñ‡ĞµĞ½Ğ¸Ğµ Ğ½Ğµ Ğ¿ÑƒÑÑ‚Ğ¾Ğµ, Ğ¿Ñ€ĞµĞ¶Ğ´Ğµ Ñ‡ĞµĞ¼ Ğ¾Ğ±Ğ½Ğ¾Ğ²Ğ»ÑÑ‚ÑŒ ÑÑ‚Ğ¾Ñ€
            if (value) setViewMode(value);
          }}
          className="flex items-center"
          aria-label="ĞŸĞµÑ€ĞµĞºĞ»ÑÑ‡Ğ°Ñ‚ĞµĞ»ÑŒ Ğ²Ğ¸Ğ´Ğ° ĞºĞ°Ñ€Ñ‚Ğ¾Ñ‡ĞµĞº"
      >
        <ToggleGroupItem value="default" aria-label="Ğ¡Ñ‚Ğ°Ğ½Ğ´Ğ°Ñ€Ñ‚Ğ½Ñ‹Ğ¹ Ğ²Ğ¸Ğ´" className="p-2 h-9 w-9">
          <LayoutGrid className="h-4 w-4" />
        </ToggleGroupItem>
        <ToggleGroupItem value="compact" aria-label="ĞšĞ¾Ğ¼Ğ¿Ğ°ĞºÑ‚Ğ½Ñ‹Ğ¹ Ğ²Ğ¸Ğ´" className="p-2 h-9 w-9">
          <List className="h-4 w-4" />
        </ToggleGroupItem>
      </ToggleGroup>
  );
}

```


## <a name="rentalappmainsrccomponentsadminAccessoryDialogstsx"></a>`rental-app-main/src/components/admin/AccessoryDialogs.tsx`

```tsx
// path: rental-app-main/src/components/admin/AccessoryDialogs.tsx

// src/components/admin/AccessoryDialogs.tsx
import { useForm } from "react-hook-form";
import { zodResolver } from "@hookform/resolvers/zod";
import { useEffect } from "react";
import { accessorySchema, AccessorySchema } from "@/lib/validationSchemas";
import { useCreateAccessory, useUpdateAccessory, useAccessory } from "@/hooks/useAdminAccessories";
import type { Accessory } from "@/types/accessory";

import { Button } from "@/components/ui/button";
import { Input } from "@/components/ui/input";
import { Label } from "@/components/ui/label";
import { Textarea } from "@/components/ui/textarea";
import {
    Dialog,
    DialogContent,
    DialogHeader,
    DialogTitle,
    DialogFooter,
    DialogDescription,
} from "@/components/ui/dialog";

// --- Ğ”Ğ¸Ğ°Ğ»Ğ¾Ğ³ ÑĞ¾Ğ·Ğ´Ğ°Ğ½Ğ¸Ñ ---
interface CreateProps {
    open: boolean;
    onClose: () => void;
}
export function AccessoryCreateDialog({ open, onClose }: CreateProps) {
    const createMutation = useCreateAccessory();
    const { register, handleSubmit, formState: { errors, isValid }, reset } = useForm<AccessorySchema>({
        resolver: zodResolver(accessorySchema) as any,
        mode: "onChange",
    });

    const onSubmit = (data: AccessorySchema) => {
        createMutation.mutate(data, {
            onSuccess: () => {
                reset();
                onClose();
            },
        });
    };

    return (
        <Dialog open={open} onOpenChange={onClose}>
            <DialogContent>
                <DialogHeader>
                    <DialogTitle>ĞĞ¾Ğ²Ñ‹Ğ¹ Ğ°ĞºÑĞµÑÑÑƒĞ°Ñ€</DialogTitle>
                    <DialogDescription>Ğ¡Ğ¾Ğ·Ğ´Ğ°Ğ¹Ñ‚Ğµ Ğ½Ğ¾Ğ²ÑƒÑ Ğ·Ğ°Ğ¿Ğ¸ÑÑŒ Ğ² ĞºĞ°Ñ‚Ğ°Ğ»Ğ¾Ğ³Ğµ Ğ°ĞºÑĞµÑÑÑƒĞ°Ñ€Ğ¾Ğ².</DialogDescription>
                </DialogHeader>
                <form onSubmit={handleSubmit(onSubmit)} className="space-y-4 py-2">
                    {/* ... Ğ¿Ğ¾Ğ»Ñ Ñ„Ğ¾Ñ€Ğ¼Ñ‹ ... */}
                    <div>
                        <Label htmlFor="name">ĞĞ°Ğ·Ğ²Ğ°Ğ½Ğ¸Ğµ *</Label>
                        <Input id="name" {...register("name")} placeholder="ĞĞºĞºÑƒĞ¼ÑƒĞ»ÑÑ‚Ğ¾Ñ€ LP-E6" />
                        {errors.name && <p className="text-xs text-red-600 mt-1">{errors.name.message}</p>}
                    </div>
                    <div className="grid grid-cols-2 gap-4">
                        <div>
                            <Label htmlFor="accessory_type">Ğ¢Ğ¸Ğ¿</Label>
                            <Input id="accessory_type" {...register("accessory_type")} placeholder="ĞŸĞ¸Ñ‚Ğ°Ğ½Ğ¸Ğµ"/>
                        </div>
                        <div>
                            <Label htmlFor="price">Ğ¦ĞµĞ½Ğ° (â‚½/Ğ´ĞµĞ½ÑŒ)</Label>
                            <Input id="price" type="number" step="0.01" {...register("price")} placeholder="100"/>
                            {errors.price && <p className="text-xs text-red-600 mt-1">{errors.price.message}</p>}
                        </div>
                    </div>
                    <div>
                        <Label htmlFor="description">ĞĞ¿Ğ¸ÑĞ°Ğ½Ğ¸Ğµ</Label>
                        <Textarea id="description" {...register("description")} placeholder="Ğ”Ğ»Ñ ĞºĞ°Ğ¼ĞµÑ€ Canon R, R5, R6..." />
                    </div>
                    <DialogFooter>
                        <Button type="button" variant="ghost" onClick={onClose}>ĞÑ‚Ğ¼ĞµĞ½Ğ°</Button>
                        <Button type="submit" disabled={!isValid || createMutation.isPending}>
                            {createMutation.isPending ? "Ğ¡Ğ¾Ğ·Ğ´Ğ°Ğ½Ğ¸Ğµ..." : "Ğ¡Ğ¾Ğ·Ğ´Ğ°Ñ‚ÑŒ"}
                        </Button>
                    </DialogFooter>
                </form>
            </DialogContent>
        </Dialog>
    );
}

// --- Ğ”Ğ¸Ğ°Ğ»Ğ¾Ğ³ Ñ€ĞµĞ´Ğ°ĞºÑ‚Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ ---
interface EditProps {
    accessory: Accessory | null;
    open: boolean;
    onClose: () => void;
}
export function AccessoryEditDialog({ accessory, open, onClose }: EditProps) {
    const updateMutation = useUpdateAccessory();
    const { data: accessoryData, isLoading } = useAccessory(accessory?.id || null);
    
    const { register, handleSubmit, formState: { errors, isValid }, reset } = useForm<AccessorySchema>({
        resolver: zodResolver(accessorySchema) as any,
        mode: "onChange",
        defaultValues: {
            name: "",
            accessory_type: "",
            price: 0,
            description: "",
        },
    });

    // ĞĞ±Ğ½Ğ¾Ğ²Ğ»ÑĞµĞ¼ Ñ„Ğ¾Ñ€Ğ¼Ñƒ Ğ¿Ñ€Ğ¸ Ğ·Ğ°Ğ³Ñ€ÑƒĞ·ĞºĞµ Ğ´Ğ°Ğ½Ğ½Ñ‹Ñ… Ğ°ĞºÑĞµÑÑÑƒĞ°Ñ€Ğ°
    useEffect(() => {
        if (accessoryData) {
            reset({
                name: accessoryData.name || "",
                accessory_type: accessoryData.accessory_type || "",
                price: accessoryData.price || 0,
                description: accessoryData.description || "",
            });
        }
    }, [accessoryData, reset]);

    const onSubmit = (data: AccessorySchema) => {
        if (!accessoryData) return;
        updateMutation.mutate({ id: accessoryData.id, data }, {
            onSuccess: () => {
                onClose();
            },
        });
    };

    if (!accessory) return null;
    
    if (isLoading) {
        return (
            <Dialog open={open} onOpenChange={onClose}>
                <DialogContent>
                    <DialogHeader>
                        <DialogTitle>Ğ ĞµĞ´Ğ°ĞºÑ‚Ğ¸Ñ€Ğ¾Ğ²Ğ°Ñ‚ÑŒ Ğ°ĞºÑĞµÑÑÑƒĞ°Ñ€</DialogTitle>
                    </DialogHeader>
                    <div className="flex items-center justify-center py-8">
                        <p>Ğ—Ğ°Ğ³Ñ€ÑƒĞ·ĞºĞ° Ğ´Ğ°Ğ½Ğ½Ñ‹Ñ… Ğ°ĞºÑĞµÑÑÑƒĞ°Ñ€Ğ°...</p>
                    </div>
                </DialogContent>
            </Dialog>
        );
    }

    return (
        <Dialog open={open} onOpenChange={onClose}>
            <DialogContent>
                <DialogHeader>
                    <DialogTitle>Ğ ĞµĞ´Ğ°ĞºÑ‚Ğ¸Ñ€Ğ¾Ğ²Ğ°Ñ‚ÑŒ Ğ°ĞºÑĞµÑÑÑƒĞ°Ñ€</DialogTitle>
                    <DialogDescription>"{accessoryData?.name || accessory.name}"</DialogDescription>
                </DialogHeader>
                <form onSubmit={handleSubmit(onSubmit)} className="space-y-4 py-2">
                    {/* ... Ğ¿Ğ¾Ğ»Ñ Ñ„Ğ¾Ñ€Ğ¼Ñ‹ ... */}
                    <div>
                        <Label htmlFor="edit-name">ĞĞ°Ğ·Ğ²Ğ°Ğ½Ğ¸Ğµ *</Label>
                        <Input id="edit-name" {...register("name")} />
                        {errors.name && <p className="text-xs text-red-600 mt-1">{errors.name.message}</p>}
                    </div>
                    <div className="grid grid-cols-2 gap-4">
                        <div>
                            <Label htmlFor="edit-accessory_type">Ğ¢Ğ¸Ğ¿</Label>
                            <Input id="edit-accessory_type" {...register("accessory_type")} />
                        </div>
                        <div>
                            <Label htmlFor="edit-price">Ğ¦ĞµĞ½Ğ° (â‚½/Ğ´ĞµĞ½ÑŒ)</Label>
                            <Input id="edit-price" type="number" step="0.01" {...register("price")} />
                            {errors.price && <p className="text-xs text-red-600 mt-1">{errors.price.message}</p>}
                        </div>
                    </div>
                    <div>
                        <Label htmlFor="edit-description">ĞĞ¿Ğ¸ÑĞ°Ğ½Ğ¸Ğµ</Label>
                        <Textarea id="edit-description" {...register("description")} />
                    </div>
                    <DialogFooter>
                        <Button type="button" variant="ghost" onClick={onClose}>ĞÑ‚Ğ¼ĞµĞ½Ğ°</Button>
                        <Button type="submit" disabled={!isValid || updateMutation.isPending}>
                            {updateMutation.isPending ? "Ğ¡Ğ¾Ñ…Ñ€Ğ°Ğ½ĞµĞ½Ğ¸Ğµ..." : "Ğ¡Ğ¾Ñ…Ñ€Ğ°Ğ½Ğ¸Ñ‚ÑŒ"}
                        </Button>
                    </DialogFooter>
                </form>
            </DialogContent>
        </Dialog>
    );
}

```


## <a name="rentalappmainsrccomponentsadminAccessoryTabletsx"></a>`rental-app-main/src/components/admin/AccessoryTable.tsx`

```tsx
// path: rental-app-main/src/components/admin/AccessoryTable.tsx

// src/components/admin/AccessoryTable.tsx

import { useState } from "react";
import { useAccessories, useDeleteAccessory } from "@/hooks/useAdminAccessories";
import type { Accessory } from "@/types/accessory";
import { AccessoryCreateDialog, AccessoryEditDialog } from "./AccessoryDialogs";

import { Button } from "@/components/ui/button";
import { Input } from "@/components/ui/input";
import {
    Table,
    TableBody,
    TableCell,
    TableHead,
    TableHeader,
    TableRow,
} from "@/components/ui/table";
import { Plus, Edit, Trash2, Search, Wrench, ChevronLeft, ChevronRight } from "lucide-react";

const PAGE_SIZE = 15;

export default function AccessoryTable() {
    // +++ ĞĞĞ§ĞĞ›Ğ Ğ˜Ğ—ĞœĞ•ĞĞ•ĞĞ˜Ğ™ +++
    const [currentPage, setCurrentPage] = useState(1);
    const { data: accessoriesResponse, isLoading, error } = useAccessories(currentPage, PAGE_SIZE);
    const deleteMutation = useDeleteAccessory();

    const accessories = accessoriesResponse?.items ?? [];
    const totalAccessories = accessoriesResponse?.total ?? 0;
    const totalPages = Math.ceil(totalAccessories / PAGE_SIZE);
    // +++ ĞšĞĞĞ•Ğ¦ Ğ˜Ğ—ĞœĞ•ĞĞ•ĞĞ˜Ğ™ +++

    const [search, setSearch] = useState("");
    const [isCreateOpen, setCreateOpen] = useState(false);
    const [editingAccessory, setEditingAccessory] = useState<Accessory | null>(null);

    const filteredAccessories = accessories.filter(acc =>
        acc.name.toLowerCase().includes(search.toLowerCase()) ||
        (acc.accessory_type && acc.accessory_type.toLowerCase().includes(search.toLowerCase()))
    );

    const handleDelete = (id: number) => {
        if (window.confirm("Ğ’Ñ‹ ÑƒĞ²ĞµÑ€ĞµĞ½Ñ‹, Ñ‡Ñ‚Ğ¾ Ñ…Ğ¾Ñ‚Ğ¸Ñ‚Ğµ ÑƒĞ´Ğ°Ğ»Ğ¸Ñ‚ÑŒ ÑÑ‚Ğ¾Ñ‚ Ğ°ĞºÑĞµÑÑÑƒĞ°Ñ€?")) {
            deleteMutation.mutate(id);
        }
    };

    if (isLoading) return <p>Ğ—Ğ°Ğ³Ñ€ÑƒĞ·ĞºĞ° Ğ°ĞºÑĞµÑÑÑƒĞ°Ñ€Ğ¾Ğ²...</p>;
    if (error) return <p className="text-red-600">ĞÑˆĞ¸Ğ±ĞºĞ° Ğ·Ğ°Ğ³Ñ€ÑƒĞ·ĞºĞ¸ Ğ´Ğ°Ğ½Ğ½Ñ‹Ñ….</p>;

    return (
        <>
            <div className="flex items-center justify-between gap-4 mb-4">
                <div className="relative w-full max-w-sm">
                    <Search className="absolute left-3 top-2.5 h-4 w-4 text-muted-foreground" />
                    <Input
                        placeholder="ĞŸĞ¾Ğ¸ÑĞº Ğ¿Ğ¾ Ğ½Ğ°Ğ·Ğ²Ğ°Ğ½Ğ¸Ñ Ğ¸Ğ»Ğ¸ Ñ‚Ğ¸Ğ¿Ñƒ..."
                        value={search}
                        onChange={(e) => setSearch(e.target.value)}
                        className="pl-10"
                    />
                </div>
                <Button onClick={() => setCreateOpen(true)}>
                    <Plus className="mr-2 h-4 w-4" /> Ğ”Ğ¾Ğ±Ğ°Ğ²Ğ¸Ñ‚ÑŒ Ğ°ĞºÑĞµÑÑÑƒĞ°Ñ€
                </Button>
            </div>
            {filteredAccessories.length > 0 ? (
                <>
                    <div className="border rounded-md">
                        <Table>
                            <TableHeader>
                                <TableRow>
                                    <TableHead className="w-[100px]">ID</TableHead>
                                    <TableHead>ĞĞ°Ğ·Ğ²Ğ°Ğ½Ğ¸Ğµ</TableHead>
                                    <TableHead>Ğ¢Ğ¸Ğ¿</TableHead>
                                    <TableHead>Ğ¦ĞµĞ½Ğ°</TableHead>
                                    <TableHead className="text-right">Ğ”ĞµĞ¹ÑÑ‚Ğ²Ğ¸Ñ</TableHead>
                                </TableRow>
                            </TableHeader>
                            <TableBody>
                                {filteredAccessories.map((acc) => (
                                    <TableRow key={acc.id}>
                                        <TableCell>{acc.id}</TableCell>
                                        <TableCell className="font-medium">{acc.name}</TableCell>
                                        <TableCell>{acc.accessory_type}</TableCell>
                                        <TableCell>{acc.price} â‚½</TableCell>
                                        <TableCell className="text-right">
                                            <Button variant="ghost" size="icon" onClick={() => setEditingAccessory(acc)}>
                                                <Edit className="h-4 w-4" />
                                            </Button>
                                            <Button variant="ghost" size="icon" onClick={() => handleDelete(acc.id)} disabled={deleteMutation.isPending}>
                                                <Trash2 className="h-4 w-4 text-red-500" />
                                            </Button>
                                        </TableCell>
                                    </TableRow>
                                ))}
                            </TableBody>
                        </Table>
                    </div>
                    {/* +++ ĞĞĞ§ĞĞ›Ğ: ĞšĞ½Ğ¾Ğ¿ĞºĞ¸ Ğ¿Ğ°Ğ³Ğ¸Ğ½Ğ°Ñ†Ğ¸Ğ¸ +++ */}
                    <div className="flex items-center justify-end space-x-2 py-4">
                        <span className="text-sm text-muted-foreground">
                            Ğ¡Ñ‚Ñ€Ğ°Ğ½Ğ¸Ñ†Ğ° {currentPage} Ğ¸Ğ· {totalPages}
                        </span>
                        <Button
                            variant="outline"
                            size="sm"
                            onClick={() => setCurrentPage(prev => Math.max(prev - 1, 1))}
                            disabled={currentPage === 1}
                        >
                            <ChevronLeft className="h-4 w-4" />
                            ĞĞ°Ğ·Ğ°Ğ´
                        </Button>
                        <Button
                            variant="outline"
                            size="sm"
                            onClick={() => setCurrentPage(prev => Math.min(prev + 1, totalPages))}
                            disabled={currentPage === totalPages}
                        >
                            Ğ’Ğ¿ĞµÑ€ĞµĞ´
                            <ChevronRight className="h-4 w-4" />
                        </Button>
                    </div>
                    {/* +++ ĞšĞĞĞ•Ğ¦: ĞšĞ½Ğ¾Ğ¿ĞºĞ¸ Ğ¿Ğ°Ğ³Ğ¸Ğ½Ğ°Ñ†Ğ¸Ğ¸ +++ */}
                </>
            ) : (
                <div className="text-center py-12 px-4 border rounded-md">
                    <Wrench className="w-16 h-16 text-gray-300 mx-auto mb-3" />
                    <h3 className="text-lg font-semibold text-gray-700">ĞĞºÑĞµÑÑÑƒĞ°Ñ€Ñ‹ Ğ½Ğµ Ğ½Ğ°Ğ¹Ğ´ĞµĞ½Ñ‹</h3>
                    <p className="text-sm text-gray-500 mt-1">{search ? "ĞŸĞ¾Ğ¿Ñ€Ğ¾Ğ±ÑƒĞ¹Ñ‚Ğµ Ğ¸Ğ·Ğ¼ĞµĞ½Ğ¸Ñ‚ÑŒ Ğ¿Ğ¾Ğ¸ÑĞºĞ¾Ğ²Ñ‹Ğ¹ Ğ·Ğ°Ğ¿Ñ€Ğ¾Ñ." : "Ğ”Ğ¾Ğ±Ğ°Ğ²ÑŒÑ‚Ğµ Ğ¿ĞµÑ€Ğ²Ñ‹Ğ¹ Ğ°ĞºÑĞµÑÑÑƒĞ°Ñ€, Ñ‡Ñ‚Ğ¾Ğ±Ñ‹ Ğ¾Ğ½ Ğ¿Ğ¾ÑĞ²Ğ¸Ğ»ÑÑ Ğ² ÑĞ¿Ğ¸ÑĞºĞµ."}</p>
                </div>
            )}

            <AccessoryCreateDialog open={isCreateOpen} onClose={() => setCreateOpen(false)} />
            <AccessoryEditDialog accessory={editingAccessory} open={!!editingAccessory} onClose={() => setEditingAccessory(null)} />
        </>
    );
}

```


## <a name="rentalappmainsrccomponentsadminAdminNavigationtsx"></a>`rental-app-main/src/components/admin/AdminNavigation.tsx`

```tsx
// path: rental-app-main/src/components/admin/AdminNavigation.tsx

// src/components/admin/AdminNavigation.tsx

import { useCurrentUser } from "@/hooks/useProfile";
import { Button } from "@/components/ui/button";
import { useNavigate, useLocation } from "react-router-dom";
import { Users, Package, Shield, Home, Paperclip, ClipboardList, TicketPercent, CalendarDays, Tags, Truck } from "lucide-react"; // <-- Ğ”Ğ¾Ğ±Ğ°Ğ²Ğ»ĞµĞ½Ğ° Ğ¸ĞºĞ¾Ğ½ĞºĞ° Truck

export default function AdminNavigation() {
    const { data: user } = useCurrentUser();
    const navigate = useNavigate();
    const location = useLocation();

    const isAdmin = user?.role === "admin";
    const isManager = user?.role === "manager" || isAdmin;

    if (!isManager) return null;

    const navigationItems = [
        {
            path: "/admin",
            label: "ĞĞ±Ğ·Ğ¾Ñ€",
            icon: <Shield className="w-4 h-4" />,
            accessible: isManager
        },
        {
            path: "/admin/reservations",
            label: "Ğ’ÑĞµ Ñ€ĞµĞ·ĞµÑ€Ğ²Ñ‹",
            icon: <ClipboardList className="w-4 h-4" />,
            accessible: isManager
        },
        // +++ ĞĞĞ’Ğ«Ğ™ ĞŸĞ£ĞĞšĞ¢ ĞœĞ•ĞĞ® +++
        {
            path: "/admin/rentals",
            label: "ĞÑ€ĞµĞ½Ğ´Ñ‹",
            icon: <Truck className="w-4 h-4" />,
            accessible: isManager
        },
        // ++++++++++++++++++++++++
        {
            path: "/admin/users",
            label: "ĞŸĞ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ğ¸",
            icon: <Users className="w-4 h-4" />,
            accessible: isManager,
        },
        {
            path: "/admin/equipment",
            label: "ĞĞ±Ğ¾Ñ€ÑƒĞ´Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ",
            icon: <Package className="w-4 h-4" />,
            accessible: isManager
        },
        {
            path: "/admin/accessories",
            label: "ĞĞºÑĞµÑÑÑƒĞ°Ñ€Ñ‹",
            icon: <Paperclip className="w-4 h-4" />,
            accessible: isManager
        },
        {
            path: "/admin/associations",
            label: "ĞÑÑĞ¾Ñ†Ğ¸Ğ°Ñ†Ğ¸Ğ¸",
            icon: <Tags className="w-4 h-4" />,
            accessible: isManager
        },
        {
            path: "/admin/promocodes",
            label: "ĞŸÑ€Ğ¾Ğ¼Ğ¾ĞºĞ¾Ğ´Ñ‹ Ğ¸ Ğ¡ĞºĞ¸Ğ´ĞºĞ¸",
            icon: <TicketPercent className="w-4 h-4" />,
            accessible: isManager
        },
        {
            path: "/admin/holidays",
            label: "Ğ’Ñ‹Ñ…Ğ¾Ğ´Ğ½Ñ‹Ğµ Ğ´Ğ½Ğ¸",
            icon: <CalendarDays className="w-4 h-4" />,
            accessible: isAdmin
        }
    ];

    const isActive = (path: string) => {
        if (path === "/admin") {
            return location.pathname === "/admin";
        }
        return location.pathname.startsWith(path);
    };

    return (
        <div className="bg-white border rounded-lg shadow-sm p-4 mb-6">
            <div className="flex items-center justify-between mb-4">
                <h2 className="text-lg font-semibold text-gray-900">
                    ĞŸĞ°Ğ½ĞµĞ»ÑŒ ÑƒĞ¿Ñ€Ğ°Ğ²Ğ»ĞµĞ½Ğ¸Ñ
                </h2>
                <Button
                    variant="outline"
                    size="sm"
                    onClick={() => navigate("/")}
                >
                    <Home className="w-4 h-4 mr-2" />
                    ĞĞ° Ğ³Ğ»Ğ°Ğ²Ğ½ÑƒÑ
                </Button>
            </div>

            <div className="flex items-center text-sm text-gray-600 mb-4">
                <span>Ğ Ğ¾Ğ»ÑŒ: </span>
                <span className={`ml-1 font-medium ${
                    isAdmin ? "text-red-600" : "text-blue-600"
                }`}>
                    {user?.role === "admin" ? "ĞĞ´Ğ¼Ğ¸Ğ½Ğ¸ÑÑ‚Ñ€Ğ°Ñ‚Ğ¾Ñ€" : "ĞœĞµĞ½ĞµĞ´Ğ¶ĞµÑ€"}
                </span>
            </div>

            <div className="flex flex-wrap gap-2">
                {navigationItems
                    .filter(item => item.accessible)
                    .map((item) => (
                        <Button
                            key={item.path}
                            variant={isActive(item.path) ? "default" : "outline"}
                            size="sm"
                            onClick={() => navigate(item.path)}
                            className="flex items-center gap-2"
                        >
                            {item.icon}
                            <span>{item.label}</span>
                        </Button>
                    ))
                }
            </div>
        </div>
    );
}

```


## <a name="rentalappmainsrccomponentsadminAdminRentalCardtsx"></a>`rental-app-main/src/components/admin/AdminRentalCard.tsx`

```tsx
// path: rental-app-main/src/components/admin/AdminRentalCard.tsx

// src/components/admin/AdminRentalCard.tsx

import { useState, useMemo, useRef, useEffect } from "react";
import { useNavigate, useLocation } from "react-router-dom";
import { Card, CardContent } from "@/components/ui/card";
import { Button } from "@/components/ui/button";
// âœ… Ğ˜Ğ¡ĞŸĞ ĞĞ’Ğ›Ğ•ĞĞ˜Ğ• 1: Ğ£Ğ±Ğ¸Ñ€Ğ°ĞµĞ¼ Ğ½ĞµĞ¸ÑĞ¿Ğ¾Ğ»ÑŒĞ·ÑƒĞµĞ¼Ñ‹Ğµ Ğ¸ĞºĞ¾Ğ½ĞºĞ¸ Wallet, Landmark, Paperclip
import { Calendar, Edit, Package, Trash2, User, Truck, RotateCcw, List, ChevronDown, Link as LinkIcon, ReceiptText } from "lucide-react";
import { formatDateEuropean, cn } from "@/lib/utils";
import RentalStatusBadge from "./RentalStatusBadge";
import type { AdminRentalOut } from "@/types/rental";
import { useCurrentUser } from "@/hooks/useProfile";
import { useDeleteAdminRental, useRevertRentalToReservation } from "@/hooks/useAdminRentals";
import { ConfirmationDialog } from "@/components/ui/confirmation-dialog";
import type { Equipment } from "@/types/equipment";
import EditableRentalCard from "./EditableRentalCard";
import EquipmentWithAccessoriesList from "@/components/shared/EquipmentWithAccessoriesList";
import { RENTAL_CARD_STYLES } from "@/constants/statusStyles";

interface Props {
    rental: AdminRentalOut;
    onReturn: (rental: AdminRentalOut) => void;
    highlightId?: number;
}

const isToday = (dateString: string): boolean => {
    const date = new Date(dateString);
    const today = new Date();
    return date.getFullYear() === today.getFullYear() &&
        date.getMonth() === today.getMonth() &&
        date.getDate() === today.getDate();
};

export default function AdminRentalCard({ rental, onReturn, highlightId }: Props) {
    const { data: currentUser } = useCurrentUser();
    const deleteMutation = useDeleteAdminRental();
    const revertMutation = useRevertRentalToReservation();
    const [isConfirmingRevert, setConfirmingRevert] = useState(false);
    const [isExpanded, setIsExpanded] = useState(true);
    const [isEditing, setIsEditing] = useState(false);
    const navigate = useNavigate();
    const location = useLocation();
    const cardRef = useRef<HTMLDivElement>(null);

    const isHighlighted = highlightId === rental.id;

    const isAdmin = currentUser?.role === 'admin';
    const canRevert = rental.reservation_id && rental.status !== 'completed' && isToday(rental.created_at);

    const handleDelete = () => {
        if (window.confirm(`Ğ’Ñ‹ ÑƒĞ²ĞµÑ€ĞµĞ½Ñ‹, Ñ‡Ñ‚Ğ¾ Ñ…Ğ¾Ñ‚Ğ¸Ñ‚Ğµ Ğ±ĞµĞ·Ğ²Ğ¾Ğ·Ğ²Ñ€Ğ°Ñ‚Ğ½Ğ¾ ÑƒĞ´Ğ°Ğ»Ğ¸Ñ‚ÑŒ Ğ°Ñ€ĞµĞ½Ğ´Ñƒ #${rental.id}? Ğ­Ñ‚Ğ¾ Ğ´ĞµĞ¹ÑÑ‚Ğ²Ğ¸Ğµ Ğ½ĞµĞ»ÑŒĞ·Ñ Ğ¾Ñ‚Ğ¼ĞµĞ½Ğ¸Ñ‚ÑŒ.`)) {
            deleteMutation.mutate(rental.id);
        }
    };

    const handleRevert = () => {
        revertMutation.mutate(rental.id, {
            onSuccess: () => setConfirmingRevert(false),
            onError: () => setConfirmingRevert(false),
        });
    };


    const handleNavigateToReservation = (reservationId: number) => {
        navigate('/admin/reservations', {
            state: {
                highlightId: reservationId,
                statusFilterOverride: 'all'
            }
        });
    };

    useEffect(() => {
        if (isHighlighted && cardRef.current) {
            cardRef.current.scrollIntoView({
                behavior: "smooth",
                block: "center",
            });
        }
    }, [isHighlighted]);

    if (isEditing) {
        return <EditableRentalCard rental={rental} onCancel={() => setIsEditing(false)} />;
    }

    const statusClass = RENTAL_CARD_STYLES[rental.status] || RENTAL_CARD_STYLES.default;
    
    const highlightClass = isHighlighted
        ? "ring-2 ring-offset-2 ring-amber-500 border-amber-400 bg-amber-50"
        : "";

    return (
        <>
            <div ref={cardRef} className={`relative w-full rounded-lg border transition-all hover:shadow-md ${highlightClass}`}>
                <Card className={cn("w-full", statusClass)}>
                    <CardContent className="p-4">
                        <div className="flex flex-col md:flex-row gap-4 justify-between">
                            {/* Ğ‘Ğ»Ğ¾Ğº Ñ Ğ¾ÑĞ½Ğ¾Ğ²Ğ½Ğ¾Ğ¹ Ğ¸Ğ½Ñ„Ğ¾Ñ€Ğ¼Ğ°Ñ†Ğ¸ĞµĞ¹ */}
                            <div className="flex-1 space-y-2.5">
                                <div className="flex items-center gap-4">
                                    <h3 className="font-bold text-lg text-orange-700 flex items-center gap-2">
                                        <Truck className="w-5 h-5"/> ĞÑ€ĞµĞ½Ğ´Ğ° #{rental.id}
                                    </h3>
                                    <RentalStatusBadge status={rental.status} />
                                </div>
                                <div className="text-sm text-gray-700 space-y-1.5 pl-1">
                                    <div className="flex items-center gap-2">
                                        <User className="w-4 h-4 text-gray-500" />
                                        <span>{rental.user.full_name} ({rental.user.email})</span>
                                    </div>
                                    <div className="flex items-center gap-2">
                                        <span className="text-gray-600">Ğ‘Ğ°Ğ»Ğ°Ğ½Ñ:</span>
                                        <span className={`font-medium ${(rental.user.balance ?? 0) < 0 ? 'text-red-600' : 'text-green-700'}`}>
                                            {(rental.user.balance ?? 0).toLocaleString('ru-RU')} â‚½
                                        </span>
                                    </div>
                                    {rental.reservation_id && (
                                        <div className="flex items-center gap-2">
                                            <LinkIcon className="w-4 h-4 text-gray-500" />
                                            <button
                                                onClick={() => handleNavigateToReservation(rental.reservation_id!)}
                                                className="text-sky-600 hover:underline hover:text-sky-700 transition-colors"
                                            >
                                                Ğ˜Ğ· Ñ€ĞµĞ·ĞµÑ€Ğ²Ğ° #{rental.reservation_id}
                                            </button>
                                        </div>
                                    )}
                                    <div className="flex items-center gap-2">
                                        <Calendar className="w-4 h-4 text-gray-500" />
                                        <span>{formatDateEuropean(rental.start_date)} â€” {formatDateEuropean(rental.end_date)}</span>
                                    </div>
                                    <div className="flex items-start gap-2">
                                        <Package className="w-4 h-4 text-gray-500 mt-0.5 flex-shrink-0" />
                                        <div className="flex-1">
                                            <button
                                                onClick={() => setIsExpanded(!isExpanded)}
                                                className="flex items-center text-left w-full hover:text-sky-700 transition-colors disabled:hover:text-current disabled:cursor-not-allowed"
                                            >
                                                <span>ĞŸĞ¾Ğ·Ğ¸Ñ†Ğ¸Ğ¹ Ğ² Ğ°Ñ€ĞµĞ½Ğ´Ğµ: {rental.equipment.length + (rental.accessory_links?.length ?? 0)}</span>
                                                <ChevronDown className={`w-4 h-4 ml-1 transition-transform ${isExpanded ? 'rotate-180' : ''}`} />
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            {/* Ğ¤Ğ¸Ğ½Ğ°Ğ½ÑĞ¾Ğ²Ñ‹Ğ¹ Ğ±Ğ»Ğ¾Ğº */}
                            <div className="flex-shrink-0 md:w-64 bg-slate-50 p-3 rounded-lg border space-y-2">
                                <h4 className="font-semibold text-sm text-slate-800 flex items-center gap-2"><ReceiptText className="w-4 h-4"/>Ğ¤Ğ¸Ğ½Ğ°Ğ½ÑÑ‹</h4>
                                <div className="text-xs space-y-1.5 text-slate-700">
                                    <div className="flex justify-between"><span>ĞĞ±Ñ‰Ğ°Ñ ÑÑ‚Ğ¾Ğ¸Ğ¼Ğ¾ÑÑ‚ÑŒ:</span> <span className="font-medium">{rental.total_cost.toLocaleString('ru-RU')} â‚½</span></div>
                                    {rental.accessories_cost > 0 && (
                                        <div className="flex justify-between"><span>Ğ’ Ñ‚.Ñ‡. Ğ°ĞºÑĞµÑÑÑƒĞ°Ñ€Ñ‹:</span> <span className="font-medium">{rental.accessories_cost.toLocaleString('ru-RU')} â‚½</span></div>
                                    )}
                                    {rental.discount_amount > 0 && (
                                        <div className="flex justify-between"><span>Ğ¡ĞºĞ¸Ğ´ĞºĞ°:</span> <span className="font-medium text-green-600">-{rental.discount_amount.toLocaleString('ru-RU')} â‚½</span></div>
                                    )}
                                    {rental.prepayment_amount > 0 && (
                                        <div className="flex justify-between"><span>ĞŸÑ€ĞµĞ´Ğ¾Ğ¿Ğ»Ğ°Ñ‚Ğ°:</span> <span className="font-medium text-blue-600">{rental.prepayment_amount.toLocaleString('ru-RU')} â‚½</span></div>
                                    )}
                                    <div className="flex justify-between pt-1 border-t">
                                        <span className="font-semibold text-base">ĞÑÑ‚Ğ°Ñ‚Ğ¾Ğº Ğº Ğ¾Ğ¿Ğ»Ğ°Ñ‚Ğµ:</span>
                                        <span className="font-bold text-base">{rental.remaining_amount.toLocaleString('ru-RU')} â‚½</span>
                                    </div>
                                    {rental.status === 'completed' && rental.final_cost !== null && (
                                        <div className="flex justify-between pt-1 border-t border-dashed">
                                            <span className="font-semibold">Ğ˜Ñ‚Ğ¾Ğ³Ğ¾Ğ²Ğ°Ñ ÑÑ‚Ğ¾Ğ¸Ğ¼Ğ¾ÑÑ‚ÑŒ:</span>
                                            <span className="font-bold">{rental.final_cost.toLocaleString('ru-RU')} â‚½</span>
                                        </div>
                                    )}
                                    <div className="flex justify-between pt-2 border-t text-slate-500">
                                        <span>Ğ’Ğ½ĞµÑĞµĞ½Ğ½Ñ‹Ğ¹ Ğ·Ğ°Ğ»Ğ¾Ğ³:</span>
                                        <span className="font-medium">{rental.deposit_amount.toLocaleString('ru-RU')} â‚½</span>
                                    </div>
                                </div>
                            </div>

                            {/* Ğ‘Ğ»Ğ¾Ğº Ñ ĞºĞ½Ğ¾Ğ¿ĞºĞ°Ğ¼Ğ¸ Ğ´ĞµĞ¹ÑÑ‚Ğ²Ğ¸Ğ¹ */}
                            <div className="flex md:flex-col items-center md:items-end justify-between md:justify-start gap-2 border-t md:border-t-0 md:border-l pt-3 md:pt-0 md:pl-4">
                                <div className="flex flex-col gap-2">
                                    {canRevert && (
                                        <Button size="sm" variant="outline" onClick={() => setConfirmingRevert(true)} className="text-amber-700 border-amber-300 hover:bg-amber-50 hover:text-amber-800">
                                            <RotateCcw className="mr-2 h-4 w-4" />
                                            ĞÑ‚Ğ¼ĞµĞ½Ğ¸Ñ‚ÑŒ Ğ²Ñ‹Ğ´Ğ°Ñ‡Ñƒ
                                        </Button>
                                    )}
                                    <Button size="sm" variant="outline" onClick={() => setIsEditing(true)}>
                                        <Edit className="mr-2 h-4 w-4" />
                                        Ğ ĞµĞ´Ğ°ĞºÑ‚Ğ¸Ñ€Ğ¾Ğ²Ğ°Ñ‚ÑŒ
                                    </Button>
                                    {rental.status !== 'completed' && (
                                        <Button size="sm" variant="default" onClick={() => onReturn(rental)}>
                                            <RotateCcw className="mr-2 h-4 w-4" />
                                            ĞÑ„Ğ¾Ñ€Ğ¼Ğ¸Ñ‚ÑŒ Ğ²Ğ¾Ğ·Ğ²Ñ€Ğ°Ñ‚
                                        </Button>
                                    )}
                                </div>
                                {isAdmin && (
                                    <Button onClick={handleDelete} size="sm" variant="destructive" disabled={deleteMutation.isPending}>
                                        <Trash2 className="mr-2 h-4 w-4" />
                                        {deleteMutation.isPending ? "Ğ£Ğ´Ğ°Ğ»ĞµĞ½Ğ¸Ğµ..." : "Ğ£Ğ´Ğ°Ğ»Ğ¸Ñ‚ÑŒ"}
                                    </Button>
                                )}
                            </div>
                        </div>

                        {/* Ğ Ğ°Ğ·Ğ²Ğ¾Ñ€Ğ°Ñ‡Ğ¸Ğ²Ğ°ĞµĞ¼Ñ‹Ğ¹ Ğ±Ğ»Ğ¾Ğº Ñ ÑĞ¾ÑÑ‚Ğ°Ğ²Ğ¾Ğ¼ Ğ°Ñ€ĞµĞ½Ğ´Ñ‹ */}
                        {isExpanded && (
                            <div className="mt-3 pt-3 border-t border-dashed animate-in fade-in-0 slide-in-from-top-2 duration-300">
                                <div className="flex items-center gap-2 text-sm font-semibold text-gray-600 mb-2">
                                    <List className="w-4 h-4" />
                                    <span>Ğ¡Ğ¾ÑÑ‚Ğ°Ğ² Ğ°Ñ€ĞµĞ½Ğ´Ñ‹:</span>
                                </div>
                                <EquipmentWithAccessoriesList
                                    equipment={rental.equipment.map(equipmentItem => ({
                                        id: equipmentItem.id,
                                        name: `${equipmentItem.equipment_type} ${equipmentItem.brand} ${equipmentItem.name}`
                                    }))}
                                    accessoryLinks={rental.accessory_links || []}
                                    title=""
                                    showTitle={false}
                                    className="border-t-0 pt-0"
                                />
                            </div>
                        )}
                    </CardContent>
                </Card>
            </div>

            <ConfirmationDialog
                open={isConfirmingRevert}
                onOpenChange={setConfirmingRevert}
                title="ĞÑ‚Ğ¼ĞµĞ½Ğ¸Ñ‚ÑŒ Ğ²Ñ‹Ğ´Ğ°Ñ‡Ñƒ Ğ°Ñ€ĞµĞ½Ğ´Ñ‹?"
                description={`ĞÑ€ĞµĞ½Ğ´Ğ° #${rental.id} Ğ±ÑƒĞ´ĞµÑ‚ ÑƒĞ´Ğ°Ğ»ĞµĞ½Ğ°, Ğ° Ğ¸ÑÑ…Ğ¾Ğ´Ğ½Ñ‹Ğ¹ Ñ€ĞµĞ·ĞµÑ€Ğ² #${rental.reservation_id} ÑĞ½Ğ¾Ğ²Ğ° ÑÑ‚Ğ°Ğ½ĞµÑ‚ Ğ°ĞºÑ‚Ğ¸Ğ²Ğ½Ñ‹Ğ¼. Ğ­Ñ‚Ğ¾ Ğ´ĞµĞ¹ÑÑ‚Ğ²Ğ¸Ğµ Ğ½ĞµĞ»ÑŒĞ·Ñ Ğ±ÑƒĞ´ĞµÑ‚ Ğ¾Ñ‚Ğ¼ĞµĞ½Ğ¸Ñ‚ÑŒ.`}
                confirmText="Ğ”Ğ°, Ğ¾Ñ‚Ğ¼ĞµĞ½Ğ¸Ñ‚ÑŒ Ğ²Ñ‹Ğ´Ğ°Ñ‡Ñƒ"
                cancelText="ĞĞ°Ğ·Ğ°Ğ´"
                onConfirm={handleRevert}
                variant="destructive"
            />
        </>
    );
}

```


## <a name="rentalappmainsrccomponentsadminAdminReservationCardtsx"></a>`rental-app-main/src/components/admin/AdminReservationCard.tsx`

```tsx
// path: rental-app-main/src/components/admin/AdminReservationCard.tsx

// src/components/admin/AdminReservationCard.tsx

import { useState, useMemo, useRef, useEffect } from "react";
import { useLocation, useNavigate } from "react-router-dom";
import { Card, CardContent } from "@/components/ui/card";
import { Button } from "@/components/ui/button";
import { Calendar, Edit, Package, Trash2, User, Truck, CheckCircle, AlertTriangle, XCircle, List } from "lucide-react";
import { formatDateEuropean, cn } from "@/lib/utils";
import type { AdminReservationOut } from "@/types/reservation";
import { useDeleteAdminReservation } from "@/hooks/useAdminReservations";
import { ReservationEditProvider } from "@/hooks/useInlineReservationEdit";
import EditableReservationCard from "@/components/reservation/EditableReservationCard";
import type { Equipment } from "@/types/equipment";
import { Checkbox } from "@/components/ui/checkbox";
import { useAdminReservationSelectionStore } from "@/store/adminReservationSelectionStore";
import EquipmentWithAccessoriesList from "@/components/shared/EquipmentWithAccessoriesList";
import FinancialInfoBlock from "@/components/shared/FinancialInfoBlock";
import { RESERVATION_CARD_STYLES } from "@/constants/statusStyles";

interface Props {
    reservation: AdminReservationOut;
    onConvertToRental: (reservation: AdminReservationOut) => void;
    equipmentMap: Map<number, Equipment>;
    highlightId?: number;
}

const getStatusInfo = (reservation: AdminReservationOut) => {
    const now = new Date();
    now.setHours(0, 0, 0, 0);
    const endDate = new Date(reservation.end_date);

    if (reservation.status === 'fulfilled') {
        return { text: "Ğ’Ñ‹Ğ¿Ğ¾Ğ»Ğ½ĞµĞ½", Icon: CheckCircle, className: "text-green-600 bg-green-50 border-green-200", isActionable: false };
    }
    if (reservation.status === 'cancelled') {
        return { text: "ĞÑ‚Ğ¼ĞµĞ½ĞµĞ½", Icon: XCircle, className: "text-gray-600 bg-gray-100 border-gray-200", isActionable: false };
    }
    if (endDate < now || reservation.status === 'overdue') {
        return { text: "ĞŸÑ€Ğ¾ÑÑ€Ğ¾Ñ‡ĞµĞ½", Icon: AlertTriangle, className: "text-orange-600 bg-orange-50 border-orange-200", isActionable: true };
    }
    return { text: "ĞĞºÑ‚Ğ¸Ğ²ĞµĞ½", Icon: Calendar, className: "text-blue-600 bg-blue-50 border-blue-200", isActionable: true };
};

export default function AdminReservationCard({ reservation, onConvertToRental, equipmentMap, highlightId }: Props) {
    const [isEditing, setIsEditing] = useState(false);
    const [isExpanded, setIsExpanded] = useState(false);
    const deleteReservationMutation = useDeleteAdminReservation();
    const cardRef = useRef<HTMLDivElement>(null);
    const navigate = useNavigate();
    const location = useLocation();

    const { selectedIds, toggleId } = useAdminReservationSelectionStore();
    const isSelected = selectedIds.includes(reservation.id);
    const isHighlighted = highlightId === reservation.id;

    const statusInfo = useMemo(() => getStatusInfo(reservation), [reservation]);

    useEffect(() => {
        if (isHighlighted && cardRef.current) {
            cardRef.current.scrollIntoView({
                behavior: "smooth",
                block: "center",
            });
        }
    }, [isHighlighted]);


    const handleDelete = () => {
        if (window.confirm(`Ğ’Ñ‹ ÑƒĞ²ĞµÑ€ĞµĞ½Ñ‹, Ñ‡Ñ‚Ğ¾ Ñ…Ğ¾Ñ‚Ğ¸Ñ‚Ğµ ÑƒĞ´Ğ°Ğ»Ğ¸Ñ‚ÑŒ Ñ€ĞµĞ·ĞµÑ€Ğ² #${reservation.id} Ğ´Ğ»Ñ ĞºĞ»Ğ¸ĞµĞ½Ñ‚Ğ° "${reservation.user_info.full_name}"?`)) {
            deleteReservationMutation.mutate(reservation.id);
        }
    };

    const handleNavigateToRental = () => {
        if (reservation.rental_id) {
            navigate('/admin/rentals', {
                state: {
                    highlightId: reservation.rental_id,
                    statusFilterOverride: 'all'
                }
            });
        }
    };

    const initialEquipmentForDisplay = useMemo(() =>
            reservation.equipment_ids
                .map(id => {
                    const equipment = equipmentMap.get(id);
                    if (!equipment) {
                        return { id, label: `ĞĞ±Ğ¾Ñ€ÑƒĞ´Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ #${id} (Ğ½Ğµ Ğ½Ğ°Ğ¹Ğ´ĞµĞ½Ğ¾)` };
                    }
                    return { id, label: `${equipment.equipment_type} ${equipment.brand} ${equipment.name}` };
                }),
        [reservation.equipment_ids, equipmentMap]
    );

    const equipmentListForDisplay = useMemo(() =>
        reservation.equipment_ids.map(id => {
            const equipment = equipmentMap.get(id);
            return equipment
                ? `${equipment.equipment_type} ${equipment.brand} ${equipment.name}`
                : `ĞĞ±Ğ¾Ñ€ÑƒĞ´Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ #${id} (Ğ½Ğµ Ğ½Ğ°Ğ¹Ğ´ĞµĞ½Ğ¾)`;
        }), [reservation.equipment_ids, equipmentMap]);

    if (isEditing) {
        return (
            <ReservationEditProvider
                reservation={reservation}
                initialEquipmentForDisplay={initialEquipmentForDisplay}
                onFullCancellation={handleDelete}
                isAdminContext={true}
                onFinishEditing={() => setIsEditing(false)}
            >
                <EditableReservationCard />
            </ReservationEditProvider>
        );
    }

    const statusClass = RESERVATION_CARD_STYLES[reservation.status] || RESERVATION_CARD_STYLES.default;
    
    const highlightClass = isHighlighted
        ? "ring-2 ring-offset-2 ring-amber-500 border-amber-400 bg-amber-50"
        : isSelected
            ? 'ring-2 ring-sky-500 border-sky-400'
            : 'border-gray-200';

    return (
        <div ref={cardRef} className={`relative w-full rounded-lg border transition-all hover:shadow-md ${highlightClass}`}>
            <div className="absolute top-4 left-4 z-10">
                <Checkbox
                    checked={isSelected}
                    onCheckedChange={() => toggleId(reservation.id)}
                    aria-label={`Ğ’Ñ‹Ğ±Ñ€Ğ°Ñ‚ÑŒ Ñ€ĞµĞ·ĞµÑ€Ğ² #${reservation.id}`}
                    className="bg-white h-5 w-5"
                />
            </div>
            <Card className={cn("w-full", statusClass)}>
                <CardContent className="p-4 pl-12">
                    <div className="flex flex-col md:flex-row gap-4 justify-between">
                        <div className="flex-1 space-y-2.5">
                            <div className="flex items-center gap-4">
                                <h3 className="font-bold text-lg text-indigo-700">Ğ ĞµĞ·ĞµÑ€Ğ² #{reservation.id}</h3>
                                <span className={`flex items-center gap-1.5 text-xs font-medium px-2 py-1 rounded-md border ${statusInfo.className}`}>
                                    <statusInfo.Icon className="w-3.5 h-3.5" />
                                    {statusInfo.text}
                                </span>
                            </div>
                            <div className="text-sm text-gray-700 space-y-1.5 pl-1">
                                <div className="flex items-center gap-2">
                                    <User className="w-4 h-4 text-gray-500" />
                                    <span>{reservation.user_info.full_name} ({reservation.user_info.email})</span>
                                </div>
                                <div className="flex items-center gap-2">
                                    <Calendar className="w-4 h-4 text-gray-500" />
                                    <span>{formatDateEuropean(reservation.start_date)} â€” {formatDateEuropean(reservation.end_date)}</span>
                                </div>
                                <div className="flex items-start gap-2">
                                    <Package className="w-4 h-4 text-gray-500 mt-1 flex-shrink-0" />
                                    <div className="flex-1">
                                        <div className="flex items-center text-left w-full">
                                            <span>ĞŸĞ¾Ğ·Ğ¸Ñ†Ğ¸Ğ¹ Ğ² Ñ€ĞµĞ·ĞµÑ€Ğ²Ğµ: {equipmentListForDisplay.length}</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        {/* Ğ¤Ğ¸Ğ½Ğ°Ğ½ÑĞ¾Ğ²Ñ‹Ğ¹ Ğ±Ğ»Ğ¾Ğº */}
                        <FinancialInfoBlock
                            totalCost={reservation.total_cost}
                            discountAmount={reservation.discount_amount}
                            promoCode={reservation.promo_code}
                            variant="admin"
                        />

                        <div className="flex md:flex-col items-center md:items-end justify-between md:justify-start gap-2 border-t md:border-t-0 md:border-l pt-3 md:pt-0 md:pl-4">
                            {statusInfo.isActionable ? (
                                <>
                                    <Button onClick={() => onConvertToRental(reservation)} size="sm" className="bg-green-600 hover:bg-green-700 w-full md:w-auto">
                                        <Truck className="mr-2 h-4 w-4" />
                                        Ğ’Ñ‹Ğ´Ğ°Ñ‚ÑŒ Ğ² Ğ°Ñ€ĞµĞ½Ğ´Ñƒ
                                    </Button>
                                    <Button onClick={() => setIsEditing(true)} size="sm" variant="outline" className="w-full md:w-auto">
                                        <Edit className="mr-2 h-4 w-4" />
                                        Ğ ĞµĞ´Ğ°ĞºÑ‚Ğ¸Ñ€Ğ¾Ğ²Ğ°Ñ‚ÑŒ
                                    </Button>
                                </>
                            ) : (
                                <div className="text-sm text-gray-500 flex items-center gap-2 pr-2">
                                    <span>Ğ”ĞµĞ¹ÑÑ‚Ğ²Ğ¸Ğ¹ Ğ½ĞµÑ‚</span>
                                </div>
                            )}

                            {/* ĞšĞ½Ğ¾Ğ¿ĞºĞ° Ğ¿ĞµÑ€ĞµÑ…Ğ¾Ğ´Ğ° Ğº Ğ°Ñ€ĞµĞ½Ğ´Ğµ Ğ´Ğ»Ñ Ğ²Ñ‹Ğ¿Ğ¾Ğ»Ğ½ĞµĞ½Ğ½Ñ‹Ñ… Ñ€ĞµĞ·ĞµÑ€Ğ²Ğ¾Ğ² */}
                            {reservation.status === 'fulfilled' && reservation.rental_id && (
                                <Button onClick={handleNavigateToRental} size="sm" variant="outline" className="w-full md:w-auto text-orange-600 hover:text-orange-700 hover:bg-orange-50 border-orange-200">
                                    <Truck className="mr-2 h-4 w-4" />
                                    ĞŸĞµÑ€ĞµĞ¹Ñ‚Ğ¸ Ğº Ğ°Ñ€ĞµĞ½Ğ´Ğµ
                                </Button>
                            )}

                            <Button onClick={handleDelete} size="sm" variant="destructive" disabled={deleteReservationMutation.isPending} className="w-full md:w-auto">
                                <Trash2 className="mr-2 h-4 w-4" />
                                {deleteReservationMutation.isPending ? "Ğ£Ğ´Ğ°Ğ»ĞµĞ½Ğ¸Ğµ..." : "Ğ£Ğ´Ğ°Ğ»Ğ¸Ñ‚ÑŒ"}
                            </Button>
                        </div>
                    </div>

                    {equipmentListForDisplay.length > 0 && (
                        <div className="mt-3 pt-3 border-t border-dashed animate-in fade-in-0 slide-in-from-top-2 duration-300">
                            <div className="flex items-center gap-2 text-sm font-semibold text-gray-600 mb-2">
                                <List className="w-4 h-4" />
                                <span>Ğ¡Ğ¾ÑÑ‚Ğ°Ğ² Ñ€ĞµĞ·ĞµÑ€Ğ²Ğ°:</span>
                            </div>
                            <EquipmentWithAccessoriesList
                                equipment={reservation.equipment_ids.map(equipmentId => {
                                    const equipment = equipmentMap.get(equipmentId);
                                    return {
                                        id: equipmentId,
                                        name: equipment
                                            ? `${equipment.equipment_type} ${equipment.brand} ${equipment.name}`
                                            : `ĞĞ±Ğ¾Ñ€ÑƒĞ´Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ #${equipmentId} (Ğ½Ğµ Ğ½Ğ°Ğ¹Ğ´ĞµĞ½Ğ¾)`
                                    };
                                })}
                                accessoryLinks={reservation.accessory_links || []}
                                title=""
                                showTitle={false}
                                className="border-t-0 pt-0"
                            />
                        </div>
                    )}
                </CardContent>
            </Card>
        </div>
    );
}

```


## <a name="rentalappmainsrccomponentsadminAdminReservationToolbartsx"></a>`rental-app-main/src/components/admin/AdminReservationToolbar.tsx`

```tsx
// path: rental-app-main/src/components/admin/AdminReservationToolbar.tsx

// src/components/admin/AdminReservationToolbar.tsx

import { Button } from '@/components/ui/button';
import { Checkbox } from '@/components/ui/checkbox';
import { Trash2 } from 'lucide-react';
import { useAdminReservationSelectionStore } from '@/store/adminReservationSelectionStore';

interface Props {
    visibleReservationIds: number[];
    onBulkDelete: () => void;
    isDeleting: boolean;
}

export function AdminReservationToolbar({ visibleReservationIds, onBulkDelete, isDeleting }: Props) {
    const { selectedIds, setSelectedIds, clearSelection } = useAdminReservationSelectionStore();

    const isAllSelected = visibleReservationIds.length > 0 && selectedIds.length === visibleReservationIds.length;
    const isSomeSelected = selectedIds.length > 0 && selectedIds.length < visibleReservationIds.length;

    const handleSelectAll = (checked: boolean | 'indeterminate') => {
        if (checked === true) {
            setSelectedIds(visibleReservationIds);
        } else {
            clearSelection();
        }
    };

    return (
        <div className="flex items-center gap-4 p-3 bg-slate-50 border rounded-md mb-4 h-14">
            <div className="flex items-center gap-2">
                <Checkbox
                    id="select-all"
                    checked={isAllSelected ? true : (isSomeSelected ? 'indeterminate' : false)}
                    onCheckedChange={handleSelectAll}
                    aria-label="Ğ’Ñ‹Ğ±Ñ€Ğ°Ñ‚ÑŒ Ğ²ÑĞµ Ğ²Ğ¸Ğ´Ğ¸Ğ¼Ñ‹Ğµ Ñ€ĞµĞ·ĞµÑ€Ğ²Ñ‹"
                />
                <label htmlFor="select-all" className="text-sm font-medium text-slate-700 cursor-pointer">
                    Ğ’Ñ‹Ğ±Ñ€Ğ°Ñ‚ÑŒ Ğ²ÑĞµ
                </label>
            </div>

            {selectedIds.length > 0 && (
                <div className="flex items-center gap-4 animate-in fade-in-0 duration-300">
          <span className="text-sm text-slate-500">
            Ğ’Ñ‹Ğ±Ñ€Ğ°Ğ½Ğ¾: {selectedIds.length}
          </span>
                    <Button
                        size="sm"
                        variant="destructive"
                        onClick={onBulkDelete}
                        disabled={isDeleting}
                    >
                        <Trash2 className="w-4 h-4 mr-2" />
                        {isDeleting ? 'Ğ£Ğ´Ğ°Ğ»ĞµĞ½Ğ¸Ğµ...' : 'Ğ£Ğ´Ğ°Ğ»Ğ¸Ñ‚ÑŒ Ğ²Ñ‹Ğ±Ñ€Ğ°Ğ½Ğ½Ğ¾Ğµ'}
                    </Button>
                </div>
            )}
        </div>
    );
}

```


## <a name="rentalappmainsrccomponentsadminAllRentalsListtsx"></a>`rental-app-main/src/components/admin/AllRentalsList.tsx`

```tsx
// path: rental-app-main/src/components/admin/AllRentalsList.tsx

// src/components/admin/AllRentalsList.tsx

// +++ Ğ”ĞĞ‘ĞĞ’Ğ¬Ğ¢Ğ• Ğ˜ĞœĞŸĞĞ Ğ¢ AdminRentalOut +++
import type { AdminRentalOut } from "@/types/rental";
import { ClipboardX } from "lucide-react";
import AdminRentalCard from "./AdminRentalCard";

// +++ Ğ˜Ğ—ĞœĞ•ĞĞ˜Ğ¢Ğ• Ğ˜ĞĞ¢Ğ•Ğ Ğ¤Ğ•Ğ™Ğ¡ Props +++
interface Props {
    rentals: AdminRentalOut[];
    onReturn: (rental: AdminRentalOut) => void;
    highlightId?: number | null;
}

export default function AllRentalsList({ rentals, onReturn, highlightId }: Props) {
    if (!rentals || rentals.length === 0) {
        return (
            <div className="flex flex-col items-center justify-center text-center p-12 space-y-4 bg-gray-50/50 rounded-lg border-2 border-dashed">
                <ClipboardX className="w-16 h-16 text-gray-400" />
                <h3 className="text-lg font-semibold text-gray-800">ĞÑ€ĞµĞ½Ğ´Ñ‹ Ğ½Ğµ Ğ½Ğ°Ğ¹Ğ´ĞµĞ½Ñ‹</h3>
                <p className="text-sm text-gray-500">ĞŸĞ¾Ğ¿Ñ€Ğ¾Ğ±ÑƒĞ¹Ñ‚Ğµ Ğ¸Ğ·Ğ¼ĞµĞ½Ğ¸Ñ‚ÑŒ Ñ„Ğ¸Ğ»ÑŒÑ‚Ñ€Ñ‹ Ğ¸Ğ»Ğ¸ Ğ¿Ğ¾Ğ¸ÑĞºĞ¾Ğ²Ñ‹Ğ¹ Ğ·Ğ°Ğ¿Ñ€Ğ¾Ñ.</p>
            </div>
        );
    }

    return (
        <div className="space-y-4">
            {/* +++ ĞŸĞ•Ğ Ğ•Ğ”ĞĞ™Ğ¢Ğ• ĞŸĞ ĞĞŸĞ¡ onReturn Ğ’ ĞšĞĞ Ğ¢ĞĞ§ĞšĞ£ +++ */}
            {rentals.map((rental) => (
                <AdminRentalCard key={rental.id} rental={rental} onReturn={onReturn} highlightId={highlightId} />
            ))}
        </div>
    );
}

```


## <a name="rentalappmainsrccomponentsadminAllReservationsListtsx"></a>`rental-app-main/src/components/admin/AllReservationsList.tsx`

```tsx
// path: rental-app-main/src/components/admin/AllReservationsList.tsx

// src/components/admin/AllReservationsList.tsx

import type { AdminReservationOut } from "@/types/reservation";
import AdminReservationCard from "./AdminReservationCard";
import type { Equipment } from "@/types/equipment";

interface Props {
    reservations: AdminReservationOut[];
    onConvertToRental: (reservation: AdminReservationOut) => void;
    equipmentMap: Map<number, Equipment>;
    highlightId?: number;
}

export default function AllReservationsList({ reservations, onConvertToRental, equipmentMap, highlightId }: Props) {
    return (
        <div className="space-y-4">
            {reservations.map((reservation) => (
                <AdminReservationCard
                    key={reservation.id}
                    reservation={reservation}
                    onConvertToRental={onConvertToRental}
                    equipmentMap={equipmentMap}
                    highlightId={highlightId}
                />
            ))}
        </div>
    );
}

```


## <a name="rentalappmainsrccomponentsadminAssociationTabletsx"></a>`rental-app-main/src/components/admin/AssociationTable.tsx`

```tsx
// path: rental-app-main/src/components/admin/AssociationTable.tsx

// src/components/admin/AssociationTable.tsx

import { useState, useMemo, useEffect } from "react";
import { useAdminAssociations, useCreateAssociation, useUpdateAssociation, useDeleteAssociation } from "@/hooks/useAdminAssociations";
// âŒ Ğ£Ğ”ĞĞ›Ğ•ĞĞ: Ğ‘Ğ¾Ğ»ÑŒÑˆĞµ Ğ½Ğµ Ğ¸ÑĞ¿Ğ¾Ğ»ÑŒĞ·ÑƒĞµĞ¼ Ğ¿Ğ°Ğ³Ğ¸Ğ½Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ½Ñ‹Ğ¹ Ñ…ÑƒĞº Ğ´Ğ»Ñ Ğ¾Ğ±Ğ¾Ñ€ÑƒĞ´Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ
// import { useEquipment } from "@/hooks/useEquipment";
// âœ… Ğ”ĞĞ‘ĞĞ’Ğ›Ğ•ĞĞ: Ğ˜ÑĞ¿Ğ¾Ğ»ÑŒĞ·ÑƒĞµĞ¼ Ñ…ÑƒĞº, ĞºĞ¾Ñ‚Ğ¾Ñ€Ñ‹Ğ¹ Ğ·Ğ°Ğ³Ñ€ÑƒĞ¶Ğ°ĞµÑ‚ ĞŸĞĞ›ĞĞ«Ğ™ ÑĞ¿Ğ¸ÑĞ¾Ğº Ğ¾Ğ±Ğ¾Ñ€ÑƒĞ´Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ Ğ´Ğ»Ñ Ğ½Ğ°ÑˆĞµĞ³Ğ¾ "ÑĞ¿Ñ€Ğ°Ğ²Ğ¾Ñ‡Ğ½Ğ¸ĞºĞ°"
import { useAllEquipment } from "@/hooks/useAllEquipment";
import { useForm, Controller } from "react-hook-form";
import { zodResolver } from "@hookform/resolvers/zod";
import { z } from "zod";
import type { Association } from "@/types/association";
// âŒ Ğ£Ğ”ĞĞ›Ğ•ĞĞ: Ğ­Ñ‚Ğ¾Ñ‚ Ñ‚Ğ¸Ğ¿ Ğ±Ğ¾Ğ»ÑŒÑˆĞµ Ğ½Ğµ Ğ½ÑƒĞ¶ĞµĞ½, Ñ‚Ğ°Ğº ĞºĞ°Ğº Ğ¼Ñ‹ Ğ½Ğµ Ñ€Ğ°Ğ±Ğ¾Ñ‚Ğ°ĞµĞ¼ Ñ Ğ¿Ğ°Ğ³Ğ¸Ğ½Ğ°Ñ†Ğ¸ĞµĞ¹ Ğ·Ğ´ĞµÑÑŒ
// import type { EquipmentListResponse } from "@/core/services/EquipmentService";

// UI Components
import { Button } from "@/components/ui/button";
import { Dialog, DialogContent, DialogHeader, DialogTitle, DialogFooter, DialogDescription } from "@/components/ui/dialog";
import { Input } from "@/components/ui/input";
import { Label } from "@/components/ui/label";
import { MultiSelect } from "@/components/ui/multi-select";
import { Table, TableBody, TableCell, TableHead, TableHeader, TableRow } from "@/components/ui/table";
import { Plus, Edit, Trash2, Tags, Loader2 } from "lucide-react";

const associationSchema = z.object({
    name: z.string().min(3, "ĞĞ°Ğ·Ğ²Ğ°Ğ½Ğ¸Ğµ Ğ¾Ğ±ÑĞ·Ğ°Ñ‚ĞµĞ»ÑŒĞ½Ğ¾"),
    description: z.string().optional(),
    sort_order: z.coerce.number(),
    equipment_ids: z.array(z.number()),
});
type AssociationFormData = z.infer<typeof associationSchema>;

// --- ĞšĞ¾Ğ¼Ğ¿Ğ¾Ğ½ĞµĞ½Ñ‚ Ğ´Ğ¸Ğ°Ğ»Ğ¾Ğ³Ğ¾Ğ²Ğ¾Ğ³Ğ¾ Ğ¾ĞºĞ½Ğ° (Ğ±ĞµĞ· Ğ¸Ğ·Ğ¼ĞµĞ½ĞµĞ½Ğ¸Ğ¹ Ğ² Ğ»Ğ¾Ğ³Ğ¸ĞºĞµ) ---
function AssociationDialog({ open, onClose, association, allEquipment }: {
    open: boolean;
    onClose: () => void;
    association: Association | null;
    allEquipment: { value: string, label: string }[];
}) {
    const createMutation = useCreateAssociation();
    const updateMutation = useUpdateAssociation();

    const {
        register,
        handleSubmit,
        control,
        reset,
        formState: { errors, isValid },
    } = useForm<AssociationFormData>({
        resolver: zodResolver(associationSchema),
        mode: "onChange",
    });

    useEffect(() => {
        if (open) {
            reset({
                name: association?.name ?? "",
                description: association?.description ?? "",
                sort_order: association?.sort_order ?? 0,
                equipment_ids: association?.equipment_ids ?? [],
            });
        }
    }, [association, open, reset]);

    const onSubmit = (data: AssociationFormData) => {
        const handleSuccess = () => {
            reset();
            onClose();
        };

        if (association) {
            updateMutation.mutate({ id: association.id, data }, { onSuccess: handleSuccess });
        } else {
            createMutation.mutate(data, { onSuccess: handleSuccess });
        }
    };

    return (
        <Dialog open={open} onOpenChange={onClose}>
            <DialogContent>
                <DialogHeader>
                    <DialogTitle>{association ? "Ğ ĞµĞ´Ğ°ĞºÑ‚Ğ¸Ñ€Ğ¾Ğ²Ğ°Ñ‚ÑŒ Ğ°ÑÑĞ¾Ñ†Ğ¸Ğ°Ñ†Ğ¸Ñ" : "ĞĞ¾Ğ²Ğ°Ñ Ğ°ÑÑĞ¾Ñ†Ğ¸Ğ°Ñ†Ğ¸Ñ"}</DialogTitle>
                    <DialogDescription>
                        {association ? `Ğ ĞµĞ´Ğ°ĞºÑ‚Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ "${association.name}"` : "Ğ¡Ğ¾Ğ·Ğ´Ğ°Ğ¹Ñ‚Ğµ Ğ½Ğ¾Ğ²ÑƒÑ Ğ¿Ğ¾Ğ´Ğ±Ğ¾Ñ€ĞºÑƒ Ğ¾Ğ±Ğ¾Ñ€ÑƒĞ´Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ."}
                    </DialogDescription>
                </DialogHeader>
                <form onSubmit={handleSubmit(onSubmit)} className="space-y-4 py-2">
                    <div>
                        <Label htmlFor="assoc-name">ĞĞ°Ğ·Ğ²Ğ°Ğ½Ğ¸Ğµ *</Label>
                        <Input id="assoc-name" {...register("name")} placeholder="ĞĞ°Ğ±Ğ¾Ñ€ Ğ´Ğ»Ñ ÑÑ‚Ñ€Ğ¸Ğ¼Ğ¸Ğ½Ğ³Ğ°" />
                        {errors.name && <p className="text-xs text-red-600 mt-1">{errors.name.message}</p>}
                    </div>
                    <div>
                        <Label htmlFor="assoc-sort">ĞŸĞ¾Ñ€ÑĞ´Ğ¾Ğº ÑĞ¾Ñ€Ñ‚Ğ¸Ñ€Ğ¾Ğ²ĞºĞ¸</Label>
                        <Input id="assoc-sort" type="number" {...register("sort_order")} />
                    </div>
                    <div>
                        <Label>ĞĞ±Ğ¾Ñ€ÑƒĞ´Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ Ğ² Ğ¿Ğ¾Ğ´Ğ±Ğ¾Ñ€ĞºĞµ</Label>
                        <Controller
                            name="equipment_ids"
                            control={control}
                            render={({ field }) => (
                                <MultiSelect
                                    placeholder="Ğ’Ñ‹Ğ±ĞµÑ€Ğ¸Ñ‚Ğµ Ğ¾Ğ±Ğ¾Ñ€ÑƒĞ´Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ..."
                                    options={allEquipment}
                                    value={field.value.map(String)}
                                    onValueChange={(selected) => field.onChange(selected.map(Number))}
                                />
                            )}
                        />
                    </div>
                    <DialogFooter>
                        <Button type="button" variant="ghost" onClick={onClose}>ĞÑ‚Ğ¼ĞµĞ½Ğ°</Button>
                        <Button type="submit" disabled={!isValid || createMutation.isPending || updateMutation.isPending}>
                            {createMutation.isPending || updateMutation.isPending ? "Ğ¡Ğ¾Ñ…Ñ€Ğ°Ğ½ĞµĞ½Ğ¸Ğµ..." : "Ğ¡Ğ¾Ñ…Ñ€Ğ°Ğ½Ğ¸Ñ‚ÑŒ"}
                        </Button>
                    </DialogFooter>
                </form>
            </DialogContent>
        </Dialog>
    );
}

// --- ĞÑĞ½Ğ¾Ğ²Ğ½Ğ¾Ğ¹ ĞºĞ¾Ğ¼Ğ¿Ğ¾Ğ½ĞµĞ½Ñ‚ Ñ‚Ğ°Ğ±Ğ»Ğ¸Ñ†Ñ‹ ---
export default function AssociationTable() {
    const { data: associations = [], isLoading } = useAdminAssociations();
    // âœ… Ğ˜Ğ—ĞœĞ•ĞĞ•ĞĞ: Ğ—Ğ°Ğ³Ñ€ÑƒĞ¶Ğ°ĞµĞ¼ Ğ²ĞµÑÑŒ ÑĞ¿Ğ¸ÑĞ¾Ğº Ğ¾Ğ±Ğ¾Ñ€ÑƒĞ´Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ Ğ¾Ğ´Ğ¸Ğ½ Ñ€Ğ°Ğ·.
    const { data: allEquipment = [] } = useAllEquipment();
    const deleteMutation = useDeleteAssociation();

    // âœ… Ğ˜Ğ—ĞœĞ•ĞĞ•ĞĞ: ĞŸÑ€ĞµĞ¾Ğ±Ñ€Ğ°Ğ·ÑƒĞµĞ¼ Ğ¿Ğ¾Ğ»Ğ½Ñ‹Ğ¹ ÑĞ¿Ğ¸ÑĞ¾Ğº Ğ² Ñ„Ğ¾Ñ€Ğ¼Ğ°Ñ‚ Ğ´Ğ»Ñ Ğ²Ñ‹Ğ¿Ğ°Ğ´Ğ°ÑÑ‰ĞµĞ³Ğ¾ Ğ¼ĞµĞ½Ñ.
    const equipmentOptions = useMemo(() =>
            allEquipment.map(e => ({ value: e.id.toString(), label: e.name })),
        [allEquipment]
    );

    const [isDialogOpen, setDialogOpen] = useState(false);
    const [editingAssoc, setEditingAssoc] = useState<Association | null>(null);

    const handleEdit = (assoc: Association) => { setEditingAssoc(assoc); setDialogOpen(true); };
    const handleCreate = () => { setEditingAssoc(null); setDialogOpen(true); };
    const handleDelete = (id: number) => { if (window.confirm("Ğ£Ğ´Ğ°Ğ»Ğ¸Ñ‚ÑŒ Ğ°ÑÑĞ¾Ñ†Ğ¸Ğ°Ñ†Ğ¸Ñ?")) deleteMutation.mutate(id); };

    if (isLoading) return <div className="flex items-center gap-2"><Loader2 className="animate-spin" /> Ğ—Ğ°Ğ³Ñ€ÑƒĞ·ĞºĞ°...</div>;

    return (
        <>
            <div className="flex justify-end mb-4">
                <Button onClick={handleCreate}><Plus className="mr-2 h-4 w-4" /> Ğ¡Ğ¾Ğ·Ğ´Ğ°Ñ‚ÑŒ</Button>
            </div>
            {associations.length > 0 ? (
                <Table>
                    <TableHeader>
                        <TableRow>
                            <TableHead>ĞŸĞ¾Ñ€ÑĞ´Ğ¾Ğº</TableHead>
                            <TableHead>ĞĞ°Ğ·Ğ²Ğ°Ğ½Ğ¸Ğµ</TableHead>
                            <TableHead>ĞšĞ¾Ğ»-Ğ²Ğ¾ ĞµĞ´.</TableHead>
                            <TableHead className="text-right">Ğ”ĞµĞ¹ÑÑ‚Ğ²Ğ¸Ñ</TableHead>
                        </TableRow>
                    </TableHeader>
                    <TableBody>
                        {associations.map((assoc) => (
                            <TableRow key={assoc.id}>
                                <TableCell>{assoc.sort_order}</TableCell>
                                <TableCell className="font-medium">{assoc.name}</TableCell>
                                <TableCell>{assoc.equipment_ids.length}</TableCell>
                                <TableCell className="text-right">
                                    <Button variant="ghost" size="icon" onClick={() => handleEdit(assoc)}><Edit className="h-4 w-4" /></Button>
                                    <Button variant="ghost" size="icon" onClick={() => handleDelete(assoc.id)}><Trash2 className="h-4 w-4 text-red-500" /></Button>
                                </TableCell>
                            </TableRow>
                        ))}
                    </TableBody>
                </Table>
            ) : (
                <div className="text-center py-10 border-dashed border-2 rounded-lg">
                    <Tags className="mx-auto h-12 w-12 text-gray-300" />
                    <h3 className="mt-2 text-sm font-semibold text-gray-800">ĞÑÑĞ¾Ñ†Ğ¸Ğ°Ñ†Ğ¸Ğ¸ Ğ½Ğµ ÑĞ¾Ğ·Ğ´Ğ°Ğ½Ñ‹</h3>
                    <p className="mt-1 text-sm text-gray-500">ĞĞ°Ğ¶Ğ¼Ğ¸Ñ‚Ğµ "Ğ¡Ğ¾Ğ·Ğ´Ğ°Ñ‚ÑŒ", Ñ‡Ñ‚Ğ¾Ğ±Ñ‹ Ğ´Ğ¾Ğ±Ğ°Ğ²Ğ¸Ñ‚ÑŒ Ğ¿ĞµÑ€Ğ²ÑƒÑ.</p>
                </div>
            )}
            {/* âœ… Ğ¢ĞµĞ¿ĞµÑ€ÑŒ Ğ² Ğ´Ğ¸Ğ°Ğ»Ğ¾Ğ³ Ğ³Ğ°Ñ€Ğ°Ğ½Ñ‚Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ½Ğ¾ Ğ¿ĞµÑ€ĞµĞ´Ğ°ĞµÑ‚ÑÑ ĞŸĞĞ›ĞĞ«Ğ™ ÑĞ¿Ğ¸ÑĞ¾Ğº Ğ¾Ğ±Ğ¾Ñ€ÑƒĞ´Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ */}
            {isDialogOpen && <AssociationDialog open={isDialogOpen} onClose={() => setDialogOpen(false)} association={editingAssoc} allEquipment={equipmentOptions} />}
        </>
    );
}

```


## <a name="rentalappmainsrccomponentsadminConvertReservationDialogtsx"></a>`rental-app-main/src/components/admin/ConvertReservationDialog.tsx`

```tsx
// path: rental-app-main/src/components/admin/ConvertReservationDialog.tsx

// path: rental-app-main/src/components/admin/ConvertReservationDialog.tsx

import { useState, useEffect, useMemo } from "react";
import { Dialog, DialogContent, DialogHeader, DialogTitle, DialogFooter, DialogDescription } from "@/components/ui/dialog";
import { Button } from "@/components/ui/button";
import { Label } from "@/components/ui/label";
import { Input } from "@/components/ui/input";
import { Textarea } from "@/components/ui/textarea";
import { useConvertReservationToRental } from "@/hooks/useAdminRentals";
import type { AdminReservationOut } from "@/types/reservation";
import type { Equipment } from "@/types/equipment";
import ReservationFinancialSummary from "./ReservationFinancialSummary";
import { useAvailabilityCheck } from "@/hooks/useAvailabilityCheck";
// +++ 1. Ğ˜ĞœĞŸĞĞ Ğ¢Ğ˜Ğ Ğ£Ğ•Ğœ Ğ”Ğ˜ĞĞ›ĞĞ“ ĞŸĞĞ”Ğ¢Ğ’Ğ•Ğ Ğ–Ğ”Ğ•ĞĞ˜Ğ¯ Ğ˜ Ğ¢Ğ˜ĞŸ ĞĞ¨Ğ˜Ğ‘ĞšĞ˜ +++
import { ConfirmationDialog } from "@/components/ui/confirmation-dialog";
import type { AxiosError } from "axios";
// +++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++

interface Props {
    reservation: AdminReservationOut | null;
    open: boolean;
    onClose: () => void;
    equipmentMap: Map<number, Equipment>;
}

export default function ConvertReservationDialog({ reservation, open, onClose, equipmentMap }: Props) {
    const [notes, setNotes] = useState("");
    const [deposit, setDeposit] = useState("0");
    const [prepayment, setPrepayment] = useState("0");
    const convertMutation = useConvertReservationToRental();

    // +++ 2. Ğ”ĞĞ‘ĞĞ’Ğ›Ğ¯Ğ•Ğœ Ğ¡ĞĞ¡Ğ¢ĞĞ¯ĞĞ˜Ğ• Ğ”Ğ›Ğ¯ Ğ£ĞŸĞ ĞĞ’Ğ›Ğ•ĞĞ˜Ğ¯ ĞšĞĞĞ¤Ğ›Ğ˜ĞšĞ¢ĞĞœ Ğ’Ğ«Ğ¥ĞĞ”ĞĞĞ“Ğ Ğ”ĞĞ¯ +++
    const [holidayConflict, setHolidayConflict] = useState<string | null>(null);
    // +++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++

    const { newStartDate, newEndDate } = useMemo(() => {
        const today = new Date();
        today.setHours(0, 0, 0, 0);
        if (!reservation) return { newStartDate: today, newEndDate: today };
        const originalEndDate = new Date(reservation.end_date);
        
        // Ğ•ÑĞ»Ğ¸ Ğ´Ğ°Ñ‚Ğ° Ğ¾ĞºĞ¾Ğ½Ñ‡Ğ°Ğ½Ğ¸Ñ Ñ€ĞµĞ·ĞµÑ€Ğ²Ğ° ÑƒĞ¶Ğµ Ğ¿Ñ€Ğ¾ÑˆĞ»Ğ° Ğ¸Ğ»Ğ¸ Ğ½Ğ°ÑÑ‚ÑƒĞ¿Ğ°ĞµÑ‚ ÑĞµĞ³Ğ¾Ğ´Ğ½Ñ, 
        // ÑƒÑÑ‚Ğ°Ğ½Ğ°Ğ²Ğ»Ğ¸Ğ²Ğ°ĞµĞ¼ Ğ´Ğ°Ñ‚Ñƒ Ğ¾ĞºĞ¾Ğ½Ñ‡Ğ°Ğ½Ğ¸Ñ Ğ½Ğ° Ğ·Ğ°Ğ²Ñ‚Ñ€Ğ°
        const finalEndDate = originalEndDate <= today 
            ? new Date(today.getTime() + 24 * 60 * 60 * 1000) // Ğ·Ğ°Ğ²Ñ‚Ñ€Ğ°
            : originalEndDate;
            
        return { newStartDate: today, newEndDate: finalEndDate };
    }, [reservation]);

    const { hasConflicts, conflictingItemIds, isLoading: isCheckingAvailability } = useAvailabilityCheck({
        equipmentIds: reservation?.equipment_ids || [],
        startDate: newStartDate,
        endDate: newEndDate,
        excludeReservationId: reservation?.id,
    });

    useEffect(() => {
        if (!open) {
            setNotes("");
            setDeposit("0");
            setPrepayment("0");
            // +++ 3. Ğ¡Ğ‘Ğ ĞĞ¡Ğ«Ğ’ĞĞ•Ğœ Ğ¡ĞĞ¡Ğ¢ĞĞ¯ĞĞ˜Ğ• ĞšĞĞĞ¤Ğ›Ğ˜ĞšĞ¢Ğ ĞŸĞ Ğ˜ Ğ—ĞĞšĞ Ğ«Ğ¢Ğ˜Ğ˜ +++
            setHolidayConflict(null);
            // +++++++++++++++++++++++++++++++++++++++++++++++++++++++++
        }
    }, [open]);

    // +++ 4. ĞĞ‘ĞĞĞ’Ğ›Ğ¯Ğ•Ğœ Ğ›ĞĞ“Ğ˜ĞšĞ£ ĞĞ‘Ğ ĞĞ‘ĞĞ¢ĞšĞ˜ ĞĞ¢ĞŸĞ ĞĞ’ĞšĞ˜ Ğ¤ĞĞ ĞœĞ« +++
    const handleSubmit = async (force: boolean = false) => {
        if (!reservation) return;

        try {
            await convertMutation.mutateAsync({
                reservationId: reservation.id,
                data: {
                    notes_on_issue: notes,
                    deposit_amount: parseFloat(deposit) || 0,
                    prepayment_amount: parseFloat(prepayment) || 0,
                    force_issue_on_holiday: force, // ĞŸĞµÑ€ĞµĞ´Ğ°ĞµĞ¼ Ñ„Ğ»Ğ°Ğ³ `force`
                },
            });
            onClose();
        } catch (error) {
            // Ğ¢Ğ¸Ğ¿Ğ¸Ğ·Ğ¸Ñ€ÑƒĞµĞ¼ Ğ¾ÑˆĞ¸Ğ±ĞºÑƒ Ğ´Ğ»Ñ Ğ´Ğ¾ÑÑ‚ÑƒĞ¿Ğ° Ğº Ğ´ĞµÑ‚Ğ°Ğ»ÑĞ¼
            const axiosError = error as AxiosError<{ detail?: { error_type?: string; message?: string } }>;
            const detail = axiosError.response?.data?.detail;

            // ĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑĞµĞ¼, Ñ‡Ñ‚Ğ¾ ÑÑ‚Ğ¾ Ğ¸Ğ¼ĞµĞ½Ğ½Ğ¾ Ğ¾ÑˆĞ¸Ğ±ĞºĞ° ĞºĞ¾Ğ½Ñ„Ğ»Ğ¸ĞºÑ‚Ğ° Ğ²Ñ‹Ñ…Ğ¾Ğ´Ğ½Ğ¾Ğ³Ğ¾ Ğ´Ğ½Ñ
            if (axiosError.response?.status === 409 && detail?.error_type === "ISSUE_ON_HOLIDAY") {
                setHolidayConflict(detail.message || "ĞŸĞ¾Ğ´Ñ‚Ğ²ĞµÑ€Ğ´Ğ¸Ñ‚Ğµ Ğ´ĞµĞ¹ÑÑ‚Ğ²Ğ¸Ğµ.");
            } else {
                // Ğ”Ğ»Ñ Ğ´Ñ€ÑƒĞ³Ğ¸Ñ… Ğ¾ÑˆĞ¸Ğ±Ğ¾Ğº Ğ¿Ğ¾ĞºĞ°Ğ·Ñ‹Ğ²Ğ°ĞµĞ¼ Ğ¾Ğ±Ñ‰ĞµĞµ ÑĞ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ğµ
                console.error("ĞÑˆĞ¸Ğ±ĞºĞ° Ğ¿Ñ€Ğ¸ ĞºĞ¾Ğ½Ğ²ĞµÑ€Ñ‚Ğ°Ñ†Ğ¸Ğ¸ Ñ€ĞµĞ·ĞµÑ€Ğ²Ğ°:", error);
                // Ğ”Ñ€ÑƒĞ³Ğ¸Ğµ Ğ¾ÑˆĞ¸Ğ±ĞºĞ¸ Ğ±ÑƒĞ´ÑƒÑ‚ Ğ¾Ğ±Ñ€Ğ°Ğ±Ğ¾Ñ‚Ğ°Ğ½Ñ‹ Ğ² Ñ…ÑƒĞºĞµ useConvertReservationToRental
            }
        }
    };

    // +++ 5. Ğ”ĞĞ‘ĞĞ’Ğ›Ğ¯Ğ•Ğœ ĞĞ‘Ğ ĞĞ‘ĞĞ¢Ğ§Ğ˜Ğš Ğ”Ğ›Ğ¯ Ğ¤ĞĞ Ğ¡Ğ˜Ğ ĞĞ’ĞĞĞĞĞ™ ĞĞ¢ĞŸĞ ĞĞ’ĞšĞ˜ +++
    const handleForceSubmit = () => {
        setHolidayConflict(null); // Ğ—Ğ°ĞºÑ€Ñ‹Ğ²Ğ°ĞµĞ¼ Ğ´Ğ¸Ğ°Ğ»Ğ¾Ğ³ Ğ¿Ğ¾Ğ´Ñ‚Ğ²ĞµÑ€Ğ¶Ğ´ĞµĞ½Ğ¸Ñ
        void handleSubmit(true); // ĞŸĞ¾Ğ²Ñ‚Ğ¾Ñ€Ğ½Ğ¾ Ğ¾Ñ‚Ğ¿Ñ€Ğ°Ğ²Ğ»ÑĞµĞ¼ Ñ Ñ„Ğ»Ğ°Ğ³Ğ¾Ğ¼ force = true
    };
    // +++++++++++++++++++++++++++++++++++++++++++++++++++++++++++

    if (!reservation) return null;

    return (
        <>
            <Dialog open={open} onOpenChange={onClose}>
                <DialogContent className="sm:max-w-lg">
                    <DialogHeader>
                        <DialogTitle>Ğ’Ñ‹Ğ´Ğ°Ñ‡Ğ° Ğ°Ñ€ĞµĞ½Ğ´Ñ‹ Ğ¸Ğ· Ñ€ĞµĞ·ĞµÑ€Ğ²Ğ° #{reservation.id}</DialogTitle>
                        <DialogDescription>
                            Ğ”Ğ»Ñ ĞºĞ»Ğ¸ĞµĞ½Ñ‚Ğ°: <strong>{reservation.user_info.full_name}</strong>
                        </DialogDescription>
                    </DialogHeader>

                    <div className="space-y-4 py-2">
                        <ReservationFinancialSummary
                            reservation={reservation}
                            open={open}
                            hasConflicts={hasConflicts}
                            conflictingItemIds={conflictingItemIds}
                            isCheckingAvailability={isCheckingAvailability}
                            equipmentMap={equipmentMap}
                        />

                        <div>
                            <Label htmlFor="deposit_amount">Ğ¡ÑƒĞ¼Ğ¼Ğ° Ğ·Ğ°Ğ»Ğ¾Ğ³Ğ° (â‚½)</Label>
                            <Input id="deposit_amount" type="number" value={deposit} onChange={(e) => setDeposit(e.target.value)} placeholder="0" />
                        </div>
                        <div>
                            <Label htmlFor="prepayment_amount">ĞŸÑ€ĞµĞ´Ğ¾Ğ¿Ğ»Ğ°Ñ‚Ğ° (â‚½)</Label>
                            <Input id="prepayment_amount" type="number" value={prepayment} onChange={(e) => setPrepayment(e.target.value)} placeholder="0" />
                        </div>
                        <div>
                            <Label htmlFor="notes_on_issue">Ğ—Ğ°Ğ¼ĞµÑ‚ĞºĞ¸ Ğ¿Ñ€Ğ¸ Ğ²Ñ‹Ğ´Ğ°Ñ‡Ğµ</Label>
                            <Textarea id="notes_on_issue" value={notes} onChange={(e) => setNotes(e.target.value)} placeholder="ĞĞ°Ğ¿Ñ€Ğ¸Ğ¼ĞµÑ€: Ğ¼ĞµĞ»ĞºĞ°Ñ Ñ†Ğ°Ñ€Ğ°Ğ¿Ğ¸Ğ½Ğ° Ğ½Ğ° ĞºĞ¾Ñ€Ğ¿ÑƒÑĞµ..." />
                        </div>
                    </div>

                    <DialogFooter>
                        <Button variant="ghost" onClick={onClose}>ĞÑ‚Ğ¼ĞµĞ½Ğ°</Button>
                        <Button onClick={() => handleSubmit(false)} disabled={convertMutation.isPending || isCheckingAvailability || hasConflicts}>
                            {convertMutation.isPending ? "ĞĞ±Ñ€Ğ°Ğ±Ğ¾Ñ‚ĞºĞ°..." : "ĞŸĞ¾Ğ´Ñ‚Ğ²ĞµÑ€Ğ´Ğ¸Ñ‚ÑŒ Ğ¸ Ğ²Ñ‹Ğ´Ğ°Ñ‚ÑŒ"}
                        </Button>
                    </DialogFooter>
                </DialogContent>
            </Dialog>

            {/* +++ 6. Ğ”ĞĞ‘ĞĞ’Ğ›Ğ¯Ğ•Ğœ Ğ”Ğ˜ĞĞ›ĞĞ“ ĞŸĞĞ”Ğ¢Ğ’Ğ•Ğ Ğ–Ğ”Ğ•ĞĞ˜Ğ¯ +++ */}
            <ConfirmationDialog
                open={!!holidayConflict}
                onOpenChange={() => setHolidayConflict(null)}
                title="ĞŸĞ¾Ğ´Ñ‚Ğ²ĞµÑ€Ğ¶Ğ´ĞµĞ½Ğ¸Ğµ Ğ²Ñ‹Ğ´Ğ°Ñ‡Ğ¸"
                description={holidayConflict || ""}
                confirmText="Ğ”Ğ°, Ğ²Ñ‹Ğ´Ğ°Ñ‚ÑŒ"
                cancelText="ĞÑ‚Ğ¼ĞµĞ½Ğ°"
                onConfirm={handleForceSubmit}
                variant="destructive"
            />
            {/* +++++++++++++++++++++++++++++++++++++++ */}
        </>
    );
}

```


## <a name="rentalappmainsrccomponentsadminCreateReservationDialogtsx"></a>`rental-app-main/src/components/admin/CreateReservationDialog.tsx`

```tsx
// path: rental-app-main/src/components/admin/CreateReservationDialog.tsx

// src/components/admin/CreateReservationDialog.tsx
import { Dialog, DialogContent, DialogHeader, DialogTitle, DialogFooter, DialogDescription } from "@/components/ui/dialog";
import { Button } from "@/components/ui/button";
import { ArrowRight, ArrowLeft } from "lucide-react";
import { useCreateReservationDialog } from "@/hooks/admin/create-reservation/useCreateReservationDialog";
import { CreateReservationStep1Details } from "./CreateReservationStep1Details";
import { CreateReservationStep2Accessories } from "./CreateReservationStep2Accessories";
import FinancialSummaryBlock from "@/components/shared/FinancialSummaryBlock";

interface Props {
    isOpen: boolean;
    onClose: () => void;
}

export default function CreateReservationDialog({ isOpen, onClose }: Props) {
    const {
        step, setStep, form, users, isLoadingUsers, clientPopoverOpen,
        setClientPopoverOpen, equipmentSearch, setEquipmentSearch,
        isLoadingEquipment, filteredAndGroupedEquipment, availabilityMap,
        equipmentWithAccessories, isLoadingAvailability, hasConflictsInSelection,
        isSubmitting, handleNextStep, onSubmit, handleCloseDialog,
        financialData // âœ… 2. ĞŸĞ¾Ğ»ÑƒÑ‡Ğ°ĞµĞ¼ ĞµĞ´Ğ¸Ğ½Ñ‹Ğ¹ Ğ¾Ğ±ÑŠĞµĞºÑ‚ Ñ Ñ„Ğ¸Ğ½Ğ°Ğ½ÑĞ¾Ğ²Ñ‹Ğ¼Ğ¸ Ğ´Ğ°Ğ½Ğ½Ñ‹Ğ¼Ğ¸
    } = useCreateReservationDialog({ isOpen, onClose });

    const { formState: { isValid } } = form;

    const formId = "create-reservation-admin-form";

    return (
        <Dialog open={isOpen} onOpenChange={onClose}>
            <DialogContent className="sm:max-w-[700px] h-[90vh] flex flex-col p-0">
                <DialogHeader className="p-6 pb-4">
                    <DialogTitle>Ğ¡Ğ¾Ğ·Ğ´Ğ°Ñ‚ÑŒ Ğ½Ğ¾Ğ²Ñ‹Ğ¹ Ñ€ĞµĞ·ĞµÑ€Ğ² (Ğ¨Ğ°Ğ³ {step === 'details' ? 1 : 2} Ğ¸Ğ· 2)</DialogTitle>
                    <DialogDescription>
                        {step === 'details'
                            ? "Ğ’Ñ‹Ğ±ĞµÑ€Ğ¸Ñ‚Ğµ ĞºĞ»Ğ¸ĞµĞ½Ñ‚Ğ°, Ğ´Ğ°Ñ‚Ñ‹ Ğ¸ Ğ¾Ğ±Ğ¾Ñ€ÑƒĞ´Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ Ğ´Ğ»Ñ ÑĞ¾Ğ·Ğ´Ğ°Ğ½Ğ¸Ñ."
                            : "Ğ’Ñ‹Ğ±ĞµÑ€Ğ¸Ñ‚Ğµ Ğ´Ğ¾Ğ¿Ğ¾Ğ»Ğ½Ğ¸Ñ‚ĞµĞ»ÑŒĞ½Ñ‹Ğµ Ğ°ĞºÑĞµÑÑÑƒĞ°Ñ€Ñ‹ Ğ´Ğ»Ñ Ğ¿Ğ¾Ğ·Ğ¸Ñ†Ğ¸Ğ¹ Ğ² Ñ€ĞµĞ·ĞµÑ€Ğ²Ğµ."
                        }
                    </DialogDescription>
                </DialogHeader>

                <div className="flex-1 overflow-y-auto px-6">
                    <form id={formId} onSubmit={onSubmit} className="contents">
                        {step === 'details' ? (
                            <CreateReservationStep1Details
                                form={form}
                                users={users}
                                isLoadingUsers={isLoadingUsers}
                                clientPopoverOpen={clientPopoverOpen}
                                setClientPopoverOpen={setClientPopoverOpen}
                                equipmentSearch={equipmentSearch}
                                setEquipmentSearch={setEquipmentSearch}
                                isLoadingEquipment={isLoadingEquipment}
                                filteredAndGroupedEquipment={filteredAndGroupedEquipment}
                                availabilityMap={availabilityMap}
                            />
                        ) : (
                            <CreateReservationStep2Accessories
                                form={form}
                                equipmentWithAccessories={equipmentWithAccessories}
                            />
                        )}
                    </form>
                </div>

                <DialogFooter className="p-6 pt-4 border-t items-center">
                    {step === 'details' ? (
                        <>
                            {/* Ğ˜ÑĞ¿Ğ¾Ğ»ÑŒĞ·ÑƒĞµĞ¼ ÑƒĞ½Ğ¸Ğ²ĞµÑ€ÑĞ°Ğ»ÑŒĞ½Ñ‹Ğ¹ ĞºĞ¾Ğ¼Ğ¿Ğ¾Ğ½ĞµĞ½Ñ‚ Ğ´Ğ»Ñ Ğ¾Ñ‚Ğ¾Ğ±Ñ€Ğ°Ğ¶ĞµĞ½Ğ¸Ñ ÑĞ²Ğ¾Ğ´ĞºĞ¸ */}
                            <FinancialSummaryBlock
                                priceDetails={financialData.priceDetails}
                                promoCode={financialData.promoCode}
                                setPromoCode={financialData.setPromoCode}
                                applyPromoCode={financialData.applyPromoCode}
                                promoCodeMessage={financialData.promoCodeMessage}
                                isLoading={isLoadingAvailability}
                                isApplyingPromoCode={financialData.isApplyingPromoCode}
                                isSubmitting={isSubmitting}
                                hasConflicts={hasConflictsInSelection}
                                variant="admin"
                                showActions={false}
                            />
                            <Button type="button" variant="ghost" onClick={handleCloseDialog}>ĞÑ‚Ğ¼ĞµĞ½Ğ°</Button>
                            <Button type="button" onClick={handleNextStep} disabled={!isValid || isSubmitting || hasConflictsInSelection || isLoadingAvailability}>
                                {equipmentWithAccessories.length > 0 ? "Ğ”Ğ°Ğ»ĞµĞµ" : "Ğ¡Ğ¾Ğ·Ğ´Ğ°Ñ‚ÑŒ Ñ€ĞµĞ·ĞµÑ€Ğ²"}
                                {equipmentWithAccessories.length > 0 && <ArrowRight className="ml-2 h-4 w-4" />}
                            </Button>
                        </>
                    ) : (
                        <>
                            <Button type="button" variant="ghost" onClick={() => setStep('details')} className="mr-auto">
                                <ArrowLeft className="mr-2 h-4 w-4" /> ĞĞ°Ğ·Ğ°Ğ´
                            </Button>
                            <Button type="button" variant="ghost" onClick={handleCloseDialog}>ĞÑ‚Ğ¼ĞµĞ½Ğ°</Button>
                            <Button type="submit" form={formId} disabled={isSubmitting}>
                                {isSubmitting ? "Ğ¡Ğ¾Ğ·Ğ´Ğ°Ğ½Ğ¸Ğµ..." : "Ğ¡Ğ¾Ğ·Ğ´Ğ°Ñ‚ÑŒ Ñ€ĞµĞ·ĞµÑ€Ğ²"}
                            </Button>
                        </>
                    )}
                </DialogFooter>
            </DialogContent>
        </Dialog>
    );
}

```


## <a name="rentalappmainsrccomponentsadminCreateReservationStep1Detailstsx"></a>`rental-app-main/src/components/admin/CreateReservationStep1Details.tsx`

```tsx
// path: rental-app-main/src/components/admin/CreateReservationStep1Details.tsx

// src/components/admin/CreateReservationStep1Details.tsx
import { useState } from "react";
import { Controller, UseFormReturn } from "react-hook-form";
import { Input } from "@/components/ui/input";
import { Label } from "@/components/ui/label";
import { Popover, PopoverContent, PopoverTrigger } from "@/components/ui/popover";
// âœ… Ğ˜Ğ¡ĞŸĞ ĞĞ’Ğ›Ğ•ĞĞ˜Ğ•: Ğ”Ğ¾Ğ±Ğ°Ğ²Ğ»ÑĞµĞ¼ CommandInput Ğ² Ğ¸Ğ¼Ğ¿Ğ¾Ñ€Ñ‚
import { Command, CommandEmpty, CommandGroup, CommandInput, CommandItem, CommandList } from "@/components/ui/command";
import { Button } from "@/components/ui/button";
import { Checkbox } from "@/components/ui/checkbox";
import { Check, ChevronsUpDown, Search, ChevronRight } from "lucide-react";
import type { CreateReservationFormData } from "@/hooks/admin/create-reservation/useCreateReservationForm";
import type { UserOut } from "@/types/user";
import type { Equipment } from "@/types/equipment";
import type { AvailabilityInfo } from "@/types/availability";

const EquipmentNode = ({ item, isChecked, onCheckedChange, availability }: {
    item: Equipment;
    isChecked: boolean;
    onCheckedChange: (checked: boolean) => void;
    availability?: AvailabilityInfo;
}) => {
    const hasConflict = !!availability && availability.status !== 'available';
    const conflictColorClass = availability?.status === 'rented' ? 'bg-red-100' : 'bg-amber-100';
    const hoverClass = hasConflict ? '' : 'hover:bg-gray-50';

    return (
        <div className={`p-2 rounded-md transition-colors ${hasConflict ? conflictColorClass : ''} ${hoverClass}`}>
            <div className="flex items-center justify-between">
                <div className="flex items-center gap-3 flex-1">
                    <Checkbox id={`eq-${item.id}`} checked={isChecked} onCheckedChange={onCheckedChange} />
                    <Label htmlFor={`eq-${item.id}`} className="font-normal w-full cursor-pointer text-sm">{item.brand} {item.name}</Label>
                </div>
                {hasConflict && <span className="text-xs font-medium">{availability?.status === 'rented' ? 'ĞÑ€ĞµĞ½Ğ´Ğ°' : 'Ğ ĞµĞ·ĞµÑ€Ğ²'}</span>}
            </div>
            {hasConflict && availability?.details && <div className="text-xs text-gray-600 mt-1 pl-8">- {availability.details}</div>}
        </div>
    );
};

interface Props {
    form: UseFormReturn<CreateReservationFormData>;
    users?: UserOut[];
    isLoadingUsers: boolean;
    clientPopoverOpen: boolean;
    setClientPopoverOpen: (isOpen: boolean) => void;
    equipmentSearch: string;
    setEquipmentSearch: (query: string) => void;
    isLoadingEquipment: boolean;
    filteredAndGroupedEquipment: { tree: Record<string, Record<string, Equipment[]>>, visibleIds: number[] };
    availabilityMap: Record<number, AvailabilityInfo>;
}

export const CreateReservationStep1Details = ({
                                                  form, users, isLoadingUsers, clientPopoverOpen, setClientPopoverOpen,
                                                  equipmentSearch, setEquipmentSearch, isLoadingEquipment,
                                                  filteredAndGroupedEquipment, availabilityMap
                                              }: Props) => {
    const { register, control, formState: { errors } } = form;
    const [collapsedSections, setCollapsedSections] = useState<Record<string, boolean>>({});

    const toggleSection = (key: string) => {
        setCollapsedSections(prev => ({ ...prev, [key]: !prev[key] }));
    };

    return (
        <div className="space-y-4">
            <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                    <Label>ĞŸĞ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ÑŒ *</Label>
                    <Controller
                        control={control}
                        name="user_id"
                        render={({ field }) => (
                            <Popover open={clientPopoverOpen} onOpenChange={setClientPopoverOpen}>
                                <PopoverTrigger asChild>
                                    <Button variant="outline" role="combobox" className="w-full justify-between" disabled={isLoadingUsers}>
                                        {field.value ? users?.find(u => u.id === field.value)?.full_name : "Ğ’Ñ‹Ğ±ĞµÑ€Ğ¸Ñ‚Ğµ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ñ..."}
                                        <ChevronsUpDown className="ml-2 h-4 w-4 shrink-0 opacity-50" />
                                    </Button>
                                </PopoverTrigger>
                                <PopoverContent className="w-[--radix-popover-trigger-width] p-0">
                                    <Command>
                                        <CommandInput placeholder="ĞŸĞ¾Ğ¸ÑĞº Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ñ..." />
                                        <CommandList><CommandEmpty>ĞŸĞ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ğ¸ Ğ½Ğµ Ğ½Ğ°Ğ¹Ğ´ĞµĞ½Ñ‹.</CommandEmpty>
                                            <CommandGroup>
                                                {users?.map((user) => (
                                                    <CommandItem key={user.id} value={`${user.full_name} ${user.email}`} onSelect={() => { form.setValue("user_id", user.id, { shouldValidate: true }); setClientPopoverOpen(false); }}>
                                                        <Check className={`mr-2 h-4 w-4 ${field.value === user.id ? "opacity-100" : "opacity-0"}`} />
                                                        {user.full_name}
                                                    </CommandItem>
                                                ))}
                                            </CommandGroup>
                                        </CommandList>
                                    </Command>
                                </PopoverContent>
                            </Popover>
                        )}
                    />
                    {errors.user_id && <p className="text-xs text-red-600 mt-1">{errors.user_id.message}</p>}
                </div>
                <div className="grid grid-cols-2 gap-2">
                    <div><Label htmlFor="start_date">ĞĞ°Ñ‡Ğ°Ğ»Ğ¾ *</Label><Input id="start_date" type="date" {...register("start_date")} />{errors.start_date && <p className="text-xs text-red-600 mt-1">{errors.start_date.message}</p>}</div>
                    <div><Label htmlFor="end_date">ĞĞºĞ¾Ğ½Ñ‡Ğ°Ğ½Ğ¸Ğµ *</Label><Input id="end_date" type="date" {...register("end_date")} />{errors.end_date && <p className="text-xs text-red-600 mt-1">{errors.end_date.message}</p>}</div>
                </div>
            </div>

            <div className="space-y-2">
                <Label>ĞĞ±Ğ¾Ñ€ÑƒĞ´Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ *</Label>
                <div className="relative"><Search className="absolute left-3 top-2.5 h-4 w-4 text-muted-foreground" /><Input placeholder="ĞŸĞ¾Ğ¸ÑĞº..." value={equipmentSearch} onChange={(e) => setEquipmentSearch(e.target.value)} className="pl-10" /></div>
                <div className="rounded-md border p-2">
                    {isLoadingEquipment ? <p className="text-center py-4">Ğ—Ğ°Ğ³Ñ€ÑƒĞ·ĞºĞ°...</p> : (
                        <Controller name="equipment_ids" control={control}
                                    render={({ field }) => (
                                        <div className="space-y-3">
                                            {Object.keys(filteredAndGroupedEquipment.tree).map(type => {
                                                const isTypeCollapsed = collapsedSections[type];
                                                return (
                                                    <div key={type}>
                                                        <button type="button" onClick={() => toggleSection(type)} className="w-full flex items-center gap-1 font-semibold text-md sticky top-0 bg-white/80 backdrop-blur-sm py-1 cursor-pointer z-10">
                                                            <ChevronRight className={`w-4 h-4 transition-transform ${!isTypeCollapsed ? 'rotate-90' : ''}`} />
                                                            {type}
                                                        </button>
                                                        {!isTypeCollapsed && Object.keys(filteredAndGroupedEquipment.tree[type]).map(brand => {
                                                            const brandKey = `${type}-${brand}`;
                                                            const isBrandCollapsed = collapsedSections[brandKey];
                                                            return (
                                                                <div key={brandKey} className="pl-4">
                                                                    <button type="button" onClick={() => toggleSection(brandKey)} className="w-full flex items-center gap-1 font-medium text-sm text-gray-600 hover:text-black">
                                                                        <ChevronRight className={`w-4 h-4 transition-transform ${!isBrandCollapsed ? 'rotate-90' : ''}`} />
                                                                        {brand}
                                                                    </button>
                                                                    {!isBrandCollapsed && (
                                                                        <div className="space-y-1 pl-4 border-l ml-2 py-1">
                                                                            {filteredAndGroupedEquipment.tree[type][brand].map(item => (
                                                                                <EquipmentNode key={item.id} item={item} availability={availabilityMap[item.id]}
                                                                                               isChecked={field.value?.includes(item.id)}
                                                                                               onCheckedChange={(checked) => field.onChange(checked ? [...field.value, item.id] : field.value.filter(id => id !== item.id))} />
                                                                            ))}
                                                                        </div>
                                                                    )}
                                                                </div>
                                                            )})}
                                                    </div>
                                                )})}
                                        </div>
                                    )}
                        />
                    )}
                </div>
                {errors.equipment_ids && <p className="text-xs text-red-600 mt-1">{errors.equipment_ids.message}</p>}
            </div>
        </div>
    );
};

```


## <a name="rentalappmainsrccomponentsadminCreateReservationStep2Accessoriestsx"></a>`rental-app-main/src/components/admin/CreateReservationStep2Accessories.tsx`

```tsx
// path: rental-app-main/src/components/admin/CreateReservationStep2Accessories.tsx

// src/components/admin/CreateReservationStep2Accessories.tsx
import { Controller, UseFormReturn } from "react-hook-form";
import { Card, CardContent, CardHeader, CardTitle } from "@/components/ui/card";
import { Checkbox } from "@/components/ui/checkbox";
import { Label } from "@/components/ui/label";
import { ScrollArea } from "@/components/ui/scroll-area";
import { Paperclip } from "lucide-react";
import type { CreateReservationFormData } from "@/hooks/admin/create-reservation/useCreateReservationForm";
import type { Equipment } from "@/types/equipment";

interface Props {
    form: UseFormReturn<CreateReservationFormData>;
    equipmentWithAccessories: Equipment[];
}

export const CreateReservationStep2Accessories = ({ form, equipmentWithAccessories }: Props) => {
    const { control } = form;

    return (
        <div className="space-y-4 overflow-hidden flex flex-col flex-1">
            <ScrollArea className="flex-1 -mx-6 px-6">
                <div className="space-y-4 pb-4">
                    {equipmentWithAccessories.map(equipmentItem => (
                        <Card key={equipmentItem.id}>
                            <CardHeader className="pb-2">
                                <CardTitle className="text-base flex items-center gap-2">
                                    <Paperclip className="h-4 w-4" />
                                    {equipmentItem.name}
                                </CardTitle>
                            </CardHeader>
                            <CardContent>
                                <Controller
                                    name={`selected_accessories.${equipmentItem.id}`}
                                    control={control}
                                    render={({ field }) => (
                                        <div className="space-y-2">
                                            {equipmentItem.accessories.map(acc => (
                                                <div key={acc.id} className="flex items-center justify-between hover:bg-slate-50 p-2 rounded">
                                                    <Label htmlFor={`acc-${equipmentItem.id}-${acc.id}`} className="flex items-center gap-2 font-normal cursor-pointer">
                                                        <Checkbox id={`acc-${equipmentItem.id}-${acc.id}`}
                                                                  checked={field.value?.includes(acc.id)}
                                                                  onCheckedChange={(checked) => {
                                                                      const currentIds = field.value || [];
                                                                      const newIds = checked ? [...currentIds, acc.id] : currentIds.filter(id => id !== acc.id);
                                                                      field.onChange(newIds);
                                                                  }}
                                                        />
                                                        {acc.name}
                                                    </Label>
                                                    <span className="text-xs text-muted-foreground">{acc.price} â‚½</span>
                                                </div>
                                            ))}
                                        </div>
                                    )}
                                />
                            </CardContent>
                        </Card>
                    ))}
                </div>
            </ScrollArea>
        </div>
    );
};

```


## <a name="rentalappmainsrccomponentsadminDurationDiscountManagertsx"></a>`rental-app-main/src/components/admin/DurationDiscountManager.tsx`

```tsx
// path: rental-app-main/src/components/admin/DurationDiscountManager.tsx

// src/components/admin/DurationDiscountManager.tsx

import { useState, useMemo } from 'react';
import { useDurationDiscounts, useCreateDurationDiscount, useDeleteDurationDiscount } from '@/hooks/useAdminDiscounts';
// +++ ĞĞĞ§ĞĞ›Ğ Ğ˜Ğ—ĞœĞ•ĞĞ•ĞĞ˜Ğ™: Ğ˜ÑĞ¿Ñ€Ğ°Ğ²Ğ»ÑĞµĞ¼ Ğ¸Ğ¼Ğ¿Ğ¾Ñ€Ñ‚ Ñ‚Ğ¸Ğ¿Ğ¾Ğ² +++
import type { DiscountPayload, DurationDiscount } from '@/types/discount';
// +++ ĞšĞĞĞ•Ğ¦ Ğ˜Ğ—ĞœĞ•ĞĞ•ĞĞ˜Ğ™ +++
import { Button } from '@/components/ui/button';
import { Input } from '@/components/ui/input';
import { Table, TableBody, TableCell, TableHead, TableHeader, TableRow } from '@/components/ui/table';
import { PlusCircle, Trash2, Loader2, ChevronLeft, ChevronRight } from 'lucide-react';
import { Alert, AlertDescription, AlertTitle } from "@/components/ui/alert";

const PAGE_SIZE = 10;

export default function DurationDiscountManager() {
    const [currentPage, setCurrentPage] = useState(1);
    const { data: discountResponse, isLoading, isError } = useDurationDiscounts(currentPage, PAGE_SIZE);

    const discounts = useMemo(() => discountResponse?.items ?? [], [discountResponse]);
    const totalDiscounts = useMemo(() => discountResponse?.total ?? 0, [discountResponse]);
    const totalPages = Math.ceil(totalDiscounts / PAGE_SIZE);

    const createMutation = useCreateDurationDiscount();
    const deleteMutation = useDeleteDurationDiscount();

    const [newItem, setNewItem] = useState<DiscountPayload>({ min_days: 0, discount_percentage: 0 });

    const handleCreate = () => {
        if (!newItem.min_days || newItem.min_days <= 0) {
            alert("ĞšĞ¾Ğ»Ğ¸Ñ‡ĞµÑÑ‚Ğ²Ğ¾ Ğ´Ğ½ĞµĞ¹ Ğ´Ğ¾Ğ»Ğ¶Ğ½Ğ¾ Ğ±Ñ‹Ñ‚ÑŒ Ğ±Ğ¾Ğ»ÑŒÑˆĞµ 0.");
            return;
        }
        if (!newItem.discount_percentage || newItem.discount_percentage <= 0) {
            alert("ĞŸÑ€Ğ¾Ñ†ĞµĞ½Ñ‚ ÑĞºĞ¸Ğ´ĞºĞ¸ Ğ´Ğ¾Ğ»Ğ¶ĞµĞ½ Ğ±Ñ‹Ñ‚ÑŒ Ğ±Ğ¾Ğ»ÑŒÑˆĞµ 0.");
            return;
        }
        createMutation.mutate(newItem, {
            onSuccess: () => setNewItem({ min_days: 0, discount_percentage: 0 })
        });
    };

    if (isLoading) {
        return <div className="flex items-center gap-2 text-gray-500"><Loader2 className="h-4 w-4 animate-spin"/>Ğ—Ğ°Ğ³Ñ€ÑƒĞ·ĞºĞ° Ğ´Ğ°Ğ½Ğ½Ñ‹Ñ… Ğ¾ ÑĞºĞ¸Ğ´ĞºĞ°Ñ…...</div>;
    }

    if (isError) {
        return <Alert variant="destructive"><AlertTitle>ĞÑˆĞ¸Ğ±ĞºĞ°!</AlertTitle><AlertDescription>ĞĞµ ÑƒĞ´Ğ°Ğ»Ğ¾ÑÑŒ Ğ·Ğ°Ğ³Ñ€ÑƒĞ·Ğ¸Ñ‚ÑŒ Ğ´Ğ°Ğ½Ğ½Ñ‹Ğµ Ğ¾ ÑĞºĞ¸Ğ´ĞºĞ°Ñ….</AlertDescription></Alert>;
    }

    return (
        <div className="space-y-4">
            <div className="border rounded-md">
                <Table>
                    <TableHeader>
                        <TableRow>
                            <TableHead className="w-[40%]">ĞœĞ¸Ğ½Ğ¸Ğ¼Ğ°Ğ»ÑŒĞ½Ğ¾Ğµ ĞºĞ¾Ğ»Ğ¸Ñ‡ĞµÑÑ‚Ğ²Ğ¾ Ğ´Ğ½ĞµĞ¹</TableHead>
                            <TableHead className="w-[40%]">ĞŸÑ€Ğ¾Ñ†ĞµĞ½Ñ‚ ÑĞºĞ¸Ğ´ĞºĞ¸ (%)</TableHead>
                            <TableHead className="text-right">Ğ”ĞµĞ¹ÑÑ‚Ğ²Ğ¸Ñ</TableHead>
                        </TableRow>
                    </TableHeader>
                    <TableBody>
                        {discounts.map((d: DurationDiscount) => (
                            <TableRow key={d.id}>
                                <TableCell>{d.min_days}</TableCell>
                                <TableCell>{d.discount_percentage}%</TableCell>
                                <TableCell className="text-right">
                                    <Button variant="ghost" size="icon" onClick={() => deleteMutation.mutate(d.id)} disabled={deleteMutation.isPending}>
                                        <Trash2 className="h-4 w-4 text-red-500" />
                                    </Button>
                                </TableCell>
                            </TableRow>
                        ))}
                        <TableRow>
                            <TableCell>
                                <Input type="number" placeholder="ĞĞ°Ğ¿Ñ€. 7" value={newItem.min_days || ''} onChange={e => setNewItem((p: DiscountPayload) => ({...p, min_days: parseInt(e.target.value, 10) || 0}))} />
                            </TableCell>
                            <TableCell>
                                <Input type="number" placeholder="ĞĞ°Ğ¿Ñ€. 15" value={newItem.discount_percentage || ''} onChange={e => setNewItem((p: DiscountPayload) => ({...p, discount_percentage: parseInt(e.target.value, 10) || 0}))} />
                            </TableCell>
                            <TableCell className="text-right">
                                <Button size="sm" onClick={handleCreate} disabled={createMutation.isPending}>
                                    {createMutation.isPending ? <Loader2 className="mr-2 h-4 w-4 animate-spin"/> : <PlusCircle className="mr-2 h-4 w-4" />}
                                    Ğ”Ğ¾Ğ±Ğ°Ğ²Ğ¸Ñ‚ÑŒ
                                </Button>
                            </TableCell>
                        </TableRow>
                    </TableBody>
                </Table>
            </div>

            <div className="flex items-center justify-end space-x-2 pt-2">
                <span className="text-sm text-muted-foreground">
                    Ğ¡Ñ‚Ñ€Ğ°Ğ½Ğ¸Ñ†Ğ° {currentPage} Ğ¸Ğ· {totalPages > 0 ? totalPages : 1}
                </span>
                <Button
                    variant="outline"
                    size="sm"
                    onClick={() => setCurrentPage(prev => Math.max(prev - 1, 1))}
                    disabled={currentPage === 1}
                >
                    <ChevronLeft className="h-4 w-4 mr-1" />
                    ĞĞ°Ğ·Ğ°Ğ´
                </Button>
                <Button
                    variant="outline"
                    size="sm"
                    onClick={() => setCurrentPage(prev => Math.min(prev + 1, totalPages))}
                    disabled={currentPage >= totalPages}
                >
                    Ğ’Ğ¿ĞµÑ€ĞµĞ´
                    <ChevronRight className="h-4 w-4 ml-1" />
                </Button>
            </div>

            <p className="text-sm text-gray-600 pt-2">
                <strong>ĞšĞ°Ğº ÑÑ‚Ğ¾ Ñ€Ğ°Ğ±Ğ¾Ñ‚Ğ°ĞµÑ‚:</strong> Ğ¡Ğ¸ÑÑ‚ĞµĞ¼Ğ° Ğ°Ğ²Ñ‚Ğ¾Ğ¼Ğ°Ñ‚Ğ¸Ñ‡ĞµÑĞºĞ¸ Ğ¿Ñ€Ğ¸Ğ¼ĞµĞ½Ğ¸Ñ‚ ÑĞºĞ¸Ğ´ĞºÑƒ Ñ Ğ½Ğ°Ğ¸Ğ±Ğ¾Ğ»ÑŒÑˆĞ¸Ğ¼ Ğ¿Ğ¾Ñ€Ğ¾Ğ³Ğ¾Ğ¼ Ğ´Ğ½ĞµĞ¹, ĞºĞ¾Ñ‚Ğ¾Ñ€Ñ‹Ğ¹ Ğ½Ğµ Ğ¿Ñ€ĞµĞ²Ñ‹ÑˆĞ°ĞµÑ‚ Ğ¾Ğ±Ñ‰ĞµĞµ ĞºĞ¾Ğ»Ğ¸Ñ‡ĞµÑÑ‚Ğ²Ğ¾ Ğ´Ğ½ĞµĞ¹ Ğ°Ñ€ĞµĞ½Ğ´Ñ‹.
                <br />
                <em>ĞĞ°Ğ¿Ñ€Ğ¸Ğ¼ĞµÑ€, ĞµÑĞ»Ğ¸ ĞµÑÑ‚ÑŒ ÑĞºĞ¸Ğ´ĞºĞ¸ Ğ´Ğ»Ñ 3 Ğ¸ 7 Ğ´Ğ½ĞµĞ¹, Ğ° Ğ°Ñ€ĞµĞ½Ğ´Ğ° Ğ½Ğ° 8 Ğ´Ğ½ĞµĞ¹, Ğ±ÑƒĞ´ĞµÑ‚ Ğ¿Ñ€Ğ¸Ğ¼ĞµĞ½ĞµĞ½Ğ° ÑĞºĞ¸Ğ´ĞºĞ° Ğ´Ğ»Ñ 7 Ğ´Ğ½ĞµĞ¹.</em>
            </p>
        </div>
    );
}

```


## <a name="rentalappmainsrccomponentsadminEditableRentalCardtsx"></a>`rental-app-main/src/components/admin/EditableRentalCard.tsx`

```tsx
// path: rental-app-main/src/components/admin/EditableRentalCard.tsx

// components/admin/EditableRentalCard.tsx (ĞĞĞ’Ğ«Ğ™ Ğ¤ĞĞ™Ğ›)

import { Card, CardContent } from "@/components/ui/card";
import { Button } from "@/components/ui/button";
import { Input } from "@/components/ui/input";
import { Label } from "@/components/ui/label";
import { Textarea } from "@/components/ui/textarea";
import { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from "@/components/ui/select";
import { Save, X, Loader2 } from "lucide-react";
import { useAdminRentalEdit } from "@/hooks/admin/useAdminRentalEdit";
import type { AdminRentalOut } from "@/types/reservation";

interface Props {
    rental: AdminRentalOut;
    onCancel: () => void;
}

export default function EditableRentalCard({ rental, onCancel }: Props) {
    const { register, handleSubmit, errors, isValid, isDirty, isSaving } = useAdminRentalEdit({
        rental,
        onSuccess: onCancel, // Ğ—Ğ°ĞºÑ€Ñ‹Ğ²Ğ°ĞµĞ¼ Ñ„Ğ¾Ñ€Ğ¼Ñƒ Ğ¿Ñ€Ğ¸ ÑƒÑĞ¿ĞµÑ…Ğµ
    });

    const statusOptions = [
        { value: "active", label: "ĞĞºÑ‚Ğ¸Ğ²Ğ½Ğ°" },
        { value: "overdue", label: "ĞŸÑ€Ğ¾ÑÑ€Ğ¾Ñ‡ĞµĞ½Ğ°" },
        { value: "completed", label: "Ğ—Ğ°Ğ²ĞµÑ€ÑˆĞµĞ½Ğ°" },
    ];

    return (
        <Card className="w-full transition-shadow border-2 border-dashed border-sky-400 bg-sky-50/50">
            <form onSubmit={handleSubmit}>
                <CardContent className="p-4 space-y-4">
                    <h3 className="font-semibold text-lg text-sky-800">Ğ ĞµĞ´Ğ°ĞºÑ‚Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ Ğ°Ñ€ĞµĞ½Ğ´Ñ‹ #{rental.id}</h3>
                    <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                        {/* Ğ”Ğ°Ñ‚Ñ‹ */}
                        <div className="space-y-2">
                            <Label htmlFor="end_date">Ğ”Ğ°Ñ‚Ğ° Ğ²Ğ¾Ğ·Ğ²Ñ€Ğ°Ñ‚Ğ° (Ğ¿Ğ»Ğ°Ğ½)</Label>
                            <Input id="end_date" type="date" {...register("end_date")} />
                            {errors.end_date && <p className="text-xs text-red-600 mt-1">{errors.end_date.message}</p>}
                        </div>
                        <div className="space-y-2">
                            <Label htmlFor="actual_return_date">Ğ”Ğ°Ñ‚Ğ° Ğ²Ğ¾Ğ·Ğ²Ñ€Ğ°Ñ‚Ğ° (Ñ„Ğ°ĞºÑ‚)</Label>
                            <Input id="actual_return_date" type="date" {...register("actual_return_date")} />
                            {errors.actual_return_date && <p className="text-xs text-red-600 mt-1">{errors.actual_return_date.message}</p>}
                        </div>

                        {/* Ğ¡Ñ‚Ğ°Ñ‚ÑƒÑ Ğ¸ Ğ¤Ğ¸Ğ½Ğ°Ğ½ÑÑ‹ */}
                        <div className="space-y-2">
                            <Label htmlFor="status">Ğ¡Ñ‚Ğ°Ñ‚ÑƒÑ</Label>
                            <select id="status" {...register("status")} className="w-full p-2 border rounded-md">
                                {statusOptions.map(opt => <option key={opt.value} value={opt.value}>{opt.label}</option>)}
                            </select>
                        </div>
                        <div className="space-y-2">
                            <Label htmlFor="deposit_amount">Ğ—Ğ°Ğ»Ğ¾Ğ³ (â‚½)</Label>
                            <Input id="deposit_amount" type="number" {...register("deposit_amount")} />
                        </div>
                        <div className="space-y-2">
                            <Label htmlFor="final_cost">Ğ˜Ñ‚Ğ¾Ğ³Ğ¾Ğ²Ğ°Ñ ÑÑ‚Ğ¾Ğ¸Ğ¼Ğ¾ÑÑ‚ÑŒ (â‚½)</Label>
                            <Input id="final_cost" type="number" {...register("final_cost")} placeholder="ĞÑÑ‚Ğ°Ğ²ÑŒÑ‚Ğµ Ğ¿ÑƒÑÑ‚Ñ‹Ğ¼ Ğ´Ğ»Ñ Ğ°Ğ²Ñ‚Ğ¾Ñ€Ğ°ÑÑ‡ĞµÑ‚Ğ°" />
                        </div>
                    </div>

                    {/* Ğ—Ğ°Ğ¼ĞµÑ‚ĞºĞ¸ */}
                    <div className="space-y-2">
                        <Label htmlFor="notes_on_issue">Ğ—Ğ°Ğ¼ĞµÑ‚ĞºĞ¸ Ğ¿Ñ€Ğ¸ Ğ²Ñ‹Ğ´Ğ°Ñ‡Ğµ</Label>
                        <Textarea id="notes_on_issue" {...register("notes_on_issue")} rows={2} />
                    </div>
                    <div className="space-y-2">
                        <Label htmlFor="notes_on_return">Ğ—Ğ°Ğ¼ĞµÑ‚ĞºĞ¸ Ğ¿Ñ€Ğ¸ Ğ²Ğ¾Ğ·Ğ²Ñ€Ğ°Ñ‚Ğµ</Label>
                        <Textarea id="notes_on_return" {...register("notes_on_return")} rows={2} />
                    </div>

                    {/* ĞšĞ½Ğ¾Ğ¿ĞºĞ¸ ÑƒĞ¿Ñ€Ğ°Ğ²Ğ»ĞµĞ½Ğ¸Ñ */}
                    <div className="flex justify-end gap-2 pt-2 border-t">
                        <Button type="button" variant="ghost" onClick={onCancel} disabled={isSaving}>
                            <X className="mr-2 h-4 w-4" /> ĞÑ‚Ğ¼ĞµĞ½Ğ°
                        </Button>
                        <Button type="submit" disabled={!isValid || !isDirty || isSaving}>
                            {isSaving ? <Loader2 className="mr-2 h-4 w-4 animate-spin" /> : <Save className="mr-2 h-4 w-4" />}
                            Ğ¡Ğ¾Ñ…Ñ€Ğ°Ğ½Ğ¸Ñ‚ÑŒ
                        </Button>
                    </div>
                </CardContent>
            </form>
        </Card>
    );
}

```


## <a name="rentalappmainsrccomponentsadminEquipmentCreateDialogtsx"></a>`rental-app-main/src/components/admin/EquipmentCreateDialog.tsx`

```tsx
// path: rental-app-main/src/components/admin/EquipmentCreateDialog.tsx

// src/components/admin/EquipmentCreateDialog.tsx

import { useMemo } from "react";
import { useForm, Controller } from "react-hook-form";
import { zodResolver } from "@hookform/resolvers/zod";
import { z } from "zod";
import { useCreateEquipment } from "@/hooks/useAdminEquipment";
import { EQUIPMENT_CONDITIONS } from "@/constants/equipmentConstants";

import {
    Dialog,
    DialogContent,
    DialogHeader,
    DialogTitle,
    DialogFooter,
} from "@/components/ui/dialog";
import { Button } from "@/components/ui/button";
import { Input } from "@/components/ui/input";
import { Label } from "@/components/ui/label";
import { Textarea } from "@/components/ui/textarea";
import {
    Select,
    SelectContent,
    SelectItem,
    SelectTrigger,
    SelectValue,
} from "@/components/ui/select";
import type { Equipment } from "@/types/equipment";
import { CreatableSelect } from "@/components/ui/CreatableSelect";

const equipmentCreateSchema = z.object({
    equipment_type: z.string().min(1, "Ğ¢Ğ¸Ğ¿ Ğ¾Ğ±Ğ¾Ñ€ÑƒĞ´Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ Ğ¾Ğ±ÑĞ·Ğ°Ñ‚ĞµĞ»ĞµĞ½"),
    brand: z.string().min(1, "Ğ‘Ñ€ĞµĞ½Ğ´ Ğ¾Ğ±ÑĞ·Ğ°Ñ‚ĞµĞ»ĞµĞ½"),
    name: z.string().min(1, "ĞĞ°Ğ·Ğ²Ğ°Ğ½Ğ¸Ğµ Ğ¾Ğ±ÑĞ·Ğ°Ñ‚ĞµĞ»ÑŒĞ½Ğ¾"),
    serial_number: z.string().optional(),
    condition: z.string().min(1, "Ğ¡Ğ¾ÑÑ‚Ğ¾ÑĞ½Ğ¸Ğµ Ğ¾Ğ±ÑĞ·Ğ°Ñ‚ĞµĞ»ÑŒĞ½Ğ¾"),
    daily_rate: z.number().min(0, "Ğ¢Ğ°Ñ€Ğ¸Ñ„ Ğ½Ğµ Ğ¼Ğ¾Ğ¶ĞµÑ‚ Ğ±Ñ‹Ñ‚ÑŒ Ğ¾Ñ‚Ñ€Ğ¸Ñ†Ğ°Ñ‚ĞµĞ»ÑŒĞ½Ñ‹Ğ¼"),
    notes: z.string().optional(),
    description: z.string().optional(),
    last_maintenance: z.string().optional(),
});

type EquipmentCreateFormData = z.infer<typeof equipmentCreateSchema>;

interface EquipmentCreateDialogProps {
    open: boolean;
    onClose: () => void;
    equipment: Equipment[];
}

export default function EquipmentCreateDialog({
                                                  open,
                                                  onClose,
                                                  equipment
                                              }: EquipmentCreateDialogProps) {
    const createEquipmentMutation = useCreateEquipment();

    const {
        register,
        handleSubmit,
        formState: { errors, isValid },
        reset,
        setValue,
        control,
    } = useForm<EquipmentCreateFormData>({
        resolver: zodResolver(equipmentCreateSchema),
        defaultValues: {
            condition: "Ğ’ĞµĞ»Ğ¸ĞºĞ¾Ğ»ĞµĞ¿Ğ½Ğ¾",
            daily_rate: 0,
        },
        mode: "onChange",
    });

    const equipmentTypes = useMemo(() => {
        const types = new Set(equipment.map(e => e.equipment_type));
        return Array.from(types).sort((a,b) => a.localeCompare(b));
    }, [equipment]);

    const equipmentBrands = useMemo(() => {
        const brands = new Set(equipment.map(e => e.brand));
        return Array.from(brands).sort((a,b) => a.localeCompare(b));
    }, [equipment]);

    const onSubmit = async (data: EquipmentCreateFormData) => {
        try {
            await createEquipmentMutation.mutateAsync(data);
            reset();
            onClose();
        } catch (error) {
            // ĞÑˆĞ¸Ğ±ĞºĞ° Ğ¾Ğ±Ñ€Ğ°Ğ±Ğ¾Ñ‚Ğ°ĞµÑ‚ÑÑ Ğ² Ñ…ÑƒĞºĞµ
        }
    };

    const handleClose = () => {
        reset();
        onClose();
    };

    return (
        <Dialog open={open} onOpenChange={handleClose}>
            <DialogContent className="max-w-2xl max-h-[90vh] overflow-y-auto">
                <DialogHeader>
                    <DialogTitle>Ğ”Ğ¾Ğ±Ğ°Ğ²Ğ¸Ñ‚ÑŒ Ğ½Ğ¾Ğ²Ğ¾Ğµ Ğ¾Ğ±Ğ¾Ñ€ÑƒĞ´Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ</DialogTitle>
                </DialogHeader>

                <form onSubmit={handleSubmit(onSubmit)} className="space-y-4">
                    <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                        {/* Ğ¢Ğ¸Ğ¿ Ğ¾Ğ±Ğ¾Ñ€ÑƒĞ´Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ */}
                        <div>
                            <Label htmlFor="equipment_type">Ğ¢Ğ¸Ğ¿ Ğ¾Ğ±Ğ¾Ñ€ÑƒĞ´Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ *</Label>
                            <Controller
                                name="equipment_type"
                                control={control}
                                render={({ field }) => (
                                    <CreatableSelect
                                        value={field.value}
                                        onChange={field.onChange}
                                        options={equipmentTypes}
                                        placeholder="Ğ’Ñ‹Ğ±ĞµÑ€Ğ¸Ñ‚Ğµ Ğ¸Ğ»Ğ¸ ÑĞ¾Ğ·Ğ´Ğ°Ğ¹Ñ‚Ğµ Ñ‚Ğ¸Ğ¿"
                                        dialogTitle="ĞĞ¾Ğ²Ñ‹Ğ¹ Ñ‚Ğ¸Ğ¿ Ğ¾Ğ±Ğ¾Ñ€ÑƒĞ´Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ"
                                        dialogDescription="Ğ’Ğ²ĞµĞ´Ğ¸Ñ‚Ğµ Ğ½Ğ°Ğ·Ğ²Ğ°Ğ½Ğ¸Ğµ Ğ´Ğ»Ñ Ğ½Ğ¾Ğ²Ğ¾Ğ³Ğ¾ Ñ‚Ğ¸Ğ¿Ğ°."
                                        dialogLabel="ĞĞ°Ğ·Ğ²Ğ°Ğ½Ğ¸Ğµ"
                                    />
                                )}
                            />
                            {errors.equipment_type && (
                                <p className="text-xs text-red-600 mt-1">
                                    {errors.equipment_type.message}
                                </p>
                            )}
                        </div>

                        {/* Ğ‘Ñ€ĞµĞ½Ğ´ */}
                        <div>
                            <Label htmlFor="brand">Ğ‘Ñ€ĞµĞ½Ğ´ *</Label>
                            <Controller
                                name="brand"
                                control={control}
                                render={({ field }) => (
                                    <CreatableSelect
                                        value={field.value}
                                        onChange={field.onChange}
                                        options={equipmentBrands}
                                        placeholder="Ğ’Ñ‹Ğ±ĞµÑ€Ğ¸Ñ‚Ğµ Ğ¸Ğ»Ğ¸ ÑĞ¾Ğ·Ğ´Ğ°Ğ¹Ñ‚Ğµ Ğ±Ñ€ĞµĞ½Ğ´"
                                        dialogTitle="ĞĞ¾Ğ²Ñ‹Ğ¹ Ğ±Ñ€ĞµĞ½Ğ´"
                                        dialogDescription="Ğ’Ğ²ĞµĞ´Ğ¸Ñ‚Ğµ Ğ½Ğ°Ğ·Ğ²Ğ°Ğ½Ğ¸Ğµ Ğ´Ğ»Ñ Ğ½Ğ¾Ğ²Ğ¾Ğ³Ğ¾ Ğ±Ñ€ĞµĞ½Ğ´Ğ°."
                                        dialogLabel="ĞĞ°Ğ·Ğ²Ğ°Ğ½Ğ¸Ğµ"
                                    />
                                )}
                            />
                            {errors.brand && (
                                <p className="text-xs text-red-600 mt-1">
                                    {errors.brand.message}
                                </p>
                            )}
                        </div>
                    </div>

                    <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                        {/* ĞĞ°Ğ·Ğ²Ğ°Ğ½Ğ¸Ğµ */}
                        <div>
                            <Label htmlFor="name">ĞĞ°Ğ·Ğ²Ğ°Ğ½Ğ¸Ğµ *</Label>
                            <Input
                                id="name"
                                {...register("name")}
                                placeholder="EOS R5, MacBook Pro 14..."
                            />
                            {errors.name && (
                                <p className="text-xs text-red-600 mt-1">
                                    {errors.name.message}
                                </p>
                            )}
                        </div>

                        {/* Ğ¡ĞµÑ€Ğ¸Ğ¹Ğ½Ñ‹Ğ¹ Ğ½Ğ¾Ğ¼ĞµÑ€ */}
                        <div>
                            <Label htmlFor="serial_number">Ğ¡ĞµÑ€Ğ¸Ğ¹Ğ½Ñ‹Ğ¹ Ğ½Ğ¾Ğ¼ĞµÑ€</Label>
                            <Input
                                id="serial_number"
                                {...register("serial_number")}
                                placeholder="ĞĞµĞ¾Ğ±ÑĞ·Ğ°Ñ‚ĞµĞ»ÑŒĞ½Ğ¾"
                            />
                        </div>
                    </div>

                    <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                        {/* Ğ¡Ğ¾ÑÑ‚Ğ¾ÑĞ½Ğ¸Ğµ */}
                        <div>
                            <Label htmlFor="condition">Ğ¡Ğ¾ÑÑ‚Ğ¾ÑĞ½Ğ¸Ğµ *</Label>
                            <Select
                                onValueChange={(value) => setValue("condition", value, { shouldValidate: true })}
                                defaultValue="Ğ’ĞµĞ»Ğ¸ĞºĞ¾Ğ»ĞµĞ¿Ğ½Ğ¾"
                            >
                                <SelectTrigger>
                                    <SelectValue placeholder="Ğ’Ñ‹Ğ±ĞµÑ€Ğ¸Ñ‚Ğµ ÑĞ¾ÑÑ‚Ğ¾ÑĞ½Ğ¸Ğµ" />
                                </SelectTrigger>
                                <SelectContent>
                                    {EQUIPMENT_CONDITIONS.map((condition) => (
                                        <SelectItem key={condition} value={condition}>
                                            {condition}
                                        </SelectItem>
                                    ))}
                                </SelectContent>
                            </Select>
                            {errors.condition && (
                                <p className="text-xs text-red-600 mt-1">
                                    {errors.condition.message}
                                </p>
                            )}
                        </div>

                        {/* Ğ¢Ğ°Ñ€Ğ¸Ñ„ Ğ·Ğ° Ğ´ĞµĞ½ÑŒ */}
                        <div>
                            <Label htmlFor="daily_rate">Ğ¢Ğ°Ñ€Ğ¸Ñ„ Ğ·Ğ° Ğ´ĞµĞ½ÑŒ (â‚½) *</Label>
                            <Input
                                id="daily_rate"
                                type="number"
                                step="0.01"
                                min="0"
                                {...register("daily_rate", { valueAsNumber: true })}
                                placeholder="0"
                            />
                            {errors.daily_rate && (
                                <p className="text-xs text-red-600 mt-1">
                                    {errors.daily_rate.message}
                                </p>
                            )}
                        </div>
                    </div>

                    {/* Ğ”Ğ°Ñ‚Ğ° Ğ¿Ğ¾ÑĞ»ĞµĞ´Ğ½ĞµĞ³Ğ¾ Ğ¢Ğ */}
                    <div>
                        <Label htmlFor="last_maintenance">Ğ”Ğ°Ñ‚Ğ° Ğ¿Ğ¾ÑĞ»ĞµĞ´Ğ½ĞµĞ³Ğ¾ Ğ¢Ğ</Label>
                        <Input
                            id="last_maintenance"
                            type="date"
                            {...register("last_maintenance")}
                        />
                    </div>

                    {/* ĞĞ¿Ğ¸ÑĞ°Ğ½Ğ¸Ğµ */}
                    <div>
                        <Label htmlFor="description">ĞĞ¿Ğ¸ÑĞ°Ğ½Ğ¸Ğµ</Label>
                        <Textarea
                            id="description"
                            {...register("description")}
                            placeholder="ĞŸĞ¾Ğ´Ñ€Ğ¾Ğ±Ğ½Ğ¾Ğµ Ğ¾Ğ¿Ğ¸ÑĞ°Ğ½Ğ¸Ğµ Ğ¾Ğ±Ğ¾Ñ€ÑƒĞ´Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ, ĞµĞ³Ğ¾ Ğ¾ÑĞ¾Ğ±ĞµĞ½Ğ½Ğ¾ÑÑ‚Ğ¸..."
                            rows={3}
                        />
                    </div>

                    {/* Ğ—Ğ°Ğ¼ĞµÑ‚ĞºĞ¸ */}
                    <div>
                        <Label htmlFor="notes">Ğ—Ğ°Ğ¼ĞµÑ‚ĞºĞ¸ (Ğ²Ğ¸Ğ´Ğ½Ñ‹ Ñ‚Ğ¾Ğ»ÑŒĞºĞ¾ Ğ¿ĞµÑ€ÑĞ¾Ğ½Ğ°Ğ»Ñƒ)</Label>
                        <Textarea
                            id="notes"
                            {...register("notes")}
                            placeholder="Ğ’Ğ½ÑƒÑ‚Ñ€ĞµĞ½Ğ½Ğ¸Ğµ Ğ·Ğ°Ğ¼ĞµÑ‚ĞºĞ¸ Ğ¾ ÑĞ¾ÑÑ‚Ğ¾ÑĞ½Ğ¸Ğ¸, Ğ¾ÑĞ¾Ğ±ĞµĞ½Ğ½Ğ¾ÑÑ‚ÑÑ…..."
                            rows={2}
                        />
                    </div>

                    <DialogFooter className="pt-4">
                        <Button type="button" variant="outline" onClick={handleClose}>
                            ĞÑ‚Ğ¼ĞµĞ½Ğ°
                        </Button>
                        <Button
                            type="submit"
                            disabled={!isValid || createEquipmentMutation.isPending}
                        >
                            {createEquipmentMutation.isPending ? "Ğ¡Ğ¾Ğ·Ğ´Ğ°Ğ½Ğ¸Ğµ..." : "Ğ¡Ğ¾Ğ·Ğ´Ğ°Ñ‚ÑŒ Ğ¾Ğ±Ğ¾Ñ€ÑƒĞ´Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ"}
                        </Button>
                    </DialogFooter>
                </form>
            </DialogContent>
        </Dialog>
    );
}

```


## <a name="rentalappmainsrccomponentsadminEquipmentEditDialogtsx"></a>`rental-app-main/src/components/admin/EquipmentEditDialog.tsx`

```tsx
// path: rental-app-main/src/components/admin/EquipmentEditDialog.tsx

// src/components/admin/EquipmentEditDialog.tsx

import { Dialog, DialogContent, DialogHeader, DialogTitle } from "@/components/ui/dialog";
import EquipmentEditForm from "@/components/equipment/EquipmentEditForm";
import type { Equipment } from "@/types/equipment";

interface Props {
    open: boolean;
    onClose: () => void;
    equipment: Equipment;
}

export default function EquipmentEditDialog({ open, onClose, equipment }: Props) {
    const handleSuccess = () => {
        onClose();
    };

    return (
        <Dialog open={open} onOpenChange={onClose} modal={false}>
            <DialogContent className="max-w-2xl">
                <DialogHeader>
                    <DialogTitle>Ğ ĞµĞ´Ğ°ĞºÑ‚Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ Ğ¾Ğ±Ğ¾Ñ€ÑƒĞ´Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ</DialogTitle>
                </DialogHeader>
                <EquipmentEditForm
                    equipment={equipment}
                    onSuccess={handleSuccess}
                    onCancel={onClose}
                />
            </DialogContent>
        </Dialog>
    );
}

```


## <a name="rentalappmainsrccomponentsadminEquipmentStatstsx"></a>`rental-app-main/src/components/admin/EquipmentStats.tsx`

```tsx
// path: rental-app-main/src/components/admin/EquipmentStats.tsx

// src/components/admin/EquipmentStats.tsx
import { useMemo } from 'react';
import type { Equipment } from "@/types/equipment";

interface Props {
    equipment: Equipment[];
}

export const EquipmentStats = ({ equipment }: Props) => {
    const stats = useMemo(() => {
        const totalCount = equipment.length;
        if (totalCount === 0) {
            return { totalCount: 0, typesCount: 0, brandsCount: 0, avgRate: 0 };
        }
        return {
            totalCount,
            typesCount: new Set(equipment.map(item => item.equipment_type)).size,
            brandsCount: new Set(equipment.map(item => item.brand)).size,
            avgRate: Math.round(equipment.reduce((sum, item) => sum + item.daily_rate, 0) / totalCount),
        };
    }, [equipment]);

    return (
        <div className="grid grid-cols-2 sm:grid-cols-4 gap-4 pt-4 border-t">
            <div className="text-center">
                <div className="text-2xl font-bold">{stats.totalCount}</div>
                <div className="text-sm text-muted-foreground">Ğ’ÑĞµĞ³Ğ¾ ĞµĞ´Ğ¸Ğ½Ğ¸Ñ†</div>
            </div>
            <div className="text-center">
                <div className="text-2xl font-bold">{stats.typesCount}</div>
                <div className="text-sm text-muted-foreground">Ğ¢Ğ¸Ğ¿Ğ¾Ğ²</div>
            </div>
            <div className="text-center">
                <div className="text-2xl font-bold">{stats.brandsCount}</div>
                <div className="text-sm text-muted-foreground">Ğ‘Ñ€ĞµĞ½Ğ´Ğ¾Ğ²</div>
            </div>
            <div className="text-center">
                <div className="text-2xl font-bold">{stats.avgRate.toLocaleString()} â‚½</div>
                <div className="text-sm text-muted-foreground">Ğ¡Ñ€ĞµĞ´Ğ½Ğ¸Ğ¹ Ñ‚Ğ°Ñ€Ğ¸Ñ„</div>
            </div>
        </div>
    );
};

```


## <a name="rentalappmainsrccomponentsadminEquipmentTabletsx"></a>`rental-app-main/src/components/admin/EquipmentTable.tsx`

```tsx
// path: rental-app-main/src/components/admin/EquipmentTable.tsx

// src/components/admin/EquipmentTable.tsx

import { useState } from "react";
import { Table, TableBody, TableHead, TableHeader, TableRow } from "@/components/ui/table";
import { Package, PackageSearch, Loader2 } from "lucide-react"; // âœ… Ğ”Ğ¾Ğ±Ğ°Ğ²Ğ»ĞµĞ½ Ğ¸Ğ¼Ğ¿Ğ¾Ñ€Ñ‚ Loader2
import { Button } from "@/components/ui/button"; // âœ… Ğ”Ğ¾Ğ±Ğ°Ğ²Ğ»ĞµĞ½ Ğ¸Ğ¼Ğ¿Ğ¾Ñ€Ñ‚ Button
import EquipmentCreateDialog from "./EquipmentCreateDialog";
import { useEquipmentTableLogic } from "@/hooks/admin/useEquipmentTableLogic";
import { EquipmentTableToolbar } from "./EquipmentTableToolbar";
import { EquipmentTableRow } from "./EquipmentTableRow";
import { EquipmentStats } from "./EquipmentStats";
import type { Equipment } from "@/types/equipment";

interface EquipmentTableProps {
    onEditEquipment?: (equipment: Equipment) => void;
    equipment: Equipment[];
    // âœ… ĞĞĞ§ĞĞ›Ğ: Ğ”Ğ¾Ğ±Ğ°Ğ²Ğ»ÑĞµĞ¼ Ğ½Ğ¾Ğ²Ñ‹Ğµ ÑĞ²Ğ¾Ğ¹ÑÑ‚Ğ²Ğ° Ğ´Ğ»Ñ Ğ¿Ğ°Ğ³Ğ¸Ğ½Ğ°Ñ†Ğ¸Ğ¸
    hasNextPage?: boolean;
    isFetchingNextPage?: boolean;
    onLoadMore: () => void;
    // âœ… ĞšĞĞĞ•Ğ¦: ĞĞ¾Ğ²Ñ‹Ğµ ÑĞ²Ğ¾Ğ¹ÑÑ‚Ğ²Ğ° Ğ´Ğ»Ñ Ğ¿Ğ°Ğ³Ğ¸Ğ½Ğ°Ñ†Ğ¸Ğ¸
}

export default function EquipmentTable({
                                           onEditEquipment,
                                           equipment,
                                           hasNextPage,
                                           isFetchingNextPage,
                                           onLoadMore
                                       }: EquipmentTableProps) {
    const [showCreateDialog, setShowCreateDialog] = useState(false);

    const {
        isManager,
        isLoading,
        error,
        filteredEquipment,
        searchQuery,
        selectedIds,
        deleteEquipmentMutation,
        bulkDeleteMutation,
        handlers,
    } = useEquipmentTableLogic(equipment);

    if (isLoading) return <div className="flex justify-center p-4">Ğ—Ğ°Ğ³Ñ€ÑƒĞ·ĞºĞ° Ğ¾Ğ±Ğ¾Ñ€ÑƒĞ´Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ...</div>;
    if (error) return <div className="flex justify-center p-4 text-red-500">ĞÑˆĞ¸Ğ±ĞºĞ° Ğ·Ğ°Ğ³Ñ€ÑƒĞ·ĞºĞ¸ Ğ¾Ğ±Ğ¾Ñ€ÑƒĞ´Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ</div>;

    return (
        <div className="space-y-4">
            <EquipmentTableToolbar
                searchQuery={searchQuery}
                onSearchChange={handlers.setSearchQuery}
                onAdd={() => setShowCreateDialog(true)}
                onBulkDelete={handlers.handleBulkDelete}
                selectedCount={selectedIds.length}
                totalCount={equipment.length}
                filteredCount={filteredEquipment.length}
                isManager={isManager}
                isDeleting={bulkDeleteMutation.isPending}
            />

            {filteredEquipment.length > 0 ? (
                <div className="border rounded-md">
                    <Table>
                        <TableHeader>
                            <TableRow>
                                {isManager && <TableHead className="w-12"></TableHead>}
                                <TableHead><Package className="inline mr-2 h-4 w-4" />Ğ¢Ğ¸Ğ¿</TableHead>
                                <TableHead>Ğ‘Ñ€ĞµĞ½Ğ´</TableHead>
                                <TableHead>ĞĞ°Ğ·Ğ²Ğ°Ğ½Ğ¸Ğµ</TableHead>
                                <TableHead>Ğ¡ĞµÑ€Ğ¸Ğ¹Ğ½Ñ‹Ğ¹ Ğ½Ğ¾Ğ¼ĞµÑ€</TableHead>
                                <TableHead>Ğ¡Ğ¾ÑÑ‚Ğ¾ÑĞ½Ğ¸Ğµ</TableHead>
                                <TableHead>Ğ¢Ğ°Ñ€Ğ¸Ñ„/Ğ´ĞµĞ½ÑŒ</TableHead>
                                {isManager && <TableHead>Ğ”ĞµĞ¹ÑÑ‚Ğ²Ğ¸Ñ</TableHead>}
                            </TableRow>
                        </TableHeader>
                        <TableBody>
                            {filteredEquipment.map((item) => (
                                <EquipmentTableRow
                                    key={item.id}
                                    item={item}
                                    isSelected={selectedIds.includes(item.id)}
                                    isManager={isManager}
                                    isDeleting={deleteEquipmentMutation.isPending}
                                    onSelectItem={handlers.handleSelectItem}
                                    onEdit={onEditEquipment!}
                                    onDelete={handlers.handleDelete}
                                />
                            ))}
                        </TableBody>
                    </Table>
                </div>
            ) : (
                <div className="text-center py-12 px-4 border rounded-md">
                    <PackageSearch className="w-16 h-16 text-gray-300 mx-auto mb-3" />
                    <h3 className="text-lg font-semibold text-gray-700">ĞĞ±Ğ¾Ñ€ÑƒĞ´Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ Ğ½Ğµ Ğ½Ğ°Ğ¹Ğ´ĞµĞ½Ğ¾</h3>
                    <p className="text-sm text-gray-500 max-w-sm">
                        {searchQuery ? "ĞŸĞ¾Ğ¿Ñ€Ğ¾Ğ±ÑƒĞ¹Ñ‚Ğµ Ğ¸Ğ·Ğ¼ĞµĞ½Ğ¸Ñ‚ÑŒ Ğ¿Ğ¾Ğ¸ÑĞºĞ¾Ğ²Ñ‹Ğ¹ Ğ·Ğ°Ğ¿Ñ€Ğ¾Ñ." : "Ğ”Ğ¾Ğ±Ğ°Ğ²ÑŒÑ‚Ğµ Ğ¾Ğ±Ğ¾Ñ€ÑƒĞ´Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ, Ñ‡Ñ‚Ğ¾Ğ±Ñ‹ Ğ¾Ğ½Ğ¾ Ğ¿Ğ¾ÑĞ²Ğ¸Ğ»Ğ¾ÑÑŒ Ğ² ÑĞ¿Ğ¸ÑĞºĞµ."}
                    </p>
                </div>
            )}

            {/* âœ… ĞĞĞ§ĞĞ›Ğ: Ğ‘Ğ»Ğ¾Ğº Ñ ĞºĞ½Ğ¾Ğ¿ĞºĞ¾Ğ¹ Ğ¿Ğ°Ğ³Ğ¸Ğ½Ğ°Ñ†Ğ¸Ğ¸ */}
            {hasNextPage && (
                <div className="flex justify-center pt-2">
                    <Button
                        variant="outline"
                        onClick={onLoadMore}
                        disabled={isFetchingNextPage}
                    >
                        {isFetchingNextPage ? (
                            <>
                                <Loader2 className="mr-2 h-4 w-4 animate-spin" />
                                Ğ—Ğ°Ğ³Ñ€ÑƒĞ·ĞºĞ°...
                            </>
                        ) : (
                            "Ğ—Ğ°Ğ³Ñ€ÑƒĞ·Ğ¸Ñ‚ÑŒ ĞµÑ‰Ñ‘"
                        )}
                    </Button>
                </div>
            )}
            {/* âœ… ĞšĞĞĞ•Ğ¦: Ğ‘Ğ»Ğ¾Ğº Ñ ĞºĞ½Ğ¾Ğ¿ĞºĞ¾Ğ¹ Ğ¿Ğ°Ğ³Ğ¸Ğ½Ğ°Ñ†Ğ¸Ğ¸ */}

            <EquipmentStats equipment={equipment} />

            <EquipmentCreateDialog
                open={showCreateDialog}
                onClose={() => setShowCreateDialog(false)}
                equipment={equipment}
            />
        </div>
    );
}

```


## <a name="rentalappmainsrccomponentsadminEquipmentTableRowtsx"></a>`rental-app-main/src/components/admin/EquipmentTableRow.tsx`

```tsx
// path: rental-app-main/src/components/admin/EquipmentTableRow.tsx

// src/components/admin/EquipmentTableRow.tsx

import { TableCell, TableRow } from "@/components/ui/table";
import { Checkbox } from "@/components/ui/checkbox";
import { Button } from "@/components/ui/button";
import { Edit, Trash2 } from "lucide-react";
import type { Equipment } from "@/types/equipment";
import { getConditionVariantClass } from "@/constants/equipmentConstants";

interface Props {
    item: Equipment;
    isSelected: boolean;
    isManager: boolean;
    isDeleting: boolean;
    onSelectItem: (id: number, checked: boolean) => void;
    onEdit: (item: Equipment) => void;
    onDelete: (id: number) => void;
}

export const EquipmentTableRow = ({ item, isSelected, isManager, isDeleting, onSelectItem, onEdit, onDelete }: Props) => (
    <TableRow>
        {isManager && (
            <TableCell>
                <Checkbox
                    checked={isSelected}
                    onCheckedChange={(checked) => onSelectItem(item.id, Boolean(checked))}
                />
            </TableCell>
        )}
        <TableCell className="font-medium">{item.equipment_type}</TableCell>
        <TableCell>{item.brand}</TableCell>
        <TableCell>{item.name}</TableCell>
        <TableCell>{item.serial_number || "â€”"}</TableCell>
        <TableCell>
            {/* âœ… Ğ˜Ğ—ĞœĞ•ĞĞ•ĞĞ˜Ğ•: Ğ˜ÑĞ¿Ğ¾Ğ»ÑŒĞ·ÑƒĞµĞ¼ Ğ¸Ğ¼Ğ¿Ğ¾Ñ€Ñ‚Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ½ÑƒÑ Ñ„ÑƒĞ½ĞºÑ†Ğ¸Ñ */}
            <span className={`text-xs px-2 py-1 rounded-full font-medium ${getConditionVariantClass(item.condition)}`}>
                {item.condition}
            </span>
        </TableCell>
        <TableCell className="font-medium">{item.daily_rate.toLocaleString()} â‚½</TableCell>
        {isManager && (
            <TableCell>
                <div className="flex gap-2">
                    <Button variant="outline" size="icon" onClick={() => onEdit(item)}>
                        <Edit className="h-4 w-4" />
                    </Button>
                    <Button variant="destructive" size="icon" onClick={() => onDelete(item.id)} disabled={isDeleting}>
                        <Trash2 className="h-4 w-4" />
                    </Button>
                </div>
            </TableCell>
        )}
    </TableRow>
);

```


## <a name="rentalappmainsrccomponentsadminEquipmentTableToolbartsx"></a>`rental-app-main/src/components/admin/EquipmentTableToolbar.tsx`

```tsx
// path: rental-app-main/src/components/admin/EquipmentTableToolbar.tsx

// src/components/admin/EquipmentTableToolbar.tsx
import { Button } from "@/components/ui/button";
import { Input } from "@/components/ui/input";
import { Plus, Search, Trash2 } from "lucide-react";

interface Props {
    searchQuery: string;
    onSearchChange: (value: string) => void;
    onAdd: () => void;
    onBulkDelete: () => void;
    selectedCount: number;
    totalCount: number;
    filteredCount: number;
    isManager: boolean;
    isDeleting: boolean;
}

export const EquipmentTableToolbar = ({
                                          searchQuery,
                                          onSearchChange,
                                          onAdd,
                                          onBulkDelete,
                                          selectedCount,
                                          totalCount,
                                          filteredCount,
                                          isManager,
                                          isDeleting
                                      }: Props) => (
    <div className="flex flex-col sm:flex-row gap-4 items-start sm:items-center justify-between">
        <div className="relative flex-1 w-full sm:w-auto sm:max-w-sm">
            <Search className="absolute left-3 top-2.5 h-4 w-4 text-muted-foreground" />
            <Input
                placeholder="ĞŸĞ¾Ğ¸ÑĞº Ğ¿Ğ¾ Ğ½Ğ°Ğ·Ğ²Ğ°Ğ½Ğ¸Ñ, Ğ±Ñ€ĞµĞ½Ğ´Ñƒ, Ñ‚Ğ¸Ğ¿Ñƒ..."
                value={searchQuery}
                onChange={(e) => onSearchChange(e.target.value)}
                className="pl-10"
            />
        </div>
        <div className="flex flex-col sm:flex-row gap-2 items-stretch sm:items-center w-full sm:w-auto">
            <span className="text-sm text-muted-foreground text-center sm:text-left">
                ĞĞ°Ğ¹Ğ´ĞµĞ½Ğ¾: {filteredCount} Ğ¸Ğ· {totalCount}
            </span>
            {selectedCount > 0 && isManager && (
                <Button variant="destructive" size="sm" onClick={onBulkDelete} disabled={isDeleting}>
                    <Trash2 className="h-4 w-4 mr-2" />
                    Ğ£Ğ´Ğ°Ğ»Ğ¸Ñ‚ÑŒ ({selectedCount})
                </Button>
            )}
            {isManager && (
                <Button onClick={onAdd} size="sm" className="flex items-center gap-2">
                    <Plus className="h-4 w-4" />
                    Ğ”Ğ¾Ğ±Ğ°Ğ²Ğ¸Ñ‚ÑŒ Ğ¾Ğ±Ğ¾Ñ€ÑƒĞ´Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ
                </Button>
            )}
        </div>
    </div>
);

```


## <a name="rentalappmainsrccomponentsadminHolidayManagertsx"></a>`rental-app-main/src/components/admin/HolidayManager.tsx`

```tsx
// path: rental-app-main/src/components/admin/HolidayManager.tsx

// src/components/admin/HolidayManager.tsx

import { useState, useMemo } from 'react';
import { DayPicker } from 'react-day-picker';
import { ru } from 'date-fns/locale';
import { format, startOfMonth, endOfMonth } from 'date-fns';
import { useHolidays, useCreateHoliday, useDeleteHoliday, type HolidayWithDate } from '@/hooks/useAdminHolidays';
import { useGetHolidayRules, useCreateWeeklyRule, useImportPublicHolidays, useDeleteHolidayRule } from '@/hooks/useAdminHolidayRules';

import { Button } from '@/components/ui/button';
import { Input } from '@/components/ui/input';
import { Trash2, CalendarPlus, Globe, Repeat } from 'lucide-react';
import { Dialog, DialogContent, DialogHeader, DialogTitle, DialogFooter, DialogDescription } from "@/components/ui/dialog";
import { toast } from 'sonner';
import { Card, CardContent, CardHeader, CardTitle, CardDescription } from "@/components/ui/card";
import { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from "@/components/ui/select";
import { Label } from "@/components/ui/label";
import { Table, TableBody, TableCell, TableHead, TableHeader, TableRow } from "@/components/ui/table";

type ConflictInfo = {
    date: Date;
    description: string;
    conflicting_reservation_ids: number[];
};

// --- ĞĞ¾Ğ²Ñ‹Ğ¹ ĞºĞ¾Ğ¼Ğ¿Ğ¾Ğ½ĞµĞ½Ñ‚ Ğ´Ğ»Ñ Ñ„Ğ¾Ñ€Ğ¼Ñ‹ ĞµĞ¶ĞµĞ½ĞµĞ´ĞµĞ»ÑŒĞ½Ñ‹Ñ… Ğ¿Ñ€Ğ°Ğ²Ğ¸Ğ» ---
function WeeklyRuleForm({ isLoading }: { isLoading: boolean }) {
    const [dayOfWeek, setDayOfWeek] = useState<string>("6"); // 6 = Ğ’Ğ¾ÑĞºÑ€ĞµÑĞµĞ½ÑŒĞµ
    const [startDate, setStartDate] = useState<string>(format(new Date(), 'yyyy-MM-dd'));
    const [endDate, setEndDate] = useState<string>(`${new Date().getFullYear()}-12-31`);
    const createRuleMutation = useCreateWeeklyRule();

    const daysOfWeek = [
        { label: "ĞŸĞ¾Ğ½ĞµĞ´ĞµĞ»ÑŒĞ½Ğ¸Ğº", value: "0" },
        { label: "Ğ’Ñ‚Ğ¾Ñ€Ğ½Ğ¸Ğº", value: "1" },
        { label: "Ğ¡Ñ€ĞµĞ´Ğ°", value: "2" },
        { label: "Ğ§ĞµÑ‚Ğ²ĞµÑ€Ğ³", value: "3" },
        { label: "ĞŸÑÑ‚Ğ½Ğ¸Ñ†Ğ°", value: "4" },
        { label: "Ğ¡ÑƒĞ±Ğ±Ğ¾Ñ‚Ğ°", value: "5" },
        { label: "Ğ’Ğ¾ÑĞºÑ€ĞµÑĞµĞ½ÑŒĞµ", value: "6" },
    ];

    const handleSubmit = (e: React.FormEvent) => {
        e.preventDefault();
        const selectedDay = daysOfWeek.find(d => d.value === dayOfWeek);
        createRuleMutation.mutate({
            day_of_week: parseInt(dayOfWeek, 10),
            start_date: new Date(startDate),
            end_date: new Date(endDate),
            description: `Ğ•Ğ¶ĞµĞ½ĞµĞ´ĞµĞ»ÑŒĞ½Ñ‹Ğ¹ Ğ²Ñ‹Ñ…Ğ¾Ğ´Ğ½Ğ¾Ğ¹: ${selectedDay?.label}`
        });
    };

    return (
        <Card>
            <CardHeader>
                <CardTitle className="flex items-center gap-2"><Repeat className="w-5 h-5" /> Ğ•Ğ¶ĞµĞ½ĞµĞ´ĞµĞ»ÑŒĞ½Ñ‹Ğµ Ğ²Ñ‹Ñ…Ğ¾Ğ´Ğ½Ñ‹Ğµ</CardTitle>
                <CardDescription>ĞĞ²Ñ‚Ğ¾Ğ¼Ğ°Ñ‚Ğ¸Ñ‡ĞµÑĞºĞ¸ ÑĞ´ĞµĞ»Ğ°Ñ‚ÑŒ Ğ²Ñ‹Ñ…Ğ¾Ğ´Ğ½Ñ‹Ğ¼Ğ¸ Ğ²ÑĞµ Ğ²Ñ‹Ğ±Ñ€Ğ°Ğ½Ğ½Ñ‹Ğµ Ğ´Ğ½Ğ¸ Ğ½ĞµĞ´ĞµĞ»Ğ¸ Ğ² Ğ¿ĞµÑ€Ğ¸Ğ¾Ğ´Ğµ.</CardDescription>
            </CardHeader>
            <CardContent>
                <form onSubmit={handleSubmit} className="space-y-4">
                    <div className="grid grid-cols-1 sm:grid-cols-3 gap-4">
                        <div>
                            <Label>Ğ”ĞµĞ½ÑŒ Ğ½ĞµĞ´ĞµĞ»Ğ¸</Label>
                            <Select value={dayOfWeek} onValueChange={setDayOfWeek}>
                                <SelectTrigger><SelectValue /></SelectTrigger>
                                <SelectContent>
                                    {daysOfWeek.map(day => (
                                        <SelectItem key={day.value} value={day.value}>{day.label}</SelectItem>
                                    ))}
                                </SelectContent>
                            </Select>
                        </div>
                        <div>
                            <Label>ĞĞ°Ñ‡Ğ¸Ğ½Ğ°Ñ Ñ</Label>
                            <Input type="date" value={startDate} onChange={e => setStartDate(e.target.value)} />
                        </div>
                        <div>
                            <Label>Ğ—Ğ°ĞºĞ°Ğ½Ñ‡Ğ¸Ğ²Ğ°Ñ</Label>
                            <Input type="date" value={endDate} onChange={e => setEndDate(e.target.value)} />
                        </div>
                    </div>
                    <Button type="submit" disabled={isLoading || createRuleMutation.isPending} className="w-full sm:w-auto">
                        {createRuleMutation.isPending ? "Ğ¡Ğ¾Ğ·Ğ´Ğ°Ğ½Ğ¸Ğµ..." : "Ğ¡Ğ¾Ğ·Ğ´Ğ°Ñ‚ÑŒ Ğ¿Ñ€Ğ°Ğ²Ğ¸Ğ»Ğ¾"}
                    </Button>
                </form>
            </CardContent>
        </Card>
    );
}

// --- ĞĞ¾Ğ²Ñ‹Ğ¹ ĞºĞ¾Ğ¼Ğ¿Ğ¾Ğ½ĞµĞ½Ñ‚ Ğ´Ğ»Ñ Ñ„Ğ¾Ñ€Ğ¼Ñ‹ Ğ¸Ğ¼Ğ¿Ğ¾Ñ€Ñ‚Ğ° ---
function PublicHolidayImportForm({ isLoading }: { isLoading: boolean }) {
    const [year, setYear] = useState<number>(new Date().getFullYear());
    const [countryCode, setCountryCode] = useState<string>("RU");
    const importMutation = useImportPublicHolidays();

    const handleSubmit = (e: React.FormEvent) => {
        e.preventDefault();
        importMutation.mutate({ year, country_code: countryCode });
    };

    return (
        <Card>
            <CardHeader>
                <CardTitle className="flex items-center gap-2"><Globe className="w-5 h-5" /> Ğ˜Ğ¼Ğ¿Ğ¾Ñ€Ñ‚ Ğ³Ğ¾Ñ. Ğ¿Ñ€Ğ°Ğ·Ğ´Ğ½Ğ¸ĞºĞ¾Ğ²</CardTitle>
                <CardDescription>ĞĞ²Ñ‚Ğ¾Ğ¼Ğ°Ñ‚Ğ¸Ñ‡ĞµÑĞºĞ¸ Ğ´Ğ¾Ğ±Ğ°Ğ²Ğ¸Ñ‚ÑŒ Ğ¾Ñ„Ğ¸Ñ†Ğ¸Ğ°Ğ»ÑŒĞ½Ñ‹Ğµ Ğ¿Ñ€Ğ°Ğ·Ğ´Ğ½Ğ¸ĞºĞ¸ Ğ´Ğ»Ñ ÑÑ‚Ñ€Ğ°Ğ½Ñ‹.</CardDescription>
            </CardHeader>
            <CardContent>
                <form onSubmit={handleSubmit} className="flex flex-col sm:flex-row items-end gap-4">
                    <div className="flex-grow">
                        <Label>Ğ“Ğ¾Ğ´</Label>
                        <Input type="number" value={year} onChange={e => setYear(parseInt(e.target.value, 10))} />
                    </div>
                    <div className="flex-grow">
                        <Label>ĞšĞ¾Ğ´ ÑÑ‚Ñ€Ğ°Ğ½Ñ‹ (ISO 3166-1)</Label>
                        <Input value={countryCode} onChange={e => setCountryCode(e.target.value.toUpperCase())} placeholder="RU" />
                    </div>
                    <Button type="submit" disabled={isLoading || importMutation.isPending}>
                        {importMutation.isPending ? "Ğ˜Ğ¼Ğ¿Ğ¾Ñ€Ñ‚..." : "Ğ˜Ğ¼Ğ¿Ğ¾Ñ€Ñ‚Ğ¸Ñ€Ğ¾Ğ²Ğ°Ñ‚ÑŒ"}
                    </Button>
                </form>
            </CardContent>
        </Card>
    );
}


// --- ĞÑĞ½Ğ¾Ğ²Ğ½Ğ¾Ğ¹ ĞºĞ¾Ğ¼Ğ¿Ğ¾Ğ½ĞµĞ½Ñ‚ HolidayManager ---
export default function HolidayManager() {
    const [month, setMonth] = useState(new Date());
    const [description, setDescription] = useState("");
    const [conflict, setConflict] = useState<ConflictInfo | null>(null);

    const startDate = startOfMonth(month);
    const endDate = endOfMonth(month);

    const { data: holidays = [], isLoading: isLoadingHolidays } = useHolidays(startDate, endDate);
    const createMutation = useCreateHoliday();
    const deleteMutation = useDeleteHoliday();

    const { data: rules = [], isLoading: isLoadingRules } = useGetHolidayRules();
    const deleteRuleMutation = useDeleteHolidayRule();

    const holidayDates = useMemo(() => holidays.map((h: HolidayWithDate) => h.date), [holidays]);
    const holidaySet = useMemo(() => new Set(holidays.map((h: HolidayWithDate) => format(h.date, "yyyy-MM-dd"))), [holidays]);

    const handleDaySelect = (day: Date | undefined) => {
        if (!day) return;

        if (holidaySet.has(format(day, "yyyy-MM-dd"))) {
            toast.info("Ğ­Ñ‚Ğ¾Ñ‚ Ğ´ĞµĞ½ÑŒ ÑƒĞ¶Ğµ ÑĞ²Ğ»ÑĞµÑ‚ÑÑ Ğ²Ñ‹Ñ…Ğ¾Ğ´Ğ½Ñ‹Ğ¼.");
            return;
        }

        createMutation.mutate({
            date: format(day, "yyyy-MM-dd"),
            description: description || undefined,
        }, {
            onError: (error: any) => {
                if (error.response?.status === 409) {
                    setConflict({
                        date: day,
                        description: description,
                        conflicting_reservation_ids: error.response.data.detail.conflicting_reservation_ids,
                    });
                }
            },
            onSuccess: () => setDescription("")
        });
    };

    const handleForceCreate = () => {
        if (!conflict) return;
        createMutation.mutate(
            { date: format(conflict.date, "yyyy-MM-dd"), description: conflict.description, force: true },
            { onSuccess: () => setConflict(null) }
        );
    };

    const handleDeleteHoliday = (date: Date) => {
        if (window.confirm(`Ğ’Ñ‹ ÑƒĞ²ĞµÑ€ĞµĞ½Ñ‹, Ñ‡Ñ‚Ğ¾ Ñ…Ğ¾Ñ‚Ğ¸Ñ‚Ğµ ÑƒĞ´Ğ°Ğ»Ğ¸Ñ‚ÑŒ Ğ²Ñ‹Ñ…Ğ¾Ğ´Ğ½Ğ¾Ğ¹ ${format(date, 'dd.MM.yyyy')}?`)) {
            deleteMutation.mutate(date);
        }
    };

    const handleDeleteRule = (ruleId: number) => {
        if (window.confirm(`Ğ’Ñ‹ ÑƒĞ²ĞµÑ€ĞµĞ½Ñ‹, Ñ‡Ñ‚Ğ¾ Ñ…Ğ¾Ñ‚Ğ¸Ñ‚Ğµ ÑƒĞ´Ğ°Ğ»Ğ¸Ñ‚ÑŒ ÑÑ‚Ğ¾ Ğ¿Ñ€Ğ°Ğ²Ğ¸Ğ»Ğ¾ Ğ¸ Ğ²ÑĞµ ÑĞ¾Ğ·Ğ´Ğ°Ğ½Ğ½Ñ‹Ğµ Ğ¸Ğ¼ Ğ±ÑƒĞ´ÑƒÑ‰Ğ¸Ğµ Ğ²Ñ‹Ñ…Ğ¾Ğ´Ğ½Ñ‹Ğµ?`)) {
            deleteRuleMutation.mutate(ruleId);
        }
    };

    const isLoading = isLoadingHolidays || isLoadingRules;

    return (
        <div className="space-y-6">

            <div className="space-y-4">
                <WeeklyRuleForm isLoading={isLoading} />
                <PublicHolidayImportForm isLoading={isLoading} />
            </div>

            <Card>
                <CardHeader>
                    <CardTitle className="flex items-center gap-2"><CalendarPlus className="w-5 h-5" /> Ğ ÑƒÑ‡Ğ½Ğ¾Ğµ ÑƒĞ¿Ñ€Ğ°Ğ²Ğ»ĞµĞ½Ğ¸Ğµ</CardTitle>
                    <CardDescription>Ğ’Ñ‹Ğ±ĞµÑ€Ğ¸Ñ‚Ğµ Ğ´Ğ°Ñ‚Ñƒ Ğ² ĞºĞ°Ğ»ĞµĞ½Ğ´Ğ°Ñ€Ğµ, Ñ‡Ñ‚Ğ¾Ğ±Ñ‹ ÑĞ´ĞµĞ»Ğ°Ñ‚ÑŒ ĞµĞµ Ğ²Ñ‹Ñ…Ğ¾Ğ´Ğ½Ñ‹Ğ¼, Ğ¸Ğ»Ğ¸ ÑƒĞ´Ğ°Ğ»Ğ¸Ñ‚Ğµ ÑÑƒÑ‰ĞµÑÑ‚Ğ²ÑƒÑÑ‰Ğ¸Ğ¹.</CardDescription>
                </CardHeader>
                <CardContent className="grid grid-cols-1 md:grid-cols-2 gap-8">
                    <div>
                        <div className="space-y-2 mb-4">
                            <Label htmlFor="holiday-desc">ĞĞ°Ğ·Ğ²Ğ°Ğ½Ğ¸Ğµ (Ğ½ĞµĞ¾Ğ±ÑĞ·Ğ°Ñ‚ĞµĞ»ÑŒĞ½Ğ¾)</Label>
                            <Input id="holiday-desc" placeholder="ĞĞ°Ğ¿Ñ€Ğ¸Ğ¼ĞµÑ€, ĞšĞ¾Ñ€Ğ¿Ğ¾Ñ€Ğ°Ñ‚Ğ¸Ğ²" value={description} onChange={(e) => setDescription(e.target.value)} />
                        </div>
                        <div className="flex justify-center border rounded-md p-2">
                            <DayPicker
                                mode="single" locale={ru} month={month} onMonthChange={setMonth}
                                onSelect={handleDaySelect} modifiers={{ holidays: holidayDates }}
                                modifiersClassNames={{ holidays: 'bg-red-100 text-red-800 rounded-md' }}
                                footer={isLoadingHolidays ? <p className="text-center text-sm p-2">Ğ—Ğ°Ğ³Ñ€ÑƒĞ·ĞºĞ°...</p> : <p className="text-center text-sm p-2">Ğ’Ñ‹Ğ±Ñ€Ğ°Ğ½ Ğ¼ĞµÑÑÑ†: {format(month, "LLLL yyyy", { locale: ru })}</p>}
                            />
                        </div>
                    </div>
                    <div>
                        <h3 className="text-md font-semibold mb-4">Ğ’Ñ‹Ñ…Ğ¾Ğ´Ğ½Ñ‹Ğµ Ğ² ÑÑ‚Ğ¾Ğ¼ Ğ¼ĞµÑÑÑ†Ğµ:</h3>
                        {holidays.length > 0 ? (
                            <div className="space-y-2 max-h-96 overflow-y-auto pr-2">
                                {holidays.map((holiday: HolidayWithDate) => (
                                    <div key={holiday.date.toString()} className="flex items-center justify-between p-2 bg-gray-50 rounded-md">
                                        <div>
                                            <span className="font-medium">{format(holiday.date, 'PPP', { locale: ru })}</span>
                                            {holiday.description && <span className="text-gray-600 text-sm ml-2">- {holiday.description}</span>}
                                        </div>
                                        <Button variant="ghost" size="icon" onClick={() => handleDeleteHoliday(holiday.date)} disabled={deleteMutation.isPending}><Trash2 className="h-4 w-4 text-red-500" /></Button>
                                    </div>
                                ))}
                            </div>
                        ) : (<p className="text-sm text-gray-500">Ğ’ ÑÑ‚Ğ¾Ğ¼ Ğ¼ĞµÑÑÑ†Ğµ Ğ²Ñ‹Ñ…Ğ¾Ğ´Ğ½Ñ‹Ğµ Ğ½Ğµ Ğ½Ğ°Ğ·Ğ½Ğ°Ñ‡ĞµĞ½Ñ‹.</p>)}
                    </div>
                </CardContent>
            </Card>

            <Card>
                <CardHeader>
                    <CardTitle>ĞĞºÑ‚Ğ¸Ğ²Ğ½Ñ‹Ğµ Ğ¿Ñ€Ğ°Ğ²Ğ¸Ğ»Ğ° Ğ°Ğ²Ñ‚Ğ¾Ğ¼Ğ°Ñ‚Ğ¸Ğ·Ğ°Ñ†Ğ¸Ğ¸</CardTitle>
                </CardHeader>
                <CardContent>
                    <Table>
                        <TableHeader>
                            <TableRow>
                                <TableHead>ĞĞ¿Ğ¸ÑĞ°Ğ½Ğ¸Ğµ</TableHead>
                                <TableHead>Ğ¢Ğ¸Ğ¿</TableHead>
                                <TableHead>Ğ”Ğ°Ñ‚Ğ° ÑĞ¾Ğ·Ğ´Ğ°Ğ½Ğ¸Ñ</TableHead>
                                <TableHead className="text-right">Ğ”ĞµĞ¹ÑÑ‚Ğ²Ğ¸Ñ</TableHead>
                            </TableRow>
                        </TableHeader>
                        <TableBody>
                            {isLoadingRules ? <TableRow><TableCell colSpan={4} className="text-center">Ğ—Ğ°Ğ³Ñ€ÑƒĞ·ĞºĞ° Ğ¿Ñ€Ğ°Ğ²Ğ¸Ğ»...</TableCell></TableRow> :
                                rules.length === 0 ? <TableRow><TableCell colSpan={4} className="text-center">ĞĞµÑ‚ Ğ°ĞºÑ‚Ğ¸Ğ²Ğ½Ñ‹Ñ… Ğ¿Ñ€Ğ°Ğ²Ğ¸Ğ».</TableCell></TableRow> :
                                    rules.map(rule => (
                                        <TableRow key={rule.id}>
                                            <TableCell>{rule.description}</TableCell>
                                            <TableCell><span className="text-xs font-mono bg-slate-100 px-2 py-1 rounded">{rule.rule_type}</span></TableCell>
                                            <TableCell>{format(new Date(rule.created_at), 'dd.MM.yyyy HH:mm')}</TableCell>
                                            <TableCell className="text-right">
                                                <Button variant="ghost" size="icon" onClick={() => handleDeleteRule(rule.id)} disabled={deleteRuleMutation.isPending}><Trash2 className="h-4 w-4 text-red-500" /></Button>
                                            </TableCell>
                                        </TableRow>
                                    ))}
                        </TableBody>
                    </Table>
                </CardContent>
            </Card>

            <Dialog open={!!conflict} onOpenChange={() => setConflict(null)}>
                <DialogContent>
                    <DialogHeader>
                        <DialogTitle>ĞĞ±Ğ½Ğ°Ñ€ÑƒĞ¶ĞµĞ½ ĞºĞ¾Ğ½Ñ„Ğ»Ğ¸ĞºÑ‚</DialogTitle>
                        <DialogDescription>
                            Ğ’Ñ‹Ğ±Ñ€Ğ°Ğ½Ğ½Ğ°Ñ Ğ´Ğ°Ñ‚Ğ° ÑĞ²Ğ»ÑĞµÑ‚ÑÑ Ğ´Ğ°Ñ‚Ğ¾Ğ¹ Ğ½Ğ°Ñ‡Ğ°Ğ»Ğ° Ğ¸Ğ»Ğ¸ Ğ¾ĞºĞ¾Ğ½Ñ‡Ğ°Ğ½Ğ¸Ñ Ğ´Ğ»Ñ ÑĞ»ĞµĞ´ÑƒÑÑ‰Ğ¸Ñ… Ñ€ĞµĞ·ĞµÑ€Ğ²Ğ¾Ğ²:
                            <strong className="block my-2">ID: {conflict?.conflicting_reservation_ids.join(', ')}</strong>
                            ĞĞ°Ğ·Ğ½Ğ°Ñ‡ĞµĞ½Ğ¸Ğµ ÑÑ‚Ğ¾Ğ³Ğ¾ Ğ´Ğ½Ñ Ğ²Ñ‹Ñ…Ğ¾Ğ´Ğ½Ñ‹Ğ¼ ÑĞ´ĞµĞ»Ğ°ĞµÑ‚ ÑÑ‚Ğ¸ Ñ€ĞµĞ·ĞµÑ€Ğ²Ñ‹ Ğ½ĞµĞºĞ¾Ñ€Ñ€ĞµĞºÑ‚Ğ½Ñ‹Ğ¼Ğ¸. Ğ’Ñ‹ ÑƒĞ²ĞµÑ€ĞµĞ½Ñ‹, Ñ‡Ñ‚Ğ¾ Ñ…Ğ¾Ñ‚Ğ¸Ñ‚Ğµ Ğ¿Ñ€Ğ¾Ğ´Ğ¾Ğ»Ğ¶Ğ¸Ñ‚ÑŒ?
                        </DialogDescription>
                    </DialogHeader>
                    <DialogFooter>
                        <Button variant="ghost" onClick={() => setConflict(null)}>ĞÑ‚Ğ¼ĞµĞ½Ğ°</Button>
                        <Button variant="destructive" onClick={handleForceCreate} disabled={createMutation.isPending}>
                            {createMutation.isPending ? "ĞĞ±Ñ€Ğ°Ğ±Ğ¾Ñ‚ĞºĞ°..." : "Ğ”Ğ°, Ğ²ÑĞµ Ñ€Ğ°Ğ²Ğ½Ğ¾ Ğ½Ğ°Ğ·Ğ½Ğ°Ñ‡Ğ¸Ñ‚ÑŒ"}
                        </Button>
                    </DialogFooter>
                </DialogContent>
            </Dialog>
        </div>
    );
}

```


## <a name="rentalappmainsrccomponentsadminPromoCodeDialogtsx"></a>`rental-app-main/src/components/admin/PromoCodeDialog.tsx`

```tsx
// path: rental-app-main/src/components/admin/PromoCodeDialog.tsx

// src/components/admin/PromoCodeDialog.tsx

import { useEffect, useMemo } from "react";
import { useForm, Controller } from "react-hook-form";
import { zodResolver } from "@hookform/resolvers/zod";
import { Button } from "@/components/ui/button";
import { Dialog, DialogContent, DialogHeader, DialogTitle, DialogFooter, DialogDescription } from "@/components/ui/dialog";
import { Input } from "@/components/ui/input";
import { Label } from "@/components/ui/label";
import { Switch } from "@/components/ui/switch";
import { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from "@/components/ui/select";
import { toast } from "sonner";
import { RefreshCw } from "lucide-react";

import { useCreatePromoCode, useUpdatePromoCode, fetchGeneratedPromoCode } from "@/hooks/useAdminPromoCodes";
import { useEquipment } from "@/hooks/useEquipment";
import { useAdminUsers } from "@/hooks/useAdminUsers";
import { useCurrentUser } from "@/hooks/useProfile";
import type { PromoCodeOut, PromoCodeCreate } from "@/types/promo_code";
import { promoCodeFormSchema, PromoCodeFormData } from "@/lib/validationSchemas";
import { MultiSelect } from "@/components/ui/multi-select";

interface Props {
    promoCode?: PromoCodeOut | null;
    open: boolean;
    onClose: () => void;
}

export function PromoCodeDialog({ promoCode, open, onClose }: Props) {
    const { data: user } = useCurrentUser();
    const createMutation = useCreatePromoCode();
    const updateMutation = useUpdatePromoCode();

    // +++ ĞĞĞ§ĞĞ›Ğ Ğ˜Ğ—ĞœĞ•ĞĞ•ĞĞ˜Ğ™ +++
    // 1. ĞŸĞ¾Ğ»ÑƒÑ‡Ğ°ĞµĞ¼ Ğ¾Ğ±ÑŠĞµĞºÑ‚ Ñ Ğ¿Ğ°Ğ³Ğ¸Ğ½Ğ°Ñ†Ğ¸ĞµĞ¹ Ğ¾Ñ‚ useInfiniteQuery
    const { data: equipmentPages } = useEquipment();
    const { data: usersResponse, isLoading: isLoadingUsers } = useAdminUsers();

    // 2. "Ğ Ğ°Ğ·Ğ²Ğ¾Ñ€Ğ°Ñ‡Ğ¸Ğ²Ğ°ĞµĞ¼" ÑÑ‚Ñ€Ğ°Ğ½Ğ¸Ñ†Ñ‹ Ğ² Ğ¾Ğ´Ğ¸Ğ½ Ğ¿Ğ»Ğ¾ÑĞºĞ¸Ğ¹ Ğ¼Ğ°ÑÑĞ¸Ğ² allEquipment
    const allEquipment = useMemo(() =>
            equipmentPages?.pages.flatMap(page => page.items) ?? [],
        [equipmentPages]);

    // 3. ĞĞ½Ğ°Ğ»Ğ¾Ğ³Ğ¸Ñ‡Ğ½Ğ¾ Ğ¿Ğ¾ÑÑ‚ÑƒĞ¿Ğ°ĞµĞ¼ Ñ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ÑĞ¼Ğ¸
    const users = useMemo(() => 
        usersResponse?.pages?.flatMap(page => page.items) ?? [], 
        [usersResponse]
    );
    // +++ ĞšĞĞĞ•Ğ¦ Ğ˜Ğ—ĞœĞ•ĞĞ•ĞĞ˜Ğ™ +++


    const {
        register,
        handleSubmit,
        control,
        reset,
        setValue,
        formState: { errors, isValid },
    } = useForm<PromoCodeFormData>({
        resolver: zodResolver(promoCodeFormSchema) as any,
        mode: "onChange",
    });

    useEffect(() => {
        if (open) {
            if (promoCode) {
                reset({
                    code: promoCode.code,
                    description: promoCode.description ?? undefined,
                    discount_percentage: promoCode.discount_percentage,
                    is_active: promoCode.is_active,
                    valid_from: promoCode.valid_from ? new Date(promoCode.valid_from) : undefined,
                    expires_at: promoCode.expires_at ? new Date(promoCode.expires_at) : undefined,
                    max_uses: promoCode.max_uses ?? undefined,
                    max_uses_per_user: promoCode.max_uses_per_user ?? undefined,
                    min_order_amount: promoCode.min_order_amount ?? undefined,
                    specific_to_user_id: promoCode.specific_to_user_id ?? undefined,
                    applicable_to_equipment_ids: promoCode.applicable_to_equipment_ids ?? [],
                    applicable_to_equipment_types: promoCode.applicable_to_equipment_types ?? [],
                });
            } else {
                reset({
                    code: "",
                    description: "",
                    discount_percentage: 10,
                    is_active: true,
                    max_uses_per_user: 1,
                    applicable_to_equipment_ids: [],
                    applicable_to_equipment_types: [],
                });
            }
        }
    }, [promoCode, open, reset]);

    const onSubmit = (data: PromoCodeFormData) => {
        const maxDiscount = user?.role === 'admin' ? 50 : 20;
        if (data.discount_percentage > maxDiscount) {
            toast.error(`ĞœĞ°ĞºÑĞ¸Ğ¼Ğ°Ğ»ÑŒĞ½Ğ°Ñ ÑĞºĞ¸Ğ´ĞºĞ° Ğ´Ğ»Ñ Ğ²Ğ°ÑˆĞµĞ¹ Ñ€Ğ¾Ğ»Ğ¸: ${maxDiscount}%`);
            return;
        }

        const payload = {
            ...data,
            valid_from: data.valid_from ? data.valid_from.toISOString() : null,
            expires_at: data.expires_at ? data.expires_at.toISOString() : null,
        };

        if (promoCode) {
            updateMutation.mutate({ id: promoCode.id, data: payload }, { onSuccess: onClose });
        } else {
            createMutation.mutate(payload as PromoCodeCreate, { onSuccess: onClose });
        }
    };

    const handleGenerateCode = async () => {
        const newCode = await fetchGeneratedPromoCode();
        if (newCode) {
            setValue("code", newCode, { shouldValidate: true, shouldDirty: true });
        }
    };

    const isLoading = createMutation.isPending || updateMutation.isPending;

    // +++ ĞĞĞ§ĞĞ›Ğ Ğ˜Ğ—ĞœĞ•ĞĞ•ĞĞ˜Ğ™: Ğ˜ÑĞ¿Ğ¾Ğ»ÑŒĞ·ÑƒĞµĞ¼ `allEquipment` Ğ²Ğ¼ĞµÑÑ‚Ğ¾ `equipments` +++
    const equipmentOptions = useMemo(() => allEquipment.map(e => ({ value: e.id.toString(), label: e.name })), [allEquipment]);
    const equipmentTypeOptions = useMemo(() => [...new Set(allEquipment.map(e => e.equipment_type))].map(type => ({ value: type, label: type })), [allEquipment]);
    // +++ ĞšĞĞĞ•Ğ¦ Ğ˜Ğ—ĞœĞ•ĞĞ•ĞĞ˜Ğ™ +++
    const userOptions = useMemo(() => users.map((u: any) => ({ value: u.id.toString(), label: `${u.full_name} (${u.email})` })), [users]);

    return (
        <Dialog open={open} onOpenChange={onClose}>
            <DialogContent className="sm:max-w-[700px] max-h-[90vh] overflow-y-auto">
                <DialogHeader>
                    <DialogTitle>{promoCode ? "Ğ ĞµĞ´Ğ°ĞºÑ‚Ğ¸Ñ€Ğ¾Ğ²Ğ°Ñ‚ÑŒ Ğ¿Ñ€Ğ¾Ğ¼Ğ¾ĞºĞ¾Ğ´" : "Ğ¡Ğ¾Ğ·Ğ´Ğ°Ñ‚ÑŒ Ğ½Ğ¾Ğ²Ñ‹Ğ¹ Ğ¿Ñ€Ğ¾Ğ¼Ğ¾ĞºĞ¾Ğ´"}</DialogTitle>
                    <DialogDescription>{promoCode ? `Ğ ĞµĞ´Ğ°ĞºÑ‚Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ "${promoCode.code}"` : "Ğ—Ğ°Ğ¿Ğ¾Ğ»Ğ½Ğ¸Ñ‚Ğµ Ğ´ĞµÑ‚Ğ°Ğ»Ğ¸ Ğ´Ğ»Ñ Ğ½Ğ¾Ğ²Ğ¾Ğ³Ğ¾ Ğ¿Ñ€Ğ¾Ğ¼Ğ¾ĞºĞ¾Ğ´Ğ°."}</DialogDescription>
                </DialogHeader>
                <form onSubmit={handleSubmit(onSubmit)} className="space-y-4 py-4 pr-2">
                    <div className="grid grid-cols-4 items-center gap-4">
                        <Label htmlFor="code" className="text-right">ĞšĞ¾Ğ´ *</Label>
                        <div className="col-span-3 flex items-center gap-2">
                            <Input id="code" {...register("code")} className="flex-grow" placeholder="SUMMER25"/>
                            <Button type="button" variant="outline" size="icon" onClick={handleGenerateCode} title="Ğ¡Ğ³ĞµĞ½ĞµÑ€Ğ¸Ñ€Ğ¾Ğ²Ğ°Ñ‚ÑŒ ĞºĞ¾Ğ´"><RefreshCw className="h-4 w-4" /></Button>
                        </div>
                        {errors.code && <p className="col-start-2 col-span-3 text-xs text-red-500 mt-1">{errors.code.message}</p>}
                    </div>

                    <div className="grid grid-cols-4 items-center gap-4">
                        <Label htmlFor="discount_percentage" className="text-right">Ğ¡ĞºĞ¸Ğ´ĞºĞ°, % *</Label>
                        <div className="col-span-3"><Input id="discount_percentage" type="number" {...register("discount_percentage")} /></div>
                        {errors.discount_percentage && <p className="col-start-2 col-span-3 text-xs text-red-500 mt-1">{errors.discount_percentage.message}</p>}
                    </div>

                    <div className="grid grid-cols-4 items-center gap-4">
                        <Label htmlFor="description" className="text-right">ĞĞ¿Ğ¸ÑĞ°Ğ½Ğ¸Ğµ</Label>
                        <div className="col-span-3"><Input id="description" {...register("description")} placeholder="Ğ”Ğ»Ñ Ğ²Ğ½ÑƒÑ‚Ñ€ĞµĞ½Ğ½ĞµĞ³Ğ¾ Ğ¸ÑĞ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ"/></div>
                    </div>

                    <div className="grid grid-cols-4 items-center gap-4">
                        <Label className="text-right">Ğ›Ğ¸Ğ¼Ğ¸Ñ‚Ñ‹</Label>
                        <div className="col-span-3 grid grid-cols-3 gap-2">
                            <Input type="number" {...register("max_uses")} placeholder="Ğ’ÑĞµĞ³Ğ¾"/>
                            <Input type="number" {...register("max_uses_per_user")} placeholder="ĞĞ° ÑĞ·ĞµÑ€Ğ°"/>
                            <Input type="number" {...register("min_order_amount")} placeholder="ĞœĞ¸Ğ½. ÑÑƒĞ¼Ğ¼Ğ° â‚½"/>
                        </div>
                    </div>

                    <div className="grid grid-cols-4 items-center gap-4">
                        <Label className="text-right">Ğ¡Ñ€Ğ¾Ğº Ğ´ĞµĞ¹ÑÑ‚Ğ²Ğ¸Ñ</Label>
                        <div className="col-span-3 grid grid-cols-2 gap-2">
                            <Controller control={control} name="valid_from" render={({ field }) => (<Input type="date" onChange={(e) => field.onChange(e.target.valueAsDate)} value={field.value ? field.value.toISOString().split('T')[0] : ''}/>)} />
                            <Controller control={control} name="expires_at" render={({ field }) => (<Input type="date" onChange={(e) => field.onChange(e.target.valueAsDate)} value={field.value ? field.value.toISOString().split('T')[0] : ''}/>)} />
                        </div>
                        {errors.expires_at && <p className="col-start-2 col-span-3 text-xs text-red-500 mt-1">{errors.expires_at.message}</p>}
                    </div>

                    <div className="grid grid-cols-4 items-center gap-4">
                        <Label className="text-right">Ğ”Ğ»Ñ Ñ‚Ğ¾Ğ²Ğ°Ñ€Ğ¾Ğ²</Label>
                        <div className="col-span-3">
                            <Controller control={control} name="applicable_to_equipment_ids" render={({ field }) => (<MultiSelect placeholder="Ğ”Ğ»Ñ Ğ²ÑĞµĞ³Ğ¾ Ğ¾Ğ±Ğ¾Ñ€ÑƒĞ´Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ" options={equipmentOptions} value={field.value?.map(String) || []} onValueChange={(selected) => field.onChange(selected.map(Number))} />)} />
                        </div>
                    </div>

                    <div className="grid grid-cols-4 items-center gap-4">
                        <Label className="text-right">Ğ”Ğ»Ñ Ñ‚Ğ¸Ğ¿Ğ¾Ğ²</Label>
                        <div className="col-span-3">
                            <Controller control={control} name="applicable_to_equipment_types" render={({ field }) => (<MultiSelect placeholder="Ğ”Ğ»Ñ Ğ²ÑĞµÑ… Ñ‚Ğ¸Ğ¿Ğ¾Ğ²" options={equipmentTypeOptions} value={field.value || []} onValueChange={field.onChange}/>)} />
                        </div>
                    </div>

                    <div className="grid grid-cols-4 items-center gap-4">
                        <Label className="text-right">Ğ”Ğ»Ñ ÑĞ·ĞµÑ€Ğ°</Label>
                        <div className="col-span-3">
                            <Controller control={control} name="specific_to_user_id"
                                        render={({ field }) => (
                                            <Select
                                                onValueChange={(value) => field.onChange(value === 'all' ? undefined : Number(value))}
                                                value={field.value?.toString()}
                                                disabled={isLoadingUsers}
                                            >
                                                <SelectTrigger><SelectValue placeholder="Ğ”Ğ»Ñ Ğ²ÑĞµÑ… Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ĞµĞ¹" /></SelectTrigger>
                                                <SelectContent>
                                                    <SelectItem value="all">Ğ”Ğ»Ñ Ğ²ÑĞµÑ… Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ĞµĞ¹</SelectItem>
                                                    {userOptions.map((opt: any) => <SelectItem key={opt.value} value={opt.value}>{opt.label}</SelectItem>)}
                                                </SelectContent>
                                            </Select>
                                        )}
                            />
                        </div>
                    </div>

                    <div className="grid grid-cols-4 items-center gap-4">
                        <Label className="text-right">Ğ¡Ñ‚Ğ°Ñ‚ÑƒÑ</Label>
                        <div className="col-span-3 flex items-center space-x-2">
                            <Controller control={control} name="is_active" render={({ field }) => (
                                <Switch id="is_active" checked={field.value} onCheckedChange={field.onChange} />
                            )} />
                            <Label htmlFor="is_active" className="font-normal cursor-pointer">ĞĞºÑ‚Ğ¸Ğ²ĞµĞ½</Label>
                        </div>
                    </div>

                    <DialogFooter>
                        <Button type="button" variant="ghost" onClick={onClose}>ĞÑ‚Ğ¼ĞµĞ½Ğ°</Button>
                        <Button type="submit" disabled={!isValid || isLoading}>
                            {isLoading ? "Ğ¡Ğ¾Ñ…Ñ€Ğ°Ğ½ĞµĞ½Ğ¸Ğµ..." : "Ğ¡Ğ¾Ñ…Ñ€Ğ°Ğ½Ğ¸Ñ‚ÑŒ"}
                        </Button>
                    </DialogFooter>
                </form>
            </DialogContent>
        </Dialog>
    );
}

```


## <a name="rentalappmainsrccomponentsadminPromoCodeTabletsx"></a>`rental-app-main/src/components/admin/PromoCodeTable.tsx`

```tsx
// path: rental-app-main/src/components/admin/PromoCodeTable.tsx

// src/components/admin/PromoCodeTable.tsx

import { useState } from "react";
import { useAdminPromoCodes, useDeletePromoCode } from "@/hooks/useAdminPromoCodes";
import { PromoCodeDialog } from "./PromoCodeDialog";
import type { PromoCodeOut } from "@/types/promo_code";
import { formatDateEuropean } from "@/lib/utils";

import { Button } from "@/components/ui/button";
import { Input } from "@/components/ui/input";
import { Badge } from "@/components/ui/badge";
import { Table, TableBody, TableCell, TableHead, TableHeader, TableRow } from "@/components/ui/table";
// âœ… Ğ£Ğ±Ñ€Ğ°Ğ½Ğ° Ğ¸ĞºĞ¾Ğ½ĞºĞ° AlertCircle
import { Plus, Edit, Trash2, Search, Ticket } from "lucide-react";

export default function PromoCodeTable() {
    const { data: promoCodes = [], isLoading, error } = useAdminPromoCodes();
    const deleteMutation = useDeletePromoCode();

    const [search, setSearch] = useState("");
    const [isDialogOpen, setDialogOpen] = useState(false);
    const [editingPromoCode, setEditingPromoCode] = useState<PromoCodeOut | null>(null);

    const filteredPromoCodes = promoCodes.filter(pc =>
        pc.code.toLowerCase().includes(search.toLowerCase()) ||
        pc.description?.toLowerCase().includes(search.toLowerCase())
    );

    const handleCreate = () => {
        setEditingPromoCode(null);
        setDialogOpen(true);
    };

    const handleEdit = (promoCode: PromoCodeOut) => {
        setEditingPromoCode(promoCode);
        setDialogOpen(true);
    };

    const handleDelete = (id: number) => {
        if (window.confirm("Ğ’Ñ‹ ÑƒĞ²ĞµÑ€ĞµĞ½Ñ‹, Ñ‡Ñ‚Ğ¾ Ñ…Ğ¾Ñ‚Ğ¸Ñ‚Ğµ ÑƒĞ´Ğ°Ğ»Ğ¸Ñ‚ÑŒ ÑÑ‚Ğ¾Ñ‚ Ğ¿Ñ€Ğ¾Ğ¼Ğ¾ĞºĞ¾Ğ´? Ğ”ĞµĞ¹ÑÑ‚Ğ²Ğ¸Ğµ Ğ½ĞµĞ¾Ğ±Ñ€Ğ°Ñ‚Ğ¸Ğ¼Ğ¾.")) {
            deleteMutation.mutate(id);
        }
    };

    if (isLoading) return <p className="text-center py-4">Ğ—Ğ°Ğ³Ñ€ÑƒĞ·ĞºĞ° Ğ¿Ñ€Ğ¾Ğ¼Ğ¾ĞºĞ¾Ğ´Ğ¾Ğ²...</p>;
    if (error) return <p className="text-center text-red-600 py-4">ĞÑˆĞ¸Ğ±ĞºĞ° Ğ·Ğ°Ğ³Ñ€ÑƒĞ·ĞºĞ¸ Ğ´Ğ°Ğ½Ğ½Ñ‹Ñ….</p>;

    return (
        <>
            <div className="flex flex-col sm:flex-row items-center justify-between gap-4 mb-4">
                <div className="relative w-full sm:max-w-xs">
                    <Search className="absolute left-3 top-2.5 h-4 w-4 text-muted-foreground" />
                    <Input
                        placeholder="ĞŸĞ¾Ğ¸ÑĞº Ğ¿Ğ¾ ĞºĞ¾Ğ´Ñƒ Ğ¸Ğ»Ğ¸ Ğ¾Ğ¿Ğ¸ÑĞ°Ğ½Ğ¸Ñ..."
                        value={search}
                        onChange={(e) => setSearch(e.target.value)}
                        className="pl-10"
                    />
                </div>
                <Button onClick={handleCreate} className="w-full sm:w-auto">
                    <Plus className="mr-2 h-4 w-4" /> Ğ”Ğ¾Ğ±Ğ°Ğ²Ğ¸Ñ‚ÑŒ Ğ¿Ñ€Ğ¾Ğ¼Ğ¾ĞºĞ¾Ğ´
                </Button>
            </div>

            {filteredPromoCodes.length > 0 ? (
                <div className="border rounded-md overflow-x-auto">
                    <Table>
                        <TableHeader>
                            <TableRow>
                                <TableHead>ĞšĞ¾Ğ´</TableHead>
                                <TableHead>Ğ¡ĞºĞ¸Ğ´ĞºĞ°</TableHead>
                                <TableHead>Ğ¡Ñ‚Ğ°Ñ‚ÑƒÑ</TableHead>
                                <TableHead>Ğ˜ÑĞ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ</TableHead>
                                <TableHead>Ğ¡Ñ€Ğ¾Ğº Ğ´ĞµĞ¹ÑÑ‚Ğ²Ğ¸Ñ</TableHead>
                                <TableHead className="text-right">Ğ”ĞµĞ¹ÑÑ‚Ğ²Ğ¸Ñ</TableHead>
                            </TableRow>
                        </TableHeader>
                        <TableBody>
                            {filteredPromoCodes.map((pc) => (
                                <TableRow key={pc.id}>
                                    <TableCell className="font-medium">{pc.code}</TableCell>
                                    <TableCell>{pc.discount_percentage}%</TableCell>
                                    <TableCell>
                                        <Badge variant={pc.is_active ? "default" : "secondary"}>
                                            {pc.is_active ? "ĞĞºÑ‚Ğ¸Ğ²ĞµĞ½" : "ĞĞµĞ°ĞºÑ‚Ğ¸Ğ²ĞµĞ½"}
                                        </Badge>
                                    </TableCell>
                                    <TableCell>
                                        {pc.times_used} / {pc.max_uses ?? 'âˆ'}
                                    </TableCell>
                                    <TableCell>
                                        {pc.expires_at ? formatDateEuropean(pc.expires_at) : 'Ğ‘ĞµÑÑÑ€Ğ¾Ñ‡Ğ½Ğ¾'}
                                    </TableCell>
                                    <TableCell className="text-right">
                                        <Button variant="ghost" size="icon" onClick={() => handleEdit(pc)}>
                                            <Edit className="h-4 w-4" />
                                        </Button>
                                        <Button variant="ghost" size="icon" onClick={() => handleDelete(pc.id)} disabled={deleteMutation.isPending}>
                                            <Trash2 className="h-4 w-4 text-red-500" />
                                        </Button>
                                    </TableCell>
                                </TableRow>
                            ))}
                        </TableBody>
                    </Table>
                </div>
            ) : (
                <div className="text-center py-12 px-4 border-2 border-dashed rounded-lg">
                    <Ticket className="w-16 h-16 text-gray-300 mx-auto mb-3" />
                    <h3 className="text-lg font-semibold text-gray-700">ĞŸÑ€Ğ¾Ğ¼Ğ¾ĞºĞ¾Ğ´Ñ‹ Ğ½Ğµ Ğ½Ğ°Ğ¹Ğ´ĞµĞ½Ñ‹</h3>
                    <p className="text-sm text-gray-500 mt-1">
                        {search ? "ĞŸĞ¾Ğ¿Ñ€Ğ¾Ğ±ÑƒĞ¹Ñ‚Ğµ Ğ¸Ğ·Ğ¼ĞµĞ½Ğ¸Ñ‚ÑŒ Ğ¿Ğ¾Ğ¸ÑĞºĞ¾Ğ²Ñ‹Ğ¹ Ğ·Ğ°Ğ¿Ñ€Ğ¾Ñ." : "Ğ”Ğ¾Ğ±Ğ°Ğ²ÑŒÑ‚Ğµ Ğ¿ĞµÑ€Ğ²Ñ‹Ğ¹ Ğ¿Ñ€Ğ¾Ğ¼Ğ¾ĞºĞ¾Ğ´, Ñ‡Ñ‚Ğ¾Ğ±Ñ‹ Ğ¾Ğ½ Ğ¿Ğ¾ÑĞ²Ğ¸Ğ»ÑÑ Ğ² ÑĞ¿Ğ¸ÑĞºĞµ."}
                    </p>
                </div>
            )}

            <PromoCodeDialog
                open={isDialogOpen}
                onClose={() => setDialogOpen(false)}
                promoCode={editingPromoCode}
            />
        </>
    );
}

```


## <a name="rentalappmainsrccomponentsadminRentalStatusBadgetsx"></a>`rental-app-main/src/components/admin/RentalStatusBadge.tsx`

```tsx
// path: rental-app-main/src/components/admin/RentalStatusBadge.tsx

// src/components/admin/RentalStatusBadge.tsx

import { Badge } from "@/components/ui/badge";

type RentalStatus = 'active' | 'overdue' | 'completed';

interface Props {
    status: RentalStatus;
}

export default function RentalStatusBadge({ status }: Props) {
    const statusConfig = {
        active: { text: "ĞĞºÑ‚Ğ¸Ğ²Ğ½Ğ°", className: "bg-green-100 text-green-800 border-green-200" },
        overdue: { text: "ĞŸÑ€Ğ¾ÑÑ€Ğ¾Ñ‡ĞµĞ½Ğ°", className: "bg-red-100 text-red-800 border-red-200" },
        completed: { text: "Ğ—Ğ°Ğ²ĞµÑ€ÑˆĞµĞ½Ğ°", className: "bg-gray-100 text-gray-800 border-gray-200" },
    };

    const config = statusConfig[status] || statusConfig.completed;

    return (
        <Badge variant="outline" className={`font-medium ${config.className}`}>
            {config.text}
        </Badge>
    );
}

```


## <a name="rentalappmainsrccomponentsadminReservationFinancialSummarytsx"></a>`rental-app-main/src/components/admin/ReservationFinancialSummary.tsx`

```tsx
// path: rental-app-main/src/components/admin/ReservationFinancialSummary.tsx

// src/components/admin/ReservationFinancialSummary.tsx

import { useMemo } from "react";
import { usePriceCalculator } from "@/hooks/reservation/usePriceCalculator";
import { AlertCircle, Loader2, ReceiptText } from "lucide-react";
import type { AdminReservationOut } from "@/types/reservation";
import type { Equipment } from "@/types/equipment"; // Ğ˜Ğ¼Ğ¿Ğ¾Ñ€Ñ‚Ğ¸Ñ€ÑƒĞµĞ¼ Ñ‚Ğ¸Ğ¿ Equipment

interface ReservationFinancialSummaryProps {
    reservation: AdminReservationOut;
    open: boolean;
    // +++ ĞĞĞ§ĞĞ›Ğ: ĞĞ¾Ğ²Ñ‹Ğµ Ğ¿Ñ€Ğ¾Ğ¿ÑÑ‹ Ğ´Ğ»Ñ Ğ¾Ñ‚Ğ¾Ğ±Ñ€Ğ°Ğ¶ĞµĞ½Ğ¸Ñ ĞºĞ¾Ğ½Ñ„Ğ»Ğ¸ĞºÑ‚Ğ¾Ğ² +++
    hasConflicts: boolean;
    conflictingItemIds: number[];
    isCheckingAvailability: boolean;
    equipmentMap: Map<number, Equipment>;
    // +++ ĞšĞĞĞ•Ğ¦: ĞĞ¾Ğ²Ñ‹Ğµ Ğ¿Ñ€Ğ¾Ğ¿ÑÑ‹ +++
}

export default function ReservationFinancialSummary({
                                                        reservation,
                                                        open,
                                                        hasConflicts,
                                                        conflictingItemIds,
                                                        isCheckingAvailability,
                                                        equipmentMap
                                                    }: ReservationFinancialSummaryProps) {

    const { newStartDate, newEndDate, newDateRangeIsValid } = useMemo(() => {
        const today = new Date();
        today.setHours(0, 0, 0, 0);

        const originalEndDate = new Date(reservation.end_date);

        return {
            newStartDate: today,
            newEndDate: originalEndDate,
            newDateRangeIsValid: originalEndDate > today,
        };
    }, [reservation]);

    const { data: priceDetails, isFetching: isCalculatingPrice, error: priceError } = usePriceCalculator({
        equipmentIds: reservation.equipment_ids || [],
        startDate: newStartDate!,
        endDate: newEndDate!,
        selectedAccessories: reservation.selected_accessories || {},
        promoCode: reservation.promo_code || undefined,
        enabled: open && newDateRangeIsValid,
    });

    const finalCost = priceDetails?.final_total ?? reservation.total_cost ?? 0;

    // +++ ĞŸĞ¾Ğ»ÑƒÑ‡Ğ°ĞµĞ¼ Ğ¸Ğ¼ĞµĞ½Ğ° ĞºĞ¾Ğ½Ñ„Ğ»Ğ¸ĞºÑ‚Ğ½Ğ¾Ğ³Ğ¾ Ğ¾Ğ±Ğ¾Ñ€ÑƒĞ´Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ +++
    const conflictingEquipmentNames = useMemo(() =>
            conflictingItemIds.map(id => equipmentMap.get(id)?.name).filter(Boolean).join(', '),
        [conflictingItemIds, equipmentMap]);

    return (
        <div className="p-3 bg-slate-50 border rounded-lg space-y-2">
            <h4 className="flex items-center gap-2 text-sm font-semibold text-gray-800">
                <ReceiptText className="w-5 h-5 text-sky-600" />
                Ğ¤Ğ¸Ğ½Ğ°Ğ½ÑĞ¾Ğ²Ğ°Ñ ÑĞ²Ğ¾Ğ´ĞºĞ°
            </h4>

            {(isCalculatingPrice || isCheckingAvailability) ? (
                <div className="flex items-center justify-center gap-2 text-sm text-gray-500 py-4">
                    <Loader2 className="h-4 w-4 animate-spin" />
                    {isCheckingAvailability ? "ĞŸÑ€Ğ¾Ğ²ĞµÑ€ĞºĞ° Ğ´Ğ¾ÑÑ‚ÑƒĞ¿Ğ½Ğ¾ÑÑ‚Ğ¸..." : "ĞŸĞµÑ€ĞµÑÑ‡ĞµÑ‚ ÑÑ‚Ğ¾Ğ¸Ğ¼Ğ¾ÑÑ‚Ğ¸..."}
                </div>
            ) : hasConflicts ? (
                // +++ ĞĞĞ§ĞĞ›Ğ: ĞĞ¾Ğ²Ñ‹Ğ¹ Ğ±Ğ»Ğ¾Ğº Ğ´Ğ»Ñ Ğ¾Ñ‚Ğ¾Ğ±Ñ€Ğ°Ğ¶ĞµĞ½Ğ¸Ñ Ğ¾ÑˆĞ¸Ğ±ĞºĞ¸ ĞºĞ¾Ğ½Ñ„Ğ»Ğ¸ĞºÑ‚Ğ° +++
                <div className="text-sm text-red-700 font-medium p-2 bg-red-100 border border-red-200 rounded-md space-y-1">
                    <div className="flex items-center gap-2">
                        <AlertCircle className="h-4 w-4" />
                        <span>ĞšĞ¾Ğ½Ñ„Ğ»Ğ¸ĞºÑ‚ Ğ±Ñ€Ğ¾Ğ½Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ!</span>
                    </div>
                    <p className="text-xs font-normal pl-6">
                        ĞĞ±Ğ¾Ñ€ÑƒĞ´Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ Ğ½ĞµĞ´Ğ¾ÑÑ‚ÑƒĞ¿Ğ½Ğ¾ Ğ² Ğ½Ğ¾Ğ²Ğ¾Ğ¼ Ğ¿ĞµÑ€Ğ¸Ğ¾Ğ´Ğµ: <strong>{conflictingEquipmentNames}</strong>.
                    </p>
                </div>
                // +++ ĞšĞĞĞ•Ğ¦: ĞĞ¾Ğ²Ñ‹Ğ¹ Ğ±Ğ»Ğ¾Ğº +++
            ) : priceError || !newDateRangeIsValid ? (
                <div className="flex items-center gap-2 text-sm text-red-600 font-medium p-2 bg-red-50 rounded-md">
                    <AlertCircle className="h-4 w-4" />
                    <span>{priceError ? "ĞĞµ ÑƒĞ´Ğ°Ğ»Ğ¾ÑÑŒ Ñ€Ğ°ÑÑÑ‡Ğ¸Ñ‚Ğ°Ñ‚ÑŒ Ñ†ĞµĞ½Ñƒ." : "ĞĞµĞ²Ğ¾Ğ·Ğ¼Ğ¾Ğ¶Ğ½Ğ¾ Ğ²Ñ‹Ğ´Ğ°Ñ‚ÑŒ: Ñ€ĞµĞ·ĞµÑ€Ğ² ÑƒĞ¶Ğµ Ğ·Ğ°ĞºĞ¾Ğ½Ñ‡Ğ¸Ğ»ÑÑ."}</span>
                </div>
            ) : (
                <div className="text-xs text-gray-700 space-y-1.5 border-t pt-2">
                    <div className="flex justify-between">
                        <span>ĞŸĞµÑ€Ğ¸Ğ¾Ğ´ Ñ€ĞµĞ·ĞµÑ€Ğ²Ğ°:</span>
                        <span className="font-medium">{new Date(reservation.start_date).toLocaleDateString()} - {new Date(reservation.end_date).toLocaleDateString()}</span>
                    </div>
                    <div className="flex justify-between">
                        <span>Ğ¡Ñ‚Ğ¾Ğ¸Ğ¼Ğ¾ÑÑ‚ÑŒ Ñ€ĞµĞ·ĞµÑ€Ğ²Ğ°:</span>
                        <span className="font-medium">{reservation.total_cost?.toLocaleString('ru-RU')} â‚½</span>
                    </div>
                    <hr className="border-dashed my-1"/>
                    <div className="flex justify-between">
                        <span>ĞĞ¾Ğ²Ñ‹Ğ¹ Ğ¿ĞµÑ€Ğ¸Ğ¾Ğ´ Ğ°Ñ€ĞµĞ½Ğ´Ñ‹:</span>
                        <span className="font-medium">{newStartDate?.toLocaleDateString()} - {newEndDate?.toLocaleDateString()}</span>
                    </div>
                    {priceDetails && (priceDetails.discount_amount > 0) && (
                        <div className="flex justify-between text-green-600">
                            <span>Ğ¡ĞºĞ¸Ğ´ĞºĞ° ({priceDetails.duration_discount_percentage}%):</span>
                            <span className="font-medium">- {priceDetails.discount_amount.toLocaleString('ru-RU')} â‚½</span>
                        </div>
                    )}
                    <div className="flex justify-between text-base font-bold pt-1 border-t mt-1">
                        <span>Ğ˜Ñ‚Ğ¾Ğ³Ğ¾ Ğº ÑĞ¿Ğ¸ÑĞ°Ğ½Ğ¸Ñ Ñ Ğ±Ğ°Ğ»Ğ°Ğ½ÑĞ°:</span>
                        <span className="text-sky-700">{finalCost.toLocaleString('ru-RU')} â‚½</span>
                    </div>
                </div>
            )}
        </div>
    );
}

```


## <a name="rentalappmainsrccomponentsadminReturnAccessoriesChecklisttsx"></a>`rental-app-main/src/components/admin/ReturnAccessoriesChecklist.tsx`

```tsx
// path: rental-app-main/src/components/admin/ReturnAccessoriesChecklist.tsx

// src/components/admin/ReturnAccessoriesChecklist.tsx

import { Label } from "@/components/ui/label";
import { Checkbox } from "@/components/ui/checkbox";
import type { AdminRentalOut } from "@/types/rental";
import type { Accessory } from "@/types/accessory";
import type { Equipment } from "@/types/equipment";

interface Props {
    rental: AdminRentalOut;
    accessoriesByEquipment: Record<number, Accessory[]>;
    checkedAccessories: Set<string>;
    handleToggleAccessory: (equipmentId: number, accessoryId: number) => void;
    totalAccessoriesCount: number;
}

export default function ReturnAccessoriesChecklist({
    rental,
    accessoriesByEquipment,
    checkedAccessories,
    handleToggleAccessory,
    totalAccessoriesCount,
}: Props) {
    if (totalAccessoriesCount === 0) {
        return null;
    }

    return (
        <div className="space-y-3 pt-3 border-t">
            <Label className="font-semibold">ĞŸĞ¾Ğ´Ñ‚Ğ²ĞµÑ€Ğ´Ğ¸Ñ‚Ğµ Ğ²Ğ¾Ğ·Ğ²Ñ€Ğ°Ñ‚ Ğ°ĞºÑĞµÑÑÑƒĞ°Ñ€Ğ¾Ğ²:</Label>
            <div className="space-y-2 max-h-48 overflow-y-auto rounded-md border p-3 bg-slate-50">
                {rental.equipment.map((eq: Equipment) => (
                    accessoriesByEquipment[eq.id] && (
                        <div key={eq.id}>
                            <p className="text-sm font-medium text-gray-700">{eq.name}</p>
                            <ul className="pl-4 mt-1 space-y-1">
                                {accessoriesByEquipment[eq.id].map((acc: Accessory) => {
                                    const key = `${eq.id}-${acc.id}`;
                                    return (
                                        <li key={key} className="flex items-center">
                                            <Checkbox
                                                id={key}
                                                checked={checkedAccessories.has(key)}
                                                onCheckedChange={() => handleToggleAccessory(eq.id, acc.id)}
                                            />
                                            <Label htmlFor={key} className="ml-2 text-sm font-normal cursor-pointer">
                                                {acc.name}
                                            </Label>
                                        </li>
                                    );
                                })}
                            </ul>
                        </div>
                    )
                ))}
            </div>
        </div>
    );
}


```


## <a name="rentalappmainsrccomponentsadminReturnFinancialstsx"></a>`rental-app-main/src/components/admin/ReturnFinancials.tsx`

```tsx
// path: rental-app-main/src/components/admin/ReturnFinancials.tsx

// src/components/admin/ReturnFinancials.tsx

import { Button } from "@/components/ui/button";
import { Label } from "@/components/ui/label";
import { Input } from "@/components/ui/input";
import { Textarea } from "@/components/ui/textarea";
import type { AdminRentalOut } from "@/types/rental";

interface Props {
    rental: AdminRentalOut;
    dynamicRemainingAmount: number;
    paymentAmount: string;
    setPaymentAmount: (value: string) => void;
    paymentDescription: string;
    setPaymentDescription: (value: string) => void;
    paymentApplied: boolean;
    handleApplyPayment: () => void;
    handleCancelPayment: () => void;
    isApplyingPayment: boolean;
    handleAutoFillPayment: () => void;
    overdueSurcharge?: number;
}

export default function ReturnFinancials({
    rental,
    dynamicRemainingAmount,
    paymentAmount,
    setPaymentAmount,
    paymentDescription,
    setPaymentDescription,
    paymentApplied,
    handleApplyPayment,
    handleCancelPayment,
    isApplyingPayment,
    handleAutoFillPayment,
    overdueSurcharge,
}: Props) {
    return (
        <div className="space-y-4 pt-3 border-t">
            <Label className="font-semibold text-base">Ğ¤Ğ¸Ğ½Ğ°Ğ½ÑĞ¾Ğ²Ğ°Ñ Ğ¸Ğ½Ñ„Ğ¾Ñ€Ğ¼Ğ°Ñ†Ğ¸Ñ</Label>
            
            {/* Ğ˜Ğ½Ñ„Ğ¾Ñ€Ğ¼Ğ°Ñ†Ğ¸Ğ¾Ğ½Ğ½Ñ‹Ğµ Ğ¿Ğ¾Ğ»Ñ */}
            <div className="space-y-2 bg-slate-50 p-3 rounded-md">
                <div className="flex justify-between">
                    <span className="text-sm text-gray-600">Ğ¢ĞµĞºÑƒÑ‰Ğ¸Ğ¹ Ğ±Ğ°Ğ»Ğ°Ğ½Ñ ĞºĞ»Ğ¸ĞµĞ½Ñ‚Ğ°:</span>
                    <span className="font-medium">{(rental.user.balance || 0).toLocaleString()} â‚½</span>
                </div>
                <div className="flex justify-between">
                    <span className="text-sm text-gray-600">Ğ¡Ñ‚Ğ¾Ğ¸Ğ¼Ğ¾ÑÑ‚ÑŒ Ğ°Ñ€ĞµĞ½Ğ´Ñ‹:</span>
                    <span className="font-medium">{rental.total_cost.toLocaleString()} â‚½</span>
                </div>
                <div className="flex justify-between">
                    <span className="text-sm text-gray-600">Ğ’Ğ½ĞµÑĞµĞ½Ğ½Ğ°Ñ Ğ¿Ñ€ĞµĞ´Ğ¾Ğ¿Ğ»Ğ°Ñ‚Ğ°:</span>
                    <span className="font-medium">{rental.prepayment_amount.toLocaleString()} â‚½</span>
                </div>
                <div className="flex justify-between">
                    <span className="text-sm text-gray-600">ĞÑÑ‚Ğ°Ñ‚Ğ¾Ğº Ğº Ğ¾Ğ¿Ğ»Ğ°Ñ‚Ğµ:</span>
                    <span className={`font-medium ${dynamicRemainingAmount > 0 ? 'text-red-600' : 'text-green-600'}`}>
                        {dynamicRemainingAmount.toLocaleString()} â‚½
                    </span>
                </div>
                <div className="flex justify-between">
                    <span className="text-sm text-gray-600">Ğ’Ğ½ĞµÑĞµĞ½Ğ½Ñ‹Ğ¹ Ğ·Ğ°Ğ»Ğ¾Ğ³:</span>
                    <span className="font-medium">{rental.deposit_amount.toLocaleString()} â‚½</span>
                </div>
                {overdueSurcharge && overdueSurcharge > 0 && (
                    <div className="flex justify-between text-red-600 font-semibold pt-2 border-t border-dashed">
                        <span>Ğ¨Ñ‚Ñ€Ğ°Ñ„ Ğ·Ğ° Ğ¿Ñ€Ğ¾ÑÑ€Ğ¾Ñ‡ĞºÑƒ:</span>
                        <span>+ {overdueSurcharge.toLocaleString()} â‚½</span>
                    </div>
                )}
            </div>

            {/* ĞŸĞ¾Ğ»Ñ Ğ´Ğ»Ñ Ğ¿Ğ»Ğ°Ñ‚ĞµĞ¶Ğ° */}
            <div className="space-y-3">
                <div>
                    <div className="flex items-center justify-between mb-1">
                        <Label htmlFor="payment_amount">Ğ¡ÑƒĞ¼Ğ¼Ğ° Ğ¿Ğ»Ğ°Ñ‚ĞµĞ¶Ğ°</Label>
                        {!paymentApplied && dynamicRemainingAmount > 0 && (
                            <Button
                                type="button"
                                variant="ghost"
                                size="sm"
                                onClick={handleAutoFillPayment}
                                className="text-xs h-6 px-2"
                            >
                                Ğ—Ğ°Ğ¿Ğ¾Ğ»Ğ½Ğ¸Ñ‚ÑŒ Ğ¾ÑÑ‚Ğ°Ñ‚Ğ¾Ğº
                            </Button>
                        )}
                    </div>
                    <Input
                        id="payment_amount"
                        type="number"
                        value={paymentAmount}
                        onChange={(e) => setPaymentAmount(e.target.value)}
                        placeholder="Ğ’Ğ²ĞµĞ´Ğ¸Ñ‚Ğµ ÑÑƒĞ¼Ğ¼Ñƒ"
                        disabled={paymentApplied}
                        className={paymentApplied ? "bg-green-50 border-green-200" : ""}
                    />
                    {paymentApplied && (
                        <p className="text-xs text-green-600 mt-1 flex items-center">
                            <span className="mr-1">âœ“</span>
                            ĞŸĞ»Ğ°Ñ‚ĞµĞ¶ ÑƒÑ‡Ñ‚ĞµĞ½
                        </p>
                    )}
                </div>
                
                <div>
                    <Label htmlFor="payment_description">ĞĞ¿Ğ¸ÑĞ°Ğ½Ğ¸Ğµ Ğ¿Ğ»Ğ°Ñ‚ĞµĞ¶Ğ°</Label>
                    <Textarea
                        id="payment_description"
                        value={paymentDescription}
                        onChange={(e) => setPaymentDescription(e.target.value)}
                        placeholder="ĞĞ°Ğ¿Ñ€Ğ¸Ğ¼ĞµÑ€: Ğ§Ğ°ÑÑ‚Ğ¸Ñ‡Ğ½Ğ°Ñ Ğ¾Ğ¿Ğ»Ğ°Ñ‚Ğ° Ğ¿Ñ€Ğ¸ Ğ²Ğ¾Ğ·Ğ²Ñ€Ğ°Ñ‚Ğµ"
                        disabled={paymentApplied}
                        className={paymentApplied ? "bg-green-50 border-green-200" : ""}
                    />
                </div>

                {/* ĞšĞ½Ğ¾Ğ¿ĞºĞ¸ ÑƒĞ¿Ñ€Ğ°Ğ²Ğ»ĞµĞ½Ğ¸Ñ Ğ¿Ğ»Ğ°Ñ‚ĞµĞ¶Ğ¾Ğ¼ */}
                <div className="flex gap-2">
                    <Button
                        type="button"
                        variant="outline"
                        onClick={handleApplyPayment}
                        disabled={!paymentAmount || paymentApplied || isApplyingPayment}
                        className="flex-1"
                    >
                        {isApplyingPayment ? "ĞĞ±Ñ€Ğ°Ğ±Ğ¾Ñ‚ĞºĞ°..." : "Ğ’Ğ½ĞµÑÑ‚Ğ¸ Ğ¿Ğ»Ğ°Ñ‚ĞµĞ¶"}
                    </Button>
                    
                    {paymentApplied && (
                        <Button
                            type="button"
                            variant="destructive"
                            onClick={handleCancelPayment}
                            className="flex-1"
                        >
                            ĞÑ‚Ğ¼ĞµĞ½Ğ¸Ñ‚ÑŒ Ğ¿Ğ»Ğ°Ñ‚ĞµĞ¶
                        </Button>
                    )}
                </div>
            </div>
        </div>
    );
}


```


## <a name="rentalappmainsrccomponentsadminReturnRentalDialogtsx"></a>`rental-app-main/src/components/admin/ReturnRentalDialog.tsx`

```tsx
// path: rental-app-main/src/components/admin/ReturnRentalDialog.tsx

// src/components/admin/ReturnRentalDialog.tsx

import { Dialog, DialogContent, DialogHeader, DialogTitle, DialogFooter, DialogDescription } from "@/components/ui/dialog";
import { Button } from "@/components/ui/button";
import { Label } from "@/components/ui/label";
import { Input } from "@/components/ui/input";
import { Textarea } from "@/components/ui/textarea";
import type { AdminRentalOut } from "@/types/rental";
import { useRentalReturnForm } from "@/hooks/admin/useRentalReturnForm";
import ReturnFinancials from "./ReturnFinancials";
import ReturnAccessoriesChecklist from "./ReturnAccessoriesChecklist";

interface Props {
    rental: AdminRentalOut | null;
    open: boolean;
    onClose: () => void;
}

export default function ReturnRentalDialog({ rental, open, onClose }: Props) {
    const {
        // Ğ¡Ğ¾ÑÑ‚Ğ¾ÑĞ½Ğ¸Ñ
        paymentAmount,
        setPaymentAmount,
        paymentDescription,
        setPaymentDescription,
        paymentApplied,
        checkedAccessories,
        dynamicRemainingAmount,
        
        // Ğ¤ÑƒĞ½ĞºÑ†Ğ¸Ğ¸-Ğ¾Ğ±Ñ€Ğ°Ğ±Ğ¾Ñ‚Ñ‡Ğ¸ĞºĞ¸
        handleApplyPayment,
        handleCancelPayment,
        handleToggleAccessory,
        handleAutoFillPayment,
        onSubmit,
        
        // Ğ¡Ğ¾ÑÑ‚Ğ¾ÑĞ½Ğ¸Ñ Ğ¼ÑƒÑ‚Ğ°Ñ†Ğ¸Ğ¹
        isSubmittingReturn,
        isApplyingPayment,
        
        // Ğ”Ğ°Ğ½Ğ½Ñ‹Ğµ Ñ„Ğ¾Ñ€Ğ¼Ñ‹ Ğ¾Ñ‚ react-hook-form
        register,
        handleSubmit,
        formState: { errors, isValid },
        
        // Ğ”Ñ€ÑƒĞ³Ğ¸Ğµ Ğ²Ñ‹Ñ‡Ğ¸ÑĞ»ÑĞµĞ¼Ñ‹Ğµ Ğ·Ğ½Ğ°Ñ‡ĞµĞ½Ğ¸Ñ
        accessoriesByEquipment,
        allAccessoriesChecked,
        totalAccessoriesCount,
    } = useRentalReturnForm({ rental, onClose });

    if (!rental) return null;

    return (
        <Dialog open={open} onOpenChange={onClose}>
            <DialogContent>
                <DialogHeader>
                    <DialogTitle>ĞÑ„Ğ¾Ñ€Ğ¼Ğ»ĞµĞ½Ğ¸Ğµ Ğ²Ğ¾Ğ·Ğ²Ñ€Ğ°Ñ‚Ğ° Ğ°Ñ€ĞµĞ½Ğ´Ñ‹ #{rental.id}</DialogTitle>
                    <DialogDescription>
                        ĞŸĞ¾Ğ´Ñ‚Ğ²ĞµÑ€Ğ´Ğ¸Ñ‚Ğµ Ğ²Ğ¾Ğ·Ğ²Ñ€Ğ°Ñ‚ Ğ¾Ñ‚ ĞºĞ»Ğ¸ĞµĞ½Ñ‚Ğ°: <strong>{rental.user.full_name}</strong>.
                    </DialogDescription>
                </DialogHeader>
                <form onSubmit={handleSubmit(onSubmit)} className="space-y-4 py-2">
                    <div>
                        <Label htmlFor="actual_return_date">Ğ¤Ğ°ĞºÑ‚Ğ¸Ñ‡ĞµÑĞºĞ°Ñ Ğ´Ğ°Ñ‚Ğ° Ğ²Ğ¾Ğ·Ğ²Ñ€Ğ°Ñ‚Ğ° *</Label>
                        <Input
                            id="actual_return_date"
                            type="date"
                            {...register("actual_return_date")}
                        />
                        {errors.actual_return_date && <p className="text-xs text-red-600 mt-1">{errors.actual_return_date.message}</p>}
                    </div>
                    <div>
                        <Label htmlFor="notes_on_return">Ğ—Ğ°Ğ¼ĞµÑ‚ĞºĞ¸ Ğ¿Ñ€Ğ¸ Ğ²Ğ¾Ğ·Ğ²Ñ€Ğ°Ñ‚Ğµ</Label>
                        <Textarea
                            id="notes_on_return"
                            {...register("notes_on_return")}
                            placeholder="ĞĞ°Ğ¿Ñ€Ğ¸Ğ¼ĞµÑ€: Ğ¾Ğ±Ğ¾Ñ€ÑƒĞ´Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ Ñ‡Ğ¸ÑÑ‚Ğ¾Ğµ, ĞºĞ¾Ğ¼Ğ¿Ğ»ĞµĞºÑ‚Ğ°Ñ†Ğ¸Ñ Ğ¿Ğ¾Ğ»Ğ½Ğ°Ñ..."
                        />
                    </div>

                    {/* Ğ¤Ğ¸Ğ½Ğ°Ğ½ÑĞ¾Ğ²Ñ‹Ğ¹ Ğ±Ğ»Ğ¾Ğº */}
                    <ReturnFinancials
                        rental={rental}
                        dynamicRemainingAmount={dynamicRemainingAmount}
                        paymentAmount={paymentAmount}
                        setPaymentAmount={setPaymentAmount}
                        paymentDescription={paymentDescription}
                        setPaymentDescription={setPaymentDescription}
                        paymentApplied={paymentApplied}
                        handleApplyPayment={handleApplyPayment}
                        handleCancelPayment={handleCancelPayment}
                        isApplyingPayment={isApplyingPayment}
                        handleAutoFillPayment={handleAutoFillPayment}
                        overdueSurcharge={rental.overdue_surcharge || undefined}
                    />

                    {/* Ğ¡Ğ¿Ğ¸ÑĞ¾Ğº Ğ°ĞºÑĞµÑÑÑƒĞ°Ñ€Ğ¾Ğ² */}
                    <ReturnAccessoriesChecklist
                        rental={rental}
                        accessoriesByEquipment={accessoriesByEquipment}
                        checkedAccessories={checkedAccessories}
                        handleToggleAccessory={handleToggleAccessory}
                        totalAccessoriesCount={totalAccessoriesCount}
                    />

                    <DialogFooter>
                        <Button type="button" variant="ghost" onClick={onClose}>ĞÑ‚Ğ¼ĞµĞ½Ğ°</Button>
                        <Button
                            type="submit"
                            disabled={!isValid || isSubmittingReturn || (totalAccessoriesCount > 0 && !allAccessoriesChecked)}
                        >
                            {isSubmittingReturn ? "ĞĞ±Ñ€Ğ°Ğ±Ğ¾Ñ‚ĞºĞ°..." : "ĞŸĞ¾Ğ´Ñ‚Ğ²ĞµÑ€Ğ´Ğ¸Ñ‚ÑŒ Ğ²Ğ¾Ğ·Ğ²Ñ€Ğ°Ñ‚"}
                        </Button>
                    </DialogFooter>
                </form>
            </DialogContent>
        </Dialog>
    );
}

```


## <a name="rentalappmainsrccomponentsadminUserCreateDialogtsx"></a>`rental-app-main/src/components/admin/UserCreateDialog.tsx`

```tsx
// path: rental-app-main/src/components/admin/UserCreateDialog.tsx

// src/components/admin/UserCreateDialog.tsx

import { useForm, Controller } from "react-hook-form";
import { zodResolver } from "@hookform/resolvers/zod";
import { adminUserCreateFormSchema, type AdminUserCreateFormSchema } from "@/lib/validationSchemas";
import { useAdminCreateUser } from "@/hooks/useAdminUsers";
import { USER_ROLE_OPTIONS, USER_ROLES } from "@/constants/userConstants";

import { Button } from "@/components/ui/button";
import { Input } from "@/components/ui/input";
import { Label } from "@/components/ui/label";
import { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from "@/components/ui/select";
import { Dialog, DialogContent, DialogHeader, DialogTitle, DialogFooter, DialogDescription } from "@/components/ui/dialog";
import { PhoneInput } from "@/components/ui/phone-input";

interface Props {
    open: boolean;
    onClose: () => void;
}

export function UserCreateDialog({ open, onClose }: Props) {
    const createMutation = useAdminCreateUser();
    const { register, handleSubmit, formState: { errors, isValid }, reset, control } = useForm<AdminUserCreateFormSchema>({
        resolver: zodResolver(adminUserCreateFormSchema),
        mode: "onChange",
        defaultValues: {
            role: USER_ROLES.USER,
            privacyPolicyAccepted: true,
            termsAccepted: true,
            emailVerified: true,
        }
    });

    const onSubmit = (data: AdminUserCreateFormSchema) => {
        createMutation.mutate(data, {
            onSuccess: () => {
                reset();
                onClose();
            },
        });
    };

    const handleDialogClose = () => {
        reset();
        onClose();
    }

    return (
        <Dialog open={open} onOpenChange={handleDialogClose}>
            <DialogContent>
                <DialogHeader>
                    <DialogTitle>ĞĞ¾Ğ²Ñ‹Ğ¹ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ÑŒ</DialogTitle>
                    <DialogDescription>
                        Ğ¡Ğ¾Ğ·Ğ´Ğ°Ğ½Ğ¸Ğµ Ğ½Ğ¾Ğ²Ğ¾Ğ¹ ÑƒÑ‡ĞµÑ‚Ğ½Ğ¾Ğ¹ Ğ·Ğ°Ğ¿Ğ¸ÑĞ¸ Ğ¸ ÑĞ²ÑĞ·Ğ°Ğ½Ğ½Ğ¾Ğ³Ğ¾ Ğ¿Ñ€Ğ¾Ñ„Ğ¸Ğ»Ñ ĞºĞ»Ğ¸ĞµĞ½Ñ‚Ğ°.
                    </DialogDescription>
                </DialogHeader>
                <form onSubmit={handleSubmit(onSubmit)} className="space-y-4 py-2">
                    <div>
                        <Label htmlFor="create-full_name">Ğ¤Ğ˜Ğ *</Label>
                        <Input id="create-full_name" {...register("full_name")} placeholder="Ğ˜Ğ²Ğ°Ğ½ ĞŸĞµÑ‚Ñ€Ğ¾Ğ²" />
                        {errors.full_name && <p className="text-xs text-red-600 mt-1">{errors.full_name.message}</p>}
                    </div>

                    <div>
                        <Label htmlFor="create-email">Email *</Label>
                        <Input id="create-email" type="email" {...register("email")} placeholder="user@example.com" />
                        {errors.email && <p className="text-xs text-red-600 mt-1">{errors.email.message}</p>}
                    </div>

                    {/* +++ ĞĞĞ§ĞĞ›Ğ: ĞĞ¾Ğ²Ğ¾Ğµ Ğ¿Ğ¾Ğ»Ğµ Ğ´Ğ»Ñ Ñ‚ĞµĞ»ĞµÑ„Ğ¾Ğ½Ğ° +++ */}
                    <div>
                        <Label htmlFor="create-phone">Ğ¢ĞµĞ»ĞµÑ„Ğ¾Ğ½</Label>
                        <Controller
                            name="phone"
                            control={control}
                            render={({ field }) => (
                                <PhoneInput
                                    id="create-phone"
                                    placeholder="+7 (___) ___-__-__"
                                    {...field} // ĞŸĞµÑ€ĞµĞ´Ğ°ĞµĞ¼ Ğ²ÑĞµ ÑĞ²Ğ¾Ğ¹ÑÑ‚Ğ²Ğ° Ğ¿Ğ¾Ğ»Ñ (value, onChange, onBlur, ref)
                                />
                            )}
                        />
                        {errors.phone && <p className="text-xs text-red-600 mt-1">{errors.phone.message}</p>}
                    </div>
                    {/* +++ ĞšĞĞĞ•Ğ¦: ĞĞ¾Ğ²Ğ¾Ğµ Ğ¿Ğ¾Ğ»Ğµ Ğ´Ğ»Ñ Ñ‚ĞµĞ»ĞµÑ„Ğ¾Ğ½Ğ° +++ */}

                    <div>
                        <Label htmlFor="create-password">ĞŸĞ°Ñ€Ğ¾Ğ»ÑŒ *</Label>
                        <Input id="create-password" type="password" {...register("password")} placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢" />
                        {errors.password && <p className="text-xs text-red-600 mt-1">{errors.password.message}</p>}
                    </div>

                    <div>
                        <Label htmlFor="create-role">Ğ Ğ¾Ğ»ÑŒ *</Label>
                        <Controller
                            name="role"
                            control={control}
                            render={({ field }) => (
                                <Select onValueChange={field.onChange} defaultValue={field.value}>
                                    <SelectTrigger id="create-role">
                                        <SelectValue placeholder="Ğ’Ñ‹Ğ±ĞµÑ€Ğ¸Ñ‚Ğµ Ñ€Ğ¾Ğ»ÑŒ" />
                                    </SelectTrigger>
                                    <SelectContent>
                                        {USER_ROLE_OPTIONS.map(option => (
                                            <SelectItem key={option.value} value={option.value}>
                                                {option.label}
                                            </SelectItem>
                                        ))}
                                    </SelectContent>
                                </Select>
                            )}
                        />
                        {errors.role && <p className="text-xs text-red-600 mt-1">{errors.role.message}</p>}
                    </div>

                    <DialogFooter className="pt-4">
                        <Button type="button" variant="ghost" onClick={handleDialogClose}>ĞÑ‚Ğ¼ĞµĞ½Ğ°</Button>
                        <Button type="submit" disabled={!isValid || createMutation.isPending}>
                            {createMutation.isPending ? "Ğ¡Ğ¾Ğ·Ğ´Ğ°Ğ½Ğ¸Ğµ..." : "Ğ¡Ğ¾Ğ·Ğ´Ğ°Ñ‚ÑŒ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ñ"}
                        </Button>
                    </DialogFooter>
                </form>
            </DialogContent>
        </Dialog>
    );
}

```


## <a name="rentalappmainsrccomponentsadminUserEditDialogtsx"></a>`rental-app-main/src/components/admin/UserEditDialog.tsx`

```tsx
// path: rental-app-main/src/components/admin/UserEditDialog.tsx

// src/components/admin/UserEditDialog.tsx

import { useEffect, useState } from "react";
import { useForm, Controller } from "react-hook-form";
import { zodResolver } from "@hookform/resolvers/zod";
import { adminUserUpdateSchema, type AdminUserUpdateSchema } from "@/lib/validationSchemas";
import { useAdminUpdateUser, useUpdateUserRole } from "@/hooks/useAdminUsers";
import { useCurrentUser } from "@/hooks/useProfile";
import { USER_ROLE_OPTIONS, USER_ROLE_LABELS } from "@/constants/userConstants";
import type { UserOut, UserRole } from "@/types/user"; // âœ… Ğ˜Ğ—ĞœĞ•ĞĞ•ĞĞ˜Ğ•: Ğ”Ğ¾Ğ±Ğ°Ğ²Ğ»ĞµĞ½ Ğ¸Ğ¼Ğ¿Ğ¾Ñ€Ñ‚ UserRole

import { Button } from "@/components/ui/button";
import { Input } from "@/components/ui/input";
import { Label } from "@/components/ui/label";
import { Textarea } from "@/components/ui/textarea";
import { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from "@/components/ui/select";
import { Dialog, DialogContent, DialogHeader, DialogTitle, DialogFooter, DialogDescription } from "@/components/ui/dialog";
import { ConfirmationDialog } from "@/components/ui/confirmation-dialog";
import { PhoneInput } from "@/components/ui/phone-input";

interface Props {
    user: UserOut | null;
    open: boolean;
    onClose: () => void;
}

const statusOptions = [
    { value: "ĞĞºÑ‚Ğ¸Ğ²Ğ½Ñ‹Ğ¹", label: "ĞĞºÑ‚Ğ¸Ğ²Ğ½Ñ‹Ğ¹" },
    { value: "Ğ¢Ñ€ĞµĞ±ÑƒĞµÑ‚ Ğ¿Ğ¾Ğ´Ñ‚Ğ²ĞµÑ€Ğ¶Ğ´ĞµĞ½Ğ¸Ñ", label: "Ğ¢Ñ€ĞµĞ±ÑƒĞµÑ‚ Ğ¿Ğ¾Ğ´Ñ‚Ğ²ĞµÑ€Ğ¶Ğ´ĞµĞ½Ğ¸Ñ" },
    { value: "Ğ—Ğ°Ğ±Ğ»Ğ¾ĞºĞ¸Ñ€Ğ¾Ğ²Ğ°Ğ½", label: "Ğ—Ğ°Ğ±Ğ»Ğ¾ĞºĞ¸Ñ€Ğ¾Ğ²Ğ°Ğ½" },
];

export function UserEditDialog({ user, open, onClose }: Props) {
    const { data: currentUser } = useCurrentUser();
    const isAdmin = currentUser?.role === 'admin';
    const updateMutation = useAdminUpdateUser();
    const updateRoleMutation = useUpdateUserRole();
    const [showRoleConfirmation, setShowRoleConfirmation] = useState(false);
    const [pendingRoleChange, setPendingRoleChange] = useState<string | null>(null);

    const { register, handleSubmit, formState: { errors, isValid, isDirty }, reset, control } = useForm<AdminUserUpdateSchema>({
        resolver: zodResolver(adminUserUpdateSchema),
        mode: "onChange",
    });

    useEffect(() => {
        if (user && open) {
            const formData = {
                full_name: user.full_name,
                phone: user.phone || "",
                status: user.status || "",
                notes: user.notes || "",
                balance: user.balance,
            };
            reset(formData);
        }
    }, [user, open, reset]); // âœ… Ğ˜Ğ—ĞœĞ•ĞĞ•ĞĞ˜Ğ•: `reset` Ğ·Ğ´ĞµÑÑŒ Ğ±ĞµĞ·Ğ¾Ğ¿Ğ°ÑĞµĞ½, Ğ¾ÑÑ‚Ğ°Ğ²Ğ»ÑĞµĞ¼ ĞµĞ³Ğ¾ Ğ´Ğ»Ñ ÑĞ±Ñ€Ğ¾ÑĞ° Ñ„Ğ¾Ñ€Ğ¼Ñ‹ Ğ¿Ñ€Ğ¸ ÑĞ¼ĞµĞ½Ğµ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ñ

    const handleRoleChange = (newRole: string) => {
        if (!user || !isAdmin || currentUser?.role !== 'admin') return;
        if (newRole !== user.role) {
            setPendingRoleChange(newRole);
            setShowRoleConfirmation(true);
        }
    };

    const confirmRoleChange = () => {
        if (!user || !pendingRoleChange || !isAdmin) return;

        // âœ… Ğ˜Ğ—ĞœĞ•ĞĞ•ĞĞ˜Ğ•: ĞŸÑ€Ğ¸Ğ²Ğ¾Ğ´Ğ¸Ğ¼ ÑÑ‚Ñ€Ğ¾ĞºÑƒ Ğº Ñ‚Ğ¸Ğ¿Ñƒ UserRole, Ñ‡Ñ‚Ğ¾Ğ±Ñ‹ Ğ¸ÑĞ¿Ñ€Ğ°Ğ²Ğ¸Ñ‚ÑŒ Ğ¾ÑˆĞ¸Ğ±ĞºÑƒ TS2322
        updateRoleMutation.mutate({ userId: user.id, newRole: pendingRoleChange as UserRole }, {
            onSuccess: () => {
                setPendingRoleChange(null);
                setShowRoleConfirmation(false);
            },
        });
    };

    const onSubmit = (data: AdminUserUpdateSchema) => {
        if (!user) return;
        updateMutation.mutate({ userId: user.id, data }, {
            onSuccess: () => {
                onClose();
            },
        });
    };

    if (!user) return null;

    return (
        <>
            <Dialog open={open} onOpenChange={onClose}>
                <DialogContent className="sm:max-w-[600px]">
                    <DialogHeader>
                        <DialogTitle>Ğ ĞµĞ´Ğ°ĞºÑ‚Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ Ğ¿Ñ€Ğ¾Ñ„Ğ¸Ğ»Ñ</DialogTitle>
                        <DialogDescription>
                            Ğ’Ñ‹ Ğ¸Ğ·Ğ¼ĞµĞ½ÑĞµÑ‚Ğµ Ğ´Ğ°Ğ½Ğ½Ñ‹Ğµ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ñ: <strong>{user.full_name}</strong>
                        </DialogDescription>
                    </DialogHeader>
                    <form onSubmit={handleSubmit(onSubmit)} className="space-y-4 py-2">
                        <div>
                            <Label htmlFor="edit-email">Email (Ğ½ĞµĞ»ÑŒĞ·Ñ Ğ¸Ğ·Ğ¼ĞµĞ½Ğ¸Ñ‚ÑŒ)</Label>
                            <Input id="edit-email" value={user.email} disabled />
                        </div>

                        <div className="grid grid-cols-1 sm:grid-cols-2 gap-4">
                            <div>
                                <Label htmlFor="edit-full_name">Ğ¤Ğ˜Ğ *</Label>
                                <Input id="edit-full_name" {...register("full_name")} />
                                {errors.full_name && <p className="text-xs text-red-600 mt-1">{errors.full_name.message}</p>}
                            </div>
                            <div>
                                <Label htmlFor="edit-phone">Ğ¢ĞµĞ»ĞµÑ„Ğ¾Ğ½</Label>
                                {/* âœ… Ğ˜Ğ—ĞœĞ•ĞĞ•ĞĞ˜Ğ•: ĞĞ±Ğ¾Ñ€Ğ°Ñ‡Ğ¸Ğ²Ğ°ĞµĞ¼ PhoneInput Ğ² Controller Ğ´Ğ»Ñ ÑÑ‚Ğ°Ğ±Ğ¸Ğ»ÑŒĞ½Ğ¾Ğ¹ Ñ€Ğ°Ğ±Ğ¾Ñ‚Ñ‹ */}
                                <Controller
                                    name="phone"
                                    control={control}
                                    render={({ field }) => (
                                        <PhoneInput id="edit-phone" {...field} />
                                    )}
                                />
                                {errors.phone && <p className="text-xs text-red-600 mt-1">{errors.phone.message}</p>}
                            </div>
                        </div>

                        <div className="grid grid-cols-1 sm:grid-cols-2 gap-4">
                            <div>
                                <Label htmlFor="edit-role">Ğ Ğ¾Ğ»ÑŒ</Label>
                                <Select
                                    onValueChange={handleRoleChange}
                                    value={user.role}
                                    disabled={!isAdmin}
                                >
                                    <SelectTrigger id="edit-role">
                                        <SelectValue />
                                    </SelectTrigger>
                                    <SelectContent>
                                        {USER_ROLE_OPTIONS.map(option => (
                                            <SelectItem key={option.value} value={option.value}>
                                                {option.label}
                                            </SelectItem>
                                        ))}
                                    </SelectContent>
                                </Select>
                                {!isAdmin && <p className="text-xs text-gray-500 mt-1">Ğ¢Ğ¾Ğ»ÑŒĞºĞ¾ Ğ°Ğ´Ğ¼Ğ¸Ğ½ Ğ¼Ğ¾Ğ¶ĞµÑ‚ Ğ¼ĞµĞ½ÑÑ‚ÑŒ Ñ€Ğ¾Ğ»ÑŒ.</p>}
                            </div>
                            <div>
                                <Label htmlFor="edit-status">Ğ¡Ñ‚Ğ°Ñ‚ÑƒÑ</Label>
                                <Controller
                                    name="status"
                                    control={control}
                                    render={({ field }) => (
                                        <Select onValueChange={field.onChange} value={field.value}>
                                            <SelectTrigger id="edit-status">
                                                <SelectValue />
                                            </SelectTrigger>
                                            <SelectContent>
                                                {statusOptions.map(option => (
                                                    <SelectItem key={option.value} value={option.value}>
                                                        {option.label}
                                                    </SelectItem>
                                                ))}
                                            </SelectContent>
                                        </Select>
                                    )}
                                />
                            </div>
                        </div>

                        <div>
                            <Label htmlFor="edit-balance">Ğ‘Ğ°Ğ»Ğ°Ğ½Ñ</Label>
                            <Input id="edit-balance" type="number" step="0.01" {...register("balance")} placeholder="0.00" />
                            {errors.balance && <p className="text-xs text-red-600 mt-1">{errors.balance.message}</p>}
                        </div>

                        <div>
                            <Label htmlFor="edit-notes">Ğ—Ğ°Ğ¼ĞµÑ‚ĞºĞ¸ (Ğ²Ğ¸Ğ´Ğ½Ñ‹ Ñ‚Ğ¾Ğ»ÑŒĞºĞ¾ Ğ¿ĞµÑ€ÑĞ¾Ğ½Ğ°Ğ»Ñƒ)</Label>
                            <Textarea id="edit-notes" {...register("notes")} placeholder="Ğ’Ğ½ÑƒÑ‚Ñ€ĞµĞ½Ğ½ÑÑ Ğ¸Ğ½Ñ„Ğ¾Ñ€Ğ¼Ğ°Ñ†Ğ¸Ñ Ğ¾ ĞºĞ»Ğ¸ĞµĞ½Ñ‚Ğµ..." />
                        </div>

                        <DialogFooter className="pt-4">
                            <Button type="button" variant="ghost" onClick={onClose}>ĞÑ‚Ğ¼ĞµĞ½Ğ°</Button>
                            <Button type="submit" disabled={!isDirty || !isValid || updateMutation.isPending}>
                                {updateMutation.isPending ? "Ğ¡Ğ¾Ñ…Ñ€Ğ°Ğ½ĞµĞ½Ğ¸Ğµ..." : "Ğ¡Ğ¾Ñ…Ñ€Ğ°Ğ½Ğ¸Ñ‚ÑŒ Ğ¸Ğ·Ğ¼ĞµĞ½ĞµĞ½Ğ¸Ñ"}
                            </Button>
                        </DialogFooter>
                    </form>
                </DialogContent>
            </Dialog>

            <ConfirmationDialog
                open={showRoleConfirmation}
                onOpenChange={setShowRoleConfirmation}
                title="ĞŸĞ¾Ğ´Ñ‚Ğ²ĞµÑ€Ğ¶Ğ´ĞµĞ½Ğ¸Ğµ Ğ¸Ğ·Ğ¼ĞµĞ½ĞµĞ½Ğ¸Ñ Ñ€Ğ¾Ğ»Ğ¸"
                description={`Ğ’Ñ‹ ÑƒĞ²ĞµÑ€ĞµĞ½Ñ‹, Ñ‡Ñ‚Ğ¾ Ñ…Ğ¾Ñ‚Ğ¸Ñ‚Ğµ Ğ¸Ğ·Ğ¼ĞµĞ½Ğ¸Ñ‚ÑŒ Ñ€Ğ¾Ğ»ÑŒ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ñ "${user?.full_name}" Ñ "${USER_ROLE_LABELS[user?.role as keyof typeof USER_ROLE_LABELS] || user?.role}" Ğ½Ğ° "${pendingRoleChange ? USER_ROLE_LABELS[pendingRoleChange as keyof typeof USER_ROLE_LABELS] || pendingRoleChange : ''}"?`}
                confirmText="Ğ˜Ğ·Ğ¼ĞµĞ½Ğ¸Ñ‚ÑŒ Ñ€Ğ¾Ğ»ÑŒ"
                cancelText="ĞÑ‚Ğ¼ĞµĞ½Ğ°"
                onConfirm={confirmRoleChange}
                variant="destructive"
            />
        </>
    );
}

```


## <a name="rentalappmainsrccomponentsadminUserPaymentDialogtsx"></a>`rental-app-main/src/components/admin/UserPaymentDialog.tsx`

```tsx
// path: rental-app-main/src/components/admin/UserPaymentDialog.tsx

// src/components/admin/UserPaymentDialog.tsx

import { useForm, Controller } from "react-hook-form";
import { zodResolver } from "@hookform/resolvers/zod";
import { userPaymentSchema, type UserPaymentSchema } from "@/lib/validationSchemas";
import { useAddUserPayment } from "@/hooks/useAdminUsers";
import type { UserOut } from "@/types/user";

import { Button } from "@/components/ui/button";
import { Input } from "@/components/ui/input";
import { Label } from "@/components/ui/label";
import { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from "@/components/ui/select";
import { Textarea } from "@/components/ui/textarea";
import {
    Dialog,
    DialogContent,
    DialogHeader,
    DialogTitle,
    DialogFooter,
    DialogDescription,
} from "@/components/ui/dialog";

const PAYMENT_METHODS = ["ĞĞ°Ğ»Ğ¸Ñ‡Ğ½Ñ‹Ğµ", "ĞšĞ°Ñ€Ñ‚Ğ°", "ĞŸĞµÑ€ĞµĞ²Ğ¾Ğ´"];

interface Props {
    user: UserOut | null;
    open: boolean;
    onClose: () => void;
}

export function UserPaymentDialog({ user, open, onClose }: Props) {
    const paymentMutation = useAddUserPayment();
    const { register, handleSubmit, formState: { errors, isValid }, reset, control } = useForm<UserPaymentSchema>({
        resolver: zodResolver(userPaymentSchema),
        mode: "onChange",
    });

    const onSubmit = (data: UserPaymentSchema) => {
        if (!user) return;

        paymentMutation.mutate({ userId: user.id, data }, {
            onSuccess: () => {
                reset();
                onClose();
            },
        });
    };

    const handleDialogClose = () => {
        if (paymentMutation.isPending) return;
        reset();
        onClose();
    };

    if (!user) return null;

    // Ğ˜Ğ—ĞœĞ•ĞĞ•ĞĞ˜Ğ•: Ğ”Ğ¾Ğ±Ğ°Ğ²Ğ»ÑĞµĞ¼ ?? 0 Ğ´Ğ»Ñ Ğ±ĞµĞ·Ğ¾Ğ¿Ğ°ÑĞ½Ğ¾Ğ³Ğ¾ Ğ´Ğ¾ÑÑ‚ÑƒĞ¿Ğ° Ğº Ğ±Ğ°Ğ»Ğ°Ğ½ÑÑƒ
    const currentBalance = user.balance ?? 0;

    return (
        <Dialog open={open} onOpenChange={handleDialogClose}>
            <DialogContent>
                <DialogHeader>
                    <DialogTitle>ĞŸĞ¾Ğ¿Ğ¾Ğ»Ğ½ĞµĞ½Ğ¸Ğµ Ğ±Ğ°Ğ»Ğ°Ğ½ÑĞ°</DialogTitle>
                    <DialogDescription>
                        Ğ’Ñ‹ Ğ¿Ğ¾Ğ¿Ğ¾Ğ»Ğ½ÑĞµÑ‚Ğµ Ğ±Ğ°Ğ»Ğ°Ğ½Ñ Ğ´Ğ»Ñ <strong>{user.full_name}</strong>.
                        Ğ¢ĞµĞºÑƒÑ‰Ğ¸Ğ¹ Ğ±Ğ°Ğ»Ğ°Ğ½Ñ:
                        <span className={`font-bold ${currentBalance < 0 ? 'text-red-600' : 'text-green-700'}`}>
                            {' '}{currentBalance.toLocaleString('ru-RU')} â‚½
                        </span>
                    </DialogDescription>
                </DialogHeader>
                <form onSubmit={handleSubmit(onSubmit)} className="space-y-4 py-2">
                    <div className="grid grid-cols-2 gap-4">
                        <div>
                            <Label htmlFor="payment-amount">Ğ¡ÑƒĞ¼Ğ¼Ğ° (â‚½) *</Label>
                            <Input id="payment-amount" type="number" step="0.01" {...register("amount")} placeholder="1000" />
                            {errors.amount && <p className="text-xs text-red-600 mt-1">{errors.amount.message}</p>}
                        </div>
                        <div>
                            <Label htmlFor="payment-method">ĞœĞµÑ‚Ğ¾Ğ´ Ğ¾Ğ¿Ğ»Ğ°Ñ‚Ñ‹ *</Label>
                            <Controller
                                name="payment_method"
                                control={control}
                                render={({ field }) => (
                                    <Select onValueChange={field.onChange} defaultValue={field.value}>
                                        <SelectTrigger id="payment-method">
                                            <SelectValue placeholder="Ğ’Ñ‹Ğ±ĞµÑ€Ğ¸Ñ‚Ğµ Ğ¼ĞµÑ‚Ğ¾Ğ´" />
                                        </SelectTrigger>
                                        <SelectContent>
                                            {PAYMENT_METHODS.map(method => (
                                                <SelectItem key={method} value={method}>{method}</SelectItem>
                                            ))}
                                        </SelectContent>
                                    </Select>
                                )}
                            />
                            {errors.payment_method && <p className="text-xs text-red-600 mt-1">{errors.payment_method.message}</p>}
                        </div>
                    </div>
                    <div>
                        <Label htmlFor="payment-description">ĞĞ¿Ğ¸ÑĞ°Ğ½Ğ¸Ğµ (Ğ½ĞµĞ¾Ğ±ÑĞ·Ğ°Ñ‚ĞµĞ»ÑŒĞ½Ğ¾)</Label>
                        <Textarea id="payment-description" {...register("description")} placeholder="ĞĞ°Ğ¿Ñ€Ğ¸Ğ¼ĞµÑ€, Ğ¾Ğ¿Ğ»Ğ°Ñ‚Ğ° Ğ·Ğ°Ğ»Ğ¾Ğ³Ğ° Ğ·Ğ° Ğ°Ñ€ĞµĞ½Ğ´Ñƒ #123" />
                    </div>
                    <DialogFooter className="pt-4">
                        <Button type="button" variant="ghost" onClick={handleDialogClose} disabled={paymentMutation.isPending}>
                            ĞÑ‚Ğ¼ĞµĞ½Ğ°
                        </Button>
                        <Button type="submit" disabled={!isValid || paymentMutation.isPending}>
                            {paymentMutation.isPending ? "ĞŸĞ¾Ğ¿Ğ¾Ğ»Ğ½ĞµĞ½Ğ¸Ğµ..." : "ĞŸĞ¾Ğ¿Ğ¾Ğ»Ğ½Ğ¸Ñ‚ÑŒ Ğ±Ğ°Ğ»Ğ°Ğ½Ñ"}
                        </Button>
                    </DialogFooter>
                </form>
            </DialogContent>
        </Dialog>
    );
}

```


## <a name="rentalappmainsrccomponentsadminUserTabletsx"></a>`rental-app-main/src/components/admin/UserTable.tsx`

```tsx
// path: rental-app-main/src/components/admin/UserTable.tsx

// src/components/admin/UserTable.tsx

import { useState } from "react";
import { Table, TableBody, TableCell, TableHead, TableHeader, TableRow } from "@/components/ui/table";
import { Button } from "@/components/ui/button";
import { UserSearch, Loader2 } from "lucide-react";
import { UserCreateDialog } from "./UserCreateDialog";
import { useUserTableLogic } from "@/hooks/admin/useUserTableLogic";
import { UserTableToolbar } from "./UserTableToolbar";
import { UserTableRow } from "./UserTableRow";
import { UserEditDialog } from "./UserEditDialog";
import { UserPaymentDialog } from "./UserPaymentDialog";
import type { UserOut } from "@/types/user";

interface UserTableProps {
    users: UserOut[];
    isLoading: boolean;
    error: unknown;
    onLoadMore: () => void;
    hasNextPage: boolean;
    isFetchingNextPage: boolean;
}

export default function UserTable({
    users,
    isLoading,
    error,
    onLoadMore,
    hasNextPage,
    isFetchingNextPage,
}: UserTableProps) {
    const [isCreateDialogOpen, setCreateDialogOpen] = useState(false);
    const [isEditDialogOpen, setEditDialogOpen] = useState(false);
    const [selectedUser, setSelectedUser] = useState<UserOut | null>(null);
    const [paymentUser, setPaymentUser] = useState<UserOut | null>(null);

    const {
        currentUser,
        filteredUsers,
        isAdmin,
        searchQuery,
        setSearchQuery,
        confirmDelete,
        mutations,
        handlers,
    } = useUserTableLogic(users);

    const handleEdit = (user: UserOut) => {
        setSelectedUser(user);
        setEditDialogOpen(true);
    };

    const handleAddPayment = (user: UserOut) => {
        setPaymentUser(user);
    };

    if (isLoading) {
        return <div className="text-center py-8">Ğ—Ğ°Ğ³Ñ€ÑƒĞ·ĞºĞ° Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ĞµĞ¹...</div>;
    }

    if (error) {
        return <div className="text-center py-8 text-red-600">ĞÑˆĞ¸Ğ±ĞºĞ° Ğ·Ğ°Ğ³Ñ€ÑƒĞ·ĞºĞ¸ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ĞµĞ¹</div>;
    }

    return (
        <>
            <div className="space-y-4">
                <UserTableToolbar
                    searchQuery={searchQuery}
                    onSearchChange={setSearchQuery}
                    onAddUser={() => setCreateDialogOpen(true)}
                    filteredUserCount={filteredUsers.length}
                    isAdmin={isAdmin}
                />

                <div className="rounded-md border">
                    <Table>
                        <TableHeader>
                            <TableRow>
                                <TableHead>ĞŸĞ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ÑŒ</TableHead>
                                <TableHead>Email</TableHead>
                                <TableHead>Ğ Ğ¾Ğ»ÑŒ</TableHead>
                                <TableHead>Ğ¡Ñ‚Ğ°Ñ‚ÑƒÑ</TableHead>
                                <TableHead>Ğ”Ğ°Ñ‚Ğ° Ñ€ĞµĞ³Ğ¸ÑÑ‚Ñ€Ğ°Ñ†Ğ¸Ğ¸</TableHead>
                                {isAdmin && <TableHead className="text-right">Ğ”ĞµĞ¹ÑÑ‚Ğ²Ğ¸Ñ</TableHead>}
                            </TableRow>
                        </TableHeader>
                        <TableBody>
                            {filteredUsers.length > 0 ? (
                                filteredUsers.map((user) => (
                                    <UserTableRow
                                        key={user.id}
                                        user={user}
                                        currentUser={currentUser}
                                        isAdmin={isAdmin}
                                        confirmDeleteId={confirmDelete}
                                        handlers={handlers}
                                        mutations={mutations}
                                        onEdit={handleEdit}
                                        onAddPayment={handleAddPayment}
                                    />
                                ))
                            ) : (
                                <TableRow>
                                    <TableCell colSpan={isAdmin ? 6 : 5} className="h-24 text-center">
                                        <div className="flex flex-col items-center justify-center text-center p-4">
                                            <UserSearch className="w-16 h-16 text-gray-300 mb-3" />
                                            <h3 className="text-lg font-semibold text-gray-700">ĞŸĞ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ğ¸ Ğ½Ğµ Ğ½Ğ°Ğ¹Ğ´ĞµĞ½Ñ‹</h3>
                                            <p className="text-sm text-gray-500 max-w-sm">
                                                {searchQuery
                                                    ? "ĞŸĞ¾Ğ¿Ñ€Ğ¾Ğ±ÑƒĞ¹Ñ‚Ğµ Ğ¸Ğ·Ğ¼ĞµĞ½Ğ¸Ñ‚ÑŒ Ğ¿Ğ¾Ğ¸ÑĞºĞ¾Ğ²Ñ‹Ğ¹ Ğ·Ğ°Ğ¿Ñ€Ğ¾Ñ."
                                                    : "Ğ’ ÑĞ¸ÑÑ‚ĞµĞ¼Ğµ Ğ¿Ğ¾ĞºĞ° Ğ½ĞµÑ‚ Ğ·Ğ°Ñ€ĞµĞ³Ğ¸ÑÑ‚Ñ€Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ½Ñ‹Ñ… Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ĞµĞ¹."}
                                            </p>
                                        </div>
                                    </TableCell>
                                </TableRow>
                            )}
                        </TableBody>
                    </Table>
                </div>

                {/* ĞšĞ½Ğ¾Ğ¿ĞºĞ° Load More */}
                {hasNextPage && (
                    <div className="flex justify-center mt-6">
                        <Button
                            onClick={onLoadMore}
                            disabled={isFetchingNextPage}
                            variant="outline"
                            className="min-w-[120px]"
                        >
                            {isFetchingNextPage ? (
                                <>
                                    <Loader2 className="w-4 h-4 mr-2 animate-spin" />
                                    Ğ—Ğ°Ğ³Ñ€ÑƒĞ·ĞºĞ°...
                                </>
                            ) : (
                                "Ğ—Ğ°Ğ³Ñ€ÑƒĞ·Ğ¸Ñ‚ÑŒ ĞµÑ‰Ğµ"
                            )}
                        </Button>
                    </div>
                )}

                {!isAdmin && (
                    <div className="bg-blue-50 border border-blue-200 rounded-lg p-4 text-sm text-blue-800">
                        <strong>Ğ ĞµĞ¶Ğ¸Ğ¼ Ğ¼ĞµĞ½ĞµĞ´Ğ¶ĞµÑ€Ğ°:</strong> Ğ’Ñ‹ Ğ¼Ğ¾Ğ¶ĞµÑ‚Ğµ Ğ¿Ñ€Ğ¾ÑĞ¼Ğ°Ñ‚Ñ€Ğ¸Ğ²Ğ°Ñ‚ÑŒ ÑĞ¿Ğ¸ÑĞ¾Ğº Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ĞµĞ¹, Ğ½Ğ¾ Ğ½Ğµ Ğ¼Ğ¾Ğ¶ĞµÑ‚Ğµ Ğ¸Ñ… Ğ¸Ğ·Ğ¼ĞµĞ½ÑÑ‚ÑŒ, Ğ±Ğ»Ğ¾ĞºĞ¸Ñ€Ğ¾Ğ²Ğ°Ñ‚ÑŒ Ğ¸Ğ»Ğ¸ ÑƒĞ´Ğ°Ğ»ÑÑ‚ÑŒ.
                    </div>
                )}
            </div>

            <UserCreateDialog open={isCreateDialogOpen} onClose={() => setCreateDialogOpen(false)} />

            <UserEditDialog
                user={selectedUser}
                open={isEditDialogOpen}
                onClose={() => {
                    setEditDialogOpen(false);
                    setSelectedUser(null);
                }}
            />

            <UserPaymentDialog
                user={paymentUser}
                open={!!paymentUser}
                onClose={() => setPaymentUser(null)}
            />
        </>
    );
}

```


## <a name="rentalappmainsrccomponentsadminUserTableRowtsx"></a>`rental-app-main/src/components/admin/UserTableRow.tsx`

```tsx
// path: rental-app-main/src/components/admin/UserTableRow.tsx

// src/components/admin/UserTableRow.tsx

import type { UserOut } from "@/types/user";
import { TableCell, TableRow } from "@/components/ui/table";
import { Badge } from "@/components/ui/badge";
import { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from "@/components/ui/select";
import { Button } from "@/components/ui/button";
import { Shield, ShieldCheck, UserCheck, UserX, Trash2, Pencil, DollarSign } from "lucide-react";
import type { useUserTableLogic } from "@/hooks/admin/useUserTableLogic";
import { USER_ROLE_LABELS, USER_ROLE_BADGE_VARIANTS, USER_ROLE_OPTIONS } from "@/constants/userConstants";
import { formatDateEuropean } from "@/lib/utils";

type Handlers = ReturnType<typeof useUserTableLogic>['handlers'];
type Mutations = ReturnType<typeof useUserTableLogic>['mutations'];

interface Props {
    user: UserOut;
    currentUser: UserOut | null | undefined;
    isAdmin: boolean;
    confirmDeleteId: number | null;
    handlers: Handlers;
    mutations: Mutations;
    onEdit: (user: UserOut) => void;
    onAddPayment: (user: UserOut) => void;
}

export function UserTableRow({ user, currentUser, isAdmin, confirmDeleteId, handlers, mutations, onEdit, onAddPayment }: Props) {
    return (
        <TableRow key={user.id}>
            <TableCell className="font-medium">
                <div className="flex items-center gap-2">
                    {user.role === "admin" && <ShieldCheck className="w-4 h-4 text-red-500" />}
                    {user.role === "manager" && <Shield className="w-4 h-4 text-blue-500" />}
                    {user.full_name}
                    {user.id === currentUser?.id && <Badge variant="outline" className="text-xs">Ğ­Ñ‚Ğ¾ Ğ²Ñ‹</Badge>}
                </div>
            </TableCell>
            <TableCell>{user.email}</TableCell>
            <TableCell>
                {isAdmin && user.id !== currentUser?.id ? (
                    <Select value={user.role} onValueChange={(value) => handlers.handleRoleChange(user.id, value)}>
                        <SelectTrigger className="w-32"><SelectValue /></SelectTrigger>
                        <SelectContent>
                            {USER_ROLE_OPTIONS.map(option => (
                                <SelectItem key={option.value} value={option.value}>
                                    {option.label}
                                </SelectItem>
                            ))}
                        </SelectContent>
                    </Select>
                ) : (
                    <Badge variant={USER_ROLE_BADGE_VARIANTS[user.role]}>
                        {USER_ROLE_LABELS[user.role]}
                    </Badge>
                )}
            </TableCell>
            <TableCell>
                <Badge variant={user.is_active ? "default" : "secondary"}>{user.is_active ? "ĞĞºÑ‚Ğ¸Ğ²ĞµĞ½" : "Ğ—Ğ°Ğ±Ğ»Ğ¾ĞºĞ¸Ñ€Ğ¾Ğ²Ğ°Ğ½"}</Badge>
            </TableCell>
            <TableCell className="text-sm text-gray-600">
                {formatDateEuropean(user.created_at)}
            </TableCell>
            {isAdmin && (
                <TableCell className="text-right">
                    <div className="flex items-center justify-end gap-2">
                        {user.id !== currentUser?.id ? (
                            <>
                                <Button variant="outline" size="icon" onClick={() => onAddPayment(user)} className="h-8 w-8 text-green-600 border-green-300 hover:bg-green-50 hover:text-green-700">
                                    <DollarSign className="w-4 h-4" />
                                </Button>
                                <Button variant="outline" size="icon" onClick={() => onEdit(user)} className="h-8 w-8">
                                    <Pencil className="w-4 h-4" />
                                </Button>
                                <Button variant="outline" size="sm" onClick={() => handlers.handleToggleBlock(user)} disabled={mutations.blockUser.isPending || mutations.unblockUser.isPending}>
                                    {user.is_active ? <UserX className="w-4 h-4" /> : <UserCheck className="w-4 h-4" />}
                                </Button>
                                <Button variant={confirmDeleteId === user.id ? "destructive" : "outline"} size="sm" onClick={() => handlers.handleDelete(user.id)} disabled={mutations.deleteUser.isPending}>
                                    <Trash2 className="w-4 h-4" />
                                    {confirmDeleteId === user.id && <span className="ml-1 text-xs">ĞŸĞ¾Ğ´Ñ‚Ğ²ĞµÑ€Ğ´Ğ¸Ñ‚ÑŒ</span>}
                                </Button>
                            </>
                        ) : (
                            <Button variant="outline" size="icon" onClick={() => onAddPayment(user)} className="h-8 w-8 text-green-600 border-green-300 hover:bg-green-50 hover:text-green-700">
                                <DollarSign className="w-4 h-4" />
                            </Button>
                        )}
                    </div>
                </TableCell>
            )}
        </TableRow>
    );
}

```


## <a name="rentalappmainsrccomponentsadminUserTableToolbartsx"></a>`rental-app-main/src/components/admin/UserTableToolbar.tsx`

```tsx
// path: rental-app-main/src/components/admin/UserTableToolbar.tsx

// src/components/admin/UserTableToolbar.tsx
import { Input } from "@/components/ui/input";
import { Button } from "@/components/ui/button";
import { Search, Plus } from "lucide-react";

interface Props {
    searchQuery: string;
    onSearchChange: (query: string) => void;
    onAddUser: () => void;
    filteredUserCount: number;
    isAdmin: boolean;
}

export function UserTableToolbar({
                                     searchQuery,
                                     onSearchChange,
                                     onAddUser,
                                     filteredUserCount,
                                     isAdmin
                                 }: Props) {
    return (
        <div className="flex flex-col sm:flex-row gap-4 items-center justify-between">
            <div className="relative flex-grow max-w-sm w-full">
                <Search className="absolute left-3 top-1/2 -translate-y-1/2 text-gray-400 w-4 h-4" />
                <Input
                    placeholder="ĞŸĞ¾Ğ¸ÑĞº Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ĞµĞ¹..."
                    value={searchQuery}
                    onChange={(e) => onSearchChange(e.target.value)}
                    className="pl-10"
                />
            </div>
            <div className="flex items-center gap-4">
                <p className="text-sm text-gray-600">
                    ĞĞ°Ğ¹Ğ´ĞµĞ½Ğ¾: {filteredUserCount}
                </p>
                {isAdmin && (
                    <Button size="sm" onClick={onAddUser}>
                        <Plus className="w-4 h-4 mr-2" />
                        Ğ”Ğ¾Ğ±Ğ°Ğ²Ğ¸Ñ‚ÑŒ
                    </Button>
                )}
            </div>
        </div>
    );
}

```


## <a name="rentalappmainsrccomponentsadmindashboardActivityFeedWidgettsx"></a>`rental-app-main/src/components/admin/dashboard/ActivityFeedWidget.tsx`

```tsx
// path: rental-app-main/src/components/admin/dashboard/ActivityFeedWidget.tsx

// src/components/admin/dashboard/ActivityFeedWidget.tsx

import { Card, CardContent, CardHeader, CardTitle } from "@/components/ui/card";
import { Skeleton } from "@/components/ui/skeleton";
import { Badge } from "@/components/ui/badge";
import { 
    Activity,
    Plus,
    X,
    Play,
    CheckCircle,
    UserPlus,
    Package,
    Calendar
} from "lucide-react";
import { formatDistanceToNow } from "date-fns";
import { ru } from "date-fns/locale";
import type { ActivityFeedItem } from "@/hooks/admin/useDashboardData";

interface ActivityFeedWidgetProps {
    data: ActivityFeedItem[];
    isLoading: boolean;
}

export default function ActivityFeedWidget({ data, isLoading }: ActivityFeedWidgetProps) {
    const getActivityIcon = (type: ActivityFeedItem['type']) => {
        switch (type) {
            case 'reservation_created':
                return <Calendar className="w-4 h-4 text-blue-600" />;
            case 'reservation_cancelled':
                return <X className="w-4 h-4 text-red-600" />;
            case 'rental_started':
                return <Play className="w-4 h-4 text-green-600" />;
            case 'rental_completed':
                return <CheckCircle className="w-4 h-4 text-green-600" />;
            case 'user_registered':
                return <UserPlus className="w-4 h-4 text-purple-600" />;
            case 'equipment_added':
                return <Package className="w-4 h-4 text-orange-600" />;
            default:
                return <Activity className="w-4 h-4 text-gray-600" />;
        }
    };

    const getActivityColor = (type: ActivityFeedItem['type']) => {
        switch (type) {
            case 'reservation_created':
                return 'bg-blue-50 border-blue-200';
            case 'reservation_cancelled':
                return 'bg-red-50 border-red-200';
            case 'rental_started':
                return 'bg-green-50 border-green-200';
            case 'rental_completed':
                return 'bg-green-50 border-green-200';
            case 'user_registered':
                return 'bg-purple-50 border-purple-200';
            case 'equipment_added':
                return 'bg-orange-50 border-orange-200';
            default:
                return 'bg-gray-50 border-gray-200';
        }
    };

    const getActivityBadgeVariant = (type: ActivityFeedItem['type']) => {
        switch (type) {
            case 'reservation_created':
                return 'default' as const;
            case 'reservation_cancelled':
                return 'destructive' as const;
            case 'rental_started':
                return 'secondary' as const;
            case 'rental_completed':
                return 'secondary' as const;
            case 'user_registered':
                return 'outline' as const;
            case 'equipment_added':
                return 'outline' as const;
            default:
                return 'outline' as const;
        }
    };

    const getActivityTypeLabel = (type: ActivityFeedItem['type']) => {
        switch (type) {
            case 'reservation_created':
                return 'Ğ ĞµĞ·ĞµÑ€Ğ² ÑĞ¾Ğ·Ğ´Ğ°Ğ½';
            case 'reservation_cancelled':
                return 'Ğ ĞµĞ·ĞµÑ€Ğ² Ğ¾Ñ‚Ğ¼ĞµĞ½ĞµĞ½';
            case 'rental_started':
                return 'ĞÑ€ĞµĞ½Ğ´Ğ° Ğ½Ğ°Ñ‡Ğ°Ñ‚Ğ°';
            case 'rental_completed':
                return 'ĞÑ€ĞµĞ½Ğ´Ğ° Ğ·Ğ°Ğ²ĞµÑ€ÑˆĞµĞ½Ğ°';
            case 'user_registered':
                return 'ĞŸĞ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ÑŒ Ğ·Ğ°Ñ€ĞµĞ³Ğ¸ÑÑ‚Ñ€Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½';
            case 'equipment_added':
                return 'ĞĞ±Ğ¾Ñ€ÑƒĞ´Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ Ğ´Ğ¾Ğ±Ğ°Ğ²Ğ»ĞµĞ½Ğ¾';
            default:
                return 'Ğ¡Ğ¾Ğ±Ñ‹Ñ‚Ğ¸Ğµ';
        }
    };

    if (isLoading) {
        return (
            <Card>
                <CardHeader>
                    <CardTitle className="flex items-center gap-2">
                        <Activity className="w-5 h-5" />
                        Ğ›ĞµĞ½Ñ‚Ğ° Ğ°ĞºÑ‚Ğ¸Ğ²Ğ½Ğ¾ÑÑ‚Ğ¸
                    </CardTitle>
                </CardHeader>
                <CardContent className="space-y-4">
                    {Array.from({ length: 5 }).map((_, index) => (
                        <div key={index} className="flex items-start gap-3 p-3 border rounded-lg">
                            <Skeleton className="w-8 h-8 rounded-full" />
                            <div className="flex-1 space-y-2">
                                <Skeleton className="h-4 w-3/4" />
                                <Skeleton className="h-3 w-1/2" />
                            </div>
                            <Skeleton className="h-6 w-16" />
                        </div>
                    ))}
                </CardContent>
            </Card>
        );
    }

    return (
        <Card>
            <CardHeader>
                <CardTitle className="flex items-center gap-2">
                    <Activity className="w-5 h-5" />
                    Ğ›ĞµĞ½Ñ‚Ğ° Ğ°ĞºÑ‚Ğ¸Ğ²Ğ½Ğ¾ÑÑ‚Ğ¸
                </CardTitle>
            </CardHeader>
            <CardContent>
                <div className="space-y-3">
                    {data.length > 0 ? (
                        data.map((activity) => (
                            <div 
                                key={activity.id}
                                className={`flex items-start gap-3 p-3 border rounded-lg ${getActivityColor(activity.type)}`}
                            >
                                <div className="flex-shrink-0 mt-0.5">
                                    {getActivityIcon(activity.type)}
                                </div>
                                <div className="flex-1 min-w-0">
                                    <p className="text-sm font-medium text-gray-900 mb-1">
                                        {activity.description}
                                    </p>
                                    <div className="flex items-center gap-2 text-xs text-gray-500">
                                        <span>
                                            {formatDistanceToNow(new Date(activity.timestamp), { 
                                                addSuffix: true, 
                                                locale: ru 
                                            })}
                                        </span>
                                        {activity.user_name && (
                                            <>
                                                <span>â€¢</span>
                                                <span>{activity.user_name}</span>
                                            </>
                                        )}
                                        {activity.equipment_name && (
                                            <>
                                                <span>â€¢</span>
                                                <span>{activity.equipment_name}</span>
                                            </>
                                        )}
                                    </div>
                                </div>
                                <div className="flex-shrink-0">
                                    <Badge 
                                        variant={getActivityBadgeVariant(activity.type)}
                                        className="text-xs"
                                    >
                                        {getActivityTypeLabel(activity.type)}
                                    </Badge>
                                </div>
                            </div>
                        ))
                    ) : (
                        <div className="text-center py-8 text-sm text-gray-500">
                            <Activity className="w-8 h-8 mx-auto mb-2 text-gray-400" />
                            <p>ĞĞµÑ‚ Ğ°ĞºÑ‚Ğ¸Ğ²Ğ½Ğ¾ÑÑ‚Ğ¸</p>
                            <p className="text-xs">Ğ¡Ğ¾Ğ±Ñ‹Ñ‚Ğ¸Ñ Ğ¿Ğ¾ÑĞ²ÑÑ‚ÑÑ Ğ·Ğ´ĞµÑÑŒ Ğ¿Ğ¾ Ğ¼ĞµÑ€Ğµ Ğ¸Ñ… Ğ²Ğ¾Ğ·Ğ½Ğ¸ĞºĞ½Ğ¾Ğ²ĞµĞ½Ğ¸Ñ</p>
                        </div>
                    )}
                </div>
            </CardContent>
        </Card>
    );
}


```


## <a name="rentalappmainsrccomponentsadmindashboardKpiCardsWidgettsx"></a>`rental-app-main/src/components/admin/dashboard/KpiCardsWidget.tsx`

```tsx
// path: rental-app-main/src/components/admin/dashboard/KpiCardsWidget.tsx

// src/components/admin/dashboard/KpiCardsWidget.tsx

import { Card, CardContent, CardHeader, CardTitle } from "@/components/ui/card";
import { Skeleton } from "@/components/ui/skeleton";
import { 
    Users, 
    UserCheck, 
    Package, 
    Calendar,
    DollarSign,
    TrendingUp,
    BarChart3,
    Clock
} from "lucide-react";
import type { DashboardSummary } from "@/hooks/admin/useDashboardData";

interface KpiCardsWidgetProps {
    data: DashboardSummary['kpi'];
    isLoading: boolean;
}

export default function KpiCardsWidget({ data, isLoading }: KpiCardsWidgetProps) {
    if (isLoading) {
        return (
            <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                {Array.from({ length: 8 }).map((_, index) => (
                    <Card key={index}>
                        <CardHeader className="flex flex-row items-center justify-between space-y-0 pb-2">
                            <Skeleton className="h-4 w-20" />
                            <Skeleton className="h-4 w-4" />
                        </CardHeader>
                        <CardContent>
                            <Skeleton className="h-8 w-16 mb-1" />
                            <Skeleton className="h-3 w-24" />
                        </CardContent>
                    </Card>
                ))}
            </div>
        );
    }

    const kpiCards = [
        {
            title: "Ğ’ÑĞµĞ³Ğ¾ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ĞµĞ¹",
            value: data.total_users.toLocaleString(),
            description: `${data.active_users} Ğ°ĞºÑ‚Ğ¸Ğ²Ğ½Ñ‹Ñ…`,
            icon: <Users className="h-4 w-4 text-muted-foreground" />,
            trend: data.active_users > 0 ? "positive" : "neutral"
        },
        {
            title: "ĞĞºÑ‚Ğ¸Ğ²Ğ½Ñ‹Ğµ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ğ¸",
            value: data.active_users.toLocaleString(),
            description: `${Math.round((data.active_users / data.total_users) * 100)}% Ğ¾Ñ‚ Ğ¾Ğ±Ñ‰ĞµĞ³Ğ¾ Ñ‡Ğ¸ÑĞ»Ğ°`,
            icon: <UserCheck className="h-4 w-4 text-muted-foreground" />,
            trend: "positive"
        },
        {
            title: "Ğ’ÑĞµĞ³Ğ¾ Ğ¾Ğ±Ğ¾Ñ€ÑƒĞ´Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ",
            value: data.total_equipment.toLocaleString(),
            description: "Ğ•Ğ´Ğ¸Ğ½Ğ¸Ñ† Ğ² ĞºĞ°Ñ‚Ğ°Ğ»Ğ¾Ğ³Ğµ",
            icon: <Package className="h-4 w-4 text-muted-foreground" />,
            trend: "neutral"
        },
        {
            title: "Ğ’ÑĞµĞ³Ğ¾ Ñ€ĞµĞ·ĞµÑ€Ğ²Ğ¾Ğ²",
            value: data.total_reservations.toLocaleString(),
            description: "Ğ—Ğ° Ğ²ÑĞµ Ğ²Ñ€ĞµĞ¼Ñ",
            icon: <Calendar className="h-4 w-4 text-muted-foreground" />,
            trend: "positive"
        },
        {
            title: "Ğ’Ñ‹Ñ€ÑƒÑ‡ĞºĞ° ÑĞµĞ³Ğ¾Ğ´Ğ½Ñ",
            value: `${data.revenue_today.toLocaleString()} â‚½`,
            description: "Ğ—Ğ° Ñ‚ĞµĞºÑƒÑ‰Ğ¸Ğ¹ Ğ´ĞµĞ½ÑŒ",
            icon: <DollarSign className="h-4 w-4 text-muted-foreground" />,
            trend: data.revenue_today > 0 ? "positive" : "neutral"
        },
        {
            title: "Ğ’Ñ‹Ñ€ÑƒÑ‡ĞºĞ° Ğ·Ğ° Ğ¼ĞµÑÑÑ†",
            value: `${data.revenue_this_month.toLocaleString()} â‚½`,
            description: "Ğ—Ğ° Ñ‚ĞµĞºÑƒÑ‰Ğ¸Ğ¹ Ğ¼ĞµÑÑÑ†",
            icon: <TrendingUp className="h-4 w-4 text-muted-foreground" />,
            trend: "positive"
        },
        {
            title: "Ğ—Ğ°Ğ³Ñ€ÑƒĞ¶ĞµĞ½Ğ½Ğ¾ÑÑ‚ÑŒ",
            value: `${data.occupancy_rate.toFixed(1)}%`,
            description: "Ğ¡Ñ€ĞµĞ´Ğ½ÑÑ Ğ·Ğ°Ğ³Ñ€ÑƒĞ¶ĞµĞ½Ğ½Ğ¾ÑÑ‚ÑŒ",
            icon: <BarChart3 className="h-4 w-4 text-muted-foreground" />,
            trend: data.occupancy_rate > 70 ? "positive" : data.occupancy_rate > 40 ? "neutral" : "negative"
        },
        {
            title: "Ğ¡Ñ€ĞµĞ´Ğ½ÑÑ Ğ´Ğ»Ğ¸Ñ‚ĞµĞ»ÑŒĞ½Ğ¾ÑÑ‚ÑŒ",
            value: `${data.avg_rental_duration.toFixed(1)} Ğ´Ğ½.`,
            description: "ĞÑ€ĞµĞ½Ğ´Ñ‹",
            icon: <Clock className="h-4 w-4 text-muted-foreground" />,
            trend: "neutral"
        }
    ];

    const getTrendColor = (trend: string) => {
        switch (trend) {
            case "positive":
                return "text-green-600";
            case "negative":
                return "text-red-600";
            default:
                return "text-gray-600";
        }
    };

    return (
        <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
            {kpiCards.map((card, index) => (
                <Card key={index} className="hover:shadow-md transition-shadow">
                    <CardHeader className="flex flex-row items-center justify-between space-y-0 pb-2">
                        <CardTitle className="text-sm font-medium">{card.title}</CardTitle>
                        {card.icon}
                    </CardHeader>
                    <CardContent>
                        <div className={`text-2xl font-bold ${getTrendColor(card.trend)}`}>
                            {card.value}
                        </div>
                        <p className="text-xs text-muted-foreground">
                            {card.description}
                        </p>
                    </CardContent>
                </Card>
            ))}
        </div>
    );
}


```


## <a name="rentalappmainsrccomponentsadmindashboardPopularEquipmentCharttsx"></a>`rental-app-main/src/components/admin/dashboard/PopularEquipmentChart.tsx`

```tsx
// path: rental-app-main/src/components/admin/dashboard/PopularEquipmentChart.tsx

// src/components/admin/dashboard/PopularEquipmentChart.tsx

import { Card, CardContent, CardHeader, CardTitle } from "@/components/ui/card";
import { Skeleton } from "@/components/ui/skeleton";
import { Badge } from "@/components/ui/badge";
import { BarChart3, TrendingUp, Package } from "lucide-react";
import type { PopularEquipmentItem } from "@/hooks/admin/useDashboardData";
import { formatNumber } from "@/lib/utils";

interface PopularEquipmentChartProps {
    data: PopularEquipmentItem[];
    isLoading: boolean;
}

export default function PopularEquipmentChart({ data, isLoading }: PopularEquipmentChartProps) {
    if (isLoading) {
        return (
            <Card>
                <CardHeader>
                    <CardTitle className="flex items-center gap-2">
                        <BarChart3 className="w-5 h-5" />
                        ĞŸĞ¾Ğ¿ÑƒĞ»ÑÑ€Ğ½Ğ¾Ğµ Ğ¾Ğ±Ğ¾Ñ€ÑƒĞ´Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ
                    </CardTitle>
                </CardHeader>
                <CardContent className="space-y-4">
                    {Array.from({ length: 5 }).map((_, index) => (
                        <div key={index} className="space-y-2">
                            <div className="flex justify-between items-center">
                                <Skeleton className="h-4 w-32" />
                                <Skeleton className="h-4 w-16" />
                            </div>
                            <Skeleton className="h-6 w-full" />
                        </div>
                    ))}
                </CardContent>
            </Card>
        );
    }

    if (data.length === 0) {
        return (
            <Card>
                <CardHeader>
                    <CardTitle className="flex items-center gap-2">
                        <BarChart3 className="w-5 h-5" />
                        ĞŸĞ¾Ğ¿ÑƒĞ»ÑÑ€Ğ½Ğ¾Ğµ Ğ¾Ğ±Ğ¾Ñ€ÑƒĞ´Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ
                    </CardTitle>
                </CardHeader>
                <CardContent>
                    <div className="text-center py-8 text-sm text-gray-500">
                        <BarChart3 className="w-8 h-8 mx-auto mb-2 text-gray-400" />
                        <p>ĞĞµÑ‚ Ğ´Ğ°Ğ½Ğ½Ñ‹Ñ… Ğ´Ğ»Ñ Ğ¿Ğ¾ÑÑ‚Ñ€Ğ¾ĞµĞ½Ğ¸Ñ Ğ³Ñ€Ğ°Ñ„Ğ¸ĞºĞ°</p>
                        <p className="text-xs">Ğ”Ğ°Ğ½Ğ½Ñ‹Ğµ Ğ¿Ğ¾ÑĞ²ÑÑ‚ÑÑ Ğ¿Ğ¾ÑĞ»Ğµ Ğ¿ĞµÑ€Ğ²Ñ‹Ñ… Ğ°Ñ€ĞµĞ½Ğ´</p>
                    </div>
                </CardContent>
            </Card>
        );
    }

    // Ğ¡Ğ¾Ñ€Ñ‚Ğ¸Ñ€ÑƒĞµĞ¼ Ğ´Ğ°Ğ½Ğ½Ñ‹Ğµ Ğ¿Ğ¾ ĞºĞ¾Ğ»Ğ¸Ñ‡ĞµÑÑ‚Ğ²Ñƒ Ğ°Ñ€ĞµĞ½Ğ´ (Ğ¿Ğ¾ ÑƒĞ±Ñ‹Ğ²Ğ°Ğ½Ğ¸Ñ)
    const sortedData = [...data].sort((a, b) => (b.rental_count || 0) - (a.rental_count || 0));
    
    // Ğ‘ĞµÑ€ĞµĞ¼ Ñ‚Ğ¾Ğ¿-10 Ğ´Ğ»Ñ Ğ¾Ñ‚Ğ¾Ğ±Ñ€Ğ°Ğ¶ĞµĞ½Ğ¸Ñ
    const topData = sortedData.slice(0, 10);
    
    // Ğ”Ğ¾Ğ±Ğ°Ğ²Ğ»ÑĞµĞ¼ fallback ID Ğ´Ğ»Ñ ÑĞ»ĞµĞ¼ĞµĞ½Ñ‚Ğ¾Ğ² Ğ±ĞµĞ· equipment_id
    const dataWithIds = topData.map((item, index) => ({
        ...item,
        equipment_id: item.equipment_id || `fallback-${index}`
    }));
    
    
    // ĞĞ°Ñ…Ğ¾Ğ´Ğ¸Ğ¼ Ğ¼Ğ°ĞºÑĞ¸Ğ¼Ğ°Ğ»ÑŒĞ½Ğ¾Ğµ Ğ·Ğ½Ğ°Ñ‡ĞµĞ½Ğ¸Ğµ Ğ´Ğ»Ñ Ğ½Ğ¾Ñ€Ğ¼Ğ°Ğ»Ğ¸Ğ·Ğ°Ñ†Ğ¸Ğ¸
    const maxRentals = topData.length > 0 ? Math.max(...topData.map(item => item.rental_count || 0)) : 0;


    const totalRentals = data.reduce((sum, item) => sum + (item.rental_count || 0), 0);
    const totalRevenue = data.reduce((sum, item) => sum + (item.revenue || 0), 0);

    return (
        <Card>
            <CardHeader>
                <CardTitle className="flex items-center gap-2">
                    <BarChart3 className="w-5 h-5" />
                    ĞŸĞ¾Ğ¿ÑƒĞ»ÑÑ€Ğ½Ğ¾Ğµ Ğ¾Ğ±Ğ¾Ñ€ÑƒĞ´Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ
                </CardTitle>
            </CardHeader>
            <CardContent className="space-y-6">
                {/* Ğ¡Ğ²Ğ¾Ğ´Ğ½Ğ°Ñ ÑÑ‚Ğ°Ñ‚Ğ¸ÑÑ‚Ğ¸ĞºĞ° */}
                <div className="grid grid-cols-2 gap-4 p-4 bg-gray-50 rounded-lg">
                    <div className="text-center">
                        <div className="flex items-center justify-center gap-1 mb-1">
                            <Package className="w-4 h-4 text-blue-600" />
                            <span className="text-sm font-medium text-gray-600">Ğ’ÑĞµĞ³Ğ¾ Ğ°Ñ€ĞµĞ½Ğ´</span>
                        </div>
                        <div className="text-2xl font-bold text-gray-900">
                            {formatNumber(totalRentals, "0")}
                        </div>
                    </div>
                    <div className="text-center">
                        <div className="flex items-center justify-center gap-1 mb-1">
                            <TrendingUp className="w-4 h-4 text-green-600" />
                            <span className="text-sm font-medium text-gray-600">Ğ’Ñ‹Ñ€ÑƒÑ‡ĞºĞ°</span>
                        </div>
                        <div className="text-2xl font-bold text-gray-900">
                            {formatNumber(totalRevenue, "0")} â‚½
                        </div>
                    </div>
                </div>

                {/* Ğ“Ñ€Ğ°Ñ„Ğ¸Ğº */}
                <div className="space-y-4">
                    {dataWithIds.map((item, index) => (
                        <div key={item.equipment_id} className="space-y-2">
                            <div className="flex justify-between items-center">
                                <div className="flex items-center gap-2">
                                    <span className="text-sm font-medium text-gray-900 truncate max-w-[200px]">
                                        {item.equipment_name}
                                    </span>
                                    {index < 3 && (
                                        <Badge 
                                            variant={index === 0 ? "default" : "secondary"}
                                            className="text-xs"
                                        >
                                            #{index + 1}
                                        </Badge>
                                    )}
                                </div>
                                <div className="text-right">
                                    <div className="text-sm font-semibold text-gray-900">
                                        {formatNumber(item.rental_count, "0")}
                                    </div>
                                    <div className="text-xs text-gray-500">
                                        {formatNumber(item.revenue, "0")} â‚½
                                    </div>
                                </div>
                            </div>
                            <div className="relative">
                                <div className="w-full bg-gray-200 rounded-full h-6 overflow-hidden">
                                    <div 
                                        className={`h-full transition-all duration-500 ease-out ${
                                            index === 0 
                                                ? 'bg-gradient-to-r from-blue-500 to-blue-600' 
                                                : index === 1 
                                                ? 'bg-gradient-to-r from-green-500 to-green-600'
                                                : index === 2
                                                ? 'bg-gradient-to-r from-yellow-500 to-yellow-600'
                                                : 'bg-gradient-to-r from-gray-400 to-gray-500'
                                        }`}
                                        style={{ width: `${maxRentals > 0 ? ((item.rental_count || 0) / maxRentals) * 100 : 0}%` }}
                                    />
                                </div>
                                <div className="absolute inset-0 flex items-center justify-center">
                                    <span className="text-xs font-medium text-white mix-blend-difference">
                                        {maxRentals > 0 ? (((item.rental_count || 0) / maxRentals) * 100).toFixed(1) : 0}%
                                    </span>
                                </div>
                            </div>
                        </div>
                    ))}
                </div>

                {/* Ğ”Ğ¾Ğ¿Ğ¾Ğ»Ğ½Ğ¸Ñ‚ĞµĞ»ÑŒĞ½Ğ°Ñ Ğ¸Ğ½Ñ„Ğ¾Ñ€Ğ¼Ğ°Ñ†Ğ¸Ñ */}
                {data.length > 10 && (
                    <div className="text-center text-sm text-gray-500 pt-2 border-t">
                        ĞŸĞ¾ĞºĞ°Ğ·Ğ°Ğ½Ñ‹ Ñ‚Ğ¾Ğ¿-10 Ğ¸Ğ· {data.length} Ğ¿Ğ¾Ğ·Ğ¸Ñ†Ğ¸Ğ¹
                    </div>
                )}
            </CardContent>
        </Card>
    );
}


```


## <a name="rentalappmainsrccomponentsadmindashboardTodayFocusWidgettsx"></a>`rental-app-main/src/components/admin/dashboard/TodayFocusWidget.tsx`

```tsx
// path: rental-app-main/src/components/admin/dashboard/TodayFocusWidget.tsx

// src/components/admin/dashboard/TodayFocusWidget.tsx

import { useNavigate } from "react-router-dom";
import { Card, CardContent, CardHeader, CardTitle } from "@/components/ui/card";
import { Badge } from "@/components/ui/badge";
import { Skeleton } from "@/components/ui/skeleton";
import { 
    Package, 
    ArrowUpCircle, 
    ArrowDownCircle, 
    AlertTriangle,
    Clock,
    User
} from "lucide-react";
import { differenceInDays } from "date-fns";
import { calculateDaysOverdue } from "@/lib/utils";
import { sortPickupsByPriority, sortOverdueRentalsByDays, getTodayDate } from "@/lib/sortingUtils";
import type { PickupReturnItem, OverdueRentalItem } from "@/hooks/admin/useDashboardData";

interface TodayFocusWidgetProps {
    data: {
        pickups_today: PickupReturnItem[];
        returns_today: PickupReturnItem[];
        overdue_rentals: OverdueRentalItem[];
    };
    isLoading: boolean;
}

export default function TodayFocusWidget({ data, isLoading }: TodayFocusWidgetProps) {
    const navigate = useNavigate();
    
    // ĞŸĞ¾Ğ»ÑƒÑ‡Ğ°ĞµĞ¼ ÑĞµĞ³Ğ¾Ğ´Ğ½ÑÑˆĞ½ÑÑ Ğ´Ğ°Ñ‚Ñƒ Ñ Ğ¾Ğ±Ğ½ÑƒĞ»ĞµĞ½Ğ½Ñ‹Ğ¼ Ğ²Ñ€ĞµĞ¼ĞµĞ½ĞµĞ¼ Ğ´Ğ»Ñ ĞºĞ¾Ñ€Ñ€ĞµĞºÑ‚Ğ½Ğ¾Ğ³Ğ¾ ÑÑ€Ğ°Ğ²Ğ½ĞµĞ½Ğ¸Ñ
    const today = getTodayDate();

    const handlePickupClick = (item: PickupReturnItem) => {
        navigate('/admin/reservations', {
            state: {
                highlightId: item.id,
                statusFilterOverride: 'active' // ĞŸĞ¾ĞºĞ°Ğ·Ñ‹Ğ²Ğ°ĞµĞ¼ Ğ°ĞºÑ‚Ğ¸Ğ²Ğ½Ñ‹Ğµ, Ñ‡Ñ‚Ğ¾Ğ±Ñ‹ Ğ½Ğ°Ğ¹Ñ‚Ğ¸ Ğ½ÑƒĞ¶Ğ½Ñ‹Ğ¹
            }
        });
    };

    const handleReturnClick = (item: PickupReturnItem) => {
        navigate('/admin/rentals', {
            state: {
                highlightId: item.id,
                statusFilterOverride: 'active'
            }
        });
    };

    const handleOverdueClick = (item: OverdueRentalItem) => {
        navigate('/admin/rentals', {
            state: {
                highlightId: item.id,
                statusFilterOverride: 'overdue'
            }
        });
    };

    if (isLoading) {
        return (
            <Card>
                <CardHeader>
                    <CardTitle className="flex items-center gap-2">
                        <Package className="w-5 h-5" />
                        Ğ¤Ğ¾ĞºÑƒÑ Ğ½Ğ° ÑĞµĞ³Ğ¾Ğ´Ğ½Ñ
                    </CardTitle>
                </CardHeader>
                <CardContent className="space-y-4">
                    <div className="space-y-2">
                        <Skeleton className="h-4 w-24" />
                        <Skeleton className="h-16 w-full" />
                    </div>
                    <div className="space-y-2">
                        <Skeleton className="h-4 w-24" />
                        <Skeleton className="h-16 w-full" />
                    </div>
                    <div className="space-y-2">
                        <Skeleton className="h-4 w-24" />
                        <Skeleton className="h-16 w-full" />
                    </div>
                </CardContent>
            </Card>
        );
    }

    const renderPickupItem = (item: PickupReturnItem) => {
        // ĞĞ¿Ñ€ĞµĞ´ĞµĞ»ÑĞµĞ¼, ÑĞ²Ğ»ÑĞµÑ‚ÑÑ Ğ»Ğ¸ Ğ²Ñ‹Ğ´Ğ°Ñ‡Ğ° "Ğ¾Ğ¶Ğ¸Ğ´Ğ°ÑÑ‰ĞµĞ¹"
        const itemStartDate = item.start_date ? new Date(item.start_date) : null;
        const isPendingPickup = itemStartDate && itemStartDate < today;
        const daysPassed = itemStartDate ? differenceInDays(today, itemStartDate) : 0;

        // ĞĞ¿Ñ€ĞµĞ´ĞµĞ»ÑĞµĞ¼ ĞºĞ»Ğ°ÑÑÑ‹ Ğ¸ Ñ‚ĞµĞºÑÑ‚ Ğ½Ğ° Ğ¾ÑĞ½Ğ¾Ğ²Ğµ ÑÑ‚Ğ°Ñ‚ÑƒÑĞ°
        const bgColor = isPendingPickup ? "bg-cyan-50 hover:bg-cyan-100" : "bg-blue-50 hover:bg-blue-100";
        const iconColor = isPendingPickup ? "text-cyan-600" : "text-blue-600";
        const badgeText = isPendingPickup ? `Ğš Ğ²Ñ‹Ğ´Ğ°Ñ‡Ğµ (-${daysPassed} Ğ´Ğ½.)` : "Ğ’Ñ‹Ğ´Ğ°Ñ‡Ğ° ÑĞµĞ³Ğ¾Ğ´Ğ½Ñ";
        const badgeVariant = isPendingPickup ? "outline" : "secondary";

        return (
            <div 
                key={item.id}
                className={`flex items-center justify-between p-3 rounded-lg cursor-pointer ${bgColor} transition-colors`}
                onClick={() => handlePickupClick(item)}
            >
                <div className="flex-1 min-w-0">
                    <div className="flex items-center gap-2 mb-1">
                        <User className={`w-4 h-4 ${iconColor} flex-shrink-0`} />
                        <span className="font-medium text-sm truncate">{item.user_name}</span>
                    </div>
                    <div className="flex items-center gap-2 text-xs text-gray-600">
                        <Package className="w-3 h-3 flex-shrink-0" />
                        <span className="truncate">{item.equipment_name}</span>
                    </div>
                </div>
                <div className="text-right ml-2">
                    <div className="flex items-center justify-end gap-1 text-xs text-gray-500 mb-1">
                        <Clock className="w-3 h-3" />
                        <span>{item.scheduled_time ? new Date(item.scheduled_time).toLocaleDateString('ru-RU') : 'ĞĞµ ÑƒĞºĞ°Ğ·Ğ°Ğ½Ğ¾'}</span>
                    </div>
                    <Badge variant={badgeVariant} className="text-xs">
                        {badgeText}
                    </Badge>
                </div>
            </div>
        );
    };

    const renderReturnItem = (item: PickupReturnItem) => (
        <div 
            key={item.id}
            className="flex items-center justify-between p-3 bg-green-50 rounded-lg cursor-pointer hover:bg-green-100 transition-colors"
            onClick={() => handleReturnClick(item)}
        >
            <div className="flex-1 min-w-0">
                <div className="flex items-center gap-2 mb-1">
                    <User className="w-4 h-4 text-green-600 flex-shrink-0" />
                    <span className="font-medium text-sm truncate">{item.user_name}</span>
                </div>
                <div className="flex items-center gap-2 text-xs text-gray-600">
                    <Package className="w-3 h-3 flex-shrink-0" />
                    <span className="truncate">{item.equipment_name}</span>
                </div>
            </div>
            <div className="text-right ml-2">
                <div className="flex items-center justify-end gap-1 text-xs text-gray-500 mb-1">
                    <Clock className="w-3 h-3" />
                    <span>{item.scheduled_time ? new Date(item.scheduled_time).toLocaleDateString('ru-RU') : 'ĞĞµ ÑƒĞºĞ°Ğ·Ğ°Ğ½Ğ¾'}</span>
                </div>
                <Badge variant="secondary" className="text-xs">
                    {item.status}
                </Badge>
            </div>
        </div>
    );

    const renderOverdueItem = (item: OverdueRentalItem) => {
        // Ğ˜ÑĞ¿Ğ¾Ğ»ÑŒĞ·ÑƒĞµĞ¼ ÑƒÑ‚Ğ¸Ğ»Ğ¸Ñ‚Ğ°Ñ€Ğ½ÑƒÑ Ñ„ÑƒĞ½ĞºÑ†Ğ¸Ñ Ğ´Ğ»Ñ Ğ²Ñ‹Ñ‡Ğ¸ÑĞ»ĞµĞ½Ğ¸Ñ Ğ´Ğ½ĞµĞ¹ Ğ¿Ñ€Ğ¾ÑÑ€Ğ¾Ñ‡ĞºĞ¸
        const daysOverdue = calculateDaysOverdue(item.due_date, item.days_overdue);

        return (
            <div 
                key={item.id}
                className="flex items-center justify-between p-3 bg-red-50 rounded-lg cursor-pointer hover:bg-red-100 transition-colors"
                onClick={() => handleOverdueClick(item)}
            >
                <div className="flex-1 min-w-0">
                    <div className="flex items-center gap-2 mb-1">
                        <User className="w-4 h-4 text-red-600 flex-shrink-0" />
                        <span className="font-medium text-sm truncate">{item.user_name}</span>
                    </div>
                    <div className="flex items-center gap-2 text-xs text-gray-600">
                        <Package className="w-3 h-3 flex-shrink-0" />
                        <span className="truncate">{item.equipment_name}</span>
                    </div>
                </div>
                <div className="text-right ml-2">
                    <div className="flex items-center justify-end gap-1 text-xs text-red-600 mb-1">
                        <AlertTriangle className="w-3 h-3" />
                        <span>
                            {daysOverdue > 0 ? `${daysOverdue} Ğ´Ğ½.` : 'ĞŸÑ€Ğ¾ÑÑ€Ğ¾Ñ‡ĞµĞ½Ğ¾'}
                        </span>
                    </div>
                    <Badge variant="destructive" className="text-xs">
                        ĞŸÑ€Ğ¾ÑÑ€Ğ¾Ñ‡ĞµĞ½Ğ¾
                    </Badge>
                </div>
            </div>
        );
    };

    return (
        <Card>
            <CardHeader>
                <CardTitle className="flex items-center gap-2">
                    <Package className="w-5 h-5" />
                    Ğ¤Ğ¾ĞºÑƒÑ Ğ½Ğ° ÑĞµĞ³Ğ¾Ğ´Ğ½Ñ
                </CardTitle>
            </CardHeader>
            <CardContent className="space-y-6">
                {/* Ğ’Ñ‹Ğ´Ğ°Ñ‡Ğ¸ ÑĞµĞ³Ğ¾Ğ´Ğ½Ñ */}
                <div>
                    <div className="flex items-center gap-2 mb-3">
                        <ArrowUpCircle className="w-4 h-4 text-blue-600" />
                        <h3 className="font-medium text-sm">Ğ’Ñ‹Ğ´Ğ°Ñ‡Ğ¸ ÑĞµĞ³Ğ¾Ğ´Ğ½Ñ</h3>
                        <Badge variant="outline" className="text-xs">
                            {data.pickups_today.length}
                        </Badge>
                    </div>
                    <div className="space-y-2">
                        {data.pickups_today.length > 0 ? (
                            sortPickupsByPriority(data.pickups_today, today).map(renderPickupItem)
                        ) : (
                            <div className="text-center py-4 text-sm text-gray-500">
                                Ğ¡ĞµĞ³Ğ¾Ğ´Ğ½Ñ Ğ½ĞµÑ‚ Ğ²Ñ‹Ğ´Ğ°Ñ‡
                            </div>
                        )}
                    </div>
                </div>

                {/* Ğ’Ğ¾Ğ·Ğ²Ñ€Ğ°Ñ‚Ñ‹ ÑĞµĞ³Ğ¾Ğ´Ğ½Ñ */}
                <div>
                    <div className="flex items-center gap-2 mb-3">
                        <ArrowDownCircle className="w-4 h-4 text-green-600" />
                        <h3 className="font-medium text-sm">Ğ’Ğ¾Ğ·Ğ²Ñ€Ğ°Ñ‚Ñ‹ ÑĞµĞ³Ğ¾Ğ´Ğ½Ñ</h3>
                        <Badge variant="outline" className="text-xs">
                            {data.returns_today.length}
                        </Badge>
                    </div>
                    <div className="space-y-2">
                        {data.returns_today.length > 0 ? (
                            data.returns_today.map(renderReturnItem)
                        ) : (
                            <div className="text-center py-4 text-sm text-gray-500">
                                Ğ¡ĞµĞ³Ğ¾Ğ´Ğ½Ñ Ğ½ĞµÑ‚ Ğ²Ğ¾Ğ·Ğ²Ñ€Ğ°Ñ‚Ğ¾Ğ²
                            </div>
                        )}
                    </div>
                </div>

                {/* ĞŸÑ€Ğ¾ÑÑ€Ğ¾Ñ‡ĞµĞ½Ğ½Ñ‹Ğµ Ğ°Ñ€ĞµĞ½Ğ´Ñ‹ */}
                <div>
                    <div className="flex items-center gap-2 mb-3">
                        <AlertTriangle className="w-4 h-4 text-red-600" />
                        <h3 className="font-medium text-sm">ĞŸÑ€Ğ¾ÑÑ€Ğ¾Ñ‡ĞµĞ½Ğ½Ñ‹Ğµ Ğ°Ñ€ĞµĞ½Ğ´Ñ‹</h3>
                        <Badge variant="outline" className="text-xs">
                            {data.overdue_rentals.length}
                        </Badge>
                    </div>
                    <div className="space-y-2">
                        {data.overdue_rentals.length > 0 ? (
                            sortOverdueRentalsByDays(data.overdue_rentals).map(renderOverdueItem)
                        ) : (
                            <div className="text-center py-4 text-sm text-gray-500">
                                ĞĞµÑ‚ Ğ¿Ñ€Ğ¾ÑÑ€Ğ¾Ñ‡ĞµĞ½Ğ½Ñ‹Ñ… Ğ°Ñ€ĞµĞ½Ğ´
                            </div>
                        )}
                    </div>
                </div>
            </CardContent>
        </Card>
    );
}


```


## <a name="rentalappmainsrccomponentscalendarCalendarDateInputRangetsx"></a>`rental-app-main/src/components/calendar/CalendarDateInputRange.tsx`

```tsx
// path: rental-app-main/src/components/calendar/CalendarDateInputRange.tsx

// src/components/calendar/CalendarDateInputRange.tsx

import { useDateStore } from "@/store/dateStore";
import { useDateRange } from "@/hooks/useDateRange";

export default function CalendarDateInputRange() {
    // âœ… Ğ˜Ğ¡ĞŸĞ ĞĞ’Ğ›Ğ•ĞĞ: ĞŸĞ¾Ğ»ÑƒÑ‡Ğ°ĞµĞ¼ Ğ°ĞºÑ‚ÑƒĞ°Ğ»ÑŒĞ½Ñ‹Ğµ startDate, endDate Ğ¸ setRange Ğ¸Ğ· Ñ…Ñ€Ğ°Ğ½Ğ¸Ğ»Ğ¸Ñ‰Ğ°
    const { startDate, endDate, setRange } = useDateStore();

    const {
        localStartDate,
        localEndDate,
        handleStartDateChange,
        handleEndDateChange
    } = useDateRange({
        // âœ… Ğ˜Ğ¡ĞŸĞ ĞĞ’Ğ›Ğ•ĞĞ: ĞŸĞµÑ€ĞµĞ´Ğ°Ñ‘Ğ¼ Ğ°ĞºÑ‚ÑƒĞ°Ğ»ÑŒĞ½Ñ‹Ğµ Ğ´Ğ°Ñ‚Ñ‹ Ğ² Ñ…ÑƒĞº
        startDate,
        endDate,
        onRangeChange: (start, end, source) => setRange(start, end, source)
    });

    return (
        <div className="flex items-center gap-2" role="group" aria-labelledby="date-range-label">
            <span id="date-range-label" className="sr-only">Ğ’Ñ‹Ğ±Ğ¾Ñ€ Ğ´Ğ¸Ğ°Ğ¿Ğ°Ğ·Ğ¾Ğ½Ğ° Ğ´Ğ°Ñ‚ ĞºĞ°Ğ»ĞµĞ½Ğ´Ğ°Ñ€Ñ</span>
            <label htmlFor="calendar-start-date" className="text-sm text-gray-700 shrink-0">
                Ğ¡:
            </label>
            <input
                id="calendar-start-date"
                type="date"
                value={localStartDate}
                onChange={handleStartDateChange}
                className="border border-gray-300 rounded px-2 py-1.5 text-sm focus:ring-2 focus:ring-sky-500 focus:border-sky-500"
                aria-label="Ğ”Ğ°Ñ‚Ğ° Ğ½Ğ°Ñ‡Ğ°Ğ»Ğ° Ğ´Ğ»Ñ ĞºĞ°Ğ»ĞµĞ½Ğ´Ğ°Ñ€Ñ"
            />

            <label htmlFor="calendar-end-date" className="text-sm text-gray-700 shrink-0">
                ĞŸĞ¾:
            </label>
            <input
                id="calendar-end-date"
                type="date"
                value={localEndDate}
                onChange={handleEndDateChange}
                className="border border-gray-300 rounded px-2 py-1.5 text-sm focus:ring-2 focus:ring-sky-500 focus:border-sky-500"
                aria-label="Ğ”Ğ°Ñ‚Ğ° Ğ¾ĞºĞ¾Ğ½Ñ‡Ğ°Ğ½Ğ¸Ñ Ğ´Ğ»Ñ ĞºĞ°Ğ»ĞµĞ½Ğ´Ğ°Ñ€Ñ"
                min={localStartDate}
            />
        </div>
    );
}

```


## <a name="rentalappmainsrccomponentscalendarCalendarFiltersBlocktsx"></a>`rental-app-main/src/components/calendar/CalendarFiltersBlock.tsx`

```tsx
// path: rental-app-main/src/components/calendar/CalendarFiltersBlock.tsx

// src/components/calendar/CalendarFiltersBlock.tsx
import CalendarDateInputRange from "@/components/calendar/CalendarDateInputRange";
import { Button } from "@/components/ui/button";
import { FilterX } from "lucide-react";
import type { Equipment } from "@/types/equipment";

type Props = {
    equipment: Equipment[];
    typeFilter: string | null;
    setTypeFilter: (v: string | null) => void;
    brandFilter: string | null;
    setBrandFilter: (v: string | null) => void;
    searchText: string;
    setSearchText: (v: string) => void;
    onReset: () => void;
};

export default function CalendarFiltersBlock({
                                                 equipment,
                                                 typeFilter,
                                                 setTypeFilter,
                                                 brandFilter,
                                                 setBrandFilter,
                                                 searchText,
                                                 setSearchText,
                                                 onReset,
                                             }: Props) {
    const types = Array.from(new Set(equipment.map((e) => e.equipment_type)));
    const brands = Array.from(new Set(equipment.map((e) => e.brand)));

    return (
        <div className="flex flex-col gap-4 mb-5 p-4 bg-gray-50 border border-gray-200 rounded-lg shadow-sm print:hidden">
            <div className="flex flex-col md:flex-row md:items-end md:justify-between gap-2">
                <div className="flex flex-col gap-2">
                    <input
                        type="text"
                        placeholder="ĞŸĞ¾Ğ¸ÑĞº Ğ¿Ğ¾ Ğ½Ğ°Ğ·Ğ²Ğ°Ğ½Ğ¸Ñ..."
                        value={searchText}
                        onChange={(e) => setSearchText(e.target.value)}
                        className="border px-3 py-1 rounded-md text-sm w-[250px]"
                    />
                    <CalendarDateInputRange />
                </div>
                <Button
                    variant="ghost"
                    onClick={onReset}
                    className="text-gray-600 hover:text-sky-700"
                >
                    <FilterX className="w-4 h-4 mr-1" />
                    Ğ¡Ğ±Ñ€Ğ¾ÑĞ¸Ñ‚ÑŒ
                </Button>
            </div>

            <div className="flex flex-wrap items-center gap-2">
                <span className="text-sm text-gray-600 mr-2">Ğ¢Ğ¸Ğ¿:</span>
                <Button
                    variant="filter"
                    data-state={typeFilter === null ? "on" : "off"}
                    onClick={() => setTypeFilter(null)}
                >
                    Ğ’ÑĞµ
                </Button>
                {types.map((type) => (
                    <Button
                        key={type}
                        variant="filter"
                        data-state={typeFilter === type ? "on" : "off"}
                        onClick={() => setTypeFilter(type)}
                    >
                        {type}
                    </Button>
                ))}
            </div>

            <div className="flex flex-wrap items-center gap-2">
                <span className="text-sm text-gray-600 mr-2">Ğ‘Ñ€ĞµĞ½Ğ´:</span>
                <Button
                    variant="filter"
                    data-state={brandFilter === null ? "on" : "off"}
                    onClick={() => setBrandFilter(null)}
                >
                    Ğ’ÑĞµ
                </Button>
                {brands.map((brand) => (
                    <Button
                        key={brand}
                        variant="filter"
                        data-state={brandFilter === brand ? "on" : "off"}
                        onClick={() => setBrandFilter(brand)}
                    >
                        {brand}
                    </Button>
                ))}
            </div>
        </div>
    );
}


```


## <a name="rentalappmainsrccomponentscalendarCalendarTabletsx"></a>`rental-app-main/src/components/calendar/CalendarTable.tsx`

```tsx
// path: rental-app-main/src/components/calendar/CalendarTable.tsx

// src/components/calendar/CalendarTable.tsx
import { useCalendarGrid } from "@/hooks/useCalendarGrid";
import { format } from "date-fns";
import { useDateStore } from "@/store/dateStore";
import { useCalendarSelectionStore } from "@/store/calendarSelectionStore";
// import { useCurrentUser } from "@/hooks/useProfile"; // ĞĞµ Ğ¸ÑĞ¿Ğ¾Ğ»ÑŒĞ·ÑƒĞµÑ‚ÑÑ Ğ½Ğ°Ğ¿Ñ€ÑĞ¼ÑƒÑ Ğ´Ğ»Ñ ÑÑ‚Ğ¸Ğ»Ğ¸Ğ·Ğ°Ñ†Ğ¸Ğ¸
import type { DayStatus, EquipmentStatus } from "@/types/availability";

type Equipment = {
    id: number;
    name: string;
    brand: string;
    equipment_type: string;
};

function getDateRange(start: Date, end: Date): Date[] {
    const days = [];
    let d = new Date(start);
    while (d <= end) {
        days.push(new Date(d));
        d.setDate(d.getDate() + 1);
    }
    return days;
}

function formatDateToDayMonthYear(date: Date): string {
    return format(date, "dd.MM.yyyy");
}

const cellBgMap: Record<string, string> = {
    available: "bg-emerald-50",
    reserved: "bg-amber-300",  // Ğ§ÑƒĞ¶Ğ¸Ğµ Ñ€ĞµĞ·ĞµÑ€Ğ²Ñ‹
    rented: "bg-rose-400",     // Ğ§ÑƒĞ¶Ğ¸Ğµ Ğ°Ñ€ĞµĞ½Ğ´Ñ‹
};

const userCellBgMap: Record<string, string> = {
    available: "bg-emerald-50", // Ğ¡Ğ²Ğ¾Ğ±Ğ¾Ğ´Ğ½Ñ‹Ğµ ÑÑ‡ĞµĞ¹ĞºĞ¸ Ğ¾Ğ´Ğ¸Ğ½Ğ°ĞºĞ¾Ğ²Ñ‹ Ğ´Ğ»Ñ Ğ²ÑĞµÑ…
    reserved: "bg-amber-500",  // Ğ¡Ğ’ĞĞ™ Ñ€ĞµĞ·ĞµÑ€Ğ² - Ñ‚ĞµĞ¼Ğ½ĞµĞµ
    rented: "bg-rose-600",     // Ğ¡Ğ’ĞĞ¯ Ğ°Ñ€ĞµĞ½Ğ´Ğ° (ĞµÑĞ»Ğ¸ Ğ¿Ñ€Ğ¸Ğ¼ĞµĞ½Ğ¸Ğ¼Ğ¾ Ğ¸ Ğ½ÑƒĞ¶Ğ½Ğ¾ Ğ¾Ñ‚Ğ»Ğ¸Ñ‡Ğ°Ñ‚ÑŒ) - Ñ‚ĞµĞ¼Ğ½ĞµĞµ
};

export default function CalendarTable({ equipment }: { equipment: Equipment[] }) {
    const { startDate, endDate } = useDateStore();
    const { data: calendarDataFromHook, isLoading, isError, refetch } = useCalendarGrid();
    const { selectedGroupId, setSelectedGroupId } = useCalendarSelectionStore();

    if (!startDate || !endDate) return null;
    if (isLoading) return <div className="p-6 text-center">Ğ—Ğ°Ğ³Ñ€ÑƒĞ·ĞºĞ°...</div>;
    if (isError)
        return (
            <div className="p-6 text-center text-red-700">
                ĞÑˆĞ¸Ğ±ĞºĞ° Ğ·Ğ°Ğ³Ñ€ÑƒĞ·ĞºĞ¸ <button onClick={() => refetch()} className="underline hover:text-red-800">ĞŸĞ¾Ğ²Ñ‚Ğ¾Ñ€Ğ¸Ñ‚ÑŒ</button>
            </div>
        );
    if (!equipment.length || !calendarDataFromHook || Object.keys(calendarDataFromHook).length === 0)
        return <div className="p-6 text-center text-gray-500">ĞĞµÑ‚ Ğ´Ğ°Ğ½Ğ½Ñ‹Ñ… Ğ´Ğ»Ñ Ğ²Ñ‹Ğ±Ñ€Ğ°Ğ½Ğ½Ñ‹Ñ… Ñ„Ğ¸Ğ»ÑŒÑ‚Ñ€Ğ¾Ğ²</div>;

    const dateRange = getDateRange(startDate, endDate);
    const todayStr = formatDateToDayMonthYear(new Date());

    return (
        <div
            className="overflow-x-auto rounded-xl border bg-white shadow"
            onClick={() => setSelectedGroupId(null)} // ÑĞ±Ñ€Ğ¾Ñ Ğ²Ñ‹Ğ´ĞµĞ»ĞµĞ½Ğ¸Ñ Ğ¿Ñ€Ğ¸ ĞºĞ»Ğ¸ĞºĞµ Ğ²Ğ½Ğµ ÑÑ‡ĞµĞµĞº
        >
            <table className="min-w-max table-auto border-collapse">
                <thead>
                <tr>
                    <th
                        className="sticky left-0 z-20 bg-white border-b px-4 py-2 text-sm font-semibold min-w-[220px]"
                        style={{ boxShadow: "2px 0 6px -2px #e0e7ef" }}
                    >
                        ĞĞ±Ğ¾Ñ€ÑƒĞ´Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ
                    </th>
                    {dateRange.map((date) => {
                        const dateStr = formatDateToDayMonthYear(date);
                        const isToday = dateStr === todayStr;

                        return (
                            <th
                                key={dateStr}
                                className={`sticky top-0 z-10 border-b px-2 py-1 text-xs font-medium min-w-[90px] truncate ${
                                    isToday
                                        ? "bg-sky-100 text-sky-800 border-sky-400 border-b-2 today-column"
                                        : "bg-white"
                                }`}
                            >
                                {dateStr}
                            </th>
                        );
                    })}
                </tr>
                </thead>
                <tbody>
                {equipment.map((item) => (
                    <tr key={item.id}>
                        <td className="sticky left-0 bg-white border-r px-3 py-1 z-10 min-w-[220px] text-xs text-gray-800 truncate">
                            {item.equipment_type} {item.brand} {item.name}
                        </td>
                        {dateRange.map((date) => {
                            const dateStr = formatDateToDayMonthYear(date);

                            const cellItemData = calendarDataFromHook[item.id]?.[dateStr];

                            let cell: DayStatus | undefined;

                            // Ğ‘ÑĞºĞµĞ½Ğ´ Ñ‚ĞµĞ¿ĞµÑ€ÑŒ Ğ²ÑĞµĞ³Ğ´Ğ° Ğ´Ğ¾Ğ»Ğ¶ĞµĞ½ Ğ²Ğ¾Ğ·Ğ²Ñ€Ğ°Ñ‰Ğ°Ñ‚ÑŒ Ğ¾Ğ±ÑŠĞµĞºÑ‚ DayStatusItem (ĞºĞ¾Ñ‚Ğ¾Ñ€Ñ‹Ğ¹ ÑĞ¾Ğ¾Ñ‚Ğ²ĞµÑ‚ÑÑ‚Ğ²ÑƒĞµÑ‚ DayStatus Ğ½Ğ° Ñ„Ñ€Ğ¾Ğ½Ñ‚Ğµ)
                            if (typeof cellItemData === 'object' && cellItemData !== null && 'status' in cellItemData) {
                                cell = cellItemData as DayStatus;
                            } else if (typeof cellItemData === 'string') {
                                // Ğ­Ñ‚Ğ¾Ñ‚ Ğ±Ğ»Ğ¾Ğº Ğ´Ğ»Ñ Ğ¾Ğ±Ñ€Ğ°Ñ‚Ğ½Ğ¾Ğ¹ ÑĞ¾Ğ²Ğ¼ĞµÑÑ‚Ğ¸Ğ¼Ğ¾ÑÑ‚Ğ¸, ĞµÑĞ»Ğ¸ Ğ±ÑĞºĞµĞ½Ğ´ Ğ’Ğ”Ğ Ğ£Ğ“ Ğ²ĞµÑ€Ğ½ĞµÑ‚ ÑÑ‚Ñ€Ğ¾ĞºÑƒ
                                console.warn(`[CalendarTable] Received string status for ${item.name} on ${dateStr}. Expected DayStatus object.`);
                                cell = { status: cellItemData as EquipmentStatus, group_id: null, is_user_reservation: false };
                            }

                            const status: EquipmentStatus = cell?.status || "available";
                            const groupId: string | null = cell?.group_id || null;
                            const isUserReservation: boolean = cell?.is_user_reservation || false;
                            const isToday = dateStr === todayStr;

                            const isHighlighted: boolean = !!(groupId && groupId === selectedGroupId);

                            const handleClick = (e: React.MouseEvent) => {
                                e.stopPropagation();
                                setSelectedGroupId(groupId === selectedGroupId ? null : groupId);
                            };

                            const currentBgMap = isUserReservation ? userCellBgMap : cellBgMap;
                            const bgColor = currentBgMap[status] || currentBgMap['available']; // Ğ¤Ğ¾Ğ»Ğ±ÑĞº Ğ½Ğ° 'available'

                            return (
                                <td
                                    key={dateStr}
                                    className={`p-[2px] border border-white ${isToday ? "today-column" : ""}`}
                                    onClick={handleClick}
                                    style={{ cursor: groupId ? 'pointer' : 'default' }} // Ğ”Ğ¾Ğ±Ğ°Ğ²Ğ»ÑĞµĞ¼ ĞºÑƒÑ€ÑĞ¾Ñ€, ĞµÑĞ»Ğ¸ ĞµÑÑ‚ÑŒ groupId
                                >
                                    <div
                                        className={`w-full h-6 rounded-md transition-colors ${bgColor} ${
                                            isHighlighted ? "ring-2 ring-black/40 ring-inset opacity-90" : ""
                                        }`}
                                        title={status + (isUserReservation ? " (Ğ¼Ğ¾Ğ¹)" : "") + (groupId ? ` (Ğ³Ñ€ÑƒĞ¿Ğ¿Ğ°: ${groupId})` : "")}
                                    >
                                        <span className="sr-only">{status}{isUserReservation ? " (Ğ¼Ğ¾Ğ¹)" : ""}{groupId ? ` (Ğ³Ñ€ÑƒĞ¿Ğ¿Ğ°: ${groupId})` : ""}</span>
                                    </div>
                                </td>
                            );
                        })}
                    </tr>
                ))}
                </tbody>
            </table>
        </div>
    );
}

```


## <a name="rentalappmainsrccomponentscatalogEquipmentCatalogtsx"></a>`rental-app-main/src/components/catalog/EquipmentCatalog.tsx`

```tsx
// path: rental-app-main/src/components/catalog/EquipmentCatalog.tsx

// src/components/catalog/EquipmentCatalog.tsx

import { useMemo } from "react";
import FilterPanel from "@/components/FilterPanel";
import EquipmentGrid from "@/components/EquipmentGrid";
import { useAppFilters } from "@/hooks/features/useAppFilters";
import { useAssociations } from "@/hooks/useAssociations";
import { useAllEquipment } from "@/hooks/useAllEquipment";
import { useEquipmentData } from "@/hooks/data/useEquipmentData";
import { useReservationManagement } from "@/hooks/useReservationManagement";
import { useViewModeStore } from "@/store/viewModeStore";

interface EquipmentCatalogProps {
    editingReservationId?: number;
    intent?: string;
}

/**
 * ĞšĞ¾Ğ¼Ğ¿Ğ¾Ğ½ĞµĞ½Ñ‚ ĞºĞ°Ñ‚Ğ°Ğ»Ğ¾Ğ³Ğ° Ğ¾Ğ±Ğ¾Ñ€ÑƒĞ´Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ.
 * Ğ˜Ğ½ĞºĞ°Ğ¿ÑÑƒĞ»Ğ¸Ñ€ÑƒĞµÑ‚ Ğ¾Ñ‚Ğ¾Ğ±Ñ€Ğ°Ğ¶ĞµĞ½Ğ¸Ğµ Ğ¸ Ñ„Ğ¸Ğ»ÑŒÑ‚Ñ€Ğ°Ñ†Ğ¸Ñ ĞºĞ°Ñ‚Ğ°Ğ»Ğ¾Ğ³Ğ° Ğ¾Ğ±Ğ¾Ñ€ÑƒĞ´Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ.
 */
export default function EquipmentCatalog({ editingReservationId: _editingReservationId, intent: _intent }: EquipmentCatalogProps) {
    const { viewMode } = useViewModeStore();

    // 1. ĞŸĞ¾Ğ»ÑƒÑ‡Ğ°ĞµĞ¼ ÑĞ¾ÑÑ‚Ğ¾ÑĞ½Ğ¸Ğµ Ñ„Ğ¸Ğ»ÑŒÑ‚Ñ€Ğ¾Ğ²
    const { query, type, brand, availableOnly, associationId, reset: resetFilters, startDate, endDate } = useAppFilters();

    // 2. ĞŸĞ¾Ğ»ÑƒÑ‡Ğ°ĞµĞ¼ Ğ´Ğ°Ğ½Ğ½Ñ‹Ğµ Ğ´Ğ»Ñ Ñ„Ğ¸Ğ»ÑŒÑ‚Ñ€Ğ¾Ğ²
    const { data: _associations = [] } = useAssociations();
    const { data: allEquipmentForFilters = [] } = useAllEquipment();

    // 3. Ğ’Ñ‹Ğ·Ñ‹Ğ²Ğ°ĞµĞ¼ Ñ…ÑƒĞº Ğ´Ğ»Ñ Ğ¿Ğ¾Ğ»ÑƒÑ‡ĞµĞ½Ğ¸Ñ Ğ´Ğ°Ğ½Ğ½Ñ‹Ñ… Ñ ÑƒÑ‡ĞµÑ‚Ğ¾Ğ¼ Ñ„Ğ¸Ğ»ÑŒÑ‚Ñ€Ğ¾Ğ²
    const {
        equipment,
        totalEquipmentCount: _totalEquipmentCount,
        availabilityData,
        dailyAvailabilityData,
        isLoading,
        isFetchingNextPage,
        hasNextPage,
        fetchNextPage
    } = useEquipmentData({ 
        query, 
        type: type || undefined, 
        brand, 
        associationId: associationId || undefined, 
        availableOnly, 
        startDate: startDate as Date | undefined, 
        endDate: endDate as Date | undefined 
    });

    // Ğ¡Ğ¾Ğ·Ğ´Ğ°ĞµĞ¼ availabilityMap Ğ¸Ğ· availabilityData Ğ´Ğ»Ñ useReservationManagement
    const availabilityMap = useMemo(() => {
        const map: Record<number, any> = {};
        availabilityData?.forEach((info) => {
            map[info.equipment_id] = info;
        });
        return map;
    }, [availabilityData]);

    // 4. Ğ’Ñ‹Ğ·Ñ‹Ğ²Ğ°ĞµĞ¼ Ñ…ÑƒĞº Ğ´Ğ»Ñ Ğ»Ğ¾Ğ³Ğ¸ĞºĞ¸ ÑƒĞ¿Ñ€Ğ°Ğ²Ğ»ĞµĞ½Ğ¸Ñ Ñ€ĞµĞ·ĞµÑ€Ğ²Ğ°Ğ¼Ğ¸
    const {
        getEquipmentStatus
    } = useReservationManagement(equipment, availabilityMap, availableOnly);

    // Ğ’Ñ‹Ñ‡Ğ¸ÑĞ»ÑĞµĞ¼ Ğ´Ğ¾Ğ¿Ğ¾Ğ»Ğ½Ğ¸Ñ‚ĞµĞ»ÑŒĞ½Ñ‹Ğµ Ğ·Ğ½Ğ°Ñ‡ĞµĞ½Ğ¸Ñ
    const hasActiveFilters = !!(type || (brand && brand !== "__all__") || query || associationId);

    return (
        <>
            <FilterPanel equipmentData={allEquipmentForFilters} />

            <EquipmentGrid
                isLoading={isLoading}
                items={equipment}
                hasActiveFilters={hasActiveFilters}
                getEquipmentStatus={getEquipmentStatus}
                dailyAvailabilityData={dailyAvailabilityData}
                availabilityData={availabilityData}
                onShowMore={fetchNextPage}
                onResetFilters={resetFilters}
                viewMode={viewMode}
                isFetchingNextPage={isFetchingNextPage}
                hasNextPage={hasNextPage}
            />
        </>
    );
}


```


## <a name="rentalappmainsrccomponentsequipmentcardAccessoriesSectiontsx"></a>`rental-app-main/src/components/equipment-card/AccessoriesSection.tsx`

```tsx
// path: rental-app-main/src/components/equipment-card/AccessoriesSection.tsx

// src/components/equipment-card/AccessoriesSection.tsx
import React from 'react';
import { Paperclip, ChevronDown } from "lucide-react";
import { Label } from "@/components/ui/label";
import { Checkbox } from "@/components/ui/checkbox";
import type { Equipment } from "@/types/equipment";

interface AccessoriesSectionProps {
    equipment: Equipment;
    isExpanded: boolean;
    isDisabled: boolean;
    onToggleExpand: (e: React.MouseEvent) => void;
    onToggleAccessory: (accId: number) => void;
    isAccessorySelected: (eqId: number, accId: number) => boolean;
}

export const AccessoriesSection: React.FC<AccessoriesSectionProps> = ({
                                                                          equipment, isExpanded, isDisabled, onToggleExpand, onToggleAccessory, isAccessorySelected
                                                                      }) => {
    if (!equipment.accessories?.length) return null;

    return (
        <div className="mt-3 border-t pt-3">
            <button
                className="w-full flex justify-between items-center text-sm font-medium text-gray-600 hover:text-sky-700 p-1 -m-1 rounded"
                onClick={onToggleExpand}
                aria-expanded={isExpanded}
            >
                <span className="flex items-center gap-2">
                    <Paperclip className="w-4 h-4" />
                    ĞĞºÑĞµÑÑÑƒĞ°Ñ€Ñ‹ ({equipment.accessories.length})
                </span>
                <ChevronDown className={`w-5 h-5 transition-transform ${isExpanded ? 'rotate-180' : ''}`} />
            </button>
            {isExpanded && (
                <div className="mt-2 space-y-2 pl-1 animate-in fade-in-0 slide-in-from-top-2 duration-300">
                    {equipment.accessories.map(acc => (
                        <div key={acc.id} className="flex items-center justify-between p-1 rounded hover:bg-gray-50">
                            <Label htmlFor={`acc-${equipment.id}-${acc.id}`} className="flex items-center gap-2 text-xs font-normal cursor-pointer">
                                <Checkbox
                                    id={`acc-${equipment.id}-${acc.id}`}
                                    checked={isAccessorySelected(equipment.id, acc.id)}
                                    onCheckedChange={() => onToggleAccessory(acc.id)}
                                    disabled={isDisabled}
                                />
                                {acc.name}
                            </Label>
                            <span className="text-xs text-gray-500">{acc.price} â‚½</span>
                        </div>
                    ))}
                </div>
            )}
        </div>
    );
};

```


## <a name="rentalappmainsrccomponentsequipmentcardCardFootertsx"></a>`rental-app-main/src/components/equipment-card/CardFooter.tsx`

```tsx
// path: rental-app-main/src/components/equipment-card/CardFooter.tsx

// src/components/equipment-card/CardFooter.tsx
import React from 'react';
import AvailabilityStrip from "@/components/AvailabilityStrip";
import { STATUS_TEXT_STYLES, STATUS_TEXTS } from './constants';
import type { DayStatus, EquipmentStatus } from "@/types/availability";

interface CardFooterProps {
    status: EquipmentStatus | "my_reservation" | "added";
    dateRange: string;
    selected: boolean;
    onToggleSelection: (e: React.MouseEvent) => void;
    dailyStatus?: Record<string, DayStatus>;
}

export const CardFooter: React.FC<CardFooterProps> = ({
                                                          status, dateRange, selected, onToggleSelection, dailyStatus
                                                      }) => (
    <div className="mt-auto pt-4 space-y-2">
        <div className="flex justify-between items-center">
            <p className={`text-sm font-semibold ${STATUS_TEXT_STYLES[status]}`}>
                {STATUS_TEXTS[status]}
                {dateRange && <span className="ml-1 text-xs font-normal">{dateRange}</span>}
            </p>
            {(status === 'available' || status === 'added') && (
                <button
                    onClick={onToggleSelection}
                    className={`px-3 py-1 rounded text-sm font-medium transition ${
                        status === 'added'
                            ? "bg-rose-100 text-rose-700 hover:bg-rose-200"
                            : selected
                                ? "bg-sky-700 text-white hover:bg-sky-800"
                                : "bg-sky-100 text-sky-700 hover:bg-sky-200"
                    }`}
                >
                    {status === 'added' ? "ĞÑ‚Ğ¼ĞµĞ½Ğ¸Ñ‚ÑŒ" : (selected ? "âœ” Ğ’ Ñ€ĞµĞ·ĞµÑ€Ğ²Ğµ" : "â• Ğ’ Ñ€ĞµĞ·ĞµÑ€Ğ²")}
                </button>
            )}
        </div>
        <AvailabilityStrip dailyStatus={dailyStatus} />
    </div>
);

```


## <a name="rentalappmainsrccomponentsequipmentcardCardImagetsx"></a>`rental-app-main/src/components/equipment-card/CardImage.tsx`

```tsx
// path: rental-app-main/src/components/equipment-card/CardImage.tsx

// src/components/equipment-card/CardImage.tsx
import React from 'react';
import { Image as ImageIcon } from "lucide-react";

interface CardImageProps {
    imageUrl?: string;
    name: string;
}

export const CardImage: React.FC<CardImageProps> = ({ imageUrl, name }) => (
    <div className="relative w-full h-40 bg-gray-100 flex items-center justify-center overflow-hidden">
        {imageUrl ? (
            <img
                src={imageUrl}
                alt={name}
                className="w-full h-full object-cover transition-transform duration-300 group-hover:scale-105"
                loading="lazy"
            />
        ) : (
            <ImageIcon className="w-12 h-12 text-gray-300" />
        )}
        <div className="absolute inset-0 bg-black/40 transition-opacity duration-300 group-hover:opacity-0 group-focus-within:opacity-0" />
    </div>
);

```


## <a name="rentalappmainsrccomponentsequipmentcardDiscountInfotsx"></a>`rental-app-main/src/components/equipment-card/DiscountInfo.tsx`

```tsx
// path: rental-app-main/src/components/equipment-card/DiscountInfo.tsx

// src/components/equipment-card/DiscountInfo.tsx
import React from 'react';
import { getDayEnding } from './constants';

interface DiscountInfoProps {
    days: number;
    percentage: number;
    priceBefore: number;
    priceAfter: number;
}

export const DiscountInfo: React.FC<DiscountInfoProps> = ({ days, percentage, priceBefore, priceAfter }) => (
    <div className="mt-2 p-2 bg-gray-50 rounded-md border border-dashed">
        <div className="flex justify-between items-center text-sm">
            <span>{days} {getDayEnding(days)}:</span>
            {percentage > 0 ? (
                <div className="flex items-baseline gap-2">
                    <span className="text-gray-500 line-through">{Math.round(priceBefore).toLocaleString('ru-RU')} â‚½</span>
                    <span className="font-bold text-base text-green-600">{Math.round(priceAfter).toLocaleString('ru-RU')} â‚½</span>
                </div>
            ) : (
                <span className="font-bold text-base text-gray-800">{Math.round(priceBefore).toLocaleString('ru-RU')} â‚½</span>
            )}
        </div>
        {percentage > 0 && <div className="text-xs text-right text-gray-500">Ğ¡ĞºĞ¸Ğ´ĞºĞ° {percentage}%</div>}
    </div>
);

```


## <a name="rentalappmainsrccomponentsequipmentcardEquipmentCardtsx"></a>`rental-app-main/src/components/equipment-card/EquipmentCard.tsx`

```tsx
// path: rental-app-main/src/components/equipment-card/EquipmentCard.tsx

// src/components/equipment-card/EquipmentCard.tsx
import React, { useState } from "react";
import { CheckCircle } from "lucide-react";
import { formatDateRangeEuropean } from "@/lib/utils";
import { useEquipmentCardViewModel } from "@/hooks/features/useEquipmentCardViewModel";

// ĞŸĞ¾Ğ´ĞºĞ¾Ğ¼Ğ¿Ğ¾Ğ½ĞµĞ½Ñ‚Ñ‹
import { CardImage } from "./CardImage";
import { DiscountInfo } from "./DiscountInfo";
import { AccessoriesSection } from "./AccessoriesSection";
import { CardFooter } from "./CardFooter";
import { STATUS_BACKGROUND_STYLES } from './constants';
import EquipmentDetailsDialog from "@/components/equipment/EquipmentDetailsDialog";

// Ğ¢Ğ¸Ğ¿Ñ‹
import type { Equipment } from "@/types/equipment";
import type { DayStatus, EquipmentStatus } from "@/types/availability";

interface EquipmentCardProps {
    equipment: Equipment;
    status?: EquipmentStatus | "my_reservation" | "added";
    startDate?: string;
    endDate?: string;
    dailyStatus?: Record<string, DayStatus>;
}

const EquipmentCardComponent: React.FC<EquipmentCardProps> = ({ equipment, status = "available", startDate, endDate, dailyStatus }) => {
    const [showDetails, setShowDetails] = useState(false);
    const [showAccessories, setShowAccessories] = useState(false);

    // ĞŸĞ¾Ğ»ÑƒÑ‡Ğ°ĞµĞ¼ Ğ²ÑĞµ Ğ´Ğ°Ğ½Ğ½Ñ‹Ğµ Ğ¸ Ñ„ÑƒĞ½ĞºÑ†Ğ¸Ğ¸ Ğ¸Ğ· Ñ…ÑƒĞºĞ°-ViewModel
    const {
        isSelectedByUser,
        isCalculatorVisible,
        discountData,
        handleToggleAccessory,
        handleToggleSelection,
        isAccessorySelected,
    } = useEquipmentCardViewModel({ equipment, status });

    const handleCardClick = (e: React.MouseEvent<HTMLDivElement>) => {
        if ((e.target as HTMLElement).closest("button, a, label, input[type='checkbox']")) return;
        setShowDetails(true);
    };

    const handleDoubleClick = (e: React.MouseEvent<HTMLDivElement>) => {
        if ((e.target as HTMLElement).closest("button, a, label, input[type='checkbox']")) return;
        if (status === 'available' || status === 'added') handleToggleSelection();
    };

    const stopPropagationAndToggle = (e: React.MouseEvent, action: () => void) => {
        e.stopPropagation();
        action();
    };

    const backgroundClass = STATUS_BACKGROUND_STYLES[status] || 'bg-white';
    const selectionClass = isSelectedByUser ? "ring-2 ring-offset-1 ring-sky-500 border-sky-400" : "border-gray-200 hover:shadow-lg";
    const dateRangeDisplay = (startDate && endDate) ? `(${formatDateRangeEuropean(startDate, endDate)})` : "";

    return (
        <>
            <div
                className={`relative group rounded-xl shadow transition w-full max-w-sm flex flex-col justify-between cursor-pointer overflow-hidden ${backgroundClass} ${selectionClass}`}
                onClick={handleCardClick}
                onDoubleClick={handleDoubleClick}
                tabIndex={0}
            >
                {isSelectedByUser && <div className="absolute top-2.5 right-2.5 z-10 bg-sky-600 text-white rounded-full p-1 shadow"><CheckCircle className="w-5 h-5" /></div>}

                <CardImage imageUrl={equipment.image_url} name={equipment.name} />

                <div className="p-4 flex-1 flex flex-col">
                    <div className="flex-grow">
                        <h3 className="text-lg font-semibold mb-1">{equipment.name}</h3>
                        <p className="text-sm text-gray-500 mb-2">{equipment.brand} â€¢ {equipment.equipment_type}</p>
                        {equipment.short_description && <p className="text-sm italic text-gray-600 mb-2">"{equipment.short_description}"</p>}
                        <p className="text-sm mb-1">Ğ¡Ğ¾ÑÑ‚Ğ¾ÑĞ½Ğ¸Ğµ: <strong>{equipment.condition}</strong></p>
                        <p className="text-base font-bold mb-1">{equipment.daily_rate} â‚½ / Ğ´ĞµĞ½ÑŒ</p>
                        {isCalculatorVisible && <DiscountInfo {...discountData} />}
                    </div>

                    <AccessoriesSection
                        equipment={equipment}
                        isExpanded={showAccessories}
                        isDisabled={status !== 'available' && status !== 'added'}
                        onToggleExpand={(e) => stopPropagationAndToggle(e, () => setShowAccessories(p => !p))}
                        onToggleAccessory={handleToggleAccessory}
                        isAccessorySelected={isAccessorySelected}
                    />

                    <CardFooter
                        status={status}
                        dateRange={dateRangeDisplay}
                        selected={isSelectedByUser}
                        onToggleSelection={(e) => stopPropagationAndToggle(e, handleToggleSelection)}
                        dailyStatus={dailyStatus}
                    />
                </div>
            </div>

            <EquipmentDetailsDialog
                open={showDetails}
                onClose={() => setShowDetails(false)}
                equipment={equipment}
                availability={{ equipment_id: equipment.id, status: status as EquipmentStatus, details: "" }}
            />
        </>
    );
};

// ĞœĞµĞ¼Ğ¾Ğ¸Ğ·Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ½Ğ°Ñ Ğ²ĞµÑ€ÑĞ¸Ñ ĞºĞ¾Ğ¼Ğ¿Ğ¾Ğ½ĞµĞ½Ñ‚Ğ° Ğ´Ğ»Ñ Ğ¾Ğ¿Ñ‚Ğ¸Ğ¼Ğ¸Ğ·Ğ°Ñ†Ğ¸Ğ¸ Ğ¿Ñ€Ğ¾Ğ¸Ğ·Ğ²Ğ¾Ğ´Ğ¸Ñ‚ĞµĞ»ÑŒĞ½Ğ¾ÑÑ‚Ğ¸
export const EquipmentCard = React.memo(EquipmentCardComponent);

```


## <a name="rentalappmainsrccomponentsequipmentcardconstantsts"></a>`rental-app-main/src/components/equipment-card/constants.ts`

```typescript
// path: rental-app-main/src/components/equipment-card/constants.ts

// src/components/equipment-card/constants.ts

import type { EquipmentStatus } from "@/types/availability";

type StatusKey = EquipmentStatus | "my_reservation" | "added";

// Ğ¡Ñ‚Ğ¸Ğ»Ğ¸ Ğ¢ĞĞ›Ğ¬ĞšĞ Ğ´Ğ»Ñ Ñ†Ğ²ĞµÑ‚Ğ° Ñ‚ĞµĞºÑÑ‚Ğ°
export const STATUS_TEXT_STYLES: Record<StatusKey, string> = {
    available: "text-green-600",
    reserved: "text-yellow-500",
    rented: "text-red-600",
    my_reservation: "text-sky-700",
    added: "text-emerald-600",
};

// Ğ¡Ñ‚Ğ¸Ğ»Ğ¸ Ğ¢ĞĞ›Ğ¬ĞšĞ Ğ´Ğ»Ñ Ñ†Ğ²ĞµÑ‚Ğ° Ñ„Ğ¾Ğ½Ğ°
export const STATUS_BACKGROUND_STYLES: Record<StatusKey, string> = {
    available: "bg-white",
    reserved: "bg-white",
    rented: "bg-white",
    my_reservation: "bg-sky-50",
    added: "bg-emerald-50",
};

// Ğ¢ĞµĞºÑÑ‚Ğ¾Ğ²Ñ‹Ğµ Ğ¾Ğ¿Ğ¸ÑĞ°Ğ½Ğ¸Ñ Ğ´Ğ»Ñ ÑÑ‚Ğ°Ñ‚ÑƒÑĞ¾Ğ²
export const STATUS_TEXTS: Record<StatusKey, string> = {
    available: "Ğ¡Ğ²Ğ¾Ğ±Ğ¾Ğ´Ğ½Ğ¾",
    reserved: "Ğ’ Ñ€ĞµĞ·ĞµÑ€Ğ²Ğµ",
    rented: "Ğ’ Ğ°Ñ€ĞµĞ½Ğ´Ğµ",
    my_reservation: "Ğ’ ÑÑ‚Ğ¾Ğ¼ Ñ€ĞµĞ·ĞµÑ€Ğ²Ğµ",
    added: "Ğ”Ğ¾Ğ±Ğ°Ğ²Ğ»ĞµĞ½Ğ¾",
};

// Ğ’ÑĞ¿Ğ¾Ğ¼Ğ¾Ğ³Ğ°Ñ‚ĞµĞ»ÑŒĞ½Ğ°Ñ Ñ„ÑƒĞ½ĞºÑ†Ğ¸Ñ Ğ´Ğ»Ñ Ğ¿Ğ¾Ğ»ÑƒÑ‡ĞµĞ½Ğ¸Ñ Ğ¿Ñ€Ğ°Ğ²Ğ¸Ğ»ÑŒĞ½Ğ¾Ğ³Ğ¾ Ğ¾ĞºĞ¾Ğ½Ñ‡Ğ°Ğ½Ğ¸Ñ ÑĞ»Ğ¾Ğ²Ğ° "Ğ´ĞµĞ½ÑŒ"
export const getDayEnding = (num: number): string => {
    if (num > 10 && num < 20) return 'Ğ´Ğ½ĞµĞ¹';
    const lastDigit = num % 10;
    if (lastDigit === 1) return 'Ğ´ĞµĞ½ÑŒ';
    if (lastDigit > 1 && lastDigit < 5) return 'Ğ´Ğ½Ñ';
    return 'Ğ´Ğ½ĞµĞ¹';
};

```


## <a name="rentalappmainsrccomponentsequipmentcardindexts"></a>`rental-app-main/src/components/equipment-card/index.ts`

```typescript
// path: rental-app-main/src/components/equipment-card/index.ts

// src/components/equipment-card/index.ts

export { EquipmentCard as default } from './EquipmentCard';

```


## <a name="rentalappmainsrccomponentsequipmentEquipmentDetailsDialogtsx"></a>`rental-app-main/src/components/equipment/EquipmentDetailsDialog.tsx`

```tsx
// path: rental-app-main/src/components/equipment/EquipmentDetailsDialog.tsx

// src/components/equipment/EquipmentDetailsDialog.tsx
import { useState, useEffect } from "react"; // 1. Ğ˜Ğ¼Ğ¿Ğ¾Ñ€Ñ‚Ğ¸Ñ€ÑƒĞµĞ¼ useEffect
import { Dialog, DialogContent, DialogFooter, DialogHeader, DialogTitle } from "@/components/ui/dialog";
import EquipmentDetailsView from "@/components/equipment/EquipmentDetailsView";
import EquipmentEditForm from "./EquipmentEditForm";
import type { Equipment } from "@/types/equipment";
import type { AvailabilityInfo } from "@/types/availability";
import { Button } from "@/components/ui/button";
import { useReserveStore } from "@/store/reserveStore";
import { useCurrentUser } from "@/hooks/useProfile";
import { Pencil, Check } from "lucide-react";

type Props = {
    open: boolean;
    onClose: () => void;
    equipment: Equipment;
    availability?: AvailabilityInfo;
};

export default function EquipmentDetailsDialog({ open, onClose, equipment, availability }: Props) {
    const { addWithAccessories, isSelected } = useReserveStore();
    const { data: currentUser } = useCurrentUser();

    const [isEditing, setIsEditing] = useState(false);
    const [stagedAccessoryIds, setStagedAccessoryIds] = useState<Set<number>>(new Set());

    // 2. Ğ”Ğ¾Ğ±Ğ°Ğ²Ğ»ÑĞµĞ¼ ÑÑ‚Ğ¾Ñ‚ Ğ±Ğ»Ğ¾Ğº useEffect
    useEffect(() => {
        if (!open) {
            document.body.style.overflow = '';
        }
    }, [open]);

    const selected = isSelected(equipment.id);
    const isAvailableForReservation = availability?.status === "available";
    const userRole = currentUser?.role;
    const canEdit = userRole === "admin" || userRole === "manager";
    const canViewAdminInfo = canEdit;

    const handleMainActionClick = () => {
        if (!selected) {
            addWithAccessories(equipment, Array.from(stagedAccessoryIds));
        }
        onClose();
    };

    const handleEditClick = () => {
        setIsEditing(true);
    };

    const handleDialogCloseTrigger = () => {
        setIsEditing(false);
        setStagedAccessoryIds(new Set());
        onClose();
    };

    const handleToggleStagedAccessory = (accessoryId: number) => {
        setStagedAccessoryIds(prev => {
            const newSet = new Set(prev);
            if (newSet.has(accessoryId)) {
                newSet.delete(accessoryId);
            } else {
                newSet.add(accessoryId);
            }
            return newSet;
        });
    };

    return (
        <Dialog open={open} onOpenChange={(isOpen) => !isOpen && handleDialogCloseTrigger()}>
            <DialogContent className="max-w-xl p-6">
                <DialogHeader className="pb-4">
                    <DialogTitle className="text-lg sm:text-xl">
                        {isEditing ? `Ğ ĞµĞ´Ğ°ĞºÑ‚Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ: ${equipment.name}` : "Ğ”ĞµÑ‚Ğ°Ğ»Ğ¸ Ğ¾Ğ±Ğ¾Ñ€ÑƒĞ´Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ"}
                    </DialogTitle>
                </DialogHeader>

                {isEditing ? (
                    <EquipmentEditForm
                        equipment={equipment}
                        onSuccess={() => { setIsEditing(false); onClose(); }}
                        onCancel={() => setIsEditing(false) }
                    />
                ) : (
                    <EquipmentDetailsView
                        equipment={equipment}
                        canViewAdminInfo={canViewAdminInfo}
                        canToggleAccessories={isAvailableForReservation}
                        isMainSelected={selected}
                        stagedAccessoryIds={stagedAccessoryIds}
                        onToggleStagedAccessory={handleToggleStagedAccessory}
                    />
                )}

                {!isEditing && (
                    <DialogFooter className="pt-4 mt-4 border-t border-gray-200 flex flex-col sm:flex-row sm:justify-end sm:items-center gap-2">
                        {canEdit && (
                            <Button
                                variant="secondary"
                                onClick={handleEditClick}
                                className="w-full sm:w-auto order-last sm:order-none"
                            >
                                <Pencil size={15} className="mr-1.5" />
                                Ğ ĞµĞ´Ğ°ĞºÑ‚Ğ¸Ñ€Ğ¾Ğ²Ğ°Ñ‚ÑŒ
                            </Button>
                        )}
                        {isAvailableForReservation && (
                            <Button
                                onClick={handleMainActionClick}
                                variant="default"
                                className="w-full sm:w-auto"
                            >
                                {selected
                                    ? <><Check size={16} className="mr-1.5" />Ğ“Ğ¾Ñ‚Ğ¾Ğ²Ğ¾</>
                                    : "â• Ğ”Ğ¾Ğ±Ğ°Ğ²Ğ¸Ñ‚ÑŒ Ğ² Ñ€ĞµĞ·ĞµÑ€Ğ²"
                                }
                            </Button>
                        )}
                    </DialogFooter>
                )}
            </DialogContent>
        </Dialog>
    );
}

```


## <a name="rentalappmainsrccomponentsequipmentEquipmentDetailsViewtsx"></a>`rental-app-main/src/components/equipment/EquipmentDetailsView.tsx`

```tsx
// path: rental-app-main/src/components/equipment/EquipmentDetailsView.tsx

// src/components/equipment/EquipmentDetailsView.tsx
import type { Equipment } from "@/types/equipment";
import { formatDateEuropean } from "@/lib/utils";
import ReactMarkdown from 'react-markdown';
import { Image as ImageIcon, Paperclip, Plus, Check } from "lucide-react";
import { Button } from "@/components/ui/button";
import { useReserveStore } from "@/store/reserveStore";

type Props = {
    equipment: Equipment;
    canViewAdminInfo: boolean;
    canToggleAccessories: boolean;
    // ğŸ‘‡ Ğ˜Ğ—ĞœĞ•ĞĞ•ĞĞ˜Ğ•: ĞĞ¾Ğ²Ñ‹Ğµ Ğ¿Ñ€Ğ¾Ğ¿ÑÑ‹ Ğ´Ğ»Ñ ÑƒĞ¿Ñ€Ğ°Ğ²Ğ»ĞµĞ½Ğ¸Ñ ÑĞ¾ÑÑ‚Ğ¾ÑĞ½Ğ¸ĞµĞ¼
    isMainSelected: boolean;
    stagedAccessoryIds: Set<number>;
    onToggleStagedAccessory: (accessoryId: number) => void;
};

export default function EquipmentDetailsView({
                                                 equipment,
                                                 canViewAdminInfo,
                                                 canToggleAccessories,
                                                 isMainSelected,
                                                 stagedAccessoryIds,
                                                 onToggleStagedAccessory
                                             }: Props) {
    const { toggleAccessory, isAccessorySelected } = useReserveStore();

    // ğŸ‘‡ Ğ˜Ğ—ĞœĞ•ĞĞ•ĞĞ˜Ğ•: ĞĞ±Ñ€Ğ°Ğ±Ğ¾Ñ‚Ñ‡Ğ¸Ğº Ñ‚ĞµĞ¿ĞµÑ€ÑŒ Ñ€Ğ°Ğ·Ğ´ĞµĞ»ÑĞµÑ‚ Ğ»Ğ¾Ğ³Ğ¸ĞºÑƒ
    const handleToggleAccessory = (accessoryId: number) => {
        // Ğ•ÑĞ»Ğ¸ Ğ¾ÑĞ½Ğ¾Ğ²Ğ½Ğ¾Ğ¹ Ñ‚Ğ¾Ğ²Ğ°Ñ€ ÑƒĞ¶Ğµ Ğ² Ñ€ĞµĞ·ĞµÑ€Ğ²Ğµ, Ñ€Ğ°Ğ±Ğ¾Ñ‚Ğ°ĞµĞ¼ Ñ Ğ³Ğ»Ğ¾Ğ±Ğ°Ğ»ÑŒĞ½Ñ‹Ğ¼ ÑÑ‚Ğ¾Ñ€Ğ¾Ğ¼
        if (isMainSelected) {
            toggleAccessory(equipment.id, accessoryId);
        } else {
            // Ğ˜Ğ½Ğ°Ñ‡Ğµ - Ñ€Ğ°Ğ±Ğ¾Ñ‚Ğ°ĞµĞ¼ Ñ Ğ»Ğ¾ĞºĞ°Ğ»ÑŒĞ½Ñ‹Ğ¼ ÑĞ¾ÑÑ‚Ğ¾ÑĞ½Ğ¸ĞµĞ¼ "Ğ¾Ñ‚Ğ¼ĞµÑ‡ĞµĞ½Ğ½Ñ‹Ñ…"
            onToggleStagedAccessory(accessoryId);
        }
    };

    const allImages = [equipment.image_url, ...(equipment.image_urls || [])].filter(Boolean) as string[];

    return (
        <div className="space-y-3 text-sm">
            {/* ... Ğ±Ğ»Ğ¾Ğº Ñ Ğ¸Ğ·Ğ¾Ğ±Ñ€Ğ°Ğ¶ĞµĞ½Ğ¸ÑĞ¼Ğ¸ Ğ¸ Ğ¾Ğ¿Ğ¸ÑĞ°Ğ½Ğ¸ĞµĞ¼ Ğ¾ÑÑ‚Ğ°ĞµÑ‚ÑÑ Ğ±ĞµĞ· Ğ¸Ğ·Ğ¼ĞµĞ½ĞµĞ½Ğ¸Ğ¹ ... */}
            {allImages.length > 0 ? (
                <div className="flex overflow-x-auto space-x-2 pb-2 -mx-1 px-1">
                    {allImages.map((url, index) => (
                        <div key={index} className="flex-shrink-0 w-48 h-32 rounded-lg overflow-hidden bg-gray-100 border">
                            <img src={url} alt={`${equipment.name} image ${index + 1}`} className="w-full h-full object-cover" />
                        </div>
                    ))}
                </div>
            ) : (
                <div className="w-full h-32 bg-gray-100 flex items-center justify-center rounded-lg border">
                    <ImageIcon className="w-12 h-12 text-gray-300" />
                </div>
            )}

            <h3 className="text-base sm:text-lg font-bold text-gray-900 leading-tight pt-2">
                {equipment.equipment_type} {equipment.brand} {equipment.name}
            </h3>

            <div className="mt-2 space-y-1">
                <p><span className="font-medium text-gray-700">Ğ¦ĞµĞ½Ğ°:</span> {equipment.daily_rate} â‚½ / Ğ´ĞµĞ½ÑŒ</p>
                <p><span className="font-medium text-gray-700">Ğ¡Ğ¾ÑÑ‚Ğ¾ÑĞ½Ğ¸Ğµ:</span> {equipment.condition}</p>
            </div>

            {equipment.accessories && equipment.accessories.length > 0 && (
                <div className="pt-3 mt-3 border-t">
                    <p className="font-semibold text-gray-800 mb-2 flex items-center gap-2">
                        <Paperclip className="w-4 h-4 text-gray-500"/>
                        Ğ”Ğ¾ÑÑ‚ÑƒĞ¿Ğ½Ñ‹Ğµ Ğ°ĞºÑĞµÑÑÑƒĞ°Ñ€Ñ‹:
                    </p>
                    <ul className="space-y-1.5">
                        {equipment.accessories.map(acc => {
                            // ğŸ‘‡ Ğ˜Ğ—ĞœĞ•ĞĞ•ĞĞ˜Ğ•: ĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑĞµĞ¼ ÑÑ‚Ğ°Ñ‚ÑƒÑ Ğ² Ğ·Ğ°Ğ²Ğ¸ÑĞ¸Ğ¼Ğ¾ÑÑ‚Ğ¸ Ğ¾Ñ‚ Ñ‚Ğ¾Ğ³Ğ¾, Ğ´Ğ¾Ğ±Ğ°Ğ²Ğ»ĞµĞ½ Ğ»Ğ¸ Ñ‚Ğ¾Ğ²Ğ°Ñ€ Ğ² Ñ€ĞµĞ·ĞµÑ€Ğ²
                            const isAdded = isMainSelected
                                ? isAccessorySelected(equipment.id, acc.id)
                                : stagedAccessoryIds.has(acc.id);

                            return (
                                <li key={acc.id} className="flex justify-between items-center bg-gray-50/70 p-2 rounded-md hover:bg-gray-100 transition-colors">
                                    <div>
                                        <span className="font-medium">{acc.name}</span>
                                        <span className="text-xs text-gray-600 ml-2">{acc.price} â‚½</span>
                                    </div>
                                    <Button
                                        size="icon"
                                        variant={isAdded ? "default" : "outline"}
                                        className={`h-7 w-7 shrink-0 ${isAdded ? 'bg-green-600 hover:bg-green-700' : ''}`}
                                        onClick={() => handleToggleAccessory(acc.id)}
                                        aria-label={isAdded ? "Ğ£Ğ±Ñ€Ğ°Ñ‚ÑŒ Ğ°ĞºÑĞµÑÑÑƒĞ°Ñ€" : "Ğ”Ğ¾Ğ±Ğ°Ğ²Ğ¸Ñ‚ÑŒ Ğ°ĞºÑĞµÑÑÑƒĞ°Ñ€"}
                                        disabled={!canToggleAccessories}
                                    >
                                        {isAdded ? <Check className="h-4 w-4" /> : <Plus className="h-4 w-4" />}
                                    </Button>
                                </li>
                            );
                        })}
                    </ul>
                </div>
            )}

            {/* ... Ğ¾ÑÑ‚Ğ°Ğ»ÑŒĞ½Ñ‹Ğµ Ğ±Ğ»Ğ¾ĞºĞ¸ (Ğ¾Ğ¿Ğ¸ÑĞ°Ğ½Ğ¸Ğµ, ÑĞ»ÑƒĞ¶ĞµĞ±Ğ½Ğ°Ñ Ğ¸Ğ½Ñ„Ğ¾Ñ€Ğ¼Ğ°Ñ†Ğ¸Ñ) Ğ¾ÑÑ‚Ğ°ÑÑ‚ÑÑ Ğ±ĞµĞ· Ğ¸Ğ·Ğ¼ĞµĞ½ĞµĞ½Ğ¸Ğ¹ ... */}
            {equipment.description && (
                <div className="pt-3 mt-3 border-t">
                    <p className="font-semibold text-gray-800 mb-1">ĞĞ¿Ğ¸ÑĞ°Ğ½Ğ¸Ğµ:</p>
                    <div className="prose prose-sm max-w-none text-gray-700 bg-gray-50 p-3 rounded-md border border-gray-200">
                        <ReactMarkdown>{equipment.description}</ReactMarkdown>
                    </div>
                </div>
            )}

            {canViewAdminInfo && (equipment.notes || equipment.last_maintenance) && (
                <div className="pt-3 mt-3 border-t space-y-2">
                    <h4 className="text-sm font-semibold text-sky-700">Ğ¡Ğ»ÑƒĞ¶ĞµĞ±Ğ½Ğ°Ñ Ğ¸Ğ½Ñ„Ğ¾Ñ€Ğ¼Ğ°Ñ†Ğ¸Ñ:</h4>
                    {equipment.last_maintenance && (
                        <p className="text-xs text-gray-600"><strong>ĞŸĞ¾ÑĞ»ĞµĞ´Ğ½ĞµĞµ Ğ¢Ğ:</strong> {formatDateEuropean(equipment.last_maintenance)}</p>
                    )}
                    {equipment.notes && (
                        <div>
                            <p className="text-xs font-semibold text-gray-600 mb-0.5">Ğ—Ğ°Ğ¼ĞµÑ‚ĞºĞ¸:</p>
                            <p className="text-xs text-gray-500 whitespace-pre-wrap bg-gray-50 p-2 rounded-md border border-gray-200">{equipment.notes}</p>
                        </div>
                    )}
                </div>
            )}
        </div>
    );
}

```


## <a name="rentalappmainsrccomponentsequipmentEquipmentEditFormtsx"></a>`rental-app-main/src/components/equipment/EquipmentEditForm.tsx`

```tsx
// path: rental-app-main/src/components/equipment/EquipmentEditForm.tsx

// src/components/equipment/EquipmentEditForm.tsx

import { useForm, Controller } from "react-hook-form";
import { zodResolver } from "@hookform/resolvers/zod";
import {
    equipmentUpdateExtendedSchema,
    type EquipmentUpdateExtendedSchema as EquipmentUpdateFormData
} from "@/lib/validationSchemas";
import { useUpdateEquipmentDetails } from "@/hooks/useUpdateEquipmentDetails";
import { useAccessories } from "@/hooks/useAdminAccessories";
import type { Equipment } from "@/types/equipment";
import type { Accessory } from "@/types/accessory"; // Ğ”Ğ¾Ğ±Ğ°Ğ²Ğ»ÑĞµĞ¼ Ğ¸Ğ¼Ğ¿Ğ¾Ñ€Ñ‚ Ñ‚Ğ¸Ğ¿Ğ° Accessory
import { Input } from "@/components/ui/input";
import { Button } from "@/components/ui/button";
import { Label } from "@/components/ui/label";
import { Textarea } from "@/components/ui/textarea";
import { formatDate } from "@/lib/utils";
import MDEditor from '@uiw/react-md-editor';
import rehypeSanitize from 'rehype-sanitize';
import { Checkbox } from "@/components/ui/checkbox";
import { useAllEquipment } from "@/hooks/useAllEquipment";
import { CreatableSelect } from "@/components/ui/CreatableSelect";
import { useMemo } from "react";

type Props = {
    equipment: Equipment;
    onSuccess: (updatedData: Equipment) => void;
    onCancel: () => void;
};

export default function EquipmentEditForm({ equipment, onSuccess, onCancel }: Props) {
    const { data: allEquipmentData = [] } = useAllEquipment();
    // Ğ—Ğ°Ğ¿Ñ€Ğ°ÑˆĞ¸Ğ²Ğ°ĞµĞ¼ Ğ°ĞºÑĞµÑÑÑƒĞ°Ñ€Ñ‹ Ñ Ğ¿Ğ°Ğ³Ğ¸Ğ½Ğ°Ñ†Ğ¸ĞµĞ¹ (Ğ±ĞµÑ€ĞµĞ¼ Ğ¾Ğ´Ğ½Ñƒ Ğ±Ğ¾Ğ»ÑŒÑˆÑƒÑ "ÑÑ‚Ñ€Ğ°Ğ½Ğ¸Ñ†Ñƒ")
    const { data: accessoriesResponse, isLoading: isLoadingAccessories } = useAccessories(1, 500);
    // Ğ˜Ğ·Ğ²Ğ»ĞµĞºĞ°ĞµĞ¼ Ğ¼Ğ°ÑÑĞ¸Ğ² .items Ğ¸Ğ· Ğ¾Ñ‚Ğ²ĞµÑ‚Ğ°
    const allAccessories = accessoriesResponse?.items || [];

    const equipmentTypes = useMemo(() => {
        const types = new Set(allEquipmentData.map(e => e.equipment_type));
        return Array.from(types).sort((a, b) => a.localeCompare(b));
    }, [allEquipmentData]);

    const equipmentBrands = useMemo(() => {
        const brands = new Set(allEquipmentData.map(e => e.brand));
        return Array.from(brands).sort((a, b) => a.localeCompare(b));
    }, [allEquipmentData]);

    const {
        register,
        handleSubmit,
        control,
        formState: { errors, isDirty, isValid },
    } = useForm<EquipmentUpdateFormData>({
        resolver: zodResolver(equipmentUpdateExtendedSchema) as any,
        defaultValues: {
            equipment_type: equipment.equipment_type ?? undefined,
            brand: equipment.brand ?? undefined,
            name: equipment.name ?? undefined,
            serial_number: equipment.serial_number ?? undefined,
            condition: equipment.condition ?? undefined,
            daily_rate: equipment.daily_rate ?? undefined,
            notes: equipment.notes ?? undefined,
            description: equipment.description ?? undefined,
            last_maintenance: equipment.last_maintenance ? formatDate(equipment.last_maintenance) : undefined,
            short_description: equipment.short_description ?? undefined,
            image_url: equipment.image_url ?? undefined,
            image_urls: equipment.image_urls ?? [],
            accessory_ids: equipment.accessories?.map(acc => acc.id) ?? [],
        },
        mode: "onChange",
    });

    const updateEquipmentMutation = useUpdateEquipmentDetails();

    const onSubmitHandler = async (data: EquipmentUpdateFormData) => {
        await updateEquipmentMutation.mutateAsync(
            { id: equipment.id, data },
            {
                onSuccess: (updatedEquipmentDataFromApi) => {
                    onSuccess(updatedEquipmentDataFromApi);
                },
            }
        );
    };

    return (
        <form onSubmit={handleSubmit(onSubmitHandler)} className="space-y-4 py-4 max-h-[75vh] overflow-y-auto pr-4">
            {/* ... Ğ¾ÑÑ‚Ğ°Ğ»ÑŒĞ½Ğ°Ñ Ñ‡Ğ°ÑÑ‚ÑŒ Ñ„Ğ¾Ñ€Ğ¼Ñ‹ Ğ¾ÑÑ‚Ğ°ĞµÑ‚ÑÑ Ğ±ĞµĞ· Ğ¸Ğ·Ğ¼ĞµĞ½ĞµĞ½Ğ¸Ğ¹ ... */}
            <div>
                <Label htmlFor="name">ĞĞ°Ğ·Ğ²Ğ°Ğ½Ğ¸Ğµ</Label>
                <Input id="name" {...register("name")} />
                {errors.name && <p className="text-xs text-red-600 mt-1">{errors.name.message}</p>}
            </div>

            <div className="grid grid-cols-1 sm:grid-cols-2 gap-4">
                <div>
                    <Label htmlFor="equipment_type">Ğ¢Ğ¸Ğ¿ Ğ¾Ğ±Ğ¾Ñ€ÑƒĞ´Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ</Label>
                    <Controller
                        name="equipment_type"
                        control={control}
                        render={({ field }) => (
                            <CreatableSelect
                                value={field.value}
                                onChange={field.onChange}
                                options={equipmentTypes}
                                placeholder="Ğ’Ñ‹Ğ±ĞµÑ€Ğ¸Ñ‚Ğµ Ğ¸Ğ»Ğ¸ ÑĞ¾Ğ·Ğ´Ğ°Ğ¹Ñ‚Ğµ Ñ‚Ğ¸Ğ¿"
                                dialogTitle="ĞĞ¾Ğ²Ñ‹Ğ¹ Ñ‚Ğ¸Ğ¿ Ğ¾Ğ±Ğ¾Ñ€ÑƒĞ´Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ"
                                dialogDescription="Ğ’Ğ²ĞµĞ´Ğ¸Ñ‚Ğµ Ğ½Ğ°Ğ·Ğ²Ğ°Ğ½Ğ¸Ğµ Ğ´Ğ»Ñ Ğ½Ğ¾Ğ²Ğ¾Ğ³Ğ¾ Ñ‚Ğ¸Ğ¿Ğ°."
                                dialogLabel="ĞĞ°Ğ·Ğ²Ğ°Ğ½Ğ¸Ğµ"
                            />
                        )}
                    />
                    {errors.equipment_type && <p className="text-xs text-red-600 mt-1">{errors.equipment_type.message}</p>}
                </div>
                <div>
                    <Label htmlFor="brand">Ğ‘Ñ€ĞµĞ½Ğ´</Label>
                    <Controller
                        name="brand"
                        control={control}
                        render={({ field }) => (
                            <CreatableSelect
                                value={field.value}
                                onChange={field.onChange}
                                options={equipmentBrands}
                                placeholder="Ğ’Ñ‹Ğ±ĞµÑ€Ğ¸Ñ‚Ğµ Ğ¸Ğ»Ğ¸ ÑĞ¾Ğ·Ğ´Ğ°Ğ¹Ñ‚Ğµ Ğ±Ñ€ĞµĞ½Ğ´"
                                dialogTitle="ĞĞ¾Ğ²Ñ‹Ğ¹ Ğ±Ñ€ĞµĞ½Ğ´"
                                dialogDescription="Ğ’Ğ²ĞµĞ´Ğ¸Ñ‚Ğµ Ğ½Ğ°Ğ·Ğ²Ğ°Ğ½Ğ¸Ğµ Ğ´Ğ»Ñ Ğ½Ğ¾Ğ²Ğ¾Ğ³Ğ¾ Ğ±Ñ€ĞµĞ½Ğ´Ğ°."
                                dialogLabel="ĞĞ°Ğ·Ğ²Ğ°Ğ½Ğ¸Ğµ"
                            />
                        )}
                    />
                    {errors.brand && <p className="text-xs text-red-600 mt-1">{errors.brand.message}</p>}
                </div>
            </div>

            <div>
                <Label htmlFor="short_description">ĞšÑ€Ğ°Ñ‚ĞºĞ¾Ğµ Ğ¾Ğ¿Ğ¸ÑĞ°Ğ½Ğ¸Ğµ (Ğ´Ğ»Ñ ĞºĞ°Ñ€Ñ‚Ğ¾Ñ‡ĞºĞ¸)</Label>
                <Input id="short_description" {...register("short_description")} placeholder="ĞĞ°Ğ¿Ñ€Ğ¸Ğ¼ĞµÑ€: ĞŸÑ€Ğ¾Ñ„ĞµÑÑĞ¸Ğ¾Ğ½Ğ°Ğ»ÑŒĞ½Ğ°Ñ Ğ±ĞµĞ·Ğ·ĞµÑ€ĞºĞ°Ğ»ÑŒĞ½Ğ°Ñ ĞºĞ°Ğ¼ĞµÑ€Ğ°..." />
                {errors.short_description && <p className="text-xs text-red-600 mt-1">{errors.short_description.message}</p>}
            </div>

            <div>
                <Label htmlFor="image_url">URL Ğ¾ÑĞ½Ğ¾Ğ²Ğ½Ğ¾Ğ³Ğ¾ Ğ¸Ğ·Ğ¾Ğ±Ñ€Ğ°Ğ¶ĞµĞ½Ğ¸Ñ</Label>
                <Input id="image_url" {...register("image_url")} placeholder="https://example.com/main_image.jpg" />
                {errors.image_url && <p className="text-xs text-red-600 mt-1">{errors.image_url.message}</p>}
            </div>

            <div>
                <Label htmlFor="image_urls">URL Ğ´Ğ¾Ğ¿Ğ¾Ğ»Ğ½Ğ¸Ñ‚ĞµĞ»ÑŒĞ½Ñ‹Ñ… Ğ¸Ğ·Ğ¾Ğ±Ñ€Ğ°Ğ¶ĞµĞ½Ğ¸Ğ¹ (ĞºĞ°Ğ¶Ğ´Ñ‹Ğ¹ Ñ Ğ½Ğ¾Ğ²Ğ¾Ğ¹ ÑÑ‚Ñ€Ğ¾ĞºĞ¸)</Label>
                <Controller
                    name="image_urls"
                    control={control}
                    render={({ field }) => (
                        <Textarea
                            id="image_urls"
                            placeholder={"https://example.com/image1.jpg\nhttps://example.com/image2.jpg"}
                            value={Array.isArray(field.value) ? field.value.join('\n') : ''}
                            onChange={(e) => {
                                const urls = e.target.value ? e.target.value.split('\n') : [];
                                field.onChange(urls);
                            }}
                            rows={4}
                        />
                    )}
                />
                {errors.image_urls && <p className="text-xs text-red-600 mt-1">{errors.image_urls.message as string}</p>}
            </div>

            <div>
                <Label htmlFor="serial_number">Ğ¡ĞµÑ€Ğ¸Ğ¹Ğ½Ñ‹Ğ¹ Ğ½Ğ¾Ğ¼ĞµÑ€</Label>
                <Input id="serial_number" {...register("serial_number")} />
                {errors.serial_number && <p className="text-xs text-red-600 mt-1">{errors.serial_number.message}</p>}
            </div>

            <div className="grid grid-cols-1 sm:grid-cols-2 gap-4">
                <div>
                    <Label htmlFor="condition">Ğ¡Ğ¾ÑÑ‚Ğ¾ÑĞ½Ğ¸Ğµ</Label>
                    <Input id="condition" {...register("condition")} />
                    {errors.condition && <p className="text-xs text-red-600 mt-1">{errors.condition.message}</p>}
                </div>
                <div>
                    <Label htmlFor="daily_rate">Ğ¦ĞµĞ½Ğ° Ğ·Ğ° Ğ´ĞµĞ½ÑŒ (â‚½)</Label>
                    <Controller
                        name="daily_rate"
                        control={control}
                        render={({ field }) => (
                            <Input
                                {...field}
                                id="daily_rate"
                                type="number"
                                value={field.value ?? ""}
                                onChange={(e) => {
                                    const val = e.target.value;
                                    field.onChange(val === '' ? undefined : parseFloat(val));
                                }}
                                step="0.01"
                                placeholder="0.00"
                            />
                        )}
                    />
                    {errors.daily_rate && <p className="text-xs text-red-600 mt-1">{errors.daily_rate.message}</p>}
                </div>
            </div>

            <div>
                <Label htmlFor="description">ĞĞ¿Ğ¸ÑĞ°Ğ½Ğ¸Ğµ (Markdown)</Label>
                <Controller
                    name="description"
                    control={control}
                    render={({ field }) => (
                        <div data-color-mode="light">
                            <MDEditor
                                value={field.value ?? ""}
                                onChange={(val) => field.onChange(val ?? "")}
                                previewOptions={{ rehypePlugins: [[rehypeSanitize]] }}
                                height={250}
                            />
                        </div>
                    )}
                />
                {errors.description && <p className="text-xs text-red-600 mt-1">{errors.description.message}</p>}
            </div>

            <div className="space-y-2 pt-4 border-t">
                <Label>ĞŸÑ€Ğ¸Ğ²ÑĞ·Ğ°Ğ½Ğ½Ñ‹Ğµ Ğ°ĞºÑĞµÑÑÑƒĞ°Ñ€Ñ‹</Label>
                <p className="text-sm text-muted-foreground">
                    Ğ’Ñ‹Ğ±ĞµÑ€Ğ¸Ñ‚Ğµ Ğ°ĞºÑĞµÑÑÑƒĞ°Ñ€Ñ‹, ĞºĞ¾Ñ‚Ğ¾Ñ€Ñ‹Ğµ Ğ±ÑƒĞ´ÑƒÑ‚ Ğ¿Ñ€ĞµĞ´Ğ»Ğ°Ğ³Ğ°Ñ‚ÑŒÑÑ Ğ²Ğ¼ĞµÑÑ‚Ğµ Ñ ÑÑ‚Ğ¸Ğ¼ Ğ¾Ğ±Ğ¾Ñ€ÑƒĞ´Ğ¾Ğ²Ğ°Ğ½Ğ¸ĞµĞ¼.
                </p>
                {isLoadingAccessories ? (
                    <p className="text-sm text-muted-foreground">Ğ—Ğ°Ğ³Ñ€ÑƒĞ·ĞºĞ° ÑĞ¿Ğ¸ÑĞºĞ° Ğ°ĞºÑĞµÑÑÑƒĞ°Ñ€Ğ¾Ğ²...</p>
                ) : (
                    <Controller
                        control={control}
                        name="accessory_ids"
                        render={({ field }) => (
                            <div className="space-y-2 max-h-48 overflow-y-auto rounded-md border p-4 bg-slate-50">
                                {allAccessories.map((accessory: Accessory) => ( // Ğ”Ğ¾Ğ±Ğ°Ğ²Ğ»ÑĞµĞ¼ Ñ‚Ğ¸Ğ¿ Ğ´Ğ»Ñ accessory
                                    <div key={accessory.id} className="flex items-center justify-between hover:bg-slate-100 p-2 rounded">
                                        <div className="flex items-center gap-2">
                                            <Checkbox
                                                id={`accessory-${accessory.id}`}
                                                checked={field.value?.includes(accessory.id)}
                                                onCheckedChange={(checked) => {
                                                    const currentIds = field.value ?? [];
                                                    const newIds = checked
                                                        ? [...currentIds, accessory.id]
                                                        : currentIds.filter(id => id !== accessory.id);
                                                    field.onChange(newIds);
                                                }}
                                            />
                                            <Label htmlFor={`accessory-${accessory.id}`} className="font-normal cursor-pointer">
                                                {accessory.name}
                                            </Label>
                                        </div>
                                        <span className="text-xs text-muted-foreground">{accessory.price} â‚½</span>
                                    </div>
                                ))}
                            </div>
                        )}
                    />
                )}
            </div>

            <div>
                <Label htmlFor="notes">Ğ—Ğ°Ğ¼ĞµÑ‚ĞºĞ¸ (Ğ²Ğ¸Ğ´Ğ½Ğ¾ Ñ‚Ğ¾Ğ»ÑŒĞºĞ¾ Ğ¼ĞµĞ½ĞµĞ´Ğ¶ĞµÑ€Ğ°Ğ¼/Ğ°Ğ´Ğ¼Ğ¸Ğ½Ğ°Ğ¼)</Label>
                <Textarea id="notes" {...register("notes")} rows={3} />
                {errors.notes && <p className="text-xs text-red-600 mt-1">{errors.notes.message}</p>}
            </div>

            <div>
                <Label htmlFor="last_maintenance">Ğ”Ğ°Ñ‚Ğ° Ğ¿Ğ¾ÑĞ»ĞµĞ´Ğ½ĞµĞ³Ğ¾ Ğ¢Ğ (Ğ²Ğ¸Ğ´Ğ½Ğ¾ Ñ‚Ğ¾Ğ»ÑŒĞºĞ¾ Ğ¼ĞµĞ½ĞµĞ´Ğ¶ĞµÑ€Ğ°Ğ¼/Ğ°Ğ´Ğ¼Ğ¸Ğ½Ğ°Ğ¼)</Label>
                <Input
                    id="last_maintenance"
                    type="date"
                    {...register("last_maintenance")}
                />
                {errors.last_maintenance && <p className="text-xs text-red-600 mt-1">{errors.last_maintenance.message}</p>}
            </div>

            <div className="flex justify-end gap-3 pt-4 border-t mt-6">
                <Button type="button" variant="ghost" onClick={onCancel}>
                    ĞÑ‚Ğ¼ĞµĞ½Ğ°
                </Button>
                <Button type="submit" disabled={!isDirty || !isValid || updateEquipmentMutation.isPending}>
                    {updateEquipmentMutation.isPending ? "Ğ¡Ğ¾Ñ…Ñ€Ğ°Ğ½ĞµĞ½Ğ¸Ğµ..." : "Ğ¡Ğ¾Ñ…Ñ€Ğ°Ğ½Ğ¸Ñ‚ÑŒ Ğ¸Ğ·Ğ¼ĞµĞ½ĞµĞ½Ğ¸Ñ"}
                </Button>
            </div>
        </form>
    );
}

```


## <a name="rentalappmainsrccomponentsprofileBalanceHistoryTabletsx"></a>`rental-app-main/src/components/profile/BalanceHistoryTable.tsx`

```tsx
// path: rental-app-main/src/components/profile/BalanceHistoryTable.tsx

// src/components/profile/BalanceHistoryTable.tsx

import { useState } from "react";
import { useBalanceHistory, useAdminBalanceHistory } from "@/hooks/useBalanceHistory";
import {
    Table,
    TableBody,
    TableCell,
    TableHead,
    TableHeader,
    TableRow,
    TableCaption,
} from "@/components/ui/table";
import { Button } from "@/components/ui/button";
import { formatDateEuropean } from "@/lib/utils";
import { Loader2, AlertTriangle, ChevronLeft, ChevronRight, Inbox } from "lucide-react";

interface Props {
    userId: number;
    // Ğ¤Ğ»Ğ°Ğ³, Ğ¾Ğ¿Ñ€ĞµĞ´ĞµĞ»ÑÑÑ‰Ğ¸Ğ¹, Ğ¸ÑĞ¿Ğ¾Ğ»ÑŒĞ·ÑƒĞµĞ¼ Ğ»Ğ¸ Ğ¼Ñ‹ Ğ°Ğ´Ğ¼Ğ¸Ğ½ÑĞºĞ¸Ğ¹ Ñ…ÑƒĞº Ğ´Ğ»Ñ Ğ¿Ğ¾Ğ»ÑƒÑ‡ĞµĞ½Ğ¸Ñ Ğ´Ğ°Ğ½Ğ½Ñ‹Ñ…
    isAdminView?: boolean;
}

export default function BalanceHistoryTable({ userId, isAdminView = false }: Props) {
    const [currentPage, setCurrentPage] = useState(1);

    // Ğ’ Ğ·Ğ°Ğ²Ğ¸ÑĞ¸Ğ¼Ğ¾ÑÑ‚Ğ¸ Ğ¾Ñ‚ Ñ„Ğ»Ğ°Ğ³Ğ° isAdminView, Ğ¸ÑĞ¿Ğ¾Ğ»ÑŒĞ·ÑƒĞµĞ¼ ÑĞ¾Ğ¾Ñ‚Ğ²ĞµÑ‚ÑÑ‚Ğ²ÑƒÑÑ‰Ğ¸Ğ¹ Ñ…ÑƒĞº
    const queryResult = isAdminView
        ? useAdminBalanceHistory(userId, currentPage)
        : useBalanceHistory(currentPage);

    const { data: historyResponse, isLoading, isError, error } = queryResult;

    const history = historyResponse?.items ?? [];
    const totalEntries = historyResponse?.total ?? 0;
    const totalPages = Math.ceil(totalEntries / 15); // 15 - PAGE_SIZE Ğ¸Ğ· Ñ…ÑƒĞºĞ°

    if (isLoading) {
        return (
            <div className="flex items-center justify-center gap-2 text-gray-500 py-8">
                <Loader2 className="h-5 w-5 animate-spin" />
                <span>Ğ—Ğ°Ğ³Ñ€ÑƒĞ·ĞºĞ° Ğ¸ÑÑ‚Ğ¾Ñ€Ğ¸Ğ¸ Ñ‚Ñ€Ğ°Ğ½Ğ·Ğ°ĞºÑ†Ğ¸Ğ¹...</span>
            </div>
        );
    }

    if (isError) {
        return (
            <div className="flex items-center justify-center gap-2 text-red-600 bg-red-50 p-4 rounded-md">
                <AlertTriangle className="h-5 w-5" />
                <span>ĞÑˆĞ¸Ğ±ĞºĞ° Ğ·Ğ°Ğ³Ñ€ÑƒĞ·ĞºĞ¸: {error?.message || "ĞĞµ ÑƒĞ´Ğ°Ğ»Ğ¾ÑÑŒ Ğ¿Ğ¾Ğ»ÑƒÑ‡Ğ¸Ñ‚ÑŒ Ğ´Ğ°Ğ½Ğ½Ñ‹Ğµ"}</span>
            </div>
        );
    }

    if (history.length === 0) {
        return (
            <div className="text-center py-10 text-gray-500 border-2 border-dashed rounded-lg">
                <Inbox className="mx-auto h-12 w-12 text-gray-300" />
                <p className="mt-2 font-medium">Ğ˜ÑÑ‚Ğ¾Ñ€Ğ¸Ñ Ñ‚Ñ€Ğ°Ğ½Ğ·Ğ°ĞºÑ†Ğ¸Ğ¹ Ğ¿ÑƒÑÑ‚Ğ°</p>
                <p className="text-sm">Ğ—Ğ´ĞµÑÑŒ Ğ±ÑƒĞ´ÑƒÑ‚ Ğ¾Ñ‚Ğ¾Ğ±Ñ€Ğ°Ğ¶Ğ°Ñ‚ÑŒÑÑ Ğ²ÑĞµ Ğ´Ğ²Ğ¸Ğ¶ĞµĞ½Ğ¸Ñ Ğ¿Ğ¾ Ğ²Ğ°ÑˆĞµĞ¼Ñƒ ÑÑ‡ĞµÑ‚Ñƒ.</p>
            </div>
        );
    }

    return (
        <div className="space-y-4">
            <div className="border rounded-lg">
                <Table>
                    <TableCaption>
                        {totalEntries > 0 ? `ĞŸĞ¾ĞºĞ°Ğ·Ğ°Ğ½Ğ¾ ${history.length} Ğ¸Ğ· ${totalEntries} Ğ·Ğ°Ğ¿Ğ¸ÑĞµĞ¹.` : 'Ğ—Ğ°Ğ¿Ğ¸ÑĞµĞ¹ Ğ½Ğµ Ğ½Ğ°Ğ¹Ğ´ĞµĞ½Ğ¾.'}
                    </TableCaption>
                    <TableHeader>
                        <TableRow>
                            <TableHead className="w-[120px]">Ğ”Ğ°Ñ‚Ğ°</TableHead>
                            <TableHead>Ğ¢Ğ¸Ğ¿ Ğ¾Ğ¿ĞµÑ€Ğ°Ñ†Ğ¸Ğ¸</TableHead>
                            <TableHead>ĞĞ¿Ğ¸ÑĞ°Ğ½Ğ¸Ğµ</TableHead>
                            <TableHead className="text-right w-[150px]">Ğ¡ÑƒĞ¼Ğ¼Ğ°</TableHead>
                        </TableRow>
                    </TableHeader>
                    <TableBody>
                        {history.map((entry) => {
                            const amountColor = entry.amount < 0 ? 'text-red-600' : 'text-green-600';
                            const amountSign = entry.amount > 0 ? '+' : '';

                            return (
                                <TableRow key={entry.id}>
                                    <TableCell className="font-medium text-xs">
                                        {formatDateEuropean(entry.created_at)}
                                    </TableCell>
                                    <TableCell className="text-xs">{entry.operation_type}</TableCell>
                                    <TableCell className="text-xs">{entry.description}</TableCell>
                                    <TableCell className={`text-right font-semibold ${amountColor}`}>
                                        {amountSign} {entry.amount.toLocaleString('ru-RU', { style: 'currency', currency: 'RUB' })}
                                    </TableCell>
                                </TableRow>
                            );
                        })}
                    </TableBody>
                </Table>
            </div>

            {totalPages > 1 && (
                <div className="flex items-center justify-end space-x-2">
                    <span className="text-sm text-muted-foreground">
                        Ğ¡Ñ‚Ñ€Ğ°Ğ½Ğ¸Ñ†Ğ° {currentPage} Ğ¸Ğ· {totalPages}
                    </span>
                    <Button
                        variant="outline"
                        size="sm"
                        onClick={() => setCurrentPage(prev => Math.max(prev - 1, 1))}
                        disabled={currentPage === 1}
                    >
                        <ChevronLeft className="h-4 w-4 mr-1" />
                        ĞĞ°Ğ·Ğ°Ğ´
                    </Button>
                    <Button
                        variant="outline"
                        size="sm"
                        onClick={() => setCurrentPage(prev => Math.min(prev + 1, totalPages))}
                        disabled={currentPage === totalPages}
                    >
                        Ğ’Ğ¿ĞµÑ€ĞµĞ´
                        <ChevronRight className="h-4 w-4 ml-1" />
                    </Button>
                </div>
            )}
        </div>
    );
}

```


## <a name="rentalappmainsrccomponentsrentalMyRentalCardtsx"></a>`rental-app-main/src/components/rental/MyRentalCard.tsx`

```tsx
// path: rental-app-main/src/components/rental/MyRentalCard.tsx

// src/components/rental/MyRentalCard.tsx

import { useState } from "react";
import { Card } from "@/components/ui/card";
import { Button } from "@/components/ui/button";
import RentalStatusBadge from "./RentalStatusBadge";
import { CalendarRange, Truck, ExternalLink, ChevronDown, Paperclip, Tag, ReceiptText, Clock, AlertTriangle } from "lucide-react";
import { useNavigate } from "react-router-dom";
import { formatDateEuropean, calculateDaysOverdue } from "@/lib/utils";
import type { AdminRentalOut } from "@/types/rental";
import { RENTAL_CARD_STYLES } from "@/constants/statusStyles";

interface MyRentalCardProps {
    rental: AdminRentalOut;
    highlightId?: number | null;
}

export default function MyRentalCard({ rental, highlightId }: MyRentalCardProps) {
    const navigate = useNavigate();
    const [expandedAccessories, setExpandedAccessories] = useState<Record<number, boolean>>({});
    
    const isHighlighted = highlightId === rental.id;
    
    const toggleAccessories = (equipmentId: number) => {
        setExpandedAccessories(prev => ({
            ...prev,
            [equipmentId]: !prev[equipmentId]
        }));
    };
    
    
    const start = rental.start_date ? new Date(rental.start_date) : null;
    const end = rental.end_date ? new Date(rental.end_date) : null;
    const actualReturn = rental.actual_return_date ? new Date(rental.actual_return_date) : null;

    const handleReservationClick = () => {
        if (rental.reservation_id) {
            navigate("/reservations/my", { 
                state: { 
                    highlightReservationId: rental.reservation_id,
                    from: "rental"
                } 
            });
        }
    };

    // Ğ›Ğ¾Ğ³Ğ¸ĞºĞ° Ğ´Ğ»Ñ ÑÑ‚Ğ¸Ğ»Ğ¸Ğ·Ğ°Ñ†Ğ¸Ğ¸ ĞºĞ°Ñ€Ñ‚Ğ¾Ñ‡ĞºĞ¸ Ğ² Ğ·Ğ°Ğ²Ğ¸ÑĞ¸Ğ¼Ğ¾ÑÑ‚Ğ¸ Ğ¾Ñ‚ ÑÑ‚Ğ°Ñ‚ÑƒÑĞ°
    const statusClass = RENTAL_CARD_STYLES[rental.status] || RENTAL_CARD_STYLES.default;

    return (
        <Card 
            className={`p-4 space-y-4 transition-all duration-300 ${statusClass} ${isHighlighted ? "ring-2 ring-orange-500 shadow-lg" : ""}`}
        >
            {/* Ğ—Ğ°Ğ³Ğ¾Ğ»Ğ¾Ğ²Ğ¾Ğº Ñ ID Ğ¸ ÑÑ‚Ğ°Ñ‚ÑƒÑĞ¾Ğ¼ */}
            <div className="flex items-center justify-between">
                <div className="flex items-center gap-3">
                    <Truck className="w-5 h-5 text-orange-600" />
                    <h3 className="text-lg font-semibold text-gray-900">
                        ĞÑ€ĞµĞ½Ğ´Ğ° #{rental.id}
                    </h3>
                </div>
                <div className="flex items-center gap-2">
                    <RentalStatusBadge status={rental.status} />
                    {/* Ğ¡ÑÑ‹Ğ»ĞºĞ° Ğ½Ğ° Ñ€ĞµĞ·ĞµÑ€Ğ² */}
                    {rental.reservation_id && (
                        <Button
                            variant="outline"
                            size="sm"
                            onClick={handleReservationClick}
                            className="text-sky-600 hover:text-sky-700 hover:bg-sky-50 border-sky-200"
                        >
                            <ExternalLink className="w-3 h-3 mr-1" />
                            Ğ ĞµĞ·ĞµÑ€Ğ² #{rental.reservation_id}
                        </Button>
                    )}
                </div>
            </div>

            {/* Ğ”Ğ°Ñ‚Ñ‹ */}
            <div className="flex items-center gap-2 text-sm text-gray-600">
                <CalendarRange className="w-4 h-4" />
                <span>
                    {start && end && (
                        <>
                            {formatDateEuropean(start)} - {formatDateEuropean(end)}
                        </>
                    )}
                </span>
            </div>

            {/* Ğ¤Ğ°ĞºÑ‚Ğ¸Ñ‡ĞµÑĞºĞ°Ñ Ğ´Ğ°Ñ‚Ğ° Ğ²Ğ¾Ğ·Ğ²Ñ€Ğ°Ñ‚Ğ° */}
            {actualReturn && (
                <div className="text-sm text-gray-600">
                    <span className="font-medium">Ğ’Ğ¾Ğ·Ğ²Ñ€Ğ°Ñ‚:</span> {formatDateEuropean(actualReturn)}
                </div>
            )}

            {/* Ğ¡Ğ¾ÑÑ‚Ğ°Ğ² Ğ°Ñ€ĞµĞ½Ğ´Ñ‹ */}
            <div className="space-y-2 pt-3 border-t">
                <h4 className="font-medium text-sm text-gray-800">Ğ¡Ğ¾ÑÑ‚Ğ°Ğ² Ğ°Ñ€ĞµĞ½Ğ´Ñ‹:</h4>
                <div className="space-y-2">
                    {rental.equipment.map((item) => {
                        const accessoriesForItem = rental.accessory_links?.filter(link => link.equipment_id === item.id);
                        return (
                            <div key={item.id} className="text-sm text-gray-700 bg-gray-50/70 p-2 rounded-md border">
                                <p>â€¢ {item.name}</p>
                                {accessoriesForItem && accessoriesForItem.length > 0 && (
                                    <div className="mt-2 pl-4">
                                        <button onClick={() => toggleAccessories(item.id)} className="flex items-center text-xs text-sky-700 hover:underline font-medium">
                                            <Paperclip className="w-3 h-3 mr-1" />
                                            ĞĞºÑĞµÑÑÑƒĞ°Ñ€Ñ‹ ({accessoriesForItem.length})
                                            <ChevronDown className={`w-4 h-4 ml-1 transition-transform ${expandedAccessories[item.id] ? 'rotate-180' : ''}`} />
                                        </button>
                                        {expandedAccessories[item.id] && (
                                            <ul className="list-disc list-inside text-xs text-gray-600 mt-1 pl-2 animate-in fade-in duration-200">
                                                {accessoriesForItem.map(link => (
                                                    <li key={link.accessory.id}>{link.accessory.name}</li>
                                                ))}
                                            </ul>
                                        )}
                                    </div>
                                )}
                            </div>
                        );
                    })}
                </div>
            </div>

            {/* Ğ¤Ğ¸Ğ½Ğ°Ğ½ÑĞ¾Ğ²Ñ‹Ğ¹ Ğ±Ğ»Ğ¾Ğº Ñ Ñ‚Ğ°Ğ¹Ğ¼ĞµÑ€Ğ¾Ğ¼ */}
            <div className="flex items-start justify-between pt-3 border-t flex-wrap-reverse gap-4">
                {/* Ğ¤Ğ¸Ğ½Ğ°Ğ½ÑĞ¾Ğ²Ñ‹Ğ¹ Ğ±Ğ»Ğ¾Ğº */}
                <div className="text-xs space-y-1.5 text-slate-700 flex-grow">
                    <h4 className="font-semibold text-sm text-slate-800 flex items-center gap-2 mb-2"><ReceiptText className="w-4 h-4"/>Ğ¤Ğ¸Ğ½Ğ°Ğ½ÑÑ‹</h4>
                    <div className="flex justify-between gap-4"><span>Ğ¡Ñ‚Ğ¾Ğ¸Ğ¼Ğ¾ÑÑ‚ÑŒ Ğ°Ñ€ĞµĞ½Ğ´Ñ‹:</span> <span className="font-medium">{rental.total_cost.toLocaleString('ru-RU')} â‚½</span></div>
                    {rental.discount_amount > 0 && (
                        <div className="flex justify-between gap-4 text-green-600"><span>Ğ¡ĞºĞ¸Ğ´ĞºĞ°:</span> <span className="font-medium">- {rental.discount_amount.toLocaleString('ru-RU')} â‚½</span></div>
                    )}
                    {rental.promo_code && (
                        <div className="flex justify-between items-center gap-4 text-purple-600"><span>ĞŸÑ€Ğ¾Ğ¼Ğ¾ĞºĞ¾Ğ´:</span> <span className="font-medium flex items-center gap-1"><Tag className="w-3 h-3"/>{rental.promo_code}</span></div>
                    )}
                    {rental.overdue_surcharge && rental.overdue_surcharge > 0 && (
                        <div className="flex justify-between gap-4 text-red-600 font-bold pt-1 border-t border-dashed mt-1"><span>Ğ”Ğ¾Ğ¿Ğ»Ğ°Ñ‚Ğ° Ğ·Ğ° Ğ¿Ñ€Ğ¾ÑÑ€Ğ¾Ñ‡ĞºÑƒ:</span> <span>{rental.overdue_surcharge.toLocaleString('ru-RU')} â‚½</span></div>
                    )}
                </div>
                
                {/* Ğ¢Ğ°Ğ¹Ğ¼ĞµÑ€ ÑÑ‚Ğ°Ñ‚ÑƒÑĞ° */}
                {(() => {
                    if (rental.status === 'overdue') {
                        const daysOverdue = calculateDaysOverdue(rental.end_date, rental.overdue_days);
                        return (
                            <div className="flex items-center gap-2 px-2 py-1 rounded-md border text-xs font-medium text-red-600 bg-red-100/60 border-red-200">
                                <AlertTriangle className="w-4 h-4"/>
                                {`ĞŸÑ€Ğ¾ÑÑ€Ğ¾Ñ‡ĞµĞ½Ğ° Ğ½Ğ° ${daysOverdue} Ğ´Ğ½.`}
                            </div>
                        );
                    }
                    if (rental.status === 'active' && rental.days_remaining !== null) {
                        const daysLeft = rental.days_remaining;
                        if (daysLeft <= 1) {
                            return (
                                <div className="flex items-center gap-2 px-2 py-1 rounded-md border text-xs font-medium text-orange-600 bg-orange-100/60 border-orange-200">
                                    <Clock className="w-4 h-4"/>
                                    {`ĞÑÑ‚Ğ°Ğ»ÑÑ ${daysLeft} Ğ´ĞµĞ½ÑŒ`}
                                </div>
                            );
                        }
                        return (
                            <div className="flex items-center gap-2 px-2 py-1 rounded-md border text-xs font-medium text-green-700 bg-green-100/60 border-green-200">
                                <Clock className="w-4 h-4"/>
                                {`ĞÑÑ‚Ğ°Ğ»Ğ¾ÑÑŒ ${daysLeft} Ğ´Ğ½.`}
                            </div>
                        );
                    }
                    return null;
                })()}
            </div>


            {/* Ğ—Ğ°Ğ¼ĞµÑ‚ĞºĞ¸ */}
            {rental.notes_on_issue && (
                <div className="pt-2 border-t">
                    <div className="text-sm">
                        <span className="font-medium text-gray-700">Ğ—Ğ°Ğ¼ĞµÑ‚ĞºĞ¸ Ğ¿Ñ€Ğ¸ Ğ²Ñ‹Ğ´Ğ°Ñ‡Ğµ:</span>
                        <p className="text-gray-600 mt-1">{rental.notes_on_issue}</p>
                    </div>
                </div>
            )}

            {rental.notes_on_return && (
                <div className="pt-2 border-t">
                    <div className="text-sm">
                        <span className="font-medium text-gray-700">Ğ—Ğ°Ğ¼ĞµÑ‚ĞºĞ¸ Ğ¿Ñ€Ğ¸ Ğ²Ğ¾Ğ·Ğ²Ñ€Ğ°Ñ‚Ğµ:</span>
                        <p className="text-gray-600 mt-1">{rental.notes_on_return}</p>
                    </div>
                </div>
            )}
        </Card>
    );
}


```


## <a name="rentalappmainsrccomponentsrentalMyRentalsListtsx"></a>`rental-app-main/src/components/rental/MyRentalsList.tsx`

```tsx
// path: rental-app-main/src/components/rental/MyRentalsList.tsx

// src/components/rental/MyRentalsList.tsx

import { useMemo } from "react";
import { useMyRentals } from "@/hooks/useMyRentals";
import MyRentalCard from "./MyRentalCard";
import { Button } from "@/components/ui/button";
import { RefreshCw, Truck } from "lucide-react";

interface MyRentalsListProps {
    highlightId?: number | null;
    rentalsData?: any;
}

const LoadingState = () => (
    <div className="text-center py-8">
        <div className="flex items-center justify-center mb-4">
            <RefreshCw className="w-8 h-8 animate-spin text-orange-600" />
        </div>
        <p className="text-gray-600">Ğ—Ğ°Ğ³Ñ€ÑƒĞ·ĞºĞ° Ğ°Ñ€ĞµĞ½Ğ´...</p>
    </div>
);

const ErrorState = ({ message, onRetry }: { message: string; onRetry: () => void }) => (
    <div className="text-center py-8">
        <div className="flex items-center justify-center mb-4">
            <Truck className="w-8 h-8 text-gray-400" />
        </div>
        <p className="text-red-600 mb-4">{message}</p>
        <Button onClick={onRetry} variant="outline" size="sm">
            <RefreshCw className="w-4 h-4 mr-2" />
            ĞŸĞ¾Ğ¿Ñ€Ğ¾Ğ±Ğ¾Ğ²Ğ°Ñ‚ÑŒ ÑĞ½Ğ¾Ğ²Ğ°
        </Button>
    </div>
);

const EmptyState = () => (
    <div className="text-center py-12">
        <div className="flex items-center justify-center mb-4">
            <Truck className="w-12 h-12 text-gray-400" />
        </div>
        <h3 className="text-lg font-medium text-gray-900 mb-2">ĞĞµÑ‚ Ğ°Ñ€ĞµĞ½Ğ´</h3>
        <p className="text-gray-600">
            Ğ£ Ğ²Ğ°Ñ Ğ¿Ğ¾ĞºĞ° Ğ½ĞµÑ‚ Ğ°ĞºÑ‚Ğ¸Ğ²Ğ½Ñ‹Ñ… Ğ¸Ğ»Ğ¸ Ğ·Ğ°Ğ²ĞµÑ€ÑˆĞµĞ½Ğ½Ñ‹Ñ… Ğ°Ñ€ĞµĞ½Ğ´.
        </p>
    </div>
);

export default function MyRentalsList({ highlightId, rentalsData: propRentalsData }: MyRentalsListProps) {
    const { data, isLoading, isError, error, fetchNextPage, hasNextPage, isFetchingNextPage, refetch } = useMyRentals();

    // Ğ˜ÑĞ¿Ğ¾Ğ»ÑŒĞ·ÑƒĞµĞ¼ Ğ´Ğ°Ğ½Ğ½Ñ‹Ğµ Ğ¸Ğ· Ğ¿Ñ€Ğ¾Ğ¿ÑĞ¾Ğ² Ğ¸Ğ»Ğ¸ Ğ·Ğ°Ğ³Ñ€ÑƒĞ¶Ğ°ĞµĞ¼ Ğ¸Ñ… ÑĞ°Ğ¼Ğ¾ÑÑ‚Ğ¾ÑÑ‚ĞµĞ»ÑŒĞ½Ğ¾
    const allRentals = useMemo(() => {
        if (propRentalsData?.pages) {
            return propRentalsData.pages.flatMap(page => page.items);
        }
        if (data?.pages) {
            return data.pages.flatMap(page => page.items);
        }
        return [];
    }, [propRentalsData, data]);

    if (isLoading) {
        return <LoadingState />;
    }

    if (isError) {
        return (
            <ErrorState 
                message={error?.message || "ĞÑˆĞ¸Ğ±ĞºĞ° Ğ¿Ñ€Ğ¸ Ğ·Ğ°Ğ³Ñ€ÑƒĞ·ĞºĞµ Ğ°Ñ€ĞµĞ½Ğ´"} 
                onRetry={() => refetch()} 
            />
        );
    }

    if (allRentals.length === 0) {
        return <EmptyState />;
    }

    return (
        <div className="space-y-4">
            {/* Ğ¡Ğ¿Ğ¸ÑĞ¾Ğº Ğ°Ñ€ĞµĞ½Ğ´ */}
            <div className="space-y-4">
                {allRentals.map((rental) => (
                    <MyRentalCard 
                        key={rental.id} 
                        rental={rental} 
                        highlightId={highlightId}
                    />
                ))}
            </div>

            {/* ĞšĞ½Ğ¾Ğ¿ĞºĞ° Ğ·Ğ°Ğ³Ñ€ÑƒĞ·ĞºĞ¸ Ğ´Ğ¾Ğ¿Ğ¾Ğ»Ğ½Ğ¸Ñ‚ĞµĞ»ÑŒĞ½Ñ‹Ñ… Ğ°Ñ€ĞµĞ½Ğ´ */}
            {hasNextPage && (
                <div className="text-center pt-4">
                    <Button
                        onClick={() => fetchNextPage()}
                        disabled={isFetchingNextPage}
                        variant="outline"
                        size="sm"
                    >
                        {isFetchingNextPage ? (
                            <>
                                <RefreshCw className="w-4 h-4 mr-2 animate-spin" />
                                Ğ—Ğ°Ğ³Ñ€ÑƒĞ·ĞºĞ°...
                            </>
                        ) : (
                            "Ğ—Ğ°Ğ³Ñ€ÑƒĞ·Ğ¸Ñ‚ÑŒ ĞµÑ‰Ğµ"
                        )}
                    </Button>
                </div>
            )}
        </div>
    );
}


```


## <a name="rentalappmainsrccomponentsrentalRentalStatusBadgetsx"></a>`rental-app-main/src/components/rental/RentalStatusBadge.tsx`

```tsx
// path: rental-app-main/src/components/rental/RentalStatusBadge.tsx

// src/components/rental/RentalStatusBadge.tsx

import { Badge } from "@/components/ui/badge";

type Status = 'active' | 'overdue' | 'completed';

interface Props {
    status: Status;
}

const statusConfig: Record<Status, { text: string; className: string }> = {
    active: {
        text: "ĞĞºÑ‚Ğ¸Ğ²Ğ½Ğ°",
        className: "bg-green-100 text-green-800 border-green-200",
    },
    overdue: {
        text: "ĞŸÑ€Ğ¾ÑÑ€Ğ¾Ñ‡ĞµĞ½Ğ°",
        className: "bg-orange-100 text-orange-800 border-orange-200",
    },
    completed: {
        text: "Ğ—Ğ°Ğ²ĞµÑ€ÑˆĞµĞ½Ğ°",
        className: "bg-gray-100 text-gray-800 border-gray-200",
    },
};

export default function RentalStatusBadge({ status }: Props) {
    const config = statusConfig[status] || statusConfig.completed;

    return (
        <Badge variant="outline" className={`font-medium ${config.className}`}>
            {config.text}
        </Badge>
    );
}


```


## <a name="rentalappmainsrccomponentsreservationAvailableAccessoriesDropdowntsx"></a>`rental-app-main/src/components/reservation/AvailableAccessoriesDropdown.tsx`

```tsx
// path: rental-app-main/src/components/reservation/AvailableAccessoriesDropdown.tsx

// src/components/reservation/AvailableAccessoriesDropdown.tsx

import { useState } from 'react';
import { Paperclip, ChevronDown, PlusCircle } from 'lucide-react';
import { Button } from '@/components/ui/button';
import { Accessory } from '@/types/accessory';

interface Props {
    accessories: Accessory[];
    equipmentId: number;
    onToggleAccessory: (equipmentId: number, accessoryId: number) => void;
    disabled?: boolean;
    hasTopBorder: boolean;
}

export const AvailableAccessoriesDropdown = ({ accessories, equipmentId, onToggleAccessory, disabled, hasTopBorder }: Props) => {
    const [isExpanded, setExpanded] = useState(false);

    if (accessories.length === 0) {
        return null;
    }

    return (
        <div className={`pt-2 mt-2 ${hasTopBorder ? 'border-t border-dashed' : ''}`}>
            <button
                className="w-full flex justify-between items-center text-sm font-medium text-gray-600 hover:text-sky-700 p-1 -m-1 rounded"
                onClick={(e) => { e.stopPropagation(); setExpanded(p => !p); }}
                aria-expanded={isExpanded}
                disabled={disabled}
            >
                <span className="flex items-center gap-2">
                    <Paperclip className="w-4 h-4" />
                    Ğ”Ğ¾Ğ±Ğ°Ğ²Ğ¸Ñ‚ÑŒ Ğ°ĞºÑĞµÑÑÑƒĞ°Ñ€Ñ‹ ({accessories.length})
                </span>
                <ChevronDown className={`w-5 h-5 transition-transform ${isExpanded ? 'rotate-180' : ''}`} />
            </button>
            {isExpanded && (
                <div className="mt-2 space-y-1 pl-1 animate-in fade-in-0 slide-in-from-top-2 duration-300">
                    {accessories.map(acc => (
                        <div key={acc.id} className="flex items-center justify-between p-1 rounded hover:bg-gray-50">
                            <span className="text-xs font-normal">
                                {acc.name} ({acc.price} â‚½)
                            </span>
                            <Button
                                size="sm"
                                variant="ghost"
                                className="h-6 px-2 text-xs"
                                onClick={() => onToggleAccessory(equipmentId, acc.id)}
                                disabled={disabled}
                            >
                                <PlusCircle className="w-3.5 h-3.5 mr-1" />
                                Ğ”Ğ¾Ğ±Ğ°Ğ²Ğ¸Ñ‚ÑŒ
                            </Button>
                        </div>
                    ))}
                </div>
            )}
        </div>
    );
}

```


## <a name="rentalappmainsrccomponentsreservationEditableDateRangetsx"></a>`rental-app-main/src/components/reservation/EditableDateRange.tsx`

```tsx
// path: rental-app-main/src/components/reservation/EditableDateRange.tsx

// src/components/reservation/EditableDateRange.tsx

import { CalendarRange } from "lucide-react";
import { useDateRange } from "@/hooks/useDateRange";
import { formatDate, formatDateEuropean } from "@/lib/utils";

interface EditableDateRangeProps {
    startDate: Date;
    endDate: Date;
    onChange: (startDate: Date, endDate: Date, source?: 'calendar' | 'slider' | 'manual') => void;
    disabled?: boolean;
}

export default function EditableDateRange({
                                              startDate,
                                              endDate,
                                              onChange,
                                              disabled = false
                                          }: EditableDateRangeProps) {
    const {
        localStartDate,
        localEndDate,
        handleStartDateChange,
        handleEndDateChange
    } = useDateRange({
        // âœ… Ğ˜Ğ¡ĞŸĞ ĞĞ’Ğ›Ğ•ĞĞ: ĞœĞµĞ½ÑĞµĞ¼ initialStartDate/initialEndDate Ğ½Ğ° startDate/endDate
        startDate: startDate,
        endDate: endDate,
        onRangeChange: onChange
    });

    const today = formatDate(new Date());

    return (
        <div className="space-y-3">
            <div className="flex items-center gap-2 text-sm font-medium text-gray-700">
                <CalendarRange className="w-4 h-4" />
                Ğ”Ğ°Ñ‚Ñ‹ Ñ€ĞµĞ·ĞµÑ€Ğ²Ğ°:
            </div>

            <div className="grid grid-cols-1 sm:grid-cols-2 gap-3">
                <div className="space-y-1">
                    <label htmlFor="edit-start-date" className="block text-xs text-gray-600">
                        ĞĞ°Ñ‡Ğ°Ğ»Ğ¾:
                    </label>
                    <input
                        id="edit-start-date"
                        type="date"
                        value={localStartDate}
                        onChange={handleStartDateChange}
                        disabled={disabled}
                        min={today}
                        className={`w-full px-3 py-2 text-sm border rounded-md focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-colors ${
                            disabled
                                ? 'bg-gray-100 cursor-not-allowed'
                                : 'bg-white hover:border-blue-300'
                        }`}
                    />
                    <div className="text-xs text-gray-500">
                        {formatDateEuropean(new Date(localStartDate))}
                    </div>
                </div>

                <div className="space-y-1">
                    <label htmlFor="edit-end-date" className="block text-xs text-gray-600">
                        ĞĞºĞ¾Ğ½Ñ‡Ğ°Ğ½Ğ¸Ğµ:
                    </label>
                    <input
                        id="edit-end-date"
                        type="date"
                        value={localEndDate}
                        onChange={handleEndDateChange}
                        disabled={disabled}
                        min={localStartDate}
                        className={`w-full px-3 py-2 text-sm border rounded-md focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-colors ${
                            disabled
                                ? 'bg-gray-100 cursor-not-allowed'
                                : 'bg-white hover:border-blue-300'
                        }`}
                    />
                    <div className="text-xs text-gray-500">
                        {formatDateEuropean(new Date(localEndDate))}
                    </div>
                </div>
            </div>
        </div>
    );
}

```


## <a name="rentalappmainsrccomponentsreservationEditableEquipmentItemtsx"></a>`rental-app-main/src/components/reservation/EditableEquipmentItem.tsx`

```tsx
// path: rental-app-main/src/components/reservation/EditableEquipmentItem.tsx

// src/components/reservation/EditableEquipmentItem.tsx
import { X } from "lucide-react";
import EquipmentItemWithConflicts from "./EquipmentItemWithConflicts";
import { AvailableAccessoriesDropdown } from "./AvailableAccessoriesDropdown"; // <-- ĞĞ¾Ğ²Ñ‹Ğ¹ Ğ¸Ğ¼Ğ¿Ğ¾Ñ€Ñ‚
import type { Equipment } from "@/types/equipment";
import type { AvailabilityInfo } from "@/types/availability";
import { Button } from "@/components/ui/button";

interface Props {
    itemDetail: { id: number; label: string };
    fullEquipmentItem: Equipment | undefined;
    isNew: boolean;
    hasConflict: boolean;
    availability?: AvailabilityInfo;
    selectedAccessoryIds: number[];
    onRemove: (id: number) => void;
    onToggleAccessory: (equipmentId: number, accessoryId: number) => void;
    disabled?: boolean;
}

export default function EditableEquipmentItem({
                                                  itemDetail,
                                                  fullEquipmentItem,
                                                  isNew,
                                                  hasConflict,
                                                  availability,
                                                  selectedAccessoryIds,
                                                  onRemove,
                                                  onToggleAccessory,
                                                  disabled
                                              }: Props) {

    if (!fullEquipmentItem) {
        return <div className="p-3 bg-gray-100 rounded-md text-sm text-red-600">ĞÑˆĞ¸Ğ±ĞºĞ°: Ğ´Ğ°Ğ½Ğ½Ñ‹Ğµ Ğ¾Ğ±Ğ¾Ñ€ÑƒĞ´Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ Ğ½Ğµ Ğ½Ğ°Ğ¹Ğ´ĞµĞ½Ñ‹.</div>;
    }

    // Ğ Ğ°Ğ·Ğ´ĞµĞ»ÑĞµĞ¼ Ğ°ĞºÑĞµÑÑÑƒĞ°Ñ€Ñ‹ Ğ½Ğ° ÑƒĞ¶Ğµ Ğ²Ñ‹Ğ±Ñ€Ğ°Ğ½Ğ½Ñ‹Ğµ Ğ¸ Ğ´Ğ¾ÑÑ‚ÑƒĞ¿Ğ½Ñ‹Ğµ Ğ´Ğ»Ñ Ğ²Ñ‹Ğ±Ğ¾Ñ€Ğ°
    const selectedAccessoryDetails = fullEquipmentItem.accessories?.filter(
        acc => selectedAccessoryIds.includes(acc.id)
    ) || [];

    const availableAccessoriesDetails = fullEquipmentItem.accessories?.filter(
        acc => !selectedAccessoryIds.includes(acc.id)
    ) || [];


    return (
        <div className="bg-white p-3 rounded-md border">
            {/* Ğ‘Ğ»Ğ¾Ğº Ñ Ğ¾ÑĞ½Ğ¾Ğ²Ğ½Ğ¾Ğ¹ Ğ¸Ğ½Ñ„Ğ¾Ñ€Ğ¼Ğ°Ñ†Ğ¸ĞµĞ¹ Ğ¾Ğ± Ğ¾Ğ±Ğ¾Ñ€ÑƒĞ´Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğ¸ (Ğ±ĞµĞ· Ğ¸Ğ·Ğ¼ĞµĞ½ĞµĞ½Ğ¸Ğ¹) */}
            <EquipmentItemWithConflicts
                item={itemDetail}
                isNew={isNew}
                hasConflict={hasConflict}
                availability={availability}
                onRemove={onRemove}
                disabled={disabled}
            />

            {/* Ğ‘Ğ»Ğ¾Ğº Ğ´Ğ»Ñ ÑƒĞ¶Ğµ Ğ´Ğ¾Ğ±Ğ°Ğ²Ğ»ĞµĞ½Ğ½Ñ‹Ñ… Ğ°ĞºÑĞµÑÑÑƒĞ°Ñ€Ğ¾Ğ² */}
            {selectedAccessoryDetails.length > 0 && (
                <div className="pl-8 pr-2 pt-2 border-t mt-2">
                    <p className="text-xs font-medium text-gray-500 mb-1">Ğ”Ğ¾Ğ±Ğ°Ğ²Ğ»ĞµĞ½Ğ½Ñ‹Ğµ Ğ°ĞºÑĞµÑÑÑƒĞ°Ñ€Ñ‹:</p>
                    <ul className="space-y-1">
                        {selectedAccessoryDetails.map(acc => (
                            <li key={acc.id} className="flex justify-between items-center text-xs text-gray-800 hover:bg-slate-50 p-1 rounded">
                                <span>- {acc.name} <strong>({acc.price} â‚½)</strong></span>
                                <Button
                                    variant="ghost"
                                    size="icon"
                                    className="h-5 w-5 text-gray-400 hover:bg-red-50 hover:text-red-600"
                                    onClick={() => onToggleAccessory(fullEquipmentItem.id, acc.id)}
                                    disabled={disabled}
                                    title="Ğ£Ğ±Ñ€Ğ°Ñ‚ÑŒ Ğ°ĞºÑĞµÑÑÑƒĞ°Ñ€"
                                >
                                    <X className="w-3 h-3" />
                                </Button>
                            </li>
                        ))}
                    </ul>
                </div>
            )}

            {/* Ğ’Ñ‹Ğ¿Ğ°Ğ´Ğ°ÑÑ‰Ğ¸Ğ¹ ÑĞ¿Ğ¸ÑĞ¾Ğº Ğ´Ğ»Ñ Ğ´Ğ¾Ğ±Ğ°Ğ²Ğ»ĞµĞ½Ğ¸Ñ Ğ½Ğ¾Ğ²Ñ‹Ñ… Ğ°ĞºÑĞµÑÑÑƒĞ°Ñ€Ğ¾Ğ² */}
            <AvailableAccessoriesDropdown
                accessories={availableAccessoriesDetails}
                equipmentId={fullEquipmentItem.id}
                onToggleAccessory={onToggleAccessory}
                disabled={disabled}
                hasTopBorder={selectedAccessoryDetails.length > 0}
            />
        </div>
    );
}

```


## <a name="rentalappmainsrccomponentsreservationEditableReservationCardtsx"></a>`rental-app-main/src/components/reservation/EditableReservationCard.tsx`

```tsx
// path: rental-app-main/src/components/reservation/EditableReservationCard.tsx

// src/components/reservation/EditableReservationCard.tsx

import React from "react"; // âœ… Ğ£Ğ±Ñ€Ğ°Ğ»Ğ¸ Ğ½ĞµĞ¸ÑĞ¿Ğ¾Ğ»ÑŒĞ·ÑƒĞµĞ¼Ñ‹Ğ¹ useMemo
import { Card } from "@/components/ui/card";
import { Button } from "@/components/ui/button";
import { Badge } from "@/components/ui/badge";
import { Loader2, Plus, Save, X, AlertTriangle, Sparkles } from "lucide-react";
import EditableDateRange from "./EditableDateRange";
import FinancialSummaryBlock from "@/components/shared/FinancialSummaryBlock";
import EditableEquipmentItem from "./EditableEquipmentItem";
import { useReservationEditContext } from "@/contexts/ReservationEditContext";
import { useNavigate } from "react-router-dom";
import HolidayConfirmationDialog from "./HolidayConfirmationDialog";
import { formatDateEuropean } from "@/lib/utils"; // âœ… Ğ”Ğ¾Ğ±Ğ°Ğ²Ğ¸Ğ»Ğ¸ Ğ½ĞµĞ´Ğ¾ÑÑ‚Ğ°ÑÑ‰Ğ¸Ğ¹ Ğ¸Ğ¼Ğ¿Ğ¾Ñ€Ñ‚

export default function EditableReservationCard() {
    const {
        reservationId,
        editState,
        availabilityMap,
        equipmentMap,
        hasConflicts,
        saveChanges,
        cancelEdit,
        updateDates,
        removeEquipmentItem,
        isLoading,
        isCheckingAvailability,
        isSaving,
        localSelectedAccessories,
        toggleAccessory,
        holidayConflict,
        confirmHolidayAdjustment,
        cancelHolidayAdjustment,
        priceDetails,
        financials,
        setPromoCode,
        applyPromoCode,
        removePromoCode,
    } = useReservationEditContext();

    const navigate = useNavigate();

    const displayNewItemsCount = editState.newlyAddedEquipmentIdsAsArray.length;
    const equipmentToDisplay = editState.currentEquipmentDetails;
    const totalItemsInEdit = equipmentToDisplay.length;

    const onAddEquipment = () => {
        navigate("/", {
            state: {
                intent: "add_to_reservation",
                reservationId: reservationId,
                equipmentIds: editState.currentEquipmentDetails.map(eq => eq.id),
                startDate: editState.startDate.toISOString(),
                endDate: editState.endDate.toISOString(),
            }
        });
    };

    return (
        <>
            <Card className="w-full px-5 py-4 rounded-2xl border shadow-md bg-blue-50 border-blue-300 transition-all">
                <div className="space-y-4">
                    <div className="flex justify-between items-center">
                        <div className="flex items-center gap-2">
                            <div className="text-base font-semibold text-blue-700">
                                âœï¸ Ğ ĞµĞ´Ğ°ĞºÑ‚Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ Ñ€ĞµĞ·ĞµÑ€Ğ²Ğ° #{reservationId}
                            </div>
                            {isCheckingAvailability && (
                                <div className="flex items-center gap-1 text-xs text-blue-600">
                                    <Loader2 className="w-3 h-3 animate-spin" />
                                    ĞŸÑ€Ğ¾Ğ²ĞµÑ€ĞºĞ° Ğ´Ğ¾ÑÑ‚ÑƒĞ¿Ğ½Ğ¾ÑÑ‚Ğ¸...
                                </div>
                            )}
                        </div>
                        <div className="flex items-center gap-2">
                            <Badge variant="outline" className="bg-blue-100 text-blue-700 border-blue-300">
                                Ğ ĞµĞ´Ğ°ĞºÑ‚Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ
                            </Badge>
                            {displayNewItemsCount > 0 && (
                                <Badge variant="outline" className="bg-green-100 text-green-700 border-green-300">
                                    <Sparkles className="w-3 h-3 mr-1" />
                                    +{displayNewItemsCount} Ğ½Ğ¾Ğ²Ñ‹Ñ…
                                </Badge>
                            )}
                        </div>
                    </div>

                    <div className="grid grid-cols-1 md:grid-cols-3 gap-6">
                        <div className="md:col-span-2 space-y-4">
                            {hasConflicts && (
                                <div className="flex items-start gap-2 p-3 bg-red-50 border border-red-200 rounded-md">
                                    <AlertTriangle className="w-4 h-4 text-red-600 mt-0.5 flex-shrink-0" />
                                    <div className="text-sm text-red-700">
                                        <div className="font-medium">ĞĞ±Ğ½Ğ°Ñ€ÑƒĞ¶ĞµĞ½Ñ‹ ĞºĞ¾Ğ½Ñ„Ğ»Ğ¸ĞºÑ‚Ñ‹!</div>
                                        <div className="text-xs mt-1">
                                            ĞĞµĞºĞ¾Ñ‚Ğ¾Ñ€Ğ¾Ğµ Ğ¾Ğ±Ğ¾Ñ€ÑƒĞ´Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ Ğ½ĞµĞ´Ğ¾ÑÑ‚ÑƒĞ¿Ğ½Ğ¾ Ğ½Ğ° Ğ²Ñ‹Ğ±Ñ€Ğ°Ğ½Ğ½Ñ‹Ğµ Ğ´Ğ°Ñ‚Ñ‹.
                                            ĞŸĞ¾Ğ¶Ğ°Ğ»ÑƒĞ¹ÑÑ‚Ğ°, Ğ¸ÑĞ¿Ñ€Ğ°Ğ²ÑŒÑ‚Ğµ ĞºĞ¾Ğ½Ñ„Ğ»Ğ¸ĞºÑ‚Ñ‹ Ğ¿ĞµÑ€ĞµĞ´ ÑĞ¾Ñ…Ñ€Ğ°Ğ½ĞµĞ½Ğ¸ĞµĞ¼.
                                        </div>
                                    </div>
                                </div>
                            )}

                            <EditableDateRange
                                startDate={editState.startDate}
                                endDate={editState.endDate}
                                onChange={updateDates}
                                disabled={isLoading}
                            />

                            <div className="space-y-3">
                                <div className="flex justify-between items-center">
                                    <div className="text-sm font-medium text-gray-700">
                                        ĞĞ±Ğ¾Ñ€ÑƒĞ´Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ ({totalItemsInEdit} Ğ¿Ğ¾Ğ·.
                                        {displayNewItemsCount > 0 && (
                                            <span className="text-green-600">
                                                , Ğ¸Ğ· Ğ½Ğ¸Ñ… {displayNewItemsCount} Ğ½Ğ¾Ğ²Ñ‹Ñ…
                                            </span>
                                        )}
                                        ):
                                    </div>
                                    <Button
                                        variant="outline"
                                        size="sm"
                                        onClick={onAddEquipment}
                                        disabled={isLoading}
                                        className="text-xs px-3 py-1 h-7"
                                    >
                                        <Plus className="w-3 h-3 mr-1" />
                                        Ğ”Ğ¾Ğ±Ğ°Ğ²Ğ¸Ñ‚ÑŒ
                                    </Button>
                                </div>
                                {totalItemsInEdit === 0 ? (
                                    <div className="text-sm text-gray-500 text-center py-6 border border-dashed border-gray-300 rounded-md">
                                        ĞĞµÑ‚ Ğ¾Ğ±Ğ¾Ñ€ÑƒĞ´Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ Ğ² Ñ€ĞµĞ·ĞµÑ€Ğ²Ğµ.{" "}
                                        <button
                                            onClick={onAddEquipment}
                                            disabled={isLoading}
                                            className="text-blue-600 hover:underline"
                                        >
                                            Ğ”Ğ¾Ğ±Ğ°Ğ²Ğ¸Ñ‚ÑŒ Ğ¾Ğ±Ğ¾Ñ€ÑƒĞ´Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ
                                        </button>
                                    </div>
                                ) : (
                                    <div className="space-y-2">
                                        {equipmentToDisplay.map((itemDetail) => {
                                            const availability = availabilityMap[itemDetail.id];
                                            const itemHasConflict = !!availability && (
                                                availability.status === "reserved" || availability.status === "rented"
                                            );
                                            const isNew = editState.newlyAddedEquipmentIdsAsArray.includes(itemDetail.id);

                                            return (
                                                <EditableEquipmentItem
                                                    key={itemDetail.id}
                                                    itemDetail={itemDetail}
                                                    fullEquipmentItem={equipmentMap.get(itemDetail.id)}
                                                    isNew={isNew}
                                                    hasConflict={itemHasConflict}
                                                    availability={availability}
                                                    selectedAccessoryIds={localSelectedAccessories[itemDetail.id] || []}
                                                    onRemove={() => removeEquipmentItem(itemDetail.id)}
                                                    onToggleAccessory={toggleAccessory}
                                                    disabled={isLoading}
                                                />
                                            );
                                        })}
                                    </div>
                                )}
                            </div>
                        </div>

                        <div className="md:col-span-1">
                            <FinancialSummaryBlock
                                priceDetails={priceDetails}
                                promoCode={financials.promoCode}
                                setPromoCode={setPromoCode}
                                applyPromoCode={applyPromoCode}
                                removePromoCode={removePromoCode}
                                promoCodeMessage={financials.promoCodeMessage}
                                isLoading={isCheckingAvailability}
                                hasConflicts={hasConflicts}
                                variant="inline"
                                showActions={false}
                            />
                        </div>
                    </div>

                    <div className="flex flex-col sm:flex-row justify-end items-center gap-3 pt-4 border-t border-blue-200 mt-4">
                        <Button
                            variant="ghost"
                            onClick={cancelEdit}
                            disabled={isLoading}
                            className="text-sm mr-auto"
                        >
                            <X className="w-4 h-4 mr-1" />
                            ĞÑ‚Ğ¼ĞµĞ½Ğ°
                        </Button>
                        <Button
                            onClick={() => saveChanges()}
                            disabled={!editState.hasChanges || hasConflicts || isLoading || totalItemsInEdit === 0}
                            className="text-sm min-w-[120px]"
                        >
                            {isSaving ? (
                                <>
                                    <Loader2 className="w-4 h-4 mr-1 animate-spin" />
                                    Ğ¡Ğ¾Ñ…Ñ€Ğ°Ğ½ĞµĞ½Ğ¸Ğµ...
                                </>
                            ) : (
                                <>
                                    <Save className="w-4 h-4 mr-1" />
                                    Ğ¡Ğ¾Ñ…Ñ€Ğ°Ğ½Ğ¸Ñ‚ÑŒ
                                </>
                            )}
                        </Button>
                    </div>

                    <div className="text-xs text-gray-500 bg-gray-50 border border-gray-200 rounded p-2 space-y-1 mt-4">
                        <div>ğŸ’¡ ĞŸĞ¾Ğ´ÑĞºĞ°Ğ·ĞºĞ¸:</div>
                        <ul className="space-y-0.5 ml-3">
                            <li>â€¢ Ğ—ĞµĞ»ĞµĞ½Ñ‹Ğ¼ Ğ¾Ñ‚Ğ¼ĞµÑ‡ĞµĞ½Ñ‹ Ğ½Ğ¾Ğ²Ñ‹Ğµ Ğ¿Ğ¾Ğ·Ğ¸Ñ†Ğ¸Ğ¸, Ğ´Ğ¾Ğ±Ğ°Ğ²Ğ»ĞµĞ½Ğ½Ñ‹Ğµ Ğ¿Ñ€Ğ¸ Ñ‚ĞµĞºÑƒÑ‰ĞµĞ¼ Ñ€ĞµĞ´Ğ°ĞºÑ‚Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğ¸.</li>
                            <li>â€¢ Ğ–ĞµĞ»Ñ‚Ñ‹Ğ¼/ĞºÑ€Ğ°ÑĞ½Ñ‹Ğ¼ Ğ¾Ñ‚Ğ¼ĞµÑ‡ĞµĞ½Ñ‹ ĞºĞ¾Ğ½Ñ„Ğ»Ğ¸ĞºÑ‚Ñ‹ Ñ Ğ´Ñ€ÑƒĞ³Ğ¸Ğ¼Ğ¸ Ñ€ĞµĞ·ĞµÑ€Ğ²Ğ°Ğ¼Ğ¸.</li>
                            <li>â€¢ ĞĞ°Ğ¶Ğ¼Ğ¸Ñ‚Ğµ "Ğ”Ğ¾Ğ±Ğ°Ğ²Ğ¸Ñ‚ÑŒ Ğ¾Ğ±Ğ¾Ñ€ÑƒĞ´Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ" Ğ´Ğ»Ñ Ğ²Ñ‹Ğ±Ğ¾Ñ€Ğ° Ğ´Ğ¾Ğ¿Ğ¾Ğ»Ğ½Ğ¸Ñ‚ĞµĞ»ÑŒĞ½Ñ‹Ñ… Ğ¿Ğ¾Ğ·Ğ¸Ñ†Ğ¸Ğ¹.</li>
                            <li>â€¢ ĞšĞ½Ğ¾Ğ¿ĞºĞ° "Ğ¡Ğ¾Ñ…Ñ€Ğ°Ğ½Ğ¸Ñ‚ÑŒ" Ğ°ĞºÑ‚Ğ¸Ğ²Ğ½Ğ° Ñ‚Ğ¾Ğ»ÑŒĞºĞ¾ Ğ¿Ñ€Ğ¸ Ğ½Ğ°Ğ»Ğ¸Ñ‡Ğ¸Ğ¸ Ğ¸Ğ·Ğ¼ĞµĞ½ĞµĞ½Ğ¸Ğ¹ Ğ¸ Ğ¾Ñ‚ÑÑƒÑ‚ÑÑ‚Ğ²Ğ¸Ğ¸ ĞºĞ¾Ğ½Ñ„Ğ»Ğ¸ĞºÑ‚Ğ¾Ğ².</li>
                            <li>â€¢ ĞŸĞ¾ÑĞ»Ğµ ÑĞ¾Ñ…Ñ€Ğ°Ğ½ĞµĞ½Ğ¸Ñ Ğ½Ğ¾Ğ²Ñ‹Ğµ Ğ¿Ğ¾Ğ·Ğ¸Ñ†Ğ¸Ğ¸ ÑÑ‚Ğ°Ğ½ÑƒÑ‚ Ğ¾Ğ±Ñ‹Ñ‡Ğ½Ñ‹Ğ¼Ğ¸ Ñ‡Ğ°ÑÑ‚ÑĞ¼Ğ¸ Ñ€ĞµĞ·ĞµÑ€Ğ²Ğ°.</li>
                        </ul>
                    </div>
                </div>
            </Card>

            <HolidayConfirmationDialog
                open={!!holidayConflict}
                message={holidayConflict?.message || ""}
                suggestedDate={holidayConflict ? formatDateEuropean(new Date(holidayConflict.suggested_end_date)) : ""}
                onConfirm={confirmHolidayAdjustment}
                onCancel={cancelHolidayAdjustment}
                isConfirming={isSaving}
            />
        </>
    );
}

```


## <a name="rentalappmainsrccomponentsreservationEquipmentItemWithConflictstsx"></a>`rental-app-main/src/components/reservation/EquipmentItemWithConflicts.tsx`

```tsx
// path: rental-app-main/src/components/reservation/EquipmentItemWithConflicts.tsx

// src/components/reservation/EquipmentItemWithConflicts.tsx
import { Button } from "@/components/ui/button";
import { MinusCircle, AlertTriangle, CheckCircle, Sparkles } from "lucide-react";
import { formatDateRangeEuropean } from "@/lib/utils";
import type { AvailabilityInfo } from "@/types/availability";

interface EquipmentItemWithConflictsProps {
    item: { id: number; label: string };
    isNew: boolean;
    hasConflict: boolean;
    availability?: AvailabilityInfo;
    onRemove?: (id: number) => void;
    disabled?: boolean;
}

export default function EquipmentItemWithConflicts({
                                                       item,
                                                       isNew,
                                                       hasConflict,
                                                       availability,
                                                       onRemove,
                                                       disabled = false
                                                   }: EquipmentItemWithConflictsProps) {

    const getStatusInfo = () => {
        if (hasConflict && availability) {
            const dateRange = availability.start_date && availability.end_date
                ? formatDateRangeEuropean(availability.start_date, availability.end_date)
                : "";

            if (availability.status === "reserved") {
                return {
                    icon: <AlertTriangle className="w-4 h-4" />,
                    color: "text-yellow-600",
                    bgColor: "bg-yellow-50 border-yellow-200",
                    status: "Ğ—Ğ°Ñ€ĞµĞ·ĞµÑ€Ğ²Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¾",
                    dateText: dateRange
                };
            } else if (availability.status === "rented") {
                return {
                    icon: <AlertTriangle className="w-4 h-4" />,
                    color: "text-red-600",
                    bgColor: "bg-red-50 border-red-200",
                    status: "Ğ’ Ğ°Ñ€ĞµĞ½Ğ´Ğµ",
                    dateText: dateRange
                };
            }
        }

        if (isNew) {
            return {
                icon: <Sparkles className="w-4 h-4" />,
                color: "text-green-600",
                bgColor: "bg-green-50 border-green-200",
                status: "ĞĞ¾Ğ²Ğ°Ñ Ğ¿Ğ¾Ğ·Ğ¸Ñ†Ğ¸Ñ",
                dateText: ""
            };
        }

        return {
            icon: <CheckCircle className="w-4 h-4" />,
            color: "text-gray-600",
            bgColor: "bg-gray-50 border-gray-200",
            status: "Ğ”Ğ¾ÑÑ‚ÑƒĞ¿Ğ½Ğ¾",
            dateText: ""
        };
    };

    const statusInfo = getStatusInfo();

    return (
        <div className={`flex justify-between items-start p-3 rounded-md border transition-colors ${statusInfo.bgColor}`}>
            <div className="flex-1 min-w-0">
                <div className="flex items-start gap-2">
                    <div className={`flex-shrink-0 mt-0.5 ${statusInfo.color}`}>
                        {statusInfo.icon}
                    </div>

                    <div className="flex-1 min-w-0">
                        <div className="text-sm font-medium text-gray-900 truncate">
                            {item.label}
                        </div>

                        <div className={`text-xs ${statusInfo.color} mt-1`}>
                            {statusInfo.status}
                            {statusInfo.dateText && (
                                <span className="ml-1 font-normal">
                  ({statusInfo.dateText})
                </span>
                            )}
                        </div>

                        {hasConflict && (
                            <div className="text-xs text-red-600 mt-1 font-medium">
                                âš ï¸ ĞšĞ¾Ğ½Ñ„Ğ»Ğ¸ĞºÑ‚: Ğ¾Ğ±Ğ¾Ñ€ÑƒĞ´Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ Ğ½ĞµĞ´Ğ¾ÑÑ‚ÑƒĞ¿Ğ½Ğ¾ Ğ½Ğ° Ğ²Ñ‹Ğ±Ñ€Ğ°Ğ½Ğ½Ñ‹Ğµ Ğ´Ğ°Ñ‚Ñ‹
                            </div>
                        )}
                    </div>
                </div>
            </div>

            {onRemove && (
                <Button
                    variant="ghost"
                    size="icon"
                    onClick={() => onRemove(item.id)}
                    disabled={disabled}
                    className={`ml-2 h-8 w-8 flex-shrink-0 hover:text-red-700 ${
                        disabled
                            ? "text-gray-400 cursor-not-allowed"
                            : hasConflict
                                ? "text-red-500 hover:bg-red-100"
                                : "text-gray-500 hover:bg-gray-100"
                    }`}
                    title="Ğ£Ğ´Ğ°Ğ»Ğ¸Ñ‚ÑŒ Ğ¸Ğ· Ñ€ĞµĞ·ĞµÑ€Ğ²Ğ°"
                >
                    <MinusCircle className="w-4 h-4" />
                </Button>
            )}
        </div>
    );
}

```


## <a name="rentalappmainsrccomponentsreservationHolidayConfirmationDialogtsx"></a>`rental-app-main/src/components/reservation/HolidayConfirmationDialog.tsx`

```tsx
// path: rental-app-main/src/components/reservation/HolidayConfirmationDialog.tsx

// src/components/reservation/HolidayConfirmationDialog.tsx
import {
    Dialog,
    DialogContent,
    DialogHeader,
    DialogTitle,
    DialogDescription,
    DialogFooter,
} from "@/components/ui/dialog";
import { Button } from "@/components/ui/button";
import { AlertTriangle } from "lucide-react";

type Props = {
    open: boolean;
    message: string;
    suggestedDate: string;
    onConfirm: () => void;
    onCancel: () => void;
    isConfirming: boolean;
};

export default function HolidayConfirmationDialog({
                                                      open,
                                                      message,
                                                      suggestedDate,
                                                      onConfirm,
                                                      onCancel,
                                                      isConfirming,
                                                  }: Props) {
    return (
        <Dialog open={open} onOpenChange={onCancel}>
            <DialogContent>
                <DialogHeader>
                    <DialogTitle className="flex items-center gap-2">
                        <AlertTriangle className="text-amber-500" />
                        Ğ”Ğ°Ñ‚Ğ° Ğ¾ĞºĞ¾Ğ½Ñ‡Ğ°Ğ½Ğ¸Ñ - Ğ²Ñ‹Ñ…Ğ¾Ğ´Ğ½Ğ¾Ğ¹
                    </DialogTitle>
                </DialogHeader>
                <DialogDescription>
                    <p>{message}</p>
                    <p className="mt-2">
                        Ğ’Ñ‹ Ñ…Ğ¾Ñ‚Ğ¸Ñ‚Ğµ Ğ°Ğ²Ñ‚Ğ¾Ğ¼Ğ°Ñ‚Ğ¸Ñ‡ĞµÑĞºĞ¸ Ğ¸Ğ·Ğ¼ĞµĞ½Ğ¸Ñ‚ÑŒ Ğ´Ğ°Ñ‚Ñƒ Ğ¾ĞºĞ¾Ğ½Ñ‡Ğ°Ğ½Ğ¸Ñ Ğ½Ğ° Ğ±Ğ»Ğ¸Ğ¶Ğ°Ğ¹ÑˆĞ¸Ğ¹ Ñ€Ğ°Ğ±Ğ¾Ñ‡Ğ¸Ğ¹ Ğ´ĞµĞ½ÑŒ:
                        <strong className="text-gray-800"> {suggestedDate}</strong>?
                    </p>
                </DialogDescription>
                <DialogFooter className="pt-4">
                    <Button variant="ghost" onClick={onCancel} disabled={isConfirming}>
                        ĞĞµÑ‚, Ñ Ğ²Ñ‹Ğ±ĞµÑ€Ñƒ Ğ´Ñ€ÑƒĞ³ÑƒÑ Ğ´Ğ°Ñ‚Ñƒ
                    </Button>
                    <Button
                        onClick={onConfirm}
                        disabled={isConfirming}
                    >
                        {isConfirming ? "Ğ¡Ğ¾Ñ…Ñ€Ğ°Ğ½ĞµĞ½Ğ¸Ğµ..." : "Ğ”Ğ°, Ğ¸Ğ·Ğ¼ĞµĞ½Ğ¸Ñ‚ÑŒ"}
                    </Button>
                </DialogFooter>
            </DialogContent>
        </Dialog>
    );
}

```


## <a name="rentalappmainsrccomponentsreservationReservationItemsListtsx"></a>`rental-app-main/src/components/reservation/ReservationItemsList.tsx`

```tsx
// path: rental-app-main/src/components/reservation/ReservationItemsList.tsx

// src/components/reservation/ReservationItemsList.tsx
import ReserveEquipmentCard from "@/components/ReserveEquipmentCard";
import { Button } from "@/components/ui/button";
import { Paperclip, X } from "lucide-react";
import type { Equipment } from "@/types/equipment";
import type { AvailabilityInfo } from "@/types/availability";

interface Props {
    items: Equipment[];
    selectedAccessories: Record<number, number[]>;
    availabilityMap: Record<number, AvailabilityInfo>;
    unavailableIdsFromAPI: number[];
    invalidItems: number[];
    onRemoveItem: (id: number) => void;
    onRemoveAccessory: (equipmentId: number, accessoryId: number) => void;
    // âœ… Ğ”ĞĞ‘ĞĞ’Ğ›Ğ•ĞĞ« ĞĞĞ’Ğ«Ğ• Ğ¡Ğ’ĞĞ™Ğ¡Ğ¢Ğ’Ğ
    isAccessorySelected: (equipmentId: number, accessoryId: number) => boolean;
    onToggleAccessory: (equipmentId: number, accessoryId: number) => void;
}

export default function ReservationItemsList({
                                                 items,
                                                 selectedAccessories,
                                                 availabilityMap,
                                                 unavailableIdsFromAPI,
                                                 invalidItems,
                                                 onRemoveItem,
                                                 onRemoveAccessory,
                                                 // âœ… ĞŸĞĞ›Ğ£Ğ§ĞĞ•Ğœ ĞĞĞ’Ğ«Ğ• Ğ¡Ğ’ĞĞ™Ğ¡Ğ¢Ğ’Ğ
                                                 isAccessorySelected,
                                                 onToggleAccessory,
                                             }: Props) {
    return (
        <div className="space-y-4 pt-4">
            {items.map((item) => {
                const selectedAccessoryIds = selectedAccessories[item.id] || [];
                const selectedAccessoryDetails = item.accessories?.filter(acc =>
                    selectedAccessoryIds.includes(acc.id)
                ) || [];

                return (
                    <div
                        key={item.id}
                        className={`border rounded-lg overflow-hidden shadow-sm transition-all ${
                            unavailableIdsFromAPI.includes(item.id) || invalidItems.includes(item.id)
                                ? "border-red-400 bg-red-50"
                                : "border-gray-200 bg-white"
                        }`}
                    >
                        <ReserveEquipmentCard
                            equipment={item}
                            availability={availabilityMap[item.id]}
                            onRemove={() => onRemoveItem(item.id)}
                            // âœ… ĞŸĞ•Ğ Ğ•Ğ”ĞĞ•Ğœ Ğ¤Ğ£ĞĞšĞ¦Ğ˜Ğ˜ Ğ’ ĞšĞĞ Ğ¢ĞĞ§ĞšĞ£
                            isAccessorySelected={isAccessorySelected}
                            onToggleAccessory={onToggleAccessory}
                        />

                        {selectedAccessoryDetails.length > 0 && (
                            <div className="px-4 pb-3 pt-2 bg-slate-50 border-t border-dashed">
                                <h4 className="flex items-center gap-1.5 text-xs font-semibold text-gray-600 mb-2">
                                    <Paperclip className="h-3.5 w-3.5" />
                                    Ğ”Ğ¾Ğ¿. Ğ°ĞºÑĞµÑÑÑƒĞ°Ñ€Ñ‹:
                                </h4>
                                <ul className="space-y-1.5">
                                    {selectedAccessoryDetails.map(acc => (
                                        <li key={acc.id} className="flex items-center justify-between text-xs hover:bg-slate-100 p-1 rounded-md">
                                            <span className="text-gray-800">{acc.name}</span>
                                            <div className="flex items-center gap-2">
                                                <span className="text-gray-500 font-medium">{acc.price} â‚½</span>
                                                <Button
                                                    variant="ghost"
                                                    size="icon"
                                                    className="h-5 w-5 text-gray-400 hover:text-red-500 hover:bg-red-50"
                                                    onClick={() => onRemoveAccessory(item.id, acc.id)}
                                                    title="Ğ£Ğ´Ğ°Ğ»Ğ¸Ñ‚ÑŒ Ğ°ĞºÑĞµÑÑÑƒĞ°Ñ€"
                                                >
                                                    <X className="h-3 w-3" />
                                                </Button>
                                            </div>
                                        </li>
                                    ))}
                                </ul>
                            </div>
                        )}

                        {(unavailableIdsFromAPI.includes(item.id) || invalidItems.includes(item.id)) && (
                            <p className="text-sm text-red-600 px-4 pb-2 pt-0">
                                Ğ­Ñ‚Ğ¾ Ğ¾Ğ±Ğ¾Ñ€ÑƒĞ´Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ Ğ½ĞµĞ´Ğ¾ÑÑ‚ÑƒĞ¿Ğ½Ğ¾ Ğ½Ğ° Ğ²Ñ‹Ğ±Ñ€Ğ°Ğ½Ğ½Ñ‹Ğµ Ğ´Ğ°Ñ‚Ñ‹.
                            </p>
                        )}
                    </div>
                )
            })}
        </div>
    );
}

```


## <a name="rentalappmainsrccomponentsreservationReservationStatusBadgetsx"></a>`rental-app-main/src/components/reservation/ReservationStatusBadge.tsx`

```tsx
// path: rental-app-main/src/components/reservation/ReservationStatusBadge.tsx

// src/components/reservation/ReservationStatusBadge.tsx

import { Badge } from "@/components/ui/badge";
import type { Reservation } from "@/types/reservation";

type Status = Reservation['status'];

interface Props {
    status: Status;
}

const statusConfig: Record<Status, { text: string; className: string }> = {
    active: {
        text: "ĞĞºÑ‚Ğ¸Ğ²ĞµĞ½",
        className: "bg-green-100 text-green-800 border-green-200",
    },
    fulfilled: {
        text: "Ğ’Ñ‹Ğ´Ğ°Ğ½ Ğ² Ğ°Ñ€ĞµĞ½Ğ´Ñƒ",
        className: "bg-blue-100 text-blue-800 border-blue-200",
    },
    cancelled: {
        text: "ĞÑ‚Ğ¼ĞµĞ½ĞµĞ½",
        className: "bg-gray-100 text-gray-800 border-gray-200",
    },
    overdue: {
        text: "ĞŸÑ€Ğ¾ÑÑ€Ğ¾Ñ‡ĞµĞ½",
        className: "bg-orange-100 text-orange-800 border-orange-200",
    },
};

export default function ReservationStatusBadge({ status }: Props) {
    const config = statusConfig[status] || statusConfig.cancelled;

    return (
        <Badge variant="outline" className={`font-medium ${config.className}`}>
            {config.text}
        </Badge>
    );
}


```


## <a name="rentalappmainsrccomponentsreservationViewReservationCardtsx"></a>`rental-app-main/src/components/reservation/ViewReservationCard.tsx`

```tsx
// path: rental-app-main/src/components/reservation/ViewReservationCard.tsx

// src/components/reservation/ViewReservationCard.tsx

import { Button } from "@/components/ui/button";
import { Card } from "@/components/ui/card";
import ReservationStatusBadge from "./ReservationStatusBadge";
import { MinusCircle, CalendarRange, Edit2, RotateCcw, Trash2, ExternalLink } from "lucide-react";
import { useNavigate, useLocation } from "react-router-dom";
import { formatDateEuropean } from "@/lib/utils";
import type { Reservation, AccessoryLink } from "@/types/reservation";
import { useState } from "react";
import EquipmentWithAccessoriesList from "@/components/shared/EquipmentWithAccessoriesList";
import FinancialInfoBlock from "@/components/shared/FinancialInfoBlock";
import { RESERVATION_CARD_STYLES } from "@/constants/statusStyles";

interface ViewReservationCardProps {
    id: number;
    equipment: { id: number; label: string }[];
    start_date: string;
    end_date: string;
    status: Reservation['status'];
    onEdit?: () => void;
    onCancel?: () => void;
    onRemoveItem?: (equipmentId: number) => void;
    onRepeat?: () => void;
    cancelDisabled?: boolean;
    total_cost?: number;
    discount_amount?: number;
    promo_code?: string | null;
    rental_id?: number | null;
    accessory_links?: AccessoryLink[];
}

export default function ViewReservationCard(props: ViewReservationCardProps) {
    const {
        id,
        equipment,
        start_date,
        end_date,
        status,
        onEdit,
        onCancel,
        onRemoveItem,
        onRepeat,
        cancelDisabled,
        total_cost,
        discount_amount,
        promo_code,
        rental_id,
        accessory_links,
    } = props;

    const navigate = useNavigate();
    const location = useLocation();

    const start = start_date ? new Date(start_date) : null;
    const end = end_date ? new Date(end_date) : null;

    const now = new Date();
    const isPast = !!end && end < now;

    const msPerDay = 1000 * 60 * 60 * 24;
    const daysUntilStart = start ? Math.ceil((start.getTime() - now.getTime()) / msPerDay) : null;
    const daysUntilEnd = end ? Math.floor((end.getTime() - now.getTime()) / msPerDay) : null;

    const isProtected = !isPast && daysUntilEnd !== null && daysUntilEnd < 2;
    const isActionable = status === 'active';
    const canBeRepeated = status === 'fulfilled' || status === 'cancelled';
    const cardColor = RESERVATION_CARD_STYLES[status] || RESERVATION_CARD_STYLES.default;

    const getStatusInfo = () => {
        if (isPast) {
            return {
                showMessage: false,
                message: "",
                className: ""
            };
        }

        if (daysUntilStart !== null) {
            if (daysUntilStart <= 0) {
                return {
                    showMessage: true,
                    message: "Ğ ĞµĞ·ĞµÑ€Ğ² ÑƒĞ¶Ğµ Ğ½Ğ°Ñ‡Ğ°Ğ»ÑÑ",
                    className: "text-green-600"
                };
            } else if (daysUntilStart <= 3) {
                return {
                    showMessage: true,
                    message: `Ğ”Ğ¾ Ğ½Ğ°Ñ‡Ğ°Ğ»Ğ° Ñ€ĞµĞ·ĞµÑ€Ğ²Ğ°: ${daysUntilStart} Ğ´Ğ½.`,
                    className: "text-orange-600 font-medium"
                };
            } else {
                return {
                    showMessage: true,
                    message: `Ğ”Ğ¾ Ğ½Ğ°Ñ‡Ğ°Ğ»Ğ° Ñ€ĞµĞ·ĞµÑ€Ğ²Ğ°: ${daysUntilStart} Ğ´Ğ½.`,
                    className: "text-gray-600"
                };
            }
        }

        return {
            showMessage: false,
            message: "",
            className: ""
        };
    };

    const statusInfo = getStatusInfo();

    const handleRentalClick = () => {
        if (rental_id) {
            navigate("/reservations/my", {
                state: {
                    highlightRentalId: rental_id,
                    from: "reservation"
                }
            });
        }
    };

    return (
        <Card className={`w-full px-5 py-4 rounded-2xl border shadow-sm hover:shadow-md transition-all ${cardColor}`}>
            <div className="space-y-3">
                <div className="flex justify-between items-center">
                    <div className="text-base font-semibold text-sky-700">Ğ ĞµĞ·ĞµÑ€Ğ² #{id}</div>
                    <div className="flex items-center gap-2">
                        <ReservationStatusBadge status={status} />
                        {rental_id && status === 'fulfilled' && (
                            <Button
                                variant="outline"
                                size="sm"
                                onClick={handleRentalClick}
                                className="text-orange-600 hover:text-orange-700 hover:bg-orange-50 border-orange-200"
                            >
                                <ExternalLink className="w-3 h-3 mr-1" />
                                ĞÑ€ĞµĞ½Ğ´Ğ° #{rental_id}
                            </Button>
                        )}
                    </div>
                </div>

                <div className="flex flex-col sm:flex-row sm:justify-between sm:items-center gap-2 pt-2 border-t border-dashed">
                    {start && end ? (
                        <div className="flex items-center gap-2 text-sm">
                            <CalendarRange className="w-4 h-4 text-gray-500 flex-shrink-0" />
                            <span>{formatDateEuropean(start)} â€” {formatDateEuropean(end)}</span>
                        </div>
                    ) : (
                        <p className="text-red-600 text-sm">ĞÑˆĞ¸Ğ±ĞºĞ° Ğ² Ğ´Ğ°Ñ‚Ğµ Ñ€ĞµĞ·ĞµÑ€Ğ²Ğ°</p>
                    )}

                    <FinancialInfoBlock
                        totalCost={total_cost}
                        discountAmount={discount_amount}
                        promoCode={promo_code}
                        variant="default"
                        className="justify-start sm:justify-end"
                    />
                </div>

                {statusInfo.showMessage && status === 'active' && (
                    <div className="flex items-center gap-2 text-sm">
                        <div className={`px-2 py-1 rounded-md text-xs ${statusInfo.className} bg-opacity-10`}>
                            {statusInfo.message}
                        </div>
                    </div>
                )}

                {/* Ğ¡Ğ¾ÑÑ‚Ğ°Ğ² Ñ€ĞµĞ·ĞµÑ€Ğ²Ğ° */}
                <EquipmentWithAccessoriesList
                    equipment={equipment.map(item => ({ id: item.id, name: item.label }))}
                    accessoryLinks={accessory_links || []}
                    title="Ğ¡Ğ¾ÑÑ‚Ğ°Ğ² Ñ€ĞµĞ·ĞµÑ€Ğ²Ğ°:"
                    showTitle={true}
                    className="pt-2 border-t"
                    showRemoveButton={isActionable && !!onRemoveItem}
                    onRemoveItem={onRemoveItem}
                    isRemoveDisabled={isProtected}
                    removeButtonTitle={isProtected ? "Ğ£Ğ´Ğ°Ğ»ĞµĞ½Ğ¸Ğµ Ñ‡ĞµÑ€ĞµĞ· Ğ¼ĞµĞ½ĞµĞ´Ğ¶ĞµÑ€Ğ°" : "Ğ£Ğ´Ğ°Ğ»Ğ¸Ñ‚ÑŒ Ğ¸Ğ· Ñ€ĞµĞ·ĞµÑ€Ğ²Ğ°"}
                />

                {canBeRepeated && onRepeat ? (
                    <div className="flex justify-end pt-2 border-t border-gray-200">
                        <Button variant="outline" size="sm" onClick={onRepeat}>
                            <RotateCcw className="w-4 h-4 mr-1" />
                            ĞŸĞ¾Ğ²Ñ‚Ğ¾Ñ€Ğ¸Ñ‚ÑŒ Ñ€ĞµĞ·ĞµÑ€Ğ²
                        </Button>
                    </div>
                ) : (
                    <div className="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-2 pt-2 border-t border-gray-200">
                        {isProtected ? (
                            <div className="flex flex-col gap-2">
                                <p className="text-sm font-medium text-rose-700">
                                    ĞÑ‚Ğ¼ĞµĞ½Ğ° Ğ¸ Ñ€ĞµĞ´Ğ°ĞºÑ‚Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ Ñ‚Ğ¾Ğ»ÑŒĞºĞ¾ Ñ‡ĞµÑ€ĞµĞ· Ğ¼ĞµĞ½ĞµĞ´Ğ¶ĞµÑ€Ğ°
                                </p>
                                <Button
                                    variant="outline"
                                    size="sm"
                                    onClick={() => navigate("/contacts", { state: { from: location.pathname } })}
                                >
                                    ĞĞ°Ğ¿Ğ¸ÑĞ°Ñ‚ÑŒ Ğ¼ĞµĞ½ĞµĞ´Ğ¶ĞµÑ€Ñƒ
                                </Button>
                            </div>
                        ) : (
                            <div className="text-sm text-gray-600">
                                {daysUntilEnd !== null && daysUntilEnd >= 0 && (
                                    <span>Ğ”Ğ¾ Ğ¾ĞºĞ¾Ğ½Ñ‡Ğ°Ğ½Ğ¸Ñ: {daysUntilEnd} Ğ´Ğ½.</span>
                                )}
                            </div>
                        )}

                        <div className="flex gap-2 justify-end w-full sm:w-auto">
                            {isActionable && onEdit && !isProtected && (
                                <Button variant="secondary" size="sm" onClick={onEdit}>
                                    <Edit2 className="w-4 h-4 mr-1" />
                                    Ğ ĞµĞ´Ğ°ĞºÑ‚Ğ¸Ñ€Ğ¾Ğ²Ğ°Ñ‚ÑŒ
                                </Button>
                            )}
                            {isActionable && onCancel && !isProtected && (
                                <Button
                                    variant="destructive"
                                    size="sm"
                                    disabled={cancelDisabled}
                                    onClick={onCancel}
                                >
                                    <Trash2 className="w-4 h-4 mr-1" />
                                    {cancelDisabled ? "ĞÑ‚Ğ¼ĞµĞ½Ğ°..." : "ĞÑ‚Ğ¼ĞµĞ½Ğ¸Ñ‚ÑŒ"}
                                </Button>
                            )}
                        </div>
                    </div>
                )}
            </div>
        </Card>
    );
}

```


## <a name="rentalappmainsrccomponentssessionUserSessiontsx"></a>`rental-app-main/src/components/session/UserSession.tsx`

```tsx
// path: rental-app-main/src/components/session/UserSession.tsx

// src/components/session/UserSession.tsx

import AuthForm from "@/components/AuthForm";
import UserInfoBlock from "@/components/UserInfoBlock";
import { useCurrentUser } from "@/hooks/useProfile";

/**
 * ĞšĞ¾Ğ¼Ğ¿Ğ¾Ğ½ĞµĞ½Ñ‚ Ğ´Ğ»Ñ ÑƒĞ¿Ñ€Ğ°Ğ²Ğ»ĞµĞ½Ğ¸Ñ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ÑŒÑĞºĞ¾Ğ¹ ÑĞµÑÑĞ¸ĞµĞ¹.
 * ĞÑ‚Ğ¾Ğ±Ñ€Ğ°Ğ¶Ğ°ĞµÑ‚ Ñ„Ğ¾Ñ€Ğ¼Ñƒ Ğ°Ğ²Ñ‚Ğ¾Ñ€Ğ¸Ğ·Ğ°Ñ†Ğ¸Ğ¸ Ğ´Ğ»Ñ Ğ³Ğ¾ÑÑ‚ĞµĞ¹ Ğ¸Ğ»Ğ¸ Ğ¸Ğ½Ñ„Ğ¾Ñ€Ğ¼Ğ°Ñ†Ğ¸Ñ Ğ¾ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ğµ Ğ´Ğ»Ñ Ğ°Ğ²Ñ‚Ğ¾Ñ€Ğ¸Ğ·Ğ¾Ğ²Ğ°Ğ½Ğ½Ñ‹Ñ….
 */
export default function UserSession() {
    const { data: user } = useCurrentUser();

    return user ? <UserInfoBlock showExtraLinks={true} /> : <AuthForm />;
}


```


## <a name="rentalappmainsrccomponentssharedEquipmentWithAccessoriesListtsx"></a>`rental-app-main/src/components/shared/EquipmentWithAccessoriesList.tsx`

```tsx
// path: rental-app-main/src/components/shared/EquipmentWithAccessoriesList.tsx

// src/components/shared/EquipmentWithAccessoriesList.tsx

import { useState } from "react";
import { Paperclip, ChevronDown, MinusCircle } from "lucide-react";
import { Button } from "@/components/ui/button";
import type { AccessoryLink } from "@/types/reservation";

interface EquipmentItem {
    id: number;
    name: string;
}

interface EquipmentWithAccessoriesListProps {
    equipment: EquipmentItem[];
    accessoryLinks?: AccessoryLink[];
    title?: string;
    showTitle?: boolean;
    className?: string;
    showRemoveButton?: boolean;
    onRemoveItem?: (equipmentId: number) => void;
    isRemoveDisabled?: boolean;
    removeButtonTitle?: string;
}

export default function EquipmentWithAccessoriesList({
    equipment,
    accessoryLinks = [],
    title = "Ğ¡Ğ¾ÑÑ‚Ğ°Ğ² Ñ€ĞµĞ·ĞµÑ€Ğ²Ğ°:",
    showTitle = true,
    className = "",
    showRemoveButton = false,
    onRemoveItem,
    isRemoveDisabled = false,
    removeButtonTitle = "Ğ£Ğ´Ğ°Ğ»Ğ¸Ñ‚ÑŒ Ğ¸Ğ· Ñ€ĞµĞ·ĞµÑ€Ğ²Ğ°"
}: EquipmentWithAccessoriesListProps) {
    const [expandedAccessories, setExpandedAccessories] = useState<Record<number, boolean>>({});

    // Ğ›Ğ¾Ğ³Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ Ğ´Ğ»Ñ Ğ¾Ñ‚Ğ»Ğ°Ğ´ĞºĞ¸ Ğ¾Ñ‚ÑÑƒÑ‚ÑÑ‚Ğ²ÑƒÑÑ‰Ğ¸Ñ… Ğ°ĞºÑĞµÑÑÑƒĞ°Ñ€Ğ¾Ğ²
    const missingAccessories = accessoryLinks.filter(link => !link.accessory);
    if (missingAccessories.length > 0) {
        console.warn('ĞĞ±Ğ½Ğ°Ñ€ÑƒĞ¶ĞµĞ½Ñ‹ AccessoryLink Ñ Ğ¾Ñ‚ÑÑƒÑ‚ÑÑ‚Ğ²ÑƒÑÑ‰Ğ¸Ğ¼Ğ¸ accessory:', missingAccessories);
    }

    const toggleAccessories = (equipmentId: number) => {
        setExpandedAccessories(prev => ({
            ...prev,
            [equipmentId]: !prev[equipmentId]
        }));
    };

    if (equipment.length === 0) {
        return (
            <div className={`space-y-2 pt-2 border-t ${className}`}>
                {showTitle && (
                    <h4 className="font-medium text-sm text-gray-800">{title}</h4>
                )}
                <div className="text-sm text-gray-500 italic">ĞĞµÑ‚ Ğ¾Ğ±Ğ¾Ñ€ÑƒĞ´Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ Ğ² Ñ€ĞµĞ·ĞµÑ€Ğ²Ğµ</div>
            </div>
        );
    }

    return (
        <div className={`space-y-2 pt-2 border-t ${className}`}>
            {showTitle && (
                <h4 className="font-medium text-sm text-gray-800">{title}</h4>
            )}
            <div className="space-y-2">
                {equipment.map((item) => {
                    // Ğ¤Ğ¸Ğ»ÑŒÑ‚Ñ€ÑƒĞµĞ¼ Ğ°ĞºÑĞµÑÑÑƒĞ°Ñ€Ñ‹, Ñ‡Ñ‚Ğ¾Ğ±Ñ‹ ÑƒĞ±ĞµĞ´Ğ¸Ñ‚ÑŒÑÑ, Ñ‡Ñ‚Ğ¾ Ğ´Ğ°Ğ½Ğ½Ñ‹Ğµ Ğ¾ Ğ½Ğ¸Ñ… ÑÑƒÑ‰ĞµÑÑ‚Ğ²ÑƒÑÑ‚
                    const accessoriesForItem = accessoryLinks.filter(link => 
                        link.equipment_id === item.id && link.accessory
                    );
                    
                    return (
                        <div key={item.id} className="text-sm text-gray-700 bg-gray-50/70 p-2 rounded-md border">
                            <div className="flex justify-between items-center">
                                <p>â€¢ {item.name}</p>
                                {showRemoveButton && onRemoveItem && (
                                    <Button
                                        variant="ghost"
                                        size="icon"
                                        onClick={() => onRemoveItem(item.id)}
                                        className={`hover:text-rose-700 ${
                                            isRemoveDisabled ? "text-gray-400 cursor-not-allowed" : "text-rose-500"
                                        }`}
                                        title={removeButtonTitle}
                                        aria-label="Ğ£Ğ´Ğ°Ğ»Ğ¸Ñ‚ÑŒ Ğ¾Ğ±Ğ¾Ñ€ÑƒĞ´Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ"
                                        disabled={isRemoveDisabled}
                                    >
                                        <MinusCircle className="w-4 h-4" />
                                    </Button>
                                )}
                            </div>
                            {accessoriesForItem.length > 0 && (
                                <div className="mt-2 pl-4">
                                    <button 
                                        onClick={() => toggleAccessories(item.id)} 
                                        className="flex items-center text-xs text-sky-700 hover:underline font-medium"
                                    >
                                        <Paperclip className="w-3 h-3 mr-1" />
                                        ĞĞºÑĞµÑÑÑƒĞ°Ñ€Ñ‹ ({accessoriesForItem.length})
                                        <ChevronDown className={`w-4 h-4 ml-1 transition-transform ${expandedAccessories[item.id] ? 'rotate-180' : ''}`} />
                                    </button>
                                    {expandedAccessories[item.id] && (
                                        <ul className="list-disc list-inside text-xs text-gray-600 mt-1 pl-2 animate-in fade-in duration-200">
                                            {accessoriesForItem.map(link => {
                                                // Ğ”Ğ¾Ğ¿Ğ¾Ğ»Ğ½Ğ¸Ñ‚ĞµĞ»ÑŒĞ½Ğ°Ñ Ğ·Ğ°Ñ‰Ğ¸Ñ‚Ğ° Ğ½Ğ° ÑĞ»ÑƒÑ‡Ğ°Ğ¹, ĞµÑĞ»Ğ¸ accessory ÑÑ‚Ğ°Ğ» null Ğ¿Ğ¾ÑĞ»Ğµ Ñ„Ğ¸Ğ»ÑŒÑ‚Ñ€Ğ°Ñ†Ğ¸Ğ¸
                                                if (!link.accessory) {
                                                    console.warn('ĞĞ±Ğ½Ğ°Ñ€ÑƒĞ¶ĞµĞ½ AccessoryLink Ñ Ğ¾Ñ‚ÑÑƒÑ‚ÑÑ‚Ğ²ÑƒÑÑ‰Ğ¸Ğ¼ accessory:', link);
                                                    return null;
                                                }
                                                return (
                                                    <li key={link.accessory.id}>{link.accessory.name}</li>
                                                );
                                            })}
                                        </ul>
                                    )}
                                </div>
                            )}
                        </div>
                    );
                })}
            </div>
        </div>
    );
}


```


## <a name="rentalappmainsrccomponentssharedFinancialInfoBlocktsx"></a>`rental-app-main/src/components/shared/FinancialInfoBlock.tsx`

```tsx
// path: rental-app-main/src/components/shared/FinancialInfoBlock.tsx

// src/components/shared/FinancialInfoBlock.tsx

import { Tag, Receipt, ReceiptText } from "lucide-react";
import { cn } from "@/lib/utils";

interface FinancialInfoBlockProps {
    totalCost?: number | null;
    discountAmount?: number | null;
    promoCode?: string | null;
    variant?: 'default' | 'compact' | 'admin';
    className?: string;
}

export default function FinancialInfoBlock({
    totalCost,
    discountAmount,
    promoCode,
    variant = 'default',
    className
}: FinancialInfoBlockProps) {
    // ĞĞ´Ğ¼Ğ¸Ğ½ÑĞºĞ¸Ğ¹ ÑÑ‚Ğ¸Ğ»ÑŒ - ĞºĞ°Ğº Ğ² AdminRentalCard
    if (variant === 'admin') {
        return (
            <div className={cn("flex-shrink-0 md:w-64 bg-slate-50 p-3 rounded-lg border space-y-2", className)}>
                <h4 className="font-semibold text-sm text-slate-800 flex items-center gap-2">
                    <ReceiptText className="w-4 h-4"/>Ğ¤Ğ¸Ğ½Ğ°Ğ½ÑÑ‹
                </h4>
                <div className="text-xs space-y-1.5 text-slate-700">
                    <div className="flex justify-between">
                        <span>ĞĞ±Ñ‰Ğ°Ñ ÑÑ‚Ğ¾Ğ¸Ğ¼Ğ¾ÑÑ‚ÑŒ:</span> 
                        <span className="font-medium">{totalCost?.toLocaleString('ru-RU') ?? 'Ğ/Ğ”'} â‚½</span>
                    </div>
                    {promoCode && (
                        <div className="flex justify-between">
                            <span>ĞŸÑ€Ğ¾Ğ¼Ğ¾ĞºĞ¾Ğ´:</span> 
                            <span className="font-medium text-purple-600">{promoCode}</span>
                        </div>
                    )}
                    {(discountAmount ?? 0) > 0 && (
                        <div className="flex justify-between">
                            <span>Ğ¡ĞºĞ¸Ğ´ĞºĞ°:</span> 
                            <span className="font-medium text-green-600">-{discountAmount?.toLocaleString('ru-RU')} â‚½</span>
                        </div>
                    )}
                </div>
            </div>
        );
    }

    // ĞšĞ¾Ğ¼Ğ¿Ğ°ĞºÑ‚Ğ½Ñ‹Ğ¹ Ğ¸ ÑÑ‚Ğ°Ğ½Ğ´Ğ°Ñ€Ñ‚Ğ½Ñ‹Ğ¹ ÑÑ‚Ğ¸Ğ»Ğ¸ (Ğ¾Ğ±ÑŠĞµĞ´Ğ¸Ğ½ĞµĞ½Ñ‹ Ğ´Ğ»Ñ ÑƒÑÑ‚Ñ€Ğ°Ğ½ĞµĞ½Ğ¸Ñ Ğ´ÑƒĞ±Ğ»Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ)
    const isCompact = variant === 'compact';
    const containerClasses = isCompact 
        ? "flex flex-wrap items-center justify-start gap-x-4 gap-y-1 text-sm pt-2 border-t border-dashed"
        : "flex flex-wrap items-center justify-start gap-x-4 gap-y-1 text-sm";
    
    return (
        <div className={cn(containerClasses, className)}>
            {promoCode && (
                <div className="flex items-center gap-1.5 text-xs text-purple-600 self-end">
                    <Tag className="w-3 h-3" />
                    <span>{promoCode}</span>
                </div>
            )}
            <div className="text-right">
                <div className="flex items-center gap-1.5 font-semibold">
                    <Receipt className="w-4 h-4 text-gray-500" />
                    Ğ˜Ñ‚Ğ¾Ğ³:
                    <span className="text-gray-800">
                        {totalCost?.toLocaleString('ru-RU') ?? 'Ğ/Ğ”'} â‚½
                    </span>
                </div>
                {(discountAmount ?? 0) > 0 && (
                    <div className="text-xs text-green-600 mt-0.5">
                        ÑĞ¾ ÑĞºĞ¸Ğ´ĞºĞ¾Ğ¹ Ğ² {discountAmount?.toLocaleString('ru-RU')} â‚½
                    </div>
                )}
            </div>
        </div>
    );
}


```


## <a name="rentalappmainsrccomponentssharedFinancialSummaryBlocktsx"></a>`rental-app-main/src/components/shared/FinancialSummaryBlock.tsx`

```tsx
// path: rental-app-main/src/components/shared/FinancialSummaryBlock.tsx

// src/components/shared/FinancialSummaryBlock.tsx

import { Button } from "@/components/ui/button";
import PromoCodeInput from "@/components/PromoCodeInput";
import { ReceiptText, Loader2, AlertTriangle } from "lucide-react";
import { cn } from "@/lib/utils";
import type { PriceDetails } from "@/hooks/reservation/usePriceCalculator";

interface FinancialSummaryBlockProps {
    // Ğ”Ğ°Ğ½Ğ½Ñ‹Ğµ Ğ¾ ÑÑ‚Ğ¾Ğ¸Ğ¼Ğ¾ÑÑ‚Ğ¸
    priceDetails?: PriceDetails | null;
    
    // Ğ”Ğ¾Ğ¿Ğ¾Ğ»Ğ½Ğ¸Ñ‚ĞµĞ»ÑŒĞ½Ñ‹Ğµ Ñ„Ğ¸Ğ½Ğ°Ğ½ÑĞ¾Ğ²Ñ‹Ğµ Ğ´Ğ°Ğ½Ğ½Ñ‹Ğµ
    accessoriesDailyTotal?: number;
    
    // ĞŸÑ€Ğ¾Ğ¼Ğ¾ĞºĞ¾Ğ´
    promoCode: string;
    setPromoCode: (code: string) => void;
    applyPromoCode: () => void;
    removePromoCode?: () => void;
    promoCodeMessage?: string;
    
    // Ğ¡Ğ¾ÑÑ‚Ğ¾ÑĞ½Ğ¸Ñ Ğ·Ğ°Ğ³Ñ€ÑƒĞ·ĞºĞ¸
    isLoading?: boolean;
    isApplyingPromoCode?: boolean;
    isSubmitting?: boolean;
    
    // Ğ’Ğ°Ğ»Ğ¸Ğ´Ğ°Ñ†Ğ¸Ñ
    isFormValid?: boolean;
    hasConflicts?: boolean;
    
    // Ğ”ĞµĞ¹ÑÑ‚Ğ²Ğ¸Ñ
    onCancel?: () => void;
    onAddMore?: () => void;
    onSubmit?: () => void;
    
    // Ğ¡Ñ‚Ğ¸Ğ»Ğ¸Ğ·Ğ°Ñ†Ğ¸Ñ
    variant?: 'default' | 'compact' | 'admin' | 'inline';
    className?: string;
    showActions?: boolean;
}

/**
 * Ğ£Ğ½Ğ¸Ğ²ĞµÑ€ÑĞ°Ğ»ÑŒĞ½Ñ‹Ğ¹ ĞºĞ¾Ğ¼Ğ¿Ğ¾Ğ½ĞµĞ½Ñ‚ Ğ´Ğ»Ñ Ğ¾Ñ‚Ğ¾Ğ±Ñ€Ğ°Ğ¶ĞµĞ½Ğ¸Ñ Ñ„Ğ¸Ğ½Ğ°Ğ½ÑĞ¾Ğ²Ğ¾Ğ¹ ÑĞ²Ğ¾Ğ´ĞºĞ¸ Ñ€ĞµĞ·ĞµÑ€Ğ²Ğ°.
 * Ğ—Ğ°Ğ¼ĞµĞ½ÑĞµÑ‚ ReservationSummary, AdminReservationSummary Ğ¸ ReservationFinancialSummary.
 */
export default function FinancialSummaryBlock({
    priceDetails,
    accessoriesDailyTotal = 0,
    promoCode,
    setPromoCode,
    applyPromoCode,
    removePromoCode,
    promoCodeMessage = "",
    isLoading = false,
    isApplyingPromoCode = false,
    isSubmitting = false,
    isFormValid = true,
    hasConflicts = false,
    onCancel,
    onAddMore,
    onSubmit,
    variant = 'default',
    className,
    showActions = true
}: FinancialSummaryBlockProps) {
    
    // Ğ˜Ğ·Ğ²Ğ»ĞµĞºĞ°ĞµĞ¼ Ğ´Ğ°Ğ½Ğ½Ñ‹Ğµ Ğ¸Ğ· priceDetails
    const dayCount = priceDetails?.day_count ?? 0;
    const fullTotal = priceDetails?.full_total ?? 0;
    const finalTotal = priceDetails?.final_total ?? 0;
    const discountAmount = priceDetails?.discount_amount ?? 0;
    const durationDiscountPercentage = priceDetails?.duration_discount_percentage ?? 0;
    const promoDiscountPercentage = priceDetails?.promo_discount_percentage ?? 0;
    const totalDiscountPercentage = durationDiscountPercentage + promoDiscountPercentage;
    const apiPromoCodeMessage = priceDetails?.promo_code_message ?? "";
    
    // Ğ˜ÑĞ¿Ğ¾Ğ»ÑŒĞ·ÑƒĞµĞ¼ ÑĞ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ğµ Ğ¸Ğ· API Ğ¸Ğ»Ğ¸ Ğ¿ĞµÑ€ĞµĞ´Ğ°Ğ½Ğ½Ğ¾Ğµ
    const displayPromoCodeMessage = apiPromoCodeMessage || promoCodeMessage;
    
    // ĞšĞ¾Ğ¼Ğ¿Ğ°ĞºÑ‚Ğ½Ñ‹Ğ¹ Ğ²Ğ°Ñ€Ğ¸Ğ°Ğ½Ñ‚ Ğ´Ğ»Ñ ĞºĞ°Ñ€Ñ‚Ğ¾Ñ‡ĞµĞº
    if (variant === 'compact') {
        return (
            <div className={cn("flex flex-wrap items-center justify-start gap-x-4 gap-y-1 text-sm", className)}>
                {promoCode && (
                    <div className="flex items-center gap-1.5 text-xs text-purple-600 self-end">
                        <span className="px-1.5 py-0.5 bg-purple-100 rounded text-xs">
                            {promoCode}
                        </span>
                    </div>
                )}
                <div className="text-right">
                    <div className="flex items-center gap-1.5 font-semibold">
                        <ReceiptText className="w-4 h-4 text-gray-500" />
                        Ğ˜Ñ‚Ğ¾Ğ³:
                        <span className="text-gray-800">
                            {finalTotal.toLocaleString('ru-RU')} â‚½
                        </span>
                    </div>
                    {discountAmount > 0 && (
                        <div className="text-xs text-green-600 mt-0.5">
                            ÑĞ¾ ÑĞºĞ¸Ğ´ĞºĞ¾Ğ¹ Ğ² {discountAmount.toLocaleString('ru-RU')} â‚½
                        </div>
                    )}
                </div>
            </div>
        );
    }
    
    // ĞĞ´Ğ¼Ğ¸Ğ½ÑĞºĞ¸Ğ¹ Ğ²Ğ°Ñ€Ğ¸Ğ°Ğ½Ñ‚
    if (variant === 'admin') {
        return (
            <div className={cn("flex-1 space-y-2 text-sm", className)}>
                <div className="grid grid-cols-2 gap-x-4 gap-y-1">
                    <span className="text-gray-600">Ğ”Ğ½ĞµĞ¹ Ğ°Ñ€ĞµĞ½Ğ´Ñ‹:</span>
                    <span className="font-medium text-right">{dayCount}</span>

                    <span className="text-gray-600">Ğ¡ÑƒĞ¼Ğ¼Ğ° Ğ±ĞµĞ· ÑĞºĞ¸Ğ´ĞºĞ¸:</span>
                    <span className="font-medium text-right">{fullTotal.toLocaleString('ru-RU')} â‚½</span>

                    {totalDiscountPercentage > 0 && (
                        <>
                            <span className="text-green-600">Ğ¡ĞºĞ¸Ğ´ĞºĞ° ({totalDiscountPercentage}%):</span>
                            <span className="font-medium text-green-600 text-right">- {discountAmount.toLocaleString('ru-RU')} â‚½</span>
                        </>
                    )}

                    <span className="font-semibold text-base mt-1">Ğ˜Ñ‚Ğ¾Ğ³Ğ¾:</span>
                    <span className="font-bold text-base text-right mt-1">{finalTotal.toLocaleString('ru-RU')} â‚½</span>
                </div>

                <div className="pt-2">
                    <PromoCodeInput
                        promoCode={promoCode}
                        setPromoCode={setPromoCode}
                        applyPromoCode={applyPromoCode}
                        promoCodeMessage={displayPromoCodeMessage}
                        disabled={isSubmitting || isLoading}
                        isLoading={isApplyingPromoCode}
                    />
                </div>

                {isLoading && (
                    <div className="flex items-center gap-2 text-xs text-gray-500 pt-1">
                        <Loader2 className="h-3 w-3 animate-spin" />
                        <span>ĞŸÑ€Ğ¾Ğ²ĞµÑ€ĞºĞ° Ğ´Ğ¾ÑÑ‚ÑƒĞ¿Ğ½Ğ¾ÑÑ‚Ğ¸...</span>
                    </div>
                )}
                {hasConflicts && (
                    <div className="flex items-center gap-2 text-xs text-red-600 font-medium pt-1">
                        <AlertTriangle className="h-4 w-4" />
                        <span>ĞĞ±Ğ½Ğ°Ñ€ÑƒĞ¶ĞµĞ½Ñ‹ ĞºĞ¾Ğ½Ñ„Ğ»Ğ¸ĞºÑ‚Ñ‹ Ğ² Ğ²Ñ‹Ğ±Ğ¾Ñ€Ğµ!</span>
                    </div>
                )}
            </div>
        );
    }
    
    // Inline Ğ²Ğ°Ñ€Ğ¸Ğ°Ğ½Ñ‚ Ğ´Ğ»Ñ Ñ€ĞµĞ´Ğ°ĞºÑ‚Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ
    if (variant === 'inline') {
        return (
            <div className={cn("space-y-3", className)}>
                <div className="flex items-center gap-2 text-sm font-medium text-gray-700">
                    <ReceiptText className="w-4 h-4" />
                    Ğ¤Ğ¸Ğ½Ğ°Ğ½ÑĞ¾Ğ²Ğ°Ñ ÑĞ²Ğ¾Ğ´ĞºĞ°
                </div>
                
                {isLoading ? (
                    <div className="text-center py-4 text-gray-500 flex items-center justify-center gap-2">
                        <Loader2 className="h-4 w-4 animate-spin" />
                        Ğ Ğ°ÑÑ‡ĞµÑ‚ ÑÑ‚Ğ¾Ğ¸Ğ¼Ğ¾ÑÑ‚Ğ¸...
                    </div>
                ) : (
                    <div className="text-sm text-gray-700 space-y-2">
                        <div className="flex justify-between">
                            <span>ĞÑ€ĞµĞ½Ğ´Ğ° Ğ¾Ğ±Ğ¾Ñ€ÑƒĞ´Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ ({dayCount} Ğ´Ğ½.):</span>
                            <span>{fullTotal.toLocaleString('ru-RU')} â‚½</span>
                        </div>
                        
                        {accessoriesDailyTotal > 0 && (
                            <div className="flex justify-between text-gray-600 pl-4">
                                <span>- Ğ² Ñ‚.Ñ‡. Ğ°ĞºÑĞµÑÑÑƒĞ°Ñ€Ñ‹ ({accessoriesDailyTotal.toLocaleString('ru-RU')} â‚½/Ğ´ĞµĞ½ÑŒ):</span>
                                <span>{(accessoriesDailyTotal * dayCount).toLocaleString('ru-RU')} â‚½</span>
                            </div>
                        )}
                        
                        <div className="flex justify-between pt-2 border-t border-dashed">
                            <span>Ğ¡ÑƒĞ¼Ğ¼Ğ° Ğ±ĞµĞ· ÑĞºĞ¸Ğ´ĞºĞ¸:</span>
                            <strong>{fullTotal.toLocaleString('ru-RU')} â‚½</strong>
                        </div>
                        
                        {totalDiscountPercentage > 0 && (
                            <div className="flex justify-between text-green-600">
                                <span>Ğ¡ĞºĞ¸Ğ´ĞºĞ° ({totalDiscountPercentage}%):</span>
                                <strong>- {discountAmount.toLocaleString('ru-RU', { minimumFractionDigits: 2, maximumFractionDigits: 2 })} â‚½</strong>
                            </div>
                        )}
                        
                        <div className="flex justify-between text-base font-bold pt-2 border-t mt-2">
                            <span>Ğš Ğ¾Ğ¿Ğ»Ğ°Ñ‚Ğµ:</span>
                            <span className="text-sky-700 ml-2">{finalTotal.toLocaleString('ru-RU', { minimumFractionDigits: 2, maximumFractionDigits: 2 })} â‚½</span>
                        </div>
                    </div>
                )}
                
                <div className="pt-2">
                    <PromoCodeInput
                        promoCode={promoCode}
                        setPromoCode={setPromoCode}
                        applyPromoCode={applyPromoCode}
                        removePromoCode={removePromoCode}
                        promoCodeMessage={displayPromoCodeMessage}
                        disabled={isSubmitting || isLoading}
                        isLoading={isApplyingPromoCode}
                    />
                </div>
            </div>
        );
    }
    
    // Ğ¡Ñ‚Ğ°Ğ½Ğ´Ğ°Ñ€Ñ‚Ğ½Ñ‹Ğ¹ Ğ²Ğ°Ñ€Ğ¸Ğ°Ğ½Ñ‚ (ĞºĞ°Ğº ReservationSummary)
    return (
        <div className={cn("mt-6 p-4 border rounded-lg bg-white shadow-sm space-y-4", className)}>
            <div className="flex items-center gap-2 text-lg font-semibold text-gray-800">
                <ReceiptText className="w-6 h-6 text-sky-600" />
                Ğ˜Ñ‚Ğ¾Ğ³Ğ¾Ğ²Ñ‹Ğ¹ Ñ€Ğ°ÑÑ‡ĞµÑ‚
            </div>

            <div className="border-t pt-4">
                <PromoCodeInput
                    promoCode={promoCode}
                    setPromoCode={setPromoCode}
                    applyPromoCode={applyPromoCode}
                    removePromoCode={removePromoCode}
                    promoCodeMessage={displayPromoCodeMessage}
                    disabled={isSubmitting || isLoading}
                    isLoading={isApplyingPromoCode}
                />
            </div>

            {isLoading ? (
                <div className="text-center py-4 text-gray-500 flex items-center justify-center gap-2">
                    <Loader2 className="h-4 w-4 animate-spin" />
                    Ğ Ğ°ÑÑ‡ĞµÑ‚ ÑÑ‚Ğ¾Ğ¸Ğ¼Ğ¾ÑÑ‚Ğ¸...
                </div>
            ) : (
                <div className="text-sm text-gray-700 space-y-2 border-t pt-4">
                    <div className="flex justify-between">
                        <span>ĞÑ€ĞµĞ½Ğ´Ğ° Ğ¾Ğ±Ğ¾Ñ€ÑƒĞ´Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ ({dayCount} Ğ´Ğ½.):</span>
                    </div>
                    {accessoriesDailyTotal > 0 && (
                        <div className="flex justify-between text-gray-600 pl-4">
                            <span>- Ğ² Ñ‚.Ñ‡. Ğ°ĞºÑĞµÑÑÑƒĞ°Ñ€Ñ‹ ({accessoriesDailyTotal.toLocaleString('ru-RU')} â‚½/Ğ´ĞµĞ½ÑŒ):</span>
                            <span>{(accessoriesDailyTotal * dayCount).toLocaleString('ru-RU')} â‚½</span>
                        </div>
                    )}
                    <div className="flex justify-between pt-2 border-t border-dashed">
                        <span>Ğ¡ÑƒĞ¼Ğ¼Ğ° Ğ±ĞµĞ· ÑĞºĞ¸Ğ´ĞºĞ¸:</span>
                        <strong>{fullTotal.toLocaleString('ru-RU')} â‚½</strong>
                    </div>
                    {totalDiscountPercentage > 0 && (
                        <div className="flex justify-between text-green-600">
                            <span>Ğ¡ĞºĞ¸Ğ´ĞºĞ° ({totalDiscountPercentage}%):</span>
                            <strong>- {discountAmount.toLocaleString('ru-RU', { minimumFractionDigits: 2, maximumFractionDigits: 2 })} â‚½</strong>
                        </div>
                    )}
                    <div className="flex justify-between text-base font-bold pt-2 border-t mt-2">
                        <span>Ğš Ğ¾Ğ¿Ğ»Ğ°Ñ‚Ğµ:</span>
                        <span className="text-sky-700 ml-2">{finalTotal.toLocaleString('ru-RU', { minimumFractionDigits: 2, maximumFractionDigits: 2 })} â‚½</span>
                    </div>
                </div>
            )}

            {showActions && (onCancel || onAddMore || onSubmit) && (
                <div className="flex flex-col sm:flex-row justify-end items-center pt-3 gap-3">
                    {onCancel && (
                        <Button variant="ghost" className="text-red-600 hover:bg-red-50 w-full sm:w-auto" onClick={onCancel}>
                            ĞÑ‚Ğ¼ĞµĞ½Ğ¸Ñ‚ÑŒ Ğ¾Ñ„Ğ¾Ñ€Ğ¼Ğ»ĞµĞ½Ğ¸Ğµ
                        </Button>
                    )}
                    {onAddMore && (
                        <Button variant="outline" className="w-full sm:w-auto" onClick={onAddMore}>
                            Ğ”Ğ¾Ğ±Ğ°Ğ²Ğ¸Ñ‚ÑŒ Ğ¾Ğ±Ğ¾Ñ€ÑƒĞ´Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ
                        </Button>
                    )}
                    {onSubmit && (
                        <Button
                            disabled={!isFormValid || isSubmitting || isLoading || isApplyingPromoCode}
                            className="px-6 py-2 w-full sm:w-auto"
                            onClick={onSubmit}
                        >
                            {isSubmitting ? "ĞĞ±Ñ€Ğ°Ğ±Ğ¾Ñ‚ĞºĞ°..." : "ĞŸĞ¾Ğ´Ñ‚Ğ²ĞµÑ€Ğ´Ğ¸Ñ‚ÑŒ Ñ€ĞµĞ·ĞµÑ€Ğ²"}
                        </Button>
                    )}
                </div>
            )}
        </div>
    );
}


```


## <a name="rentalappmainsrccomponentssharedOrderToolbartsx"></a>`rental-app-main/src/components/shared/OrderToolbar.tsx`

```tsx
// path: rental-app-main/src/components/shared/OrderToolbar.tsx

import { Input } from "@/components/ui/input"
import { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from "@/components/ui/select"
import { Checkbox } from "@/components/ui/checkbox"
import { Label } from "@/components/ui/label"
import { useOrderFilterStore, type SortOption, type OrderContext } from "@/store/orderFilterStore"

interface OrderToolbarProps {
    context: OrderContext
    showHideCompletedCheckbox?: boolean
}

export default function OrderToolbar({ context, showHideCompletedCheckbox }: OrderToolbarProps) {
    const { searchQuery, statusFilter, sortOption, setSearchQuery, setStatusFilter, setSortOption } = useOrderFilterStore()

    // ĞĞ¿Ñ€ĞµĞ´ĞµĞ»ÑĞµĞ¼ placeholder Ğ´Ğ»Ñ Ğ¿Ğ¾Ğ¸ÑĞºĞ° Ğ² Ğ·Ğ°Ğ²Ğ¸ÑĞ¸Ğ¼Ğ¾ÑÑ‚Ğ¸ Ğ¾Ñ‚ ĞºĞ¾Ğ½Ñ‚ĞµĞºÑÑ‚Ğ°
    const getSearchPlaceholder = () => {
        switch (context) {
            case "user-reservations":
            case "user-rentals":
                return "ĞŸĞ¾Ğ¸ÑĞº Ğ¿Ğ¾ Ğ¾Ğ±Ğ¾Ñ€ÑƒĞ´Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ..."
            case "admin-reservations":
            case "admin-rentals":
                return "ĞŸĞ¾Ğ¸ÑĞº Ğ¿Ğ¾ ĞºĞ»Ğ¸ĞµĞ½Ñ‚Ñƒ..."
            default:
                return "ĞŸĞ¾Ğ¸ÑĞº..."
        }
    }

    // ĞĞ¿Ñ€ĞµĞ´ĞµĞ»ÑĞµĞ¼ Ğ¾Ğ¿Ñ†Ğ¸Ğ¸ ÑÑ‚Ğ°Ñ‚ÑƒÑĞ° Ğ² Ğ·Ğ°Ğ²Ğ¸ÑĞ¸Ğ¼Ğ¾ÑÑ‚Ğ¸ Ğ¾Ñ‚ ĞºĞ¾Ğ½Ñ‚ĞµĞºÑÑ‚Ğ°
    const getStatusOptions = () => {
        switch (context) {
            case "user-reservations":
                return [
                    { value: "active", label: "ĞĞºÑ‚Ğ¸Ğ²Ğ½Ñ‹Ğµ" },
                    { value: "completed", label: "Ğ—Ğ°Ğ²ĞµÑ€ÑˆĞµĞ½Ğ½Ñ‹Ğµ" },
                    { value: "all", label: "Ğ’ÑĞµ" }
                ]
            case "user-rentals":
                return [
                    { value: "active", label: "ĞĞºÑ‚Ğ¸Ğ²Ğ½Ñ‹Ğµ" },
                    { value: "overdue", label: "ĞŸÑ€Ğ¾ÑÑ€Ğ¾Ñ‡ĞµĞ½Ğ½Ñ‹Ğµ" },
                    { value: "completed", label: "Ğ—Ğ°Ğ²ĞµÑ€ÑˆĞµĞ½Ğ½Ñ‹Ğµ" },
                    { value: "all", label: "Ğ’ÑĞµ" }
                ]
            case "admin-reservations":
                return [
                    { value: "active", label: "ĞĞºÑ‚Ğ¸Ğ²Ğ½Ñ‹Ğµ" },
                    { value: "completed", label: "Ğ—Ğ°Ğ²ĞµÑ€ÑˆĞµĞ½Ğ½Ñ‹Ğµ" },
                    { value: "all", label: "Ğ’ÑĞµ" }
                ]
            case "admin-rentals":
                return [
                    { value: "active", label: "ĞĞºÑ‚Ğ¸Ğ²Ğ½Ñ‹Ğµ" },
                    { value: "overdue", label: "ĞŸÑ€Ğ¾ÑÑ€Ğ¾Ñ‡ĞµĞ½Ğ½Ñ‹Ğµ" },
                    { value: "completed", label: "Ğ—Ğ°Ğ²ĞµÑ€ÑˆĞµĞ½Ğ½Ñ‹Ğµ" },
                    { value: "all", label: "Ğ’ÑĞµ" }
                ]
            default:
                return []
        }
    }

    const statusOptions = getStatusOptions()

    // Ğ›Ğ¾Ğ³Ğ¸ĞºĞ° Ğ´Ğ»Ñ Ñ‡ĞµĞºĞ±Ğ¾ĞºÑĞ° "Ğ¡ĞºÑ€Ñ‹Ñ‚ÑŒ Ğ·Ğ°Ğ²ĞµÑ€ÑˆĞµĞ½Ğ½Ñ‹Ğµ"
    const isHideCompletedChecked = statusFilter !== 'all'
    const handleHideCompletedChange = (checked: boolean | 'indeterminate') => {
        // Ğ•ÑĞ»Ğ¸ indeterminate, ÑÑ‡Ğ¸Ñ‚Ğ°ĞµĞ¼ ĞºĞ°Ğº false
        setStatusFilter(checked === true ? 'active' : 'all')
    }

    return (
        <div className="mb-4 flex flex-wrap items-center gap-4">
            <Input
                type="text"
                placeholder={getSearchPlaceholder()}
                value={searchQuery}
                onChange={(e) => setSearchQuery(e.target.value)}
                className="max-w-xs"
            />
            
            {showHideCompletedCheckbox ? (
                <div className="flex items-center space-x-2">
                    <Checkbox
                        id="hide-completed-orders"
                        checked={isHideCompletedChecked}
                        onCheckedChange={handleHideCompletedChange}
                    />
                    <Label htmlFor="hide-completed-orders">Ğ¡ĞºÑ€Ñ‹Ñ‚ÑŒ Ğ·Ğ°Ğ²ĞµÑ€ÑˆĞµĞ½Ğ½Ñ‹Ğµ</Label>
                </div>
            ) : (
                <Select value={statusFilter || "active"} onValueChange={setStatusFilter}>
                    <SelectTrigger className="w-52">
                        <SelectValue placeholder="Ğ¤Ğ¸Ğ»ÑŒÑ‚Ñ€ Ğ¿Ğ¾ ÑÑ‚Ğ°Ñ‚ÑƒÑÑƒ" />
                    </SelectTrigger>
                    <SelectContent>
                        {statusOptions.map((option) => (
                            <SelectItem key={option.value} value={option.value}>
                                {option.label}
                            </SelectItem>
                        ))}
                    </SelectContent>
                </Select>
            )}

            <Select value={sortOption} onValueChange={(val) => setSortOption(val as SortOption)}>
                <SelectTrigger className="w-52">
                    <SelectValue placeholder="Ğ¡Ğ¾Ñ€Ñ‚Ğ¸Ñ€Ğ¾Ğ²ĞºĞ°" />
                </SelectTrigger>
                <SelectContent>
                    <SelectItem value="id_desc">ĞĞ¾Ğ¼ĞµÑ€ â†“</SelectItem>
                    <SelectItem value="id_asc">ĞĞ¾Ğ¼ĞµÑ€ â†‘</SelectItem>
                    <SelectItem value="start_desc">ĞĞ°Ñ‡Ğ°Ğ»Ğ¾ â†“</SelectItem>
                    <SelectItem value="start_asc">ĞĞ°Ñ‡Ğ°Ğ»Ğ¾ â†‘</SelectItem>
                    <SelectItem value="end_desc">ĞĞºĞ¾Ğ½Ñ‡Ğ°Ğ½Ğ¸Ğµ â†“</SelectItem>
                    <SelectItem value="end_asc">ĞĞºĞ¾Ğ½Ñ‡Ğ°Ğ½Ğ¸Ğµ â†‘</SelectItem>
                    <SelectItem value="count_desc">ĞŸĞ¾Ğ·Ğ¸Ñ†Ğ¸Ğ¹ â†“</SelectItem>
                    <SelectItem value="count_asc">ĞŸĞ¾Ğ·Ğ¸Ñ†Ğ¸Ğ¹ â†‘</SelectItem>
                </SelectContent>
            </Select>
        </div>
    )
}


```


## <a name="rentalappmainsrccomponentsuiAdminButtontsx"></a>`rental-app-main/src/components/ui/AdminButton.tsx`

```tsx
// path: rental-app-main/src/components/ui/AdminButton.tsx

// src/components/AdminButton.tsx


import { useCurrentUser } from "@/hooks/useProfile";
import { Button } from "@/components/ui/button";
import { Shield } from "lucide-react";
import { useNavigate } from "react-router-dom";

export default function AdminButton() {
    const { data: user, isLoading } = useCurrentUser();
    const navigate = useNavigate();

    const isAdmin = user?.role === "admin";
    const isManager = user?.role === "manager" || isAdmin;

    if (isLoading || !isManager) return null;

    return (
        <Button
            onClick={() => navigate("/admin")}
            variant="default"
            className="bg-gray-800 hover:bg-gray-700"
        >
            <Shield className="w-4 h-4 mr-2" />
            {isAdmin ? "ĞĞ´Ğ¼Ğ¸Ğ½ Ğ¿Ğ°Ğ½ĞµĞ»ÑŒ" : "ĞŸĞ°Ğ½ĞµĞ»ÑŒ Ğ¼ĞµĞ½ĞµĞ´Ğ¶ĞµÑ€Ğ°"}
        </Button>
    );
}


```


## <a name="rentalappmainsrccomponentsuiCreatableSelecttsx"></a>`rental-app-main/src/components/ui/CreatableSelect.tsx`

```tsx
// path: rental-app-main/src/components/ui/CreatableSelect.tsx

// src/components/ui/CreatableSelect.tsx

import { useState, useMemo, useEffect } from "react";
import {
    Dialog, DialogContent, DialogHeader, DialogTitle, DialogFooter, DialogDescription
} from "@/components/ui/dialog";
import {
    Select, SelectContent, SelectItem, SelectTrigger, SelectValue
} from "@/components/ui/select";
import { Button } from "@/components/ui/button";
import { Input } from "@/components/ui/input";
import { Label } from "@/components/ui/label";

// --- Ğ’ÑĞ¿Ğ¾Ğ¼Ğ¾Ğ³Ğ°Ñ‚ĞµĞ»ÑŒĞ½Ñ‹Ğ¹ ĞºĞ¾Ğ¼Ğ¿Ğ¾Ğ½ĞµĞ½Ñ‚: Ğ”Ğ¸Ğ°Ğ»Ğ¾Ğ³ Ğ´Ğ»Ñ ÑĞ¾Ğ·Ğ´Ğ°Ğ½Ğ¸Ñ Ğ½Ğ¾Ğ²Ğ¾Ğ³Ğ¾ ÑĞ»ĞµĞ¼ĞµĞ½Ñ‚Ğ° ---
const AddNewItemDialog = ({ open, onClose, onSave, title, description, label }: {
    open: boolean;
    onClose: () => void;
    onSave: (newItem: string) => void;
    title: string;
    description: string;
    label: string;
}) => {
    const [newItem, setNewItem] = useState("");

    const handleSave = () => {
        if (newItem.trim()) {
            onSave(newItem.trim());
        }
    };

    // Ğ¡Ğ±Ñ€Ğ°ÑÑ‹Ğ²Ğ°ĞµĞ¼ Ğ¿Ğ¾Ğ»Ğµ Ğ²Ğ²Ğ¾Ğ´Ğ°, ĞºĞ¾Ğ³Ğ´Ğ° Ğ´Ğ¸Ğ°Ğ»Ğ¾Ğ³ Ğ¾Ñ‚ĞºÑ€Ñ‹Ğ²Ğ°ĞµÑ‚ÑÑ
    useEffect(() => {
        if (open) {
            setNewItem("");
        }
    }, [open]);

    return (
        <Dialog open={open} onOpenChange={onClose}>
            <DialogContent className="sm:max-w-[425px]">
                <DialogHeader>
                    <DialogTitle>{title}</DialogTitle>
                    <DialogDescription>{description}</DialogDescription>
                </DialogHeader>
                <div className="grid gap-4 py-4">
                    <div className="grid grid-cols-4 items-center gap-4">
                        <Label htmlFor="new-item-name" className="text-right">{label}</Label>
                        <Input
                            id="new-item-name"
                            value={newItem}
                            onChange={(e) => setNewItem(e.target.value)}
                            className="col-span-3"
                            autoFocus
                            onKeyDown={(e) => { if (e.key === 'Enter') handleSave(); }}
                        />
                    </div>
                </div>
                <DialogFooter>
                    <Button type="button" variant="ghost" onClick={onClose}>ĞÑ‚Ğ¼ĞµĞ½Ğ°</Button>
                    <Button type="button" onClick={handleSave} disabled={!newItem.trim()}>Ğ¡Ğ¾Ñ…Ñ€Ğ°Ğ½Ğ¸Ñ‚ÑŒ</Button>
                </DialogFooter>
            </DialogContent>
        </Dialog>
    );
};

// --- ĞÑĞ½Ğ¾Ğ²Ğ½Ğ¾Ğ¹ ĞºĞ¾Ğ¼Ğ¿Ğ¾Ğ½ĞµĞ½Ñ‚ CreatableSelect ---
interface CreatableSelectProps {
    value?: string;
    onChange: (value: string) => void;
    options: string[];
    placeholder?: string;
    dialogTitle: string;
    dialogDescription: string;
    dialogLabel: string;
    className?: string;
}

export function CreatableSelect({
                                    value,
                                    onChange,
                                    options,
                                    placeholder = "Ğ’Ñ‹Ğ±ĞµÑ€Ğ¸Ñ‚Ğµ Ğ·Ğ½Ğ°Ñ‡ĞµĞ½Ğ¸Ğµ...",
                                    dialogTitle,
                                    dialogDescription,
                                    dialogLabel,
                                    className
                                }: CreatableSelectProps) {
    const [isAddingNew, setIsAddingNew] = useState(false);
    const [customOptions, setCustomOptions] = useState<string[]>([]);

    const allOptions = useMemo(() => {
        const combined = new Set([...options, ...customOptions]);
        return Array.from(combined).sort((a, b) => a.localeCompare(b));
    }, [options, customOptions]);

    const handleSelect = (selectedValue: string) => {
        if (selectedValue === "add_new") {
            setIsAddingNew(true);
        } else {
            onChange(selectedValue);
        }
    };

    const handleSaveNew = (newItem: string) => {
        if (!allOptions.includes(newItem)) {
            setCustomOptions(prev => [...prev, newItem]);
        }
        onChange(newItem);
        setIsAddingNew(false);
    };

    return (
        <>
            <Select onValueChange={handleSelect} value={value || ""}>
                <SelectTrigger className={className}>
                    <SelectValue placeholder={placeholder} />
                </SelectTrigger>
                <SelectContent>
                    {allOptions.map((opt) => (
                        <SelectItem key={opt} value={opt}>
                            {opt}
                        </SelectItem>
                    ))}
                    <SelectItem value="add_new" className="text-sky-600 font-semibold">
                        + Ğ”Ğ¾Ğ±Ğ°Ğ²Ğ¸Ñ‚ÑŒ Ğ½Ğ¾Ğ²Ñ‹Ğ¹...
                    </SelectItem>
                </SelectContent>
            </Select>

            <AddNewItemDialog
                open={isAddingNew}
                onClose={() => setIsAddingNew(false)}
                onSave={handleSaveNew}
                title={dialogTitle}
                description={dialogDescription}
                label={dialogLabel}
            />
        </>
    );
}

```


## <a name="rentalappmainsrccomponentsuialerttsx"></a>`rental-app-main/src/components/ui/alert.tsx`

```tsx
// path: rental-app-main/src/components/ui/alert.tsx

import * as React from "react"
import { cva, type VariantProps } from "class-variance-authority"

import { cn } from "@/lib/utils"

const alertVariants = cva(
  "relative w-full rounded-lg border p-4 [&>svg~*]:pl-7 [&>svg+div]:translate-y-[-3px] [&>svg]:absolute [&>svg]:left-4 [&>svg]:top-4 [&>svg]:text-foreground",
  {
    variants: {
      variant: {
        default: "bg-background text-foreground",
        destructive:
          "border-destructive/50 text-destructive dark:border-destructive [&>svg]:text-destructive",
      },
    },
    defaultVariants: {
      variant: "default",
    },
  }
)

const Alert = React.forwardRef<
  HTMLDivElement,
  React.HTMLAttributes<HTMLDivElement> & VariantProps<typeof alertVariants>
>(({ className, variant, ...props }, ref) => (
  <div
    ref={ref}
    role="alert"
    className={cn(alertVariants({ variant }), className)}
    {...props}
  />
))
Alert.displayName = "Alert"

const AlertTitle = React.forwardRef<
  HTMLParagraphElement,
  React.HTMLAttributes<HTMLHeadingElement>
>(({ className, ...props }, ref) => (
  <h5
    ref={ref}
    className={cn("mb-1 font-medium leading-none tracking-tight", className)}
    {...props}
  />
))
AlertTitle.displayName = "AlertTitle"

const AlertDescription = React.forwardRef<
  HTMLParagraphElement,
  React.HTMLAttributes<HTMLParagraphElement>
>(({ className, ...props }, ref) => (
  <div
    ref={ref}
    className={cn("text-sm [&_p]:leading-relaxed", className)}
    {...props}
  />
))
AlertDescription.displayName = "AlertDescription"

export { Alert, AlertTitle, AlertDescription }


```


## <a name="rentalappmainsrccomponentsuibadgetsx"></a>`rental-app-main/src/components/ui/badge.tsx`

```tsx
// path: rental-app-main/src/components/ui/badge.tsx

import * as React from "react"
import { cva, type VariantProps } from "class-variance-authority"

import { cn } from "@/lib/utils"

const badgeVariants = cva(
  "inline-flex items-center rounded-md border px-2.5 py-0.5 text-xs font-semibold transition-colors focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2",
  {
    variants: {
      variant: {
        default:
          "border-transparent bg-primary text-primary-foreground shadow hover:bg-primary/80",
        secondary:
          "border-transparent bg-secondary text-secondary-foreground hover:bg-secondary/80",
        destructive:
          "border-transparent bg-destructive text-destructive-foreground shadow hover:bg-destructive/80",
        outline: "text-foreground",
      },
    },
    defaultVariants: {
      variant: "default",
    },
  }
)

export interface BadgeProps
  extends React.HTMLAttributes<HTMLDivElement>,
    VariantProps<typeof badgeVariants> {}

function Badge({ className, variant, ...props }: BadgeProps) {
  return (
    <div className={cn(badgeVariants({ variant }), className)} {...props} />
  )
}

export { Badge, badgeVariants }


```


## <a name="rentalappmainsrccomponentsuibuttontsx"></a>`rental-app-main/src/components/ui/button.tsx`

```tsx
// path: rental-app-main/src/components/ui/button.tsx

// src/components/ui/button.tsx

import * as React from "react";
import { Slot } from "@radix-ui/react-slot";
import { cva, type VariantProps } from "class-variance-authority";
import { cn } from "@/lib/utils";

const buttonVariants = cva(
    "inline-flex items-center justify-center gap-2 whitespace-nowrap rounded-md text-sm font-medium transition-colors focus-visible:outline-none focus-visible:ring-1 focus-visible:ring-ring disabled:pointer-events-none disabled:opacity-50 [&_svg]:pointer-events-none [&_svg]:size-4 [&_svg]:shrink-0",
    {
        variants: {
            variant: {
                default: "bg-primary text-primary-foreground shadow hover:bg-primary/90",
                destructive: "bg-destructive text-destructive-foreground shadow-sm hover:bg-destructive/90",
                outline: "border border-input bg-background shadow-sm hover:bg-accent hover:text-accent-foreground",
                secondary: "bg-secondary text-secondary-foreground shadow-sm hover:bg-secondary/80",
                ghost: "hover:bg-accent hover:text-accent-foreground",
                link: "text-primary underline-offset-4 hover:underline",
                filter: "h-8 px-3 rounded-full border border-gray-300 text-gray-700 data-[state=on]:bg-sky-600 data-[state=on]:text-white hover:bg-sky-100 hover:text-gray-900 transition-colors",

                // ĞĞ±Ğ½Ğ¾Ğ²Ğ»ĞµĞ½Ğ½Ñ‹Ğµ Ğ²Ğ°Ñ€Ğ¸Ğ°Ğ½Ñ‚Ñ‹ Ğ´Ğ»Ñ ÑĞ¾ÑÑ‚Ğ¾ÑĞ½Ğ¸Ğ¹ Ğ¾Ğ±Ğ¾Ñ€ÑƒĞ´Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ Ğ² ÑĞ¾Ğ¾Ñ‚Ğ²ĞµÑ‚ÑÑ‚Ğ²Ğ¸Ğ¸ Ñ Ğ¸Ğ·Ğ¾Ğ±Ñ€Ğ°Ğ¶ĞµĞ½Ğ¸ĞµĞ¼
                conditionExcellent: // Ğ’ĞµĞ»Ğ¸ĞºĞ¾Ğ»ĞµĞ¿Ğ½Ğ¾ (ÑĞ²ĞµÑ‚Ğ»Ğ¾-Ğ·ĞµĞ»ĞµĞ½Ñ‹Ğ¹ Ñ„Ğ¾Ğ½, Ñ‚ĞµĞ¼Ğ½Ñ‹Ğ¹ Ñ‚ĞµĞºÑÑ‚)
                    "bg-green-200 text-green-800 shadow-sm hover:bg-green-300 focus-visible:ring-green-400",
                conditionGreat: // ĞÑ‚Ğ»Ğ¸Ñ‡Ğ½Ğ¾ (ÑĞ²ĞµÑ‚Ğ»Ğ¾-Ğ³Ğ¾Ğ»ÑƒĞ±Ğ¾Ğ¹ Ñ„Ğ¾Ğ½, Ñ‚ĞµĞ¼Ğ½Ñ‹Ğ¹ Ñ‚ĞµĞºÑÑ‚)
                    "bg-sky-200 text-sky-800 shadow-sm hover:bg-sky-300 focus-visible:ring-sky-400",
                conditionGood: // Ğ¥Ğ¾Ñ€Ğ¾ÑˆĞ¾ (ÑĞ²ĞµÑ‚Ğ»Ğ¾-Ğ¶ĞµĞ»Ñ‚Ñ‹Ğ¹ Ñ„Ğ¾Ğ½, Ñ‚ĞµĞ¼Ğ½Ñ‹Ğ¹ Ñ‚ĞµĞºÑÑ‚)
                    "bg-yellow-200 text-yellow-800 shadow-sm hover:bg-yellow-300 focus-visible:ring-yellow-400",
                conditionSatisfactory: // Ğ£Ğ´Ğ¾Ğ²Ğ»ĞµÑ‚Ğ²Ğ¾Ñ€Ğ¸Ñ‚ĞµĞ»ÑŒĞ½Ğ¾ (ÑĞ²ĞµÑ‚Ğ»Ğ¾-Ğ¾Ñ€Ğ°Ğ½Ğ¶ĞµĞ²Ñ‹Ğ¹/Ğ¿ĞµÑ€ÑĞ¸ĞºĞ¾Ğ²Ñ‹Ğ¹ Ñ„Ğ¾Ğ½, Ñ‚ĞµĞ¼Ğ½Ñ‹Ğ¹ Ñ‚ĞµĞºÑÑ‚)
                    "bg-orange-200 text-orange-800 shadow-sm hover:bg-orange-300 focus-visible:ring-orange-400",
                conditionBad: // ĞŸĞ»Ğ¾Ñ…Ğ¾ / Ğ¢Ñ€ĞµĞ±ÑƒĞµÑ‚ Ñ€ĞµĞ¼Ğ¾Ğ½Ñ‚Ğ° (ÑĞ²ĞµÑ‚Ğ»Ğ¾-ĞºÑ€Ğ°ÑĞ½Ñ‹Ğ¹/Ñ€Ğ¾Ğ·Ğ¾Ğ²Ñ‹Ğ¹ Ñ„Ğ¾Ğ½, Ñ‚ĞµĞ¼Ğ½Ñ‹Ğ¹ Ñ‚ĞµĞºÑÑ‚)
                    "bg-red-200 text-red-800 shadow-sm hover:bg-red-300 focus-visible:ring-red-400",
            },
            size: {
                default: "h-9 px-4 py-2",
                sm: "h-8 rounded-md px-3 text-xs",
                lg: "h-10 rounded-md px-8",
                icon: "h-9 w-9",
            },
        },
        defaultVariants: {
            variant: "default",
            size: "default",
        },
    }
);

export interface ButtonProps
    extends React.ButtonHTMLAttributes<HTMLButtonElement>,
        VariantProps<typeof buttonVariants> {
    asChild?: boolean;
}

const Button = React.forwardRef<HTMLButtonElement, ButtonProps>(
    ({ className, variant, size, asChild = false, ...props }, ref) => {
        const Comp = asChild ? Slot : "button";
        return (
            <Comp
                className={cn(buttonVariants({ variant, size, className }))}
                ref={ref}
                {...props}
            />
        );
    }
);
Button.displayName = "Button";

export { Button, buttonVariants };

```


## <a name="rentalappmainsrccomponentsuicardtsx"></a>`rental-app-main/src/components/ui/card.tsx`

```tsx
// path: rental-app-main/src/components/ui/card.tsx

import * as React from "react"

import { cn } from "@/lib/utils"

const Card = React.forwardRef<
  HTMLDivElement,
  React.HTMLAttributes<HTMLDivElement>
>(({ className, ...props }, ref) => (
  <div
    ref={ref}
    className={cn(
      "rounded-xl border bg-card text-card-foreground shadow",
      className
    )}
    {...props}
  />
))
Card.displayName = "Card"

const CardHeader = React.forwardRef<
  HTMLDivElement,
  React.HTMLAttributes<HTMLDivElement>
>(({ className, ...props }, ref) => (
  <div
    ref={ref}
    className={cn("flex flex-col space-y-1.5 p-6", className)}
    {...props}
  />
))
CardHeader.displayName = "CardHeader"

const CardTitle = React.forwardRef<
  HTMLDivElement,
  React.HTMLAttributes<HTMLDivElement>
>(({ className, ...props }, ref) => (
  <div
    ref={ref}
    className={cn("font-semibold leading-none tracking-tight", className)}
    {...props}
  />
))
CardTitle.displayName = "CardTitle"

const CardDescription = React.forwardRef<
  HTMLDivElement,
  React.HTMLAttributes<HTMLDivElement>
>(({ className, ...props }, ref) => (
  <div
    ref={ref}
    className={cn("text-sm text-muted-foreground", className)}
    {...props}
  />
))
CardDescription.displayName = "CardDescription"

const CardContent = React.forwardRef<
  HTMLDivElement,
  React.HTMLAttributes<HTMLDivElement>
>(({ className, ...props }, ref) => (
  <div ref={ref} className={cn("p-6 pt-0", className)} {...props} />
))
CardContent.displayName = "CardContent"

const CardFooter = React.forwardRef<
  HTMLDivElement,
  React.HTMLAttributes<HTMLDivElement>
>(({ className, ...props }, ref) => (
  <div
    ref={ref}
    className={cn("flex items-center p-6 pt-0", className)}
    {...props}
  />
))
CardFooter.displayName = "CardFooter"

export { Card, CardHeader, CardFooter, CardTitle, CardDescription, CardContent }


```


## <a name="rentalappmainsrccomponentsuicheckboxtsx"></a>`rental-app-main/src/components/ui/checkbox.tsx`

```tsx
// path: rental-app-main/src/components/ui/checkbox.tsx

import * as React from "react"
import * as CheckboxPrimitive from "@radix-ui/react-checkbox"
import { Check } from "lucide-react"

import { cn } from "@/lib/utils"

const Checkbox = React.forwardRef<
  React.ElementRef<typeof CheckboxPrimitive.Root>,
  React.ComponentPropsWithoutRef<typeof CheckboxPrimitive.Root>
>(({ className, ...props }, ref) => (
  <CheckboxPrimitive.Root
    ref={ref}
    className={cn(
      "peer h-4 w-4 shrink-0 rounded-sm border border-primary shadow focus-visible:outline-none focus-visible:ring-1 focus-visible:ring-ring disabled:cursor-not-allowed disabled:opacity-50 data-[state=checked]:bg-primary data-[state=checked]:text-primary-foreground",
      className
    )}
    {...props}
  >
    <CheckboxPrimitive.Indicator
      className={cn("flex items-center justify-center text-current")}
    >
      <Check className="h-4 w-4" />
    </CheckboxPrimitive.Indicator>
  </CheckboxPrimitive.Root>
))
Checkbox.displayName = CheckboxPrimitive.Root.displayName

export { Checkbox }


```


## <a name="rentalappmainsrccomponentsuicommandtsx"></a>`rental-app-main/src/components/ui/command.tsx`

```tsx
// path: rental-app-main/src/components/ui/command.tsx

import * as React from "react"
import { type DialogProps } from "@radix-ui/react-dialog"
import { Command as CommandPrimitive } from "cmdk"
import { Search } from "lucide-react"

import { cn } from "@/lib/utils"
import { Dialog, DialogContent } from "@/components/ui/dialog"

const Command = React.forwardRef<
  React.ElementRef<typeof CommandPrimitive>,
  React.ComponentPropsWithoutRef<typeof CommandPrimitive>
>(({ className, ...props }, ref) => (
  <CommandPrimitive
    ref={ref}
    className={cn(
      "flex h-full w-full flex-col overflow-hidden rounded-md bg-popover text-popover-foreground",
      className
    )}
    {...props}
  />
))
Command.displayName = CommandPrimitive.displayName

const CommandDialog = ({ children, ...props }: DialogProps) => {
  return (
    <Dialog {...props}>
      <DialogContent className="overflow-hidden p-0">
        <Command className="[&_[cmdk-group-heading]]:px-2 [&_[cmdk-group-heading]]:font-medium [&_[cmdk-group-heading]]:text-muted-foreground [&_[cmdk-group]:not([hidden])_~[cmdk-group]]:pt-0 [&_[cmdk-group]]:px-2 [&_[cmdk-input-wrapper]_svg]:h-5 [&_[cmdk-input-wrapper]_svg]:w-5 [&_[cmdk-input]]:h-12 [&_[cmdk-item]]:px-2 [&_[cmdk-item]]:py-3 [&_[cmdk-item]_svg]:h-5 [&_[cmdk-item]_svg]:w-5">
          {children}
        </Command>
      </DialogContent>
    </Dialog>
  )
}

const CommandInput = React.forwardRef<
  React.ElementRef<typeof CommandPrimitive.Input>,
  React.ComponentPropsWithoutRef<typeof CommandPrimitive.Input>
>(({ className, ...props }, ref) => (
  <div className="flex items-center border-b px-3" cmdk-input-wrapper="">
    <Search className="mr-2 h-4 w-4 shrink-0 opacity-50" />
    <CommandPrimitive.Input
      ref={ref}
      className={cn(
        "flex h-10 w-full rounded-md bg-transparent py-3 text-sm outline-none placeholder:text-muted-foreground disabled:cursor-not-allowed disabled:opacity-50",
        className
      )}
      {...props}
    />
  </div>
))

CommandInput.displayName = CommandPrimitive.Input.displayName

const CommandList = React.forwardRef<
  React.ElementRef<typeof CommandPrimitive.List>,
  React.ComponentPropsWithoutRef<typeof CommandPrimitive.List>
>(({ className, ...props }, ref) => (
  <CommandPrimitive.List
    ref={ref}
    className={cn("max-h-[300px] overflow-y-auto overflow-x-hidden", className)}
    {...props}
  />
))

CommandList.displayName = CommandPrimitive.List.displayName

const CommandEmpty = React.forwardRef<
  React.ElementRef<typeof CommandPrimitive.Empty>,
  React.ComponentPropsWithoutRef<typeof CommandPrimitive.Empty>
>((props, ref) => (
  <CommandPrimitive.Empty
    ref={ref}
    className="py-6 text-center text-sm"
    {...props}
  />
))

CommandEmpty.displayName = CommandPrimitive.Empty.displayName

const CommandGroup = React.forwardRef<
  React.ElementRef<typeof CommandPrimitive.Group>,
  React.ComponentPropsWithoutRef<typeof CommandPrimitive.Group>
>(({ className, ...props }, ref) => (
  <CommandPrimitive.Group
    ref={ref}
    className={cn(
      "overflow-hidden p-1 text-foreground [&_[cmdk-group-heading]]:px-2 [&_[cmdk-group-heading]]:py-1.5 [&_[cmdk-group-heading]]:text-xs [&_[cmdk-group-heading]]:font-medium [&_[cmdk-group-heading]]:text-muted-foreground",
      className
    )}
    {...props}
  />
))

CommandGroup.displayName = CommandPrimitive.Group.displayName

const CommandSeparator = React.forwardRef<
  React.ElementRef<typeof CommandPrimitive.Separator>,
  React.ComponentPropsWithoutRef<typeof CommandPrimitive.Separator>
>(({ className, ...props }, ref) => (
  <CommandPrimitive.Separator
    ref={ref}
    className={cn("-mx-1 h-px bg-border", className)}
    {...props}
  />
))
CommandSeparator.displayName = CommandPrimitive.Separator.displayName

const CommandItem = React.forwardRef<
  React.ElementRef<typeof CommandPrimitive.Item>,
  React.ComponentPropsWithoutRef<typeof CommandPrimitive.Item>
>(({ className, ...props }, ref) => (
  <CommandPrimitive.Item
    ref={ref}
    className={cn(
      "relative flex cursor-default gap-2 select-none items-center rounded-sm px-2 py-1.5 text-sm outline-none data-[disabled=true]:pointer-events-none data-[selected=true]:bg-accent data-[selected=true]:text-accent-foreground data-[disabled=true]:opacity-50 [&_svg]:pointer-events-none [&_svg]:size-4 [&_svg]:shrink-0",
      className
    )}
    {...props}
  />
))

CommandItem.displayName = CommandPrimitive.Item.displayName

const CommandShortcut = ({
  className,
  ...props
}: React.HTMLAttributes<HTMLSpanElement>) => {
  return (
    <span
      className={cn(
        "ml-auto text-xs tracking-widest text-muted-foreground",
        className
      )}
      {...props}
    />
  )
}
CommandShortcut.displayName = "CommandShortcut"

export {
  Command,
  CommandDialog,
  CommandInput,
  CommandList,
  CommandEmpty,
  CommandGroup,
  CommandItem,
  CommandShortcut,
  CommandSeparator,
}


```


## <a name="rentalappmainsrccomponentsuiconfirmationdialogtsx"></a>`rental-app-main/src/components/ui/confirmation-dialog.tsx`

```tsx
// path: rental-app-main/src/components/ui/confirmation-dialog.tsx

import React from "react";
import {
  Dialog,
  DialogContent,
  DialogDescription,
  DialogFooter,
  DialogHeader,
  DialogTitle,
} from "./dialog";
import { Button } from "./button";
import { AlertTriangle } from "lucide-react";

interface ConfirmationDialogProps {
  open: boolean;
  onOpenChange: (open: boolean) => void;
  title: string;
  description: string;
  confirmText?: string;
  cancelText?: string;
  onConfirm: () => void;
  onCancel?: () => void;
  variant?: "default" | "destructive";
}

export function ConfirmationDialog({
  open,
  onOpenChange,
  title,
  description,
  confirmText = "ĞŸĞ¾Ğ´Ñ‚Ğ²ĞµÑ€Ğ´Ğ¸Ñ‚ÑŒ",
  cancelText = "ĞÑ‚Ğ¼ĞµĞ½Ğ°",
  onConfirm,
  onCancel,
  variant = "default",
}: ConfirmationDialogProps) {
  const handleConfirm = () => {
    onConfirm();
    onOpenChange(false);
  };

  const handleCancel = () => {
    onCancel?.();
    onOpenChange(false);
  };

  return (
    <Dialog open={open} onOpenChange={onOpenChange}>
      <DialogContent className="sm:max-w-[425px]">
        <DialogHeader>
          <div className="flex items-center gap-2">
            {variant === "destructive" && (
              <AlertTriangle className="h-5 w-5 text-red-500" />
            )}
            <DialogTitle>{title}</DialogTitle>
          </div>
          <DialogDescription>{description}</DialogDescription>
        </DialogHeader>
        <DialogFooter>
          <Button variant="outline" onClick={handleCancel}>
            {cancelText}
          </Button>
          <Button
            variant={variant === "destructive" ? "destructive" : "default"}
            onClick={handleConfirm}
          >
            {confirmText}
          </Button>
        </DialogFooter>
      </DialogContent>
    </Dialog>
  );
} 

```


## <a name="rentalappmainsrccomponentsuidialogtsx"></a>`rental-app-main/src/components/ui/dialog.tsx`

```tsx
// path: rental-app-main/src/components/ui/dialog.tsx

import * as React from "react"
import * as DialogPrimitive from "@radix-ui/react-dialog"
import { X } from "lucide-react"

import { cn } from "@/lib/utils"

const Dialog = DialogPrimitive.Root

const DialogTrigger = DialogPrimitive.Trigger

const DialogPortal = DialogPrimitive.Portal

const DialogClose = DialogPrimitive.Close

const DialogOverlay = React.forwardRef<
  React.ElementRef<typeof DialogPrimitive.Overlay>,
  React.ComponentPropsWithoutRef<typeof DialogPrimitive.Overlay>
>(({ className, ...props }, ref) => (
  <DialogPrimitive.Overlay
    ref={ref}
    className={cn(
      "fixed inset-0 z-50 bg-black/80  data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0",
      className
    )}
    {...props}
  />
))
DialogOverlay.displayName = DialogPrimitive.Overlay.displayName

const DialogContent = React.forwardRef<
  React.ElementRef<typeof DialogPrimitive.Content>,
  React.ComponentPropsWithoutRef<typeof DialogPrimitive.Content>
>(({ className, children, ...props }, ref) => (
  <DialogPortal>
    <DialogOverlay />
    <DialogPrimitive.Content
      ref={ref}
      className={cn(
        "fixed left-[50%] top-[50%] z-50 grid w-full max-w-lg translate-x-[-50%] translate-y-[-50%] gap-4 border bg-background p-6 shadow-lg duration-200 data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[state=closed]:slide-out-to-left-1/2 data-[state=closed]:slide-out-to-top-[48%] data-[state=open]:slide-in-from-left-1/2 data-[state=open]:slide-in-from-top-[48%] sm:rounded-lg",
        className
      )}
      {...props}
    >
      {children}
      <DialogPrimitive.Close className="absolute right-4 top-4 rounded-sm opacity-70 ring-offset-background transition-opacity hover:opacity-100 focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2 disabled:pointer-events-none data-[state=open]:bg-accent data-[state=open]:text-muted-foreground">
        <X className="h-4 w-4" />
        <span className="sr-only">Close</span>
      </DialogPrimitive.Close>
    </DialogPrimitive.Content>
  </DialogPortal>
))
DialogContent.displayName = DialogPrimitive.Content.displayName

const DialogHeader = ({
  className,
  ...props
}: React.HTMLAttributes<HTMLDivElement>) => (
  <div
    className={cn(
      "flex flex-col space-y-1.5 text-center sm:text-left",
      className
    )}
    {...props}
  />
)
DialogHeader.displayName = "DialogHeader"

const DialogFooter = ({
  className,
  ...props
}: React.HTMLAttributes<HTMLDivElement>) => (
  <div
    className={cn(
      "flex flex-col-reverse sm:flex-row sm:justify-end sm:space-x-2",
      className
    )}
    {...props}
  />
)
DialogFooter.displayName = "DialogFooter"

const DialogTitle = React.forwardRef<
  React.ElementRef<typeof DialogPrimitive.Title>,
  React.ComponentPropsWithoutRef<typeof DialogPrimitive.Title>
>(({ className, ...props }, ref) => (
  <DialogPrimitive.Title
    ref={ref}
    className={cn(
      "text-lg font-semibold leading-none tracking-tight",
      className
    )}
    {...props}
  />
))
DialogTitle.displayName = DialogPrimitive.Title.displayName

const DialogDescription = React.forwardRef<
  React.ElementRef<typeof DialogPrimitive.Description>,
  React.ComponentPropsWithoutRef<typeof DialogPrimitive.Description>
>(({ className, ...props }, ref) => (
  <DialogPrimitive.Description
    ref={ref}
    className={cn("text-sm text-muted-foreground", className)}
    {...props}
  />
))
DialogDescription.displayName = DialogPrimitive.Description.displayName

export {
  Dialog,
  DialogPortal,
  DialogOverlay,
  DialogTrigger,
  DialogClose,
  DialogContent,
  DialogHeader,
  DialogFooter,
  DialogTitle,
  DialogDescription,
}


```


## <a name="rentalappmainsrccomponentsuifiltertoggletsx"></a>`rental-app-main/src/components/ui/filter-toggle.tsx`

```tsx
// path: rental-app-main/src/components/ui/filter-toggle.tsx

// src/components/ui/filter-toggle.tsx
import { cva } from "class-variance-authority"
import { cn } from "@/lib/utils"

// Ğ‘Ğ°Ğ·Ğ¾Ğ²Ñ‹Ğµ ÑÑ‚Ğ¸Ğ»Ğ¸ Ğ´Ğ»Ñ ĞºĞ½Ğ¾Ğ¿Ğ¾Ğº Ñ„Ğ¸Ğ»ÑŒÑ‚Ñ€Ğ°
export const filterToggleBaseClass = cva(
    "capitalize px-2 py-1 rounded text-sm font-medium transition-colors"
)

// Ğ˜Ñ‚Ğ¾Ğ³Ğ¾Ğ²Ñ‹Ğ¹ ĞºĞ»Ğ°ÑÑ ÑĞ¾ ÑÑ‚Ğ¸Ğ»ÑĞ¼Ğ¸ Ğ¿Ğ¾ ÑĞ¾ÑÑ‚Ğ¾ÑĞ½Ğ¸Ñ ToggleGroupItem
export function getFilterToggleClass(color = "sky") {
    const colorClasses = {
        sky: "data-[state=on]:bg-sky-600 data-[state=on]:text-white data-[state=off]:bg-sky-100 data-[state=off]:text-sky-600 data-[state=off]:hover:bg-sky-200",
        green: "data-[state=on]:bg-green-600 data-[state=on]:text-white data-[state=off]:bg-green-100 data-[state=off]:text-green-600 data-[state=off]:hover:bg-green-200"
    };
    
    return cn(
        filterToggleBaseClass(),
        colorClasses[color as keyof typeof colorClasses] || colorClasses.sky
    )
}


```


## <a name="rentalappmainsrccomponentsuiinputtsx"></a>`rental-app-main/src/components/ui/input.tsx`

```tsx
// path: rental-app-main/src/components/ui/input.tsx

import * as React from "react"

import { cn } from "@/lib/utils"

const Input = React.forwardRef<HTMLInputElement, React.ComponentProps<"input">>(
  ({ className, type, ...props }, ref) => {
    return (
      <input
        type={type}
        className={cn(
          "flex h-9 w-full rounded-md border border-input bg-transparent px-3 py-1 text-base shadow-sm transition-colors file:border-0 file:bg-transparent file:text-sm file:font-medium file:text-foreground placeholder:text-muted-foreground focus-visible:outline-none focus-visible:ring-1 focus-visible:ring-ring disabled:cursor-not-allowed disabled:opacity-50 md:text-sm",
          className
        )}
        ref={ref}
        {...props}
      />
    )
  }
)
Input.displayName = "Input"

export { Input }


```


## <a name="rentalappmainsrccomponentsuilabeltsx"></a>`rental-app-main/src/components/ui/label.tsx`

```tsx
// path: rental-app-main/src/components/ui/label.tsx

import * as React from "react"
import * as LabelPrimitive from "@radix-ui/react-label"
import { cva, type VariantProps } from "class-variance-authority"

import { cn } from "@/lib/utils"

const labelVariants = cva(
  "text-sm font-medium leading-none peer-disabled:cursor-not-allowed peer-disabled:opacity-70"
)

const Label = React.forwardRef<
  React.ElementRef<typeof LabelPrimitive.Root>,
  React.ComponentPropsWithoutRef<typeof LabelPrimitive.Root> &
    VariantProps<typeof labelVariants>
>(({ className, ...props }, ref) => (
  <LabelPrimitive.Root
    ref={ref}
    className={cn(labelVariants(), className)}
    {...props}
  />
))
Label.displayName = LabelPrimitive.Root.displayName

export { Label }


```


## <a name="rentalappmainsrccomponentsuimultiselecttsx"></a>`rental-app-main/src/components/ui/multi-select.tsx`

```tsx
// path: rental-app-main/src/components/ui/multi-select.tsx

// src/components/ui/multi-select.tsx

"use client";

import * as React from "react";
import { cva, type VariantProps } from "class-variance-authority";
import { X } from "lucide-react";

import { cn } from "@/lib/utils";
import { Badge } from "@/components/ui/badge";
import { Command, CommandList, CommandItem } from "@/components/ui/command"; // âœ… Ğ˜Ğ¡ĞŸĞ ĞĞ’Ğ›Ğ•ĞĞ: Ğ£Ğ±Ñ€Ğ°Ğ½ Ğ½ĞµĞ¸ÑĞ¿Ğ¾Ğ»ÑŒĞ·ÑƒĞµĞ¼Ñ‹Ğ¹ CommandGroup
import { Command as CommandPrimitive } from "cmdk";

const multiSelectVariants = cva(
    "m-0 flex flex-wrap gap-1 rounded-md border border-input bg-background p-1 text-sm ring-offset-background focus-within:ring-2 focus-within:ring-ring focus-within:ring-offset-2",
    {
        variants: {
            variant: {
                default: "h-10",
                compact: "h-auto min-h-10",
            },
        },
        defaultVariants: {
            variant: "default",
        },
    }
);

interface MultiSelectProps
    extends React.HTMLAttributes<HTMLDivElement>,
        VariantProps<typeof multiSelectVariants> {
    placeholder?: string;
    options: {
        label: string;
        value: string;
        icon?: React.ReactNode;
    }[];
    value: string[];
    onValueChange: (value: string[]) => void;
    disabled?: boolean;
    maxCount?: number;
}

const MultiSelect = React.forwardRef<
    // âœ… Ğ˜Ğ¡ĞŸĞ ĞĞ’Ğ›Ğ•ĞĞ: Ğ¢Ğ¸Ğ¿ ref Ğ¸Ğ·Ğ¼ĞµĞ½ĞµĞ½ Ğ½Ğ° HTMLInputElement
    HTMLInputElement,
    MultiSelectProps
>(
    (
        {
            placeholder,
            options,
            value,
            onValueChange,
            disabled,
            variant,
            maxCount = 5,
            className,
            ...props
        },
        ref
    ) => {
        const [open, setOpen] = React.useState(false);
        const [inputValue, setInputValue] = React.useState("");

        const handleSelect = (val: string) => {
            if (!value.includes(val)) {
                onValueChange([...value, val]);
            }
        };

        const handleDeselect = (val: string) => {
            onValueChange(value.filter((v) => v !== val));
        };

        const handleKeyDown = (e: React.KeyboardEvent<HTMLDivElement>) => {
            const input = e.currentTarget.querySelector("input");
            if (input) {
                if (e.key === "Delete" || e.key === "Backspace") {
                    if (input.value === "" && value.length > 0) {
                        handleDeselect(value[value.length - 1]);
                    }
                }
                if (e.key === "Escape") {
                    input.blur();
                }
            }
        };

        const selected = options.filter((opt) => value.includes(opt.value));
        const unselected = options.filter((opt) => !value.includes(opt.value));

        return (
            <Command
                onKeyDown={handleKeyDown}
                className="overflow-visible bg-transparent"
            >
                <div className={cn(multiSelectVariants({ variant }), className)}>
                    <div className="flex flex-wrap items-center gap-1">
                        {selected.map((option) => (
                            <Badge
                                key={option.value}
                                variant="secondary"
                                className="gap-1 whitespace-nowrap"
                            >
                                {option.label}
                                <button
                                    type="button"
                                    className="ml-1 rounded-full outline-none ring-offset-background focus:ring-2 focus:ring-ring focus:ring-offset-2"
                                    onKeyDown={(e) => {
                                        if (e.key === "Enter") handleDeselect(option.value);
                                    }}
                                    onMouseDown={(e) => {
                                        e.preventDefault();
                                        e.stopPropagation();
                                    }}
                                    onClick={() => handleDeselect(option.value)}
                                >
                                    <X className="h-3 w-3 text-muted-foreground hover:text-foreground" />
                                </button>
                            </Badge>
                        ))}
                        <CommandPrimitive.Input
                            ref={ref}
                            placeholder={selected.length > 0 ? "" : placeholder}
                            className="w-fit flex-1 bg-transparent p-1 outline-none placeholder:text-muted-foreground"
                            value={inputValue}
                            onValueChange={setInputValue}
                            onBlur={() => setOpen(false)}
                            onFocus={() => setOpen(true)}
                            disabled={disabled}
                            {...props}
                        />
                    </div>
                </div>
                <div className="relative mt-2">
                    {open && unselected.length > 0 ? (
                        <div className="absolute top-0 z-10 w-full rounded-md border bg-popover text-popover-foreground shadow-md outline-none animate-in">
                            <CommandList>
                                {unselected.map((option) => (
                                    <CommandItem
                                        key={option.value}
                                        onMouseDown={(e) => {
                                            e.preventDefault();
                                            e.stopPropagation();
                                        }}
                                        onSelect={() => handleSelect(option.value)}
                                        className="cursor-pointer"
                                    >
                                        {option.label}
                                    </CommandItem>
                                ))}
                            </CommandList>
                        </div>
                    ) : null}
                </div>
            </Command>
        );
    }
);

MultiSelect.displayName = "MultiSelect";

export { MultiSelect };

```


## <a name="rentalappmainsrccomponentsuiphoneinputmd"></a>`rental-app-main/src/components/ui/phone-input.md`

```markdown
// path: rental-app-main/src/components/ui/phone-input.md

# PhoneInput Component

ĞšĞ¾Ğ¼Ğ¿Ğ¾Ğ½ĞµĞ½Ñ‚ Ğ´Ğ»Ñ Ğ²Ğ²Ğ¾Ğ´Ğ° Ñ‚ĞµĞ»ĞµÑ„Ğ¾Ğ½Ğ½Ñ‹Ñ… Ğ½Ğ¾Ğ¼ĞµÑ€Ğ¾Ğ² Ñ Ğ°Ğ²Ñ‚Ğ¾Ğ¼Ğ°Ñ‚Ğ¸Ñ‡ĞµÑĞºĞ¸Ğ¼ Ñ„Ğ¾Ñ€Ğ¼Ğ°Ñ‚Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸ĞµĞ¼ Ğ¸ Ğ²Ğ°Ğ»Ğ¸Ğ´Ğ°Ñ†Ğ¸ĞµĞ¹.

## ĞÑĞ¾Ğ±ĞµĞ½Ğ½Ğ¾ÑÑ‚Ğ¸

- âœ… ĞĞ²Ñ‚Ğ¾Ğ¼Ğ°Ñ‚Ğ¸Ñ‡ĞµÑĞºĞ¾Ğµ Ñ„Ğ¾Ñ€Ğ¼Ğ°Ñ‚Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ Ñ€Ğ¾ÑÑĞ¸Ğ¹ÑĞºĞ¸Ñ… Ğ½Ğ¾Ğ¼ĞµÑ€Ğ¾Ğ² (+7 (XXX) XXX-XX-XX)
- âœ… ĞŸĞ¾Ğ´Ğ´ĞµÑ€Ğ¶ĞºĞ° Ğ¼ĞµĞ¶Ğ´ÑƒĞ½Ğ°Ñ€Ğ¾Ğ´Ğ½Ñ‹Ñ… Ğ½Ğ¾Ğ¼ĞµÑ€Ğ¾Ğ²
- âœ… Ğ’Ğ°Ğ»Ğ¸Ğ´Ğ°Ñ†Ğ¸Ñ Ğ² Ñ€ĞµĞ°Ğ»ÑŒĞ½Ğ¾Ğ¼ Ğ²Ñ€ĞµĞ¼ĞµĞ½Ğ¸
- âœ… Ğ¡Ğ¾Ğ²Ğ¼ĞµÑÑ‚Ğ¸Ğ¼Ğ¾ÑÑ‚ÑŒ Ñ react-hook-form
- âœ… Ğ”Ğ¾ÑÑ‚ÑƒĞ¿Ğ½Ğ¾ÑÑ‚ÑŒ (ARIA Ğ°Ñ‚Ñ€Ğ¸Ğ±ÑƒÑ‚Ñ‹)
- âœ… ĞŸĞ¾Ğ´Ğ´ĞµÑ€Ğ¶ĞºĞ° Ğ¾ÑˆĞ¸Ğ±Ğ¾Ğº Ğ¸ ÑĞ¾ÑÑ‚Ğ¾ÑĞ½Ğ¸Ğ¹
- âœ… ĞœĞµĞ¼Ğ¾Ğ¸Ğ·Ğ°Ñ†Ğ¸Ñ Ğ´Ğ»Ñ Ğ¾Ğ¿Ñ‚Ğ¸Ğ¼Ğ¸Ğ·Ğ°Ñ†Ğ¸Ğ¸ Ğ¿Ñ€Ğ¾Ğ¸Ğ·Ğ²Ğ¾Ğ´Ğ¸Ñ‚ĞµĞ»ÑŒĞ½Ğ¾ÑÑ‚Ğ¸

## Ğ˜ÑĞ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ

### Ğ‘Ğ°Ğ·Ğ¾Ğ²Ğ¾Ğµ Ğ¸ÑĞ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ

```tsx
import { PhoneInput } from "@/components/ui/phone-input";

function MyForm() {
  const [phone, setPhone] = useState("");

  return (
    <PhoneInput
      value={phone}
      onChange={(e) => setPhone(e.target.value)}
      placeholder="+7 (___) ___-__-__"
    />
  );
}
```

### Ğ¡ react-hook-form

```tsx
import { useForm } from "react-hook-form";
import { PhoneInput } from "@/components/ui/phone-input";

function MyForm() {
  const { register, handleSubmit } = useForm();

  return (
    <form onSubmit={handleSubmit(onSubmit)}>
      <PhoneInput
        {...register("phone")}
        placeholder="+7 (___) ___-__-__"
      />
    </form>
  );
}
```

### Ğ¡ Ğ²Ğ°Ğ»Ğ¸Ğ´Ğ°Ñ†Ğ¸ĞµĞ¹ Ğ¾ÑˆĞ¸Ğ±Ğ¾Ğº

```tsx
import { PhoneInput } from "@/components/ui/phone-input";

function MyForm() {
  const [phone, setPhone] = useState("");
  const [error, setError] = useState(false);

  return (
    <PhoneInput
      value={phone}
      onChange={(e) => setPhone(e.target.value)}
      error={error}
      placeholder="+7 (___) ___-__-__"
    />
  );
}
```

### Ğ¡ Ğ²Ğ°Ğ»Ğ¸Ğ´Ğ°Ñ†Ğ¸ĞµĞ¹ Ğ² Ñ€ĞµĞ°Ğ»ÑŒĞ½Ğ¾Ğ¼ Ğ²Ñ€ĞµĞ¼ĞµĞ½Ğ¸

```tsx
import { PhoneInput } from "@/components/ui/phone-input";
import { usePhoneValidation } from "@/hooks/usePhoneValidation";

function MyForm() {
  const [phone, setPhone] = useState("");
  const { isValid, error, validatePhone } = usePhoneValidation({
    required: true,
    onValidationChange: (isValid) => {
      console.log("Phone validation:", isValid);
    }
  });

  return (
    <div>
      <PhoneInput
        value={phone}
        onChange={(e) => {
          setPhone(e.target.value);
          validatePhone(e.target.value);
        }}
        error={!!error}
        placeholder="+7 (___) ___-__-__"
      />
      {error && <p className="text-red-500 text-sm">{error}</p>}
    </div>
  );
}
```

### ĞœĞµĞ¶Ğ´ÑƒĞ½Ğ°Ñ€Ğ¾Ğ´Ğ½Ñ‹Ğ¹ Ñ„Ğ¾Ñ€Ğ¼Ğ°Ñ‚

```tsx
import { PhoneInput } from "@/components/ui/phone-input";

function MyForm() {
  const [phone, setPhone] = useState("");

  return (
    <PhoneInput
      value={phone}
      onChange={(e) => setPhone(e.target.value)}
      format="international"
      placeholder="+X (XXX) XXX-XXXX"
    />
  );
}
```

## Props

| Prop | Ğ¢Ğ¸Ğ¿ | ĞŸĞ¾ ÑƒĞ¼Ğ¾Ğ»Ñ‡Ğ°Ğ½Ğ¸Ñ | ĞĞ¿Ğ¸ÑĞ°Ğ½Ğ¸Ğµ |
|------|-----|--------------|----------|
| `value` | `string` | - | Ğ—Ğ½Ğ°Ñ‡ĞµĞ½Ğ¸Ğµ Ğ¿Ğ¾Ğ»Ñ |
| `onChange` | `(e: ChangeEvent<HTMLInputElement>) => void` | - | ĞĞ±Ñ€Ğ°Ğ±Ğ¾Ñ‚Ñ‡Ğ¸Ğº Ğ¸Ğ·Ğ¼ĞµĞ½ĞµĞ½Ğ¸Ñ |
| `error` | `boolean` | `false` | ĞŸĞ¾ĞºĞ°Ğ·Ñ‹Ğ²Ğ°Ñ‚ÑŒ Ğ»Ğ¸ Ğ¾ÑˆĞ¸Ğ±ĞºÑƒ |
| `format` | `'russian' \| 'international'` | `'russian'` | Ğ¤Ğ¾Ñ€Ğ¼Ğ°Ñ‚ Ğ½Ğ¾Ğ¼ĞµÑ€Ğ° |
| `onValidationChange` | `(isValid: boolean) => void` | - | ĞšĞ¾Ğ»Ğ±ÑĞº Ğ¿Ñ€Ğ¸ Ğ¸Ğ·Ğ¼ĞµĞ½ĞµĞ½Ğ¸Ğ¸ Ğ²Ğ°Ğ»Ğ¸Ğ´Ğ½Ğ¾ÑÑ‚Ğ¸ |
| `className` | `string` | - | Ğ”Ğ¾Ğ¿Ğ¾Ğ»Ğ½Ğ¸Ñ‚ĞµĞ»ÑŒĞ½Ñ‹Ğµ CSS ĞºĞ»Ğ°ÑÑÑ‹ |
| `placeholder` | `string` | - | ĞŸĞ»ĞµĞ¹ÑÑ…Ğ¾Ğ»Ğ´ĞµÑ€ |
| `disabled` | `boolean` | `false` | ĞÑ‚ĞºĞ»ÑÑ‡ĞµĞ½Ğ¾ Ğ»Ğ¸ Ğ¿Ğ¾Ğ»Ğµ |
| `required` | `boolean` | `false` | ĞĞ±ÑĞ·Ğ°Ñ‚ĞµĞ»ÑŒĞ½Ğ¾Ğµ Ğ»Ğ¸ Ğ¿Ğ¾Ğ»Ğµ |

## Ğ¡Ğ¾Ğ±Ñ‹Ñ‚Ğ¸Ñ

ĞšĞ¾Ğ¼Ğ¿Ğ¾Ğ½ĞµĞ½Ñ‚ Ğ³ĞµĞ½ĞµÑ€Ğ¸Ñ€ÑƒĞµÑ‚ ÑÑ‚Ğ°Ğ½Ğ´Ğ°Ñ€Ñ‚Ğ½Ñ‹Ğµ ÑĞ¾Ğ±Ñ‹Ñ‚Ğ¸Ñ `ChangeEvent<HTMLInputElement>` Ñ Ğ´Ğ¾Ğ¿Ğ¾Ğ»Ğ½Ğ¸Ñ‚ĞµĞ»ÑŒĞ½Ñ‹Ğ¼Ğ¸ Ğ´Ğ°Ğ½Ğ½Ñ‹Ğ¼Ğ¸ Ğ² `target.dataset`:

- `isValid`: `boolean` - ÑĞ²Ğ»ÑĞµÑ‚ÑÑ Ğ»Ğ¸ Ğ½Ğ¾Ğ¼ĞµÑ€ Ğ¿Ğ¾Ğ»Ğ½Ñ‹Ğ¼ Ğ¸ Ğ²Ğ°Ğ»Ğ¸Ğ´Ğ½Ñ‹Ğ¼
- `unmaskedValue`: `string` - Ğ½Ğ¾Ğ¼ĞµÑ€ Ğ±ĞµĞ· Ñ„Ğ¾Ñ€Ğ¼Ğ°Ñ‚Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ

## Ğ’Ğ°Ğ»Ğ¸Ğ´Ğ°Ñ†Ğ¸Ñ

ĞšĞ¾Ğ¼Ğ¿Ğ¾Ğ½ĞµĞ½Ñ‚ Ğ¸ÑĞ¿Ğ¾Ğ»ÑŒĞ·ÑƒĞµÑ‚ Ğ²ÑÑ‚Ñ€Ğ¾ĞµĞ½Ğ½ÑƒÑ Ğ²Ğ°Ğ»Ğ¸Ğ´Ğ°Ñ†Ğ¸Ñ Ñ‡ĞµÑ€ĞµĞ· `react-imask` Ğ¸ Ğ´Ğ¾Ğ¿Ğ¾Ğ»Ğ½Ğ¸Ñ‚ĞµĞ»ÑŒĞ½Ñ‹Ğµ ÑƒÑ‚Ğ¸Ğ»Ğ¸Ñ‚Ñ‹ Ğ¸Ğ· `@/utils/phoneUtils`:

- ĞŸÑ€Ğ¾Ğ²ĞµÑ€ĞºĞ° Ñ„Ğ¾Ñ€Ğ¼Ğ°Ñ‚Ğ° Ğ½Ğ¾Ğ¼ĞµÑ€Ğ°
- ĞŸÑ€Ğ¾Ğ²ĞµÑ€ĞºĞ° Ğ¿Ğ¾Ğ»Ğ½Ğ¾Ñ‚Ñ‹ Ğ½Ğ¾Ğ¼ĞµÑ€Ğ°
- ĞŸĞ¾Ğ´Ğ´ĞµÑ€Ğ¶ĞºĞ° Ñ€Ğ¾ÑÑĞ¸Ğ¹ÑĞºĞ¸Ñ… (+7) Ğ¸ Ğ¼ĞµĞ¶Ğ´ÑƒĞ½Ğ°Ñ€Ğ¾Ğ´Ğ½Ñ‹Ñ… Ğ½Ğ¾Ğ¼ĞµÑ€Ğ¾Ğ²
- ĞĞ²Ñ‚Ğ¾Ğ¼Ğ°Ñ‚Ğ¸Ñ‡ĞµÑĞºĞ°Ñ Ğ½Ğ¾Ñ€Ğ¼Ğ°Ğ»Ğ¸Ğ·Ğ°Ñ†Ğ¸Ñ

## Ğ”Ğ¾ÑÑ‚ÑƒĞ¿Ğ½Ğ¾ÑÑ‚ÑŒ

ĞšĞ¾Ğ¼Ğ¿Ğ¾Ğ½ĞµĞ½Ñ‚ Ğ²ĞºĞ»ÑÑ‡Ğ°ĞµÑ‚ ÑĞ»ĞµĞ´ÑƒÑÑ‰Ğ¸Ğµ ARIA Ğ°Ñ‚Ñ€Ğ¸Ğ±ÑƒÑ‚Ñ‹:

- `aria-invalid`: ÑƒĞºĞ°Ğ·Ñ‹Ğ²Ğ°ĞµÑ‚ Ğ½Ğ° Ğ½Ğ°Ğ»Ğ¸Ñ‡Ğ¸Ğµ Ğ¾ÑˆĞ¸Ğ±ĞºĞ¸
- `aria-describedby`: ÑĞ²ÑĞ·Ñ‹Ğ²Ğ°ĞµÑ‚ Ñ ÑĞ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸ĞµĞ¼ Ğ¾Ğ± Ğ¾ÑˆĞ¸Ğ±ĞºĞµ
- `inputMode="tel"`: Ğ¿Ğ¾ĞºĞ°Ğ·Ñ‹Ğ²Ğ°ĞµÑ‚ Ñ†Ğ¸Ñ„Ñ€Ğ¾Ğ²ÑƒÑ ĞºĞ»Ğ°Ğ²Ğ¸Ğ°Ñ‚ÑƒÑ€Ñƒ Ğ½Ğ° Ğ¼Ğ¾Ğ±Ğ¸Ğ»ÑŒĞ½Ñ‹Ñ… ÑƒÑÑ‚Ñ€Ğ¾Ğ¹ÑÑ‚Ğ²Ğ°Ñ…
- `autoComplete="tel"`: Ğ¿Ğ¾Ğ¼Ğ¾Ğ³Ğ°ĞµÑ‚ Ğ±Ñ€Ğ°ÑƒĞ·ĞµÑ€Ñƒ Ğ°Ğ²Ñ‚Ğ¾Ğ·Ğ°Ğ¿Ğ¾Ğ»Ğ½Ğ¸Ñ‚ÑŒ Ğ¿Ğ¾Ğ»Ğµ

## Ğ£Ñ‚Ğ¸Ğ»Ğ¸Ñ‚Ñ‹

Ğ”Ğ»Ñ Ñ€Ğ°Ğ±Ğ¾Ñ‚Ñ‹ Ñ Ñ‚ĞµĞ»ĞµÑ„Ğ¾Ğ½Ğ½Ñ‹Ğ¼Ğ¸ Ğ½Ğ¾Ğ¼ĞµÑ€Ğ°Ğ¼Ğ¸ Ğ´Ğ¾ÑÑ‚ÑƒĞ¿Ğ½Ñ‹ ÑƒÑ‚Ğ¸Ğ»Ğ¸Ñ‚Ñ‹ Ğ² `@/utils/phoneUtils`:

```tsx
import { 
  validateRussianPhone,
  formatPhone,
  normalizePhone,
  isPhoneComplete 
} from "@/utils/phoneUtils";

// Ğ’Ğ°Ğ»Ğ¸Ğ´Ğ°Ñ†Ğ¸Ñ
const isValid = validateRussianPhone("+7 (999) 123-45-67");

// Ğ¤Ğ¾Ñ€Ğ¼Ğ°Ñ‚Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ
const formatted = formatPhone("79991234567");

// ĞĞ¾Ñ€Ğ¼Ğ°Ğ»Ğ¸Ğ·Ğ°Ñ†Ğ¸Ñ
const normalized = normalizePhone("8 (999) 123-45-67");

// ĞŸÑ€Ğ¾Ğ²ĞµÑ€ĞºĞ° Ğ¿Ğ¾Ğ»Ğ½Ğ¾Ñ‚Ñ‹
const isComplete = isPhoneComplete("+7 (999) 123-45-67");
```

## Ğ¥ÑƒĞºĞ¸

Ğ”Ğ»Ñ Ğ²Ğ°Ğ»Ğ¸Ğ´Ğ°Ñ†Ğ¸Ğ¸ Ğ² Ñ€ĞµĞ°Ğ»ÑŒĞ½Ğ¾Ğ¼ Ğ²Ñ€ĞµĞ¼ĞµĞ½Ğ¸ Ğ¸ÑĞ¿Ğ¾Ğ»ÑŒĞ·ÑƒĞ¹Ñ‚Ğµ Ñ…ÑƒĞºĞ¸ Ğ¸Ğ· `@/hooks/usePhoneValidation`:

```tsx
import { usePhoneValidation, usePhoneValidationWithDebounce } from "@/hooks/usePhoneValidation";

// ĞĞ±Ñ‹Ñ‡Ğ½Ğ°Ñ Ğ²Ğ°Ğ»Ğ¸Ğ´Ğ°Ñ†Ğ¸Ñ
const { isValid, error, validatePhone } = usePhoneValidation({
  required: true
});

// Ğ’Ğ°Ğ»Ğ¸Ğ´Ğ°Ñ†Ğ¸Ñ Ñ debounce
const { debouncedValidate } = usePhoneValidationWithDebounce({
  debounceMs: 500
});
``` 

```


## <a name="rentalappmainsrccomponentsuiphoneinputtsx"></a>`rental-app-main/src/components/ui/phone-input.tsx`

```tsx
// path: rental-app-main/src/components/ui/phone-input.tsx

// src/components/ui/phone-input.tsx

import * as React from "react";
import { useIMask } from "react-imask";
import { Input } from "@/components/ui/input";
import { cn } from "@/lib/utils";

// Ğ£Ğ»ÑƒÑ‡ÑˆĞµĞ½Ğ½Ğ°Ñ Ñ‚Ğ¸Ğ¿Ğ¸Ğ·Ğ°Ñ†Ğ¸Ñ Ñ Ğ¿Ğ¾Ğ´Ğ´ĞµÑ€Ğ¶ĞºĞ¾Ğ¹ Ğ²ÑĞµÑ… Ğ²Ğ¾Ğ·Ğ¼Ğ¾Ğ¶Ğ½Ñ‹Ñ… Ğ¿Ñ€Ğ¾Ğ¿ÑĞ¾Ğ² Input
interface PhoneInputProps extends Omit<React.InputHTMLAttributes<HTMLInputElement>, 'onChange'> {
    error?: boolean;
    onChange?: (e: React.ChangeEvent<HTMLInputElement>) => void;
    // Ğ”Ğ¾Ğ±Ğ°Ğ²Ğ»ÑĞµĞ¼ Ğ¿Ğ¾Ğ´Ğ´ĞµÑ€Ğ¶ĞºÑƒ Ñ€Ğ°Ğ·Ğ»Ğ¸Ñ‡Ğ½Ñ‹Ñ… Ñ„Ğ¾Ñ€Ğ¼Ğ°Ñ‚Ğ¾Ğ² Ñ‚ĞµĞ»ĞµÑ„Ğ¾Ğ½Ğ¾Ğ²
    format?: 'russian' | 'international';
    // Ğ”Ğ¾Ğ±Ğ°Ğ²Ğ»ÑĞµĞ¼ Ğ¿Ğ¾Ğ´Ğ´ĞµÑ€Ğ¶ĞºÑƒ Ğ²Ğ°Ğ»Ğ¸Ğ´Ğ°Ñ†Ğ¸Ğ¸ Ğ² Ñ€ĞµĞ°Ğ»ÑŒĞ½Ğ¾Ğ¼ Ğ²Ñ€ĞµĞ¼ĞµĞ½Ğ¸
    onValidationChange?: (isValid: boolean) => void;
}

const PhoneInput = React.forwardRef<HTMLInputElement, PhoneInputProps>(
    ({ 
        onChange, 
        error, 
        format = 'russian',
        onValidationChange,
        className,
        ...props 
    }, ref) => {
        // ĞĞ¿Ñ€ĞµĞ´ĞµĞ»ÑĞµĞ¼ Ğ¼Ğ°ÑĞºÑƒ Ğ² Ğ·Ğ°Ğ²Ğ¸ÑĞ¸Ğ¼Ğ¾ÑÑ‚Ğ¸ Ğ¾Ñ‚ Ñ„Ğ¾Ñ€Ğ¼Ğ°Ñ‚Ğ°
        const maskConfig = format === 'russian' 
            ? { 
                mask: "+7 (000) 000-00-00",
                lazy: false,
                placeholderChar: '_'
              }
            : { 
                mask: "+{1}(000)000-0000",
                lazy: false,
                placeholderChar: '_'
              };

        const { ref: imaskRef, value: maskedValue, setValue } = useIMask(
            maskConfig,
            {
                onAccept: (value: any, mask: any) => {
                    console.log('PhoneInput onAccept:', { value, maskedValue, isComplete: mask.masked.isComplete });
                    
                    if (onChange) {
                        // Ğ¡Ğ¾Ğ·Ğ´Ğ°ĞµĞ¼ Ğ¿Ñ€Ğ¾ÑÑ‚Ğ¾Ğµ ÑĞ¾Ğ±Ñ‹Ñ‚Ğ¸Ğµ Ñ Ğ½ĞµĞ¾Ğ±Ñ…Ğ¾Ğ´Ğ¸Ğ¼Ñ‹Ğ¼Ğ¸ ÑĞ²Ğ¾Ğ¹ÑÑ‚Ğ²Ğ°Ğ¼Ğ¸
                        const event = {
                            target: {
                                name: props.name,
                                value: value,
                            },
                        } as unknown as React.ChangeEvent<HTMLInputElement>;
                        
                        onChange(event);
                    }

                    // Ğ£Ğ²ĞµĞ´Ğ¾Ğ¼Ğ»ÑĞµĞ¼ Ğ¾ ÑĞ¾ÑÑ‚Ğ¾ÑĞ½Ğ¸Ğ¸ Ğ²Ğ°Ğ»Ğ¸Ğ´Ğ°Ñ†Ğ¸Ğ¸
                    if (onValidationChange) {
                        onValidationChange(mask.masked.isComplete);
                    }
                }
            }
        );

        // Ğ¡Ğ¸Ğ½Ñ…Ñ€Ğ¾Ğ½Ğ¸Ğ·Ğ¸Ñ€ÑƒĞµĞ¼ Ğ²Ğ½ĞµÑˆĞ½ĞµĞµ Ğ·Ğ½Ğ°Ñ‡ĞµĞ½Ğ¸Ğµ Ñ Ğ¼Ğ°ÑĞºĞ¾Ğ¹
        React.useEffect(() => {
            const currentValue = props.value as string || '';
            if (currentValue !== maskedValue) {
                setValue(currentValue);
            }
        }, [props.value, maskedValue, setValue]);

        // ĞĞ±Ñ€Ğ°Ğ±Ğ¾Ñ‚Ñ‡Ğ¸Ğº Ğ¸Ğ·Ğ¼ĞµĞ½ĞµĞ½Ğ¸Ñ Ğ·Ğ½Ğ°Ñ‡ĞµĞ½Ğ¸Ñ
        const handleChange = React.useCallback((e: React.ChangeEvent<HTMLInputElement>) => {
            setValue(e.target.value);
        }, [setValue]);

        // ĞœĞµĞ¼Ğ¾Ğ¸Ğ·Ğ¸Ñ€ÑƒĞµĞ¼ Ñ„ÑƒĞ½ĞºÑ†Ğ¸Ñ ÑƒÑÑ‚Ğ°Ğ½Ğ¾Ğ²ĞºĞ¸ refs Ğ´Ğ»Ñ Ğ¾Ğ¿Ñ‚Ğ¸Ğ¼Ğ¸Ğ·Ğ°Ñ†Ğ¸Ğ¸
        const setRefs = React.useCallback(
            (node: HTMLInputElement | null) => {
                // Ref Ğ¾Ñ‚ useIMask
                (imaskRef as React.MutableRefObject<HTMLInputElement | null>).current = node;

                // Ğ’Ğ½ĞµÑˆĞ½Ğ¸Ğ¹ ref Ğ¾Ñ‚ react-hook-form
                if (typeof ref === 'function') {
                    ref(node);
                } else if (ref) {
                    ref.current = node;
                }
            },
            [ref, imaskRef]
        );

        // Ğ”Ğ¾Ğ±Ğ°Ğ²Ğ»ÑĞµĞ¼ aria-Ğ°Ñ‚Ñ€Ğ¸Ğ±ÑƒÑ‚Ñ‹ Ğ´Ğ»Ñ Ğ»ÑƒÑ‡ÑˆĞµĞ¹ Ğ´Ğ¾ÑÑ‚ÑƒĞ¿Ğ½Ğ¾ÑÑ‚Ğ¸
        const accessibilityProps = {
            'aria-invalid': error ? true : false,
            'aria-describedby': error ? `${props.id}-error` : undefined,
            'inputMode': 'tel' as const,
            'autoComplete': 'tel' as const,
        };

        return (
            <Input
                {...props}
                {...accessibilityProps}
                ref={setRefs}
                value={maskedValue || ''}
                onChange={handleChange}
                className={cn(
                    error && "border-red-500 focus-visible:ring-red-500",
                    className
                )}
            />
        );
    }
);

PhoneInput.displayName = "PhoneInput";

export { PhoneInput };
export type { PhoneInputProps };

```


## <a name="rentalappmainsrccomponentsuipopovertsx"></a>`rental-app-main/src/components/ui/popover.tsx`

```tsx
// path: rental-app-main/src/components/ui/popover.tsx

import * as React from "react"
import * as PopoverPrimitive from "@radix-ui/react-popover"

import { cn } from "@/lib/utils"

const Popover = PopoverPrimitive.Root

const PopoverTrigger = PopoverPrimitive.Trigger

const PopoverAnchor = PopoverPrimitive.Anchor

const PopoverContent = React.forwardRef<
  React.ElementRef<typeof PopoverPrimitive.Content>,
  React.ComponentPropsWithoutRef<typeof PopoverPrimitive.Content>
>(({ className, align = "center", sideOffset = 4, ...props }, ref) => (
  <PopoverPrimitive.Portal>
    <PopoverPrimitive.Content
      ref={ref}
      align={align}
      sideOffset={sideOffset}
      className={cn(
        "z-50 w-72 rounded-md border bg-popover p-4 text-popover-foreground shadow-md outline-none data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2 origin-[--radix-popover-content-transform-origin]",
        className
      )}
      {...props}
    />
  </PopoverPrimitive.Portal>
))
PopoverContent.displayName = PopoverPrimitive.Content.displayName

export { Popover, PopoverTrigger, PopoverContent, PopoverAnchor }


```


## <a name="rentalappmainsrccomponentsuiscrollareatsx"></a>`rental-app-main/src/components/ui/scroll-area.tsx`

```tsx
// path: rental-app-main/src/components/ui/scroll-area.tsx

// src/components/ui/scroll-area.tsx

import * as React from "react"
import * as ScrollAreaPrimitive from "@radix-ui/react-scroll-area"

import { cn } from "@/lib/utils"

const ScrollArea = React.forwardRef<
    React.ElementRef<typeof ScrollAreaPrimitive.Root>,
    React.ComponentPropsWithoutRef<typeof ScrollAreaPrimitive.Root>
>(({ className, children, ...props }, ref) => (
    <ScrollAreaPrimitive.Root
        ref={ref}
        className={cn("relative overflow-hidden", className)}
        {...props}
    >
        <ScrollAreaPrimitive.Viewport className="h-full w-full rounded-[inherit]">
            {children}
        </ScrollAreaPrimitive.Viewport>
        <ScrollBar />
        <ScrollAreaPrimitive.Corner />
    </ScrollAreaPrimitive.Root>
))
ScrollArea.displayName = ScrollAreaPrimitive.Root.displayName

const ScrollBar = React.forwardRef<
    React.ElementRef<typeof ScrollAreaPrimitive.Scrollbar>,
    React.ComponentPropsWithoutRef<typeof ScrollAreaPrimitive.Scrollbar>
>(({ className, orientation = "vertical", ...props }, ref) => (
    <ScrollAreaPrimitive.Scrollbar
        ref={ref}
        orientation={orientation}
        className={cn(
            "flex touch-none select-none transition-colors",
            orientation === "vertical" &&
            "h-full w-2.5 border-l border-l-transparent p-[1px]",
            orientation === "horizontal" &&
            "h-2.5 flex-col border-t border-t-transparent p-[1px]",
            className
        )}
        {...props}
    >
        <ScrollAreaPrimitive.Thumb className="relative flex-1 rounded-full bg-border" />
    </ScrollAreaPrimitive.Scrollbar>
))
ScrollBar.displayName = ScrollAreaPrimitive.Scrollbar.displayName

export { ScrollArea, ScrollBar }

```


## <a name="rentalappmainsrccomponentsuiselecttsx"></a>`rental-app-main/src/components/ui/select.tsx`

```tsx
// path: rental-app-main/src/components/ui/select.tsx

import * as React from "react"
import * as SelectPrimitive from "@radix-ui/react-select"
import { Check, ChevronDown, ChevronUp } from "lucide-react"

import { cn } from "@/lib/utils"

const Select = SelectPrimitive.Root

const SelectGroup = SelectPrimitive.Group

const SelectValue = SelectPrimitive.Value

const SelectTrigger = React.forwardRef<
  React.ElementRef<typeof SelectPrimitive.Trigger>,
  React.ComponentPropsWithoutRef<typeof SelectPrimitive.Trigger>
>(({ className, children, ...props }, ref) => (
  <SelectPrimitive.Trigger
    ref={ref}
    className={cn(
      "flex h-9 w-full items-center justify-between whitespace-nowrap rounded-md border border-input bg-transparent px-3 py-2 text-sm shadow-sm ring-offset-background data-[placeholder]:text-muted-foreground focus:outline-none focus:ring-1 focus:ring-ring disabled:cursor-not-allowed disabled:opacity-50 [&>span]:line-clamp-1",
      className
    )}
    {...props}
  >
    {children}
    <SelectPrimitive.Icon asChild>
      <ChevronDown className="h-4 w-4 opacity-50" />
    </SelectPrimitive.Icon>
  </SelectPrimitive.Trigger>
))
SelectTrigger.displayName = SelectPrimitive.Trigger.displayName

const SelectScrollUpButton = React.forwardRef<
  React.ElementRef<typeof SelectPrimitive.ScrollUpButton>,
  React.ComponentPropsWithoutRef<typeof SelectPrimitive.ScrollUpButton>
>(({ className, ...props }, ref) => (
  <SelectPrimitive.ScrollUpButton
    ref={ref}
    className={cn(
      "flex cursor-default items-center justify-center py-1",
      className
    )}
    {...props}
  >
    <ChevronUp className="h-4 w-4" />
  </SelectPrimitive.ScrollUpButton>
))
SelectScrollUpButton.displayName = SelectPrimitive.ScrollUpButton.displayName

const SelectScrollDownButton = React.forwardRef<
  React.ElementRef<typeof SelectPrimitive.ScrollDownButton>,
  React.ComponentPropsWithoutRef<typeof SelectPrimitive.ScrollDownButton>
>(({ className, ...props }, ref) => (
  <SelectPrimitive.ScrollDownButton
    ref={ref}
    className={cn(
      "flex cursor-default items-center justify-center py-1",
      className
    )}
    {...props}
  >
    <ChevronDown className="h-4 w-4" />
  </SelectPrimitive.ScrollDownButton>
))
SelectScrollDownButton.displayName =
  SelectPrimitive.ScrollDownButton.displayName

const SelectContent = React.forwardRef<
  React.ElementRef<typeof SelectPrimitive.Content>,
  React.ComponentPropsWithoutRef<typeof SelectPrimitive.Content>
>(({ className, children, position = "popper", ...props }, ref) => (
  <SelectPrimitive.Portal>
    <SelectPrimitive.Content
      ref={ref}
      className={cn(
        "relative z-50 max-h-[--radix-select-content-available-height] min-w-[8rem] overflow-y-auto overflow-x-hidden rounded-md border bg-popover text-popover-foreground shadow-md data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2 origin-[--radix-select-content-transform-origin]",
        position === "popper" &&
          "data-[side=bottom]:translate-y-1 data-[side=left]:-translate-x-1 data-[side=right]:translate-x-1 data-[side=top]:-translate-y-1",
        className
      )}
      position={position}
      {...props}
    >
      <SelectScrollUpButton />
      <SelectPrimitive.Viewport
        className={cn(
          "p-1",
          position === "popper" &&
            "h-[var(--radix-select-trigger-height)] w-full min-w-[var(--radix-select-trigger-width)]"
        )}
      >
        {children}
      </SelectPrimitive.Viewport>
      <SelectScrollDownButton />
    </SelectPrimitive.Content>
  </SelectPrimitive.Portal>
))
SelectContent.displayName = SelectPrimitive.Content.displayName

const SelectLabel = React.forwardRef<
  React.ElementRef<typeof SelectPrimitive.Label>,
  React.ComponentPropsWithoutRef<typeof SelectPrimitive.Label>
>(({ className, ...props }, ref) => (
  <SelectPrimitive.Label
    ref={ref}
    className={cn("px-2 py-1.5 text-sm font-semibold", className)}
    {...props}
  />
))
SelectLabel.displayName = SelectPrimitive.Label.displayName

const SelectItem = React.forwardRef<
  React.ElementRef<typeof SelectPrimitive.Item>,
  React.ComponentPropsWithoutRef<typeof SelectPrimitive.Item>
>(({ className, children, ...props }, ref) => (
  <SelectPrimitive.Item
    ref={ref}
    className={cn(
      "relative flex w-full cursor-default select-none items-center rounded-sm py-1.5 pl-2 pr-8 text-sm outline-none focus:bg-accent focus:text-accent-foreground data-[disabled]:pointer-events-none data-[disabled]:opacity-50",
      className
    )}
    {...props}
  >
    <span className="absolute right-2 flex h-3.5 w-3.5 items-center justify-center">
      <SelectPrimitive.ItemIndicator>
        <Check className="h-4 w-4" />
      </SelectPrimitive.ItemIndicator>
    </span>
    <SelectPrimitive.ItemText>{children}</SelectPrimitive.ItemText>
  </SelectPrimitive.Item>
))
SelectItem.displayName = SelectPrimitive.Item.displayName

const SelectSeparator = React.forwardRef<
  React.ElementRef<typeof SelectPrimitive.Separator>,
  React.ComponentPropsWithoutRef<typeof SelectPrimitive.Separator>
>(({ className, ...props }, ref) => (
  <SelectPrimitive.Separator
    ref={ref}
    className={cn("-mx-1 my-1 h-px bg-muted", className)}
    {...props}
  />
))
SelectSeparator.displayName = SelectPrimitive.Separator.displayName

export {
  Select,
  SelectGroup,
  SelectValue,
  SelectTrigger,
  SelectContent,
  SelectLabel,
  SelectItem,
  SelectSeparator,
  SelectScrollUpButton,
  SelectScrollDownButton,
}


```


## <a name="rentalappmainsrccomponentsuiskeletontsx"></a>`rental-app-main/src/components/ui/skeleton.tsx`

```tsx
// path: rental-app-main/src/components/ui/skeleton.tsx

import * as React from "react"
import { cn } from "@/lib/utils"

function Skeleton({
  className,
  ...props
}: React.HTMLAttributes<HTMLDivElement>) {
  return (
    <div
      className={cn("animate-pulse rounded-md bg-muted", className)}
      {...props}
    />
  )
}

export { Skeleton }


```


## <a name="rentalappmainsrccomponentsuiswitchtsx"></a>`rental-app-main/src/components/ui/switch.tsx`

```tsx
// path: rental-app-main/src/components/ui/switch.tsx

import * as React from "react"
import * as SwitchPrimitives from "@radix-ui/react-switch"

import { cn } from "@/lib/utils"

const Switch = React.forwardRef<
  React.ElementRef<typeof SwitchPrimitives.Root>,
  React.ComponentPropsWithoutRef<typeof SwitchPrimitives.Root>
>(({ className, ...props }, ref) => (
  <SwitchPrimitives.Root
    className={cn(
      "peer inline-flex h-5 w-9 shrink-0 cursor-pointer items-center rounded-full border-2 border-transparent shadow-sm transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 focus-visible:ring-offset-background disabled:cursor-not-allowed disabled:opacity-50 data-[state=checked]:bg-primary data-[state=unchecked]:bg-input",
      className
    )}
    {...props}
    ref={ref}
  >
    <SwitchPrimitives.Thumb
      className={cn(
        "pointer-events-none block h-4 w-4 rounded-full bg-background shadow-lg ring-0 transition-transform data-[state=checked]:translate-x-4 data-[state=unchecked]:translate-x-0"
      )}
    />
  </SwitchPrimitives.Root>
))
Switch.displayName = SwitchPrimitives.Root.displayName

export { Switch }


```


## <a name="rentalappmainsrccomponentsuitabletsx"></a>`rental-app-main/src/components/ui/table.tsx`

```tsx
// path: rental-app-main/src/components/ui/table.tsx

//src/components/ui/table.tsx


import * as React from "react";
import { cn } from "@/lib/utils";

const Table = React.forwardRef<
    HTMLTableElement,
    React.HTMLAttributes<HTMLTableElement>
>(({ className, ...props }, ref) => (
    <div className="relative w-full overflow-auto">
        <table
            ref={ref}
            className={cn("w-full caption-bottom text-sm", className)}
            {...props}
        />
    </div>
));
Table.displayName = "Table";

const TableHeader = React.forwardRef<
    HTMLTableSectionElement,
    React.HTMLAttributes<HTMLTableSectionElement>
>(({ className, ...props }, ref) => (
    <thead ref={ref} className={cn("[&_tr]:border-b", className)} {...props} />
));
TableHeader.displayName = "TableHeader";

const TableBody = React.forwardRef<
    HTMLTableSectionElement,
    React.HTMLAttributes<HTMLTableSectionElement>
>(({ className, ...props }, ref) => (
    <tbody
        ref={ref}
        className={cn("[&_tr:last-child]:border-0", className)}
        {...props}
    />
));
TableBody.displayName = "TableBody";

const TableFooter = React.forwardRef<
    HTMLTableSectionElement,
    React.HTMLAttributes<HTMLTableSectionElement>
>(({ className, ...props }, ref) => (
    <tfoot
        ref={ref}
        className={cn(
            "border-t bg-muted/50 font-medium [&>tr]:last:border-b-0",
            className
        )}
        {...props}
    />
));
TableFooter.displayName = "TableFooter";

const TableRow = React.forwardRef<
    HTMLTableRowElement,
    React.HTMLAttributes<HTMLTableRowElement>
>(({ className, ...props }, ref) => (
    <tr
        ref={ref}
        className={cn(
            "border-b transition-colors hover:bg-muted/50 data-[state=selected]:bg-muted",
            className
        )}
        {...props}
    />
));
TableRow.displayName = "TableRow";

const TableHead = React.forwardRef<
    HTMLTableCellElement,
    React.ThHTMLAttributes<HTMLTableCellElement>
>(({ className, ...props }, ref) => (
    <th
        ref={ref}
        className={cn(
            "h-12 px-4 text-left align-middle font-medium text-muted-foreground [&:has([role=checkbox])]:pr-0",
            className
        )}
        {...props}
    />
));
TableHead.displayName = "TableHead";

const TableCell = React.forwardRef<
    HTMLTableCellElement,
    React.TdHTMLAttributes<HTMLTableCellElement>
>(({ className, ...props }, ref) => (
    <td
        ref={ref}
        className={cn("p-4 align-middle [&:has([role=checkbox])]:pr-0", className)}
        {...props}
    />
));
TableCell.displayName = "TableCell";

const TableCaption = React.forwardRef<
    HTMLTableCaptionElement,
    React.HTMLAttributes<HTMLTableCaptionElement>
>(({ className, ...props }, ref) => (
    <caption
        ref={ref}
        className={cn("mt-4 text-sm text-muted-foreground", className)}
        {...props}
    />
));
TableCaption.displayName = "TableCaption";

export {
    Table,
    TableHeader,
    TableBody,
    TableFooter,
    TableHead,
    TableRow,
    TableCell,
    TableCaption,
};


```


## <a name="rentalappmainsrccomponentsuitextareatsx"></a>`rental-app-main/src/components/ui/textarea.tsx`

```tsx
// path: rental-app-main/src/components/ui/textarea.tsx

import * as React from "react"

import { cn } from "@/lib/utils"

const Textarea = React.forwardRef<
  HTMLTextAreaElement,
  React.ComponentProps<"textarea">
>(({ className, ...props }, ref) => {
  return (
    <textarea
      className={cn(
        "flex min-h-[60px] w-full rounded-md border border-input bg-transparent px-3 py-2 text-base shadow-sm placeholder:text-muted-foreground focus-visible:outline-none focus-visible:ring-1 focus-visible:ring-ring disabled:cursor-not-allowed disabled:opacity-50 md:text-sm",
        className
      )}
      ref={ref}
      {...props}
    />
  )
})
Textarea.displayName = "Textarea"

export { Textarea }


```


## <a name="rentalappmainsrccomponentsuitogglegrouptsx"></a>`rental-app-main/src/components/ui/toggle-group.tsx`

```tsx
// path: rental-app-main/src/components/ui/toggle-group.tsx

"use client"

import * as React from "react"
import * as ToggleGroupPrimitive from "@radix-ui/react-toggle-group"
import { type VariantProps } from "class-variance-authority"

import { cn } from "@/lib/utils"
import { toggleVariants } from "@/components/ui/toggle"

const ToggleGroupContext = React.createContext<
  VariantProps<typeof toggleVariants>
>({
  size: "default",
  variant: "default",
})

const ToggleGroup = React.forwardRef<
  React.ElementRef<typeof ToggleGroupPrimitive.Root>,
  React.ComponentPropsWithoutRef<typeof ToggleGroupPrimitive.Root> &
    VariantProps<typeof toggleVariants>
>(({ className, variant, size, children, ...props }, ref) => (
  <ToggleGroupPrimitive.Root
    ref={ref}
    className={cn("flex items-center justify-center gap-1", className)}
    {...props}
  >
    <ToggleGroupContext.Provider value={{ variant, size }}>
      {children}
    </ToggleGroupContext.Provider>
  </ToggleGroupPrimitive.Root>
))

ToggleGroup.displayName = ToggleGroupPrimitive.Root.displayName

const ToggleGroupItem = React.forwardRef<
  React.ElementRef<typeof ToggleGroupPrimitive.Item>,
  React.ComponentPropsWithoutRef<typeof ToggleGroupPrimitive.Item> &
    VariantProps<typeof toggleVariants>
>(({ className, children, variant, size, ...props }, ref) => {
  const context = React.useContext(ToggleGroupContext)

  return (
    <ToggleGroupPrimitive.Item
      ref={ref}
      className={cn(
        toggleVariants({
          variant: context.variant || variant,
          size: context.size || size,
        }),
        className
      )}
      {...props}
    >
      {children}
    </ToggleGroupPrimitive.Item>
  )
})

ToggleGroupItem.displayName = ToggleGroupPrimitive.Item.displayName

export { ToggleGroup, ToggleGroupItem }


```


## <a name="rentalappmainsrccomponentsuitoggletsx"></a>`rental-app-main/src/components/ui/toggle.tsx`

```tsx
// path: rental-app-main/src/components/ui/toggle.tsx

import * as React from "react"
import * as TogglePrimitive from "@radix-ui/react-toggle"
import { cva, type VariantProps } from "class-variance-authority"

import { cn } from "@/lib/utils"

const toggleVariants = cva(
  "inline-flex items-center justify-center gap-2 rounded-md text-sm font-medium transition-colors hover:bg-muted hover:text-muted-foreground focus-visible:outline-none focus-visible:ring-1 focus-visible:ring-ring disabled:pointer-events-none disabled:opacity-50 data-[state=on]:bg-accent data-[state=on]:text-accent-foreground [&_svg]:pointer-events-none [&_svg]:size-4 [&_svg]:shrink-0",
  {
    variants: {
      variant: {
        default: "bg-transparent",
        outline:
          "border border-input bg-transparent shadow-sm hover:bg-accent hover:text-accent-foreground",
      },
      size: {
        default: "h-9 px-2 min-w-9",
        sm: "h-8 px-1.5 min-w-8",
        lg: "h-10 px-2.5 min-w-10",
      },
    },
    defaultVariants: {
      variant: "default",
      size: "default",
    },
  }
)

const Toggle = React.forwardRef<
  React.ElementRef<typeof TogglePrimitive.Root>,
  React.ComponentPropsWithoutRef<typeof TogglePrimitive.Root> &
    VariantProps<typeof toggleVariants>
>(({ className, variant, size, ...props }, ref) => (
  <TogglePrimitive.Root
    ref={ref}
    className={cn(toggleVariants({ variant, size, className }))}
    {...props}
  />
))

Toggle.displayName = TogglePrimitive.Root.displayName

export { Toggle, toggleVariants }


```


## <a name="rentalappmainsrcconstantsequipmentConstantsts"></a>`rental-app-main/src/constants/equipmentConstants.ts`

```typescript
// path: rental-app-main/src/constants/equipmentConstants.ts

// src/constants/equipmentConstants.ts

/**
 * Ğ¡Ğ¿Ğ¸ÑĞ¾Ğº Ğ²Ğ¾Ğ·Ğ¼Ğ¾Ğ¶Ğ½Ñ‹Ñ… ÑĞ¾ÑÑ‚Ğ¾ÑĞ½Ğ¸Ğ¹ Ğ¾Ğ±Ğ¾Ñ€ÑƒĞ´Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ.
 * Ğ˜ÑĞ¿Ğ¾Ğ»ÑŒĞ·ÑƒĞµÑ‚ÑÑ Ğ´Ğ»Ñ Ğ²Ñ‹Ğ¿Ğ°Ğ´Ğ°ÑÑ‰Ğ¸Ñ… ÑĞ¿Ğ¸ÑĞºĞ¾Ğ² Ğ² Ñ„Ğ¾Ñ€Ğ¼Ğ°Ñ… Ğ¸ Ğ´Ğ»Ñ Ğ²Ğ°Ğ»Ğ¸Ğ´Ğ°Ñ†Ğ¸Ğ¸.
 */
export const EQUIPMENT_CONDITIONS: readonly string[] = [
    "Ğ’ĞµĞ»Ğ¸ĞºĞ¾Ğ»ĞµĞ¿Ğ½Ğ¾",
    "ĞÑ‚Ğ»Ğ¸Ñ‡Ğ½Ğ¾",
    "Ğ¥Ğ¾Ñ€Ğ¾ÑˆĞ¾",
    "Ğ£Ğ´Ğ¾Ğ²Ğ»ĞµÑ‚Ğ²Ğ¾Ñ€Ğ¸Ñ‚ĞµĞ»ÑŒĞ½Ğ¾",
    "Ğ¢Ñ€ĞµĞ±ÑƒĞµÑ‚ Ñ€ĞµĞ¼Ğ¾Ğ½Ñ‚Ğ°",
];

/**
 * Ğ£Ñ‚Ğ¸Ğ»Ğ¸Ñ‚Ğ° Ğ´Ğ»Ñ Ğ¿Ğ¾Ğ»ÑƒÑ‡ĞµĞ½Ğ¸Ñ Tailwind CSS ĞºĞ»Ğ°ÑÑĞ¾Ğ² Ğ´Ğ»Ñ ÑÑ‚Ğ¸Ğ»Ğ¸Ğ·Ğ°Ñ†Ğ¸Ğ¸ ÑĞ¾ÑÑ‚Ğ¾ÑĞ½Ğ¸Ñ Ğ¾Ğ±Ğ¾Ñ€ÑƒĞ´Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ.
 * @param condition Ğ¡Ñ‚Ñ€Ğ¾ĞºĞ° Ñ Ğ½Ğ°Ğ·Ğ²Ğ°Ğ½Ğ¸ĞµĞ¼ ÑĞ¾ÑÑ‚Ğ¾ÑĞ½Ğ¸Ñ.
 * @returns Ğ¡Ñ‚Ñ€Ğ¾ĞºĞ° Ñ CSS ĞºĞ»Ğ°ÑÑĞ°Ğ¼Ğ¸ Ğ´Ğ»Ñ Ñ„Ğ¾Ğ½Ğ° Ğ¸ Ñ‚ĞµĞºÑÑ‚Ğ°.
 */
export function getConditionVariantClass(condition: string): string {
    switch (condition) {
        case "Ğ’ĞµĞ»Ğ¸ĞºĞ¾Ğ»ĞµĞ¿Ğ½Ğ¾":
            return "bg-green-100 text-green-800";
        case "ĞÑ‚Ğ»Ğ¸Ñ‡Ğ½Ğ¾":
            return "bg-sky-100 text-sky-800";
        case "Ğ¥Ğ¾Ñ€Ğ¾ÑˆĞ¾":
            return "bg-yellow-100 text-yellow-800";
        case "Ğ£Ğ´Ğ¾Ğ²Ğ»ĞµÑ‚Ğ²Ğ¾Ñ€Ğ¸Ñ‚ĞµĞ»ÑŒĞ½Ğ¾":
            return "bg-orange-100 text-orange-800";
        case "Ğ¢Ñ€ĞµĞ±ÑƒĞµÑ‚ Ñ€ĞµĞ¼Ğ¾Ğ½Ñ‚Ğ°":
            return "bg-red-100 text-red-800";
        default:
            return "bg-gray-100 text-gray-800";
    }
};

```


## <a name="rentalappmainsrcconstantspaginationConstantsts"></a>`rental-app-main/src/constants/paginationConstants.ts`

```typescript
// path: rental-app-main/src/constants/paginationConstants.ts

// src/constants/paginationConstants.ts

export const PAGINATION_CONSTANTS = {
    HOME_PAGE_SIZE: 12,
    ADMIN_PAGE_SIZE: 10,
};

```


## <a name="rentalappmainsrcconstantsstatusStylests"></a>`rental-app-main/src/constants/statusStyles.ts`

```typescript
// path: rental-app-main/src/constants/statusStyles.ts

// src/constants/statusStyles.ts

// Ğ¡Ñ‚Ğ¸Ğ»Ğ¸ Ğ´Ğ»Ñ ĞºĞ°Ñ€Ñ‚Ğ¾Ñ‡ĞµĞº Ğ Ğ•Ğ—Ğ•Ğ Ğ’ĞĞ’
export const RESERVATION_CARD_STYLES: Record<string, string> = {
    active: "bg-white hover:shadow-md",
    fulfilled: "bg-blue-50 border-blue-200 text-gray-800",
    cancelled: "bg-gray-100 border-gray-300 text-gray-600 hover:shadow-sm",
    overdue: "bg-orange-50 border-orange-200 text-gray-800",
    default: "bg-white hover:shadow-md"
};

// Ğ¡Ñ‚Ğ¸Ğ»Ğ¸ Ğ´Ğ»Ñ ĞºĞ°Ñ€Ñ‚Ğ¾Ñ‡ĞµĞº ĞĞ Ğ•ĞĞ”Ğ«
export const RENTAL_CARD_STYLES: Record<string, string> = {
    active: "bg-white hover:shadow-md",
    completed: "bg-gray-100 border-gray-200 text-gray-600 hover:shadow-sm",
    overdue: "bg-red-50/70 border-red-300",
    default: "bg-white hover:shadow-md"
};


```


## <a name="rentalappmainsrcconstantsuserConstantsts"></a>`rental-app-main/src/constants/userConstants.ts`

```typescript
// path: rental-app-main/src/constants/userConstants.ts

// src/constants/userConstants.ts

/**
 * Ğ¡Ğ¸ÑÑ‚ĞµĞ¼Ğ½Ñ‹Ğµ Ğ¸Ğ¼ĞµĞ½Ğ° Ñ€Ğ¾Ğ»ĞµĞ¹ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ĞµĞ¹.
 * Ğ˜ÑĞ¿Ğ¾Ğ»ÑŒĞ·ÑƒÑÑ‚ÑÑ Ğ´Ğ»Ñ Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ñ Ñ API Ğ¸ Ğ² Ğ»Ğ¾Ğ³Ğ¸ĞºĞµ.
 */
export const USER_ROLES = {
    USER: "user",
    MANAGER: "manager",
    ADMIN: "admin",
} as const;

// Ğ¡Ğ¾Ğ·Ğ´Ğ°ĞµĞ¼ Ñ‚Ğ¸Ğ¿ Ğ½Ğ° Ğ¾ÑĞ½Ğ¾Ğ²Ğµ ĞºĞ»ÑÑ‡ĞµĞ¹ Ğ¾Ğ±ÑŠĞµĞºÑ‚Ğ° USER_ROLES Ğ´Ğ»Ñ ÑƒĞ´Ğ¾Ğ±ÑÑ‚Ğ²Ğ°
type UserRoleKey = keyof typeof USER_ROLES;

/**
 * Ğ¢Ğ¸Ğ¿ Ğ´Ğ»Ñ ÑĞ¸ÑÑ‚ĞµĞ¼Ğ½Ñ‹Ñ… Ğ¸Ğ¼ĞµĞ½ Ñ€Ğ¾Ğ»ĞµĞ¹.
 * ĞŸÑ€Ğ¸Ğ¼ĞµÑ€: 'user' | 'manager' | 'admin'
 */
export type UserRole = (typeof USER_ROLES)[UserRoleKey];

// âœ… Ğ˜Ğ—ĞœĞ•ĞĞ•ĞĞ˜Ğ•: Ğ¡Ğ¾Ğ·Ğ´Ğ°ĞµĞ¼ Ğ¼Ğ°ÑÑĞ¸Ğ² Ñ€Ğ¾Ğ»ĞµĞ¹ Ğ¸ ÑĞ²Ğ½Ğ¾ ÑƒĞºĞ°Ğ·Ñ‹Ğ²Ğ°ĞµĞ¼ TypeScript,
// Ñ‡Ñ‚Ğ¾ ÑÑ‚Ğ¾ Ğ½ĞµĞ¿ÑƒÑÑ‚Ğ¾Ğ¹ ĞºĞ¾Ñ€Ñ‚ĞµĞ¶ Ğ¸Ğ· Ğ½Ğ°ÑˆĞ¸Ñ… ĞºĞ¾Ğ½ĞºÑ€ĞµÑ‚Ğ½Ñ‹Ñ… Ñ€Ğ¾Ğ»ĞµĞ¹.
// Ğ­Ñ‚Ğ¾ Ğ¸ ĞµÑÑ‚ÑŒ Ğ¸ÑĞ¿Ñ€Ğ°Ğ²Ğ»ĞµĞ½Ğ¸Ğµ Ğ¾ÑˆĞ¸Ğ±ĞºĞ¸.
export const USER_ROLE_VALUES = Object.values(USER_ROLES) as [UserRole, ...UserRole[]];

/**
 * ĞœĞµÑ‚ĞºĞ¸ Ñ€Ğ¾Ğ»ĞµĞ¹ Ğ´Ğ»Ñ Ğ¾Ñ‚Ğ¾Ğ±Ñ€Ğ°Ğ¶ĞµĞ½Ğ¸Ñ Ğ² Ğ¸Ğ½Ñ‚ĞµÑ€Ñ„ĞµĞ¹ÑĞµ.
 */
export const USER_ROLE_LABELS: Record<UserRole, string> = {
    [USER_ROLES.USER]: "ĞŸĞ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ÑŒ",
    [USER_ROLES.MANAGER]: "ĞœĞµĞ½ĞµĞ´Ğ¶ĞµÑ€",
    [USER_ROLES.ADMIN]: "ĞĞ´Ğ¼Ğ¸Ğ½",
};

/**
 * Ğ’Ğ°Ñ€Ğ¸Ğ°Ğ½Ñ‚Ñ‹ (Ñ†Ğ²ĞµÑ‚Ğ°) Ğ´Ğ»Ñ ĞºĞ¾Ğ¼Ğ¿Ğ¾Ğ½ĞµĞ½Ñ‚Ğ° Badge Ğ¸Ğ· UI-Ğ±Ğ¸Ğ±Ğ»Ğ¸Ğ¾Ñ‚ĞµĞºĞ¸.
 */
export const USER_ROLE_BADGE_VARIANTS: Record<UserRole, "secondary" | "default" | "destructive"> = {
    [USER_ROLES.USER]: "secondary",
    [USER_ROLES.MANAGER]: "default",
    [USER_ROLES.ADMIN]: "destructive",
};

/**
 * ĞŸĞ¾Ğ»Ğ½Ñ‹Ğ¹ Ğ½Ğ°Ğ±Ğ¾Ñ€ Ğ´Ğ°Ğ½Ğ½Ñ‹Ñ… Ğ´Ğ»Ñ ĞºĞ°Ğ¶Ğ´Ğ¾Ğ¹ Ñ€Ğ¾Ğ»Ğ¸, ÑƒĞ´Ğ¾Ğ±Ğ½Ñ‹Ğ¹ Ğ´Ğ»Ñ Ğ³ĞµĞ½ĞµÑ€Ğ°Ñ†Ğ¸Ğ¸ UI-ÑĞ»ĞµĞ¼ĞµĞ½Ñ‚Ğ¾Ğ².
 */
export const USER_ROLE_OPTIONS = (Object.keys(USER_ROLES) as UserRoleKey[]).map(key => ({
    value: USER_ROLES[key],
    label: USER_ROLE_LABELS[USER_ROLES[key]],
}));

```


## <a name="rentalappmainsrccontextsReservationEditContexttsx"></a>`rental-app-main/src/contexts/ReservationEditContext.tsx`

```tsx
// path: rental-app-main/src/contexts/ReservationEditContext.tsx

// src/contexts/ReservationEditContext.tsx

import { createContext, useContext } from 'react';
import type { AvailabilityInfo } from '@/types/availability';
import type { EditState } from '@/hooks/reservation/useReservationState';
import type { Equipment } from '@/types/equipment'; // âœ… Ğ”Ğ¾Ğ±Ğ°Ğ²Ğ»ĞµĞ½ Ğ¸Ğ¼Ğ¿Ğ¾Ñ€Ñ‚
import type { PriceDetails } from '@/hooks/reservation/usePriceCalculator';

export type ReservationEditContextValue = {
    reservationId: number;
    editState: EditState & { hasChanges: boolean; newlyAddedEquipmentIdsAsArray: number[] };
    availabilityMap: Record<number, AvailabilityInfo>;
    hasConflicts: boolean;
    isLoading: boolean;
    isCheckingAvailability: boolean;
    isSaving: boolean;
    isCalculatingPrice: boolean;
    isCancelling: boolean;
    isCancelConfirmationVisible: boolean;
    startEdit: () => void;
    cancelEdit: () => void;
    saveChanges: () => Promise<boolean | void>;
    // âœ… Ğ”ĞĞ‘ĞĞ’Ğ›Ğ•ĞĞ« Ğ­Ğ¢Ğ˜ Ğ”Ğ’Ğ Ğ¡Ğ’ĞĞ™Ğ¡Ğ¢Ğ’Ğ
    equipmentMap: Map<number, Equipment>;
    allEquipment: Equipment[];
    updateDates: (newStartDate: Date, newEndDate: Date) => void;
    addEquipmentItems: (itemsToAdd: any[]) => void;
    removeEquipmentItem: (idToRemove: number) => void;
    handleConfirmFullCancellation: () => Promise<void>;
    handleCloseCancellationDialog: () => void;
    financials: {
        dayCount: number;
        fullTotal: number;
        finalTotal: number;
        discountAmount: number;
        durationDiscountAmount: number;
        durationDiscountPercentage: number;
        promoDiscountAmount: number;
        promoCodePercentage: number;
        promoCodeMessage: string;
        promoCode: string;
    };
    priceDetails?: PriceDetails | null; // Ğ”Ğ¾Ğ±Ğ°Ğ²Ğ»ÑĞµĞ¼ priceDetails Ğ¸Ğ· usePriceCalculator
    setPromoCode: (code: string) => void;
    applyPromoCode: () => void;
    removePromoCode: () => void;
    localSelectedAccessories: Record<number, number[]>;
    toggleAccessory: (equipmentId: number, accessoryId: number) => void;
    holidayConflict: { message: string, suggested_end_date: string } | null;
    confirmHolidayAdjustment: () => void;
    cancelHolidayAdjustment: () => void;
};

export const ReservationEditContext = createContext<ReservationEditContextValue | null>(null);

export const useReservationEditContext = () => {
    const context = useContext(ReservationEditContext);
    if (!context) {
        throw new Error('useReservationEditContext must be used within a ReservationEditProvider');
    }
    return context;
};

```


## <a name="rentalappmainsrccoreservicesAccessoryServicets"></a>`rental-app-main/src/core/services/AccessoryService.ts`

```typescript
// path: rental-app-main/src/core/services/AccessoryService.ts

// src/core/services/AccessoryService.ts

import { api } from "@/lib/api";
import type { Accessory, AccessoryListResponse } from "@/types/accessory"; // Ğ£Ğ±ĞµĞ´Ğ¸Ñ‚ĞµÑÑŒ, Ñ‡Ñ‚Ğ¾ AccessoryListResponse Ğ¸Ğ¼Ğ¿Ğ¾Ñ€Ñ‚Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½

export interface AccessoryCreateInput {
    name: string;
    accessory_type: string;
    price: number;
    description?: string;
}

export interface AccessoryUpdateInput extends AccessoryCreateInput {
    id: number;
}

export interface AccessoryFilterOptions {
    search?: string;
    accessoryType?: string;
    minPrice?: number;
    maxPrice?: number;
}

export interface AccessoryValidationResult {
    isValid: boolean;
    errors: string[];
}

export class AccessoryService {
    /**
     * ĞŸĞ¾Ğ»ÑƒÑ‡Ğ°ĞµÑ‚ Ğ²ÑĞµ Ğ°ĞºÑĞµÑÑÑƒĞ°Ñ€Ñ‹ Ñ Ğ¿Ğ°Ğ³Ğ¸Ğ½Ğ°Ñ†Ğ¸ĞµĞ¹
     */
    static async getAllAccessories(skip: number, limit: number): Promise<AccessoryListResponse> {
        const response = await api.get("/accessories/", {
            params: { skip, limit }
        });
        // Ğ’ĞĞ–ĞĞ: API Ğ²Ğ¾Ğ·Ğ²Ñ€Ğ°Ñ‰Ğ°ĞµÑ‚ Ğ¾Ğ±ÑŠĞµĞºÑ‚ { items: [], total: 0 },
        // Ğ¸ Ñ‚ĞµĞ¿ĞµÑ€ÑŒ Ğ½Ğ°Ñˆ ÑĞµÑ€Ğ²Ğ¸Ñ ĞºĞ¾Ñ€Ñ€ĞµĞºÑ‚Ğ½Ğ¾ ĞµĞ³Ğ¾ Ğ¾Ğ±Ñ€Ğ°Ğ±Ğ°Ñ‚Ñ‹Ğ²Ğ°ĞµÑ‚.
        return response.data;
    }

    /**
     * ĞŸĞ¾Ğ»ÑƒÑ‡Ğ°ĞµÑ‚ Ğ°ĞºÑĞµÑÑÑƒĞ°Ñ€ Ğ¿Ğ¾ ID
     */
    static async getAccessoryById(id: number): Promise<Accessory> {
        const response = await api.get(`/accessories/${id}`);
        return response.data;
    }

    /**
     * Ğ¡Ğ¾Ğ·Ğ´Ğ°ĞµÑ‚ Ğ½Ğ¾Ğ²Ñ‹Ğ¹ Ğ°ĞºÑĞµÑÑÑƒĞ°Ñ€
     */
    static async createAccessory(input: AccessoryCreateInput): Promise<Accessory> {
        const response = await api.post("/accessories/", input);
        return response.data;
    }

    /**
     * ĞĞ±Ğ½Ğ¾Ğ²Ğ»ÑĞµÑ‚ Ğ°ĞºÑĞµÑÑÑƒĞ°Ñ€
     */
    static async updateAccessory(input: AccessoryUpdateInput): Promise<Accessory> {
        const response = await api.put(`/accessories/${input.id}`, input);
        return response.data;
    }

    /**
     * Ğ£Ğ´Ğ°Ğ»ÑĞµÑ‚ Ğ°ĞºÑĞµÑÑÑƒĞ°Ñ€
     */
    static async deleteAccessory(id: number): Promise<void> {
        await api.delete(`/accessories/${id}`);
    }

    /**
     * ĞŸĞ¾Ğ»ÑƒÑ‡Ğ°ĞµÑ‚ Ğ°ĞºÑĞµÑÑÑƒĞ°Ñ€Ñ‹ Ğ´Ğ»Ñ ĞºĞ¾Ğ½ĞºÑ€ĞµÑ‚Ğ½Ğ¾Ğ³Ğ¾ Ğ¾Ğ±Ğ¾Ñ€ÑƒĞ´Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ
     */
    static async getAccessoriesForEquipment(equipmentId: number): Promise<Accessory[]> {
        const response = await api.get(`/equipment/${equipmentId}/accessories`);
        return response.data;
    }

    /**
     * Ğ¤Ğ¸Ğ»ÑŒÑ‚Ñ€ÑƒĞµÑ‚ Ğ°ĞºÑĞµÑÑÑƒĞ°Ñ€Ñ‹ Ğ¿Ğ¾ Ğ·Ğ°Ğ´Ğ°Ğ½Ğ½Ñ‹Ğ¼ ĞºÑ€Ğ¸Ñ‚ĞµÑ€Ğ¸ÑĞ¼
     */
    static filterAccessories(
        accessories: Accessory[],
        filters: AccessoryFilterOptions
    ): Accessory[] {
        return accessories.filter(accessory => {
            // Ğ¤Ğ¸Ğ»ÑŒÑ‚Ñ€ Ğ¿Ğ¾ Ğ¿Ğ¾Ğ¸ÑĞºÑƒ
            if (filters.search) {
                const searchLower = filters.search.toLowerCase();
                const matchesSearch =
                    accessory.name.toLowerCase().includes(searchLower) ||
                    accessory.accessory_type.toLowerCase().includes(searchLower) ||
                    (accessory.description && accessory.description.toLowerCase().includes(searchLower));

                if (!matchesSearch) {
                    return false;
                }
            }

            // Ğ¤Ğ¸Ğ»ÑŒÑ‚Ñ€ Ğ¿Ğ¾ Ñ‚Ğ¸Ğ¿Ñƒ Ğ°ĞºÑĞµÑÑÑƒĞ°Ñ€Ğ°
            if (filters.accessoryType && accessory.accessory_type !== filters.accessoryType) {
                return false;
            }

            // Ğ¤Ğ¸Ğ»ÑŒÑ‚Ñ€ Ğ¿Ğ¾ Ğ¼Ğ¸Ğ½Ğ¸Ğ¼Ğ°Ğ»ÑŒĞ½Ğ¾Ğ¹ Ñ†ĞµĞ½Ğµ
            if (filters.minPrice !== undefined && accessory.price < filters.minPrice) {
                return false;
            }

            // Ğ¤Ğ¸Ğ»ÑŒÑ‚Ñ€ Ğ¿Ğ¾ Ğ¼Ğ°ĞºÑĞ¸Ğ¼Ğ°Ğ»ÑŒĞ½Ğ¾Ğ¹ Ñ†ĞµĞ½Ğµ
            if (filters.maxPrice !== undefined && accessory.price > filters.maxPrice) {
                return false;
            }

            return true;
        });
    }

    /**
     * Ğ“Ñ€ÑƒĞ¿Ğ¿Ğ¸Ñ€ÑƒĞµÑ‚ Ğ°ĞºÑĞµÑÑÑƒĞ°Ñ€Ñ‹ Ğ¿Ğ¾ Ñ‚Ğ¸Ğ¿Ñƒ
     */
    static groupAccessoriesByType(accessories: Accessory[]): Record<string, Accessory[]> {
        return accessories.reduce((acc, accessory) => {
            const type = accessory.accessory_type;
            if (!acc[type]) {
                acc[type] = [];
            }
            acc[type].push(accessory);
            return acc;
        }, {} as Record<string, Accessory[]>);
    }

    /**
     * Ğ¡Ğ¾Ñ€Ñ‚Ğ¸Ñ€ÑƒĞµÑ‚ Ğ°ĞºÑĞµÑÑÑƒĞ°Ñ€Ñ‹ Ğ¿Ğ¾ Ğ·Ğ°Ğ´Ğ°Ğ½Ğ½Ğ¾Ğ¼Ñƒ ĞºÑ€Ğ¸Ñ‚ĞµÑ€Ğ¸Ñ
     */
    static sortAccessories(
        accessories: Accessory[],
        sortBy: 'name' | 'accessory_type' | 'price',
        sortOrder: 'asc' | 'desc' = 'asc'
    ): Accessory[] {
        return [...accessories].sort((a, b) => {
            let aValue: any = a[sortBy];
            let bValue: any = b[sortBy];

            // Ğ”Ğ»Ñ Ñ‡Ğ¸ÑĞµĞ» (price)
            if (sortBy === 'price') {
                aValue = Number(aValue) || 0;
                bValue = Number(bValue) || 0;
            }

            // Ğ¡Ñ‚Ñ€Ğ¾ĞºĞ¾Ğ²Ğ¾Ğµ ÑÑ€Ğ°Ğ²Ğ½ĞµĞ½Ğ¸Ğµ
            if (typeof aValue === 'string' && typeof bValue === 'string') {
                aValue = aValue.toLowerCase();
                bValue = bValue.toLowerCase();
            }

            if (aValue < bValue) {
                return sortOrder === 'asc' ? -1 : 1;
            }
            if (aValue > bValue) {
                return sortOrder === 'asc' ? 1 : -1;
            }
            return 0;
        });
    }

    /**
     * Ğ’Ğ°Ğ»Ğ¸Ğ´Ğ¸Ñ€ÑƒĞµÑ‚ Ğ´Ğ°Ğ½Ğ½Ñ‹Ğµ Ğ°ĞºÑĞµÑÑÑƒĞ°Ñ€Ğ°
     */
    static validateAccessoryData(input: AccessoryCreateInput): AccessoryValidationResult {
        const errors: string[] = [];

        if (!input.name?.trim()) {
            errors.push("ĞĞ°Ğ·Ğ²Ğ°Ğ½Ğ¸Ğµ Ğ°ĞºÑĞµÑÑÑƒĞ°Ñ€Ğ° Ğ¾Ğ±ÑĞ·Ğ°Ñ‚ĞµĞ»ÑŒĞ½Ğ¾");
        }

        if (!input.accessory_type?.trim()) {
            errors.push("Ğ¢Ğ¸Ğ¿ Ğ°ĞºÑĞµÑÑÑƒĞ°Ñ€Ğ° Ğ¾Ğ±ÑĞ·Ğ°Ñ‚ĞµĞ»ĞµĞ½");
        }

        if (input.price <= 0) {
            errors.push("Ğ¦ĞµĞ½Ğ° Ğ´Ğ¾Ğ»Ğ¶Ğ½Ğ° Ğ±Ñ‹Ñ‚ÑŒ Ğ±Ğ¾Ğ»ÑŒÑˆĞµ Ğ½ÑƒĞ»Ñ");
        }

        return {
            isValid: errors.length === 0,
            errors
        };
    }

    /**
     * Ğ Ğ°ÑÑÑ‡Ğ¸Ñ‚Ñ‹Ğ²Ğ°ĞµÑ‚ Ğ¾Ğ±Ñ‰ÑƒÑ ÑÑ‚Ğ¾Ğ¸Ğ¼Ğ¾ÑÑ‚ÑŒ Ğ²Ñ‹Ğ±Ñ€Ğ°Ğ½Ğ½Ñ‹Ñ… Ğ°ĞºÑĞµÑÑÑƒĞ°Ñ€Ğ¾Ğ²
     */
    static calculateAccessoriesTotal(
        selectedAccessories: Record<number, number[]>,
        allAccessories: Accessory[]
    ): number {
        let total = 0;

        Object.entries(selectedAccessories).forEach(([equipmentId, accessoryIds]) => {
            accessoryIds.forEach(accessoryId => {
                const accessory = allAccessories.find(acc => acc.id === accessoryId);
                if (accessory) {
                    total += accessory.price;
                }
            });
        });

        return total;
    }

    /**
     * ĞŸĞ¾Ğ»ÑƒÑ‡Ğ°ĞµÑ‚ Ğ°ĞºÑĞµÑÑÑƒĞ°Ñ€Ñ‹ Ğ¿Ğ¾ Ğ¸Ñ… ID
     */
    static getAccessoriesByIds(
        accessoryIds: number[],
        allAccessories: Accessory[]
    ): Accessory[] {
        return allAccessories.filter(accessory => accessoryIds.includes(accessory.id));
    }

    /**
     * Ğ“ĞµĞ½ĞµÑ€Ğ¸Ñ€ÑƒĞµÑ‚ ĞºĞ»ÑÑ‡ Ğ´Ğ»Ñ ĞºÑÑˆĞ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ Ğ°ĞºÑĞµÑÑÑƒĞ°Ñ€Ğ¾Ğ²
     */
    static generateAccessoriesCacheKey(filters?: AccessoryFilterOptions): string {
        return JSON.stringify(["accessories", filters]);
    }

    /**
     * Ğ“ĞµĞ½ĞµÑ€Ğ¸Ñ€ÑƒĞµÑ‚ ĞºĞ»ÑÑ‡ Ğ´Ğ»Ñ ĞºÑÑˆĞ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ Ğ°ĞºÑĞµÑÑÑƒĞ°Ñ€Ğ¾Ğ² Ğ¾Ğ±Ğ¾Ñ€ÑƒĞ´Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ
     */
    static generateEquipmentAccessoriesCacheKey(equipmentId: number): string {
        return JSON.stringify(["equipment-accessories", equipmentId]);
    }
}

```


## <a name="rentalappmainsrccoreservicesAvailabilityServicets"></a>`rental-app-main/src/core/services/AvailabilityService.ts`

```typescript
// path: rental-app-main/src/core/services/AvailabilityService.ts

// src/core/services/AvailabilityService.ts

import { api } from "@/lib/api";
import { formatDate } from "@/lib/utils";
import type { AvailabilityInfo, AvailabilityListResponse, DayStatus } from "@/types/availability";

export interface AvailabilityStatusParams {
    equipmentIds: number[];
    startDate: Date;
    endDate: Date;
    excludeReservationId?: number;
}

export interface DailyStatusParams {
    equipmentIds: number[];
    startDate: Date;
    endDate: Date;
    excludeReservationId?: number;
}

export interface ConflictCheckParams {
    equipmentIds: number[];
    startDate: Date;
    endDate: Date;
    excludeReservationId?: number;
}

/**
 * Ğ¡ĞµÑ€Ğ²Ğ¸Ñ Ğ´Ğ»Ñ Ñ€Ğ°Ğ±Ğ¾Ñ‚Ñ‹ Ñ Ğ´Ğ¾ÑÑ‚ÑƒĞ¿Ğ½Ğ¾ÑÑ‚ÑŒÑ Ğ¾Ğ±Ğ¾Ñ€ÑƒĞ´Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ.
 * Ğ¦ĞµĞ½Ñ‚Ñ€Ğ°Ğ»Ğ¸Ğ·ÑƒĞµÑ‚ Ğ²ÑĞµ API-Ğ·Ğ°Ğ¿Ñ€Ğ¾ÑÑ‹, ÑĞ²ÑĞ·Ğ°Ğ½Ğ½Ñ‹Ğµ Ñ Ğ¿Ñ€Ğ¾Ğ²ĞµÑ€ĞºĞ¾Ğ¹ Ğ´Ğ¾ÑÑ‚ÑƒĞ¿Ğ½Ğ¾ÑÑ‚Ğ¸.
 */
export class AvailabilityService {
    /**
     * ĞŸĞ¾Ğ»ÑƒÑ‡Ğ°ĞµÑ‚ Ğ¾Ğ±Ñ‰Ğ¸Ğ¹ ÑÑ‚Ğ°Ñ‚ÑƒÑ (available, rented, reserved) Ğ´Ğ»Ñ ÑĞ¿Ğ¸ÑĞºĞ° Ğ¾Ğ±Ğ¾Ñ€ÑƒĞ´Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ.
     * Ğ’Ñ‹Ğ·Ñ‹Ğ²Ğ°ĞµÑ‚ ÑĞ½Ğ´Ğ¿Ğ¾Ğ¸Ğ½Ñ‚ /calendar/view.
     */
    static async getStatuses(params: AvailabilityStatusParams): Promise<AvailabilityInfo[]> {
        if (!params.startDate || !params.endDate || params.equipmentIds.length === 0) {
            return [];
        }

        const searchParams = new URLSearchParams();
        
        searchParams.append("start", formatDate(params.startDate));
        searchParams.append("end", formatDate(params.endDate));
        
        params.equipmentIds.forEach(id => {
            searchParams.append("ids", id.toString());
        });

        if (params.excludeReservationId !== undefined) {
            searchParams.append("exclude_reservation_id", params.excludeReservationId.toString());
        }

        const response = await api.get<AvailabilityListResponse>(`/calendar/view?${searchParams.toString()}`);
        return response.data.items;
    }

    /**
     * ĞŸĞ¾Ğ»ÑƒÑ‡Ğ°ĞµÑ‚ ÑÑ‚Ğ°Ñ‚ÑƒÑÑ‹ Ğ¿Ğ¾ Ğ´Ğ½ÑĞ¼ Ğ´Ğ»Ñ ĞºĞ°Ğ»ĞµĞ½Ğ´Ğ°Ñ€Ñ-Ğ¿Ğ¾Ğ»Ğ¾ÑĞºĞ¸.
     * Ğ’Ñ‹Ğ·Ñ‹Ğ²Ğ°ĞµÑ‚ ÑĞ½Ğ´Ğ¿Ğ¾Ğ¸Ğ½Ñ‚ /calendar/day-statuses.
     */
    static async getDailyStatuses(params: DailyStatusParams): Promise<Record<number, DayStatus[]>> {
        if (!params.startDate || !params.endDate || params.equipmentIds.length === 0) {
            return {};
        }

        const searchParams = new URLSearchParams();
        
        searchParams.append("start", formatDate(params.startDate));
        searchParams.append("end", formatDate(params.endDate));
        
        params.equipmentIds.forEach(id => {
            searchParams.append("ids", id.toString());
        });

        if (params.excludeReservationId !== undefined) {
            searchParams.append("exclude_reservation_id", params.excludeReservationId.toString());
        }

        const response = await api.get<Record<number, DayStatus[]>>(`/calendar/day-statuses?${searchParams.toString()}`);
        return response.data;
    }

    /**
     * ĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑĞµÑ‚ ĞºĞ¾Ğ½Ñ„Ğ»Ğ¸ĞºÑ‚Ñ‹ Ğ´Ğ»Ñ ÑƒĞºĞ°Ğ·Ğ°Ğ½Ğ½Ğ¾Ğ³Ğ¾ Ğ¾Ğ±Ğ¾Ñ€ÑƒĞ´Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ.
     * Ğ’Ğ¾Ğ·Ğ²Ñ€Ğ°Ñ‰Ğ°ĞµÑ‚ ÑĞ¿Ğ¸ÑĞ¾Ğº ID Ğ¾Ğ±Ğ¾Ñ€ÑƒĞ´Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ Ñ ĞºĞ¾Ğ½Ñ„Ğ»Ğ¸ĞºÑ‚Ğ°Ğ¼Ğ¸.
     * Ğ­Ñ‚Ğ¾Ñ‚ Ğ¼ĞµÑ‚Ğ¾Ğ´ Ğ¼Ğ¾Ğ¶ĞµÑ‚ Ğ±Ñ‹Ñ‚ÑŒ Ğ¾Ğ¿Ñ†Ğ¸Ğ¾Ğ½Ğ°Ğ»ÑŒĞ½Ñ‹Ğ¼, ĞµÑĞ»Ğ¸ getStatuses Ğ²Ğ¾Ğ·Ğ²Ñ€Ğ°Ñ‰Ğ°ĞµÑ‚ Ğ´Ğ¾ÑÑ‚Ğ°Ñ‚Ğ¾Ñ‡Ğ½Ğ¾ Ğ¸Ğ½Ñ„Ğ¾Ñ€Ğ¼Ğ°Ñ†Ğ¸Ğ¸.
     */
    static async checkConflicts(params: ConflictCheckParams): Promise<number[]> {
        const statuses = await this.getStatuses(params);
        
        return statuses
            .filter(info => info.status === "reserved" || info.status === "rented")
            .map(info => info.equipment_id);
    }
}


```


## <a name="rentalappmainsrccoreservicesCalendarServicets"></a>`rental-app-main/src/core/services/CalendarService.ts`

```typescript
// path: rental-app-main/src/core/services/CalendarService.ts

// src/core/services/CalendarService.ts
import { api } from "@/lib/api";
import type { DayStatus } from "@/types/availability";
import type { Equipment } from "@/types/equipment";

export interface CalendarGridData {
  [equipmentId: number]: {
    [date: string]: DayStatus;
  };
}

export interface CalendarFilterOptions {
  type?: string;
  brand?: string;
  query?: string;
}

export class CalendarService {
  /**
   * ĞŸĞ¾Ğ»ÑƒÑ‡Ğ°ĞµÑ‚ ÑÑ‚Ğ°Ñ‚ÑƒÑÑ‹ Ğ´Ğ½ĞµĞ¹ Ğ´Ğ»Ñ ĞºĞ°Ğ»ĞµĞ½Ğ´Ğ°Ñ€Ñ
   */
  static async getDayStatuses(
    startDate: string,
    endDate: string,
    equipmentIds: number[]
  ): Promise<CalendarGridData> {
    if (!startDate || !endDate) {
      console.warn(
        "[CalendarService] getDayStatuses Ğ²Ñ‹Ğ·Ğ²Ğ°Ğ½ Ñ Ğ½ĞµĞ²Ğ°Ğ»Ğ¸Ğ´Ğ½Ñ‹Ğ¼Ğ¸ Ğ´Ğ°Ñ‚Ğ°Ğ¼Ğ¸"
      );
      return {};
    }

    if (equipmentIds.length === 0) {
      console.warn(
        "[CalendarService] getDayStatuses Ğ²Ñ‹Ğ·Ğ²Ğ°Ğ½ Ñ Ğ¿ÑƒÑÑ‚Ñ‹Ğ¼ ÑĞ¿Ğ¸ÑĞºĞ¾Ğ¼ ID Ğ¾Ğ±Ğ¾Ñ€ÑƒĞ´Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ"
      );
      return {};
    }

    try {
      const response = await api.get("/calendar/day-statuses", {
        params: {
          start: startDate,
          end: endDate,
          ids: equipmentIds,
        },
      });

      console.log(
        "[CalendarService] API response for /calendar/day-statuses:",
        response
      );

      if (
        response?.data?.equipment_day_statuses !== undefined
      ) {
        return response.data.equipment_day_statuses;
      } else {
        console.error(
          "[CalendarService] API response did not contain 'equipment_day_statuses'",
          response?.data
        );
        return {};
      }
    } catch (error) {
      console.error(
        "[CalendarService] Error fetching /calendar/day-statuses:",
        error
      );
      throw error;
    }
  }

  /**
   * Ğ¤Ğ¸Ğ»ÑŒÑ‚Ñ€ÑƒĞµÑ‚ Ğ¾Ğ±Ğ¾Ñ€ÑƒĞ´Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ Ğ´Ğ»Ñ ĞºĞ°Ğ»ĞµĞ½Ğ´Ğ°Ñ€Ñ Ğ¿Ğ¾ Ğ·Ğ°Ğ´Ğ°Ğ½Ğ½Ñ‹Ğ¼ ĞºÑ€Ğ¸Ñ‚ĞµÑ€Ğ¸ÑĞ¼
   */
  static filterEquipmentForCalendar(
    equipment: Equipment[],
    options: CalendarFilterOptions
  ): number[] {
    return equipment
      .filter((item) => {
        // Ğ¤Ğ¸Ğ»ÑŒÑ‚Ñ€ Ğ¿Ğ¾ Ñ‚Ğ¸Ğ¿Ñƒ
        if (options.type && options.type !== item.equipment_type) {
          return false;
        }

        // Ğ¤Ğ¸Ğ»ÑŒÑ‚Ñ€ Ğ¿Ğ¾ Ğ±Ñ€ĞµĞ½Ğ´Ñƒ
        if (options.brand && options.brand !== "__all__" && options.brand !== item.brand) {
          return false;
        }

        // Ğ¤Ğ¸Ğ»ÑŒÑ‚Ñ€ Ğ¿Ğ¾ Ğ¿Ğ¾Ğ¸ÑĞºĞ¾Ğ²Ğ¾Ğ¼Ñƒ Ğ·Ğ°Ğ¿Ñ€Ğ¾ÑÑƒ
        if (options.query) {
          const query = options.query.toLowerCase();
          const matchesQuery =
            item.name?.toLowerCase().includes(query) ||
            item.brand?.toLowerCase().includes(query) ||
            item.equipment_type?.toLowerCase().includes(query);
          
          if (!matchesQuery) {
            return false;
          }
        }

        return true;
      })
      .map((item) => item.id);
  }

  /**
   * Ğ¡Ğ¾Ğ·Ğ´Ğ°ĞµÑ‚ ĞºĞ»ÑÑ‡ Ğ·Ğ°Ğ¿Ñ€Ğ¾ÑĞ° Ğ´Ğ»Ñ ĞºÑÑˆĞ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ
   */
  static createQueryKey(
    startDate: string,
    endDate: string,
    equipmentIds: number[]
  ): string[] {
    return [
      "calendar-grid",
      startDate,
      endDate,
      JSON.stringify(equipmentIds.sort((a, b) => a - b)),
    ];
  }
} 

```


## <a name="rentalappmainsrccoreservicesDateServicets"></a>`rental-app-main/src/core/services/DateService.ts`

```typescript
// path: rental-app-main/src/core/services/DateService.ts

// src/core/services/DateService.ts

import { addDays, format } from 'date-fns';

export interface DateRange {
  startDate: Date;
  endDate: Date;
}

export interface DateRangeValidationResult {
  isValid: boolean;
  error?: string;
  adjustedRange?: DateRange;
}

export class DateService {
  /**
   * ĞšĞ¾Ñ€Ñ€ĞµĞºÑ‚Ğ¸Ñ€ÑƒĞµÑ‚ Ğ´Ğ°Ñ‚Ñƒ, ĞµÑĞ»Ğ¸ Ğ¾Ğ½Ğ° Ğ²Ñ‹Ğ¿Ğ°Ğ´Ğ°ĞµÑ‚ Ğ½Ğ° Ğ²Ñ‹Ñ…Ğ¾Ğ´Ğ½Ğ¾Ğ¹, ÑĞ´Ğ²Ğ¸Ğ³Ğ°Ñ ĞµÑ‘ Ğ½Ğ° Ğ±Ğ»Ğ¸Ğ¶Ğ°Ğ¹ÑˆĞ¸Ğ¹ Ñ€Ğ°Ğ±Ğ¾Ñ‡Ğ¸Ğ¹ Ğ´ĞµĞ½ÑŒ.
   * @param date - ĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑĞµĞ¼Ğ°Ñ Ğ´Ğ°Ñ‚Ğ°
   * @param holidays - ĞœĞ°ÑÑĞ¸Ğ² Ğ´Ğ°Ñ‚-Ğ²Ñ‹Ñ…Ğ¾Ğ´Ğ½Ñ‹Ñ…
   * @returns Ğ¡ĞºĞ¾Ñ€Ñ€ĞµĞºÑ‚Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ½Ğ°Ñ Ğ´Ğ°Ñ‚Ğ°
   */
  static adjustDateIfHoliday(date: Date, holidays: Date[]): Date {
    let adjustedDate = new Date(date);
    const holidaySet = new Set(holidays.map(h => format(h, 'yyyy-MM-dd')));

    // ĞŸĞ¾ĞºĞ° Ğ¸Ñ‚Ğ¾Ğ³Ğ¾Ğ²Ğ°Ñ Ğ´Ğ°Ñ‚Ğ° ÑĞ²Ğ»ÑĞµÑ‚ÑÑ Ğ²Ñ‹Ñ…Ğ¾Ğ´Ğ½Ñ‹Ğ¼, Ğ´Ğ¾Ğ±Ğ°Ğ²Ğ»ÑĞµĞ¼ Ğ¾Ğ´Ğ¸Ğ½ Ğ´ĞµĞ½ÑŒ
    while (holidaySet.has(format(adjustedDate, 'yyyy-MM-dd'))) {
      adjustedDate = addDays(adjustedDate, 1);
    }
    return adjustedDate;
  }

  /**
   * Ğ’Ğ°Ğ»Ğ¸Ğ´Ğ¸Ñ€ÑƒĞµÑ‚ Ğ´Ğ¸Ğ°Ğ¿Ğ°Ğ·Ğ¾Ğ½ Ğ´Ğ°Ñ‚
   */
  static validateDateRange(startDate: Date, endDate: Date): DateRangeValidationResult {
    if (!startDate || !endDate) {
      return {
        isValid: false,
        error: 'Ğ”Ğ°Ñ‚Ñ‹ Ğ½Ğ°Ñ‡Ğ°Ğ»Ğ° Ğ¸ Ğ¾ĞºĞ¾Ğ½Ñ‡Ğ°Ğ½Ğ¸Ñ Ğ¾Ğ±ÑĞ·Ğ°Ñ‚ĞµĞ»ÑŒĞ½Ñ‹'
      };
    }

    if (isNaN(startDate.getTime()) || isNaN(endDate.getTime())) {
      return {
        isValid: false,
        error: 'ĞĞµĞºĞ¾Ñ€Ñ€ĞµĞºÑ‚Ğ½Ñ‹Ğ¹ Ñ„Ğ¾Ñ€Ğ¼Ğ°Ñ‚ Ğ´Ğ°Ñ‚Ñ‹'
      };
    }

    if (startDate >= endDate) {
      return {
        isValid: false,
        error: 'Ğ”Ğ°Ñ‚Ğ° Ğ¾ĞºĞ¾Ğ½Ñ‡Ğ°Ğ½Ğ¸Ñ Ğ´Ğ¾Ğ»Ğ¶Ğ½Ğ° Ğ±Ñ‹Ñ‚ÑŒ Ğ¿Ğ¾Ğ·Ğ¶Ğµ Ğ´Ğ°Ñ‚Ñ‹ Ğ½Ğ°Ñ‡Ğ°Ğ»Ğ°'
      };
    }

    return {
      isValid: true
    };
  }

  /**
   * ĞšĞ¾Ñ€Ñ€ĞµĞºÑ‚Ğ¸Ñ€ÑƒĞµÑ‚ Ğ´Ğ¸Ğ°Ğ¿Ğ°Ğ·Ğ¾Ğ½ Ğ´Ğ°Ñ‚, ĞµÑĞ»Ğ¸ endDate Ñ€Ğ°Ğ½ÑŒÑˆĞµ startDate
   */
  static adjustDateRange(startDate: Date, endDate: Date): DateRange {
    if (startDate >= endDate) {
      const adjustedEndDate = new Date(startDate);
      adjustedEndDate.setDate(adjustedEndDate.getDate() + 1);
      return {
        startDate,
        endDate: adjustedEndDate
      };
    }

    return { startDate, endDate };
  }

  /**
   * ĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑĞµÑ‚, ÑĞ²Ğ»ÑĞµÑ‚ÑÑ Ğ»Ğ¸ Ğ´Ğ°Ñ‚Ğ° Ğ²Ğ°Ğ»Ğ¸Ğ´Ğ½Ğ¾Ğ¹
   */
  static isValidDate(date: Date): boolean {
    return date instanceof Date && !isNaN(date.getTime());
  }

  /**
   * Ğ¡Ğ¾Ğ·Ğ´Ğ°ĞµÑ‚ ÑĞ»ĞµĞ´ÑƒÑÑ‰ÑƒÑ Ğ´Ğ°Ñ‚Ñƒ Ğ¿Ğ¾ÑĞ»Ğµ ÑƒĞºĞ°Ğ·Ğ°Ğ½Ğ½Ğ¾Ğ¹
   */
  static getNextDay(date: Date): Date {
    const nextDay = new Date(date);
    nextDay.setDate(nextDay.getDate() + 1);
    return nextDay;
  }

  /**
   * Ğ¡Ğ¾Ğ·Ğ´Ğ°ĞµÑ‚ Ğ¿Ñ€ĞµĞ´Ñ‹Ğ´ÑƒÑ‰ÑƒÑ Ğ´Ğ°Ñ‚Ñƒ Ğ¿ĞµÑ€ĞµĞ´ ÑƒĞºĞ°Ğ·Ğ°Ğ½Ğ½Ğ¾Ğ¹
   */
  static getPreviousDay(date: Date): Date {
    const previousDay = new Date(date);
    previousDay.setDate(previousDay.getDate() - 1);
    return previousDay;
  }

  /**
   * Ğ’Ñ‹Ñ‡Ğ¸ÑĞ»ÑĞµÑ‚ ĞºĞ¾Ğ»Ğ¸Ñ‡ĞµÑÑ‚Ğ²Ğ¾ Ğ´Ğ½ĞµĞ¹ Ğ¼ĞµĞ¶Ğ´Ñƒ Ğ´Ğ²ÑƒĞ¼Ñ Ğ´Ğ°Ñ‚Ğ°Ğ¼Ğ¸
   */
  static getDaysDifference(startDate: Date, endDate: Date): number {
    const timeDiff = endDate.getTime() - startDate.getTime();
    return Math.ceil(timeDiff / (1000 * 3600 * 24));
  }

  /**
   * ĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑĞµÑ‚, Ğ½Ğ°Ñ…Ğ¾Ğ´Ğ¸Ñ‚ÑÑ Ğ»Ğ¸ Ğ´Ğ°Ñ‚Ğ° Ğ² Ğ·Ğ°Ğ´Ğ°Ğ½Ğ½Ğ¾Ğ¼ Ğ´Ğ¸Ğ°Ğ¿Ğ°Ğ·Ğ¾Ğ½Ğµ
   */
  static isDateInRange(date: Date, startDate: Date, endDate: Date): boolean {
    return date >= startDate && date <= endDate;
  }

  /**
   * Ğ¤Ğ¾Ñ€Ğ¼Ğ°Ñ‚Ğ¸Ñ€ÑƒĞµÑ‚ Ğ´Ğ°Ñ‚Ñƒ Ğ² ÑÑ‚Ñ€Ğ¾ĞºÑƒ Ğ´Ğ»Ñ API (YYYY-MM-DD)
   */
  static formatDateForAPI(date: Date): string {
    return date.toISOString().split('T')[0];
  }

  /**
   * ĞŸĞ°Ñ€ÑĞ¸Ñ‚ ÑÑ‚Ñ€Ğ¾ĞºÑƒ Ğ´Ğ°Ñ‚Ñ‹ Ğ² Ğ¾Ğ±ÑŠĞµĞºÑ‚ Date
   */
  static parseDate(dateString: string): Date | null {
    const date = new Date(dateString);
    return this.isValidDate(date) ? date : null;
  }

  /**
   * ĞĞ°Ñ…Ğ¾Ğ´Ğ¸Ñ‚ ÑĞ»ĞµĞ´ÑƒÑÑ‰Ğ¸Ğ¹ Ñ€Ğ°Ğ±Ğ¾Ñ‡Ğ¸Ğ¹ Ğ´ĞµĞ½ÑŒ, Ğ¸ÑĞºĞ»ÑÑ‡Ğ°Ñ Ğ¿Ñ€Ğ°Ğ·Ğ´Ğ½Ğ¸ĞºĞ¸
   * @param startDate - Ğ½Ğ°Ñ‡Ğ°Ğ»ÑŒĞ½Ğ°Ñ Ğ´Ğ°Ñ‚Ğ°
   * @param holidays - Ğ¼Ğ°ÑÑĞ¸Ğ² Ğ´Ğ°Ñ‚ Ğ¿Ñ€Ğ°Ğ·Ğ´Ğ½Ğ¸ĞºĞ¾Ğ²
   * @param daysToAdd - ĞºĞ¾Ğ»Ğ¸Ñ‡ĞµÑÑ‚Ğ²Ğ¾ Ğ´Ğ½ĞµĞ¹ Ğ´Ğ»Ñ Ğ´Ğ¾Ğ±Ğ°Ğ²Ğ»ĞµĞ½Ğ¸Ñ (Ğ¿Ğ¾ ÑƒĞ¼Ğ¾Ğ»Ñ‡Ğ°Ğ½Ğ¸Ñ 1)
   * @returns Ğ”Ğ°Ñ‚Ğ° ÑĞ»ĞµĞ´ÑƒÑÑ‰ĞµĞ³Ğ¾ Ñ€Ğ°Ğ±Ğ¾Ñ‡ĞµĞ³Ğ¾ Ğ´Ğ½Ñ
   */
  static findNextWorkingDay(startDate: Date, holidays: Date[], daysToAdd: number = 1): Date {
    let finalDate = addDays(startDate, daysToAdd);

    // Ğ¡Ğ¾Ğ·Ğ´Ğ°ĞµĞ¼ Set Ğ¸Ğ· Ğ´Ğ°Ñ‚ Ğ¿Ñ€Ğ°Ğ·Ğ´Ğ½Ğ¸ĞºĞ¾Ğ² Ğ´Ğ»Ñ Ğ±Ñ‹ÑÑ‚Ñ€Ğ¾Ğ¹ Ğ¿Ñ€Ğ¾Ğ²ĞµÑ€ĞºĞ¸
    const holidaySet = new Set(holidays.map(h => format(h, 'yyyy-MM-dd')));

    // ĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑĞµĞ¼, Ğ½Ğµ ÑĞ²Ğ»ÑĞµÑ‚ÑÑ Ğ»Ğ¸ ĞºĞ¾Ğ½ĞµÑ‡Ğ½Ğ°Ñ Ğ´Ğ°Ñ‚Ğ° Ğ²Ñ‹Ñ…Ğ¾Ğ´Ğ½Ñ‹Ğ¼.
    // Ğ•ÑĞ»Ğ¸ Ğ´Ğ°, ÑĞ´Ğ²Ğ¸Ğ³Ğ°ĞµĞ¼ ĞµĞµ Ğ²Ğ¿ĞµÑ€ĞµĞ´ Ğ´Ğ¾ Ñ‚ĞµÑ… Ğ¿Ğ¾Ñ€, Ğ¿Ğ¾ĞºĞ° Ğ½Ğµ Ğ½Ğ°Ğ¹Ğ´ĞµĞ¼ Ñ€Ğ°Ğ±Ğ¾Ñ‡Ğ¸Ğ¹ Ğ´ĞµĞ½ÑŒ.
    while (holidaySet.has(format(finalDate, 'yyyy-MM-dd'))) {
      finalDate = addDays(finalDate, 1);
    }

    return finalDate;
  }

  /**
   * Ğ¡Ğ¾Ğ·Ğ´Ğ°ĞµÑ‚ Ğ´Ğ¸Ğ°Ğ¿Ğ°Ğ·Ğ¾Ğ½ Ğ´Ğ°Ñ‚ Ñ Ğ°Ğ²Ñ‚Ğ¾Ğ¼Ğ°Ñ‚Ğ¸Ñ‡ĞµÑĞºĞ¸Ğ¼ Ğ¿Ğ¾Ğ¸ÑĞºĞ¾Ğ¼ Ñ€Ğ°Ğ±Ğ¾Ñ‡ĞµĞ³Ğ¾ Ğ´Ğ½Ñ Ğ¾ĞºĞ¾Ğ½Ñ‡Ğ°Ğ½Ğ¸Ñ
   * @param startDate - Ğ´Ğ°Ñ‚Ğ° Ğ½Ğ°Ñ‡Ğ°Ğ»Ğ°
   * @param holidays - Ğ¼Ğ°ÑÑĞ¸Ğ² Ğ´Ğ°Ñ‚ Ğ¿Ñ€Ğ°Ğ·Ğ´Ğ½Ğ¸ĞºĞ¾Ğ²
   * @param daysToAdd - ĞºĞ¾Ğ»Ğ¸Ñ‡ĞµÑÑ‚Ğ²Ğ¾ Ğ´Ğ½ĞµĞ¹ Ğ´Ğ»Ñ Ğ´Ğ¾Ğ±Ğ°Ğ²Ğ»ĞµĞ½Ğ¸Ñ (Ğ¿Ğ¾ ÑƒĞ¼Ğ¾Ğ»Ñ‡Ğ°Ğ½Ğ¸Ñ 1)
   * @returns ĞĞ±ÑŠĞµĞºÑ‚ Ñ Ğ´Ğ°Ñ‚Ğ°Ğ¼Ğ¸ Ğ½Ğ°Ñ‡Ğ°Ğ»Ğ° Ğ¸ Ğ¾ĞºĞ¾Ğ½Ñ‡Ğ°Ğ½Ğ¸Ñ
   */
  static createWorkingDayRange(startDate: Date, holidays: Date[], daysToAdd: number = 1): DateRange {
    const endDate = this.findNextWorkingDay(startDate, holidays, daysToAdd);
    return {
      startDate,
      endDate
    };
  }
}

```


## <a name="rentalappmainsrccoreservicesEquipmentServicets"></a>`rental-app-main/src/core/services/EquipmentService.ts`

```typescript
// path: rental-app-main/src/core/services/EquipmentService.ts

// src/core/services/EquipmentService.ts

import { api } from "@/lib/api";
import type { Equipment } from "@/types/equipment";
import type { AvailabilityInfo, AvailabilityListResponse } from "@/types/availability";
import { formatDate } from "@/lib/utils"; // 1. Ğ£Ğ±ĞµĞ´Ğ¸Ñ‚ĞµÑÑŒ, Ñ‡Ñ‚Ğ¾ ÑÑ‚Ğ¾Ñ‚ Ğ¸Ğ¼Ğ¿Ğ¾Ñ€Ñ‚ Ğ¿Ñ€Ğ¸ÑÑƒÑ‚ÑÑ‚Ğ²ÑƒĞµÑ‚

export interface EquipmentListResponse {
    items: Equipment[];
    total: number;
}

export interface EquipmentFilterParams {
    query?: string;
    type?: string | null;
    brand?: string | null;
    associationId?: number | null;
    startDate?: Date | null;
    endDate?: Date | null;
    availableOnly?: boolean;
}

export class EquipmentService {
    static async getAllEquipment(
        skip: number,
        limit: number,
        filters: EquipmentFilterParams = {}
    ): Promise<EquipmentListResponse> {
        const params: Record<string, any> = { skip, limit };

        if (filters.query) {
            params.query = filters.query;
        }
        if (filters.type) {
            params.type = filters.type;
        }
        if (filters.brand) {
            params.brand = filters.brand;
        }
        if (filters.associationId) {
            params.associationId = filters.associationId;
        }

        if (filters.availableOnly && filters.startDate && filters.endDate) {
            params.availableOnly = true;
            params.startDate = formatDate(filters.startDate);
            params.endDate = formatDate(filters.endDate);
        }

        const response = await api.get<EquipmentListResponse>("/equipment/", { params });
        return response.data;
    }

    static async checkAvailability(input: { ids: number[]; start: Date | null; end: Date | null; excludeReservationId?: number; }): Promise<AvailabilityInfo[]> {
        if (!input.start || !input.end || input.ids.length === 0) {
            return [];
        }

        const searchParams = new URLSearchParams();

        // V-- 2. Ğ˜Ğ¡ĞŸĞ ĞĞ’Ğ›Ğ•ĞĞ˜Ğ• Ğ—Ğ”Ğ•Ğ¡Ğ¬ --V
        searchParams.append("start", formatDate(input.start));
        searchParams.append("end", formatDate(input.end));
        // ^-- ĞšĞĞĞ•Ğ¦ Ğ˜Ğ¡ĞŸĞ ĞĞ’Ğ›Ğ•ĞĞ˜Ğ¯ --^

        input.ids.forEach(id => {
            searchParams.append("ids", id.toString());
        });

        if (input.excludeReservationId !== undefined) {
            searchParams.append("exclude_reservation_id", input.excludeReservationId.toString());
        }

        const response = await api.get<AvailabilityListResponse>(`/calendar/view?${searchParams.toString()}`);
        return response.data.items;
    }

    static filterAndGroupEquipment(
        allEquipment: Equipment[],
        searchQuery: string
    ): { tree: Record<string, Record<string, Equipment[]>>; visibleIds: number[] } {
        const lowerCaseQuery = searchQuery.toLowerCase();
        const filtered = searchQuery
            ? allEquipment.filter(item =>
                item.name.toLowerCase().includes(lowerCaseQuery) ||
                item.brand.toLowerCase().includes(lowerCaseQuery) ||
                item.equipment_type.toLowerCase().includes(lowerCaseQuery)
            )
            : allEquipment;

        const visibleIds = filtered.map(item => item.id);

        const tree: Record<string, Record<string, Equipment[]>> = {};
        for (const eq of filtered) {
            if (!tree[eq.equipment_type]) {
                tree[eq.equipment_type] = {};
            }
            if (!tree[eq.equipment_type][eq.brand]) {
                tree[eq.equipment_type][eq.brand] = [];
            }
            tree[eq.equipment_type][eq.brand].push(eq);
        }

        return { tree, visibleIds };
    }

    static filterEquipment(
        equipmentData: Equipment[],
        params: EquipmentFilterParams
    ): Equipment[] {
        let result = equipmentData;
        if (params.query) {
            const lowerCaseQuery = params.query.toLowerCase();
            result = result.filter((item) =>
                item.name.toLowerCase().includes(lowerCaseQuery) ||
                item.brand.toLowerCase().includes(lowerCaseQuery) ||
                item.equipment_type.toLowerCase().includes(lowerCaseQuery)
            );
        }
        if (params.type) {
            result = result.filter((item) => item.equipment_type === params.type);
        }
        if (params.brand && params.brand !== "__all__") {
            result = result.filter((item) => item.brand === params.brand);
        }
        return result;
    }

    static async getEquipmentById(id: number): Promise<Equipment> {
        const response = await api.get(`/equipment/${id}`);
        return response.data;
    }

    static async createEquipment(input: Omit<Equipment, 'id' | 'accessories' | 'associations'>): Promise<Equipment> {
        const response = await api.post("/equipment/", input);
        return response.data;
    }

    static async updateEquipment(id: number, input: Partial<Omit<Equipment, 'id'>>): Promise<Equipment> {
        const response = await api.put(`/equipment/${id}`, input);
        return response.data;
    }

    static async deleteEquipment(id: number): Promise<void> {
        await api.delete(`/equipment/${id}`);
    }
}

```


## <a name="rentalappmainsrccoreservicesPhoneServicets"></a>`rental-app-main/src/core/services/PhoneService.ts`

```typescript
// path: rental-app-main/src/core/services/PhoneService.ts

// src/core/services/PhoneService.ts

export interface PhoneValidationResult {
  isValid: boolean;
  error?: string;
  normalizedPhone?: string;
}

export class PhoneService {
  /**
   * Ğ’Ğ°Ğ»Ğ¸Ğ´Ğ¸Ñ€ÑƒĞµÑ‚ Ñ€Ğ¾ÑÑĞ¸Ğ¹ÑĞºĞ¸Ğ¹ Ñ‚ĞµĞ»ĞµÑ„Ğ¾Ğ½Ğ½Ñ‹Ğ¹ Ğ½Ğ¾Ğ¼ĞµÑ€
   */
  static validate(phone: string): PhoneValidationResult {
    if (!phone) {
      return {
        isValid: false,
        error: 'ĞĞ¾Ğ¼ĞµÑ€ Ñ‚ĞµĞ»ĞµÑ„Ğ¾Ğ½Ğ° Ğ¾Ğ±ÑĞ·Ğ°Ñ‚ĞµĞ»ĞµĞ½'
      };
    }

    const normalized = this.normalize(phone);
    
    // ĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑĞµĞ¼, Ñ‡Ñ‚Ğ¾ Ğ½Ğ¾Ğ¼ĞµÑ€ ÑĞ¾Ğ´ĞµÑ€Ğ¶Ğ¸Ñ‚ Ñ‚Ğ¾Ğ»ÑŒĞºĞ¾ Ñ†Ğ¸Ñ„Ñ€Ñ‹
    if (!/^\d+$/.test(normalized)) {
      return {
        isValid: false,
        error: 'ĞĞ¾Ğ¼ĞµÑ€ Ğ´Ğ¾Ğ»Ğ¶ĞµĞ½ ÑĞ¾Ğ´ĞµÑ€Ğ¶Ğ°Ñ‚ÑŒ Ñ‚Ğ¾Ğ»ÑŒĞºĞ¾ Ñ†Ğ¸Ñ„Ñ€Ñ‹'
      };
    }

    // ĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑĞµĞ¼ Ğ´Ğ»Ğ¸Ğ½Ñƒ (10 Ğ¸Ğ»Ğ¸ 11 Ñ†Ğ¸Ñ„Ñ€ Ğ´Ğ»Ñ Ñ€Ğ¾ÑÑĞ¸Ğ¹ÑĞºĞ¸Ñ… Ğ½Ğ¾Ğ¼ĞµÑ€Ğ¾Ğ²)
    if (normalized.length < 10 || normalized.length > 11) {
      return {
        isValid: false,
        error: 'ĞĞ¾Ğ¼ĞµÑ€ Ğ´Ğ¾Ğ»Ğ¶ĞµĞ½ ÑĞ¾Ğ´ĞµÑ€Ğ¶Ğ°Ñ‚ÑŒ 10 Ğ¸Ğ»Ğ¸ 11 Ñ†Ğ¸Ñ„Ñ€'
      };
    }

    // Ğ•ÑĞ»Ğ¸ 11 Ñ†Ğ¸Ñ„Ñ€, Ğ¿ĞµÑ€Ğ²Ğ°Ñ Ğ´Ğ¾Ğ»Ğ¶Ğ½Ğ° Ğ±Ñ‹Ñ‚ÑŒ 7 Ğ¸Ğ»Ğ¸ 8
    if (normalized.length === 11 && !['7', '8'].includes(normalized[0])) {
      return {
        isValid: false,
        error: 'ĞĞ¾Ğ¼ĞµÑ€ Ğ´Ğ¾Ğ»Ğ¶ĞµĞ½ Ğ½Ğ°Ñ‡Ğ¸Ğ½Ğ°Ñ‚ÑŒÑÑ Ñ 7 Ğ¸Ğ»Ğ¸ 8'
      };
    }

    return {
      isValid: true,
      normalizedPhone: normalized
    };
  }

  /**
   * ĞĞ¾Ñ€Ğ¼Ğ°Ğ»Ğ¸Ğ·ÑƒĞµÑ‚ Ñ‚ĞµĞ»ĞµÑ„Ğ¾Ğ½Ğ½Ñ‹Ğ¹ Ğ½Ğ¾Ğ¼ĞµÑ€ (ÑƒĞ±Ğ¸Ñ€Ğ°ĞµÑ‚ Ğ²ÑĞµ ÑĞ¸Ğ¼Ğ²Ğ¾Ğ»Ñ‹ ĞºÑ€Ğ¾Ğ¼Ğµ Ñ†Ğ¸Ñ„Ñ€)
   */
  static normalize(phone: string): string {
    return phone.replace(/\D/g, '');
  }

  /**
   * Ğ¤Ğ¾Ñ€Ğ¼Ğ°Ñ‚Ğ¸Ñ€ÑƒĞµÑ‚ Ñ‚ĞµĞ»ĞµÑ„Ğ¾Ğ½Ğ½Ñ‹Ğ¹ Ğ½Ğ¾Ğ¼ĞµÑ€ Ğ´Ğ»Ñ Ğ¾Ñ‚Ğ¾Ğ±Ñ€Ğ°Ğ¶ĞµĞ½Ğ¸Ñ
   */
  static format(phone: string): string {
    const normalized = this.normalize(phone);
    
    if (normalized.length === 11) {
      // +7 (XXX) XXX-XX-XX
      return `+7 (${normalized.slice(1, 4)}) ${normalized.slice(4, 7)}-${normalized.slice(7, 9)}-${normalized.slice(9)}`;
    } else if (normalized.length === 10) {
      // +7 (XXX) XXX-XX-XX (Ğ´Ğ¾Ğ±Ğ°Ğ²Ğ»ÑĞµĞ¼ 7 Ğ² Ğ½Ğ°Ñ‡Ğ°Ğ»Ğ¾)
      return `+7 (${normalized.slice(0, 3)}) ${normalized.slice(3, 6)}-${normalized.slice(6, 8)}-${normalized.slice(8)}`;
    }
    
    return phone; // Ğ’Ğ¾Ğ·Ğ²Ñ€Ğ°Ñ‰Ğ°ĞµĞ¼ ĞºĞ°Ğº ĞµÑÑ‚ÑŒ, ĞµÑĞ»Ğ¸ Ğ½Ğµ ÑƒĞ´Ğ°ĞµÑ‚ÑÑ Ğ¾Ñ‚Ñ„Ğ¾Ñ€Ğ¼Ğ°Ñ‚Ğ¸Ñ€Ğ¾Ğ²Ğ°Ñ‚ÑŒ
  }

  /**
   * ĞŸĞ¾Ğ»ÑƒÑ‡Ğ°ĞµÑ‚ Ğ¿Ğ¾Ğ»Ğ½Ñ‹Ğ¹ Ğ½Ğ¾Ğ¼ĞµÑ€ Ğ´Ğ»Ñ API (Ğ²ÑĞµĞ³Ğ´Ğ° 11 Ñ†Ğ¸Ñ„Ñ€ Ñ 7 Ğ² Ğ½Ğ°Ñ‡Ğ°Ğ»Ğµ)
   */
  static getFullNumber(phone: string): string {
    const normalized = this.normalize(phone);
    
    if (normalized.length === 11) {
      return normalized;
    } else if (normalized.length === 10) {
      return `7${normalized}`;
    }
    
    return normalized; // Ğ’Ğ¾Ğ·Ğ²Ñ€Ğ°Ñ‰Ğ°ĞµĞ¼ ĞºĞ°Ğº ĞµÑÑ‚ÑŒ, ĞµÑĞ»Ğ¸ Ğ½Ğµ ÑƒĞ´Ğ°ĞµÑ‚ÑÑ Ğ¾Ğ±Ñ€Ğ°Ğ±Ğ¾Ñ‚Ğ°Ñ‚ÑŒ
  }
} 

```


## <a name="rentalappmainsrccoreservicesPromoCodeServicets"></a>`rental-app-main/src/core/services/PromoCodeService.ts`

```typescript
// path: rental-app-main/src/core/services/PromoCodeService.ts

// src/core/services/PromoCodeService.ts

import { api } from "@/lib/api";
import type { PromoCodeOut, PromoCodeCreate, PromoCodeUpdate } from "@/types/promo_code";

export interface PromoCodeValidationResult {
    isValid: boolean;
    message: string | null;
    discountPercentage: number;
}

export interface PromoCodeFilterOptions {
    isActive?: boolean;
    search?: string;
}

export class PromoCodeService {
    /**
     * ĞŸĞ¾Ğ»ÑƒÑ‡Ğ°ĞµÑ‚ Ğ²ÑĞµ Ğ¿Ñ€Ğ¾Ğ¼Ğ¾ĞºĞ¾Ğ´Ñ‹
     */
    static async getAllPromoCodes(): Promise<PromoCodeOut[]> {
        const response = await api.get("/promocodes/");
        return response.data;
    }

    /**
     * ĞŸĞ¾Ğ»ÑƒÑ‡Ğ°ĞµÑ‚ Ğ¿Ñ€Ğ¾Ğ¼Ğ¾ĞºĞ¾Ğ´ Ğ¿Ğ¾ ID
     */
    static async getPromoCodeById(id: number): Promise<PromoCodeOut> {
        const response = await api.get(`/promocodes/${id}`);
        return response.data;
    }

    /**
     * Ğ¡Ğ¾Ğ·Ğ´Ğ°ĞµÑ‚ Ğ½Ğ¾Ğ²Ñ‹Ğ¹ Ğ¿Ñ€Ğ¾Ğ¼Ğ¾ĞºĞ¾Ğ´
     */
    static async createPromoCode(input: PromoCodeCreate): Promise<PromoCodeOut> {
        const response = await api.post("/promocodes/", input);
        return response.data;
    }

    /**
     * ĞĞ±Ğ½Ğ¾Ğ²Ğ»ÑĞµÑ‚ Ğ¿Ñ€Ğ¾Ğ¼Ğ¾ĞºĞ¾Ğ´
     */
    static async updatePromoCode(id: number, input: PromoCodeUpdate): Promise<PromoCodeOut> {
        const response = await api.put(`/promocodes/${id}`, input);
        return response.data;
    }

    /**
     * Ğ£Ğ´Ğ°Ğ»ÑĞµÑ‚ Ğ¿Ñ€Ğ¾Ğ¼Ğ¾ĞºĞ¾Ğ´
     */
    static async deletePromoCode(id: number): Promise<void> {
        await api.delete(`/promocodes/${id}`);
    }

    /**
     * ĞĞºÑ‚Ğ¸Ğ²Ğ¸Ñ€ÑƒĞµÑ‚/Ğ´ĞµĞ°ĞºÑ‚Ğ¸Ğ²Ğ¸Ñ€ÑƒĞµÑ‚ Ğ¿Ñ€Ğ¾Ğ¼Ğ¾ĞºĞ¾Ğ´
     */
    static async togglePromoCodeStatus(id: number, isActive: boolean): Promise<PromoCodeOut> {
        const response = await api.patch(`/promocodes/${id}/toggle-status`, { is_active: isActive });
        return response.data;
    }

    /**
     * Ğ’Ğ°Ğ»Ğ¸Ğ´Ğ¸Ñ€ÑƒĞµÑ‚ Ğ¿Ñ€Ğ¾Ğ¼Ğ¾ĞºĞ¾Ğ´ Ğ´Ğ»Ñ ĞºĞ¾Ğ½ĞºÑ€ĞµÑ‚Ğ½Ğ¾Ğ³Ğ¾ Ğ·Ğ°ĞºĞ°Ğ·Ğ°
     */
    static async validatePromoCode(
        code: string,
        equipmentIds: number[],
        totalAmount: number,
        userId?: number
    ): Promise<PromoCodeValidationResult> {
        try {
            const response = await api.post("/promocodes/validate", {
                code,
                equipment_ids: equipmentIds,
                total_amount: totalAmount,
                user_id: userId
            });
            return response.data;
        } catch (error: any) {
            return {
                isValid: false,
                message: error.response?.data?.detail || "ĞŸÑ€Ğ¾Ğ¼Ğ¾ĞºĞ¾Ğ´ Ğ½ĞµĞ´ĞµĞ¹ÑÑ‚Ğ²Ğ¸Ñ‚ĞµĞ»ĞµĞ½",
                discountPercentage: 0
            };
        }
    }

    /**
     * Ğ¤Ğ¸Ğ»ÑŒÑ‚Ñ€ÑƒĞµÑ‚ Ğ¿Ñ€Ğ¾Ğ¼Ğ¾ĞºĞ¾Ğ´Ñ‹ Ğ¿Ğ¾ Ğ·Ğ°Ğ´Ğ°Ğ½Ğ½Ñ‹Ğ¼ ĞºÑ€Ğ¸Ñ‚ĞµÑ€Ğ¸ÑĞ¼
     */
    static filterPromoCodes(
        promoCodes: PromoCodeOut[],
        filters: PromoCodeFilterOptions
    ): PromoCodeOut[] {
        return promoCodes.filter(promo => {
            // Ğ¤Ğ¸Ğ»ÑŒÑ‚Ñ€ Ğ¿Ğ¾ Ğ°ĞºÑ‚Ğ¸Ğ²Ğ½Ğ¾ÑÑ‚Ğ¸
            if (filters.isActive !== undefined && promo.is_active !== filters.isActive) {
                return false;
            }

            // Ğ¤Ğ¸Ğ»ÑŒÑ‚Ñ€ Ğ¿Ğ¾ Ğ¿Ğ¾Ğ¸ÑĞºÑƒ
            if (filters.search) {
                const searchLower = filters.search.toLowerCase();
                const matchesSearch = 
                    promo.code.toLowerCase().includes(searchLower) ||
                    (promo.description && promo.description.toLowerCase().includes(searchLower));
                
                if (!matchesSearch) {
                    return false;
                }
            }

            return true;
        });
    }

    /**
     * Ğ’Ğ°Ğ»Ğ¸Ğ´Ğ¸Ñ€ÑƒĞµÑ‚ Ğ´Ğ°Ğ½Ğ½Ñ‹Ğµ Ğ¿Ñ€Ğ¾Ğ¼Ğ¾ĞºĞ¾Ğ´Ğ° Ğ¿ĞµÑ€ĞµĞ´ ÑĞ¾Ğ·Ğ´Ğ°Ğ½Ğ¸ĞµĞ¼/Ğ¾Ğ±Ğ½Ğ¾Ğ²Ğ»ĞµĞ½Ğ¸ĞµĞ¼
     */
    static validatePromoCodeData(input: PromoCodeCreate): { isValid: boolean; errors: string[] } {
        const errors: string[] = [];

        if (!input.code?.trim()) {
            errors.push("ĞšĞ¾Ğ´ Ğ¿Ñ€Ğ¾Ğ¼Ğ¾ĞºĞ¾Ğ´Ğ° Ğ¾Ğ±ÑĞ·Ğ°Ñ‚ĞµĞ»ĞµĞ½");
        }

        if (input.discount_percentage <= 0 || input.discount_percentage > 100) {
            errors.push("ĞŸÑ€Ğ¾Ñ†ĞµĞ½Ñ‚ ÑĞºĞ¸Ğ´ĞºĞ¸ Ğ´Ğ¾Ğ»Ğ¶ĞµĞ½ Ğ±Ñ‹Ñ‚ÑŒ Ğ¾Ñ‚ 1 Ğ´Ğ¾ 100");
        }

        if (input.valid_from && input.expires_at) {
            const validFrom = new Date(input.valid_from);
            const expiresAt = new Date(input.expires_at);
            
            if (validFrom >= expiresAt) {
                errors.push("Ğ”Ğ°Ñ‚Ğ° Ğ¾ĞºĞ¾Ğ½Ñ‡Ğ°Ğ½Ğ¸Ñ Ğ´Ğ¾Ğ»Ğ¶Ğ½Ğ° Ğ±Ñ‹Ñ‚ÑŒ Ğ¿Ğ¾Ğ·Ğ¶Ğµ Ğ´Ğ°Ñ‚Ñ‹ Ğ½Ğ°Ñ‡Ğ°Ğ»Ğ°");
            }
        }

        if (input.max_uses !== null && input.max_uses <= 0) {
            errors.push("ĞœĞ°ĞºÑĞ¸Ğ¼Ğ°Ğ»ÑŒĞ½Ğ¾Ğµ ĞºĞ¾Ğ»Ğ¸Ñ‡ĞµÑÑ‚Ğ²Ğ¾ Ğ¸ÑĞ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğ¹ Ğ´Ğ¾Ğ»Ğ¶Ğ½Ğ¾ Ğ±Ñ‹Ñ‚ÑŒ Ğ±Ğ¾Ğ»ÑŒÑˆĞµ Ğ½ÑƒĞ»Ñ");
        }

        if (input.max_uses_per_user !== null && input.max_uses_per_user <= 0) {
            errors.push("ĞœĞ°ĞºÑĞ¸Ğ¼Ğ°Ğ»ÑŒĞ½Ğ¾Ğµ ĞºĞ¾Ğ»Ğ¸Ñ‡ĞµÑÑ‚Ğ²Ğ¾ Ğ¸ÑĞ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğ¹ Ğ½Ğ° Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ñ Ğ´Ğ¾Ğ»Ğ¶Ğ½Ğ¾ Ğ±Ñ‹Ñ‚ÑŒ Ğ±Ğ¾Ğ»ÑŒÑˆĞµ Ğ½ÑƒĞ»Ñ");
        }

        if (input.min_order_amount !== null && input.min_order_amount <= 0) {
            errors.push("ĞœĞ¸Ğ½Ğ¸Ğ¼Ğ°Ğ»ÑŒĞ½Ğ°Ñ ÑÑƒĞ¼Ğ¼Ğ° Ğ·Ğ°ĞºĞ°Ğ·Ğ° Ğ´Ğ¾Ğ»Ğ¶Ğ½Ğ° Ğ±Ñ‹Ñ‚ÑŒ Ğ±Ğ¾Ğ»ÑŒÑˆĞµ Ğ½ÑƒĞ»Ñ");
        }

        return {
            isValid: errors.length === 0,
            errors
        };
    }

    /**
     * ĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑĞµÑ‚, Ğ°ĞºÑ‚Ğ¸Ğ²ĞµĞ½ Ğ»Ğ¸ Ğ¿Ñ€Ğ¾Ğ¼Ğ¾ĞºĞ¾Ğ´ Ğ² Ğ´Ğ°Ğ½Ğ½Ñ‹Ğ¹ Ğ¼Ğ¾Ğ¼ĞµĞ½Ñ‚
     */
    static isPromoCodeActive(promoCode: PromoCodeOut): boolean {
        if (!promoCode.is_active) {
            return false;
        }

        const now = new Date();

        // ĞŸÑ€Ğ¾Ğ²ĞµÑ€ĞºĞ° Ğ´Ğ°Ñ‚Ñ‹ Ğ½Ğ°Ñ‡Ğ°Ğ»Ğ°
        if (promoCode.valid_from) {
            const validFrom = new Date(promoCode.valid_from);
            if (now < validFrom) {
                return false;
            }
        }

        // ĞŸÑ€Ğ¾Ğ²ĞµÑ€ĞºĞ° Ğ´Ğ°Ñ‚Ñ‹ Ğ¾ĞºĞ¾Ğ½Ñ‡Ğ°Ğ½Ğ¸Ñ
        if (promoCode.expires_at) {
            const expiresAt = new Date(promoCode.expires_at);
            if (now > expiresAt) {
                return false;
            }
        }

        // ĞŸÑ€Ğ¾Ğ²ĞµÑ€ĞºĞ° Ğ¼Ğ°ĞºÑĞ¸Ğ¼Ğ°Ğ»ÑŒĞ½Ğ¾Ğ³Ğ¾ ĞºĞ¾Ğ»Ğ¸Ñ‡ĞµÑÑ‚Ğ²Ğ° Ğ¸ÑĞ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğ¹
        if (promoCode.max_uses !== null && promoCode.times_used >= promoCode.max_uses) {
            return false;
        }

        return true;
    }

    /**
     * Ğ“ĞµĞ½ĞµÑ€Ğ¸Ñ€ÑƒĞµÑ‚ ĞºĞ»ÑÑ‡ Ğ´Ğ»Ñ ĞºÑÑˆĞ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ Ğ¿Ñ€Ğ¾Ğ¼Ğ¾ĞºĞ¾Ğ´Ğ¾Ğ²
     */
    static generatePromoCodesCacheKey(filters?: PromoCodeFilterOptions): string {
        return JSON.stringify(["promo-codes", filters]);
    }

    /**
     * Ğ“ĞµĞ½ĞµÑ€Ğ¸Ñ€ÑƒĞµÑ‚ ĞºĞ»ÑÑ‡ Ğ´Ğ»Ñ ĞºÑÑˆĞ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ Ğ²Ğ°Ğ»Ğ¸Ğ´Ğ°Ñ†Ğ¸Ğ¸ Ğ¿Ñ€Ğ¾Ğ¼Ğ¾ĞºĞ¾Ğ´Ğ°
     */
    static generateValidationCacheKey(
        code: string,
        equipmentIds: number[],
        totalAmount: number,
        userId?: number
    ): string {
        return JSON.stringify([
            "promo-code-validation",
            code,
            equipmentIds.sort(),
            totalAmount,
            userId
        ]);
    }
} 

```


## <a name="rentalappmainsrccoreservicesReservationServicets"></a>`rental-app-main/src/core/services/ReservationService.ts`

```typescript
// path: rental-app-main/src/core/services/ReservationService.ts

// src/core/services/ReservationService.ts

import { api } from "@/lib/api";
import type { Equipment } from "@/types/equipment";
import type { Reservation, ReservationWithNames, ReservationListResponse } from "@/types/reservation";

// Ğ•Ğ´Ğ¸Ğ½Ñ‹Ğ¹ Ñ‚Ğ¸Ğ¿ Ğ´Ğ»Ñ ÑĞ¾Ğ·Ğ´Ğ°Ğ½Ğ¸Ñ Ñ€ĞµĞ·ĞµÑ€Ğ²Ğ°, ĞºĞ¾Ñ‚Ğ¾Ñ€Ñ‹Ğ¹ Ğ±ÑƒĞ´ĞµÑ‚ Ğ¸ÑĞ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ÑŒÑÑ Ğ²ĞµĞ·Ğ´Ğµ
export interface ReservationCreateInput {
    user_id?: number;
    start_date: string;
    end_date: string;
    equipment_ids: number[];
    selected_accessories: Record<number, number[]>;
    promo_code?: string;
}

export interface ReservationUpdateInput {
    id: number;
    start_date: string;
    end_date: string;
    equipment_ids: number[];
    selected_accessories: Record<number, number[]>;
    promo_code?: string;
    isAdminContext?: boolean;
}

export class ReservationService {
    /**
     * Ğ Ğ°ÑÑÑ‡Ğ¸Ñ‚Ñ‹Ğ²Ğ°ĞµÑ‚ ÑÑ‚Ğ¾Ğ¸Ğ¼Ğ¾ÑÑ‚ÑŒ Ñ€ĞµĞ·ĞµÑ€Ğ²Ğ°
     */
    static async calculatePrice(input: Omit<ReservationCreateInput, 'user_id'>): Promise<any> {
        const payload = {
            ...input,
            selected_accessories: input.selected_accessories || {},
            promo_code: input.promo_code || null,
        };

        const response = await api.post("/reservations/calculate", payload);
        return response.data;
    }

    /**
     * Ğ¡Ğ¾Ğ·Ğ´Ğ°ĞµÑ‚ Ğ½Ğ¾Ğ²Ñ‹Ğ¹ Ñ€ĞµĞ·ĞµÑ€Ğ²
     */
    static async createReservation(input: ReservationCreateInput) {
        const { user_id, ...payload } = input;
        const finalPayload = user_id !== undefined ? { user_id, ...payload } : payload;

        const response = await api.post("/reservations/", finalPayload);
        return response.data;
    }

    /**
     * ĞĞ±Ğ½Ğ¾Ğ²Ğ»ÑĞµÑ‚ ÑÑƒÑ‰ĞµÑÑ‚Ğ²ÑƒÑÑ‰Ğ¸Ğ¹ Ñ€ĞµĞ·ĞµÑ€Ğ²
     */
    static async updateReservation(input: ReservationUpdateInput) {
        const { isAdminContext, id, ...payload } = input;
        const url = isAdminContext
            ? `/admin/reservations/${id}`
            : `/reservations/${id}`;

        const response = await api.put(url, payload);
        return response.data;
    }

    /**
     * ĞÑ‚Ğ¼ĞµĞ½ÑĞµÑ‚ Ñ€ĞµĞ·ĞµÑ€Ğ²
     */
    static async cancelReservation(id: number) {
        const response = await api.delete(`/reservations/${id}`);
        return response.data;
    }

    /**
     * ĞŸĞ¾Ğ»ÑƒÑ‡Ğ°ĞµÑ‚ ÑĞ¿Ğ¸ÑĞ¾Ğº Ñ€ĞµĞ·ĞµÑ€Ğ²Ğ¾Ğ² Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ñ
     */
    static async getUserReservations(params?: { search?: string; status?: string; sort?: string }): Promise<Reservation[]> {
        // Ğ£ĞºĞ°Ğ·Ñ‹Ğ²Ğ°ĞµĞ¼, Ñ‡Ñ‚Ğ¾ Ğ¾Ğ¶Ğ¸Ğ´Ğ°ĞµĞ¼ Ğ¾Ğ±ÑŠĞµĞºÑ‚ Ñ Ğ¿Ğ°Ğ³Ğ¸Ğ½Ğ°Ñ†Ğ¸ĞµĞ¹
        const response = await api.get<ReservationListResponse>("/reservations/", {
            params: params ? {
                search: params.search,
                status: params.status,
                sort: params.sort
            } : undefined
        });
        // Ğ’Ğ¾Ğ·Ğ²Ñ€Ğ°Ñ‰Ğ°ĞµĞ¼ Ñ‚Ğ¾Ğ»ÑŒĞºĞ¾ Ğ¼Ğ°ÑÑĞ¸Ğ² items
        return response.data.items;
    }

    /**
     * ĞŸĞ¾Ğ»ÑƒÑ‡Ğ°ĞµÑ‚ Ğ²ÑĞµ Ñ€ĞµĞ·ĞµÑ€Ğ²Ñ‹ (Ğ´Ğ»Ñ Ğ°Ğ´Ğ¼Ğ¸Ğ½Ğ°)
     */
    static async getAllReservations() {
        // ĞŸÑ€Ğ¸Ğ¼ĞµÑ‡Ğ°Ğ½Ğ¸Ğµ: ÑÑ‚Ğ¾Ñ‚ Ğ¼ĞµÑ‚Ğ¾Ğ´ Ğ½Ğµ Ğ¸ÑĞ¿Ğ¾Ğ»ÑŒĞ·ÑƒĞµÑ‚ÑÑ Ğ´Ğ»Ñ Ğ¿Ğ°Ğ³Ğ¸Ğ½Ğ°Ñ†Ğ¸Ğ¸, Ğ½Ğ¾ Ğ¾ÑÑ‚Ğ°Ğ²Ğ»ĞµĞ½ Ğ´Ğ»Ñ ÑĞ¾Ğ²Ğ¼ĞµÑÑ‚Ğ¸Ğ¼Ğ¾ÑÑ‚Ğ¸.
        // Ğ”Ğ»Ñ Ğ¿Ğ°Ğ³Ğ¸Ğ½Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ½Ğ¾Ğ³Ğ¾ ÑĞ¿Ğ¸ÑĞºĞ° Ğ°Ğ´Ğ¼Ğ¸Ğ½Ğ° Ğ¸ÑĞ¿Ğ¾Ğ»ÑŒĞ·ÑƒĞµÑ‚ÑÑ /admin/reservations
        const response = await api.get("/reservations/");
        return response.data;
    }

    /**
     * ĞŸĞ¾Ğ»ÑƒÑ‡Ğ°ĞµÑ‚ Ğ´ĞµÑ‚Ğ°Ğ»Ğ¸ Ñ€ĞµĞ·ĞµÑ€Ğ²Ğ° Ğ¿Ğ¾ ID
     */
    static async getReservationById(id: number) {
        const response = await api.get(`/reservations/${id}`);
        return response.data;
    }

    /**
     * ĞŸÑ€ĞµĞ¾Ğ±Ñ€Ğ°Ğ·ÑƒĞµÑ‚ Ñ€ĞµĞ·ĞµÑ€Ğ²Ñ‹, Ğ´Ğ¾Ğ±Ğ°Ğ²Ğ»ÑÑ Ğ¸Ğ¼ĞµĞ½Ğ° Ğ¾Ğ±Ğ¾Ñ€ÑƒĞ´Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ
     */
    static createReservationsWithNames(
        reservationsData: Reservation[],
        equipmentMap: Record<number, Equipment>
    ): ReservationWithNames[] {
        if (!reservationsData || reservationsData.length === 0) {
            return [];
        }

        return reservationsData.map((r: Reservation) => ({
            ...r,
            equipment_names: r.equipment_ids
                .map((id: number) => equipmentMap[id])
                .filter((eq): eq is Equipment => Boolean(eq))
                .map((eq: Equipment) => `${eq.equipment_type} ${eq.brand} ${eq.name}`),
        }));
    }
}

```


## <a name="rentalappmainsrccoreservicesUserServicets"></a>`rental-app-main/src/core/services/UserService.ts`

```typescript
// path: rental-app-main/src/core/services/UserService.ts

// src/core/services/UserService.ts

import { api } from "@/lib/api";
import type { UserOut, UserRole, UserListResponse, UserPaymentRequest } from "@/types/user";
import type { BalanceHistoryListResponse } from "@/types/balanceHistory";

export interface UserCreateInput {
    full_name: string;
    email: string;
    password: string;
    role: UserRole;
    phone?: string;
    privacyPolicyAccepted: boolean;
    termsAccepted: boolean;
    emailVerified: boolean;
}

export interface UserUpdateInput extends Partial<UserCreateInput> {
    id: number;
}

export interface UserFilterOptions {
    search?: string;
    role?: UserRole;
    isActive?: boolean;
    status?: string;
}

export interface UserValidationResult {
    isValid: boolean;
    errors: string[];
}

export class UserService {
    /**
     * ĞŸÑ€ĞµĞ¾Ğ±Ñ€Ğ°Ğ·ÑƒĞµÑ‚ camelCase Ğ¿Ğ¾Ğ»Ñ Ğ² snake_case Ğ´Ğ»Ñ API
     */
    private static toApiFormat(input: Partial<UserCreateInput>): Record<string, any> {
        const apiPayload: Record<string, any> = {};

        if (input.full_name !== undefined) apiPayload.full_name = input.full_name;
        if (input.email !== undefined) apiPayload.email = input.email;
        if (input.password !== undefined) apiPayload.password = input.password;
        if (input.role !== undefined) apiPayload.role = input.role;
        if (input.phone !== undefined) apiPayload.phone = input.phone;
        if (input.privacyPolicyAccepted !== undefined) apiPayload.privacy_policy_accepted = input.privacyPolicyAccepted;
        if (input.termsAccepted !== undefined) apiPayload.terms_accepted = input.termsAccepted;
        if (input.emailVerified !== undefined) apiPayload.email_verified = input.emailVerified;

        return apiPayload;
    }

    /**
     * ĞŸĞ¾Ğ»ÑƒÑ‡Ğ°ĞµÑ‚ Ğ²ÑĞµÑ… Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ĞµĞ¹ Ñ Ğ¿Ğ°Ğ³Ğ¸Ğ½Ğ°Ñ†Ğ¸ĞµĞ¹
     */
    static async getAllUsers(skip: number = 0, limit: number = 15): Promise<UserListResponse> {
        try {
            const response = await api.get<UserListResponse>("/user/admin/users", {
                params: { skip, limit }
            });
            return response.data;
        } catch (error) {
            console.error("ĞÑˆĞ¸Ğ±ĞºĞ° Ğ¿Ñ€Ğ¸ Ğ¿Ğ¾Ğ»ÑƒÑ‡ĞµĞ½Ğ¸Ğ¸ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ĞµĞ¹:", error);
            throw error;
        }
    }

    /**
     * ĞŸĞ¾Ğ»ÑƒÑ‡Ğ°ĞµÑ‚ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ñ Ğ¿Ğ¾ ID
     */
    static async getUserById(id: number): Promise<UserOut> {
        try {
            const response = await api.get(`/user/admin/users/${id}`);
            return response.data;
        } catch (error) {
            console.error(`ĞÑˆĞ¸Ğ±ĞºĞ° Ğ¿Ñ€Ğ¸ Ğ¿Ğ¾Ğ»ÑƒÑ‡ĞµĞ½Ğ¸Ğ¸ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ñ Ñ ID ${id}:`, error);
            throw error;
        }
    }

    /**
     * Ğ¡Ğ¾Ğ·Ğ´Ğ°ĞµÑ‚ Ğ½Ğ¾Ğ²Ğ¾Ğ³Ğ¾ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ñ
     */
    static async createUser(input: UserCreateInput): Promise<UserOut> {
        try {
            const apiPayload = this.toApiFormat(input);
            const response = await api.post("/user/admin/users", apiPayload);
            return response.data;
        } catch (error) {
            console.error("ĞÑˆĞ¸Ğ±ĞºĞ° Ğ¿Ñ€Ğ¸ ÑĞ¾Ğ·Ğ´Ğ°Ğ½Ğ¸Ğ¸ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ñ:", error);
            throw error;
        }
    }

    /**
     * ĞĞ±Ğ½Ğ¾Ğ²Ğ»ÑĞµÑ‚ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ñ
     */
    static async updateUser(input: UserUpdateInput): Promise<UserOut> {
        try {
            const { id, ...updateData } = input;
            const apiPayload = this.toApiFormat(updateData);
            const response = await api.put(`/user/admin/users/${id}`, apiPayload);
            return response.data;
        } catch (error) {
            console.error(`ĞÑˆĞ¸Ğ±ĞºĞ° Ğ¿Ñ€Ğ¸ Ğ¾Ğ±Ğ½Ğ¾Ğ²Ğ»ĞµĞ½Ğ¸Ğ¸ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ñ Ñ ID ${input.id}:`, error);
            throw error;
        }
    }

    /**
     * ĞĞ±Ğ½Ğ¾Ğ²Ğ»ÑĞµÑ‚ Ñ€Ğ¾Ğ»ÑŒ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ñ (Ñ‚Ğ¾Ğ»ÑŒĞºĞ¾ Ğ°Ğ´Ğ¼Ğ¸Ğ½)
     */
    static async updateUserRole(userId: number, newRole: UserRole): Promise<any> {
        try {
            // Ğ˜Ğ—ĞœĞ•ĞĞ•ĞĞ˜Ğ•: ĞÑ‚Ğ¿Ñ€Ğ°Ğ²Ğ»ÑĞµĞ¼ `new_role` ĞºĞ°Ğº Ğ¿Ğ°Ñ€Ğ°Ğ¼ĞµÑ‚Ñ€ Ğ·Ğ°Ğ¿Ñ€Ğ¾ÑĞ°, Ğ° Ğ½Ğµ Ğ² Ñ‚ĞµĞ»Ğµ.
            // Ğ¢Ğ°ĞºĞ¶Ğµ Ğ¼ĞµĞ½ÑĞµĞ¼ Ğ¾Ğ¶Ğ¸Ğ´Ğ°ĞµĞ¼Ñ‹Ğ¹ Ñ‚Ğ¸Ğ¿ Ğ¾Ñ‚Ğ²ĞµÑ‚Ğ° Ğ½Ğ° `any`, Ñ‚Ğ°Ğº ĞºĞ°Ğº API Ğ²Ğ¾Ğ·Ğ²Ñ€Ğ°Ñ‰Ğ°ĞµÑ‚ { message: "..." }
            const response = await api.put(`/user/admin/users/${userId}/role?new_role=${newRole}`);
            return response.data;
        } catch (error) {
            console.error(`ĞÑˆĞ¸Ğ±ĞºĞ° Ğ¿Ñ€Ğ¸ Ğ¾Ğ±Ğ½Ğ¾Ğ²Ğ»ĞµĞ½Ğ¸Ğ¸ Ñ€Ğ¾Ğ»Ğ¸ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ñ ${userId}:`, error);
            throw error;
        }
    }

    /**
     * Ğ£Ğ´Ğ°Ğ»ÑĞµÑ‚ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ñ
     */
    static async deleteUser(id: number): Promise<void> {
        try {
            await api.delete(`/user/admin/users/${id}`);
        } catch (error) {
            console.error(`ĞÑˆĞ¸Ğ±ĞºĞ° Ğ¿Ñ€Ğ¸ ÑƒĞ´Ğ°Ğ»ĞµĞ½Ğ¸Ğ¸ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ñ Ñ ID ${id}:`, error);
            throw error;
        }
    }

    /**
     * ĞĞºÑ‚Ğ¸Ğ²Ğ¸Ñ€ÑƒĞµÑ‚/Ğ´ĞµĞ°ĞºÑ‚Ğ¸Ğ²Ğ¸Ñ€ÑƒĞµÑ‚ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ñ
     */
    static async toggleUserStatus(id: number, isActive: boolean): Promise<UserOut> {
        try {
            const endpoint = isActive ? `/user/admin/users/${id}/unblock` : `/user/admin/users/${id}/block`;
            const response = await api.put(endpoint);
            return response.data;
        } catch (error) {
            console.error(`ĞÑˆĞ¸Ğ±ĞºĞ° Ğ¿Ñ€Ğ¸ Ğ¸Ğ·Ğ¼ĞµĞ½ĞµĞ½Ğ¸Ğ¸ ÑÑ‚Ğ°Ñ‚ÑƒÑĞ° Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ñ ${id}:`, error);
            throw error;
        }
    }

    /**
     * ĞŸĞ¾Ğ»ÑƒÑ‡Ğ°ĞµÑ‚ Ğ¿Ñ€Ğ¾Ñ„Ğ¸Ğ»ÑŒ Ñ‚ĞµĞºÑƒÑ‰ĞµĞ³Ğ¾ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ñ
     */
    static async getCurrentUserProfile(): Promise<UserOut> {
        try {
            const response = await api.get("/user/");
            return response.data;
        } catch (error) {
            console.error("ĞÑˆĞ¸Ğ±ĞºĞ° Ğ¿Ñ€Ğ¸ Ğ¿Ğ¾Ğ»ÑƒÑ‡ĞµĞ½Ğ¸Ğ¸ Ğ¿Ñ€Ğ¾Ñ„Ğ¸Ğ»Ñ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ñ:", error);
            throw error;
        }
    }

    /**
     * ĞĞ±Ğ½Ğ¾Ğ²Ğ»ÑĞµÑ‚ Ğ¿Ñ€Ğ¾Ñ„Ğ¸Ğ»ÑŒ Ñ‚ĞµĞºÑƒÑ‰ĞµĞ³Ğ¾ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ñ
     */
    static async updateCurrentUserProfile(input: Partial<UserCreateInput>): Promise<UserOut> {
        try {
            const apiPayload = this.toApiFormat(input);
            const response = await api.put("/user/", apiPayload);
            return response.data;
        } catch (error) {
            console.error("ĞÑˆĞ¸Ğ±ĞºĞ° Ğ¿Ñ€Ğ¸ Ğ¾Ğ±Ğ½Ğ¾Ğ²Ğ»ĞµĞ½Ğ¸Ğ¸ Ğ¿Ñ€Ğ¾Ñ„Ğ¸Ğ»Ñ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ñ:", error);
            throw error;
        }
    }

    /**
     * ĞŸĞ¾Ğ»ÑƒÑ‡Ğ°ĞµÑ‚ Ğ¸ÑÑ‚Ğ¾Ñ€Ğ¸Ñ Ğ±Ğ°Ğ»Ğ°Ğ½ÑĞ° Ğ´Ğ»Ñ Ñ‚ĞµĞºÑƒÑ‰ĞµĞ³Ğ¾ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ñ Ñ Ğ¿Ğ°Ğ³Ğ¸Ğ½Ğ°Ñ†Ğ¸ĞµĞ¹.
     */
    static async getMyBalanceHistory(skip: number, limit: number): Promise<BalanceHistoryListResponse> {
        try {
            const response = await api.get<BalanceHistoryListResponse>("/user/balance-history", {
                params: { skip, limit }
            });
            return response.data;
        } catch (error) {
            console.error("ĞÑˆĞ¸Ğ±ĞºĞ° Ğ¿Ñ€Ğ¸ Ğ¿Ğ¾Ğ»ÑƒÑ‡ĞµĞ½Ğ¸Ğ¸ Ğ¸ÑÑ‚Ğ¾Ñ€Ğ¸Ğ¸ Ğ±Ğ°Ğ»Ğ°Ğ½ÑĞ°:", error);
            throw error;
        }
    }

    /**
     * ĞŸĞ¾Ğ»ÑƒÑ‡Ğ°ĞµÑ‚ Ğ¸ÑÑ‚Ğ¾Ñ€Ğ¸Ñ Ğ±Ğ°Ğ»Ğ°Ğ½ÑĞ° Ğ´Ğ»Ñ Ğ»ÑĞ±Ğ¾Ğ³Ğ¾ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ñ Ğ¿Ğ¾ ID (Ğ´Ğ»Ñ Ğ°Ğ´Ğ¼Ğ¸Ğ½Ğ¸ÑÑ‚Ñ€Ğ°Ñ‚Ğ¾Ñ€Ğ¾Ğ²).
     */
    static async getUserBalanceHistory(userId: number, skip: number, limit: number): Promise<BalanceHistoryListResponse> {
        try {
            const response = await api.get<BalanceHistoryListResponse>(`/user/admin/users/${userId}/balance-history`, {
                params: { skip, limit }
            });
            return response.data;
        } catch (error) {
            console.error(`ĞÑˆĞ¸Ğ±ĞºĞ° Ğ¿Ñ€Ğ¸ Ğ¿Ğ¾Ğ»ÑƒÑ‡ĞµĞ½Ğ¸Ğ¸ Ğ¸ÑÑ‚Ğ¾Ñ€Ğ¸Ğ¸ Ğ±Ğ°Ğ»Ğ°Ğ½ÑĞ° Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ñ ${userId}:`, error);
            throw error;
        }
    }

    /**
     * Ğ ĞµĞ³Ğ¸ÑÑ‚Ñ€Ğ¸Ñ€ÑƒĞµÑ‚ Ğ¿Ğ»Ğ°Ñ‚ĞµĞ¶ Ğ¸ Ğ¿Ğ¾Ğ¿Ğ¾Ğ»Ğ½ÑĞµÑ‚ Ğ±Ğ°Ğ»Ğ°Ğ½Ñ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ñ (Ğ´Ğ»Ñ Ğ¼ĞµĞ½ĞµĞ´Ğ¶ĞµÑ€Ğ¾Ğ²/Ğ°Ğ´Ğ¼Ğ¸Ğ½Ğ¾Ğ²).
     */
    static async addUserPayment(userId: number, data: UserPaymentRequest): Promise<UserOut> {
        try {
            const response = await api.post<UserOut>(`/user/admin/users/${userId}/add-payment`, data);
            return response.data;
        } catch (error) {
            console.error(`ĞÑˆĞ¸Ğ±ĞºĞ° Ğ¿Ñ€Ğ¸ Ğ´Ğ¾Ğ±Ğ°Ğ²Ğ»ĞµĞ½Ğ¸Ğ¸ Ğ¿Ğ»Ğ°Ñ‚ĞµĞ¶Ğ° Ğ´Ğ»Ñ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ñ ${userId}:`, error);
            throw error;
        }
    }

    /**
     * Ğ¤Ğ¸Ğ»ÑŒÑ‚Ñ€ÑƒĞµÑ‚ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ĞµĞ¹ Ğ¿Ğ¾ Ğ·Ğ°Ğ´Ğ°Ğ½Ğ½Ñ‹Ğ¼ ĞºÑ€Ğ¸Ñ‚ĞµÑ€Ğ¸ÑĞ¼
     */
    static filterUsers(
        users: UserOut[],
        filters: UserFilterOptions
    ): UserOut[] {
        return users.filter(user => {
            if (filters.search) {
                const searchLower = filters.search.toLowerCase();
                const matchesSearch =
                    user.full_name.toLowerCase().includes(searchLower) ||
                    user.email.toLowerCase().includes(searchLower) ||
                    (user.phone && user.phone.toLowerCase().includes(searchLower));
                if (!matchesSearch) return false;
            }
            if (filters.role && user.role !== filters.role) return false;
            if (filters.isActive !== undefined && user.is_active !== filters.isActive) return false;
            if (filters.status && user.status !== filters.status) return false;
            return true;
        });
    }

    /**
     * Ğ’Ğ°Ğ»Ğ¸Ğ´Ğ¸Ñ€ÑƒĞµÑ‚ Ğ´Ğ°Ğ½Ğ½Ñ‹Ğµ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ñ
     */
    static validateUserData(input: UserCreateInput): UserValidationResult {
        const errors: string[] = [];
        if (!input.full_name?.trim()) errors.push("ĞŸĞ¾Ğ»Ğ½Ğ¾Ğµ Ğ¸Ğ¼Ñ Ğ¾Ğ±ÑĞ·Ğ°Ñ‚ĞµĞ»ÑŒĞ½Ğ¾");
        if (!input.email?.trim()) {
            errors.push("Email Ğ¾Ğ±ÑĞ·Ğ°Ñ‚ĞµĞ»ĞµĞ½");
        } else if (!this.isValidEmail(input.email)) {
            errors.push("ĞĞµĞºĞ¾Ñ€Ñ€ĞµĞºÑ‚Ğ½Ñ‹Ğ¹ Ñ„Ğ¾Ñ€Ğ¼Ğ°Ñ‚ email");
        }
        if (!input.role) errors.push("Ğ Ğ¾Ğ»ÑŒ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ñ Ğ¾Ğ±ÑĞ·Ğ°Ñ‚ĞµĞ»ÑŒĞ½Ğ°");
        if (input.phone && !this.isValidPhone(input.phone)) errors.push("ĞĞµĞºĞ¾Ñ€Ñ€ĞµĞºÑ‚Ğ½Ñ‹Ğ¹ Ñ„Ğ¾Ñ€Ğ¼Ğ°Ñ‚ Ñ‚ĞµĞ»ĞµÑ„Ğ¾Ğ½Ğ°");
        if (!input.privacyPolicyAccepted) errors.push("ĞĞµĞ¾Ğ±Ñ…Ğ¾Ğ´Ğ¸Ğ¼Ğ¾ Ğ¿Ñ€Ğ¸Ğ½ÑÑ‚ÑŒ Ğ¿Ğ¾Ğ»Ğ¸Ñ‚Ğ¸ĞºÑƒ ĞºĞ¾Ğ½Ñ„Ğ¸Ğ´ĞµĞ½Ñ†Ğ¸Ğ°Ğ»ÑŒĞ½Ğ¾ÑÑ‚Ğ¸");
        if (!input.termsAccepted) errors.push("ĞĞµĞ¾Ğ±Ñ…Ğ¾Ğ´Ğ¸Ğ¼Ğ¾ Ğ¿Ñ€Ğ¸Ğ½ÑÑ‚ÑŒ ÑƒÑĞ»Ğ¾Ğ²Ğ¸Ñ Ğ¸ÑĞ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ");
        return { isValid: errors.length === 0, errors };
    }

    /**
     * ĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑĞµÑ‚ Ğ²Ğ°Ğ»Ğ¸Ğ´Ğ½Ğ¾ÑÑ‚ÑŒ email
     */
    private static isValidEmail(email: string): boolean {
        const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
        return emailRegex.test(email);
    }

    /**
     * ĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑĞµÑ‚ Ğ²Ğ°Ğ»Ğ¸Ğ´Ğ½Ğ¾ÑÑ‚ÑŒ Ñ‚ĞµĞ»ĞµÑ„Ğ¾Ğ½Ğ°
     */
    private static isValidPhone(phone: string): boolean {
        const phoneRegex = /^[+]?[0-9\s-()]+$/;
        return phoneRegex.test(phone) && phone.replace(/\D/g, '').length >= 10;
    }

    /**
     * Ğ¡Ğ¾Ñ€Ñ‚Ğ¸Ñ€ÑƒĞµÑ‚ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ĞµĞ¹ Ğ¿Ğ¾ Ğ·Ğ°Ğ´Ğ°Ğ½Ğ½Ğ¾Ğ¼Ñƒ ĞºÑ€Ğ¸Ñ‚ĞµÑ€Ğ¸Ñ
     */
    static sortUsers(
        users: UserOut[],
        sortBy: 'full_name' | 'email' | 'role' | 'created_at' | 'balance',
        sortOrder: 'asc' | 'desc' = 'asc'
    ): UserOut[] {
        return [...users].sort((a, b) => {
            let aValue: string | number | Date = a[sortBy] as string | number | Date;
            let bValue: string | number | Date = b[sortBy] as string | number | Date;

            if (aValue === null || aValue === undefined) aValue = '';
            if (bValue === null || bValue === undefined) bValue = '';

            if (sortBy === 'created_at') {
                aValue = new Date(aValue as string).getTime();
                bValue = new Date(bValue as string).getTime();
            }

            if (sortBy === 'balance') {
                aValue = Number(aValue) || 0;
                bValue = Number(bValue) || 0;
            }

            if (typeof aValue === 'string' && typeof bValue === 'string') {
                aValue = aValue.toLowerCase();
                bValue = bValue.toLowerCase();
            }

            if (aValue < bValue) return sortOrder === 'asc' ? -1 : 1;
            if (aValue > bValue) return sortOrder === 'asc' ? 1 : -1;
            return 0;
        });
    }

    /**
     * Ğ“ĞµĞ½ĞµÑ€Ğ¸Ñ€ÑƒĞµÑ‚ ĞºĞ»ÑÑ‡ Ğ´Ğ»Ñ ĞºÑÑˆĞ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ĞµĞ¹
     */
    static generateUsersCacheKey(filters?: UserFilterOptions): string {
        return JSON.stringify(["users", filters]);
    }

    /**
     * Ğ“ĞµĞ½ĞµÑ€Ğ¸Ñ€ÑƒĞµÑ‚ ĞºĞ»ÑÑ‡ Ğ´Ğ»Ñ ĞºÑÑˆĞ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ Ğ¿Ñ€Ğ¾Ñ„Ğ¸Ğ»Ñ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ñ
     */
    static generateUserProfileCacheKey(): string {
        return JSON.stringify(["user-profile"]);
    }
}

```


## <a name="rentalappmainsrccoreservicesindexts"></a>`rental-app-main/src/core/services/index.ts`

```typescript
// path: rental-app-main/src/core/services/index.ts

// src/core/services/index.ts

// Ğ­ĞºÑĞ¿Ğ¾Ñ€Ñ‚ Ğ²ÑĞµÑ… ÑĞµÑ€Ğ²Ğ¸ÑĞ¾Ğ²
export { ReservationService } from './ReservationService';
export { EquipmentService } from './EquipmentService';
export { AvailabilityService } from './AvailabilityService';
export { PromoCodeService } from './PromoCodeService';
export { UserService } from './UserService';
export { AccessoryService } from './AccessoryService';
export { PhoneService } from './PhoneService';
export { CalendarService } from './CalendarService';
export { DateService } from './DateService';

// Ğ­ĞºÑĞ¿Ğ¾Ñ€Ñ‚ Ñ‚Ğ¸Ğ¿Ğ¾Ğ²
export type {
    ReservationCreateInput,
    ReservationUpdateInput
} from './ReservationService';

export type {
    EquipmentListResponse,
    EquipmentFilterParams
} from './EquipmentService';

export type {
    PromoCodeValidationResult,
    PromoCodeFilterOptions
} from './PromoCodeService';

export type {
    UserCreateInput,
    UserUpdateInput,
    UserFilterOptions,
    UserValidationResult
} from './UserService';

export type {
    AccessoryCreateInput,
    AccessoryUpdateInput,
    AccessoryFilterOptions,
    AccessoryValidationResult
} from './AccessoryService';

export type {
    PhoneValidationResult
} from './PhoneService';

export type {
    CalendarGridData,
    CalendarFilterOptions
} from './CalendarService';

export type {
    DateRange,
    DateRangeValidationResult
} from './DateService';

export type {
    AvailabilityStatusParams,
    DailyStatusParams,
    ConflictCheckParams
} from './AvailabilityService';

```


## <a name="rentalappmainsrchooksadmincreatereservationuseCreateReservationDatats"></a>`rental-app-main/src/hooks/admin/create-reservation/useCreateReservationData.ts`

```typescript
// path: rental-app-main/src/hooks/admin/create-reservation/useCreateReservationData.ts

// src/hooks/admin/create-reservation/useCreateReservationData.ts

import { useMemo } from "react";
import { useAdminUsers } from "@/hooks/useAdminUsers";
import { useEquipment } from "@/hooks/useEquipment";
import { useAvailabilityCheck } from "@/hooks/useAvailabilityCheck";
import { EquipmentService } from "@/core/services";
import type { Equipment } from "@/types/equipment";

interface UseCreateReservationDataInputs {
    equipmentSearch: string;
    watchedStartDate: string;
    watchedEndDate: string;
    watchedEquipmentIds: number[];
}

/**
 * Ğ¥ÑƒĞº Ğ´Ğ»Ñ Ğ¿Ğ¾Ğ»ÑƒÑ‡ĞµĞ½Ğ¸Ñ Ğ¸ Ğ¾Ğ±Ñ€Ğ°Ğ±Ğ¾Ñ‚ĞºĞ¸ Ğ´Ğ°Ğ½Ğ½Ñ‹Ñ… Ğ´Ğ»Ñ Ñ„Ğ¾Ñ€Ğ¼Ñ‹ ÑĞ¾Ğ·Ğ´Ğ°Ğ½Ğ¸Ñ Ñ€ĞµĞ·ĞµÑ€Ğ²Ğ°.
 * Ğ¡Ğ¾Ğ´ĞµÑ€Ğ¶Ğ¸Ñ‚ Ğ²ÑÑ Ğ»Ğ¾Ğ³Ğ¸ĞºÑƒ Ğ¿Ğ¾Ğ»ÑƒÑ‡ĞµĞ½Ğ¸Ñ Ğ´Ğ°Ğ½Ğ½Ñ‹Ñ…: Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ğ¸, Ğ¾Ğ±Ğ¾Ñ€ÑƒĞ´Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ, Ğ´Ğ¾ÑÑ‚ÑƒĞ¿Ğ½Ğ¾ÑÑ‚ÑŒ.
 */
export const useCreateReservationData = ({
    equipmentSearch,
    watchedStartDate,
    watchedEndDate,
    watchedEquipmentIds
}: UseCreateReservationDataInputs) => {

    // 1. Ğ—Ğ°Ğ³Ñ€ÑƒĞ·ĞºĞ° Ğ¸ÑÑ…Ğ¾Ğ´Ğ½Ñ‹Ñ… Ğ´Ğ°Ğ½Ğ½Ñ‹Ñ…
    const { data: usersResponse, isLoading: isLoadingUsers } = useAdminUsers();
    const { data: equipmentPages, isLoading: isLoadingEquipment } = useEquipment({}); // Ğ’Ñ‹Ğ·Ñ‹Ğ²Ğ°ĞµĞ¼ Ñ Ğ¿ÑƒÑÑ‚Ñ‹Ğ¼ Ğ¾Ğ±ÑŠĞµĞºÑ‚Ğ¾Ğ¼ Ñ„Ğ¸Ğ»ÑŒÑ‚Ñ€Ğ¾Ğ²

    // 2. "Ğ Ğ°Ğ·Ğ²Ğ¾Ñ€Ğ°Ñ‡Ğ¸Ğ²Ğ°ĞµĞ¼" ÑÑ‚Ñ€Ğ°Ğ½Ğ¸Ñ†Ñ‹ Ğ² Ğ¾Ğ´Ğ¸Ğ½ Ğ¿Ğ»Ğ¾ÑĞºĞ¸Ğ¹ Ğ¼Ğ°ÑÑĞ¸Ğ² `allEquipment`
    const allEquipment = useMemo(() =>
        equipmentPages?.pages.flatMap((page) => page.items) ?? [],
        [equipmentPages]);

    const users = useMemo(() => 
        usersResponse?.pages?.flatMap(page => page.items) ?? [], 
        [usersResponse]
    );

    // 3. Ğ¤Ğ¸Ğ»ÑŒÑ‚Ñ€Ğ°Ñ†Ğ¸Ñ Ğ¸ Ğ³Ñ€ÑƒĞ¿Ğ¿Ğ¸Ñ€Ğ¾Ğ²ĞºĞ° Ğ¾Ğ±Ğ¾Ñ€ÑƒĞ´Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ
    const filteredAndGroupedEquipment = useMemo(() => {
        return EquipmentService.filterAndGroupEquipment(allEquipment, equipmentSearch);
    }, [allEquipment, equipmentSearch]);

    // 4. ĞŸÑ€Ğ¾Ğ²ĞµÑ€ĞºĞ° Ğ´Ğ¾ÑÑ‚ÑƒĞ¿Ğ½Ğ¾ÑÑ‚Ğ¸ Ğ¾Ñ‚Ñ„Ğ¸Ğ»ÑŒÑ‚Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ½Ğ¾Ğ³Ğ¾ Ğ¾Ğ±Ğ¾Ñ€ÑƒĞ´Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ
    const { validStartDate, validEndDate } = useMemo(() => {
        const start = watchedStartDate ? new Date(watchedStartDate) : null;
        const end = watchedEndDate ? new Date(watchedEndDate) : null;
        return {
            validStartDate: start && !isNaN(start.getTime()) ? start : null,
            validEndDate: end && !isNaN(end.getTime()) ? end : null,
        }
    }, [watchedStartDate, watchedEndDate]);

    const { 
        availabilityMap, 
        hasConflicts: hasConflictsInSelection, 
        isLoading: isLoadingAvailability 
    } = useAvailabilityCheck({
        equipmentIds: filteredAndGroupedEquipment.visibleIds,
        startDate: validStartDate || new Date(),
        endDate: validEndDate || new Date(),
        enabled: !!(validStartDate && validEndDate && filteredAndGroupedEquipment.visibleIds.length > 0)
    });

    // Ğ’ÑĞ¿Ğ¾Ğ¼Ğ¾Ğ³Ğ°Ñ‚ĞµĞ»ÑŒĞ½Ğ°Ñ Ñ„ÑƒĞ½ĞºÑ†Ğ¸Ñ Ğ´Ğ»Ñ Ğ¿Ğ¾Ğ»ÑƒÑ‡ĞµĞ½Ğ¸Ñ Ğ¾Ğ±Ğ¾Ñ€ÑƒĞ´Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ Ñ Ğ°ĞºÑĞµÑÑÑƒĞ°Ñ€Ğ°Ğ¼Ğ¸
    const getEquipmentWithAccessories = (allEq: Equipment[], ids: number[]): Equipment[] => {
        const selectedIds = new Set(ids);
        return allEq.filter(eq => selectedIds.has(eq.id) && eq.accessories && eq.accessories.length > 0);
    };

    const equipmentWithAccessories = useMemo(() => getEquipmentWithAccessories(allEquipment, watchedEquipmentIds), [watchedEquipmentIds, allEquipment]);

    return {
        users,
        isLoadingUsers,
        allEquipment,
        isLoadingEquipment,
        filteredAndGroupedEquipment,
        availabilityMap,
        isLoadingAvailability,
        hasConflictsInSelection,
        equipmentWithAccessories
    };
};


```


## <a name="rentalappmainsrchooksadmincreatereservationuseCreateReservationDialogts"></a>`rental-app-main/src/hooks/admin/create-reservation/useCreateReservationDialog.ts`

```typescript
// path: rental-app-main/src/hooks/admin/create-reservation/useCreateReservationDialog.ts

// src/hooks/admin/create-reservation/useCreateReservationDialog.ts

import { useState, useEffect, useCallback } from "react";
import { useCreateAdminReservation } from "@/hooks/useAdminReservations";
import { useAdminReservationCalculator } from "../useAdminReservationCalculator";
import { formatDate } from "@/lib/utils";
import { useCreateReservationData } from "./useCreateReservationData";
import { useCreateReservationForm, type CreateReservationFormData } from "./useCreateReservationForm";

const todayDate = new Date();
const tomorrowDate = new Date();
tomorrowDate.setDate(todayDate.getDate() + 1);

/**
 * Ğ£ĞŸĞ ĞĞ©Ğ•ĞĞĞ«Ğ™ Ğ¥Ğ£Ğš-ĞĞ ĞšĞ•Ğ¡Ğ¢Ğ ĞĞ¢ĞĞ 
 * Ğ£Ğ¿Ñ€Ğ°Ğ²Ğ»ÑĞµÑ‚ ÑĞ¾ÑÑ‚Ğ¾ÑĞ½Ğ¸ĞµĞ¼ Ğ´Ğ¸Ğ°Ğ»Ğ¾Ğ³Ğ° ÑĞ¾Ğ·Ğ´Ğ°Ğ½Ğ¸Ñ Ñ€ĞµĞ·ĞµÑ€Ğ²Ğ°, Ğ¸ÑĞ¿Ğ¾Ğ»ÑŒĞ·ÑƒÑ Ğ´Ğ¾Ñ‡ĞµÑ€Ğ½Ğ¸Ğµ Ñ…ÑƒĞºĞ¸ Ğ´Ğ»Ñ Ğ´Ğ°Ğ½Ğ½Ñ‹Ñ… Ğ¸ Ñ€Ğ°ÑÑ‡ĞµÑ‚Ğ¾Ğ².
 */
export const useCreateReservationDialog = ({ isOpen, onClose }: { isOpen: boolean; onClose: () => void }) => {
    // 1. Ğ¡Ğ¾ÑÑ‚Ğ¾ÑĞ½Ğ¸Ğµ UI Ğ´Ğ¸Ğ°Ğ»Ğ¾Ğ³Ğ°
    const [step, setStep] = useState<'details' | 'accessories'>('details');
    const [equipmentSearch, setEquipmentSearch] = useState("");
    const [clientPopoverOpen, setClientPopoverOpen] = useState(false);

    // 2. Ğ£Ğ¿Ñ€Ğ°Ğ²Ğ»ĞµĞ½Ğ¸Ğµ Ñ„Ğ¾Ñ€Ğ¼Ğ¾Ğ¹ Ñ‡ĞµÑ€ĞµĞ· ÑĞ¿ĞµÑ†Ğ¸Ğ°Ğ»Ğ¸Ğ·Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ½Ñ‹Ğ¹ Ñ…ÑƒĞº
    const { form, watch, trigger, handleSubmit, reset } = useCreateReservationForm();

    const watchedStartDate = watch("start_date");
    const watchedEndDate = watch("end_date");
    const watchedEquipmentIds = watch("equipment_ids");

    // 3. ĞŸĞ¾Ğ»ÑƒÑ‡ĞµĞ½Ğ¸Ğµ Ğ´Ğ°Ğ½Ğ½Ñ‹Ñ… Ñ‡ĞµÑ€ĞµĞ· ÑĞ¿ĞµÑ†Ğ¸Ğ°Ğ»Ğ¸Ğ·Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ½Ñ‹Ğ¹ Ñ…ÑƒĞº
    const {
        users,
        isLoadingUsers,
        allEquipment,
        isLoadingEquipment,
        filteredAndGroupedEquipment,
        availabilityMap,
        isLoadingAvailability,
        hasConflictsInSelection,
        equipmentWithAccessories,
    } = useCreateReservationData({
        equipmentSearch,
        watchedStartDate,
        watchedEndDate,
        watchedEquipmentIds,
    });

    // 4. Ğ Ğ°ÑÑ‡ĞµÑ‚ Ñ„Ğ¸Ğ½Ğ°Ğ½ÑĞ¾Ğ²
    const financialData = useAdminReservationCalculator(watch, allEquipment);

    // 5. Ğ›Ğ¾Ğ³Ğ¸ĞºĞ° Ğ¾Ñ‚Ğ¿Ñ€Ğ°Ğ²ĞºĞ¸ Ñ„Ğ¾Ñ€Ğ¼Ñ‹
    const createReservationMutation = useCreateAdminReservation();

    const handleCloseDialog = useCallback(() => onClose(), [onClose]);

    const processSubmit = useCallback((data: CreateReservationFormData) => {
        if (hasConflictsInSelection) {
            alert("ĞĞµĞ»ÑŒĞ·Ñ ÑĞ¾Ğ·Ğ´Ğ°Ñ‚ÑŒ Ñ€ĞµĞ·ĞµÑ€Ğ², Ñ‚Ğ°Ğº ĞºĞ°Ğº Ğ² Ğ²Ğ°ÑˆĞµĞ¼ Ğ²Ñ‹Ğ±Ğ¾Ñ€Ğµ ĞµÑÑ‚ÑŒ ĞºĞ¾Ğ½Ñ„Ğ»Ğ¸ĞºÑ‚Ğ½Ñ‹Ğµ Ğ¿Ğ¾Ğ·Ğ¸Ñ†Ğ¸Ğ¸.");
            return;
        }
        createReservationMutation.mutate(data, { onSuccess: handleCloseDialog });
    }, [hasConflictsInSelection, createReservationMutation, handleCloseDialog]);

    const handleNextStep = useCallback(async () => {
        const isValid = await trigger(["user_id", "start_date", "end_date", "equipment_ids"]);
        if (!isValid) return;

        if (equipmentWithAccessories.length > 0) {
            setStep('accessories');
        } else {
            // âœ… Ğ˜Ğ¡ĞŸĞ ĞĞ’Ğ›Ğ•ĞĞ˜Ğ•: Ğ”Ğ¾Ğ±Ğ°Ğ²Ğ»ĞµĞ½Ğ¾ ĞºĞ»ÑÑ‡ĞµĞ²Ğ¾Ğµ ÑĞ»Ğ¾Ğ²Ğ¾ `await` Ğ´Ğ»Ñ Ğ°ÑĞ¸Ğ½Ñ…Ñ€Ğ¾Ğ½Ğ½Ğ¾Ğ³Ğ¾ Ğ²Ñ‹Ğ·Ğ¾Ğ²Ğ°.
            await handleSubmit(processSubmit)();
        }
    }, [trigger, equipmentWithAccessories, handleSubmit, processSubmit]);

    // 6. Ğ¡Ğ±Ñ€Ğ¾Ñ ÑĞ¾ÑÑ‚Ğ¾ÑĞ½Ğ¸Ñ Ğ¿Ñ€Ğ¸ Ğ·Ğ°ĞºÑ€Ñ‹Ñ‚Ğ¸Ğ¸ Ğ´Ğ¸Ğ°Ğ»Ğ¾Ğ³Ğ°
    useEffect(() => {
        if (!isOpen) {
            reset({
                equipment_ids: [], 
                selected_accessories: {},
                start_date: formatDate(todayDate), 
                end_date: formatDate(tomorrowDate),
            });
            setEquipmentSearch("");
            setStep('details');
        }
    }, [isOpen, reset]);

    // 7. Ğ’Ğ¾Ğ·Ğ²Ñ€Ğ°Ñ‰Ğ°ĞµĞ¼ ĞµĞ´Ğ¸Ğ½Ñ‹Ğ¹ Ğ¸Ğ½Ñ‚ĞµÑ€Ñ„ĞµĞ¹Ñ Ğ´Ğ»Ñ ĞºĞ¾Ğ¼Ğ¿Ğ¾Ğ½ĞµĞ½Ñ‚Ğ°
    return {
        step,
        form,
        isSubmitting: createReservationMutation.isPending,
        users,
        isLoadingUsers,
        clientPopoverOpen,
        setClientPopoverOpen,
        equipmentSearch,
        setEquipmentSearch,
        isLoadingEquipment,
        filteredAndGroupedEquipment,
        equipmentWithAccessories,
        availabilityMap,
        isLoadingAvailability,
        hasConflictsInSelection,
        setStep,
        handleNextStep,
        onSubmit: handleSubmit(processSubmit),
        handleCloseDialog,
        financialData,
    };
};


```


## <a name="rentalappmainsrchooksadmincreatereservationuseCreateReservationFormts"></a>`rental-app-main/src/hooks/admin/create-reservation/useCreateReservationForm.ts`

```typescript
// path: rental-app-main/src/hooks/admin/create-reservation/useCreateReservationForm.ts

// src/hooks/admin/create-reservation/useCreateReservationForm.ts

import { useForm } from "react-hook-form";
import { zodResolver } from "@hookform/resolvers/zod";
import { z } from "zod";
import { formatDate } from "@/lib/utils";

const createSchema = z.object({
    user_id: z.coerce.number().min(1, "ĞĞµĞ¾Ğ±Ñ…Ğ¾Ğ´Ğ¸Ğ¼Ğ¾ Ğ²Ñ‹Ğ±Ñ€Ğ°Ñ‚ÑŒ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ñ"),
    start_date: z.string().min(1, "ĞĞµĞ¾Ğ±Ñ…Ğ¾Ğ´Ğ¸Ğ¼Ğ¾ ÑƒĞºĞ°Ğ·Ğ°Ñ‚ÑŒ Ğ´Ğ°Ñ‚Ñƒ Ğ½Ğ°Ñ‡Ğ°Ğ»Ğ°"),
    end_date: z.string().min(1, "ĞĞµĞ¾Ğ±Ñ…Ğ¾Ğ´Ğ¸Ğ¼Ğ¾ ÑƒĞºĞ°Ğ·Ğ°Ñ‚ÑŒ Ğ´Ğ°Ñ‚Ñƒ Ğ¾ĞºĞ¾Ğ½Ñ‡Ğ°Ğ½Ğ¸Ñ"),
    equipment_ids: z.array(z.number()).min(1, "Ğ’Ñ‹Ğ±ĞµÑ€Ğ¸Ñ‚Ğµ Ñ…Ğ¾Ñ‚Ñ Ğ±Ñ‹ Ğ¾Ğ´Ğ½Ñƒ Ğ¿Ğ¾Ğ·Ğ¸Ñ†Ğ¸Ñ Ğ¾Ğ±Ğ¾Ñ€ÑƒĞ´Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ"),
    selected_accessories: z.record(z.array(z.number())).optional(),
}).refine(data => new Date(data.end_date) >= new Date(data.start_date), {
    message: "Ğ”Ğ°Ñ‚Ğ° Ğ¾ĞºĞ¾Ğ½Ñ‡Ğ°Ğ½Ğ¸Ñ Ğ½Ğµ Ğ¼Ğ¾Ğ¶ĞµÑ‚ Ğ±Ñ‹Ñ‚ÑŒ Ñ€Ğ°Ğ½ÑŒÑˆĞµ Ğ´Ğ°Ñ‚Ñ‹ Ğ½Ğ°Ñ‡Ğ°Ğ»Ğ°",
    path: ["end_date"],
});

export type CreateReservationFormData = z.infer<typeof createSchema>;

const todayDate = new Date();
const tomorrowDate = new Date();
tomorrowDate.setDate(todayDate.getDate() + 1);

/**
 * Ğ¥ÑƒĞº Ğ´Ğ»Ñ ÑƒĞ¿Ñ€Ğ°Ğ²Ğ»ĞµĞ½Ğ¸Ñ Ñ„Ğ¾Ñ€Ğ¼Ğ¾Ğ¹ ÑĞ¾Ğ·Ğ´Ğ°Ğ½Ğ¸Ñ Ñ€ĞµĞ·ĞµÑ€Ğ²Ğ°.
 * Ğ¡Ğ¾Ğ´ĞµÑ€Ğ¶Ğ¸Ñ‚ Ğ²ÑÑ Ğ»Ğ¾Ğ³Ğ¸ĞºÑƒ, ÑĞ²ÑĞ·Ğ°Ğ½Ğ½ÑƒÑ Ñ react-hook-form.
 */
export const useCreateReservationForm = () => {
    const form = useForm<CreateReservationFormData>({
        resolver: zodResolver(createSchema), 
        mode: "onChange",
        defaultValues: {
            equipment_ids: [], 
            selected_accessories: {},
            start_date: formatDate(todayDate), 
            end_date: formatDate(tomorrowDate),
        },
    });

    const { watch, trigger, handleSubmit, reset } = form;

    return {
        form,
        watch,
        trigger,
        handleSubmit,
        reset,
    };
};


```


## <a name="rentalappmainsrchooksadminuseAdminRentalEditts"></a>`rental-app-main/src/hooks/admin/useAdminRentalEdit.ts`

```typescript
// path: rental-app-main/src/hooks/admin/useAdminRentalEdit.ts

// hooks/admin/useAdminRentalEdit.ts (ĞĞĞ’Ğ«Ğ™ Ğ¤ĞĞ™Ğ›)

import { useForm } from "react-hook-form";
import { zodResolver } from "@hookform/resolvers/zod";
import { z } from "zod";
import { useMutation, useQueryClient } from "@tanstack/react-query";
import { toast } from "sonner";
import { api } from "@/lib/api";
import { formatDate } from "@/lib/utils";
import type { AdminRentalOut } from "@/types/reservation";

// Ğ¡Ñ…ĞµĞ¼Ğ° Ğ²Ğ°Ğ»Ğ¸Ğ´Ğ°Ñ†Ğ¸Ğ¸ Ğ´Ğ»Ñ Ñ„Ğ¾Ñ€Ğ¼Ñ‹ Ñ€ĞµĞ´Ğ°ĞºÑ‚Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ
const rentalEditSchema = z.object({
    end_date: z.string().optional(),
    actual_return_date: z.string().nullable().optional(),
    status: z.string().optional(),
    final_cost: z.coerce.number().optional(),
    deposit_amount: z.coerce.number().optional(),
    notes_on_issue: z.string().optional(),
    notes_on_return: z.string().optional(),
});

type RentalEditFormData = z.infer<typeof rentalEditSchema>;

interface UseAdminRentalEditProps {
    rental: AdminRentalOut;
    onSuccess: () => void;
}

export function useAdminRentalEdit({ rental, onSuccess }: UseAdminRentalEditProps) {
    const queryClient = useQueryClient();

    const { register, handleSubmit, formState: { errors, isValid, isDirty } } = useForm<RentalEditFormData>({
        resolver: zodResolver(rentalEditSchema),
        defaultValues: {
            end_date: formatDate(rental.end_date),
            actual_return_date: rental.actual_return_date ? formatDate(rental.actual_return_date) : null,
            status: rental.status,
            final_cost: rental.final_cost ?? undefined,
            deposit_amount: rental.deposit_amount,
            notes_on_issue: rental.notes_on_issue ?? "",
            notes_on_return: rental.notes_on_return ?? "",
        },
        mode: "onChange",
    });

    const updateMutation = useMutation({
        mutationFn: (data: RentalEditFormData) => api.put(`/admin/rentals/${rental.id}`, data),
        onSuccess: () => {
            toast.success("ĞÑ€ĞµĞ½Ğ´Ğ° ÑƒÑĞ¿ĞµÑˆĞ½Ğ¾ Ğ¾Ğ±Ğ½Ğ¾Ğ²Ğ»ĞµĞ½Ğ°");
            void queryClient.invalidateQueries({ queryKey: ["adminRentals"] });
            onSuccess(); // Ğ—Ğ°ĞºÑ€Ñ‹Ğ²Ğ°ĞµĞ¼ Ñ„Ğ¾Ñ€Ğ¼Ñƒ Ñ€ĞµĞ´Ğ°ĞºÑ‚Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ
        },
        onError: (error: any) => {
            toast.error(error?.response?.data?.detail || "ĞÑˆĞ¸Ğ±ĞºĞ° Ğ¿Ñ€Ğ¸ Ğ¾Ğ±Ğ½Ğ¾Ğ²Ğ»ĞµĞ½Ğ¸Ğ¸ Ğ°Ñ€ĞµĞ½Ğ´Ñ‹");
        },
    });

    const onSubmit = (data: RentalEditFormData) => {
        updateMutation.mutate(data);
    };

    return {
        register,
        handleSubmit: handleSubmit(onSubmit),
        errors,
        isValid,
        isDirty,
        isSaving: updateMutation.isPending,
    };
}

```


## <a name="rentalappmainsrchooksadminuseAdminReservationCalculatorts"></a>`rental-app-main/src/hooks/admin/useAdminReservationCalculator.ts`

```typescript
// path: rental-app-main/src/hooks/admin/useAdminReservationCalculator.ts

// src/hooks/admin/useAdminReservationCalculator.ts

import { useMemo } from "react";
import { UseFormWatch } from "react-hook-form";
import { usePromoCodeStore } from "@/store/promoCodeStore";
import { usePriceCalculator } from "../reservation/usePriceCalculator";
import type { CreateReservationFormData } from "./create-reservation/useCreateReservationForm";
import type { Equipment } from "@/types/equipment";

/**
 * Ğ¥ÑƒĞº Ğ´Ğ»Ñ Ñ€Ğ°ÑÑ‡ĞµÑ‚Ğ° ÑÑ‚Ğ¾Ğ¸Ğ¼Ğ¾ÑÑ‚Ğ¸ Ñ€ĞµĞ·ĞµÑ€Ğ²Ğ° Ğ² Ğ°Ğ´Ğ¼Ğ¸Ğ½-Ğ¿Ğ°Ğ½ĞµĞ»Ğ¸.
 * Ğ˜ÑĞ¿Ğ¾Ğ»ÑŒĞ·ÑƒĞµÑ‚ Ñ†ĞµĞ½Ñ‚Ñ€Ğ°Ğ»Ğ¸Ğ·Ğ¾Ğ²Ğ°Ğ½Ğ½Ñ‹Ğ¹ usePriceCalculator ĞºĞ°Ğº ĞµĞ´Ğ¸Ğ½Ñ‹Ğ¹ Ğ¸ÑÑ‚Ğ¾Ñ‡Ğ½Ğ¸Ğº Ğ¿Ñ€Ğ°Ğ²Ğ´Ñ‹.
 */
export function useAdminReservationCalculator(
    watch: UseFormWatch<CreateReservationFormData>,
    allEquipment: Equipment[] = []
) {
    const watchedStartDateStr = watch("start_date");
    const watchedEndDateStr = watch("end_date");
    const watchedEquipmentIds = watch("equipment_ids");
    const watchedSelectedAccessories = watch("selected_accessories") || {};

    const { promoCode, setPromoCode, promoCodeMessage } = usePromoCodeStore();

    const startDate = useMemo(() => watchedStartDateStr ? new Date(watchedStartDateStr) : new Date(), [watchedStartDateStr]);
    const endDate = useMemo(() => watchedEndDateStr ? new Date(watchedEndDateStr) : new Date(), [watchedEndDateStr]);

    const equipmentForCalc = useMemo(() =>
            allEquipment.filter(e => watchedEquipmentIds.includes(e.id)),
        [allEquipment, watchedEquipmentIds]
    );

    // Ğ˜ÑĞ¿Ğ¾Ğ»ÑŒĞ·ÑƒĞµĞ¼ Ñ€Ğ°ÑÑˆĞ¸Ñ€ĞµĞ½Ğ½Ñ‹Ğ¹ usePriceCalculator
    const priceCalculator = usePriceCalculator({
        equipmentIds: equipmentForCalc.map(i => i.id),
        startDate,
        endDate,
        selectedAccessories: watchedSelectedAccessories,
        promoCode: promoCode,
        enabled: watchedEquipmentIds.length > 0 && !!watchedStartDateStr && !!watchedEndDateStr
    });

    const applyPromoCode = () => {
        console.log("Applying promo code from admin calculator context:", promoCode);
    };

    // Ğ’Ğ¾Ğ·Ğ²Ñ€Ğ°Ñ‰Ğ°ĞµĞ¼ Ğ´Ğ°Ğ½Ğ½Ñ‹Ğµ Ğ¸Ğ· Ñ†ĞµĞ½Ñ‚Ñ€Ğ°Ğ»Ğ¸Ğ·Ğ¾Ğ²Ğ°Ğ½Ğ½Ğ¾Ğ³Ğ¾ Ñ…ÑƒĞºĞ°
    return {
        // ĞÑĞ½Ğ¾Ğ²Ğ½Ñ‹Ğµ Ğ´Ğ°Ğ½Ğ½Ñ‹Ğµ Ğ¸Ğ· usePriceCalculator
        priceDetails: priceCalculator.priceDetails,
        
        // Ğ¤Ğ¸Ğ½Ğ°Ğ½ÑĞ¾Ğ²Ñ‹Ğµ Ğ´Ğ°Ğ½Ğ½Ñ‹Ğµ Ğ¸Ğ· usePriceCalculator
        dayCount: priceCalculator.dayCount,
        fullTotal: priceCalculator.fullTotal,
        finalTotal: priceCalculator.finalTotal,
        discountAmount: priceCalculator.discountAmount,
        totalDiscountPercentage: priceCalculator.totalDiscountPercentage,
        durationDiscountPercentage: priceCalculator.durationDiscountPercentage,
        promoDiscountPercentage: priceCalculator.promoDiscountPercentage,
        
        // ĞŸÑ€Ğ¾Ğ¼Ğ¾ĞºĞ¾Ğ´
        promoCode,
        setPromoCode,
        applyPromoCode,
        promoCodeMessage: priceCalculator.promoCodeMessage || promoCodeMessage,
        
        // Ğ¡Ğ¾ÑÑ‚Ğ¾ÑĞ½Ğ¸Ñ Ğ·Ğ°Ğ³Ñ€ÑƒĞ·ĞºĞ¸
        isApplyingPromoCode: priceCalculator.isApplyingPromoCode,
        isCalculatingPrice: priceCalculator.isCalculatingPrice,
        isFetchingPrice: priceCalculator.isFetchingPrice,
    };
}

```


## <a name="rentalappmainsrchooksadminuseDashboardDatats"></a>`rental-app-main/src/hooks/admin/useDashboardData.ts`

```typescript
// path: rental-app-main/src/hooks/admin/useDashboardData.ts

// src/hooks/admin/useDashboardData.ts

import { useQuery } from "@tanstack/react-query";
import { api } from "@/lib/api";

// Ğ¢Ğ¸Ğ¿Ñ‹ Ğ´Ğ°Ğ½Ğ½Ñ‹Ñ… Ğ´Ğ»Ñ Ğ´Ğ°ÑˆĞ±Ğ¾Ñ€Ğ´Ğ°
export interface DashboardSummary {
    pickups_today: PickupReturnItem[];
    returns_today: PickupReturnItem[];
    overdue_rentals: OverdueRentalItem[];
    kpi: {
        total_users: number;
        active_users: number;
        total_equipment: number;
        total_reservations: number;
        revenue_today: number;
        revenue_this_month: number;
        occupancy_rate: number;
        avg_rental_duration: number;
    };
    recent_activity: ActivityFeedItem[];
    popular_equipment: PopularEquipmentItem[];
}

export interface PickupReturnItem {
    id: number;
    user_name: string;
    equipment_name: string;
    scheduled_time: string | null;
    status: string;
    start_date?: string;
}

export interface OverdueRentalItem {
    id: number;
    user_name: string;
    equipment_name: string;
    due_date: string | null;
    days_overdue: number | null;
}

export interface ActivityFeedItem {
    id: number;
    type: 'reservation_created' | 'reservation_cancelled' | 'rental_started' | 'rental_completed' | 'user_registered' | 'equipment_added';
    description: string;
    timestamp: string;
    user_name?: string;
    equipment_name?: string;
}

export interface PopularEquipmentItem {
    equipment_id: number;
    equipment_name: string;
    rental_count: number;
    revenue: number;
}

export const useDashboardData = () => {
    return useQuery({
        queryKey: ['admin', 'dashboardSummary'],
        queryFn: async (): Promise<DashboardSummary> => {
            const response = await api.get('/admin/dashboard-summary');
            return response.data;
        },
        staleTime: 5 * 60 * 1000, // 5 Ğ¼Ğ¸Ğ½ÑƒÑ‚
        refetchInterval: 2 * 60 * 1000, // 2 Ğ¼Ğ¸Ğ½ÑƒÑ‚Ñ‹
        retry: 3,
        retryDelay: (attemptIndex) => Math.min(1000 * 2 ** attemptIndex, 30000),
    });
};


```


## <a name="rentalappmainsrchooksadminuseEquipmentTableLogicts"></a>`rental-app-main/src/hooks/admin/useEquipmentTableLogic.ts`

```typescript
// path: rental-app-main/src/hooks/admin/useEquipmentTableLogic.ts

// src/hooks/admin/useEquipmentTableLogic.ts
import { useState, useMemo } from "react";
import { useQueryClient } from "@tanstack/react-query";
import { useCurrentUser } from "@/hooks/useProfile";
// â›”ï¸ Ğ£Ğ´Ğ°Ğ»ÑĞµĞ¼ useEquipment, Ñ‚Ğ°Ğº ĞºĞ°Ğº Ñ…ÑƒĞº Ğ±Ğ¾Ğ»ÑŒÑˆĞµ Ğ½Ğµ Ğ±ÑƒĞ´ĞµÑ‚ Ğ·Ğ°Ğ³Ñ€ÑƒĞ¶Ğ°Ñ‚ÑŒ Ğ´Ğ°Ğ½Ğ½Ñ‹Ğµ ÑĞ°Ğ¼
// import { useEquipment } from "@/hooks/useEquipment";
import { useDeleteEquipment, useBulkDeleteEquipment } from "@/hooks/useAdminEquipment";
import { api } from "@/lib/api";
import { toast } from "sonner";
import type { Equipment } from "@/types/equipment"; // âœ… Ğ”Ğ¾Ğ±Ğ°Ğ²Ğ»ÑĞµĞ¼ Ğ¸Ğ¼Ğ¿Ğ¾Ñ€Ñ‚ Ñ‚Ğ¸Ğ¿Ğ°

interface EquipmentAvailability {
    hasActiveReservations: boolean;
    hasActiveRentals: boolean;
    activeReservationsCount: number;
    activeRentalsCount: number;
}

// âœ… Ğ¥ÑƒĞº Ñ‚ĞµĞ¿ĞµÑ€ÑŒ Ğ¿Ñ€Ğ¸Ğ½Ğ¸Ğ¼Ğ°ĞµÑ‚ Ğ¼Ğ°ÑÑĞ¸Ğ² Ğ¾Ğ±Ğ¾Ñ€ÑƒĞ´Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ ĞºĞ°Ğº Ğ°Ñ€Ğ³ÑƒĞ¼ĞµĞ½Ñ‚
export const useEquipmentTableLogic = (equipment: Equipment[] = []) => {
    const queryClient = useQueryClient();
    const { data: currentUser } = useCurrentUser();
    // â›”ï¸ Ğ£Ğ´Ğ°Ğ»ÑĞµĞ¼ Ğ²Ğ½ÑƒÑ‚Ñ€ĞµĞ½Ğ½Ğ¸Ğ¹ Ğ²Ñ‹Ğ·Ğ¾Ğ² useEquipment()
    // const { data: equipment = [], isLoading, error } = useEquipment();

    const [searchQuery, setSearchQuery] = useState("");
    const [selectedIds, setSelectedIds] = useState<number[]>([]);

    const deleteEquipmentMutation = useDeleteEquipment();
    const bulkDeleteMutation = useBulkDeleteEquipment();

    const isManager = currentUser?.role === "manager" || currentUser?.role === "admin";

    const filteredEquipment = useMemo(() => {
        const lowerCaseQuery = searchQuery.toLowerCase();
        return equipment.filter(item =>
            item.name.toLowerCase().includes(lowerCaseQuery) ||
            item.brand.toLowerCase().includes(lowerCaseQuery) ||
            item.equipment_type.toLowerCase().includes(lowerCaseQuery) ||
            (item.serial_number && item.serial_number.toLowerCase().includes(lowerCaseQuery))
        );
    }, [equipment, searchQuery]);

    const handleSelectAll = (checked: boolean) => {
        setSelectedIds(checked ? filteredEquipment.map(item => item.id) : []);
    };

    const handleSelectItem = (itemId: number, checked: boolean) => {
        setSelectedIds(prev =>
            checked ? [...prev, itemId] : prev.filter(id => id !== itemId)
        );
    };

    const handleDelete = async (itemId: number) => {
        if (!isManager) return;

        try {
            const availability = await queryClient.fetchQuery<EquipmentAvailability>({
                queryKey: ["equipment-availability", itemId],
                queryFn: async () => (await api.get<EquipmentAvailability>(`/equipment/${itemId}/availability`)).data,
            });

            if (availability.hasActiveReservations || availability.hasActiveRentals) {
                const messages = [];
                if (availability.hasActiveReservations) messages.push(`${availability.activeReservationsCount} Ğ°ĞºÑ‚Ğ¸Ğ²Ğ½Ñ‹Ñ… Ñ€ĞµĞ·ĞµÑ€Ğ²Ğ¾Ğ²`);
                if (availability.hasActiveRentals) messages.push(`${availability.activeRentalsCount} Ğ°ĞºÑ‚Ğ¸Ğ²Ğ½Ñ‹Ñ… Ğ°Ñ€ĞµĞ½Ğ´`);
                toast.error(`ĞĞµĞ²Ğ¾Ğ·Ğ¼Ğ¾Ğ¶Ğ½Ğ¾ ÑƒĞ´Ğ°Ğ»Ğ¸Ñ‚ÑŒ: Ñƒ Ğ¾Ğ±Ğ¾Ñ€ÑƒĞ´Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ ĞµÑÑ‚ÑŒ ${messages.join(" Ğ¸ ")}.`);
                return;
            }

            const equipmentToDelete = filteredEquipment.find(item => item.id === itemId);
            if (window.confirm(`Ğ£Ğ´Ğ°Ğ»Ğ¸Ñ‚ÑŒ "${equipmentToDelete?.name}"? Ğ”ĞµĞ¹ÑÑ‚Ğ²Ğ¸Ğµ Ğ½ĞµĞ»ÑŒĞ·Ñ Ğ¾Ñ‚Ğ¼ĞµĞ½Ğ¸Ñ‚ÑŒ.`)) {
                deleteEquipmentMutation.mutate(itemId);
            }
        } catch (err) {
            toast.error("ĞÑˆĞ¸Ğ±ĞºĞ° Ğ¿Ñ€Ğ¸ Ğ¿Ñ€Ğ¾Ğ²ĞµÑ€ĞºĞµ ÑÑ‚Ğ°Ñ‚ÑƒÑĞ° Ğ¾Ğ±Ğ¾Ñ€ÑƒĞ´Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ.");
            console.error("Availability check failed:", err);
        }
    };

    const handleBulkDelete = () => {
        if (!isManager || selectedIds.length === 0) return;
        if (window.confirm(`Ğ£Ğ´Ğ°Ğ»Ğ¸Ñ‚ÑŒ ${selectedIds.length} ĞµĞ´. Ğ¾Ğ±Ğ¾Ñ€ÑƒĞ´Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ?`)) {
            bulkDeleteMutation.mutate(selectedIds, {
                onSuccess: () => setSelectedIds([]),
            });
        }
    };

    const handlers = {
        setSearchQuery,
        handleSelectAll,
        handleSelectItem,
        handleDelete,
        handleBulkDelete
    };

    return {
        isManager,
        // âœ… Ğ¢Ğ°Ğº ĞºĞ°Ğº Ğ·Ğ°Ğ³Ñ€ÑƒĞ·ĞºĞ° Ğ¿Ñ€Ğ¾Ğ¸ÑÑ…Ğ¾Ğ´Ğ¸Ñ‚ Ğ²Ñ‹ÑˆĞµ, Ğ·Ğ´ĞµÑÑŒ Ğ¼Ñ‹ ÑÑ‡Ğ¸Ñ‚Ğ°ĞµĞ¼, Ñ‡Ñ‚Ğ¾ ĞµÑ‘ Ğ½ĞµÑ‚
        isLoading: false,
        error: null,
        equipment,
        filteredEquipment,
        searchQuery,
        selectedIds,
        deleteEquipmentMutation,
        bulkDeleteMutation,
        handlers,
    };
};

```


## <a name="rentalappmainsrchooksadminuseRentalReturnFormts"></a>`rental-app-main/src/hooks/admin/useRentalReturnForm.ts`

```typescript
// path: rental-app-main/src/hooks/admin/useRentalReturnForm.ts

// src/hooks/admin/useRentalReturnForm.ts

import { useForm } from "react-hook-form";
import { zodResolver } from "@hookform/resolvers/zod";
import { z } from "zod";
import { useReturnRental } from "@/hooks/useAdminRentals";
import { useAddUserPayment } from "@/hooks/useAdminUsers";
import { useQueryClient } from "@tanstack/react-query";
import { toast } from "sonner";
import type { AdminRentalOut, RentalAccessoryDetail } from "@/types/rental";
import { formatDate } from "@/lib/utils";
import { useState, useMemo, useEffect } from "react";
import type { Accessory } from "@/types/accessory";
import type { Equipment } from "@/types/equipment";

interface Props {
    rental: AdminRentalOut | null;
    onClose: () => void;
}

const returnSchema = z.object({
    actual_return_date: z.string().min(1, "Ğ”Ğ°Ñ‚Ğ° Ğ¾Ğ±ÑĞ·Ğ°Ñ‚ĞµĞ»ÑŒĞ½Ğ°"),
    notes_on_return: z.string().optional(),
});

type ReturnFormData = z.infer<typeof returnSchema>;

export function useRentalReturnForm({ rental, onClose }: Props) {
    const returnMutation = useReturnRental();
    const queryClient = useQueryClient();
    const paymentMutation = useAddUserPayment();
    
    const { register, handleSubmit, formState: { errors, isValid }, reset } = useForm<ReturnFormData>({
        resolver: zodResolver(returnSchema),
        mode: "onChange",
        defaultValues: {
            actual_return_date: formatDate(new Date()),
            notes_on_return: "",
        },
    });

    const [checkedAccessories, setCheckedAccessories] = useState<Set<string>>(new Set());
    
    // Ğ¡Ğ¾ÑÑ‚Ğ¾ÑĞ½Ğ¸Ğµ Ğ´Ğ»Ñ Ğ¿Ğ»Ğ°Ñ‚ĞµĞ¶Ğ°
    const [paymentAmount, setPaymentAmount] = useState("");
    const [paymentDescription, setPaymentDescription] = useState("");
    const [paymentApplied, setPaymentApplied] = useState(false);

    // Ğ”Ğ¸Ğ½Ğ°Ğ¼Ğ¸Ñ‡ĞµÑĞºĞ¸Ğ¹ Ğ¿ĞµÑ€ĞµÑÑ‡ĞµÑ‚ Ğ¾ÑÑ‚Ğ°Ñ‚ĞºĞ° Ñ ÑƒÑ‡ĞµÑ‚Ğ¾Ğ¼ ÑˆÑ‚Ñ€Ğ°Ñ„Ğ° Ğ·Ğ° Ğ¿Ñ€Ğ¾ÑÑ€Ğ¾Ñ‡ĞºÑƒ
    const dynamicRemainingAmount = useMemo(() => {
        if (!rental) return 0;
        
        const remaining = rental.remaining_amount || 0;
        const surcharge = rental.overdue_surcharge || 0;
        const payment = parseFloat(paymentAmount) || 0;

        // Ğ˜Ñ‚Ğ¾Ğ³Ğ¾Ğ²Ñ‹Ğ¹ Ğ¾ÑÑ‚Ğ°Ñ‚Ğ¾Ğº = (ĞÑÑ‚Ğ°Ñ‚Ğ¾Ğº Ğ¿Ğ¾ Ğ°Ñ€ĞµĞ½Ğ´Ğµ) + (Ğ¨Ñ‚Ñ€Ğ°Ñ„) - (Ğ’Ğ½ĞµÑĞµĞ½Ğ½Ñ‹Ğ¹ Ğ¿Ğ»Ğ°Ñ‚ĞµĞ¶)
        return Math.max(0, remaining + surcharge - payment);
    }, [rental, paymentAmount]);

    // Ğ“Ñ€ÑƒĞ¿Ğ¿Ğ¸Ñ€Ğ¾Ğ²ĞºĞ° Ğ°ĞºÑĞµÑÑÑƒĞ°Ñ€Ğ¾Ğ² Ğ¿Ğ¾ Ğ¾Ğ±Ğ¾Ñ€ÑƒĞ´Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ
    const accessoriesByEquipment = useMemo(() => {
        if (!rental?.accessory_links) return {};
        return rental.accessory_links.reduce((acc: Record<number, Accessory[]>, current: RentalAccessoryDetail) => {
            const equipmentId = current.equipment_id;
            (acc[equipmentId] = acc[equipmentId] || []).push(current.accessory);
            return acc;
        }, {} as Record<number, Accessory[]>);
    }, [rental]);

    const totalAccessoriesCount = rental?.accessory_links?.length ?? 0;
    const allAccessoriesChecked = checkedAccessories.size === totalAccessoriesCount;

    const handleToggleAccessory = (equipmentId: number, accessoryId: number) => {
        const key = `${equipmentId}-${accessoryId}`;
        setCheckedAccessories(prev => {
            const newSet = new Set(prev);
            if (newSet.has(key)) {
                newSet.delete(key);
            } else {
                newSet.add(key);
            }
            return newSet;
        });
    };

    // Ğ›Ğ¾Ğ³Ğ¸ĞºĞ° Ğ¾Ğ±Ñ€Ğ°Ğ±Ğ¾Ñ‚ĞºĞ¸ Ğ¿Ğ»Ğ°Ñ‚ĞµĞ¶Ğ°
    const handleApplyPayment = async () => {
        if (!rental || !paymentAmount) return;
        
        try {
            await paymentMutation.mutateAsync({
                userId: rental.user.id,
                data: {
                    amount: parseFloat(paymentAmount),
                    payment_method: "cash",
                    description: paymentDescription || `ĞŸĞ»Ğ°Ñ‚ĞµĞ¶ Ğ¿Ñ€Ğ¸ Ğ²Ğ¾Ğ·Ğ²Ñ€Ğ°Ñ‚Ğµ Ğ°Ñ€ĞµĞ½Ğ´Ñ‹ #${rental.id}`
                }
            });
            
            setPaymentApplied(true);
            toast.success("ĞŸĞ»Ğ°Ñ‚ĞµĞ¶ ÑƒÑĞ¿ĞµÑˆĞ½Ğ¾ Ğ·Ğ°Ğ½ĞµÑĞµĞ½.");
            
            // Ğ˜Ğ½Ğ²Ğ°Ğ»Ğ¸Ğ´Ğ¸Ñ€ÑƒĞµĞ¼ Ğ·Ğ°Ğ¿Ñ€Ğ¾ÑÑ‹ Ğ´Ğ»Ñ Ğ¾Ğ±Ğ½Ğ¾Ğ²Ğ»ĞµĞ½Ğ¸Ñ Ğ´Ğ°Ğ½Ğ½Ñ‹Ñ…
            await queryClient.invalidateQueries({ queryKey: ["admin", "users"] });
            await queryClient.invalidateQueries({ queryKey: ["adminRentals"] });
        } catch (error) {
            console.error("ĞÑˆĞ¸Ğ±ĞºĞ° Ğ¿Ñ€Ğ¸ Ğ²Ğ½ĞµÑĞµĞ½Ğ¸Ğ¸ Ğ¿Ğ»Ğ°Ñ‚ĞµĞ¶Ğ°:", error);
        }
    };

    // Ğ›Ğ¾Ğ³Ğ¸ĞºĞ° Ğ¾Ñ‚Ğ¼ĞµĞ½Ñ‹ Ğ¿Ğ»Ğ°Ñ‚ĞµĞ¶Ğ°
    const handleCancelPayment = () => {
        setPaymentAmount("");
        setPaymentDescription("");
        setPaymentApplied(false);
        toast.info("Ğ’Ğ²Ğ¾Ğ´ Ğ¿Ğ»Ğ°Ñ‚ĞµĞ¶Ğ° Ğ¾Ñ‚Ğ¼ĞµĞ½ĞµĞ½.");
    };

    // ĞĞ²Ñ‚Ğ¾Ğ·Ğ°Ğ¿Ğ¾Ğ»Ğ½ĞµĞ½Ğ¸Ğµ ÑÑƒĞ¼Ğ¼Ñ‹ Ğ¿Ğ»Ğ°Ñ‚ĞµĞ¶Ğ° Ñ ÑƒÑ‡ĞµÑ‚Ğ¾Ğ¼ ÑˆÑ‚Ñ€Ğ°Ñ„Ğ° Ğ·Ğ° Ğ¿Ñ€Ğ¾ÑÑ€Ğ¾Ñ‡ĞºÑƒ
    const handleAutoFillPayment = () => {
        if (rental) {
            const remaining = rental.remaining_amount || 0;
            const surcharge = rental.overdue_surcharge || 0;
            const totalAmount = remaining + surcharge;
            setPaymentAmount(totalAmount.toString());
        }
    };

    useEffect(() => {
        if (rental) {
            setCheckedAccessories(new Set());
            setPaymentAmount("");
            setPaymentDescription("");
            setPaymentApplied(false);
            reset({
                actual_return_date: formatDate(new Date()),
                notes_on_return: "",
            });
        }
    }, [rental, reset]);

    const onSubmit = (data: ReturnFormData) => {
        if (!rental) return;
        returnMutation.mutate(
            {
                rentalId: rental.id,
                data: {
                    ...data,
                    accessories_returned_confirmation: allAccessoriesChecked,
                }
            },
            {
                onSuccess: () => {
                    reset();
                    onClose();
                },
            }
        );
    };

    return {
        // Ğ¡Ğ¾ÑÑ‚Ğ¾ÑĞ½Ğ¸Ñ
        paymentAmount,
        setPaymentAmount,
        paymentDescription,
        setPaymentDescription,
        paymentApplied,
        checkedAccessories,
        dynamicRemainingAmount,
        
        // Ğ¤ÑƒĞ½ĞºÑ†Ğ¸Ğ¸-Ğ¾Ğ±Ñ€Ğ°Ğ±Ğ¾Ñ‚Ñ‡Ğ¸ĞºĞ¸
        handleApplyPayment,
        handleCancelPayment,
        handleToggleAccessory,
        handleAutoFillPayment,
        onSubmit,
        
        // Ğ¡Ğ¾ÑÑ‚Ğ¾ÑĞ½Ğ¸Ñ Ğ¼ÑƒÑ‚Ğ°Ñ†Ğ¸Ğ¹
        isSubmittingReturn: returnMutation.isPending,
        isApplyingPayment: paymentMutation.isPending,
        
        // Ğ”Ğ°Ğ½Ğ½Ñ‹Ğµ Ñ„Ğ¾Ñ€Ğ¼Ñ‹ Ğ¾Ñ‚ react-hook-form
        register,
        handleSubmit,
        formState: { errors, isValid },
        
        // Ğ”Ñ€ÑƒĞ³Ğ¸Ğµ Ğ²Ñ‹Ñ‡Ğ¸ÑĞ»ÑĞµĞ¼Ñ‹Ğµ Ğ·Ğ½Ğ°Ñ‡ĞµĞ½Ğ¸Ñ
        accessoriesByEquipment,
        allAccessoriesChecked,
        totalAccessoriesCount,
    };
}


```


## <a name="rentalappmainsrchooksadminuseUserTableLogicts"></a>`rental-app-main/src/hooks/admin/useUserTableLogic.ts`

```typescript
// path: rental-app-main/src/hooks/admin/useUserTableLogic.ts

// src/hooks/admin/useUserTableLogic.ts

import { useState, useMemo } from "react";
import { useCurrentUser } from "@/hooks/useProfile";
import {
    useUpdateUserRole,
    useBlockUser,
    useUnblockUser,
    useDeleteUser
} from "@/hooks/useAdminUsers";
import type { UserOut, UserRole } from "@/types/user";

export function useUserTableLogic(users: UserOut[]) {
    const { data: currentUser } = useCurrentUser();

    const [searchQuery, setSearchQuery] = useState("");
    const [confirmDelete, setConfirmDelete] = useState<number | null>(null);

    const updateRoleMutation = useUpdateUserRole();
    const blockUserMutation = useBlockUser();
    const unblockUserMutation = useUnblockUser();
    const deleteUserMutation = useDeleteUser();

    const isAdmin = currentUser?.role === "admin";

    const filteredUsers = useMemo(() => {
        return users.filter(user =>
            user.full_name.toLowerCase().includes(searchQuery.toLowerCase()) ||
            user.email.toLowerCase().includes(searchQuery.toLowerCase()) ||
            user.role.toLowerCase().includes(searchQuery.toLowerCase())
        );
    }, [users, searchQuery]);

    const handleRoleChange = (userId: number, newRole: string) => {
        if (!isAdmin) return;
        // Ğ˜Ğ—ĞœĞ•ĞĞ•ĞĞ˜Ğ•: ĞŸÑ€Ğ¸Ğ²Ğ¾Ğ´Ğ¸Ğ¼ string Ğº Ñ‚Ğ¸Ğ¿Ñƒ UserRole Ğ¿ĞµÑ€ĞµĞ´ Ğ²Ñ‹Ğ·Ğ¾Ğ²Ğ¾Ğ¼ Ğ¼ÑƒÑ‚Ğ°Ñ†Ğ¸Ğ¸
        updateRoleMutation.mutate({ userId, newRole: newRole as UserRole });
    };

    const handleToggleBlock = (user: UserOut) => {
        if (!isAdmin) return;
        if (user.is_active) {
            blockUserMutation.mutate(user.id);
        } else {
            unblockUserMutation.mutate(user.id);
        }
    };

    const handleDelete = (userId: number) => {
        if (!isAdmin) return;
        if (confirmDelete === userId) {
            deleteUserMutation.mutate(userId);
            setConfirmDelete(null);
        } else {
            setConfirmDelete(userId);
            setTimeout(() => setConfirmDelete(null), 5000);
        }
    };

    return {
        currentUser,
        filteredUsers,
        isAdmin,
        searchQuery,
        setSearchQuery,
        confirmDelete,
        mutations: {
            updateRole: updateRoleMutation,
            blockUser: blockUserMutation,
            unblockUser: unblockUserMutation,
            deleteUser: deleteUserMutation,
        },
        handlers: {
            handleRoleChange,
            handleToggleBlock,
            handleDelete,
        },
    };
}

```


## <a name="rentalappmainsrchooksdatauseEquipmentDatats"></a>`rental-app-main/src/hooks/data/useEquipmentData.ts`

```typescript
// path: rental-app-main/src/hooks/data/useEquipmentData.ts

// src/hooks/data/useEquipmentData.ts

import { useMemo } from "react";
import { useEquipment } from "@/hooks/useEquipment";
import { useAvailabilityCheck } from "@/hooks/useAvailabilityCheck";
import { useDailyAvailability } from "@/hooks/useDailyAvailability";
import { useReserveStore } from "@/store/reserveStore";
import type { Equipment } from "@/types/equipment";
import type { AvailabilityInfo, DailyAvailabilityData } from "@/types/availability";

export interface EquipmentFilters {
    query?: string;
    type?: string;
    brand?: string;
    associationId?: number;
    availableOnly?: boolean;
    startDate?: Date;
    endDate?: Date;
}

export interface UseEquipmentDataReturn {
    equipment: Equipment[];
    totalEquipmentCount: number;
    availabilityData: AvailabilityInfo[];
    dailyAvailabilityData: DailyAvailabilityData | undefined;
    isLoading: boolean;
    isFetchingNextPage: boolean;
    hasNextPage: boolean;
    fetchNextPage: () => void;
}

export const useEquipmentData = (filters: EquipmentFilters): UseEquipmentDataReturn => {
    const { addToReservationMode } = useReserveStore();

    // Ğ—Ğ°Ğ³Ñ€ÑƒĞ¶Ğ°ĞµĞ¼ Ğ¿Ğ°Ğ³Ğ¸Ğ½Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ½Ñ‹Ğ¹ ÑĞ¿Ğ¸ÑĞ¾Ğº Ğ¾Ğ±Ğ¾Ñ€ÑƒĞ´Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ
    const {
        data: equipmentPages,
        fetchNextPage,
        hasNextPage,
        isLoading,
        isFetchingNextPage
    } = useEquipment(filters);

    // Ğ˜Ğ·Ğ²Ğ»ĞµĞºĞ°ĞµĞ¼ Ğ¿Ğ»Ğ¾ÑĞºĞ¸Ğ¹ Ğ¼Ğ°ÑÑĞ¸Ğ² Ğ¾Ğ±Ğ¾Ñ€ÑƒĞ´Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ
    const equipment = useMemo(() =>
        equipmentPages?.pages.flatMap(page => page.items) ?? [],
        [equipmentPages]
    );

    const totalEquipmentCount = equipmentPages?.pages[0]?.total ?? 0;

    // Ğ—Ğ°Ğ³Ñ€ÑƒĞ¶Ğ°ĞµĞ¼ Ğ´Ğ°Ğ½Ğ½Ñ‹Ğµ Ğ¾ Ğ´Ğ¾ÑÑ‚ÑƒĞ¿Ğ½Ğ¾ÑÑ‚Ğ¸ Ğ´Ğ»Ñ Ğ²ÑĞµĞ³Ğ¾ Ğ¾Ğ±Ğ¾Ñ€ÑƒĞ´Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ
    const { availabilityMap } = useAvailabilityCheck({
        equipmentIds: equipment.map(e => e.id),
        startDate: filters.startDate || new Date(),
        endDate: filters.endDate || new Date(),
        excludeReservationId: addToReservationMode || undefined,
        enabled: !!(filters.startDate && filters.endDate && equipment.length > 0)
    });

    // ĞŸÑ€ĞµĞ¾Ğ±Ñ€Ğ°Ğ·ÑƒĞµĞ¼ availabilityMap Ğ¾Ğ±Ñ€Ğ°Ñ‚Ğ½Ğ¾ Ğ² Ğ¼Ğ°ÑÑĞ¸Ğ² Ğ´Ğ»Ñ ÑĞ¾Ğ²Ğ¼ĞµÑÑ‚Ğ¸Ğ¼Ğ¾ÑÑ‚Ğ¸
    const availabilityData = useMemo(() => 
        Object.values(availabilityMap), 
        [availabilityMap]
    );

    // Ğ—Ğ°Ğ³Ñ€ÑƒĞ¶Ğ°ĞµĞ¼ Ğ´Ğ°Ğ½Ğ½Ñ‹Ğµ Ğ¾ ĞµĞ¶ĞµĞ´Ğ½ĞµĞ²Ğ½Ğ¾Ğ¹ Ğ´Ğ¾ÑÑ‚ÑƒĞ¿Ğ½Ğ¾ÑÑ‚Ğ¸ Ğ´Ğ»Ñ Ğ²Ğ¸Ğ´Ğ¸Ğ¼Ñ‹Ñ… ÑĞ»ĞµĞ¼ĞµĞ½Ñ‚Ğ¾Ğ²
    const thirtyDaysFromNow = useMemo(() => new Date(Date.now() + 30 * 24 * 60 * 60 * 1000), []);
    const { data: dailyAvailabilityData } = useDailyAvailability({
        ids: equipment.map(item => item.id),
        start: new Date(),
        end: thirtyDaysFromNow,
    });

    return {
        equipment,
        totalEquipmentCount,
        availabilityData,
        dailyAvailabilityData,
        isLoading,
        isFetchingNextPage,
        hasNextPage,
        fetchNextPage
    };
};



```


## <a name="rentalappmainsrchooksfeaturesuseAppFiltersts"></a>`rental-app-main/src/hooks/features/useAppFilters.ts`

```typescript
// path: rental-app-main/src/hooks/features/useAppFilters.ts

// src/hooks/features/useAppFilters.ts

import { useSearchStore } from "@/store/searchStore";
import { useFilterStore } from "@/store/filterStore";
import { useDateStore } from "@/store/dateStore";

/**
 * Ğ¥ÑƒĞº Ğ´Ğ»Ñ Ğ¸Ğ½ĞºĞ°Ğ¿ÑÑƒĞ»ÑÑ†Ğ¸Ğ¸ Ğ»Ğ¾Ğ³Ğ¸ĞºĞ¸ Ğ¿Ğ¾Ğ»ÑƒÑ‡ĞµĞ½Ğ¸Ñ Ğ²ÑĞµÑ… Ñ„Ğ¸Ğ»ÑŒÑ‚Ñ€Ğ¾Ğ² Ğ¿Ñ€Ğ¸Ğ»Ğ¾Ğ¶ĞµĞ½Ğ¸Ñ
 * ĞĞ±ÑŠĞµĞ´Ğ¸Ğ½ÑĞµÑ‚ ÑĞ¾ÑÑ‚Ğ¾ÑĞ½Ğ¸Ğµ Ğ¸Ğ· Ñ‚Ñ€ĞµÑ… ÑÑ‚Ğ¾Ñ€Ğ¾Ğ²: Ğ¿Ğ¾Ğ¸ÑĞºĞ°, Ñ„Ğ¸Ğ»ÑŒÑ‚Ñ€Ğ¾Ğ² Ğ¸ Ğ´Ğ°Ñ‚
 */
export const useAppFilters = () => {
    const search = useSearchStore();
    const filters = useFilterStore();
    const dates = useDateStore();

    return {
        // ĞŸĞ¾Ğ¸ÑĞº
        query: search.query,
        
        // Ğ¤Ğ¸Ğ»ÑŒÑ‚Ñ€Ñ‹
        type: filters.type,
        brand: filters.brand,
        availableOnly: filters.availableOnly,
        associationId: filters.associationId,
        reset: filters.reset,
        
        // Ğ”Ğ°Ñ‚Ñ‹
        startDate: dates.startDate,
        endDate: dates.endDate,
    };
};



```


## <a name="rentalappmainsrchooksfeaturesuseEquipmentCardViewModelts"></a>`rental-app-main/src/hooks/features/useEquipmentCardViewModel.ts`

```typescript
// path: rental-app-main/src/hooks/features/useEquipmentCardViewModel.ts

// src/hooks/features/useEquipmentCardViewModel.ts

import { useMemo, useCallback } from "react";
import { useReserveStore } from "@/store/reserveStore";
import { useDateStore } from "@/store/dateStore";
import { useSandboxCalculatorStore } from "@/store/sandboxCalculatorStore";
import { usePromoCodeStore } from "@/store/promoCodeStore";
import type { Equipment } from "@/types/equipment";
import type { EquipmentStatus } from "@/types/availability";

interface UseEquipmentCardViewModelProps {
    equipment: Equipment;
    status?: EquipmentStatus | "my_reservation" | "added";
}

/**
 * Ğ¥ÑƒĞº Ğ´Ğ»Ñ ÑƒĞ¿Ñ€Ğ°Ğ²Ğ»ĞµĞ½Ğ¸Ñ Ğ»Ğ¾Ğ³Ğ¸ĞºĞ¾Ğ¹ ĞºĞ°Ñ€Ñ‚Ğ¾Ñ‡ĞºĞ¸ Ğ¾Ğ±Ğ¾Ñ€ÑƒĞ´Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ.
 * Ğ¡Ğ¾Ğ´ĞµÑ€Ğ¶Ğ¸Ñ‚ Ğ²ÑĞµ Ñ…ÑƒĞºĞ¸, Ñ€Ğ°ÑÑ‡ĞµÑ‚Ñ‹ Ğ¸ Ğ¾Ğ±Ñ€Ğ°Ğ±Ğ¾Ñ‚Ñ‡Ğ¸ĞºĞ¸ ÑĞ¾Ğ±Ñ‹Ñ‚Ğ¸Ğ¹ Ğ´Ğ»Ñ EquipmentCard.
 */
export const useEquipmentCardViewModel = ({ equipment, status: _status = "available" }: UseEquipmentCardViewModelProps) => {
    // ĞŸĞ¾Ğ»ÑƒÑ‡ĞµĞ½Ğ¸Ğµ Ğ´Ğ°Ğ½Ğ½Ñ‹Ñ… Ğ¸Ğ· Ğ²ÑĞµÑ… ÑÑ‚Ğ¾Ñ€Ğ¾Ğ²
    const { toggle, isSelected, toggleAccessory, isAccessorySelected, selectedAccessories } = useReserveStore();
    const { dayCount } = useDateStore();
    const { isCalculatorVisible, durationDiscountPercentage } = useSandboxCalculatorStore();
    const { promoCodePercentage } = usePromoCodeStore();

    // ĞŸÑ€Ğ¾Ğ²ĞµÑ€ĞºĞ° Ğ²Ñ‹Ğ±Ñ€Ğ°Ğ½Ğ½Ğ¾ÑÑ‚Ğ¸ Ğ¾Ğ±Ğ¾Ñ€ÑƒĞ´Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ
    const isSelectedByUser = isSelected(equipment.id);

    // Ğ Ğ°ÑÑ‡ĞµÑ‚ ÑÑƒÑ‚Ğ¾Ñ‡Ğ½Ğ¾Ğ¹ ÑÑ‚Ğ¾Ğ¸Ğ¼Ğ¾ÑÑ‚Ğ¸ Ğ°ĞºÑĞµÑÑÑƒĞ°Ñ€Ğ¾Ğ²
    const accessoriesDailyRate = useMemo(() => {
        const selectedForThisCard = selectedAccessories[equipment.id] || [];
        return equipment.accessories?.reduce((total, acc) => 
            selectedForThisCard.includes(acc.id) ? total + acc.price : total, 0) ?? 0;
    }, [equipment.accessories, equipment.id, selectedAccessories]);

    // Ğ Ğ°ÑÑ‡ĞµÑ‚ Ğ¾Ğ±Ñ‰ĞµĞ¹ ÑĞºĞ¸Ğ´ĞºĞ¸
    const totalDiscountPercentage = useMemo(() => 
        durationDiscountPercentage + promoCodePercentage, 
        [durationDiscountPercentage, promoCodePercentage]
    );

    // Ğ”Ğ°Ğ½Ğ½Ñ‹Ğµ Ğ´Ğ»Ñ Ğ¾Ñ‚Ğ¾Ğ±Ñ€Ğ°Ğ¶ĞµĞ½Ğ¸Ñ ÑĞºĞ¸Ğ´ĞºĞ¸
    const discountData = useMemo(() => {
        const totalDailyRate = equipment.daily_rate + accessoriesDailyRate;
        const priceBefore = totalDailyRate * dayCount;
        return {
            days: dayCount,
            percentage: totalDiscountPercentage,
            priceBefore,
            priceAfter: priceBefore * (1 - totalDiscountPercentage / 100),
        };
    }, [equipment.daily_rate, accessoriesDailyRate, dayCount, totalDiscountPercentage]);

    // ĞĞ±Ñ€Ğ°Ğ±Ğ¾Ñ‚Ñ‡Ğ¸Ğº Ğ¿ĞµÑ€ĞµĞºĞ»ÑÑ‡ĞµĞ½Ğ¸Ñ Ğ°ĞºÑĞµÑÑÑƒĞ°Ñ€Ğ°
    const handleToggleAccessory = useCallback((accessoryId: number) => {
        if (!isSelectedByUser) toggle(equipment);
        toggleAccessory(equipment.id, accessoryId);
    }, [isSelectedByUser, toggle, equipment, toggleAccessory]);

    // ĞĞ±Ñ€Ğ°Ğ±Ğ¾Ñ‚Ñ‡Ğ¸Ğº Ğ¿ĞµÑ€ĞµĞºĞ»ÑÑ‡ĞµĞ½Ğ¸Ñ Ğ²Ñ‹Ğ±Ğ¾Ñ€Ğ° Ğ¾Ğ±Ğ¾Ñ€ÑƒĞ´Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ
    const handleToggleSelection = useCallback(() => {
        toggle(equipment);
    }, [toggle, equipment]);

    return {
        // Ğ¡Ğ¾ÑÑ‚Ğ¾ÑĞ½Ğ¸Ğµ
        isSelectedByUser,
        isCalculatorVisible,
        
        // Ğ Ğ°ÑÑ‡ĞµÑ‚Ñ‹
        accessoriesDailyRate,
        totalDiscountPercentage,
        discountData,
        
        // Ğ¤ÑƒĞ½ĞºÑ†Ğ¸Ğ¸
        handleToggleAccessory,
        handleToggleSelection,
        isAccessorySelected,
    };
};


```


## <a name="rentalappmainsrchooksreservationsubmissionuseReservationFormDatats"></a>`rental-app-main/src/hooks/reservation/submission/useReservationFormData.ts`

```typescript
// path: rental-app-main/src/hooks/reservation/submission/useReservationFormData.ts

// src/hooks/reservation/submission/useReservationFormData.ts

import { useReserveStore } from "@/store/reserveStore";
import { useDateStore } from "@/store/dateStore";
import { usePromoCodeStore } from "@/store/promoCodeStore";
import { useCurrentUser } from "@/hooks/useProfile";

/**
 * Ğ¥ÑƒĞº-Ğ°Ğ³Ñ€ĞµĞ³Ğ°Ñ‚Ğ¾Ñ€ Ğ´Ğ»Ñ ÑĞ±Ğ¾Ñ€Ğ° Ğ´Ğ°Ğ½Ğ½Ñ‹Ñ… Ğ¸Ğ· Ñ€Ğ°Ğ·Ğ»Ğ¸Ñ‡Ğ½Ñ‹Ñ… Ñ…Ñ€Ğ°Ğ½Ğ¸Ğ»Ğ¸Ñ‰ (Zustand).
 * Ğ¡Ğ¾Ğ±Ğ¸Ñ€Ğ°ĞµÑ‚ Ğ¸ Ğ²Ğ¾Ğ·Ğ²Ñ€Ğ°Ñ‰Ğ°ĞµÑ‚ ĞµĞ´Ğ¸Ğ½Ñ‹Ğ¹ Ğ¾Ğ±ÑŠĞµĞºÑ‚ ÑĞ¾ Ğ²ÑĞµĞ¼Ğ¸ Ğ½ĞµĞ¾Ğ±Ñ…Ğ¾Ğ´Ğ¸Ğ¼Ñ‹Ğ¼Ğ¸ Ğ´Ğ°Ğ½Ğ½Ñ‹Ğ¼Ğ¸ Ğ´Ğ»Ñ ÑÑ‚Ñ€Ğ°Ğ½Ğ¸Ñ†Ñ‹ Ğ¾Ñ„Ğ¾Ñ€Ğ¼Ğ»ĞµĞ½Ğ¸Ñ.
 */
export const useReservationFormData = () => {
    // ĞŸĞ¾Ğ»ÑƒÑ‡ĞµĞ½Ğ¸Ğµ Ğ´Ğ°Ğ½Ğ½Ñ‹Ñ… Ğ¸Ğ· Ğ²ÑĞµÑ… ÑÑ‚Ğ¾Ñ€Ğ¾Ğ²
    const { data: user } = useCurrentUser();
    const { startDate, endDate, setStartDate, setEndDate, dayCount } = useDateStore();
    const { 
        items, 
        selectedAccessories, 
        remove: removeItemFromStore, 
        clear: clearReserveStore, 
        isAccessorySelected, 
        toggleAccessory 
    } = useReserveStore();
    const { 
        promoCode: promoCodeInput, 
        setPromoCode: setPromoCodeInput, 
        removePromoCode 
    } = usePromoCodeStore();

    return {
        // Ğ”Ğ°Ğ½Ğ½Ñ‹Ğµ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ñ
        user,
        
        // Ğ”Ğ°Ğ½Ğ½Ñ‹Ğµ Ğ´Ğ°Ñ‚
        startDate,
        endDate,
        dayCount,
        
        // Ğ”Ğ°Ğ½Ğ½Ñ‹Ğµ Ñ€ĞµĞ·ĞµÑ€Ğ²Ğ°
        items,
        selectedAccessories,
        
        // ĞŸÑ€Ğ¾Ğ¼Ğ¾ĞºĞ¾Ğ´
        promoCodeInput,
        
        // Ğ¤ÑƒĞ½ĞºÑ†Ğ¸Ğ¸ ÑƒĞ¿Ñ€Ğ°Ğ²Ğ»ĞµĞ½Ğ¸Ñ Ğ´Ğ°Ñ‚Ğ°Ğ¼Ğ¸
        setStartDate,
        setEndDate,
        
        // Ğ¤ÑƒĞ½ĞºÑ†Ğ¸Ğ¸ ÑƒĞ¿Ñ€Ğ°Ğ²Ğ»ĞµĞ½Ğ¸Ñ Ñ€ĞµĞ·ĞµÑ€Ğ²Ğ¾Ğ¼
        removeItemFromStore,
        clearReserveStore,
        isAccessorySelected,
        toggleAccessory,
        
        // Ğ¤ÑƒĞ½ĞºÑ†Ğ¸Ğ¸ ÑƒĞ¿Ñ€Ğ°Ğ²Ğ»ĞµĞ½Ğ¸Ñ Ğ¿Ñ€Ğ¾Ğ¼Ğ¾ĞºĞ¾Ğ´Ğ¾Ğ¼
        setPromoCodeInput,
        removePromoCode,
    };
};


```


## <a name="rentalappmainsrchooksreservationsubmissionuseReserveSubmissionts"></a>`rental-app-main/src/hooks/reservation/submission/useReserveSubmission.ts`

```typescript
// path: rental-app-main/src/hooks/reservation/submission/useReserveSubmission.ts

// src/hooks/reservation/submission/useReserveSubmission.ts

import { useMemo, useState } from "react";
import { toast } from "sonner";
import { useReservations } from "@/hooks/useReservations";
import { useAvailabilityCheck } from "@/hooks/useAvailabilityCheck";
import { reservationCreateSchema, type ReservationCreateInput } from "@/lib/validationSchemas";
import { usePriceCalculator } from "../usePriceCalculator";
import { formatDate } from "@/lib/utils";
import { useReservationFormData } from "./useReservationFormData";

/**
 * Ğ¥ÑƒĞº-ĞºĞ¾Ğ¾Ñ€Ğ´Ğ¸Ğ½Ğ°Ñ‚Ğ¾Ñ€ Ğ´Ğ»Ñ ÑÑ‚Ñ€Ğ°Ğ½Ğ¸Ñ†Ñ‹ Ğ¾Ñ„Ğ¾Ñ€Ğ¼Ğ»ĞµĞ½Ğ¸Ñ Ñ€ĞµĞ·ĞµÑ€Ğ²Ğ°.
 * Ğ˜ÑĞ¿Ğ¾Ğ»ÑŒĞ·ÑƒĞµÑ‚ Ñ…ÑƒĞº-Ğ°Ğ³Ñ€ĞµĞ³Ğ°Ñ‚Ğ¾Ñ€ Ğ´Ğ»Ñ Ğ¿Ğ¾Ğ»ÑƒÑ‡ĞµĞ½Ğ¸Ñ Ğ´Ğ°Ğ½Ğ½Ñ‹Ñ… Ğ¸ ÑĞ¾Ğ´ĞµÑ€Ğ¶Ğ¸Ñ‚ Ğ»Ğ¾Ğ³Ğ¸ĞºÑƒ Ğ¾Ğ±Ñ€Ğ°Ğ±Ğ¾Ñ‚ĞºĞ¸ Ğ¸ Ğ¾Ñ‚Ğ¿Ñ€Ğ°Ğ²ĞºĞ¸ Ñ„Ğ¾Ñ€Ğ¼Ñ‹.
 */
export function useReserveSubmission() {
    // ĞŸĞ¾Ğ»ÑƒÑ‡ĞµĞ½Ğ¸Ğµ Ğ²ÑĞµÑ… Ğ´Ğ°Ğ½Ğ½Ñ‹Ñ… Ñ‡ĞµÑ€ĞµĞ· Ñ…ÑƒĞº-Ğ°Ğ³Ñ€ĞµĞ³Ğ°Ñ‚Ğ¾Ñ€
    const {
        user,
        startDate,
        endDate,
        dayCount,
        items,
        selectedAccessories,
        promoCodeInput,
        setStartDate,
        setEndDate,
        removeItemFromStore,
        clearReserveStore,
        isAccessorySelected,
        toggleAccessory,
        setPromoCodeInput,
        removePromoCode,
    } = useReservationFormData();

    // Ğ›Ğ¾ĞºĞ°Ğ»ÑŒĞ½Ğ¾Ğµ ÑĞ¾ÑÑ‚Ğ¾ÑĞ½Ğ¸Ğµ Ğ´Ğ»Ñ Ğ¿Ñ€Ğ¾Ğ¼Ğ¾ĞºĞ¾Ğ´Ğ°, ĞºĞ¾Ñ‚Ğ¾Ñ€Ñ‹Ğ¹ Ğ±Ñ‹Ğ» Ğ¿Ñ€Ğ¸Ğ¼ĞµĞ½ĞµĞ½ Ğº Ñ€Ğ°ÑÑ‡ĞµÑ‚Ñƒ
    const [appliedPromoCode, setAppliedPromoCode] = useState(promoCodeInput);

    // --- Ğ ĞĞ¡Ğ§Ğ•Ğ¢Ğ« Ğ˜ ĞŸĞ ĞĞ’Ğ•Ğ ĞšĞ˜ ---
    const equipmentIds = useMemo(() => items.map(i => i.id), [items]);

    // ĞŸÑ€Ğ¾Ğ²ĞµÑ€ĞºĞ° Ğ´Ğ¾ÑÑ‚ÑƒĞ¿Ğ½Ğ¾ÑÑ‚Ğ¸ Ğ¾Ğ±Ğ¾Ñ€ÑƒĞ´Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ Ğ½Ğ° Ğ²Ñ‹Ğ±Ñ€Ğ°Ğ½Ğ½Ñ‹Ğµ Ğ´Ğ°Ñ‚Ñ‹
    const { availabilityMap, conflictingItemIds, isLoading: isCheckingAvailability } = useAvailabilityCheck({
        equipmentIds, startDate, endDate
    });

    // Ğ Ğ°ÑÑ‡ĞµÑ‚ Ğ¸Ñ‚Ğ¾Ğ³Ğ¾Ğ²Ğ¾Ğ¹ ÑÑ‚Ğ¾Ğ¸Ğ¼Ğ¾ÑÑ‚Ğ¸ Ñ Ğ¿Ğ¾Ğ¼Ğ¾Ñ‰ÑŒÑ Ñ€Ğ°ÑÑˆĞ¸Ñ€ĞµĞ½Ğ½Ğ¾Ğ³Ğ¾ usePriceCalculator
    const priceCalculator = usePriceCalculator({
        equipmentIds, startDate, endDate, selectedAccessories, promoCode: appliedPromoCode
    });

    // Ğ Ğ°ÑÑ‡ĞµÑ‚ ÑÑƒÑ‚Ğ¾Ñ‡Ğ½Ğ¾Ğ¹ ÑÑ‚Ğ¾Ğ¸Ğ¼Ğ¾ÑÑ‚Ğ¸ Ğ°ĞºÑĞµÑÑÑƒĞ°Ñ€Ğ¾Ğ² (Ğ´Ğ»Ñ Ğ¸Ğ½Ñ„Ğ¾Ñ€Ğ¼Ğ°Ñ†Ğ¸Ğ¸)
    const accessoriesDailyTotal = useMemo(() => {
        return items.reduce((total, item) => {
            const selectedForThisItem = selectedAccessories[item.id] || [];
            return total + (item.accessories?.reduce((accTotal, accessory) =>
                selectedForThisItem.includes(accessory.id) ? accTotal + accessory.price : accTotal, 0) ?? 0);
        }, 0);
    }, [items, selectedAccessories]);

    // --- Ğ›ĞĞ“Ğ˜ĞšĞ ĞĞ¢ĞŸĞ ĞĞ’ĞšĞ˜ Ğ¤ĞĞ ĞœĞ« ---
    const { createReservation } = useReservations();
    const { isPending: isSubmitting, isSuccess: reservationSuccess, mutateAsync, error } = createReservation;

    // Ğ˜Ğ·Ğ²Ğ»ĞµĞºĞ°ĞµĞ¼ ID Ğ½ĞµĞ´Ğ¾ÑÑ‚ÑƒĞ¿Ğ½Ñ‹Ñ… Ñ‚Ğ¾Ğ²Ğ°Ñ€Ğ¾Ğ² Ğ¸Ğ· Ğ¾ÑˆĞ¸Ğ±ĞºĞ¸, ĞµÑĞ»Ğ¸ Ğ¾Ğ½Ğ° ĞµÑÑ‚ÑŒ
    const unavailableIdsFromAPI = useMemo(() => (error as { unavailable_ids?: number[] })?.unavailable_ids ?? [], [error]);

    const handleSubmit = async () => {
        if (!user) {
            toast.error("ĞĞµĞ¾Ğ±Ñ…Ğ¾Ğ´Ğ¸Ğ¼Ğ¾ Ğ°Ğ²Ñ‚Ğ¾Ñ€Ğ¸Ğ·Ğ¾Ğ²Ğ°Ñ‚ÑŒÑÑ Ğ´Ğ»Ñ ÑĞ¾Ğ·Ğ´Ğ°Ğ½Ğ¸Ñ Ñ€ĞµĞ·ĞµÑ€Ğ²Ğ°.");
            return;
        }
        if (conflictingItemIds.length > 0) {
            toast.error("ĞĞµĞºĞ¾Ñ‚Ğ¾Ñ€Ñ‹Ğµ Ğ²Ñ‹Ğ±Ñ€Ğ°Ğ½Ğ½Ñ‹Ğµ Ğ¿Ğ¾Ğ·Ğ¸Ñ†Ğ¸Ğ¸ Ğ½ĞµĞ´Ğ¾ÑÑ‚ÑƒĞ¿Ğ½Ñ‹. Ğ£Ğ´Ğ°Ğ»Ğ¸Ñ‚Ğµ Ğ¸Ñ… Ğ¸Ğ»Ğ¸ Ğ¸Ğ·Ğ¼ĞµĞ½Ğ¸Ñ‚Ğµ Ğ´Ğ°Ñ‚Ñ‹.");
            return;
        }

        const payload: ReservationCreateInput = {
            equipment_ids: items.map(i => i.id),
            start_date: formatDate(startDate),
            end_date: formatDate(endDate),
            selected_accessories: selectedAccessories,
            promo_code: appliedPromoCode || undefined,
        };

        const validationResult = reservationCreateSchema.safeParse(payload);
        if (!validationResult.success) {
            const errorMessages = validationResult.error.errors.map(e => e.message).join("\n");
            toast.error(`ĞÑˆĞ¸Ğ±ĞºĞ° Ğ²Ğ°Ğ»Ğ¸Ğ´Ğ°Ñ†Ğ¸Ğ¸ Ğ´Ğ°Ğ½Ğ½Ñ‹Ñ…:\n${errorMessages}`);
            return;
        }

        try {
            await mutateAsync(validationResult.data);
            toast.success("Ğ ĞµĞ·ĞµÑ€Ğ² ÑƒÑĞ¿ĞµÑˆĞ½Ğ¾ ÑĞ¾Ğ·Ğ´Ğ°Ğ½!");
            clearReserveStore();
            // ĞÑ‡Ğ¸Ñ‰Ğ°ĞµĞ¼ Ğ¿Ñ€Ğ¾Ğ¼Ğ¾ĞºĞ¾Ğ´ Ğ¿Ğ¾ÑĞ»Ğµ ÑƒÑĞ¿ĞµÑˆĞ½Ğ¾Ğ³Ğ¾ Ñ€ĞµĞ·ĞµÑ€Ğ²Ğ°
            removePromoCode();
        } catch (e: unknown) {
            // ĞÑˆĞ¸Ğ±ĞºĞ¸ (Ğ²ĞºĞ»ÑÑ‡Ğ°Ñ 409 Ñ ĞºĞ¾Ğ½Ñ„Ğ»Ğ¸ĞºÑ‚Ğ°Ğ¼Ğ¸) Ñ‚ĞµĞ¿ĞµÑ€ÑŒ Ğ¾Ğ±Ñ€Ğ°Ğ±Ğ°Ñ‚Ñ‹Ğ²Ğ°ÑÑ‚ÑÑ Ğ¸ Ğ¾Ñ‚Ğ¾Ğ±Ñ€Ğ°Ğ¶Ğ°ÑÑ‚ÑÑ
            // Ñ†ĞµĞ½Ñ‚Ñ€Ğ°Ğ»Ğ¸Ğ·Ğ¾Ğ²Ğ°Ğ½Ğ½Ğ¾ Ğ² Ñ…ÑƒĞºĞµ useReservations. Ğ—Ğ´ĞµÑÑŒ Ğ¼Ñ‹ Ğ¿Ñ€Ğ¾ÑÑ‚Ğ¾ Ğ»Ğ¾Ğ³Ğ¸Ñ€ÑƒĞµĞ¼ Ğ¸Ñ….
            console.error("Submission failed:", e);
        }
    };

    // Ğ¤ÑƒĞ½ĞºÑ†Ğ¸Ñ, ĞºĞ¾Ñ‚Ğ¾Ñ€Ğ°Ñ "Ñ„Ğ¸ĞºÑĞ¸Ñ€ÑƒĞµÑ‚" Ğ²Ğ²ĞµĞ´ĞµĞ½Ğ½Ñ‹Ğ¹ Ğ¿Ñ€Ğ¾Ğ¼Ğ¾ĞºĞ¾Ğ´ Ğ´Ğ»Ñ Ñ€Ğ°ÑÑ‡ĞµÑ‚Ğ°
    const applyPromoCode = () => {
        setAppliedPromoCode(promoCodeInput);
    };

    // --- Ğ’ĞĞ—Ğ’Ğ ĞĞ¢ Ğ”ĞĞĞĞ«Ğ¥ Ğ”Ğ›Ğ¯ UI ---
    // Ğ¡Ğ¾Ğ±Ğ¸Ñ€Ğ°ĞµĞ¼ Ğ²ÑĞµ Ğ½ĞµĞ¾Ğ±Ñ…Ğ¾Ğ´Ğ¸Ğ¼Ñ‹Ğµ Ğ´Ğ°Ğ½Ğ½Ñ‹Ğµ Ğ¸ Ñ„ÑƒĞ½ĞºÑ†Ğ¸Ğ¸ Ğ² Ğ¾Ğ´Ğ¸Ğ½ Ğ¾Ğ±ÑŠĞµĞºÑ‚ Ğ´Ğ»Ñ Ğ¿ĞµÑ€ĞµĞ´Ğ°Ñ‡Ğ¸ Ğ² ĞºĞ¾Ğ¼Ğ¿Ğ¾Ğ½ĞµĞ½Ñ‚
    return {
        // Ğ”Ğ°Ğ½Ğ½Ñ‹Ğµ Ğ¸ ÑĞ¾ÑÑ‚Ğ¾ÑĞ½Ğ¸Ğµ
        items,
        user,
        startDate,
        endDate,
        availabilityMap,
        unavailableIdsFromAPI,
        invalidItems: conflictingItemIds,
        isLoadingAvailability: isCheckingAvailability || priceCalculator.isCalculatingPrice,
        isSubmitting,
        isApplyingPromoCode: priceCalculator.isApplyingPromoCode,
        reservationSuccess,
        submitMessage: (error as Error)?.message,
        selectedAccessories,
        // Ğ¤Ğ¸Ğ½Ğ°Ğ½ÑĞ¾Ğ²Ñ‹Ğµ Ñ€Ğ°ÑÑ‡ĞµÑ‚Ñ‹ Ğ¸Ğ· Ñ†ĞµĞ½Ñ‚Ñ€Ğ°Ğ»Ğ¸Ğ·Ğ¾Ğ²Ğ°Ğ½Ğ½Ğ¾Ğ³Ğ¾ Ñ…ÑƒĞºĞ°
        priceDetails: priceCalculator.priceDetails,
        dayCount: priceCalculator.dayCount || dayCount,
        fullTotal: priceCalculator.fullTotal,
        totalDiscountPercentage: priceCalculator.totalDiscountPercentage,
        discountAmount: priceCalculator.discountAmount,
        finalTotal: priceCalculator.finalTotal,
        accessoriesDailyTotal,
        // ĞŸÑ€Ğ¾Ğ¼Ğ¾ĞºĞ¾Ğ´
        promoCode: promoCodeInput,
        promoCodeMessage: priceCalculator.promoCodeMessage,
        // Ğ¤ÑƒĞ½ĞºÑ†Ğ¸Ğ¸ Ğ¸ Ğ´ĞµĞ¹ÑÑ‚Ğ²Ğ¸Ñ
        setStartDate,
        setEndDate,
        clearReserveStore,
        removeItemFromStore,
        isAccessorySelected,
        toggleAccessory,
        setPromoCode: setPromoCodeInput,
        applyPromoCode,
        removePromoCode,
        handleSubmit,
    };
}


```


## <a name="rentalappmainsrchooksreservationusePriceCalculatorts"></a>`rental-app-main/src/hooks/reservation/usePriceCalculator.ts`

```typescript
// path: rental-app-main/src/hooks/reservation/usePriceCalculator.ts

// src/hooks/reservation/usePriceCalculator.ts

import { useQuery } from "@tanstack/react-query";
import { ReservationService, type PriceDetails } from "@/core/services";
import { formatDate } from "@/lib/utils";

interface UsePriceCalculatorInput {
    equipmentIds: number[];
    startDate: Date;
    endDate: Date;
    selectedAccessories: Record<number, number[]>;
    promoCode?: string;
    enabled?: boolean;
}

export { type PriceDetails };

/**
 * Ğ•Ğ´Ğ¸Ğ½Ñ‹Ğ¹ Ñ…ÑƒĞº Ğ´Ğ»Ñ Ñ€Ğ°ÑÑ‡ĞµÑ‚Ğ° ÑÑ‚Ğ¾Ğ¸Ğ¼Ğ¾ÑÑ‚Ğ¸ Ñ€ĞµĞ·ĞµÑ€Ğ²Ğ°.
 * Ğ¯Ğ²Ğ»ÑĞµÑ‚ÑÑ ĞµĞ´Ğ¸Ğ½ÑÑ‚Ğ²ĞµĞ½Ğ½Ñ‹Ğ¼ Ğ¸ÑÑ‚Ğ¾Ñ‡Ğ½Ğ¸ĞºĞ¾Ğ¼ Ğ¿Ñ€Ğ°Ğ²Ğ´Ñ‹ Ğ´Ğ»Ñ Ğ²ÑĞµÑ… Ñ„Ğ¸Ğ½Ğ°Ğ½ÑĞ¾Ğ²Ñ‹Ñ… Ñ€Ğ°ÑÑ‡ĞµÑ‚Ğ¾Ğ² Ğ² Ğ¿Ñ€Ğ¸Ğ»Ğ¾Ğ¶ĞµĞ½Ğ¸Ğ¸.
 */
export const usePriceCalculator = ({
    equipmentIds, 
    startDate, 
    endDate, 
    selectedAccessories, 
    promoCode, 
    enabled = true
}: UsePriceCalculatorInput) => {

    const queryKey = [
        "priceCalculation",
        [...equipmentIds].sort(),
        formatDate(startDate),
        formatDate(endDate),
        JSON.stringify(selectedAccessories),
        promoCode || ""
    ];

    const query = useQuery<PriceDetails>({
        queryKey: queryKey,
        queryFn: async () => {
            return ReservationService.calculatePrice({
                equipment_ids: equipmentIds,
                start_date: formatDate(startDate),
                end_date: formatDate(endDate),
                selected_accessories: selectedAccessories,
                promo_code: promoCode
            });
        },
        enabled: enabled && equipmentIds.length > 0 && !!startDate && !!endDate && startDate < endDate,
        staleTime: 5000,
    });

    // Ğ’Ğ¾Ğ·Ğ²Ñ€Ğ°Ñ‰Ğ°ĞµĞ¼ Ñ€Ğ°ÑÑˆĞ¸Ñ€ĞµĞ½Ğ½Ñ‹Ğ¹ Ğ¾Ğ±ÑŠĞµĞºÑ‚ Ñ Ğ´Ğ¾Ğ¿Ğ¾Ğ»Ğ½Ğ¸Ñ‚ĞµĞ»ÑŒĞ½Ñ‹Ğ¼Ğ¸ Ğ²Ñ‹Ñ‡Ğ¸ÑĞ»ÑĞµĞ¼Ñ‹Ğ¼Ğ¸ Ğ¿Ğ¾Ğ»ÑĞ¼Ğ¸
    return {
        ...query,
        // ĞÑĞ½Ğ¾Ğ²Ğ½Ñ‹Ğµ Ğ´Ğ°Ğ½Ğ½Ñ‹Ğµ Ğ¸Ğ· API
        priceDetails: query.data,
        
        // Ğ’Ñ‹Ñ‡Ğ¸ÑĞ»ÑĞµĞ¼Ñ‹Ğµ Ğ¿Ğ¾Ğ»Ñ Ğ´Ğ»Ñ ÑƒĞ´Ğ¾Ğ±ÑÑ‚Ğ²Ğ° Ğ¸ÑĞ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ
        dayCount: query.data?.day_count ?? 0,
        fullTotal: query.data?.full_total ?? 0,
        finalTotal: query.data?.final_total ?? 0,
        discountAmount: query.data?.discount_amount ?? 0,
        durationDiscountPercentage: query.data?.duration_discount_percentage ?? 0,
        promoDiscountPercentage: query.data?.promo_discount_percentage ?? 0,
        totalDiscountPercentage: (query.data?.duration_discount_percentage ?? 0) + (query.data?.promo_discount_percentage ?? 0),
        promoCodeMessage: query.data?.promo_code_message ?? "",
        
        // Ğ¡Ğ¾ÑÑ‚Ğ¾ÑĞ½Ğ¸Ñ Ğ·Ğ°Ğ³Ñ€ÑƒĞ·ĞºĞ¸
        isCalculatingPrice: query.isLoading,
        isFetchingPrice: query.isFetching,
        isApplyingPromoCode: query.isFetching && !!promoCode,
    };
};

```


## <a name="rentalappmainsrchooksreservationuseReservationActionsts"></a>`rental-app-main/src/hooks/reservation/useReservationActions.ts`

```typescript
// path: rental-app-main/src/hooks/reservation/useReservationActions.ts

// src/hooks/reservation/useReservationActions.ts

import { useState, useCallback, useMemo } from "react";
import { toast } from "sonner";
import { useReserveStore } from "@/store/reserveStore";
import { useEditReservation } from "../useEditReservation";
import { ReservationService } from "@/core/services";
import type { Reservation } from "@/types/reservation";
import { type EditState } from "./useReservationState";

export function useReservationActions({
                                          reservation,
                                          state,
                                          hasConflicts,
                                          appliedPromoCode,
                                          onFullCancellation,
                                          isAdminContext,
                                          onFinishEditing, // âœ¨ 1. ĞŸÑ€Ğ¸Ğ½Ğ¸Ğ¼Ğ°ĞµĞ¼ ĞºĞ¾Ğ»Ğ±ÑĞº
                                      }: {
    reservation: Reservation,
    state: EditState,
    hasConflicts: boolean,
    appliedPromoCode: string,
    onFullCancellation?: () => Promise<void> | void,
    isAdminContext: boolean,
    onFinishEditing: () => void; // âœ¨ 2. Ğ”Ğ¾Ğ±Ğ°Ğ²Ğ»ÑĞµĞ¼ ĞµĞ³Ğ¾ Ğ² Ñ‚Ğ¸Ğ¿
}) {
    const editApiMutation = useEditReservation();
    const { clear: clearReserveStore } = useReserveStore();

    const finalHasChanges = useMemo(() => {
        const promoCodeChanged = appliedPromoCode !== (reservation.promo_code || "");
        return state.hasChanges || promoCodeChanged;
    }, [state.hasChanges, appliedPromoCode, reservation.promo_code]);

    const saveChanges = useCallback(async (): Promise<boolean> => {
        if (!finalHasChanges) {
            toast.info("ĞĞµÑ‚ Ğ¸Ğ·Ğ¼ĞµĞ½ĞµĞ½Ğ¸Ğ¹ Ğ´Ğ»Ñ ÑĞ¾Ñ…Ñ€Ğ°Ğ½ĞµĞ½Ğ¸Ñ.");
            return false;
        }
        if (hasConflicts) {
            toast.error("ĞĞµĞ²Ğ¾Ğ·Ğ¼Ğ¾Ğ¶Ğ½Ğ¾ ÑĞ¾Ñ…Ñ€Ğ°Ğ½Ğ¸Ñ‚ÑŒ Ñ€ĞµĞ·ĞµÑ€Ğ² Ñ ĞºĞ¾Ğ½Ñ„Ğ»Ğ¸ĞºÑ‚Ğ°Ğ¼Ğ¸.");
            return false;
        }
        if (state.currentEquipmentDetails.length === 0) {
            toast.error("Ğ ĞµĞ·ĞµÑ€Ğ² Ğ´Ğ¾Ğ»Ğ¶ĞµĞ½ ÑĞ¾Ğ´ĞµÑ€Ğ¶Ğ°Ñ‚ÑŒ Ñ…Ğ¾Ñ‚Ñ Ğ±Ñ‹ Ğ¾Ğ´Ğ½Ñƒ Ğ¿Ğ¾Ğ·Ğ¸Ñ†Ğ¸Ñ.");
            return false;
        }

        try {
            await editApiMutation.mutateAsync({
                id: reservation.id,
                start_date: state.startDate.toISOString().split('T')[0],
                end_date: state.endDate.toISOString().split('T')[0],
                equipment_ids: state.currentEquipmentDetails.map(eq => eq.id),
                promo_code: appliedPromoCode || undefined,
                selected_accessories: state.localSelectedAccessories,
                isAdminContext,
            });
            toast.success("Ğ ĞµĞ·ĞµÑ€Ğ² ÑƒÑĞ¿ĞµÑˆĞ½Ğ¾ Ğ¾Ğ±Ğ½Ğ¾Ğ²Ğ»ĞµĞ½!");
            clearReserveStore();
            onFinishEditing(); // âœ¨ 3. Ğ’Ñ‹Ğ·Ñ‹Ğ²Ğ°ĞµĞ¼ ĞºĞ¾Ğ»Ğ±ÑĞº Ğ¿Ğ¾ÑĞ»Ğµ ÑƒÑĞ¿ĞµÑˆĞ½Ğ¾Ğ³Ğ¾ ÑĞ¾Ñ…Ñ€Ğ°Ğ½ĞµĞ½Ğ¸Ñ
            return true;
        } catch (error) {
            toast.error("ĞÑˆĞ¸Ğ±ĞºĞ° Ğ¿Ñ€Ğ¸ ÑĞ¾Ñ…Ñ€Ğ°Ğ½ĞµĞ½Ğ¸Ğ¸ Ğ¸Ğ·Ğ¼ĞµĞ½ĞµĞ½Ğ¸Ğ¹.");
            return false;
        }
    }, [
        reservation.id, state, finalHasChanges, hasConflicts,
        appliedPromoCode, editApiMutation, clearReserveStore, isAdminContext, onFinishEditing
    ]);

    const [isCancelling, setIsCancelling] = useState(false);

    const handleConfirmFullCancellation = useCallback(async () => {
        if (!onFullCancellation) return;
        setIsCancelling(true);
        try {
            await onFullCancellation();
        } catch (error) {
            toast.error("ĞĞµ ÑƒĞ´Ğ°Ğ»Ğ¾ÑÑŒ Ğ¾Ñ‚Ğ¼ĞµĞ½Ğ¸Ñ‚ÑŒ Ñ€ĞµĞ·ĞµÑ€Ğ².");
        } finally {
            setIsCancelling(false);
        }
    }, [onFullCancellation]);

    return {
        saveChanges,
        isSaving: editApiMutation.isPending,
        handleConfirmFullCancellation,
        isCancelling,
        finalHasChanges,
    };
}

```


## <a name="rentalappmainsrchooksreservationuseReservationDatats"></a>`rental-app-main/src/hooks/reservation/useReservationData.ts`

```typescript
// path: rental-app-main/src/hooks/reservation/useReservationData.ts

// src/hooks/reservation/useReservationData.ts

import { useState, useMemo, useEffect } from "react";
import { usePriceCalculator } from "./usePriceCalculator";
import { useAvailabilityCheck } from "@/hooks/useAvailabilityCheck";
import type { EditState } from "./useReservationState";
import type { Reservation } from "@/types/reservation";

const emptyFinancials = {
    dayCount: 0,
    fullTotal: 0,
    finalTotal: 0,
    discountAmount: 0,
    durationDiscountAmount: 0,
    durationDiscountPercentage: 0,
    promoDiscountAmount: 0,
    promoCodePercentage: 0,
    promoCodeMessage: "",
};

export function useReservationData(reservation: Reservation, state: EditState) {
    const [promoCode, setPromoCode] = useState(reservation.promo_code || "");
    const [appliedPromoCode, setAppliedPromoCode] = useState(reservation.promo_code || "");

    const { availabilityMap, hasConflicts, isLoading: isCheckingAvailability } = useAvailabilityCheck({
        equipmentIds: state.currentEquipmentDetails.map(eq => eq.id),
        startDate: state.startDate,
        endDate: state.endDate,
        // âœ¨ Ğ“Ğ›ĞĞ’ĞĞĞ• Ğ˜Ğ¡ĞŸĞ ĞĞ’Ğ›Ğ•ĞĞ˜Ğ•: ĞœÑ‹ Ğ²ÑĞµĞ³Ğ´Ğ° Ğ² Ñ€ĞµĞ¶Ğ¸Ğ¼Ğµ Ñ€ĞµĞ´Ğ°ĞºÑ‚Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ,
        // Ğ¿Ğ¾ÑÑ‚Ğ¾Ğ¼Ñƒ Ğ²ÑĞµĞ³Ğ´Ğ° Ğ¿ĞµÑ€ĞµĞ´Ğ°ĞµĞ¼ ID Ğ´Ğ»Ñ Ğ¸ÑĞºĞ»ÑÑ‡ĞµĞ½Ğ¸Ñ.
        excludeReservationId: reservation.id,
    });

    const priceCalculator = usePriceCalculator({
        equipmentIds: state.currentEquipmentDetails.map(i => i.id),
        startDate: state.startDate,
        endDate: state.endDate,
        selectedAccessories: state.localSelectedAccessories,
        promoCode: appliedPromoCode,
        enabled: true // Ğ¥ÑƒĞº Ğ°ĞºÑ‚Ğ¸Ğ²ĞµĞ½ Ğ²ÑĞµĞ³Ğ´Ğ°, ĞºĞ¾Ğ³Ğ´Ğ° Ğ¸ÑĞ¿Ğ¾Ğ»ÑŒĞ·ÑƒĞµÑ‚ÑÑ
    });

    const financials = useMemo(() => {
        if (!priceCalculator.priceDetails) {
            return { ...emptyFinancials, promoCode: promoCode };
        }
        const priceDetails = priceCalculator.priceDetails;
        const durationDiscountAmount = priceDetails.full_total * (priceDetails.duration_discount_percentage / 100);
        const promoDiscountAmount = priceDetails.full_total * (priceDetails.promo_discount_percentage / 100);
        return {
            dayCount: priceDetails.day_count,
            fullTotal: priceDetails.full_total,
            finalTotal: priceDetails.final_total,
            discountAmount: priceDetails.discount_amount,
            durationDiscountAmount,
            durationDiscountPercentage: priceDetails.duration_discount_percentage,
            promoDiscountAmount,
            promoCodePercentage: priceDetails.promo_discount_percentage,
            promoCodeMessage: priceDetails.promo_code_message ?? "",
            promoCode: promoCode,
        };
    }, [priceCalculator.priceDetails, promoCode]);

    const applyPromoCode = () => setAppliedPromoCode(promoCode);
    const removePromoCode = () => {
        setPromoCode("");
        setAppliedPromoCode("");
    };

    return {
        availabilityMap,
        hasConflicts,
        isCheckingAvailability,
        isCalculatingPrice: priceCalculator.isCalculatingPrice,
        financials,
        promoCode,
        setPromoCode,
        applyPromoCode,
        removePromoCode,
        appliedPromoCode,
        priceDetails: priceCalculator.priceDetails,
    };
}

```


## <a name="rentalappmainsrchooksreservationuseReservationEditStatets"></a>`rental-app-main/src/hooks/reservation/useReservationEditState.ts`

```typescript
// path: rental-app-main/src/hooks/reservation/useReservationEditState.ts

// src/hooks/reservation/useReservationEditState.ts
import { useState, useMemo, useCallback, useEffect } from "react";
import type { Reservation } from "@/types/reservation";
// âŒ Ğ£Ğ´Ğ°Ğ»ĞµĞ½ Ğ½ĞµĞ¸ÑĞ¿Ğ¾Ğ»ÑŒĞ·ÑƒĞµĞ¼Ñ‹Ğ¹ Ğ¸Ğ¼Ğ¿Ğ¾Ñ€Ñ‚ `Equipment`
// import type { Equipment } from "@/types/equipment";

// âœ… ĞĞ¿ĞµÑ‡Ğ°Ñ‚ĞºĞ° Ğ¸ÑĞ¿Ñ€Ğ°Ğ²Ğ»ĞµĞ½Ğ°: Ğ¿ĞµÑ€ĞµĞ¸ÑĞ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ -> Ğ¿ĞµÑ€ĞµĞ¸ÑĞ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ
// Ğ˜Ğ½Ñ‚ĞµÑ€Ñ„ĞµĞ¹ÑÑ‹ Ğ²Ñ‹Ğ½ĞµÑĞµĞ½Ñ‹ Ğ´Ğ»Ñ Ğ¿ĞµÑ€ĞµĞ¸ÑĞ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ
export interface EquipmentDisplayDetail {
    id: number;
    label: string;
}

export interface EditState {
    isEditing: boolean;
    startDate: Date;
    endDate: Date;
    originalEquipmentIds: ReadonlySet<number>;
    currentEquipmentDetails: EquipmentDisplayDetail[];
    newlyAddedEquipmentIds: ReadonlySet<number>;
    hasChanges: boolean;
}

/**
 * Ğ£Ğ¿Ñ€Ğ°Ğ²Ğ»ÑĞµÑ‚ Ğ¾ÑĞ½Ğ¾Ğ²Ğ½Ñ‹Ğ¼ ÑĞ¾ÑÑ‚Ğ¾ÑĞ½Ğ¸ĞµĞ¼ Ñ€ĞµĞ´Ğ°ĞºÑ‚Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ Ñ€ĞµĞ·ĞµÑ€Ğ²Ğ°.
 */
export function useReservationEditState(
    reservation: Reservation,
    initialEquipmentForDisplay: ReadonlyArray<EquipmentDisplayDetail>
) {
    const initialStartDate = useMemo(() => new Date(reservation.start_date), [reservation.start_date]);
    const initialEndDate = useMemo(() => new Date(reservation.end_date), [reservation.end_date]);
    const initialOriginalIds = useMemo(() => new Set(reservation.equipment_ids), [reservation.equipment_ids]);
    const initialCurrentDetails = useMemo(() => [...initialEquipmentForDisplay], [initialEquipmentForDisplay]);

    const [editState, setEditState] = useState<EditState>({
        isEditing: false,
        startDate: initialStartDate,
        endDate: initialEndDate,
        originalEquipmentIds: initialOriginalIds,
        currentEquipmentDetails: initialCurrentDetails,
        newlyAddedEquipmentIds: new Set<number>(),
        hasChanges: false
    });

    const calculateChanges = useCallback((
        currentState: EditState
    ): boolean => {
        const datesChanged =
            currentState.startDate.getTime() !== initialStartDate.getTime() ||
            currentState.endDate.getTime() !== initialEndDate.getTime();

        const currentIdSet = new Set(currentState.currentEquipmentDetails.map(eq => eq.id));
        const equipmentChanged =
            initialOriginalIds.size !== currentIdSet.size ||
            !Array.from(initialOriginalIds).every(id => currentIdSet.has(id));

        return datesChanged || equipmentChanged;
    }, [initialStartDate, initialEndDate, initialOriginalIds]);

    // Ğ¡Ğ±Ñ€Ğ¾Ñ ÑĞ¾ÑÑ‚Ğ¾ÑĞ½Ğ¸Ñ, ĞµÑĞ»Ğ¸ Ğ¿Ñ€Ğ¾Ğ¿ÑÑ‹ Ñ€ĞµĞ·ĞµÑ€Ğ²Ğ° Ğ¸Ğ·Ğ¼ĞµĞ½Ğ¸Ğ»Ğ¸ÑÑŒ Ğ¸Ğ·Ğ²Ğ½Ğµ
    useEffect(() => {
        if (!editState.isEditing) {
            setEditState({
                isEditing: false,
                startDate: initialStartDate,
                endDate: initialEndDate,
                originalEquipmentIds: initialOriginalIds,
                currentEquipmentDetails: initialCurrentDetails,
                newlyAddedEquipmentIds: new Set<number>(),
                hasChanges: false,
            });
        }
    }, [initialStartDate, initialEndDate, initialOriginalIds, initialCurrentDetails, editState.isEditing]);

    const resetToInitialState = useCallback(() => {
        setEditState({
            isEditing: false,
            startDate: initialStartDate,
            endDate: initialEndDate,
            originalEquipmentIds: initialOriginalIds,
            currentEquipmentDetails: initialCurrentDetails,
            newlyAddedEquipmentIds: new Set<number>(),
            hasChanges: false,
        });
    }, [initialStartDate, initialEndDate, initialOriginalIds, initialCurrentDetails]);

    return {
        editState,
        setEditState,
        calculateChanges,
        initialOriginalIds,
        initialStartDate,
        initialEndDate,
        resetToInitialState,
    };
}

```


## <a name="rentalappmainsrchooksreservationuseReservationStatets"></a>`rental-app-main/src/hooks/reservation/useReservationState.ts`

```typescript
// path: rental-app-main/src/hooks/reservation/useReservationState.ts

// src/hooks/reservation/useReservationState.ts

import { useState, useMemo, useCallback, useEffect } from "react";
import type { Reservation } from "@/types/reservation";
import type { Equipment } from "@/types/equipment";

export interface EquipmentDisplayDetail {
    id: number;
    label: string;
}

export interface EditState {
    // isEditing: boolean; // âœ¨ Ğ£Ğ”ĞĞ›Ğ•ĞĞ
    startDate: Date;
    endDate: Date;
    originalEquipmentIds: ReadonlySet<number>;
    currentEquipmentDetails: EquipmentDisplayDetail[];
    newlyAddedEquipmentIds: ReadonlySet<number>;
    localSelectedAccessories: Record<number, number[]>;
    hasChanges: boolean;
}

function createDisplayLabel(equipmentItem: Equipment): string {
    return `${equipmentItem.equipment_type} ${equipmentItem.brand} ${equipmentItem.name}`;
}

export function useReservationState(
    reservation: Reservation,
    initialEquipmentForDisplay: ReadonlyArray<EquipmentDisplayDetail>
) {
    const initialValues = useMemo(() => ({
        startDate: new Date(reservation.start_date),
        endDate: new Date(reservation.end_date),
        equipmentIds: new Set(reservation.equipment_ids),
        equipmentDetails: [...initialEquipmentForDisplay],
        accessories: reservation.selected_accessories || {},
    }), [reservation, initialEquipmentForDisplay]);

    const [state, setState] = useState<Omit<EditState, 'hasChanges'>>({ // âœ¨ hasChanges ÑƒĞ±Ñ€Ğ°Ğ½Ğ¾ Ğ¸Ğ· Ğ½Ğ°Ñ‡Ğ°Ğ»ÑŒĞ½Ğ¾Ğ³Ğ¾ ÑĞ¾ÑÑ‚Ğ¾ÑĞ½Ğ¸Ñ
        startDate: initialValues.startDate,
        endDate: initialValues.endDate,
        originalEquipmentIds: initialValues.equipmentIds,
        currentEquipmentDetails: initialValues.equipmentDetails,
        newlyAddedEquipmentIds: new Set<number>(),
        localSelectedAccessories: initialValues.accessories,
    });

    // âœ¨ Ğ’Ñ‹Ñ‡Ğ¸ÑĞ»ÑĞµĞ¼ hasChanges Ñ‡ĞµÑ€ĞµĞ· useMemo
    const hasChanges = useMemo(() => {
        const datesChanged =
            state.startDate.getTime() !== initialValues.startDate.getTime() ||
            state.endDate.getTime() !== initialValues.endDate.getTime();

        const currentIdSet = new Set(state.currentEquipmentDetails.map(eq => eq.id));
        const equipmentChanged =
            initialValues.equipmentIds.size !== currentIdSet.size ||
            !Array.from(initialValues.equipmentIds).every(id => currentIdSet.has(id));

        const accessoriesChanged =
            JSON.stringify(state.localSelectedAccessories) !== JSON.stringify(initialValues.accessories);

        return datesChanged || equipmentChanged || accessoriesChanged;
    }, [state, initialValues]);


    const [isCancelConfirmationVisible, setCancelConfirmationVisible] = useState(false);

    const updateDates = useCallback((newStartDate: Date, newEndDate: Date) => {
        setState(prev => ({ ...prev, startDate: newStartDate, endDate: newEndDate }));
    }, []);

    const addEquipmentItems = useCallback((itemsToAdd: Equipment[]) => {
        setState(prev => {
            const currentIds = new Set(prev.currentEquipmentDetails.map(d => d.id));
            const newDetails = itemsToAdd
                .filter(item => !currentIds.has(item.id))
                .map(item => ({ id: item.id, label: createDisplayLabel(item) }));

            if (newDetails.length === 0) return prev;

            const newNewlyAddedIds = new Set(prev.newlyAddedEquipmentIds);
            itemsToAdd.forEach(item => {
                if (!initialValues.equipmentIds.has(item.id)) {
                    newNewlyAddedIds.add(item.id);
                }
            });

            return {
                ...prev,
                currentEquipmentDetails: [...prev.currentEquipmentDetails, ...newDetails],
                newlyAddedEquipmentIds: newNewlyAddedIds,
            };
        });
    }, [initialValues.equipmentIds]);

    const removeEquipmentItem = useCallback((idToRemove: number) => {
        if (state.currentEquipmentDetails.length <= 1) {
            setCancelConfirmationVisible(true);
        } else {
            setState(prev => {
                const newDetails = prev.currentEquipmentDetails.filter(eq => eq.id !== idToRemove);
                const newNewlyAddedIds = new Set(prev.newlyAddedEquipmentIds);
                newNewlyAddedIds.delete(idToRemove);

                const newAccessories = { ...prev.localSelectedAccessories };
                delete newAccessories[idToRemove];

                return {
                    ...prev,
                    currentEquipmentDetails: newDetails,
                    newlyAddedEquipmentIds: newNewlyAddedIds,
                    localSelectedAccessories: newAccessories,
                };
            });
        }
    }, [state.currentEquipmentDetails.length]);

    const toggleAccessory = useCallback((equipmentId: number, accessoryId: number) => {
        setState(prev => {
            const newAccessoriesState = { ...prev.localSelectedAccessories };
            const currentSelection = newAccessoriesState[equipmentId] || [];
            const isSelected = currentSelection.includes(accessoryId);

            const newSelection = isSelected
                ? currentSelection.filter(id => id !== accessoryId)
                : [...currentSelection, accessoryId];

            if (newSelection.length > 0) {
                newAccessoriesState[equipmentId] = newSelection;
            } else {
                delete newAccessoriesState[equipmentId];
            }
            return { ...prev, localSelectedAccessories: newAccessoriesState };
        });
    }, []);

    return {
        // âœ¨ Ğ’Ğ¾Ğ·Ğ²Ñ€Ğ°Ñ‰Ğ°ĞµĞ¼ Ğ²Ñ‹Ñ‡Ğ¸ÑĞ»ĞµĞ½Ğ½Ğ¾Ğµ Ğ·Ğ½Ğ°Ñ‡ĞµĞ½Ğ¸Ğµ hasChanges
        state: { ...state, hasChanges },
        actions: {
            updateDates,
            addEquipmentItems,
            removeEquipmentItem,
            toggleAccessory,
        },
        dialogs: {
            isCancelConfirmationVisible,
            setCancelConfirmationVisible,
        },
    };
}

```


## <a name="rentalappmainsrchooksuseAdminAccessoriests"></a>`rental-app-main/src/hooks/useAdminAccessories.ts`

```typescript
// path: rental-app-main/src/hooks/useAdminAccessories.ts

// src/hooks/useAdminAccessories.ts

import { useQuery, useMutation, useQueryClient } from "@tanstack/react-query";
import { api } from "@/lib/api";
import { toast } from "sonner";
import type { Accessory, AccessoryListResponse } from "@/types/accessory";
import { AccessoryService } from "@/core/services";

// Ğ¢Ğ¸Ğ¿Ñ‹ Ğ´Ğ»Ñ ÑĞ¾Ğ·Ğ´Ğ°Ğ½Ğ¸Ñ Ğ¸ Ğ¾Ğ±Ğ½Ğ¾Ğ²Ğ»ĞµĞ½Ğ¸Ñ
type AccessoryPayload = {
    name: string;
    accessory_type?: string;
    price?: number;
    description?: string;
};

// +++ ĞĞĞ§ĞĞ›Ğ Ğ˜Ğ—ĞœĞ•ĞĞ•ĞĞ˜Ğ™ +++
// Ğ”Ğ¾Ğ±Ğ°Ğ²Ğ»ÑĞµĞ¼ Ğ·Ğ½Ğ°Ñ‡ĞµĞ½Ğ¸Ñ Ğ¿Ğ¾ ÑƒĞ¼Ğ¾Ğ»Ñ‡Ğ°Ğ½Ğ¸Ñ Ğ´Ğ»Ñ ÑÑ‚Ñ€Ğ°Ğ½Ğ¸Ñ†Ñ‹ Ğ¸ Ñ€Ğ°Ğ·Ğ¼ĞµÑ€Ğ° ÑÑ‚Ñ€Ğ°Ğ½Ğ¸Ñ†Ñ‹
export function useAccessories(page: number = 1, pageSize: number = 20) {
// +++ ĞšĞĞĞ•Ğ¦ Ğ˜Ğ—ĞœĞ•ĞĞ•ĞĞ˜Ğ™ +++
    const skip = (page - 1) * pageSize;

    return useQuery<AccessoryListResponse>({
        queryKey: ["accessories", page, pageSize],
        queryFn: async () => {
            return await AccessoryService.getAllAccessories(skip, pageSize);
        },
        staleTime: 5 * 60 * 1000, // 5 Ğ¼Ğ¸Ğ½ÑƒÑ‚
    });
}

// Ğ¡Ğ¾Ğ·Ğ´Ğ°Ğ½Ğ¸Ğµ Ğ½Ğ¾Ğ²Ğ¾Ğ³Ğ¾ Ğ°ĞºÑĞµÑÑÑƒĞ°Ñ€Ğ°
export function useCreateAccessory() {
    const queryClient = useQueryClient();
    return useMutation({
        mutationFn: (data: AccessoryPayload) => api.post<Accessory>("/accessories/", data),
        onSuccess: () => {
            void queryClient.invalidateQueries({ queryKey: ["accessories"] });
            toast.success("ĞĞºÑĞµÑÑÑƒĞ°Ñ€ ÑƒÑĞ¿ĞµÑˆĞ½Ğ¾ ÑĞ¾Ğ·Ğ´Ğ°Ğ½");
        },
        onError: (error: any) => {
            toast.error(error?.response?.data?.detail || "ĞÑˆĞ¸Ğ±ĞºĞ° Ğ¿Ñ€Ğ¸ ÑĞ¾Ğ·Ğ´Ğ°Ğ½Ğ¸Ğ¸ Ğ°ĞºÑĞµÑÑÑƒĞ°Ñ€Ğ°");
        },
    });
}

// ĞĞ±Ğ½Ğ¾Ğ²Ğ»ĞµĞ½Ğ¸Ğµ Ğ°ĞºÑĞµÑÑÑƒĞ°Ñ€Ğ°
export function useUpdateAccessory() {
    const queryClient = useQueryClient();
    return useMutation({
        mutationFn: ({ id, data }: { id: number, data: AccessoryPayload }) =>
            api.put<Accessory>(`/accessories/${id}`, data),
        onSuccess: () => {
            void queryClient.invalidateQueries({ queryKey: ["accessories"] });
            toast.success("ĞĞºÑĞµÑÑÑƒĞ°Ñ€ ÑƒÑĞ¿ĞµÑˆĞ½Ğ¾ Ğ¾Ğ±Ğ½Ğ¾Ğ²Ğ»ĞµĞ½");
        },
        onError: (error: any) => {
            toast.error(error?.response?.data?.detail || "ĞÑˆĞ¸Ğ±ĞºĞ° Ğ¿Ñ€Ğ¸ Ğ¾Ğ±Ğ½Ğ¾Ğ²Ğ»ĞµĞ½Ğ¸Ğ¸ Ğ°ĞºÑĞµÑÑÑƒĞ°Ñ€Ğ°");
        },
    });
}

// ĞŸĞ¾Ğ»ÑƒÑ‡ĞµĞ½Ğ¸Ğµ Ğ°ĞºÑĞµÑÑÑƒĞ°Ñ€Ğ° Ğ¿Ğ¾ ID
export function useAccessory(id: number | null) {
    return useQuery<Accessory>({
        queryKey: ["accessory", id],
        queryFn: async () => {
            if (!id) throw new Error("ID Ğ°ĞºÑĞµÑÑÑƒĞ°Ñ€Ğ° Ğ½Ğµ ÑƒĞºĞ°Ğ·Ğ°Ğ½");
            const response = await api.get<Accessory>(`/accessories/${id}`);
            return response.data;
        },
        enabled: !!id,
        staleTime: 5 * 60 * 1000, // 5 Ğ¼Ğ¸Ğ½ÑƒÑ‚
    });
}

// Ğ£Ğ´Ğ°Ğ»ĞµĞ½Ğ¸Ğµ Ğ°ĞºÑĞµÑÑÑƒĞ°Ñ€Ğ°
export function useDeleteAccessory() {
    const queryClient = useQueryClient();
    return useMutation({
        mutationFn: (id: number) => api.delete(`/accessories/${id}`),
        onSuccess: () => {
            void queryClient.invalidateQueries({ queryKey: ["accessories"] });
            toast.success("ĞĞºÑĞµÑÑÑƒĞ°Ñ€ ÑƒĞ´Ğ°Ğ»ĞµĞ½");
        },
        onError: (error: any) => {
            toast.error(error?.response?.data?.detail || "ĞÑˆĞ¸Ğ±ĞºĞ° Ğ¿Ñ€Ğ¸ ÑƒĞ´Ğ°Ğ»ĞµĞ½Ğ¸Ğ¸ Ğ°ĞºÑĞµÑÑÑƒĞ°Ñ€Ğ°");
        },
    });
}

```


## <a name="rentalappmainsrchooksuseAdminAssociationsts"></a>`rental-app-main/src/hooks/useAdminAssociations.ts`

```typescript
// path: rental-app-main/src/hooks/useAdminAssociations.ts

// src/hooks/useAdminAssociations.ts

import { useQuery, useMutation, useQueryClient } from "@tanstack/react-query";
import { api } from "@/lib/api";
import { toast } from "sonner";
// +++ ĞĞĞ§ĞĞ›Ğ Ğ˜Ğ—ĞœĞ•ĞĞ•ĞĞ˜Ğ™: Ğ˜Ğ¼Ğ¿Ğ¾Ñ€Ñ‚Ğ¸Ñ€ÑƒĞµĞ¼ Ñ‚Ğ¸Ğ¿ Ğ´Ğ»Ñ Ğ¾Ñ‚Ğ²ĞµÑ‚Ğ° Ñ Ğ¿Ğ°Ğ³Ğ¸Ğ½Ğ°Ñ†Ğ¸ĞµĞ¹ +++
import type { Association, AssociationCreate, AssociationUpdate, AssociationListResponse } from "@/types/association";
// +++ ĞšĞĞĞ•Ğ¦ Ğ˜Ğ—ĞœĞ•ĞĞ•ĞĞ˜Ğ™ +++

const ADMIN_ASSOCIATIONS_KEY = ["admin", "associations"];

// Ğ¥ÑƒĞº Ğ´Ğ»Ñ Ğ¿Ğ¾Ğ»ÑƒÑ‡ĞµĞ½Ğ¸Ñ Ğ´Ğ°Ğ½Ğ½Ñ‹Ñ… Ñ‚Ğ°ĞºĞ¾Ğ¹ Ğ¶Ğµ, ĞºĞ°Ğº Ğ¸ Ğ¿ÑƒĞ±Ğ»Ğ¸Ñ‡Ğ½Ñ‹Ğ¹, Ğ½Ğ¾ Ñ Ğ´Ñ€ÑƒĞ³Ğ¸Ğ¼ ĞºĞ»ÑÑ‡Ğ¾Ğ¼
export function useAdminAssociations() {
    // +++ ĞĞĞ§ĞĞ›Ğ Ğ˜Ğ—ĞœĞ•ĞĞ•ĞĞ˜Ğ™: Ğ˜ÑĞ¿Ñ€Ğ°Ğ²Ğ»ÑĞµĞ¼ Ñ…ÑƒĞº Ğ´Ğ»Ñ Ñ€Ğ°Ğ±Ğ¾Ñ‚Ñ‹ Ñ Ğ¾Ğ±ÑŠĞµĞºÑ‚Ğ¾Ğ¼ Ğ¾Ñ‚Ğ²ĞµÑ‚Ğ° +++
    return useQuery<AssociationListResponse, Error, Association[]>({
        queryKey: ADMIN_ASSOCIATIONS_KEY,
        queryFn: async () => {
            // 1. ĞĞ¶Ğ¸Ğ´Ğ°ĞµĞ¼ Ğ¾Ñ‚ API Ğ¾Ğ±ÑŠĞµĞºÑ‚ AssociationListResponse
            const response = await api.get<AssociationListResponse>("/associations/");
            return response.data; // Ğ’Ğ¾Ğ·Ğ²Ñ€Ğ°Ñ‰Ğ°ĞµĞ¼ Ğ²ĞµÑÑŒ Ğ¾Ğ±ÑŠĞµĞºÑ‚ { items: [...], total: ... }
        },
        // 2. Ğ¡ Ğ¿Ğ¾Ğ¼Ğ¾Ñ‰ÑŒÑ `select` Ğ¸Ğ·Ğ²Ğ»ĞµĞºĞ°ĞµĞ¼ Ğ¸ Ğ²Ğ¾Ğ·Ğ²Ñ€Ğ°Ñ‰Ğ°ĞµĞ¼ Ñ‚Ğ¾Ğ»ÑŒĞºĞ¾ Ğ¼Ğ°ÑÑĞ¸Ğ² `items`
        select: (data) => data.items,
    });
    // +++ ĞšĞĞĞ•Ğ¦ Ğ˜Ğ—ĞœĞ•ĞĞ•ĞĞ˜Ğ™ +++
}

export function useCreateAssociation() {
    const queryClient = useQueryClient();
    return useMutation({
        mutationFn: (data: AssociationCreate) => api.post<Association>("/associations/", data),
        onSuccess: () => {
            void queryClient.invalidateQueries({ queryKey: ADMIN_ASSOCIATIONS_KEY });
            toast.success("ĞÑÑĞ¾Ñ†Ğ¸Ğ°Ñ†Ğ¸Ñ ÑƒÑĞ¿ĞµÑˆĞ½Ğ¾ ÑĞ¾Ğ·Ğ´Ğ°Ğ½Ğ°");
        },
        onError: (e: any) => toast.error(e.response?.data?.detail || "ĞÑˆĞ¸Ğ±ĞºĞ° ÑĞ¾Ğ·Ğ´Ğ°Ğ½Ğ¸Ñ"),
    });
}

export function useUpdateAssociation() {
    const queryClient = useQueryClient();
    return useMutation({
        mutationFn: ({ id, data }: { id: number, data: AssociationUpdate }) =>
            api.put<Association>(`/associations/${id}`, data),
        onSuccess: () => {
            void queryClient.invalidateQueries({ queryKey: ADMIN_ASSOCIATIONS_KEY });
            toast.success("ĞÑÑĞ¾Ñ†Ğ¸Ğ°Ñ†Ğ¸Ñ ÑƒÑĞ¿ĞµÑˆĞ½Ğ¾ Ğ¾Ğ±Ğ½Ğ¾Ğ²Ğ»ĞµĞ½Ğ°");
        },
        onError: (e: any) => toast.error(e.response?.data?.detail || "ĞÑˆĞ¸Ğ±ĞºĞ° Ğ¾Ğ±Ğ½Ğ¾Ğ²Ğ»ĞµĞ½Ğ¸Ñ"),
    });
}

export function useDeleteAssociation() {
    const queryClient = useQueryClient();
    return useMutation({
        mutationFn: (id: number) => api.delete(`/associations/${id}`),
        onSuccess: () => {
            void queryClient.invalidateQueries({ queryKey: ADMIN_ASSOCIATIONS_KEY });
            toast.success("ĞÑÑĞ¾Ñ†Ğ¸Ğ°Ñ†Ğ¸Ñ ÑƒĞ´Ğ°Ğ»ĞµĞ½Ğ°");
        },
        onError: (e: any) => toast.error(e.response?.data?.detail || "ĞÑˆĞ¸Ğ±ĞºĞ° ÑƒĞ´Ğ°Ğ»ĞµĞ½Ğ¸Ñ"),
    });
}

```


## <a name="rentalappmainsrchooksuseAdminDiscountsts"></a>`rental-app-main/src/hooks/useAdminDiscounts.ts`

```typescript
// path: rental-app-main/src/hooks/useAdminDiscounts.ts

// src/hooks/useAdminDiscounts.ts

import { useQuery, useMutation, useQueryClient } from "@tanstack/react-query";
import { api } from "@/lib/api";
import { toast } from "sonner";
// +++ ĞĞĞ§ĞĞ›Ğ Ğ˜Ğ—ĞœĞ•ĞĞ•ĞĞ˜Ğ™: Ğ˜ÑĞ¿Ñ€Ğ°Ğ²Ğ»ÑĞµĞ¼ Ğ¸Ğ¼Ğ¿Ğ¾Ñ€Ñ‚ +++
import type { DurationDiscount, DiscountPayload, DiscountListResponse } from "@/types/discount";
// +++ ĞšĞĞĞ•Ğ¦ Ğ˜Ğ—ĞœĞ•ĞĞ•ĞĞ˜Ğ™ +++

const DURATION_DISCOUNTS_KEY = "durationDiscounts";

export const useDurationDiscounts = (page: number = 1, pageSize: number = 10) => {
    const skip = (page - 1) * pageSize;
    return useQuery<DiscountListResponse>({
        queryKey: [DURATION_DISCOUNTS_KEY, page, pageSize],
        queryFn: async () => {
            const response = await api.get<DiscountListResponse>("/discounts/", {
                params: { skip, limit: pageSize }
            });
            return response.data;
        },
    });
};

export const useCreateDurationDiscount = () => {
    const queryClient = useQueryClient();
    return useMutation({
        mutationFn: (data: DiscountPayload) => api.post("/discounts/", data),
        onSuccess: () => {
            toast.success("ĞĞ¾Ğ²Ñ‹Ğ¹ ÑƒÑ€Ğ¾Ğ²ĞµĞ½ÑŒ ÑĞºĞ¸Ğ´ĞºĞ¸ Ğ´Ğ¾Ğ±Ğ°Ğ²Ğ»ĞµĞ½");
            void queryClient.invalidateQueries({ queryKey: [DURATION_DISCOUNTS_KEY] });
        },
        onError: (e: any) => toast.error(e.response?.data?.detail || "ĞÑˆĞ¸Ğ±ĞºĞ° ÑĞ¾Ğ·Ğ´Ğ°Ğ½Ğ¸Ñ"),
    });
};

export const useUpdateDurationDiscount = () => {
    const queryClient = useQueryClient();
    return useMutation({
        mutationFn: ({ id, ...data }: DurationDiscount) => api.put(`/discounts/${id}`, data),
        onSuccess: () => {
            toast.success("Ğ¡ĞºĞ¸Ğ´ĞºĞ° Ğ¾Ğ±Ğ½Ğ¾Ğ²Ğ»ĞµĞ½Ğ°");
            void queryClient.invalidateQueries({ queryKey: [DURATION_DISCOUNTS_KEY] });
        },
        onError: (e: any) => toast.error(e.response?.data?.detail || "ĞÑˆĞ¸Ğ±ĞºĞ° Ğ¾Ğ±Ğ½Ğ¾Ğ²Ğ»ĞµĞ½Ğ¸Ñ"),
    });
};

export const useDeleteDurationDiscount = () => {
    const queryClient = useQueryClient();
    return useMutation({
        mutationFn: (id: number) => api.delete(`/discounts/${id}`),
        onSuccess: () => {
            toast.success("Ğ¡ĞºĞ¸Ğ´ĞºĞ° ÑƒĞ´Ğ°Ğ»ĞµĞ½Ğ°");
            void queryClient.invalidateQueries({ queryKey: [DURATION_DISCOUNTS_KEY] });
        },
        onError: (e: any) => toast.error(e.response?.data?.detail || "ĞÑˆĞ¸Ğ±ĞºĞ° ÑƒĞ´Ğ°Ğ»ĞµĞ½Ğ¸Ñ"),
    });
};

```


## <a name="rentalappmainsrchooksuseAdminEquipmentts"></a>`rental-app-main/src/hooks/useAdminEquipment.ts`

```typescript
// path: rental-app-main/src/hooks/useAdminEquipment.ts

//src/hooks/useAdminEquipment.ts


import { useMutation, useQueryClient } from "@tanstack/react-query";
import { api } from "@/lib/api";
import { toast } from "sonner";
import type { Equipment } from "@/types/equipment";

export interface EquipmentCreateData {
    equipment_type: string;
    brand: string;
    name: string;
    serial_number?: string;
    condition?: string;
    daily_rate?: number;
    notes?: string;
    description?: string;
    last_maintenance?: string; // format: YYYY-MM-DD
}

// Ğ¡Ğ¾Ğ·Ğ´Ğ°Ğ½Ğ¸Ğµ Ğ½Ğ¾Ğ²Ğ¾Ğ³Ğ¾ Ğ¾Ğ±Ğ¾Ñ€ÑƒĞ´Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ (Ğ´Ğ»Ñ Ğ¼ĞµĞ½ĞµĞ´Ğ¶ĞµÑ€Ğ¾Ğ² Ğ¸ Ğ°Ğ´Ğ¼Ğ¸Ğ½Ğ¾Ğ²)
export function useCreateEquipment() {
    const queryClient = useQueryClient();

    return useMutation({
        mutationFn: async (equipmentData: EquipmentCreateData) => {
            const response = await api.post<Equipment>("/equipment/", equipmentData);
            return response.data;
        },
        onSuccess: () => {
            queryClient.invalidateQueries({ queryKey: ["equipment"] });
            queryClient.invalidateQueries({ queryKey: ["availability"] });
            queryClient.invalidateQueries({ queryKey: ["calendar-grid"] });
            toast.success("ĞĞ±Ğ¾Ñ€ÑƒĞ´Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ ÑƒÑĞ¿ĞµÑˆĞ½Ğ¾ ÑĞ¾Ğ·Ğ´Ğ°Ğ½Ğ¾");
        },
        onError: (error: any) => {
            toast.error(error?.response?.data?.detail || "ĞÑˆĞ¸Ğ±ĞºĞ° Ğ¿Ñ€Ğ¸ ÑĞ¾Ğ·Ğ´Ğ°Ğ½Ğ¸Ğ¸ Ğ¾Ğ±Ğ¾Ñ€ÑƒĞ´Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ");
        },
    });
}

// Ğ£Ğ´Ğ°Ğ»ĞµĞ½Ğ¸Ğµ Ğ¾Ğ±Ğ¾Ñ€ÑƒĞ´Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ (Ğ´Ğ»Ñ Ğ¼ĞµĞ½ĞµĞ´Ğ¶ĞµÑ€Ğ¾Ğ² Ğ¸ Ğ°Ğ´Ğ¼Ğ¸Ğ½Ğ¾Ğ²)
export function useDeleteEquipment() {
    const queryClient = useQueryClient();

    return useMutation({
        mutationFn: async (equipmentId: number) => {
            const response = await api.delete(`/equipment/${equipmentId}`);
            return response.data;
        },
        onSuccess: () => {
            queryClient.invalidateQueries({ queryKey: ["equipment"] });
            queryClient.invalidateQueries({ queryKey: ["availability"] });
            queryClient.invalidateQueries({ queryKey: ["calendar-grid"] });
            toast.success("ĞĞ±Ğ¾Ñ€ÑƒĞ´Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ ÑƒĞ´Ğ°Ğ»ĞµĞ½Ğ¾");
        },
        onError: (error: any) => {
            toast.error(error?.response?.data?.detail || "ĞÑˆĞ¸Ğ±ĞºĞ° Ğ¿Ñ€Ğ¸ ÑƒĞ´Ğ°Ğ»ĞµĞ½Ğ¸Ğ¸ Ğ¾Ğ±Ğ¾Ñ€ÑƒĞ´Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ");
        },
    });
}

// ĞœĞ°ÑÑĞ¾Ğ²Ğ¾Ğµ ÑƒĞ´Ğ°Ğ»ĞµĞ½Ğ¸Ğµ Ğ¾Ğ±Ğ¾Ñ€ÑƒĞ´Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ
export function useBulkDeleteEquipment() {
    const queryClient = useQueryClient();

    return useMutation({
        mutationFn: async (equipmentIds: number[]) => {
            // Ğ’Ñ‹Ğ¿Ğ¾Ğ»Ğ½ÑĞµĞ¼ Ğ¿Ğ°Ñ€Ğ°Ğ»Ğ»ĞµĞ»ÑŒĞ½Ğ¾Ğµ ÑƒĞ´Ğ°Ğ»ĞµĞ½Ğ¸Ğµ
            const deletePromises = equipmentIds.map(id => 
                api.delete(`/equipment/${id}`)
            );
            await Promise.all(deletePromises);
            return { deleted_count: equipmentIds.length };
        },
        onSuccess: (data) => {
            queryClient.invalidateQueries({ queryKey: ["equipment"] });
            queryClient.invalidateQueries({ queryKey: ["availability"] });
            queryClient.invalidateQueries({ queryKey: ["calendar-grid"] });
            toast.success(`Ğ£Ğ´Ğ°Ğ»ĞµĞ½Ğ¾ ${data.deleted_count} ĞµĞ´Ğ¸Ğ½Ğ¸Ñ† Ğ¾Ğ±Ğ¾Ñ€ÑƒĞ´Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ`);
        },
        onError: (error: any) => {
            toast.error("ĞÑˆĞ¸Ğ±ĞºĞ° Ğ¿Ñ€Ğ¸ Ğ¼Ğ°ÑÑĞ¾Ğ²Ğ¾Ğ¼ ÑƒĞ´Ğ°Ğ»ĞµĞ½Ğ¸Ğ¸ Ğ¾Ğ±Ğ¾Ñ€ÑƒĞ´Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ");
        },
    });
}

// ĞœĞ°ÑÑĞ¾Ğ²Ğ¾Ğµ Ğ¾Ğ±Ğ½Ğ¾Ğ²Ğ»ĞµĞ½Ğ¸Ğµ Ñ‚Ğ°Ñ€Ğ¸Ñ„Ğ¾Ğ²
export function useBulkUpdateRates() {
    const queryClient = useQueryClient();

    return useMutation({
        mutationFn: async (updates: { id: number; daily_rate: number }[]) => {
            // Ğ’Ñ‹Ğ¿Ğ¾Ğ»Ğ½ÑĞµĞ¼ Ğ¿Ğ°Ñ€Ğ°Ğ»Ğ»ĞµĞ»ÑŒĞ½Ğ¾Ğµ Ğ¾Ğ±Ğ½Ğ¾Ğ²Ğ»ĞµĞ½Ğ¸Ğµ
            const updatePromises = updates.map(({ id, daily_rate }) => 
                api.put(`/equipment/${id}`, { daily_rate })
            );
            await Promise.all(updatePromises);
            return { updated_count: updates.length };
        },
        onSuccess: (data) => {
            queryClient.invalidateQueries({ queryKey: ["equipment"] });
            toast.success(`ĞĞ±Ğ½Ğ¾Ğ²Ğ»ĞµĞ½Ñ‹ Ñ‚Ğ°Ñ€Ğ¸Ñ„Ñ‹ Ğ´Ğ»Ñ ${data.updated_count} ĞµĞ´Ğ¸Ğ½Ğ¸Ñ† Ğ¾Ğ±Ğ¾Ñ€ÑƒĞ´Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ`);
        },
        onError: (error: any) => {
            toast.error("ĞÑˆĞ¸Ğ±ĞºĞ° Ğ¿Ñ€Ğ¸ Ğ¼Ğ°ÑÑĞ¾Ğ²Ğ¾Ğ¼ Ğ¾Ğ±Ğ½Ğ¾Ğ²Ğ»ĞµĞ½Ğ¸Ğ¸ Ñ‚Ğ°Ñ€Ğ¸Ñ„Ğ¾Ğ²");
        },
    });
}


```


## <a name="rentalappmainsrchooksuseAdminHolidayRulests"></a>`rental-app-main/src/hooks/useAdminHolidayRules.ts`

```typescript
// path: rental-app-main/src/hooks/useAdminHolidayRules.ts

// src/hooks/useAdminHolidayRules.ts

import { useQuery, useMutation, useQueryClient } from "@tanstack/react-query";
import { toast } from "sonner";
import { api } from "@/lib/api";

// Ğ¢Ğ¸Ğ¿Ñ‹, ÑĞ¾Ğ¾Ñ‚Ğ²ĞµÑ‚ÑÑ‚Ğ²ÑƒÑÑ‰Ğ¸Ğµ Pydantic-ÑÑ…ĞµĞ¼Ğ°Ğ¼ Ğ½Ğ° Ğ±ÑĞºĞµĞ½Ğ´Ğµ
interface HolidayRuleOut {
    id: number;
    rule_type: string;
    description: string;
    created_at: string;
}

interface RecurringHolidayRuleCreate {
    day_of_week: number;
    start_date: Date;
    end_date: Date;
    description: string;
}

// +++ ĞĞĞ§ĞĞ›Ğ Ğ˜Ğ—ĞœĞ•ĞĞ•ĞĞ˜Ğ™: Ğ”Ğ¾Ğ±Ğ°Ğ²Ğ»ÑĞµĞ¼ Ñ‚Ğ¸Ğ¿ Ğ´Ğ»Ñ Ğ¾Ñ‚Ğ²ĞµÑ‚Ğ° API +++
interface HolidayRuleListResponse {
    items: HolidayRuleOut[];
    total: number;
}
// +++ ĞšĞĞĞ•Ğ¦ Ğ˜Ğ—ĞœĞ•ĞĞ•ĞĞ˜Ğ™ +++


const HOLIDAY_RULES_KEY = ["holidayRules"];
const HOLIDAYS_QUERY_KEY = ["holidays"];

// 1. Ğ¥ÑƒĞº Ğ´Ğ»Ñ Ğ¿Ğ¾Ğ»ÑƒÑ‡ĞµĞ½Ğ¸Ñ ÑĞ¿Ğ¸ÑĞºĞ° Ğ¿Ñ€Ğ°Ğ²Ğ¸Ğ»
export function useGetHolidayRules() {
    // +++ ĞĞĞ§ĞĞ›Ğ Ğ˜Ğ—ĞœĞ•ĞĞ•ĞĞ˜Ğ™: Ğ˜ÑĞ¿Ñ€Ğ°Ğ²Ğ»ÑĞµĞ¼ Ñ…ÑƒĞº Ğ´Ğ»Ñ Ñ€Ğ°Ğ±Ğ¾Ñ‚Ñ‹ Ñ Ğ¾Ğ±ÑŠĞµĞºÑ‚Ğ¾Ğ¼ Ğ¾Ñ‚Ğ²ĞµÑ‚Ğ° +++
    return useQuery<HolidayRuleListResponse, Error, HolidayRuleOut[]>({
        queryKey: HOLIDAY_RULES_KEY,
        queryFn: async () => {
            // 1. ĞĞ¶Ğ¸Ğ´Ğ°ĞµĞ¼ Ğ¾Ñ‚ API Ğ¾Ğ±ÑŠĞµĞºÑ‚ HolidayRuleListResponse
            const response = await api.get<HolidayRuleListResponse>("/holidays/rules");
            return response.data;
        },
        // 2. Ğ¡ Ğ¿Ğ¾Ğ¼Ğ¾Ñ‰ÑŒÑ `select` Ğ¸Ğ·Ğ²Ğ»ĞµĞºĞ°ĞµĞ¼ Ğ¸ Ğ²Ğ¾Ğ·Ğ²Ñ€Ğ°Ñ‰Ğ°ĞµĞ¼ Ñ‚Ğ¾Ğ»ÑŒĞºĞ¾ Ğ¼Ğ°ÑÑĞ¸Ğ² `items`
        select: (data) => data.items,
    });
    // +++ ĞšĞĞĞ•Ğ¦ Ğ˜Ğ—ĞœĞ•ĞĞ•ĞĞ˜Ğ™ +++
}

// 2. Ğ¥ÑƒĞº Ğ´Ğ»Ñ ÑĞ¾Ğ·Ğ´Ğ°Ğ½Ğ¸Ñ Ğ¿Ñ€Ğ°Ğ²Ğ¸Ğ»Ğ° ĞµĞ¶ĞµĞ½ĞµĞ´ĞµĞ»ÑŒĞ½Ñ‹Ñ… Ğ²Ñ‹Ñ…Ğ¾Ğ´Ğ½Ñ‹Ñ…
export function useCreateWeeklyRule() {
    const queryClient = useQueryClient();
    return useMutation({
        mutationFn: (data: RecurringHolidayRuleCreate) => api.post("/holidays/recurring/weekly", data),
        onSuccess: () => {
            toast.success("ĞŸÑ€Ğ°Ğ²Ğ¸Ğ»Ğ¾ Ğ´Ğ»Ñ ĞµĞ¶ĞµĞ½ĞµĞ´ĞµĞ»ÑŒĞ½Ñ‹Ñ… Ğ²Ñ‹Ñ…Ğ¾Ğ´Ğ½Ñ‹Ñ… ÑƒÑĞ¿ĞµÑˆĞ½Ğ¾ ÑĞ¾Ğ·Ğ´Ğ°Ğ½Ğ¾!");
            void queryClient.invalidateQueries({ queryKey: HOLIDAY_RULES_KEY });
            void queryClient.invalidateQueries({ queryKey: HOLIDAYS_QUERY_KEY });
        },
        onError: (error: any) => {
            toast.error(error.response?.data?.detail || "ĞÑˆĞ¸Ğ±ĞºĞ° Ğ¿Ñ€Ğ¸ ÑĞ¾Ğ·Ğ´Ğ°Ğ½Ğ¸Ğ¸ Ğ¿Ñ€Ğ°Ğ²Ğ¸Ğ»Ğ°");
        },
    });
}

// 3. Ğ¥ÑƒĞº Ğ´Ğ»Ñ Ğ¸Ğ¼Ğ¿Ğ¾Ñ€Ñ‚Ğ° Ğ³Ğ¾ÑÑƒĞ´Ğ°Ñ€ÑÑ‚Ğ²ĞµĞ½Ğ½Ñ‹Ñ… Ğ¿Ñ€Ğ°Ğ·Ğ´Ğ½Ğ¸ĞºĞ¾Ğ²
export function useImportPublicHolidays() {
    const queryClient = useQueryClient();
    return useMutation({
        mutationFn: ({ country_code, year }: { country_code: string; year: number }) =>
            api.post(`/holidays/import/public?country_code=${country_code}&year=${year}`),
        onSuccess: () => {
            toast.success("Ğ“Ğ¾ÑÑƒĞ´Ğ°Ñ€ÑÑ‚Ğ²ĞµĞ½Ğ½Ñ‹Ğµ Ğ¿Ñ€Ğ°Ğ·Ğ´Ğ½Ğ¸ĞºĞ¸ ÑƒÑĞ¿ĞµÑˆĞ½Ğ¾ Ğ¸Ğ¼Ğ¿Ğ¾Ñ€Ñ‚Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ñ‹!");
            void queryClient.invalidateQueries({ queryKey: HOLIDAY_RULES_KEY });
            void queryClient.invalidateQueries({ queryKey: HOLIDAYS_QUERY_KEY });
        },
        onError: (error: any) => {
            toast.error(error.response?.data?.detail || "ĞÑˆĞ¸Ğ±ĞºĞ° Ğ¿Ñ€Ğ¸ Ğ¸Ğ¼Ğ¿Ğ¾Ñ€Ñ‚Ğµ Ğ¿Ñ€Ğ°Ğ·Ğ´Ğ½Ğ¸ĞºĞ¾Ğ²");
        },
    });
}


// 4. Ğ¥ÑƒĞº Ğ´Ğ»Ñ ÑƒĞ´Ğ°Ğ»ĞµĞ½Ğ¸Ñ Ğ¿Ñ€Ğ°Ğ²Ğ¸Ğ»Ğ°
export function useDeleteHolidayRule() {
    const queryClient = useQueryClient();
    return useMutation({
        mutationFn: (ruleId: number) => api.delete(`/holidays/rules/${ruleId}`),
        onSuccess: () => {
            toast.success("ĞŸÑ€Ğ°Ğ²Ğ¸Ğ»Ğ¾ Ğ¸ ÑĞ²ÑĞ·Ğ°Ğ½Ğ½Ñ‹Ğµ Ñ Ğ½Ğ¸Ğ¼ Ğ²Ñ‹Ñ…Ğ¾Ğ´Ğ½Ñ‹Ğµ ÑƒĞ´Ğ°Ğ»ĞµĞ½Ñ‹.");
            void queryClient.invalidateQueries({ queryKey: HOLIDAY_RULES_KEY });
            void queryClient.invalidateQueries({ queryKey: HOLIDAYS_QUERY_KEY });
        },
        onError: (error: any) => {
            toast.error(error.response?.data?.detail || "ĞÑˆĞ¸Ğ±ĞºĞ° Ğ¿Ñ€Ğ¸ ÑƒĞ´Ğ°Ğ»ĞµĞ½Ğ¸Ğ¸ Ğ¿Ñ€Ğ°Ğ²Ğ¸Ğ»Ğ°");
        },
    });
}

```


## <a name="rentalappmainsrchooksuseAdminHolidaysts"></a>`rental-app-main/src/hooks/useAdminHolidays.ts`

```typescript
// path: rental-app-main/src/hooks/useAdminHolidays.ts

// src/hooks/useAdminHolidays.ts

import { useQuery, useMutation, useQueryClient } from "@tanstack/react-query";
import { toast } from "sonner";
import { api } from "@/lib/api";
import { formatDate } from "@/lib/utils";
import type { AxiosError } from "axios";
// +++ ĞĞĞ§ĞĞ›Ğ Ğ˜Ğ—ĞœĞ•ĞĞ•ĞĞ˜Ğ™: Ğ˜Ğ¼Ğ¿Ğ¾Ñ€Ñ‚Ğ¸Ñ€ÑƒĞµĞ¼ Ğ½ÑƒĞ¶Ğ½Ñ‹Ğµ Ñ‚Ğ¸Ğ¿Ñ‹ +++
import type { Holiday, HolidayListResponse } from "@/types/holiday";
// +++ ĞšĞĞĞ•Ğ¦ Ğ˜Ğ—ĞœĞ•ĞĞ•ĞĞ˜Ğ™ +++


// ĞĞ¾Ğ²Ñ‹Ğ¹ Ñ‚Ğ¸Ğ¿ Ğ´Ğ»Ñ Ğ²Ğ½ÑƒÑ‚Ñ€ĞµĞ½Ğ½ĞµĞ³Ğ¾ Ğ¸ÑĞ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ, Ğ³Ğ´Ğµ date ÑĞ²Ğ»ÑĞµÑ‚ÑÑ Ğ¾Ğ±ÑŠĞµĞºÑ‚Ğ¾Ğ¼ Date
export interface HolidayWithDate extends Omit<Holiday, 'date'> {
    date: Date;
}

export interface HolidayCreatePayload {
    date: string; // YYYY-MM-DD
    description?: string;
    force?: boolean; // Ğ¤Ğ»Ğ°Ğ³ Ğ´Ğ»Ñ Ğ¿Ğ¾Ğ´Ñ‚Ğ²ĞµÑ€Ğ¶Ğ´ĞµĞ½Ğ¸Ñ ÑĞ¾Ğ·Ğ´Ğ°Ğ½Ğ¸Ñ Ğ¿Ñ€Ğ¸ ĞºĞ¾Ğ½Ñ„Ğ»Ğ¸ĞºÑ‚Ğ°Ñ…
}

// Ğ¢Ğ¸Ğ¿ Ğ´Ğ»Ñ Ğ¾ÑˆĞ¸Ğ±ĞºĞ¸ ĞºĞ¾Ğ½Ñ„Ğ»Ğ¸ĞºÑ‚Ğ° Ğ¾Ñ‚ API
interface ConflictErrorData {
    detail: {
        message: string;
        conflicting_reservation_ids: number[];
    };
}

const HOLIDAYS_QUERY_KEY = "holidays";

/**
 * Ğ¥ÑƒĞº Ğ´Ğ»Ñ Ğ¿Ğ¾Ğ»ÑƒÑ‡ĞµĞ½Ğ¸Ñ ÑĞ¿Ğ¸ÑĞºĞ° Ğ²Ñ‹Ñ…Ğ¾Ğ´Ğ½Ñ‹Ñ… Ğ² Ğ·Ğ°Ğ´Ğ°Ğ½Ğ½Ğ¾Ğ¼ Ğ´Ğ¸Ğ°Ğ¿Ğ°Ğ·Ğ¾Ğ½Ğµ Ğ´Ğ°Ñ‚.
 */
export function useHolidays(startDate: Date, endDate: Date) {
    const formattedStart = formatDate(startDate);
    const formattedEnd = formatDate(endDate);

    // +++ ĞĞĞ§ĞĞ›Ğ Ğ˜Ğ—ĞœĞ•ĞĞ•ĞĞ˜Ğ™: ĞŸĞ¾Ğ»Ğ½Ğ¾ÑÑ‚ÑŒÑ Ğ¸ÑĞ¿Ñ€Ğ°Ğ²Ğ»ĞµĞ½Ğ½Ñ‹Ğ¹ Ñ…ÑƒĞº +++
    return useQuery<HolidayListResponse, Error, HolidayWithDate[]>({
        queryKey: [HOLIDAYS_QUERY_KEY, formattedStart, formattedEnd],
        queryFn: async () => {
            const response = await api.get<HolidayListResponse>("/holidays/", {
                params: {
                    start_date: formattedStart,
                    end_date: formattedEnd,
                    // 1. Ğ”Ğ¾Ğ±Ğ°Ğ²Ğ»ÑĞµĞ¼ Ğ½ĞµĞ´Ğ¾ÑÑ‚Ğ°ÑÑ‰Ğ¸Ğ¹ Ğ¿Ğ°Ñ€Ğ°Ğ¼ĞµÑ‚Ñ€ limit
                    limit: 100,
                },
            });
            return response.data; // Ğ’Ğ¾Ğ·Ğ²Ñ€Ğ°Ñ‰Ğ°ĞµĞ¼ Ğ²ĞµÑÑŒ Ğ¾Ğ±ÑŠĞµĞºÑ‚ { items: [...], total: ... }
        },
        // 2. Ğ¡ Ğ¿Ğ¾Ğ¼Ğ¾Ñ‰ÑŒÑ `select` Ğ¸Ğ·Ğ²Ğ»ĞµĞºĞ°ĞµĞ¼ Ğ¼Ğ°ÑÑĞ¸Ğ² items Ğ¸ Ğ¿Ñ€ĞµĞ¾Ğ±Ñ€Ğ°Ğ·ÑƒĞµĞ¼ Ğ´Ğ°Ñ‚Ñ‹
        select: (data) => {
            return data.items.map(h => ({ ...h, date: new Date(h.date) }));
        },
        enabled: !!startDate && !!endDate,
    });
    // +++ ĞšĞĞĞ•Ğ¦ Ğ˜Ğ—ĞœĞ•ĞĞ•ĞĞ˜Ğ™ +++
}

/**
 * Ğ¥ÑƒĞº Ğ´Ğ»Ñ ÑĞ¾Ğ·Ğ´Ğ°Ğ½Ğ¸Ñ Ğ½Ğ¾Ğ²Ğ¾Ğ³Ğ¾ Ğ²Ñ‹Ñ…Ğ¾Ğ´Ğ½Ğ¾Ğ³Ğ¾ Ğ´Ğ½Ñ.
 * ĞĞ±Ñ€Ğ°Ğ±Ğ°Ñ‚Ñ‹Ğ²Ğ°ĞµÑ‚ ÑĞ¿ĞµÑ†Ğ¸Ñ„Ğ¸Ñ‡ĞµÑĞºÑƒÑ Ğ¾ÑˆĞ¸Ğ±ĞºÑƒ ĞºĞ¾Ğ½Ñ„Ğ»Ğ¸ĞºÑ‚Ğ° (409).
 */
export function useCreateHoliday() {
    const queryClient = useQueryClient();
    return useMutation<unknown, AxiosError<ConflictErrorData>, HolidayCreatePayload>({
        mutationFn: (data) => api.post("/holidays/", data),
        onSuccess: () => {
            toast.success("Ğ’Ñ‹Ñ…Ğ¾Ğ´Ğ½Ğ¾Ğ¹ Ğ´ĞµĞ½ÑŒ ÑƒÑĞ¿ĞµÑˆĞ½Ğ¾ Ğ´Ğ¾Ğ±Ğ°Ğ²Ğ»ĞµĞ½");
            void queryClient.invalidateQueries({ queryKey: [HOLIDAYS_QUERY_KEY] });
        },
        onError: (error) => {
            if (error.response?.status === 409) {
                // ĞÑˆĞ¸Ğ±ĞºĞ° ĞºĞ¾Ğ½Ñ„Ğ»Ğ¸ĞºÑ‚Ğ° Ğ±ÑƒĞ´ĞµÑ‚ Ğ¾Ğ±Ñ€Ğ°Ğ±Ğ¾Ñ‚Ğ°Ğ½Ğ° Ğ² ĞºĞ¾Ğ¼Ğ¿Ğ¾Ğ½ĞµĞ½Ñ‚Ğµ
                return;
            }
            toast.error(error.response?.data?.detail?.message || "ĞÑˆĞ¸Ğ±ĞºĞ° Ğ¿Ñ€Ğ¸ ÑĞ¾Ğ·Ğ´Ğ°Ğ½Ğ¸Ğ¸ Ğ²Ñ‹Ñ…Ğ¾Ğ´Ğ½Ğ¾Ğ³Ğ¾ Ğ´Ğ½Ñ");
        },
    });
}

/**
 * Ğ¥ÑƒĞº Ğ´Ğ»Ñ ÑƒĞ´Ğ°Ğ»ĞµĞ½Ğ¸Ñ Ğ²Ñ‹Ñ…Ğ¾Ğ´Ğ½Ğ¾Ğ³Ğ¾ Ğ´Ğ½Ñ.
 */
export function useDeleteHoliday() {
    const queryClient = useQueryClient();
    return useMutation({
        mutationFn: (date: Date) => api.delete(`/holidays/${formatDate(date)}`),
        onSuccess: () => {
            toast.success("Ğ’Ñ‹Ñ…Ğ¾Ğ´Ğ½Ğ¾Ğ¹ Ğ´ĞµĞ½ÑŒ ÑƒĞ´Ğ°Ğ»ĞµĞ½");
            void queryClient.invalidateQueries({ queryKey: [HOLIDAYS_QUERY_KEY] });
        },
        onError: (error: any) => {
            toast.error(error.response?.data?.detail || "ĞÑˆĞ¸Ğ±ĞºĞ° Ğ¿Ñ€Ğ¸ ÑƒĞ´Ğ°Ğ»ĞµĞ½Ğ¸Ğ¸ Ğ²Ñ‹Ñ…Ğ¾Ğ´Ğ½Ğ¾Ğ³Ğ¾ Ğ´Ğ½Ñ");
        },
    });
}

```


## <a name="rentalappmainsrchooksuseAdminPromoCodests"></a>`rental-app-main/src/hooks/useAdminPromoCodes.ts`

```typescript
// path: rental-app-main/src/hooks/useAdminPromoCodes.ts

// src/hooks/useAdminPromoCodes.ts

import { useQuery, useMutation, useQueryClient } from "@tanstack/react-query";
import { api } from "@/lib/api";
import { toast } from "sonner";
// +++ ĞĞĞ§ĞĞ›Ğ Ğ˜Ğ—ĞœĞ•ĞĞ•ĞĞ˜Ğ™: Ğ˜Ğ¼Ğ¿Ğ¾Ñ€Ñ‚Ğ¸Ñ€ÑƒĞµĞ¼ Ğ½Ğ¾Ğ²Ñ‹Ğ¹ Ñ‚Ğ¸Ğ¿ +++
import type {
    PromoCodeOut,
    PromoCodeCreate,
    PromoCodeUpdate,
    PromoCodeListResponse
} from "@/types/promo_code";
// +++ ĞšĞĞĞ•Ğ¦ Ğ˜Ğ—ĞœĞ•ĞĞ•ĞĞ˜Ğ™ +++

const PROMO_CODES_QUERY_KEY = ["admin", "promocodes"];

/**
 * Ğ¥ÑƒĞº Ğ´Ğ»Ñ Ğ¿Ğ¾Ğ»ÑƒÑ‡ĞµĞ½Ğ¸Ñ ÑĞ¿Ğ¸ÑĞºĞ° Ğ²ÑĞµÑ… Ğ¿Ñ€Ğ¾Ğ¼Ğ¾ĞºĞ¾Ğ´Ğ¾Ğ².
 */
export function useAdminPromoCodes() {
    // +++ ĞĞĞ§ĞĞ›Ğ Ğ˜Ğ—ĞœĞ•ĞĞ•ĞĞ˜Ğ™: ĞŸĞ¾Ğ»Ğ½Ğ¾ÑÑ‚ÑŒÑ Ğ¸ÑĞ¿Ñ€Ğ°Ğ²Ğ»ĞµĞ½Ğ½Ñ‹Ğ¹ Ñ…ÑƒĞº +++
    return useQuery<PromoCodeListResponse, Error, PromoCodeOut[]>({
        queryKey: PROMO_CODES_QUERY_KEY,
        queryFn: async () => {
            // 1. Ğ£ĞºĞ°Ğ·Ñ‹Ğ²Ğ°ĞµĞ¼, Ñ‡Ñ‚Ğ¾ API Ğ²ĞµÑ€Ğ½ĞµÑ‚ Ğ¾Ğ±ÑŠĞµĞºÑ‚ PromoCodeListResponse
            const response = await api.get<PromoCodeListResponse>("/promocodes/");
            // 2. Ğ’Ğ¾Ğ·Ğ²Ñ€Ğ°Ñ‰Ğ°ĞµĞ¼ Ğ²ĞµÑÑŒ Ğ¾Ğ±ÑŠĞµĞºÑ‚ { items: [...], total: ... }
            return response.data;
        },
        // 3. Ğ¡ Ğ¿Ğ¾Ğ¼Ğ¾Ñ‰ÑŒÑ Ğ¾Ğ¿Ñ†Ğ¸Ğ¸ `select` Ğ¸Ğ·Ğ²Ğ»ĞµĞºĞ°ĞµĞ¼ Ñ‚Ğ¾Ğ»ÑŒĞºĞ¾ Ğ¼Ğ°ÑÑĞ¸Ğ² `items`.
        //    ĞšĞ¾Ğ¼Ğ¿Ğ¾Ğ½ĞµĞ½Ñ‚, Ğ¸ÑĞ¿Ğ¾Ğ»ÑŒĞ·ÑƒÑÑ‰Ğ¸Ğ¹ Ñ…ÑƒĞº, Ğ¿Ğ¾Ğ»ÑƒÑ‡Ğ¸Ñ‚ ÑƒĞ¶Ğµ Ğ³Ğ¾Ñ‚Ğ¾Ğ²Ñ‹Ğ¹ Ğ¼Ğ°ÑÑĞ¸Ğ².
        select: (data) => data.items,
        staleTime: 5 * 60 * 1000, // 5 Ğ¼Ğ¸Ğ½ÑƒÑ‚
    });
    // +++ ĞšĞĞĞ•Ğ¦ Ğ˜Ğ—ĞœĞ•ĞĞ•ĞĞ˜Ğ™ +++
}

/**
 * Ğ—Ğ°Ğ¿Ñ€Ğ°ÑˆĞ¸Ğ²Ğ°ĞµÑ‚ Ğ½Ğ¾Ğ²Ñ‹Ğ¹ ÑĞ³ĞµĞ½ĞµÑ€Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ½Ñ‹Ğ¹ ĞºĞ¾Ğ´ Ñ Ğ±ÑĞºĞµĞ½Ğ´Ğ°.
 */
export async function fetchGeneratedPromoCode(): Promise<string> {
    try {
        const response = await api.get<{ generated_code: string }>("/promocodes/generate/new-code");
        return response.data.generated_code;
    } catch (error) {
        toast.error("ĞÑˆĞ¸Ğ±ĞºĞ° Ğ¿Ñ€Ğ¸ Ğ³ĞµĞ½ĞµÑ€Ğ°Ñ†Ğ¸Ğ¸ ĞºĞ¾Ğ´Ğ°");
        console.error("Failed to generate promo code:", error);
        return "";
    }
}

/**
 * Ğ¥ÑƒĞº Ğ´Ğ»Ñ ÑĞ¾Ğ·Ğ´Ğ°Ğ½Ğ¸Ñ Ğ½Ğ¾Ğ²Ğ¾Ğ³Ğ¾ Ğ¿Ñ€Ğ¾Ğ¼Ğ¾ĞºĞ¾Ğ´Ğ°.
 */
export function useCreatePromoCode() {
    const queryClient = useQueryClient();
    return useMutation({
        mutationFn: async (data: PromoCodeCreate) => {
            const response = await api.post<PromoCodeOut>("/promocodes/", data);
            return response.data;
        },
        onSuccess: () => {
            void queryClient.invalidateQueries({ queryKey: PROMO_CODES_QUERY_KEY });
            toast.success("ĞŸÑ€Ğ¾Ğ¼Ğ¾ĞºĞ¾Ğ´ ÑƒÑĞ¿ĞµÑˆĞ½Ğ¾ ÑĞ¾Ğ·Ğ´Ğ°Ğ½");
        },
        onError: (error: any) => {
            toast.error(error?.response?.data?.detail || "ĞÑˆĞ¸Ğ±ĞºĞ° Ğ¿Ñ€Ğ¸ ÑĞ¾Ğ·Ğ´Ğ°Ğ½Ğ¸Ğ¸ Ğ¿Ñ€Ğ¾Ğ¼Ğ¾ĞºĞ¾Ğ´Ğ°");
        },
    });
}

/**
 * Ğ¥ÑƒĞº Ğ´Ğ»Ñ Ğ¾Ğ±Ğ½Ğ¾Ğ²Ğ»ĞµĞ½Ğ¸Ñ Ğ¿Ñ€Ğ¾Ğ¼Ğ¾ĞºĞ¾Ğ´Ğ°.
 */
export function useUpdatePromoCode() {
    const queryClient = useQueryClient();
    return useMutation({
        mutationFn: async ({ id, data }: { id: number; data: PromoCodeUpdate }) => {
            const response = await api.put<PromoCodeOut>(`/promocodes/${id}`, data);
            return response.data;
        },
        onSuccess: (updatedPromoCode) => {
            void queryClient.invalidateQueries({ queryKey: PROMO_CODES_QUERY_KEY });
            toast.success(`ĞŸÑ€Ğ¾Ğ¼Ğ¾ĞºĞ¾Ğ´ "${updatedPromoCode.code}" ÑƒÑĞ¿ĞµÑˆĞ½Ğ¾ Ğ¾Ğ±Ğ½Ğ¾Ğ²Ğ»ĞµĞ½`);
        },
        onError: (error: any) => {
            toast.error(error?.response?.data?.detail || "ĞÑˆĞ¸Ğ±ĞºĞ° Ğ¿Ñ€Ğ¸ Ğ¾Ğ±Ğ½Ğ¾Ğ²Ğ»ĞµĞ½Ğ¸Ğ¸ Ğ¿Ñ€Ğ¾Ğ¼Ğ¾ĞºĞ¾Ğ´Ğ°");
        },
    });
}

/**
 * Ğ¥ÑƒĞº Ğ´Ğ»Ñ ÑƒĞ´Ğ°Ğ»ĞµĞ½Ğ¸Ñ Ğ¿Ñ€Ğ¾Ğ¼Ğ¾ĞºĞ¾Ğ´Ğ°.
 */
export function useDeletePromoCode() {
    const queryClient = useQueryClient();
    return useMutation({
        mutationFn: (id: number) => api.delete(`/promocodes/${id}`),
        onSuccess: () => {
            void queryClient.invalidateQueries({ queryKey: PROMO_CODES_QUERY_KEY });
            toast.success("ĞŸÑ€Ğ¾Ğ¼Ğ¾ĞºĞ¾Ğ´ ÑƒĞ´Ğ°Ğ»ĞµĞ½");
        },
        onError: (error: any) => {
            toast.error(error?.response?.data?.detail || "ĞÑˆĞ¸Ğ±ĞºĞ° Ğ¿Ñ€Ğ¸ ÑƒĞ´Ğ°Ğ»ĞµĞ½Ğ¸Ğ¸ Ğ¿Ñ€Ğ¾Ğ¼Ğ¾ĞºĞ¾Ğ´Ğ°");
        },
    });
}

```


## <a name="rentalappmainsrchooksuseAdminRentalsts"></a>`rental-app-main/src/hooks/useAdminRentals.ts`

```typescript
// path: rental-app-main/src/hooks/useAdminRentals.ts

// src/hooks/useAdminRentals.ts

import { useInfiniteQuery, useMutation, useQueryClient, type QueryFunctionContext } from "@tanstack/react-query";
import { toast } from "sonner";
import { api } from "@/lib/api";
// +++ Ğ˜Ğ—ĞœĞ•ĞĞ•ĞĞ˜Ğ•: Ğ˜Ğ¼Ğ¿Ğ¾Ñ€Ñ‚Ğ¸Ñ€ÑƒĞµĞ¼ Ğ¾Ğ±Ğ½Ğ¾Ğ²Ğ»ĞµĞ½Ğ½Ñ‹Ğµ Ñ‚Ğ¸Ğ¿Ñ‹ +++
import type { AdminRentalListResponse, RentalReturnRequest, AdminRentalOut } from "@/types/rental";


export interface AdminRentalsParams {
    status?: "active" | "overdue" | "completed" | null;
    search?: string;
    limit?: number;
}

const ADMIN_RENTALS_QUERY_KEY = ["adminRentals"];
const ADMIN_RESERVATIONS_QUERY_KEY = ["adminReservations"];

interface ConvertReservationPayload {
    reservationId: number;
    data: {
        notes_on_issue?: string;
        deposit_amount: number;
        prepayment_amount?: number;
        force_issue_on_holiday?: boolean;
    };
}

// +++ ĞĞĞ§ĞĞ›Ğ: ĞĞ‘ĞĞĞ’Ğ›Ğ•ĞĞĞ«Ğ™ Ğ¢Ğ˜ĞŸ Ğ”Ğ›Ğ¯ PAYLOAD Ğ’ĞĞ—Ğ’Ğ ĞĞ¢Ğ +++
interface ReturnRentalPayload {
    rentalId: number;
    data: RentalReturnRequest;
}
// +++ ĞšĞĞĞ•Ğ¦: ĞĞ‘ĞĞĞ’Ğ›Ğ•ĞĞĞĞ“Ğ Ğ¢Ğ˜ĞŸĞ +++


export function useAdminRentals(params: AdminRentalsParams = {}) {
    const { limit = 10, ...otherParams } = params;

    return useInfiniteQuery<AdminRentalListResponse, Error>({
        queryKey: [ADMIN_RENTALS_QUERY_KEY, otherParams],
        queryFn: async ({ pageParam = 0 }: QueryFunctionContext) => {
            const skip = (pageParam as number) * limit;
            const response = await api.get<AdminRentalListResponse>("/admin/rentals/", {
                params: { ...otherParams, skip, limit },
            });
            return response.data;
        },
        initialPageParam: 0,
        getNextPageParam: (lastPage, allPages) => {
            const loadedItems = allPages.reduce((acc, page) => acc + page.items.length, 0);
            if (loadedItems < lastPage.total) {
                return allPages.length;
            }
            return undefined;
        },
        staleTime: 60 * 1000,
    });
}

export function useConvertReservationToRental() {
    const queryClient = useQueryClient();
    return useMutation({
        mutationFn: ({ reservationId, data }: ConvertReservationPayload) =>
            api.post(`/admin/rentals/from-reservation/${reservationId}`, data),
        onSuccess: async () => {
            toast.success("Ğ ĞµĞ·ĞµÑ€Ğ² ÑƒÑĞ¿ĞµÑˆĞ½Ğ¾ ĞºĞ¾Ğ½Ğ²ĞµÑ€Ñ‚Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½ Ğ² Ğ°Ñ€ĞµĞ½Ğ´Ñƒ!");
            await queryClient.invalidateQueries({ queryKey: [ADMIN_RENTALS_QUERY_KEY] });
            await queryClient.invalidateQueries({ queryKey: [ADMIN_RESERVATIONS_QUERY_KEY] });
        },
        onError: (error: any) => {
            console.error("Conversion error:", error);
            throw error;
        },
    });
}

export function useDeleteAdminRental() {
    const queryClient = useQueryClient();
    return useMutation({
        mutationFn: (rentalId: number) => api.delete(`/admin/rentals/${rentalId}`),
        onSuccess: async () => {
            toast.success("ĞÑ€ĞµĞ½Ğ´Ğ° ÑƒÑĞ¿ĞµÑˆĞ½Ğ¾ ÑƒĞ´Ğ°Ğ»ĞµĞ½Ğ°");
            await queryClient.invalidateQueries({ queryKey: [ADMIN_RENTALS_QUERY_KEY] });
        },
        onError: (error: any) => {
            toast.error(error?.response?.data?.detail || "ĞÑˆĞ¸Ğ±ĞºĞ° Ğ¿Ñ€Ğ¸ ÑƒĞ´Ğ°Ğ»ĞµĞ½Ğ¸Ğ¸ Ğ°Ñ€ĞµĞ½Ğ´Ñ‹");
        },
    });
}

export function useReturnRental() {
    const queryClient = useQueryClient();
    return useMutation({
        // +++ Ğ˜Ğ—ĞœĞ•ĞĞ•ĞĞ˜Ğ•: ĞœÑƒÑ‚Ğ°Ñ†Ğ¸Ñ Ñ‚ĞµĞ¿ĞµÑ€ÑŒ Ğ¿Ñ€Ğ¸Ğ½Ğ¸Ğ¼Ğ°ĞµÑ‚ Ğ½Ğ¾Ğ²Ñ‹Ğ¹ payload +++
        mutationFn: ({ rentalId, data }: ReturnRentalPayload) =>
            api.post(`/admin/rentals/${rentalId}/return`, data),
        onSuccess: async (_data, variables) => {
            toast.success("Ğ’Ğ¾Ğ·Ğ²Ñ€Ğ°Ñ‚ Ğ°Ñ€ĞµĞ½Ğ´Ñ‹ ÑƒÑĞ¿ĞµÑˆĞ½Ğ¾ Ğ¾Ñ„Ğ¾Ñ€Ğ¼Ğ»ĞµĞ½!");
            await queryClient.invalidateQueries({ queryKey: [ADMIN_RENTALS_QUERY_KEY] });
            await queryClient.invalidateQueries({ queryKey: ["availability"] });
            await queryClient.invalidateQueries({ queryKey: ["calendar-grid"] });
        },
        onError: (error: any) => {
            toast.error(error?.response?.data?.detail || "ĞÑˆĞ¸Ğ±ĞºĞ° Ğ¿Ñ€Ğ¸ Ğ¾Ñ„Ğ¾Ñ€Ğ¼Ğ»ĞµĞ½Ğ¸Ğ¸ Ğ²Ğ¾Ğ·Ğ²Ñ€Ğ°Ñ‚Ğ°");
        },
    });
}

export function useRevertRentalToReservation() {
    const queryClient = useQueryClient();
    return useMutation({
        mutationFn: (rentalId: number) =>
            api.post(`/admin/rentals/${rentalId}/revert-to-reservation`),
        onSuccess: async () => {
            toast.success("Ğ’Ñ‹Ğ´Ğ°Ñ‡Ğ° Ğ°Ñ€ĞµĞ½Ğ´Ñ‹ ÑƒÑĞ¿ĞµÑˆĞ½Ğ¾ Ğ¾Ñ‚Ğ¼ĞµĞ½ĞµĞ½Ğ°!");
            await queryClient.invalidateQueries({ queryKey: [ADMIN_RENTALS_QUERY_KEY] });
            await queryClient.invalidateQueries({ queryKey: [ADMIN_RESERVATIONS_QUERY_KEY] });
        },
        onError: (error: any) => {
            const errorMessage = error?.response?.data?.detail || "ĞÑˆĞ¸Ğ±ĞºĞ° Ğ¿Ñ€Ğ¸ Ğ¾Ñ‚Ğ¼ĞµĞ½Ğµ Ğ²Ñ‹Ğ´Ğ°Ñ‡Ğ¸ Ğ°Ñ€ĞµĞ½Ğ´Ñ‹";
            toast.error(errorMessage);
        },
    });
}

```


## <a name="rentalappmainsrchooksuseAdminReservationsts"></a>`rental-app-main/src/hooks/useAdminReservations.ts`

```typescript
// path: rental-app-main/src/hooks/useAdminReservations.ts

// src/hooks/useAdminReservations.ts

import { useInfiniteQuery, useMutation, useQueryClient, type QueryFunctionContext } from "@tanstack/react-query";
import { toast } from "sonner";
import { api } from "@/lib/api";
import type { AdminReservationListResponse } from "@/types/reservation";
import { transformAccessoryLinks } from "@/lib/utils";

export interface AdminReservationsParams {
    status?: "active" | "completed" | "fulfilled" | "cancelled" | "overdue" | null;
    search?: string;
    limit?: number;
}

const ADMIN_RESERVATIONS_QUERY_KEY = ["adminReservations"];

export function useAdminReservations(params: AdminReservationsParams = {}) {
    const { limit = 10, ...otherParams } = params;

    return useInfiniteQuery<AdminReservationListResponse, Error>({
        queryKey: [ADMIN_RESERVATIONS_QUERY_KEY, otherParams],
        queryFn: async ({ pageParam = 0 }: QueryFunctionContext) => {
            const skip = (pageParam as number) * limit;
            const response = await api.get<AdminReservationListResponse>("/admin/reservations/", {
                params: { ...otherParams, skip, limit },
            });
            return response.data;
        },
        initialPageParam: 0,
        getNextPageParam: (lastPage, allPages) => {
            const loadedItems = allPages.reduce((acc, page) => acc + page.items.length, 0);
            if (loadedItems < lastPage.total) {
                return allPages.length;
            }
            return undefined;
        },
        staleTime: 60 * 1000,
        select: (data) => ({
            ...data,
            pages: data.pages.map(page => ({
                ...page,
                items: page.items.map(transformAccessoryLinks)
            }))
        }),
    });
}

export function useCreateAdminReservation() {
    const queryClient = useQueryClient();
    return useMutation({
        mutationFn: (data: any) => api.post("/admin/reservations/", data),
        onSuccess: async () => {
            toast.success("Ğ ĞµĞ·ĞµÑ€Ğ² ÑƒÑĞ¿ĞµÑˆĞ½Ğ¾ ÑĞ¾Ğ·Ğ´Ğ°Ğ½");
            await queryClient.invalidateQueries({ queryKey: [ADMIN_RESERVATIONS_QUERY_KEY] });
        },
        onError: (error: any) => {
            toast.error(error?.response?.data?.detail || "ĞÑˆĞ¸Ğ±ĞºĞ° Ğ¿Ñ€Ğ¸ ÑĞ¾Ğ·Ğ´Ğ°Ğ½Ğ¸Ğ¸ Ñ€ĞµĞ·ĞµÑ€Ğ²Ğ°");
        },
    });
}

export function useDeleteAdminReservation() {
    const queryClient = useQueryClient();
    return useMutation({
        mutationFn: (reservationId: number) => api.delete(`/admin/reservations/${reservationId}`),
        onSuccess: async () => {
            toast.success("Ğ ĞµĞ·ĞµÑ€Ğ² ÑƒÑĞ¿ĞµÑˆĞ½Ğ¾ ÑƒĞ´Ğ°Ğ»ĞµĞ½");
            await queryClient.invalidateQueries({ queryKey: [ADMIN_RESERVATIONS_QUERY_KEY] });
        },
        onError: (error: any) => {
            toast.error(error?.response?.data?.detail || "ĞÑˆĞ¸Ğ±ĞºĞ° Ğ¿Ñ€Ğ¸ ÑƒĞ´Ğ°Ğ»ĞµĞ½Ğ¸Ğ¸ Ñ€ĞµĞ·ĞµÑ€Ğ²Ğ°");
        },
    });
}

export function useBulkDeleteAdminReservations() {
    const queryClient = useQueryClient();
    return useMutation({
        mutationFn: (reservationIds: number[]) => {
            const payload = { reservation_ids: reservationIds };

            // --- Ğ˜Ğ—ĞœĞ•ĞĞ•ĞĞ˜Ğ•: ĞŸĞĞ›ĞĞĞ¡Ğ¢Ğ¬Ğ® ĞœĞ•ĞĞ¯Ğ•Ğœ ĞŸĞ£Ğ¢Ğ¬ ---
            return api.post(`/admin/reservations/delete-many`, payload);
        },
        onSuccess: async () => {
            toast.success("Ğ’Ñ‹Ğ±Ñ€Ğ°Ğ½Ğ½Ñ‹Ğµ Ñ€ĞµĞ·ĞµÑ€Ğ²Ñ‹ ÑƒÑĞ¿ĞµÑˆĞ½Ğ¾ ÑƒĞ´Ğ°Ğ»ĞµĞ½Ñ‹");
            await queryClient.invalidateQueries({ queryKey: [ADMIN_RESERVATIONS_QUERY_KEY] });
        },
        onError: (error: any) => {
            toast.error(error?.response?.data?.detail || "ĞÑˆĞ¸Ğ±ĞºĞ° Ğ¿Ñ€Ğ¸ Ğ¼Ğ°ÑÑĞ¾Ğ²Ğ¾Ğ¼ ÑƒĞ´Ğ°Ğ»ĞµĞ½Ğ¸Ğ¸ Ñ€ĞµĞ·ĞµÑ€Ğ²Ğ¾Ğ²");
        },
    });
}

```


## <a name="rentalappmainsrchooksuseAdminUsersts"></a>`rental-app-main/src/hooks/useAdminUsers.ts`

```typescript
// path: rental-app-main/src/hooks/useAdminUsers.ts

// src/hooks/useAdminUsers.ts

import { useQuery, useInfiniteQuery, useMutation, useQueryClient } from "@tanstack/react-query";
import { UserService } from "@/core/services";
import { toast } from "sonner";
import type { UserListResponse, UserRole, UserPaymentRequest } from "@/types/user";
import type { AdminUserCreateFormSchema, AdminUserUpdateSchema } from "@/lib/validationSchemas";

// Ğ¢Ğ¸Ğ¿ Ğ´Ğ»Ñ Ğ´Ğ°Ğ½Ğ½Ñ‹Ñ…, Ğ¾Ñ‚Ğ¿Ñ€Ğ°Ğ²Ğ»ÑĞµĞ¼Ñ‹Ñ… Ğ¿Ñ€Ğ¸ Ğ¾Ğ±Ğ½Ğ¾Ğ²Ğ»ĞµĞ½Ğ¸Ğ¸
type AdminUserUpdatePayload = {
    userId: number;
    data: AdminUserUpdateSchema;
};

// Ğ¡Ğ¾Ğ·Ğ´Ğ°Ğ½Ğ¸Ğµ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ñ (Ñ‚Ğ¾Ğ»ÑŒĞºĞ¾ Ğ°Ğ´Ğ¼Ğ¸Ğ½Ğ¸ÑÑ‚Ñ€Ğ°Ñ‚Ğ¾Ñ€)
export function useAdminCreateUser() {
    const queryClient = useQueryClient();
    return useMutation({
        mutationFn: async (userData: AdminUserCreateFormSchema) => {
            return await UserService.createUser(userData);
        },
        onSuccess: () => {
            void queryClient.invalidateQueries({ queryKey: ["admin", "users"] });
            toast.success("ĞŸĞ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ÑŒ ÑƒÑĞ¿ĞµÑˆĞ½Ğ¾ ÑĞ¾Ğ·Ğ´Ğ°Ğ½");
        },
        onError: (error: unknown) => {
            const apiError = error as { response?: { data?: { detail?: string } } }
            toast.error(apiError?.response?.data?.detail || "ĞÑˆĞ¸Ğ±ĞºĞ° Ğ¿Ñ€Ğ¸ ÑĞ¾Ğ·Ğ´Ğ°Ğ½Ğ¸Ğ¸ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ñ");
        },
    });
}

// ĞĞ±Ğ½Ğ¾Ğ²Ğ»ĞµĞ½Ğ¸Ğµ Ğ´Ğ°Ğ½Ğ½Ñ‹Ñ… Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ñ (Ğ°Ğ´Ğ¼Ğ¸Ğ½Ğ¸ÑÑ‚Ñ€Ğ°Ñ‚Ğ¾Ñ€/Ğ¼ĞµĞ½ĞµĞ´Ğ¶ĞµÑ€)
export function useAdminUpdateUser() {
    const queryClient = useQueryClient();
    return useMutation({
        mutationFn: async ({ userId, data }: AdminUserUpdatePayload) => {
            return await UserService.updateUser({ id: userId, ...data });
        },
        onSuccess: (updatedUser) => {
            void queryClient.invalidateQueries({ queryKey: ["admin", "users"] });
            toast.success(`ĞŸÑ€Ğ¾Ñ„Ğ¸Ğ»ÑŒ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ñ ${updatedUser.full_name} ÑƒÑĞ¿ĞµÑˆĞ½Ğ¾ Ğ¾Ğ±Ğ½Ğ¾Ğ²Ğ»ĞµĞ½.`);
        },
        onError: (error: unknown) => {
            const apiError = error as { response?: { data?: { detail?: string } } }
            toast.error(apiError?.response?.data?.detail || "ĞÑˆĞ¸Ğ±ĞºĞ° Ğ¿Ñ€Ğ¸ Ğ¾Ğ±Ğ½Ğ¾Ğ²Ğ»ĞµĞ½Ğ¸Ğ¸ Ğ¿Ñ€Ğ¾Ñ„Ğ¸Ğ»Ñ.");
        }
    });
}

// ĞŸĞ¾Ğ»ÑƒÑ‡ĞµĞ½Ğ¸Ğµ Ğ²ÑĞµÑ… Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ĞµĞ¹ Ñ Ğ¿Ğ°Ğ³Ğ¸Ğ½Ğ°Ñ†Ğ¸ĞµĞ¹ (Ğ´Ğ»Ñ Ğ¼ĞµĞ½ĞµĞ´Ğ¶ĞµÑ€Ğ¾Ğ² Ğ¸ Ğ°Ğ´Ğ¼Ğ¸Ğ½Ğ¸ÑÑ‚Ñ€Ğ°Ñ‚Ğ¾Ñ€Ğ¾Ğ²)
export function useAdminUsers() {
    return useInfiniteQuery<UserListResponse>({
        queryKey: ["admin", "users"],
        queryFn: async ({ pageParam = 0 }) => {
            const skip = (pageParam as number) * 15; // 15 Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ĞµĞ¹ Ğ½Ğ° ÑÑ‚Ñ€Ğ°Ğ½Ğ¸Ñ†Ñƒ
            return await UserService.getAllUsers(skip, 15);
        },
        initialPageParam: 0,
        getNextPageParam: (lastPage, allPages) => {
            const totalLoaded = allPages.reduce((acc, page) => acc + page.items.length, 0);
            return totalLoaded < lastPage.total ? allPages.length : undefined;
        },
        staleTime: 5 * 60 * 1000, // 5 Ğ¼Ğ¸Ğ½ÑƒÑ‚
    });
}

// Ğ˜Ğ·Ğ¼ĞµĞ½ĞµĞ½Ğ¸Ğµ Ñ€Ğ¾Ğ»Ğ¸ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ñ (Ñ‚Ğ¾Ğ»ÑŒĞºĞ¾ Ğ°Ğ´Ğ¼Ğ¸Ğ½Ğ¸ÑÑ‚Ñ€Ğ°Ñ‚Ğ¾Ñ€)
export function useUpdateUserRole() {
    const queryClient = useQueryClient();
    return useMutation({
        // Ğ˜Ğ—ĞœĞ•ĞĞ•ĞĞ˜Ğ•: Ğ£ĞºĞ°Ğ·Ñ‹Ğ²Ğ°ĞµĞ¼ ĞºĞ¾Ğ½ĞºÑ€ĞµÑ‚Ğ½Ñ‹Ğ¹ Ñ‚Ğ¸Ğ¿ UserRole Ğ²Ğ¼ĞµÑÑ‚Ğ¾ string
        mutationFn: async ({ userId, newRole }: { userId: number; newRole: UserRole }) => {
            return await UserService.updateUserRole(userId, newRole);
        },
        onSuccess: () => {
            void queryClient.invalidateQueries({ queryKey: ["admin", "users"] });
            toast.success("Ğ Ğ¾Ğ»ÑŒ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ñ ÑƒÑĞ¿ĞµÑˆĞ½Ğ¾ Ğ¸Ğ·Ğ¼ĞµĞ½ĞµĞ½Ğ°");
        },
        onError: (error: unknown) => {
            const apiError = error as { response?: { data?: { detail?: string } } }
            toast.error(apiError?.response?.data?.detail || "ĞÑˆĞ¸Ğ±ĞºĞ° Ğ¿Ñ€Ğ¸ Ğ¸Ğ·Ğ¼ĞµĞ½ĞµĞ½Ğ¸Ğ¸ Ñ€Ğ¾Ğ»Ğ¸");
        },
    });
}

// Ğ‘Ğ»Ğ¾ĞºĞ¸Ñ€Ğ¾Ğ²ĞºĞ° Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ñ (Ñ‚Ğ¾Ğ»ÑŒĞºĞ¾ Ğ°Ğ´Ğ¼Ğ¸Ğ½Ğ¸ÑÑ‚Ñ€Ğ°Ñ‚Ğ¾Ñ€)
export function useBlockUser() {
    const queryClient = useQueryClient();
    return useMutation({
        mutationFn: async (userId: number) => {
            return await UserService.toggleUserStatus(userId, false);
        },
        onSuccess: () => {
            void queryClient.invalidateQueries({ queryKey: ["admin", "users"] });
            toast.success("ĞŸĞ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ÑŒ Ğ·Ğ°Ğ±Ğ»Ğ¾ĞºĞ¸Ñ€Ğ¾Ğ²Ğ°Ğ½");
        },
        onError: (error: unknown) => {
            const apiError = error as { response?: { data?: { detail?: string } } }
            toast.error(apiError?.response?.data?.detail || "ĞÑˆĞ¸Ğ±ĞºĞ° Ğ¿Ñ€Ğ¸ Ğ±Ğ»Ğ¾ĞºĞ¸Ñ€Ğ¾Ğ²ĞºĞµ");
        },
    });
}

// Ğ Ğ°Ğ·Ğ±Ğ»Ğ¾ĞºĞ¸Ñ€Ğ¾Ğ²ĞºĞ° Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ñ (Ñ‚Ğ¾Ğ»ÑŒĞºĞ¾ Ğ°Ğ´Ğ¼Ğ¸Ğ½Ğ¸ÑÑ‚Ñ€Ğ°Ñ‚Ğ¾Ñ€)
export function useUnblockUser() {
    const queryClient = useQueryClient();
    return useMutation({
        mutationFn: async (userId: number) => {
            return await UserService.toggleUserStatus(userId, true);
        },
        onSuccess: () => {
            void queryClient.invalidateQueries({ queryKey: ["admin", "users"] });
            toast.success("ĞŸĞ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ÑŒ Ñ€Ğ°Ğ·Ğ±Ğ»Ğ¾ĞºĞ¸Ñ€Ğ¾Ğ²Ğ°Ğ½");
        },
        onError: (error: unknown) => {
            const apiError = error as { response?: { data?: { detail?: string } } }
            toast.error(apiError?.response?.data?.detail || "ĞÑˆĞ¸Ğ±ĞºĞ° Ğ¿Ñ€Ğ¸ Ñ€Ğ°Ğ·Ğ±Ğ»Ğ¾ĞºĞ¸Ñ€Ğ¾Ğ²ĞºĞµ");
        },
    });
}

// Ğ£Ğ´Ğ°Ğ»ĞµĞ½Ğ¸Ğµ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ñ (Ñ‚Ğ¾Ğ»ÑŒĞºĞ¾ Ğ°Ğ´Ğ¼Ğ¸Ğ½Ğ¸ÑÑ‚Ñ€Ğ°Ñ‚Ğ¾Ñ€)
export function useDeleteUser() {
    const queryClient = useQueryClient();
    return useMutation({
        mutationFn: async (userId: number) => {
            await UserService.deleteUser(userId);
        },
        onSuccess: () => {
            void queryClient.invalidateQueries({ queryKey: ["admin", "users"] });
            toast.success("ĞŸĞ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ÑŒ Ğ¸ ÑĞ²ÑĞ·Ğ°Ğ½Ğ½Ñ‹Ğ¹ ĞºĞ»Ğ¸ĞµĞ½Ñ‚ ÑƒĞ´Ğ°Ğ»ĞµĞ½Ñ‹");
        },
        onError: (error: unknown) => {
            const apiError = error as { response?: { data?: { detail?: string } } }
            toast.error(apiError?.response?.data?.detail || "ĞÑˆĞ¸Ğ±ĞºĞ° Ğ¿Ñ€Ğ¸ ÑƒĞ´Ğ°Ğ»ĞµĞ½Ğ¸Ğ¸");
        },
    });
}

/**
 * Ğ¥ÑƒĞº Ğ´Ğ»Ñ Ğ´Ğ¾Ğ±Ğ°Ğ²Ğ»ĞµĞ½Ğ¸Ñ Ğ¿Ğ»Ğ°Ñ‚ĞµĞ¶Ğ° Ğ¸ Ğ¿Ğ¾Ğ¿Ğ¾Ğ»Ğ½ĞµĞ½Ğ¸Ñ Ğ±Ğ°Ğ»Ğ°Ğ½ÑĞ° Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ñ.
 */
export function useAddUserPayment() {
    const queryClient = useQueryClient();
    return useMutation({
        mutationFn: async ({ userId, data }: { userId: number; data: UserPaymentRequest }) => {
            return await UserService.addUserPayment(userId, data);
        },
        onSuccess: (updatedUser) => {
            void queryClient.invalidateQueries({ queryKey: ["admin", "users"] });
            // ĞœĞ¾Ğ¶Ğ½Ğ¾ Ñ‚Ğ°ĞºĞ¶Ğµ Ñ‚Ğ¾Ñ‡ĞµÑ‡Ğ½Ğ¾ Ğ¾Ğ±Ğ½Ğ¾Ğ²Ğ¸Ñ‚ÑŒ ĞºÑÑˆ ĞºĞ¾Ğ½ĞºÑ€ĞµÑ‚Ğ½Ğ¾Ğ³Ğ¾ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ñ, ĞµÑĞ»Ğ¸ Ğ¾Ğ½ Ğ³Ğ´Ğµ-Ñ‚Ğ¾ Ğ¸ÑĞ¿Ğ¾Ğ»ÑŒĞ·ÑƒĞµÑ‚ÑÑ
            toast.success(`Ğ‘Ğ°Ğ»Ğ°Ğ½Ñ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ñ ${updatedUser.full_name} ÑƒÑĞ¿ĞµÑˆĞ½Ğ¾ Ğ¿Ğ¾Ğ¿Ğ¾Ğ»Ğ½ĞµĞ½.`);
        },
        onError: (error: unknown) => {
            const apiError = error as { response?: { data?: { detail?: string } } };
            toast.error(apiError?.response?.data?.detail || "ĞÑˆĞ¸Ğ±ĞºĞ° Ğ¿Ñ€Ğ¸ Ğ¿Ğ¾Ğ¿Ğ¾Ğ»Ğ½ĞµĞ½Ğ¸Ğ¸ Ğ±Ğ°Ğ»Ğ°Ğ½ÑĞ°.");
        },
    });
}

```


## <a name="rentalappmainsrchooksuseAllEquipmentts"></a>`rental-app-main/src/hooks/useAllEquipment.ts`

```typescript
// path: rental-app-main/src/hooks/useAllEquipment.ts

// src/hooks/useAllEquipment.ts

import { useQuery } from "@tanstack/react-query";
import { EquipmentService } from "@/core/services";
import { handleQueryError } from "@/lib/queryHelpers";

// Ğ­Ñ‚Ğ¾Ñ‚ Ñ…ÑƒĞº Ğ±ÑƒĞ´ĞµÑ‚ Ğ·Ğ°Ğ³Ñ€ÑƒĞ¶Ğ°Ñ‚ÑŒ Ğ’Ğ¡Ğ• Ğ¾Ğ±Ğ¾Ñ€ÑƒĞ´Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ Ğ´Ğ»Ñ Ñ„Ğ¾Ñ€Ğ¼ Ğ¸ Ğ²Ñ‹Ğ¿Ğ°Ğ´Ğ°ÑÑ‰Ğ¸Ñ… ÑĞ¿Ğ¸ÑĞºĞ¾Ğ²
export function useAllEquipment() {
    return useQuery({
        queryKey: ["allEquipment"], // Ğ£Ğ½Ğ¸ĞºĞ°Ğ»ÑŒĞ½Ñ‹Ğ¹ ĞºĞ»ÑÑ‡
        queryFn: async () => {
            try {
                // Ğ—Ğ°Ğ¿Ñ€Ğ°ÑˆĞ¸Ğ²Ğ°ĞµĞ¼ Ğ±Ğ¾Ğ»ÑŒÑˆĞ¾Ğ¹ Ğ»Ğ¸Ğ¼Ğ¸Ñ‚, Ñ‡Ñ‚Ğ¾Ğ±Ñ‹ Ğ¿Ğ¾Ğ»ÑƒÑ‡Ğ¸Ñ‚ÑŒ Ğ²ÑĞµ Ğ·Ğ°Ğ¿Ğ¸ÑĞ¸
                const response = await EquipmentService.getAllEquipment(0, 1000);
                return response.items; // Ğ’Ğ¾Ğ·Ğ²Ñ€Ğ°Ñ‰Ğ°ĞµĞ¼ Ñ‚Ğ¾Ğ»ÑŒĞºĞ¾ Ğ¼Ğ°ÑÑĞ¸Ğ²
            } catch (error) {
                handleQueryError(error);
                throw error;
            }
        },
        staleTime: 60 * 60 * 1000, // ĞšÑÑˆĞ¸Ñ€ÑƒĞµĞ¼ Ğ½Ğ° Ñ‡Ğ°Ñ
    });
}

```


## <a name="rentalappmainsrchooksuseAssociationsts"></a>`rental-app-main/src/hooks/useAssociations.ts`

```typescript
// path: rental-app-main/src/hooks/useAssociations.ts

// src/hooks/useAssociations.ts

import { useQuery } from "@tanstack/react-query";
import { api } from "@/lib/api";
import type { Association, AssociationListResponse } from "@/types/association"; // Ğ˜Ğ¼Ğ¿Ğ¾Ñ€Ñ‚Ğ¸Ñ€ÑƒĞµĞ¼ Ğ¾Ğ±Ğ° Ñ‚Ğ¸Ğ¿Ğ°

const ASSOCIATIONS_QUERY_KEY = ["associations"];

export function useAssociations() {
    // Ğ˜Ğ—ĞœĞ•ĞĞ•ĞĞ˜Ğ•: Ğ¥ÑƒĞº Ñ‚ĞµĞ¿ĞµÑ€ÑŒ Ğ¾Ğ¶Ğ¸Ğ´Ğ°ĞµÑ‚ Association[] ĞºĞ°Ğº ĞºĞ¾Ğ½ĞµÑ‡Ğ½Ñ‹Ğ¹ Ñ€ĞµĞ·ÑƒĞ»ÑŒÑ‚Ğ°Ñ‚ Ğ´Ğ»Ñ ĞºĞ¾Ğ¼Ğ¿Ğ¾Ğ½ĞµĞ½Ñ‚Ğ°
    return useQuery<Association[]>({
        queryKey: ASSOCIATIONS_QUERY_KEY,
        queryFn: async () => {
            // Ğ—Ğ°Ğ¿Ñ€Ğ°ÑˆĞ¸Ğ²Ğ°ĞµĞ¼ Ñƒ API Ğ¾Ğ±ÑŠĞµĞºÑ‚ AssociationListResponse
            const response = await api.get<AssociationListResponse>("/associations/");
            // Ğ Ğ²Ğ¾Ğ·Ğ²Ñ€Ğ°Ñ‰Ğ°ĞµĞ¼ Ñ‚Ğ¾Ğ»ÑŒĞºĞ¾ Ğ¼Ğ°ÑÑĞ¸Ğ² `items`
            return response.data.items;
        },
        staleTime: 5 * 60 * 1000, // 5 Ğ¼Ğ¸Ğ½ÑƒÑ‚
    });
}

```


## <a name="rentalappmainsrchooksuseAvailabilityCheckts"></a>`rental-app-main/src/hooks/useAvailabilityCheck.ts`

```typescript
// path: rental-app-main/src/hooks/useAvailabilityCheck.ts

// src/hooks/useAvailabilityCheck.ts

import { useQuery } from "@tanstack/react-query";
import { useMemo } from "react";
import { AvailabilityService } from "@/core/services";
import type { AvailabilityInfo } from "@/types/availability";
import { handleQueryError } from "@/lib/queryHelpers";

export interface UseAvailabilityCheckProps {
    equipmentIds: number[];
    startDate: Date;
    endDate: Date;
    excludeReservationId?: number;
    enabled?: boolean;
}

export interface UseAvailabilityCheckReturn {
    isLoading: boolean;
    isError: boolean;
    availabilityMap: Record<number, AvailabilityInfo>;
    conflictingItemIds: number[];
    hasConflicts: boolean;
    error: Error | null;
}

/**
 * Ğ¦ĞµĞ½Ñ‚Ñ€Ğ°Ğ»ÑŒĞ½Ñ‹Ğ¹ Ñ…ÑƒĞº Ğ´Ğ»Ñ Ğ¿Ñ€Ğ¾Ğ²ĞµÑ€ĞºĞ¸ Ğ´Ğ¾ÑÑ‚ÑƒĞ¿Ğ½Ğ¾ÑÑ‚Ğ¸ Ğ¾Ğ±Ğ¾Ñ€ÑƒĞ´Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ.
 * Ğ˜ÑĞ¿Ğ¾Ğ»ÑŒĞ·ÑƒĞµÑ‚ useQuery Ğ¸Ğ· @tanstack/react-query Ğ´Ğ»Ñ Ğ¿Ğ¾Ğ»ÑƒÑ‡ĞµĞ½Ğ¸Ñ Ğ¸ ĞºÑÑˆĞ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ Ğ´Ğ°Ğ½Ğ½Ñ‹Ñ… Ğ¾ Ğ´Ğ¾ÑÑ‚ÑƒĞ¿Ğ½Ğ¾ÑÑ‚Ğ¸.
 * 
 * @param props - ĞŸĞ°Ñ€Ğ°Ğ¼ĞµÑ‚Ñ€Ñ‹ Ğ´Ğ»Ñ Ğ¿Ñ€Ğ¾Ğ²ĞµÑ€ĞºĞ¸ Ğ´Ğ¾ÑÑ‚ÑƒĞ¿Ğ½Ğ¾ÑÑ‚Ğ¸
 * @returns ĞĞ±ÑŠĞµĞºÑ‚ Ñ Ğ´Ğ°Ğ½Ğ½Ñ‹Ğ¼Ğ¸ Ğ¾ Ğ´Ğ¾ÑÑ‚ÑƒĞ¿Ğ½Ğ¾ÑÑ‚Ğ¸ Ğ¸ ÑÑ‚Ğ°Ñ‚ÑƒÑĞ¾Ğ¼ Ğ·Ğ°Ğ³Ñ€ÑƒĞ·ĞºĞ¸
 */
export function useAvailabilityCheck({
    equipmentIds,
    startDate,
    endDate,
    excludeReservationId,
    enabled = true
}: UseAvailabilityCheckProps): UseAvailabilityCheckReturn {
    
    // Ğ¤Ğ¾Ñ€Ğ¼Ğ¸Ñ€ÑƒĞµĞ¼ ÑƒĞ½Ğ¸ĞºĞ°Ğ»ÑŒĞ½Ñ‹Ğ¹ queryKey Ğ½Ğ° Ğ¾ÑĞ½Ğ¾Ğ²Ğµ Ğ²Ñ…Ğ¾Ğ´Ğ½Ñ‹Ñ… Ğ¿Ğ°Ñ€Ğ°Ğ¼ĞµÑ‚Ñ€Ğ¾Ğ²
    const queryKey = useMemo(() => {
        const stringifiedIds = JSON.stringify([...equipmentIds].sort((a, b) => a - b));
        return [
            "availability-check",
            stringifiedIds,
            startDate.toISOString(),
            endDate.toISOString(),
            excludeReservationId
        ] as const;
    }, [equipmentIds, startDate, endDate, excludeReservationId]);

    // ĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑĞµĞ¼ Ğ²Ğ°Ğ»Ğ¸Ğ´Ğ½Ğ¾ÑÑ‚ÑŒ Ğ¿Ğ°Ñ€Ğ°Ğ¼ĞµÑ‚Ñ€Ğ¾Ğ²
    const isParamsValid = useMemo(() => {
        return !!(
            equipmentIds.length > 0 &&
            startDate && !isNaN(startDate.getTime()) &&
            endDate && !isNaN(endDate.getTime()) &&
            startDate <= endDate
        );
    }, [equipmentIds, startDate, endDate]);

    const query = useQuery({
        queryKey,
        queryFn: async (): Promise<AvailabilityInfo[]> => {
            if (!isParamsValid) return [];
            
            try {
                return await AvailabilityService.getStatuses({
                    equipmentIds,
                    startDate,
                    endDate,
                    excludeReservationId
                });
            } catch (error: unknown) {
                console.error("[useAvailabilityCheck] Error fetching availability:", error);
                handleQueryError(error);
                throw error;
            }
        },
        enabled: enabled && isParamsValid,
        staleTime: 30 * 1000, // 30 ÑĞµĞºÑƒĞ½Ğ´
        gcTime: 5 * 60 * 1000, // 5 Ğ¼Ğ¸Ğ½ÑƒÑ‚
    });

    // ĞĞ±Ñ€Ğ°Ğ±Ğ°Ñ‚Ñ‹Ğ²Ğ°ĞµĞ¼ Ğ´Ğ°Ğ½Ğ½Ñ‹Ğµ Ğ¸ ÑĞ¾Ğ·Ğ´Ğ°ĞµĞ¼ ĞºĞ°Ñ€Ñ‚Ñƒ Ğ´Ğ¾ÑÑ‚ÑƒĞ¿Ğ½Ğ¾ÑÑ‚Ğ¸
    const processedData = useMemo(() => {
        const availabilityData = query.data || [];
        
        // Ğ¡Ğ¾Ğ·Ğ´Ğ°ĞµĞ¼ ĞºĞ°Ñ€Ñ‚Ñƒ Ğ´Ğ¾ÑÑ‚ÑƒĞ¿Ğ½Ğ¾ÑÑ‚Ğ¸ Ğ´Ğ»Ñ Ğ±Ñ‹ÑÑ‚Ñ€Ğ¾Ğ³Ğ¾ Ğ´Ğ¾ÑÑ‚ÑƒĞ¿Ğ°
        const availabilityMap: Record<number, AvailabilityInfo> = {};
        availabilityData.forEach((info) => {
            availabilityMap[info.equipment_id] = info;
        });

        // ĞĞ°Ñ…Ğ¾Ğ´Ğ¸Ğ¼ ID Ğ²ÑĞµÑ… ĞºĞ¾Ğ½Ñ„Ğ»Ğ¸ĞºÑ‚Ğ½Ñ‹Ñ… Ğ¿Ğ¾Ğ·Ğ¸Ñ†Ğ¸Ğ¹
        const conflictingItemIds = availabilityData
            .filter(info => info.status === "reserved" || info.status === "rented")
            .map(info => info.equipment_id);

        return {
            availabilityMap,
            conflictingItemIds,
            hasConflicts: conflictingItemIds.length > 0
        };
    }, [query.data]);

    return {
        isLoading: query.isLoading,
        isError: query.isError,
        availabilityMap: processedData.availabilityMap,
        conflictingItemIds: processedData.conflictingItemIds,
        hasConflicts: processedData.hasConflicts,
        error: query.error
    };
}


```


## <a name="rentalappmainsrchooksuseBalanceHistoryts"></a>`rental-app-main/src/hooks/useBalanceHistory.ts`

```typescript
// path: rental-app-main/src/hooks/useBalanceHistory.ts

// src/hooks/useBalanceHistory.ts

import { useQuery } from "@tanstack/react-query";
import { UserService } from "@/core/services";
import type { BalanceHistoryListResponse } from "@/types/balanceHistory";
import { useCurrentUser } from "./useProfile";

const PAGE_SIZE = 15;

/**
 * Ğ¥ÑƒĞº Ğ´Ğ»Ñ Ğ¿Ğ¾Ğ»ÑƒÑ‡ĞµĞ½Ğ¸Ñ Ğ¿Ğ°Ğ³Ğ¸Ğ½Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ½Ğ¾Ğ¹ Ğ¸ÑÑ‚Ğ¾Ñ€Ğ¸Ğ¸ Ğ±Ğ°Ğ»Ğ°Ğ½ÑĞ° Ğ¢Ğ•ĞšĞ£Ğ©Ğ•Ğ“Ğ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ñ.
 */
export function useBalanceHistory(page: number) {
    const { data: user } = useCurrentUser();

    return useQuery<BalanceHistoryListResponse>({
        queryKey: ["balanceHistory", "me", page],
        queryFn: async () => {
            const skip = (page - 1) * PAGE_SIZE;
            return await UserService.getMyBalanceHistory(skip, PAGE_SIZE);
        },
        enabled: !!user, // Ğ’Ñ‹Ğ¿Ğ¾Ğ»Ğ½ÑÑ‚ÑŒ Ğ·Ğ°Ğ¿Ñ€Ğ¾Ñ Ñ‚Ğ¾Ğ»ÑŒĞºĞ¾ ĞµÑĞ»Ğ¸ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ÑŒ Ğ°Ğ²Ñ‚Ğ¾Ñ€Ğ¸Ğ·Ğ¾Ğ²Ğ°Ğ½
        staleTime: 60 * 1000, // 1 Ğ¼Ğ¸Ğ½ÑƒÑ‚Ğ°
    });
}

/**
 * Ğ¥ÑƒĞº Ğ´Ğ»Ñ Ğ¿Ğ¾Ğ»ÑƒÑ‡ĞµĞ½Ğ¸Ñ Ğ¿Ğ°Ğ³Ğ¸Ğ½Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ½Ğ¾Ğ¹ Ğ¸ÑÑ‚Ğ¾Ñ€Ğ¸Ğ¸ Ğ±Ğ°Ğ»Ğ°Ğ½ÑĞ° Ğ›Ğ®Ğ‘ĞĞ“Ğ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ñ (Ğ´Ğ»Ñ Ğ°Ğ´Ğ¼Ğ¸Ğ½Ğ¾Ğ²).
 */
export function useAdminBalanceHistory(userId: number, page: number) {
    const { data: currentUser } = useCurrentUser();
    const isManager = currentUser?.role === 'admin' || currentUser?.role === 'manager';

    return useQuery<BalanceHistoryListResponse>({
        queryKey: ["balanceHistory", "admin", userId, page],
        queryFn: async () => {
            const skip = (page - 1) * PAGE_SIZE;
            return await UserService.getUserBalanceHistory(userId, skip, PAGE_SIZE);
        },
        enabled: isManager && !!userId, // Ğ’Ñ‹Ğ¿Ğ¾Ğ»Ğ½ÑÑ‚ÑŒ Ğ·Ğ°Ğ¿Ñ€Ğ¾Ñ Ñ‚Ğ¾Ğ»ÑŒĞºĞ¾ ĞµÑĞ»Ğ¸ Ñ‚ĞµĞºÑƒÑ‰Ğ¸Ğ¹ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ÑŒ - Ğ°Ğ´Ğ¼Ğ¸Ğ½/Ğ¼ĞµĞ½ĞµĞ´Ğ¶ĞµÑ€
        staleTime: 60 * 1000,
    });
}

```


## <a name="rentalappmainsrchooksuseCalendarGridts"></a>`rental-app-main/src/hooks/useCalendarGrid.ts`

```typescript
// path: rental-app-main/src/hooks/useCalendarGrid.ts

// src/hooks/useCalendarGrid.ts

import { useQuery } from "@tanstack/react-query"
import { useDateStore } from "@/store/dateStore"
import { useFilterStore } from "@/store/filterStore"
import { useSearchStore } from "@/store/searchStore"
import { useEquipment } from "./useEquipment"
import { formatDate } from "@/lib/utils"
import { CalendarService } from "@/core/services"
import type { CalendarGridData } from "@/core/services"
import { useMemo } from "react" // <-- Ğ”Ğ¾Ğ±Ğ°Ğ²Ğ»ÑĞµĞ¼ Ğ¸Ğ¼Ğ¿Ğ¾Ñ€Ñ‚ useMemo

export function useCalendarGrid() {
    const { startDate, endDate } = useDateStore()
    const { type, brand } = useFilterStore()
    const { query } = useSearchStore()
    // Ğ˜Ğ—ĞœĞ•ĞĞ•ĞĞ˜Ğ•: useEquipment Ğ²Ğ¾Ğ·Ğ²Ñ€Ğ°Ñ‰Ğ°ĞµÑ‚ Ğ¾Ğ±ÑŠĞµĞºÑ‚ ÑĞ¾ ÑÑ‚Ñ€Ğ°Ğ½Ğ¸Ñ†Ğ°Ğ¼Ğ¸, Ğ° Ğ½Ğµ Ğ¿Ñ€Ğ¾ÑÑ‚Ğ¾ Ğ´Ğ°Ğ½Ğ½Ñ‹Ğµ
    const { data: equipmentPages, isLoading: isLoadingEquipment } = useEquipment()

    // Ğ˜Ğ—ĞœĞ•ĞĞ•ĞĞ˜Ğ•: "Ğ Ğ°Ğ·Ğ²Ğ¾Ñ€Ğ°Ñ‡Ğ¸Ğ²Ğ°ĞµĞ¼" Ğ²ÑĞµ ÑÑ‚Ñ€Ğ°Ğ½Ğ¸Ñ†Ñ‹ Ğ² Ğ¾Ğ´Ğ¸Ğ½ Ğ¿Ğ»Ğ¾ÑĞºĞ¸Ğ¹ Ğ¼Ğ°ÑÑĞ¸Ğ²
    const allEquipment = useMemo(() =>
            equipmentPages?.pages.flatMap(page => page.items) ?? [],
        [equipmentPages]);

    // Ğ¢ĞµĞ¿ĞµÑ€ÑŒ Ñ„Ğ¸Ğ»ÑŒÑ‚Ñ€ÑƒĞµĞ¼ Ğ¿Ñ€Ğ°Ğ²Ğ¸Ğ»ÑŒĞ½Ñ‹Ğ¹ Ğ¼Ğ°ÑÑĞ¸Ğ² allEquipment
    const filteredIds = CalendarService.filterEquipmentForCalendar(
        allEquipment,
        {
            type: type || undefined,
            brand: brand || undefined,
            query: query || undefined
        }
    )

    const formattedStartDateAPI = startDate ? formatDate(startDate) : null
    const formattedEndDateAPI = endDate ? formatDate(endDate) : null

    const enabled =
        !!formattedStartDateAPI &&
        !!formattedEndDateAPI &&
        !isLoadingEquipment &&
        filteredIds.length > 0

    const queryKey = CalendarService.createQueryKey(
        formattedStartDateAPI!,
        formattedEndDateAPI!,
        filteredIds
    )

    return useQuery<CalendarGridData>({
        queryKey: queryKey,
        queryFn: async () => {
            if (!formattedStartDateAPI || !formattedEndDateAPI) {
                return {}
            }
            if (filteredIds.length === 0) {
                return {}
            }

            return CalendarService.getDayStatuses(
                formattedStartDateAPI,
                formattedEndDateAPI,
                filteredIds
            )
        },
        enabled,
        staleTime: 60 * 1000,
        placeholderData: (previousData) => previousData,
    })
}

```


## <a name="rentalappmainsrchooksuseDailyAvailabilityts"></a>`rental-app-main/src/hooks/useDailyAvailability.ts`

```typescript
// path: rental-app-main/src/hooks/useDailyAvailability.ts

// src/hooks/useDailyAvailability.ts
import { useQuery } from "@tanstack/react-query";
import { api } from "@/lib/api";
import { formatDate } from "@/lib/utils";
import type { DayStatus } from "@/types/availability";

type DailyAvailabilityData = Record<number, Record<string, DayStatus>>; // { equipmentId: { "DD.MM.YYYY": DayStatus } }

type Params = {
    ids: number[];
    start: Date;
    end: Date;
};

export function useDailyAvailability({ ids, start, end }: Params) {
    const formattedStartDate = formatDate(start);
    const formattedEndDate = formatDate(end);

    // Sort IDs to ensure consistent query key
    const sortedIds = JSON.stringify([...ids].sort((a, b) => a - b));

    return useQuery<DailyAvailabilityData>({
        queryKey: ["daily-availability", sortedIds, formattedStartDate, formattedEndDate],
        queryFn: async () => {
            const resp = await api.get("/calendar/day-statuses", {
                params: {
                    start: formattedStartDate,
                    end: formattedEndDate,
                    ids,
                },
            });
            // The actual data is nested inside equipment_day_statuses
            const result = resp.data?.equipment_day_statuses ?? {};
            

            
            return result;
        },
        enabled: ids.length > 0 && !!start && !!end,
        staleTime: 5 * 60 * 1000, // 5 mins
    });
}

```


## <a name="rentalappmainsrchooksuseDateRangets"></a>`rental-app-main/src/hooks/useDateRange.ts`

```typescript
// path: rental-app-main/src/hooks/useDateRange.ts

// src/hooks/useDateRange.ts

import { useState, useEffect } from 'react';
import { formatDate } from '@/lib/utils';
import { DateService } from '@/core/services';

interface UseDateRangeProps {
    startDate: Date;
    endDate: Date;
    onRangeChange: (startDate: Date, endDate: Date, source?: 'calendar' | 'slider' | 'manual', holidays?: Date[]) => void;
    holidays?: Date[];
}

interface UseDateRangeReturn {
    localStartDate: string;
    localEndDate: string;
    handleStartDateChange: (e: React.ChangeEvent<HTMLInputElement>) => void;
    handleEndDateChange: (e: React.ChangeEvent<HTMLInputElement>) => void;
}

export function useDateRange({
                                 startDate,
                                 endDate,
                                 onRangeChange,
                                 holidays = [] // Ğ£ÑÑ‚Ğ°Ğ½Ğ°Ğ²Ğ»Ğ¸Ğ²Ğ°ĞµĞ¼ Ğ·Ğ½Ğ°Ñ‡ĞµĞ½Ğ¸Ğµ Ğ¿Ğ¾ ÑƒĞ¼Ğ¾Ğ»Ñ‡Ğ°Ğ½Ğ¸Ñ
                             }: UseDateRangeProps): UseDateRangeReturn {
    // Ğ›Ğ¾ĞºĞ°Ğ»ÑŒĞ½Ğ¾Ğµ ÑĞ¾ÑÑ‚Ğ¾ÑĞ½Ğ¸Ğµ Ğ´Ğ»Ñ input'Ğ¾Ğ² Ğ²ÑĞµĞ³Ğ´Ğ° Ğ² Ñ„Ğ¾Ñ€Ğ¼Ğ°Ñ‚Ğµ 'YYYY-MM-DD'
    const [localStartDate, setLocalStartDate] = useState<string>(formatDate(startDate));
    const [localEndDate, setLocalEndDate] = useState<string>(formatDate(endDate));

    // Ğ¡Ğ¸Ğ½Ñ…Ñ€Ğ¾Ğ½Ğ¸Ğ·Ğ¸Ñ€ÑƒĞµĞ¼ Ğ»Ğ¾ĞºĞ°Ğ»ÑŒĞ½Ğ¾Ğµ ÑĞ¾ÑÑ‚Ğ¾ÑĞ½Ğ¸Ğµ, ĞµÑĞ»Ğ¸ Ğ¿Ñ€Ğ¾Ğ¿ÑÑ‹ Ğ¸Ğ·Ğ¼ĞµĞ½Ğ¸Ğ»Ğ¸ÑÑŒ Ğ¸Ğ·Ğ²Ğ½Ğµ
    useEffect(() => {
        setLocalStartDate(formatDate(startDate));
        setLocalEndDate(formatDate(endDate));
    }, [startDate, endDate]);

    const handleStartDateChange = (e: React.ChangeEvent<HTMLInputElement>) => {
        const newStartDate = new Date(e.target.value);
        if (DateService.isValidDate(newStartDate)) {
            // Ğ•ÑĞ»Ğ¸ Ğ´Ğ°Ñ‚Ğ° Ğ¾ĞºĞ¾Ğ½Ñ‡Ğ°Ğ½Ğ¸Ñ Ğ¾ĞºĞ°Ğ·Ğ°Ğ»Ğ°ÑÑŒ Ñ€Ğ°Ğ½ÑŒÑˆĞµ Ğ½Ğ¾Ğ²Ğ¾Ğ¹ Ğ´Ğ°Ñ‚Ñ‹ Ğ½Ğ°Ñ‡Ğ°Ğ»Ğ°, ĞºĞ¾Ñ€Ñ€ĞµĞºÑ‚Ğ¸Ñ€ÑƒĞµĞ¼ ĞµĞµ
            const adjustedRange = DateService.adjustDateRange(newStartDate, endDate);
            // Ğ’Ñ‹Ğ·Ñ‹Ğ²Ğ°ĞµĞ¼ ĞºĞ¾Ğ»Ğ±ÑĞº Ñ Ğ¾Ğ±ÑŠĞµĞºÑ‚Ğ°Ğ¼Ğ¸ Date Ğ¸ Ğ¿ĞµÑ€ĞµĞ´Ğ°ĞµĞ¼ holidays
            onRangeChange(adjustedRange.startDate, adjustedRange.endDate, 'manual', holidays);
        }
    };

    const handleEndDateChange = (e: React.ChangeEvent<HTMLInputElement>) => {
        const newEndDate = new Date(e.target.value);
        if (DateService.isValidDate(newEndDate)) {
            // Ğ•ÑĞ»Ğ¸ Ğ´Ğ°Ñ‚Ğ° Ğ¾ĞºĞ¾Ğ½Ñ‡Ğ°Ğ½Ğ¸Ñ Ğ¾ĞºĞ°Ğ·Ğ°Ğ»Ğ°ÑÑŒ Ñ€Ğ°Ğ½ÑŒÑˆĞµ Ğ´Ğ°Ñ‚Ñ‹ Ğ½Ğ°Ñ‡Ğ°Ğ»Ğ°, ĞºĞ¾Ñ€Ñ€ĞµĞºÑ‚Ğ¸Ñ€ÑƒĞµĞ¼ ĞµĞµ
            const adjustedRange = DateService.adjustDateRange(startDate, newEndDate);
            // Ğ’Ñ‹Ğ·Ñ‹Ğ²Ğ°ĞµĞ¼ ĞºĞ¾Ğ»Ğ±ÑĞº Ñ Ğ¾Ğ±ÑŠĞµĞºÑ‚Ğ°Ğ¼Ğ¸ Date Ğ¸ Ğ¿ĞµÑ€ĞµĞ´Ğ°ĞµĞ¼ holidays
            onRangeChange(adjustedRange.startDate, adjustedRange.endDate, 'manual', holidays);
        }
    };

    return {
        localStartDate,
        localEndDate,
        handleStartDateChange,
        handleEndDateChange,
    };
}

```


## <a name="rentalappmainsrchooksuseEditReservationts"></a>`rental-app-main/src/hooks/useEditReservation.ts`

```typescript
// path: rental-app-main/src/hooks/useEditReservation.ts

// src/hooks/useEditReservation.ts
import { useMutation, useQueryClient } from "@tanstack/react-query";
import { ReservationService } from "@/core/services";

interface EditReservationInput {
    id: number;
    start_date: string;
    end_date: string;
    equipment_ids: number[];
    promo_code?: string;
    selected_accessories?: Record<number, number[]>;
    isAdminContext?: boolean;
    // âœ¨ ĞĞĞ’Ğ«Ğ™ Ğ¤Ğ›ĞĞ“
    confirm_date_adjustment?: boolean;
}

export function useEditReservation() {
    const queryClient = useQueryClient();

    return useMutation({
        mutationFn: async (data: EditReservationInput) => {
            console.log(`[useEditReservation] ĞÑ‚Ğ¿Ñ€Ğ°Ğ²ĞºĞ° Ğ·Ğ°Ğ¿Ñ€Ğ¾ÑĞ° Ğ½Ğ° Ğ¾Ğ±Ğ½Ğ¾Ğ²Ğ»ĞµĞ½Ğ¸Ğµ Ñ€ĞµĞ·ĞµÑ€Ğ²Ğ° ${data.id}`);
            console.log(`[useEditReservation] Ğ”Ğ°Ğ½Ğ½Ñ‹Ğµ:`, data);

            const { id, isAdminContext, ...payload } = data;
            
            // ĞŸÑ€ĞµĞ¾Ğ±Ñ€Ğ°Ğ·ÑƒĞµĞ¼ Ğ´Ğ°Ğ½Ğ½Ñ‹Ğµ Ğ² Ñ„Ğ¾Ñ€Ğ¼Ğ°Ñ‚, Ğ¾Ğ¶Ğ¸Ğ´Ğ°ĞµĞ¼Ñ‹Ğ¹ ÑĞµÑ€Ğ²Ğ¸ÑĞ¾Ğ¼
            const servicePayload = {
                id,
                start_date: payload.start_date,
                end_date: payload.end_date,
                equipment_ids: payload.equipment_ids,
                selected_accessories: payload.selected_accessories || {},
                promo_code: payload.promo_code,
                isAdminContext
            };

            console.log(`[useEditReservation] ĞÑ‚Ğ¿Ñ€Ğ°Ğ²ĞºĞ° Ğ·Ğ°Ğ¿Ñ€Ğ¾ÑĞ° Ñ‡ĞµÑ€ĞµĞ· ÑĞµÑ€Ğ²Ğ¸Ñ`);

            const response = await ReservationService.updateReservation(servicePayload);

            console.log(`[useEditReservation] ĞÑ‚Ğ²ĞµÑ‚ ÑĞµÑ€Ğ²ĞµÑ€Ğ°:`, response);
            return response;
        },
        onSuccess: async (_data, variables) => {
            console.log(`[useEditReservation] Ğ£ÑĞ¿ĞµÑˆĞ½Ğ¾Ğµ Ğ¾Ğ±Ğ½Ğ¾Ğ²Ğ»ĞµĞ½Ğ¸Ğµ Ñ€ĞµĞ·ĞµÑ€Ğ²Ğ° ${variables.id}`);
            if (variables.isAdminContext) {
                await queryClient.invalidateQueries({ queryKey: ["adminReservations"] });
            }
            await queryClient.invalidateQueries({ queryKey: ["reservations"] });
            await queryClient.invalidateQueries({ queryKey: ["availability"] });
            await queryClient.invalidateQueries({ queryKey: ["calendar-grid"] });
        },
        onError: (error: unknown, variables) => {
            console.error(`[useEditReservation] ĞÑˆĞ¸Ğ±ĞºĞ° Ğ¿Ñ€Ğ¸ Ğ¾Ğ±Ğ½Ğ¾Ğ²Ğ»ĞµĞ½Ğ¸Ğ¸ Ñ€ĞµĞ·ĞµÑ€Ğ²Ğ° ${variables.id}:`, error);
        },
    });
}

```


## <a name="rentalappmainsrchooksuseEquipmentts"></a>`rental-app-main/src/hooks/useEquipment.ts`

```typescript
// path: rental-app-main/src/hooks/useEquipment.ts

// src/hooks/useEquipment.ts

import { useInfiniteQuery, type QueryFunctionContext } from "@tanstack/react-query";
import { EquipmentService, type EquipmentListResponse, type EquipmentFilterParams } from "@/core/services/EquipmentService";
import { handleQueryError } from "@/lib/queryHelpers";
import { PAGINATION_CONSTANTS } from "@/constants/paginationConstants";
import { formatDate } from "@/lib/utils";

export function useEquipment(filters: EquipmentFilterParams = {}) {
    // Ğ”ĞµÑÑ‚Ñ€ÑƒĞºÑ‚ÑƒÑ€Ğ¸Ñ€ÑƒĞµĞ¼ Ğ²ÑĞµ Ğ²Ğ¾Ğ·Ğ¼Ğ¾Ğ¶Ğ½Ñ‹Ğµ Ñ„Ğ¸Ğ»ÑŒÑ‚Ñ€Ñ‹
    const { query, type, brand, associationId, availableOnly, startDate, endDate } = filters;

    return useInfiniteQuery<EquipmentListResponse, Error>({
        // Ğ”Ğ¾Ğ±Ğ°Ğ²Ğ»ÑĞµĞ¼ Ğ½Ğ¾Ğ²Ñ‹Ğµ Ğ¿Ğ°Ñ€Ğ°Ğ¼ĞµÑ‚Ñ€Ñ‹ Ğ² ĞºĞ»ÑÑ‡ Ğ·Ğ°Ğ¿Ñ€Ğ¾ÑĞ° Ğ´Ğ»Ñ ĞºĞ¾Ñ€Ñ€ĞµĞºÑ‚Ğ½Ğ¾Ğ³Ğ¾ ĞºÑÑˆĞ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ
        queryKey: ["equipment", {
            query,
            type,
            brand,
            associationId,
            availableOnly,
            // Ğ˜ÑĞ¿Ğ¾Ğ»ÑŒĞ·ÑƒĞµĞ¼ Ğ¾Ñ‚Ñ„Ğ¾Ñ€Ğ¼Ğ°Ñ‚Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ½Ñ‹Ğµ Ğ´Ğ°Ñ‚Ñ‹ Ğ² ĞºĞ»ÑÑ‡Ğµ, Ñ‡Ñ‚Ğ¾Ğ±Ñ‹ Ğ¸Ğ·Ğ±ĞµĞ¶Ğ°Ñ‚ÑŒ Ğ¿Ñ€Ğ¾Ğ±Ğ»ĞµĞ¼ Ñ Ğ¾Ğ±ÑŠĞµĞºÑ‚Ğ°Ğ¼Ğ¸ Date
            startDate: startDate ? formatDate(startDate) : undefined,
            endDate: endDate ? formatDate(endDate) : undefined,
        }],

        queryFn: async ({ pageParam = 0 }: QueryFunctionContext): Promise<EquipmentListResponse> => {
            const pageSize = PAGINATION_CONSTANTS.HOME_PAGE_SIZE;
            const skip = (pageParam as number) * pageSize;
            try {
                // ĞŸĞµÑ€ĞµĞ´Ğ°ĞµĞ¼ Ğ²ĞµÑÑŒ Ğ¾Ğ±ÑŠĞµĞºÑ‚ filters Ğ² ÑĞµÑ€Ğ²Ğ¸Ñ
                return await EquipmentService.getAllEquipment(skip, pageSize, filters);
            } catch (error) {
                handleQueryError(error);
                throw error; // ĞŸÑ€Ğ¾Ğ±Ñ€Ğ°ÑÑ‹Ğ²Ğ°ĞµĞ¼ Ğ¾ÑˆĞ¸Ğ±ĞºÑƒ Ğ´Ğ°Ğ»ÑŒÑˆĞµ Ğ´Ğ»Ñ react-query
            }
        },
        initialPageParam: 0,
        getNextPageParam: (lastPage, allPages) => {
            const loadedItems = allPages.flatMap(page => page.items).length;

            if (loadedItems < lastPage.total) {
                return allPages.length;
            }
            return undefined;
        },
        staleTime: 5 * 60 * 1000, // 5 Ğ¼Ğ¸Ğ½ÑƒÑ‚
    });
}

```


## <a name="rentalappmainsrchooksuseEquipmentAvailabilityts"></a>`rental-app-main/src/hooks/useEquipmentAvailability.ts`

```typescript
// path: rental-app-main/src/hooks/useEquipmentAvailability.ts

import { useQuery } from "@tanstack/react-query";
import { api } from "@/lib/api";

interface EquipmentAvailability {
    hasActiveReservations: boolean;
    hasActiveRentals: boolean;
    activeReservationsCount: number;
    activeRentalsCount: number;
}

export function useEquipmentAvailability(equipmentId: number) {
    return useQuery({
        queryKey: ["equipment-availability", equipmentId],
        queryFn: async () => {
            const response = await api.get<EquipmentAvailability>(`/equipment/${equipmentId}/availability`);
            return response.data;
        },
    });
} 

```


## <a name="rentalappmainsrchooksuseEquipmentMapts"></a>`rental-app-main/src/hooks/useEquipmentMap.ts`

```typescript
// path: rental-app-main/src/hooks/useEquipmentMap.ts

// src/hooks/useEquipmentMap.ts

import { useMemo } from "react";
import type { Equipment } from "@/types/equipment";
import type { InfiniteData } from "@tanstack/react-query";
import type { EquipmentListResponse } from "@/core/services";

/**
 * Ğ¥ÑƒĞº Ğ´Ğ»Ñ ÑĞ¾Ğ·Ğ´Ğ°Ğ½Ğ¸Ñ ĞºĞ°Ñ€Ñ‚Ñ‹ Ğ¾Ğ±Ğ¾Ñ€ÑƒĞ´Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ Ğ¿Ğ¾ ID Ğ¸Ğ· Ğ´Ğ°Ğ½Ğ½Ñ‹Ñ… useInfiniteQuery
 * @param equipmentPages - ĞĞ±ÑŠĞµĞºÑ‚ InfiniteData, Ğ²Ğ¾Ğ·Ğ²Ñ€Ğ°Ñ‰Ğ°ĞµĞ¼Ñ‹Ğ¹ Ñ…ÑƒĞºĞ¾Ğ¼ useEquipment
 * @returns ĞšĞ°Ñ€Ñ‚Ğ° Ğ¾Ğ±Ğ¾Ñ€ÑƒĞ´Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ, Ğ³Ğ´Ğµ ĞºĞ»ÑÑ‡ - ID Ğ¾Ğ±Ğ¾Ñ€ÑƒĞ´Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ
 */
export const useEquipmentMap = (equipmentPages: InfiniteData<EquipmentListResponse, unknown> | undefined) => {
    return useMemo(() => {
        // Ğ˜Ğ—ĞœĞ•ĞĞ•ĞĞ˜Ğ•: "Ğ Ğ°Ğ·Ğ²Ğ¾Ñ€Ğ°Ñ‡Ğ¸Ğ²Ğ°ĞµĞ¼" Ğ²ÑĞµ ÑÑ‚Ñ€Ğ°Ğ½Ğ¸Ñ†Ñ‹ Ğ² Ğ¾Ğ´Ğ¸Ğ½ Ğ¿Ğ»Ğ¾ÑĞºĞ¸Ğ¹ Ğ¼Ğ°ÑÑĞ¸Ğ² `allEquipment`
        const allEquipment = equipmentPages?.pages.flatMap(page => page.items) ?? [];

        const map: Record<number, Equipment> = {};
        // Ğ¢ĞµĞ¿ĞµÑ€ÑŒ allEquipment - ÑÑ‚Ğ¾ Ğ¿Ñ€Ğ°Ğ²Ğ¸Ğ»ÑŒĞ½Ñ‹Ğ¹ Ğ¼Ğ°ÑÑĞ¸Ğ², Ğ¸ forEach Ğ±ÑƒĞ´ĞµÑ‚ Ñ€Ğ°Ğ±Ğ¾Ñ‚Ğ°Ñ‚ÑŒ
        allEquipment.forEach((e: Equipment) => {
            map[e.id] = e;
        });
        return map;
    }, [equipmentPages]);
};

```


## <a name="rentalappmainsrchooksuseErrorHandlerts"></a>`rental-app-main/src/hooks/useErrorHandler.ts`

```typescript
// path: rental-app-main/src/hooks/useErrorHandler.ts

// src/hooks/useErrorHandler.ts
import { useCallback } from "react"

type UseErrorHandler = () => (error: unknown) => void

/**
 * Ğ¥ÑƒĞº, Ğ¿Ñ€Ğ¾Ğ±Ñ€Ğ°ÑÑ‹Ğ²Ğ°ÑÑ‰Ğ¸Ğ¹ Ğ¾ÑˆĞ¸Ğ±ĞºÑƒ Ğ²Ğ¾ Ğ²Ğ½ĞµÑˆĞ½Ğ¸Ğ¹ ErrorBoundary Ñ‡ĞµÑ€ĞµĞ· throw.
 * Ğ’Ñ‹Ğ·Ñ‹Ğ²Ğ°ĞµÑ‚ÑÑ Ğ²Ñ€ÑƒÑ‡Ğ½ÑƒÑ Ğ¸Ğ· async-ĞºĞ¾Ğ½Ñ‚ĞµĞºÑÑ‚Ğ°.
 */
export const useErrorHandler: UseErrorHandler = () => {
    return useCallback((error: unknown) => {
        if (error instanceof Error) {
            throw error
        } else {
            throw new Error("ĞŸÑ€Ğ¾Ğ¸Ğ·Ğ¾ÑˆĞ»Ğ° Ğ½ĞµĞ¸Ğ·Ğ²ĞµÑÑ‚Ğ½Ğ°Ñ Ğ¾ÑˆĞ¸Ğ±ĞºĞ°")
        }
    }, [])
}


```


## <a name="rentalappmainsrchooksuseInlineReservationEdittsx"></a>`rental-app-main/src/hooks/useInlineReservationEdit.tsx`

```tsx
// path: rental-app-main/src/hooks/useInlineReservationEdit.tsx

// src/hooks/useInlineReservationEdit.tsx

import React, { useMemo, useState, useEffect } from "react";
import { useReserveStore } from "@/store/reserveStore";
import { useReservationState, type EquipmentDisplayDetail } from "./reservation/useReservationState";
import { useReservationData } from "./reservation/useReservationData";
import { useEditReservation } from "./useEditReservation";
import type { Reservation } from "@/types/reservation";
import { ReservationEditContext, type ReservationEditContextValue } from "@/contexts/ReservationEditContext";
import { toast } from "sonner";
import { formatDate } from "@/lib/utils"; // <-- 1. Ğ”ĞĞ‘ĞĞ’Ğ›Ğ•Ğ Ğ˜ĞœĞŸĞĞ Ğ¢
import { useAllEquipment } from "./useAllEquipment";
import type { Equipment } from "@/types/equipment";

/**
 * ĞÑĞ½Ğ¾Ğ²Ğ½Ğ¾Ğ¹ Ñ…ÑƒĞº, ĞºĞ¾Ñ‚Ğ¾Ñ€Ñ‹Ğ¹ Ğ¸Ğ½ĞºĞ°Ğ¿ÑÑƒĞ»Ğ¸Ñ€ÑƒĞµÑ‚ Ğ²ÑÑ ÑĞ»Ğ¾Ğ¶Ğ½ÑƒÑ Ğ»Ğ¾Ğ³Ğ¸ĞºÑƒ Ñ€ĞµĞ´Ğ°ĞºÑ‚Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ Ñ€ĞµĞ·ĞµÑ€Ğ²Ğ°.
 * ĞĞ½ Ğ¸ÑĞ¿Ğ¾Ğ»ÑŒĞ·ÑƒĞµÑ‚ÑÑ Ğ²Ğ½ÑƒÑ‚Ñ€Ğ¸ Ğ¿Ñ€Ğ¾Ğ²Ğ°Ğ¹Ğ´ĞµÑ€Ğ° ReservationEditProvider.
 */
const useInlineReservationEditLogic = (
    reservation: Reservation,
    initialEquipmentForDisplay: ReadonlyArray<EquipmentDisplayDetail>,
    onFullCancellation: (() => Promise<void> | void) | undefined,
    isAdminContext: boolean,
    onFinishEditing: () => void
): ReservationEditContextValue => {

    const { state, actions: stateActions, dialogs } = useReservationState(
        reservation,
        initialEquipmentForDisplay
    );

    const {
        availabilityMap, hasConflicts, isCheckingAvailability, isCalculatingPrice,
        financials, setPromoCode, applyPromoCode, removePromoCode, appliedPromoCode,
        priceDetails,
    } = useReservationData(reservation, state);

    const { data: allEquipment = [] } = useAllEquipment();

    const equipmentMap = useMemo(() =>
            new Map(allEquipment.map(e => [e.id, e])),
        [allEquipment]
    );

    useEffect(() => {
        const reserveStoreState = useReserveStore.getState();

        if (reserveStoreState.addToReservationMode === reservation.id && reserveStoreState.items.length > 0) {

            if (allEquipment.length > 0) {
                const newItemsData = reserveStoreState.items.map(itemInStore => {
                    const fullItemData = allEquipment.find((eq: Equipment) => eq.id === itemInStore.id);
                    return fullItemData || itemInStore;
                });

                stateActions.addEquipmentItems(newItemsData);
                reserveStoreState.clear();
            }
        }
    }, [allEquipment, reservation.id, stateActions]);

    const [holidayConflict, setHolidayConflict] = useState<{ message: string, suggested_end_date: string } | null>(null);
    const editApiMutation = useEditReservation();

    const finalHasChanges = useMemo(() => {
        const promoCodeChanged = appliedPromoCode !== (reservation.promo_code || "");
        return state.hasChanges || promoCodeChanged;
    }, [state.hasChanges, appliedPromoCode, reservation.promo_code]);

    const saveChanges = async (confirmAdjustment: boolean = false): Promise<boolean> => {
        if (!finalHasChanges && !confirmAdjustment) {
            toast.info("ĞĞµÑ‚ Ğ¸Ğ·Ğ¼ĞµĞ½ĞµĞ½Ğ¸Ğ¹ Ğ´Ğ»Ñ ÑĞ¾Ñ…Ñ€Ğ°Ğ½ĞµĞ½Ğ¸Ñ.");
            return false;
        }
        if (hasConflicts) {
            toast.error("ĞĞµĞ²Ğ¾Ğ·Ğ¼Ğ¾Ğ¶Ğ½Ğ¾ ÑĞ¾Ñ…Ñ€Ğ°Ğ½Ğ¸Ñ‚ÑŒ Ñ€ĞµĞ·ĞµÑ€Ğ² Ñ ĞºĞ¾Ğ½Ñ„Ğ»Ğ¸ĞºÑ‚Ğ°Ğ¼Ğ¸.");
            return false;
        }
        if (state.currentEquipmentDetails.length === 0) {
            toast.error("Ğ ĞµĞ·ĞµÑ€Ğ² Ğ´Ğ¾Ğ»Ğ¶ĞµĞ½ ÑĞ¾Ğ´ĞµÑ€Ğ¶Ğ°Ñ‚ÑŒ Ñ…Ğ¾Ñ‚Ñ Ğ±Ñ‹ Ğ¾Ğ´Ğ½Ñƒ Ğ¿Ğ¾Ğ·Ğ¸Ñ†Ğ¸Ñ.");
            return false;
        }

        try {
            await editApiMutation.mutateAsync({
                id: reservation.id,
                // V-- 2. Ğ˜Ğ¡ĞŸĞ ĞĞ’Ğ›Ğ•ĞĞ˜Ğ• Ğ—Ğ”Ğ•Ğ¡Ğ¬ --V
                start_date: formatDate(state.startDate),
                end_date: formatDate(state.endDate),
                // ^-- ĞšĞĞĞ•Ğ¦ Ğ˜Ğ¡ĞŸĞ ĞĞ’Ğ›Ğ•ĞĞ˜Ğ¯ --^
                equipment_ids: state.currentEquipmentDetails.map(eq => eq.id),
                promo_code: appliedPromoCode,
                selected_accessories: state.localSelectedAccessories,
                isAdminContext,
                confirm_date_adjustment: confirmAdjustment,
            });
            toast.success("Ğ ĞµĞ·ĞµÑ€Ğ² ÑƒÑĞ¿ĞµÑˆĞ½Ğ¾ Ğ¾Ğ±Ğ½Ğ¾Ğ²Ğ»ĞµĞ½!");
            if (holidayConflict) setHolidayConflict(null);
            onFinishEditing();
            return true;
        } catch (error) {
            const errorDetail = (error as any)?.response?.data?.detail;

            let parsedDetail = null;
            if (typeof errorDetail === 'string') {
                try { parsedDetail = JSON.parse(errorDetail); } catch (e) { /* ĞÑˆĞ¸Ğ±ĞºĞ° Ğ½Ğµ Ğ² Ñ„Ğ¾Ñ€Ğ¼Ğ°Ñ‚Ğµ JSON */ }
            } else {
                parsedDetail = errorDetail;
            }

            if (
                (error as any).response?.status === 409 &&
                parsedDetail?.error_type === "END_DATE_IS_HOLIDAY"
            ) {
                setHolidayConflict(parsedDetail);
            } else {
                const message = typeof errorDetail === 'string' ? errorDetail : "ĞÑˆĞ¸Ğ±ĞºĞ° Ğ¿Ñ€Ğ¸ ÑĞ¾Ñ…Ñ€Ğ°Ğ½ĞµĞ½Ğ¸Ğ¸ Ğ¸Ğ·Ğ¼ĞµĞ½ĞµĞ½Ğ¸Ğ¹.";
                toast.error(message);
            }
            return false;
        }
    };

    const handleConfirmHolidayAdjustment = () => {
        void saveChanges(true);
    };

    const { clear: clearReserveStore, setReservationId } = useReserveStore.getState();

    const cancelEdit = () => {
        clearReserveStore();
        onFinishEditing();
    };

    const editStateForUI = useMemo(() => ({
        ...state,
        hasChanges: finalHasChanges,
        newlyAddedEquipmentIdsAsArray: Array.from(state.newlyAddedEquipmentIds)
    }), [state, finalHasChanges]);

    return {
        reservationId: reservation.id,
        editState: editStateForUI,
        availabilityMap,
        hasConflicts,
        isLoading: editApiMutation.isPending || isCheckingAvailability,
        isCheckingAvailability,
        isSaving: editApiMutation.isPending,
        isCalculatingPrice,
        isCancelling: false,
        isCancelConfirmationVisible: dialogs.isCancelConfirmationVisible,
        startEdit: () => setReservationId(reservation.id),
        cancelEdit,
        saveChanges: () => saveChanges(false),
        equipmentMap,
        allEquipment,
        updateDates: stateActions.updateDates,
        addEquipmentItems: stateActions.addEquipmentItems,
        removeEquipmentItem: stateActions.removeEquipmentItem,
        handleConfirmFullCancellation: async () => { if (onFullCancellation) await onFullCancellation() },
        handleCloseCancellationDialog: () => dialogs.setCancelConfirmationVisible(false),
        financials,
        priceDetails,
        setPromoCode,
        applyPromoCode,
        removePromoCode,
        localSelectedAccessories: state.localSelectedAccessories,
        toggleAccessory: stateActions.toggleAccessory,
        holidayConflict: holidayConflict,
        confirmHolidayAdjustment: handleConfirmHolidayAdjustment,
        cancelHolidayAdjustment: () => setHolidayConflict(null),
    };
};

/**
 * ĞšĞ¾Ğ¼Ğ¿Ğ¾Ğ½ĞµĞ½Ñ‚-Ğ¿Ñ€Ğ¾Ğ²Ğ°Ğ¹Ğ´ĞµÑ€, ĞºĞ¾Ñ‚Ğ¾Ñ€Ñ‹Ğ¹ Ğ¾Ğ±Ğ¾Ñ€Ğ°Ñ‡Ğ¸Ğ²Ğ°ĞµÑ‚ Ğ´Ğ¾Ñ‡ĞµÑ€Ğ½Ğ¸Ğµ ĞºĞ¾Ğ¼Ğ¿Ğ¾Ğ½ĞµĞ½Ñ‚Ñ‹
 * Ğ¸ Ğ¿Ñ€ĞµĞ´Ğ¾ÑÑ‚Ğ°Ğ²Ğ»ÑĞµÑ‚ Ğ¸Ğ¼ Ğ´Ğ¾ÑÑ‚ÑƒĞ¿ ĞºĞ¾ Ğ²ÑĞµĞ¹ Ğ»Ğ¾Ğ³Ğ¸ĞºĞµ Ñ€ĞµĞ´Ğ°ĞºÑ‚Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ Ñ‡ĞµÑ€ĞµĞ· Ñ…ÑƒĞº useReservationEditContext.
 */
export const ReservationEditProvider: React.FC<{
    children: React.ReactNode;
    reservation: Reservation;
    initialEquipmentForDisplay: ReadonlyArray<EquipmentDisplayDetail>;
    onFullCancellation?: (() => Promise<void> | void) | undefined;
    isAdminContext?: boolean;
    onFinishEditing: () => void;
}> = (props) => {
    const contextValue = useInlineReservationEditLogic(
        props.reservation,
        props.initialEquipmentForDisplay,
        props.onFullCancellation,
        props.isAdminContext || false,
        props.onFinishEditing
    );

    return (
        <ReservationEditContext.Provider value={contextValue}>
            {props.children}
        </ReservationEditContext.Provider>
    );
};

```


## <a name="rentalappmainsrchooksuseMyRentalsts"></a>`rental-app-main/src/hooks/useMyRentals.ts`

```typescript
// path: rental-app-main/src/hooks/useMyRentals.ts

import { useInfiniteQuery, type QueryFunctionContext } from "@tanstack/react-query";
import { api } from "@/lib/api";
import type { AdminRentalListResponse } from "@/types/rental";
import { useCurrentUser } from "./useProfile";

const MY_RENTALS_KEY = "myRentals";

interface UseMyRentalsParams {
    search?: string;
    status?: string;
    sort?: string;
}

export function useMyRentals(params?: UseMyRentalsParams, limit: number = 10) {
    const { data: user } = useCurrentUser();

    return useInfiniteQuery<AdminRentalListResponse, Error>({
        queryKey: [MY_RENTALS_KEY, params],
        queryFn: async ({ pageParam = 0 }: QueryFunctionContext) => {
            const skip = (pageParam as number) * limit;
            const response = await api.get<AdminRentalListResponse>("/user/rentals", {
                params: { skip, limit, ...params },
            });
            return response.data;
        },
        initialPageParam: 0,
        getNextPageParam: (lastPage, allPages) => {
            const loadedItems = allPages.reduce((acc, page) => acc + page.items.length, 0);
            if (loadedItems < lastPage.total) {
                return allPages.length;
            }
            return undefined;
        },
        enabled: !!user, // Ğ’Ñ‹Ğ¿Ğ¾Ğ»Ğ½ÑÑ‚ÑŒ Ğ·Ğ°Ğ¿Ñ€Ğ¾Ñ Ñ‚Ğ¾Ğ»ÑŒĞºĞ¾ ĞµÑĞ»Ğ¸ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ÑŒ Ğ°Ğ²Ñ‚Ğ¾Ñ€Ğ¸Ğ·Ğ¾Ğ²Ğ°Ğ½
    });
}


```


## <a name="rentalappmainsrchooksuseNetworkStatusts"></a>`rental-app-main/src/hooks/useNetworkStatus.ts`

```typescript
// path: rental-app-main/src/hooks/useNetworkStatus.ts

// src/hooks/useNetworkStatus.ts
import { useEffect, useState } from "react"

/**
 * Ğ¥ÑƒĞº Ğ¾Ñ‚ÑĞ»ĞµĞ¶Ğ¸Ğ²Ğ°ĞµÑ‚ ÑÑ‚Ğ°Ñ‚ÑƒÑ Ğ¿Ğ¾Ğ´ĞºĞ»ÑÑ‡ĞµĞ½Ğ¸Ñ (online/offline).
 * Ğ’Ğ¾Ğ·Ğ²Ñ€Ğ°Ñ‰Ğ°ĞµÑ‚ true â€” ĞµÑĞ»Ğ¸ Ğ² ÑĞµÑ‚Ğ¸, false â€” ĞµÑĞ»Ğ¸ Ğ¾Ñ„Ñ„Ğ»Ğ°Ğ¹Ğ½.
 */
export function useNetworkStatus(): boolean {
    const [isOnline, setIsOnline] = useState(navigator.onLine)

    useEffect(() => {
        const handleOnline = () => setIsOnline(true)
        const handleOffline = () => setIsOnline(false)

        window.addEventListener("online", handleOnline)
        window.addEventListener("offline", handleOffline)

        return () => {
            window.removeEventListener("online", handleOnline)
            window.removeEventListener("offline", handleOffline)
        }
    }, [])

    return isOnline
}


```


## <a name="rentalappmainsrchooksusePhoneValidationts"></a>`rental-app-main/src/hooks/usePhoneValidation.ts`

```typescript
// path: rental-app-main/src/hooks/usePhoneValidation.ts

// src/hooks/usePhoneValidation.ts

import { useState, useCallback } from 'react';
import { PhoneService } from '@/core/services';

interface UsePhoneValidationOptions {
    format?: 'russian' | 'international';
    required?: boolean;
    onValidationChange?: (isValid: boolean) => void;
}

interface UsePhoneValidationReturn {
    isValid: boolean;
    error: string | null;
    validatePhone: (phone: string) => boolean;
    clearError: () => void;
}

/**
 * Ğ¥ÑƒĞº Ğ´Ğ»Ñ Ğ²Ğ°Ğ»Ğ¸Ğ´Ğ°Ñ†Ğ¸Ğ¸ Ñ‚ĞµĞ»ĞµÑ„Ğ¾Ğ½Ğ½Ñ‹Ñ… Ğ½Ğ¾Ğ¼ĞµÑ€Ğ¾Ğ² Ğ² Ñ€ĞµĞ°Ğ»ÑŒĞ½Ğ¾Ğ¼ Ğ²Ñ€ĞµĞ¼ĞµĞ½Ğ¸
 */
export function usePhoneValidation(options: UsePhoneValidationOptions = {}): UsePhoneValidationReturn {
    const {
        format = 'russian',
        required = false,
        onValidationChange
    } = options;

    const [isValid, setIsValid] = useState(false);
    const [error, setError] = useState<string | null>(null);

    const validatePhone = useCallback((phone: string): boolean => {
        // Ğ•ÑĞ»Ğ¸ Ğ¿Ğ¾Ğ»Ğµ Ğ½Ğµ Ğ¾Ğ±ÑĞ·Ğ°Ñ‚ĞµĞ»ÑŒĞ½Ğ¾ Ğ¸ Ğ¿ÑƒÑÑ‚Ğ¾Ğµ, ÑÑ‡Ğ¸Ñ‚Ğ°ĞµĞ¼ Ğ²Ğ°Ğ»Ğ¸Ğ´Ğ½Ñ‹Ğ¼
        if (!required && !phone.trim()) {
            setIsValid(true);
            setError(null);
            onValidationChange?.(true);
            return true;
        }

        // Ğ•ÑĞ»Ğ¸ Ğ¿Ğ¾Ğ»Ğµ Ğ¾Ğ±ÑĞ·Ğ°Ñ‚ĞµĞ»ÑŒĞ½Ğ¾ Ğ¸ Ğ¿ÑƒÑÑ‚Ğ¾Ğµ
        if (required && !phone.trim()) {
            setIsValid(false);
            setError('ĞĞ¾Ğ¼ĞµÑ€ Ñ‚ĞµĞ»ĞµÑ„Ğ¾Ğ½Ğ° Ğ¾Ğ±ÑĞ·Ğ°Ñ‚ĞµĞ»ĞµĞ½');
            onValidationChange?.(false);
            return false;
        }

        // Ğ˜ÑĞ¿Ğ¾Ğ»ÑŒĞ·ÑƒĞµĞ¼ PhoneService Ğ´Ğ»Ñ Ğ²Ğ°Ğ»Ğ¸Ğ´Ğ°Ñ†Ğ¸Ğ¸
        const validationResult = PhoneService.validate(phone);
        
        if (!validationResult.isValid) {
            setIsValid(false);
            setError(validationResult.error || 'ĞĞµĞºĞ¾Ñ€Ñ€ĞµĞºÑ‚Ğ½Ñ‹Ğ¹ Ğ½Ğ¾Ğ¼ĞµÑ€ Ñ‚ĞµĞ»ĞµÑ„Ğ¾Ğ½Ğ°');
            onValidationChange?.(false);
            return false;
        }

        // Ğ’ÑĞµ Ğ¿Ñ€Ğ¾Ğ²ĞµÑ€ĞºĞ¸ Ğ¿Ñ€Ğ¾Ğ¹Ğ´ĞµĞ½Ñ‹
        setIsValid(true);
        setError(null);
        onValidationChange?.(true);
        return true;
    }, [format, required, onValidationChange]);

    const clearError = useCallback(() => {
        setError(null);
    }, []);

    return {
        isValid,
        error,
        validatePhone,
        clearError
    };
}

/**
 * Ğ¥ÑƒĞº Ğ´Ğ»Ñ Ğ²Ğ°Ğ»Ğ¸Ğ´Ğ°Ñ†Ğ¸Ğ¸ Ñ‚ĞµĞ»ĞµÑ„Ğ¾Ğ½Ğ° Ñ debounce
 */
export function usePhoneValidationWithDebounce(
    options: UsePhoneValidationOptions & { debounceMs?: number } = {}
): UsePhoneValidationReturn & { debouncedValidate: (phone: string) => void } {
    const { debounceMs = 500, ...validationOptions } = options;
    const [debounceTimeout, setDebounceTimeout] = useState<NodeJS.Timeout | null>(null);
    
    const baseValidation = usePhoneValidation(validationOptions);

    const debouncedValidate = useCallback((phone: string) => {
        // ĞÑ‡Ğ¸Ñ‰Ğ°ĞµĞ¼ Ğ¿Ñ€ĞµĞ´Ñ‹Ğ´ÑƒÑ‰Ğ¸Ğ¹ Ñ‚Ğ°Ğ¹Ğ¼Ğ°ÑƒÑ‚
        if (debounceTimeout) {
            clearTimeout(debounceTimeout);
        }

        // Ğ£ÑÑ‚Ğ°Ğ½Ğ°Ğ²Ğ»Ğ¸Ğ²Ğ°ĞµĞ¼ Ğ½Ğ¾Ğ²Ñ‹Ğ¹ Ñ‚Ğ°Ğ¹Ğ¼Ğ°ÑƒÑ‚
        const timeout = setTimeout(() => {
            baseValidation.validatePhone(phone);
        }, debounceMs);

        setDebounceTimeout(timeout);
    }, [baseValidation, debounceMs, debounceTimeout]);

    return {
        ...baseValidation,
        debouncedValidate
    };
} 

```


## <a name="rentalappmainsrchooksuseProfilets"></a>`rental-app-main/src/hooks/useProfile.ts`

```typescript
// path: rental-app-main/src/hooks/useProfile.ts

import { useQuery, useMutation, useQueryClient } from "@tanstack/react-query";
import { api } from "@/lib/api";
import type { UserOut } from "@/types/user";
import { handleQueryError } from "@/lib/queryHelpers";

/**
 * Ğ¢Ğ¸Ğ¿ Ğ´Ğ°Ğ½Ğ½Ñ‹Ñ… Ğ´Ğ»Ñ Ğ¾Ğ±Ğ½Ğ¾Ğ²Ğ»ĞµĞ½Ğ¸Ñ Ğ¿Ñ€Ğ¾Ñ„Ğ¸Ğ»Ñ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ñ
 */
type ProfileUpdatePayload = {
    full_name: string;
    email: string;
    phone?: string;
};

/**
 * Ğ¢Ğ¸Ğ¿ Ğ¾ÑˆĞ¸Ğ±ĞºĞ¸ API
 */
type APIError = {
    response?: {
        status?: number;
        data?: {
            detail?: string;
        };
    };
    message?: string;
};

/**
 * Ğ¥ÑƒĞº Ğ´Ğ»Ñ Ğ¿Ğ¾Ğ»ÑƒÑ‡ĞµĞ½Ğ¸Ñ Ğ´Ğ°Ğ½Ğ½Ñ‹Ñ… Ñ‚ĞµĞºÑƒÑ‰ĞµĞ³Ğ¾ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ñ
 * @returns Query Ğ¾Ğ±ÑŠĞµĞºÑ‚ Ñ Ğ´Ğ°Ğ½Ğ½Ñ‹Ğ¼Ğ¸ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ñ
 */
export function useCurrentUser() {
    return useQuery<UserOut | null, Error>({
        queryKey: ["current_user"],
        queryFn: async () => {
            // ĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑĞµĞ¼ Ğ½Ğ°Ğ»Ğ¸Ñ‡Ğ¸Ğµ Ñ‚Ğ¾ĞºĞµĞ½Ğ° Ğ¿ĞµÑ€ĞµĞ´ Ğ·Ğ°Ğ¿Ñ€Ğ¾ÑĞ¾Ğ¼
            const accessToken = localStorage.getItem("access_token");
            if (!accessToken) {
                return null;
            }

            try {
                const res = await api.get<UserOut>("/user/");
                return res.data;
            } catch (error: unknown) {
                const apiError = error as APIError;
                if (apiError.response?.status === 401) {
                    // ĞÑ‡Ğ¸Ñ‰Ğ°ĞµĞ¼ Ğ½ĞµĞ´ĞµĞ¹ÑÑ‚Ğ²Ğ¸Ñ‚ĞµĞ»ÑŒĞ½Ñ‹Ğ¹ Ñ‚Ğ¾ĞºĞµĞ½
                    localStorage.removeItem("access_token");
                    return null;
                }
                console.error("[useCurrentUser] Error fetching user data:", apiError);
                handleQueryError(error);
                throw error;
            }
        },
        staleTime: 1000 * 60 * 10, // ĞºÑÑˆ Ğ½Ğ° 10 Ğ¼Ğ¸Ğ½ÑƒÑ‚
        retry: (failureCount, error) => {
            // ĞĞµ Ğ¿Ğ¾Ğ²Ñ‚Ğ¾Ñ€ÑĞµĞ¼ Ğ·Ğ°Ğ¿Ñ€Ğ¾Ñ Ğ¿Ñ€Ğ¸ 401 Ğ¾ÑˆĞ¸Ğ±ĞºĞµ
            if (error instanceof Error && error.message.includes("401")) {
                return false;
            }
            return failureCount < 3;
        },
        // ĞĞµ Ğ²Ñ‹Ğ¿Ğ¾Ğ»Ğ½ÑĞµĞ¼ Ğ·Ğ°Ğ¿Ñ€Ğ¾Ñ, ĞµÑĞ»Ğ¸ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ÑŒ Ğ½Ğµ Ğ°Ğ²Ñ‚Ğ¾Ñ€Ğ¸Ğ·Ğ¾Ğ²Ğ°Ğ½
        enabled: !!localStorage.getItem("access_token"),
    });
}

/**
 * Ğ¥ÑƒĞº Ğ´Ğ»Ñ Ğ¾Ğ±Ğ½Ğ¾Ğ²Ğ»ĞµĞ½Ğ¸Ñ Ğ´Ğ°Ğ½Ğ½Ñ‹Ñ… Ğ¿Ñ€Ğ¾Ñ„Ğ¸Ğ»Ñ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ñ
 * @returns Mutation Ğ¾Ğ±ÑŠĞµĞºÑ‚ Ğ´Ğ»Ñ Ğ¾Ğ±Ğ½Ğ¾Ğ²Ğ»ĞµĞ½Ğ¸Ñ Ğ¿Ñ€Ğ¾Ñ„Ğ¸Ğ»Ñ
 */
export function useProfileUpdate() {
    const queryClient = useQueryClient();

    return useMutation<void, Error, ProfileUpdatePayload>({
        mutationFn: async (data: ProfileUpdatePayload) => {
            try {
                await api.put("/user/", data);
            } catch (error: unknown) {
                console.error("[useProfileUpdate] Error updating profile:", error);
                handleQueryError(error);
                throw error;
            }
        },
        onSuccess: () => {
            queryClient.invalidateQueries({ queryKey: ["current_user"] });
        },
        onError: (error: Error) => {
            console.error("[useProfileUpdate] Mutation error:", error);
        },
    });
}


```


## <a name="rentalappmainsrchooksuseReservationManagementts"></a>`rental-app-main/src/hooks/useReservationManagement.ts`

```typescript
// path: rental-app-main/src/hooks/useReservationManagement.ts

// src/hooks/useReservationManagement.ts

import { useEffect, useMemo } from 'react';
import { useLocation } from 'react-router-dom';
import { useReserveStore } from '@/store/reserveStore';
import type { Equipment } from '@/types/equipment';
import type { AvailabilityInfo, EquipmentStatus } from '@/types/availability';

type UseReservationManagementReturn = {
    editingReservationId: number | null;
    intent: string | null;
    getEquipmentStatus: (eq: Equipment) => EquipmentStatus | "my_reservation" | "added";
};

export function useReservationManagement(
    filteredItems: Equipment[],
    availabilityMap: Record<number, AvailabilityInfo>,
    availableOnly: boolean
): UseReservationManagementReturn {
    const location = useLocation();
    const { items: selectedItems, addToReservationMode } = useReserveStore();

    const editingReservationEquipmentIds = useMemo(() => {
        if (location.state?.intent === "add_to_reservation" && location.state?.reservationId) {
            return new Set(location.state?.equipmentIds || []);
        }
        return new Set<number>();
    }, [location.state]);

    useEffect(() => {
        const intent = location.state?.intent;
        const reservationIdFromLocation = location.state?.reservationId;
        const storeActions = useReserveStore.getState();

        if (intent === "add_to_reservation" && reservationIdFromLocation) {
            if (storeActions.addToReservationMode !== reservationIdFromLocation) {
                storeActions.clear();
                storeActions.setAddToReservationMode(reservationIdFromLocation);
            }
        } else if (intent === "add_to_new_reservation") {
            if (storeActions.addToReservationMode !== null) {
                storeActions.clear();
            }
        } else {
            if (storeActions.addToReservationMode !== null) {
                storeActions.clear();
            }
        }
    }, [location.state]);

    // availabilityMap Ñ‚ĞµĞ¿ĞµÑ€ÑŒ Ğ¿ĞµÑ€ĞµĞ´Ğ°ĞµÑ‚ÑÑ ĞºĞ°Ğº Ğ¿Ğ°Ñ€Ğ°Ğ¼ĞµÑ‚Ñ€, Ğ½Ğµ Ğ½ÑƒĞ¶Ğ½Ğ¾ ÑĞ¾Ğ·Ğ´Ğ°Ğ²Ğ°Ñ‚ÑŒ ĞµĞ³Ğ¾ Ğ·Ğ´ĞµÑÑŒ


    const getEquipmentStatus = (eq: Equipment): EquipmentStatus | "my_reservation" | "added" => {
        if (location.state?.intent === "add_to_reservation" && location.state?.reservationId === addToReservationMode) {
            if (editingReservationEquipmentIds.has(eq.id)) {
                return "my_reservation";
            }
            if (selectedItems.some(i => i.id === eq.id)) {
                return "added";
            }
        }

        const itemAvailability = availabilityMap[eq.id];

        // --- ĞĞĞ§ĞĞ›Ğ Ğ˜Ğ—ĞœĞ•ĞĞ•ĞĞ˜Ğ™ (Ğ’ĞĞ—Ğ’Ğ ĞĞ©ĞĞ•Ğœ ĞšĞĞš Ğ‘Ğ«Ğ›Ğ) ---
        // Ğ¢ĞµĞ¿ĞµÑ€ÑŒ Ğ±ÑĞºĞµĞ½Ğ´ ÑĞ°Ğ¼ Ğ¾Ñ‚Ğ´Ğ°ĞµÑ‚ Ğ¿Ñ€Ğ°Ğ²Ğ¸Ğ»ÑŒĞ½Ñ‹Ğ¹ ÑÑ‚Ğ°Ñ‚ÑƒÑ, Ğ½Ğ°Ğ¼ Ğ½Ğµ Ğ½ÑƒĞ¶Ğ½Ğ° Ğ´Ğ¾Ğ¿Ğ¾Ğ»Ğ½Ğ¸Ñ‚ĞµĞ»ÑŒĞ½Ğ°Ñ Ğ»Ğ¾Ğ³Ğ¸ĞºĞ°
        return itemAvailability?.status ?? "available";
        // --- ĞšĞĞĞ•Ğ¦ Ğ˜Ğ—ĞœĞ•ĞĞ•ĞĞ˜Ğ™ ---
    };

    return {
        editingReservationId: location.state?.reservationId ?? null,
        intent: location.state?.intent ?? null,
        getEquipmentStatus
    };
}

```


## <a name="rentalappmainsrchooksuseReservationsts"></a>`rental-app-main/src/hooks/useReservations.ts`

```typescript
// path: rental-app-main/src/hooks/useReservations.ts

// src/hooks/useReservations.ts

import { useQuery, useMutation, useQueryClient } from "@tanstack/react-query";
import { ReservationService, type ReservationCreateInput } from "@/core/services/ReservationService";
import type { Reservation } from "@/types/reservation";
import { handleQueryError } from "@/lib/queryHelpers";
import { useCurrentUser } from "./useProfile";
import { toast } from "sonner";
import { transformAccessoryLinks } from "@/lib/utils";

const RESERVATIONS_KEY = ["reservations"];

const invalidateReservationQueries = (queryClient: ReturnType<typeof useQueryClient>) => {
    void queryClient.invalidateQueries({ queryKey: RESERVATIONS_KEY });
    void queryClient.invalidateQueries({ queryKey: ["availability"] });
    void queryClient.invalidateQueries({ queryKey: ["calendar-grid"] });
};

const handleMutationError = (error: unknown, contextMessage: string) => {
    console.error(`[useReservations] Error on ${contextMessage}:`, error);
    const apiError = error as { response?: { data?: { detail?: any } } };
    const detail = apiError.response?.data?.detail;
    let message = `ĞÑˆĞ¸Ğ±ĞºĞ°: ${contextMessage}`;

    if (typeof detail === 'string') {
        message = detail;
    } else if (typeof detail?.message === 'string') {
        message = detail.message;
    }

    toast.error(message);

    if (detail?.unavailable_ids) {
        const errorToThrow = new Error(message);
        (errorToThrow as any).unavailable_ids = detail.unavailable_ids;
        throw errorToThrow;
    }
};

interface UseReservationsParams {
    search?: string;
    status?: string;
    sort?: string;
}

export function useReservations(params?: UseReservationsParams) {
    const queryClient = useQueryClient();
    const { data: user } = useCurrentUser();

    const reservationsQuery = useQuery<Reservation[], Error>({
        queryKey: [...RESERVATIONS_KEY, params],
        queryFn: async (): Promise<Reservation[]> => {
            try {
                return await ReservationService.getUserReservations(params);
            } catch (error) {
                handleQueryError(error);
                throw error;
            }
        },
        enabled: !!user,
        staleTime: 5 * 60 * 1000,
        select: (data) => data.map(transformAccessoryLinks),
    });

    const createReservation = useMutation({
        mutationFn: (data: ReservationCreateInput) => ReservationService.createReservation(data),
        onSuccess: () => {
            invalidateReservationQueries(queryClient);
        },
        onError: (error) => handleMutationError(error, "Ğ½Ğµ ÑƒĞ´Ğ°Ğ»Ğ¾ÑÑŒ ÑĞ¾Ğ·Ğ´Ğ°Ñ‚ÑŒ Ñ€ĞµĞ·ĞµÑ€Ğ²")
    });

    const updateReservation = useMutation({
        mutationFn: (data: any) => ReservationService.updateReservation(data),
        onSuccess: () => {
            invalidateReservationQueries(queryClient);
            toast.success("Ğ ĞµĞ·ĞµÑ€Ğ² ÑƒÑĞ¿ĞµÑˆĞ½Ğ¾ Ğ¾Ğ±Ğ½Ğ¾Ğ²Ğ»ĞµĞ½!");
        },
        onError: (error) => handleMutationError(error, "Ğ½Ğµ ÑƒĞ´Ğ°Ğ»Ğ¾ÑÑŒ Ğ¾Ğ±Ğ½Ğ¾Ğ²Ğ¸Ñ‚ÑŒ Ñ€ĞµĞ·ĞµÑ€Ğ²")
    });

    const deleteReservation = useMutation({
        mutationFn: (id: number) => ReservationService.cancelReservation(id),
        onSuccess: () => {
            invalidateReservationQueries(queryClient);
            toast.success("Ğ ĞµĞ·ĞµÑ€Ğ² ÑƒÑĞ¿ĞµÑˆĞ½Ğ¾ ÑƒĞ´Ğ°Ğ»ĞµĞ½!");
        },
        onError: (error) => handleMutationError(error, "Ğ½Ğµ ÑƒĞ´Ğ°Ğ»Ğ¾ÑÑŒ ÑƒĞ´Ğ°Ğ»Ğ¸Ñ‚ÑŒ Ñ€ĞµĞ·ĞµÑ€Ğ²")
    });

    return {
        reservationsQuery,
        createReservation,
        updateReservation,
        deleteReservation,
    };
}

```


## <a name="rentalappmainsrchooksuseUpdateEquipmentDetailsts"></a>`rental-app-main/src/hooks/useUpdateEquipmentDetails.ts`

```typescript
// path: rental-app-main/src/hooks/useUpdateEquipmentDetails.ts

// src/hooks/useUpdateEquipmentDetails.ts
import { useMutation, useQueryClient } from "@tanstack/react-query";
import { toast } from "sonner";
import { api } from "@/lib/api";
import type { Equipment } from "@/types/equipment";
import type { EquipmentUpdateExtendedSchema } from "@/lib/validationSchemas";

interface UpdateEquipmentPayload {
    id: number;
    data: EquipmentUpdateExtendedSchema;
}

export function useUpdateEquipmentDetails() {
    const queryClient = useQueryClient();

    return useMutation<Equipment, Error, UpdateEquipmentPayload>({
        mutationFn: async ({ id, data }) => {
            const payload: Record<string, string | number | boolean | string[] | number[] | null> = {};
            for (const key in data) {
                if (Object.prototype.hasOwnProperty.call(data, key)) {
                    const typedKey = key as keyof EquipmentUpdateExtendedSchema;
                    if (data[typedKey] !== undefined) {
                        payload[typedKey] = data[typedKey];
                    }
                }
            }
            const response = await api.put<Equipment>(`/equipment/${id}`, payload);
            return response.data;
        },
        onSuccess: async (updatedEquipment, variables) => { // <--- Ğ”Ğ¾Ğ±Ğ°Ğ²Ğ»ĞµĞ½ async
            toast.success(`ĞĞ±Ğ¾Ñ€ÑƒĞ´Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ "${updatedEquipment.name}" ÑƒÑĞ¿ĞµÑˆĞ½Ğ¾ Ğ¾Ğ±Ğ½Ğ¾Ğ²Ğ»ĞµĞ½Ğ¾!`);

            // Ğ˜Ğ½Ğ²Ğ°Ğ»Ğ¸Ğ´Ğ°Ñ†Ğ¸Ñ Ğ¸ Ğ¾Ğ±Ğ½Ğ¾Ğ²Ğ»ĞµĞ½Ğ¸Ğµ ĞºÑÑˆĞ°
            // 1. Ğ˜Ğ½Ğ²Ğ°Ğ»Ğ¸Ğ´Ğ¸Ñ€ÑƒĞµĞ¼ Ğ¾Ğ±Ñ‰Ğ¸Ğ¹ ÑĞ¿Ğ¸ÑĞ¾Ğº Ğ¾Ğ±Ğ¾Ñ€ÑƒĞ´Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ
            await queryClient.invalidateQueries({ queryKey: ["equipment"] }); // <--- Ğ”Ğ¾Ğ±Ğ°Ğ²Ğ»ĞµĞ½ await

            // 2. ĞœĞ¾Ğ¶Ğ½Ğ¾ Ñ‚Ğ°ĞºĞ¶Ğµ Ñ‚Ğ¾Ñ‡ĞµÑ‡Ğ½Ğ¾ Ğ¾Ğ±Ğ½Ğ¾Ğ²Ğ¸Ñ‚ÑŒ ĞºÑÑˆ Ğ´Ğ»Ñ ÑÑ‚Ğ¾Ğ³Ğ¾ ĞºĞ¾Ğ½ĞºÑ€ĞµÑ‚Ğ½Ğ¾Ğ³Ğ¾ ÑĞ»ĞµĞ¼ĞµĞ½Ñ‚Ğ°,
            // ĞµÑĞ»Ğ¸ Ğ¾Ğ½ Ğ³Ğ´Ğµ-Ñ‚Ğ¾ Ğ·Ğ°Ğ¿Ñ€Ğ°ÑˆĞ¸Ğ²Ğ°ĞµÑ‚ÑÑ Ğ¿Ğ¾ Ğ¾Ñ‚Ğ´ĞµĞ»ÑŒĞ½Ğ¾Ğ¼Ñƒ ĞºĞ»ÑÑ‡Ñƒ (Ğ½Ğ°Ğ¿Ñ€Ğ¸Ğ¼ĞµÑ€, ["equipment", variables.id])
            // await queryClient.setQueryData(["equipment", variables.id], updatedEquipment); // <--- Ğ”Ğ¾Ğ±Ğ°Ğ²Ğ»ĞµĞ½ await, ĞµÑĞ»Ğ¸ Ğ¸ÑĞ¿Ğ¾Ğ»ÑŒĞ·ÑƒĞµÑ‚ÑÑ

            queryClient.setQueryData<Equipment[]>(["equipment"], (oldData) =>
                oldData?.map((item) =>
                    item.id === variables.id ? { ...item, ...updatedEquipment } : item
                ) ?? []
            );

            // 4. Ğ˜Ğ½Ğ²Ğ°Ğ»Ğ¸Ğ´Ğ¸Ñ€ÑƒĞµĞ¼ Ğ´Ğ°Ğ½Ğ½Ñ‹Ğµ Ğ¾ Ğ´Ğ¾ÑÑ‚ÑƒĞ¿Ğ½Ğ¾ÑÑ‚Ğ¸
            await queryClient.invalidateQueries({ queryKey: ["availability"] }); // <--- Ğ”Ğ¾Ğ±Ğ°Ğ²Ğ»ĞµĞ½ await
            await queryClient.invalidateQueries({ queryKey: ["calendar-grid"] }); // <--- Ğ”Ğ¾Ğ±Ğ°Ğ²Ğ»ĞµĞ½ await
            await queryClient.invalidateQueries({ queryKey: ["calendar-events"] }); // <--- Ğ”Ğ¾Ğ±Ğ°Ğ²Ğ»ĞµĞ½ await
        },
        onError: (error) => {
            toast.error(`ĞÑˆĞ¸Ğ±ĞºĞ° Ğ¿Ñ€Ğ¸ Ğ¾Ğ±Ğ½Ğ¾Ğ²Ğ»ĞµĞ½Ğ¸Ğ¸ Ğ¾Ğ±Ğ¾Ñ€ÑƒĞ´Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ: ${error.message}`);
            console.error("ĞÑˆĞ¸Ğ±ĞºĞ° Ğ¿Ñ€Ğ¸ Ğ¾Ğ±Ğ½Ğ¾Ğ²Ğ»ĞµĞ½Ğ¸Ğ¸ Ğ¾Ğ±Ğ¾Ñ€ÑƒĞ´Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ:", error);
        },
    });
}

```


## <a name="rentalappmainsrchooksuseVisibleItemsts"></a>`rental-app-main/src/hooks/useVisibleItems.ts`

```typescript
// path: rental-app-main/src/hooks/useVisibleItems.ts

import { useState, useEffect } from 'react';

/**
 * Ğ£Ğ¿Ñ€Ğ°Ğ²Ğ»ÑĞµÑ‚ ĞºĞ¾Ğ»Ğ¸Ñ‡ĞµÑÑ‚Ğ²Ğ¾Ğ¼ Ğ²Ğ¸Ğ´Ğ¸Ğ¼Ñ‹Ñ… ÑĞ»ĞµĞ¼ĞµĞ½Ñ‚Ğ¾Ğ² Ğ² ÑĞ¿Ğ¸ÑĞºĞµ Ñ ÑƒÑ‡ĞµÑ‚Ğ¾Ğ¼ Ñ„Ğ¸Ğ»ÑŒÑ‚Ñ€Ğ°Ñ†Ğ¸Ğ¸.
 * @param totalCount ĞĞ±Ñ‰ĞµĞµ ĞºĞ¾Ğ»Ğ¸Ñ‡ĞµÑÑ‚Ğ²Ğ¾ ÑĞ»ĞµĞ¼ĞµĞ½Ñ‚Ğ¾Ğ² Ğ² Ğ¾Ñ‚Ñ„Ğ¸Ğ»ÑŒÑ‚Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ½Ğ¾Ğ¼ ÑĞ¿Ğ¸ÑĞºĞµ.
 */
export function useVisibleItems(totalCount: number) {
    // `intendedSize` â€” ÑÑ‚Ğ¾ ĞºĞ¾Ğ»Ğ¸Ñ‡ĞµÑÑ‚Ğ²Ğ¾ ÑĞ»ĞµĞ¼ĞµĞ½Ñ‚Ğ¾Ğ², ĞºĞ¾Ñ‚Ğ¾Ñ€Ğ¾Ğµ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ÑŒ *Ñ…Ğ¾Ñ‡ĞµÑ‚* Ğ²Ğ¸Ğ´ĞµÑ‚ÑŒ (Ğ½Ğ°Ğ¿Ñ€Ğ¸Ğ¼ĞµÑ€, Ğ¿Ğ¾ÑĞ»Ğµ Ğ½Ğ°Ğ¶Ğ°Ñ‚Ğ¸Ñ ĞºĞ½Ğ¾Ğ¿ĞºĞ¸ "24").
    const [intendedSize, setIntendedSize] = useState(12);

    // `visibleCount` â€” ÑÑ‚Ğ¾ Ñ„Ğ°ĞºÑ‚Ğ¸Ñ‡ĞµÑĞºĞ¾Ğµ ĞºĞ¾Ğ»Ğ¸Ñ‡ĞµÑÑ‚Ğ²Ğ¾ ÑĞ»ĞµĞ¼ĞµĞ½Ñ‚Ğ¾Ğ² Ğ´Ğ»Ñ Ğ¾Ñ‚Ğ¾Ğ±Ñ€Ğ°Ğ¶ĞµĞ½Ğ¸Ñ, Ğ¾Ğ³Ñ€Ğ°Ğ½Ğ¸Ñ‡ĞµĞ½Ğ½Ğ¾Ğµ `totalCount`.
    const [visibleCount, setVisibleCount] = useState(12);

    // `increaseVisibleCount` Ğ¾Ğ±Ğ½Ğ¾Ğ²Ğ»ÑĞµÑ‚ Ğ½Ğ°Ğ¼ĞµÑ€ĞµĞ½Ğ¸Ğµ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ñ ÑƒĞ²Ğ¸Ğ´ĞµÑ‚ÑŒ Ğ±Ğ¾Ğ»ÑŒÑˆĞµ ÑĞ»ĞµĞ¼ĞµĞ½Ñ‚Ğ¾Ğ².
    const increaseVisibleCount = (step: number = 12) => {
        setIntendedSize((prev) => prev + step);
    };

    // `setVisibility` (Ğ¿ĞµÑ€ĞµĞ¸Ğ¼ĞµĞ½Ğ¾Ğ²Ğ°Ğ½Ğ° Ğ´Ğ»Ñ ÑÑĞ½Ğ¾ÑÑ‚Ğ¸ Ğ² `setIntendedSize`) Ğ²Ñ‹Ğ·Ñ‹Ğ²Ğ°ĞµÑ‚ÑÑ ĞºĞ½Ğ¾Ğ¿ĞºĞ°Ğ¼Ğ¸ "12", "24", Ğ¸ Ñ‚.Ğ´.
    const setVisibility = (count: number) => {
        setIntendedSize(count);
    };

    // Ğ­Ñ‚Ğ¾Ñ‚ useEffect ÑĞ¸Ğ½Ñ…Ñ€Ğ¾Ğ½Ğ¸Ğ·Ğ¸Ñ€ÑƒĞµÑ‚ Ñ„Ğ°ĞºÑ‚Ğ¸Ñ‡ĞµÑĞºĞ¾Ğµ ĞºĞ¾Ğ»Ğ¸Ñ‡ĞµÑÑ‚Ğ²Ğ¾ Ğ²Ğ¸Ğ´Ğ¸Ğ¼Ñ‹Ñ… ÑĞ»ĞµĞ¼ĞµĞ½Ñ‚Ğ¾Ğ².
    // ĞĞ½ ÑÑ€Ğ°Ğ±Ğ°Ñ‚Ñ‹Ğ²Ğ°ĞµÑ‚, ĞºĞ¾Ğ³Ğ´Ğ° Ğ¼ĞµĞ½ÑĞµÑ‚ÑÑ Ğ»Ğ¸Ğ±Ğ¾ Ğ½Ğ°Ğ¼ĞµÑ€ĞµĞ½Ğ¸Ğµ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ñ (`intendedSize`), Ğ»Ğ¸Ğ±Ğ¾ Ğ¾Ğ±Ñ‰ĞµĞµ ĞºĞ¾Ğ»Ğ¸Ñ‡ĞµÑÑ‚Ğ²Ğ¾ ÑĞ»ĞµĞ¼ĞµĞ½Ñ‚Ğ¾Ğ² (`totalCount`).
    useEffect(() => {
        // Ğ•ÑĞ»Ğ¸ Ğ¾Ğ±Ñ‰ĞµĞµ ĞºĞ¾Ğ»Ğ¸Ñ‡ĞµÑÑ‚Ğ²Ğ¾ Ñ€Ğ°Ğ²Ğ½Ğ¾ 0, Ğ½Ğ¸Ñ‡ĞµĞ³Ğ¾ Ğ½Ğµ Ğ¿Ğ¾ĞºĞ°Ğ·Ñ‹Ğ²Ğ°ĞµĞ¼.
        if (totalCount === 0) {
            setVisibleCount(0);
        } else {
            // Ğ’ Ğ¾ÑÑ‚Ğ°Ğ»ÑŒĞ½Ñ‹Ñ… ÑĞ»ÑƒÑ‡Ğ°ÑÑ… Ğ¿Ğ¾ĞºĞ°Ğ·Ñ‹Ğ²Ğ°ĞµĞ¼ Ğ¼ĞµĞ½ÑŒÑˆĞµĞµ Ğ¸Ğ· Ğ´Ğ²ÑƒÑ…:
            // Ğ»Ğ¸Ğ±Ğ¾ ÑĞºĞ¾Ğ»ÑŒĞºĞ¾ Ñ…Ğ¾Ñ‡ĞµÑ‚ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ÑŒ, Ğ»Ğ¸Ğ±Ğ¾ ÑĞºĞ¾Ğ»ÑŒĞºĞ¾ ĞµÑÑ‚ÑŒ Ğ²ÑĞµĞ³Ğ¾.
            setVisibleCount(Math.min(intendedSize, totalCount));
        }
    }, [intendedSize, totalCount]);

    return { visibleCount, setVisibleCount: setVisibility, increaseVisibleCount };
}

```


## <a name="rentalappmainsrcindexcss"></a>`rental-app-main/src/index.css`

```css
// path: rental-app-main/src/index.css

@tailwind base;
@tailwind components;
@tailwind utilities;

/* Ğ‘Ğ°Ğ·Ğ¾Ğ²Ñ‹Ğµ ÑÑ‚Ğ¸Ğ»Ğ¸ html/body */
html,
body {
  margin: 0;
  padding: 0;
  min-height: 100vh;
  background-color: #f9fafb; /* Tailwind gray-50 */
  color: #111827; /* Tailwind gray-900 */
  font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI",
  Roboto, Helvetica, Arial, sans-serif;
  line-height: 1.5;
  -webkit-font-smoothing: antialiased;
}

a {
  color: inherit;
  text-decoration: none;
}

button {
  cursor: pointer;
  font-family: inherit;
}


@layer base {
  :root {
    --background: 0 0% 100%;
    --foreground: 0 0% 3.9%;
    --card: 0 0% 100%;
    --card-foreground: 0 0% 3.9%;
    --popover: 0 0% 100%;
    --popover-foreground: 0 0% 3.9%;
    --primary: 0 0% 9%;
    --primary-foreground: 0 0% 98%;
    --secondary: 0 0% 96.1%;
    --secondary-foreground: 0 0% 9%;
    --muted: 0 0% 96.1%;
    --muted-foreground: 0 0% 45.1%;
    --accent: 0 0% 96.1%;
    --accent-foreground: 0 0% 9%;
    --destructive: 0 84.2% 60.2%;
    --destructive-foreground: 0 0% 98%;
    --border: 0 0% 89.8%;
    --input: 0 0% 89.8%;
    --ring: 0 0% 3.9%;
    --chart-1: 12 76% 61%;
    --chart-2: 173 58% 39%;
    --chart-3: 197 37% 24%;
    --chart-4: 43 74% 66%;
    --chart-5: 27 87% 67%;
    --radius: 0.5rem;
  }
  .dark {
    --background: 0 0% 3.9%;
    --foreground: 0 0% 98%;
    --card: 0 0% 3.9%;
    --card-foreground: 0 0% 98%;
    --popover: 0 0% 3.9%;
    --popover-foreground: 0 0% 98%;
    --primary: 0 0% 98%;
    --primary-foreground: 0 0% 9%;
    --secondary: 0 0% 14.9%;
    --secondary-foreground: 0 0% 98%;
    --muted: 0 0% 14.9%;
    --muted-foreground: 0 0% 63.9%;
    --accent: 0 0% 14.9%;
    --accent-foreground: 0 0% 98%;
    --destructive: 0 62.8% 30.6%;
    --destructive-foreground: 0 0% 98%;
    --border: 0 0% 14.9%;
    --input: 0 0% 14.9%;
    --ring: 0 0% 83.1%;
    --chart-1: 220 70% 50%;
    --chart-2: 160 60% 45%;
    --chart-3: 30 80% 55%;
    --chart-4: 280 65% 60%;
    --chart-5: 340 75% 55%;
  }
}

@layer base {
  * {
    @apply border-border;
  }
  body {
    @apply bg-background text-foreground;
  }
}

/* ĞŸĞ¾Ğ´ÑĞ²ĞµÑ‚ĞºĞ° Ğ²ĞµÑ€Ñ‚Ğ¸ĞºĞ°Ğ»ÑŒĞ½Ğ¾Ğ³Ğ¾ ÑÑ‚Ğ¾Ğ»Ğ±Ñ†Ğ° "Ğ¡ĞµĞ³Ğ¾Ğ´Ğ½Ñ" */
.today-column {
  box-shadow: inset -1px 0 0 0 rgba(59, 130, 246, 0.5),
    /* sky-500 */ inset 1px 0 0 0 rgba(59, 130, 246, 0.5);
}

/* === Ğ¡Ğ¢Ğ˜Ğ›Ğ˜ Ğ”Ğ›Ğ¯ REACT-DAY-PICKER === */
/* Ğ£Ğ´Ğ°Ğ»ÑĞµĞ¼ ÑÑ‚Ğ°Ñ€Ñ‹Ğ¹ Ğ±Ğ»Ğ¾Ğº ÑÑ‚Ğ¸Ğ»ĞµĞ¹ Ğ¸ Ğ·Ğ°Ğ¼ĞµĞ½ÑĞµĞ¼ ĞµĞ³Ğ¾ Ğ½Ğ° ÑÑ‚Ğ¾Ñ‚ */
@layer components {
  .day-range-start {
    @apply rounded-r-none;
  }
  .day-range-end {
    @apply rounded-l-none;
  }
  .day-outside {
    @apply text-muted-foreground opacity-50;
  }
}

/* Ğ’ ÑĞ°Ğ¼Ñ‹Ğ¹ ĞºĞ¾Ğ½ĞµÑ† Ñ„Ğ°Ğ¹Ğ»Ğ° src/index.css */

.super-test-border {
  border: 10px dashed lime !important;
}


@layer components {
  /* Ğ‘Ğ°Ğ·Ğ¾Ğ²Ñ‹Ğ¹ ÑÑ‚Ğ¸Ğ»ÑŒ Ğ´Ğ»Ñ Ğ²Ñ‹Ğ±Ñ€Ğ°Ğ½Ğ½Ğ¾Ğ³Ğ¾ Ğ´Ğ½Ñ (ĞºÑ€ÑƒĞ¶Ğ¾Ğº) */
  .day-selected {
    @apply bg-sky-600 text-white hover:bg-sky-700 focus:bg-sky-700 rounded-full;
  }

  /* ĞĞ°Ñ‡Ğ°Ğ»Ğ¾ Ğ´Ğ¸Ğ°Ğ¿Ğ°Ğ·Ğ¾Ğ½Ğ° - ÑĞºÑ€ÑƒĞ³Ğ»ĞµĞ½Ğ¸Ğµ Ñ‚Ğ¾Ğ»ÑŒĞºĞ¾ ÑĞ»ĞµĞ²Ğ° */
  .day-range-start {
    @apply rounded-r-none;
  }

  /* ĞšĞ¾Ğ½ĞµÑ† Ğ´Ğ¸Ğ°Ğ¿Ğ°Ğ·Ğ¾Ğ½Ğ° - ÑĞºÑ€ÑƒĞ³Ğ»ĞµĞ½Ğ¸Ğµ Ñ‚Ğ¾Ğ»ÑŒĞºĞ¾ ÑĞ¿Ñ€Ğ°Ğ²Ğ° */
  .day-range-end {
    @apply rounded-l-none;
  }

  /* Ğ”Ğ½Ğ¸ Ğ² ÑĞµÑ€ĞµĞ´Ğ¸Ğ½Ğµ Ğ´Ğ¸Ğ°Ğ¿Ğ°Ğ·Ğ¾Ğ½Ğ° - ÑƒĞ±Ğ¸Ñ€Ğ°ĞµĞ¼ ÑĞºÑ€ÑƒĞ³Ğ»ĞµĞ½Ğ¸Ğµ Ğ¸ Ğ´Ğ¾Ğ±Ğ°Ğ²Ğ»ÑĞµĞ¼ Ñ„Ğ¾Ğ½ */
  .day-range-middle {
    @apply bg-sky-100 text-gray-800 rounded-none hover:bg-sky-200;
  }
}




```


## <a name="rentalappmainsrclibapits"></a>`rental-app-main/src/lib/api.ts`

```typescript
// path: rental-app-main/src/lib/api.ts

import axios from "axios"

// Ğ’ÑĞ¿Ğ¾Ğ¼Ğ¾Ğ³Ğ°Ñ‚ĞµĞ»ÑŒĞ½Ğ°Ñ Ñ„ÑƒĞ½ĞºÑ†Ğ¸Ñ Ğ´Ğ»Ñ Ğ¿Ğ¾Ğ»ÑƒÑ‡ĞµĞ½Ğ¸Ñ Ğ·Ğ½Ğ°Ñ‡ĞµĞ½Ğ¸Ñ cookie Ğ¿Ğ¾ Ğ¸Ğ¼ĞµĞ½Ğ¸
function getCookie(name: string): string | null {
  const match = document.cookie.match(new RegExp('(^| )' + name + '=([^;]+)'));
  if (match) {
    return match[2];
  }
  return null;
}

export const api = axios.create({
  baseURL: "/api",
})

// Interceptor Ğ´Ğ»Ñ Ğ¾Ğ±Ñ€Ğ°Ğ±Ğ¾Ñ‚ĞºĞ¸ Ğ¾Ñ‚Ğ²ĞµÑ‚Ğ¾Ğ²
api.interceptors.response.use(
  (response) => response,
  (error) => {
    // Ğ•ÑĞ»Ğ¸ Ğ¿Ğ¾Ğ»ÑƒÑ‡Ğ°ĞµĞ¼ 401 Ğ¾ÑˆĞ¸Ğ±ĞºÑƒ, Ğ¾Ñ‡Ğ¸Ñ‰Ğ°ĞµĞ¼ Ñ‚Ğ¾ĞºĞµĞ½
    if (error.response?.status === 401) {
      localStorage.removeItem("access_token");
    }
    return Promise.reject(error);
  }
)

// Interceptor Ğ´Ğ»Ñ Ğ´Ğ¾Ğ±Ğ°Ğ²Ğ»ĞµĞ½Ğ¸Ñ Ñ‚Ğ¾ĞºĞµĞ½Ğ¾Ğ² (Authorization Ğ¸ CSRF)
api.interceptors.request.use(
    (config) => {
      // 1. Ğ”Ğ¾Ğ±Ğ°Ğ²Ğ»ÑĞµĞ¼ Authorization: Bearer <token>
      const accessToken = localStorage.getItem("access_token") // [cite: 1]
      if (accessToken) {
        config.headers.Authorization = `Bearer ${accessToken}` // [cite: 1]
      }

      // 2. Ğ”Ğ¾Ğ±Ğ°Ğ²Ğ»ÑĞµĞ¼ CSRF-Ñ‚Ğ¾ĞºĞµĞ½
      // Ğ‘ÑĞºĞµĞ½Ğ´ (fastapi-csrf-protect) Ğ¾Ğ±Ñ‹Ñ‡Ğ½Ğ¾ ÑƒÑÑ‚Ğ°Ğ½Ğ°Ğ²Ğ»Ğ¸Ğ²Ğ°ĞµÑ‚ CSRF-Ñ‚Ğ¾ĞºĞµĞ½ Ğ² cookie
      // Ñ Ğ¸Ğ¼ĞµĞ½ĞµĞ¼ 'fastapi-csrf-token'. Ğ¤Ñ€Ğ¾Ğ½Ñ‚ĞµĞ½Ğ´ Ğ´Ğ¾Ğ»Ğ¶ĞµĞ½ Ğ¿Ñ€Ğ¾Ñ‡Ğ¸Ñ‚Ğ°Ñ‚ÑŒ ĞµĞ³Ğ¾
      // Ğ¸ Ğ¾Ñ‚Ğ¿Ñ€Ğ°Ğ²Ğ¸Ñ‚ÑŒ Ğ² Ğ·Ğ°Ğ³Ğ¾Ğ»Ğ¾Ğ²ĞºĞµ 'X-CSRF-Token'.
      // Ğ­Ñ‚Ğ¾ Ğ½ÑƒĞ¶Ğ½Ğ¾ Ğ´Ğ»Ñ Ğ¼ĞµÑ‚Ğ¾Ğ´Ğ¾Ğ², Ğ¸Ğ·Ğ¼ĞµĞ½ÑÑÑ‰Ğ¸Ñ… ÑĞ¾ÑÑ‚Ğ¾ÑĞ½Ğ¸Ğµ (POST, PUT, DELETE, PATCH).
      const csrfToken = getCookie("fastapi-csrf-token") // Ğ˜Ğ¼Ñ cookie Ğ¾Ñ‚ fastapi-csrf-protect
      if (csrfToken) {
        config.headers["X-CSRF-Token"] = csrfToken
      }

      // Ğ›Ğ¾Ğ³Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ Ğ´Ğ»Ñ Ğ¾Ñ‚Ğ»Ğ°Ğ´ĞºĞ¸ (Ğ¼Ğ¾Ğ¶Ğ½Ğ¾ ÑƒĞ±Ñ€Ğ°Ñ‚ÑŒ Ğ² production)
      // console.log("Request Config:", config.method?.toUpperCase(), config.url, config.headers);

      return config
    },
    (error) => {
      // ĞĞ±Ñ€Ğ°Ğ±Ğ¾Ñ‚ĞºĞ° Ğ¾ÑˆĞ¸Ğ±Ğ¾Ğº Ğ·Ğ°Ğ¿Ñ€Ğ¾ÑĞ° (ĞµÑĞ»Ğ¸ Ğ½ÑƒĞ¶Ğ½Ğ¾)
      return Promise.reject(error)
    }
)

```


## <a name="rentalappmainsrclibqueryClientts"></a>`rental-app-main/src/lib/queryClient.ts`

```typescript
// path: rental-app-main/src/lib/queryClient.ts

// src/lib/queryClient.ts
import { QueryClient, QueryCacheNotifyEvent, Query } from "@tanstack/react-query"

export const queryClient = new QueryClient({
    defaultOptions: {
        queries: {
            staleTime: 1000 * 60,
            refetchOnWindowFocus: true,
            retry: 1
        }
    }
})

// ğŸ”§ ĞŸĞ¾Ğ´Ğ¿Ğ¸ÑĞºĞ° Ğ½Ğ° ÑĞ¾Ğ±Ñ‹Ñ‚Ğ¸Ñ Ğ¾ÑˆĞ¸Ğ±Ğ¾Ğº Ğ² ĞºÑÑˆĞµ
queryClient.getQueryCache().subscribe((event: QueryCacheNotifyEvent) => {
    // ĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑĞµĞ¼, ÑĞ¾Ğ´ĞµÑ€Ğ¶Ğ¸Ñ‚ Ğ»Ğ¸ ÑĞ¾Ğ±Ñ‹Ñ‚Ğ¸Ğµ Ğ¾Ğ±ÑŠĞµĞºÑ‚ Query
    const query = 'query' in event ? (event as { query: Query }).query : undefined

    if (
        query?.state.status === "error" &&
        isUnauthorizedError(query.state.error)
    ) {
        handleUnauthorized()
    }
})

function isUnauthorizedError(error: unknown): boolean {
    return error instanceof Error && error.message.includes("401")
}

function handleUnauthorized() {
    localStorage.removeItem("access_token")
    window.location.href = "/"
}


```


## <a name="rentalappmainsrclibqueryHelpersts"></a>`rental-app-main/src/lib/queryHelpers.ts`

```typescript
// path: rental-app-main/src/lib/queryHelpers.ts

import { toast } from "sonner"

export function handleQueryError(error: unknown) {
    const message =
        error instanceof Error
            ? error.message
            : typeof error === "string"
                ? error
                : "ĞĞµĞ¸Ğ·Ğ²ĞµÑÑ‚Ğ½Ğ°Ñ Ğ¾ÑˆĞ¸Ğ±ĞºĞ° Ğ·Ğ°Ğ¿Ñ€Ğ¾ÑĞ°"
    toast.error(message)
    console.error("[Query error]", error)
}


```


## <a name="rentalappmainsrclibsortingUtilsts"></a>`rental-app-main/src/lib/sortingUtils.ts`

```typescript
// path: rental-app-main/src/lib/sortingUtils.ts

// src/lib/sortingUtils.ts

import { differenceInDays } from "date-fns";
import type { PickupReturnItem, OverdueRentalItem } from "@/hooks/admin/useDashboardData";

/**
 * Ğ¡Ğ¾Ñ€Ñ‚Ğ¸Ñ€ÑƒĞµÑ‚ Ğ²Ñ‹Ğ´Ğ°Ñ‡Ğ¸ Ğ¿Ğ¾ Ğ¿Ñ€Ğ¸Ğ¾Ñ€Ğ¸Ñ‚ĞµÑ‚Ñƒ:
 * 1. Ğ’Ñ‹Ğ´Ğ°Ñ‡Ğ¸ Ğ½Ğ° ÑĞµĞ³Ğ¾Ğ´Ğ½Ñ (Ğ±ĞµĞ· start_date Ğ¸Ğ»Ğ¸ start_date = ÑĞµĞ³Ğ¾Ğ´Ğ½Ñ)
 * 2. ĞŸÑ€Ğ¾ÑÑ€Ğ¾Ñ‡ĞµĞ½Ğ½Ñ‹Ğµ Ğ²Ñ‹Ğ´Ğ°Ñ‡Ğ¸ Ğ¿Ğ¾ ĞºĞ¾Ğ»Ğ¸Ñ‡ĞµÑÑ‚Ğ²Ñƒ Ğ´Ğ½ĞµĞ¹ Ğ¿Ñ€Ğ¾ÑÑ€Ğ¾Ñ‡ĞºĞ¸ (Ğ¿Ğ¾ Ğ²Ğ¾Ğ·Ñ€Ğ°ÑÑ‚Ğ°Ğ½Ğ¸Ñ)
 */
export const sortPickupsByPriority = (pickups: PickupReturnItem[], today: Date): PickupReturnItem[] => {
    return [...pickups].sort((a, b) => {
        const aStartDate = a.start_date ? new Date(a.start_date) : null;
        const bStartDate = b.start_date ? new Date(b.start_date) : null;
        
        // Ğ•ÑĞ»Ğ¸ Ñƒ ÑĞ»ĞµĞ¼ĞµĞ½Ñ‚Ğ° Ğ½ĞµÑ‚ start_date, ÑÑ‡Ğ¸Ñ‚Ğ°ĞµĞ¼ ĞµĞ³Ğ¾ Ğ²Ñ‹Ğ´Ğ°Ñ‡ĞµĞ¹ Ğ½Ğ° ÑĞµĞ³Ğ¾Ğ´Ğ½Ñ
        const aIsToday = !aStartDate || aStartDate.getTime() === today.getTime();
        const bIsToday = !bStartDate || bStartDate.getTime() === today.getTime();
        
        // Ğ¡Ğ½Ğ°Ñ‡Ğ°Ğ»Ğ° Ğ²Ñ‹Ğ´Ğ°Ñ‡Ğ¸ Ğ½Ğ° ÑĞµĞ³Ğ¾Ğ´Ğ½Ñ
        if (aIsToday && !bIsToday) return -1;
        if (!aIsToday && bIsToday) return 1;
        
        // Ğ•ÑĞ»Ğ¸ Ğ¾Ğ±Ğ° Ğ½Ğµ Ğ½Ğ° ÑĞµĞ³Ğ¾Ğ´Ğ½Ñ, ÑĞ¾Ñ€Ñ‚Ğ¸Ñ€ÑƒĞµĞ¼ Ğ¿Ğ¾ ĞºĞ¾Ğ»Ğ¸Ñ‡ĞµÑÑ‚Ğ²Ñƒ Ğ´Ğ½ĞµĞ¹ Ğ¿Ñ€Ğ¾ÑÑ€Ğ¾Ñ‡ĞºĞ¸
        if (!aIsToday && !bIsToday) {
            const aDaysPassed = aStartDate ? differenceInDays(today, aStartDate) : 0;
            const bDaysPassed = bStartDate ? differenceInDays(today, bStartDate) : 0;
            return aDaysPassed - bDaysPassed; // ĞœĞµĞ½ÑŒÑˆĞµ Ğ´Ğ½ĞµĞ¹ Ğ¿Ñ€Ğ¾ÑÑ€Ğ¾Ñ‡ĞºĞ¸ - Ğ²Ñ‹ÑˆĞµ Ğ² ÑĞ¿Ğ¸ÑĞºĞµ
        }
        
        return 0;
    });
};

/**
 * Ğ¡Ğ¾Ñ€Ñ‚Ğ¸Ñ€ÑƒĞµÑ‚ Ğ¿Ñ€Ğ¾ÑÑ€Ğ¾Ñ‡ĞµĞ½Ğ½Ñ‹Ğµ Ğ°Ñ€ĞµĞ½Ğ´Ñ‹ Ğ¿Ğ¾ ĞºĞ¾Ğ»Ğ¸Ñ‡ĞµÑÑ‚Ğ²Ñƒ Ğ´Ğ½ĞµĞ¹ Ğ¿Ñ€Ğ¾ÑÑ€Ğ¾Ñ‡ĞºĞ¸ (Ğ¿Ğ¾ Ğ²Ğ¾Ğ·Ñ€Ğ°ÑÑ‚Ğ°Ğ½Ğ¸Ñ)
 */
export const sortOverdueRentalsByDays = (overdueRentals: OverdueRentalItem[]): OverdueRentalItem[] => {
    return [...overdueRentals].sort((a, b) => {
        // Ğ˜ÑĞ¿Ğ¾Ğ»ÑŒĞ·ÑƒĞµĞ¼ days_overdue ĞµÑĞ»Ğ¸ ĞµÑÑ‚ÑŒ, Ğ¸Ğ½Ğ°Ñ‡Ğµ Ğ²Ñ‹Ñ‡Ğ¸ÑĞ»ÑĞµĞ¼ Ñ€Ğ°Ğ·Ğ½Ğ¾ÑÑ‚ÑŒ
        const aDaysOverdue = a.days_overdue ?? 0;
        const bDaysOverdue = b.days_overdue ?? 0;
        
        return aDaysOverdue - bDaysOverdue; // ĞœĞµĞ½ÑŒÑˆĞµ Ğ´Ğ½ĞµĞ¹ Ğ¿Ñ€Ğ¾ÑÑ€Ğ¾Ñ‡ĞºĞ¸ - Ğ²Ñ‹ÑˆĞµ Ğ² ÑĞ¿Ğ¸ÑĞºĞµ
    });
};

/**
 * Ğ¡Ğ¾Ğ·Ğ´Ğ°ĞµÑ‚ ÑĞµĞ³Ğ¾Ğ´Ğ½ÑÑˆĞ½ÑÑ Ğ´Ğ°Ñ‚Ñƒ Ñ Ğ¾Ğ±Ğ½ÑƒĞ»ĞµĞ½Ğ½Ñ‹Ğ¼ Ğ²Ñ€ĞµĞ¼ĞµĞ½ĞµĞ¼ Ğ´Ğ»Ñ ĞºĞ¾Ñ€Ñ€ĞµĞºÑ‚Ğ½Ğ¾Ğ³Ğ¾ ÑÑ€Ğ°Ğ²Ğ½ĞµĞ½Ğ¸Ñ
 */
export const getTodayDate = (): Date => {
    const today = new Date();
    today.setHours(0, 0, 0, 0);
    return today;
};


```


## <a name="rentalappmainsrclibutilsts"></a>`rental-app-main/src/lib/utils.ts`

```typescript
// path: rental-app-main/src/lib/utils.ts

// src/lib/utils.ts

import { clsx, type ClassValue } from "clsx"
import { twMerge } from "tailwind-merge"

/**
 * Ğ¦ĞµĞ½Ñ‚Ñ€Ğ°Ğ»Ğ¸Ğ·Ğ¾Ğ²Ğ°Ğ½Ğ½Ğ¾ Ñ€Ğ°ÑÑÑ‡Ğ¸Ñ‚Ñ‹Ğ²Ğ°ĞµÑ‚ ĞºĞ¾Ğ»Ğ¸Ñ‡ĞµÑÑ‚Ğ²Ğ¾ Ñ‚Ğ°Ñ€Ğ¸Ñ„Ğ¸Ñ†Ğ¸Ñ€ÑƒĞµĞ¼Ñ‹Ñ… Ğ´Ğ½ĞµĞ¹ (Ğ½Ğ¾Ñ‡ĞµĞ¹), Ğ²Ñ‹Ñ‡Ğ¸Ñ‚Ğ°Ñ Ğ¿Ñ€Ğ°Ğ·Ğ´Ğ½Ğ¸ĞºĞ¸.
 * @param start - Ğ”Ğ°Ñ‚Ğ° Ğ½Ğ°Ñ‡Ğ°Ğ»Ğ°
 * @param end - Ğ”Ğ°Ñ‚Ğ° Ğ¾ĞºĞ¾Ğ½Ñ‡Ğ°Ğ½Ğ¸Ñ
 * @param holidays - ĞœĞ°ÑÑĞ¸Ğ² Ğ´Ğ°Ñ‚, ÑĞ²Ğ»ÑÑÑ‰Ğ¸Ñ…ÑÑ Ğ²Ñ‹Ñ…Ğ¾Ğ´Ğ½Ñ‹Ğ¼Ğ¸
 * @returns ĞšĞ¾Ğ»Ğ¸Ñ‡ĞµÑÑ‚Ğ²Ğ¾ Ñ‚Ğ°Ñ€Ğ¸Ñ„Ğ¸Ñ†Ğ¸Ñ€ÑƒĞµĞ¼Ñ‹Ñ… Ğ´Ğ½ĞµĞ¹.
 */
export function calculateDayCount(
    start?: Date | null,
    end?: Date | null,
    holidays: Date[] = []
): number {
  // ĞŸÑ€Ğ¾Ğ²ĞµÑ€ĞºĞ° Ğ½Ğ° ĞºĞ¾Ñ€Ñ€ĞµĞºÑ‚Ğ½Ğ¾ÑÑ‚ÑŒ Ğ´Ğ°Ñ‚
  if (!start || !end || start >= end) {
    return 0;
  }

  // Ğ¡Ñ‡Ğ¸Ñ‚Ğ°ĞµĞ¼ Ğ¾Ğ±Ñ‰ĞµĞµ ĞºĞ¾Ğ»Ğ¸Ñ‡ĞµÑÑ‚Ğ²Ğ¾ "Ğ½Ğ¾Ñ‡ĞµĞ¹"
  const totalDays = Math.round((end.getTime() - start.getTime()) / (1000 * 60 * 60 * 24));

  if (holidays.length === 0) {
    return Math.max(0, totalDays);
  }

  // Ğ¡Ğ¾Ğ·Ğ´Ğ°ĞµĞ¼ Ğ¼Ğ½Ğ¾Ğ¶ĞµÑÑ‚Ğ²Ğ¾ Ğ´Ğ°Ñ‚ Ğ¿Ñ€Ğ°Ğ·Ğ´Ğ½Ğ¸ĞºĞ¾Ğ² (Ğ² Ñ„Ğ¾Ñ€Ğ¼Ğ°Ñ‚Ğµ YYYY-MM-DD) Ğ´Ğ»Ñ Ğ±Ñ‹ÑÑ‚Ñ€Ğ¾Ğ¹ Ğ¿Ñ€Ğ¾Ğ²ĞµÑ€ĞºĞ¸
  const holidaySet = new Set(holidays.map(h => formatDate(h)));

  let nonBillableDays = 0;
  // ĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑĞµĞ¼ ĞºĞ°Ğ¶Ğ´Ñ‹Ğ¹ Ğ´ĞµĞ½ÑŒ Ğ²Ğ½ÑƒÑ‚Ñ€Ğ¸ Ğ´Ğ¸Ğ°Ğ¿Ğ°Ğ·Ğ¾Ğ½Ğ°
  for (let i = 0; i < totalDays; i++) {
    const currentDay = new Date(start);
    currentDay.setDate(start.getDate() + i);

    // ĞŸÑ€Ğ¾Ğ¿ÑƒÑĞºĞ°ĞµĞ¼ ÑĞ°Ğ¼ Ğ´ĞµĞ½ÑŒ Ğ½Ğ°Ñ‡Ğ°Ğ»Ğ°, Ñ‚Ğ°Ğº ĞºĞ°Ğº Ğ¿Ğ¾ Ğ¿Ñ€Ğ°Ğ²Ğ¸Ğ»Ğ°Ğ¼ Ğ¾Ğ½ Ñ‚Ğ°Ñ€Ğ¸Ñ„Ğ¸Ñ†Ğ¸Ñ€ÑƒĞµÑ‚ÑÑ
    if (i === 0) continue;

    if (holidaySet.has(formatDate(currentDay))) {
      nonBillableDays++;
    }
  }

  return Math.max(0, totalDays - nonBillableDays);
}

/**
 * Ğ£Ğ½Ğ¸Ğ²ĞµÑ€ÑĞ°Ğ»ÑŒĞ½Ñ‹Ğ¹ Ñ„Ğ¾Ñ€Ğ¼Ğ°Ñ‚Ñ‚ĞµÑ€ Ğ´Ğ°Ñ‚Ñ‹ (YYYY-MM-DD)
 * ĞŸÑ€Ğ¸Ğ½Ğ¸Ğ¼Ğ°ĞµÑ‚ Date Ğ¸Ğ»Ğ¸ ÑÑ‚Ñ€Ğ¾ĞºÑƒ, Ğ²Ğ¾Ğ·Ğ²Ñ€Ğ°Ñ‰Ğ°ĞµÑ‚ ÑÑ‚Ñ€Ğ¾ĞºÑƒ Ğ² Ñ„Ğ¾Ñ€Ğ¼Ğ°Ñ‚Ğµ '2024-05-21'
 * Ğ˜ÑĞ¿Ğ¾Ğ»ÑŒĞ·ÑƒĞµÑ‚ÑÑ Ğ´Ğ»Ñ API Ğ¸ input[type="date"]
 */
export function formatDate(date: Date | string | null | undefined): string {
  if (!date) return "";
  const d = typeof date === "string" ? new Date(date) : date;
  if (isNaN(d.getTime())) return "";
  const year = d.getFullYear();
  const month = String(d.getMonth() + 1).padStart(2, "0");
  const day = String(d.getDate()).padStart(2, "0");
  return `${year}-${month}-${day}`;
}

/**
 * Ğ¤Ğ¾Ñ€Ğ¼Ğ°Ñ‚Ñ‚ĞµÑ€ Ğ´Ğ°Ñ‚Ñ‹ Ğ´Ğ»Ñ UI (Ğ”Ğ”.ĞœĞœ.Ğ“Ğ“Ğ“Ğ“)
 * ĞŸÑ€Ğ¸Ğ½Ğ¸Ğ¼Ğ°ĞµÑ‚ Date Ğ¸Ğ»Ğ¸ ÑÑ‚Ñ€Ğ¾ĞºÑƒ, Ğ²Ğ¾Ğ·Ğ²Ñ€Ğ°Ñ‰Ğ°ĞµÑ‚ ÑÑ‚Ñ€Ğ¾ĞºÑƒ Ğ² Ñ„Ğ¾Ñ€Ğ¼Ğ°Ñ‚Ğµ '21.05.2024'
 * Ğ˜ÑĞ¿Ğ¾Ğ»ÑŒĞ·ÑƒĞµÑ‚ÑÑ Ñ‚Ğ¾Ğ»ÑŒĞºĞ¾ Ğ´Ğ»Ñ Ğ²Ñ‹Ğ²Ğ¾Ğ´Ğ° Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ñ!
 */
export function formatDateEuropean(date: Date | string | null | undefined): string {
  if (!date) return "";
  const d = typeof date === "string" ? new Date(date) : date;
  if (isNaN(d.getTime())) return "";
  const day = String(d.getDate()).padStart(2, "0");
  const month = String(d.getMonth() + 1).padStart(2, "0");
  const year = d.getFullYear();
  return `${day}.${month}.${year}`;
}

/**
 * Ğ¤Ğ¾Ñ€Ğ¼Ğ°Ñ‚Ñ‚ĞµÑ€ Ğ´Ğ¸Ğ°Ğ¿Ğ°Ğ·Ğ¾Ğ½Ğ° Ğ´Ğ°Ñ‚ Ğ´Ğ»Ñ UI (Ğ½Ğ°Ğ¿Ñ€Ğ¸Ğ¼ĞµÑ€: 21.05.2024 â€” 28.05.2024)
 */
export function formatDateRangeEuropean(start?: Date | string | null, end?: Date | string | null): string {
  if (!start || !end) return "";
  return `${formatDateEuropean(start)} â€” ${formatDateEuropean(end)}`;
}

/**
 * Ğ‘ĞµĞ·Ğ¾Ğ¿Ğ°ÑĞ½Ğ¾ Ñ„Ğ¾Ñ€Ğ¼Ğ°Ñ‚Ğ¸Ñ€ÑƒĞµÑ‚ Ñ‡Ğ¸ÑĞ»Ğ¾Ğ²Ğ¾Ğµ Ğ·Ğ½Ğ°Ñ‡ĞµĞ½Ğ¸Ğµ Ğ² ÑÑ‚Ñ€Ğ¾ĞºÑƒ Ñ Ñ€Ğ°Ğ·Ğ´ĞµĞ»Ğ¸Ñ‚ĞµĞ»ÑĞ¼Ğ¸ Ñ‚Ñ‹ÑÑÑ‡
 * @param value - Ñ‡Ğ¸ÑĞ»Ğ¾Ğ²Ğ¾Ğµ Ğ·Ğ½Ğ°Ñ‡ĞµĞ½Ğ¸Ğµ Ğ´Ğ»Ñ Ñ„Ğ¾Ñ€Ğ¼Ğ°Ñ‚Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ
 * @param fallback - Ğ·Ğ½Ğ°Ñ‡ĞµĞ½Ğ¸Ğµ Ğ¿Ğ¾ ÑƒĞ¼Ğ¾Ğ»Ñ‡Ğ°Ğ½Ğ¸Ñ, ĞµÑĞ»Ğ¸ value Ğ½Ğµ Ğ¾Ğ¿Ñ€ĞµĞ´ĞµĞ»ĞµĞ½Ğ¾
 * @returns Ğ¾Ñ‚Ñ„Ğ¾Ñ€Ğ¼Ğ°Ñ‚Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ½Ğ°Ñ ÑÑ‚Ñ€Ğ¾ĞºĞ°
 */
export function formatNumber(value: number | null | undefined, fallback: string = "0"): string {
  if (value === null || value === undefined || isNaN(value)) {
    return fallback;
  }
  return value.toLocaleString('ru-RU');
}

/**
 * Ğ£Ñ‚Ğ¸Ğ»Ğ¸Ñ‚Ğ° Ğ¾Ğ±ÑŠĞµĞ´Ğ¸Ğ½ĞµĞ½Ğ¸Ñ ĞºĞ»Ğ°ÑÑĞ¾Ğ² Ñ Ğ¿Ğ¾Ğ´Ğ´ĞµÑ€Ğ¶ĞºĞ¾Ğ¹ Tailwind Ğ¸ clsx
 */
export function cn(...inputs: ClassValue[]) {
  return twMerge(clsx(inputs));
}

/**
 * Ğ’Ñ‹Ñ‡Ğ¸ÑĞ»ÑĞµÑ‚ ĞºĞ¾Ğ»Ğ¸Ñ‡ĞµÑÑ‚Ğ²Ğ¾ Ğ´Ğ½ĞµĞ¹ Ğ¿Ñ€Ğ¾ÑÑ€Ğ¾Ñ‡ĞºĞ¸ Ğ´Ğ»Ñ Ğ°Ñ€ĞµĞ½Ğ´Ñ‹
 * @param dueDate - Ğ”Ğ°Ñ‚Ğ° Ğ²Ğ¾Ğ·Ğ²Ñ€Ğ°Ñ‚Ğ° (ÑÑ‚Ñ€Ğ¾ĞºĞ° Ğ¸Ğ»Ğ¸ Date)
 * @param daysOverdue - ĞšĞ¾Ğ»Ğ¸Ñ‡ĞµÑÑ‚Ğ²Ğ¾ Ğ´Ğ½ĞµĞ¹ Ğ¿Ñ€Ğ¾ÑÑ€Ğ¾Ñ‡ĞºĞ¸ Ñ Ğ±ÑĞºĞµĞ½Ğ´Ğ° (ĞµÑĞ»Ğ¸ ĞµÑÑ‚ÑŒ)
 * @returns ĞšĞ¾Ğ»Ğ¸Ñ‡ĞµÑÑ‚Ğ²Ğ¾ Ğ´Ğ½ĞµĞ¹ Ğ¿Ñ€Ğ¾ÑÑ€Ğ¾Ñ‡ĞºĞ¸
 */
export function calculateDaysOverdue(dueDate: string | Date | null | undefined, daysOverdue?: number | null): number {
  // Ğ•ÑĞ»Ğ¸ Ğ±ÑĞºĞµĞ½Ğ´ Ğ¿Ñ€ĞµĞ´Ğ¾ÑÑ‚Ğ°Ğ²Ğ¸Ğ» ĞºĞ¾Ğ»Ğ¸Ñ‡ĞµÑÑ‚Ğ²Ğ¾ Ğ´Ğ½ĞµĞ¹ Ğ¿Ñ€Ğ¾ÑÑ€Ğ¾Ñ‡ĞºĞ¸, Ğ¸ÑĞ¿Ğ¾Ğ»ÑŒĞ·ÑƒĞµĞ¼ ĞµĞ³Ğ¾
  if (daysOverdue !== undefined && daysOverdue !== null) {
    return daysOverdue;
  }
  
  // ĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑĞµĞ¼, Ñ‡Ñ‚Ğ¾ dueDate Ğ²Ğ°Ğ»Ğ¸Ğ´ĞµĞ½
  if (!dueDate) {
    return 0;
  }
  
  // Ğ’Ñ‹Ñ‡Ğ¸ÑĞ»ÑĞµĞ¼ Ğ½Ğ° ĞºĞ»Ğ¸ĞµĞ½Ñ‚Ğµ, ĞµÑĞ»Ğ¸ Ğ¿Ğ¾Ğ»Ğµ Ğ½Ğµ Ğ¿Ñ€ĞµĞ´Ğ¾ÑÑ‚Ğ°Ğ²Ğ»ĞµĞ½Ğ¾
  const due = typeof dueDate === "string" ? new Date(dueDate) : dueDate;
  
  // ĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑĞµĞ¼, Ñ‡Ñ‚Ğ¾ Ğ´Ğ°Ñ‚Ğ° Ğ²Ğ°Ğ»Ğ¸Ğ´Ğ½Ğ°
  if (isNaN(due.getTime())) {
    return 0;
  }
  
  const today = new Date();
  
  // Ğ¡Ğ±Ñ€Ğ°ÑÑ‹Ğ²Ğ°ĞµĞ¼ Ğ²Ñ€ĞµĞ¼Ñ Ğ´Ğ»Ñ ĞºĞ¾Ñ€Ñ€ĞµĞºÑ‚Ğ½Ğ¾Ğ³Ğ¾ ÑÑ€Ğ°Ğ²Ğ½ĞµĞ½Ğ¸Ñ Ğ´Ğ°Ñ‚
  today.setHours(0, 0, 0, 0);
  due.setHours(0, 0, 0, 0);
  
  const diffTime = today.getTime() - due.getTime();
  const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
  
  return diffDays > 0 ? diffDays : 0;
}

/**
 * ĞŸÑ€ĞµĞ¾Ğ±Ñ€Ğ°Ğ·ÑƒĞµÑ‚ accessory_links Ğ² selected_accessories Ğ´Ğ»Ñ ÑĞ¾Ğ²Ğ¼ĞµÑÑ‚Ğ¸Ğ¼Ğ¾ÑÑ‚Ğ¸ Ñ ĞºĞ¾Ğ¼Ğ¿Ğ¾Ğ½ĞµĞ½Ñ‚Ğ°Ğ¼Ğ¸
 * @param reservation - ĞĞ±ÑŠĞµĞºÑ‚ Ñ€ĞµĞ·ĞµÑ€Ğ²Ğ° Ñ accessory_links
 * @returns ĞĞ±ÑŠĞµĞºÑ‚ Ñ€ĞµĞ·ĞµÑ€Ğ²Ğ° Ñ Ğ´Ğ¾Ğ±Ğ°Ğ²Ğ»ĞµĞ½Ğ½Ñ‹Ğ¼ selected_accessories
 */
export function transformAccessoryLinks<T extends { accessory_links?: Array<{ equipment_id: number; accessory: { id: number } }> }>(reservation: T): T & { selected_accessories: Record<number, number[]> } {
  if (!reservation.accessory_links || reservation.accessory_links.length === 0) {
    return { ...reservation, selected_accessories: {} };
  }
  
  const selected_accessories = reservation.accessory_links.reduce((acc, link) => {
    if (!acc[link.equipment_id]) {
      acc[link.equipment_id] = [];
    }
    acc[link.equipment_id].push(link.accessory.id);
    return acc;
  }, {} as Record<number, number[]>);
  
  return { ...reservation, selected_accessories };
}

```


## <a name="rentalappmainsrclibvalidationSchemasts"></a>`rental-app-main/src/lib/validationSchemas.ts`

```typescript
// path: rental-app-main/src/lib/validationSchemas.ts

// src/lib/validationSchemas.ts

import { z } from "zod";
import { USER_ROLE_VALUES } from "@/constants/userConstants";
import { validateRussianPhone } from "@/utils/phoneUtils";

// --- ĞÑƒÑ‚ĞµĞ½Ñ‚Ğ¸Ñ„Ğ¸ĞºĞ°Ñ†Ğ¸Ñ ---
export const authSchema = z.object({
    email: z.string().min(1, "Email Ğ¾Ğ±ÑĞ·Ğ°Ñ‚ĞµĞ»ĞµĞ½").email("ĞĞµĞºĞ¾Ñ€Ñ€ĞµĞºÑ‚Ğ½Ñ‹Ğ¹ email"),
    password: z.string().min(6, "ĞŸĞ°Ñ€Ğ¾Ğ»ÑŒ Ğ´Ğ¾Ğ»Ğ¶ĞµĞ½ Ğ±Ñ‹Ñ‚ÑŒ Ğ½Ğµ Ğ¼ĞµĞ½ĞµĞµ 6 ÑĞ¸Ğ¼Ğ²Ğ¾Ğ»Ğ¾Ğ²"),
    fullName: z.string().min(2, "Ğ¤Ğ˜Ğ Ğ´Ğ¾Ğ»Ğ¶Ğ½Ğ¾ Ğ±Ñ‹Ñ‚ÑŒ Ğ½Ğµ ĞºĞ¾Ñ€Ğ¾Ñ‡Ğµ 2 ÑĞ¸Ğ¼Ğ²Ğ¾Ğ»Ğ¾Ğ²").optional(),
    phone: z.string().optional().refine(val => !val || validateRussianPhone(val), {
        message: "ĞĞµĞºĞ¾Ñ€Ñ€ĞµĞºÑ‚Ğ½Ñ‹Ğ¹ Ñ„Ğ¾Ñ€Ğ¼Ğ°Ñ‚ Ğ½Ğ¾Ğ¼ĞµÑ€Ğ° Ñ‚ĞµĞ»ĞµÑ„Ğ¾Ğ½Ğ°. Ğ˜ÑĞ¿Ğ¾Ğ»ÑŒĞ·ÑƒĞ¹Ñ‚Ğµ Ñ„Ğ¾Ñ€Ğ¼Ğ°Ñ‚: +7 (XXX) XXX-XX-XX",
    }),
    privacyPolicyAccepted: z.boolean().optional(),
    termsAccepted: z.boolean().optional(),
});
export type AuthSchema = z.infer<typeof authSchema>;


// --- Ğ ĞµĞ·ĞµÑ€Ğ²Ñ‹ ---
// Ğ­Ñ‚Ğ° Zod-ÑÑ…ĞµĞ¼Ğ° Ñ‚ĞµĞ¿ĞµÑ€ÑŒ ÑĞ²Ğ»ÑĞµÑ‚ÑÑ Ğ•Ğ”Ğ˜ĞĞ¡Ğ¢Ğ’Ğ•ĞĞĞ«Ğœ Ğ¸ÑÑ‚Ğ¾Ñ‡Ğ½Ğ¸ĞºĞ¾Ğ¼ Ğ¿Ñ€Ğ°Ğ²Ğ´Ñ‹ Ğ´Ğ»Ñ Ñ‚Ğ¸Ğ¿Ğ° Ğ´Ğ°Ğ½Ğ½Ñ‹Ñ… Ğ¿Ñ€Ğ¸ ÑĞ¾Ğ·Ğ´Ğ°Ğ½Ğ¸Ğ¸ Ñ€ĞµĞ·ĞµÑ€Ğ²Ğ°.
export const reservationCreateSchema = z.object({
    user_id: z.number().optional(), // Ğ”Ğ»Ñ ÑĞ¾Ğ·Ğ´Ğ°Ğ½Ğ¸Ñ Ñ€ĞµĞ·ĞµÑ€Ğ²Ğ° Ğ°Ğ´Ğ¼Ğ¸Ğ½Ğ¾Ğ¼
    equipment_ids: z.array(z.number()).min(1, "ĞĞµĞ¾Ğ±Ñ…Ğ¾Ğ´Ğ¸Ğ¼Ğ¾ Ğ²Ñ‹Ğ±Ñ€Ğ°Ñ‚ÑŒ Ñ…Ğ¾Ñ‚Ñ Ğ±Ñ‹ Ğ¾Ğ´Ğ½Ğ¾ Ğ¾Ğ±Ğ¾Ñ€ÑƒĞ´Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ Ğ´Ğ»Ñ Ñ€ĞµĞ·ĞµÑ€Ğ²Ğ°."),
    start_date: z.string().refine((date) => /^\d{4}-\d{2}-\d{2}$/.test(date) && !isNaN(new Date(date).getTime()), {
        message: "ĞĞµĞºĞ¾Ñ€Ñ€ĞµĞºÑ‚Ğ½Ğ°Ñ Ğ´Ğ°Ñ‚Ğ° Ğ½Ğ°Ñ‡Ğ°Ğ»Ğ°.",
    }),
    end_date: z.string().refine((date) => /^\d{4}-\d{2}-\d{2}$/.test(date) && !isNaN(new Date(date).getTime()), {
        message: "ĞĞµĞºĞ¾Ñ€Ñ€ĞµĞºÑ‚Ğ½Ğ°Ñ Ğ´Ğ°Ñ‚Ğ° Ğ¾ĞºĞ¾Ğ½Ñ‡Ğ°Ğ½Ğ¸Ñ.",
    }),
    selected_accessories: z.record(z.array(z.number())).default({}),
    promo_code: z.string().optional(),
}).refine(data => new Date(data.end_date) > new Date(data.start_date), {
    message: "Ğ”Ğ°Ñ‚Ğ° Ğ¾ĞºĞ¾Ğ½Ñ‡Ğ°Ğ½Ğ¸Ñ Ğ´Ğ¾Ğ»Ğ¶Ğ½Ğ° Ğ±Ñ‹Ñ‚ÑŒ Ğ¿Ğ¾Ğ·Ğ¶Ğµ Ğ´Ğ°Ñ‚Ñ‹ Ğ½Ğ°Ñ‡Ğ°Ğ»Ğ°.",
    path: ["end_date"],
});

// Ğ­ĞºÑĞ¿Ğ¾Ñ€Ñ‚Ğ¸Ñ€ÑƒĞµĞ¼ Ñ‚Ğ¸Ğ¿, ÑĞ¾Ğ·Ğ´Ğ°Ğ½Ğ½Ñ‹Ğ¹ Ğ½Ğ° Ğ¾ÑĞ½Ğ¾Ğ²Ğµ Zod-ÑÑ…ĞµĞ¼Ñ‹.
// Ğ¢ĞµĞ¿ĞµÑ€ÑŒ ÑÑ‚Ğ¾Ñ‚ Ñ‚Ğ¸Ğ¿ Ğ±ÑƒĞ´ĞµÑ‚ Ğ¸ÑĞ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ÑŒÑÑ Ğ² ÑĞµÑ€Ğ²Ğ¸ÑĞ°Ñ… Ğ¸ Ñ…ÑƒĞºĞ°Ñ…, Ğ³Ğ°Ñ€Ğ°Ğ½Ñ‚Ğ¸Ñ€ÑƒÑ ÑĞ¾Ğ¾Ñ‚Ğ²ĞµÑ‚ÑÑ‚Ğ²Ğ¸Ğµ.
export type ReservationCreateInput = z.infer<typeof reservationCreateSchema>;


// --- Ğ£Ğ¿Ñ€Ğ°Ğ²Ğ»ĞµĞ½Ğ¸Ğµ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ÑĞ¼Ğ¸ (ĞĞ´Ğ¼Ğ¸Ğ½-Ğ¿Ğ°Ğ½ĞµĞ»ÑŒ) ---
export const adminUserCreateFormSchema = z.object({
    full_name: z.string().min(2, "Ğ¤Ğ˜Ğ Ğ¾Ğ±ÑĞ·Ğ°Ñ‚ĞµĞ»ÑŒĞ½Ğ¾"),
    email: z.string().min(1, "Email Ğ¾Ğ±ÑĞ·Ğ°Ñ‚ĞµĞ»ĞµĞ½").email("ĞĞµĞºĞ¾Ñ€Ñ€ĞµĞºÑ‚Ğ½Ñ‹Ğ¹ email"),
    password: z.string().min(6, "ĞŸĞ°Ñ€Ğ¾Ğ»ÑŒ Ğ´Ğ¾Ğ»Ğ¶ĞµĞ½ Ğ±Ñ‹Ñ‚ÑŒ Ğ½Ğµ Ğ¼ĞµĞ½ĞµĞµ 6 ÑĞ¸Ğ¼Ğ²Ğ¾Ğ»Ğ¾Ğ²"),
    phone: z.string().optional(),
    role: z.enum(USER_ROLE_VALUES, {
        errorMap: () => ({ message: "ĞĞµĞ¾Ğ±Ñ…Ğ¾Ğ´Ğ¸Ğ¼Ğ¾ Ğ²Ñ‹Ğ±Ñ€Ğ°Ñ‚ÑŒ Ñ€Ğ¾Ğ»ÑŒ." })
    }),
    privacyPolicyAccepted: z.boolean(),
    termsAccepted: z.boolean(),
    emailVerified: z.boolean(),
});
export type AdminUserCreateFormSchema = z.infer<typeof adminUserCreateFormSchema>;

export const adminUserUpdateSchema = z.object({
    full_name: z.string().min(2, "Ğ¤Ğ˜Ğ Ğ¾Ğ±ÑĞ·Ğ°Ñ‚ĞµĞ»ÑŒĞ½Ğ¾").optional(),
    phone: z.string().optional(),
    status: z.string().optional(),
    notes: z.string().optional(),
    balance: z.coerce.number().optional()
});
export type AdminUserUpdateSchema = z.infer<typeof adminUserUpdateSchema>;

export const adminUserRoleUpdateSchema = z.object({
    role: z.enum(USER_ROLE_VALUES, {
        errorMap: () => ({ message: "ĞĞµĞ¾Ğ±Ñ…Ğ¾Ğ´Ğ¸Ğ¼Ğ¾ Ğ²Ñ‹Ğ±Ñ€Ğ°Ñ‚ÑŒ Ñ€Ğ¾Ğ»ÑŒ." })
    })
});
export type AdminUserRoleUpdateSchema = z.infer<typeof adminUserRoleUpdateSchema>;


// --- Ğ£Ğ¿Ñ€Ğ°Ğ²Ğ»ĞµĞ½Ğ¸Ğµ Ğ¾Ğ±Ğ¾Ñ€ÑƒĞ´Ğ¾Ğ²Ğ°Ğ½Ğ¸ĞµĞ¼ ---
export const equipmentUpdateExtendedSchema = z.object({
    equipment_type: z.string().min(1, "Ğ¢Ğ¸Ğ¿ Ğ¾Ğ±Ğ¾Ñ€ÑƒĞ´Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ Ğ½Ğµ Ğ´Ğ¾Ğ»Ğ¶ĞµĞ½ Ğ±Ñ‹Ñ‚ÑŒ Ğ¿ÑƒÑÑ‚Ñ‹Ğ¼.").optional(),
    brand: z.string().min(1, "Ğ‘Ñ€ĞµĞ½Ğ´ Ğ½Ğµ Ğ´Ğ¾Ğ»Ğ¶ĞµĞ½ Ğ±Ñ‹Ñ‚ÑŒ Ğ¿ÑƒÑÑ‚Ñ‹Ğ¼.").optional(),
    name: z.string().min(1, "ĞĞ°Ğ·Ğ²Ğ°Ğ½Ğ¸Ğµ Ğ½Ğµ Ğ´Ğ¾Ğ»Ğ¶Ğ½Ğ¾ Ğ±Ñ‹Ñ‚ÑŒ Ğ¿ÑƒÑÑ‚Ñ‹Ğ¼.").optional(),
    serial_number: z.string().nullable().optional(),
    condition: z.string().optional(),
    daily_rate: z.preprocess(
        (val) => (val === "" || val === null || val === undefined) ? undefined : parseFloat(String(val)),
        z.number({ invalid_type_error: "Ğ¡Ñ‚Ğ¾Ğ¸Ğ¼Ğ¾ÑÑ‚ÑŒ Ğ´Ğ¾Ğ»Ğ¶Ğ½Ğ° Ğ±Ñ‹Ñ‚ÑŒ Ñ‡Ğ¸ÑĞ»Ğ¾Ğ¼." })
            .positive("Ğ¡Ñ‚Ğ¾Ğ¸Ğ¼Ğ¾ÑÑ‚ÑŒ Ğ´Ğ¾Ğ»Ğ¶Ğ½Ğ° Ğ±Ñ‹Ñ‚ÑŒ Ğ¿Ğ¾Ğ»Ğ¾Ğ¶Ğ¸Ñ‚ĞµĞ»ÑŒĞ½Ñ‹Ğ¼ Ñ‡Ğ¸ÑĞ»Ğ¾Ğ¼.")
            .optional()
    ),
    notes: z.string().nullable().optional(),
    description: z.string().nullable().optional(),
    last_maintenance: z.string().nullable().optional().refine(val => val === null || val === undefined || val === "" || /^\d{4}-\d{2}-\d{2}$/.test(val), {
        message: "Ğ”Ğ°Ñ‚Ğ° Ğ¿Ğ¾ÑĞ»ĞµĞ´Ğ½ĞµĞ³Ğ¾ Ğ¢Ğ Ğ´Ğ¾Ğ»Ğ¶Ğ½Ğ° Ğ±Ñ‹Ñ‚ÑŒ Ğ² Ñ„Ğ¾Ñ€Ğ¼Ğ°Ñ‚Ğµ Ğ“Ğ“Ğ“Ğ“-ĞœĞœ-Ğ”Ğ” Ğ¸Ğ»Ğ¸ Ğ¾Ñ‚ÑÑƒÑ‚ÑÑ‚Ğ²Ğ¾Ğ²Ğ°Ñ‚ÑŒ.",
    }).transform(val => (val === "" ? undefined : val)),
    short_description: z.string().nullable().optional(),
    image_url: z.string().nullable().optional(),
    image_urls: z.array(z.string()).optional(),
    accessory_ids: z.array(z.number()).optional(),
});
export type EquipmentUpdateExtendedSchema = z.infer<typeof equipmentUpdateExtendedSchema>;


// --- Ğ£Ğ¿Ñ€Ğ°Ğ²Ğ»ĞµĞ½Ğ¸Ğµ Ğ°ĞºÑĞµÑÑÑƒĞ°Ñ€Ğ°Ğ¼Ğ¸ ---
export const accessorySchema = z.object({
    name: z.string().min(2, { message: "ĞĞ°Ğ·Ğ²Ğ°Ğ½Ğ¸Ğµ Ğ´Ğ¾Ğ»Ğ¶Ğ½Ğ¾ ÑĞ¾Ğ´ĞµÑ€Ğ¶Ğ°Ñ‚ÑŒ Ğ¼Ğ¸Ğ½Ğ¸Ğ¼ÑƒĞ¼ 2 ÑĞ¸Ğ¼Ğ²Ğ¾Ğ»Ğ°." }),
    accessory_type: z.string().optional(),
    price: z.preprocess(
        (value) => (value === "" ? undefined : value),
        z.coerce.number({ invalid_type_error: "Ğ¦ĞµĞ½Ğ° Ğ´Ğ¾Ğ»Ğ¶Ğ½Ğ° Ğ±Ñ‹Ñ‚ÑŒ Ñ‡Ğ¸ÑĞ»Ğ¾Ğ¼." })
            .min(0, { message: "Ğ¦ĞµĞ½Ğ° Ğ½Ğµ Ğ¼Ğ¾Ğ¶ĞµÑ‚ Ğ±Ñ‹Ñ‚ÑŒ Ğ¾Ñ‚Ñ€Ğ¸Ñ†Ğ°Ñ‚ĞµĞ»ÑŒĞ½Ğ¾Ğ¹." })
            .optional()
    ),
    description: z.string().optional(),
});
export type AccessorySchema = z.infer<typeof accessorySchema>;


// --- Ğ£Ğ¿Ñ€Ğ°Ğ²Ğ»ĞµĞ½Ğ¸Ğµ Ğ¿Ñ€Ğ¾Ğ¼Ğ¾ĞºĞ¾Ğ´Ğ°Ğ¼Ğ¸ ---
export const promoCodeFormSchema = z.object({
    code: z.string().min(3, "ĞšĞ¾Ğ´ Ğ´Ğ¾Ğ»Ğ¶ĞµĞ½ ÑĞ¾Ğ´ĞµÑ€Ğ¶Ğ°Ñ‚ÑŒ Ğ¼Ğ¸Ğ½Ğ¸Ğ¼ÑƒĞ¼ 3 ÑĞ¸Ğ¼Ğ²Ğ¾Ğ»Ğ°").max(50),
    description: z.string().optional(),
    discount_percentage: z.coerce.number({ invalid_type_error: "Ğ¡ĞºĞ¸Ğ´ĞºĞ° Ğ´Ğ¾Ğ»Ğ¶Ğ½Ğ° Ğ±Ñ‹Ñ‚ÑŒ Ñ‡Ğ¸ÑĞ»Ğ¾Ğ¼" })
        .min(1, "Ğ¡ĞºĞ¸Ğ´ĞºĞ° Ğ´Ğ¾Ğ»Ğ¶Ğ½Ğ° Ğ±Ñ‹Ñ‚ÑŒ Ğ±Ğ¾Ğ»ÑŒÑˆĞµ 0")
        .max(50, "ĞœĞ°ĞºÑĞ¸Ğ¼Ğ°Ğ»ÑŒĞ½Ğ°Ñ ÑĞºĞ¸Ğ´ĞºĞ° 50%"),
    is_active: z.boolean().default(true),
    valid_from: z.date().optional(),
    expires_at: z.date().optional(),
    max_uses: z.preprocess(
        (val) => (val === "" || val === null || val === undefined) ? undefined : parseInt(String(val), 10),
        z.number().positive("Ğ—Ğ½Ğ°Ñ‡ĞµĞ½Ğ¸Ğµ Ğ´Ğ¾Ğ»Ğ¶Ğ½Ğ¾ Ğ±Ñ‹Ñ‚ÑŒ Ğ±Ğ¾Ğ»ÑŒÑˆĞµ 0").optional()
    ),
    max_uses_per_user: z.preprocess(
        (val) => (val === "" || val === null || val === undefined) ? undefined : parseInt(String(val), 10),
        z.number().positive("Ğ—Ğ½Ğ°Ñ‡ĞµĞ½Ğ¸Ğµ Ğ´Ğ¾Ğ»Ğ¶Ğ½Ğ¾ Ğ±Ñ‹Ñ‚ÑŒ Ğ±Ğ¾Ğ»ÑŒÑˆĞµ 0").optional()
    ),
    min_order_amount: z.preprocess(
        (val) => (val === "" || val === null || val === undefined) ? undefined : parseFloat(String(val)),
        z.number().positive("Ğ—Ğ½Ğ°Ñ‡ĞµĞ½Ğ¸Ğµ Ğ´Ğ¾Ğ»Ğ¶Ğ½Ğ¾ Ğ±Ñ‹Ñ‚ÑŒ Ğ±Ğ¾Ğ»ÑŒÑˆĞµ 0").optional()
    ),
    applicable_to_equipment_ids: z.array(z.number()).optional(),
    applicable_to_equipment_types: z.array(z.string()).optional(),
    specific_to_user_id: z.coerce.number().optional(),
}).refine(data => {
    if (data.valid_from && data.expires_at) {
        return data.expires_at >= data.valid_from;
    }
    return true;
}, {
    message: "Ğ”Ğ°Ñ‚Ğ° Ğ¾ĞºĞ¾Ğ½Ñ‡Ğ°Ğ½Ğ¸Ñ Ğ½Ğµ Ğ¼Ğ¾Ğ¶ĞµÑ‚ Ğ±Ñ‹Ñ‚ÑŒ Ñ€Ğ°Ğ½ÑŒÑˆĞµ Ğ´Ğ°Ñ‚Ñ‹ Ğ½Ğ°Ñ‡Ğ°Ğ»Ğ°",
    path: ["expires_at"],
});
export type PromoCodeFormData = z.infer<typeof promoCodeFormSchema>;

// +++ ĞĞĞ§ĞĞ›Ğ: ĞĞ¾Ğ²Ğ°Ñ ÑÑ…ĞµĞ¼Ğ° Ğ´Ğ»Ñ Ñ„Ğ¾Ñ€Ğ¼Ñ‹ Ğ¿Ğ¾Ğ¿Ğ¾Ğ»Ğ½ĞµĞ½Ğ¸Ñ Ğ±Ğ°Ğ»Ğ°Ğ½ÑĞ° +++
export const userPaymentSchema = z.object({
    amount: z.coerce
        .number({ invalid_type_error: "Ğ¡ÑƒĞ¼Ğ¼Ğ° Ğ´Ğ¾Ğ»Ğ¶Ğ½Ğ° Ğ±Ñ‹Ñ‚ÑŒ Ñ‡Ğ¸ÑĞ»Ğ¾Ğ¼" })
        .positive("Ğ¡ÑƒĞ¼Ğ¼Ğ° Ğ´Ğ¾Ğ»Ğ¶Ğ½Ğ° Ğ±Ñ‹Ñ‚ÑŒ Ğ±Ğ¾Ğ»ÑŒÑˆĞµ Ğ½ÑƒĞ»Ñ"),
    payment_method: z.string().min(1, "ĞĞµĞ¾Ğ±Ñ…Ğ¾Ğ´Ğ¸Ğ¼Ğ¾ Ğ²Ñ‹Ğ±Ñ€Ğ°Ñ‚ÑŒ Ğ¼ĞµÑ‚Ğ¾Ğ´ Ğ¾Ğ¿Ğ»Ğ°Ñ‚Ñ‹"),
    description: z.string().optional(),
});
export type UserPaymentSchema = z.infer<typeof userPaymentSchema>;
// +++ ĞšĞĞĞ•Ğ¦: ĞĞ¾Ğ²Ğ°Ñ ÑÑ…ĞµĞ¼Ğ° +++

```


## <a name="rentalappmainsrcmaintsx"></a>`rental-app-main/src/main.tsx`

```tsx
// path: rental-app-main/src/main.tsx

// src/main.tsx

import React from "react";
import ReactDOM from "react-dom/client";
import {BrowserRouter} from "react-router-dom";
import App from "./app/App";

// 1. Ğ¡ĞĞĞ§ĞĞ›Ğ Ğ¸Ğ¼Ğ¿Ğ¾Ñ€Ñ‚Ğ¸Ñ€ÑƒĞµĞ¼ ÑÑ‚Ğ¸Ğ»Ğ¸ Ğ±Ğ¸Ğ±Ğ»Ğ¸Ğ¾Ñ‚ĞµĞºĞ¸
import 'react-day-picker/dist/style.css';

// 2. ĞŸĞĞ¢ĞĞœ Ğ¸Ğ¼Ğ¿Ğ¾Ñ€Ñ‚Ğ¸Ñ€ÑƒĞµĞ¼ Ğ½Ğ°ÑˆĞ¸ ÑĞ¾Ğ±ÑÑ‚Ğ²ĞµĞ½Ğ½Ñ‹Ğµ ÑÑ‚Ğ¸Ğ»Ğ¸ Ğ´Ğ»Ñ Ğ¸Ñ… Ğ¿ĞµÑ€ĞµĞ¾Ğ¿Ñ€ĞµĞ´ĞµĞ»ĞµĞ½Ğ¸Ñ
import "./index.css";

import {QueryClientProvider} from "@tanstack/react-query";
import {queryClient} from "./lib/queryClient";
import {ReactQueryDevtools} from "@tanstack/react-query-devtools";
import ErrorBoundary from "./components/ErrorBoundary";
import NetworkStatus from "./components/NetworkStatus";

ReactDOM.createRoot(document.getElementById("root")!).render(
    <React.StrictMode>
        <QueryClientProvider client={queryClient}>
            <ErrorBoundary>
                <BrowserRouter>
                    <App/>
                    <NetworkStatus/>
                </BrowserRouter>
            </ErrorBoundary>
            <ReactQueryDevtools initialIsOpen={false}/>
        </QueryClientProvider>
    </React.StrictMode>
);

```


## <a name="rentalappmainsrcpagesAccessoryManagementPagetsx"></a>`rental-app-main/src/pages/AccessoryManagementPage.tsx`

```tsx
// path: rental-app-main/src/pages/AccessoryManagementPage.tsx

// src/pages/AccessoryManagementPage.tsx

import AdminNavigation from "@/components/admin/AdminNavigation";
// âœ… Ğ˜ĞœĞŸĞĞ Ğ¢Ğ˜Ğ Ğ£Ğ•Ğœ Ğ Ğ•ĞĞ›Ğ¬ĞĞ«Ğ™ ĞšĞĞœĞŸĞĞĞ•ĞĞ¢
import AccessoryTable from "@/components/admin/AccessoryTable";
import { Button } from "@/components/ui/button";
import { Shield, Paperclip } from "lucide-react";
import { useNavigate } from "react-router-dom";
import { useCurrentUser } from "@/hooks/useProfile";

export default function AccessoryManagementPage() {
    const { data: currentUser } = useCurrentUser();
    const navigate = useNavigate();
    const isManager = currentUser?.role === "manager" || currentUser?.role === "admin";

    if (!isManager) {
        return (
            <div className="max-w-4xl mx-auto px-4 py-8 text-center">
                <Shield className="w-16 h-16 text-gray-400 mx-auto mb-4" />
                <h1 className="text-2xl font-bold text-gray-900 mb-2">Ğ”Ğ¾ÑÑ‚ÑƒĞ¿ Ğ¾Ğ³Ñ€Ğ°Ğ½Ğ¸Ñ‡ĞµĞ½</h1>
                <p className="text-gray-600 mb-4">
                    Ğ£ Ğ²Ğ°Ñ Ğ½ĞµÑ‚ Ğ¿Ñ€Ğ°Ğ² Ğ´Ğ»Ñ Ğ´Ğ¾ÑÑ‚ÑƒĞ¿Ğ° Ğº ÑÑ‚Ğ¾Ğ¼Ñƒ Ñ€Ğ°Ğ·Ğ´ĞµĞ»Ñƒ.
                </p>
                <Button onClick={() => navigate("/")}>ĞĞ° Ğ³Ğ»Ğ°Ğ²Ğ½ÑƒÑ</Button>
            </div>
        );
    }

    return (
        <div className="max-w-7xl mx-auto px-4 py-6 space-y-6">
            <AdminNavigation />
            <div className="flex items-center gap-3">
                <Paperclip className="w-8 h-8 text-purple-600" />
                <div>
                    <h1 className="text-3xl font-bold text-gray-900">
                        Ğ£Ğ¿Ñ€Ğ°Ğ²Ğ»ĞµĞ½Ğ¸Ğµ Ğ°ĞºÑĞµÑÑÑƒĞ°Ñ€Ğ°Ğ¼Ğ¸
                    </h1>
                    <p className="text-gray-600 mt-1">
                        Ğ”Ğ¾Ğ±Ğ°Ğ²Ğ»ĞµĞ½Ğ¸Ğµ, Ñ€ĞµĞ´Ğ°ĞºÑ‚Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ Ğ¸ ÑƒĞ´Ğ°Ğ»ĞµĞ½Ğ¸Ğµ Ğ°ĞºÑĞµÑÑÑƒĞ°Ñ€Ğ¾Ğ².
                    </p>
                </div>
            </div>
            <div className="bg-white rounded-lg border shadow-sm p-6">
                {/* âœ… Ğ—ĞĞœĞ•ĞĞ¯Ğ•Ğœ Ğ—ĞĞ“Ğ›Ğ£Ğ¨ĞšĞ£ ĞĞ ĞšĞĞœĞŸĞĞĞ•ĞĞ¢ */}
                <AccessoryTable />
            </div>
        </div>
    );
}

```


## <a name="rentalappmainsrcpagesCalendarPagetsx"></a>`rental-app-main/src/pages/CalendarPage.tsx`

```tsx
// path: rental-app-main/src/pages/CalendarPage.tsx

// src/pages/CalendarPage.tsx

import { useEffect, useState, useMemo, useCallback } from "react";
import { useDateStore } from "@/store/dateStore";
import { useEquipment } from "@/hooks/useEquipment";
import { useAllEquipment } from "@/hooks/useAllEquipment"; // ++ 1. Ğ˜Ğ¼Ğ¿Ğ¾Ñ€Ñ‚Ğ¸Ñ€ÑƒĞµĞ¼ Ñ…ÑƒĞº Ğ´Ğ»Ñ Ğ¿Ğ¾Ğ»ÑƒÑ‡ĞµĞ½Ğ¸Ñ Ğ²ÑĞµÑ… Ğ´Ğ°Ğ½Ğ½Ñ‹Ñ… Ğ´Ğ»Ñ Ñ„Ğ¸Ğ»ÑŒÑ‚Ñ€Ğ¾Ğ²
import CalendarFiltersBlock from "@/components/calendar/CalendarFiltersBlock";
import CalendarTable from "@/components/calendar/CalendarTable";
import { useCalendarSelectionStore } from "@/store/calendarSelectionStore";
import { Button } from "@/components/ui/button";
import { Home, ArrowLeft, Loader2 } from "lucide-react";
import { useNavigate } from "react-router-dom";

export default function CalendarPage() {
    const { setRange } = useDateStore();
    const { setSelectedGroupId } = useCalendarSelectionStore();
    const navigate = useNavigate();

    // -- Ğ£Ğ´Ğ°Ğ»ÑĞµĞ¼ Ğ½ĞµĞ¸ÑĞ¿Ğ¾Ğ»ÑŒĞ·ÑƒĞµĞ¼Ñ‹Ğ¹ currentUser --

    const [typeFilter, setTypeFilter] = useState<string | null>(null);
    const [brandFilter, setBrandFilter] = useState<string | null>(null);
    const [searchText, setSearchText] = useState<string>("");
    const [isLoadingAll, setIsLoadingAll] = useState(false);

    // ++ 2. ĞŸĞ¾Ğ»ÑƒÑ‡Ğ°ĞµĞ¼ ĞŸĞĞ›ĞĞ«Ğ™ ÑĞ¿Ğ¸ÑĞ¾Ğº Ğ¾Ğ±Ğ¾Ñ€ÑƒĞ´Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ ĞĞ”Ğ˜Ğ Ñ€Ğ°Ğ· Ğ´Ğ»Ñ Ğ³ĞµĞ½ĞµÑ€Ğ°Ñ†Ğ¸Ğ¸ Ğ¾Ğ¿Ñ†Ğ¸Ğ¹ Ğ² Ñ„Ğ¸Ğ»ÑŒÑ‚Ñ€Ğ°Ñ… ++
    const { data: allEquipmentForFilters = [] } = useAllEquipment();

    // ++ 3. ĞŸĞ¾Ğ»ÑƒÑ‡Ğ°ĞµĞ¼ ĞŸĞĞ“Ğ˜ĞĞ˜Ğ ĞĞ’ĞĞĞĞ«Ğ™ Ğ¸ ÑƒĞ¶Ğµ Ğ¾Ñ‚Ñ„Ğ¸Ğ»ÑŒÑ‚Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ½Ñ‹Ğ¹ ÑĞµÑ€Ğ²ĞµÑ€Ğ¾Ğ¼ ÑĞ¿Ğ¸ÑĞ¾Ğº Ğ´Ğ»Ñ Ğ¾Ñ‚Ğ¾Ğ±Ñ€Ğ°Ğ¶ĞµĞ½Ğ¸Ñ Ğ² Ñ‚Ğ°Ğ±Ğ»Ğ¸Ñ†Ğµ ++
    const {
        data: equipmentPages,
        fetchNextPage,
        hasNextPage,
        isFetchingNextPage
    } = useEquipment({
        type: typeFilter,
        brand: brandFilter,
        query: searchText
    });

    const paginatedAndFilteredEquipment = useMemo(() => equipmentPages?.pages.flatMap(page => page.items) ?? [], [equipmentPages]);

    // ++ 4. ĞĞ±Ğ¾Ñ€Ğ°Ñ‡Ğ¸Ğ²Ğ°ĞµĞ¼ Ñ„ÑƒĞ½ĞºÑ†Ğ¸Ñ Ğ² useCallback Ğ¸ Ğ´Ğ¾Ğ±Ğ°Ğ²Ğ»ÑĞµĞ¼ Ğ² Ğ·Ğ°Ğ²Ğ¸ÑĞ¸Ğ¼Ğ¾ÑÑ‚Ğ¸ useEffect, Ñ‡Ñ‚Ğ¾Ğ±Ñ‹ Ğ¸ÑĞ¿Ñ€Ğ°Ğ²Ğ¸Ñ‚ÑŒ Ğ¿Ñ€ĞµĞ´ÑƒĞ¿Ñ€ĞµĞ¶Ğ´ĞµĞ½Ğ¸Ğµ ++
    const resetToDefaultRange = useCallback(() => {
        const today = new Date();
        const expectedStart = new Date(today);
        expectedStart.setDate(today.getDate() - 3);
        const expectedEnd = new Date(today);
        expectedEnd.setDate(today.getDate() + 13);
        setRange(expectedStart, expectedEnd);
    }, [setRange]);

    useEffect(() => {
        resetToDefaultRange();
    }, [resetToDefaultRange]);

    const handleResetAll = () => {
        resetToDefaultRange();
        setTypeFilter(null);
        setBrandFilter(null);
        setSearchText("");
        setSelectedGroupId(null);
    };

    const handleLoadAll = () => {
        setIsLoadingAll(true);
    };

    useEffect(() => {
        if (isLoadingAll && hasNextPage && !isFetchingNextPage) {
            // ++ 5. Ğ”Ğ¾Ğ±Ğ°Ğ²Ğ»ÑĞµĞ¼ `void` Ñ‡Ñ‚Ğ¾Ğ±Ñ‹ Ğ¸ÑĞ¿Ñ€Ğ°Ğ²Ğ¸Ñ‚ÑŒ Ğ¿Ñ€ĞµĞ´ÑƒĞ¿Ñ€ĞµĞ¶Ğ´ĞµĞ½Ğ¸Ğµ Ğ¾ Ğ½ĞµĞ¸ÑĞ¿Ğ¾Ğ»ÑŒĞ·ÑƒĞµĞ¼Ğ¾Ğ¼ Promise ++
            void fetchNextPage();
        }
        if (isLoadingAll && !hasNextPage && !isFetchingNextPage) {
            setIsLoadingAll(false);
        }
    }, [isLoadingAll, hasNextPage, isFetchingNextPage, fetchNextPage]);

    return (
        <div className="p-4 space-y-4">
            <div className="flex justify-between items-center mb-4">
                <div className="flex gap-2">
                    <Button variant="outline" onClick={() => navigate(-1)} className="flex items-center gap-2">
                        <ArrowLeft className="w-4 h-4" /> ĞĞ°Ğ·Ğ°Ğ´
                    </Button>
                    <Button variant="outline" onClick={() => navigate("/")} className="flex items-center gap-2">
                        <Home className="w-4 h-4" /> ĞĞ° Ğ³Ğ»Ğ°Ğ²Ğ½ÑƒÑ
                    </Button>
                </div>
            </div>

            <div className="flex flex-wrap gap-4 p-4 bg-white rounded-lg border shadow-sm mb-4">
                <div className="flex items-center gap-2"><div className="w-4 h-4 bg-emerald-50 rounded"></div><span className="text-sm">Ğ¡Ğ²Ğ¾Ğ±Ğ¾Ğ´Ğ½Ğ¾</span></div>
                <div className="flex items-center gap-2"><div className="w-4 h-4 bg-amber-300 rounded"></div><span className="text-sm">Ğ ĞµĞ·ĞµÑ€Ğ²</span></div>
                <div className="flex items-center gap-2"><div className="w-4 h-4 bg-rose-400 rounded"></div><span className="text-sm">ĞÑ€ĞµĞ½Ğ´Ğ°</span></div>
                {/* ĞŸÑ€Ğ¾Ğ²ĞµÑ€ĞºÑƒ Ğ½Ğ° currentUser Ğ¼Ğ¾Ğ¶Ğ½Ğ¾ ÑƒĞ±Ñ€Ğ°Ñ‚ÑŒ, ĞµÑĞ»Ğ¸ Ğ¾Ğ½Ğ° Ğ±Ğ¾Ğ»ÑŒÑˆĞµ Ğ½Ğ¸Ğ³Ğ´Ğµ Ğ½Ğµ Ğ¸ÑĞ¿Ğ¾Ğ»ÑŒĞ·ÑƒĞµÑ‚ÑÑ, Ğ»Ğ¸Ğ±Ğ¾ Ğ¾ÑÑ‚Ğ°Ğ²Ğ¸Ñ‚ÑŒ Ğ´Ğ»Ñ Ğ±ÑƒĞ´ÑƒÑ‰Ğ¸Ñ… Ñ€Ğ°ÑÑˆĞ¸Ñ€ĞµĞ½Ğ¸Ğ¹ */}
                <div className="flex items-center gap-2"><div className="w-4 h-4 bg-amber-500 rounded"></div><span className="text-sm">ĞœĞ¾Ğ¹ Ñ€ĞµĞ·ĞµÑ€Ğ²</span></div>
            </div>

            {/* ++ 6. ĞŸĞµÑ€ĞµĞ´Ğ°ĞµĞ¼ ĞŸĞĞ›ĞĞ«Ğ™ ÑĞ¿Ğ¸ÑĞ¾Ğº Ğ² Ğ±Ğ»Ğ¾Ğº Ñ„Ğ¸Ğ»ÑŒÑ‚Ñ€Ğ¾Ğ² Ğ´Ğ»Ñ Ğ³ĞµĞ½ĞµÑ€Ğ°Ñ†Ğ¸Ğ¸ Ğ²ÑĞµÑ… Ğ¾Ğ¿Ñ†Ğ¸Ğ¹ ++ */}
            <CalendarFiltersBlock
                equipment={allEquipmentForFilters}
                typeFilter={typeFilter}
                setTypeFilter={setTypeFilter}
                brandFilter={brandFilter}
                setBrandFilter={setBrandFilter}
                searchText={searchText}
                setSearchText={setSearchText}
                onReset={handleResetAll}
            />
            {/* ++ 7. ĞŸĞµÑ€ĞµĞ´Ğ°ĞµĞ¼ ĞŸĞĞ“Ğ˜ĞĞ˜Ğ ĞĞ’ĞĞĞĞ«Ğ™ ÑĞ¿Ğ¸ÑĞ¾Ğº Ğ² Ñ‚Ğ°Ğ±Ğ»Ğ¸Ñ†Ñƒ Ğ´Ğ»Ñ Ğ¾Ñ‚Ğ¾Ğ±Ñ€Ğ°Ğ¶ĞµĞ½Ğ¸Ñ ++ */}
            <CalendarTable equipment={paginatedAndFilteredEquipment} />

            {hasNextPage && (
                <div className="flex justify-center items-center gap-4 mt-4">
                    <Button variant="outline" onClick={() => fetchNextPage()} disabled={isFetchingNextPage || isLoadingAll}>
                        {isFetchingNextPage && !isLoadingAll ? (
                            <><Loader2 className="mr-2 h-4 w-4 animate-spin" /> Ğ—Ğ°Ğ³Ñ€ÑƒĞ·ĞºĞ°...</>
                        ) : ( "Ğ—Ğ°Ğ³Ñ€ÑƒĞ·Ğ¸Ñ‚ÑŒ ĞµÑ‰Ñ‘" )}
                    </Button>
                    <Button variant="secondary" onClick={handleLoadAll} disabled={isFetchingNextPage || isLoadingAll}>
                        {isLoadingAll ? (
                            <><Loader2 className="mr-2 h-4 w-4 animate-spin" /> Ğ—Ğ°Ğ³Ñ€ÑƒĞ·ĞºĞ° Ğ²ÑĞµÑ…...</>
                        ) : ( "Ğ—Ğ°Ğ³Ñ€ÑƒĞ·Ğ¸Ñ‚ÑŒ Ğ²ÑÑ‘" )}
                    </Button>
                </div>
            )}
        </div>
    );
}

```


## <a name="rentalappmainsrcpagesCalendarTestPagetsx"></a>`rental-app-main/src/pages/CalendarTestPage.tsx`

```tsx
// path: rental-app-main/src/pages/CalendarTestPage.tsx

// src/pages/CalendarTestPage.tsx
// Ğ­Ñ‚Ğ¾Ñ‚ Ñ„Ğ°Ğ¹Ğ» ÑĞ¾Ğ´ĞµÑ€Ğ¶Ğ¸Ñ‚ Ğ¿Ğ¾Ğ»Ğ½Ñ‹Ğ¹ ĞºĞ¾Ğ´ Ğ´Ğ»Ñ ÑÑ‚Ñ€Ğ°Ğ½Ğ¸Ñ†Ñ‹ Ñ ĞºĞ°ÑÑ‚Ğ¾Ğ¼Ğ¸Ğ·Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ½Ñ‹Ğ¼ ĞºĞ°Ğ»ĞµĞ½Ğ´Ğ°Ñ€Ñ‘Ğ¼.

import { useState } from 'react';
import { DayPicker, type DateRange } from 'react-day-picker';
import { ru } from 'date-fns/locale'; // Ğ˜Ğ¼Ğ¿Ğ¾Ñ€Ñ‚Ğ¸Ñ€ÑƒĞµĞ¼ Ñ€ÑƒÑÑĞºÑƒÑ Ğ»Ğ¾ĞºĞ°Ğ»ÑŒ Ğ´Ğ»Ñ Ğ½Ğ°Ğ·Ğ²Ğ°Ğ½Ğ¸Ğ¹

export default function CalendarTestPage() {
    // Ğ›Ğ¾ĞºĞ°Ğ»ÑŒĞ½Ğ¾Ğµ ÑĞ¾ÑÑ‚Ğ¾ÑĞ½Ğ¸Ğµ Ğ´Ğ»Ñ Ñ…Ñ€Ğ°Ğ½ĞµĞ½Ğ¸Ñ Ğ²Ñ‹Ğ±Ñ€Ğ°Ğ½Ğ½Ğ¾Ğ³Ğ¾ Ğ´Ğ¸Ğ°Ğ¿Ğ°Ğ·Ğ¾Ğ½Ğ° Ğ´Ğ°Ñ‚
    const [range, setRange] = useState<DateRange | undefined>();

    return (
        // ĞšĞ¾Ğ½Ñ‚ĞµĞ¹Ğ½ĞµÑ€ Ğ´Ğ»Ñ Ñ†ĞµĞ½Ñ‚Ñ€Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ ĞºĞ°Ğ»ĞµĞ½Ğ´Ğ°Ñ€Ñ Ğ½Ğ° ÑÑ‚Ñ€Ğ°Ğ½Ğ¸Ñ†Ğµ
        <div className="p-10 bg-gray-100 min-h-screen flex flex-col items-center justify-center">
            <h1 className="text-3xl font-bold text-gray-800 text-center mb-6">
                Ğ¢ĞµÑÑ‚Ğ¾Ğ²Ñ‹Ğ¹ ĞºĞ°Ğ»ĞµĞ½Ğ´Ğ°Ñ€ÑŒ Ñ ĞºÑ€Ğ°ÑĞ½Ñ‹Ğ¼ Ğ²Ñ‹Ğ´ĞµĞ»ĞµĞ½Ğ¸ĞµĞ¼
            </h1>

            <div className="bg-white p-4 rounded-lg shadow-lg border">
                <DayPicker
                    mode="range"
                    locale={ru} // Ğ˜ÑĞ¿Ğ¾Ğ»ÑŒĞ·ÑƒĞµĞ¼ Ñ€ÑƒÑÑĞºÑƒÑ Ğ»Ğ¾ĞºĞ°Ğ»ÑŒ
                    selected={range}
                    onSelect={setRange}
                    numberOfMonths={2}
                    showOutsideDays
                    // Ğ¡Ñ‚Ğ¸Ğ»Ğ¸ Ğ´Ğ»Ñ Ğ¾ÑĞ½Ğ¾Ğ²Ğ½Ñ‹Ñ… ÑĞ»ĞµĞ¼ĞµĞ½Ñ‚Ğ¾Ğ² ĞºĞ°Ğ»ĞµĞ½Ğ´Ğ°Ñ€Ñ, Ğ²Ğ·ÑÑ‚Ñ‹Ğµ Ğ¸Ğ· Ğ²Ğ°ÑˆĞµĞ³Ğ¾ Ğ¿Ñ€Ğ¾ĞµĞºÑ‚Ğ°
                    classNames={{
                        months: 'flex flex-col sm:flex-row space-y-4 sm:space-x-4 sm:space-y-0',
                        month: 'space-y-4',
                        table: 'w-full border-collapse space-y-1',
                        head_row: 'flex',
                        head_cell: 'text-muted-foreground rounded-md w-9 font-normal text-[0.8rem]',
                        row: 'flex w-full mt-2',
                        cell: 'h-9 w-9 text-center text-sm p-0 relative [&:has([aria-selected])]:bg-accent first:[&:has([aria-selected])]:rounded-l-md last:[&:has([aria-selected])]:rounded-r-md focus-within:relative focus-within:z-20',
                        day: 'h-9 w-9 p-0 font-normal aria-selected:opacity-100',
                        nav: 'space-x-1 flex items-center',
                        caption: 'flex justify-center pt-1 relative items-center',
                        caption_label: 'text-sm font-medium',
                        nav_button: 'h-7 w-7 bg-transparent p-0 opacity-50 hover:opacity-100'
                    }}
                    // Ğ¡Ñ‚Ğ¸Ğ»Ğ¸ Ğ´Ğ»Ñ ÑĞ¾ÑÑ‚Ğ¾ÑĞ½Ğ¸Ğ¹ Ğ´Ğ½ĞµĞ¹ (Ğ¼Ğ¾Ğ´Ğ¸Ñ„Ğ¸ĞºĞ°Ñ‚Ğ¾Ñ€Ğ¾Ğ²)
                    modifiersClassNames={{
                        today: 'bg-accent text-accent-foreground',
                        // Ğ¡Ğ¸Ğ½Ğ¸Ğµ Ñ†Ğ²ĞµÑ‚Ğ° Ğ´Ğ»Ñ Ğ²Ñ‹Ğ±Ñ€Ğ°Ğ½Ğ½Ñ‹Ñ… Ğ´Ğ°Ñ‚
                        selected: 'bg-sky-600 text-white hover:bg-sky-600 hover:text-white focus:bg-sky-600 focus:text-white',
                        // Ğ¡ĞºÑ€ÑƒĞ³Ğ»ĞµĞ½Ğ¸Ñ Ğ´Ğ»Ñ Ğ½Ğ°Ñ‡Ğ°Ğ»Ğ° Ğ¸ ĞºĞ¾Ğ½Ñ†Ğ° Ğ´Ğ¸Ğ°Ğ¿Ğ°Ğ·Ğ¾Ğ½Ğ°
                        range_start: 'rounded-l-full',
                        range_end: 'rounded-r-full',
                        range_middle: 'aria-selected:bg-sky-100 aria-selected:text-sky-900',
                        outside: 'day-outside text-muted-foreground opacity-50',
                        disabled: 'text-muted-foreground opacity-50',
                    }}
                />
            </div>
            <div className="mt-4 p-4 bg-white rounded-lg shadow-lg border text-sm text-gray-700">
                <p>Ğ’Ñ‹Ğ±Ñ€Ğ°Ğ½Ğ½Ñ‹Ğ¹ Ğ´Ğ¸Ğ°Ğ¿Ğ°Ğ·Ğ¾Ğ½:</p>
                {range?.from ? (
                    <pre className="mt-2 font-mono">{JSON.stringify(range, null, 2)}</pre>
                ) : (
                    <p className="text-gray-500 italic mt-1">ĞĞ¸Ñ‡ĞµĞ³Ğ¾ Ğ½Ğµ Ğ²Ñ‹Ğ±Ñ€Ğ°Ğ½Ğ¾</p>
                )}
            </div>
        </div>
    );
}

```


## <a name="rentalappmainsrcpagesContactPagetsx"></a>`rental-app-main/src/pages/ContactPage.tsx`

```tsx
// path: rental-app-main/src/pages/ContactPage.tsx

// src/pages/ContactPage.tsx
import { Button } from "@/components/ui/button"
import { useNavigate, useLocation } from "react-router-dom"

export default function ContactPage() {
    const navigate = useNavigate()
    const location = useLocation()

    const backTo = location.state?.from || -1

    const telegramBot = "d30manager"
    const message = encodeURIComponent(
        "Ğ—Ğ´Ñ€Ğ°Ğ²ÑÑ‚Ğ²ÑƒĞ¹Ñ‚Ğµ, Ñ Ñ…Ğ¾Ñ‡Ñƒ Ğ¾Ñ‚Ğ¼ĞµĞ½Ğ¸Ñ‚ÑŒ Ñ€ĞµĞ·ĞµÑ€Ğ². Ğ”Ğ¾ ĞµĞ³Ğ¾ Ğ¾ĞºĞ¾Ğ½Ñ‡Ğ°Ğ½Ğ¸Ñ Ğ¾ÑÑ‚Ğ°Ğ»Ğ¾ÑÑŒ Ğ¼ĞµĞ½ĞµĞµ 2 Ğ´Ğ½ĞµĞ¹."
    )
    const telegramLink = `https://t.me/${telegramBot}?start=${message}`

    return (
        <div className="max-w-2xl mx-auto px-4 py-6 sm:py-8 space-y-6">
            <h1 className="text-2xl font-bold text-center sm:text-left">Ğ¡Ğ²ÑĞ·ÑŒ Ñ Ğ¼ĞµĞ½ĞµĞ´Ğ¶ĞµÑ€Ğ¾Ğ¼</h1>

            <p className="text-sm text-gray-700">
                Ğ•ÑĞ»Ğ¸ Ğ²Ñ‹ Ñ…Ğ¾Ñ‚Ğ¸Ñ‚Ğµ Ğ¾Ñ‚Ğ¼ĞµĞ½Ğ¸Ñ‚ÑŒ Ñ€ĞµĞ·ĞµÑ€Ğ², Ğ´Ğ¾ Ğ¾ĞºĞ¾Ğ½Ñ‡Ğ°Ğ½Ğ¸Ñ ĞºĞ¾Ñ‚Ğ¾Ñ€Ğ¾Ğ³Ğ¾ Ğ¾ÑÑ‚Ğ°Ğ»Ğ¾ÑÑŒ Ğ¼ĞµĞ½ĞµĞµ 2-Ñ… Ğ´Ğ½ĞµĞ¹,
                Ğ¿Ğ¾Ğ¶Ğ°Ğ»ÑƒĞ¹ÑÑ‚Ğ°, ÑĞ²ÑĞ¶Ğ¸Ñ‚ĞµÑÑŒ Ñ Ğ½Ğ°Ğ¼Ğ¸ Ğ»ÑĞ±Ñ‹Ğ¼ ÑƒĞ´Ğ¾Ğ±Ğ½Ñ‹Ğ¼ ÑĞ¿Ğ¾ÑĞ¾Ğ±Ğ¾Ğ¼:
            </p>

            <ul className="text-sm text-gray-800 list-disc list-inside space-y-1">
                <li>Email:{" "}
                    <a href="mailto:info@digital30.ru" className="text-sky-600 hover:underline">
                        info@digital30.ru
                    </a>
                </li>
                <li>Ğ¢ĞµĞ»ĞµÑ„Ğ¾Ğ½: <span className="font-semibold">+7 (908) 6177177</span></li>
                <li>Telegram:{" "}
                    <a href={`https://t.me/${telegramBot}`} className="text-sky-600 hover:underline">
                        @{telegramBot}
                    </a>
                </li>
            </ul>

            <div className="flex flex-col sm:flex-row gap-3 pt-4 sm:pt-6">
                <Button
                    onClick={() => window.open(telegramLink, "_blank")}
                    variant="default"
                    className="w-full sm:w-auto"
                >
                    ğŸ’¬ ĞĞ°Ğ¿Ğ¸ÑĞ°Ñ‚ÑŒ Ğ² Telegram
                </Button>

                <Button
                    variant="outline"
                    onClick={() => typeof backTo === "string" ? navigate(backTo) : navigate(-1)}
                    className="w-full sm:w-auto"
                >
                    â† Ğ’ĞµÑ€Ğ½ÑƒÑ‚ÑŒÑÑ Ğ½Ğ°Ğ·Ğ°Ğ´
                </Button>
            </div>
        </div>
    )
}


```


## <a name="rentalappmainsrcpagesEquipmentManagementPagetsx"></a>`rental-app-main/src/pages/EquipmentManagementPage.tsx`

```tsx
// path: rental-app-main/src/pages/EquipmentManagementPage.tsx

// src/pages/EquipmentManagementPage.tsx

import { useState, useEffect, useMemo } from "react";
import { useCurrentUser } from "@/hooks/useProfile";
import AdminNavigation from "@/components/admin/AdminNavigation";
import EquipmentTable from "@/components/admin/EquipmentTable";
import EquipmentEditDialog from "@/components/admin/EquipmentEditDialog";
import { Button } from "@/components/ui/button";
import { Shield, Package } from "lucide-react";
import { useNavigate } from "react-router-dom";
import type { Equipment } from "@/types/equipment";
import { useEquipment } from "@/hooks/useEquipment";
import type { EquipmentListResponse } from "@/core/services/EquipmentService";

export default function EquipmentManagementPage() {
    const { data: currentUser } = useCurrentUser();
    const navigate = useNavigate();

    // âœ… Ğ˜Ğ—ĞœĞ•ĞĞ•ĞĞ˜Ğ•: ĞŸĞ¾Ğ»ÑƒÑ‡Ğ°ĞµĞ¼ Ğ¸Ğ· Ñ…ÑƒĞºĞ° Ğ´Ğ¾Ğ¿Ğ¾Ğ»Ğ½Ğ¸Ñ‚ĞµĞ»ÑŒĞ½Ñ‹Ğµ Ğ´Ğ°Ğ½Ğ½Ñ‹Ğµ Ğ´Ğ»Ñ Ğ¿Ğ°Ğ³Ğ¸Ğ½Ğ°Ñ†Ğ¸Ğ¸
    const {
        data: equipmentPages,
        fetchNextPage,
        hasNextPage,
        isFetchingNextPage
    } = useEquipment();

    // "Ğ Ğ°ÑĞ¿Ğ»ÑÑ‰Ğ¸Ğ²Ğ°ĞµĞ¼" ÑÑ‚Ñ€Ğ°Ğ½Ğ¸Ñ†Ñ‹ Ğ² Ğ¾Ğ´Ğ¸Ğ½ Ğ¾Ğ±Ñ‰Ğ¸Ğ¹ Ğ¼Ğ°ÑÑĞ¸Ğ² Ñ Ğ¿Ğ¾Ğ¼Ğ¾Ñ‰ÑŒÑ useMemo
    const allEquipment = useMemo(() =>
            equipmentPages?.pages.flatMap((page: EquipmentListResponse) => page.items) ?? [],
        [equipmentPages]);

    const [selectedEquipment, setSelectedEquipment] = useState<Equipment | null>(null);
    const [showEditDialog, setShowEditDialog] = useState(false);

    const isAdmin = currentUser?.role === "admin";
    const isManager = currentUser?.role === "manager" || isAdmin;

    useEffect(() => {
        if (!showEditDialog) {
            document.body.style.overflow = '';
        }
    }, [showEditDialog]);

    if (!isManager) {
        return (
            <div className="max-w-4xl mx-auto px-4 py-8">
                <div className="text-center">
                    <Shield className="w-16 h-16 text-gray-400 mx-auto mb-4" />
                    <h1 className="text-2xl font-bold text-gray-900 mb-2">
                        Ğ”Ğ¾ÑÑ‚ÑƒĞ¿ Ğ¾Ğ³Ñ€Ğ°Ğ½Ğ¸Ñ‡ĞµĞ½
                    </h1>
                    <p className="text-gray-600 mb-4">
                        Ğ£ Ğ²Ğ°Ñ Ğ½ĞµÑ‚ Ğ¿Ñ€Ğ°Ğ² Ğ´Ğ»Ñ Ğ´Ğ¾ÑÑ‚ÑƒĞ¿Ğ° Ğº ÑƒĞ¿Ñ€Ğ°Ğ²Ğ»ĞµĞ½Ğ¸Ñ Ğ¾Ğ±Ğ¾Ñ€ÑƒĞ´Ğ¾Ğ²Ğ°Ğ½Ğ¸ĞµĞ¼.
                    </p>
                    <Button onClick={() => navigate("/")}>
                        ĞĞ° Ğ³Ğ»Ğ°Ğ²Ğ½ÑƒÑ
                    </Button>
                </div>
            </div>
        );
    }

    const handleEditEquipment = (equipment: Equipment) => {
        setSelectedEquipment(equipment);
        setShowEditDialog(true);
    };

    const handleCloseDialog = () => {
        setShowEditDialog(false);
        setSelectedEquipment(null);
    };

    return (
        <div className="max-w-7xl mx-auto px-4 py-6 space-y-6">
            <AdminNavigation />

            <div className="flex items-center justify-between">
                <div className="flex items-center gap-3">
                    <Package className="w-8 h-8 text-green-600" />
                    <div>
                        <h1 className="text-3xl font-bold text-gray-900">
                            Ğ£Ğ¿Ñ€Ğ°Ğ²Ğ»ĞµĞ½Ğ¸Ğµ Ğ¾Ğ±Ğ¾Ñ€ÑƒĞ´Ğ¾Ğ²Ğ°Ğ½Ğ¸ĞµĞ¼
                        </h1>
                        <p className="text-gray-600 mt-1">
                            Ğ”Ğ¾Ğ±Ğ°Ğ²Ğ»ĞµĞ½Ğ¸Ğµ, Ñ€ĞµĞ´Ğ°ĞºÑ‚Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ Ğ¸ ÑƒĞ´Ğ°Ğ»ĞµĞ½Ğ¸Ğµ Ğ¾Ğ±Ğ¾Ñ€ÑƒĞ´Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ Ğ´Ğ»Ñ Ğ°Ñ€ĞµĞ½Ğ´Ñ‹
                        </p>
                    </div>
                </div>
            </div>

            <div className="bg-white rounded-lg border shadow-sm p-6">
                {/* âœ… Ğ˜Ğ—ĞœĞ•ĞĞ•ĞĞ˜Ğ•: ĞŸĞµÑ€ĞµĞ´Ğ°ĞµĞ¼ Ğ½Ğ¾Ğ²Ñ‹Ğµ ÑĞ²Ğ¾Ğ¹ÑÑ‚Ğ²Ğ° Ğ´Ğ»Ñ Ğ¿Ğ°Ğ³Ğ¸Ğ½Ğ°Ñ†Ğ¸Ğ¸ Ğ² Ñ‚Ğ°Ğ±Ğ»Ğ¸Ñ†Ñƒ */}
                <EquipmentTable
                    onEditEquipment={handleEditEquipment}
                    equipment={allEquipment}
                    onLoadMore={fetchNextPage}
                    hasNextPage={hasNextPage}
                    isFetchingNextPage={isFetchingNextPage}
                />
            </div>

            {/* Ğ‘Ğ»Ğ¾ĞºĞ¸ Ñ ÑĞ¾Ğ²ĞµÑ‚Ğ°Ğ¼Ğ¸ Ğ¸ ÑĞ¾ÑÑ‚Ğ¾ÑĞ½Ğ¸ÑĞ¼Ğ¸ Ğ¾ÑÑ‚Ğ°ÑÑ‚ÑÑ Ğ±ĞµĞ· Ğ¸Ğ·Ğ¼ĞµĞ½ĞµĞ½Ğ¸Ğ¹ */}
            <div className="bg-blue-50 border border-blue-200 rounded-lg p-4">
                <h3 className="font-semibold text-blue-900 mb-3">ğŸ’¡ ĞŸĞ¾Ğ»ĞµĞ·Ğ½Ñ‹Ğµ ÑĞ¾Ğ²ĞµÑ‚Ñ‹</h3>
                <div className="grid grid-cols-1 md:grid-cols-2 gap-4 text-sm text-blue-800">
                    <div>
                        <p className="font-medium mb-2">Ğ”Ğ¾Ğ±Ğ°Ğ²Ğ»ĞµĞ½Ğ¸Ğµ Ğ¾Ğ±Ğ¾Ñ€ÑƒĞ´Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ:</p>
                        <ul className="space-y-1">
                            <li>â€¢ Ğ£ĞºĞ°Ğ·Ñ‹Ğ²Ğ°Ğ¹Ñ‚Ğµ Ğ¿Ğ¾Ğ´Ñ€Ğ¾Ğ±Ğ½Ğ¾Ğµ Ğ¾Ğ¿Ğ¸ÑĞ°Ğ½Ğ¸Ğµ Ğ´Ğ»Ñ ĞºĞ»Ğ¸ĞµĞ½Ñ‚Ğ¾Ğ²</li>
                            <li>â€¢ Ğ”Ğ¾Ğ±Ğ°Ğ²Ğ»ÑĞ¹Ñ‚Ğµ ÑĞµÑ€Ğ¸Ğ¹Ğ½Ñ‹Ğµ Ğ½Ğ¾Ğ¼ĞµÑ€Ğ° Ğ´Ğ»Ñ ÑƒÑ‡ĞµÑ‚Ğ°</li>
                            <li>â€¢ Ğ£ÑÑ‚Ğ°Ğ½Ğ°Ğ²Ğ»Ğ¸Ğ²Ğ°Ğ¹Ñ‚Ğµ Ğ°ĞºÑ‚ÑƒĞ°Ğ»ÑŒĞ½Ñ‹Ğµ Ñ‚Ğ°Ñ€Ğ¸Ñ„Ñ‹</li>
                        </ul>
                    </div>
                    <div>
                        <p className="font-medium mb-2">Ğ£Ğ¿Ñ€Ğ°Ğ²Ğ»ĞµĞ½Ğ¸Ğµ:</p>
                        <ul className="space-y-1">
                            <li>â€¢ Ğ˜ÑĞ¿Ğ¾Ğ»ÑŒĞ·ÑƒĞ¹Ñ‚Ğµ Ğ¿Ğ¾Ğ¸ÑĞº Ğ´Ğ»Ñ Ğ±Ñ‹ÑÑ‚Ñ€Ğ¾Ğ³Ğ¾ Ğ½Ğ°Ñ…Ğ¾Ğ¶Ğ´ĞµĞ½Ğ¸Ñ</li>
                            <li>â€¢ Ğ’Ñ‹Ğ´ĞµĞ»ÑĞ¹Ñ‚Ğµ Ğ½ĞµÑĞºĞ¾Ğ»ÑŒĞºĞ¾ ÑĞ»ĞµĞ¼ĞµĞ½Ñ‚Ğ¾Ğ² Ğ´Ğ»Ñ Ğ¼Ğ°ÑÑĞ¾Ğ²Ñ‹Ñ… Ğ¾Ğ¿ĞµÑ€Ğ°Ñ†Ğ¸Ğ¹</li>
                            <li>â€¢ Ğ ĞµĞ³ÑƒĞ»ÑÑ€Ğ½Ğ¾ Ğ¾Ğ±Ğ½Ğ¾Ğ²Ğ»ÑĞ¹Ñ‚Ğµ ÑĞ¾ÑÑ‚Ğ¾ÑĞ½Ğ¸Ğµ Ğ¾Ğ±Ğ¾Ñ€ÑƒĞ´Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ</li>
                        </ul>
                    </div>
                </div>
            </div>
            <div className="bg-gray-50 rounded-lg p-4">
                <h3 className="font-semibold text-gray-900 mb-3">Ğ¡Ğ¾ÑÑ‚Ğ¾ÑĞ½Ğ¸Ñ Ğ¾Ğ±Ğ¾Ñ€ÑƒĞ´Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ</h3>
                <div className="grid grid-cols-2 md:grid-cols-5 gap-3 text-sm">
                    <div className="bg-green-100 text-green-800 p-2 rounded text-center">
                        <div className="font-medium">Ğ’ĞµĞ»Ğ¸ĞºĞ¾Ğ»ĞµĞ¿Ğ½Ğ¾</div>
                        <div className="text-xs">ĞšĞ°Ğº Ğ½Ğ¾Ğ²Ğ¾Ğµ</div>
                    </div>
                    <div className="bg-blue-100 text-blue-800 p-2 rounded text-center">
                        <div className="font-medium">ĞÑ‚Ğ»Ğ¸Ñ‡Ğ½Ğ¾</div>
                        <div className="text-xs">ĞœĞ¸Ğ½Ğ¸Ğ¼Ğ°Ğ»ÑŒĞ½Ñ‹Ğ¹ Ğ¸Ğ·Ğ½Ğ¾Ñ</div>
                    </div>
                    <div className="bg-yellow-100 text-yellow-800 p-2 rounded text-center">
                        <div className="font-medium">Ğ¥Ğ¾Ñ€Ğ¾ÑˆĞ¾</div>
                        <div className="text-xs">ĞĞµĞ±Ğ¾Ğ»ÑŒÑˆĞ¸Ğµ Ğ¿Ğ¾Ñ‚ĞµÑ€Ñ‚Ğ¾ÑÑ‚Ğ¸</div>
                    </div>
                    <div className="bg-orange-100 text-orange-800 p-2 rounded text-center">
                        <div className="font-medium">Ğ£Ğ´Ğ¾Ğ²Ğ»ĞµÑ‚Ğ²Ğ¾Ñ€Ğ¸Ñ‚ĞµĞ»ÑŒĞ½Ğ¾</div>
                        <div className="text-xs">Ğ—Ğ°Ğ¼ĞµÑ‚Ğ½Ñ‹Ğ¹ Ğ¸Ğ·Ğ½Ğ¾Ñ</div>
                    </div>
                    <div className="bg-red-100 text-red-800 p-2 rounded text-center">
                        <div className="font-medium">Ğ¢Ñ€ĞµĞ±ÑƒĞµÑ‚ Ñ€ĞµĞ¼Ğ¾Ğ½Ñ‚Ğ°</div>
                        <div className="text-xs">ĞĞµ ÑĞ´Ğ°ĞµÑ‚ÑÑ</div>
                    </div>
                </div>
            </div>

            {selectedEquipment && (
                <EquipmentEditDialog
                    open={showEditDialog}
                    onClose={handleCloseDialog}
                    equipment={selectedEquipment}
                />
            )}
        </div>
    );
}

```


## <a name="rentalappmainsrcpagesHomePagetsx"></a>`rental-app-main/src/pages/HomePage.tsx`

```tsx
// path: rental-app-main/src/pages/HomePage.tsx

// src/pages/HomePage.tsx

import { useEffect, useRef, useState, useMemo } from "react";
import { useNavigate, useLocation } from "react-router-dom";
import { useReserveStore } from "@/store/reserveStore";
import { X } from "lucide-react";

// ĞšĞ¾Ğ¼Ğ¿Ğ¾Ğ½ĞµĞ½Ñ‚Ñ‹
import AuthStatus from "@/components/AuthStatus";
import DateRangeSelector from "@/components/DateRangeSelector";
import DiscountCalculator from "@/components/DiscountCalculator";
import ReservationFooter from "@/components/ReservationFooter";
import EquipmentCatalog from "@/components/catalog/EquipmentCatalog";
import UserSession from "@/components/session/UserSession";
import { Button } from "@/components/ui/button";

// Ğ¥ÑƒĞºĞ¸
import { useReservationManagement } from "@/hooks/useReservationManagement";
import { useDateStore } from "@/store/dateStore";
import { useHolidayStore } from "@/store/holidayStore";
import { useEquipmentData } from "@/hooks/data/useEquipmentData";
import { useAppFilters } from "@/hooks/features/useAppFilters";

export default function HomePage() {
    const navigate = useNavigate();
    const location = useLocation();
    const containerRef = useRef<HTMLDivElement>(null);
    const { clearItemsOnly, items: selectedItems = [] } = useReserveStore();
    
    // ĞŸĞ¾Ğ»ÑƒÑ‡Ğ°ĞµĞ¼ Ğ½ÑƒĞ¶Ğ½Ñ‹Ğµ Ğ´Ğ°Ğ½Ğ½Ñ‹Ğµ Ğ¸ Ñ„ÑƒĞ½ĞºÑ†Ğ¸Ğ¸ Ğ¸Ğ· Ñ…Ñ€Ğ°Ğ½Ğ¸Ğ»Ğ¸Ñ‰
    const { setRange, initializeDates } = useDateStore();
    const { holidays, fetchHolidays } = useHolidayStore();
    const [datesInitialized, setDatesInitialized] = useState(false);

    // ĞŸĞ¾Ğ»ÑƒÑ‡Ğ°ĞµĞ¼ ÑĞ¾ÑÑ‚Ğ¾ÑĞ½Ğ¸Ğµ Ñ„Ğ¸Ğ»ÑŒÑ‚Ñ€Ğ¾Ğ² Ğ´Ğ»Ñ Ğ¿ĞµÑ€ĞµĞ´Ğ°Ñ‡Ğ¸ Ğ² EquipmentCatalog
    const { query, type, brand, availableOnly, associationId, startDate, endDate } = useAppFilters();

    // ĞŸĞ¾Ğ»ÑƒÑ‡Ğ°ĞµĞ¼ Ğ´Ğ°Ğ½Ğ½Ñ‹Ğµ Ğ¾Ğ±Ğ¾Ñ€ÑƒĞ´Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ Ğ´Ğ»Ñ useReservationManagement
    const {
        equipment,
        availabilityData,
    } = useEquipmentData({ query, type, brand, associationId, availableOnly, startDate, endDate });

    // Ğ¡Ğ¾Ğ·Ğ´Ğ°ĞµĞ¼ availabilityMap Ğ¸Ğ· availabilityData Ğ´Ğ»Ñ useReservationManagement
    const availabilityMap = useMemo(() => {
        const map: Record<number, any> = {};
        availabilityData?.forEach((info) => {
            map[info.equipment_id] = info;
        });
        return map;
    }, [availabilityData]);

    // ĞŸĞ¾Ğ»ÑƒÑ‡Ğ°ĞµĞ¼ Ğ»Ğ¾Ğ³Ğ¸ĞºÑƒ ÑƒĞ¿Ñ€Ğ°Ğ²Ğ»ĞµĞ½Ğ¸Ñ Ñ€ĞµĞ·ĞµÑ€Ğ²Ğ°Ğ¼Ğ¸
    const {
        editingReservationId,
        intent,
    } = useReservationManagement(equipment, availabilityMap, availableOnly);

    // +++ ĞĞĞ§ĞĞ›Ğ: Ğ”ĞĞ‘ĞĞ’Ğ›Ğ•ĞĞ Ğ›ĞĞ“Ğ˜ĞšĞ Ğ˜ĞĞ˜Ğ¦Ğ˜ĞĞ›Ğ˜Ğ—ĞĞ¦Ğ˜Ğ˜ Ğ”ĞĞ¢ +++
    // 1. Ğ—Ğ°Ğ³Ñ€ÑƒĞ¶Ğ°ĞµĞ¼ Ğ²Ñ‹Ñ…Ğ¾Ğ´Ğ½Ñ‹Ğµ Ğ¿Ñ€Ğ¸ Ğ¼Ğ¾Ğ½Ñ‚Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğ¸ ĞºĞ¾Ğ¼Ğ¿Ğ¾Ğ½ĞµĞ½Ñ‚Ğ°
    useEffect(() => {
        const today = new Date();
        const futureDate = new Date();
        futureDate.setDate(today.getDate() + 30); // Ğ—Ğ°Ğ³Ñ€ÑƒĞ¶Ğ°ĞµĞ¼ Ğ½Ğ° 30 Ğ´Ğ½ĞµĞ¹ Ğ²Ğ¿ĞµÑ€ĞµĞ´
        fetchHolidays(today, futureDate);
    }, [fetchHolidays]);

    // 2. Ğ˜Ğ½Ğ¸Ñ†Ğ¸Ğ°Ğ»Ğ¸Ğ·Ğ¸Ñ€ÑƒĞµĞ¼ Ğ´Ğ°Ñ‚Ñ‹, ĞºĞ°Ğº Ñ‚Ğ¾Ğ»ÑŒĞºĞ¾ Ğ²Ñ‹Ñ…Ğ¾Ğ´Ğ½Ñ‹Ğµ Ğ·Ğ°Ğ³Ñ€ÑƒĞ¶ĞµĞ½Ñ‹
    useEffect(() => {
        // Ğ’Ñ‹Ğ¿Ğ¾Ğ»Ğ½ÑĞµĞ¼ Ñ‚Ğ¾Ğ»ÑŒĞºĞ¾ Ğ¾Ğ´Ğ¸Ğ½ Ñ€Ğ°Ğ·, ĞºĞ¾Ğ³Ğ´Ğ° Ğ¿Ğ¾ÑĞ²Ğ¸Ğ»Ğ¸ÑÑŒ Ğ´Ğ°Ğ½Ğ½Ñ‹Ğµ Ğ¾ Ğ²Ñ‹Ñ…Ğ¾Ğ´Ğ½Ñ‹Ñ…
        if (holidays.length > 0 && !datesInitialized) {
            initializeDates(holidays);
            setDatesInitialized(true);
        }
    }, [holidays, initializeDates, datesInitialized]);
    // +++ ĞšĞĞĞ•Ğ¦ +++

    // Ğ¡Ğ¸Ğ½Ñ…Ñ€Ğ¾Ğ½Ğ¸Ğ·Ğ°Ñ†Ğ¸Ñ Ğ´Ğ°Ñ‚ Ğ¸Ğ· ÑĞ¾ÑÑ‚Ğ¾ÑĞ½Ğ¸Ñ Ğ½Ğ°Ğ²Ğ¸Ğ³Ğ°Ñ†Ğ¸Ğ¸
    useEffect(() => {
        const start = (location.state as any)?.startDate;
        const end = (location.state as any)?.endDate;
        if (start && end) {
            const startDate = new Date(start);
            const endDate = new Date(end);
            setRange(startDate, endDate, 'manual', holidays); // ĞŸĞµÑ€ĞµĞ´Ğ°ĞµĞ¼ Ğ¿Ñ€Ğ°Ğ·Ğ´Ğ½Ğ¸ĞºĞ¸ Ğ´Ğ»Ñ ĞºĞ¾Ñ€Ñ€ĞµĞºÑ‚Ğ½Ğ¾Ğ³Ğ¾ Ñ€Ğ°ÑÑ‡ĞµÑ‚Ğ°
        }
    }, [location.state, setRange, holidays]);

    const handleCompleteAddition = () => {
        const { addToReservationMode } = useReserveStore.getState();
        if (addToReservationMode) {
            navigate(location.state?.from || "/reservations/my", {
                replace: true,
                state: {
                    continueEditing: addToReservationMode,
                },
            });
        } else {
            navigate("/reserve/create");
        }
    };

    const handleCancelAddition = () => {
        useReserveStore.getState().clear();
        navigate("/reservations/my", {
            replace: true,
            state: {
                continueEditing: editingReservationId,
            },
        });
    };

    return (
        <div className="bg-gray-50 min-h-screen">
            <div ref={containerRef} className="max-w-7xl mx-auto px-4 py-6 space-y-4 pb-20">
                <AuthStatus />
                <UserSession />

                {editingReservationId && (
                    <div className="flex items-center justify-between p-3 bg-sky-100 border border-sky-300 text-sky-700 rounded-md text-sm shadow">
                        <span>
                            Ğ’Ñ‹ Ğ´Ğ¾Ğ±Ğ°Ğ²Ğ»ÑĞµÑ‚Ğµ Ğ¾Ğ±Ğ¾Ñ€ÑƒĞ´Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ Ğº Ñ€ĞµĞ·ĞµÑ€Ğ²Ñƒ <strong>#{editingReservationId}</strong>. ĞšĞ¾Ğ³Ğ´Ğ° Ğ·Ğ°ĞºĞ¾Ğ½Ñ‡Ğ¸Ñ‚Ğµ, Ğ½Ğ°Ğ¶Ğ¼Ğ¸Ñ‚Ğµ ĞºĞ½Ğ¾Ğ¿ĞºÑƒ Ğ²Ğ½Ğ¸Ğ·Ñƒ ÑÑ‚Ñ€Ğ°Ğ½Ğ¸Ñ†Ñ‹.
                        </span>
                        <Button
                            variant="ghost"
                            size="sm"
                            onClick={handleCancelAddition}
                            className="text-sky-700 hover:bg-sky-200 hover:text-sky-800 flex-shrink-0"
                        >
                            <X className="w-4 h-4 mr-1.5" />
                            ĞÑ‚Ğ¼ĞµĞ½Ğ¸Ñ‚ÑŒ Ğ´Ğ¾Ğ±Ğ°Ğ²Ğ»ĞµĞ½Ğ¸Ğµ
                        </Button>
                    </div>
                )}

                <h1 className="text-2xl font-bold mt-4 text-center">ĞšĞ°Ñ‚Ğ°Ğ»Ğ¾Ğ³ Ğ¾Ğ±Ğ¾Ñ€ÑƒĞ´Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ</h1>

                <DateRangeSelector containerRef={containerRef} />
                <DiscountCalculator />

                <EquipmentCatalog 
                    editingReservationId={editingReservationId}
                    intent={intent}
                />
            </div>

            <ReservationFooter
                selectedCount={selectedItems.length}
                onClick={handleCompleteAddition}
                onReset={clearItemsOnly}
                isEditingMode={!!editingReservationId}
                intent={intent || ''}
            />
        </div>
    );
}

```


## <a name="rentalappmainsrcpagesMyReservationsPagetsx"></a>`rental-app-main/src/pages/MyReservationsPage.tsx`

```tsx
// path: rental-app-main/src/pages/MyReservationsPage.tsx

// src/pages/MyReservationsPage.tsx
import { useState, useEffect, useMemo } from "react";
import { useNavigate, useLocation } from "react-router-dom";
import { Button } from "@/components/ui/button";
import { ToggleGroup, ToggleGroupItem } from "@/components/ui/toggle-group";
import MyReservationList from "../components/MyReservationList";
import { useCurrentUser } from "@/hooks/useProfile";
import UserInfoBlock from "@/components/UserInfoBlock";
import { useMyRentals } from "@/hooks/useMyRentals";
import MyRentalsList from "@/components/rental/MyRentalsList";
import { ClipboardList, Truck } from "lucide-react";
import OrderToolbar from "@/components/shared/OrderToolbar";
import { useOrderFilterStore } from "@/store/orderFilterStore";
import { useReservations } from "@/hooks/useReservations";

interface MyReservationsLocationState {
    from?: string;
    continueEditing?: number;
    highlightRentalId?: number;
    highlightReservationId?: number;
}

export default function MyReservationsPage() {
    const { data: user, isLoading } = useCurrentUser();
    const navigate = useNavigate();
    const location = useLocation();

    const [activeTab, setActiveTab] = useState<'reservations' | 'rentals'>('reservations');
    const [highlightId, setHighlightId] = useState<number | null>(null);

    const locationState = location.state as MyReservationsLocationState | null;

    const cameFrom = locationState?.from;
    const continueEditingReservationId = locationState?.continueEditing;

    // ĞŸĞ¾Ğ»ÑƒÑ‡Ğ°ĞµĞ¼ Ğ¿Ğ°Ñ€Ğ°Ğ¼ĞµÑ‚Ñ€Ñ‹ Ñ„Ğ¸Ğ»ÑŒÑ‚Ñ€Ğ°Ñ†Ğ¸Ğ¸ Ğ¸Ğ· ÑÑ‚Ğ¾Ñ€Ğ°
    const { searchQuery, statusFilter, sortOption } = useOrderFilterStore();

    // ĞĞ¿Ñ€ĞµĞ´ĞµĞ»ÑĞµĞ¼ ĞºĞ¾Ğ½Ñ‚ĞµĞºÑÑ‚ Ğ´Ğ»Ñ OrderToolbar
    const toolbarContext = useMemo(() => {
        return activeTab === 'reservations' ? 'user-reservations' : 'user-rentals';
    }, [activeTab]);

    // ĞŸĞ¾Ğ´Ğ³Ğ¾Ñ‚Ğ°Ğ²Ğ»Ğ¸Ğ²Ğ°ĞµĞ¼ Ğ¿Ğ°Ñ€Ğ°Ğ¼ĞµÑ‚Ñ€Ñ‹ Ğ´Ğ»Ñ API Ğ·Ğ°Ğ¿Ñ€Ğ¾ÑĞ¾Ğ²
    const apiParams = useMemo(() => ({
        search: searchQuery || undefined,
        status: statusFilter === 'all' ? undefined : statusFilter,
        sort: sortOption
    }), [searchQuery, statusFilter, sortOption]);

    // ĞŸĞ¾Ğ»ÑƒÑ‡Ğ°ĞµĞ¼ Ğ´Ğ°Ğ½Ğ½Ñ‹Ğµ Ñ ÑĞµÑ€Ğ²ĞµÑ€Ğ½Ğ¾Ğ¹ Ñ„Ğ¸Ğ»ÑŒÑ‚Ñ€Ğ°Ñ†Ğ¸ĞµĞ¹
    const { reservationsQuery } = useReservations(apiParams);
    const { data: rentalsData } = useMyRentals(apiParams);

    useEffect(() => {
        const { highlightRentalId, highlightReservationId } = locationState || {};
        if (highlightRentalId) {
            setActiveTab('rentals');
            setHighlightId(highlightRentalId);
        } else if (highlightReservationId) {
            setActiveTab('reservations');
            setHighlightId(highlightReservationId);
        }
    }, [locationState]);

    useEffect(() => {
        // Ğ¡Ğ±Ñ€Ğ¾Ñ Ğ¿Ğ¾Ğ´ÑĞ²ĞµÑ‚ĞºĞ¸ Ñ‡ĞµÑ€ĞµĞ· Ğ½ĞµĞºĞ¾Ñ‚Ğ¾Ñ€Ğ¾Ğµ Ğ²Ñ€ĞµĞ¼Ñ
        if (highlightId) {
            const timer = setTimeout(() => {
                setHighlightId(null);
                navigate(location.pathname, { replace: true, state: {} });
            }, 2500);
            return () => clearTimeout(timer);
        }
    }, [highlightId, navigate, location.pathname]);

    useEffect(() => {
        if (continueEditingReservationId) {
            console.log(`[MyReservationsPage] Processing return from equipment addition to reservation #${continueEditingReservationId}`);
        }
    }, [continueEditingReservationId]);

    if (isLoading) {
        return (
            <p className="text-center mt-12 text-sm text-gray-500">
                Ğ—Ğ°Ğ³Ñ€ÑƒĞ·ĞºĞ° Ğ¿Ñ€Ğ¾Ñ„Ğ¸Ğ»Ñ...
            </p>
        );
    }

    if (!user) {
        return (
            <div className="text-center mt-12">
                <p className="text-lg">
                    Ğ¢Ğ¾Ğ»ÑŒĞºĞ¾ Ğ°Ğ²Ñ‚Ğ¾Ñ€Ğ¸Ğ·Ğ¾Ğ²Ğ°Ğ½Ğ½Ñ‹Ğµ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ğ¸ Ğ¼Ğ¾Ğ³ÑƒÑ‚ Ğ¿Ñ€Ğ¾ÑĞ¼Ğ°Ñ‚Ñ€Ğ¸Ğ²Ğ°Ñ‚ÑŒ ÑĞ²Ğ¾Ğ¸ Ñ€ĞµĞ·ĞµÑ€Ğ²Ñ‹.
                </p>
                <Button className="mt-4" onClick={() => navigate("/reserve/create")}>
                    Ğ’Ğ¾Ğ¹Ñ‚Ğ¸ Ğ¸ Ğ¾Ñ„Ğ¾Ñ€Ğ¼Ğ¸Ñ‚ÑŒ Ñ€ĞµĞ·ĞµÑ€Ğ²
                </Button>
            </div>
        );
    }

    const handleEditProfile = () => {
        navigate("/profile", { state: { from: location.pathname } });
    };

    return (
        <div className="max-w-4xl mx-auto px-4 py-6 space-y-6">
            <div className="mb-6">
                <UserInfoBlock onEditProfile={handleEditProfile} />
            </div>

            <div className="flex items-center justify-between">
                <h1 className="text-2xl font-bold">ĞœĞ¾Ğ¸ Ğ·Ğ°ĞºĞ°Ğ·Ñ‹</h1>
                <div className="flex items-center gap-3">
                    <Button variant="secondary" onClick={() => navigate(cameFrom || "/")}>
                        â† ĞĞ°Ğ·Ğ°Ğ´
                    </Button>
                    <Button variant="outline" onClick={() => navigate("/")}>
                        ĞĞ° Ğ³Ğ»Ğ°Ğ²Ğ½ÑƒÑ
                    </Button>
                </div>
            </div>

            {/* Ğ’ĞºĞ»Ğ°Ğ´ĞºĞ¸ */}
            <ToggleGroup
                type="single"
                value={activeTab}
                onValueChange={(value) => { if (value) setActiveTab(value as any); }}
                className="w-full"
            >
                <ToggleGroupItem value="reservations" className="w-1/2 data-[state=on]:bg-sky-100 data-[state=on]:text-sky-800">
                    <ClipboardList className="w-4 h-4 mr-2" />
                    Ğ ĞµĞ·ĞµÑ€Ğ²Ñ‹
                </ToggleGroupItem>
                <ToggleGroupItem value="rentals" className="w-1/2 data-[state=on]:bg-orange-100 data-[state=on]:text-orange-800">
                    <Truck className="w-4 h-4 mr-2" />
                    ĞÑ€ĞµĞ½Ğ´Ñ‹
                </ToggleGroupItem>
            </ToggleGroup>

            {/* Ğ£Ğ²ĞµĞ´Ğ¾Ğ¼Ğ»ĞµĞ½Ğ¸Ğµ Ğ¾ Ñ€ĞµĞ´Ğ°ĞºÑ‚Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğ¸ Ñ€ĞµĞ·ĞµÑ€Ğ²Ğ° */}
            {continueEditingReservationId && activeTab === 'reservations' && (
                <div className="p-3 bg-sky-100 border border-sky-300 text-sky-700 rounded-md text-sm">
                    Ğ’Ñ‹ Ğ²ĞµÑ€Ğ½ÑƒĞ»Ğ¸ÑÑŒ Ğº Ñ€ĞµĞ´Ğ°ĞºÑ‚Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ Ñ€ĞµĞ·ĞµÑ€Ğ²Ğ° #{continueEditingReservationId}. Ğ’Ñ‹Ğ±Ñ€Ğ°Ğ½Ğ½Ñ‹Ğµ Ğ¿Ğ¾Ğ·Ğ¸Ñ†Ğ¸Ğ¸ Ğ´Ğ¾Ğ±Ğ°Ğ²Ğ»ĞµĞ½Ñ‹.
                </div>
            )}

            {/* Ğ¢ÑƒĞ»Ğ±Ğ°Ñ€ Ñ„Ğ¸Ğ»ÑŒÑ‚Ñ€Ğ°Ñ†Ğ¸Ğ¸ */}
            <OrderToolbar context={toolbarContext} showHideCompletedCheckbox={true} />

            {/* Ğ£ÑĞ»Ğ¾Ğ²Ğ½Ñ‹Ğ¹ Ñ€ĞµĞ½Ğ´ĞµÑ€Ğ¸Ğ½Ğ³ ÑĞ¿Ğ¸ÑĞºĞ¾Ğ² */}
            <div>
                {activeTab === 'reservations' ? (
                    <MyReservationList
                        continueEditingReservationId={continueEditingReservationId}
                        highlightId={highlightId}
                        reservationsData={reservationsQuery.data}
                        isLoading={reservationsQuery.isLoading}
                        isError={reservationsQuery.isError}
                    />
                ) : (
                    <MyRentalsList 
                        highlightId={highlightId}
                        rentalsData={rentalsData}
                    />
                )}
            </div>
        </div>
    );
}

```


## <a name="rentalappmainsrcpagesProfilePagetsx"></a>`rental-app-main/src/pages/ProfilePage.tsx`

```tsx
// path: rental-app-main/src/pages/ProfilePage.tsx

// src/pages/ProfilePage.tsx

import { useState, useEffect } from "react"
import { Input } from "@/components/ui/input"
import { Label } from "@/components/ui/label"
import { Button } from "@/components/ui/button"
import { useNavigate, useLocation } from "react-router-dom"
import { useProfileUpdate, useCurrentUser } from "@/hooks/useProfile"
import { useAuthStore } from "@/store/authStore"
import { toast } from "sonner"
import { PhoneInput } from "@/components/ui/phone-input"
import { Alert, AlertDescription } from "@/components/ui/alert"
import { AlertCircle, CheckCircle } from "lucide-react"
// âœ… 1. Ğ˜Ğ¼Ğ¿Ğ¾Ñ€Ñ‚Ğ¸Ñ€ÑƒĞµĞ¼ Ğ½Ğ°Ñˆ Ğ½Ğ¾Ğ²Ñ‹Ğ¹ ĞºĞ¾Ğ¼Ğ¿Ğ¾Ğ½ĞµĞ½Ñ‚ Ğ´Ğ»Ñ Ğ¾Ñ‚Ğ¾Ğ±Ñ€Ğ°Ğ¶ĞµĞ½Ğ¸Ñ Ğ¸ÑÑ‚Ğ¾Ñ€Ğ¸Ğ¸
import BalanceHistoryTable from "@/components/profile/BalanceHistoryTable";

// Ğ¤ÑƒĞ½ĞºÑ†Ğ¸Ñ Ğ²Ğ°Ğ»Ğ¸Ğ´Ğ°Ñ†Ğ¸Ğ¸ Ñ‚ĞµĞ»ĞµÑ„Ğ¾Ğ½Ğ°
const validatePhone = (phone: string): boolean => {
    if (!phone) return true; // ĞŸÑƒÑÑ‚Ğ¾Ğ¹ Ñ‚ĞµĞ»ĞµÑ„Ğ¾Ğ½ Ñ€Ğ°Ğ·Ñ€ĞµÑˆĞµĞ½
    return /^\+7 \(\d{3}\) \d{3}-\d{2}-\d{2}$/.test(phone);
};

export default function ProfilePage() {
    const navigate = useNavigate()
    const location = useLocation()
    const { logout } = useAuthStore()

    const backTo = location.state?.from || "/"

    const { data: user, isLoading } = useCurrentUser()
    const updateProfile = useProfileUpdate()

    const [fullName, setFullName] = useState("")
    const [email, setEmail] = useState("")
    const [phone, setPhone] = useState("")
    const [emailChanged, setEmailChanged] = useState(false)
    const [originalEmail, setOriginalEmail] = useState("")
    const [showEmailWarning, setShowEmailWarning] = useState(false)

    useEffect(() => {
        if (user) {
            setFullName(user.full_name)
            setEmail(user.email)
            setPhone(user.phone || "")
            setOriginalEmail(user.email)
        }
    }, [user])

    // ĞÑ‚ÑĞ»ĞµĞ¶Ğ¸Ğ²Ğ°ĞµĞ¼ Ğ¸Ğ·Ğ¼ĞµĞ½ĞµĞ½Ğ¸Ñ email
    useEffect(() => {
        if (originalEmail && email !== originalEmail) {
            setEmailChanged(true)
            setShowEmailWarning(true)
        } else {
            setEmailChanged(false)
            setShowEmailWarning(false)
        }
    }, [email, originalEmail])

    const handleUpdate = async (e: React.FormEvent) => {
        e.preventDefault()

        // Ğ’Ğ°Ğ»Ğ¸Ğ´Ğ°Ñ†Ğ¸Ñ Ñ‚ĞµĞ»ĞµÑ„Ğ¾Ğ½Ğ°
        if (!validatePhone(phone)) {
            toast.error("ĞĞµĞºĞ¾Ñ€Ñ€ĞµĞºÑ‚Ğ½Ñ‹Ğ¹ Ñ„Ğ¾Ñ€Ğ¼Ğ°Ñ‚ Ğ½Ğ¾Ğ¼ĞµÑ€Ğ° Ñ‚ĞµĞ»ĞµÑ„Ğ¾Ğ½Ğ°")
            return
        }

        try {
            // ĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑĞµĞ¼, Ğ¸Ğ·Ğ¼ĞµĞ½Ğ¸Ğ»ÑÑ Ğ»Ğ¸ email
            const emailChanged = user && email !== user.email;

            await updateProfile.mutateAsync({ full_name: fullName, email, phone }) // <<< Ğ˜Ğ—ĞœĞ•ĞĞ•ĞĞ˜Ğ•: ĞŸĞµÑ€ĞµĞ´Ğ°ĞµĞ¼ Ñ‚ĞµĞ»ĞµÑ„Ğ¾Ğ½
            toast.success("ĞŸÑ€Ğ¾Ñ„Ğ¸Ğ»ÑŒ ÑƒÑĞ¿ĞµÑˆĞ½Ğ¾ Ğ¾Ğ±Ğ½Ğ¾Ğ²Ğ»Ñ‘Ğ½")

            // <<< Ğ˜Ğ—ĞœĞ•ĞĞ•ĞĞ˜Ğ•: ĞŸĞ¾ĞºĞ°Ğ·Ñ‹Ğ²Ğ°ĞµĞ¼ ÑƒĞ²ĞµĞ´Ğ¾Ğ¼Ğ»ĞµĞ½Ğ¸Ğµ-Ğ·Ğ°Ğ³Ğ»ÑƒÑˆĞºÑƒ, ĞµÑĞ»Ğ¸ email Ğ±Ñ‹Ğ» Ğ¸Ğ·Ğ¼ĞµĞ½ĞµĞ½
            if (emailChanged) {
                toast.info("ĞĞ° Ğ²Ğ°ÑˆÑƒ Ğ½Ğ¾Ğ²ÑƒÑ Ğ¿Ğ¾Ñ‡Ñ‚Ñƒ Ğ¾Ñ‚Ğ¿Ñ€Ğ°Ğ²Ğ»ĞµĞ½Ğ° ÑÑÑ‹Ğ»ĞºĞ° Ğ´Ğ»Ñ Ğ¿Ğ¾Ğ´Ñ‚Ğ²ĞµÑ€Ğ¶Ğ´ĞµĞ½Ğ¸Ñ (Ñ„ÑƒĞ½ĞºÑ†Ğ¸Ğ¾Ğ½Ğ°Ğ» Ğ² Ñ€Ğ°Ğ·Ñ€Ğ°Ğ±Ğ¾Ñ‚ĞºĞµ).")
                // Ğ’ Ğ±ÑƒĞ´ÑƒÑ‰ĞµĞ¼ Ğ·Ğ´ĞµÑÑŒ Ğ¼Ğ¾Ğ¶Ğ½Ğ¾ Ğ±ÑƒĞ´ĞµÑ‚ ÑĞ±Ñ€Ğ¾ÑĞ¸Ñ‚ÑŒ email Ğ² Ñ„Ğ¾Ñ€Ğ¼Ğµ Ğ¾Ğ±Ñ€Ğ°Ñ‚Ğ½Ğ¾ Ğ½Ğ° ÑÑ‚Ğ°Ñ€Ñ‹Ğ¹,
                // Ğ¿Ğ¾ĞºĞ° Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ÑŒ Ğ½Ğµ Ğ¿Ğ¾Ğ´Ñ‚Ğ²ĞµÑ€Ğ´Ğ¸Ñ‚ Ğ½Ğ¾Ğ²Ñ‹Ğ¹.
            }

        } catch (err) {
            console.error(err)
            toast.error("ĞÑˆĞ¸Ğ±ĞºĞ° Ğ¿Ñ€Ğ¸ Ğ¾Ğ±Ğ½Ğ¾Ğ²Ğ»ĞµĞ½Ğ¸Ğ¸ Ğ¿Ñ€Ğ¾Ñ„Ğ¸Ğ»Ñ")
        }
    }

    if (isLoading) {
        return <p className="text-center mt-12 text-gray-500">Ğ—Ğ°Ğ³Ñ€ÑƒĞ·ĞºĞ°...</p>
    }

    if (!user) {
        return (
            <div className="text-center mt-12">
                <p className="text-lg">Ğ’Ñ‹ Ğ½Ğµ Ğ°Ğ²Ñ‚Ğ¾Ñ€Ğ¸Ğ·Ğ¾Ğ²Ğ°Ğ½Ñ‹.</p>
                <Button className="mt-4" onClick={() => navigate("/")}>
                    ĞĞ° Ğ³Ğ»Ğ°Ğ²Ğ½ÑƒÑ
                </Button>
            </div>
        )
    }

    return (
        // âœ… 2. Ğ£Ğ²ĞµĞ»Ğ¸Ñ‡Ğ¸Ğ²Ğ°ĞµĞ¼ Ğ¼Ğ°ĞºÑĞ¸Ğ¼Ğ°Ğ»ÑŒĞ½ÑƒÑ ÑˆĞ¸Ñ€Ğ¸Ğ½Ñƒ ĞºĞ¾Ğ½Ñ‚ĞµĞ¹Ğ½ĞµÑ€Ğ°, Ñ‡Ñ‚Ğ¾Ğ±Ñ‹ Ñ‚Ğ°Ğ±Ğ»Ğ¸Ñ†Ğ° Ğ¿Ğ¾Ğ¼ĞµÑÑ‚Ğ¸Ğ»Ğ°ÑÑŒ
        <div className="max-w-4xl mx-auto px-4 py-8 space-y-6">
            <div className="bg-white border rounded-lg shadow-sm p-6 space-y-4">
                <h1 className="text-xl font-bold text-center">Ğ ĞµĞ´Ğ°ĞºÑ‚Ğ¸Ñ€Ğ¾Ğ²Ğ°Ñ‚ÑŒ Ğ¿Ñ€Ğ¾Ñ„Ğ¸Ğ»ÑŒ</h1>

                <form onSubmit={handleUpdate} className="space-y-4">
                    <div>
                        <Label htmlFor="fullName">Ğ¤Ğ˜Ğ</Label>
                        <Input
                            id="fullName"
                            type="text"
                            value={fullName}
                            onChange={(e) => setFullName(e.target.value)}
                            required
                        />
                    </div>

                    <div>
                        <Label htmlFor="email">Email</Label>
                        <Input
                            id="email"
                            type="email"
                            value={email}
                            onChange={(e) => setEmail(e.target.value)}
                            required
                        />
                    </div>

                    {/* +++ ĞĞĞ§ĞĞ›Ğ: ĞĞ¾Ğ²Ğ¾Ğµ Ğ¿Ğ¾Ğ»Ğµ Ğ´Ğ»Ñ Ñ‚ĞµĞ»ĞµÑ„Ğ¾Ğ½Ğ° +++ */}
                    <div>
                        <Label htmlFor="phone">Ğ¢ĞµĞ»ĞµÑ„Ğ¾Ğ½</Label>
                        <PhoneInput
                            id="phone"
                            value={phone}
                            onChange={(e) => setPhone(e.target.value)}
                            placeholder="+7 (___) ___-__-__"
                        />
                    </div>
                    {/* +++ ĞšĞĞĞ•Ğ¦: ĞĞ¾Ğ²Ğ¾Ğµ Ğ¿Ğ¾Ğ»Ğµ Ğ´Ğ»Ñ Ñ‚ĞµĞ»ĞµÑ„Ğ¾Ğ½Ğ° +++ */}

                    {showEmailWarning && (
                        <Alert>
                            <AlertCircle className="h-4 w-4" />
                            <AlertDescription>
                                ĞŸĞ¾ÑĞ»Ğµ Ğ¸Ğ·Ğ¼ĞµĞ½ĞµĞ½Ğ¸Ñ email Ğ¿Ğ¾Ñ‚Ñ€ĞµĞ±ÑƒĞµÑ‚ÑÑ Ğ¿Ğ¾Ğ´Ñ‚Ğ²ĞµÑ€Ğ¶Ğ´ĞµĞ½Ğ¸Ğµ Ğ½Ğ¾Ğ²Ğ¾Ğ³Ğ¾ Ğ°Ğ´Ñ€ĞµÑĞ°.
                                ĞĞ° ÑƒĞºĞ°Ğ·Ğ°Ğ½Ğ½ÑƒÑ Ğ¿Ğ¾Ñ‡Ñ‚Ñƒ Ğ±ÑƒĞ´ĞµÑ‚ Ğ¾Ñ‚Ğ¿Ñ€Ğ°Ğ²Ğ»ĞµĞ½Ğ° ÑÑÑ‹Ğ»ĞºĞ° Ğ´Ğ»Ñ Ğ¿Ğ¾Ğ´Ñ‚Ğ²ĞµÑ€Ğ¶Ğ´ĞµĞ½Ğ¸Ñ.
                            </AlertDescription>
                        </Alert>
                    )}

                    <div className="flex justify-between items-center pt-2">
                        <Button type="submit" disabled={updateProfile.isPending}>
                            {updateProfile.isPending ? "Ğ¡Ğ¾Ñ…Ñ€Ğ°Ğ½ĞµĞ½Ğ¸Ğµ..." : "Ğ¡Ğ¾Ñ…Ñ€Ğ°Ğ½Ğ¸Ñ‚ÑŒ"}
                        </Button>
                        <Button type="button" variant="ghost" onClick={() => navigate(backTo)}>
                            ĞĞ°Ğ·Ğ°Ğ´
                        </Button>
                    </div>
                </form>

                <div className="pt-4 border-t text-center space-y-2">
                    <p className="text-xs text-gray-500">
                        Ğ”Ğ»Ñ Ğ¸Ğ·Ğ¼ĞµĞ½ĞµĞ½Ğ¸Ñ Ğ¿Ğ°Ñ€Ğ¾Ğ»Ñ Ğ¾Ğ±Ñ€Ğ°Ñ‚Ğ¸Ñ‚ĞµÑÑŒ Ğº Ğ°Ğ´Ğ¼Ğ¸Ğ½Ğ¸ÑÑ‚Ñ€Ğ°Ñ‚Ğ¾Ñ€Ñƒ.
                    </p>
                    <Button
                        variant="link"
                        className="text-red-600"
                        onClick={() => {
                            logout()
                            navigate("/")
                        }}
                    >
                        Ğ’Ñ‹Ğ¹Ñ‚Ğ¸ Ğ¸Ğ· Ğ°ĞºĞºĞ°ÑƒĞ½Ñ‚Ğ°
                    </Button>
                </div>
            </div>

            {/* âœ… 3. Ğ”Ğ¾Ğ±Ğ°Ğ²Ğ»ÑĞµĞ¼ Ğ½Ğ¾Ğ²Ñ‹Ğ¹ Ğ±Ğ»Ğ¾Ğº Ñ Ğ¸ÑÑ‚Ğ¾Ñ€Ğ¸ĞµĞ¹ Ğ±Ğ°Ğ»Ğ°Ğ½ÑĞ° */}
            <div className="bg-white border rounded-lg shadow-sm p-6 space-y-4">
                <h2 className="text-xl font-bold">Ğ˜ÑÑ‚Ğ¾Ñ€Ğ¸Ñ Ğ±Ğ°Ğ»Ğ°Ğ½ÑĞ°</h2>
                <BalanceHistoryTable userId={user.id} />
            </div>
        </div>
    )
}

```


## <a name="rentalappmainsrcpagesReservePagetsx"></a>`rental-app-main/src/pages/ReservePage.tsx`

```tsx
// path: rental-app-main/src/pages/ReservePage.tsx

// src/pages/ReservePage.tsx
import { useNavigate, useLocation } from "react-router-dom";
import { useState, useMemo } from "react";
import AuthForm from "@/components/AuthForm";
import UserInfoBlock from "@/components/UserInfoBlock";
import CancelReservationDialog from "@/components/CancelReservationDialog";
import { Button } from "@/components/ui/button";
import { useReserveSubmission } from "@/hooks/reservation/submission/useReserveSubmission";
import { formatDate } from "@/lib/utils";
import { ShoppingCart } from "lucide-react";

import ReservationItemsList from "@/components/reservation/ReservationItemsList";
import FinancialSummaryBlock from "@/components/shared/FinancialSummaryBlock";

export default function ReservePage() {
    const navigate = useNavigate();
    const location = useLocation();

    const {
        items,
        user,
        startDate,
        endDate,
        setStartDate,
        setEndDate,
        availabilityMap,
        unavailableIdsFromAPI,
        invalidItems,
        submitMessage,
        reservationSuccess,
        clearReserveStore,
        removeItemFromStore,
        isAccessorySelected,
        toggleAccessory,
        isLoadingAvailability,
        isSubmitting,
        isApplyingPromoCode,
        priceDetails,
        accessoriesDailyTotal,
        promoCode,
        promoCodeMessage,
        applyPromoCode,
        setPromoCode,
        removePromoCode,
        handleSubmit,
        selectedAccessories,
    } = useReserveSubmission();

    const [showCancelDialog, setShowCancelDialog] = useState(false);

    const handleConfirmCancel = () => {
        clearReserveStore();
        navigate("/");
    };

    const isFormValid = useMemo(() => {
        return !!(user && invalidItems.length === 0 && unavailableIdsFromAPI.length === 0);
    }, [user, invalidItems.length, unavailableIdsFromAPI.length]);

    // âœ… Ğ”ĞĞ‘ĞĞ’Ğ›Ğ•ĞĞ: Ğ Ğ°ÑÑ‡ĞµÑ‚ Ğ¼Ğ¸Ğ½Ğ¸Ğ¼Ğ°Ğ»ÑŒĞ½Ğ¾Ğ¹ Ğ´Ğ°Ñ‚Ñ‹ Ğ´Ğ»Ñ Ğ¿Ğ¾Ğ»Ñ "ĞšĞ¾Ğ½ĞµÑ†"
    const minEndDate = useMemo(() => {
        const nextDay = new Date(startDate);
        nextDay.setDate(startDate.getDate() + 1);
        return formatDate(nextDay);
    }, [startDate]);

    if (items.length === 0 && !reservationSuccess) {
        return (
            <div className="text-center mt-12 p-4">
                <ShoppingCart className="mx-auto h-16 w-16 text-gray-300" />
                <p className="mt-4 text-lg text-gray-700">Ğ’Ğ°ÑˆĞ° ĞºĞ¾Ñ€Ğ·Ğ¸Ğ½Ğ° Ğ¿ÑƒÑÑ‚Ğ°.</p>
                <p className="mt-1 text-sm text-gray-500">Ğ’Ñ‹ ĞµÑ‰Ğµ Ğ½Ğµ Ğ²Ñ‹Ğ±Ñ€Ğ°Ğ»Ğ¸ Ğ¾Ğ±Ğ¾Ñ€ÑƒĞ´Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ Ğ´Ğ»Ñ Ñ€ĞµĞ·ĞµÑ€Ğ²Ğ°.</p>
                <Button
                    variant="default"
                    className="mt-6"
                    onClick={() => navigate("/", { state: { intent: "add_to_new_reservation" } })}
                >
                    ĞŸĞµÑ€ĞµĞ¹Ñ‚Ğ¸ Ğº Ğ²Ñ‹Ğ±Ğ¾Ñ€Ñƒ Ğ¾Ğ±Ğ¾Ñ€ÑƒĞ´Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ
                </Button>
            </div>
        );
    }

    if (reservationSuccess) {
        return (
            <div className="text-center pt-8 space-y-4 p-6 bg-green-50 rounded-lg border border-green-200 max-w-3xl mx-auto">
                <p className="text-xl font-semibold text-green-700">âœ… Ğ ĞµĞ·ĞµÑ€Ğ² ÑƒÑĞ¿ĞµÑˆĞ½Ğ¾ ÑĞ¾Ğ·Ğ´Ğ°Ğ½!</p>
                {submitMessage && (<p className="text-sm text-green-600">{submitMessage}</p>)}
                <div className="flex gap-3 justify-center">
                    <Button variant="outline" onClick={() => navigate("/")}>ĞĞ° Ğ³Ğ»Ğ°Ğ²Ğ½ÑƒÑ</Button>
                    <Button variant="default" onClick={() => navigate("/reservations/my")}>Ğš Ğ¼Ğ¾Ğ¸Ğ¼ Ñ€ĞµĞ·ĞµÑ€Ğ²Ğ°Ğ¼</Button>
                </div>
            </div>
        );
    }

    return (
        <>
            <div className="max-w-3xl mx-auto px-4 py-6 space-y-6">
                <div className="flex items-center justify-between">
                    <h1 className="text-2xl font-bold">ĞÑ„Ğ¾Ñ€Ğ¼Ğ»ĞµĞ½Ğ¸Ğµ Ñ€ĞµĞ·ĞµÑ€Ğ²Ğ°</h1>
                    <button
                        onClick={() => navigate("/", { state: { intent: "add_to_new_reservation" } })}
                        className="text-sm text-sky-600 hover:underline"
                    >
                        â† Ğ’ĞµÑ€Ğ½ÑƒÑ‚ÑŒÑÑ Ğº Ğ²Ñ‹Ğ±Ğ¾Ñ€Ñƒ
                    </button>
                </div>

                {!user ? <AuthForm /> : <UserInfoBlock onEditProfile={() => navigate("/profile", { state: { from: location.pathname } })} />}

                <div className="p-4 border rounded-md shadow-sm bg-white">
                    <h2 className="text-lg font-semibold mb-3 text-gray-700">Ğ”Ğ°Ñ‚Ñ‹ Ñ€ĞµĞ·ĞµÑ€Ğ²Ğ°:</h2>
                    <div className="flex flex-col sm:flex-row justify-center items-center gap-4">
                        <div className="flex flex-col items-start w-full sm:w-auto">
                            <label htmlFor="start-date" className="text-sm text-gray-600 mb-1">ĞĞ°Ñ‡Ğ°Ğ»Ğ¾:</label>
                            <input id="start-date" type="date" className="border rounded px-3 py-1 text-sm shadow-sm w-full focus:ring-sky-500 focus:border-sky-500"
                                   value={formatDate(startDate)}
                                   onChange={(e) => { const d = new Date(e.target.value); if(!isNaN(d.getTime())) setStartDate(d); }}
                                   min={formatDate(new Date())} />
                        </div>
                        <div className="flex flex-col items-start w-full sm:w-auto">
                            <label htmlFor="end-date" className="text-sm text-gray-600 mb-1">ĞšĞ¾Ğ½ĞµÑ†:</label>
                            <input id="end-date" type="date" className="border rounded px-3 py-1 text-sm shadow-sm w-full focus:ring-sky-500 focus:border-sky-500"
                                   value={formatDate(endDate)}
                                   onChange={(e) => { const d = new Date(e.target.value); if(!isNaN(d.getTime())) setEndDate(d); }}
                                // âœ… Ğ˜Ğ—ĞœĞ•ĞĞ•ĞĞ˜Ğ•: Ğ£ÑÑ‚Ğ°Ğ½Ğ¾Ğ²Ğ»ĞµĞ½Ğ¾ Ğ¼Ğ¸Ğ½Ğ¸Ğ¼Ğ°Ğ»ÑŒĞ½Ğ¾Ğµ Ğ·Ğ½Ğ°Ñ‡ĞµĞ½Ğ¸Ğµ Ğ´Ğ»Ñ Ğ¿Ğ¾Ğ»Ñ
                                   min={minEndDate} />
                        </div>
                    </div>
                </div>

                {isLoadingAvailability && <p className="text-center text-gray-500 py-3">ĞŸÑ€Ğ¾Ğ²ĞµÑ€ĞºĞ° Ğ´Ğ¾ÑÑ‚ÑƒĞ¿Ğ½Ğ¾ÑÑ‚Ğ¸...</p>}

                <ReservationItemsList
                    items={items}
                    selectedAccessories={selectedAccessories}
                    availabilityMap={availabilityMap}
                    unavailableIdsFromAPI={unavailableIdsFromAPI}
                    invalidItems={invalidItems}
                    onRemoveItem={removeItemFromStore}
                    onRemoveAccessory={toggleAccessory}
                    isAccessorySelected={isAccessorySelected}
                    onToggleAccessory={toggleAccessory}
                />

                <FinancialSummaryBlock
                    priceDetails={priceDetails}
                    accessoriesDailyTotal={accessoriesDailyTotal}
                    promoCode={promoCode}
                    setPromoCode={setPromoCode}
                    applyPromoCode={applyPromoCode}
                    removePromoCode={removePromoCode}
                    promoCodeMessage={promoCodeMessage}
                    isLoading={isLoadingAvailability}
                    isApplyingPromoCode={isApplyingPromoCode}
                    isSubmitting={isSubmitting}
                    isFormValid={isFormValid}
                    onCancel={() => setShowCancelDialog(true)}
                    onAddMore={() => navigate("/", { state: { intent: "add_to_new_reservation" } })}
                    onSubmit={handleSubmit}
                    variant="default"
                    showActions={true}
                />
            </div>

            <CancelReservationDialog
                open={showCancelDialog}
                onClose={() => setShowCancelDialog(false)}
                onConfirm={handleConfirmCancel}
            />
        </>
    );
}

```


## <a name="rentalappmainsrcpagesUserManagementPagetsx"></a>`rental-app-main/src/pages/UserManagementPage.tsx`

```tsx
// path: rental-app-main/src/pages/UserManagementPage.tsx

// src/pages/UserManagementPage.tsx

import { useMemo } from "react";
import { useCurrentUser } from "@/hooks/useProfile";
import { useAdminUsers } from "@/hooks/useAdminUsers";
import AdminNavigation from "@/components/admin/AdminNavigation";
import UserTable from "@/components/admin/UserTable";
import { Button } from "@/components/ui/button";
import { Shield, Users } from "lucide-react";
import { useNavigate } from "react-router-dom";

export default function UserManagementPage() {
    const { data: currentUser } = useCurrentUser();
    const navigate = useNavigate();
    
    // ĞŸĞ¾Ğ»ÑƒÑ‡Ğ°ĞµĞ¼ Ğ´Ğ°Ğ½Ğ½Ñ‹Ğµ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ĞµĞ¹ Ñ Ğ¿Ğ°Ğ³Ğ¸Ğ½Ğ°Ñ†Ğ¸ĞµĞ¹
    const {
        data: usersData,
        isLoading,
        error,
        fetchNextPage,
        hasNextPage,
        isFetchingNextPage,
    } = useAdminUsers();

    // ĞĞ±ÑŠĞµĞ´Ğ¸Ğ½ÑĞµĞ¼ Ğ²ÑĞµ ÑÑ‚Ñ€Ğ°Ğ½Ğ¸Ñ†Ñ‹ Ğ² Ğ¾Ğ´Ğ¸Ğ½ Ğ¼Ğ°ÑÑĞ¸Ğ² Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ĞµĞ¹
    const allUsers = useMemo(() => {
        if (!usersData?.pages) return [];
        return usersData.pages.flatMap(page => page.items);
    }, [usersData]);

    const isAdmin = currentUser?.role === "admin";
    const isManager = currentUser?.role === "manager" || isAdmin;

    // Ğ•ÑĞ»Ğ¸ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ÑŒ Ğ½Ğµ Ğ¸Ğ¼ĞµĞµÑ‚ Ğ¿Ñ€Ğ°Ğ² Ğ´Ğ¾ÑÑ‚ÑƒĞ¿Ğ°
    if (!isManager) {
        return (
            <div className="max-w-4xl mx-auto px-4 py-8">
                <div className="text-center">
                    <Shield className="w-16 h-16 text-gray-400 mx-auto mb-4" />
                    <h1 className="text-2xl font-bold text-gray-900 mb-2">
                        Ğ”Ğ¾ÑÑ‚ÑƒĞ¿ Ğ¾Ğ³Ñ€Ğ°Ğ½Ğ¸Ñ‡ĞµĞ½
                    </h1>
                    <p className="text-gray-600 mb-4">
                        Ğ£ Ğ²Ğ°Ñ Ğ½ĞµÑ‚ Ğ¿Ñ€Ğ°Ğ² Ğ´Ğ»Ñ Ğ´Ğ¾ÑÑ‚ÑƒĞ¿Ğ° Ğº ÑƒĞ¿Ñ€Ğ°Ğ²Ğ»ĞµĞ½Ğ¸Ñ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ÑĞ¼Ğ¸.
                    </p>
                    <Button onClick={() => navigate("/")}>
                        ĞĞ° Ğ³Ğ»Ğ°Ğ²Ğ½ÑƒÑ
                    </Button>
                </div>
            </div>
        );
    }

    return (
        <div className="max-w-7xl mx-auto px-4 py-6 space-y-6">
            <AdminNavigation />

            {/* Ğ—Ğ°Ğ³Ğ¾Ğ»Ğ¾Ğ²Ğ¾Ğº ÑÑ‚Ñ€Ğ°Ğ½Ğ¸Ñ†Ñ‹ */}
            <div className="flex items-center justify-between">
                <div className="flex items-center gap-3">
                    <Users className="w-8 h-8 text-blue-600" />
                    <div>
                        <h1 className="text-3xl font-bold text-gray-900">
                            Ğ£Ğ¿Ñ€Ğ°Ğ²Ğ»ĞµĞ½Ğ¸Ğµ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ÑĞ¼Ğ¸
                        </h1>
                        <p className="text-gray-600 mt-1">
                            {isAdmin
                                ? "Ğ£Ğ¿Ñ€Ğ°Ğ²Ğ»ĞµĞ½Ğ¸Ğµ ÑƒÑ‡ĞµÑ‚Ğ½Ñ‹Ğ¼Ğ¸ Ğ·Ğ°Ğ¿Ğ¸ÑÑĞ¼Ğ¸, Ñ€Ğ¾Ğ»ÑĞ¼Ğ¸ Ğ¸ Ğ¿Ñ€Ğ°Ğ²Ğ°Ğ¼Ğ¸ Ğ´Ğ¾ÑÑ‚ÑƒĞ¿Ğ°"
                                : "ĞŸÑ€Ğ¾ÑĞ¼Ğ¾Ñ‚Ñ€ Ğ·Ğ°Ñ€ĞµĞ³Ğ¸ÑÑ‚Ñ€Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ½Ñ‹Ñ… Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ĞµĞ¹ ÑĞ¸ÑÑ‚ĞµĞ¼Ñ‹"
                            }
                        </p>
                    </div>
                </div>
            </div>

            {/* ĞÑĞ½Ğ¾Ğ²Ğ½Ğ¾Ğ¹ ĞºĞ¾Ğ½Ñ‚ĞµĞ½Ñ‚ */}
            <div className="bg-white rounded-lg border shadow-sm p-6">
                <UserTable 
                    users={allUsers}
                    isLoading={isLoading}
                    error={error}
                    onLoadMore={fetchNextPage}
                    hasNextPage={hasNextPage}
                    isFetchingNextPage={isFetchingNextPage}
                />
            </div>

            {/* Ğ”Ğ¾Ğ¿Ğ¾Ğ»Ğ½Ğ¸Ñ‚ĞµĞ»ÑŒĞ½Ğ°Ñ Ğ¸Ğ½Ñ„Ğ¾Ñ€Ğ¼Ğ°Ñ†Ğ¸Ñ Ğ´Ğ»Ñ Ğ¼ĞµĞ½ĞµĞ´Ğ¶ĞµÑ€Ğ¾Ğ² */}
            {!isAdmin && (
                <div className="bg-amber-50 border border-amber-200 rounded-lg p-4">
                    <div className="flex items-start gap-3">
                        <Shield className="w-5 h-5 text-amber-600 mt-0.5" />
                        <div className="text-sm">
                            <p className="font-medium text-amber-800 mb-1">
                                ĞĞ³Ñ€Ğ°Ğ½Ğ¸Ñ‡ĞµĞ½Ğ½Ñ‹Ğ¹ Ğ´Ğ¾ÑÑ‚ÑƒĞ¿
                            </p>
                            <p className="text-amber-700">
                                ĞšĞ°Ğº Ğ¼ĞµĞ½ĞµĞ´Ğ¶ĞµÑ€, Ğ²Ñ‹ Ğ¼Ğ¾Ğ¶ĞµÑ‚Ğµ Ğ¿Ñ€Ğ¾ÑĞ¼Ğ°Ñ‚Ñ€Ğ¸Ğ²Ğ°Ñ‚ÑŒ ÑĞ¿Ğ¸ÑĞ¾Ğº Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ĞµĞ¹, Ğ½Ğ¾ Ğ½Ğµ Ğ¼Ğ¾Ğ¶ĞµÑ‚Ğµ:
                            </p>
                            <ul className="list-disc list-inside mt-2 text-amber-700 space-y-1">
                                <li>Ğ˜Ğ·Ğ¼ĞµĞ½ÑÑ‚ÑŒ Ñ€Ğ¾Ğ»Ğ¸ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ĞµĞ¹</li>
                                <li>Ğ‘Ğ»Ğ¾ĞºĞ¸Ñ€Ğ¾Ğ²Ğ°Ñ‚ÑŒ Ğ¸Ğ»Ğ¸ Ñ€Ğ°Ğ·Ğ±Ğ»Ğ¾ĞºĞ¸Ñ€Ğ¾Ğ²Ğ°Ñ‚ÑŒ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ĞµĞ¹</li>
                                <li>Ğ£Ğ´Ğ°Ğ»ÑÑ‚ÑŒ ÑƒÑ‡ĞµÑ‚Ğ½Ñ‹Ğµ Ğ·Ğ°Ğ¿Ğ¸ÑĞ¸</li>
                            </ul>
                            <p className="text-amber-700 mt-2">
                                Ğ”Ğ»Ñ Ğ²Ñ‹Ğ¿Ğ¾Ğ»Ğ½ĞµĞ½Ğ¸Ñ ÑÑ‚Ğ¸Ñ… Ğ´ĞµĞ¹ÑÑ‚Ğ²Ğ¸Ğ¹ Ğ¾Ğ±Ñ€Ğ°Ñ‚Ğ¸Ñ‚ĞµÑÑŒ Ğº Ğ°Ğ´Ğ¼Ğ¸Ğ½Ğ¸ÑÑ‚Ñ€Ğ°Ñ‚Ğ¾Ñ€Ñƒ.
                            </p>
                        </div>
                    </div>
                </div>
            )}

            {/* Ğ˜Ğ½Ñ„Ğ¾Ñ€Ğ¼Ğ°Ñ†Ğ¸Ñ Ğ¾ Ñ€Ğ¾Ğ»ÑÑ… */}
            <div className="bg-gray-50 rounded-lg p-4">
                <h3 className="font-semibold text-gray-900 mb-3">ĞĞ¿Ğ¸ÑĞ°Ğ½Ğ¸Ğµ Ñ€Ğ¾Ğ»ĞµĞ¹ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ĞµĞ¹</h3>
                <div className="grid grid-cols-1 md:grid-cols-3 gap-4 text-sm">
                    <div className="bg-white p-3 rounded border">
                        <div className="font-medium text-gray-900 mb-2">ğŸ‘¤ ĞŸĞ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ÑŒ</div>
                        <ul className="text-gray-600 space-y-1">
                            <li>â€¢ ĞŸÑ€Ğ¾ÑĞ¼Ğ¾Ñ‚Ñ€ ĞºĞ°Ñ‚Ğ°Ğ»Ğ¾Ğ³Ğ° Ğ¾Ğ±Ğ¾Ñ€ÑƒĞ´Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ</li>
                            <li>â€¢ Ğ¡Ğ¾Ğ·Ğ´Ğ°Ğ½Ğ¸Ğµ Ğ¸ ÑƒĞ¿Ñ€Ğ°Ğ²Ğ»ĞµĞ½Ğ¸Ğµ ÑĞ²Ğ¾Ğ¸Ğ¼Ğ¸ Ñ€ĞµĞ·ĞµÑ€Ğ²Ğ°Ğ¼Ğ¸</li>
                            <li>â€¢ Ğ ĞµĞ´Ğ°ĞºÑ‚Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ ÑĞ¾Ğ±ÑÑ‚Ğ²ĞµĞ½Ğ½Ğ¾Ğ³Ğ¾ Ğ¿Ñ€Ğ¾Ñ„Ğ¸Ğ»Ñ</li>
                        </ul>
                    </div>
                    <div className="bg-white p-3 rounded border">
                        <div className="font-medium text-blue-900 mb-2">ğŸ›¡ï¸ ĞœĞµĞ½ĞµĞ´Ğ¶ĞµÑ€</div>
                        <ul className="text-gray-600 space-y-1">
                            <li>â€¢ Ğ’ÑĞµ Ğ¿Ñ€Ğ°Ğ²Ğ° Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ñ</li>
                            <li>â€¢ Ğ£Ğ¿Ñ€Ğ°Ğ²Ğ»ĞµĞ½Ğ¸Ğµ Ğ¾Ğ±Ğ¾Ñ€ÑƒĞ´Ğ¾Ğ²Ğ°Ğ½Ğ¸ĞµĞ¼</li>
                            <li>â€¢ ĞŸÑ€Ğ¾ÑĞ¼Ğ¾Ñ‚Ñ€ Ğ²ÑĞµÑ… Ñ€ĞµĞ·ĞµÑ€Ğ²Ğ¾Ğ²</li>
                            <li>â€¢ ĞŸÑ€Ğ¾ÑĞ¼Ğ¾Ñ‚Ñ€ ÑĞ¿Ğ¸ÑĞºĞ° Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ĞµĞ¹</li>
                        </ul>
                    </div>
                    <div className="bg-white p-3 rounded border">
                        <div className="font-medium text-red-900 mb-2">ğŸ‘‘ ĞĞ´Ğ¼Ğ¸Ğ½Ğ¸ÑÑ‚Ñ€Ğ°Ñ‚Ğ¾Ñ€</div>
                        <ul className="text-gray-600 space-y-1">
                            <li>â€¢ Ğ’ÑĞµ Ğ¿Ñ€Ğ°Ğ²Ğ° Ğ¼ĞµĞ½ĞµĞ´Ğ¶ĞµÑ€Ğ°</li>
                            <li>â€¢ Ğ£Ğ¿Ñ€Ğ°Ğ²Ğ»ĞµĞ½Ğ¸Ğµ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ÑĞ¼Ğ¸</li>
                            <li>â€¢ Ğ˜Ğ·Ğ¼ĞµĞ½ĞµĞ½Ğ¸Ğµ Ñ€Ğ¾Ğ»ĞµĞ¹</li>
                            <li>â€¢ Ğ‘Ğ»Ğ¾ĞºĞ¸Ñ€Ğ¾Ğ²ĞºĞ° Ğ¸ ÑƒĞ´Ğ°Ğ»ĞµĞ½Ğ¸Ğµ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ĞµĞ¹</li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    );
}

```


## <a name="rentalappmainsrcpagesadminAllReservationsManagementPagetsx"></a>`rental-app-main/src/pages/admin/AllReservationsManagementPage.tsx`

```tsx
// path: rental-app-main/src/pages/admin/AllReservationsManagementPage.tsx

// src/pages/admin/AllReservationsManagementPage.tsx

import { useState, useMemo, useEffect } from "react";
import { useLocation, useNavigate } from "react-router-dom";
import AdminNavigation from "@/components/admin/AdminNavigation";
import { useAdminReservations, useBulkDeleteAdminReservations } from "@/hooks/useAdminReservations";
import { Button } from "@/components/ui/button";
import { ClipboardList, Plus, Loader2, ClipboardX } from "lucide-react";
import AllReservationsList from "@/components/admin/AllReservationsList";
import CreateReservationDialog from "@/components/admin/CreateReservationDialog";
import ConvertReservationDialog from "@/components/admin/ConvertReservationDialog";
import type { AdminReservationOut } from "@/types/reservation";
import { useAllEquipment } from "@/hooks/useAllEquipment";
import { useAdminReservationSelectionStore } from "@/store/adminReservationSelectionStore";
import { AdminReservationToolbar } from "@/components/admin/AdminReservationToolbar";
import { ConfirmationDialog } from "@/components/ui/confirmation-dialog";
import OrderToolbar from "@/components/shared/OrderToolbar";
import { useOrderFilterStore } from "@/store/orderFilterStore";

export default function AllReservationsManagementPage() {
    const location = useLocation();
    const navigate = useNavigate();
    const [localHighlightId, setLocalHighlightId] = useState<number | null>(null);

    const [isCreateDialogOpen, setCreateDialogOpen] = useState(false);
    const [conversionTarget, setConversionTarget] = useState<AdminReservationOut | null>(null);
    const [isConfirmingDelete, setConfirmingDelete] = useState(false);

    // ĞŸĞ¾Ğ»ÑƒÑ‡Ğ°ĞµĞ¼ Ğ¿Ğ°Ñ€Ğ°Ğ¼ĞµÑ‚Ñ€Ñ‹ Ñ„Ğ¸Ğ»ÑŒÑ‚Ñ€Ğ°Ñ†Ğ¸Ğ¸ Ğ¸Ğ· ÑÑ‚Ğ¾Ñ€Ğ°
    const { searchQuery, statusFilter, setSearchQuery, setStatusFilter } = useOrderFilterStore();

    // Ğ­Ñ‚Ğ¾Ñ‚ useEffect Ğ¾Ğ±Ñ€Ğ°Ğ±Ğ¾Ñ‚Ğ°ĞµÑ‚ ÑĞ¾ÑÑ‚Ğ¾ÑĞ½Ğ¸Ğµ, Ğ¿ĞµÑ€ĞµĞ´Ğ°Ğ½Ğ½Ğ¾Ğµ Ğ¿Ñ€Ğ¸ Ğ½Ğ°Ğ²Ğ¸Ğ³Ğ°Ñ†Ğ¸Ğ¸
    useEffect(() => {
        const state = location.state as { highlightId?: number; statusFilterOverride?: string } | null;
        if (state?.highlightId) {
            setLocalHighlightId(state.highlightId);
        }
        if (state?.statusFilterOverride) {
            setStatusFilter(state.statusFilterOverride);
            setSearchQuery(""); // Ğ¡Ğ±Ñ€Ğ°ÑÑ‹Ğ²Ğ°ĞµĞ¼ Ğ¿Ğ¾Ğ¸ÑĞº Ğ´Ğ»Ñ Ñ‡Ğ¸ÑÑ‚Ğ¾Ñ‚Ñ‹
        }
    }, [location.state, setStatusFilter, setSearchQuery]);

    // Ğ­Ñ‚Ğ¾Ñ‚ useEffect ÑĞ±Ñ€Ğ¾ÑĞ¸Ñ‚ Ğ¿Ğ¾Ğ´ÑĞ²ĞµÑ‚ĞºÑƒ Ñ‡ĞµÑ€ĞµĞ· 3 ÑĞµĞºÑƒĞ½Ğ´Ñ‹
    useEffect(() => {
        if (localHighlightId) {
            const timer = setTimeout(() => {
                setLocalHighlightId(null);
                // ĞÑ‡Ğ¸Ñ‰Ğ°ĞµĞ¼ location.state, Ñ‡Ñ‚Ğ¾Ğ±Ñ‹ Ğ¿Ğ¾Ğ´ÑĞ²ĞµÑ‚ĞºĞ° Ğ½Ğµ "Ğ·Ğ°Ğ»Ğ¸Ğ¿Ğ°Ğ»Ğ°" Ğ¿Ñ€Ğ¸ Ğ¾Ğ±Ğ½Ğ¾Ğ²Ğ»ĞµĞ½Ğ¸Ğ¸ ÑÑ‚Ñ€Ğ°Ğ½Ğ¸Ñ†Ñ‹
                navigate(location.pathname, { replace: true, state: {} });
            }, 3000);
            return () => clearTimeout(timer);
        }
    }, [localHighlightId, navigate, location.pathname]);

    const {
        data,
        isLoading: isLoadingReservations,
        error,
        fetchNextPage,
        hasNextPage,
        isFetchingNextPage
    } = useAdminReservations({
        search: searchQuery,
        status: statusFilter === "all" ? undefined : statusFilter,
    });

    const { data: allEquipment = [], isLoading: isLoadingEquipment } = useAllEquipment();
    const { selectedIds, clearSelection } = useAdminReservationSelectionStore();
    const bulkDeleteMutation = useBulkDeleteAdminReservations();

    useEffect(() => {
        return () => {
            clearSelection();
        };
    }, []);

    const equipmentMap = useMemo(() => {
        return new Map(allEquipment.map(e => [e.id, e]));
    }, [allEquipment]);

    const allReservations = useMemo(() => {
        const flatList = data?.pages.flatMap(page => page.items) ?? [];
        return Array.from(new Map(flatList.map(item => [item.id, item])).values());
    }, [data]);

    const visibleReservationIds = useMemo(() => allReservations.map(r => r.id), [allReservations]);

    const isLoading = isLoadingReservations || isLoadingEquipment;

    const handleBulkDelete = () => {
        if (selectedIds.length === 0) return;
        setConfirmingDelete(true);
    };

    const confirmBulkDelete = () => {
        bulkDeleteMutation.mutate(selectedIds, {
            onSuccess: () => {
                clearSelection();
                setConfirmingDelete(false);
            },
            onError: () => {
                setConfirmingDelete(false);
            }
        });
    };

    return (
        <div className="max-w-7xl mx-auto px-4 py-6 space-y-6">
            <AdminNavigation />

            <div className="flex items-center gap-3">
                <ClipboardList className="w-8 h-8 text-indigo-600" />
                <div>
                    <h1 className="text-3xl font-bold text-gray-900">
                        Ğ£Ğ¿Ñ€Ğ°Ğ²Ğ»ĞµĞ½Ğ¸Ğµ Ñ€ĞµĞ·ĞµÑ€Ğ²Ğ°Ğ¼Ğ¸
                    </h1>
                    <p className="text-gray-600 mt-1">
                        ĞŸÑ€Ğ¾ÑĞ¼Ğ¾Ñ‚Ñ€, ÑĞ¾Ğ·Ğ´Ğ°Ğ½Ğ¸Ğµ Ğ¸ Ñ€ĞµĞ´Ğ°ĞºÑ‚Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ Ğ²ÑĞµÑ… Ñ€ĞµĞ·ĞµÑ€Ğ²Ğ¾Ğ² Ğ² ÑĞ¸ÑÑ‚ĞµĞ¼Ğµ.
                    </p>
                </div>
            </div>

            <div className="bg-white rounded-lg border shadow-sm p-4 flex flex-col md:flex-row items-center justify-between gap-4">
                <div className="w-full">
                    <OrderToolbar context="admin-reservations" />
                </div>
                <Button onClick={() => setCreateDialogOpen(true)} className="w-full md:w-auto">
                    <Plus className="mr-2 h-4 w-4" />
                    Ğ¡Ğ¾Ğ·Ğ´Ğ°Ñ‚ÑŒ Ñ€ĞµĞ·ĞµÑ€Ğ²
                </Button>
            </div>

            <AdminReservationToolbar
                visibleReservationIds={visibleReservationIds}
                onBulkDelete={handleBulkDelete}
                isDeleting={bulkDeleteMutation.isPending}
            />

            <div className="bg-white rounded-lg border shadow-sm p-4 md:p-6">
                {isLoading && <p className="text-center text-gray-500 py-4">Ğ—Ğ°Ğ³Ñ€ÑƒĞ·ĞºĞ° Ğ´Ğ°Ğ½Ğ½Ñ‹Ñ…...</p>}
                {error && <p className="text-center text-red-600 py-4">ĞÑˆĞ¸Ğ±ĞºĞ° Ğ·Ğ°Ğ³Ñ€ÑƒĞ·ĞºĞ¸ Ğ´Ğ°Ğ½Ğ½Ñ‹Ñ…: {error.message}</p>}

                {!isLoading && !error && allReservations.length === 0 && (
                    <div className="flex flex-col items-center justify-center text-center p-12 space-y-4 bg-gray-50/50 rounded-lg border-2 border-dashed">
                        <ClipboardX className="w-16 h-16 text-gray-400" />
                        <h3 className="text-lg font-semibold text-gray-800">Ğ ĞµĞ·ĞµÑ€Ğ²Ñ‹ Ğ½Ğµ Ğ½Ğ°Ğ¹Ğ´ĞµĞ½Ñ‹</h3>
                        <p className="text-sm text-gray-500">ĞŸĞ¾Ğ¿Ñ€Ğ¾Ğ±ÑƒĞ¹Ñ‚Ğµ Ğ¸Ğ·Ğ¼ĞµĞ½Ğ¸Ñ‚ÑŒ Ñ„Ğ¸Ğ»ÑŒÑ‚Ñ€Ñ‹ Ğ¸Ğ»Ğ¸ ÑĞ¾Ğ·Ğ´Ğ°Ğ¹Ñ‚Ğµ Ğ½Ğ¾Ğ²Ñ‹Ğ¹ Ñ€ĞµĞ·ĞµÑ€Ğ².</p>
                    </div>
                )}

                {!isLoading && !error && allReservations.length > 0 && (
                    <AllReservationsList
                        reservations={allReservations}
                        onConvertToRental={setConversionTarget}
                        equipmentMap={equipmentMap}
                        highlightId={localHighlightId}
                    />
                )}
                {hasNextPage && (
                    <div className="flex justify-center mt-6">
                        <Button
                            variant="outline"
                            onClick={() => fetchNextPage()}
                            disabled={isFetchingNextPage}
                        >
                            {isFetchingNextPage ? (
                                <><Loader2 className="mr-2 h-4 w-4 animate-spin" /> Ğ—Ğ°Ğ³Ñ€ÑƒĞ·ĞºĞ°...</>
                            ) : "Ğ—Ğ°Ğ³Ñ€ÑƒĞ·Ğ¸Ñ‚ÑŒ ĞµÑ‰Ğµ"}
                        </Button>
                    </div>
                )}
            </div>

            <CreateReservationDialog
                isOpen={isCreateDialogOpen}
                onClose={() => setCreateDialogOpen(false)}
            />
            <ConvertReservationDialog
                reservation={conversionTarget}
                open={!!conversionTarget}
                onClose={() => setConversionTarget(null)}
                equipmentMap={equipmentMap}
            />

            <ConfirmationDialog
                open={isConfirmingDelete}
                onOpenChange={setConfirmingDelete}
                title="ĞŸĞ¾Ğ´Ñ‚Ğ²ĞµÑ€Ğ´Ğ¸Ñ‚Ğµ ÑƒĞ´Ğ°Ğ»ĞµĞ½Ğ¸Ğµ"
                description={`Ğ’Ñ‹ ÑƒĞ²ĞµÑ€ĞµĞ½Ñ‹, Ñ‡Ñ‚Ğ¾ Ñ…Ğ¾Ñ‚Ğ¸Ñ‚Ğµ ÑƒĞ´Ğ°Ğ»Ğ¸Ñ‚ÑŒ ${selectedIds.length} Ñ€ĞµĞ·ĞµÑ€Ğ²(Ğ¾Ğ²)? Ğ­Ñ‚Ğ¾ Ğ´ĞµĞ¹ÑÑ‚Ğ²Ğ¸Ğµ Ğ½ĞµĞ»ÑŒĞ·Ñ Ğ¾Ñ‚Ğ¼ĞµĞ½Ğ¸Ñ‚ÑŒ.`}
                confirmText="Ğ”Ğ°, ÑƒĞ´Ğ°Ğ»Ğ¸Ñ‚ÑŒ"
                cancelText="ĞÑ‚Ğ¼ĞµĞ½Ğ°"
                onConfirm={confirmBulkDelete}
                variant="destructive"
            />
        </div>
    );
}

```


## <a name="rentalappmainsrcpagesadminAssociationManagementPagetsx"></a>`rental-app-main/src/pages/admin/AssociationManagementPage.tsx`

```tsx
// path: rental-app-main/src/pages/admin/AssociationManagementPage.tsx

import AdminNavigation from "@/components/admin/AdminNavigation";
import AssociationTable from "@/components/admin/AssociationTable";
import { Tags } from "lucide-react";

export default function AssociationManagementPage() {
    return (
        <div className="max-w-7xl mx-auto px-4 py-6 space-y-6">
            <AdminNavigation />
            <div className="flex items-center gap-3">
                <Tags className="w-8 h-8 text-green-600" />
                <div>
                    <h1 className="text-3xl font-bold text-gray-900">
                        Ğ£Ğ¿Ñ€Ğ°Ğ²Ğ»ĞµĞ½Ğ¸Ğµ Ğ°ÑÑĞ¾Ñ†Ğ¸Ğ°Ñ†Ğ¸ÑĞ¼Ğ¸
                    </h1>
                    <p className="text-gray-600 mt-1">
                        Ğ¡Ğ¾Ğ·Ğ´Ğ°Ğ²Ğ°Ğ¹Ñ‚Ğµ Ğ¸ Ñ€ĞµĞ´Ğ°ĞºÑ‚Ğ¸Ñ€ÑƒĞ¹Ñ‚Ğµ Ğ¿Ğ¾Ğ´Ğ±Ğ¾Ñ€ĞºĞ¸ Ğ¾Ğ±Ğ¾Ñ€ÑƒĞ´Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ Ğ´Ğ»Ñ Ğ±Ñ‹ÑÑ‚Ñ€Ğ¾Ğ³Ğ¾ Ğ´Ğ¾ÑÑ‚ÑƒĞ¿Ğ°.
                    </p>
                </div>
            </div>
            <div className="bg-white rounded-lg border shadow-sm p-6">
                <AssociationTable />
            </div>
        </div>
    );
}



```


## <a name="rentalappmainsrcpagesadminDashboardPagetsx"></a>`rental-app-main/src/pages/admin/DashboardPage.tsx`

```tsx
// path: rental-app-main/src/pages/admin/DashboardPage.tsx

// src/pages/admin/DashboardPage.tsx

import { useCurrentUser } from "@/hooks/useProfile";
import { useDashboardData } from "@/hooks/admin/useDashboardData";
import AdminNavigation from "@/components/admin/AdminNavigation";
import TodayFocusWidget from "@/components/admin/dashboard/TodayFocusWidget";
import KpiCardsWidget from "@/components/admin/dashboard/KpiCardsWidget";
import ActivityFeedWidget from "@/components/admin/dashboard/ActivityFeedWidget";
import PopularEquipmentChart from "@/components/admin/dashboard/PopularEquipmentChart";
import { Card, CardContent } from "@/components/ui/card";
import { Alert, AlertDescription } from "@/components/ui/alert";
import { Skeleton } from "@/components/ui/skeleton";
import { AlertCircle, RefreshCw } from "lucide-react";
import { Button } from "@/components/ui/button";

export default function DashboardPage() {
    const { data: currentUser } = useCurrentUser();
    const { data: dashboardData, isLoading, isError, error, refetch } = useDashboardData();

    const isAdmin = currentUser?.role === "admin";
    const isManager = currentUser?.role === "manager" || isAdmin;

    if (!isManager) {
        return (
            <div className="max-w-7xl mx-auto px-4 py-6">
                <AdminNavigation />
                <div className="flex items-center justify-center min-h-[400px]">
                    <Alert className="max-w-md">
                        <AlertCircle className="h-4 w-4" />
                        <AlertDescription>
                            Ğ”Ğ¾ÑÑ‚ÑƒĞ¿ Ğ¾Ğ³Ñ€Ğ°Ğ½Ğ¸Ñ‡ĞµĞ½. Ğ¢Ñ€ĞµĞ±ÑƒÑÑ‚ÑÑ Ğ¿Ñ€Ğ°Ğ²Ğ° Ğ¼ĞµĞ½ĞµĞ´Ğ¶ĞµÑ€Ğ° Ğ¸Ğ»Ğ¸ Ğ°Ğ´Ğ¼Ğ¸Ğ½Ğ¸ÑÑ‚Ñ€Ğ°Ñ‚Ğ¾Ñ€Ğ°.
                        </AlertDescription>
                    </Alert>
                </div>
            </div>
        );
    }

    if (isError) {
        return (
            <div className="max-w-7xl mx-auto px-4 py-6 space-y-6">
                <AdminNavigation />
                <div className="flex items-center justify-center min-h-[400px]">
                    <Card className="max-w-md">
                        <CardContent className="pt-6">
                            <Alert variant="destructive">
                                <AlertCircle className="h-4 w-4" />
                                <AlertDescription className="mt-2">
                                    <div className="font-medium mb-2">ĞÑˆĞ¸Ğ±ĞºĞ° Ğ·Ğ°Ğ³Ñ€ÑƒĞ·ĞºĞ¸ Ğ´Ğ°Ğ½Ğ½Ñ‹Ñ…</div>
                                    <div className="text-sm text-muted-foreground mb-4">
                                        {error?.message || "ĞĞµ ÑƒĞ´Ğ°Ğ»Ğ¾ÑÑŒ Ğ·Ğ°Ğ³Ñ€ÑƒĞ·Ğ¸Ñ‚ÑŒ Ğ´Ğ°Ğ½Ğ½Ñ‹Ğµ Ğ´Ğ°ÑˆĞ±Ğ¾Ñ€Ğ´Ğ°"}
                                    </div>
                                    <Button 
                                        onClick={() => refetch()} 
                                        variant="outline" 
                                        size="sm"
                                        className="w-full"
                                    >
                                        <RefreshCw className="w-4 h-4 mr-2" />
                                        ĞŸĞ¾Ğ¿Ñ€Ğ¾Ğ±Ğ¾Ğ²Ğ°Ñ‚ÑŒ ÑĞ½Ğ¾Ğ²Ğ°
                                    </Button>
                                </AlertDescription>
                            </Alert>
                        </CardContent>
                    </Card>
                </div>
            </div>
        );
    }

    return (
        <div className="max-w-7xl mx-auto px-4 py-6 space-y-6">
            <AdminNavigation />

            {/* Ğ—Ğ°Ğ³Ğ¾Ğ»Ğ¾Ğ²Ğ¾Ğº */}
            <div className="flex items-center justify-between">
                <div>
                    <h1 className="text-3xl font-bold text-gray-900">
                        ĞŸĞ°Ğ½ĞµĞ»ÑŒ ÑƒĞ¿Ñ€Ğ°Ğ²Ğ»ĞµĞ½Ğ¸Ñ
                    </h1>
                    <p className="text-gray-600 mt-1">
                        Ğ”Ğ¾Ğ±Ñ€Ğ¾ Ğ¿Ğ¾Ğ¶Ğ°Ğ»Ğ¾Ğ²Ğ°Ñ‚ÑŒ, {currentUser?.full_name}!
                    </p>
                </div>
                <div className="flex items-center gap-2">
                    {isLoading && (
                        <div className="flex items-center gap-2 text-sm text-gray-500">
                            <RefreshCw className="w-4 h-4 animate-spin" />
                            ĞĞ±Ğ½Ğ¾Ğ²Ğ»ĞµĞ½Ğ¸Ğµ...
                        </div>
                    )}
                    <Button 
                        onClick={() => refetch()} 
                        variant="outline" 
                        size="sm"
                        disabled={isLoading}
                    >
                        <RefreshCw className={`w-4 h-4 mr-2 ${isLoading ? 'animate-spin' : ''}`} />
                        ĞĞ±Ğ½Ğ¾Ğ²Ğ¸Ñ‚ÑŒ
                    </Button>
                </div>
            </div>

            {/* KPI Cards */}
            {isLoading ? (
                <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                    {Array.from({ length: 8 }).map((_, index) => (
                        <Card key={index}>
                            <CardContent className="p-6">
                                <div className="space-y-2">
                                    <Skeleton className="h-4 w-20" />
                                    <Skeleton className="h-8 w-16" />
                                    <Skeleton className="h-3 w-24" />
                                </div>
                            </CardContent>
                        </Card>
                    ))}
                </div>
            ) : (
                <KpiCardsWidget 
                    data={dashboardData?.kpi || {
                        total_users: 0,
                        active_users: 0,
                        total_equipment: 0,
                        total_reservations: 0,
                        revenue_today: 0,
                        revenue_this_month: 0,
                        occupancy_rate: 0,
                        avg_rental_duration: 0
                    }} 
                    isLoading={false} 
                />
            )}

            {/* ĞÑĞ½Ğ¾Ğ²Ğ½Ğ¾Ğ¹ ĞºĞ¾Ğ½Ñ‚ĞµĞ½Ñ‚ - Ğ°Ğ´Ğ°Ğ¿Ñ‚Ğ¸Ğ²Ğ½Ğ°Ñ ÑĞµÑ‚ĞºĞ° */}
            <div className="grid grid-cols-1 lg:grid-cols-3 gap-6">
                {/* Ğ›ĞµĞ²Ğ°Ñ ĞºĞ¾Ğ»Ğ¾Ğ½ĞºĞ° - Ğ¤Ğ¾ĞºÑƒÑ Ğ½Ğ° ÑĞµĞ³Ğ¾Ğ´Ğ½Ñ */}
                <div className="lg:col-span-1">
                    {isLoading ? (
                        <Card>
                            <CardContent className="p-6">
                                <div className="space-y-4">
                                    <Skeleton className="h-6 w-32" />
                                    {Array.from({ length: 3 }).map((_, index) => (
                                        <div key={index} className="space-y-2">
                                            <Skeleton className="h-4 w-24" />
                                            <Skeleton className="h-16 w-full" />
                                        </div>
                                    ))}
                                </div>
                            </CardContent>
                        </Card>
                    ) : (
                        <TodayFocusWidget 
                            data={{
                                pickups_today: dashboardData?.pickups_today || [],
                                returns_today: dashboardData?.returns_today || [],
                                overdue_rentals: dashboardData?.overdue_rentals || []
                            }} 
                            isLoading={false} 
                        />
                    )}
                </div>

                {/* ĞŸÑ€Ğ°Ğ²Ğ°Ñ ĞºĞ¾Ğ»Ğ¾Ğ½ĞºĞ° - Ğ›ĞµĞ½Ñ‚Ğ° Ğ°ĞºÑ‚Ğ¸Ğ²Ğ½Ğ¾ÑÑ‚Ğ¸ Ğ¸ Ğ³Ñ€Ğ°Ñ„Ğ¸Ğº */}
                <div className="lg:col-span-2 space-y-6">
                    {/* Ğ›ĞµĞ½Ñ‚Ğ° Ğ°ĞºÑ‚Ğ¸Ğ²Ğ½Ğ¾ÑÑ‚Ğ¸ */}
                    <ActivityFeedWidget 
                        data={dashboardData?.recent_activity || []} 
                        isLoading={isLoading} 
                    />

                    {/* Ğ“Ñ€Ğ°Ñ„Ğ¸Ğº Ğ¿Ğ¾Ğ¿ÑƒĞ»ÑÑ€Ğ½Ğ¾Ğ³Ğ¾ Ğ¾Ğ±Ğ¾Ñ€ÑƒĞ´Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ */}
                    <PopularEquipmentChart 
                        data={dashboardData?.popular_equipment || []} 
                        isLoading={isLoading} 
                    />
                </div>
            </div>

            {/* Ğ”Ğ¾Ğ¿Ğ¾Ğ»Ğ½Ğ¸Ñ‚ĞµĞ»ÑŒĞ½Ğ°Ñ Ğ¸Ğ½Ñ„Ğ¾Ñ€Ğ¼Ğ°Ñ†Ğ¸Ñ */}
            {!isLoading && dashboardData && (
                <div className="text-center text-sm text-gray-500 pt-4 border-t">
                    <p>
                        Ğ”Ğ°Ğ½Ğ½Ñ‹Ğµ Ğ¾Ğ±Ğ½Ğ¾Ğ²Ğ»ÑÑÑ‚ÑÑ Ğ°Ğ²Ñ‚Ğ¾Ğ¼Ğ°Ñ‚Ğ¸Ñ‡ĞµÑĞºĞ¸ ĞºĞ°Ğ¶Ğ´Ñ‹Ğµ 2 Ğ¼Ğ¸Ğ½ÑƒÑ‚Ñ‹. 
                        ĞŸĞ¾ÑĞ»ĞµĞ´Ğ½ĞµĞµ Ğ¾Ğ±Ğ½Ğ¾Ğ²Ğ»ĞµĞ½Ğ¸Ğµ: {new Date().toLocaleTimeString('ru-RU')}
                    </p>
                </div>
            )}
        </div>
    );
}


```


## <a name="rentalappmainsrcpagesadminHolidayManagementPagetsx"></a>`rental-app-main/src/pages/admin/HolidayManagementPage.tsx`

```tsx
// path: rental-app-main/src/pages/admin/HolidayManagementPage.tsx

// src/pages/admin/HolidayManagementPage.tsx

import AdminNavigation from "@/components/admin/AdminNavigation";
import HolidayManager from "@/components/admin/HolidayManager"; // Ğ­Ñ‚Ğ¾Ñ‚ ĞºĞ¾Ğ¼Ğ¿Ğ¾Ğ½ĞµĞ½Ñ‚ Ğ¼Ñ‹ ÑĞ¾Ğ·Ğ´Ğ°Ğ´Ğ¸Ğ¼ Ğ´Ğ°Ğ»ĞµĞµ
import { CalendarDays } from "lucide-react";

export default function HolidayManagementPage() {
    return (
        <div className="max-w-7xl mx-auto px-4 py-6 space-y-6">
            <AdminNavigation />
            <div className="flex items-center gap-3">
                <CalendarDays className="w-8 h-8 text-cyan-600" />
                <div>
                    <h1 className="text-3xl font-bold text-gray-900">
                        Ğ£Ğ¿Ñ€Ğ°Ğ²Ğ»ĞµĞ½Ğ¸Ğµ Ğ²Ñ‹Ñ…Ğ¾Ğ´Ğ½Ñ‹Ğ¼Ğ¸ Ğ´Ğ½ÑĞ¼Ğ¸
                    </h1>
                    <p className="text-gray-600 mt-1">
                        ĞĞ°Ğ·Ğ½Ğ°Ñ‡ÑŒÑ‚Ğµ Ğ¿Ñ€Ğ°Ğ·Ğ´Ğ½Ğ¸Ñ‡Ğ½Ñ‹Ğµ Ğ¸ Ğ½ĞµÑ€Ğ°Ğ±Ğ¾Ñ‡Ğ¸Ğµ Ğ´Ğ½Ğ¸, ĞºĞ¾Ñ‚Ğ¾Ñ€Ñ‹Ğµ Ğ½Ğµ Ğ±ÑƒĞ´ÑƒÑ‚ Ñ‚Ğ°Ñ€Ğ¸Ñ„Ğ¸Ñ†Ğ¸Ñ€Ğ¾Ğ²Ğ°Ñ‚ÑŒÑÑ.
                    </p>
                </div>
            </div>
            <div className="bg-white rounded-lg border shadow-sm p-6">
                <HolidayManager />
            </div>
        </div>
    );
}

```


## <a name="rentalappmainsrcpagesadminPromoCodeManagementPagetsx"></a>`rental-app-main/src/pages/admin/PromoCodeManagementPage.tsx`

```tsx
// path: rental-app-main/src/pages/admin/PromoCodeManagementPage.tsx

// src/pages/admin/PromoCodeManagementPage.tsx

import AdminNavigation from "@/components/admin/AdminNavigation";
import { TicketPercent } from "lucide-react";
import PromoCodeTable from "@/components/admin/PromoCodeTable";
import DurationDiscountManager from "@/components/admin/DurationDiscountManager";

export default function PromoCodeManagementPage() {
    return (
        <div className="max-w-7xl mx-auto px-4 py-6 space-y-6">
            <AdminNavigation />

            <div className="flex items-center gap-3">
                <TicketPercent className="w-8 h-8 text-purple-600" />
                <div>
                    <h1 className="text-3xl font-bold text-gray-900">
                        ĞŸÑ€Ğ¾Ğ¼Ğ¾ĞºĞ¾Ğ´Ñ‹ Ğ¸ ÑĞºĞ¸Ğ´ĞºĞ¸
                    </h1>
                    <p className="text-gray-600 mt-1">
                        Ğ¡Ğ¾Ğ·Ğ´Ğ°Ğ½Ğ¸Ğµ, Ñ€ĞµĞ´Ğ°ĞºÑ‚Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ Ğ¸ Ğ¿Ñ€Ğ¾ÑĞ¼Ğ¾Ñ‚Ñ€ Ğ¿Ñ€Ğ¾Ğ¼Ğ¾ĞºĞ¾Ğ´Ğ¾Ğ² Ğ¸ Ğ°Ğ²Ñ‚Ğ¾Ğ¼Ğ°Ñ‚Ğ¸Ñ‡ĞµÑĞºĞ¸Ñ… ÑĞºĞ¸Ğ´Ğ¾Ğº.
                    </p>
                </div>
            </div>

            {/* Ğ‘Ğ»Ğ¾Ğº Ñ Ğ¿Ñ€Ğ¾Ğ¼Ğ¾ĞºĞ¾Ğ´Ğ°Ğ¼Ğ¸ (Ğ¾ÑÑ‚Ğ°ĞµÑ‚ÑÑ Ğ±ĞµĞ· Ğ¸Ğ·Ğ¼ĞµĞ½ĞµĞ½Ğ¸Ğ¹) */}
            <div className="bg-white rounded-lg border shadow-sm p-6">
                <PromoCodeTable />
            </div>

            {/* 2. <-- Ğ”ĞĞ‘ĞĞ’Ğ›Ğ¯Ğ•Ğœ ĞĞĞ’Ğ«Ğ™ Ğ‘Ğ›ĞĞš Ğ”Ğ›Ğ¯ Ğ£ĞŸĞ ĞĞ’Ğ›Ğ•ĞĞ˜Ğ¯ Ğ¡ĞšĞ˜Ğ”ĞšĞĞœĞ˜ */}
            <div className="bg-white rounded-lg border shadow-sm p-6">
                <DurationDiscountManager />
            </div>
        </div>
    );
}

```


## <a name="rentalappmainsrcpagesadminRentalManagementPagetsx"></a>`rental-app-main/src/pages/admin/RentalManagementPage.tsx`

```tsx
// path: rental-app-main/src/pages/admin/RentalManagementPage.tsx

// src/pages/admin/RentalManagementPage.tsx

import { useState, useMemo, useEffect } from "react";
import { useLocation, useNavigate } from "react-router-dom";
import AdminNavigation from "@/components/admin/AdminNavigation";
import { Button } from "@/components/ui/button";
import { Truck, Plus, Loader2 } from "lucide-react";
import { useAdminRentals } from "@/hooks/useAdminRentals";
import AllRentalsList from "@/components/admin/AllRentalsList";
import ReturnRentalDialog from "@/components/admin/ReturnRentalDialog";
import type { AdminRentalOut } from "@/types/rental";
import OrderToolbar from "@/components/shared/OrderToolbar";
import { useOrderFilterStore } from "@/store/orderFilterStore";



export default function RentalManagementPage() {
    const location = useLocation();
    const navigate = useNavigate();
    const [localHighlightId, setLocalHighlightId] = useState<number | null>(null);
    const [returnTarget, setReturnTarget] = useState<AdminRentalOut | null>(null);

    // ĞŸĞ¾Ğ»ÑƒÑ‡Ğ°ĞµĞ¼ Ğ¿Ğ°Ñ€Ğ°Ğ¼ĞµÑ‚Ñ€Ñ‹ Ñ„Ğ¸Ğ»ÑŒÑ‚Ñ€Ğ°Ñ†Ğ¸Ğ¸ Ğ¸Ğ· ÑÑ‚Ğ¾Ñ€Ğ°
    const { searchQuery, statusFilter, setSearchQuery, setStatusFilter } = useOrderFilterStore();

    const {
        data,
        isLoading,
        error,
        fetchNextPage,
        hasNextPage,
        isFetchingNextPage
    } = useAdminRentals({
        search: searchQuery,
        status: statusFilter === "all" ? undefined : (statusFilter as "active" | "overdue" | "completed" | null),
    });

    const allRentals = useMemo(() => data?.pages.flatMap(page => page.items) ?? [], [data]);

    // Ğ­Ñ‚Ğ¾Ñ‚ useEffect Ğ¾Ğ±Ñ€Ğ°Ğ±Ğ¾Ñ‚Ğ°ĞµÑ‚ ÑĞ¾ÑÑ‚Ğ¾ÑĞ½Ğ¸Ğµ, Ğ¿ĞµÑ€ĞµĞ´Ğ°Ğ½Ğ½Ğ¾Ğµ Ğ¿Ñ€Ğ¸ Ğ½Ğ°Ğ²Ğ¸Ğ³Ğ°Ñ†Ğ¸Ğ¸
    useEffect(() => {
        const state = location.state as { highlightId?: number; statusFilterOverride?: string } | null;
        if (state?.highlightId) {
            setLocalHighlightId(state.highlightId);
        }
        if (state?.statusFilterOverride) {
            setStatusFilter(state.statusFilterOverride);
            setSearchQuery(""); // Ğ¡Ğ±Ñ€Ğ°ÑÑ‹Ğ²Ğ°ĞµĞ¼ Ğ¿Ğ¾Ğ¸ÑĞº Ğ´Ğ»Ñ Ñ‡Ğ¸ÑÑ‚Ğ¾Ñ‚Ñ‹
        }
    }, [location.state, setStatusFilter, setSearchQuery]);

    // Ğ­Ñ‚Ğ¾Ñ‚ useEffect ÑĞ±Ñ€Ğ¾ÑĞ¸Ñ‚ Ğ¿Ğ¾Ğ´ÑĞ²ĞµÑ‚ĞºÑƒ Ñ‡ĞµÑ€ĞµĞ· 3 ÑĞµĞºÑƒĞ½Ğ´Ñ‹
    useEffect(() => {
        if (localHighlightId) {
            const timer = setTimeout(() => {
                setLocalHighlightId(null);
                // ĞÑ‡Ğ¸Ñ‰Ğ°ĞµĞ¼ location.state, Ñ‡Ñ‚Ğ¾Ğ±Ñ‹ Ğ¿Ğ¾Ğ´ÑĞ²ĞµÑ‚ĞºĞ° Ğ½Ğµ "Ğ·Ğ°Ğ»Ğ¸Ğ¿Ğ°Ğ»Ğ°" Ğ¿Ñ€Ğ¸ Ğ¾Ğ±Ğ½Ğ¾Ğ²Ğ»ĞµĞ½Ğ¸Ğ¸ ÑÑ‚Ñ€Ğ°Ğ½Ğ¸Ñ†Ñ‹
                navigate(location.pathname, { replace: true, state: {} });
            }, 3000);
            return () => clearTimeout(timer);
        }
    }, [localHighlightId, navigate, location.pathname]);

    return (
        <div className="max-w-7xl mx-auto px-4 py-6 space-y-6">
            <AdminNavigation />

            <div className="flex items-center gap-3">
                <Truck className="w-8 h-8 text-orange-600" />
                <div>
                    <h1 className="text-3xl font-bold text-gray-900">
                        Ğ£Ğ¿Ñ€Ğ°Ğ²Ğ»ĞµĞ½Ğ¸Ğµ ĞÑ€ĞµĞ½Ğ´Ğ°Ğ¼Ğ¸
                    </h1>
                    <p className="text-gray-600 mt-1">
                        ĞŸÑ€Ğ¾ÑĞ¼Ğ¾Ñ‚Ñ€, ÑĞ¾Ğ·Ğ´Ğ°Ğ½Ğ¸Ğµ Ğ¸ Ğ·Ğ°Ğ²ĞµÑ€ÑˆĞµĞ½Ğ¸Ğµ Ñ„Ğ¸Ğ·Ğ¸Ñ‡ĞµÑĞºĞ¾Ğ¹ Ğ²Ñ‹Ğ´Ğ°Ñ‡Ğ¸ Ğ¾Ğ±Ğ¾Ñ€ÑƒĞ´Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ.
                    </p>
                </div>
            </div>

            <div className="bg-white rounded-lg border shadow-sm p-4 flex flex-col md:flex-row items-center justify-between gap-4">
                <div className="w-full">
                    <OrderToolbar context="admin-rentals" />
                </div>
                <Button disabled className="w-full md:w-auto">
                    <Plus className="mr-2 h-4 w-4" />
                    Ğ¡Ğ¾Ğ·Ğ´Ğ°Ñ‚ÑŒ Ğ°Ñ€ĞµĞ½Ğ´Ñƒ
                </Button>
            </div>

            <div className="bg-white rounded-lg border shadow-sm p-4 md:p-6">
                {isLoading && <p className="text-center text-gray-500 py-4">Ğ—Ğ°Ğ³Ñ€ÑƒĞ·ĞºĞ° Ğ°Ñ€ĞµĞ½Ğ´...</p>}
                {error && <p className="text-center text-red-600 py-4">ĞÑˆĞ¸Ğ±ĞºĞ° Ğ·Ğ°Ğ³Ñ€ÑƒĞ·ĞºĞ¸ Ğ´Ğ°Ğ½Ğ½Ñ‹Ñ…: {error.message}</p>}
                {!isLoading && !error && (
                    <AllRentalsList rentals={allRentals} onReturn={setReturnTarget} highlightId={localHighlightId} />
                )}
                {hasNextPage && (
                    <div className="flex justify-center mt-6">
                        <Button
                            variant="outline"
                            onClick={() => fetchNextPage()}
                            disabled={isFetchingNextPage}
                        >
                            {isFetchingNextPage ? (
                                <><Loader2 className="mr-2 h-4 w-4 animate-spin" /> Ğ—Ğ°Ğ³Ñ€ÑƒĞ·ĞºĞ°...</>
                            ) : "Ğ—Ğ°Ğ³Ñ€ÑƒĞ·Ğ¸Ñ‚ÑŒ ĞµÑ‰Ğµ"}
                        </Button>
                    </div>
                )}
            </div>

            <ReturnRentalDialog
                rental={returnTarget}
                open={!!returnTarget}
                onClose={() => setReturnTarget(null)}
            />
        </div>
    );
}

```


## <a name="rentalappmainsrcstoreadminReservationSelectionStorets"></a>`rental-app-main/src/store/adminReservationSelectionStore.ts`

```typescript
// path: rental-app-main/src/store/adminReservationSelectionStore.ts

// src/store/adminReservationSelectionStore.ts

import { create } from 'zustand';

type SelectionState = {
    selectedIds: number[];
    toggleId: (id: number) => void;
    setSelectedIds: (ids: number[]) => void;
    clearSelection: () => void;
};

export const useAdminReservationSelectionStore = create<SelectionState>((set) => ({
    selectedIds: [],
    toggleId: (id) =>
        set((state) => ({
            selectedIds: state.selectedIds.includes(id)
                ? state.selectedIds.filter((selectedId) => selectedId !== id)
                : [...state.selectedIds, id],
        })),
    setSelectedIds: (ids) => set({ selectedIds: ids }),
    clearSelection: () => set({ selectedIds: [] }),
}));

```


## <a name="rentalappmainsrcstoreauthStorets"></a>`rental-app-main/src/store/authStore.ts`

```typescript
// path: rental-app-main/src/store/authStore.ts

// src/store/authStore.ts

import { create } from "zustand"
import { api } from "@/lib/api"
import { queryClient } from "@/lib/queryClient"

// <<< Ğ˜Ğ—ĞœĞ•ĞĞ•ĞĞ˜Ğ•: ĞĞ±Ğ½Ğ¾Ğ²Ğ»ÑĞµĞ¼ Ñ‚Ğ¸Ğ¿ Ğ´Ğ°Ğ½Ğ½Ñ‹Ñ… Ğ´Ğ»Ñ Ñ€ĞµĞ³Ğ¸ÑÑ‚Ñ€Ğ°Ñ†Ğ¸Ğ¸
type RegisterPayload = {
    full_name: string
    email: string
    password: string
    phone?: string
    privacy_policy_accepted: boolean
    terms_accepted: boolean
}

type AuthStore = {
    loading: boolean
    error: string | null
    login: (email: string, password: string) => Promise<void>
    register: (data: RegisterPayload) => Promise<void>
    logout: () => void
}

export const useAuthStore = create<AuthStore>((set) => ({
    loading: false,
    error: null,

    login: async (email, password) => {
        set({ loading: true, error: null })
        try {
            const response = await api.post(
                "/auth/token",
                new URLSearchParams({ username: email, password }),
                {
                    headers: {
                        "Content-Type": "application/x-www-form-urlencoded",
                    },
                }
            )

            const token = response.data.access_token
            localStorage.setItem("access_token", token)

            // âœ… ĞĞ±Ğ½Ğ¾Ğ²Ğ»ÑĞµĞ¼ ĞºÑÑˆ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ñ
            await queryClient.invalidateQueries({ queryKey: ["current_user"] })
        } catch (err: unknown) {
            const error = err as { response?: { data?: { detail?: string } } }
            set({
                error: error?.response?.data?.detail || "ĞÑˆĞ¸Ğ±ĞºĞ° Ğ²Ñ…Ğ¾Ğ´Ğ°",
            })
        } finally {
            set({ loading: false })
        }
    },

    // <<< Ğ˜Ğ—ĞœĞ•ĞĞ•ĞĞ˜Ğ•: ĞĞ±Ğ½Ğ¾Ğ²Ğ»ÑĞµĞ¼ Ñ„ÑƒĞ½ĞºÑ†Ğ¸Ñ register Ğ´Ğ»Ñ Ğ¾Ñ‚Ğ¿Ñ€Ğ°Ğ²ĞºĞ¸ Ğ²ÑĞµÑ… Ğ¿Ğ¾Ğ»ĞµĞ¹
    register: async (data) => {
        set({ loading: true, error: null })
        try {
            await api.post("/auth/register", data) // ĞÑ‚Ğ¿Ñ€Ğ°Ğ²Ğ»ÑĞµĞ¼ Ğ¿Ğ¾Ğ»Ğ½Ñ‹Ğ¹ Ğ¾Ğ±ÑŠĞµĞºÑ‚ `data`

            // ĞĞ²Ñ‚Ğ¾Ğ¼Ğ°Ñ‚Ğ¸Ñ‡ĞµÑĞºĞ¸ Ğ²Ñ…Ğ¾Ğ´Ğ¸Ğ¼ Ğ¿Ğ¾ÑĞ»Ğµ Ñ€ĞµĞ³Ğ¸ÑÑ‚Ñ€Ğ°Ñ†Ğ¸Ğ¸
            const response = await api.post(
                "/auth/token",
                new URLSearchParams({ username: data.email, password: data.password }),
                {
                    headers: {
                        "Content-Type": "application/x-www-form-urlencoded",
                    },
                }
            )

            const token = response.data.access_token
            localStorage.setItem("access_token", token)

            // âœ… ĞĞ±Ğ½Ğ¾Ğ²Ğ»ÑĞµĞ¼ ĞºÑÑˆ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ñ
            await queryClient.invalidateQueries({ queryKey: ["current_user"] })
        } catch (err: unknown) {
            const error = err as { response?: { data?: { detail?: string } } }
            set({
                error: error?.response?.data?.detail || "ĞÑˆĞ¸Ğ±ĞºĞ° Ñ€ĞµĞ³Ğ¸ÑÑ‚Ñ€Ğ°Ñ†Ğ¸Ğ¸",
            })
        } finally {
            set({ loading: false })
        }
    },

    logout: () => {
        localStorage.removeItem("access_token")
        queryClient.invalidateQueries({ queryKey: ["current_user"] })
    },
}))

```


## <a name="rentalappmainsrcstorecalendarSelectionStorets"></a>`rental-app-main/src/store/calendarSelectionStore.ts`

```typescript
// path: rental-app-main/src/store/calendarSelectionStore.ts

// src/store/calendarSelectionStore.ts
import { create } from "zustand";

type CalendarSelectionState = {
    selectedGroupId: string | null;
    setSelectedGroupId: (id: string | null) => void;
};

export const useCalendarSelectionStore = create<CalendarSelectionState>((set) => ({
    selectedGroupId: null,
    setSelectedGroupId: (id) => set({ selectedGroupId: id }),
}));


```


## <a name="rentalappmainsrcstoredateStorets"></a>`rental-app-main/src/store/dateStore.ts`

```typescript
// path: rental-app-main/src/store/dateStore.ts

// src/store/dateStore.ts

import { create } from "zustand";
import { calculateDayCount } from "@/lib/utils";
import { addDays } from "date-fns";
import { DateService } from "@/core/services/DateService";

type DateState = {
    startDate: Date;
    endDate: Date;
    dayCount: number;
    // +++ Ğ”ĞĞ‘ĞĞ’Ğ›Ğ•ĞĞ ĞĞĞ’ĞĞ¯ Ğ¤Ğ£ĞĞšĞ¦Ğ˜Ğ¯ Ğ’ Ğ¢Ğ˜ĞŸ +++
    initializeDates: (holidays: Date[]) => void;
    setRange: (from: Date, to: Date, source?: 'calendar' | 'slider' | 'manual', holidays?: Date[]) => void;
    setStartDate: (date: Date, holidays?: Date[]) => void;
    setEndDate: (date: Date, holidays?: Date[]) => void;
    setDayCount: (days: number, holidays?: Date[]) => void;
    reset: (holidays?: Date[]) => void;
};

// Ğ’ÑĞ¿Ğ¾Ğ¼Ğ¾Ğ³Ğ°Ñ‚ĞµĞ»ÑŒĞ½Ñ‹Ğµ Ñ„ÑƒĞ½ĞºÑ†Ğ¸Ğ¸
function normalizeDate(date: Date): Date {
    const local = new Date(date);
    local.setHours(12, 0, 0, 0); // Ğ£ÑÑ‚Ğ°Ğ½Ğ°Ğ²Ğ»Ğ¸Ğ²Ğ°ĞµĞ¼ Ğ²Ñ€ĞµĞ¼Ñ Ğ½Ğ° Ğ¿Ğ¾Ğ»Ğ´ĞµĞ½ÑŒ Ğ´Ğ»Ñ Ğ¸Ğ·Ğ±ĞµĞ¶Ğ°Ğ½Ğ¸Ñ Ğ¿Ñ€Ğ¾Ğ±Ğ»ĞµĞ¼ Ñ Ñ‡Ğ°ÑĞ¾Ğ²Ñ‹Ğ¼Ğ¸ Ğ¿Ğ¾ÑÑĞ°Ğ¼Ğ¸
    return local;
}

function isValidDate(date: Date): boolean {
    return date instanceof Date && !isNaN(date.getTime());
}

function isValidDateRange(start: Date, end: Date): boolean {
    return isValidDate(start) && isValidDate(end) && start < end;
}

// ĞĞ°Ñ‡Ğ°Ğ»ÑŒĞ½Ñ‹Ğµ Ğ·Ğ½Ğ°Ñ‡ĞµĞ½Ğ¸Ñ Ğ¿Ğ¾ ÑƒĞ¼Ğ¾Ğ»Ñ‡Ğ°Ğ½Ğ¸Ñ
const defaultStart = normalizeDate(new Date());
const defaultEnd = normalizeDate(new Date(new Date().setDate(new Date().getDate() + 1)));

export const useDateStore = create<DateState>((set, get) => ({
    startDate: defaultStart,
    endDate: defaultEnd,
    dayCount: 1,

    // +++ ĞĞĞ§ĞĞ›Ğ: ĞĞĞ’ĞĞ¯ Ğ¤Ğ£ĞĞšĞ¦Ğ˜Ğ¯ Ğ”Ğ›Ğ¯ Ğ˜ĞĞ˜Ğ¦Ğ˜ĞĞ›Ğ˜Ğ—ĞĞ¦Ğ˜Ğ˜ Ğ”ĞĞ¢ +++
    initializeDates: (holidays: Date[]) => {
        const today = normalizeDate(new Date());
        // Ğ¡Ğ´Ğ²Ğ¸Ğ³Ğ°ĞµĞ¼ Ğ´Ğ°Ñ‚Ñƒ Ğ½Ğ°Ñ‡Ğ°Ğ»Ğ°, ĞµÑĞ»Ğ¸ ÑĞµĞ³Ğ¾Ğ´Ğ½Ñ Ğ²Ñ‹Ñ…Ğ¾Ğ´Ğ½Ğ¾Ğ¹
        const initialStartDate = DateService.adjustDateIfHoliday(today, holidays);
        // ĞĞ°Ñ…Ğ¾Ğ´Ğ¸Ğ¼ ÑĞ»ĞµĞ´ÑƒÑÑ‰Ğ¸Ğ¹ Ñ€Ğ°Ğ±Ğ¾Ñ‡Ğ¸Ğ¹ Ğ´ĞµĞ½ÑŒ Ğ¿Ğ¾ÑĞ»Ğµ ÑĞºĞ¾Ñ€Ñ€ĞµĞºÑ‚Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ½Ğ¾Ğ¹ Ğ´Ğ°Ñ‚Ñ‹ Ğ½Ğ°Ñ‡Ğ°Ğ»Ğ°
        const initialEndDate = DateService.findNextWorkingDay(initialStartDate, holidays, 1);

        // Ğ£ÑÑ‚Ğ°Ğ½Ğ°Ğ²Ğ»Ğ¸Ğ²Ğ°ĞµĞ¼ Ğ½Ğ¾Ğ²Ñ‹Ğ¹ Ğ´Ğ¸Ğ°Ğ¿Ğ°Ğ·Ğ¾Ğ½
        get().setRange(initialStartDate, initialEndDate, 'manual', holidays);
    },
    // +++ ĞšĞĞĞ•Ğ¦: ĞĞĞ’ĞĞ¯ Ğ¤Ğ£ĞĞšĞ¦Ğ˜Ğ¯ +++

    setRange: (from, to, source, holidays = []) => {
        const currentState = get();
        const normalizedFrom = normalizeDate(from);
        let normalizedTo = normalizeDate(to);

        if (normalizedFrom.getTime() >= normalizedTo.getTime()) {
            normalizedTo = new Date(normalizedFrom);
            normalizedTo.setDate(normalizedTo.getDate() + 1);
        }

        normalizedTo = DateService.adjustDateIfHoliday(normalizedTo, holidays);

        if (
            normalizedFrom.getTime() === currentState.startDate.getTime() &&
            normalizedTo.getTime() === currentState.endDate.getTime()
        ) {
            return;
        }

        if (!isValidDateRange(normalizedFrom, normalizedTo)) {
            console.error("[dateStore] Invalid date range:", { from, to });
            return;
        }

        const newDayCount = calculateDayCount(normalizedFrom, normalizedTo, holidays);

        set({
            startDate: normalizedFrom,
            endDate: normalizedTo,
            dayCount: newDayCount,
        });
    },

    setStartDate: (date, holidays = []) => {
        if (!isValidDate(date)) return;
        const state = get();
        const normalizedDate = normalizeDate(date);
        if (isValidDateRange(normalizedDate, state.endDate)) {
            get().setRange(normalizedDate, state.endDate, 'manual', holidays);
        } else {
            const newEndDate = new Date(normalizedDate);
            newEndDate.setDate(newEndDate.getDate() + 1);
            get().setRange(normalizedDate, newEndDate, 'manual', holidays);
        }
    },

    setEndDate: (date, holidays = []) => {
        if (!isValidDate(date)) return;
        const state = get();
        const normalizedDate = normalizeDate(date);
        if (isValidDateRange(state.startDate, normalizedDate)) {
            get().setRange(state.startDate, normalizedDate, 'manual', holidays);
        }
    },

    setDayCount: (days, holidays = []) => {
        const state = get();
        const potentialEndDate = addDays(state.startDate, days);
        get().setRange(state.startDate, potentialEndDate, 'slider', holidays);
    },

    reset: (holidays = []) => {
        const newStart = normalizeDate(new Date());
        const newEnd = normalizeDate(new Date());
        newEnd.setDate(newEnd.getDate() + 1);
        get().setRange(newStart, newEnd, 'manual', holidays);
    },
}));

```


## <a name="rentalappmainsrcstorefilterStorets"></a>`rental-app-main/src/store/filterStore.ts`

```typescript
// path: rental-app-main/src/store/filterStore.ts

// src/store/filterStore.ts
import { create } from "zustand"

type FilterState = {
  brand: string
  type: string | null
  associationId: number | null
  availableOnly: boolean
  setBrand: (brand: string) => void
  setType: (type: string | null) => void
  setAssociationId: (id: number | null) => void
  setAvailableOnly: (value: boolean) => void
  reset: () => void
}

export const useFilterStore = create<FilterState>((set) => ({
  brand: "__all__",            // ĞŸĞ¾ ÑƒĞ¼Ğ¾Ğ»Ñ‡Ğ°Ğ½Ğ¸Ñ Ğ¿Ğ¾ĞºĞ°Ğ·Ñ‹Ğ²Ğ°Ñ‚ÑŒ Ğ²ÑĞµ Ğ±Ñ€ĞµĞ½Ğ´Ñ‹
  type: null,                  // <-- ĞŸĞ¾ ÑƒĞ¼Ğ¾Ğ»Ñ‡Ğ°Ğ½Ğ¸Ñ Ğ¿Ğ¾ĞºĞ°Ğ·Ñ‹Ğ²Ğ°Ñ‚ÑŒ Ğ²ÑĞµ Ñ‚Ğ¸Ğ¿Ñ‹
  associationId: null,
  availableOnly: false,
  setBrand: (brand) => set({ brand }),
  setType: (type) => set({ type }),
  setAssociationId: (id) => set({ associationId: id }),
  setAvailableOnly: (value) => set({ availableOnly: value }),
  reset: () => set({
    brand: "__all__",
    type: null,               // <-- Ğ¡Ğ±Ñ€Ğ¾Ñ Ğ´Ğ¾Ğ»Ğ¶ĞµĞ½ Ñ‚Ğ¾Ğ¶Ğµ Ğ´Ğ°Ğ²Ğ°Ñ‚ÑŒ null
    associationId: null,
    availableOnly: false,
  }),
}))


```


## <a name="rentalappmainsrcstoreholidayStorets"></a>`rental-app-main/src/store/holidayStore.ts`

```typescript
// path: rental-app-main/src/store/holidayStore.ts

// src/store/holidayStore.ts

import { create } from 'zustand';
import { api } from '@/lib/api';
import { formatDate } from '@/lib/utils';
import type { Holiday, HolidayListResponse } from '@/types/holiday';

type HolidayState = {
    holidays: Date[];
    isLoading: boolean;
    lastFetchedRange: { start: string; end: string } | null;
    fetchHolidays: (start: Date, end: Date) => Promise<void>;
};

export const useHolidayStore = create<HolidayState>((set, get) => ({
    holidays: [],
    isLoading: false,
    lastFetchedRange: null,

    fetchHolidays: async (start, end) => {
        const formattedStart = formatDate(start);
        const formattedEnd = formatDate(end);
        const currentRange = get().lastFetchedRange;

        if (
            get().holidays.length > 0 &&
            currentRange?.start === formattedStart &&
            currentRange?.end === formattedEnd
        ) {
            return;
        }

        set({ isLoading: true });
        try {
            const response = await api.get<HolidayListResponse>('/holidays/', {
                params: {
                    start_date: formattedStart,
                    end_date: formattedEnd,
                    // Ğ˜Ğ—ĞœĞ•ĞĞ•ĞĞ˜Ğ•: Ğ£ÑÑ‚Ğ°Ğ½Ğ°Ğ²Ğ»Ğ¸Ğ²Ğ°ĞµĞ¼ Ğ»Ğ¸Ğ¼Ğ¸Ñ‚ Ğ² 100, Ñ‡Ñ‚Ğ¾Ğ±Ñ‹ ÑĞ¾Ğ¾Ñ‚Ğ²ĞµÑ‚ÑÑ‚Ğ²Ğ¾Ğ²Ğ°Ñ‚ÑŒ Ğ²Ğ°Ğ»Ğ¸Ğ´Ğ°Ñ†Ğ¸Ğ¸ Ğ±ÑĞºĞµĞ½Ğ´Ğ°
                    limit: 100
                },
            });

            const holidayDates = response.data.items.map((h: Holiday) => new Date(h.date));
            set({
                holidays: holidayDates,
                lastFetchedRange: { start: formattedStart, end: formattedEnd },
            });
        } catch (error) {
            console.error("Failed to fetch holidays:", error);
            set({ holidays: [], lastFetchedRange: null });
        } finally {
            set({ isLoading: false });
        }
    },
}));

```


## <a name="rentalappmainsrcstoreorderFilterStorets"></a>`rental-app-main/src/store/orderFilterStore.ts`

```typescript
// path: rental-app-main/src/store/orderFilterStore.ts

import { create } from "zustand"

export type SortOption =
    | "start_asc"
    | "start_desc"
    | "end_asc"
    | "end_desc"
    | "count_asc"
    | "count_desc"
    | "id_asc"
    | "id_desc"

export type OrderContext = 
    | "user-reservations"
    | "user-rentals"
    | "admin-reservations"
    | "admin-rentals"

type OrderFilterState = {
    searchQuery: string
    statusFilter: string | null
    sortOption: SortOption
    setSearchQuery: (query: string) => void
    setStatusFilter: (filter: string | null) => void
    setSortOption: (option: SortOption) => void
    resetFilters: () => void
}

export const useOrderFilterStore = create<OrderFilterState>()((set) => ({
    searchQuery: "",
    statusFilter: "active",
    sortOption: "id_desc",
    setSearchQuery: (query) => set({ searchQuery: query }),
    setStatusFilter: (filter) => set({ statusFilter: filter }),
    setSortOption: (option) => set({ sortOption: option }),
    resetFilters: () => set({ 
        searchQuery: "", 
        statusFilter: "active", 
        sortOption: "id_desc" 
    }),
}))


```


## <a name="rentalappmainsrcstorepromoCodeStorets"></a>`rental-app-main/src/store/promoCodeStore.ts`

```typescript
// path: rental-app-main/src/store/promoCodeStore.ts

// src/store/promoCodeStore.ts

import { create } from "zustand";
import { toast } from "sonner";

type PromoCodeState = {
    promoCode: string;
    promoCodePercentage: number;
    promoCodeMessage: string;
};

type PromoCodeActions = {
    setPromoCode: (code: string) => void;
    setPromoCodeResult: (percentage: number, message: string) => void;
    removePromoCode: () => void;
    clearPromoCode: () => void; // Ğ”Ğ»Ñ ÑĞ±Ñ€Ğ¾ÑĞ° Ğ±ĞµĞ· ÑƒĞ²ĞµĞ´Ğ¾Ğ¼Ğ»ĞµĞ½Ğ¸Ñ
};

type PromoCodeStore = PromoCodeState & PromoCodeActions;

export const usePromoCodeStore = create<PromoCodeStore>((set) => ({
    // State
    promoCode: "",
    promoCodePercentage: 0,
    promoCodeMessage: "",

    // Actions
    setPromoCode: (code) => set({ promoCode: code, promoCodeMessage: "" }), // Ğ¡Ğ±Ñ€Ğ°ÑÑ‹Ğ²Ğ°ĞµĞ¼ ÑĞ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ğµ Ğ¿Ñ€Ğ¸ Ğ½Ğ¾Ğ²Ğ¾Ğ¼ Ğ²Ğ²Ğ¾Ğ´Ğµ

    setPromoCodeResult: (percentage, message) => set({
        promoCodePercentage: percentage,
        promoCodeMessage: message
    }),

    removePromoCode: () => {
        set({ promoCode: "", promoCodePercentage: 0, promoCodeMessage: "" });
        toast.info("ĞŸÑ€Ğ¾Ğ¼Ğ¾ĞºĞ¾Ğ´ ÑĞ±Ñ€Ğ¾ÑˆĞµĞ½.");
    },

    // "Ğ¢Ğ¸Ñ…Ğ¸Ğ¹" ÑĞ±Ñ€Ğ¾Ñ, Ğ¸ÑĞ¿Ğ¾Ğ»ÑŒĞ·ÑƒĞµĞ¼Ñ‹Ğ¹ Ğ¿Ñ€Ğ¾Ğ³Ñ€Ğ°Ğ¼Ğ¼Ğ½Ğ¾ Ğ¿Ñ€Ğ¸ Ğ·Ğ°ĞºÑ€Ñ‹Ñ‚Ğ¸Ğ¸ Ñ„Ğ¾Ñ€Ğ¼/Ğ´Ğ¸Ğ°Ğ»Ğ¾Ğ³Ğ¾Ğ²
    clearPromoCode: () => set({ promoCode: "", promoCodePercentage: 0, promoCodeMessage: "" }),
}));

```


## <a name="rentalappmainsrcstorereserveStorets"></a>`rental-app-main/src/store/reserveStore.ts`

```typescript
// path: rental-app-main/src/store/reserveStore.ts

// src/store/reserveStore.ts
import { create } from "zustand";
import { subscribeWithSelector } from "zustand/middleware";
import type { Equipment } from "@/types/equipment";

type ReserveState = {
    items: Equipment[];
    reservationId: number | null;
    addToReservationMode: number | null;
    selectedAccessories: Record<number, number[]>;
};

type ReserveActions = {
    toggle: (equipment: Equipment) => void;
    add: (equipment: Equipment) => void;
    // ğŸ‘‡ Ğ”ĞĞ‘ĞĞ’Ğ›Ğ•Ğ ĞĞĞ’Ğ«Ğ™ ĞœĞ•Ğ¢ĞĞ” Ğ’ Ğ¢Ğ˜ĞŸ
    addWithAccessories: (equipment: Equipment, accessoryIds: number[]) => void;
    remove: (equipmentId: number) => void;
    bulkAdd: (equipmentList: Equipment[]) => void;
    clear: () => void;
    clearItemsOnly: () => void;
    isSelected: (equipmentId: number) => boolean;
    setReservationId: (id: number | null) => void;
    setAddToReservationMode: (reservationId: number | null) => void;
    completeAddition: () => Equipment[];
    logState: () => void;
    toggleAccessory: (equipmentId: number, accessoryId: number) => void;
    isAccessorySelected: (equipmentId: number, accessoryId: number) => boolean;
    clearAccessoriesForEquipment: (equipmentId: number) => void;
};

type ReserveStore = ReserveState & ReserveActions;

const isEquipmentSelected = (items: Equipment[], equipmentId: number) =>
    items.some((item) => item.id === equipmentId);

export const useReserveStore = create<ReserveStore>()(
    subscribeWithSelector((set, get) => ({
        items: [],
        reservationId: null,
        addToReservationMode: null,
        selectedAccessories: {},

        toggle: (equipment: Equipment) => {
            const currentItems = get().items;
            const isAlreadySelected = isEquipmentSelected(currentItems, equipment.id);

            if (isAlreadySelected) {
                get().clearAccessoriesForEquipment(equipment.id);
            }

            const newItems = isAlreadySelected
                ? currentItems.filter((item) => item.id !== equipment.id)
                : [...currentItems, equipment];

            set({ items: newItems });
        },

        add: (equipment: Equipment) => {
            const currentItems = get().items;
            if (!isEquipmentSelected(currentItems, equipment.id)) {
                set({ items: [...currentItems, equipment] });
            }
        },

        // ğŸ‘‡ Ğ Ğ•ĞĞ›Ğ˜Ğ—ĞĞ¦Ğ˜Ğ¯ ĞĞĞ’ĞĞ“Ğ ĞœĞ•Ğ¢ĞĞ”Ğ
        addWithAccessories: (equipment, accessoryIds) => {
            set(state => {
                // Ğ”Ğ¾Ğ±Ğ°Ğ²Ğ»ÑĞµĞ¼ Ğ¾ÑĞ½Ğ¾Ğ²Ğ½Ğ¾Ğµ Ğ¾Ğ±Ğ¾Ñ€ÑƒĞ´Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ, ĞµÑĞ»Ğ¸ ĞµĞ³Ğ¾ ĞµÑ‰Ğµ Ğ½ĞµÑ‚
                const items = state.items.some(i => i.id === equipment.id)
                    ? state.items
                    : [...state.items, equipment];

                // Ğ”Ğ¾Ğ±Ğ°Ğ²Ğ»ÑĞµĞ¼ Ğ¸Ğ»Ğ¸ Ğ¾Ğ±Ğ½Ğ¾Ğ²Ğ»ÑĞµĞ¼ Ğ°ĞºÑĞµÑÑÑƒĞ°Ñ€Ñ‹ Ğ´Ğ»Ñ ÑÑ‚Ğ¾Ğ³Ğ¾ Ğ¾Ğ±Ğ¾Ñ€ÑƒĞ´Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ
                const newSelectedAccessories = { ...state.selectedAccessories };
                if (accessoryIds.length > 0) {
                    newSelectedAccessories[equipment.id] = accessoryIds;
                } else {
                    // Ğ•ÑĞ»Ğ¸ Ğ¿ĞµÑ€ĞµĞ´Ğ°Ğ½ Ğ¿ÑƒÑÑ‚Ğ¾Ğ¹ Ğ¼Ğ°ÑÑĞ¸Ğ², ÑƒĞ´Ğ°Ğ»ÑĞµĞ¼ Ğ°ĞºÑĞµÑÑÑƒĞ°Ñ€Ñ‹ Ğ´Ğ»Ñ ÑÑ‚Ğ¾Ğ³Ğ¾ ÑĞ»ĞµĞ¼ĞµĞ½Ñ‚Ğ°
                    delete newSelectedAccessories[equipment.id];
                }

                return { items, selectedAccessories: newSelectedAccessories };
            });
        },

        remove: (equipmentId: number) => {
            get().clearAccessoriesForEquipment(equipmentId);
            set(state => ({
                items: state.items.filter((item) => item.id !== equipmentId)
            }));
        },

        bulkAdd: (equipmentList: Equipment[]) => {
            set(state => {
                const currentIds = new Set(state.items.map(item => item.id));
                const newEquipment = equipmentList.filter(eq => !currentIds.has(eq.id));
                return { items: [...state.items, ...newEquipment] };
            });
        },

        clear: () => {
            set({
                items: [],
                reservationId: null,
                addToReservationMode: null,
                selectedAccessories: {},
            });
        },

        clearItemsOnly: () => {
            set({ items: [], selectedAccessories: {} });
        },

        isSelected: (equipmentId: number) => isEquipmentSelected(get().items, equipmentId),

        setReservationId: (id: number | null) => set({ reservationId: id }),

        setAddToReservationMode: (reservationId: number | null) => set({ addToReservationMode: reservationId }),

        completeAddition: () => {
            const state = get();
            const addedItems = [...state.items];
            set({ items: [], addToReservationMode: null, selectedAccessories: {} });
            return addedItems;
        },

        logState: () => {
            console.log(`[ReserveStore] Current state:`, get());
        },

        toggleAccessory: (equipmentId, accessoryId) => {
            set(state => {
                const currentSelection = state.selectedAccessories[equipmentId] || [];
                const isSelected = currentSelection.includes(accessoryId);
                const newSelection = isSelected
                    ? currentSelection.filter(id => id !== accessoryId)
                    : [...currentSelection, accessoryId];

                const newSelectedAccessories = { ...state.selectedAccessories };

                if (newSelection.length > 0) {
                    newSelectedAccessories[equipmentId] = newSelection;
                } else {
                    delete newSelectedAccessories[equipmentId];
                }

                return { selectedAccessories: newSelectedAccessories };
            });
        },

        isAccessorySelected: (equipmentId, accessoryId) => {
            const selection = get().selectedAccessories[equipmentId];
            return selection ? selection.includes(accessoryId) : false;
        },

        clearAccessoriesForEquipment: (equipmentId) => {
            set(state => {
                if (!state.selectedAccessories[equipmentId]) {
                    return state;
                }
                const newSelections = { ...state.selectedAccessories };
                delete newSelections[equipmentId];
                return { selectedAccessories: newSelections };
            });
        }
    }))
);

// ĞŸĞ¾Ğ´Ğ¿Ğ¸ÑĞºĞ¸ Ğ½Ğ° Ğ¸Ğ·Ğ¼ĞµĞ½ĞµĞ½Ğ¸Ñ Ğ´Ğ»Ñ Ğ¾Ñ‚Ğ»Ğ°Ğ´ĞºĞ¸ (Ğ¾ÑÑ‚Ğ°ÑÑ‚ÑÑ Ğ±ĞµĞ· Ğ¸Ğ·Ğ¼ĞµĞ½ĞµĞ½Ğ¸Ğ¹)
useReserveStore.subscribe(
    (state) => state.items,
    (items, previousItems) => {
        if (items.length !== previousItems.length) {
            console.log(`[ReserveStore] Items changed: ${previousItems.length} -> ${items.length}`);
        }
    }
);

useReserveStore.subscribe(
    (state) => state.reservationId,
    (reservationId, previousReservationId) => {
        if (reservationId !== previousReservationId) {
            console.log(`[ReserveStore] Reservation ID changed: ${previousReservationId} -> ${reservationId}`);
        }
    }
);

useReserveStore.subscribe(
    (state) => state.addToReservationMode,
    (addToReservationMode, previousAddToReservationMode) => {
        if (addToReservationMode !== previousAddToReservationMode) {
            console.log(`[ReserveStore] Add to reservation mode changed: ${previousAddToReservationMode} -> ${addToReservationMode}`);
        }
    }
);

```


## <a name="rentalappmainsrcstoresandboxCalculatorStorets"></a>`rental-app-main/src/store/sandboxCalculatorStore.ts`

```typescript
// path: rental-app-main/src/store/sandboxCalculatorStore.ts

// src/store/sandboxCalculatorStore.ts

import { create } from "zustand";
import { useDateStore } from "./dateStore";
import { useHolidayStore } from "./holidayStore";
import { api } from "@/lib/api";
import type { DurationDiscount, DiscountListResponse } from "@/types/discount";

type SandboxCalculatorState = {
    durationDiscountTiers: DurationDiscount[];
    durationDiscountPercentage: number;
    isLoadingTiers: boolean;
    isCalculatorVisible: boolean;
};

type SandboxCalculatorActions = {
    fetchDiscountTiers: () => Promise<void>;
    setDaysFromCalendar: (days: number) => void;
    setDaysFromSlider: (days: number) => void;
    toggleCalculator: () => void;
    _calculateDurationDiscount: (dayCount: number) => void;
    syncWithDateStore: () => void;
    refreshCalculator: () => void;
};

type SandboxCalculatorStore = SandboxCalculatorState & SandboxCalculatorActions;

export const useSandboxCalculatorStore = create<SandboxCalculatorStore>((set, get) => ({
    durationDiscountTiers: [],
    durationDiscountPercentage: 0,
    isLoadingTiers: false,
    isCalculatorVisible: false,

    _calculateDurationDiscount: (dayCount: number) => {
        const tiers = get().durationDiscountTiers;
        const applicableDiscount = tiers
            .filter(tier => dayCount >= tier.min_days)
            .sort((a, b) => b.min_days - a.min_days)[0];
        set({
            durationDiscountPercentage: applicableDiscount ? applicableDiscount.discount_percentage : 0,
        });
    },

    syncWithDateStore: () => {
        const { dayCount } = useDateStore.getState();
        const { holidays } = useHolidayStore.getState();
        const { _calculateDurationDiscount, isCalculatorVisible, fetchDiscountTiers } = get();

        if (dayCount >= 4 && !isCalculatorVisible) {
            set({ isCalculatorVisible: true });
            void fetchDiscountTiers();
        }

        if (get().durationDiscountTiers.length > 0) {
            _calculateDurationDiscount(dayCount);
        }
    },

    fetchDiscountTiers: async () => {
        if (get().durationDiscountTiers.length > 0 || get().isLoadingTiers) return;
        set({ isLoadingTiers: true });
        try {
            const response = await api.get<DiscountListResponse>("/discounts/");
            set({ durationDiscountTiers: response.data.items, isLoadingTiers: false });
            const { dayCount } = useDateStore.getState();
            get()._calculateDurationDiscount(dayCount);
        } catch (error) {
            console.error("Failed to fetch discount tiers:", error);
            set({ isLoadingTiers: false });
        }
    },

    setDaysFromCalendar: (days: number) => {
        const { isCalculatorVisible, fetchDiscountTiers, _calculateDurationDiscount } = get();

        if (!isCalculatorVisible && days >= 4) {
            void fetchDiscountTiers();
        }
        if (get().durationDiscountTiers.length > 0) {
            _calculateDurationDiscount(days);
        }
        if (days >= 4) {
            set({ isCalculatorVisible: true });
        }
    },

    setDaysFromSlider: (days: number) => {
        const dateStore = useDateStore.getState();
        const { holidays } = useHolidayStore.getState();

        // --- Ğ˜Ğ—ĞœĞ•ĞĞ•ĞĞ˜Ğ• Ğ—Ğ”Ğ•Ğ¡Ğ¬ ---
        // Ğ¢ĞµĞ¿ĞµÑ€ÑŒ ÑÑ‚Ğ° Ñ„ÑƒĞ½ĞºÑ†Ğ¸Ñ Ñ‚Ğ¾Ğ»ÑŒĞºĞ¾ Ğ¿ĞµÑ€ĞµĞ´Ğ°ĞµÑ‚ Ğ´Ğ°Ğ½Ğ½Ñ‹Ğµ Ğ² dateStore
        // Ğ¸ Ğ±Ğ¾Ğ»ÑŒÑˆĞµ Ğ½Ğµ Ğ²Ñ‹Ğ·Ñ‹Ğ²Ğ°ĞµÑ‚ Ñ€Ğ°ÑÑ‡ĞµÑ‚ ÑĞºĞ¸Ğ´ĞºĞ¸ Ğ½Ğ°Ğ¿Ñ€ÑĞ¼ÑƒÑ.
        dateStore.setDayCount(days, holidays);
        // -------------------------

        if (days >= 4) set({ isCalculatorVisible: true });
    },

    toggleCalculator: () => {
        const alreadyVisible = get().isCalculatorVisible;
        if (!alreadyVisible) void get().fetchDiscountTiers();
        set({ isCalculatorVisible: !alreadyVisible });
    },

    refreshCalculator: () => {
        const { dayCount } = useDateStore.getState();
        const { _calculateDurationDiscount } = get();

        if (get().durationDiscountTiers.length > 0 && dayCount > 0) {
            _calculateDurationDiscount(dayCount);
        }
    },
}));

```


## <a name="rentalappmainsrcstoresearchStorets"></a>`rental-app-main/src/store/searchStore.ts`

```typescript
// path: rental-app-main/src/store/searchStore.ts

import { create } from "zustand"

interface SearchState {
  query: string
  setQuery: (value: string) => void
}

export const useSearchStore = create<SearchState>((set) => ({
  query: "",
  setQuery: (value) => set({ query: value })
}))


```


## <a name="rentalappmainsrcstoreviewModeStorets"></a>`rental-app-main/src/store/viewModeStore.ts`

```typescript
// path: rental-app-main/src/store/viewModeStore.ts

// src/store/viewModeStore.ts

import { create } from "zustand";

// Ğ˜ÑĞ¿Ğ¾Ğ»ÑŒĞ·ÑƒĞµĞ¼ 'default' Ğ¸ 'compact' Ğ´Ğ»Ñ ĞµĞ´Ğ¸Ğ½Ğ¾Ğ¾Ğ±Ñ€Ğ°Ğ·Ğ¸Ñ
export type ViewMode = 'default' | 'compact';

type ViewState = {
  viewMode: ViewMode;
  setViewMode: (mode: ViewMode) => void;
};

export const useViewModeStore = create<ViewState>((set) => ({
  viewMode: 'default', // Ğ˜ÑÑ…Ğ¾Ğ´Ğ½Ğ¾Ğµ ÑĞ¾ÑÑ‚Ğ¾ÑĞ½Ğ¸Ğµ
  // Ğ‘Ğ¾Ğ»ĞµĞµ ÑĞ²Ğ½Ñ‹Ğ¹ Ğ¼ĞµÑ‚Ğ¾Ğ´ ÑƒÑÑ‚Ğ°Ğ½Ğ¾Ğ²ĞºĞ¸, ĞºĞ¾Ñ‚Ğ¾Ñ€Ñ‹Ğ¹ Ğ¿Ğ¾Ğ½Ğ°Ğ´Ğ¾Ğ±Ğ¸Ñ‚ÑÑ Ğ´Ğ»Ñ ToggleGroup
  setViewMode: (mode) => set({ viewMode: mode }),
}));

```


## <a name="rentalappmainsrctypesaccessoryts"></a>`rental-app-main/src/types/accessory.ts`

```typescript
// path: rental-app-main/src/types/accessory.ts

// src/types/accessory.ts

export interface Accessory {
    id: number;
    name: string;
    accessory_type: string;
    price: number;
    description?: string;
}

// Ğ”ĞĞ‘ĞĞ’Ğ›Ğ¯Ğ•Ğœ Ğ­Ğ¢ĞĞ¢ Ğ˜ĞĞ¢Ğ•Ğ Ğ¤Ğ•Ğ™Ğ¡
export interface AccessoryListResponse {
    items: Accessory[];
    total: number;
}

```


## <a name="rentalappmainsrctypesassociationts"></a>`rental-app-main/src/types/association.ts`

```typescript
// path: rental-app-main/src/types/association.ts

// src/types/association.ts

export interface Association {
    id: number;
    name: string;
    description?: string;
    sort_order: number;
    equipment_ids: number[];
}

export type AssociationCreate = Omit<Association, 'id'>;
export type AssociationUpdate = Partial<AssociationCreate>;

// Ğ”ĞĞ‘ĞĞ’Ğ¬Ğ¢Ğ• Ğ­Ğ¢ĞĞ¢ Ğ­ĞšĞ¡ĞŸĞĞ Ğ¢
export interface AssociationListResponse {
    items: Association[];
    total: number;
}

```


## <a name="rentalappmainsrctypesavailabilityts"></a>`rental-app-main/src/types/availability.ts`

```typescript
// path: rental-app-main/src/types/availability.ts

// src/types/availability.ts

export type EquipmentStatus = "available" | "reserved" | "rented";

export interface AvailabilityInfo {
  equipment_id: number;
  status: EquipmentStatus;
  start_date?: string | null;
  end_date?: string | null;
  details: string;
}

// Ğ”ĞĞ‘ĞĞ’Ğ¬Ğ¢Ğ• Ğ­Ğ¢ĞĞ¢ Ğ˜ĞĞ¢Ğ•Ğ Ğ¤Ğ•Ğ™Ğ¡
// ĞĞ½ Ğ¾Ğ¿Ğ¸ÑÑ‹Ğ²Ğ°ĞµÑ‚ ÑÑ‚Ñ€ÑƒĞºÑ‚ÑƒÑ€Ñƒ Ğ¾Ñ‚Ğ²ĞµÑ‚Ğ° Ğ¾Ñ‚ /calendar/view
export interface AvailabilityListResponse {
  items: AvailabilityInfo[];
  total: number;
}


export interface ConflictDetail {
  type: 'reservation' | 'rental';
  id: number;
  user_name?: string; // Ğ˜Ğ¼Ñ ĞºĞ»Ğ¸ĞµĞ½Ñ‚Ğ° Ğ² ĞºĞ¾Ğ½Ñ„Ğ»Ğ¸ĞºÑ‚Ğµ
  start_date: string;
  end_date: string;
}

export interface EquipmentConflictInfo {
  equipment_id: number;
  conflicts: ConflictDetail[];
}

export interface DayStatus {
  status: EquipmentStatus;
  group_id: string | null;
  is_user_reservation: boolean;
}

```


## <a name="rentalappmainsrctypesbalanceHistoryts"></a>`rental-app-main/src/types/balanceHistory.ts`

```typescript
// path: rental-app-main/src/types/balanceHistory.ts

// src/types/balanceHistory.ts

export interface BalanceHistoryEntry {
    id: number;
    user_id: number;
    rental_id: number | null;
    amount: number;
    operation_type: string;
    description: string | null;
    created_at: string; // Ğ”Ğ°Ñ‚Ğ° Ğ² Ñ„Ğ¾Ñ€Ğ¼Ğ°Ñ‚Ğµ ISO-ÑÑ‚Ñ€Ğ¾ĞºĞ¸
}

export interface BalanceHistoryListResponse {
    items: BalanceHistoryEntry[];
    total: number;
}

```


## <a name="rentalappmainsrctypesdiscountts"></a>`rental-app-main/src/types/discount.ts`

```typescript
// path: rental-app-main/src/types/discount.ts

// src/types/discount.ts

// Ğ¢Ğ¸Ğ¿ Ğ´Ğ»Ñ ÑĞºĞ¸Ğ´ĞºĞ¸, ĞºĞ°Ğº Ğ¾Ğ½Ğ° Ğ¿Ñ€Ğ¸Ñ…Ğ¾Ğ´Ğ¸Ñ‚ Ğ¾Ñ‚ API
export interface DurationDiscount {
    id: number;
    min_days: number;
    discount_percentage: number;
}

// Ğ¢Ğ¸Ğ¿ Ğ´Ğ»Ñ Ğ´Ğ°Ğ½Ğ½Ñ‹Ñ…, Ğ¾Ñ‚Ğ¿Ñ€Ğ°Ğ²Ğ»ÑĞµĞ¼Ñ‹Ñ… Ğ½Ğ° API Ğ´Ğ»Ñ ÑĞ¾Ğ·Ğ´Ğ°Ğ½Ğ¸Ñ ÑĞºĞ¸Ğ´ĞºĞ¸
export type DiscountPayload = Omit<DurationDiscount, 'id'>;

// Ğ¢Ğ¸Ğ¿ Ğ´Ğ»Ñ Ğ¾Ñ‚Ğ²ĞµÑ‚Ğ° Ğ¾Ñ‚ API ÑĞ¾ ÑĞ¿Ğ¸ÑĞºĞ¾Ğ¼ ÑĞºĞ¸Ğ´Ğ¾Ğº
export interface DiscountListResponse {
    items: DurationDiscount[];
    total: number;
}

```


## <a name="rentalappmainsrctypesequipmentts"></a>`rental-app-main/src/types/equipment.ts`

```typescript
// path: rental-app-main/src/types/equipment.ts

// src/types/equipment.ts

// âœ… Ğ”ĞĞ‘ĞĞ’Ğ›Ğ•Ğ Ğ˜ĞœĞŸĞĞ Ğ¢
import type { Accessory } from "./accessory";

export interface Equipment {
  id: number;
  equipment_type: string;
  brand: string;
  name: string;
  serial_number?: string;
  condition: string;
  daily_rate: number;
  notes?: string;
  description?: string;
  last_maintenance?: string;
  image_url?: string;
  image_urls?: string[];
  short_description?: string;
  // âœ… Ğ”ĞĞ‘ĞĞ’Ğ›Ğ•ĞĞ ĞŸĞĞ›Ğ•
  accessories: Accessory[];
}

```


## <a name="rentalappmainsrctypesholidayts"></a>`rental-app-main/src/types/holiday.ts`

```typescript
// path: rental-app-main/src/types/holiday.ts

// src/types/holiday.ts

// Ğ¢Ğ¸Ğ¿ Ğ´Ğ»Ñ Ğ¾Ğ´Ğ½Ğ¾Ğ³Ğ¾ Ğ²Ñ‹Ñ…Ğ¾Ğ´Ğ½Ğ¾Ğ³Ğ¾ Ğ´Ğ½Ñ, ĞºĞ°Ğº Ğ¾Ğ½ Ğ¿Ñ€Ğ¸Ñ…Ğ¾Ğ´Ğ¸Ñ‚ Ğ¾Ñ‚ API
export interface Holiday {
    date: string; // Ğ¤Ğ¾Ñ€Ğ¼Ğ°Ñ‚ 'YYYY-MM-DD'
    description: string | null;
    created_at: string;
    created_by_id: number;
}

// Ğ¢Ğ¸Ğ¿ Ğ´Ğ»Ñ Ğ¾Ñ‚Ğ²ĞµÑ‚Ğ° API ÑĞ¾ ÑĞ¿Ğ¸ÑĞºĞ¾Ğ¼ Ğ²Ñ‹Ñ…Ğ¾Ğ´Ğ½Ñ‹Ñ…
export interface HolidayListResponse {
    items: Holiday[];
    total: number;
}

```


## <a name="rentalappmainsrctypespromocodets"></a>`rental-app-main/src/types/promo_code.ts`

```typescript
// path: rental-app-main/src/types/promo_code.ts

// src/types/promo_code.ts

// Ğ¢Ğ¸Ğ¿ Ğ´Ğ»Ñ Ğ´Ğ°Ğ½Ğ½Ñ‹Ñ…, ĞºĞ¾Ñ‚Ğ¾Ñ€Ñ‹Ğµ Ğ¼Ñ‹ Ğ¿Ğ¾Ğ»ÑƒÑ‡Ğ°ĞµĞ¼ Ğ¾Ñ‚ API Ğ¿Ñ€Ğ¸ Ğ·Ğ°Ğ¿Ñ€Ğ¾ÑĞµ ÑĞ¿Ğ¸ÑĞºĞ° Ğ¿Ñ€Ğ¾Ğ¼Ğ¾ĞºĞ¾Ğ´Ğ¾Ğ²
export interface PromoCodeOut {
    id: number;
    code: string;
    description: string | null;
    discount_percentage: number;
    is_active: boolean;
    valid_from: string | null; // Ğ”Ğ°Ñ‚Ñ‹ Ğ¿Ñ€Ğ¸Ñ…Ğ¾Ğ´ÑÑ‚ ĞºĞ°Ğº ÑÑ‚Ñ€Ğ¾ĞºĞ¸ Ğ² Ñ„Ğ¾Ñ€Ğ¼Ğ°Ñ‚Ğµ ISO
    expires_at: string | null;
    max_uses: number | null;
    times_used: number;
    max_uses_per_user: number | null;
    min_order_amount: number | null;
    specific_to_user_id: number | null;
    applicable_to_equipment_ids: number[] | null;
    applicable_to_equipment_types: string[] | null;
    created_at: string;
    created_by_id: number;
    creator_email?: string; // ĞĞ¿Ñ†Ğ¸Ğ¾Ğ½Ğ°Ğ»ÑŒĞ½Ğ¾Ğµ Ğ¿Ğ¾Ğ»Ğµ Ğ´Ğ»Ñ ÑƒĞ´Ğ¾Ğ±ÑÑ‚Ğ²Ğ°
}

// Ğ¢Ğ¸Ğ¿ Ğ´Ğ»Ñ Ğ´Ğ°Ğ½Ğ½Ñ‹Ñ…, ĞºĞ¾Ñ‚Ğ¾Ñ€Ñ‹Ğµ Ğ¼Ñ‹ Ğ¾Ñ‚Ğ¿Ñ€Ğ°Ğ²Ğ»ÑĞµĞ¼ Ğ½Ğ° API Ğ´Ğ»Ñ ÑĞ¾Ğ·Ğ´Ğ°Ğ½Ğ¸Ñ Ğ¿Ñ€Ğ¾Ğ¼Ğ¾ĞºĞ¾Ğ´Ğ°
// ĞŸĞ¾Ğ»Ñ, ĞºĞ¾Ñ‚Ğ¾Ñ€Ñ‹Ğµ Ğ³ĞµĞ½ĞµÑ€Ğ¸Ñ€ÑƒÑÑ‚ÑÑ ÑĞµÑ€Ğ²ĞµÑ€Ğ¾Ğ¼ (id, times_used, created_at Ğ¸ Ñ‚.Ğ´.), Ğ·Ğ´ĞµÑÑŒ Ğ¾Ñ‚ÑÑƒÑ‚ÑÑ‚Ğ²ÑƒÑÑ‚.
export type PromoCodeCreate = Omit<PromoCodeOut, 'id' | 'times_used' | 'created_at' | 'created_by_id' | 'creator_email'>;

// Ğ¢Ğ¸Ğ¿ Ğ´Ğ»Ñ Ğ¾Ğ±Ğ½Ğ¾Ğ²Ğ»ĞµĞ½Ğ¸Ñ. Ğ’ÑĞµ Ğ¿Ğ¾Ğ»Ñ Ğ¾Ğ¿Ñ†Ğ¸Ğ¾Ğ½Ğ°Ğ»ÑŒĞ½Ñ‹, Ñ‚Ğ°Ğº ĞºĞ°Ğº Ğ¼Ñ‹ Ğ¼Ğ¾Ğ¶ĞµĞ¼ Ğ¾Ğ±Ğ½Ğ¾Ğ²Ğ»ÑÑ‚ÑŒ Ğ¸Ñ… Ğ¿Ğ¾ Ğ¾Ğ´Ğ½Ğ¾Ğ¼Ñƒ.
export type PromoCodeUpdate = Partial<PromoCodeCreate>;

// +++ ĞĞĞ§ĞĞ›Ğ Ğ˜Ğ—ĞœĞ•ĞĞ•ĞĞ˜Ğ™: Ğ”Ğ¾Ğ±Ğ°Ğ²ÑŒÑ‚Ğµ ÑÑ‚Ğ¾Ñ‚ Ğ¸Ğ½Ñ‚ĞµÑ€Ñ„ĞµĞ¹Ñ +++
// ĞĞ½ Ğ¾Ğ¿Ğ¸ÑÑ‹Ğ²Ğ°ĞµÑ‚ ÑÑ‚Ñ€ÑƒĞºÑ‚ÑƒÑ€Ñƒ Ğ¾Ñ‚Ğ²ĞµÑ‚Ğ° API Ñ Ğ¿Ğ°Ğ³Ğ¸Ğ½Ğ°Ñ†Ğ¸ĞµĞ¹
export interface PromoCodeListResponse {
    items: PromoCodeOut[];
    total: number;
}
// +++ ĞšĞĞĞ•Ğ¦ Ğ˜Ğ—ĞœĞ•ĞĞ•ĞĞ˜Ğ™ +++

```


## <a name="rentalappmainsrctypesrentalts"></a>`rental-app-main/src/types/rental.ts`

```typescript
// path: rental-app-main/src/types/rental.ts

// src/types/rental.ts

import type { UserOut } from "./user";
import type { Equipment } from "./equipment";
import type { Accessory } from "./accessory";

export interface RentalAccessoryDetail {
    equipment_id: number;
    accessory: Accessory;
}

export interface RentalReturnRequest {
    actual_return_date: string; // Ğ¤Ğ¾Ñ€Ğ¼Ğ°Ñ‚ 'YYYY-MM-DD'
    notes_on_return?: string;
    accessories_returned_confirmation: boolean;
}

export interface AdminRentalOut {
    id: number;
    user_id: number;
    created_by_id: number;
    reservation_id: number | null;
    start_date: string;
    end_date: string;
    actual_return_date: string | null;
    status: 'active' | 'overdue' | 'completed';
    total_cost: number;
    discount_amount: number;
    promo_code: string | null;
    final_cost: number | null;
    deposit_amount: number;
    prepayment_amount: number;
    accessories_cost: number;
    remaining_amount: number;
    notes_on_issue: string | null;
    notes_on_return: string | null;
    created_at: string;
    updated_at: string;
    user: UserOut;
    created_by: UserOut;
    equipment: Equipment[];
    // --- Ğ˜Ğ—ĞœĞ•ĞĞ•ĞĞ˜Ğ• Ğ—Ğ”Ğ•Ğ¡Ğ¬ ---
    accessory_links: RentalAccessoryDetail[];
    // -------------------------
    days_remaining: number | null;
    overdue_days: number | null;
    overdue_surcharge: number | null;
}

export interface AdminRentalListResponse {
    items: AdminRentalOut[];
    total: number;
}

```


## <a name="rentalappmainsrctypesreservationts"></a>`rental-app-main/src/types/reservation.ts`

```typescript
// path: rental-app-main/src/types/reservation.ts

// src/types/reservation.ts

import type { UserOut } from "./user";
import type { Accessory } from "./accessory";

export interface AccessoryLink {
    equipment_id: number;
    accessory: Accessory;
}

export interface Reservation {
    id: number;
    equipment_ids: number[];
    start_date: string;
    end_date: string;
    status: 'active' | 'fulfilled' | 'cancelled' | 'overdue';
    total_cost?: number;
    discount_amount?: number;
    promo_code?: string | null;
    selected_accessories?: Record<number, number[]>;
    accessory_links?: AccessoryLink[];
    rental_id?: number | null;
}

export interface ReservationWithNames extends Reservation {
    equipment_names: string[];
}

export interface ReservationListResponse {
    items: Reservation[];
    total: number;
}

/* // Ğ—Ğ°ĞºĞ¾Ğ¼Ğ¼ĞµĞ½Ñ‚Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ½Ñ‹Ğ¹ Ğ¸Ğ½Ñ‚ĞµÑ€Ñ„ĞµĞ¹Ñ
export interface ReservationItem {
    id: number;
    user_id: number;
    equipment_ids: number[];
    start_date: string;
    end_date: string;
    status: 'active' | 'fulfilled' | 'cancelled' | 'overdue';
    selected_accessories?: Record<number, number[]>;
    total_cost?: number;
    discount_amount?: number;
    promo_code?: string | null;
    rental_id?: number | null;
}
*/

export interface AdminReservationOut {
    id: number;
    user_id: number;
    equipment_ids: number[];
    start_date: string;
    end_date: string;
    status: 'active' | 'fulfilled' | 'cancelled' | 'overdue';
    selected_accessories?: Record<number, number[]>;
    accessory_links?: AccessoryLink[];
    user_info: UserOut;
    total_cost?: number;
    discount_amount?: number;
    promo_code?: string | null;
    rental_id?: number | null;
}

export interface AdminReservationListResponse {
    items: AdminReservationOut[];
    total: number;
}

```


## <a name="rentalappmainsrctypesuserts"></a>`rental-app-main/src/types/user.ts`

```typescript
// path: rental-app-main/src/types/user.ts

// src/types/user.ts

import { z } from "zod";
import { USER_ROLE_VALUES, type UserRole as UserRoleType } from "@/constants/userConstants";

export type UserRole = UserRoleType;

// Ğ¡Ñ…ĞµĞ¼Ğ° Ğ´Ğ»Ñ Ğ²Ğ°Ğ»Ğ¸Ğ´Ğ°Ñ†Ğ¸Ğ¸ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ñ
export const userOutSchema = z.object({
    id: z.number(),
    full_name: z.string(),
    email: z.string().email(),
    role: z.enum(USER_ROLE_VALUES),
    is_active: z.boolean().nullable().transform((val) => val ?? false),
    phone: z.string().nullable().optional(),
    status: z.string().nullable().optional(),
    balance: z.number().optional(),
    notes: z.string().nullable().optional(),
    privacy_policy_accepted: z.boolean(),
    terms_accepted: z.boolean(),
    email_verified: z.boolean(),
    created_at: z.string().datetime(),
});

// Ğ¢Ğ¸Ğ¿, ĞºĞ¾Ñ‚Ğ¾Ñ€Ñ‹Ğ¹ Ğ¿Ğ¾Ğ»ÑƒÑ‡Ğ°ĞµÑ‚ÑÑ Ğ¸Ğ· ÑÑ…ĞµĞ¼Ñ‹
export type UserOut = z.infer<typeof userOutSchema>;

// +++ Ğ”ĞĞ‘ĞĞ’Ğ¬Ğ¢Ğ• Ğ­Ğ¢ĞĞ¢ Ğ˜ĞĞ¢Ğ•Ğ Ğ¤Ğ•Ğ™Ğ¡ +++
// ĞĞ½ Ğ¾Ğ¿Ğ¸ÑÑ‹Ğ²Ğ°ĞµÑ‚ ÑÑ‚Ñ€ÑƒĞºÑ‚ÑƒÑ€Ñƒ Ğ¾Ñ‚Ğ²ĞµÑ‚Ğ° Ğ¾Ñ‚ /user/admin/users
export interface UserListResponse {
    items: UserOut[];
    total: number;
}

// +++ ĞĞĞ§ĞĞ›Ğ: Ğ¢Ğ¸Ğ¿ Ğ´Ğ»Ñ Ğ·Ğ°Ğ¿Ñ€Ğ¾ÑĞ° Ğ½Ğ° Ğ¿Ğ¾Ğ¿Ğ¾Ğ»Ğ½ĞµĞ½Ğ¸Ğµ Ğ±Ğ°Ğ»Ğ°Ğ½ÑĞ° +++
export interface UserPaymentRequest {
    amount: number;
    payment_method: string;
    description?: string;
}
// +++ ĞšĞĞĞ•Ğ¦: Ğ¢Ğ¸Ğ¿ Ğ´Ğ»Ñ Ğ·Ğ°Ğ¿Ñ€Ğ¾ÑĞ° +++

```


## <a name="rentalappmainsrcutilsphoneUtilsts"></a>`rental-app-main/src/utils/phoneUtils.ts`

```typescript
// path: rental-app-main/src/utils/phoneUtils.ts

// src/utils/phoneUtils.ts

/**
 * Ğ£Ñ‚Ğ¸Ğ»Ğ¸Ñ‚Ñ‹ Ğ´Ğ»Ñ Ñ€Ğ°Ğ±Ğ¾Ñ‚Ñ‹ Ñ Ñ‚ĞµĞ»ĞµÑ„Ğ¾Ğ½Ğ½Ñ‹Ğ¼Ğ¸ Ğ½Ğ¾Ğ¼ĞµÑ€Ğ°Ğ¼Ğ¸
 */

// Ğ ĞµĞ³ÑƒĞ»ÑÑ€Ğ½Ñ‹Ğµ Ğ²Ñ‹Ñ€Ğ°Ğ¶ĞµĞ½Ğ¸Ñ Ğ´Ğ»Ñ Ğ²Ğ°Ğ»Ğ¸Ğ´Ğ°Ñ†Ğ¸Ğ¸ Ñ€Ğ°Ğ·Ğ»Ğ¸Ñ‡Ğ½Ñ‹Ñ… Ñ„Ğ¾Ñ€Ğ¼Ğ°Ñ‚Ğ¾Ğ² Ñ‚ĞµĞ»ĞµÑ„Ğ¾Ğ½Ğ¾Ğ²
export const PHONE_PATTERNS = {
    // Ğ Ğ¾ÑÑĞ¸Ğ¹ÑĞºĞ¸Ğ¹ Ñ„Ğ¾Ñ€Ğ¼Ğ°Ñ‚: +7 (XXX) XXX-XX-XX
    RUSSIAN: /^\+7\s?\(?(\d{3})\)?\s?(\d{3})-?(\d{2})-?(\d{2})$/,
    // ĞœĞµĞ¶Ğ´ÑƒĞ½Ğ°Ñ€Ğ¾Ğ´Ğ½Ñ‹Ğ¹ Ñ„Ğ¾Ñ€Ğ¼Ğ°Ñ‚: +X (XXX) XXX-XXXX
    INTERNATIONAL: /^\+\d{1,3}\s?\(?(\d{3})\)?\s?(\d{3})-?(\d{4})$/,
    // ĞŸÑ€Ğ¾ÑÑ‚Ğ¾Ğ¹ Ñ„Ğ¾Ñ€Ğ¼Ğ°Ñ‚: Ñ‚Ğ¾Ğ»ÑŒĞºĞ¾ Ñ†Ğ¸Ñ„Ñ€Ñ‹
    DIGITS_ONLY: /^\+?[\d\s\-\(\)]+$/,
} as const;

/**
 * Ğ’Ğ°Ğ»Ğ¸Ğ´Ğ¸Ñ€ÑƒĞµÑ‚ Ñ€Ğ¾ÑÑĞ¸Ğ¹ÑĞºĞ¸Ğ¹ Ğ½Ğ¾Ğ¼ĞµÑ€ Ñ‚ĞµĞ»ĞµÑ„Ğ¾Ğ½Ğ°
 */
export function validateRussianPhone(phone: string): boolean {
    if (!phone) return false;

    // Ğ£Ğ´Ğ°Ğ»ÑĞµĞ¼ Ğ²ÑÑ‘, Ñ‡Ñ‚Ğ¾ Ğ½Ğµ ÑĞ²Ğ»ÑĞµÑ‚ÑÑ Ñ†Ğ¸Ñ„Ñ€Ğ¾Ğ¹
    const cleanPhone = phone.replace(/[^\d]/g, '');

    // ĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑĞµĞ¼, Ñ‡Ñ‚Ğ¾ Ğ½Ğ¾Ğ¼ĞµÑ€ Ğ½Ğ°Ñ‡Ğ¸Ğ½Ğ°ĞµÑ‚ÑÑ Ñ 7 Ğ¸Ğ»Ğ¸ 8 Ğ¸ Ğ¸Ğ¼ĞµĞµÑ‚ 11 Ñ†Ğ¸Ñ„Ñ€
    if (!/^[78]\d{10}$/.test(cleanPhone)) {
        return false;
    }

    return true;
}

/**
 * Ğ’Ğ°Ğ»Ğ¸Ğ´Ğ¸Ñ€ÑƒĞµÑ‚ Ğ¼ĞµĞ¶Ğ´ÑƒĞ½Ğ°Ñ€Ğ¾Ğ´Ğ½Ñ‹Ğ¹ Ğ½Ğ¾Ğ¼ĞµÑ€ Ñ‚ĞµĞ»ĞµÑ„Ğ¾Ğ½Ğ°
 */
export function validateInternationalPhone(phone: string): boolean {
    if (!phone) return false;
    
    // Ğ£Ğ±Ğ¸Ñ€Ğ°ĞµĞ¼ Ğ²ÑĞµ Ğ¿Ñ€Ğ¾Ğ±ĞµĞ»Ñ‹ Ğ¸ Ğ´ĞµÑ„Ğ¸ÑÑ‹ Ğ´Ğ»Ñ Ğ¿Ñ€Ğ¾Ğ²ĞµÑ€ĞºĞ¸
    const cleanPhone = phone.replace(/[\s\-\(\)]/g, '');
    
    // ĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑĞµĞ¼, Ñ‡Ñ‚Ğ¾ Ğ½Ğ¾Ğ¼ĞµÑ€ Ğ½Ğ°Ñ‡Ğ¸Ğ½Ğ°ĞµÑ‚ÑÑ Ñ + Ğ¸ Ğ¸Ğ¼ĞµĞµÑ‚ Ğ¾Ñ‚ 7 Ğ´Ğ¾ 15 Ñ†Ğ¸Ñ„Ñ€
    if (!/^\+\d{7,15}$/.test(cleanPhone)) {
        return false;
    }
    
    return true;
}

/**
 * ĞĞ¾Ñ€Ğ¼Ğ°Ğ»Ğ¸Ğ·ÑƒĞµÑ‚ Ğ½Ğ¾Ğ¼ĞµÑ€ Ñ‚ĞµĞ»ĞµÑ„Ğ¾Ğ½Ğ° Ğº ÑÑ‚Ğ°Ğ½Ğ´Ğ°Ñ€Ñ‚Ğ½Ğ¾Ğ¼Ñƒ Ñ„Ğ¾Ñ€Ğ¼Ğ°Ñ‚Ñƒ
 */
export function normalizePhone(phone: string, format: 'russian' | 'international' = 'russian'): string {
    if (!phone) return '';
    
    // Ğ£Ğ±Ğ¸Ñ€Ğ°ĞµĞ¼ Ğ²ÑĞµ ÑĞ¸Ğ¼Ğ²Ğ¾Ğ»Ñ‹ ĞºÑ€Ğ¾Ğ¼Ğµ Ñ†Ğ¸Ñ„Ñ€ Ğ¸ +
    const cleanPhone = phone.replace(/[^\d+]/g, '');
    
    if (format === 'russian') {
        // Ğ”Ğ»Ñ Ñ€Ğ¾ÑÑĞ¸Ğ¹ÑĞºĞ¸Ñ… Ğ½Ğ¾Ğ¼ĞµÑ€Ğ¾Ğ²
        if (cleanPhone.startsWith('8')) {
            return cleanPhone.replace(/^8/, '+7');
        }
        if (cleanPhone.startsWith('7')) {
            return '+' + cleanPhone;
        }
        if (cleanPhone.startsWith('+7')) {
            return cleanPhone;
        }
        // Ğ•ÑĞ»Ğ¸ Ğ½Ğ¾Ğ¼ĞµÑ€ Ğ½Ğ°Ñ‡Ğ¸Ğ½Ğ°ĞµÑ‚ÑÑ Ñ 9, Ğ´Ğ¾Ğ±Ğ°Ğ²Ğ»ÑĞµĞ¼ +7
        if (cleanPhone.startsWith('9') && cleanPhone.length === 10) {
            return '+7' + cleanPhone;
        }
    }
    
    return cleanPhone;
}

/**
 * Ğ¤Ğ¾Ñ€Ğ¼Ğ°Ñ‚Ğ¸Ñ€ÑƒĞµÑ‚ Ğ½Ğ¾Ğ¼ĞµÑ€ Ñ‚ĞµĞ»ĞµÑ„Ğ¾Ğ½Ğ° Ğ´Ğ»Ñ Ğ¾Ñ‚Ğ¾Ğ±Ñ€Ğ°Ğ¶ĞµĞ½Ğ¸Ñ
 */
export function formatPhone(phone: string, format: 'russian' | 'international' = 'russian'): string {
    if (!phone) return '';
    
    const normalized = normalizePhone(phone, format);
    
    if (format === 'russian') {
        // Ğ¤Ğ¾Ñ€Ğ¼Ğ°Ñ‚: +7 (XXX) XXX-XX-XX
        const match = normalized.match(/^\+7(\d{3})(\d{3})(\d{2})(\d{2})$/);
        if (match) {
            return `+7 (${match[1]}) ${match[2]}-${match[3]}-${match[4]}`;
        }
    } else {
        // Ğ¤Ğ¾Ñ€Ğ¼Ğ°Ñ‚: +X (XXX) XXX-XXXX
        const match = normalized.match(/^\+(\d{1,3})(\d{3})(\d{3})(\d{4})$/);
        if (match) {
            return `+${match[1]} (${match[2]}) ${match[3]}-${match[4]}`;
        }
    }
    
    return normalized;
}

/**
 * Ğ˜Ğ·Ğ²Ğ»ĞµĞºĞ°ĞµÑ‚ Ñ‚Ğ¾Ğ»ÑŒĞºĞ¾ Ñ†Ğ¸Ñ„Ñ€Ñ‹ Ğ¸Ğ· Ğ½Ğ¾Ğ¼ĞµÑ€Ğ° Ñ‚ĞµĞ»ĞµÑ„Ğ¾Ğ½Ğ°
 */
export function extractDigits(phone: string): string {
    if (!phone) return '';
    return phone.replace(/\D/g, '');
}

/**
 * ĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑĞµÑ‚, ÑĞ²Ğ»ÑĞµÑ‚ÑÑ Ğ»Ğ¸ Ğ½Ğ¾Ğ¼ĞµÑ€ Ñ‚ĞµĞ»ĞµÑ„Ğ¾Ğ½Ğ° Ğ¿Ğ¾Ğ»Ğ½Ñ‹Ğ¼
 */
export function isPhoneComplete(phone: string, format: 'russian' | 'international' = 'russian'): boolean {
    if (!phone) return false;
    
    const digits = extractDigits(phone);
    
    if (format === 'russian') {
        // Ğ Ğ¾ÑÑĞ¸Ğ¹ÑĞºĞ¸Ğ¹ Ğ½Ğ¾Ğ¼ĞµÑ€ Ğ´Ğ¾Ğ»Ğ¶ĞµĞ½ Ğ¸Ğ¼ĞµÑ‚ÑŒ 11 Ñ†Ğ¸Ñ„Ñ€ (Ñ ĞºĞ¾Ğ´Ğ¾Ğ¼ ÑÑ‚Ñ€Ğ°Ğ½Ñ‹)
        return digits.length === 11 && digits.startsWith('7');
    } else {
        // ĞœĞµĞ¶Ğ´ÑƒĞ½Ğ°Ñ€Ğ¾Ğ´Ğ½Ñ‹Ğ¹ Ğ½Ğ¾Ğ¼ĞµÑ€ Ğ´Ğ¾Ğ»Ğ¶ĞµĞ½ Ğ¸Ğ¼ĞµÑ‚ÑŒ Ğ¾Ñ‚ 7 Ğ´Ğ¾ 15 Ñ†Ğ¸Ñ„Ñ€
        return digits.length >= 7 && digits.length <= 15;
    }
}

/**
 * ĞŸĞ¾Ğ»ÑƒÑ‡Ğ°ĞµÑ‚ ĞºĞ¾Ğ´ ÑÑ‚Ñ€Ğ°Ğ½Ñ‹ Ğ¸Ğ· Ğ½Ğ¾Ğ¼ĞµÑ€Ğ° Ñ‚ĞµĞ»ĞµÑ„Ğ¾Ğ½Ğ°
 */
export function getCountryCode(phone: string): string | null {
    if (!phone) return null;
    
    const normalized = normalizePhone(phone, 'international');
    const match = normalized.match(/^\+(\d{1,3})/);
    
    return match ? match[1] : null;
}

/**
 * ĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑĞµÑ‚, ÑĞ²Ğ»ÑĞµÑ‚ÑÑ Ğ»Ğ¸ Ğ½Ğ¾Ğ¼ĞµÑ€ Ñ€Ğ¾ÑÑĞ¸Ğ¹ÑĞºĞ¸Ğ¼
 */
export function isRussianPhone(phone: string): boolean {
    if (!phone) return false;
    
    const countryCode = getCountryCode(phone);
    return countryCode === '7';
} 

```


## <a name="rentalappmainsrcviteenvdts"></a>`rental-app-main/src/vite-env.d.ts`

```typescript
// path: rental-app-main/src/vite-env.d.ts

/// <reference types="vite/client" />


```


## <a name="rentalappmaintailwindconfigjs"></a>`rental-app-main/tailwind.config.js`

```javascript
// path: rental-app-main/tailwind.config.js

/** @type {import('tailwindcss').Config} */
export default {
	darkMode: ["class"],
	content: [
		"./index.html",
		"./src/**/*.{js,ts,jsx,tsx,css}",
	],
	theme: {
		extend: {
			borderRadius: {
				lg: 'var(--radius)',
				md: 'calc(var(--radius) - 2px)',
				sm: 'calc(var(--radius) - 4px)'
			},
			colors: {
				background: 'hsl(var(--background))',
				foreground: 'hsl(var(--foreground))',
				card: {
					DEFAULT: 'hsl(var(--card))',
					foreground: 'hsl(var(--card-foreground))'
				},
				popover: {
					DEFAULT: 'hsl(var(--popover))',
					foreground: 'hsl(var(--popover-foreground))'
				},
				primary: {
					DEFAULT: 'hsl(var(--primary))',
					foreground: 'hsl(var(--primary-foreground))'
				},
				secondary: {
					DEFAULT: 'hsl(var(--secondary))',
					foreground: 'hsl(var(--secondary-foreground))'
				},
				muted: {
					DEFAULT: 'hsl(var(--muted))',
					foreground: 'hsl(var(--muted-foreground))'
				},
				accent: {
					DEFAULT: 'hsl(var(--accent))',
					foreground: 'hsl(var(--accent-foreground))'
				},
				destructive: {
					DEFAULT: 'hsl(var(--destructive))',
					foreground: 'hsl(var(--destructive-foreground))'
				},
				border: 'hsl(var(--border))',
				input: 'hsl(var(--input))',
				ring: 'hsl(var(--ring))',
				chart: {
					'1': 'hsl(var(--chart-1))',
					'2': 'hsl(var(--chart-2))',
					'3': 'hsl(var(--chart-3))',
					'4': 'hsl(var(--chart-4))',
					'5': 'hsl(var(--chart-5))'
				}
			}
		}
	},
	plugins: [
		require('tailwindcss-animate'),
		require('@tailwindcss/typography'),
	],
}

```


## <a name="rentalappmaintestslidersyncmd"></a>`rental-app-main/test_slider_sync.md`

```markdown
// path: rental-app-main/test_slider_sync.md

# Ğ¢ĞµÑÑ‚Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ ÑĞ¸Ğ½Ñ…Ñ€Ğ¾Ğ½Ğ¸Ğ·Ğ°Ñ†Ğ¸Ğ¸ Ğ¿Ğ¾Ğ»Ğ·ÑƒĞ½ĞºĞ° Ñ ĞºĞ°Ğ»ĞµĞ½Ğ´Ğ°Ñ€ĞµĞ¼

## ĞĞ¿Ğ¸ÑĞ°Ğ½Ğ¸Ğµ Ñ„ÑƒĞ½ĞºÑ†Ğ¸Ğ¾Ğ½Ğ°Ğ»ÑŒĞ½Ğ¾ÑÑ‚Ğ¸

Ğ ĞµĞ°Ğ»Ğ¸Ğ·Ğ¾Ğ²Ğ°Ğ½Ğ° ÑĞ¸Ğ½Ñ…Ñ€Ğ¾Ğ½Ğ¸Ğ·Ğ°Ñ†Ğ¸Ñ Ğ¼ĞµĞ¶Ğ´Ñƒ ÑƒĞ¼Ğ½Ñ‹Ğ¼ ĞºĞ°Ğ»ÑŒĞºÑƒĞ»ÑÑ‚Ğ¾Ñ€Ğ¾Ğ¼ ÑĞºĞ¸Ğ´Ğ¾Ğº Ğ¸ Ğ²Ğ¸Ğ´Ğ¶ĞµÑ‚Ğ¾Ğ¼ ĞºĞ°Ğ»ĞµĞ½Ğ´Ğ°Ñ€Ñ Ğ½Ğ° Ğ³Ğ»Ğ°Ğ²Ğ½Ğ¾Ğ¹ ÑÑ‚Ñ€Ğ°Ğ½Ğ¸Ñ†Ğµ:

### ĞšĞ°Ğº ÑÑ‚Ğ¾ Ñ€Ğ°Ğ±Ğ¾Ñ‚Ğ°ĞµÑ‚:

1. **Ğ˜Ğ·Ğ¼ĞµĞ½ĞµĞ½Ğ¸Ğµ Ğ´Ğ°Ñ‚ Ğ² ĞºĞ°Ğ»ĞµĞ½Ğ´Ğ°Ñ€Ğµ** â†’ Ğ¾Ğ±Ğ½Ğ¾Ğ²Ğ»ÑĞµÑ‚ÑÑ ĞºĞ¾Ğ»Ğ¸Ñ‡ĞµÑÑ‚Ğ²Ğ¾ Ğ´Ğ½ĞµĞ¹ Ğ² ĞºĞ°Ğ»ÑŒĞºÑƒĞ»ÑÑ‚Ğ¾Ñ€Ğµ
2. **Ğ˜Ğ·Ğ¼ĞµĞ½ĞµĞ½Ğ¸Ğµ Ğ¿Ğ¾Ğ»Ğ·ÑƒĞ½ĞºĞ° Ğ² ĞºĞ°Ğ»ÑŒĞºÑƒĞ»ÑÑ‚Ğ¾Ñ€Ğµ** â†’ Ğ¾Ğ±Ğ½Ğ¾Ğ²Ğ»ÑĞµÑ‚ÑÑ Ğ´Ğ°Ñ‚Ğ° Ğ¾ĞºĞ¾Ğ½Ñ‡Ğ°Ğ½Ğ¸Ñ Ğ² ĞºĞ°Ğ»ĞµĞ½Ğ´Ğ°Ñ€Ğµ

### ĞŸÑ€Ğ¸Ğ¼ĞµÑ€ Ğ¸ÑĞ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ:

1. ĞŸĞ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ÑŒ Ğ²Ñ‹Ğ±Ğ¸Ñ€Ğ°ĞµÑ‚ Ğ´Ğ°Ñ‚Ñ‹ Ñ 20.08 Ğ¿Ğ¾ 22.08 (2 Ğ´Ğ½Ñ)
2. ĞŸĞ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ÑŒ Ğ´Ğ²Ğ¸Ğ³Ğ°ĞµÑ‚ Ğ¿Ğ¾Ğ»Ğ·ÑƒĞ½Ğ¾Ğº Ğ² ÑƒĞ¼Ğ½Ğ¾Ğ¼ ĞºĞ°Ğ»ÑŒĞºÑƒĞ»ÑÑ‚Ğ¾Ñ€Ğµ ÑĞºĞ¸Ğ´Ğ¾Ğº Ğ½Ğ° 4 Ğ´Ğ½Ñ
3. Ğ”Ğ°Ñ‚Ğ° Ğ¾ĞºĞ¾Ğ½Ñ‡Ğ°Ğ½Ğ¸Ñ Ğ°Ñ€ĞµĞ½Ğ´Ñ‹ Ğ°Ğ²Ñ‚Ğ¾Ğ¼Ğ°Ñ‚Ğ¸Ñ‡ĞµÑĞºĞ¸ ÑƒÑÑ‚Ğ°Ğ½Ğ°Ğ²Ğ»Ğ¸Ğ²Ğ°ĞµÑ‚ÑÑ Ğ½Ğ° 24.08

## Ğ ĞµĞ°Ğ»Ğ¸Ğ·Ğ¾Ğ²Ğ°Ğ½Ğ½Ñ‹Ğµ Ğ¸Ğ·Ğ¼ĞµĞ½ĞµĞ½Ğ¸Ñ:

### 1. ĞĞ±Ğ½Ğ¾Ğ²Ğ»ĞµĞ½ `src/store/discountStore.ts`:
- Ğ”Ğ¾Ğ±Ğ°Ğ²Ğ»ĞµĞ½ Ğ¼ĞµÑ‚Ğ¾Ğ´ `setDaysFromSlider()` Ğ´Ğ»Ñ Ğ¾Ğ±Ğ½Ğ¾Ğ²Ğ»ĞµĞ½Ğ¸Ñ Ğ´Ğ°Ñ‚ Ğ¸Ğ· Ğ¿Ğ¾Ğ»Ğ·ÑƒĞ½ĞºĞ°
- Ğ˜Ğ¼Ğ¿Ğ¾Ñ€Ñ‚Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ° Ñ„ÑƒĞ½ĞºÑ†Ğ¸Ñ `addDays` Ğ¸Ğ· date-fns

### 2. ĞĞ±Ğ½Ğ¾Ğ²Ğ»ĞµĞ½ `src/components/DiscountCalculator.tsx`:
- Ğ˜Ğ·Ğ¼ĞµĞ½ĞµĞ½ `handleSliderChange` Ğ´Ğ»Ñ Ğ¸ÑĞ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ `setDaysFromSlider` Ğ²Ğ¼ĞµÑÑ‚Ğ¾ `setDays`

### 3. ĞĞ±Ğ½Ğ¾Ğ²Ğ»ĞµĞ½ `src/store/dateStore.ts`:
- Ğ”Ğ¾Ğ±Ğ°Ğ²Ğ»ĞµĞ½ Ğ¿Ğ°Ñ€Ğ°Ğ¼ĞµÑ‚Ñ€ `source` Ğ² `setRange` Ğ´Ğ»Ñ Ğ¾Ñ‚ÑĞ»ĞµĞ¶Ğ¸Ğ²Ğ°Ğ½Ğ¸Ñ Ğ¸ÑÑ‚Ğ¾Ñ‡Ğ½Ğ¸ĞºĞ° Ğ¸Ğ·Ğ¼ĞµĞ½ĞµĞ½Ğ¸Ğ¹

### 4. ĞĞ±Ğ½Ğ¾Ğ²Ğ»ĞµĞ½ `src/components/DateRangeSelector.tsx`:
- Ğ”Ğ¾Ğ±Ğ°Ğ²Ğ»ĞµĞ½Ğ° Ğ»Ğ¾Ğ³Ğ¸ĞºĞ° Ğ´Ğ»Ñ Ğ¸Ğ³Ğ½Ğ¾Ñ€Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ Ğ¸Ğ·Ğ¼ĞµĞ½ĞµĞ½Ğ¸Ğ¹ Ğ¾Ñ‚ Ğ¿Ğ¾Ğ»Ğ·ÑƒĞ½ĞºĞ°
- Ğ”Ğ¾Ğ±Ğ°Ğ²Ğ»ĞµĞ½ `useRef` Ğ´Ğ»Ñ Ğ¾Ñ‚ÑĞ»ĞµĞ¶Ğ¸Ğ²Ğ°Ğ½Ğ¸Ñ Ğ¸ÑÑ‚Ğ¾Ñ‡Ğ½Ğ¸ĞºĞ° Ğ¸Ğ·Ğ¼ĞµĞ½ĞµĞ½Ğ¸Ğ¹

### 5. ĞĞ±Ğ½Ğ¾Ğ²Ğ»ĞµĞ½ `src/hooks/useDateRange.ts`:
- ĞĞ±Ğ½Ğ¾Ğ²Ğ»ĞµĞ½ Ğ¸Ğ½Ñ‚ĞµÑ€Ñ„ĞµĞ¹Ñ Ğ´Ğ»Ñ Ğ¿Ğ¾Ğ´Ğ´ĞµÑ€Ğ¶ĞºĞ¸ Ğ¸ÑÑ‚Ğ¾Ñ‡Ğ½Ğ¸ĞºĞ° Ğ¸Ğ·Ğ¼ĞµĞ½ĞµĞ½Ğ¸Ğ¹

### 6. ĞĞ±Ğ½Ğ¾Ğ²Ğ»ĞµĞ½Ñ‹ ÑĞ²ÑĞ·Ğ°Ğ½Ğ½Ñ‹Ğµ ĞºĞ¾Ğ¼Ğ¿Ğ¾Ğ½ĞµĞ½Ñ‚Ñ‹:
- `EditableDateRange.tsx`
- `CalendarDateInputRange.tsx`
- `useReservationState.ts`
- `EditableReservationCard.tsx`

## Ğ›Ğ¾Ğ³Ğ¸ĞºĞ° Ğ¿Ñ€ĞµĞ´Ğ¾Ñ‚Ğ²Ñ€Ğ°Ñ‰ĞµĞ½Ğ¸Ñ Ñ†Ğ¸ĞºĞ»Ğ¸Ñ‡ĞµÑĞºĞ¸Ñ… Ğ¾Ğ±Ğ½Ğ¾Ğ²Ğ»ĞµĞ½Ğ¸Ğ¹:

1. ĞšĞ¾Ğ³Ğ´Ğ° Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ÑŒ Ğ´Ğ²Ğ¸Ğ³Ğ°ĞµÑ‚ Ğ¿Ğ¾Ğ»Ğ·ÑƒĞ½Ğ¾Ğº â†’ Ğ²Ñ‹Ğ·Ñ‹Ğ²Ğ°ĞµÑ‚ÑÑ `setDaysFromSlider` â†’ Ğ¾Ğ±Ğ½Ğ¾Ğ²Ğ»ÑĞµÑ‚ÑÑ Ğ´Ğ°Ñ‚Ğ° Ñ Ğ¸ÑÑ‚Ğ¾Ñ‡Ğ½Ğ¸ĞºĞ¾Ğ¼ 'slider'
2. `DateRangeSelector` Ğ¿Ñ€Ğ¾Ğ²ĞµÑ€ÑĞµÑ‚ Ğ¸ÑÑ‚Ğ¾Ñ‡Ğ½Ğ¸Ğº Ğ¸Ğ·Ğ¼ĞµĞ½ĞµĞ½Ğ¸Ğ¹ Ğ¸ Ğ¸Ğ³Ğ½Ğ¾Ñ€Ğ¸Ñ€ÑƒĞµÑ‚ Ğ¾Ğ±Ğ½Ğ¾Ğ²Ğ»ĞµĞ½Ğ¸Ñ Ğ¾Ñ‚ 'slider'
3. Ğ­Ñ‚Ğ¾ Ğ¿Ñ€ĞµĞ´Ğ¾Ñ‚Ğ²Ñ€Ğ°Ñ‰Ğ°ĞµÑ‚ Ñ†Ğ¸ĞºĞ»Ğ¸Ñ‡ĞµÑĞºĞ¸Ğµ Ğ¾Ğ±Ğ½Ğ¾Ğ²Ğ»ĞµĞ½Ğ¸Ñ Ğ¼ĞµĞ¶Ğ´Ñƒ ĞºĞ¾Ğ¼Ğ¿Ğ¾Ğ½ĞµĞ½Ñ‚Ğ°Ğ¼Ğ¸

## Ğ¢ĞµÑÑ‚Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ:

1. ĞÑ‚ĞºÑ€Ğ¾Ğ¹Ñ‚Ğµ Ğ³Ğ»Ğ°Ğ²Ğ½ÑƒÑ ÑÑ‚Ñ€Ğ°Ğ½Ğ¸Ñ†Ñƒ
2. Ğ’Ñ‹Ğ±ĞµÑ€Ğ¸Ñ‚Ğµ Ğ´Ğ°Ñ‚Ñ‹ Ğ² ĞºĞ°Ğ»ĞµĞ½Ğ´Ğ°Ñ€Ğµ (Ğ½Ğ°Ğ¿Ñ€Ğ¸Ğ¼ĞµÑ€, 20.08 - 22.08)
3. Ğ”Ğ²Ğ¸Ğ³Ğ°Ğ¹Ñ‚Ğµ Ğ¿Ğ¾Ğ»Ğ·ÑƒĞ½Ğ¾Ğº Ğ² ĞºĞ°Ğ»ÑŒĞºÑƒĞ»ÑÑ‚Ğ¾Ñ€Ğµ ÑĞºĞ¸Ğ´Ğ¾Ğº
4. ĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑŒÑ‚Ğµ, Ñ‡Ñ‚Ğ¾ Ğ´Ğ°Ñ‚Ğ° Ğ¾ĞºĞ¾Ğ½Ñ‡Ğ°Ğ½Ğ¸Ñ Ğ² ĞºĞ°Ğ»ĞµĞ½Ğ´Ğ°Ñ€Ğµ Ğ¾Ğ±Ğ½Ğ¾Ğ²Ğ»ÑĞµÑ‚ÑÑ Ğ°Ğ²Ñ‚Ğ¾Ğ¼Ğ°Ñ‚Ğ¸Ñ‡ĞµÑĞºĞ¸
5. ĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑŒÑ‚Ğµ, Ñ‡Ñ‚Ğ¾ ĞºĞ¾Ğ»Ğ¸Ñ‡ĞµÑÑ‚Ğ²Ğ¾ Ğ´Ğ½ĞµĞ¹ Ğ² ĞºĞ°Ğ»ÑŒĞºÑƒĞ»ÑÑ‚Ğ¾Ñ€Ğµ Ğ¾Ğ±Ğ½Ğ¾Ğ²Ğ»ÑĞµÑ‚ÑÑ Ğ¿Ñ€Ğ¸ Ğ¸Ğ·Ğ¼ĞµĞ½ĞµĞ½Ğ¸Ğ¸ Ğ´Ğ°Ñ‚ Ğ² ĞºĞ°Ğ»ĞµĞ½Ğ´Ğ°Ñ€Ğµ 

```


## <a name="rentalappmaintsconfigappjson"></a>`rental-app-main/tsconfig.app.json`

```json
// path: rental-app-main/tsconfig.app.json

{
  "compilerOptions": {
    "tsBuildInfoFile": "./node_modules/.tmp/tsconfig.app.tsbuildinfo",
    "target": "ES2020",
    "useDefineForClassFields": true,
    "lib": ["ES2020", "DOM", "DOM.Iterable"],
    "module": "ESNext",
    "skipLibCheck": true,

    /* Bundler mode */
    "moduleResolution": "bundler",
    "allowImportingTsExtensions": true,
    "verbatimModuleSyntax": true,
    "moduleDetection": "force",
    "noEmit": true,
    "jsx": "react-jsx",

    /* Linting */
    "strict": true,
    "noUnusedLocals": true,
    "noUnusedParameters": true,
    "erasableSyntaxOnly": true,
    "noFallthroughCasesInSwitch": true,
    "noUncheckedSideEffectImports": true,

    /* âœ… Ğ”Ğ¾Ğ±Ğ°Ğ²Ğ»ÑĞµĞ¼ Ğ´Ğ»Ñ alias */
    "baseUrl": ".",
    "paths": {
      "@/*": ["src/*"]
    }
  },
  "include": ["src"]
}


```


## <a name="rentalappmaintsconfigjson"></a>`rental-app-main/tsconfig.json`

```json
// path: rental-app-main/tsconfig.json

{
  "compilerOptions": {
    "target": "ESNext",
    "useDefineForClassFields": true,
    "module": "ESNext",
    "moduleResolution": "bundler",
    "strict": true,
    "jsx": "react-jsx",

    // âœ… Ğ´Ğ¾Ğ±Ğ°Ğ²Ğ»ÑĞµĞ¼
    "baseUrl": ".",
    "paths": {
      "@/*": ["src/*"]
    },
    "allowSyntheticDefaultImports": true
  },
  "include": ["src"]
}


```


## <a name="rentalappmaintsconfignodejson"></a>`rental-app-main/tsconfig.node.json`

```json
// path: rental-app-main/tsconfig.node.json

{
  "compilerOptions": {
    "tsBuildInfoFile": "./node_modules/.tmp/tsconfig.node.tsbuildinfo",
    "target": "ES2022",
    "lib": ["ES2023"],
    "module": "ESNext",
    "skipLibCheck": true,

    /* Bundler mode */
    "moduleResolution": "bundler",
    "types": ["node"],
    "allowImportingTsExtensions": true,
    "verbatimModuleSyntax": true,
    "moduleDetection": "force",
    "noEmit": true,

    /* Linting */
    "strict": true,
    "noUnusedLocals": true,
    "noUnusedParameters": true,
    "erasableSyntaxOnly": true,
    "noFallthroughCasesInSwitch": true,
    "noUncheckedSideEffectImports": true
  },
  "include": ["vite.config.ts"]
}


```


## <a name="rentalappmainviteconfigts"></a>`rental-app-main/vite.config.ts`

```typescript
// path: rental-app-main/vite.config.ts

import { defineConfig } from 'vite'
import react from '@vitejs/plugin-react'
import { fileURLToPath, URL } from 'url' // Ğ˜Ğ¼Ğ¿Ğ¾Ñ€Ñ‚Ğ¸Ñ€ÑƒĞµĞ¼ ÑƒÑ‚Ğ¸Ğ»Ğ¸Ñ‚Ñ‹ Ğ´Ğ»Ñ Ñ€Ğ°Ğ±Ğ¾Ñ‚Ñ‹ Ñ Ğ¿ÑƒÑ‚ÑĞ¼Ğ¸

export default defineConfig({
  plugins: [react()],

  server: {
    port: 5173,
    strictPort: true,
  },

  resolve: {
    alias: {
      // Ğ˜ÑĞ¿Ğ¾Ğ»ÑŒĞ·ÑƒĞµĞ¼ ÑĞ¾Ğ²Ñ€ĞµĞ¼ĞµĞ½Ğ½Ñ‹Ğ¹ ÑĞ¿Ğ¾ÑĞ¾Ğ± Ğ´Ğ»Ñ ÑĞ¾Ğ·Ğ´Ğ°Ğ½Ğ¸Ñ alias
      "@": fileURLToPath(new URL('./src', import.meta.url))
    }
  }
})

```


## ğŸ“¦ Ğ—Ğ°Ğ²Ğ¸ÑĞ¸Ğ¼Ğ¾ÑÑ‚Ğ¸ Ğ¿Ñ€Ğ¾ĞµĞºÑ‚Ğ°

### Frontend (package.json)

- `@fullcalendar/core`: ^6.1.17
- `@fullcalendar/daygrid`: ^6.1.17
- `@fullcalendar/interaction`: ^6.1.17
- `@fullcalendar/react`: ^6.1.17
- `@fullcalendar/resource-timeline`: ^6.1.17
- `@hookform/resolvers`: ^5.0.1
- `@radix-ui/react-checkbox`: ^1.3.1
- `@radix-ui/react-dialog`: ^1.1.14
- `@radix-ui/react-label`: ^2.1.6
- `@radix-ui/react-popover`: ^1.1.14
- `@radix-ui/react-scroll-area`: ^1.2.9
- `@radix-ui/react-select`: ^2.2.4
- `@radix-ui/react-slot`: ^1.2.2
- `@radix-ui/react-switch`: ^1.2.5
- `@radix-ui/react-toggle`: ^1.1.8
- `@radix-ui/react-toggle-group`: ^1.1.9
- `@tanstack/react-query`: ^5.76.1
- `@tanstack/react-query-devtools`: ^5.76.1
- `@types/react-input-mask`: ^3.0.6
- `@uiw/react-md-editor`: ^4.0.7
- `axios`: ^1.9.0
- `class-variance-authority`: ^0.7.1
- `clsx`: ^2.1.1
- `cmdk`: ^1.1.1
- `date-fns`: ^4.1.0
- `lucide-react`: ^0.511.0
- `react`: ^19.1.0
- `react-day-picker`: ^9.7.0
- `react-dom`: ^19.1.0
- `react-error-boundary`: ^6.0.0
- `react-hook-form`: ^7.56.4
- `react-imask`: ^7.6.1
- `react-markdown`: ^10.1.0
- `react-router-dom`: ^7.6.0
- `rehype-sanitize`: ^6.0.0
- `sonner`: ^2.0.3
- `tailwind-merge`: ^3.3.0
- `tailwindcss-animate`: ^1.0.7
- `zod`: ^3.25.28
- `zustand`: ^5.0.4

#### Dev-Ğ·Ğ°Ğ²Ğ¸ÑĞ¸Ğ¼Ğ¾ÑÑ‚Ğ¸
- `@eslint/js`: ^9.25.0
- `@tailwindcss/typography`: ^0.5.16
- `@types/mocha`: ^10.0.10
- `@types/node`: ^24.0.10
- `@types/react`: ^19.1.2
- `@types/react-dom`: ^19.1.2
- `@vitejs/plugin-react`: ^4.4.1
- `autoprefixer`: ^10.4.15
- `eslint`: ^9.25.0
- `eslint-plugin-react-hooks`: ^5.2.0
- `eslint-plugin-react-refresh`: ^0.4.19
- `globals`: ^16.0.0
- `postcss`: ^8.4.38
- `tailwindcss`: ^3.4.1
- `typescript`: ~5.8.3
- `typescript-eslint`: ^8.30.1
- `vite`: ^6.3.5

### Backend (requirements.txt)

```txt


## ĞÑˆĞ¸Ğ±ĞºĞ° Ñ‡Ñ‚ĞµĞ½Ğ¸Ñ requirements.txt: 'utf-8' codec can't decode byte 0xff in position 0: invalid start byte
